# AIæ™ºèƒ½è®°è´¦åº”ç”¨ - æ¶æ„è®¾è®¡æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®åç§°
**AI Bookkeeping** (æ™ºèƒ½è®°è´¦)

### 1.2 é¡¹ç›®ç›®æ ‡
æ‰“é€ ä¸€æ¬¾AIé©±åŠ¨çš„æ™ºèƒ½è®°è´¦åº”ç”¨ï¼Œæ”¯æŒå¤šç§è®°è´¦æ–¹å¼ï¼ˆå›¾ç‰‡è¯†åˆ«ã€è¯­éŸ³è¾“å…¥ã€é‚®ç®±è´¦å•è§£æã€æ‰‹åŠ¨å½•å…¥ï¼‰ï¼Œæä¾›ä¸°å¯Œçš„ç»Ÿè®¡æŠ¥è¡¨åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·è½»æ¾ç®¡ç†ä¸ªäºº/å®¶åº­è´¢åŠ¡ã€‚

### 1.3 æ ¸å¿ƒåŠŸèƒ½
1. **æ™ºèƒ½è®°è´¦**
   - å›¾ç‰‡/æ‹ç…§è¯†åˆ«ï¼šè‡ªåŠ¨è¯†åˆ«å°ç¥¨ã€å‘ç¥¨ã€è´¦å•
   - è¯­éŸ³è®°è´¦ï¼šè¯­éŸ³è½¬æ–‡å­—è‡ªåŠ¨è§£æé‡‘é¢å’Œåˆ†ç±»
   - é‚®ç®±è´¦å•è§£æï¼šè‡ªåŠ¨è·å–ä¿¡ç”¨å¡è´¦å•ç”Ÿæˆè®°å½•
   - æ‰‹åŠ¨è®°è´¦ï¼šæ”¯æŒæ”¯å‡º/æ”¶å…¥/è½¬è´¦

2. **è´¦ç›®ç®¡ç†**
   - å¤šè´¦æœ¬æ”¯æŒ
   - å¤šæˆå‘˜åä½œ
   - åˆ†ç±»ç®¡ç†ï¼ˆæ”¯å‡º/æ”¶å…¥ï¼‰
   - è´¦æˆ·ç®¡ç†ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€ä¿¡ç”¨å¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡ç­‰ï¼‰

3. **ç»Ÿè®¡æŠ¥è¡¨**
   - æ”¶æ”¯æ€»è§ˆ
   - è¶‹åŠ¿åˆ†æï¼ˆæ—¥/å‘¨/æœˆ/å¹´ï¼‰
   - åˆ†ç±»å æ¯”
   - æŠ¥é”€ç»Ÿè®¡
   - é¢„ç®—ç®¡ç†

4. **ä¸ªäººä¸­å¿ƒ**
   - ä¼šå‘˜ç³»ç»Ÿ
   - ä¸»é¢˜è®¾ç½®
   - æ•°æ®å¯¼å…¥/å¯¼å‡º
   - å®šæ—¶è®°è´¦

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ (Mobile App)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Flutter (iOS & Android)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚   é¦–é¡µ   â”‚ â”‚   ç»Ÿè®¡   â”‚ â”‚   è´¦å•   â”‚ â”‚   æˆ‘çš„   â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS/REST API
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Gateway                              â”‚
â”‚                    (Nginx / Kong / AWS ALB)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡ (Backend)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Python FastAPI                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”‚  è®°è´¦æœåŠ¡    â”‚ â”‚  ç»Ÿè®¡æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  AIè¯†åˆ«æœåŠ¡  â”‚ â”‚  é‚®ä»¶è§£æ    â”‚ â”‚  é€šçŸ¥æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostgreSQL    â”‚ â”‚      Redis       â”‚ â”‚   MinIO/OSS      â”‚
â”‚   (ä¸»æ•°æ®åº“)     â”‚ â”‚   (ç¼“å­˜/é˜Ÿåˆ—)    â”‚ â”‚   (æ–‡ä»¶å­˜å‚¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AI æœåŠ¡å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Claude API   â”‚ â”‚ Whisper API  â”‚ â”‚ OCR Service  â”‚            â”‚
â”‚  â”‚ (æ–‡æœ¬ç†è§£)   â”‚ â”‚ (è¯­éŸ³è¯†åˆ«)   â”‚ â”‚ (å›¾ç‰‡è¯†åˆ«)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

#### å‰ç«¯ (Mobile App)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | **Flutter 3.x** | ä¸€å¥—ä»£ç ï¼ŒåŒæ—¶æ”¯æŒiOSå’ŒAndroid |
| çŠ¶æ€ç®¡ç† | **Riverpod** | ç®€æ´ã€ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç† |
| ç½‘ç»œè¯·æ±‚ | **Dio** | å¼ºå¤§çš„HTTPå®¢æˆ·ç«¯ |
| æœ¬åœ°å­˜å‚¨ | **Hive + SQLite** | ç¦»çº¿æ•°æ®ç¼“å­˜ |
| å›¾è¡¨ | **fl_chart** | ç¾è§‚çš„ç»Ÿè®¡å›¾è¡¨ |
| ç›¸æœº | **camera + image_picker** | æ‹ç…§å’Œå›¾ç‰‡é€‰æ‹© |
| è¯­éŸ³ | **speech_to_text** | è¯­éŸ³è¾“å…¥ |
| UIç»„ä»¶ | **è‡ªå®šä¹‰ç»„ä»¶åº“** | å‚ç…§è®¾è®¡ç¨¿å®šåˆ¶ |

#### åç«¯ (Backend)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| è¯­è¨€ | **Python 3.11+** | AIç”Ÿæ€ä¸°å¯Œ |
| æ¡†æ¶ | **FastAPI** | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| ORM | **SQLAlchemy 2.0** | æ•°æ®åº“æ˜ å°„ |
| æ•°æ®åº“ | **PostgreSQL 15** | ä¸»æ•°æ®å­˜å‚¨ |
| ç¼“å­˜ | **Redis 7** | ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ— |
| ä»»åŠ¡é˜Ÿåˆ— | **Celery** | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| æ–‡ä»¶å­˜å‚¨ | **MinIO / é˜¿é‡Œäº‘OSS** | å›¾ç‰‡ç­‰æ–‡ä»¶å­˜å‚¨ |

#### AIæœåŠ¡
| åŠŸèƒ½ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜ |
|------|----------|------|
| å›¾ç‰‡è¯†åˆ«(OCR) | **PaddleOCR** + Claude | æœ¬åœ°OCR + AIç†è§£ |
| è¯­éŸ³è¯†åˆ« | **Whisper API** | OpenAIè¯­éŸ³è½¬æ–‡å­— |
| æ™ºèƒ½åˆ†ç±» | **Claude API** | è‡ªåŠ¨è¯†åˆ«æ¶ˆè´¹ç±»å‹ |
| è´¦å•è§£æ | **Claude API** | è§£æé‚®ä»¶ä¸­çš„è´¦å• |

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    password_hash VARCHAR(255),
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    member_level INT DEFAULT 0,  -- 0:æ™®é€š 1:VIP
    member_expire_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬è¡¨
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(50),
    cover_image VARCHAR(500),
    book_type INT DEFAULT 0,  -- 0:æ™®é€š 1:å®¶åº­ 2:å•†åŠ¡
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬æˆå‘˜è¡¨
CREATE TABLE book_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    book_id UUID REFERENCES books(id),
    user_id UUID REFERENCES users(id),
    role INT DEFAULT 0,  -- 0:æˆå‘˜ 1:ç®¡ç†å‘˜ 2:æ‰€æœ‰è€…
    joined_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æˆ·è¡¨ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€æ”¯ä»˜å®ç­‰ï¼‰
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    account_type INT NOT NULL,  -- 1:ç°é‡‘ 2:å‚¨è“„å¡ 3:ä¿¡ç”¨å¡ 4:æ”¯ä»˜å® 5:å¾®ä¿¡
    icon VARCHAR(50),
    balance DECIMAL(15,2) DEFAULT 0,
    credit_limit DECIMAL(15,2),  -- ä¿¡ç”¨å¡é¢åº¦
    bill_day INT,  -- è´¦å•æ—¥
    repay_day INT,  -- è¿˜æ¬¾æ—¥
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,  -- NULLè¡¨ç¤ºç³»ç»Ÿé¢„è®¾
    parent_id UUID REFERENCES categories(id),
    name VARCHAR(50) NOT NULL,
    icon VARCHAR(50),
    category_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥
    sort_order INT DEFAULT 0,
    is_system BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦ç›®è®°å½•è¡¨
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    account_id UUID REFERENCES accounts(id),
    target_account_id UUID REFERENCES accounts(id),  -- è½¬è´¦ç›®æ ‡
    category_id UUID REFERENCES categories(id),
    transaction_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥ 3:è½¬è´¦
    amount DECIMAL(15,2) NOT NULL,
    fee DECIMAL(15,2) DEFAULT 0,  -- æ‰‹ç»­è´¹
    transaction_date DATE NOT NULL,
    transaction_time TIME,
    note VARCHAR(500),
    tags VARCHAR(200)[],
    images VARCHAR(500)[],
    location VARCHAR(200),
    is_reimbursable BOOLEAN DEFAULT FALSE,  -- å¯æŠ¥é”€
    is_reimbursed BOOLEAN DEFAULT FALSE,    -- å·²æŠ¥é”€
    is_exclude_stats BOOLEAN DEFAULT FALSE, -- ä¸è®¡æ”¶æ”¯
    source INT DEFAULT 0,  -- 0:æ‰‹åŠ¨ 1:å›¾ç‰‡ 2:è¯­éŸ³ 3:é‚®ä»¶
    ai_confidence DECIMAL(3,2),  -- AIè¯†åˆ«ç½®ä¿¡åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é¢„ç®—è¡¨
CREATE TABLE budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    category_id UUID REFERENCES categories(id),  -- NULLè¡¨ç¤ºæ€»é¢„ç®—
    budget_type INT NOT NULL,  -- 1:æœˆåº¦ 2:å¹´åº¦
    amount DECIMAL(15,2) NOT NULL,
    year INT NOT NULL,
    month INT,  -- å¹´åº¦é¢„ç®—ä¸ºNULL
    created_at TIMESTAMP DEFAULT NOW()
);

-- å®šæ—¶è®°è´¦è¡¨
CREATE TABLE scheduled_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    template_data JSONB NOT NULL,  -- è®°è´¦æ¨¡æ¿
    frequency INT NOT NULL,  -- 1:æ¯å¤© 2:æ¯å‘¨ 3:æ¯æœˆ 4:æ¯å¹´
    next_execute_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- é‚®ç®±ç»‘å®šè¡¨
CREATE TABLE email_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    email VARCHAR(100) NOT NULL,
    email_type INT NOT NULL,  -- 1:Gmail 2:Outlook 3:QQ 4:163
    access_token TEXT,
    refresh_token TEXT,
    last_sync_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 ç´¢å¼•è®¾è®¡

```sql
-- è´¦ç›®æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date DESC);
CREATE INDEX idx_transactions_book_date ON transactions(book_id, transaction_date DESC);
CREATE INDEX idx_transactions_category ON transactions(category_id, transaction_date DESC);

-- ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_stats ON transactions(user_id, book_id, transaction_type, transaction_date);
```

---

## å››ã€APIè®¾è®¡

### 4.1 APIè§„èŒƒ
- RESTfulé£æ ¼
- JWT Tokenè®¤è¯
- ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
    "code": 0,
    "message": "success",
    "data": {}
}
```

### 4.2 æ ¸å¿ƒAPIåˆ—è¡¨

#### è®¤è¯æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/auth/register | æ³¨å†Œ |
| POST | /api/v1/auth/login | ç™»å½• |
| POST | /api/v1/auth/refresh | åˆ·æ–°Token |
| POST | /api/v1/auth/logout | ç™»å‡º |

#### è´¦æœ¬æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/books | è·å–è´¦æœ¬åˆ—è¡¨ |
| POST | /api/v1/books | åˆ›å»ºè´¦æœ¬ |
| PUT | /api/v1/books/{id} | æ›´æ–°è´¦æœ¬ |
| DELETE | /api/v1/books/{id} | åˆ é™¤è´¦æœ¬ |
| POST | /api/v1/books/{id}/members | æ·»åŠ æˆå‘˜ |

#### è®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/transactions | è·å–è´¦ç›®åˆ—è¡¨ |
| POST | /api/v1/transactions | åˆ›å»ºè´¦ç›® |
| PUT | /api/v1/transactions/{id} | æ›´æ–°è´¦ç›® |
| DELETE | /api/v1/transactions/{id} | åˆ é™¤è´¦ç›® |
| POST | /api/v1/transactions/batch | æ‰¹é‡åˆ›å»º |

#### AIè®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/ai/recognize-image | å›¾ç‰‡è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/recognize-voice | è¯­éŸ³è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/parse-bill | è§£æè´¦å•é‚®ä»¶ |

#### ç»Ÿè®¡æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/stats/overview | æ”¶æ”¯æ¦‚è§ˆ |
| GET | /api/v1/stats/trend | è¶‹åŠ¿åˆ†æ |
| GET | /api/v1/stats/category | åˆ†ç±»ç»Ÿè®¡ |
| GET | /api/v1/stats/budget | é¢„ç®—æ‰§è¡Œæƒ…å†µ |

#### è´¦æˆ·æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/accounts | è´¦æˆ·åˆ—è¡¨ |
| POST | /api/v1/accounts | åˆ›å»ºè´¦æˆ· |
| PUT | /api/v1/accounts/{id} | æ›´æ–°è´¦æˆ· |
| GET | /api/v1/accounts/{id}/balance | è´¦æˆ·ä½™é¢ |

---

## äº”ã€å‰ç«¯é¡µé¢è®¾è®¡

### 5.1 é¡µé¢ç»“æ„

```
App
â”œâ”€â”€ å¯åŠ¨é¡µ (Splash)
â”œâ”€â”€ ç™»å½•/æ³¨å†Œ
â”‚   â”œâ”€â”€ æ‰‹æœºå·ç™»å½•
â”‚   â”œâ”€â”€ éªŒè¯ç ç™»å½•
â”‚   â””â”€â”€ ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ï¼‰
â”œâ”€â”€ ä¸»é¡µé¢ (åº•éƒ¨å¯¼èˆª)
â”‚   â”œâ”€â”€ é¦–é¡µ (Home)
â”‚   â”‚   â”œâ”€â”€ è´¦æœ¬åˆ‡æ¢
â”‚   â”‚   â”œâ”€â”€ æœ¬æœˆæ¦‚è§ˆå¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ å¿«æ·åŠŸèƒ½å…¥å£
â”‚   â”‚   â”œâ”€â”€ é¢„ç®—è¿›åº¦
â”‚   â”‚   â””â”€â”€ æœˆè´¦å•åˆ—è¡¨
â”‚   â”œâ”€â”€ ç»Ÿè®¡ (Stats)
â”‚   â”‚   â”œâ”€â”€ æ—¶é—´ç­›é€‰ï¼ˆæœˆ/å¹´/èŒƒå›´/æ—¥/å‘¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ æ€»è§ˆTab
â”‚   â”‚   â”œâ”€â”€ è¶‹åŠ¿Tab
â”‚   â”‚   â””â”€â”€ åˆ†ç±»Tab
â”‚   â”œâ”€â”€ è´¦å• (Bills)
â”‚   â”‚   â””â”€â”€ è´¦å•åˆ—è¡¨/æ—¥å†è§†å›¾
â”‚   â””â”€â”€ æˆ‘çš„ (Profile)
â”‚       â”œâ”€â”€ ä¼šå‘˜ä¿¡æ¯
â”‚       â”œâ”€â”€ è®¾ç½®åˆ—è¡¨
â”‚       â””â”€â”€ ç®¡ç†åŠŸèƒ½
â”œâ”€â”€ è®°è´¦é¡µé¢
â”‚   â”œâ”€â”€ æ”¯å‡ºè®°è´¦
â”‚   â”œâ”€â”€ æ”¶å…¥è®°è´¦
â”‚   â””â”€â”€ è½¬è´¦è®°è´¦
â”œâ”€â”€ AIè®°è´¦
â”‚   â”œâ”€â”€ æ‹ç…§/å›¾ç‰‡è¯†åˆ«
â”‚   â”œâ”€â”€ è¯­éŸ³è®°è´¦
â”‚   â””â”€â”€ è´¦å•å¯¼å…¥
â””â”€â”€ è®¾ç½®é¡µé¢
    â”œâ”€â”€ ä¸ªäººè®¾ç½®
    â”œâ”€â”€ è´¦æœ¬ç®¡ç†
    â”œâ”€â”€ åˆ†ç±»ç®¡ç†
    â”œâ”€â”€ è´¦æˆ·ç®¡ç†
    â””â”€â”€ ä¸»é¢˜è®¾ç½®
```

### 5.2 è®¾è®¡è§„èŒƒ

#### é¢œè‰²ç³»ç»Ÿ
```dart
// ä¸»è‰²è°ƒ
static const primary = Color(0xFF00C9A7);      // è–„è·ç»¿
static const primaryLight = Color(0xFFE8FFF8);

// åŠŸèƒ½è‰²
static const expense = Color(0xFFFF6B6B);      // æ”¯å‡ºçº¢
static const income = Color(0xFF4CAF50);       // æ”¶å…¥ç»¿
static const transfer = Color(0xFF2196F3);     // è½¬è´¦è“

// ä¸­æ€§è‰²
static const textPrimary = Color(0xFF333333);
static const textSecondary = Color(0xFF999999);
static const background = Color(0xFFF5F5F5);
static const cardBackground = Color(0xFFFFFFFF);
```

#### å­—ä½“è§„èŒƒ
```dart
// æ ‡é¢˜
static const headlineLarge = TextStyle(fontSize: 28, fontWeight: FontWeight.bold);
static const headlineMedium = TextStyle(fontSize: 24, fontWeight: FontWeight.bold);

// é‡‘é¢
static const amountLarge = TextStyle(fontSize: 32, fontWeight: FontWeight.bold);
static const amountMedium = TextStyle(fontSize: 20, fontWeight: FontWeight.w600);

// æ­£æ–‡
static const bodyLarge = TextStyle(fontSize: 16);
static const bodyMedium = TextStyle(fontSize: 14);
static const bodySmall = TextStyle(fontSize: 12);
```

---

## å…­ã€AIåŠŸèƒ½è®¾è®¡

### 6.1 å›¾ç‰‡è¯†åˆ«æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ‹ç…§  â”‚ â”€â”€â–¶ â”‚ OCRè¯†åˆ«  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ /é€‰å›¾ç‰‡  â”‚     â”‚ æ–‡å­—æå–  â”‚     â”‚ æ™ºèƒ½è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯†åˆ«å†…å®¹ï¼š**
- å•†æˆ·åç§°
- æ¶ˆè´¹é‡‘é¢
- æ¶ˆè´¹æ—¶é—´
- å•†å“æ˜ç»†
- è‡ªåŠ¨åˆ†ç±»å»ºè®®

### 6.2 è¯­éŸ³è®°è´¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯´è¯  â”‚ â”€â”€â–¶ â”‚ Whisper  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ æŒ‰ä½å½•éŸ³  â”‚     â”‚ è¯­éŸ³è½¬æ–‡å­—â”‚     â”‚ æ„å›¾è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹è¾“å…¥ï¼š**
- "ä»Šå¤©åˆé¥­èŠ±äº†35å—"
- "ä¹°äº†ä¸€æ¯å’–å•¡28å…ƒ"
- "è¿™ä¸ªæœˆå·¥èµ„åˆ°è´¦8000"

### 6.3 é‚®ç®±è´¦å•è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæƒé‚®ç®±  â”‚ â”€â”€â–¶ â”‚ è·å–é‚®ä»¶  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ æ‰¹é‡å¯¼å…¥  â”‚
â”‚ OAuth    â”‚     â”‚ ç­›é€‰è´¦å•  â”‚     â”‚ è§£æè´¦å•  â”‚     â”‚ ç”¨æˆ·ç¡®è®¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æŒé“¶è¡Œï¼š**
- æ‹›å•†é“¶è¡Œã€å·¥å•†é“¶è¡Œã€å»ºè®¾é“¶è¡Œç­‰
- æ”¯ä»˜å®ã€å¾®ä¿¡è´¦å•
- ä¿¡ç”¨å¡ç”µå­è´¦å•

---

## ä¸ƒã€é¡¹ç›®ç›®å½•ç»“æ„

### 7.1 å‰ç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-app/
â”œâ”€â”€ android/                    # AndroidåŸç”Ÿä»£ç 
â”œâ”€â”€ ios/                        # iOSåŸç”Ÿä»£ç 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart              # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ app.dart           # Appé…ç½®
â”‚   â”‚   â””â”€â”€ routes.dart        # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ constants/         # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ theme/             # ä¸»é¢˜é…ç½®
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ extensions/        # æ‰©å±•æ–¹æ³•
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ repositories/      # æ•°æ®ä»“åº“
â”‚   â”‚   â”œâ”€â”€ providers/         # çŠ¶æ€æä¾›è€…
â”‚   â”‚   â””â”€â”€ services/          # APIæœåŠ¡
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ home/              # é¦–é¡µæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ stats/             # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ bills/             # è´¦å•æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ profile/           # ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ transaction/       # è®°è´¦æ¨¡å—
â”‚   â”‚   â””â”€â”€ ai/                # AIè®°è´¦æ¨¡å—
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ widgets/           # é€šç”¨ç»„ä»¶
â”‚       â””â”€â”€ dialogs/           # å¼¹çª—ç»„ä»¶
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ images/                # å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ icons/                 # å›¾æ ‡èµ„æº
â”‚   â””â”€â”€ fonts/                 # å­—ä½“æ–‡ä»¶
â”œâ”€â”€ test/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ pubspec.yaml               # ä¾èµ–é…ç½®
â””â”€â”€ README.md
```

### 7.2 åç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # FastAPIå…¥å£
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ exceptions.py      # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py        # è®¤è¯æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ users.py       # ç”¨æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ books.py       # è´¦æœ¬æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ transactions.py# è®°è´¦æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.py    # è´¦æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ categories.py  # åˆ†ç±»æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ stats.py       # ç»Ÿè®¡æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ ai.py          # AIæ¥å£
â”‚   â”‚   â””â”€â”€ deps.py            # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ account.py         # è´¦æˆ·æ¨¡å‹
â”‚   â”‚   â””â”€â”€ category.py        # åˆ†ç±»æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·Schema
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬Schema
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦Schema
â”‚   â”‚   â””â”€â”€ stats.py           # ç»Ÿè®¡Schema
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py    # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”œâ”€â”€ stats_service.py   # ç»Ÿè®¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ ai_service.py      # AIæœåŠ¡
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ email_parser.py    # é‚®ä»¶è§£æä»»åŠ¡
â”‚       â””â”€â”€ scheduled.py       # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ Dockerfile                  # Dockeré…ç½®
â”œâ”€â”€ docker-compose.yml          # Dockerç¼–æ’
â””â”€â”€ README.md
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 å¼€å‘ç¯å¢ƒ
- æœ¬åœ°å¼€å‘ä½¿ç”¨Docker Compose
- çƒ­é‡è½½æ”¯æŒ

### 8.2 ç”Ÿäº§ç¯å¢ƒ

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   CDN (é™æ€)    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  è´Ÿè½½å‡è¡¡ (SLB) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚   â”‚   API Server 2  â”‚   â”‚   API Server N  â”‚
     â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                              â”‚                              â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚PostgreSQLâ”‚                   â”‚   Redis   â”‚                  â”‚   MinIO   â”‚
â”‚ (RDS)   â”‚                   â”‚  Cluster  â”‚                  â”‚   (OSS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æ¨èäº‘æœåŠ¡
- **æœåŠ¡å™¨**ï¼šé˜¿é‡Œäº‘ECS / AWS EC2
- **æ•°æ®åº“**ï¼šé˜¿é‡Œäº‘RDS PostgreSQL
- **ç¼“å­˜**ï¼šé˜¿é‡Œäº‘Redis
- **å­˜å‚¨**ï¼šé˜¿é‡Œäº‘OSS
- **å®¹å™¨**ï¼šé˜¿é‡Œäº‘ACK (Kubernetes)

---

## ä¹ã€å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] æ•°æ®å¯¼å‡º

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ

---

## åã€åˆ†ç±»é¢„è®¾

### 10.1 æ”¯å‡ºåˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | å­åˆ†ç±» |
|------|------|--------|
| ğŸ½ï¸ | é¤é¥® | æ—©é¤ã€åˆé¤ã€æ™šé¤ã€é¥®æ–™ã€é›¶é£Ÿ |
| ğŸ  | ä½æˆ¿ | æˆ¿ç§Ÿã€ç‰©ä¸šè´¹ã€æ°´ç”µç‡ƒæ°”ã€ç»´ä¿® |
| ğŸ® | å¨±ä¹ | æ¸¸æˆã€ç”µå½±ã€KTVã€æ—…æ¸¸ |
| ğŸ‘¥ | äººæƒ… | çº¢åŒ…ã€ç¤¼ç‰©ã€è¯·å®¢ |
| ğŸ‘¶ | è‚²å„¿ | å¥¶ç²‰ã€ç©å…·ã€æ•™è‚²ã€åŒ»ç–— |
| âœˆï¸ | å·®æ—… | æœºç¥¨ã€é…’åº—ã€æ‰“è½¦ã€ç«è½¦ |
| ğŸšŒ | äº¤é€š | å…¬äº¤ã€åœ°é“ã€æ‰“è½¦ã€å…±äº«å•è½¦ |
| ğŸš— | æ±½è½¦ | åŠ æ²¹ã€åœè½¦ã€ä¿å…»ã€ä¿é™© |
| ğŸ›’ | è´­ç‰© | æœè£…ã€æ—¥ç”¨å“ã€æ•°ç äº§å“ |
| ğŸ’¼ | åŠå…¬ | åŠå…¬ç”¨å“ã€æ‰“å°ã€å¿«é€’ |
| ğŸ¥ | åŒ»ç–— | æŒ‚å·ã€è¯å“ã€ä½“æ£€ |
| ğŸƒ | è¿åŠ¨ | å¥èº«å¡ã€è¿åŠ¨è£…å¤‡ |
| ğŸ“š | å­¦ä¹  | ä¹¦ç±ã€è¯¾ç¨‹ã€åŸ¹è®­ |
| ğŸ“± | ä¼šå‘˜è®¢é˜… | è§†é¢‘ä¼šå‘˜ã€éŸ³ä¹ä¼šå‘˜ã€è½¯ä»¶ |

### 10.2 æ”¶å…¥åˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | è¯´æ˜ |
|------|------|------|
| ğŸ’° | å·¥èµ„ | æœˆè–ªã€å‘¨è–ª |
| â° | åŠ ç­ | åŠ ç­è´¹ |
| ğŸ’¼ | å…¼èŒ | å…¼èŒæ”¶å…¥ |
| ğŸ“ˆ | ç†è´¢ | åˆ©æ¯ã€è‚¡ç¥¨ã€åŸºé‡‘ |
| ğŸ | ç¦åˆ© | å…¬å¸ç¦åˆ© |
| ğŸ† | å¥–é‡‘ | å¹´ç»ˆå¥–ã€ç»©æ•ˆå¥– |
| ğŸ¦ | å…¬ç§¯é‡‘ | å…¬ç§¯é‡‘æå– |
| ğŸ§§ | çº¢åŒ… | æ”¶åˆ°çš„çº¢åŒ… |
| ğŸ’ | ç¤¼é‡‘ | æ”¶åˆ°çš„ç¤¼é‡‘ |
| ğŸª | ç»è¥æ‰€å¾— | ç”Ÿæ„æ”¶å…¥ |
| ğŸ² | æ„å¤–æ¥é’± | ä¸­å¥–ã€é€€æ¬¾ç­‰ |

---

## åä¸€ã€å®‰å…¨è®¾è®¡

### 11.1 æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- HTTPSå…¨é“¾è·¯åŠ å¯†
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤

### 11.2 ç”¨æˆ·éšç§
- æœ€å°åŒ–æ•°æ®æ”¶é›†
- ç”¨æˆ·æ•°æ®å¯å¯¼å‡º/åˆ é™¤
- ç¬¬ä¸‰æ–¹æœåŠ¡æ•°æ®è„±æ•
- ç¬¦åˆGDPR/ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•

### 11.3 APIå®‰å…¨
- JWT Token + Refresh Token
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- æ¥å£ç­¾åéªŒè¯
- æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

---

## åäºŒã€ç¬¬ä¸‰æ–¹ç™»å½•è®¾è®¡

### 12.1 æ”¯æŒçš„ç™»å½•æ–¹å¼

| ç™»å½•æ–¹å¼ | å¹³å° | æŠ€æœ¯æ–¹æ¡ˆ |
|----------|------|----------|
| å¾®ä¿¡ç™»å½• | iOS/Android | å¾®ä¿¡å¼€æ”¾å¹³å°SDK |
| Appleç™»å½• | iOS | Sign in with Apple |
| æ‰‹æœºå·ç™»å½• | å…¨å¹³å° | çŸ­ä¿¡éªŒè¯ç  |
| é‚®ç®±ç™»å½• | å…¨å¹³å° | é‚®ç®±+å¯†ç  |

### 12.2 å¾®ä¿¡ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ å¾®ä¿¡æˆæƒ  â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ æ‹‰èµ·å¾®ä¿¡  â”‚     â”‚ è·å–code â”‚     â”‚ æ¢å–ä¿¡æ¯  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 Appleç™»å½•æµç¨‹ (iOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ Appleæˆæƒ â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ Face ID  â”‚     â”‚ è·å–Token â”‚     â”‚ éªŒè¯JWT  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.4 ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šè¡¨

```sql
-- ç¬¬ä¸‰æ–¹ç™»å½•ç»‘å®šè¡¨
CREATE TABLE oauth_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    provider VARCHAR(20) NOT NULL,      -- wechat, apple, google
    provider_user_id VARCHAR(100) NOT NULL,
    union_id VARCHAR(100),              -- å¾®ä¿¡UnionID
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    raw_data JSONB,                     -- åŸå§‹è¿”å›æ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(provider, provider_user_id)
);
```

---

## åä¸‰ã€å¤šè´§å¸ç³»ç»Ÿè®¾è®¡

### 13.1 è´§å¸æ”¯æŒ

æ”¯æŒå…¨çƒä¸»æµè´§å¸ï¼Œæ ¹æ®ç”¨æˆ·IPè‡ªåŠ¨è®¾ç½®é»˜è®¤è´§å¸ï¼š

| è´§å¸ä»£ç  | è´§å¸åç§° | ç¬¦å· | å›½å®¶/åœ°åŒº |
|----------|----------|------|-----------|
| CNY | äººæ°‘å¸ | Â¥ | ä¸­å›½å¤§é™† |
| USD | ç¾å…ƒ | $ | ç¾å›½ |
| EUR | æ¬§å…ƒ | â‚¬ | æ¬§ç›Ÿ |
| GBP | è‹±é•‘ | Â£ | è‹±å›½ |
| JPY | æ—¥å…ƒ | Â¥ | æ—¥æœ¬ |
| HKD | æ¸¯å¸ | HK$ | é¦™æ¸¯ |
| TWD | æ–°å°å¸ | NT$ | å°æ¹¾ |
| SGD | æ–°åŠ å¡å…ƒ | S$ | æ–°åŠ å¡ |
| AUD | æ¾³å…ƒ | A$ | æ¾³å¤§åˆ©äºš |
| CAD | åŠ å…ƒ | C$ | åŠ æ‹¿å¤§ |
| KRW | éŸ©å…ƒ | â‚© | éŸ©å›½ |
| THB | æ³°é“¢ | à¸¿ | æ³°å›½ |
| MYR | é©¬æ¥è¥¿äºšä»¤å‰ | RM | é©¬æ¥è¥¿äºš |

### 13.2 æ±‡ç‡ç®¡ç†

```sql
-- è´§å¸è¡¨
CREATE TABLE currencies (
    code VARCHAR(3) PRIMARY KEY,        -- ISO 4217
    name VARCHAR(50) NOT NULL,
    name_en VARCHAR(50) NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    decimal_places INT DEFAULT 2,
    is_active BOOLEAN DEFAULT TRUE
);

-- æ±‡ç‡è¡¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
CREATE TABLE exchange_rates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    base_currency VARCHAR(3) DEFAULT 'USD',
    target_currency VARCHAR(3) NOT NULL,
    rate DECIMAL(20,10) NOT NULL,
    rate_date DATE NOT NULL,
    source VARCHAR(50),                 -- æ•°æ®æ¥æº
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(base_currency, target_currency, rate_date)
);

-- ç”¨æˆ·è´§å¸è®¾ç½®
ALTER TABLE users ADD COLUMN default_currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE users ADD COLUMN detected_country VARCHAR(2);  -- IPæ£€æµ‹å›½å®¶
```

### 13.3 è´¦ç›®è´§å¸æ‰©å±•

```sql
-- è´¦ç›®è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE transactions ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE transactions ADD COLUMN original_amount DECIMAL(15,2);      -- åŸå§‹é‡‘é¢
ALTER TABLE transactions ADD COLUMN original_currency VARCHAR(3);        -- åŸå§‹è´§å¸
ALTER TABLE transactions ADD COLUMN exchange_rate DECIMAL(20,10);       -- è½¬æ¢æ±‡ç‡

-- è´¦æˆ·è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE accounts ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
```

### 13.4 è´§å¸è½¬æ¢é€»è¾‘

```python
# è´§å¸è½¬æ¢æœåŠ¡
class CurrencyService:
    async def convert(
        self,
        amount: Decimal,
        from_currency: str,
        to_currency: str,
        date: date = None
    ) -> tuple[Decimal, Decimal]:
        """
        è¿”å›: (è½¬æ¢åé‡‘é¢, æ±‡ç‡)
        """
        if from_currency == to_currency:
            return amount, Decimal('1')

        rate = await self.get_rate(from_currency, to_currency, date)
        converted = amount * rate
        return converted.quantize(Decimal('0.01')), rate

    async def get_rate(self, from_curr: str, to_curr: str, date: date = None):
        # 1. ä¼˜å…ˆä»ç¼“å­˜è·å–
        # 2. ä»æ•°æ®åº“è·å–
        # 3. è°ƒç”¨æ±‡ç‡APIæ›´æ–°
        pass
```

### 13.5 IPåœ°ç†ä½ç½®æ£€æµ‹

```python
# ç™»å½•/æ³¨å†Œæ—¶æ£€æµ‹ç”¨æˆ·æ‰€åœ¨å›½å®¶
async def detect_user_location(ip_address: str) -> dict:
    """
    ä½¿ç”¨ IP2Location æˆ– MaxMind GeoIP2 æ£€æµ‹
    è¿”å›: {country_code: 'CN', currency: 'CNY', language: 'zh-CN'}
    """
    # æ¨èä½¿ç”¨ MaxMind GeoLite2 (å…è´¹) æˆ– GeoIP2 (ä»˜è´¹)
    pass
```

---

## åå››ã€ç¦»çº¿æ¨¡å¼è®¾è®¡

### 14.1 ç¦»çº¿æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flutter App                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Repository Layer                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ Remote Sourceâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚ Local Source â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (API)      â”‚  Sync   â”‚  (SQLite)    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                     â”‚  Sync Manager   â”‚                      â”‚
â”‚                     â”‚ (å†²çªè§£å†³/é˜Ÿåˆ—) â”‚                      â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 æœ¬åœ°æ•°æ®åº“è®¾è®¡ (SQLite)

```sql
-- ç¦»çº¿æ“ä½œé˜Ÿåˆ—
CREATE TABLE sync_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_type TEXT NOT NULL,       -- create, update, delete
    entity_type TEXT NOT NULL,          -- transaction, account, category
    entity_id TEXT NOT NULL,
    payload TEXT NOT NULL,              -- JSONæ•°æ®
    created_at INTEGER NOT NULL,        -- Unix timestamp
    retry_count INTEGER DEFAULT 0,
    last_error TEXT,
    status TEXT DEFAULT 'pending'       -- pending, syncing, synced, failed
);

-- æœ¬åœ°è´¦ç›®ç¼“å­˜
CREATE TABLE local_transactions (
    id TEXT PRIMARY KEY,
    server_id TEXT,                     -- æœåŠ¡å™¨IDï¼Œæ–°å»ºæ—¶ä¸ºNULL
    data TEXT NOT NULL,                 -- JSONå®Œæ•´æ•°æ®
    is_synced INTEGER DEFAULT 0,
    local_updated_at INTEGER NOT NULL,
    server_updated_at INTEGER,
    is_deleted INTEGER DEFAULT 0
);

-- åŒæ­¥çŠ¶æ€è¡¨
CREATE TABLE sync_status (
    entity_type TEXT PRIMARY KEY,
    last_sync_at INTEGER,
    last_server_timestamp INTEGER
);
```

### 14.3 åŒæ­¥ç­–ç•¥

```dart
class SyncManager {
  // åŒæ­¥ä¼˜å…ˆçº§
  static const syncOrder = [
    'categories',    // 1. å…ˆåŒæ­¥åˆ†ç±»
    'accounts',      // 2. å†åŒæ­¥è´¦æˆ·
    'transactions',  // 3. æœ€ååŒæ­¥è´¦ç›®
  ];

  // å†²çªè§£å†³ç­–ç•¥
  ConflictResolution resolveConflict(LocalData local, ServerData server) {
    // ç­–ç•¥1: æœåŠ¡å™¨ä¼˜å…ˆ (é»˜è®¤)
    // ç­–ç•¥2: æœ¬åœ°ä¼˜å…ˆ
    // ç­–ç•¥3: æœ€æ–°ä¿®æ”¹ä¼˜å…ˆ
    // ç­–ç•¥4: ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©

    if (server.updatedAt > local.localUpdatedAt) {
      return ConflictResolution.useServer;
    }
    return ConflictResolution.useLocal;
  }
}
```

### 14.4 ç¦»çº¿æ•°æ®æ¸…ç†ç­–ç•¥

```dart
class OfflineDataManager {
  // æ¸…ç†é…ç½®
  static const config = {
    'maxLocalDays': 90,           // æœ€å¤šä¿ç•™90å¤©æ•°æ®
    'maxLocalSize': 100 * 1024 * 1024,  // æœ€å¤§100MB
    'cleanupThreshold': 80 * 1024 * 1024, // 80MBæ—¶å¼€å§‹æ¸…ç†
    'keepRecentDays': 30,         // å§‹ç»ˆä¿ç•™æœ€è¿‘30å¤©
  };

  Future<void> cleanupIfNeeded() async {
    final currentSize = await getLocalDataSize();

    if (currentSize > config['cleanupThreshold']) {
      // 1. åˆ é™¤è¶…è¿‡90å¤©çš„å·²åŒæ­¥æ•°æ®
      await deleteOldSyncedData(config['maxLocalDays']);

      // 2. å¦‚æœè¿˜è¶…è¿‡é˜ˆå€¼ï¼Œå‹ç¼©å›¾ç‰‡ç¼“å­˜
      await compressImageCache();

      // 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      await clearTempFiles();
    }
  }

  // å®šæœŸæ¸…ç†ä»»åŠ¡ (æ¯å‘¨ä¸€æ¬¡)
  void scheduleWeeklyCleanup() {
    // åœ¨WiFiç¯å¢ƒä¸‹æ‰§è¡Œ
    // åœ¨å……ç”µçŠ¶æ€ä¸‹æ‰§è¡Œ
    // åœ¨Appåå°æ—¶æ‰§è¡Œ
  }
}
```

### 14.5 å­˜å‚¨ç©ºé—´ç®¡ç†ç•Œé¢

```
å­˜å‚¨ç©ºé—´ç®¡ç†
â”œâ”€â”€ æ€»å ç”¨: 45.2 MB
â”‚   â”œâ”€â”€ è´¦ç›®æ•°æ®: 12.3 MB (3,240æ¡)
â”‚   â”œâ”€â”€ å›¾ç‰‡ç¼“å­˜: 28.5 MB (156å¼ )
â”‚   â””â”€â”€ å…¶ä»–ç¼“å­˜: 4.4 MB
â”œâ”€â”€ è‡ªåŠ¨æ¸…ç†: å¼€å¯
â”‚   â”œâ”€â”€ ä¿ç•™æœ€è¿‘: 90å¤©
â”‚   â””â”€â”€ æœ€å¤§ç©ºé—´: 100 MB
â””â”€â”€ [æ¸…ç†ç¼“å­˜] [å¯¼å‡ºæ•°æ®]
```

---

## åäº”ã€ä¼šå‘˜ç³»ç»Ÿè®¾è®¡

### 15.1 ç”¨æˆ·ç±»å‹ä¸ä¼šå‘˜ç­‰çº§

#### ç”¨æˆ·ç±»å‹å®šä¹‰

| ç±»å‹ | è¯´æ˜ | è·å–æ–¹å¼ |
|------|------|----------|
| **æ³¨å†Œç”¨æˆ·** | é€šè¿‡å¾®ä¿¡/Apple/æ‰‹æœºå·ç™»å½•è‡ªåŠ¨æˆä¸º | ç™»å½•å³æ³¨å†Œ |
| **è¯•ç”¨ç”¨æˆ·** | æ³¨å†Œç”¨æˆ·ç”³è¯·AIè¯•ç”¨ | ç”³è¯·1æ¬¡ï¼Œ30å¤©æœ‰æ•ˆ |
| **ä»˜è´¹ä¼šå‘˜** | è´­ä¹°ä¼šå‘˜æœåŠ¡ | å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ |

#### ä¼šå‘˜ç­‰çº§

| ç­‰çº§ | åç§° | ä»·æ ¼ | æœ‰æ•ˆæœŸ |
|------|------|------|--------|
| 0 | æ³¨å†Œç”¨æˆ· | å…è´¹ | æ°¸ä¹… |
| 1 | AIè¯•ç”¨ | å…è´¹(ä»…1æ¬¡) | 30å¤© |
| 2 | æœˆåº¦ä¼šå‘˜ | Â¥12/æœˆ | 1ä¸ªæœˆ |
| 3 | å­£åº¦ä¼šå‘˜ | Â¥30/å­£ | 3ä¸ªæœˆ |
| 4 | å¹´åº¦ä¼šå‘˜ | Â¥98/å¹´ | 1å¹´ |
| 5 | ç»ˆèº«ä¼šå‘˜ | Â¥298 | æ°¸ä¹… |

### 15.2 åŠŸèƒ½æƒç›Šå¯¹æ¯”

| åŠŸèƒ½ | æ³¨å†Œç”¨æˆ· | AIè¯•ç”¨(30å¤©) | ä»˜è´¹ä¼šå‘˜ |
|------|----------|--------------|----------|
| **åŸºç¡€è®°è´¦** | | | |
| æ‰‹åŠ¨è®°è´¦ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| è´¦æœ¬æ•°é‡ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| è´¦æˆ·æ•°é‡ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| æˆå‘˜åä½œ | âœ… 10äºº | âœ… 10äºº | âœ… 10äºº |
| **AIåŠŸèƒ½** | | | |
| å›¾ç‰‡è¯†åˆ«è®°è´¦ | âŒ | âœ… æ— é™ | âœ… æ— é™ |
| è¯­éŸ³è®°è´¦ | âŒ | âœ… æ— é™ | âœ… æ— é™ |
| é‚®ç®±è´¦å•è§£æ | âŒ | âœ… | âœ… |
| æ™ºèƒ½åˆ†ç±»å»ºè®® | âŒ | âœ… | âœ… |
| **ç»Ÿè®¡æŠ¥è¡¨** | | | |
| åŸºç¡€ç»Ÿè®¡ | âœ… | âœ… | âœ… |
| è¶‹åŠ¿åˆ†æ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| åˆ†ç±»å æ¯” | âœ… | âœ… | âœ… |
| å¹´åº¦æŠ¥å‘Š | âœ… | âœ… | âœ… |
| è‡ªå®šä¹‰æŠ¥è¡¨ | âœ… | âœ… | âœ… |
| **æ•°æ®åŠŸèƒ½** | | | |
| æ•°æ®å¯¼å‡º(CSV) | âœ… | âœ… | âœ… |
| æ•°æ®å¯¼å‡º(Excel) | âœ… | âœ… | âœ… |
| äº‘ç«¯å¤‡ä»½ | âœ… è‡ªåŠ¨/æ—¥ | âœ… è‡ªåŠ¨/æ—¥ | âœ… è‡ªåŠ¨/æ—¥ |
| å†å²å¤‡ä»½ä¿ç•™ | âœ… 30ä»½ | âœ… 30ä»½ | âœ… 30ä»½ |
| **é«˜çº§åŠŸèƒ½** | | | |
| å®šæ—¶è®°è´¦ | âœ… | âœ… | âœ… |
| æ¡Œé¢å°ç»„ä»¶ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| è‡ªå®šä¹‰åˆ†ç±»å›¾æ ‡ | âœ… | âœ… | âœ… |
| ä¸»é¢˜çš®è‚¤ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| å»å¹¿å‘Š | âœ… | âœ… | âœ… |

**æ€»ç»“**ï¼šæ³¨å†Œç”¨æˆ· = å…¨åŠŸèƒ½(é™¤AI) | AIè¯•ç”¨ = å…¨åŠŸèƒ½(30å¤©) | ä»˜è´¹ä¼šå‘˜ = å…¨åŠŸèƒ½(æ°¸ä¹…AI)

### 15.3 AIè¯•ç”¨ç”³è¯·æœºåˆ¶

```python
class AITrialService:
    """AIåŠŸèƒ½è¯•ç”¨æœåŠ¡"""

    TRIAL_DURATION_DAYS = 30  # è¯•ç”¨æœŸ30å¤©

    async def apply_trial(self, user_id: str) -> dict:
        """ç”³è¯·AIè¯•ç”¨"""
        user = await self.get_user(user_id)

        # æ£€æŸ¥æ˜¯å¦å·²ç»ç”³è¯·è¿‡è¯•ç”¨
        if user.has_used_trial:
            return {
                'success': False,
                'message': 'æ‚¨å·²ä½¿ç”¨è¿‡AIè¯•ç”¨æœºä¼šï¼Œè¯·å‡çº§ä¼šå‘˜äº«å—å®Œæ•´åŠŸèƒ½'
            }

        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»˜è´¹ä¼šå‘˜
        if user.is_paid_member:
            return {
                'success': False,
                'message': 'æ‚¨å·²æ˜¯ä»˜è´¹ä¼šå‘˜ï¼Œæ— éœ€ç”³è¯·è¯•ç”¨'
            }

        # æ¿€æ´»è¯•ç”¨
        trial_expire = datetime.now() + timedelta(days=self.TRIAL_DURATION_DAYS)
        await self.activate_trial(user_id, trial_expire)

        return {
            'success': True,
            'message': f'AIåŠŸèƒ½è¯•ç”¨å·²æ¿€æ´»ï¼Œæœ‰æ•ˆæœŸè‡³ {trial_expire.strftime("%Y-%m-%d")}',
            'expire_at': trial_expire
        }

    async def check_ai_access(self, user_id: str) -> tuple[bool, str]:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰AIåŠŸèƒ½æƒé™"""
        user = await self.get_user(user_id)

        # ä»˜è´¹ä¼šå‘˜
        if user.is_paid_member:
            return True, ""

        # è¯•ç”¨æœŸå†…
        if user.trial_expire_at and user.trial_expire_at > datetime.now():
            days_left = (user.trial_expire_at - datetime.now()).days
            return True, f"è¯•ç”¨æœŸå‰©ä½™{days_left}å¤©"

        # æœªå¼€é€š
        if not user.has_used_trial:
            return False, "æ‚¨å°šæœªå¼€é€šAIåŠŸèƒ½ï¼Œå¯ç”³è¯·30å¤©å…è´¹è¯•ç”¨"
        else:
            return False, "AIè¯•ç”¨å·²è¿‡æœŸï¼Œå‡çº§ä¼šå‘˜ç»§ç»­ä½¿ç”¨"
```

### 15.4 ä¼šå‘˜æ•°æ®è¡¨

```sql
-- ç”¨æˆ·è¡¨ï¼ˆæ‰©å±•å­—æ®µï¼‰
ALTER TABLE users ADD COLUMN user_type INT DEFAULT 0;        -- 0:æ³¨å†Œç”¨æˆ· 1:è¯•ç”¨ç”¨æˆ· 2:ä»˜è´¹ä¼šå‘˜
ALTER TABLE users ADD COLUMN has_used_trial BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦å·²ä½¿ç”¨è¯•ç”¨
ALTER TABLE users ADD COLUMN trial_expire_at TIMESTAMP;      -- è¯•ç”¨åˆ°æœŸæ—¶é—´
ALTER TABLE users ADD COLUMN member_level INT DEFAULT 0;     -- ä¼šå‘˜ç­‰çº§ 0:æ—  2:æœˆåº¦ 3:å­£åº¦ 4:å¹´åº¦ 5:ç»ˆèº«
ALTER TABLE users ADD COLUMN member_expire_at TIMESTAMP;     -- ä¼šå‘˜åˆ°æœŸæ—¶é—´
ALTER TABLE users ADD COLUMN is_lifetime BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦ç»ˆèº«ä¼šå‘˜

-- ä¼šå‘˜è®¢å•è¡¨
CREATE TABLE member_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    order_no VARCHAR(50) UNIQUE NOT NULL,
    product_type INT NOT NULL,           -- 2:æœˆåº¦ 3:å­£åº¦ 4:å¹´åº¦ 5:ç»ˆèº«
    original_amount DECIMAL(10,2) NOT NULL,  -- åŸä»·
    discount_amount DECIMAL(10,2) DEFAULT 0, -- ä¼˜æƒ é‡‘é¢
    pay_amount DECIMAL(10,2) NOT NULL,   -- å®ä»˜é‡‘é¢
    currency VARCHAR(3) DEFAULT 'CNY',
    payment_method VARCHAR(20),          -- wechat_pay, alipay
    payment_status INT DEFAULT 0,        -- 0:å¾…æ”¯ä»˜ 1:å·²æ”¯ä»˜ 2:å·²å–æ¶ˆ 3:å·²é€€æ¬¾
    paid_at TIMESTAMP,
    member_start_at TIMESTAMP,           -- ä¼šå‘˜å¼€å§‹æ—¶é—´
    member_expire_at TIMESTAMP,          -- ä¼šå‘˜åˆ°æœŸæ—¶é—´
    transaction_id VARCHAR(100),         -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    coupon_id UUID,                      -- ä½¿ç”¨çš„ä¼˜æƒ åˆ¸
    campaign_id UUID,                    -- å‚ä¸çš„æ´»åŠ¨
    refund_amount DECIMAL(10,2),
    refund_at TIMESTAMP,
    refund_reason TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è¯•ç”¨è®°å½•è¡¨
CREATE TABLE trial_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) UNIQUE,
    applied_at TIMESTAMP DEFAULT NOW(),
    expire_at TIMESTAMP NOT NULL,
    is_converted BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦è½¬åŒ–ä¸ºä»˜è´¹
    converted_at TIMESTAMP,
    converted_order_id UUID
);
```

---

## åäº”Aã€æ”¯ä»˜ç³»ç»Ÿè®¾è®¡

### 15A.1 æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

| æ”¯ä»˜æ–¹å¼ | åœºæ™¯ | æ¥å…¥æ–¹æ¡ˆ |
|----------|------|----------|
| **å¾®ä¿¡æ”¯ä»˜** | Appå†…æ”¯ä»˜ | å¾®ä¿¡å¼€æ”¾å¹³å° APPæ”¯ä»˜ |
| **æ”¯ä»˜å®** | Appå†…æ”¯ä»˜ | æ”¯ä»˜å®å¼€æ”¾å¹³å° APPæ”¯ä»˜ |
| **Apple Pay** | iOS Appå†…è´­ | StoreKit (IAP) |

### 15A.2 æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚     â”‚   App    â”‚     â”‚  åç«¯    â”‚     â”‚ æ”¯ä»˜å¹³å°  â”‚
â”‚ é€‰æ‹©å¥—é¤ â”‚     â”‚ åˆ›å»ºè®¢å• â”‚     â”‚ ç”Ÿæˆå‚æ•° â”‚     â”‚ å‘èµ·æ”¯ä»˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚
     â”‚ 1.é€‰æ‹©ä¼šå‘˜å¥—é¤  â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
     â”‚                â”‚ 2.è¯·æ±‚åˆ›å»ºè®¢å•  â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
     â”‚                â”‚                â”‚ 3.ç”Ÿæˆè®¢å•å·    â”‚
     â”‚                â”‚                â”‚ è°ƒç”¨æ”¯ä»˜API     â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 4.è¿”å›æ”¯ä»˜å‚æ•°  â”‚
     â”‚                â”‚ 5.è°ƒèµ·æ”¯ä»˜SDK   â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚ 6.ç”¨æˆ·å®Œæˆæ”¯ä»˜  â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚ 7.å¼‚æ­¥å›è°ƒé€šçŸ¥  â”‚
     â”‚                â”‚                â”‚ 8.æ›´æ–°è®¢å•çŠ¶æ€  â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ å¼€é€šä¼šå‘˜æƒç›Š    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 9.é€šçŸ¥ç”¨æˆ·     â”‚                â”‚
     â”‚  æ”¯ä»˜æˆåŠŸ       â”‚                â”‚                â”‚
```

### 15A.3 å¾®ä¿¡æ”¯ä»˜æ¥å…¥

```python
import hashlib
import time
from wechatpay import WeChatPay

class WeChatPayService:
    def __init__(self):
        self.client = WeChatPay(
            appid=settings.WECHAT_APP_ID,
            mch_id=settings.WECHAT_MCH_ID,
            api_key=settings.WECHAT_API_KEY,
            cert_path=settings.WECHAT_CERT_PATH,
            key_path=settings.WECHAT_KEY_PATH,
        )

    async def create_order(
        self,
        order_no: str,
        amount: int,  # å•ä½ï¼šåˆ†
        description: str,
        user_openid: str = None
    ) -> dict:
        """åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•ï¼ˆAPPæ”¯ä»˜ï¼‰"""

        params = {
            'body': description,
            'out_trade_no': order_no,
            'total_fee': amount,
            'spbill_create_ip': '127.0.0.1',
            'notify_url': f'{settings.API_BASE_URL}/api/v1/payment/wechat/notify',
            'trade_type': 'APP',
        }

        result = self.client.unified_order(**params)

        if result['return_code'] == 'SUCCESS':
            # ç”ŸæˆAPPè°ƒèµ·æ”¯ä»˜çš„å‚æ•°
            timestamp = str(int(time.time()))
            nonce_str = self._generate_nonce()
            prepay_id = result['prepay_id']

            sign_params = {
                'appid': settings.WECHAT_APP_ID,
                'partnerid': settings.WECHAT_MCH_ID,
                'prepayid': prepay_id,
                'package': 'Sign=WXPay',
                'noncestr': nonce_str,
                'timestamp': timestamp,
            }
            sign = self._generate_sign(sign_params)

            return {
                'success': True,
                'pay_params': {
                    **sign_params,
                    'sign': sign,
                }
            }

        return {'success': False, 'message': result.get('return_msg')}

    async def handle_notify(self, xml_data: str) -> dict:
        """å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ"""
        result = self.client.parse_notify(xml_data)

        if result['return_code'] == 'SUCCESS' and result['result_code'] == 'SUCCESS':
            order_no = result['out_trade_no']
            transaction_id = result['transaction_id']

            # æ›´æ–°è®¢å•çŠ¶æ€
            await self._complete_order(order_no, transaction_id)

            return {'return_code': 'SUCCESS', 'return_msg': 'OK'}

        return {'return_code': 'FAIL', 'return_msg': 'Verification failed'}
```

### 15A.4 æ”¯ä»˜å®æ¥å…¥

```python
from alipay import AliPay

class AlipayService:
    def __init__(self):
        self.client = AliPay(
            appid=settings.ALIPAY_APP_ID,
            app_private_key_string=settings.ALIPAY_PRIVATE_KEY,
            alipay_public_key_string=settings.ALIPAY_PUBLIC_KEY,
            sign_type='RSA2',
        )

    async def create_order(
        self,
        order_no: str,
        amount: str,  # å•ä½ï¼šå…ƒ
        subject: str,
    ) -> dict:
        """åˆ›å»ºæ”¯ä»˜å®è®¢å•ï¼ˆAPPæ”¯ä»˜ï¼‰"""

        order_string = self.client.api_alipay_trade_app_pay(
            out_trade_no=order_no,
            total_amount=amount,
            subject=subject,
            notify_url=f'{settings.API_BASE_URL}/api/v1/payment/alipay/notify',
        )

        return {
            'success': True,
            'order_string': order_string,  # ç›´æ¥ä¼ ç»™æ”¯ä»˜å®SDK
        }

    async def handle_notify(self, data: dict) -> str:
        """å¤„ç†æ”¯ä»˜å®å›è°ƒ"""
        # éªŒç­¾
        signature = data.pop('sign')
        if self.client.verify(data, signature):
            if data['trade_status'] in ('TRADE_SUCCESS', 'TRADE_FINISHED'):
                order_no = data['out_trade_no']
                transaction_id = data['trade_no']

                await self._complete_order(order_no, transaction_id)

                return 'success'

        return 'fail'
```

### 15A.5 æ”¯ä»˜ç›¸å…³æ•°æ®è¡¨

```sql
-- æ”¯ä»˜æµæ°´è¡¨
CREATE TABLE payment_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES member_orders(id),
    payment_method VARCHAR(20) NOT NULL,     -- wechat_pay, alipay, apple_iap
    transaction_id VARCHAR(100),             -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    status INT DEFAULT 0,                    -- 0:å¾…æ”¯ä»˜ 1:æˆåŠŸ 2:å¤±è´¥ 3:å·²é€€æ¬¾
    raw_notify TEXT,                         -- åŸå§‹å›è°ƒæ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é€€æ¬¾è®°å½•è¡¨
CREATE TABLE refund_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES member_orders(id),
    payment_transaction_id UUID REFERENCES payment_transactions(id),
    refund_no VARCHAR(50) UNIQUE NOT NULL,
    refund_amount DECIMAL(10,2) NOT NULL,
    reason TEXT,
    status INT DEFAULT 0,                    -- 0:å¤„ç†ä¸­ 1:æˆåŠŸ 2:å¤±è´¥
    operator_id UUID,                        -- æ“ä½œäººï¼ˆç®¡ç†å‘˜ï¼‰
    third_party_refund_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

---

## åäº”Bã€ç®¡ç†åå°è®¾è®¡

### 15B.1 ç®¡ç†åå°åŠŸèƒ½æ¨¡å—

```
ç®¡ç†åå°
â”œâ”€â”€ é¦–é¡µä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ ä»Šæ—¥æ•°æ®æ¦‚è§ˆï¼ˆæ–°å¢ç”¨æˆ·ã€æ´»è·ƒç”¨æˆ·ã€æ”¶å…¥ï¼‰
â”‚   â”œâ”€â”€ è¶‹åŠ¿å›¾è¡¨
â”‚   â””â”€â”€ å¾…å¤„ç†äº‹é¡¹
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ï¼ˆæœç´¢ã€ç­›é€‰ã€å¯¼å‡ºï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·è¯¦æƒ…ï¼ˆåŸºæœ¬ä¿¡æ¯ã€ä¼šå‘˜çŠ¶æ€ã€æ“ä½œè®°å½•ï¼‰
â”‚   â”œâ”€â”€ ä¼šå‘˜ç®¡ç†ï¼ˆå¼€é€šã€å»¶æœŸã€å–æ¶ˆï¼‰
â”‚   â””â”€â”€ ç”¨æˆ·å°ç¦/è§£å°
â”œâ”€â”€ è®¢å•ç®¡ç†
â”‚   â”œâ”€â”€ è®¢å•åˆ—è¡¨
â”‚   â”œâ”€â”€ è®¢å•è¯¦æƒ…
â”‚   â”œâ”€â”€ é€€æ¬¾å¤„ç†
â”‚   â””â”€â”€ è®¢å•ç»Ÿè®¡
â”œâ”€â”€ è¥é”€æ´»åŠ¨
â”‚   â”œâ”€â”€ æ´»åŠ¨ç®¡ç†ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€ä¸Šä¸‹çº¿ï¼‰
â”‚   â”œâ”€â”€ ä¼˜æƒ åˆ¸ç®¡ç†
â”‚   â”œâ”€â”€ æ´»åŠ¨æ•°æ®åˆ†æ
â”‚   â””â”€â”€ æ´»åŠ¨æ¨¡æ¿åº“
â”œâ”€â”€ å†…å®¹ç®¡ç†
â”‚   â”œâ”€â”€ å…¬å‘Šç®¡ç†
â”‚   â”œâ”€â”€ æ¨é€ç®¡ç†
â”‚   â””â”€â”€ Bannerç®¡ç†
â”œâ”€â”€ æ•°æ®ç»Ÿè®¡
â”‚   â”œâ”€â”€ ç”¨æˆ·ç»Ÿè®¡
â”‚   â”œâ”€â”€ æ”¶å…¥ç»Ÿè®¡
â”‚   â”œâ”€â”€ è½¬åŒ–æ¼æ–—
â”‚   â””â”€â”€ ç•™å­˜åˆ†æ
â””â”€â”€ ç³»ç»Ÿè®¾ç½®
    â”œâ”€â”€ ç®¡ç†å‘˜ç®¡ç†
    â”œâ”€â”€ è§’è‰²æƒé™
    â”œâ”€â”€ æ“ä½œæ—¥å¿—
    â””â”€â”€ ç³»ç»Ÿé…ç½®
```

### 15B.2 è¥é”€æ´»åŠ¨ç±»å‹æ¨¡æ¿

#### æ´»åŠ¨ç±»å‹ä¸€è§ˆ

| æ´»åŠ¨ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| **æ–°ç”¨æˆ·ä¸“äº«** | é¦–æ¬¡ä»˜è´¹ç‰¹ä»· | æ‹‰æ–°è½¬åŒ– |
| **é™æ—¶æŠ˜æ‰£** | æŒ‡å®šæ—¶é—´æ®µæŠ˜æ‰£ | ä¿ƒé”€å†²é‡ |
| **æ»¡å‡æ´»åŠ¨** | æ»¡è¶³æ¡ä»¶å‡å… | æå‡å®¢å•ä»· |
| **ä¹°èµ æ´»åŠ¨** | è´­ä¹°èµ é€æ—¶é•¿ | æå‡ä»˜è´¹ç‡ |
| **é‚€è¯·æœ‰ç¤¼** | é‚€è¯·å¥½å‹åŒæ–¹å—ç›Š | è£‚å˜æ‹‰æ–° |
| **ç»­è´¹ä¼˜æƒ ** | è€ç”¨æˆ·ç»­è´¹æŠ˜æ‰£ | æå‡ç»­è´¹ç‡ |
| **èŠ‚æ—¥æ´»åŠ¨** | èŠ‚å‡æ—¥ç‰¹åˆ«ä¼˜æƒ  | èŠ‚æ—¥è¥é”€ |
| **ä¼šå‘˜æ—¥** | å›ºå®šæ—¥æœŸç‰¹æƒ  | åŸ¹å…»æ¶ˆè´¹ä¹ æƒ¯ |
| **ç§¯åˆ†å…‘æ¢** | ç§¯åˆ†æ¢ä¼˜æƒ åˆ¸/æ—¶é•¿ | ç”¨æˆ·æ¿€åŠ± |
| **æŠ½å¥–æ´»åŠ¨** | éšæœºå¥–åŠ± | å¢åŠ è¶£å‘³æ€§ |

### 15B.3 æ´»åŠ¨é…ç½®æ•°æ®è¡¨

```sql
-- è¥é”€æ´»åŠ¨è¡¨
CREATE TABLE campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    campaign_type VARCHAR(50) NOT NULL,      -- æ´»åŠ¨ç±»å‹
    description TEXT,
    rules JSONB NOT NULL,                    -- æ´»åŠ¨è§„åˆ™é…ç½®
    start_at TIMESTAMP NOT NULL,
    end_at TIMESTAMP NOT NULL,
    target_users JSONB,                      -- ç›®æ ‡ç”¨æˆ·æ¡ä»¶
    budget DECIMAL(10,2),                    -- é¢„ç®—ä¸Šé™
    used_budget DECIMAL(10,2) DEFAULT 0,
    max_participants INT,                    -- æœ€å¤§å‚ä¸äººæ•°
    current_participants INT DEFAULT 0,
    status INT DEFAULT 0,                    -- 0:è‰ç¨¿ 1:å¾…å¼€å§‹ 2:è¿›è¡Œä¸­ 3:å·²ç»“æŸ 4:å·²å–æ¶ˆ
    created_by UUID,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ´»åŠ¨è§„åˆ™ç¤ºä¾‹ (rules JSONB)
-- æ–°ç”¨æˆ·ä¸“äº«:
-- {
--   "type": "new_user_discount",
--   "discount_type": "percent",    -- percent/fixed
--   "discount_value": 50,          -- 5æŠ˜ æˆ– å›ºå®šå‡å…é‡‘é¢
--   "applicable_products": [2,3,4], -- é€‚ç”¨çš„ä¼šå‘˜ç±»å‹
--   "limit_per_user": 1
-- }

-- é™æ—¶æŠ˜æ‰£:
-- {
--   "type": "time_limited_discount",
--   "discount_type": "percent",
--   "discount_value": 70,          -- 7æŠ˜
--   "applicable_products": [4],    -- ä»…å¹´åº¦ä¼šå‘˜
--   "flash_sale_times": [          -- ç§’æ€æ—¶æ®µ
--     {"start": "10:00", "end": "12:00"},
--     {"start": "20:00", "end": "22:00"}
--   ]
-- }

-- ä¹°èµ æ´»åŠ¨:
-- {
--   "type": "buy_get_free",
--   "buy_product": 4,              -- è´­ä¹°å¹´åº¦ä¼šå‘˜
--   "gift_days": 60,               -- èµ é€60å¤©
--   "gift_description": "ä¹°ä¸€å¹´é€ä¸¤ä¸ªæœˆ"
-- }

-- é‚€è¯·æœ‰ç¤¼:
-- {
--   "type": "referral",
--   "inviter_reward": {"type": "days", "value": 7},    -- é‚€è¯·äººè·å¾—7å¤©
--   "invitee_reward": {"type": "days", "value": 7},    -- è¢«é‚€è¯·äººè·å¾—7å¤©
--   "invitee_must_pay": true,      -- è¢«é‚€è¯·äººéœ€ä»˜è´¹æ‰ç®—æœ‰æ•ˆ
--   "max_invites": 10              -- æ¯äººæœ€å¤šé‚€è¯·10äºº
-- }

-- ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    coupon_type INT NOT NULL,                -- 1:æŠ˜æ‰£åˆ¸ 2:æ»¡å‡åˆ¸ 3:ä»£é‡‘åˆ¸ 4:å…è´¹æ—¶é•¿åˆ¸
    discount_value DECIMAL(10,2) NOT NULL,   -- æŠ˜æ‰£æ¯”ä¾‹/å‡å…é‡‘é¢/å…è´¹å¤©æ•°
    min_amount DECIMAL(10,2),                -- æœ€ä½æ¶ˆè´¹ï¼ˆæ»¡å‡åˆ¸ç”¨ï¼‰
    applicable_products INT[],               -- é€‚ç”¨äº§å“
    total_count INT,                         -- å‘æ”¾æ€»é‡
    claimed_count INT DEFAULT 0,             -- å·²é¢†å–æ•°é‡
    used_count INT DEFAULT 0,                -- å·²ä½¿ç”¨æ•°é‡
    claim_limit_per_user INT DEFAULT 1,      -- æ¯äººé™é¢†
    valid_days INT,                          -- é¢†å–åæœ‰æ•ˆå¤©æ•°
    start_at TIMESTAMP,
    expire_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·ä¼˜æƒ åˆ¸
CREATE TABLE user_coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    coupon_id UUID REFERENCES coupons(id),
    status INT DEFAULT 0,                    -- 0:æœªä½¿ç”¨ 1:å·²ä½¿ç”¨ 2:å·²è¿‡æœŸ
    claimed_at TIMESTAMP DEFAULT NOW(),
    expire_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP,
    used_order_id UUID,
    UNIQUE(user_id, coupon_id)
);

-- é‚€è¯·è®°å½•è¡¨
CREATE TABLE referral_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    inviter_user_id UUID REFERENCES users(id),
    invitee_user_id UUID REFERENCES users(id),
    inviter_reward_type VARCHAR(20),         -- days, coupon
    inviter_reward_value INT,
    inviter_rewarded BOOLEAN DEFAULT FALSE,
    invitee_reward_type VARCHAR(20),
    invitee_reward_value INT,
    invitee_rewarded BOOLEAN DEFAULT FALSE,
    invitee_paid BOOLEAN DEFAULT FALSE,      -- è¢«é‚€è¯·äººæ˜¯å¦å·²ä»˜è´¹
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ´»åŠ¨å‚ä¸è®°å½•
CREATE TABLE campaign_participations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    user_id UUID REFERENCES users(id),
    participation_type VARCHAR(50),          -- claim_coupon, place_order, invite
    order_id UUID,
    discount_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(campaign_id, user_id, participation_type)
);
```

### 15B.4 é¢„ç½®æ´»åŠ¨æ¨¡æ¿

```python
CAMPAIGN_TEMPLATES = {
    # æ–°ç”¨æˆ·ä¸“äº«
    'new_user_50off': {
        'name': 'æ–°ç”¨æˆ·é¦–å•5æŠ˜',
        'campaign_type': 'new_user_discount',
        'description': 'æ–°ç”¨æˆ·é¦–æ¬¡è´­ä¹°ä¼šå‘˜äº«5æŠ˜ä¼˜æƒ ',
        'rules': {
            'type': 'new_user_discount',
            'discount_type': 'percent',
            'discount_value': 50,
            'applicable_products': [2, 3, 4, 5],
            'limit_per_user': 1
        },
        'target_users': {'is_new': True, 'has_paid': False}
    },

    # é™æ—¶ç§’æ€
    'flash_sale': {
        'name': 'é™æ—¶ç§’æ€',
        'campaign_type': 'time_limited_discount',
        'description': 'æ•´ç‚¹ç§’æ€ï¼Œå¹´åº¦ä¼šå‘˜ä½è‡³6æŠ˜',
        'rules': {
            'type': 'time_limited_discount',
            'discount_type': 'percent',
            'discount_value': 60,
            'applicable_products': [4],
            'flash_sale_times': [
                {'start': '10:00', 'end': '10:30'},
                {'start': '14:00', 'end': '14:30'},
                {'start': '20:00', 'end': '20:30'}
            ]
        }
    },

    # ä¹°ä¸€å¹´é€ä¸¤æœˆ
    'buy_year_get_bonus': {
        'name': 'ä¹°ä¸€å¹´é€ä¸¤æœˆ',
        'campaign_type': 'buy_get_free',
        'description': 'è´­ä¹°å¹´åº¦ä¼šå‘˜ï¼Œé¢å¤–èµ é€2ä¸ªæœˆ',
        'rules': {
            'type': 'buy_get_free',
            'buy_product': 4,
            'gift_days': 60,
            'gift_description': 'ä¹°12ä¸ªæœˆé€2ä¸ªæœˆï¼Œå®é™…äº«å—14ä¸ªæœˆ'
        }
    },

    # é‚€è¯·æœ‰ç¤¼
    'invite_friends': {
        'name': 'é‚€è¯·å¥½å‹ï¼ŒåŒæ–¹å„å¾—7å¤©',
        'campaign_type': 'referral',
        'description': 'é‚€è¯·å¥½å‹æ³¨å†Œå¹¶ä»˜è´¹ï¼ŒåŒæ–¹å„å¾—7å¤©ä¼šå‘˜',
        'rules': {
            'type': 'referral',
            'inviter_reward': {'type': 'days', 'value': 7},
            'invitee_reward': {'type': 'days', 'value': 7},
            'invitee_must_pay': True,
            'max_invites': 20
        }
    },

    # è€ç”¨æˆ·ç»­è´¹
    'renewal_discount': {
        'name': 'è€ç”¨æˆ·ç»­è´¹8æŠ˜',
        'campaign_type': 'renewal_discount',
        'description': 'ä¼šå‘˜åˆ°æœŸå‰30å¤©å†…ç»­è´¹äº«8æŠ˜',
        'rules': {
            'type': 'renewal_discount',
            'discount_type': 'percent',
            'discount_value': 80,
            'days_before_expire': 30,
            'applicable_products': [2, 3, 4]
        },
        'target_users': {'is_member': True, 'expire_within_days': 30}
    },

    # èŠ‚æ—¥æ´»åŠ¨ - åŒ11
    'double_11': {
        'name': 'åŒ11ç‹‚æ¬¢',
        'campaign_type': 'festival',
        'description': 'åŒ11ç‰¹æƒ ï¼Œå¹´åº¦ä¼šå‘˜ç«‹å‡111å…ƒ',
        'rules': {
            'type': 'festival_discount',
            'discount_type': 'fixed',
            'discount_value': 111,
            'applicable_products': [4, 5],
            'festival': 'double_11'
        }
    },

    # ä¼šå‘˜æ—¥
    'member_day': {
        'name': 'æ¯æœˆ8å·ä¼šå‘˜æ—¥',
        'campaign_type': 'member_day',
        'description': 'æ¯æœˆ8å·ï¼Œå…¨åœº88æŠ˜',
        'rules': {
            'type': 'member_day',
            'day_of_month': 8,
            'discount_type': 'percent',
            'discount_value': 88,
            'applicable_products': [2, 3, 4, 5]
        }
    },

    # é¦–å……è¿”ç°
    'first_charge_bonus': {
        'name': 'é¦–å……å¤šé€30å¤©',
        'campaign_type': 'first_charge',
        'description': 'é¦–æ¬¡å……å€¼ä»»æ„å¥—é¤ï¼Œé¢å¤–èµ é€30å¤©',
        'rules': {
            'type': 'first_charge_bonus',
            'bonus_days': 30,
            'applicable_products': [2, 3, 4, 5]
        },
        'target_users': {'has_paid': False}
    },

    # è¿ç»­åŒ…æœˆä¼˜æƒ 
    'subscription': {
        'name': 'è¿ç»­åŒ…æœˆä¼˜æƒ ',
        'campaign_type': 'subscription',
        'description': 'å¼€é€šè‡ªåŠ¨ç»­è´¹ï¼Œæ¯æœˆä»…éœ€9.9å…ƒ',
        'rules': {
            'type': 'subscription',
            'monthly_price': 9.9,
            'original_price': 12,
            'auto_renew': True
        }
    },

    # ç­¾åˆ°é¢†ç§¯åˆ†
    'daily_checkin': {
        'name': 'ç­¾åˆ°é¢†ç§¯åˆ†',
        'campaign_type': 'checkin',
        'description': 'æ¯æ—¥ç­¾åˆ°é¢†ç§¯åˆ†ï¼Œç§¯åˆ†å¯å…‘æ¢ä¼šå‘˜',
        'rules': {
            'type': 'checkin',
            'daily_points': 10,
            'consecutive_bonus': [
                {'days': 7, 'bonus': 50},
                {'days': 30, 'bonus': 200}
            ],
            'exchange_rate': 1000  # 1000ç§¯åˆ†=1å¤©ä¼šå‘˜
        }
    }
}
```

### 15B.5 ç®¡ç†åå°æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| å‰ç«¯æ¡†æ¶ | **Vue 3 + Element Plus** | æˆç†Ÿçš„åå°UIæ–¹æ¡ˆ |
| çŠ¶æ€ç®¡ç† | **Pinia** | Vue 3æ¨è |
| å›¾è¡¨ | **ECharts** | ä¸°å¯Œçš„æ•°æ®å¯è§†åŒ– |
| æƒé™ | **RBAC** | åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ |
| åç«¯ | å¤ç”¨ä¸»API + ç®¡ç†ä¸“ç”¨æ¥å£ | å‡å°‘é‡å¤å¼€å‘ |

### 15B.6 ç®¡ç†å‘˜æƒé™è®¾è®¡

```sql
-- ç®¡ç†å‘˜è¡¨
CREATE TABLE admins (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    role_id UUID REFERENCES admin_roles(id),
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è§’è‰²è¡¨
CREATE TABLE admin_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    permissions JSONB NOT NULL,           -- æƒé™åˆ—è¡¨
    created_at TIMESTAMP DEFAULT NOW()
);

-- é¢„ç½®è§’è‰²
-- è¶…çº§ç®¡ç†å‘˜: ["*"]
-- è¿è¥: ["user:view", "user:edit", "campaign:*", "content:*", "stats:view"]
-- å®¢æœ: ["user:view", "order:view", "order:refund"]
-- æ•°æ®åˆ†æ: ["stats:*", "user:view"]

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE admin_operation_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_id UUID REFERENCES admins(id),
    operation VARCHAR(100) NOT NULL,
    target_type VARCHAR(50),              -- user, order, campaign
    target_id UUID,
    old_value JSONB,
    new_value JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## åå…­ã€å›½é™…åŒ–(i18n)è®¾è®¡

### 16.1 æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ä»£ç  | è¯­è¨€åç§° | é»˜è®¤åœ°åŒº |
|----------|----------|----------|
| zh-CN | ç®€ä½“ä¸­æ–‡ | ä¸­å›½å¤§é™† |
| zh-TW | ç¹ä½“ä¸­æ–‡ | å°æ¹¾ã€é¦™æ¸¯ã€æ¾³é—¨ |
| en-US | è‹±è¯­ | ç¾å›½ã€è‹±å›½ã€æ¾³æ´²ç­‰ |
| ja-JP | æ—¥è¯­ | æ—¥æœ¬ |
| ko-KR | éŸ©è¯­ | éŸ©å›½ |
| th-TH | æ³°è¯­ | æ³°å›½ |
| vi-VN | è¶Šå—è¯­ | è¶Šå— |
| ms-MY | é©¬æ¥è¯­ | é©¬æ¥è¥¿äºš |

### 16.2 è¯­è¨€æ£€æµ‹ä¼˜å…ˆçº§

```dart
class LocaleManager {
  Locale detectUserLocale(UserInfo? user, String? ipCountry) {
    // 1. ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„è¯­è¨€ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    if (user?.preferredLanguage != null) {
      return Locale(user!.preferredLanguage);
    }

    // 2. æ ¹æ®IPæ£€æµ‹çš„å›½å®¶
    if (ipCountry != null) {
      return _countryToLocale(ipCountry);
    }

    // 3. è®¾å¤‡ç³»ç»Ÿè¯­è¨€
    final deviceLocale = Platform.localeName;
    if (_supportedLocales.contains(deviceLocale)) {
      return Locale(deviceLocale);
    }

    // 4. é»˜è®¤ä¸­æ–‡
    return const Locale('zh', 'CN');
  }

  static const _countryLocaleMap = {
    'CN': 'zh-CN',
    'TW': 'zh-TW',
    'HK': 'zh-TW',
    'US': 'en-US',
    'GB': 'en-US',
    'JP': 'ja-JP',
    'KR': 'ko-KR',
    'TH': 'th-TH',
    // ...
  };
}
```

### 16.3 Flutterå›½é™…åŒ–å®ç°

```yaml
# pubspec.yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: ^0.18.0

flutter:
  generate: true
```

```dart
// lib/l10n/app_zh.arb
{
  "@@locale": "zh",
  "appName": "æ™ºèƒ½è®°è´¦",
  "home": "é¦–é¡µ",
  "stats": "ç»Ÿè®¡",
  "bills": "è´¦å•",
  "profile": "æˆ‘çš„",
  "expense": "æ”¯å‡º",
  "income": "æ”¶å…¥",
  "transfer": "è½¬è´¦",
  "monthlyExpense": "æœ¬æœˆæ”¯å‡º",
  "monthlyIncome": "æœ¬æœˆæ”¶å…¥",
  "balance": "ç»“ä½™",
  "budget": "é¢„ç®—",
  "category": "åˆ†ç±»",
  "account": "è´¦æˆ·",
  "note": "å¤‡æ³¨",
  "save": "ä¿å­˜",
  "cancel": "å–æ¶ˆ",
  "delete": "åˆ é™¤",
  "edit": "ç¼–è¾‘",
  "settings": "è®¾ç½®",
  "language": "è¯­è¨€",
  "currency": "è´§å¸",
  "theme": "ä¸»é¢˜",
  "about": "å…³äº",
  "logout": "é€€å‡ºç™»å½•",
  "upgradeToVip": "å‡çº§VIP",
  "aiRecognition": "AIè¯†åˆ«",
  "voiceInput": "è¯­éŸ³è®°è´¦",
  "scanReceipt": "æ‰«æå°ç¥¨",

  "categoryFood": "é¤é¥®",
  "categoryHousing": "ä½æˆ¿",
  "categoryEntertainment": "å¨±ä¹",
  "categoryTransport": "äº¤é€š",
  "categoryShopping": "è´­ç‰©",
  "categoryMedical": "åŒ»ç–—",
  "categorySalary": "å·¥èµ„",
  "categoryBonus": "å¥–é‡‘",

  "freeUsageExhausted": "æœ¬æœˆå…è´¹{feature}æ¬¡æ•°å·²ç”¨å®Œ",
  "@freeUsageExhausted": {
    "placeholders": {
      "feature": {"type": "String"}
    }
  }
}
```

```dart
// lib/l10n/app_en.arb
{
  "@@locale": "en",
  "appName": "AI Bookkeeping",
  "home": "Home",
  "stats": "Statistics",
  "bills": "Bills",
  "profile": "Profile",
  "expense": "Expense",
  "income": "Income",
  "transfer": "Transfer",
  "monthlyExpense": "Monthly Expense",
  "monthlyIncome": "Monthly Income",
  "balance": "Balance",
  // ...
}
```

### 16.4 åç«¯å¤šè¯­è¨€æ”¯æŒ

```python
# åç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯ä¹Ÿæ”¯æŒå¤šè¯­è¨€
class I18nMessages:
    messages = {
        'auth.invalid_password': {
            'zh-CN': 'å¯†ç é”™è¯¯',
            'en-US': 'Invalid password',
            'ja-JP': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
        },
        'member.quota_exceeded': {
            'zh-CN': 'æœ¬æœˆå…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å‡çº§VIP',
            'en-US': 'Free quota exceeded, please upgrade to VIP',
            'ja-JP': 'ä»Šæœˆã®ç„¡æ–™å›æ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„',
        },
    }

    @classmethod
    def get(cls, key: str, locale: str = 'zh-CN') -> str:
        return cls.messages.get(key, {}).get(locale, key)
```

### 16.5 ç”¨æˆ·è¯­è¨€è®¾ç½®

```sql
-- ç”¨æˆ·è¡¨æ·»åŠ è¯­è¨€è®¾ç½®
ALTER TABLE users ADD COLUMN preferred_language VARCHAR(10);
ALTER TABLE users ADD COLUMN detected_language VARCHAR(10);  -- IPæ£€æµ‹è¯­è¨€
```

---

## åä¸ƒã€æ•°æ®å¤‡ä»½ç³»ç»Ÿè®¾è®¡

### 17.1 å¤‡ä»½ç­–ç•¥

| ç”¨æˆ·ç±»å‹ | è‡ªåŠ¨å¤‡ä»½é¢‘ç‡ | ä¿ç•™ä»½æ•° | æ‰‹åŠ¨å¤‡ä»½ |
|----------|--------------|----------|----------|
| å…è´¹ç”¨æˆ· | æ¯æœˆ1æ¬¡ | 1ä»½ | âœ… |
| VIPä¼šå‘˜ | æ¯æ—¥1æ¬¡ | 30ä»½ | âœ… æ— é™ |

### 17.2 å¤‡ä»½æ•°æ®è¡¨

```sql
-- ç”¨æˆ·å¤‡ä»½è®°å½•è¡¨
CREATE TABLE user_backups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    backup_type INT NOT NULL,            -- 1:è‡ªåŠ¨ 2:æ‰‹åŠ¨
    backup_size BIGINT NOT NULL,         -- å­—èŠ‚æ•°
    file_path VARCHAR(500) NOT NULL,     -- OSSè·¯å¾„
    file_hash VARCHAR(64),               -- SHA256æ ¡éªŒ
    data_summary JSONB,                  -- æ•°æ®æ‘˜è¦
    status INT DEFAULT 0,                -- 0:è¿›è¡Œä¸­ 1:æˆåŠŸ 2:å¤±è´¥
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP                 -- è¿‡æœŸæ—¶é—´
);

-- æ•°æ®æ‘˜è¦ç¤ºä¾‹
-- {
--   "transactions_count": 1234,
--   "accounts_count": 5,
--   "books_count": 2,
--   "categories_count": 30,
--   "date_range": {"from": "2024-01-01", "to": "2024-12-27"},
--   "total_expense": 50000.00,
--   "total_income": 80000.00
-- }
```

### 17.3 å¤‡ä»½å†…å®¹

```json
{
  "version": "1.0",
  "created_at": "2024-12-27T10:00:00Z",
  "user_id": "xxx",
  "data": {
    "user_settings": {
      "default_currency": "CNY",
      "preferred_language": "zh-CN",
      "theme": "light"
    },
    "books": [...],
    "accounts": [...],
    "categories": [...],
    "transactions": [...],
    "budgets": [...],
    "scheduled_transactions": [...]
  }
}
```

### 17.4 å¤‡ä»½æœåŠ¡å®ç°

```python
class BackupService:
    async def create_backup(self, user_id: str, backup_type: int = 1) -> str:
        """åˆ›å»ºç”¨æˆ·æ•°æ®å¤‡ä»½"""

        # 1. æ”¶é›†ç”¨æˆ·æ‰€æœ‰æ•°æ®
        data = await self._collect_user_data(user_id)

        # 2. åºåˆ—åŒ–ä¸ºJSON
        json_data = json.dumps(data, ensure_ascii=False, default=str)

        # 3. å‹ç¼©
        compressed = gzip.compress(json_data.encode('utf-8'))

        # 4. åŠ å¯†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±å¯†é’¥ï¼‰
        encrypted = await self._encrypt_data(compressed, user_id)

        # 5. ä¸Šä¼ åˆ°OSS
        file_path = f"backups/{user_id}/{datetime.now().strftime('%Y%m%d_%H%M%S')}.backup"
        await self.oss.upload(file_path, encrypted)

        # 6. è®°å½•å¤‡ä»½ä¿¡æ¯
        backup_record = await self._save_backup_record(
            user_id=user_id,
            backup_type=backup_type,
            file_path=file_path,
            backup_size=len(encrypted),
            data_summary=self._generate_summary(data)
        )

        # 7. æ¸…ç†è¿‡æœŸå¤‡ä»½
        await self._cleanup_old_backups(user_id)

        return backup_record.id

    async def restore_backup(self, user_id: str, backup_id: str):
        """æ¢å¤ç”¨æˆ·æ•°æ®"""

        # 1. è·å–å¤‡ä»½æ–‡ä»¶
        backup = await self.get_backup(backup_id)
        encrypted = await self.oss.download(backup.file_path)

        # 2. è§£å¯†
        compressed = await self._decrypt_data(encrypted, user_id)

        # 3. è§£å‹
        json_data = gzip.decompress(compressed).decode('utf-8')
        data = json.loads(json_data)

        # 4. æ¢å¤æ•°æ®ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
        async with self.db.transaction():
            # æ¸…ç©ºç°æœ‰æ•°æ®
            await self._clear_user_data(user_id)
            # å¯¼å…¥å¤‡ä»½æ•°æ®
            await self._import_data(user_id, data)

        return True

    async def _cleanup_old_backups(self, user_id: str):
        """æ¸…ç†è¿‡æœŸå¤‡ä»½"""
        user = await self.get_user(user_id)
        keep_count = 30 if user.is_vip else 1

        # è·å–æ‰€æœ‰å¤‡ä»½ï¼ŒæŒ‰æ—¶é—´å€’åº
        backups = await self.get_user_backups(user_id, order_by='-created_at')

        # åˆ é™¤è¶…å‡ºä¿ç•™æ•°é‡çš„å¤‡ä»½
        for backup in backups[keep_count:]:
            await self.oss.delete(backup.file_path)
            await backup.delete()
```

### 17.5 å®šæ—¶å¤‡ä»½ä»»åŠ¡

```python
# Celeryå®šæ—¶ä»»åŠ¡
@celery.task
def scheduled_backup():
    """æ¯æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ"""

    # VIPç”¨æˆ·æ¯æ—¥å¤‡ä»½
    vip_users = User.query.filter(User.is_vip == True).all()
    for user in vip_users:
        create_backup.delay(user.id, backup_type=1)

    # å…è´¹ç”¨æˆ·æ¯æœˆ1å·å¤‡ä»½
    if datetime.now().day == 1:
        free_users = User.query.filter(User.is_vip == False).all()
        for user in free_users:
            create_backup.delay(user.id, backup_type=1)

# Celery Beaté…ç½®
CELERYBEAT_SCHEDULE = {
    'daily-backup': {
        'task': 'tasks.scheduled_backup',
        'schedule': crontab(hour=3, minute=0),
    },
}
```

### 17.6 å¤‡ä»½ç®¡ç†ç•Œé¢

```
æ•°æ®å¤‡ä»½
â”œâ”€â”€ æœ€è¿‘å¤‡ä»½: 2024-12-27 03:00
â”œâ”€â”€ å¤‡ä»½å¤§å°: 2.3 MB
â”œâ”€â”€ æ•°æ®æ¦‚è¦:
â”‚   â”œâ”€â”€ è´¦ç›®: 3,240æ¡
â”‚   â”œâ”€â”€ è´¦æœ¬: 2ä¸ª
â”‚   â””â”€â”€ æ—¶é—´èŒƒå›´: 2024-01 ~ 2024-12
â”œâ”€â”€ å†å²å¤‡ä»½ (VIP: 30ä»½ / å…è´¹: 1ä»½)
â”‚   â”œâ”€â”€ 2024-12-27 03:00 - 2.3 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â”œâ”€â”€ 2024-12-26 03:00 - 2.2 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â””â”€â”€ ...
â””â”€â”€ [ç«‹å³å¤‡ä»½] [å¯¼å‡ºåˆ°æœ¬åœ°]
```

---

## åå…«ã€æ‰©å±•æ€§æ¶æ„è®¾è®¡

### 18.1 å®¹é‡è§„åˆ’ç›®æ ‡

| é˜¶æ®µ | DAU | æ³¨å†Œç”¨æˆ· | æ—¥è®°è´¦é‡ | å¹¶å‘è¯·æ±‚ | æ•°æ®å¢é•¿/æœˆ |
|------|-----|----------|----------|----------|-------------|
| **åˆæœŸ** | 1,000 | 5,000 | 5,000æ¡ | 50 QPS | 500MB |
| **ä¸­æœŸ** | 10,000 | 50,000 | 50,000æ¡ | 500 QPS | 5GB |
| **è¿œæœŸ** | 100,000 | 500,000 | 500,000æ¡ | 5,000 QPS | 50GB |

### 18.2 ä¸‰é˜¶æ®µæ¶æ„æ¼”è¿›

#### é˜¶æ®µä¸€ï¼šå•æœºæ¶æ„ (1,000 DAU)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‘æœåŠ¡å™¨ (å•æœº)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Nginx     â”‚  â”‚   FastAPI   â”‚  â”‚   Celery    â”‚         â”‚
â”‚  â”‚  (åå‘ä»£ç†) â”‚  â”‚  (2 workers)â”‚  â”‚  (1 worker) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚  â”‚   MinIO     â”‚         â”‚
â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (æœ¬åœ°å­˜å‚¨) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æœˆè´¹ç”¨ |
|------|------|--------|
| ECS | 2æ ¸4G | Â¥150 |
| äº‘ç›˜ | 100GB SSD | Â¥40 |
| å¸¦å®½ | 5Mbps | Â¥100 |
| **åˆè®¡** | | **Â¥290/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 200ms (P95)
- æ”¯æŒå¹¶å‘: 50-100 QPS
- æ•°æ®åº“è¿æ¥æ•°: 20

---

#### é˜¶æ®µäºŒï¼šåˆ†ç¦»æ¶æ„ (10,000 DAU)

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     SLB     â”‚
                        â”‚  (è´Ÿè½½å‡è¡¡) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚ â”‚   ...   â”‚ â”‚   API Server 2  â”‚
     â”‚   (2æ ¸4G)       â”‚ â”‚         â”‚ â”‚   (2æ ¸4G)       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL â”‚       â”‚     Redis     â”‚      â”‚     OSS     â”‚
â”‚   (2æ ¸4G)   â”‚       â”‚    (1æ ¸2G)    â”‚      â”‚  (å¯¹è±¡å­˜å‚¨) â”‚
â”‚   ä¸»ä»å¤åˆ¶   â”‚       â”‚    å•å®ä¾‹     â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| SLB | æ ‡å‡†å‹ | 1 | Â¥50 |
| ECS (API) | 2æ ¸4G | 2 | Â¥300 |
| RDS PostgreSQL | 2æ ¸4G | 1 | Â¥400 |
| Redis | 1æ ¸2G | 1 | Â¥150 |
| OSS | 100GB | 1 | Â¥20 |
| å¸¦å®½ | 10Mbps | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥1,120/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 150ms (P95)
- æ”¯æŒå¹¶å‘: 300-500 QPS
- æ•°æ®åº“è¿æ¥æ± : 50
- è¯»å†™åˆ†ç¦»æ”¯æŒ

**å‡çº§è·¯å¾„ï¼ˆä»é˜¶æ®µä¸€ï¼‰ï¼š**
1. æ•°æ®åº“è¿ç§»åˆ°RDSï¼ˆçº¦2å°æ—¶åœæœºï¼‰
2. éƒ¨ç½²ç¬¬äºŒå°APIæœåŠ¡å™¨
3. é…ç½®SLBè´Ÿè½½å‡è¡¡
4. æ–‡ä»¶å­˜å‚¨è¿ç§»åˆ°OSS
5. **é¢„è®¡å‡çº§æˆæœ¬**: Â¥0ï¼ˆå¹³æ»‘è¿ç§»ï¼‰
6. **é¢„è®¡å‡çº§æ—¶é—´**: 1å¤©

---

#### é˜¶æ®µä¸‰ï¼šé›†ç¾¤æ¶æ„ (100,000 DAU)

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     CDN     â”‚
                           â”‚  (é™æ€èµ„æº) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚     SLB     â”‚
                           â”‚ (è´Ÿè½½å‡è¡¡)  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚
â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚                             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ PGä¸»åº“ â”‚â—„â”€â”€â”€â”€ åŒæ­¥å¤åˆ¶ â”€â”€â”€â–ºâ”‚  PGä»åº“   â”‚                 â”‚  PGä»åº“   â”‚
â”‚(4æ ¸16G)â”‚                   â”‚ (4æ ¸8G)   â”‚                 â”‚ (4æ ¸8G)   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚                     Redis Cluster                           â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â””â”€â”€â”¼â”€â”€â–ºâ”‚ Master1 â”‚   â”‚ Master2 â”‚   â”‚ Master3 â”‚                  â”‚
       â”‚   â”‚ Slave1  â”‚   â”‚ Slave2  â”‚   â”‚ Slave3  â”‚                  â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| ACKé›†ç¾¤ | 4æ ¸8GèŠ‚ç‚¹ | 4 | Â¥2,400 |
| SLB | é«˜æ€§èƒ½å‹ | 1 | Â¥200 |
| RDS PostgreSQL | 4æ ¸16Gä¸» + 4æ ¸8Gä»x2 | 3 | Â¥2,500 |
| Redisé›†ç¾¤ | 4Gé›†ç¾¤ç‰ˆ | 1 | Â¥800 |
| OSS | 1TB + CDN | 1 | Â¥300 |
| å¸¦å®½ | 50Mbps | 1 | Â¥1,000 |
| æ—¥å¿—æœåŠ¡ | SLS | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥7,400/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 100ms (P95)
- æ”¯æŒå¹¶å‘: 3,000-5,000 QPS
- æ•°æ®åº“è¿æ¥æ± : 200
- è‡ªåŠ¨æ‰©ç¼©å®¹æ”¯æŒ

---

### 18.3 æ•°æ®åº“æ‰©å±•ç­–ç•¥

#### åˆ†è¡¨ç­–ç•¥ï¼ˆ10ä¸‡DAUæ—¶å¯ç”¨ï¼‰

```sql
-- è´¦ç›®è¡¨æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨
-- transactions_0, transactions_1, ... transactions_15 (16å¼ è¡¨)

-- åˆ†è¡¨è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_transaction_table(user_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN 'transactions_' || (hashtext(user_id::text) & 15)::text;
END;
$$ LANGUAGE plpgsql;
```

#### è¯»å†™åˆ†ç¦»é…ç½®

```python
# SQLAlchemyè¯»å†™åˆ†ç¦»
DATABASES = {
    'default': {
        'write': 'postgresql://master:5432/bookkeeping',
        'read': [
            'postgresql://slave1:5432/bookkeeping',
            'postgresql://slave2:5432/bookkeeping',
        ]
    }
}

class RoutingSession:
    def get_bind(self, mapper=None, clause=None):
        if self._flushing:
            return engines['write']
        return random.choice(engines['read'])
```

#### çƒ­æ•°æ®åˆ†ç¦»

```sql
-- çƒ­æ•°æ®è¡¨ï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
CREATE TABLE transactions_hot (
    LIKE transactions INCLUDING ALL
);

-- å†·æ•°æ®è¡¨ï¼ˆ3ä¸ªæœˆå‰ï¼‰
CREATE TABLE transactions_cold (
    LIKE transactions INCLUDING ALL
);

-- å®šæ—¶è¿ç§»ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
-- å°†3ä¸ªæœˆå‰çš„æ•°æ®ä»hotè¿ç§»åˆ°cold
```

---

### 18.4 ç¼“å­˜ç­–ç•¥

#### å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°ç¼“å­˜   â”‚ â”€â”€â–º â”‚   Redis     â”‚ â”€â”€â–º â”‚  æ•°æ®åº“     â”‚
â”‚  (LRU 1min) â”‚     â”‚  (TTL 5min) â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜é”®è®¾è®¡

```python
CACHE_KEYS = {
    # ç”¨æˆ·ä¿¡æ¯ (TTL: 30åˆ†é’Ÿ)
    'user:{user_id}': 'user_info',

    # ç”¨æˆ·è´¦æœ¬åˆ—è¡¨ (TTL: 10åˆ†é’Ÿ)
    'user:{user_id}:books': 'book_list',

    # æœˆåº¦ç»Ÿè®¡ (TTL: 5åˆ†é’Ÿ)
    'stats:{user_id}:{book_id}:{year}:{month}': 'monthly_stats',

    # åˆ†ç±»åˆ—è¡¨ (TTL: 1å°æ—¶)
    'categories:{user_id}': 'category_list',

    # æ±‡ç‡ (TTL: 1å°æ—¶)
    'exchange_rate:{from}:{to}:{date}': 'rate',
}
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥

```python
class CacheManager:
    # å†™åå¤±æ•ˆæ¨¡å¼
    async def invalidate_on_write(self, user_id: str, entity: str):
        patterns = {
            'transaction': [
                f'stats:{user_id}:*',
                f'user:{user_id}:recent_transactions',
            ],
            'account': [
                f'user:{user_id}:accounts',
                f'account:{user_id}:*',
            ],
        }
        for pattern in patterns.get(entity, []):
            await self.redis.delete_pattern(pattern)
```

---

### 18.5 APIæ€§èƒ½ä¼˜åŒ–

#### æ¥å£é™æµé…ç½®

```python
from fastapi_limiter import RateLimiter

# é™æµè§„åˆ™
RATE_LIMITS = {
    # æ™®é€šæ¥å£: 100æ¬¡/åˆ†é’Ÿ
    'default': '100/minute',

    # AIæ¥å£: 10æ¬¡/åˆ†é’Ÿ (å…è´¹ç”¨æˆ·) / 60æ¬¡/åˆ†é’Ÿ (VIP)
    'ai_ocr': {'free': '10/minute', 'vip': '60/minute'},
    'ai_voice': {'free': '20/minute', 'vip': '120/minute'},

    # ç™»å½•æ¥å£: 5æ¬¡/åˆ†é’Ÿ (é˜²æš´åŠ›ç ´è§£)
    'auth_login': '5/minute',

    # å¯¼å‡ºæ¥å£: 5æ¬¡/å°æ—¶
    'export': '5/hour',
}
```

#### æ‰¹é‡æ¥å£ä¼˜åŒ–

```python
# æ‰¹é‡åˆ›å»ºè´¦ç›® (å‡å°‘ç½‘ç»œå¾€è¿”)
@router.post("/transactions/batch")
async def batch_create_transactions(
    transactions: List[TransactionCreate],  # æœ€å¤š50æ¡
    db: AsyncSession = Depends(get_db)
):
    # ä½¿ç”¨æ‰¹é‡æ’å…¥
    await db.execute(
        insert(Transaction),
        [t.dict() for t in transactions]
    )
```

#### å“åº”å‹ç¼©

```python
from fastapi.middleware.gzip import GZipMiddleware

app.add_middleware(GZipMiddleware, minimum_size=1000)
```

---

### 18.6 ç›‘æ§ä¸å‘Šè­¦

#### ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheus ç›‘æ§é…ç½®
metrics:
  # åº”ç”¨å±‚
  - api_request_total          # è¯·æ±‚æ€»æ•°
  - api_request_duration_seconds  # å“åº”æ—¶é—´
  - api_error_total            # é”™è¯¯æ•°

  # æ•°æ®åº“å±‚
  - db_connection_pool_size    # è¿æ¥æ± å¤§å°
  - db_query_duration_seconds  # æŸ¥è¯¢æ—¶é—´

  # ç¼“å­˜å±‚
  - cache_hit_ratio            # ç¼“å­˜å‘½ä¸­ç‡
  - cache_memory_usage         # å†…å­˜ä½¿ç”¨

  # ä¸šåŠ¡å±‚
  - active_users_daily         # æ—¥æ´»ç”¨æˆ·
  - transactions_created_total # è®°è´¦æ•°é‡
  - ai_requests_total          # AIè°ƒç”¨æ¬¡æ•°
```

#### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  # APIå“åº”æ—¶é—´ > 500ms
  - alert: HighApiLatency
    expr: api_request_duration_seconds{quantile="0.95"} > 0.5
    for: 5m

  # é”™è¯¯ç‡ > 1%
  - alert: HighErrorRate
    expr: rate(api_error_total[5m]) / rate(api_request_total[5m]) > 0.01
    for: 5m

  # æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ > 80%
  - alert: DbConnectionPoolHigh
    expr: db_connection_pool_size / db_connection_pool_max > 0.8
    for: 5m

  # Rediså†…å­˜ä½¿ç”¨ > 80%
  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
```

---

### 18.7 æˆæœ¬å¯¹æ¯”æ€»ç»“

| é˜¶æ®µ | DAU | æœˆè´¹ç”¨ | å•ç”¨æˆ·æˆæœ¬ | å‡çº§æˆæœ¬ |
|------|-----|--------|------------|----------|
| åˆæœŸ | 1,000 | Â¥290 | Â¥0.29 | - |
| ä¸­æœŸ | 10,000 | Â¥1,120 | Â¥0.11 | Â¥0 |
| è¿œæœŸ | 100,000 | Â¥7,400 | Â¥0.07 | Â¥0 |

**å…³é”®è®¾è®¡åŸåˆ™ï¼š**
1. **æ— çŠ¶æ€APIæœåŠ¡** - æ”¯æŒæ°´å¹³æ‰©å±•
2. **æ•°æ®åº“è¯»å†™åˆ†ç¦»** - æ‰©å±•è¯»æ€§èƒ½
3. **å¤šçº§ç¼“å­˜** - å‡å°‘æ•°æ®åº“å‹åŠ›
4. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** - AIå¤„ç†ä¸é˜»å¡ä¸»æµç¨‹
5. **å¹³æ»‘å‡çº§** - æ¯æ¬¡å‡çº§åœæœºæ—¶é—´ < 30åˆ†é’Ÿ

---

### 18.8 æŠ€æœ¯é€‰å‹å¯¹æ¯”

#### ä¸ºä»€ä¹ˆé€‰æ‹©å•ä½“æ¶æ„è€Œéå¾®æœåŠ¡ï¼ˆåˆæœŸï¼‰

| ç»´åº¦ | å•ä½“æ¶æ„ | å¾®æœåŠ¡æ¶æ„ |
|------|----------|------------|
| å¼€å‘å¤æ‚åº¦ | ä½ | é«˜ |
| éƒ¨ç½²å¤æ‚åº¦ | ä½ | é«˜ |
| è¿ç»´æˆæœ¬ | Â¥290/æœˆ | Â¥2000+/æœˆ |
| é€‚åˆé˜¶æ®µ | < 5ä¸‡DAU | > 10ä¸‡DAU |
| å›¢é˜Ÿè§„æ¨¡ | 1-3äºº | 5+äºº |

**ç»“è®ºï¼š** åˆæœŸé‡‡ç”¨å•ä½“æ¶æ„ï¼Œå½“DAUè¶…è¿‡5ä¸‡ä¸”å›¢é˜Ÿæ‰©å¤§åå†è€ƒè™‘å¾®æœåŠ¡æ‹†åˆ†ã€‚

#### æ½œåœ¨çš„å¾®æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆï¼ˆè¿œæœŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚  â”‚  è®°è´¦æœåŠ¡   â”‚  â”‚  ç»Ÿè®¡æœåŠ¡   â”‚
â”‚ user-svc   â”‚  â”‚ txn-svc    â”‚  â”‚ stats-svc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIæœåŠ¡    â”‚  â”‚  é€šçŸ¥æœåŠ¡   â”‚  â”‚  æ”¯ä»˜æœåŠ¡   â”‚
â”‚  ai-svc    â”‚  â”‚ notify-svc â”‚  â”‚ payment-svcâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åå…«Aã€æ—¥å¿—ç³»ç»Ÿè®¾è®¡

### 18A.1 æ—¥å¿—åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—é‡‡é›†å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Appæ—¥å¿—    â”‚  â”‚  APIæ—¥å¿—    â”‚  â”‚  ç³»ç»Ÿæ—¥å¿—   â”‚             â”‚
â”‚  â”‚ (Flutter)   â”‚  â”‚ (FastAPI)   â”‚  â”‚ (Nginxç­‰)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å¤„ç†å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Filebeat / Fluent Bit (æ—¥å¿—æ”¶é›†)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å­˜å‚¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Elasticsearch   â”‚    æˆ–    â”‚   é˜¿é‡Œäº‘SLS       â”‚          â”‚
â”‚  â”‚   (è‡ªå»º)          â”‚          â”‚   (äº‘æœåŠ¡)        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å±•ç¤ºå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     Kibana        â”‚    æˆ–    â”‚   SLSæ§åˆ¶å°       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18A.2 æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ« | åç§° | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|------|----------|------|
| **CRITICAL** | ä¸¥é‡ | ç³»ç»Ÿå´©æºƒã€æ•°æ®ä¸¢å¤± | æ•°æ®åº“è¿æ¥æ± è€—å°½ |
| **ERROR** | é”™è¯¯ | åŠŸèƒ½å¼‚å¸¸ã€éœ€è¦ä¿®å¤ | æ”¯ä»˜å›è°ƒéªŒç­¾å¤±è´¥ |
| **WARNING** | è­¦å‘Š | æ½œåœ¨é—®é¢˜ã€éœ€å…³æ³¨ | æ¥å£å“åº”æ—¶é—´è¿‡é•¿ |
| **INFO** | ä¿¡æ¯ | æ­£å¸¸ä¸šåŠ¡æµç¨‹ | ç”¨æˆ·ç™»å½•æˆåŠŸ |
| **DEBUG** | è°ƒè¯• | å¼€å‘è°ƒè¯•ä¿¡æ¯ | è¯·æ±‚å‚æ•°è¯¦æƒ… |

### 18A.3 æ—¥å¿—æ ¼å¼è§„èŒƒ

#### ç»Ÿä¸€JSONæ ¼å¼

```json
{
  "timestamp": "2024-12-27T15:30:45.123Z",
  "level": "INFO",
  "logger": "api.transactions",
  "trace_id": "abc123def456",
  "span_id": "span789",
  "user_id": "user_xxx",
  "request_id": "req_yyy",
  "message": "Transaction created successfully",
  "context": {
    "transaction_id": "txn_zzz",
    "amount": 35.50,
    "category": "é¤é¥®"
  },
  "duration_ms": 45,
  "host": "api-server-1",
  "env": "production"
}
```

### 18A.4 åç«¯æ—¥å¿—å®ç°

```python
# app/core/logging.py
import logging
import json
import sys
from datetime import datetime
from contextvars import ContextVar
from typing import Optional

# è¯·æ±‚ä¸Šä¸‹æ–‡
request_id_var: ContextVar[Optional[str]] = ContextVar('request_id', default=None)
trace_id_var: ContextVar[Optional[str]] = ContextVar('trace_id', default=None)
user_id_var: ContextVar[Optional[str]] = ContextVar('user_id', default=None)

class JSONFormatter(logging.Formatter):
    """JSONæ ¼å¼æ—¥å¿—è¾“å‡º"""

    def format(self, record: logging.LogRecord) -> str:
        log_data = {
            'timestamp': datetime.utcnow().isoformat() + 'Z',
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'trace_id': trace_id_var.get(),
            'request_id': request_id_var.get(),
            'user_id': user_id_var.get(),
            'host': socket.gethostname(),
            'env': settings.ENVIRONMENT,
        }

        # æ·»åŠ å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)

        # æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡
        if hasattr(record, 'context'):
            log_data['context'] = record.context

        # æ·»åŠ è€—æ—¶
        if hasattr(record, 'duration_ms'):
            log_data['duration_ms'] = record.duration_ms

        return json.dumps(log_data, ensure_ascii=False)


def setup_logging():
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)

    # æ§åˆ¶å°è¾“å‡º
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(console_handler)

    # æ–‡ä»¶è¾“å‡ºï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    if settings.ENVIRONMENT == 'production':
        file_handler = logging.handlers.RotatingFileHandler(
            filename='/var/log/app/api.log',
            maxBytes=100 * 1024 * 1024,  # 100MB
            backupCount=10,
            encoding='utf-8'
        )
        file_handler.setFormatter(JSONFormatter())
        root_logger.addHandler(file_handler)


class AppLogger:
    """åº”ç”¨æ—¥å¿—å·¥å…·ç±»"""

    def __init__(self, name: str):
        self.logger = logging.getLogger(name)

    def info(self, message: str, **context):
        self._log(logging.INFO, message, context)

    def warning(self, message: str, **context):
        self._log(logging.WARNING, message, context)

    def error(self, message: str, exc_info=None, **context):
        self._log(logging.ERROR, message, context, exc_info=exc_info)

    def debug(self, message: str, **context):
        self._log(logging.DEBUG, message, context)

    def _log(self, level: int, message: str, context: dict, exc_info=None):
        record = self.logger.makeRecord(
            self.logger.name, level, '', 0, message, (), exc_info
        )
        if context:
            record.context = context
        self.logger.handle(record)


# ä½¿ç”¨ç¤ºä¾‹
logger = AppLogger('api.transactions')
logger.info('Transaction created', transaction_id='txn_123', amount=35.50)
```

### 18A.5 è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

```python
# app/middleware/logging.py
import time
import uuid
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware

class RequestLoggingMiddleware(BaseHTTPMiddleware):
    """è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        # ç”Ÿæˆè¯·æ±‚IDå’Œè¿½è¸ªID
        request_id = str(uuid.uuid4())[:8]
        trace_id = request.headers.get('X-Trace-ID', str(uuid.uuid4()))

        # è®¾ç½®ä¸Šä¸‹æ–‡
        request_id_var.set(request_id)
        trace_id_var.set(trace_id)

        # è®°å½•å¼€å§‹æ—¶é—´
        start_time = time.time()

        # è¯·æ±‚æ—¥å¿—
        logger.info(
            'Request started',
            method=request.method,
            path=request.url.path,
            query=str(request.query_params),
            client_ip=request.client.host,
            user_agent=request.headers.get('User-Agent'),
        )

        try:
            response = await call_next(request)
            duration_ms = (time.time() - start_time) * 1000

            # å“åº”æ—¥å¿—
            logger.info(
                'Request completed',
                method=request.method,
                path=request.url.path,
                status_code=response.status_code,
                duration_ms=round(duration_ms, 2),
            )

            # æ·»åŠ è¿½è¸ªå¤´
            response.headers['X-Request-ID'] = request_id
            response.headers['X-Trace-ID'] = trace_id

            return response

        except Exception as e:
            duration_ms = (time.time() - start_time) * 1000
            logger.error(
                'Request failed',
                method=request.method,
                path=request.url.path,
                error=str(e),
                duration_ms=round(duration_ms, 2),
                exc_info=True,
            )
            raise
```

### 18A.6 ä¸šåŠ¡æ—¥å¿—è§„èŒƒ

```python
# ä¸šåŠ¡æ—¥å¿—ç¤ºä¾‹

# ç”¨æˆ·æ¨¡å—
logger = AppLogger('biz.user')
logger.info('User registered', user_id='xxx', method='wechat')
logger.info('User logged in', user_id='xxx', ip='1.2.3.4')
logger.warning('Login failed', phone='138****1234', reason='wrong_password', attempts=3)

# äº¤æ˜“æ¨¡å—
logger = AppLogger('biz.transaction')
logger.info('Transaction created', txn_id='xxx', user_id='xxx', type='expense', amount=35.5)
logger.info('Transaction updated', txn_id='xxx', changes={'amount': [35.5, 40.0]})
logger.info('Transaction deleted', txn_id='xxx', user_id='xxx')

# AIæ¨¡å—
logger = AppLogger('biz.ai')
logger.info('OCR started', user_id='xxx', image_size=1024000)
logger.info('OCR completed', user_id='xxx', duration_ms=1500, confidence=0.95)
logger.error('OCR failed', user_id='xxx', error='Image too blurry')

# æ”¯ä»˜æ¨¡å—
logger = AppLogger('biz.payment')
logger.info('Payment order created', order_no='xxx', amount=98, method='wechat_pay')
logger.info('Payment callback received', order_no='xxx', transaction_id='wx_xxx')
logger.info('Payment completed', order_no='xxx', user_id='xxx')
logger.error('Payment callback verification failed', order_no='xxx', reason='sign_mismatch')

# ä¼šå‘˜æ¨¡å—
logger = AppLogger('biz.membership')
logger.info('Trial activated', user_id='xxx', expire_at='2025-01-27')
logger.info('Member upgraded', user_id='xxx', level=4, expire_at='2026-01-27')
logger.info('Member expired', user_id='xxx', level=4)
```

### 18A.7 æ—¥å¿—å­˜å‚¨ä¸å½’æ¡£

```yaml
# æ—¥å¿—ä¿ç•™ç­–ç•¥
retention:
  # çƒ­æ•°æ®ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰
  hot:
    duration: 7d
    storage: SSD

  # æ¸©æ•°æ®ï¼ˆå†å²æŸ¥è¯¢ï¼‰
  warm:
    duration: 30d
    storage: HDD

  # å†·æ•°æ®ï¼ˆå½’æ¡£ï¼‰
  cold:
    duration: 365d
    storage: OSS
    compressed: true

# æ—¥å¿—ç´¢å¼•é…ç½®
indices:
  app-logs:
    shards: 3
    replicas: 1
    refresh_interval: 5s

  access-logs:
    shards: 5
    replicas: 1
    refresh_interval: 10s
```

### 18A.8 å‰ç«¯æ—¥å¿—é‡‡é›†

```dart
// lib/core/logging/app_logger.dart
import 'package:dio/dio.dart';

enum LogLevel { debug, info, warning, error }

class AppLogger {
  static final AppLogger _instance = AppLogger._internal();
  factory AppLogger() => _instance;
  AppLogger._internal();

  final List<LogEntry> _buffer = [];
  static const int _bufferSize = 50;
  static const Duration _flushInterval = Duration(minutes: 1);

  void log(LogLevel level, String message, {Map<String, dynamic>? context}) {
    final entry = LogEntry(
      timestamp: DateTime.now(),
      level: level,
      message: message,
      context: context,
      userId: AuthService.currentUserId,
      deviceId: DeviceInfo.deviceId,
      appVersion: AppConfig.version,
    );

    _buffer.add(entry);

    // é”™è¯¯æ—¥å¿—ç«‹å³ä¸ŠæŠ¥
    if (level == LogLevel.error) {
      _flush();
    } else if (_buffer.length >= _bufferSize) {
      _flush();
    }
  }

  Future<void> _flush() async {
    if (_buffer.isEmpty) return;

    final logs = List<LogEntry>.from(_buffer);
    _buffer.clear();

    try {
      await _uploadLogs(logs);
    } catch (e) {
      // ä¸Šä¼ å¤±è´¥ï¼Œå­˜å‚¨åˆ°æœ¬åœ°
      await _saveToLocal(logs);
    }
  }

  // å´©æºƒæ—¥å¿—
  void logCrash(dynamic error, StackTrace stackTrace) {
    log(
      LogLevel.error,
      'App crashed',
      context: {
        'error': error.toString(),
        'stackTrace': stackTrace.toString(),
      },
    );
    _flush();
  }

  // ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
  void logEvent(String event, {Map<String, dynamic>? params}) {
    log(LogLevel.info, event, context: params);
  }

  // é¡µé¢è®¿é—®æ—¥å¿—
  void logPageView(String pageName, {Map<String, dynamic>? params}) {
    log(LogLevel.info, 'page_view', context: {
      'page': pageName,
      ...?params,
    });
  }

  // æ€§èƒ½æ—¥å¿—
  void logPerformance(String metric, int durationMs) {
    log(LogLevel.info, 'performance', context: {
      'metric': metric,
      'duration_ms': durationMs,
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
final logger = AppLogger();
logger.logEvent('transaction_created', params: {'amount': 35.5});
logger.logPageView('home');
logger.logPerformance('api_transactions_list', 150);
```

---

## åå…«Bã€ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ

### 18B.1 ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç›‘æ§æ•°æ®æº                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  åº”ç”¨æŒ‡æ ‡   â”‚  â”‚  ç³»ç»ŸæŒ‡æ ‡   â”‚  â”‚  ä¸šåŠ¡æŒ‡æ ‡   â”‚             â”‚
â”‚  â”‚ (Metrics)  â”‚  â”‚ (Node)     â”‚  â”‚ (Custom)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Prometheus (æŒ‡æ ‡æ”¶é›†)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  - åº”ç”¨Metricsç«¯ç‚¹ (/metrics)                               â”‚ â”‚
â”‚  â”‚  - Node Exporter (ç³»ç»ŸæŒ‡æ ‡)                                 â”‚ â”‚
â”‚  â”‚  - Redis Exporter / PostgreSQL Exporter                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Grafana      â”‚ â”‚  Alertmanager   â”‚ â”‚   PagerDuty/    â”‚
â”‚   (å¯è§†åŒ–)      â”‚ â”‚    (å‘Šè­¦)       â”‚ â”‚   é’‰é’‰/é£ä¹¦     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18B.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»

#### åº”ç”¨å±‚æŒ‡æ ‡ (RED)

```python
# app/core/metrics.py
from prometheus_client import Counter, Histogram, Gauge

# è¯·æ±‚è®¡æ•° (Request)
http_requests_total = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status_code']
)

# é”™è¯¯è®¡æ•° (Error)
http_errors_total = Counter(
    'http_errors_total',
    'Total HTTP errors',
    ['method', 'endpoint', 'error_type']
)

# å“åº”æ—¶é—´ (Duration)
http_request_duration_seconds = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint'],
    buckets=[0.01, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)

# æ´»è·ƒè¿æ¥æ•°
http_active_connections = Gauge(
    'http_active_connections',
    'Number of active HTTP connections'
)
```

#### æ•°æ®åº“æŒ‡æ ‡

```python
# æ•°æ®åº“è¿æ¥æ± 
db_pool_connections = Gauge(
    'db_pool_connections',
    'Database connection pool status',
    ['state']  # active, idle, waiting
)

# æŸ¥è¯¢æ—¶é—´
db_query_duration_seconds = Histogram(
    'db_query_duration_seconds',
    'Database query duration',
    ['operation', 'table']
)

# æ…¢æŸ¥è¯¢è®¡æ•°
db_slow_queries_total = Counter(
    'db_slow_queries_total',
    'Total slow queries (>1s)',
    ['operation', 'table']
)
```

#### ä¸šåŠ¡æŒ‡æ ‡

```python
# ç”¨æˆ·æŒ‡æ ‡
users_registered_total = Counter(
    'users_registered_total',
    'Total registered users',
    ['method']  # wechat, apple, phone
)

users_active = Gauge(
    'users_active',
    'Current active users',
    ['period']  # dau, wau, mau
)

# è®°è´¦æŒ‡æ ‡
transactions_created_total = Counter(
    'transactions_created_total',
    'Total transactions created',
    ['type', 'source']  # expense/income, manual/ocr/voice
)

# AIæŒ‡æ ‡
ai_requests_total = Counter(
    'ai_requests_total',
    'Total AI requests',
    ['type', 'status']  # ocr/voice, success/failed
)

ai_request_duration_seconds = Histogram(
    'ai_request_duration_seconds',
    'AI request duration',
    ['type']
)

# æ”¯ä»˜æŒ‡æ ‡
payment_orders_total = Counter(
    'payment_orders_total',
    'Total payment orders',
    ['product', 'method', 'status']
)

payment_revenue_total = Counter(
    'payment_revenue_total',
    'Total revenue in cents',
    ['product', 'method']
)

# ä¼šå‘˜æŒ‡æ ‡
members_active = Gauge(
    'members_active',
    'Current active members',
    ['level']  # trial, monthly, yearly, lifetime
)

trial_conversions_total = Counter(
    'trial_conversions_total',
    'Trial to paid conversions'
)
```

### 18B.3 Metricsä¸­é—´ä»¶

```python
# app/middleware/metrics.py
import time
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware

class MetricsMiddleware(BaseHTTPMiddleware):
    """PrometheusæŒ‡æ ‡æ”¶é›†ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        # å¢åŠ æ´»è·ƒè¿æ¥æ•°
        http_active_connections.inc()

        method = request.method
        endpoint = self._get_endpoint(request)
        start_time = time.time()

        try:
            response = await call_next(request)
            status_code = response.status_code

            # è®°å½•è¯·æ±‚
            http_requests_total.labels(
                method=method,
                endpoint=endpoint,
                status_code=status_code
            ).inc()

            # è®°å½•è€—æ—¶
            duration = time.time() - start_time
            http_request_duration_seconds.labels(
                method=method,
                endpoint=endpoint
            ).observe(duration)

            return response

        except Exception as e:
            # è®°å½•é”™è¯¯
            http_errors_total.labels(
                method=method,
                endpoint=endpoint,
                error_type=type(e).__name__
            ).inc()
            raise

        finally:
            http_active_connections.dec()

    def _get_endpoint(self, request: Request) -> str:
        # å½’ä¸€åŒ–è·¯å¾„ï¼Œé¿å…é«˜åŸºæ•°
        # /api/v1/transactions/123 -> /api/v1/transactions/{id}
        path = request.url.path
        # æ›¿æ¢UUIDå’Œæ•°å­—ID
        import re
        path = re.sub(r'/[0-9a-f-]{36}', '/{id}', path)
        path = re.sub(r'/\d+', '/{id}', path)
        return path
```

### 18B.4 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# prometheus/alerts.yml
groups:
  - name: api_alerts
    rules:
      # APIå¯ç”¨æ€§å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          sum(rate(http_errors_total[5m]))
          / sum(rate(http_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "APIé”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡1%"

      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "APIå“åº”æ—¶é—´è¿‡é•¿"
          description: "P95å“åº”æ—¶é—´ {{ $value | humanizeDuration }}"

      # è¯·æ±‚é‡çªå¢
      - alert: RequestSpike
        expr: |
          sum(rate(http_requests_total[5m]))
          > 2 * sum(rate(http_requests_total[1h] offset 1d))
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "è¯·æ±‚é‡å¼‚å¸¸çªå¢"

  - name: database_alerts
    rules:
      # æ•°æ®åº“è¿æ¥æ± 
      - alert: DbConnectionPoolExhausted
        expr: db_pool_connections{state="waiting"} > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ± ç­‰å¾…è¿‡å¤š"

      # æ…¢æŸ¥è¯¢
      - alert: TooManySlowQueries
        expr: rate(db_slow_queries_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "æ…¢æŸ¥è¯¢è¿‡å¤š"

  - name: business_alerts
    rules:
      # æ”¯ä»˜æˆåŠŸç‡
      - alert: LowPaymentSuccessRate
        expr: |
          sum(rate(payment_orders_total{status="success"}[1h]))
          / sum(rate(payment_orders_total[1h])) < 0.95
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "æ”¯ä»˜æˆåŠŸç‡è¿‡ä½"
          description: "æˆåŠŸç‡ {{ $value | humanizePercentage }}"

      # AIæœåŠ¡å¼‚å¸¸
      - alert: AIServiceDown
        expr: |
          sum(rate(ai_requests_total{status="failed"}[5m]))
          / sum(rate(ai_requests_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "AIæœåŠ¡å¼‚å¸¸"

      # æ–°ç”¨æˆ·æ³¨å†Œéª¤é™
      - alert: RegistrationDrop
        expr: |
          sum(increase(users_registered_total[1h]))
          < 0.5 * sum(increase(users_registered_total[1h] offset 1d))
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "æ–°ç”¨æˆ·æ³¨å†Œé‡éª¤é™"

  - name: infrastructure_alerts
    rules:
      # CPUä½¿ç”¨ç‡
      - alert: HighCpuUsage
        expr: |
          100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPUä½¿ç”¨ç‡è¿‡é«˜: {{ $value }}%"

      # å†…å­˜ä½¿ç”¨ç‡
      - alert: HighMemoryUsage
        expr: |
          (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {{ $value }}%"

      # ç£ç›˜ä½¿ç”¨ç‡
      - alert: DiskSpaceLow
        expr: |
          (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³: {{ $value }}%"
```

### 18B.5 å‘Šè­¦é€šçŸ¥é…ç½®

```yaml
# alertmanager/config.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default'
  routes:
    # ä¸¥é‡å‘Šè­¦
    - match:
        severity: critical
      receiver: 'critical-alerts'
      repeat_interval: 1h

    # ä¸€èˆ¬å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 4h

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://webhook/default'

  - name: 'critical-alerts'
    webhook_configs:
      # é’‰é’‰å‘Šè­¦
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
        send_resolved: true
      # é£ä¹¦å‘Šè­¦
      - url: 'https://open.feishu.cn/open-apis/bot/v2/hook/xxx'
        send_resolved: true
    # ç”µè¯å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
    # pagerduty_configs:
    #   - service_key: 'xxx'

  - name: 'warning-alerts'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
```

### 18B.6 Grafanaä»ªè¡¨ç›˜

```json
{
  "dashboard": {
    "title": "AI Bookkeeping - Overview",
    "panels": [
      {
        "title": "è¯·æ±‚é‡ (QPS)",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[1m]))"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_errors_total[5m])) / sum(rate(http_requests_total[5m])) * 100"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´ (P95/P99)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "æ´»è·ƒç”¨æˆ·",
        "type": "stat",
        "targets": [
          {
            "expr": "users_active{period='dau'}"
          }
        ]
      },
      {
        "title": "ä»Šæ—¥æ”¶å…¥",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(increase(payment_revenue_total[24h])) / 100"
          }
        ]
      },
      {
        "title": "AIè°ƒç”¨é‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(ai_requests_total[5m])) by (type)"
          }
        ]
      }
    ]
  }
}
```

### 18B.7 å¥åº·æ£€æŸ¥æ¥å£

```python
# app/api/v1/health.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter()

@router.get("/health")
async def health_check():
    """åŸºç¡€å¥åº·æ£€æŸ¥"""
    return {"status": "healthy"}

@router.get("/health/ready")
async def readiness_check(db: AsyncSession = Depends(get_db)):
    """å°±ç»ªæ£€æŸ¥ï¼ˆå«ä¾èµ–æœåŠ¡ï¼‰"""
    checks = {}

    # æ•°æ®åº“æ£€æŸ¥
    try:
        await db.execute(text("SELECT 1"))
        checks['database'] = 'healthy'
    except Exception as e:
        checks['database'] = f'unhealthy: {e}'

    # Redisæ£€æŸ¥
    try:
        await redis.ping()
        checks['redis'] = 'healthy'
    except Exception as e:
        checks['redis'] = f'unhealthy: {e}'

    # æ•´ä½“çŠ¶æ€
    is_healthy = all(v == 'healthy' for v in checks.values())

    return {
        'status': 'healthy' if is_healthy else 'unhealthy',
        'checks': checks,
        'timestamp': datetime.utcnow().isoformat()
    }

@router.get("/health/live")
async def liveness_check():
    """å­˜æ´»æ£€æŸ¥"""
    return {"status": "alive"}
```

---

## åå…«Cã€ä»£ç æ¶æ„è§„èŒƒ

### 18C.1 é¡¹ç›®åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¡¨ç°å±‚ (Presentation)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  API Routes / Controllers / Schemas (Request/Response)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸šåŠ¡å±‚ (Business/Service)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Services / Use Cases / Domain Logic                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚ (Data/Repository)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Repositories / DAOs / External Services                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŸºç¡€è®¾æ–½å±‚ (Infrastructure)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Database / Cache / Message Queue / External APIs           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18C.2 åç«¯ç›®å½•ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```
server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py             # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ redis.py                # Redisè¿æ¥
â”‚   â”‚   â”œâ”€â”€ logging.py              # æ—¥å¿—é…ç½®
â”‚   â”‚   â”œâ”€â”€ metrics.py              # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚   â””â”€â”€ exceptions.py           # å¼‚å¸¸å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                        # APIå±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py                 # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ router.py           # è·¯ç”±æ±‡æ€»
â”‚   â”‚       â”œâ”€â”€ auth.py             # è®¤è¯æ¥å£
â”‚   â”‚       â”œâ”€â”€ users.py            # ç”¨æˆ·æ¥å£
â”‚   â”‚       â”œâ”€â”€ transactions.py     # è®°è´¦æ¥å£
â”‚   â”‚       â”œâ”€â”€ books.py            # è´¦æœ¬æ¥å£
â”‚   â”‚       â”œâ”€â”€ accounts.py         # è´¦æˆ·æ¥å£
â”‚   â”‚       â”œâ”€â”€ categories.py       # åˆ†ç±»æ¥å£
â”‚   â”‚       â”œâ”€â”€ stats.py            # ç»Ÿè®¡æ¥å£
â”‚   â”‚       â”œâ”€â”€ ai.py               # AIæ¥å£
â”‚   â”‚       â”œâ”€â”€ payment.py          # æ”¯ä»˜æ¥å£
â”‚   â”‚       â”œâ”€â”€ membership.py       # ä¼šå‘˜æ¥å£
â”‚   â”‚       â””â”€â”€ health.py           # å¥åº·æ£€æŸ¥
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                     # æ•°æ®åº“æ¨¡å‹ (SQLAlchemy)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ transaction.py
â”‚   â”‚   â”œâ”€â”€ book.py
â”‚   â”‚   â”œâ”€â”€ account.py
â”‚   â”‚   â”œâ”€â”€ category.py
â”‚   â”‚   â”œâ”€â”€ membership.py
â”‚   â”‚   â””â”€â”€ campaign.py
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                    # Pydanticæ¨¡å‹ (API Schema)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€Schema
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ transaction.py
â”‚   â”‚   â”œâ”€â”€ book.py
â”‚   â”‚   â”œâ”€â”€ account.py
â”‚   â”‚   â”œâ”€â”€ stats.py
â”‚   â”‚   â””â”€â”€ payment.py
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”œâ”€â”€ stats_service.py
â”‚   â”‚   â”œâ”€â”€ ai_service.py
â”‚   â”‚   â”œâ”€â”€ payment_service.py
â”‚   â”‚   â”œâ”€â”€ membership_service.py
â”‚   â”‚   â””â”€â”€ campaign_service.py
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/               # æ•°æ®ä»“åº“å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€ä»“åº“
â”‚   â”‚   â”œâ”€â”€ user_repository.py
â”‚   â”‚   â”œâ”€â”€ transaction_repository.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logging.py              # è¯·æ±‚æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ metrics.py              # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚   â”œâ”€â”€ error_handler.py        # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ rate_limit.py           # é™æµ
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/                      # å¼‚æ­¥ä»»åŠ¡ (Celery)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ celery_app.py
â”‚   â”‚   â”œâ”€â”€ email_tasks.py
â”‚   â”‚   â”œâ”€â”€ ai_tasks.py
â”‚   â”‚   â”œâ”€â”€ backup_tasks.py
â”‚   â”‚   â””â”€â”€ scheduled_tasks.py
â”‚   â”‚
â”‚   â”œâ”€â”€ integrations/               # å¤–éƒ¨æœåŠ¡é›†æˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ wechat/                 # å¾®ä¿¡é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â””â”€â”€ pay.py
â”‚   â”‚   â”œâ”€â”€ alipay/                 # æ”¯ä»˜å®é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ pay.py
â”‚   â”‚   â”œâ”€â”€ apple/                  # Appleé›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â””â”€â”€ iap.py
â”‚   â”‚   â”œâ”€â”€ ai/                     # AIæœåŠ¡é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ claude.py
â”‚   â”‚   â”‚   â”œâ”€â”€ whisper.py
â”‚   â”‚   â”‚   â””â”€â”€ ocr.py
â”‚   â”‚   â””â”€â”€ sms/                    # çŸ­ä¿¡æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ aliyun_sms.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ datetime.py
â”‚       â”œâ”€â”€ currency.py
â”‚       â”œâ”€â”€ validators.py
â”‚       â””â”€â”€ helpers.py
â”‚
â”œâ”€â”€ migrations/                     # æ•°æ®åº“è¿ç§» (Alembic)
â”‚   â”œâ”€â”€ versions/
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ alembic.ini
â”‚
â”œâ”€â”€ tests/                          # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                 # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ unit/                       # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”œâ”€â”€ integration/                # é›†æˆæµ‹è¯•
â”‚   â”‚   â””â”€â”€ api/
â”‚   â””â”€â”€ e2e/                        # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚
â”œâ”€â”€ scripts/                        # è„šæœ¬
â”‚   â”œâ”€â”€ init_db.py
â”‚   â”œâ”€â”€ seed_data.py
â”‚   â””â”€â”€ migrate.py
â”‚
â”œâ”€â”€ docker/                         # Dockeré…ç½®
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ Dockerfile.dev
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â”œâ”€â”€ requirements/                   # ä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ base.txt
â”‚   â”œâ”€â”€ dev.txt
â”‚   â””â”€â”€ prod.txt
â”‚
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ pyproject.toml                  # é¡¹ç›®é…ç½®
â””â”€â”€ README.md
```

### 18C.3 å‰ç«¯ç›®å½•ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```
app/
â”œâ”€â”€ android/                        # AndroidåŸç”Ÿä»£ç 
â”œâ”€â”€ ios/                            # iOSåŸç”Ÿä»£ç 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart                   # å…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ app/                        # åº”ç”¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ app.dart                # Appæ ¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ routes.dart             # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ di.dart                 # ä¾èµ–æ³¨å…¥
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config/                 # é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ app_config.dart
â”‚   â”‚   â”‚   â””â”€â”€ api_config.dart
â”‚   â”‚   â”œâ”€â”€ constants/              # å¸¸é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ app_constants.dart
â”‚   â”‚   â”‚   â””â”€â”€ api_constants.dart
â”‚   â”‚   â”œâ”€â”€ theme/                  # ä¸»é¢˜
â”‚   â”‚   â”‚   â”œâ”€â”€ app_theme.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ app_colors.dart
â”‚   â”‚   â”‚   â””â”€â”€ app_text_styles.dart
â”‚   â”‚   â”œâ”€â”€ utils/                  # å·¥å…·ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ date_utils.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ currency_utils.dart
â”‚   â”‚   â”‚   â””â”€â”€ validators.dart
â”‚   â”‚   â”œâ”€â”€ extensions/             # æ‰©å±•æ–¹æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ string_ext.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ datetime_ext.dart
â”‚   â”‚   â”‚   â””â”€â”€ context_ext.dart
â”‚   â”‚   â”œâ”€â”€ logging/                # æ—¥å¿—
â”‚   â”‚   â”‚   â””â”€â”€ app_logger.dart
â”‚   â”‚   â””â”€â”€ errors/                 # é”™è¯¯å¤„ç†
â”‚   â”‚       â”œâ”€â”€ exceptions.dart
â”‚   â”‚       â””â”€â”€ error_handler.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                       # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ user_model.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction_model.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ book_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ repositories/           # æ•°æ®ä»“åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ base_repository.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ auth_repository.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction_repository.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ datasources/            # æ•°æ®æº
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/             # è¿œç¨‹æ•°æ®æº
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ api_client.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ api_endpoints.dart
â”‚   â”‚   â”‚   â””â”€â”€ local/              # æœ¬åœ°æ•°æ®æº
â”‚   â”‚   â”‚       â”œâ”€â”€ database.dart
â”‚   â”‚   â”‚       â””â”€â”€ preferences.dart
â”‚   â”‚   â””â”€â”€ providers/              # çŠ¶æ€æä¾›è€…
â”‚   â”‚       â”œâ”€â”€ auth_provider.dart
â”‚   â”‚       â”œâ”€â”€ transaction_provider.dart
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                     # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ entities/               # é¢†åŸŸå®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ user.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ usecases/               # ç”¨ä¾‹
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ interfaces/             # æ¥å£å®šä¹‰
â”‚   â”‚       â””â”€â”€ repositories/
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                   # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/                   # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ register_screen.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â””â”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ home/                   # é¦–é¡µæ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ home_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”‚       â”œâ”€â”€ overview_card.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ quick_actions.dart
â”‚   â”‚   â”‚       â””â”€â”€ recent_transactions.dart
â”‚   â”‚   â”œâ”€â”€ transaction/            # è®°è´¦æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ add_transaction_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ transaction_detail_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”‚       â”œâ”€â”€ category_selector.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ amount_input.dart
â”‚   â”‚   â”‚       â””â”€â”€ account_selector.dart
â”‚   â”‚   â”œâ”€â”€ stats/                  # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”œâ”€â”€ ai/                     # AIè®°è´¦æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ camera_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ voice_input_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”œâ”€â”€ profile/                # ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â””â”€â”€ settings/               # è®¾ç½®æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ screens/
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                     # å…±äº«ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ widgets/                # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ buttons/
â”‚   â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”‚   â”œâ”€â”€ inputs/
â”‚   â”‚   â”‚   â”œâ”€â”€ dialogs/
â”‚   â”‚   â”‚   â””â”€â”€ loading/
â”‚   â”‚   â””â”€â”€ layouts/                # å¸ƒå±€ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ app_scaffold.dart
â”‚   â”‚       â””â”€â”€ bottom_nav.dart
â”‚   â”‚
â”‚   â””â”€â”€ l10n/                       # å›½é™…åŒ–
â”‚       â”œâ”€â”€ app_zh.arb
â”‚       â”œâ”€â”€ app_en.arb
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ assets/                         # èµ„æºæ–‡ä»¶
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ icons/
â”‚   â”œâ”€â”€ fonts/
â”‚   â””â”€â”€ animations/
â”‚
â”œâ”€â”€ test/                           # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ widget/
â”‚   â””â”€â”€ integration/
â”‚
â”œâ”€â”€ pubspec.yaml                    # ä¾èµ–é…ç½®
â”œâ”€â”€ analysis_options.yaml           # ä»£ç åˆ†æé…ç½®
â””â”€â”€ README.md
```

### 18C.4 ç¼–ç è§„èŒƒ

#### Pythonåç«¯è§„èŒƒ

```python
# 1. å‘½åè§„èŒƒ
class UserService:          # ç±»åï¼šPascalCase
    def get_user_by_id():   # æ–¹æ³•åï¼šsnake_case
        user_name = ""      # å˜é‡åï¼šsnake_case
        MAX_RETRY = 3       # å¸¸é‡ï¼šUPPER_SNAKE_CASE

# 2. ç±»å‹æ³¨è§£
from typing import Optional, List
from pydantic import BaseModel

class UserCreate(BaseModel):
    email: str
    nickname: Optional[str] = None

async def get_users(skip: int = 0, limit: int = 100) -> List[User]:
    pass

# 3. æ–‡æ¡£å­—ç¬¦ä¸²
def create_transaction(
    user_id: str,
    amount: Decimal,
    category_id: str,
) -> Transaction:
    """
    åˆ›å»ºäº¤æ˜“è®°å½•

    Args:
        user_id: ç”¨æˆ·ID
        amount: äº¤æ˜“é‡‘é¢
        category_id: åˆ†ç±»ID

    Returns:
        åˆ›å»ºçš„äº¤æ˜“è®°å½•

    Raises:
        ValidationError: å‚æ•°éªŒè¯å¤±è´¥
        InsufficientBalanceError: ä½™é¢ä¸è¶³
    """
    pass

# 4. å¼‚å¸¸å¤„ç†
class AppException(Exception):
    """åº”ç”¨å¼‚å¸¸åŸºç±»"""
    def __init__(self, code: str, message: str, status_code: int = 400):
        self.code = code
        self.message = message
        self.status_code = status_code

class NotFoundError(AppException):
    def __init__(self, resource: str, id: str):
        super().__init__(
            code="NOT_FOUND",
            message=f"{resource} with id {id} not found",
            status_code=404
        )

# 5. ä¾èµ–æ³¨å…¥
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session() as session:
        yield session

@router.get("/users/{user_id}")
async def get_user(
    user_id: str,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    pass
```

#### Flutterå‰ç«¯è§„èŒƒ

```dart
// 1. å‘½åè§„èŒƒ
class TransactionService {}  // ç±»åï¼šPascalCase
void getUserById() {}        // æ–¹æ³•åï¼šcamelCase
final userName = '';         // å˜é‡åï¼šcamelCase
const maxRetry = 3;          // å¸¸é‡ï¼šcamelCase
final _privateVar = '';      // ç§æœ‰å˜é‡ï¼š_camelCase

// 2. æ–‡ä»¶å‘½å
// user_service.dart         // æ–‡ä»¶åï¼šsnake_case
// transaction_model.dart

// 3. Widgetè§„èŒƒ
class TransactionCard extends StatelessWidget {
  const TransactionCard({
    super.key,
    required this.transaction,
    this.onTap,
  });

  final Transaction transaction;
  final VoidCallback? onTap;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        title: Text(transaction.category),
        subtitle: Text(transaction.note ?? ''),
        trailing: Text(
          transaction.formattedAmount,
          style: TextStyle(
            color: transaction.isExpense ? Colors.red : Colors.green,
          ),
        ),
        onTap: onTap,
      ),
    );
  }
}

// 4. çŠ¶æ€ç®¡ç† (Riverpod)
final transactionListProvider = FutureProvider.family<List<Transaction>, TransactionFilter>(
  (ref, filter) async {
    final repository = ref.watch(transactionRepositoryProvider);
    return repository.getTransactions(filter);
  },
);

// 5. é”™è¯¯å¤„ç†
class AppException implements Exception {
  final String code;
  final String message;

  const AppException(this.code, this.message);
}

class NetworkException extends AppException {
  const NetworkException([String? message])
    : super('NETWORK_ERROR', message ?? 'Network error occurred');
}

// 6. æ‰©å±•æ–¹æ³•
extension DateTimeExt on DateTime {
  String get formatted => DateFormat('yyyy-MM-dd').format(this);
  bool get isToday => DateUtils.isSameDay(this, DateTime.now());
}
```

### 18C.5 Gitå·¥ä½œæµè§„èŒƒ

```bash
# åˆ†æ”¯å‘½å
main                    # ä¸»åˆ†æ”¯ï¼Œç”Ÿäº§ç¯å¢ƒ
develop                 # å¼€å‘åˆ†æ”¯
feature/xxx             # åŠŸèƒ½åˆ†æ”¯
bugfix/xxx              # ä¿®å¤åˆ†æ”¯
hotfix/xxx              # ç´§æ€¥ä¿®å¤åˆ†æ”¯
release/v1.0.0          # å‘å¸ƒåˆ†æ”¯

# Commit Messageè§„èŒƒ (Conventional Commits)
feat: æ·»åŠ ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
fix: ä¿®å¤ç™»å½•éªŒè¯ç å‘é€å¤±è´¥é—®é¢˜
docs: æ›´æ–°APIæ–‡æ¡£
style: æ ¼å¼åŒ–ä»£ç 
refactor: é‡æ„äº¤æ˜“æœåŠ¡
test: æ·»åŠ å•å…ƒæµ‹è¯•
chore: æ›´æ–°ä¾èµ–ç‰ˆæœ¬

# ç¤ºä¾‹
feat(auth): add WeChat login support
fix(payment): handle alipay callback timeout
docs(api): update transaction endpoint docs
refactor(service): extract common logic to base service
```

### 18C.6 APIè®¾è®¡è§„èŒƒ

```yaml
# RESTful APIè§„èŒƒ

# 1. URLè®¾è®¡
GET    /api/v1/transactions          # åˆ—è¡¨
POST   /api/v1/transactions          # åˆ›å»º
GET    /api/v1/transactions/{id}     # è¯¦æƒ…
PUT    /api/v1/transactions/{id}     # å…¨é‡æ›´æ–°
PATCH  /api/v1/transactions/{id}     # éƒ¨åˆ†æ›´æ–°
DELETE /api/v1/transactions/{id}     # åˆ é™¤

# 2. æŸ¥è¯¢å‚æ•°
GET /api/v1/transactions?page=1&page_size=20&sort=-created_at&type=expense

# 3. ç»Ÿä¸€å“åº”æ ¼å¼
# æˆåŠŸå“åº”
{
  "code": 0,
  "message": "success",
  "data": { ... },
  "meta": {
    "page": 1,
    "page_size": 20,
    "total": 100
  }
}

# é”™è¯¯å“åº”
{
  "code": "VALIDATION_ERROR",
  "message": "Validation failed",
  "errors": [
    {
      "field": "amount",
      "message": "Amount must be positive"
    }
  ]
}

# 4. HTTPçŠ¶æ€ç 
200 OK              # æˆåŠŸ
201 Created         # åˆ›å»ºæˆåŠŸ
204 No Content      # åˆ é™¤æˆåŠŸ
400 Bad Request     # è¯·æ±‚å‚æ•°é”™è¯¯
401 Unauthorized    # æœªè®¤è¯
403 Forbidden       # æ— æƒé™
404 Not Found       # èµ„æºä¸å­˜åœ¨
422 Unprocessable   # ä¸šåŠ¡é€»è¾‘é”™è¯¯
429 Too Many Requests # é™æµ
500 Internal Error  # æœåŠ¡å™¨é”™è¯¯

# 5. ç‰ˆæœ¬æ§åˆ¶
/api/v1/...         # URLç‰ˆæœ¬
Accept: application/vnd.api+json;version=1  # Headerç‰ˆæœ¬
```

### 18C.7 æµ‹è¯•è§„èŒƒ

```python
# tests/unit/services/test_transaction_service.py

import pytest
from decimal import Decimal
from unittest.mock import Mock, AsyncMock

class TestTransactionService:
    """äº¤æ˜“æœåŠ¡å•å…ƒæµ‹è¯•"""

    @pytest.fixture
    def service(self, mock_repository):
        return TransactionService(repository=mock_repository)

    @pytest.fixture
    def mock_repository(self):
        return Mock(spec=TransactionRepository)

    async def test_create_transaction_success(self, service):
        """æµ‹è¯•åˆ›å»ºäº¤æ˜“æˆåŠŸ"""
        # Arrange
        data = TransactionCreate(
            amount=Decimal("35.50"),
            type=TransactionType.EXPENSE,
            category_id="cat_123",
        )

        # Act
        result = await service.create_transaction("user_123", data)

        # Assert
        assert result.amount == Decimal("35.50")
        assert result.type == TransactionType.EXPENSE

    async def test_create_transaction_invalid_amount(self, service):
        """æµ‹è¯•åˆ›å»ºäº¤æ˜“-é‡‘é¢æ— æ•ˆ"""
        data = TransactionCreate(
            amount=Decimal("-10"),
            type=TransactionType.EXPENSE,
            category_id="cat_123",
        )

        with pytest.raises(ValidationError) as exc:
            await service.create_transaction("user_123", data)

        assert exc.value.code == "INVALID_AMOUNT"

# æµ‹è¯•è¦†ç›–ç‡è¦æ±‚
# - å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
# - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ > 90%
# - é›†æˆæµ‹è¯•è¦†ç›–ä¸»è¦APIæ¥å£
```

### 18C.8 ä»£ç å®¡æŸ¥æ¸…å•

```markdown
## Code Review Checklist

### åŠŸèƒ½æ€§
- [ ] ä»£ç å®ç°äº†éœ€æ±‚æè¿°çš„åŠŸèƒ½
- [ ] è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µå·²å¤„ç†
- [ ] æ²¡æœ‰å¼•å…¥å®‰å…¨æ¼æ´

### ä»£ç è´¨é‡
- [ ] å‘½åæ¸…æ™°ã€æœ‰æ„ä¹‰
- [ ] å‡½æ•°/æ–¹æ³•èŒè´£å•ä¸€
- [ ] æ²¡æœ‰é‡å¤ä»£ç 
- [ ] å¤æ‚é€»è¾‘æœ‰æ³¨é‡Šè¯´æ˜

### æ€§èƒ½
- [ ] æ²¡æœ‰N+1æŸ¥è¯¢é—®é¢˜
- [ ] å¤§æ•°æ®é‡æœ‰åˆ†é¡µå¤„ç†
- [ ] é€‚å½“ä½¿ç”¨ç¼“å­˜

### å¯ç»´æŠ¤æ€§
- [ ] æœ‰é€‚å½“çš„å•å…ƒæµ‹è¯•
- [ ] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
- [ ] é…ç½®é¡¹ä½¿ç”¨ç¯å¢ƒå˜é‡

### æ—¥å¿—ä¸ç›‘æ§
- [ ] å…³é”®ä¸šåŠ¡æœ‰æ—¥å¿—è®°å½•
- [ ] é”™è¯¯æ—¥å¿—åŒ…å«å¿…è¦ä¸Šä¸‹æ–‡
- [ ] æ·»åŠ äº†å¿…è¦çš„ç›‘æ§æŒ‡æ ‡
```

---

## åä¹ã€å¼€å‘è®¡åˆ’ï¼ˆæ›´æ–°ç‰ˆï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ï¼ˆæ‰‹æœºå·+ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰
- [ ] å¤šè¯­è¨€åŸºç¡€æ¡†æ¶
- [ ] ç¦»çº¿æ¨¡å¼åŸºç¡€æ”¯æŒ

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] å¤šè´§å¸æ”¯æŒ
- [ ] æ•°æ®å¯¼å‡º
- [ ] æ•°æ®å¤‡ä»½

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ
- [ ] æ”¯ä»˜é›†æˆ

### ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–è¿­ä»£
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ›´å¤šè¯­è¨€æ”¯æŒ
- [ ] æ›´å¤šè´§å¸æ”¯æŒ
- [ ] é«˜çº§æŠ¥è¡¨åŠŸèƒ½

---

## äºŒåã€ç«å“ç‰¹æ€§é›†æˆï¼ˆMint/YNABï¼‰

åŸºäºå¯¹ Mintã€YNABï¼ˆYou Need A Budgetï¼‰åŠå…¶ä»–ä¸»æµè®°è´¦åº”ç”¨çš„åˆ†æï¼Œé›†æˆä»¥ä¸‹ä¼˜ç§€ç‰¹æ€§ï¼š

### 20.1 é›¶åŸºé¢„ç®—ç³»ç»Ÿï¼ˆYNABæ–¹æ³•è®ºï¼‰

#### æ ¸å¿ƒç†å¿µ
YNAB çš„å››å¤§æ³•åˆ™ï¼š
1. **ç»™æ¯ä¸€åˆ†é’±ä¸€ä¸ªç”¨é€”** - å°†æ‰€æœ‰æ”¶å…¥åˆ†é…åˆ°å…·ä½“ç±»åˆ«
2. **æ‹¥æŠ±çœŸå®å¼€æ”¯** - å°†å¤§é¢ä½é¢‘æ”¯å‡ºåˆ†æ‘Šåˆ°æ¯æœˆ
3. **çµæ´»è°ƒæ•´** - é¢„ç®—ä¸æ˜¯æ­»æ¿çš„ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
4. **è®©é’±"å˜è€"** - å¢åŠ æ”¶å…¥ä¸æ”¯å‡ºä¹‹é—´çš„æ—¶é—´å·®

#### åŠŸèƒ½è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é›¶åŸºé¢„ç®—ä»ªè¡¨ç›˜                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’° å¾…åˆ†é…é‡‘é¢: Â¥5,280.00                                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“¦ å¿…è¦æ”¯å‡º                              é¢„ç®—        å·²ç”¨        â”‚
â”‚  â”œâ”€â”€ ğŸ  æˆ¿ç§Ÿ                            Â¥3,000     Â¥3,000 âœ“     â”‚
â”‚  â”œâ”€â”€ âš¡ æ°´ç”µç‡ƒæ°”                         Â¥300       Â¥185         â”‚
â”‚  â”œâ”€â”€ ğŸ“± æ‰‹æœºè¯è´¹                         Â¥100       Â¥0           â”‚
â”‚  â””â”€â”€ ğŸš‡ äº¤é€šå‡ºè¡Œ                         Â¥400       Â¥280         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ½ï¸ ç”Ÿæ´»æ¶ˆè´¹                                                     â”‚
â”‚  â”œâ”€â”€ ğŸ›’ ä¹°èœåšé¥­                         Â¥1,500     Â¥892         â”‚
â”‚  â”œâ”€â”€ ğŸ” å¤–å‡ºå°±é¤                         Â¥600       Â¥445         â”‚
â”‚  â””â”€â”€ â˜• å’–å•¡é¥®æ–™                         Â¥200       Â¥128         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ¯ å‚¨è“„ç›®æ ‡                                                     â”‚
â”‚  â”œâ”€â”€ ğŸ–ï¸ å¹´å‡æ—…è¡Œï¼ˆ6ä¸ªæœˆåï¼‰              Â¥500/æœˆ    Â¥2,500/Â¥3,000â”‚
â”‚  â”œâ”€â”€ ğŸ’» æ¢ç”µè„‘ï¼ˆ3ä¸ªæœˆåï¼‰                Â¥1,000/æœˆ  Â¥1,000/Â¥3,000â”‚
â”‚  â””â”€â”€ ğŸ„ å¹´ç»ˆç¤¼ç‰©                         Â¥200/æœˆ    Â¥1,000/Â¥2,400â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š "é’±é¾„"æŒ‡æ ‡: 28å¤© â†‘                                           â”‚
â”‚  (å¹³å‡æ¯èŠ±ä¸€ç¬”é’±ï¼Œè¿™ç¬”é’±åœ¨è´¦æˆ·é‡Œå¾…äº†28å¤©)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- é¢„ç®—åˆ†é…è¡¨ï¼ˆé›¶åŸºé¢„ç®—ï¼‰
CREATE TABLE budget_allocations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    category_id UUID REFERENCES categories(id),
    year_month VARCHAR(7) NOT NULL,  -- æ ¼å¼: 2024-01
    budgeted_amount DECIMAL(15,2) DEFAULT 0,  -- é¢„ç®—é‡‘é¢
    spent_amount DECIMAL(15,2) DEFAULT 0,     -- å·²èŠ±é‡‘é¢
    available_amount DECIMAL(15,2) DEFAULT 0, -- å‰©ä½™å¯ç”¨
    overspent_amount DECIMAL(15,2) DEFAULT 0, -- è¶…æ”¯é‡‘é¢
    is_rollover BOOLEAN DEFAULT TRUE,         -- æ˜¯å¦ç»“è½¬åˆ°ä¸‹æœˆ
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, book_id, category_id, year_month)
);

-- æ”¶å…¥å¾…åˆ†é…æ± 
CREATE TABLE income_pool (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    total_income DECIMAL(15,2) DEFAULT 0,      -- æ€»æ”¶å…¥
    allocated_amount DECIMAL(15,2) DEFAULT 0,  -- å·²åˆ†é…
    unallocated_amount DECIMAL(15,2) DEFAULT 0, -- å¾…åˆ†é…
    year_month VARCHAR(7) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é’±é¾„è¿½è¸ª
CREATE TABLE money_age (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    calculated_date DATE NOT NULL,
    average_age_days INT NOT NULL,  -- å¹³å‡é’±é¾„ï¼ˆå¤©ï¼‰
    trend VARCHAR(10),  -- up, down, stable
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 20.2 ç›®æ ‡è¿½è¸ªç³»ç»Ÿ

#### ç›®æ ‡ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **å‚¨è“„ä½™é¢ç›®æ ‡** | åˆ°æŸæ—¥æœŸå­˜å¤Ÿä¸€å®šé‡‘é¢ | 6ä¸ªæœˆåå­˜å¤ŸÂ¥10,000å»æ—…è¡Œ |
| **æœˆåº¦å¼€æ”¯ç›®æ ‡** | æ¯æœˆè¯¥ç±»åˆ«èŠ±è´¹ä¸è¶…è¿‡ | æ¯æœˆé¤é¥®ä¸è¶…è¿‡Â¥2,000 |
| **è¿˜å€ºç›®æ ‡** | åˆ°æŸæ—¥æœŸè¿˜æ¸…å€ºåŠ¡ | 12ä¸ªæœˆå†…è¿˜æ¸…ä¿¡ç”¨å¡ |
| **å®šæœŸå­˜æ¬¾ç›®æ ‡** | æ¯æœˆå›ºå®šå­˜å…¥é‡‘é¢ | æ¯æœˆå­˜Â¥1,000åº”æ€¥é‡‘ |
| **è‡ªå®šä¹‰ç›®æ ‡** | çµæ´»è®¾å®š | æ¯å‘¨å­˜Â¥100ä¹°æ–°æ‰‹æœº |

#### ç›®æ ‡è¿›åº¦å¯è§†åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ æˆ‘çš„ç›®æ ‡                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ–ï¸ å¹´å‡æ—…è¡ŒåŸºé‡‘                                                 â”‚
â”‚  ç›®æ ‡: Â¥12,000  |  å·²å­˜: Â¥7,500  |  å‰©ä½™: Â¥4,500                 â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  62.5%                            â”‚
â”‚  ğŸ“… è·ç¦»ç›®æ ‡è¿˜æœ‰ 3 ä¸ªæœˆ | å»ºè®®æ¯æœˆå­˜: Â¥1,500                      â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’³ è¿˜æ¸…ä¿¡ç”¨å¡                                                   â”‚
â”‚  å¾…è¿˜: Â¥8,500  |  å·²è¿˜: Â¥11,500  |  èŠ‚çœåˆ©æ¯: Â¥680               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  57.5%                            â”‚
â”‚  ğŸ“… æŒ‰å½“å‰è¿›åº¦ï¼Œé¢„è®¡ 5 ä¸ªæœˆåè¿˜æ¸…                                  â”‚
â”‚  ğŸ’¡ æ¯æœˆå¤šè¿˜ Â¥200ï¼Œå¯ä»¥æå‰ 1 ä¸ªæœˆè¿˜æ¸…ï¼ŒèŠ‚çœ Â¥150 åˆ©æ¯             â”‚
â”‚                                                                  â”‚
â”‚  ğŸ„ å¹´ç»ˆç¤¼ç‰©åŸºé‡‘                                                  â”‚
â”‚  ç›®æ ‡: Â¥3,000  |  å·²å­˜: Â¥2,200  |  æœ¬æœˆéœ€å­˜: Â¥400                â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  73.3%                            â”‚
â”‚  âœ… è¿›åº¦æ­£å¸¸ï¼Œç»§ç»­ä¿æŒï¼                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- è´¢åŠ¡ç›®æ ‡è¡¨
CREATE TABLE financial_goals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    goal_type INT NOT NULL,  -- 1:å‚¨è“„ 2:æœˆåº¦å¼€æ”¯ 3:è¿˜å€º 4:å®šæœŸå­˜æ¬¾ 5:è‡ªå®šä¹‰
    target_amount DECIMAL(15,2) NOT NULL,
    current_amount DECIMAL(15,2) DEFAULT 0,
    target_date DATE,
    monthly_contribution DECIMAL(15,2),  -- æ¯æœˆå»ºè®®å­˜å…¥
    linked_account_id UUID REFERENCES accounts(id),  -- å…³è”è´¦æˆ·
    linked_category_id UUID REFERENCES categories(id),  -- å…³è”åˆ†ç±»
    icon VARCHAR(50),
    color VARCHAR(20),
    priority INT DEFAULT 0,
    is_completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç›®æ ‡è¿›åº¦è®°å½•
CREATE TABLE goal_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    goal_id UUID REFERENCES financial_goals(id),
    record_date DATE NOT NULL,
    amount_added DECIMAL(15,2),
    current_total DECIMAL(15,2),
    progress_percent DECIMAL(5,2),
    note TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 20.3 è¿˜æ¬¾æ¨¡æ‹Ÿå™¨ï¼ˆå€ºåŠ¡è§„åˆ’ï¼‰

#### åŠŸèƒ½è¯´æ˜
å¸®åŠ©ç”¨æˆ·è§„åˆ’ä¿¡ç”¨å¡ã€è´·æ¬¾ç­‰å€ºåŠ¡çš„è¿˜æ¬¾ç­–ç•¥ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’³ è¿˜æ¬¾æ¨¡æ‹Ÿå™¨                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æˆ‘çš„å€ºåŠ¡æ€»è§ˆ                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  æ‹›å•†ä¿¡ç”¨å¡        Â¥12,500    å¹´åˆ©ç‡ 18.25%                      â”‚
â”‚  èŠ±å‘—              Â¥3,200     å¹´åˆ©ç‡ 15.00%                      â”‚
â”‚  ç™½æ¡              Â¥5,800     å¹´åˆ©ç‡ 12.00%                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  å€ºåŠ¡æ€»è®¡          Â¥21,500                                       â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š è¿˜æ¬¾ç­–ç•¥å¯¹æ¯”                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ç­–ç•¥              æœˆè¿˜æ¬¾    è¿˜æ¸…æ—¶é—´    æ€»åˆ©æ¯    èŠ‚çœ       â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ æœ€ä½è¿˜æ¬¾          Â¥800     36ä¸ªæœˆ     Â¥7,350    --         â”‚â”‚
â”‚  â”‚ é›ªçƒæ³•(å…ˆå°é¢)    Â¥1,500   18ä¸ªæœˆ     Â¥2,890    Â¥4,460     â”‚â”‚
â”‚  â”‚ é›ªå´©æ³•(å…ˆé«˜æ¯)    Â¥1,500   17ä¸ªæœˆ     Â¥2,450    Â¥4,900 â­  â”‚â”‚
â”‚  â”‚ è‡ªå®šä¹‰            Â¥2,000   12ä¸ªæœˆ     Â¥1,680    Â¥5,670     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¡ å»ºè®®: ä½¿ç”¨é›ªå´©æ³•ï¼Œä¼˜å…ˆè¿˜æ¸…åˆ©ç‡æœ€é«˜çš„æ‹›å•†ä¿¡ç”¨å¡                  â”‚
â”‚                                                                  â”‚
â”‚  [åº”ç”¨æ­¤ç­–ç•¥]  [è‡ªå®šä¹‰è®¾ç½®]  [å¯¼å‡ºè¿˜æ¬¾è®¡åˆ’]                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- å€ºåŠ¡è¡¨
CREATE TABLE debts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    account_id UUID REFERENCES accounts(id),  -- å…³è”è´¦æˆ·
    name VARCHAR(100) NOT NULL,
    debt_type INT NOT NULL,  -- 1:ä¿¡ç”¨å¡ 2:æ¶ˆè´¹è´· 3:æˆ¿è´· 4:è½¦è´· 5:å…¶ä»–
    principal_amount DECIMAL(15,2) NOT NULL,  -- æœ¬é‡‘
    current_balance DECIMAL(15,2) NOT NULL,   -- å½“å‰ä½™é¢
    interest_rate DECIMAL(5,2) NOT NULL,      -- å¹´åˆ©ç‡%
    minimum_payment DECIMAL(15,2),            -- æœ€ä½è¿˜æ¬¾é¢
    due_day INT,                              -- è¿˜æ¬¾æ—¥
    start_date DATE,
    expected_payoff_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è¿˜æ¬¾è®¡åˆ’è¡¨
CREATE TABLE payoff_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    strategy_type INT NOT NULL,  -- 1:é›ªçƒæ³• 2:é›ªå´©æ³• 3:è‡ªå®šä¹‰
    monthly_budget DECIMAL(15,2) NOT NULL,
    total_interest_saved DECIMAL(15,2),
    expected_months INT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è¿˜æ¬¾è®¡åˆ’è¯¦æƒ…
CREATE TABLE payoff_plan_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plan_id UUID REFERENCES payoff_plans(id),
    debt_id UUID REFERENCES debts(id),
    payment_order INT NOT NULL,  -- è¿˜æ¬¾é¡ºåº
    monthly_payment DECIMAL(15,2),
    expected_payoff_date DATE
);
```

### 20.4 è®¢é˜…ç®¡ç†ä¸è´¦å•æé†’

#### è®¢é˜…è¿½è¸ª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± æˆ‘çš„è®¢é˜…                            æœ¬æœˆæ€»è®¡: Â¥268           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸµ Apple Music          Â¥11/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ5æ—¥             â”‚
â”‚  ğŸ“º çˆ±å¥‡è‰ºVIP            Â¥25/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ12æ—¥            â”‚
â”‚  â˜ï¸ iCloud 200G          Â¥21/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ15æ—¥            â”‚
â”‚  ğŸ® PlayStation Plus     Â¥38/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ20æ—¥            â”‚
â”‚  ğŸ“š å¾®ä¿¡è¯»ä¹¦æ— é™å¡        Â¥19/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ22æ—¥            â”‚
â”‚  ğŸ‹ï¸ å¥èº«æˆ¿ä¼šå‘˜           Â¥99/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ28æ—¥            â”‚
â”‚  ğŸš— åœè½¦åŒ…æœˆ             Â¥55/æœˆ    ä¸‹æ¬¡æ‰£æ¬¾: 1æœˆ30æ—¥            â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ ä»·æ ¼å˜åŠ¨æé†’                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  çˆ±å¥‡è‰ºVIP ä¸‹æœˆå°†æ¶¨ä»·: Â¥25 â†’ Â¥30 (+20%)                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š å¹´åº¦è®¢é˜…å¼€æ”¯: Â¥3,216    æ¯”å»å¹´å¢åŠ  Â¥420 (+15%)               â”‚
â”‚                                                                  â”‚
â”‚  [æ·»åŠ è®¢é˜…]  [å¯¼å‡ºæŠ¥å‘Š]                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è´¦å•æé†’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“… å³å°†åˆ°æœŸè´¦å•                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ”´ æ˜å¤© (1æœˆ5æ—¥)                                                â”‚
â”‚     â””â”€â”€ ğŸ’³ æ‹›å•†ä¿¡ç”¨å¡è¿˜æ¬¾  Â¥3,580                                â”‚
â”‚                                                                  â”‚
â”‚  ğŸŸ¡ åå¤© (1æœˆ6æ—¥)                                                â”‚
â”‚     â””â”€â”€ âš¡ ç”µè´¹           Â¥156                                   â”‚
â”‚                                                                  â”‚
â”‚  ğŸŸ¢ æœ¬å‘¨å†…                                                       â”‚
â”‚     â”œâ”€â”€ ğŸ“± æ‰‹æœºè¯è´¹       Â¥68     1æœˆ8æ—¥                        â”‚
â”‚     â”œâ”€â”€ ğŸ  ç‰©ä¸šè´¹         Â¥280    1æœˆ10æ—¥                       â”‚
â”‚     â””â”€â”€ ğŸŒ å®½å¸¦è´¹         Â¥99     1æœˆ10æ—¥                       â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¡ æœ¬å‘¨å¾…ç¼´æ€»è®¡: Â¥4,183                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- è®¢é˜…æœåŠ¡è¡¨
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50),
    category_id UUID REFERENCES categories(id),
    account_id UUID REFERENCES accounts(id),  -- æ‰£æ¬¾è´¦æˆ·
    amount DECIMAL(15,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'CNY',
    billing_cycle INT NOT NULL,  -- 1:æ—¥ 2:å‘¨ 3:æœˆ 4:å­£ 5:å¹´
    billing_day INT,  -- æ¯æœˆ/æ¯å¹´çš„æ‰£æ¬¾æ—¥
    start_date DATE NOT NULL,
    end_date DATE,  -- è®¢é˜…ç»“æŸæ—¥æœŸ
    next_billing_date DATE,
    last_amount DECIMAL(15,2),  -- ä¸Šæ¬¡é‡‘é¢ï¼ˆç”¨äºæ£€æµ‹æ¶¨ä»·ï¼‰
    price_change_alert BOOLEAN DEFAULT TRUE,
    reminder_days INT DEFAULT 3,  -- æå‰å‡ å¤©æé†’
    is_active BOOLEAN DEFAULT TRUE,
    auto_record BOOLEAN DEFAULT TRUE,  -- è‡ªåŠ¨ç”Ÿæˆè´¦ç›®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è´¦å•æé†’è¡¨
CREATE TABLE bill_reminders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    bill_type INT NOT NULL,  -- 1:ä¿¡ç”¨å¡ 2:æ°´ç”µ 3:æˆ¿ç§Ÿ 4:ç‰©ä¸š 5:å…¶ä»–
    amount DECIMAL(15,2),
    due_date DATE NOT NULL,
    repeat_type INT,  -- 0:ä¸€æ¬¡ 1:æ¯æœˆ 2:æ¯å­£ 3:æ¯å¹´
    account_id UUID REFERENCES accounts(id),
    reminder_days INT[] DEFAULT '{3,1,0}',  -- æå‰3å¤©ã€1å¤©ã€å½“å¤©æé†’
    is_paid BOOLEAN DEFAULT FALSE,
    paid_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä»·æ ¼å˜åŠ¨å†å²
CREATE TABLE subscription_price_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscription_id UUID REFERENCES subscriptions(id),
    old_price DECIMAL(15,2),
    new_price DECIMAL(15,2),
    change_percent DECIMAL(5,2),
    effective_date DATE,
    notified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 20.5 å‡€èµ„äº§è¿½è¸ª

#### åŠŸèƒ½è¯´æ˜
å®æ—¶å±•ç¤ºç”¨æˆ·çš„æ€»èµ„äº§ã€æ€»è´Ÿå€ºå’Œå‡€èµ„äº§å˜åŒ–è¶‹åŠ¿ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’ æˆ‘çš„å‡€èµ„äº§                          æ›´æ–°äº: 2024-01-05      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                    Â¥ 285,680                                     â”‚
â”‚                    å‡€èµ„äº§ â†‘ 2.3%                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“ˆ èµ„äº§                                ğŸ“‰ è´Ÿå€º                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ’³ é“¶è¡Œå­˜æ¬¾   Â¥125,000                 ğŸ’³ ä¿¡ç”¨å¡    Â¥12,500    â”‚
â”‚  ğŸ“± æ”¯ä»˜å®     Â¥23,500                  ğŸ  æˆ¿è´·      Â¥580,000   â”‚
â”‚  ğŸ’° å¾®ä¿¡      Â¥8,200                    ğŸš— è½¦è´·      Â¥85,000    â”‚
â”‚  ğŸ  æˆ¿äº§      Â¥2,000,000                                        â”‚
â”‚  ğŸš— æ±½è½¦      Â¥180,000                                          â”‚
â”‚  ğŸ“Š åŸºé‡‘      Â¥45,000                                           â”‚
â”‚  ğŸ“ˆ è‚¡ç¥¨      Â¥32,480                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  åˆè®¡         Â¥2,414,180                åˆè®¡        Â¥677,500    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š å‡€èµ„äº§è¶‹åŠ¿ï¼ˆè¿‘12ä¸ªæœˆï¼‰                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     â•­â”€â•®                                              â•­â”€â”€â”€â”€â”€â”€â”‚â”‚
â”‚  â”‚ â•­â”€â”€â”€â•¯ â•°â”€â”€â”€â•®          â•­â”€â”€â”€â”€â”€â”€â”€â”€â•®              â•­â”€â”€â”€â”€â”€â”€â”€â•¯      â”‚â”‚
â”‚  â”‚â”€â•¯          â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯             â”‚â”‚
â”‚  â”‚ 2æœˆ  3æœˆ  4æœˆ  5æœˆ  6æœˆ  7æœˆ  8æœˆ  9æœˆ  10æœˆ 11æœˆ 12æœˆ 1æœˆ   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¡ æœ¬æœˆå‡€èµ„äº§å¢åŠ  Â¥6,420ï¼Œä¸»è¦æ¥è‡ªå·¥èµ„æ”¶å…¥å’ŒæŠ•èµ„æ”¶ç›Š              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- èµ„äº§è´¦æˆ·è¡¨ï¼ˆæ‰©å±•accountsè¡¨ï¼‰
ALTER TABLE accounts ADD COLUMN asset_type INT DEFAULT 1;
-- 1:æµåŠ¨èµ„äº§ 2:å›ºå®šèµ„äº§ 3:æŠ•èµ„èµ„äº§ 4:è´Ÿå€º

-- èµ„äº§ä¼°å€¼è¡¨ï¼ˆç”¨äºæˆ¿äº§ã€æ±½è½¦ç­‰éœ€è¦ä¼°å€¼çš„èµ„äº§ï¼‰
CREATE TABLE asset_valuations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID REFERENCES accounts(id),
    valuation_date DATE NOT NULL,
    valuation_amount DECIMAL(15,2) NOT NULL,
    valuation_source VARCHAR(50),  -- manual, api, estimate
    note TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å‡€èµ„äº§å¿«ç…§ï¼ˆæ¯æ—¥/æ¯å‘¨è®°å½•ï¼‰
CREATE TABLE net_worth_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    snapshot_date DATE NOT NULL,
    total_assets DECIMAL(15,2) NOT NULL,
    total_liabilities DECIMAL(15,2) NOT NULL,
    net_worth DECIMAL(15,2) NOT NULL,
    assets_breakdown JSONB,  -- èµ„äº§æ˜ç»†
    liabilities_breakdown JSONB,  -- è´Ÿå€ºæ˜ç»†
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, snapshot_date)
);
```

### 20.6 åˆ†è´¦åŠŸèƒ½ï¼ˆæ‹†åˆ†äº¤æ˜“ï¼‰

#### åŠŸèƒ½è¯´æ˜
ä¸€ç¬”äº¤æ˜“å¯ä»¥æ‹†åˆ†åˆ°å¤šä¸ªåˆ†ç±»ï¼Œé€‚ç”¨äºè¶…å¸‚è´­ç‰©ç­‰åœºæ™¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ æ‹†åˆ†äº¤æ˜“                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸª æ²ƒå°”ç›è¶…å¸‚                              æ€»è®¡: Â¥358.50        â”‚
â”‚  ğŸ“… 2024-01-05                                                   â”‚
â”‚                                                                  â”‚
â”‚  æ‹†åˆ†æ˜ç»†:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ¥¬ ä¹°èœåšé¥­                             Â¥156.00             â”‚â”‚
â”‚  â”‚ ğŸ§´ æ—¥ç”¨å“                               Â¥89.50              â”‚â”‚
â”‚  â”‚ ğŸª é›¶é£Ÿé¥®æ–™                             Â¥68.00              â”‚â”‚
â”‚  â”‚ ğŸ§’ æ¯å©´ç”¨å“                             Â¥45.00              â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ [+ æ·»åŠ æ‹†åˆ†é¡¹]                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  å·²åˆ†é…: Â¥358.50  |  å‰©ä½™: Â¥0.00  âœ“                             â”‚
â”‚                                                                  â”‚
â”‚  [å–æ¶ˆ]                                        [ä¿å­˜æ‹†åˆ†]       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- äº¤æ˜“æ‹†åˆ†è¡¨
CREATE TABLE transaction_splits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transaction_id UUID REFERENCES transactions(id),
    category_id UUID REFERENCES categories(id),
    amount DECIMAL(15,2) NOT NULL,
    note VARCHAR(200),
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åœ¨transactionsè¡¨æ·»åŠ å­—æ®µ
ALTER TABLE transactions ADD COLUMN is_split BOOLEAN DEFAULT FALSE;
```

### 20.7 å®¶åº­å…±äº«è´¦æœ¬

#### åŠŸèƒ½è¯´æ˜
æ”¯æŒå®¶åº­æˆå‘˜å…±åŒç®¡ç†è´¢åŠ¡ï¼Œç±»ä¼¼YNAB Togetherã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è´¦æœ¬                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æˆå‘˜ (4äºº)                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ‘¨ çˆ¸çˆ¸ (ç®¡ç†å‘˜)    æœ¬æœˆæ”¯å‡º: Â¥8,520    é¢„ç®—å‰©ä½™: Â¥1,480     â”‚â”‚
â”‚  â”‚ ğŸ‘© å¦ˆå¦ˆ (ç®¡ç†å‘˜)    æœ¬æœˆæ”¯å‡º: Â¥6,350    é¢„ç®—å‰©ä½™: Â¥2,650     â”‚â”‚
â”‚  â”‚ ğŸ‘§ å¥³å„¿ (æˆå‘˜)      æœ¬æœˆæ”¯å‡º: Â¥1,200    é¢„ç®—å‰©ä½™: Â¥300       â”‚â”‚
â”‚  â”‚ ğŸ‘¦ å„¿å­ (æˆå‘˜)      æœ¬æœˆæ”¯å‡º: Â¥850      é¢„ç®—å‰©ä½™: Â¥150       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š å®¶åº­æœ¬æœˆæ€»è§ˆ                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  æ€»æ”¶å…¥: Â¥28,000  |  æ€»æ”¯å‡º: Â¥16,920  |  ç»“ä½™: Â¥11,080          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ  å…±åŒå¼€æ”¯                                                     â”‚
â”‚  â”œâ”€â”€ æˆ¿è´·           Â¥6,500                                      â”‚
â”‚  â”œâ”€â”€ æ°´ç”µç‡ƒæ°”       Â¥450                                        â”‚
â”‚  â”œâ”€â”€ ç‰©ä¸šè´¹         Â¥280                                        â”‚
â”‚  â””â”€â”€ å®¶åº­é‡‡è´­       Â¥2,800                                      â”‚
â”‚                                                                  â”‚
â”‚  âš™ï¸ æƒé™è®¾ç½®                                                     â”‚
â”‚  â”‚ â˜‘ï¸ æˆå‘˜å¯æŸ¥çœ‹å®¶åº­æ€»è§ˆ                                         â”‚
â”‚  â”‚ â˜ æˆå‘˜å¯æŸ¥çœ‹å…¶ä»–æˆå‘˜æ˜ç»†                                      â”‚
â”‚  â”‚ â˜‘ï¸ æˆå‘˜æ¶ˆè´¹éœ€è¦å®¡æ‰¹ï¼ˆè¶…è¿‡Â¥500ï¼‰                               â”‚
â”‚  â”‚ â˜‘ï¸ é¢„ç®—è¶…æ”¯è‡ªåŠ¨é€šçŸ¥ç®¡ç†å‘˜                                     â”‚
â”‚                                                                  â”‚
â”‚  [é‚€è¯·æˆå‘˜]  [æƒé™è®¾ç½®]  [æŸ¥çœ‹æŠ¥è¡¨]                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨æ‰©å±•

```sql
-- æ‰©å±•book_membersè¡¨
ALTER TABLE book_members ADD COLUMN monthly_budget DECIMAL(15,2);
ALTER TABLE book_members ADD COLUMN can_view_others BOOLEAN DEFAULT FALSE;
ALTER TABLE book_members ADD COLUMN approval_threshold DECIMAL(15,2);  -- è¶…è¿‡æ­¤é‡‘é¢éœ€å®¡æ‰¹
ALTER TABLE book_members ADD COLUMN color VARCHAR(20);  -- æˆå‘˜æ ‡è¯†é¢œè‰²

-- å®¡æ‰¹è®°å½•è¡¨
CREATE TABLE transaction_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transaction_id UUID REFERENCES transactions(id),
    requester_id UUID REFERENCES users(id),
    approver_id UUID REFERENCES users(id),
    status INT DEFAULT 0,  -- 0:å¾…å®¡æ‰¹ 1:å·²æ‰¹å‡† 2:å·²æ‹’ç»
    comment TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP
);
```

### 20.8 æ™ºèƒ½æ´å¯Ÿä¸å»ºè®®

#### AIé©±åŠ¨çš„è´¢åŠ¡åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ æ™ºèƒ½æ´å¯Ÿ                                    æœ¬å‘¨ (3æ¡)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âš ï¸ æ¶ˆè´¹å¼‚å¸¸                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  æœ¬å‘¨å¤–å–æ”¯å‡º Â¥380ï¼Œæ¯”ä¸Šå‘¨å¢åŠ  65%ã€‚                              â”‚
â”‚  å»ºè®®: å°è¯•å‡å°‘å¤–å–é¢‘æ¬¡ï¼Œæ¯å‘¨çœä¸‹ Â¥150 å¯ç”¨äºå‚¨è“„ã€‚                â”‚
â”‚                                                  [æŸ¥çœ‹è¯¦æƒ…]      â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š æ¶ˆè´¹è¶‹åŠ¿                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  æ‚¨çš„å’–å•¡æ¶ˆè´¹è¿ç»­3ä¸ªæœˆä¸Šæ¶¨ï¼Œæœ¬æœˆå·²è¾¾ Â¥420ã€‚                        â”‚
â”‚  å»ºè®®: è€ƒè™‘è´­ä¹°å’–å•¡æœºï¼Œé¢„è®¡6ä¸ªæœˆå¯å›æœ¬ã€‚                           â”‚
â”‚                                                  [è®¾ç½®é¢„ç®—]      â”‚
â”‚                                                                  â”‚
â”‚  ğŸ¯ ç›®æ ‡è¿›åº¦                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ã€Œå¹´å‡æ—…è¡ŒåŸºé‡‘ã€è¿›åº¦è½åäºè®¡åˆ’ï¼Œå»ºè®®æœ¬æœˆå¢åŠ å­˜å…¥ Â¥300ã€‚            â”‚
â”‚                                                  [è°ƒæ•´è®¡åˆ’]      â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’° çœé’±æœºä¼š                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  å‘ç°æ‚¨æœ‰3ä¸ªè§†é¢‘ä¼šå‘˜è®¢é˜…ï¼ˆçˆ±å¥‡è‰ºã€ä¼˜é…·ã€è…¾è®¯ï¼‰ï¼Œ                    â”‚
â”‚  åˆå¹¶ä¸ºä¸€ä¸ªå¯æ¯æœˆèŠ‚çœ Â¥35ã€‚                                       â”‚
â”‚                                                  [æŸ¥çœ‹è®¢é˜…]      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é¢„ç®—é¢„è­¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”” é¢„ç®—é¢„è­¦                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ”´ å·²è¶…æ”¯                                                       â”‚
â”‚     â””â”€â”€ ğŸ” å¤–å‡ºå°±é¤   Â¥650 / Â¥500   è¶…æ”¯ Â¥150                   â”‚
â”‚                                                                  â”‚
â”‚  ğŸŸ¡ å³å°†ç”¨å®Œ (>80%)                                              â”‚
â”‚     â”œâ”€â”€ â˜• å’–å•¡é¥®æ–™   Â¥178 / Â¥200   å‰©ä½™ Â¥22                    â”‚
â”‚     â””â”€â”€ ğŸ® å¨±ä¹      Â¥425 / Â¥500   å‰©ä½™ Â¥75                     â”‚
â”‚                                                                  â”‚
â”‚  ğŸŸ¢ è¿›åº¦æ­£å¸¸                                                     â”‚
â”‚     â”œâ”€â”€ ğŸ›’ ä¹°èœåšé¥­   Â¥892 / Â¥1500  å‰©ä½™ Â¥608                   â”‚
â”‚     â”œâ”€â”€ ğŸš‡ äº¤é€šå‡ºè¡Œ   Â¥280 / Â¥400   å‰©ä½™ Â¥120                   â”‚
â”‚     â””â”€â”€ ğŸ‘• æœè£…è´­ç‰©   Â¥0 / Â¥300     å‰©ä½™ Â¥300                   â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ğŸ’¡ å»ºè®®: ä»ã€Œæœè£…è´­ç‰©ã€è°ƒæ‹¨ Â¥150 åˆ°ã€Œå¤–å‡ºå°±é¤ã€                   â”‚
â”‚                                              [ä¸€é”®è°ƒæ‹¨]          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- æ™ºèƒ½æ´å¯Ÿè¡¨
CREATE TABLE financial_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    insight_type INT NOT NULL,
    -- 1:æ¶ˆè´¹å¼‚å¸¸ 2:è¶‹åŠ¿åˆ†æ 3:ç›®æ ‡æé†’ 4:çœé’±å»ºè®® 5:é¢„ç®—é¢„è­¦
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    data JSONB,  -- ç›¸å…³æ•°æ®
    action_type VARCHAR(50),  -- å»ºè®®çš„æ“ä½œç±»å‹
    action_data JSONB,  -- æ“ä½œæ‰€éœ€æ•°æ®
    priority INT DEFAULT 0,  -- ä¼˜å…ˆçº§
    is_read BOOLEAN DEFAULT FALSE,
    is_dismissed BOOLEAN DEFAULT FALSE,
    valid_until TIMESTAMP,  -- æœ‰æ•ˆæœŸ
    created_at TIMESTAMP DEFAULT NOW()
);

-- å‘¨æœŸæ€§åˆ†ææŠ¥å‘Š
CREATE TABLE periodic_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    report_type INT NOT NULL,  -- 1:å‘¨æŠ¥ 2:æœˆæŠ¥ 3:å¹´æŠ¥
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    summary JSONB NOT NULL,  -- æ”¶æ”¯æ‘˜è¦
    insights JSONB,  -- æ´å¯Ÿåˆ—è¡¨
    comparisons JSONB,  -- åŒæ¯”/ç¯æ¯”
    recommendations JSONB,  -- å»ºè®®åˆ—è¡¨
    is_sent BOOLEAN DEFAULT FALSE,
    sent_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 20.9 å‘¨æœŸæ€§äº¤æ˜“è‡ªåŠ¨è¯†åˆ«

#### åŠŸèƒ½è¯´æ˜
AIè‡ªåŠ¨è¯†åˆ«é‡å¤å‡ºç°çš„äº¤æ˜“ï¼Œæç¤ºç”¨æˆ·è®¾ç½®ä¸ºå®šæœŸäº¤æ˜“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ å‘ç°é‡å¤äº¤æ˜“                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æˆ‘ä»¬å‘ç°ä»¥ä¸‹äº¤æ˜“å¯èƒ½æ˜¯å®šæœŸå‘ç”Ÿçš„:                                 â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ‹ï¸ ä¹åˆ»å¥èº«                                                 â”‚â”‚
â”‚  â”‚ æ¯æœˆ15æ—¥å‰å  |  Â¥99  |  å·²å‡ºç° 6 æ¬¡                         â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ [è®¾ä¸ºå®šæœŸäº¤æ˜“]  [å¿½ç•¥]  [ä¸å†æé†’]                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â˜• ç‘å¹¸å’–å•¡                                                  â”‚â”‚
â”‚  â”‚ æ¯å‘¨ä¸€è‡³å‘¨äº”  |  Â¥15-20  |  å·²å‡ºç° 23 æ¬¡                     â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ [è®¾ä¸ºå®šæœŸäº¤æ˜“]  [å¿½ç•¥]  [ä¸å†æé†’]                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- äº¤æ˜“æ¨¡å¼è¯†åˆ«
CREATE TABLE transaction_patterns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    pattern_type INT NOT NULL,  -- 1:å›ºå®šå‘¨æœŸ 2:å·¥ä½œæ—¥ 3:å‘¨æœ« 4:æœˆåˆ/æœˆæœ«
    merchant_name VARCHAR(200),
    category_id UUID REFERENCES categories(id),
    avg_amount DECIMAL(15,2),
    amount_variance DECIMAL(15,2),  -- é‡‘é¢æ³¢åŠ¨èŒƒå›´
    frequency_days INT,  -- å¹³å‡é—´éš”å¤©æ•°
    occurrence_count INT,  -- å‡ºç°æ¬¡æ•°
    confidence DECIMAL(3,2),  -- ç½®ä¿¡åº¦
    suggested_schedule JSONB,  -- å»ºè®®çš„å®šæœŸè®¾ç½®
    is_confirmed BOOLEAN DEFAULT FALSE,
    is_dismissed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 20.10 æ–°å¢APIåˆ—è¡¨

```
#### é›¶åŸºé¢„ç®—æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/budgets/zero-based | è·å–é›¶åŸºé¢„ç®—åˆ†é… |
| POST | /api/v1/budgets/allocate | åˆ†é…é¢„ç®—åˆ°åˆ†ç±» |
| POST | /api/v1/budgets/reallocate | é¢„ç®—å†åˆ†é… |
| GET | /api/v1/budgets/unallocated | è·å–å¾…åˆ†é…é‡‘é¢ |
| GET | /api/v1/stats/money-age | è·å–é’±é¾„æŒ‡æ ‡ |

#### ç›®æ ‡è¿½è¸ªæ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/goals | è·å–ç›®æ ‡åˆ—è¡¨ |
| POST | /api/v1/goals | åˆ›å»ºç›®æ ‡ |
| PUT | /api/v1/goals/{id} | æ›´æ–°ç›®æ ‡ |
| DELETE | /api/v1/goals/{id} | åˆ é™¤ç›®æ ‡ |
| POST | /api/v1/goals/{id}/contribute | å‘ç›®æ ‡å­˜å…¥èµ„é‡‘ |
| GET | /api/v1/goals/{id}/progress | è·å–ç›®æ ‡è¿›åº¦ |

#### å€ºåŠ¡ç®¡ç†æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/debts | è·å–å€ºåŠ¡åˆ—è¡¨ |
| POST | /api/v1/debts | æ·»åŠ å€ºåŠ¡ |
| PUT | /api/v1/debts/{id} | æ›´æ–°å€ºåŠ¡ |
| POST | /api/v1/debts/simulate | è¿˜æ¬¾æ¨¡æ‹Ÿ |
| GET | /api/v1/debts/payoff-plans | è·å–è¿˜æ¬¾è®¡åˆ’ |
| POST | /api/v1/debts/payoff-plans | åˆ›å»ºè¿˜æ¬¾è®¡åˆ’ |

#### è®¢é˜…ç®¡ç†æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/subscriptions | è·å–è®¢é˜…åˆ—è¡¨ |
| POST | /api/v1/subscriptions | æ·»åŠ è®¢é˜… |
| PUT | /api/v1/subscriptions/{id} | æ›´æ–°è®¢é˜… |
| DELETE | /api/v1/subscriptions/{id} | åˆ é™¤è®¢é˜… |
| GET | /api/v1/subscriptions/upcoming | è·å–å³å°†æ‰£æ¬¾çš„è®¢é˜… |
| GET | /api/v1/subscriptions/price-changes | è·å–ä»·æ ¼å˜åŠ¨ |

#### è´¦å•æé†’æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/bill-reminders | è·å–è´¦å•æé†’åˆ—è¡¨ |
| POST | /api/v1/bill-reminders | åˆ›å»ºè´¦å•æé†’ |
| PUT | /api/v1/bill-reminders/{id} | æ›´æ–°è´¦å•æé†’ |
| POST | /api/v1/bill-reminders/{id}/mark-paid | æ ‡è®°å·²æ”¯ä»˜ |

#### å‡€èµ„äº§æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/net-worth | è·å–å‡€èµ„äº§æ¦‚è§ˆ |
| GET | /api/v1/net-worth/history | è·å–å‡€èµ„äº§å†å² |
| POST | /api/v1/assets/{id}/valuate | æ›´æ–°èµ„äº§ä¼°å€¼ |

#### æ™ºèƒ½æ´å¯Ÿæ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/insights | è·å–æ™ºèƒ½æ´å¯Ÿ |
| POST | /api/v1/insights/{id}/dismiss | å¿½ç•¥æ´å¯Ÿ |
| POST | /api/v1/insights/{id}/action | æ‰§è¡Œå»ºè®®æ“ä½œ |
| GET | /api/v1/reports/weekly | è·å–å‘¨æŠ¥ |
| GET | /api/v1/reports/monthly | è·å–æœˆæŠ¥ |

#### äº¤æ˜“æ‹†åˆ†æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/transactions/{id}/split | æ‹†åˆ†äº¤æ˜“ |
| PUT | /api/v1/transactions/{id}/splits | æ›´æ–°æ‹†åˆ† |
| DELETE | /api/v1/transactions/{id}/splits | å–æ¶ˆæ‹†åˆ† |

#### å®¶åº­å…±äº«æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/family/overview | è·å–å®¶åº­æ€»è§ˆ |
| GET | /api/v1/family/members | è·å–æˆå‘˜åˆ—è¡¨åŠæ¶ˆè´¹ |
| PUT | /api/v1/family/members/{id}/budget | è®¾ç½®æˆå‘˜é¢„ç®— |
| GET | /api/v1/family/approvals | è·å–å¾…å®¡æ‰¹åˆ—è¡¨ |
| POST | /api/v1/family/approvals/{id}/approve | å®¡æ‰¹é€šè¿‡ |
| POST | /api/v1/family/approvals/{id}/reject | å®¡æ‰¹æ‹’ç» |
```

### 20.11 åŠŸèƒ½å¯¹æ¯”æ€»ç»“

| åŠŸèƒ½ | Mint | YNAB | æœ¬åº”ç”¨ |
|------|:----:|:----:|:------:|
| è´¦æˆ·åŒæ­¥ | âœ“ | âœ“ | âœ“ (æ‰‹åŠ¨/AIè¯†åˆ«) |
| è‡ªåŠ¨åˆ†ç±» | âœ“ | âœ“ | âœ“ (AIå¢å¼º) |
| é¢„ç®—ç®¡ç† | âœ“ | âœ“ | âœ“ |
| é›¶åŸºé¢„ç®— | âœ— | âœ“ | âœ“ |
| ç›®æ ‡è¿½è¸ª | âœ“ | âœ“ | âœ“ |
| å€ºåŠ¡è§„åˆ’ | âœ— | âœ“ | âœ“ |
| è®¢é˜…ç®¡ç† | âœ“ | âœ— | âœ“ |
| è´¦å•æé†’ | âœ“ | âœ— | âœ“ |
| ä¿¡ç”¨åˆ†æ•° | âœ“ | âœ— | âœ— (å›½å†…æ— æ­¤æœåŠ¡) |
| å‡€èµ„äº§è¿½è¸ª | âœ“ | âœ“ | âœ“ |
| äº¤æ˜“æ‹†åˆ† | âœ— | âœ“ | âœ“ |
| å®¶åº­å…±äº« | âœ— | âœ“ | âœ“ |
| æ™ºèƒ½æ´å¯Ÿ | âœ“ | âœ— | âœ“ (AIå¢å¼º) |
| å›¾ç‰‡è¯†åˆ« | âœ— | âœ— | âœ“ |
| è¯­éŸ³è®°è´¦ | âœ— | âœ— | âœ“ |
| é‚®ä»¶è§£æ | âœ— | âœ— | âœ“ |
| ç¦»çº¿æ¨¡å¼ | âœ— | âœ— | âœ“ |
| å¤šè¯­è¨€ | âœ— | âœ“ | âœ“ |
| å¤šè´§å¸ | âœ— | âœ“ | âœ“ |

---

## äºŒåä¸€ã€ç”¨æˆ·åé¦ˆç³»ç»Ÿ

å®Œæ•´çš„ç”¨æˆ·åé¦ˆæ”¶é›†ã€å¤„ç†å’Œå›å¤æœºåˆ¶ï¼ŒæŒç»­æ”¹è¿›äº§å“ä½“éªŒã€‚

### 21.1 åé¦ˆå…¥å£è®¾è®¡

#### å¤šæ¸ é“åé¦ˆå…¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± Appå†…åé¦ˆå…¥å£                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1ï¸âƒ£ ã€Œæˆ‘çš„ã€é¡µé¢ â†’ å¸®åŠ©ä¸åé¦ˆ                                    â”‚
â”‚     â””â”€â”€ å¸¸é©»å…¥å£ï¼Œéšæ—¶å¯è®¿é—®                                      â”‚
â”‚                                                                  â”‚
â”‚  2ï¸âƒ£ è®¾ç½®é¡µé¢ â†’ æ„è§åé¦ˆ                                          â”‚
â”‚     â””â”€â”€ ç³»ç»Ÿè®¾ç½®ä¸­çš„åé¦ˆå…¥å£                                      â”‚
â”‚                                                                  â”‚
â”‚  3ï¸âƒ£ æ‘‡ä¸€æ‘‡å¿«æ·åé¦ˆ                                               â”‚
â”‚     â””â”€â”€ æ‘‡åŠ¨æ‰‹æœºå”¤èµ·åé¦ˆç•Œé¢ï¼ˆå¯å…³é—­ï¼‰                             â”‚
â”‚                                                                  â”‚
â”‚  4ï¸âƒ£ åŠŸèƒ½å¼‚å¸¸æ—¶å¼¹çª—                                               â”‚
â”‚     â””â”€â”€ æ“ä½œå¤±è´¥æ—¶è¯¢é—®æ˜¯å¦åé¦ˆ                                    â”‚
â”‚                                                                  â”‚
â”‚  5ï¸âƒ£ æ‚¬æµ®åé¦ˆæŒ‰é’®ï¼ˆå¯é€‰ï¼‰                                         â”‚
â”‚     â””â”€â”€ å¼€å‘/æµ‹è¯•ç‰ˆæœ¬çš„å¿«é€Ÿåé¦ˆ                                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.2 åé¦ˆç±»å‹åˆ†ç±»

| ç±»å‹ | å›¾æ ‡ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **BugæŠ¥å‘Š** | ğŸ› | åŠŸèƒ½å¼‚å¸¸ã€å´©æºƒã€æ•°æ®é”™è¯¯ | é«˜ |
| **åŠŸèƒ½å»ºè®®** | ğŸ’¡ | æ–°åŠŸèƒ½éœ€æ±‚ã€æ”¹è¿›å»ºè®® | ä¸­ |
| **ä½¿ç”¨å’¨è¯¢** | â“ | å¦‚ä½•ä½¿ç”¨ã€æ“ä½œæŒ‡å¯¼ | ä¸­ |
| **ä½“éªŒé—®é¢˜** | ğŸ˜• | ç•Œé¢ä¸å‹å¥½ã€æ“ä½œå¤æ‚ | ä¸­ |
| **æŠ•è¯‰å»ºè®®** | ğŸ“¢ | æœåŠ¡æŠ•è¯‰ã€è´¦å·é—®é¢˜ | é«˜ |
| **æ•°æ®é—®é¢˜** | ğŸ“Š | ç»Ÿè®¡é”™è¯¯ã€æ•°æ®ä¸¢å¤± | é«˜ |
| **å…¶ä»–** | ğŸ“ | å…¶ä»–ç±»å‹åé¦ˆ | ä½ |

### 21.3 åé¦ˆæäº¤ç•Œé¢

#### ç”¨æˆ·ç«¯åé¦ˆè¡¨å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ æäº¤åé¦ˆ                                           [Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  åé¦ˆç±»å‹                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ› BugæŠ¥å‘Š  â”‚ ğŸ’¡ åŠŸèƒ½å»ºè®®  â”‚ â“ ä½¿ç”¨å’¨è¯¢  â”‚ ğŸ˜• ä½“éªŒé—®é¢˜     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  é—®é¢˜æè¿° *                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®...                               â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  0/500                                                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“· æ·»åŠ æˆªå›¾ï¼ˆæœ€å¤š4å¼ ï¼‰                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  + ğŸ“·  â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“± è‡ªåŠ¨æ”¶é›†è®¾å¤‡ä¿¡æ¯                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â˜‘ï¸ è®¾å¤‡å‹å·: iPhone 15 Pro                                  â”‚â”‚
â”‚  â”‚ â˜‘ï¸ ç³»ç»Ÿç‰ˆæœ¬: iOS 17.2                                       â”‚â”‚
â”‚  â”‚ â˜‘ï¸ Appç‰ˆæœ¬: 1.2.3                                           â”‚â”‚
â”‚  â”‚ â˜‘ï¸ ç½‘ç»œçŠ¶æ€: WiFi                                           â”‚â”‚
â”‚  â”‚ â˜ åŒ…å«æœ€è¿‘æ“ä½œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  è”ç³»æ–¹å¼ï¼ˆé€‰å¡«ï¼Œç”¨äºå›å¤ï¼‰                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“§ é‚®ç®± / ğŸ“± æ‰‹æœº                                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â˜‘ï¸ æˆ‘åŒæ„ã€Šéšç§æ”¿ç­–ã€‹ä¸­å…³äºåé¦ˆä¿¡æ¯æ”¶é›†çš„æ¡æ¬¾                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        æäº¤åé¦ˆ                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æˆ‘çš„åé¦ˆè®°å½•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ æˆ‘çš„åé¦ˆ                                      [æäº¤æ–°åé¦ˆ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ› å›¾ç‰‡è¯†åˆ«æœ‰æ—¶å€™é‡‘é¢è§£æé”™è¯¯                                 â”‚â”‚
â”‚  â”‚ 2024-01-05 14:30                                            â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚ â”‚ ğŸŸ¢ å·²è§£å†³                                                â”‚ â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚ ğŸ’¬ å®˜æ–¹å›å¤: å·²åœ¨1.2.4ç‰ˆæœ¬ä¿®å¤ï¼Œè¯·æ›´æ–°App                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ’¡ å¸Œæœ›å¢åŠ è®°è´¦æé†’åŠŸèƒ½                                      â”‚â”‚
â”‚  â”‚ 2024-01-03 09:15                                            â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚ â”‚ ğŸ”µ å·²é‡‡çº³                                                â”‚ â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚ ğŸ’¬ å®˜æ–¹å›å¤: æ„Ÿè°¢å»ºè®®ï¼å·²åŠ å…¥å¼€å‘è®¡åˆ’ï¼Œé¢„è®¡2æœˆä¸Šçº¿            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â“ å¦‚ä½•å¯¼å‡ºè´¦ç›®æ•°æ®ï¼Ÿ                                        â”‚â”‚
â”‚  â”‚ 2024-01-02 16:45                                            â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚ â”‚ ğŸŸ¢ å·²å›å¤                                                â”‚ â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚ ğŸ’¬ å®˜æ–¹å›å¤: åœ¨ã€Œæˆ‘çš„ã€â†’ã€Œæ•°æ®ç®¡ç†ã€â†’ã€Œå¯¼å‡ºæ•°æ®ã€ä¸­æ“ä½œ      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ› Appé—ªé€€é—®é¢˜                                               â”‚â”‚
â”‚  â”‚ 2024-01-01 10:20                                            â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚ â”‚ ğŸŸ¡ å¤„ç†ä¸­                                                â”‚ â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚ ğŸ’¬ å®˜æ–¹å›å¤: æ­£åœ¨æ’æŸ¥ä¸­ï¼Œè¯·é—®èƒ½å¦æä¾›æ›´å¤šå¤ç°æ­¥éª¤ï¼Ÿ           â”‚â”‚
â”‚  â”‚                                          [ç»§ç»­æ²Ÿé€š]         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.4 åé¦ˆçŠ¶æ€æµè½¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åé¦ˆå¤„ç†æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æäº¤
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     è‡ªåŠ¨      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾…å¤„ç†  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ AIé¢„åˆ†ç±» â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                   â–¼                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ å¸¸è§é—®é¢˜ â”‚        â”‚ BugæŠ¥å‘Š â”‚        â”‚ åŠŸèƒ½å»ºè®® â”‚
      â”‚ è‡ªåŠ¨å›å¤ â”‚        â”‚ è½¬æŠ€æœ¯ç»„ â”‚        â”‚ è½¬äº§å“ç»„ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚                   â”‚
           â–¼                   â–¼                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  å·²å›å¤  â”‚        â”‚  å¤„ç†ä¸­  â”‚        â”‚  è¯„ä¼°ä¸­  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                   â”‚
                               â–¼                   â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  å·²è§£å†³  â”‚        â”‚ å·²é‡‡çº³/  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ æš‚ä¸å¤„ç† â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€è¯´æ˜:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”´ å¾…å¤„ç†  â”‚ æ–°æäº¤çš„åé¦ˆï¼Œç­‰å¾…å®¢æœåˆ†é…                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¡ å¤„ç†ä¸­  â”‚ å·²åˆ†é…å¤„ç†äººï¼Œæ­£åœ¨è§£å†³                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¢ å·²å›å¤  â”‚ å·²ç»™ç”¨æˆ·å›å¤ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¢ å·²è§£å†³  â”‚ é—®é¢˜å·²è§£å†³ï¼Œç”¨æˆ·ç¡®è®¤æˆ–è¶…æ—¶è‡ªåŠ¨å…³é—­              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”µ å·²é‡‡çº³  â”‚ åŠŸèƒ½å»ºè®®å·²åŠ å…¥å¼€å‘è®¡åˆ’                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âšª æš‚ä¸å¤„ç†â”‚ å»ºè®®æš‚ä¸å®ç°ï¼Œå·²å‘ŠçŸ¥ç”¨æˆ·åŸå›                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â¬› å·²å…³é—­  â”‚ åé¦ˆå·²å¤„ç†å®Œæˆå¹¶å…³é—­                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.5 ç®¡ç†åå° - åé¦ˆç®¡ç†

#### åé¦ˆå·¥å•åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ åé¦ˆç®¡ç†                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ç­›é€‰: [å…¨éƒ¨ç±»å‹ â–¼] [å…¨éƒ¨çŠ¶æ€ â–¼] [æœ€è¿‘7å¤© â–¼] [ğŸ” æœç´¢å…³é”®è¯]     â”‚
â”‚                                                                  â”‚
â”‚  ç»Ÿè®¡: å¾…å¤„ç† 23 | å¤„ç†ä¸­ 15 | ä»Šæ—¥æ–°å¢ 8 | å¹³å‡å“åº” 2.5å°æ—¶     â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ ID        ç±»å‹    ç”¨æˆ·        æ ‡é¢˜              çŠ¶æ€    æ—¶é—´  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ #1024    ğŸ›Bug   138****8888  Appå¯åŠ¨é—ªé€€       ğŸ”´å¾…å¤„ç† 5åˆ†é’Ÿ â”‚
â”‚  â–¡ #1023    ğŸ’¡å»ºè®®   ç”¨æˆ·A       å¸Œæœ›æ”¯æŒApple Watch ğŸŸ¡å¤„ç†ä¸­ 1å°æ—¶â”‚
â”‚  â–¡ #1022    â“å’¨è¯¢   ç”¨æˆ·B       å¦‚ä½•ä¿®æ”¹è´¦å•æ—¥æœŸ   ğŸŸ¢å·²å›å¤ 2å°æ—¶ â”‚
â”‚  â–¡ #1021    ğŸ›Bug   ç”¨æˆ·C       è¯­éŸ³è¯†åˆ«ä¸å‡†ç¡®     ğŸŸ¡å¤„ç†ä¸­ 3å°æ—¶ â”‚
â”‚  â–¡ #1020    ğŸ˜•ä½“éªŒ   ç”¨æˆ·D       ç»Ÿè®¡å›¾è¡¨çœ‹ä¸æ¸…æ¥š   ğŸ”µå·²é‡‡çº³ 5å°æ—¶ â”‚
â”‚  â–¡ #1019    ğŸ“¢æŠ•è¯‰   139****9999  ä¼šå‘˜æ‰£è´¹é—®é¢˜      ğŸ”´å¾…å¤„ç† 6å°æ—¶ â”‚
â”‚  ...                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ‰¹é‡åˆ†é…] [æ‰¹é‡å›å¤] [å¯¼å‡ºæŠ¥è¡¨]              å…± 156 æ¡ < 1/16 > â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å·¥å•è¯¦æƒ…ä¸å›å¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ å·¥å•è¯¦æƒ… #1024                                    [å…³é—­å·¥å•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ åŸºæœ¬ä¿¡æ¯                                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ç±»å‹: ğŸ› BugæŠ¥å‘Š          çŠ¶æ€: ğŸ”´ å¾…å¤„ç†                    â”‚â”‚
â”‚  â”‚ ç”¨æˆ·: 138****8888         æäº¤æ—¶é—´: 2024-01-05 14:30        â”‚â”‚
â”‚  â”‚ è®¾å¤‡: iPhone 15 Pro       Appç‰ˆæœ¬: 1.2.3                    â”‚â”‚
â”‚  â”‚ ç³»ç»Ÿ: iOS 17.2            ç½‘ç»œ: WiFi                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ é—®é¢˜æè¿°                                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ æ‰“å¼€Appåï¼Œç‚¹å‡»è®°è´¦æŒ‰é’®ï¼Œé€‰æ‹©æ‹ç…§è¯†åˆ«ï¼Œç›¸æœºæ‰“å¼€åAppå°±é—ªé€€äº†ã€‚ â”‚â”‚
â”‚  â”‚ å·²ç»è¯•äº†å¥½å‡ æ¬¡éƒ½æ˜¯è¿™æ ·ã€‚                                      â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ ğŸ“· é™„ä»¶: [æˆªå›¾1.png] [æˆªå›¾2.png]                             â”‚â”‚
â”‚  â”‚ ğŸ“‹ æ—¥å¿—: [æŸ¥çœ‹æ“ä½œæ—¥å¿—]                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å¤„ç†è®°å½•                                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ æš‚æ— å¤„ç†è®°å½•                                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å›å¤ç”¨æˆ·                                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ğŸ“ è¾“å…¥å›å¤å†…å®¹...                                           â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ å¿«æ·å›å¤: [é€‰æ‹©æ¨¡æ¿ â–¼]                                       â”‚â”‚
â”‚  â”‚ â”œâ”€â”€ æ„Ÿè°¢åé¦ˆï¼Œæ­£åœ¨å¤„ç†                                       â”‚â”‚
â”‚  â”‚ â”œâ”€â”€ è¯·æä¾›æ›´å¤šä¿¡æ¯                                           â”‚â”‚
â”‚  â”‚ â”œâ”€â”€ é—®é¢˜å·²ä¿®å¤ï¼Œè¯·æ›´æ–°                                       â”‚â”‚
â”‚  â”‚ â””â”€â”€ åŠŸèƒ½å·²åŠ å…¥è®¡åˆ’                                           â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ [ä¿å­˜è‰ç¨¿]              [å‘é€å›å¤å¹¶æ›´æ–°çŠ¶æ€ â–¼]                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å†…éƒ¨å¤‡æ³¨ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰                                        â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ åˆ†é…ç»™: [é€‰æ‹©å¤„ç†äºº â–¼]    ä¼˜å…ˆçº§: [é«˜ â–¼]                     â”‚â”‚
â”‚  â”‚ æ ‡ç­¾: [ç›¸æœº] [é—ªé€€] [iOS]  å…³è”å·¥å•: [#1018]                  â”‚â”‚
â”‚  â”‚ å¤‡æ³¨: _______________                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.6 æ™ºèƒ½å¤„ç†åŠŸèƒ½

#### AIè¾…åŠ©åˆ†ç±»ä¸å›å¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– æ™ºèƒ½è¾…åŠ©                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1ï¸âƒ£ è‡ªåŠ¨åˆ†ç±»                                                    â”‚
â”‚     â””â”€â”€ AIåˆ†æåé¦ˆå†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«ç±»å‹å’Œç´§æ€¥ç¨‹åº¦                    â”‚
â”‚                                                                  â”‚
â”‚  2ï¸âƒ£ ç›¸ä¼¼é—®é¢˜åŒ¹é…                                                â”‚
â”‚     â””â”€â”€ è‡ªåŠ¨å…³è”å†å²ç›¸ä¼¼å·¥å•ï¼Œæä¾›å¤„ç†å‚è€ƒ                        â”‚
â”‚                                                                  â”‚
â”‚  3ï¸âƒ£ æ™ºèƒ½å›å¤å»ºè®®                                                â”‚
â”‚     â””â”€â”€ æ ¹æ®é—®é¢˜ç±»å‹ç”Ÿæˆå›å¤å»ºè®®                                  â”‚
â”‚                                                                  â”‚
â”‚  4ï¸âƒ£ FAQè‡ªåŠ¨å›å¤                                                 â”‚
â”‚     â””â”€â”€ å¸¸è§é—®é¢˜è‡ªåŠ¨å›å¤ï¼Œå¤æ‚é—®é¢˜è½¬äººå·¥                          â”‚
â”‚                                                                  â”‚
â”‚  5ï¸âƒ£ æƒ…æ„Ÿåˆ†æ                                                    â”‚
â”‚     â””â”€â”€ è¯†åˆ«ç”¨æˆ·æƒ…ç»ªï¼Œä¼˜å…ˆå¤„ç†è´Ÿé¢æƒ…ç»ªåé¦ˆ                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è‡ªåŠ¨å›å¤ç¤ºä¾‹

```python
# å¸¸è§é—®é¢˜è‡ªåŠ¨å›å¤é…ç½®
FAQ_AUTO_REPLIES = {
    "å¦‚ä½•å¯¼å‡ºæ•°æ®": {
        "keywords": ["å¯¼å‡º", "æ•°æ®å¯¼å‡º", "å¤‡ä»½æ•°æ®", "ä¸‹è½½æ•°æ®"],
        "reply": """
æ‚¨å¥½ï¼å¯¼å‡ºæ•°æ®çš„æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š
1. æ‰“å¼€Appï¼Œè¿›å…¥ã€Œæˆ‘çš„ã€é¡µé¢
2. ç‚¹å‡»ã€Œæ•°æ®ç®¡ç†ã€
3. é€‰æ‹©ã€Œå¯¼å‡ºæ•°æ®ã€
4. é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼ˆExcel/CSVï¼‰å’Œæ—¶é—´èŒƒå›´
5. ç‚¹å‡»ã€Œå¼€å§‹å¯¼å‡ºã€

å¯¼å‡ºçš„æ–‡ä»¶ä¼šä¿å­˜åˆ°æ‚¨çš„æ‰‹æœºï¼Œä¹Ÿå¯ä»¥åˆ†äº«åˆ°é‚®ç®±æˆ–å…¶ä»–åº”ç”¨ã€‚

å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ï¼
        """,
        "auto_close": True,
        "close_delay_hours": 24
    },
    "å¿˜è®°å¯†ç ": {
        "keywords": ["å¿˜è®°å¯†ç ", "å¯†ç å¿˜äº†", "é‡ç½®å¯†ç ", "æ‰¾å›å¯†ç "],
        "reply": """
æ‚¨å¥½ï¼é‡ç½®å¯†ç çš„æ­¥éª¤å¦‚ä¸‹ï¼š
1. åœ¨ç™»å½•é¡µé¢ç‚¹å‡»ã€Œå¿˜è®°å¯†ç ã€
2. è¾“å…¥æ³¨å†Œæ—¶ä½¿ç”¨çš„æ‰‹æœºå·
3. è·å–éªŒè¯ç å¹¶è¾“å…¥
4. è®¾ç½®æ–°å¯†ç 

å¦‚æœæ‰‹æœºå·å·²æ›´æ¢ï¼Œè¯·è”ç³»å®¢æœå¤„ç†ã€‚
        """,
        "auto_close": False
    }
}
```

### 21.7 é€šçŸ¥ä¸æé†’

#### ç”¨æˆ·é€šçŸ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”” åé¦ˆé€šçŸ¥æ–¹å¼                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“± Appæ¨é€é€šçŸ¥                                                  â”‚
â”‚     â””â”€â”€ åé¦ˆçŠ¶æ€å˜æ›´ã€æ”¶åˆ°å›å¤æ—¶æ¨é€                              â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“§ é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚ç”¨æˆ·å¡«å†™äº†é‚®ç®±ï¼‰                                  â”‚
â”‚     â””â”€â”€ å‘é€è¯¦ç»†å›å¤å†…å®¹åˆ°ç”¨æˆ·é‚®ç®±                                â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¬ ç«™å†…æ¶ˆæ¯                                                     â”‚
â”‚     â””â”€â”€ Appå†…æ¶ˆæ¯ä¸­å¿ƒæ˜¾ç¤ºåé¦ˆæ›´æ–°                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“± çŸ­ä¿¡é€šçŸ¥ï¼ˆé‡è¦é—®é¢˜ï¼‰                                          â”‚
â”‚     â””â”€â”€ è´¦å·å®‰å…¨ã€æ”¯ä»˜é—®é¢˜ç­‰é‡è¦åé¦ˆ                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®¢æœæé†’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â° å¤„ç†æé†’è§„åˆ™                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1ï¸âƒ£ æ–°å·¥å•æé†’                                                  â”‚
â”‚     â””â”€â”€ æ–°åé¦ˆæäº¤åç«‹å³é€šçŸ¥ç›¸å…³å®¢æœ                              â”‚
â”‚                                                                  â”‚
â”‚  2ï¸âƒ£ è¶…æ—¶æé†’                                                    â”‚
â”‚     â”œâ”€â”€ å¾…å¤„ç†è¶…è¿‡2å°æ—¶ â†’ æé†’ä¸€æ¬¡                               â”‚
â”‚     â”œâ”€â”€ å¾…å¤„ç†è¶…è¿‡4å°æ—¶ â†’ å‡çº§æé†’ä¸»ç®¡                            â”‚
â”‚     â””â”€â”€ å¾…å¤„ç†è¶…è¿‡8å°æ—¶ â†’ å‡çº§æé†’ç»ç†                            â”‚
â”‚                                                                  â”‚
â”‚  3ï¸âƒ£ ç”¨æˆ·å‚¬ä¿ƒæé†’                                                â”‚
â”‚     â””â”€â”€ ç”¨æˆ·è¿½é—®æˆ–å‚¬ä¿ƒæ—¶ç«‹å³é€šçŸ¥å¤„ç†äºº                            â”‚
â”‚                                                                  â”‚
â”‚  4ï¸âƒ£ VIPç”¨æˆ·ä¼˜å…ˆ                                                 â”‚
â”‚     â””â”€â”€ ä»˜è´¹ä¼šå‘˜åé¦ˆä¼˜å…ˆå¤„ç†ï¼Œå•ç‹¬æé†’                            â”‚
â”‚                                                                  â”‚
â”‚  5ï¸âƒ£ è´Ÿé¢æƒ…ç»ªé¢„è­¦                                                â”‚
â”‚     â””â”€â”€ AIè¯†åˆ«åˆ°å¼ºçƒˆä¸æ»¡æ—¶ç«‹å³é¢„è­¦                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.8 æ•°æ®ç»Ÿè®¡ä¸åˆ†æ

#### åé¦ˆç»Ÿè®¡ä»ªè¡¨ç›˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š åé¦ˆæ•°æ®ç»Ÿè®¡                               æ—¶é—´: 2024å¹´1æœˆ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æœ¬æœˆæ€»åé¦ˆ    â”‚ â”‚ å¹³å‡å“åº”æ—¶é—´  â”‚ â”‚ è§£å†³ç‡       â”‚ â”‚ æ»¡æ„åº¦   â”‚â”‚
â”‚  â”‚    256       â”‚ â”‚   2.5å°æ—¶    â”‚ â”‚   92%        â”‚ â”‚  4.6/5   â”‚â”‚
â”‚  â”‚   â†‘12%      â”‚ â”‚   â†“15%      â”‚ â”‚   â†‘3%        â”‚ â”‚  â†‘0.2    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“ˆ åé¦ˆè¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 15â”‚    â•­â”€â•®                                                  â”‚â”‚
â”‚  â”‚ 10â”‚â•­â”€â”€â”€â•¯ â•°â”€â”€â”€â•®     â•­â”€â”€â”€â”€â•®                    â•­â”€â”€â”€â”€â•®        â”‚â”‚
â”‚  â”‚  5â”‚â•¯          â•°â”€â”€â”€â”€â”€â•¯    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯    â•°â”€â”€â”€â”€   â”‚â”‚
â”‚  â”‚  0â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚
â”‚  â”‚    1æ—¥      7æ—¥      14æ—¥      21æ—¥      28æ—¥               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š ç±»å‹åˆ†å¸ƒ                    ğŸ“Š çŠ¶æ€åˆ†å¸ƒ                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ› BugæŠ¥å‘Š    35%  â–ˆâ–ˆâ–ˆâ–ˆ â”‚   â”‚ ğŸŸ¢ å·²è§£å†³   65%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â”‚ â”‚
â”‚  â”‚ ğŸ’¡ åŠŸèƒ½å»ºè®®   28%  â–ˆâ–ˆâ–ˆ  â”‚   â”‚ ğŸŸ¡ å¤„ç†ä¸­   20%  â–ˆâ–ˆ         â”‚ â”‚
â”‚  â”‚ â“ ä½¿ç”¨å’¨è¯¢   22%  â–ˆâ–ˆ   â”‚   â”‚ ğŸ”´ å¾…å¤„ç†   10%  â–ˆ          â”‚ â”‚
â”‚  â”‚ ğŸ˜• ä½“éªŒé—®é¢˜   10%  â–ˆ    â”‚   â”‚ â¬› å·²å…³é—­    5%  â–Œ          â”‚ â”‚
â”‚  â”‚ ğŸ“¢ å…¶ä»–       5%  â–Œ    â”‚   â”‚                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”¥ çƒ­é—¨é—®é¢˜ TOP 5                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. å›¾ç‰‡è¯†åˆ«é‡‘é¢ä¸å‡†ç¡®           (23æ¬¡)    [æŸ¥çœ‹è¯¦æƒ…]         â”‚â”‚
â”‚  â”‚ 2. å¸Œæœ›æ”¯æŒå¾®ä¿¡è´¦å•å¯¼å…¥          (18æ¬¡)    [å·²åŠ å…¥è®¡åˆ’]       â”‚â”‚
â”‚  â”‚ 3. ç»Ÿè®¡å›¾è¡¨æ˜¾ç¤ºå¼‚å¸¸             (15æ¬¡)    [å·²ä¿®å¤]           â”‚â”‚
â”‚  â”‚ 4. è¯­éŸ³è®°è´¦è¯†åˆ«æ…¢               (12æ¬¡)    [ä¼˜åŒ–ä¸­]           â”‚â”‚
â”‚  â”‚ 5. å¸Œæœ›å¢åŠ æ¡Œé¢å°ç»„ä»¶            (10æ¬¡)    [è¯„ä¼°ä¸­]           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.9 æ»¡æ„åº¦è¯„ä»·

#### ç”¨æˆ·è¯„ä»·æ”¶é›†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â­ è¯·å¯¹æœ¬æ¬¡æœåŠ¡è¿›è¡Œè¯„ä»·                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æ‚¨çš„é—®é¢˜: å›¾ç‰‡è¯†åˆ«é‡‘é¢è§£æé”™è¯¯                                   â”‚
â”‚  å¤„ç†ç»“æœ: å·²åœ¨1.2.4ç‰ˆæœ¬ä¿®å¤                                     â”‚
â”‚                                                                  â”‚
â”‚  è¯·é—®æ‚¨å¯¹æœ¬æ¬¡å¤„ç†æ»¡æ„å—ï¼Ÿ                                         â”‚
â”‚                                                                  â”‚
â”‚         ğŸ˜Š          ğŸ˜          ğŸ˜                              â”‚
â”‚        æ»¡æ„        ä¸€èˆ¬        ä¸æ»¡æ„                             â”‚
â”‚                                                                  â”‚
â”‚  æ‚¨çš„è¯„ä»·å¯¹æˆ‘ä»¬å¾ˆé‡è¦ï¼ï¼ˆé€‰å¡«ï¼‰                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ è¯·è¾“å…¥æ‚¨çš„æ„è§æˆ–å»ºè®®...                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚                           [æäº¤è¯„ä»·]                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.10 æ•°æ®è¡¨è®¾è®¡

```sql
-- åé¦ˆå·¥å•è¡¨
CREATE TABLE feedback_tickets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_no VARCHAR(20) UNIQUE NOT NULL,  -- å·¥å•ç¼–å·ï¼Œå¦‚ #1024
    user_id UUID REFERENCES users(id),

    -- åé¦ˆå†…å®¹
    feedback_type INT NOT NULL,  -- 1:Bug 2:å»ºè®® 3:å’¨è¯¢ 4:ä½“éªŒ 5:æŠ•è¯‰ 6:æ•°æ® 7:å…¶ä»–
    title VARCHAR(200),
    content TEXT NOT NULL,
    images VARCHAR(500)[],  -- æˆªå›¾URLæ•°ç»„

    -- è®¾å¤‡ä¿¡æ¯
    device_info JSONB,  -- {model, os, app_version, network, ...}
    operation_log TEXT,  -- æ“ä½œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰

    -- è”ç³»æ–¹å¼
    contact_type VARCHAR(20),  -- email, phone
    contact_value VARCHAR(100),

    -- çŠ¶æ€ç®¡ç†
    status INT DEFAULT 0,  -- 0:å¾…å¤„ç† 1:å¤„ç†ä¸­ 2:å·²å›å¤ 3:å·²è§£å†³ 4:å·²é‡‡çº³ 5:æš‚ä¸å¤„ç† 6:å·²å…³é—­
    priority INT DEFAULT 0,  -- 0:æ™®é€š 1:é‡è¦ 2:ç´§æ€¥

    -- åˆ†é…ä¿¡æ¯
    assigned_to UUID REFERENCES admin_users(id),
    assigned_at TIMESTAMP,

    -- æ ‡ç­¾å’Œå…³è”
    tags VARCHAR(50)[],
    related_ticket_ids UUID[],

    -- AIåˆ†æ
    ai_category INT,  -- AIè¯†åˆ«çš„ç±»å‹
    ai_sentiment DECIMAL(3,2),  -- æƒ…æ„Ÿåˆ†æ•° -1åˆ°1
    ai_suggested_reply TEXT,

    -- æ—¶é—´ä¿¡æ¯
    first_response_at TIMESTAMP,  -- é¦–æ¬¡å“åº”æ—¶é—´
    resolved_at TIMESTAMP,
    closed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- å·¥å•å›å¤è¡¨
CREATE TABLE feedback_replies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_id UUID REFERENCES feedback_tickets(id),

    -- å›å¤è€…ä¿¡æ¯
    reply_by_user BOOLEAN DEFAULT FALSE,  -- true:ç”¨æˆ·å›å¤ false:å®¢æœå›å¤
    user_id UUID REFERENCES users(id),
    admin_id UUID REFERENCES admin_users(id),

    -- å›å¤å†…å®¹
    content TEXT NOT NULL,
    images VARCHAR(500)[],

    -- å†…éƒ¨å¤‡æ³¨
    is_internal BOOLEAN DEFAULT FALSE,  -- å†…éƒ¨å¤‡æ³¨ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰

    created_at TIMESTAMP DEFAULT NOW()
);

-- å·¥å•çŠ¶æ€å˜æ›´è®°å½•
CREATE TABLE feedback_status_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_id UUID REFERENCES feedback_tickets(id),
    from_status INT,
    to_status INT,
    changed_by UUID REFERENCES admin_users(id),
    reason TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å¿«æ·å›å¤æ¨¡æ¿è¡¨
CREATE TABLE feedback_reply_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category INT NOT NULL,  -- é€‚ç”¨çš„åé¦ˆç±»å‹
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    usage_count INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_by UUID REFERENCES admin_users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- FAQè‡ªåŠ¨å›å¤é…ç½®è¡¨
CREATE TABLE feedback_faq_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    keywords VARCHAR(100)[] NOT NULL,  -- è§¦å‘å…³é”®è¯
    match_mode INT DEFAULT 0,  -- 0:ä»»æ„åŒ¹é… 1:å…¨éƒ¨åŒ¹é…
    reply_content TEXT NOT NULL,
    auto_close BOOLEAN DEFAULT FALSE,
    close_delay_hours INT DEFAULT 24,
    hit_count INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ»¡æ„åº¦è¯„ä»·è¡¨
CREATE TABLE feedback_ratings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_id UUID REFERENCES feedback_tickets(id) UNIQUE,
    user_id UUID REFERENCES users(id),
    rating INT NOT NULL,  -- 1:ä¸æ»¡æ„ 2:ä¸€èˆ¬ 3:æ»¡æ„
    comment TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åé¦ˆç»Ÿè®¡å¿«ç…§ï¼ˆæ¯æ—¥ï¼‰
CREATE TABLE feedback_stats_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stat_date DATE NOT NULL UNIQUE,
    total_tickets INT DEFAULT 0,
    new_tickets INT DEFAULT 0,
    resolved_tickets INT DEFAULT 0,
    avg_response_minutes INT,
    avg_resolve_minutes INT,
    satisfaction_score DECIMAL(3,2),
    type_distribution JSONB,  -- ç±»å‹åˆ†å¸ƒ
    status_distribution JSONB,  -- çŠ¶æ€åˆ†å¸ƒ
    created_at TIMESTAMP DEFAULT NOW()
);

-- çƒ­é—¨é—®é¢˜èšåˆè¡¨
CREATE TABLE feedback_hot_topics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic_name VARCHAR(200) NOT NULL,
    keywords VARCHAR(100)[],
    ticket_count INT DEFAULT 0,
    status INT DEFAULT 0,  -- 0:æœªå¤„ç† 1:å·²å“åº” 2:å·²è§£å†³ 3:å·²åŠ å…¥è®¡åˆ’
    response_note TEXT,
    first_reported_at TIMESTAMP,
    last_reported_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_feedback_tickets_user ON feedback_tickets(user_id);
CREATE INDEX idx_feedback_tickets_status ON feedback_tickets(status, created_at DESC);
CREATE INDEX idx_feedback_tickets_assigned ON feedback_tickets(assigned_to, status);
CREATE INDEX idx_feedback_tickets_type ON feedback_tickets(feedback_type, created_at DESC);
CREATE INDEX idx_feedback_replies_ticket ON feedback_replies(ticket_id, created_at);
```

### 21.11 APIè®¾è®¡

```
#### ç”¨æˆ·ç«¯API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/feedback | æäº¤åé¦ˆ |
| GET | /api/v1/feedback | è·å–æˆ‘çš„åé¦ˆåˆ—è¡¨ |
| GET | /api/v1/feedback/{id} | è·å–åé¦ˆè¯¦æƒ… |
| POST | /api/v1/feedback/{id}/reply | ç”¨æˆ·è¿½åŠ å›å¤ |
| POST | /api/v1/feedback/{id}/close | ç”¨æˆ·å…³é—­å·¥å• |
| POST | /api/v1/feedback/{id}/rate | æäº¤æ»¡æ„åº¦è¯„ä»· |
| GET | /api/v1/feedback/faq | è·å–å¸¸è§é—®é¢˜åˆ—è¡¨ |

#### ç®¡ç†åå°API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/admin/feedback | è·å–å·¥å•åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼‰ |
| GET | /api/v1/admin/feedback/{id} | è·å–å·¥å•è¯¦æƒ… |
| PUT | /api/v1/admin/feedback/{id} | æ›´æ–°å·¥å•çŠ¶æ€/åˆ†é… |
| POST | /api/v1/admin/feedback/{id}/reply | å®¢æœå›å¤ |
| POST | /api/v1/admin/feedback/{id}/internal-note | æ·»åŠ å†…éƒ¨å¤‡æ³¨ |
| POST | /api/v1/admin/feedback/batch-assign | æ‰¹é‡åˆ†é…å·¥å• |
| POST | /api/v1/admin/feedback/batch-reply | æ‰¹é‡å›å¤ |
| GET | /api/v1/admin/feedback/stats | è·å–ç»Ÿè®¡æ•°æ® |
| GET | /api/v1/admin/feedback/hot-topics | è·å–çƒ­é—¨é—®é¢˜ |
| GET | /api/v1/admin/feedback/templates | è·å–å›å¤æ¨¡æ¿ |
| POST | /api/v1/admin/feedback/templates | åˆ›å»ºå›å¤æ¨¡æ¿ |
| PUT | /api/v1/admin/feedback/templates/{id} | æ›´æ–°å›å¤æ¨¡æ¿ |
| GET | /api/v1/admin/feedback/faq-rules | è·å–FAQè§„åˆ™ |
| POST | /api/v1/admin/feedback/faq-rules | åˆ›å»ºFAQè§„åˆ™ |
| PUT | /api/v1/admin/feedback/faq-rules/{id} | æ›´æ–°FAQè§„åˆ™ |
```

### 21.12 é€šçŸ¥æ¶ˆæ¯æ¨¡æ¿

```yaml
# ç”¨æˆ·é€šçŸ¥æ¨¡æ¿
user_notifications:
  # æ”¶åˆ°å›å¤
  feedback_replied:
    push_title: "æ‚¨çš„åé¦ˆæœ‰æ–°å›å¤"
    push_body: "å®¢æœå·²å›å¤æ‚¨çš„é—®é¢˜ã€Œ{{title}}ã€ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"
    email_subject: "ã€æ™ºèƒ½è®°è´¦ã€‘æ‚¨çš„åé¦ˆå·²æ”¶åˆ°å›å¤"
    email_body: |
      å°Šæ•¬çš„ç”¨æˆ·ï¼Œæ‚¨å¥½ï¼

      æ‚¨äº {{created_at}} æäº¤çš„åé¦ˆã€Œ{{title}}ã€å·²æ”¶åˆ°æˆ‘ä»¬çš„å›å¤ï¼š

      ---
      {{reply_content}}
      ---

      å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚

      æ™ºèƒ½è®°è´¦å›¢é˜Ÿ

  # é—®é¢˜å·²è§£å†³
  feedback_resolved:
    push_title: "æ‚¨çš„é—®é¢˜å·²è§£å†³"
    push_body: "ã€Œ{{title}}ã€å·²å¤„ç†å®Œæˆï¼ŒæœŸå¾…æ‚¨çš„è¯„ä»·"

  # å»ºè®®å·²é‡‡çº³
  feedback_accepted:
    push_title: "æ‚¨çš„å»ºè®®å·²è¢«é‡‡çº³"
    push_body: "æ„Ÿè°¢æ‚¨çš„å®è´µå»ºè®®ï¼Œæˆ‘ä»¬å·²å°†å…¶åŠ å…¥å¼€å‘è®¡åˆ’ï¼"

# å®¢æœé€šçŸ¥æ¨¡æ¿
admin_notifications:
  # æ–°å·¥å•
  new_ticket:
    title: "æ–°åé¦ˆå·¥å•"
    body: "[{{type}}] {{title}} - æ¥è‡ª {{user}}"

  # è¶…æ—¶é¢„è­¦
  timeout_warning:
    title: "å·¥å•è¶…æ—¶é¢„è­¦"
    body: "å·¥å• #{{ticket_no}} å·²ç­‰å¾… {{hours}} å°æ—¶æœªå¤„ç†"

  # ç”¨æˆ·å‚¬ä¿ƒ
  user_urge:
    title: "ç”¨æˆ·å‚¬ä¿ƒå¤„ç†"
    body: "ç”¨æˆ·åœ¨å·¥å• #{{ticket_no}} ä¸­è¿½é—®ï¼Œè¯·åŠæ—¶å¤„ç†"

  # è´Ÿé¢æƒ…ç»ªé¢„è­¦
  negative_sentiment:
    title: "âš ï¸ è´Ÿé¢æƒ…ç»ªé¢„è­¦"
    body: "å·¥å• #{{ticket_no}} æ£€æµ‹åˆ°ç”¨æˆ·å¼ºçƒˆä¸æ»¡ï¼Œè¯·ä¼˜å…ˆå¤„ç†"
```

---

## äºŒåäºŒã€æ¨¡å—è§£è€¦æ¶æ„è®¾è®¡

ç¡®ä¿å„åŠŸèƒ½æ¨¡å—å……åˆ†è§£è€¦ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### 22.1 åç«¯æ¨¡å—åŒ–æ¶æ„

#### åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Layer (è·¯ç”±å±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ /auth/*  â”‚ â”‚/books/*  â”‚ â”‚/trans/*  â”‚ â”‚ /stats/* â”‚  ...      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Layer (æœåŠ¡å±‚)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å„æœåŠ¡é€šè¿‡æ¥å£(Interface)é€šä¿¡ï¼Œä¸ç›´æ¥ä¾èµ–å…·ä½“å®ç°           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚AuthSvc   â”‚ â”‚BookSvc   â”‚ â”‚TransSvc  â”‚ â”‚StatsSvc  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚BudgetSvc â”‚ â”‚GoalSvc   â”‚ â”‚DebtSvc   â”‚ â”‚SubsSvc   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚AISvc     â”‚ â”‚NotifySvc â”‚ â”‚FeedbackSvcâ”‚ â”‚PaymentSvcâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Repository Layer (æ•°æ®è®¿é—®å±‚)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚UserRepo  â”‚ â”‚BookRepo  â”‚ â”‚TransRepo â”‚ â”‚StatsRepo â”‚  ...      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚PostgreSQLâ”‚ â”‚  Redis   â”‚ â”‚   OSS    â”‚ â”‚ External â”‚           â”‚
â”‚  â”‚          â”‚ â”‚          â”‚ â”‚          â”‚ â”‚   APIs   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

```
server/
â”œâ”€â”€ modules/                    # åŠŸèƒ½æ¨¡å—ï¼ˆé«˜åº¦è§£è€¦ï¼‰
â”‚   â”œâ”€â”€ auth/                   # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ router.py          # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ service.py         # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ repository.py      # æ•°æ®è®¿é—®
â”‚   â”‚   â”œâ”€â”€ schemas.py         # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ dependencies.py    # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ exceptions.py      # æ¨¡å—å¼‚å¸¸
â”‚   â”‚
â”‚   â”œâ”€â”€ bookkeeping/           # è®°è´¦æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ books/             # è´¦æœ¬å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ transactions/      # è´¦ç›®å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ categories/        # åˆ†ç±»å­æ¨¡å—
â”‚   â”‚   â””â”€â”€ accounts/          # è´¦æˆ·å­æ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ statistics/            # ç»Ÿè®¡æ¨¡å—
â”‚   â”œâ”€â”€ budget/                # é¢„ç®—æ¨¡å—
â”‚   â”œâ”€â”€ goals/                 # ç›®æ ‡æ¨¡å—
â”‚   â”œâ”€â”€ debts/                 # å€ºåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ subscriptions/         # è®¢é˜…æ¨¡å—
â”‚   â”œâ”€â”€ ai/                    # AIæœåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ notifications/         # é€šçŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ payments/              # æ”¯ä»˜æ¨¡å—
â”‚   â”œâ”€â”€ feedback/              # åé¦ˆæ¨¡å—
â”‚   â”œâ”€â”€ admin/                 # ç®¡ç†åå°æ¨¡å—
â”‚   â””â”€â”€ family/                # å®¶åº­å…±äº«æ¨¡å—
â”‚
â”œâ”€â”€ core/                      # æ ¸å¿ƒå…±äº«ç»„ä»¶
â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py            # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ security.py            # å®‰å…¨å·¥å…·
â”‚   â”œâ”€â”€ cache.py               # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ events.py              # äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ exceptions.py          # å…¨å±€å¼‚å¸¸
â”‚
â”œâ”€â”€ shared/                    # å…±äº«å·¥å…·
â”‚   â”œâ”€â”€ utils/                 # é€šç”¨å·¥å…·
â”‚   â”œâ”€â”€ validators/            # é€šç”¨éªŒè¯å™¨
â”‚   â””â”€â”€ constants/             # å¸¸é‡å®šä¹‰
â”‚
â””â”€â”€ main.py                    # åº”ç”¨å…¥å£
```

#### æ¨¡å—é—´é€šä¿¡è§„èŒƒ

```python
# âœ… æ­£ç¡®ï¼šé€šè¿‡äº‹ä»¶æ€»çº¿è§£è€¦
# modules/bookkeeping/transactions/service.py
class TransactionService:
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus

    async def create_transaction(self, data: TransactionCreate) -> Transaction:
        transaction = await self.repo.create(data)

        # å‘å¸ƒäº‹ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨å…¶ä»–æ¨¡å—
        await self.event_bus.publish(TransactionCreatedEvent(
            transaction_id=transaction.id,
            user_id=transaction.user_id,
            amount=transaction.amount,
            category_id=transaction.category_id
        ))

        return transaction

# modules/budget/service.py (è®¢é˜…äº‹ä»¶)
class BudgetService:
    @subscribe(TransactionCreatedEvent)
    async def on_transaction_created(self, event: TransactionCreatedEvent):
        # æ›´æ–°é¢„ç®—ä½¿ç”¨æƒ…å†µ
        await self.update_budget_usage(event.category_id, event.amount)

# modules/statistics/service.py (è®¢é˜…äº‹ä»¶)
class StatisticsService:
    @subscribe(TransactionCreatedEvent)
    async def on_transaction_created(self, event: TransactionCreatedEvent):
        # æ›´æ–°ç»Ÿè®¡ç¼“å­˜
        await self.invalidate_stats_cache(event.user_id)
```

```python
# âŒ é”™è¯¯ï¼šæ¨¡å—é—´ç›´æ¥ä¾èµ–
class TransactionService:
    def __init__(self, budget_service: BudgetService, stats_service: StatisticsService):
        # ç›´æ¥ä¾èµ–å…¶ä»–æ¨¡å—ï¼Œè€¦åˆåº¦é«˜
        self.budget_service = budget_service
        self.stats_service = stats_service
```

#### ä¾èµ–æ³¨å…¥å®¹å™¨

```python
# core/container.py
from dependency_injector import containers, providers

class Container(containers.DeclarativeContainer):
    """ä¾èµ–æ³¨å…¥å®¹å™¨"""

    config = providers.Configuration()

    # åŸºç¡€è®¾æ–½
    db = providers.Singleton(Database, url=config.database_url)
    redis = providers.Singleton(Redis, url=config.redis_url)
    event_bus = providers.Singleton(EventBus)

    # ä»“åº“å±‚
    user_repo = providers.Factory(UserRepository, db=db)
    transaction_repo = providers.Factory(TransactionRepository, db=db)

    # æœåŠ¡å±‚ï¼ˆé€šè¿‡æ¥å£å¼•ç”¨ï¼‰
    auth_service = providers.Factory(
        AuthService,
        user_repo=user_repo,
        event_bus=event_bus
    )

    transaction_service = providers.Factory(
        TransactionService,
        repo=transaction_repo,
        event_bus=event_bus
    )
```

### 22.2 å‰ç«¯æ¨¡å—åŒ–æ¶æ„

#### Flutteræ¨¡å—ç»“æ„

```
lib/
â”œâ”€â”€ core/                      # æ ¸å¿ƒå±‚ï¼ˆä¸ä¾èµ–ä»»ä½•featureï¼‰
â”‚   â”œâ”€â”€ di/                    # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ injection.dart     # GetIté…ç½®
â”‚   â”œâ”€â”€ network/               # ç½‘ç»œå±‚
â”‚   â”‚   â”œâ”€â”€ api_client.dart
â”‚   â”‚   â””â”€â”€ interceptors/
â”‚   â”œâ”€â”€ storage/               # æœ¬åœ°å­˜å‚¨
â”‚   â”œâ”€â”€ theme/                 # ä¸»é¢˜
â”‚   â””â”€â”€ utils/                 # å·¥å…·ç±»
â”‚
â”œâ”€â”€ shared/                    # å…±äº«ç»„ä»¶
â”‚   â”œâ”€â”€ widgets/               # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ buttons/
â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”œâ”€â”€ inputs/
â”‚   â”‚   â””â”€â”€ dialogs/
â”‚   â””â”€â”€ extensions/            # æ‰©å±•æ–¹æ³•
â”‚
â”œâ”€â”€ features/                  # åŠŸèƒ½æ¨¡å—ï¼ˆå®Œå…¨è§£è€¦ï¼‰
â”‚   â”œâ”€â”€ auth/                  # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ usecases/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”œâ”€â”€ widgets/
â”‚   â”‚       â””â”€â”€ providers/
â”‚   â”‚
â”‚   â”œâ”€â”€ home/                  # é¦–é¡µæ¨¡å—
â”‚   â”œâ”€â”€ bookkeeping/           # è®°è´¦æ¨¡å—
â”‚   â”œâ”€â”€ statistics/            # ç»Ÿè®¡æ¨¡å—
â”‚   â”œâ”€â”€ budget/                # é¢„ç®—æ¨¡å—
â”‚   â”œâ”€â”€ goals/                 # ç›®æ ‡æ¨¡å—
â”‚   â”œâ”€â”€ settings/              # è®¾ç½®æ¨¡å—
â”‚   â””â”€â”€ feedback/              # åé¦ˆæ¨¡å—
â”‚
â””â”€â”€ main.dart                  # åº”ç”¨å…¥å£
```

#### æ¨¡å—é—´é€šä¿¡

```dart
// âœ… æ­£ç¡®ï¼šé€šè¿‡å¯¼èˆªä¼ å‚æˆ–çŠ¶æ€ç®¡ç†é€šä¿¡
// ä¸ç›´æ¥importå…¶ä»–featureçš„å†…éƒ¨å®ç°

// features/home/presentation/pages/home_page.dart
class HomePage extends ConsumerWidget {
  void _onAddTransaction(BuildContext context) {
    // é€šè¿‡è·¯ç”±å¯¼èˆªï¼Œä¼ é€’å¿…è¦å‚æ•°
    context.push('/bookkeeping/add', extra: {'bookId': currentBookId});
  }
}

// features/bookkeeping/presentation/pages/add_transaction_page.dart
class AddTransactionPage extends ConsumerWidget {
  final String bookId;  // æ¥æ”¶å‚æ•°

  // å®Œæˆåé€šè¿‡å›è°ƒæˆ–äº‹ä»¶é€šçŸ¥
  void _onTransactionCreated() {
    ref.read(eventBusProvider).emit(TransactionCreatedEvent());
    context.pop(true);  // è¿”å›ç»“æœ
  }
}
```

---

## äºŒåä¸‰ã€UI/UXè®¾è®¡è§„èŒƒ

éµå¾ªä¼˜è´¨äº’è”ç½‘Appçš„æ˜“ç”¨æ€§è®¾è®¡è§„èŒƒï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½3æ¬¡ç‚¹å‡»å†…å¯è¾¾ã€‚

### 23.1 è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       UI/UX æ ¸å¿ƒè®¾è®¡åŸåˆ™                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1ï¸âƒ£ ä¸‰æ¬¡ç‚¹å‡»åŸåˆ™                                                â”‚
â”‚     â””â”€â”€ æ ¸å¿ƒåŠŸèƒ½æœ€å¤š3æ¬¡ç‚¹å‡»å³å¯ä½¿ç”¨                               â”‚
â”‚                                                                  â”‚
â”‚  2ï¸âƒ£ æ¸è¿›å¼æŠ«éœ²                                                  â”‚
â”‚     â””â”€â”€ åŸºç¡€åŠŸèƒ½æ˜¾çœ¼æ˜“è¾¾ï¼Œé«˜çº§åŠŸèƒ½æŒ‰éœ€å±•å¼€                         â”‚
â”‚                                                                  â”‚
â”‚  3ï¸âƒ£ ä¸€è‡´æ€§                                                      â”‚
â”‚     â””â”€â”€ ç›¸åŒæ“ä½œç›¸åŒä½ç½®ï¼Œå‡å°‘ç”¨æˆ·å­¦ä¹ æˆæœ¬                         â”‚
â”‚                                                                  â”‚
â”‚  4ï¸âƒ£ åé¦ˆå³æ—¶                                                    â”‚
â”‚     â””â”€â”€ æ¯ä¸ªæ“ä½œéƒ½æœ‰å³æ—¶è§†è§‰/è§¦è§‰åé¦ˆ                             â”‚
â”‚                                                                  â”‚
â”‚  5ï¸âƒ£ å®¹é”™è®¾è®¡                                                    â”‚
â”‚     â””â”€â”€ å…è®¸æ’¤é”€ã€æä¾›ç¡®è®¤ã€é˜²æ­¢è¯¯æ“ä½œ                             â”‚
â”‚                                                                  â”‚
â”‚  6ï¸âƒ£ æç®€ä¸»ä¹‰                                                    â”‚
â”‚     â””â”€â”€ ç•Œé¢å¹²å‡€ï¼Œä¿¡æ¯å±‚æ¬¡åˆ†æ˜ï¼Œå‡å°‘è§†è§‰å™ªéŸ³                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.2 åŠŸèƒ½åˆ†å±‚è®¾è®¡

#### åŠŸèƒ½å±‚çº§å®šä¹‰

| å±‚çº§ | å®šä¹‰ | ä½ç½® | ç‚¹å‡»æ¬¡æ•° | ç¤ºä¾‹ |
|------|------|------|----------|------|
| **L0-æ ¸å¿ƒ** | æ¯æ—¥é«˜é¢‘ä½¿ç”¨ | é¦–å±ç›´è¾¾ | 1æ¬¡ | è®°ä¸€ç¬”ã€ä»Šæ—¥æ”¶æ”¯ |
| **L1-å¸¸ç”¨** | æ¯å‘¨ä½¿ç”¨ | åº•éƒ¨Tab/é¦–é¡µå¡ç‰‡ | 1-2æ¬¡ | ç»Ÿè®¡ã€è´¦å•ã€é¢„ç®— |
| **L2-æ ‡å‡†** | æ¯æœˆä½¿ç”¨ | äºŒçº§é¡µé¢ | 2-3æ¬¡ | ç›®æ ‡ã€è®¢é˜…ã€æŠ¥è¡¨ |
| **L3-é«˜çº§** | å¶å°”ä½¿ç”¨ | è®¾ç½®/æ›´å¤šèœå• | 3æ¬¡+ | æ•°æ®å¯¼å‡ºã€é«˜çº§è®¾ç½® |

#### åŠŸèƒ½åˆ†ç±»è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0 æ ¸å¿ƒåŠŸèƒ½ (é¦–å±1æ¬¡ç‚¹å‡»)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å¿«é€Ÿè®°è´¦æŒ‰é’®ï¼ˆæ‚¬æµ®/åº•éƒ¨ä¸­å¤®ï¼‰                                   â”‚
â”‚ â€¢ ä»Šæ—¥/æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ                                              â”‚
â”‚ â€¢ æœ€è¿‘è´¦ç›®åˆ—è¡¨                                                   â”‚
â”‚ â€¢ è´¦æœ¬åˆ‡æ¢                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1 å¸¸ç”¨åŠŸèƒ½ (åº•éƒ¨Tab 1-2æ¬¡ç‚¹å‡»)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç»Ÿè®¡æŠ¥è¡¨ï¼ˆæ”¶æ”¯è¶‹åŠ¿ã€åˆ†ç±»å æ¯”ï¼‰                                  â”‚
â”‚ â€¢ è´¦å•æ—¥å†                                                       â”‚
â”‚ â€¢ é¢„ç®—æ¦‚è§ˆ                                                       â”‚
â”‚ â€¢ ä¸ªäººä¸­å¿ƒ                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2 æ ‡å‡†åŠŸèƒ½ (é¦–é¡µå¡ç‰‡/åˆ—è¡¨å…¥å£ 2-3æ¬¡ç‚¹å‡»)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è´¢åŠ¡ç›®æ ‡ç®¡ç†                                                   â”‚
â”‚ â€¢ è®¢é˜…æœåŠ¡ç®¡ç†                                                   â”‚
â”‚ â€¢ è´¦å•æé†’                                                       â”‚
â”‚ â€¢ å‡€èµ„äº§è¿½è¸ª                                                     â”‚
â”‚ â€¢ å®¶åº­è´¦æœ¬ç®¡ç†                                                   â”‚
â”‚ â€¢ æ™ºèƒ½æ´å¯Ÿ                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3 é«˜çº§åŠŸèƒ½ (è®¾ç½®/æ›´å¤š 3æ¬¡+ç‚¹å‡»)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ é›¶åŸºé¢„ç®—è¯¦ç»†è®¾ç½®                                               â”‚
â”‚ â€¢ å€ºåŠ¡è¿˜æ¬¾è§„åˆ’                                                   â”‚
â”‚ â€¢ æ•°æ®å¯¼å…¥/å¯¼å‡º                                                  â”‚
â”‚ â€¢ é‚®ç®±è´¦å•ç»‘å®š                                                   â”‚
â”‚ â€¢ æ±‡ç‡è®¾ç½®                                                       â”‚
â”‚ â€¢ åˆ†ç±»è‡ªå®šä¹‰                                                     â”‚
â”‚ â€¢ è´¦æˆ·ç®¡ç†                                                       â”‚
â”‚ â€¢ ä¸»é¢˜/è¯­è¨€è®¾ç½®                                                  â”‚
â”‚ â€¢ éšç§ä¸å®‰å…¨                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.3 æ ¸å¿ƒåŠŸèƒ½ç‚¹å‡»è·¯å¾„

#### è®°è´¦åŠŸèƒ½ï¼ˆæœ€æ ¸å¿ƒ - 1æ¬¡ç‚¹å‡»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          é¦–é¡µ                                    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆå¡ç‰‡                         â”‚  â”‚
â”‚  â”‚         æ”¶å…¥: Â¥12,500    æ”¯å‡º: Â¥8,320    ç»“ä½™: Â¥4,180      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å¿«æ·æ“ä½œ                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                         â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“·  â”‚ â”‚ ğŸ¤  â”‚ â”‚ ğŸ“Š  â”‚ â”‚ ğŸ¯  â”‚                         â”‚  â”‚
â”‚  â”‚  â”‚æ‹ç…§ â”‚ â”‚è¯­éŸ³ â”‚ â”‚ç»Ÿè®¡ â”‚ â”‚ç›®æ ‡ â”‚                         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœ€è¿‘è´¦ç›®                                     [æŸ¥çœ‹å…¨éƒ¨ >] â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  ğŸ” åˆé¤         -Â¥35      ä»Šå¤© 12:30                     â”‚  â”‚
â”‚  â”‚  â˜• å’–å•¡         -Â¥28      ä»Šå¤© 09:15                     â”‚  â”‚
â”‚  â”‚  ğŸš‡ åœ°é“         -Â¥6       ä»Šå¤© 08:30                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ   â”‚   â”‚ ğŸ“Š  â”‚   â”‚     â•      â”‚   â”‚ ğŸ“…  â”‚   â”‚ ğŸ‘¤  â”‚      â”‚
â”‚  â”‚ é¦–é¡µ â”‚   â”‚ ç»Ÿè®¡ â”‚   â”‚    è®°è´¦     â”‚   â”‚ è´¦å• â”‚   â”‚ æˆ‘çš„ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                            â–²                                    â”‚
â”‚                       æ ¸å¿ƒæŒ‰é’®æ”¾å¤§                               â”‚
â”‚                       1æ¬¡ç‚¹å‡»è®°è´¦                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‚¹å‡»è·¯å¾„ç¤ºæ„

```
æ ¸å¿ƒåŠŸèƒ½ç‚¹å‡»è·¯å¾„ï¼ˆâ‰¤3æ¬¡ï¼‰:

ğŸ“ æ‰‹åŠ¨è®°è´¦
   é¦–é¡µ â†’ [è®°è´¦æŒ‰é’®] â†’ è¾“å…¥é‡‘é¢ â†’ å®Œæˆ
   ç‚¹å‡»æ¬¡æ•°: 1æ¬¡ âœ…

ğŸ“· æ‹ç…§è®°è´¦
   é¦–é¡µ â†’ [æ‹ç…§å¿«æ·å…¥å£] â†’ æ‹ç…§ â†’ ç¡®è®¤ â†’ å®Œæˆ
   ç‚¹å‡»æ¬¡æ•°: 1æ¬¡ âœ…

ğŸ¤ è¯­éŸ³è®°è´¦
   é¦–é¡µ â†’ [è¯­éŸ³å¿«æ·å…¥å£] â†’ è¯´è¯ â†’ ç¡®è®¤ â†’ å®Œæˆ
   ç‚¹å‡»æ¬¡æ•°: 1æ¬¡ âœ…

ğŸ“Š æŸ¥çœ‹æœ¬æœˆç»Ÿè®¡
   é¦–é¡µ â†’ [ç»Ÿè®¡Tab] â†’ æŸ¥çœ‹
   ç‚¹å‡»æ¬¡æ•°: 1æ¬¡ âœ…

ğŸ“… æŸ¥çœ‹è´¦å•æ—¥å†
   é¦–é¡µ â†’ [è´¦å•Tab] â†’ æŸ¥çœ‹
   ç‚¹å‡»æ¬¡æ•°: 1æ¬¡ âœ…

ğŸ’° è®¾ç½®é¢„ç®—
   é¦–é¡µ â†’ [é¢„ç®—å¡ç‰‡] â†’ è®¾ç½®
   ç‚¹å‡»æ¬¡æ•°: 2æ¬¡ âœ…

ğŸ¯ æŸ¥çœ‹ç›®æ ‡è¿›åº¦
   é¦–é¡µ â†’ [ç›®æ ‡å¡ç‰‡] â†’ æŸ¥çœ‹è¯¦æƒ…
   ç‚¹å‡»æ¬¡æ•°: 2æ¬¡ âœ…

âš™ï¸ ä¿®æ”¹è®¾ç½®
   é¦–é¡µ â†’ [æˆ‘çš„Tab] â†’ [è®¾ç½®]
   ç‚¹å‡»æ¬¡æ•°: 2æ¬¡ âœ…

ğŸ“¤ å¯¼å‡ºæ•°æ®
   é¦–é¡µ â†’ [æˆ‘çš„Tab] â†’ [æ•°æ®ç®¡ç†] â†’ [å¯¼å‡º]
   ç‚¹å‡»æ¬¡æ•°: 3æ¬¡ âœ…
```

### 23.4 ç•Œé¢ç®€æ´è®¾è®¡

#### é¦–é¡µè®¾è®¡ - ä¿¡æ¯å¯†åº¦æ§åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9:41                    æ™ºèƒ½è®°è´¦                      â˜°  ğŸ””   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æˆ‘çš„è´¦æœ¬ â–¼                              2024å¹´1æœˆ        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚            Â¥ 4,180.00                                     â”‚  â”‚
â”‚  â”‚              æœ¬æœˆç»“ä½™                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   æ”¶å…¥ Â¥12,500         æ”¯å‡º Â¥8,320                        â”‚  â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ğŸ“· æ‹ç…§è®°è´¦  â”‚ â”‚ ğŸ¤ è¯­éŸ³è®°è´¦  â”‚ â”‚ âœï¸ æ‰‹åŠ¨è®°è´¦  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’¡ æ™ºèƒ½æé†’                                        [æ›´å¤š]  â”‚  â”‚
â”‚  â”‚ ä¿¡ç”¨å¡è¿˜æ¬¾æ—¥è¿˜æœ‰3å¤©ï¼Œå¾…è¿˜ Â¥3,580                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  ä»Šæ—¥è´¦ç›®                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  ğŸ” åˆé¤ Â· é¤é¥®          -Â¥35.00            12:30              â”‚
â”‚  â˜• ç‘å¹¸å’–å•¡ Â· é¥®å“       -Â¥18.00            09:15              â”‚
â”‚  ğŸš‡ åœ°é“ Â· äº¤é€š          -Â¥6.00             08:30              â”‚
â”‚                                                                  â”‚
â”‚  æ˜¨æ—¥è´¦ç›®                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  ğŸ›’ è¶…å¸‚è´­ç‰© Â· ç”Ÿæ´»       -Â¥156.00           19:20              â”‚
â”‚  ğŸ’¼ å·¥èµ„ Â· è–ªèµ„          +Â¥12,500.00        10:00              â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ   â”‚   â”‚ ğŸ“Š  â”‚   â”‚    â•     â”‚   â”‚ ğŸ“…  â”‚   â”‚ ğŸ‘¤  â”‚        â”‚
â”‚  â”‚ é¦–é¡µ â”‚   â”‚ ç»Ÿè®¡ â”‚   â”‚   è®°è´¦    â”‚   â”‚ è´¦å• â”‚   â”‚ æˆ‘çš„ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è¦ç‚¹:
âœ… æ ¸å¿ƒæ•°æ®ä¸€ç›®äº†ç„¶ï¼ˆæ”¶æ”¯ç»“ä½™ï¼‰
âœ… é«˜é¢‘æ“ä½œä¸€è§¦å³è¾¾ï¼ˆæ‹ç…§/è¯­éŸ³/æ‰‹åŠ¨ï¼‰
âœ… æ™ºèƒ½æé†’ä¸æ‰“æ‰°ï¼ˆå•æ¡é«˜äº®ï¼‰
âœ… è´¦ç›®åˆ—è¡¨ç®€æ´ï¼ˆæŒ‰æ—¥åˆ†ç»„ï¼‰
âœ… åº•éƒ¨å¯¼èˆªå›ºå®šï¼ˆæ ¸å¿ƒTabï¼‰
âœ… è®°è´¦æŒ‰é’®çªå‡ºï¼ˆå±…ä¸­æ”¾å¤§ï¼‰
```

#### è®°è´¦é¡µé¢ - æç®€è¾“å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ•                      æ”¯å‡º                              âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                         Â¥ 35.00                                  â”‚
â”‚                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ğŸ” é¤é¥®  â”‚  ğŸ›’ è´­ç‰©  â”‚  ğŸš‡ äº¤é€š  â”‚  â˜• é¥®å“  â”‚  ğŸ® å¨±ä¹    â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  ğŸ’„ ç¾å®¹  â”‚  ğŸ“± æ•°ç   â”‚  ğŸ¥ åŒ»ç–—  â”‚  ğŸ“š å­¦ä¹   â”‚  â‹¯ æ›´å¤š    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“… ä»Šå¤©                                                    >   â”‚
â”‚  ğŸ’³ æ”¯ä»˜å®                                                  >   â”‚
â”‚  ğŸ“ æ·»åŠ å¤‡æ³¨                                                >   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  7  â”‚  8  â”‚  9  â”‚  âŒ«  â”‚                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  4  â”‚  5  â”‚  6  â”‚  +  â”‚                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  1  â”‚  2  â”‚  3  â”‚  -  â”‚                                     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  .  â”‚  0  â”‚  å®Œæˆ     â”‚                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚   æ”¯å‡º       æ”¶å…¥       è½¬è´¦                                     â”‚
â”‚   â”€â”€â”€â”€                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è¦ç‚¹:
âœ… é‡‘é¢è¾“å…¥æœ€æ˜¾çœ¼
âœ… å¸¸ç”¨åˆ†ç±»ä¸€å±å±•ç¤º
âœ… é»˜è®¤å€¼æ™ºèƒ½å¡«å……ï¼ˆä»Šå¤©ã€é»˜è®¤è´¦æˆ·ï¼‰
âœ… å¯é€‰é¡¹æ”¶èµ·ï¼ˆç‚¹å‡»å±•å¼€ï¼‰
âœ… æ•°å­—é”®ç›˜ä¼˜åŒ–ï¼ˆå¤§æŒ‰é’®ï¼‰
âœ… ä¸€é”®å®Œæˆä¿å­˜
```

### 23.5 å¯¼èˆªè®¾è®¡

#### åº•éƒ¨å¯¼èˆªç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº•éƒ¨å¯¼èˆªè®¾è®¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚   ğŸ     â”‚   ğŸ“Š    â”‚     â•      â”‚   ğŸ“…    â”‚   ğŸ‘¤    â”‚       â”‚
â”‚   â”‚  é¦–é¡µ   â”‚  ç»Ÿè®¡   â”‚    è®°è´¦     â”‚   è´¦å•   â”‚   æˆ‘çš„   â”‚       â”‚
â”‚   â”‚         â”‚         â”‚   (çªå‡º)    â”‚         â”‚         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â”‚   è¯´æ˜:                                                          â”‚
â”‚   â€¢ é¦–é¡µ: æ¦‚è§ˆã€å¿«æ·å…¥å£ã€æœ€è¿‘è´¦ç›®                                â”‚
â”‚   â€¢ ç»Ÿè®¡: æ”¶æ”¯æŠ¥è¡¨ã€è¶‹åŠ¿åˆ†æã€åˆ†ç±»å æ¯”                            â”‚
â”‚   â€¢ è®°è´¦: æ ¸å¿ƒåŠŸèƒ½ï¼Œå±…ä¸­çªå‡ºæ˜¾ç¤º                                  â”‚
â”‚   â€¢ è´¦å•: è´¦å•æ—¥å†ã€è´¦å•åˆ—è¡¨                                     â”‚
â”‚   â€¢ æˆ‘çš„: ä¸ªäººä¸­å¿ƒã€è®¾ç½®ã€é«˜çº§åŠŸèƒ½å…¥å£                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### "æˆ‘çš„"é¡µé¢ - åŠŸèƒ½åˆ†å±‚å…¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9:41                      æˆ‘çš„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ‘¤ ç”¨æˆ·æ˜µç§°                                              â”‚  â”‚
â”‚  â”‚  â­ VIPä¼šå‘˜ Â· 2024.12.31åˆ°æœŸ                    [ç»­è´¹ >]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’° å‡€èµ„äº§    ğŸ¯ ç›®æ ‡    ğŸ“± è®¢é˜…    ğŸ’³ å€ºåŠ¡               â”‚  â”‚
â”‚  â”‚  Â¥285,680    3ä¸ªè¿›è¡Œä¸­  Â¥268/æœˆ   Â¥21,500               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  å¸¸ç”¨åŠŸèƒ½                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“’ è´¦æœ¬ç®¡ç†                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ’³ è´¦æˆ·ç®¡ç†                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ“‚ åˆ†ç±»ç®¡ç†                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­å…±äº«                                            >  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  æ•°æ®ä¸å¤‡ä»½                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¤ å¯¼å…¥/å¯¼å‡º                                           >  â”‚  â”‚
â”‚  â”‚ â˜ï¸ æ•°æ®å¤‡ä»½                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ“§ é‚®ç®±è´¦å•                                            >  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  è®¾ç½®                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âš™ï¸ é€šç”¨è®¾ç½®                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ”” é€šçŸ¥è®¾ç½®                                            >  â”‚  â”‚
â”‚  â”‚ ğŸ” éšç§ä¸å®‰å…¨                                          >  â”‚  â”‚
â”‚  â”‚ â“ å¸®åŠ©ä¸åé¦ˆ                                          >  â”‚  â”‚
â”‚  â”‚ â„¹ï¸ å…³äº                                               >  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ğŸ        ğŸ“Š       â•        ğŸ“…        ğŸ‘¤                      â”‚
â”‚  é¦–é¡µ     ç»Ÿè®¡     è®°è´¦       è´¦å•      æˆ‘çš„                      â”‚
â”‚                                                â”€â”€â”€â”€              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.6 æ‰‹åŠ¿ä¸å¿«æ·æ“ä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ‰‹åŠ¿å¿«æ·æ“ä½œ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“± é¦–é¡µ                                                         â”‚
â”‚  â”œâ”€â”€ ä¸‹æ‹‰åˆ·æ–°: åˆ·æ–°è´¦ç›®å’Œç»Ÿè®¡æ•°æ®                                 â”‚
â”‚  â”œâ”€â”€ å·¦æ»‘è´¦ç›®: æ˜¾ç¤ºåˆ é™¤æŒ‰é’®                                      â”‚
â”‚  â””â”€â”€ ç‚¹å‡»è´¦ç›®: æŸ¥çœ‹/ç¼–è¾‘è¯¦æƒ…                                     â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š ç»Ÿè®¡é¡µ                                                       â”‚
â”‚  â”œâ”€â”€ å·¦å³æ»‘åŠ¨: åˆ‡æ¢æœˆä»½                                          â”‚
â”‚  â””â”€â”€ åŒæŒ‡ç¼©æ”¾: å›¾è¡¨ç¼©æ”¾                                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“… è´¦å•é¡µ                                                       â”‚
â”‚  â”œâ”€â”€ å·¦å³æ»‘åŠ¨: åˆ‡æ¢æœˆä»½                                          â”‚
â”‚  â””â”€â”€ ç‚¹å‡»æ—¥æœŸ: æŸ¥çœ‹å½“æ—¥è´¦ç›®                                      â”‚
â”‚                                                                  â”‚
â”‚  â• è®°è´¦é¡µ                                                       â”‚
â”‚  â”œâ”€â”€ ä¸‹æ‹‰å…³é—­: å–æ¶ˆè®°è´¦                                          â”‚
â”‚  â”œâ”€â”€ é•¿æŒ‰åˆ†ç±»: å¿«é€Ÿåˆ‡æ¢åˆ°å­åˆ†ç±»                                   â”‚
â”‚  â””â”€â”€ å·¦å³æ»‘åŠ¨: åˆ‡æ¢ æ”¯å‡º/æ”¶å…¥/è½¬è´¦                                â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”„ å…¨å±€                                                         â”‚
â”‚  â”œâ”€â”€ æ‘‡ä¸€æ‘‡: å¿«é€Ÿåé¦ˆï¼ˆå¯å…³é—­ï¼‰                                   â”‚
â”‚  â””â”€â”€ åŒå‡»Tab: æ»šåŠ¨åˆ°é¡¶éƒ¨                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.7 å“åº”å¼ä¸é€‚é…

```dart
// å“åº”å¼å¸ƒå±€ç­–ç•¥
class ResponsiveLayout {
  static const double mobileMaxWidth = 600;
  static const double tabletMaxWidth = 900;

  static bool isMobile(BuildContext context) =>
    MediaQuery.of(context).size.width < mobileMaxWidth;

  static bool isTablet(BuildContext context) =>
    MediaQuery.of(context).size.width >= mobileMaxWidth &&
    MediaQuery.of(context).size.width < tabletMaxWidth;

  // é¦–é¡µç½‘æ ¼åˆ—æ•°
  static int getGridColumns(BuildContext context) {
    if (isMobile(context)) return 2;
    if (isTablet(context)) return 3;
    return 4;
  }

  // åº•éƒ¨å¯¼èˆª vs ä¾§è¾¹æ 
  static bool useBottomNav(BuildContext context) => isMobile(context);
}
```

### 23.8 åŠ è½½ä¸ç©ºçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        çŠ¶æ€é¡µé¢è®¾è®¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â³ åŠ è½½çŠ¶æ€                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                      â³                                   â”‚  â”‚
â”‚  â”‚                   åŠ è½½ä¸­...                               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  (ä½¿ç”¨éª¨æ¶å±è€Œéçº¯loadingï¼Œä¿æŒå¸ƒå±€ç¨³å®š)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“­ ç©ºçŠ¶æ€                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                      ğŸ“                                   â”‚  â”‚
â”‚  â”‚                  è¿˜æ²¡æœ‰è´¦ç›®                                â”‚  â”‚
â”‚  â”‚              è®°å½•ç¬¬ä¸€ç¬”æ”¶æ”¯å¼€å§‹ç†è´¢å§                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                 [ç«‹å³è®°è´¦]                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  âŒ é”™è¯¯çŠ¶æ€                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                      ğŸ˜µ                                   â”‚  â”‚
â”‚  â”‚                  åŠ è½½å¤±è´¥                                  â”‚  â”‚
â”‚  â”‚              è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                 [é‡æ–°åŠ è½½]                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.9 åŠ¨æ•ˆä¸åé¦ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŠ¨æ•ˆè®¾è®¡è§„èŒƒ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âš¡ å³æ—¶åé¦ˆ (< 100ms)                                           â”‚
â”‚  â”œâ”€â”€ æŒ‰é’®ç‚¹å‡»é«˜äº®                                                â”‚
â”‚  â”œâ”€â”€ åˆ—è¡¨é¡¹ç‚¹å‡»æ³¢çº¹                                              â”‚
â”‚  â””â”€â”€ å¼€å…³åˆ‡æ¢                                                    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”„ è¿‡æ¸¡åŠ¨ç”» (200-300ms)                                         â”‚
â”‚  â”œâ”€â”€ é¡µé¢åˆ‡æ¢ï¼ˆå³è¿›å·¦å‡ºï¼‰                                         â”‚
â”‚  â”œâ”€â”€ å¼¹çª—å‡ºç°ï¼ˆåº•éƒ¨æ»‘å…¥ï¼‰                                         â”‚
â”‚  â”œâ”€â”€ åˆ—è¡¨åŠ è½½ï¼ˆæ¸å…¥ï¼‰                                             â”‚
â”‚  â””â”€â”€ å¡ç‰‡å±•å¼€/æ”¶èµ·                                               â”‚
â”‚                                                                  â”‚
â”‚  ğŸ‰ æˆåŠŸåé¦ˆ                                                     â”‚
â”‚  â”œâ”€â”€ è®°è´¦æˆåŠŸ: è½»éœ‡åŠ¨ + âœ“åŠ¨ç”» + æ•°å­—è·³åŠ¨                          â”‚
â”‚  â”œâ”€â”€ ç›®æ ‡è¾¾æˆ: å½©å¸¦åŠ¨ç”» + éœ‡åŠ¨                                    â”‚
â”‚  â””â”€â”€ åˆ é™¤æˆåŠŸ: é¡¹ç›®æ»‘å‡ºåŠ¨ç”»                                       â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ é”™è¯¯åé¦ˆ                                                     â”‚
â”‚  â”œâ”€â”€ è¡¨å•é”™è¯¯: æŠ–åŠ¨ + çº¢è‰²é«˜äº®                                    â”‚
â”‚  â”œâ”€â”€ ç½‘ç»œé”™è¯¯: Toastæç¤º                                         â”‚
â”‚  â””â”€â”€ æ“ä½œå¤±è´¥: å¼¹çª—è¯´æ˜                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.10 å¯è®¿é—®æ€§è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯è®¿é—®æ€§è§„èŒƒ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ‘ï¸ è§†è§‰å¯è®¿é—®æ€§                                                 â”‚
â”‚  â”œâ”€â”€ æœ€å°ç‚¹å‡»åŒºåŸŸ: 44x44pt                                       â”‚
â”‚  â”œâ”€â”€ æ–‡å­—æœ€å°å­—å·: 12sp                                          â”‚
â”‚  â”œâ”€â”€ é¢œè‰²å¯¹æ¯”åº¦: â‰¥ 4.5:1 (æ­£æ–‡) / â‰¥ 3:1 (å¤§å­—)                   â”‚
â”‚  â”œâ”€â”€ ä¸ä»…ä¾èµ–é¢œè‰²ä¼ è¾¾ä¿¡æ¯ï¼ˆé…åˆå›¾æ ‡/æ–‡å­—ï¼‰                         â”‚
â”‚  â””â”€â”€ æ”¯æŒç³»ç»Ÿå­—ä½“ç¼©æ”¾                                            â”‚
â”‚                                                                  â”‚
â”‚  ğŸ‘‚ å±å¹•é˜…è¯»å™¨æ”¯æŒ                                               â”‚
â”‚  â”œâ”€â”€ æ‰€æœ‰å›¾æ ‡æœ‰è¯­ä¹‰æ ‡ç­¾                                          â”‚
â”‚  â”œâ”€â”€ è¡¨å•æœ‰å…³è”æ ‡ç­¾                                              â”‚
â”‚  â”œâ”€â”€ æ“ä½œæœ‰æè¿°                                                  â”‚
â”‚  â””â”€â”€ ç„¦ç‚¹é¡ºåºåˆç†                                                â”‚
â”‚                                                                  â”‚
â”‚  âŒ¨ï¸ æ“ä½œä¾¿åˆ©æ€§                                                   â”‚
â”‚  â”œâ”€â”€ é‡è¦æ“ä½œå¯æ’¤é”€                                              â”‚
â”‚  â”œâ”€â”€ åˆ é™¤éœ€ç¡®è®¤                                                  â”‚
â”‚  â”œâ”€â”€ è¡¨å•è‡ªåŠ¨ä¿å­˜è‰ç¨¿                                            â”‚
â”‚  â””â”€â”€ æ”¯æŒç³»ç»Ÿè¿”å›æ‰‹åŠ¿                                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒåå››ã€ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ç³»ç»Ÿ

å®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡‡é›†ã€åˆ†æå’Œä¼˜åŒ–ä½“ç³»ï¼Œä¸ºäº§å“è¿­ä»£æä¾›æ•°æ®æ”¯æ’‘ã€‚

### 24.1 åŸ‹ç‚¹ä½“ç³»æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŸ‹ç‚¹æ•°æ®æµ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯   â”‚â”€â”€â”€â–¶â”‚  æ•°æ®é‡‡é›† â”‚â”€â”€â”€â–¶â”‚  æ•°æ®å¤„ç† â”‚â”€â”€â”€â–¶â”‚  æ•°æ®åˆ†æ â”‚
â”‚  SDK     â”‚    â”‚  æœåŠ¡    â”‚    â”‚  å¹³å°    â”‚    â”‚  å¹³å°    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â–¼               â–¼               â–¼               â–¼
  ç”¨æˆ·è¡Œä¸º        å®æ—¶æ¥æ”¶        æ¸…æ´—èšåˆ        æŠ¥è¡¨å¯è§†åŒ–
  è‡ªåŠ¨é‡‡é›†        æ‰¹é‡ä¸ŠæŠ¥        å­˜å‚¨å½’æ¡£        æ¼æ–—åˆ†æ
  æ‰‹åŠ¨åŸ‹ç‚¹        æ•°æ®æ ¡éªŒ        ç”¨æˆ·ç”»åƒ        ABæµ‹è¯•
```

### 24.2 åŸ‹ç‚¹äº‹ä»¶åˆ†ç±»

#### äº‹ä»¶ç±»å‹å®šä¹‰

| ç±»å‹ | ä»£ç  | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| **é¡µé¢æµè§ˆ** | `page_view` | é¡µé¢æ‰“å¼€/åœç•™ | é¦–é¡µã€ç»Ÿè®¡é¡µã€è®°è´¦é¡µ |
| **ç‚¹å‡»äº‹ä»¶** | `click` | æŒ‰é’®/é“¾æ¥ç‚¹å‡» | è®°è´¦æŒ‰é’®ã€åˆ†ç±»é€‰æ‹© |
| **æ›å…‰äº‹ä»¶** | `exposure` | å…ƒç´ å±•ç¤º | å¹¿å‘Šä½ã€æ¨èå¡ç‰‡ |
| **ä¸šåŠ¡äº‹ä»¶** | `business` | æ ¸å¿ƒä¸šåŠ¡æ“ä½œ | åˆ›å»ºè´¦ç›®ã€è®¾ç½®é¢„ç®— |
| **æ€§èƒ½äº‹ä»¶** | `performance` | æ€§èƒ½æŒ‡æ ‡ | é¡µé¢åŠ è½½æ—¶é—´ã€æ¥å£è€—æ—¶ |
| **é”™è¯¯äº‹ä»¶** | `error` | å¼‚å¸¸å’Œé”™è¯¯ | æ¥å£å¤±è´¥ã€å´©æºƒ |
| **è‡ªå®šä¹‰äº‹ä»¶** | `custom` | ç‰¹æ®Šåœºæ™¯ | A/Bæµ‹è¯•åˆ†ç»„ |

#### æ ¸å¿ƒåŸ‹ç‚¹äº‹ä»¶åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¡µé¢æµè§ˆäº‹ä»¶ (page_view)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  äº‹ä»¶å                    é¡µé¢            è§¦å‘æ—¶æœº               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  pv_home                  é¦–é¡µ            è¿›å…¥é¦–é¡µ               â”‚
â”‚  pv_statistics            ç»Ÿè®¡é¡µ          è¿›å…¥ç»Ÿè®¡é¡µ             â”‚
â”‚  pv_bills                 è´¦å•é¡µ          è¿›å…¥è´¦å•é¡µ             â”‚
â”‚  pv_profile               æˆ‘çš„é¡µ          è¿›å…¥æˆ‘çš„é¡µ             â”‚
â”‚  pv_add_transaction       è®°è´¦é¡µ          æ‰“å¼€è®°è´¦é¡µ             â”‚
â”‚  pv_transaction_detail    è´¦ç›®è¯¦æƒ…        æŸ¥çœ‹è´¦ç›®è¯¦æƒ…           â”‚
â”‚  pv_budget                é¢„ç®—é¡µ          è¿›å…¥é¢„ç®—é¡µ             â”‚
â”‚  pv_goals                 ç›®æ ‡é¡µ          è¿›å…¥ç›®æ ‡é¡µ             â”‚
â”‚  pv_settings              è®¾ç½®é¡µ          è¿›å…¥è®¾ç½®é¡µ             â”‚
â”‚  pv_feedback              åé¦ˆé¡µ          è¿›å…¥åé¦ˆé¡µ             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç‚¹å‡»äº‹ä»¶ (click)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  äº‹ä»¶å                    å…ƒç´             é™„åŠ å‚æ•°               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  click_add_transaction    è®°è´¦æŒ‰é’®         entry_point(å…¥å£)     â”‚
â”‚  click_photo_recognize    æ‹ç…§è®°è´¦         -                     â”‚
â”‚  click_voice_recognize    è¯­éŸ³è®°è´¦         -                     â”‚
â”‚  click_category           åˆ†ç±»é€‰æ‹©         category_id, name     â”‚
â”‚  click_account            è´¦æˆ·é€‰æ‹©         account_id, type      â”‚
â”‚  click_tab                åº•éƒ¨Tab          tab_name              â”‚
â”‚  click_book_switch        åˆ‡æ¢è´¦æœ¬         book_id               â”‚
â”‚  click_date_picker        æ—¥æœŸé€‰æ‹©         selected_date         â”‚
â”‚  click_transaction_item   è´¦ç›®åˆ—è¡¨é¡¹       transaction_id        â”‚
â”‚  click_budget_card        é¢„ç®—å¡ç‰‡         category_id           â”‚
â”‚  click_goal_card          ç›®æ ‡å¡ç‰‡         goal_id               â”‚
â”‚  click_insight_card       æ´å¯Ÿå¡ç‰‡         insight_type          â”‚
â”‚  click_export             å¯¼å‡ºæ•°æ®         export_type           â”‚
â”‚  click_share              åˆ†äº«             share_channel         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡äº‹ä»¶ (business)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  äº‹ä»¶å                    ä¸šåŠ¡            å…³é”®å‚æ•°               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  åˆ›å»ºè´¦ç›®                                                        â”‚
â”‚  biz_transaction_create   æ–°å»ºè´¦ç›®         type, amount,         â”‚
â”‚                                           category, source       â”‚
â”‚  biz_transaction_edit     ç¼–è¾‘è´¦ç›®         transaction_id        â”‚
â”‚  biz_transaction_delete   åˆ é™¤è´¦ç›®         transaction_id        â”‚
â”‚                                                                  â”‚
â”‚  AIåŠŸèƒ½                                                          â”‚
â”‚  biz_ai_photo_start       æ‹ç…§è¯†åˆ«å¼€å§‹     -                     â”‚
â”‚  biz_ai_photo_success     æ‹ç…§è¯†åˆ«æˆåŠŸ     confidence, duration  â”‚
â”‚  biz_ai_photo_fail        æ‹ç…§è¯†åˆ«å¤±è´¥     error_code            â”‚
â”‚  biz_ai_photo_confirm     ç¡®è®¤è¯†åˆ«ç»“æœ     is_modified           â”‚
â”‚  biz_ai_voice_start       è¯­éŸ³è¯†åˆ«å¼€å§‹     -                     â”‚
â”‚  biz_ai_voice_success     è¯­éŸ³è¯†åˆ«æˆåŠŸ     duration              â”‚
â”‚  biz_ai_voice_fail        è¯­éŸ³è¯†åˆ«å¤±è´¥     error_code            â”‚
â”‚                                                                  â”‚
â”‚  é¢„ç®—ç›®æ ‡                                                        â”‚
â”‚  biz_budget_create        åˆ›å»ºé¢„ç®—         category, amount      â”‚
â”‚  biz_budget_edit          ä¿®æ”¹é¢„ç®—         budget_id             â”‚
â”‚  biz_goal_create          åˆ›å»ºç›®æ ‡         goal_type, amount     â”‚
â”‚  biz_goal_contribute      å‘ç›®æ ‡å­˜å…¥       goal_id, amount       â”‚
â”‚  biz_goal_complete        ç›®æ ‡å®Œæˆ         goal_id               â”‚
â”‚                                                                  â”‚
â”‚  ç”¨æˆ·ç›¸å…³                                                        â”‚
â”‚  biz_register             æ³¨å†Œå®Œæˆ         register_type         â”‚
â”‚  biz_login                ç™»å½•æˆåŠŸ         login_type            â”‚
â”‚  biz_logout               é€€å‡ºç™»å½•         -                     â”‚
â”‚  biz_member_purchase      è´­ä¹°ä¼šå‘˜         plan_type, amount     â”‚
â”‚  biz_trial_start          å¼€å§‹è¯•ç”¨         -                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ€§èƒ½äº‹ä»¶ (performance)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  äº‹ä»¶å                    æŒ‡æ ‡            å•ä½                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  perf_app_launch          Appå¯åŠ¨è€—æ—¶      ms                    â”‚
â”‚  perf_page_load           é¡µé¢åŠ è½½è€—æ—¶     ms (page_name)        â”‚
â”‚  perf_api_request         æ¥å£è¯·æ±‚è€—æ—¶     ms (api_path, status) â”‚
â”‚  perf_image_upload        å›¾ç‰‡ä¸Šä¼ è€—æ—¶     ms (file_size)        â”‚
â”‚  perf_ai_recognize        AIè¯†åˆ«è€—æ—¶       ms (ai_type)          â”‚
â”‚  perf_db_query            æœ¬åœ°æŸ¥è¯¢è€—æ—¶     ms (query_type)       â”‚
â”‚  perf_render_frame        å¸§æ¸²æŸ“æ—¶é—´       ms (page_name)        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é”™è¯¯äº‹ä»¶ (error)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  äº‹ä»¶å                    ç±»å‹            é™„åŠ ä¿¡æ¯               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  error_api                æ¥å£é”™è¯¯         api_path, status,     â”‚
â”‚                                           error_code, message    â”‚
â”‚  error_crash              Appå´©æºƒ          stack_trace, page     â”‚
â”‚  error_js                 JSå¼‚å¸¸           message, stack        â”‚
â”‚  error_network            ç½‘ç»œé”™è¯¯         type, url             â”‚
â”‚  error_business           ä¸šåŠ¡å¼‚å¸¸         biz_type, error_code  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.3 äº‹ä»¶æ•°æ®ç»“æ„

#### é€šç”¨äº‹ä»¶æ ¼å¼

```json
{
  "event_id": "uuid-v4",
  "event_name": "biz_transaction_create",
  "event_type": "business",
  "timestamp": 1704441600000,

  "user": {
    "user_id": "user_uuid",
    "is_login": true,
    "member_level": 1,
    "register_days": 30
  },

  "device": {
    "device_id": "device_uuid",
    "platform": "ios",
    "os_version": "17.2",
    "app_version": "1.2.3",
    "device_model": "iPhone 15 Pro",
    "screen_width": 393,
    "screen_height": 852,
    "network_type": "wifi",
    "carrier": "ä¸­å›½ç§»åŠ¨",
    "language": "zh-CN",
    "timezone": "Asia/Shanghai"
  },

  "context": {
    "page_name": "add_transaction",
    "page_path": "/bookkeeping/add",
    "referrer": "home",
    "session_id": "session_uuid",
    "session_seq": 15
  },

  "properties": {
    "transaction_type": "expense",
    "amount": 35.00,
    "category_id": "cat_001",
    "category_name": "é¤é¥®",
    "source": "manual",
    "has_image": false,
    "has_note": true
  },

  "ab_test": {
    "exp_001": "B",
    "exp_002": "A"
  }
}
```

### 24.4 å®¢æˆ·ç«¯SDKè®¾è®¡

#### FlutteråŸ‹ç‚¹SDK

```dart
// lib/core/analytics/analytics_sdk.dart

class AnalyticsSDK {
  static final AnalyticsSDK _instance = AnalyticsSDK._internal();
  factory AnalyticsSDK() => _instance;
  AnalyticsSDK._internal();

  // åˆå§‹åŒ–
  Future<void> init({
    required String appKey,
    bool enableDebug = false,
  }) async {
    // åˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯
    await _initDeviceInfo();
    // å¼€å¯ä¼šè¯
    _startSession();
    // å¯åŠ¨å®šæ—¶ä¸ŠæŠ¥
    _startReportTimer();
  }

  // ==================== é¡µé¢äº‹ä»¶ ====================

  /// é¡µé¢è¿›å…¥
  void onPageStart(String pageName, {Map<String, dynamic>? extra}) {
    _track('page_view', {
      'page_name': pageName,
      'action': 'enter',
      ...?extra,
    });
    _pageStartTime[pageName] = DateTime.now().millisecondsSinceEpoch;
  }

  /// é¡µé¢ç¦»å¼€
  void onPageEnd(String pageName) {
    final startTime = _pageStartTime[pageName];
    if (startTime != null) {
      final duration = DateTime.now().millisecondsSinceEpoch - startTime;
      _track('page_view', {
        'page_name': pageName,
        'action': 'leave',
        'duration': duration,
      });
    }
  }

  // ==================== ç‚¹å‡»äº‹ä»¶ ====================

  /// é€šç”¨ç‚¹å‡»äº‹ä»¶
  void onClick(String elementName, {Map<String, dynamic>? properties}) {
    _track('click', {
      'element': elementName,
      ...?properties,
    });
  }

  // ==================== ä¸šåŠ¡äº‹ä»¶ ====================

  /// è®°è´¦äº‹ä»¶
  void onTransactionCreate({
    required String type,
    required double amount,
    required String categoryId,
    required String source,
    bool hasImage = false,
    bool hasNote = false,
  }) {
    _track('business', {
      'action': 'transaction_create',
      'transaction_type': type,
      'amount': amount,
      'category_id': categoryId,
      'source': source,
      'has_image': hasImage,
      'has_note': hasNote,
    });
  }

  /// AIè¯†åˆ«äº‹ä»¶
  void onAIRecognize({
    required String aiType,
    required bool success,
    int? duration,
    double? confidence,
    String? errorCode,
  }) {
    _track('business', {
      'action': 'ai_recognize',
      'ai_type': aiType,
      'success': success,
      'duration': duration,
      'confidence': confidence,
      'error_code': errorCode,
    });
  }

  /// è´­ä¹°ä¼šå‘˜
  void onMemberPurchase({
    required String planType,
    required double amount,
    required String paymentMethod,
  }) {
    _track('business', {
      'action': 'member_purchase',
      'plan_type': planType,
      'amount': amount,
      'payment_method': paymentMethod,
    });
  }

  // ==================== æ€§èƒ½äº‹ä»¶ ====================

  /// é¡µé¢åŠ è½½æ€§èƒ½
  void onPageLoad(String pageName, int duration) {
    _track('performance', {
      'metric': 'page_load',
      'page_name': pageName,
      'duration': duration,
    });
  }

  /// APIè¯·æ±‚æ€§èƒ½
  void onApiRequest(String path, int status, int duration) {
    _track('performance', {
      'metric': 'api_request',
      'path': path,
      'status': status,
      'duration': duration,
    });
  }

  // ==================== é”™è¯¯äº‹ä»¶ ====================

  /// APIé”™è¯¯
  void onApiError(String path, int status, String errorCode, String message) {
    _track('error', {
      'error_type': 'api',
      'path': path,
      'status': status,
      'error_code': errorCode,
      'message': message,
    });
  }

  /// å´©æºƒä¸ŠæŠ¥
  void onCrash(String stackTrace, String pageName) {
    _trackImmediate('error', {
      'error_type': 'crash',
      'stack_trace': stackTrace,
      'page_name': pageName,
    });
  }

  // ==================== æ ¸å¿ƒæ–¹æ³• ====================

  void _track(String eventType, Map<String, dynamic> properties) {
    final event = _buildEvent(eventType, properties);
    _eventQueue.add(event);

    // é˜Ÿåˆ—æ»¡äº†ç«‹å³ä¸ŠæŠ¥
    if (_eventQueue.length >= _maxQueueSize) {
      _flushEvents();
    }
  }

  void _trackImmediate(String eventType, Map<String, dynamic> properties) {
    final event = _buildEvent(eventType, properties);
    _sendEvents([event]);
  }

  Map<String, dynamic> _buildEvent(String eventType, Map<String, dynamic> properties) {
    return {
      'event_id': Uuid().v4(),
      'event_type': eventType,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
      'user': _getUserInfo(),
      'device': _deviceInfo,
      'context': _getContext(),
      'properties': properties,
      'ab_test': _abTestGroups,
    };
  }
}
```

#### è‡ªåŠ¨åŸ‹ç‚¹ï¼ˆé¡µé¢æµè§ˆï¼‰

```dart
// lib/core/analytics/auto_track_observer.dart

class AnalyticsRouteObserver extends NavigatorObserver {
  @override
  void didPush(Route route, Route? previousRoute) {
    _trackPageView(route, 'push');
  }

  @override
  void didPop(Route route, Route? previousRoute) {
    _trackPageEnd(route);
    if (previousRoute != null) {
      _trackPageView(previousRoute, 'pop_back');
    }
  }

  void _trackPageView(Route route, String action) {
    final pageName = _getPageName(route);
    if (pageName != null) {
      AnalyticsSDK().onPageStart(pageName);
    }
  }

  void _trackPageEnd(Route route) {
    final pageName = _getPageName(route);
    if (pageName != null) {
      AnalyticsSDK().onPageEnd(pageName);
    }
  }

  String? _getPageName(Route route) {
    if (route.settings.name != null) {
      return route.settings.name;
    }
    // ä»è·¯ç”±ç±»å‹æ¨æ–­
    return route.runtimeType.toString();
  }
}

// ä½¿ç”¨æ–¹å¼
MaterialApp(
  navigatorObservers: [AnalyticsRouteObserver()],
  // ...
)
```

#### ç‚¹å‡»åŸ‹ç‚¹å°è£…

```dart
// lib/shared/widgets/trackable_button.dart

class TrackableButton extends StatelessWidget {
  final String trackName;
  final Map<String, dynamic>? trackProperties;
  final VoidCallback onPressed;
  final Widget child;

  const TrackableButton({
    required this.trackName,
    required this.onPressed,
    required this.child,
    this.trackProperties,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        // å…ˆåŸ‹ç‚¹
        AnalyticsSDK().onClick(trackName, properties: trackProperties);
        // å†æ‰§è¡Œä¸šåŠ¡
        onPressed();
      },
      child: child,
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
TrackableButton(
  trackName: 'click_add_transaction',
  trackProperties: {'entry_point': 'home_fab'},
  onPressed: () => _navigateToAddTransaction(),
  child: FloatingActionButton(
    child: Icon(Icons.add),
  ),
)
```

### 24.5 æ•°æ®ä¸ŠæŠ¥ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®ä¸ŠæŠ¥ç­–ç•¥                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“¦ æ‰¹é‡ä¸ŠæŠ¥                                                     â”‚
â”‚  â”œâ”€â”€ é˜Ÿåˆ—é•¿åº¦è¾¾åˆ° 20 æ¡æ—¶è§¦å‘ä¸ŠæŠ¥                                 â”‚
â”‚  â”œâ”€â”€ å®šæ—¶ 30 ç§’ä¸ŠæŠ¥ä¸€æ¬¡                                          â”‚
â”‚  â”œâ”€â”€ App åˆ‡åˆ°åå°æ—¶ç«‹å³ä¸ŠæŠ¥                                       â”‚
â”‚  â””â”€â”€ App å¯åŠ¨æ—¶ä¸ŠæŠ¥ä¸Šæ¬¡æœªå‘é€çš„æ•°æ®                               â”‚
â”‚                                                                  â”‚
â”‚  âš¡ å®æ—¶ä¸ŠæŠ¥                                                     â”‚
â”‚  â”œâ”€â”€ å´©æºƒäº‹ä»¶ (error_crash)                                      â”‚
â”‚  â”œâ”€â”€ æ”¯ä»˜äº‹ä»¶ (biz_member_purchase)                              â”‚
â”‚  â””â”€â”€ å…³é”®ä¸šåŠ¡å¼‚å¸¸                                                â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¾ æœ¬åœ°ç¼“å­˜                                                     â”‚
â”‚  â”œâ”€â”€ ç¦»çº¿æ—¶å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“                                       â”‚
â”‚  â”œâ”€â”€ æœ€å¤šç¼“å­˜ 1000 æ¡äº‹ä»¶                                        â”‚
â”‚  â”œâ”€â”€ è¶…è¿‡åé‡‡ç”¨ LRU æ·˜æ±°ç­–ç•¥                                      â”‚
â”‚  â””â”€â”€ ç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡ä¼                                           â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”’ æ•°æ®å®‰å…¨                                                     â”‚
â”‚  â”œâ”€â”€ HTTPS ä¼ è¾“åŠ å¯†                                              â”‚
â”‚  â”œâ”€â”€ æ•æ„Ÿå­—æ®µè„±æ• (æ‰‹æœºå·ã€é‚®ç®±ç­‰)                                â”‚
â”‚  â”œâ”€â”€ æœ¬åœ°æ•°æ®åŠ å¯†å­˜å‚¨                                            â”‚
â”‚  â””â”€â”€ ä¸ŠæŠ¥æ•°æ®ç­¾åé˜²ç¯¡æ”¹                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.6 æœåŠ¡ç«¯æ•°æ®å¤„ç†

#### æ•°æ®å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®æ¥æ”¶  â”‚â”€â”€â”€â–¶â”‚ æ•°æ®æ¸…æ´—  â”‚â”€â”€â”€â–¶â”‚ å®æ—¶è®¡ç®—  â”‚â”€â”€â”€â–¶â”‚ æ•°æ®å­˜å‚¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼               â–¼
   æ¥æ”¶ä¸ŠæŠ¥        æ ¼å¼æ ¡éªŒ        å®æ—¶èšåˆ         åŸå§‹æ•°æ®
   è§£å‹è§£å¯†        å­—æ®µè¡¥å…¨        ç”¨æˆ·åˆ†ç¾¤         èšåˆæ•°æ®
   è´Ÿè½½å‡è¡¡        å¼‚å¸¸è¿‡æ»¤        æ¼æ–—è®¡ç®—         ç”¨æˆ·ç”»åƒ
```

#### æ•°æ®è¡¨è®¾è®¡

```sql
-- åŸå§‹äº‹ä»¶è¡¨ï¼ˆæŒ‰æ—¥åˆ†åŒºï¼‰
CREATE TABLE analytics_events (
    id BIGSERIAL PRIMARY KEY,
    event_id VARCHAR(50) UNIQUE NOT NULL,
    event_type VARCHAR(20) NOT NULL,
    event_name VARCHAR(100),
    user_id UUID,
    device_id VARCHAR(100),
    session_id VARCHAR(50),

    -- è®¾å¤‡ä¿¡æ¯
    platform VARCHAR(20),
    os_version VARCHAR(20),
    app_version VARCHAR(20),
    device_model VARCHAR(50),
    network_type VARCHAR(20),

    -- ä¸Šä¸‹æ–‡
    page_name VARCHAR(100),
    page_path VARCHAR(200),
    referrer VARCHAR(100),

    -- äº‹ä»¶å±æ€§ï¼ˆJSONBä¾¿äºçµæ´»æŸ¥è¯¢ï¼‰
    properties JSONB,
    ab_test JSONB,

    -- æ—¶é—´
    event_time TIMESTAMP NOT NULL,
    received_time TIMESTAMP DEFAULT NOW(),

    -- åˆ†åŒºé”®
    event_date DATE NOT NULL
) PARTITION BY RANGE (event_date);

-- æŒ‰æ—¥åˆ›å»ºåˆ†åŒº
CREATE TABLE analytics_events_20240101 PARTITION OF analytics_events
    FOR VALUES FROM ('2024-01-01') TO ('2024-01-02');

-- ç”¨æˆ·ä¼šè¯è¡¨
CREATE TABLE analytics_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    device_id VARCHAR(100) NOT NULL,
    session_id VARCHAR(50) UNIQUE NOT NULL,

    -- ä¼šè¯ä¿¡æ¯
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    duration_seconds INT,
    page_count INT DEFAULT 0,
    event_count INT DEFAULT 0,

    -- é¦–æ¬¡è®¿é—®é¡µé¢
    entry_page VARCHAR(100),
    exit_page VARCHAR(100),

    -- è®¾å¤‡ä¿¡æ¯å¿«ç…§
    platform VARCHAR(20),
    app_version VARCHAR(20),

    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·æ¯æ—¥èšåˆè¡¨
CREATE TABLE analytics_user_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    stat_date DATE NOT NULL,

    -- æ´»è·ƒæŒ‡æ ‡
    session_count INT DEFAULT 0,
    page_view_count INT DEFAULT 0,
    total_duration_seconds INT DEFAULT 0,

    -- ä¸šåŠ¡æŒ‡æ ‡
    transaction_count INT DEFAULT 0,
    transaction_amount DECIMAL(15,2) DEFAULT 0,
    ai_usage_count INT DEFAULT 0,

    -- åŠŸèƒ½ä½¿ç”¨
    features_used VARCHAR(100)[],

    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, stat_date)
);

-- äº‹ä»¶èšåˆè¡¨ï¼ˆæ¯å°æ—¶ï¼‰
CREATE TABLE analytics_event_hourly (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_name VARCHAR(100) NOT NULL,
    stat_hour TIMESTAMP NOT NULL,

    -- èšåˆæŒ‡æ ‡
    event_count BIGINT DEFAULT 0,
    unique_users INT DEFAULT 0,
    unique_devices INT DEFAULT 0,

    -- å±æ€§åˆ†å¸ƒï¼ˆJSONBå­˜å‚¨ï¼‰
    property_distribution JSONB,

    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(event_name, stat_hour)
);

-- æ¼æ–—åˆ†æè¡¨
CREATE TABLE analytics_funnels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    funnel_name VARCHAR(100) NOT NULL,
    stat_date DATE NOT NULL,

    -- æ¼æ–—æ­¥éª¤
    step1_name VARCHAR(100),
    step1_count INT DEFAULT 0,
    step2_name VARCHAR(100),
    step2_count INT DEFAULT 0,
    step3_name VARCHAR(100),
    step3_count INT DEFAULT 0,
    step4_name VARCHAR(100),
    step4_count INT DEFAULT 0,
    step5_name VARCHAR(100),
    step5_count INT DEFAULT 0,

    -- è½¬åŒ–ç‡
    step1_to_2_rate DECIMAL(5,2),
    step2_to_3_rate DECIMAL(5,2),
    step3_to_4_rate DECIMAL(5,2),
    step4_to_5_rate DECIMAL(5,2),
    overall_rate DECIMAL(5,2),

    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(funnel_name, stat_date)
);

-- ç”¨æˆ·ç”»åƒæ ‡ç­¾è¡¨
CREATE TABLE analytics_user_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL,

    -- åŸºç¡€å±æ€§
    first_seen_at TIMESTAMP,
    last_seen_at TIMESTAMP,
    total_sessions INT DEFAULT 0,
    total_days_active INT DEFAULT 0,

    -- ç”¨æˆ·ä»·å€¼
    lifetime_value DECIMAL(15,2) DEFAULT 0,
    member_level INT DEFAULT 0,

    -- ä½¿ç”¨ä¹ æƒ¯
    preferred_time VARCHAR(20),  -- morning, afternoon, evening, night
    avg_session_duration INT,
    most_used_features VARCHAR(100)[],

    -- è®°è´¦ä¹ æƒ¯
    avg_transactions_per_week DECIMAL(5,2),
    preferred_input_method VARCHAR(20),  -- manual, photo, voice
    top_categories VARCHAR(100)[],

    -- è®¾å¤‡ä¿¡æ¯
    primary_platform VARCHAR(20),
    primary_device VARCHAR(50),

    -- æ ‡ç­¾
    tags VARCHAR(50)[],

    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_events_user_time ON analytics_events(user_id, event_time);
CREATE INDEX idx_events_type_time ON analytics_events(event_type, event_time);
CREATE INDEX idx_events_name ON analytics_events(event_name);
CREATE INDEX idx_sessions_user ON analytics_sessions(user_id, start_time);
CREATE INDEX idx_user_daily ON analytics_user_daily(user_id, stat_date);
```

### 24.7 åˆ†ææŠ¥è¡¨

#### æ ¸å¿ƒæŒ‡æ ‡ä»ªè¡¨ç›˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š æ•°æ®çœ‹æ¿                                æ—¶é—´: 2024-01-05    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æ ¸å¿ƒæŒ‡æ ‡                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  DAU     â”‚ â”‚  æ–°å¢ç”¨æˆ· â”‚ â”‚ æ¬¡æ—¥ç•™å­˜ â”‚ â”‚  ARPU   â”‚            â”‚
â”‚  â”‚  8,520   â”‚ â”‚   320    â”‚ â”‚  45.2%   â”‚ â”‚  Â¥12.5  â”‚            â”‚
â”‚  â”‚  â†‘8.5%   â”‚ â”‚  â†‘12.3%  â”‚ â”‚  â†‘2.1%   â”‚ â”‚  â†‘5.2%  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  åŠŸèƒ½ä½¿ç”¨TOP5                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. æ‰‹åŠ¨è®°è´¦      68%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                  â”‚â”‚
â”‚  â”‚ 2. æŸ¥çœ‹ç»Ÿè®¡      52%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                       â”‚â”‚
â”‚  â”‚ 3. æ‹ç…§è®°è´¦      35%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                            â”‚â”‚
â”‚  â”‚ 4. é¢„ç®—æŸ¥çœ‹      28%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                              â”‚â”‚
â”‚  â”‚ 5. è¯­éŸ³è®°è´¦      15%  â–ˆâ–ˆâ–ˆâ–ˆ                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  è®°è´¦æ–¹å¼åˆ†å¸ƒ                        ç”¨æˆ·æ´»è·ƒæ—¶æ®µ                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     æ‰‹åŠ¨                â”‚       â”‚ 8                       â”‚ â”‚
â”‚  â”‚     65%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚       â”‚ 6     â•­â”€â•®    â•­â”€â”€â•®       â”‚ â”‚
â”‚  â”‚     æ‹ç…§                â”‚       â”‚ 4  â•­â”€â”€â•¯ â•°â”€â”€â”€â”€â•¯  â•°â”€â”€â”€â•®   â”‚ â”‚
â”‚  â”‚     25%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚       â”‚ 2â”€â”€â•¯                â•°â”€â”€ â”‚ â”‚
â”‚  â”‚     è¯­éŸ³                â”‚       â”‚ 0  6  9  12  15  18  21 â”‚ â”‚
â”‚  â”‚     10%  â–ˆâ–ˆ             â”‚       â”‚      æ—¶                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¼æ–—åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”» è®°è´¦è½¬åŒ–æ¼æ–—                           æ—¶é—´: è¿‘7å¤©          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  æ‰“å¼€App                    8,520 äºº     100%               â”‚â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚â”‚
â”‚  â”‚                                        â†“ 65%                â”‚â”‚
â”‚  â”‚  è¿›å…¥è®°è´¦é¡µ                  5,538 äºº      65%               â”‚â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                     â”‚â”‚
â”‚  â”‚                                        â†“ 78%                â”‚â”‚
â”‚  â”‚  é€‰æ‹©åˆ†ç±»                    4,320 äºº      50.7%            â”‚â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                â”‚â”‚
â”‚  â”‚                                        â†“ 92%                â”‚â”‚
â”‚  â”‚  è¾“å…¥é‡‘é¢                    3,974 äºº      46.6%            â”‚â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                  â”‚â”‚
â”‚  â”‚                                        â†“ 95%                â”‚â”‚
â”‚  â”‚  å®Œæˆè®°è´¦                    3,775 äºº      44.3%            â”‚â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                   â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¡ ä¼˜åŒ–å»ºè®®:                                                    â”‚
â”‚  â€¢ "è¿›å…¥è®°è´¦é¡µ"è½¬åŒ–ç‡è¾ƒä½(65%)ï¼Œå»ºè®®ä¼˜åŒ–é¦–é¡µè®°è´¦å…¥å£å±•ç¤º          â”‚
â”‚  â€¢ å¯å°è¯•åœ¨é¦–é¡µå¢åŠ å¿«æ·è®°è´¦å¡ç‰‡                                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç”¨æˆ·ç•™å­˜åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ ç”¨æˆ·ç•™å­˜åˆ†æ                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ç•™å­˜ç‡è¶‹åŠ¿ï¼ˆæ–°ç”¨æˆ·ï¼‰                                            â”‚
â”‚                                                                  â”‚
â”‚  æ³¨å†Œæ—¥æœŸ    æ–°å¢   æ¬¡æ—¥   3æ—¥   7æ—¥   14æ—¥  30æ—¥               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  01-01      320   45.2%  38.1%  28.5%  22.3%  15.6%            â”‚
â”‚  01-02      285   47.0%  39.6%  29.8%  23.5%  --               â”‚
â”‚  01-03      310   44.5%  37.2%  27.1%  --     --               â”‚
â”‚  01-04      298   46.3%  38.9%  --     --     --               â”‚
â”‚  01-05      340   45.9%  --     --     --     --               â”‚
â”‚                                                                  â”‚
â”‚  ç•™å­˜æ›²çº¿                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 50%â”‚â•²                                                       â”‚â”‚
â”‚  â”‚ 40%â”‚ â•²___                                                   â”‚â”‚
â”‚  â”‚ 30%â”‚     â•²___                                               â”‚â”‚
â”‚  â”‚ 20%â”‚         â•²_____                                         â”‚â”‚
â”‚  â”‚ 10%â”‚               â•²___________                             â”‚â”‚
â”‚  â”‚  0%â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚    1æ—¥  3æ—¥  7æ—¥  14æ—¥  30æ—¥  60æ—¥  90æ—¥                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š åŒæœŸç¾¤å¯¹æ¯”                                                   â”‚
â”‚  â€¢ æœ¬å‘¨ç•™å­˜ vs ä¸Šå‘¨: â†‘3.2%                                      â”‚
â”‚  â€¢ ä¸»è¦æå‡æ¥æº: æ–°æ‰‹å¼•å¯¼ä¼˜åŒ–                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.8 ç”¨æˆ·ç”»åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ç”¨æˆ·ç”»åƒåˆ†æ                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ç”¨æˆ·åˆ†ç¾¤                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  ğŸŒŸ é«˜ä»·å€¼ç”¨æˆ· (12%)                                        â”‚â”‚
â”‚  â”‚     â€¢ ä»˜è´¹ä¼šå‘˜                                              â”‚â”‚
â”‚  â”‚     â€¢ æ—¥å‡è®°è´¦ 5+ ç¬”                                        â”‚â”‚
â”‚  â”‚     â€¢ ä½¿ç”¨å…¨éƒ¨æ ¸å¿ƒåŠŸèƒ½                                      â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  ğŸ“ˆ æ´»è·ƒç”¨æˆ· (35%)                                          â”‚â”‚
â”‚  â”‚     â€¢ å‘¨æ´»è·ƒ 5+ å¤©                                          â”‚â”‚
â”‚  â”‚     â€¢ æ—¥å‡è®°è´¦ 2-5 ç¬”                                       â”‚â”‚
â”‚  â”‚     â€¢ ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½                                          â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  ğŸ“Š æ™®é€šç”¨æˆ· (40%)                                          â”‚â”‚
â”‚  â”‚     â€¢ å‘¨æ´»è·ƒ 2-4 å¤©                                         â”‚â”‚
â”‚  â”‚     â€¢ ä¸»è¦æ‰‹åŠ¨è®°è´¦                                          â”‚â”‚
â”‚  â”‚     â€¢ å¶å°”æŸ¥çœ‹ç»Ÿè®¡                                          â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  ğŸ˜´ æ²‰é»˜ç”¨æˆ· (13%)                                          â”‚â”‚
â”‚  â”‚     â€¢ 30å¤©å†…æ— æ´»è·ƒ                                          â”‚â”‚
â”‚  â”‚     â€¢ å¾…å¬å›                                                â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  ä½¿ç”¨ä¹ æƒ¯æ ‡ç­¾                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  è®°è´¦æ–¹å¼: [æ‰‹åŠ¨æ´¾ 65%] [æ‹ç…§æ´¾ 25%] [è¯­éŸ³æ´¾ 10%]            â”‚â”‚
â”‚  â”‚  æ´»è·ƒæ—¶æ®µ: [æ—©é—´ 15%] [åˆé—´ 25%] [æ™šé—´ 45%] [å¤œé—´ 15%]       â”‚â”‚
â”‚  â”‚  è®°è´¦é¢‘ç‡: [æ—¥è®°å‹ 20%] [å‘¨è®°å‹ 50%] [æœˆè®°å‹ 30%]            â”‚â”‚
â”‚  â”‚  æ¶ˆè´¹ç±»å‹: [é¤é¥®ä¸ºä¸» 40%] [è´­ç‰©ä¸ºä¸» 25%] [å‡è¡¡å‹ 35%]        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.9 A/Bæµ‹è¯•é›†æˆ

```dart
// A/Bæµ‹è¯•é…ç½®
class ABTestManager {
  static final ABTestManager _instance = ABTestManager._internal();
  factory ABTestManager() => _instance;
  ABTestManager._internal();

  Map<String, String> _experiments = {};

  /// åˆå§‹åŒ–å®éªŒåˆ†ç»„
  Future<void> init(String userId) async {
    // ä»æœåŠ¡ç«¯è·å–ç”¨æˆ·åˆ†ç»„
    final response = await _fetchExperiments(userId);
    _experiments = response;

    // ä¸ŠæŠ¥åˆ†ç»„ä¿¡æ¯
    AnalyticsSDK().setABTestGroups(_experiments);
  }

  /// è·å–å®éªŒåˆ†ç»„
  String getVariant(String experimentId, {String defaultValue = 'control'}) {
    return _experiments[experimentId] ?? defaultValue;
  }

  /// æ£€æŸ¥æ˜¯å¦åœ¨å®éªŒç»„
  bool isInExperiment(String experimentId, String variant) {
    return _experiments[experimentId] == variant;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
if (ABTestManager().isInExperiment('new_home_layout', 'B')) {
  // å±•ç¤ºæ–°ç‰ˆé¦–é¡µå¸ƒå±€
  return NewHomeLayout();
} else {
  // å±•ç¤ºåŸç‰ˆé¦–é¡µå¸ƒå±€
  return OriginalHomeLayout();
}
```

### 24.10 éšç§åˆè§„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        éšç§åˆè§„è¦æ±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“‹ æ•°æ®æ”¶é›†åŸåˆ™                                                 â”‚
â”‚  â”œâ”€â”€ æœ€å°å¿…è¦: åªæ”¶é›†ä¸šåŠ¡å¿…éœ€çš„æ•°æ®                               â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·çŸ¥æƒ…: åœ¨éšç§æ”¿ç­–ä¸­æ˜ç¡®è¯´æ˜æ”¶é›†å†…å®¹                        â”‚
â”‚  â”œâ”€â”€ æˆæƒåŒæ„: é¦–æ¬¡ä½¿ç”¨æ—¶è·å–ç”¨æˆ·æˆæƒ                             â”‚
â”‚  â””â”€â”€ å¯é€‰é€€å‡º: ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­å…³é—­æ•°æ®æ”¶é›†                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”’ æ•°æ®è„±æ•è§„åˆ™                                                 â”‚
â”‚  â”œâ”€â”€ æ‰‹æœºå·: 138****8888                                        â”‚
â”‚  â”œâ”€â”€ é‚®ç®±: t***@example.com                                     â”‚
â”‚  â”œâ”€â”€ è®¾å¤‡ID: åŠ å¯†åå­˜å‚¨                                          â”‚
â”‚  â”œâ”€â”€ ä½ç½®: åªè®°å½•åŸå¸‚çº§åˆ«                                        â”‚
â”‚  â””â”€â”€ é‡‘é¢: å¯é€‰æ‹©æ˜¯å¦ä¸ŠæŠ¥å…·ä½“é‡‘é¢                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“… æ•°æ®ä¿ç•™æœŸé™                                                 â”‚
â”‚  â”œâ”€â”€ åŸå§‹äº‹ä»¶: 90å¤©                                              â”‚
â”‚  â”œâ”€â”€ èšåˆæ•°æ®: 2å¹´                                               â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·ç”»åƒ: ç”¨æˆ·æ³¨é”€å30å¤©åˆ é™¤                                 â”‚
â”‚  â””â”€â”€ å´©æºƒæ—¥å¿—: 30å¤©                                              â”‚
â”‚                                                                  â”‚
â”‚  ğŸŒ åˆè§„è¦æ±‚                                                     â”‚
â”‚  â”œâ”€â”€ ä¸­å›½: ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ã€Šæ•°æ®å®‰å…¨æ³•ã€‹                        â”‚
â”‚  â”œâ”€â”€ GDPR: æ¬§æ´²ç”¨æˆ·æ•°æ®å¤„ç†åˆè§„                                   â”‚
â”‚  â””â”€â”€ CCPA: åŠ å·ç”¨æˆ·éšç§æƒä¿æŠ¤                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.11 APIè®¾è®¡

```
#### æ•°æ®ä¸ŠæŠ¥API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/analytics/track | æ‰¹é‡ä¸ŠæŠ¥äº‹ä»¶ |
| POST | /api/v1/analytics/crash | å´©æºƒä¸ŠæŠ¥ï¼ˆå®æ—¶ï¼‰ |

#### é…ç½®è·å–API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/analytics/config | è·å–åŸ‹ç‚¹é…ç½® |
| GET | /api/v1/analytics/ab-test | è·å–A/Bæµ‹è¯•åˆ†ç»„ |

#### ç®¡ç†åå°API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/admin/analytics/overview | æ•°æ®æ¦‚è§ˆ |
| GET | /api/v1/admin/analytics/events | äº‹ä»¶æŸ¥è¯¢ |
| GET | /api/v1/admin/analytics/funnel | æ¼æ–—åˆ†æ |
| GET | /api/v1/admin/analytics/retention | ç•™å­˜åˆ†æ |
| GET | /api/v1/admin/analytics/user-profile | ç”¨æˆ·ç”»åƒ |
| GET | /api/v1/admin/analytics/realtime | å®æ—¶æ•°æ® |
| POST | /api/v1/admin/analytics/ab-test | åˆ›å»ºA/Bæµ‹è¯• |
| GET | /api/v1/admin/analytics/ab-test/{id}/result | A/Bæµ‹è¯•ç»“æœ |
```

---

## äºŒåäº”ã€ä¸»é¢˜æ¢è‚¤ç³»ç»Ÿ

### 25.1 ä¸»é¢˜ç³»ç»Ÿæ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸»é¢˜æ¢è‚¤ç³»ç»Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ¨ æ ¸å¿ƒåŠŸèƒ½                                                     â”‚
â”‚  â”œâ”€â”€ é¢„è®¾ä¸»é¢˜: æä¾›å¤šå¥—ç»å…¸ä¸»é¢˜ä¾›ç”¨æˆ·é€‰æ‹©                          â”‚
â”‚  â”œâ”€â”€ æ·±è‰²æ¨¡å¼: æ”¯æŒæµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿ                             â”‚
â”‚  â”œâ”€â”€ ä¸»é¢˜é¢„è§ˆ: åˆ‡æ¢å‰å¯é¢„è§ˆæ•ˆæœ                                   â”‚
â”‚  â”œâ”€â”€ å®æ—¶åˆ‡æ¢: æ— éœ€é‡å¯å³æ—¶ç”Ÿæ•ˆ                                   â”‚
â”‚  â””â”€â”€ ä¼šå‘˜ä¸»é¢˜: éƒ¨åˆ†é«˜çº§ä¸»é¢˜ä»…é™ä¼šå‘˜ä½¿ç”¨                           â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“¦ ä¸»é¢˜åŒ…å«å†…å®¹                                                 â”‚
â”‚  â”œâ”€â”€ é¢œè‰²æ–¹æ¡ˆ: ä¸»è‰²ã€è¾…åŠ©è‰²ã€èƒŒæ™¯è‰²ã€æ–‡å­—è‰²ç­‰                      â”‚
â”‚  â”œâ”€â”€ å›¾æ ‡æ ·å¼: åŒ¹é…ä¸»é¢˜çš„å›¾æ ‡é£æ ¼                                 â”‚
â”‚  â”œâ”€â”€ å­—ä½“é…ç½®: å­—ä½“å¤§å°ã€å­—é‡                                     â”‚
â”‚  â”œâ”€â”€ åœ†è§’æ ·å¼: ç»„ä»¶åœ†è§’å¤§å°                                       â”‚
â”‚  â””â”€â”€ åŠ¨ç”»æ•ˆæœ: ä¸»é¢˜ç‰¹æœ‰çš„è¿‡æ¸¡åŠ¨ç”»                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 25.2 é¢„è®¾ç»å…¸ä¸»é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç»å…¸ä¸»é¢˜åˆ—è¡¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸŒŸ åŸºç¡€ä¸»é¢˜ (å…è´¹)                                              â”‚
â”‚                                                                  â”‚
â”‚  1. é»˜è®¤è“ (Default Blue)                                        â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #2196F3 (Material Blue)                            â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #64B5F6                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #FFFFFF / #121212 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: ç®€æ´ä¸“ä¸šï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨                               â”‚
â”‚     â””â”€â”€ å›¾æ ‡: çº¿æ€§å›¾æ ‡                                           â”‚
â”‚                                                                  â”‚
â”‚  2. è–„è·ç»¿ (Mint Green)                                          â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #26A69A (Teal)                                     â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #80CBC4                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #F5FFFA / #1A2F2A (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: æ¸…æ–°è‡ªç„¶ï¼ŒæŠ¤çœ¼èˆ’é€‚                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: åœ†æ¶¦å›¾æ ‡                                           â”‚
â”‚                                                                  â”‚
â”‚  3. æš–é˜³æ©™ (Warm Orange)                                         â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #FF9800 (Orange)                                   â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #FFB74D                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #FFFAF0 / #2D2416 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: æ¸©æš–æ´»åŠ›ï¼Œç§¯æå‘ä¸Š                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: å¡«å……å›¾æ ‡                                           â”‚
â”‚                                                                  â”‚
â”‚  4. ç»å…¸é»‘ç™½ (Classic Mono)                                      â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #424242 (Grey)                                     â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #757575                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #FAFAFA / #000000 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: æç®€å•†åŠ¡ï¼Œä½è°ƒç¨³é‡                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: ç»†çº¿å›¾æ ‡                                           â”‚
â”‚                                                                  â”‚
â”‚  â­ ä¼šå‘˜ä¸“å±ä¸»é¢˜                                                  â”‚
â”‚                                                                  â”‚
â”‚  5. æ¨±èŠ±ç²‰ (Sakura Pink)                                         â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #E91E63 (Pink)                                     â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #F48FB1                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #FFF0F5 / #2D1A21 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: æµªæ¼«æ¸©æŸ”ï¼Œå°‘å¥³å¿ƒ                                     â”‚
â”‚     â””â”€â”€ å›¾æ ‡: å¯çˆ±åœ†æ¶¦å›¾æ ‡                                        â”‚
â”‚                                                                  â”‚
â”‚  6. æ·±é‚ƒç´« (Royal Purple)                                        â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #673AB7 (Deep Purple)                              â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #9575CD                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #F3E5F5 / #1A1625 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: ç¥ç§˜é«˜è´µï¼Œä¸ªæ€§ç‹¬ç‰¹                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: æ¸å˜å›¾æ ‡                                           â”‚
â”‚                                                                  â”‚
â”‚  7. æµ·æ´‹è“ (Ocean Blue)                                          â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #0277BD (Light Blue)                               â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #4FC3F7                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #E1F5FE / #0D1B2A (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: æ·±æ²‰å®é™ï¼Œä¸“æ³¨é«˜æ•ˆ                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: æ°´æ³¢çº¹å›¾æ ‡                                          â”‚
â”‚                                                                  â”‚
â”‚  8. æ£®æ—ç»¿ (Forest Green)                                        â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #2E7D32 (Green)                                    â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #81C784                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #E8F5E9 / #1B2E1B (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: è‡ªç„¶ç”Ÿæ€ï¼Œç¯ä¿å¥åº·                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: è‡ªç„¶é£æ ¼å›¾æ ‡                                        â”‚
â”‚                                                                  â”‚
â”‚  9. ä¸­å›½çº¢ (China Red)                                           â”‚
â”‚     â”œâ”€â”€ ä¸»è‰²: #C62828 (Red)                                      â”‚
â”‚     â”œâ”€â”€ è¾…åŠ©è‰²: #EF5350                                          â”‚
â”‚     â”œâ”€â”€ èƒŒæ™¯: #FFEBEE / #2D1616 (æ·±è‰²)                           â”‚
â”‚     â”œâ”€â”€ é£æ ¼: å–œåº†çƒ­æƒ…ï¼ŒèŠ‚æ—¥æ°›å›´                                   â”‚
â”‚     â””â”€â”€ å›¾æ ‡: ä¼ ç»Ÿé£æ ¼å›¾æ ‡                                        â”‚
â”‚                                                                  â”‚
â”‚  10. æ˜Ÿç©ºç´« (Galaxy Purple)                                      â”‚
â”‚      â”œâ”€â”€ ä¸»è‰²: æ¸å˜ #667eea â†’ #764ba2                            â”‚
â”‚      â”œâ”€â”€ è¾…åŠ©è‰²: #B39DDB                                         â”‚
â”‚      â”œâ”€â”€ èƒŒæ™¯: æ¸å˜ #0F0C29 â†’ #302B63 â†’ #24243E                  â”‚
â”‚      â”œâ”€â”€ é£æ ¼: æ¢¦å¹»ç§‘æŠ€ï¼Œæœªæ¥æ„Ÿ                                    â”‚
â”‚      â””â”€â”€ å›¾æ ‡: éœ“è™¹é£æ ¼å›¾æ ‡                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 25.3 ä¸»é¢˜æ•°æ®ç»“æ„

```dart
/// ä¸»é¢˜é…ç½®æ¨¡å‹
class AppThemeConfig {
  final String id;              // ä¸»é¢˜ID
  final String name;            // ä¸»é¢˜åç§°
  final String nameEn;          // è‹±æ–‡åç§°
  final String description;     // ä¸»é¢˜æè¿°
  final bool isPremium;         // æ˜¯å¦ä¼šå‘˜ä¸“å±
  final String iconAsset;       // ä¸»é¢˜å›¾æ ‡
  final String previewAsset;    // é¢„è§ˆå›¾
  final ThemeColors lightColors; // æµ…è‰²æ¨¡å¼é¢œè‰²
  final ThemeColors darkColors;  // æ·±è‰²æ¨¡å¼é¢œè‰²
  final ThemeTypography typography; // å­—ä½“é…ç½®
  final ThemeShapes shapes;     // å½¢çŠ¶é…ç½®
  final String iconStyle;       // å›¾æ ‡é£æ ¼
}

/// ä¸»é¢˜é¢œè‰²é…ç½®
class ThemeColors {
  // å“ç‰Œè‰²
  final Color primary;          // ä¸»è‰²
  final Color primaryLight;     // ä¸»è‰²æµ…
  final Color primaryDark;      // ä¸»è‰²æ·±
  final Color secondary;        // è¾…åŠ©è‰²
  final Color accent;           // å¼ºè°ƒè‰²

  // èƒŒæ™¯è‰²
  final Color background;       // ä¸»èƒŒæ™¯
  final Color surface;          // å¡ç‰‡èƒŒæ™¯
  final Color surfaceVariant;   // æ¬¡çº§èƒŒæ™¯

  // æ–‡å­—è‰²
  final Color textPrimary;      // ä¸»æ–‡å­—
  final Color textSecondary;    // æ¬¡è¦æ–‡å­—
  final Color textHint;         // æç¤ºæ–‡å­—
  final Color textOnPrimary;    // ä¸»è‰²ä¸Šçš„æ–‡å­—

  // åŠŸèƒ½è‰²
  final Color success;          // æˆåŠŸ/æ”¶å…¥
  final Color error;            // é”™è¯¯/æ”¯å‡º
  final Color warning;          // è­¦å‘Š
  final Color info;             // ä¿¡æ¯

  // è¾¹æ¡†å’Œåˆ†éš”çº¿
  final Color border;           // è¾¹æ¡†è‰²
  final Color divider;          // åˆ†éš”çº¿

  // ç‰¹æ®Š
  final Color shadow;           // é˜´å½±è‰²
  final Color overlay;          // é®ç½©å±‚
}

/// å­—ä½“é…ç½®
class ThemeTypography {
  final String fontFamily;      // å­—ä½“æ—
  final double fontSizeScale;   // å­—ä½“å¤§å°ç¼©æ”¾
  final FontWeight headingWeight; // æ ‡é¢˜å­—é‡
  final FontWeight bodyWeight;  // æ­£æ–‡å­—é‡
}

/// å½¢çŠ¶é…ç½®
class ThemeShapes {
  final double borderRadiusSmall;  // å°åœ†è§’ 4-8
  final double borderRadiusMedium; // ä¸­åœ†è§’ 8-12
  final double borderRadiusLarge;  // å¤§åœ†è§’ 12-20
  final double borderRadiusXL;     // è¶…å¤§åœ†è§’ 20-28
  final double cardElevation;      // å¡ç‰‡é˜´å½±
}
```

### 25.4 é¢„è®¾ä¸»é¢˜é…ç½®

```dart
/// é¢„è®¾ä¸»é¢˜åˆ—è¡¨
class PresetThemes {
  static final List<AppThemeConfig> themes = [
    // 1. é»˜è®¤è“
    AppThemeConfig(
      id: 'default_blue',
      name: 'é»˜è®¤è“',
      nameEn: 'Default Blue',
      description: 'ç®€æ´ä¸“ä¸šï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨',
      isPremium: false,
      iconAsset: 'assets/themes/icons/default_blue.svg',
      previewAsset: 'assets/themes/previews/default_blue.png',
      lightColors: ThemeColors(
        primary: Color(0xFF2196F3),
        primaryLight: Color(0xFF64B5F6),
        primaryDark: Color(0xFF1976D2),
        secondary: Color(0xFF03A9F4),
        accent: Color(0xFF00BCD4),
        background: Color(0xFFFFFFFF),
        surface: Color(0xFFF5F5F5),
        surfaceVariant: Color(0xFFEEEEEE),
        textPrimary: Color(0xFF212121),
        textSecondary: Color(0xFF757575),
        textHint: Color(0xFFBDBDBD),
        textOnPrimary: Color(0xFFFFFFFF),
        success: Color(0xFF4CAF50),
        error: Color(0xFFF44336),
        warning: Color(0xFFFF9800),
        info: Color(0xFF2196F3),
        border: Color(0xFFE0E0E0),
        divider: Color(0xFFEEEEEE),
        shadow: Color(0x1A000000),
        overlay: Color(0x80000000),
      ),
      darkColors: ThemeColors(
        primary: Color(0xFF64B5F6),
        primaryLight: Color(0xFF90CAF9),
        primaryDark: Color(0xFF42A5F5),
        secondary: Color(0xFF4FC3F7),
        accent: Color(0xFF4DD0E1),
        background: Color(0xFF121212),
        surface: Color(0xFF1E1E1E),
        surfaceVariant: Color(0xFF2C2C2C),
        textPrimary: Color(0xFFE0E0E0),
        textSecondary: Color(0xFF9E9E9E),
        textHint: Color(0xFF616161),
        textOnPrimary: Color(0xFF000000),
        success: Color(0xFF81C784),
        error: Color(0xFFE57373),
        warning: Color(0xFFFFB74D),
        info: Color(0xFF64B5F6),
        border: Color(0xFF424242),
        divider: Color(0xFF303030),
        shadow: Color(0x40000000),
        overlay: Color(0xCC000000),
      ),
      typography: ThemeTypography(
        fontFamily: 'System',
        fontSizeScale: 1.0,
        headingWeight: FontWeight.w600,
        bodyWeight: FontWeight.w400,
      ),
      shapes: ThemeShapes(
        borderRadiusSmall: 4,
        borderRadiusMedium: 8,
        borderRadiusLarge: 12,
        borderRadiusXL: 20,
        cardElevation: 2,
      ),
      iconStyle: 'outlined',
    ),

    // 2. è–„è·ç»¿
    AppThemeConfig(
      id: 'mint_green',
      name: 'è–„è·ç»¿',
      nameEn: 'Mint Green',
      description: 'æ¸…æ–°è‡ªç„¶ï¼ŒæŠ¤çœ¼èˆ’é€‚',
      isPremium: false,
      lightColors: ThemeColors(
        primary: Color(0xFF26A69A),
        primaryLight: Color(0xFF80CBC4),
        primaryDark: Color(0xFF00897B),
        // ... å®Œæ•´é¢œè‰²é…ç½®
      ),
      // ... å…¶ä»–é…ç½®
    ),

    // 3-10. å…¶ä»–ä¸»é¢˜é…ç½®...
  ];

  /// è·å–ä¸»é¢˜
  static AppThemeConfig? getTheme(String id) {
    return themes.firstWhereOrNull((t) => t.id == id);
  }

  /// è·å–å…è´¹ä¸»é¢˜
  static List<AppThemeConfig> get freeThemes {
    return themes.where((t) => !t.isPremium).toList();
  }

  /// è·å–ä¼šå‘˜ä¸»é¢˜
  static List<AppThemeConfig> get premiumThemes {
    return themes.where((t) => t.isPremium).toList();
  }
}
```

### 25.5 ä¸»é¢˜Providerå®ç°

```dart
/// ä¸»é¢˜çŠ¶æ€ç®¡ç†
final themeProvider = StateNotifierProvider<ThemeNotifier, ThemeState>((ref) {
  return ThemeNotifier(ref);
});

class ThemeState {
  final String themeId;           // å½“å‰ä¸»é¢˜ID
  final ThemeMode themeMode;      // æµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿ
  final AppThemeConfig config;    // ä¸»é¢˜é…ç½®
  final ThemeData lightTheme;     // Materialæµ…è‰²ä¸»é¢˜
  final ThemeData darkTheme;      // Materialæ·±è‰²ä¸»é¢˜

  ThemeState({
    required this.themeId,
    required this.themeMode,
    required this.config,
    required this.lightTheme,
    required this.darkTheme,
  });
}

class ThemeNotifier extends StateNotifier<ThemeState> {
  final Ref _ref;

  ThemeNotifier(this._ref) : super(_loadInitialTheme());

  /// åŠ è½½åˆå§‹ä¸»é¢˜
  static ThemeState _loadInitialTheme() {
    final prefs = SharedPreferences.getInstance();
    final themeId = prefs.getString('theme_id') ?? 'default_blue';
    final themeMode = ThemeMode.values[prefs.getInt('theme_mode') ?? 0];
    return _buildThemeState(themeId, themeMode);
  }

  /// åˆ‡æ¢ä¸»é¢˜
  Future<void> setTheme(String themeId) async {
    // æ£€æŸ¥ä¼šå‘˜æƒé™
    final config = PresetThemes.getTheme(themeId);
    if (config == null) return;

    if (config.isPremium) {
      final isPremium = await _ref.read(membershipProvider).isPremium;
      if (!isPremium) {
        throw ThemePermissionException('æ­¤ä¸»é¢˜éœ€è¦ä¼šå‘˜æƒé™');
      }
    }

    // æ›´æ–°ä¸»é¢˜
    state = _buildThemeState(themeId, state.themeMode);

    // æŒä¹…åŒ–
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('theme_id', themeId);

    // åŸ‹ç‚¹
    AnalyticsSDK().track('theme_change', {
      'theme_id': themeId,
      'theme_name': config.name,
      'is_premium': config.isPremium,
    });
  }

  /// åˆ‡æ¢æ·±è‰²æ¨¡å¼
  Future<void> setThemeMode(ThemeMode mode) async {
    state = ThemeState(
      themeId: state.themeId,
      themeMode: mode,
      config: state.config,
      lightTheme: state.lightTheme,
      darkTheme: state.darkTheme,
    );

    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt('theme_mode', mode.index);
  }

  /// æ„å»ºä¸»é¢˜çŠ¶æ€
  static ThemeState _buildThemeState(String themeId, ThemeMode mode) {
    final config = PresetThemes.getTheme(themeId) ?? PresetThemes.themes.first;

    return ThemeState(
      themeId: themeId,
      themeMode: mode,
      config: config,
      lightTheme: _buildMaterialTheme(config.lightColors, config),
      darkTheme: _buildMaterialTheme(config.darkColors, config),
    );
  }

  /// æ„å»ºMaterialä¸»é¢˜
  static ThemeData _buildMaterialTheme(ThemeColors colors, AppThemeConfig config) {
    return ThemeData(
      useMaterial3: true,
      brightness: colors.background.computeLuminance() > 0.5
          ? Brightness.light
          : Brightness.dark,
      primaryColor: colors.primary,
      colorScheme: ColorScheme(
        brightness: colors.background.computeLuminance() > 0.5
            ? Brightness.light
            : Brightness.dark,
        primary: colors.primary,
        onPrimary: colors.textOnPrimary,
        secondary: colors.secondary,
        onSecondary: colors.textOnPrimary,
        error: colors.error,
        onError: Colors.white,
        background: colors.background,
        onBackground: colors.textPrimary,
        surface: colors.surface,
        onSurface: colors.textPrimary,
      ),
      scaffoldBackgroundColor: colors.background,
      cardColor: colors.surface,
      dividerColor: colors.divider,
      appBarTheme: AppBarTheme(
        backgroundColor: colors.surface,
        foregroundColor: colors.textPrimary,
        elevation: 0,
      ),
      cardTheme: CardTheme(
        color: colors.surface,
        elevation: config.shapes.cardElevation,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(config.shapes.borderRadiusMedium),
        ),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: colors.primary,
          foregroundColor: colors.textOnPrimary,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(config.shapes.borderRadiusMedium),
          ),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: colors.surfaceVariant,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(config.shapes.borderRadiusSmall),
          borderSide: BorderSide(color: colors.border),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(config.shapes.borderRadiusSmall),
          borderSide: BorderSide(color: colors.border),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(config.shapes.borderRadiusSmall),
          borderSide: BorderSide(color: colors.primary, width: 2),
        ),
      ),
      // ... æ›´å¤šç»„ä»¶ä¸»é¢˜é…ç½®
    );
  }
}
```

### 25.6 ä¸»é¢˜é€‰æ‹©ç•Œé¢

```dart
/// ä¸»é¢˜é€‰æ‹©é¡µé¢
class ThemeSettingsPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final themeState = ref.watch(themeProvider);
    final membership = ref.watch(membershipProvider);

    return Scaffold(
      appBar: AppBar(title: Text('ä¸»é¢˜è®¾ç½®')),
      body: ListView(
        padding: EdgeInsets.all(16),
        children: [
          // æ·±è‰²æ¨¡å¼è®¾ç½®
          _buildDarkModeSection(context, ref, themeState),

          SizedBox(height: 24),

          // å…è´¹ä¸»é¢˜
          Text('åŸºç¡€ä¸»é¢˜', style: Theme.of(context).textTheme.titleMedium),
          SizedBox(height: 12),
          _buildThemeGrid(
            context,
            ref,
            PresetThemes.freeThemes,
            themeState.themeId,
          ),

          SizedBox(height: 24),

          // ä¼šå‘˜ä¸»é¢˜
          Row(
            children: [
              Text('ä¼šå‘˜ä¸“å±', style: Theme.of(context).textTheme.titleMedium),
              SizedBox(width: 8),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Color(0xFFFFD700), Color(0xFFFFA500)],
                  ),
                  borderRadius: BorderRadius.circular(10),
                ),
                child: Text('VIP', style: TextStyle(
                  color: Colors.white,
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                )),
              ),
            ],
          ),
          SizedBox(height: 12),
          _buildThemeGrid(
            context,
            ref,
            PresetThemes.premiumThemes,
            themeState.themeId,
            isPremiumRequired: !membership.isPremium,
          ),
        ],
      ),
    );
  }

  Widget _buildDarkModeSection(BuildContext context, WidgetRef ref, ThemeState state) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('æ·±è‰²æ¨¡å¼', style: Theme.of(context).textTheme.titleSmall),
            SizedBox(height: 12),
            SegmentedButton<ThemeMode>(
              segments: [
                ButtonSegment(value: ThemeMode.light, label: Text('æµ…è‰²')),
                ButtonSegment(value: ThemeMode.dark, label: Text('æ·±è‰²')),
                ButtonSegment(value: ThemeMode.system, label: Text('è·Ÿéšç³»ç»Ÿ')),
              ],
              selected: {state.themeMode},
              onSelectionChanged: (modes) {
                ref.read(themeProvider.notifier).setThemeMode(modes.first);
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildThemeGrid(
    BuildContext context,
    WidgetRef ref,
    List<AppThemeConfig> themes,
    String currentThemeId, {
    bool isPremiumRequired = false,
  }) {
    return GridView.builder(
      shrinkWrap: true,
      physics: NeverScrollableScrollPhysics(),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        childAspectRatio: 1.2,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
      ),
      itemCount: themes.length,
      itemBuilder: (context, index) {
        final theme = themes[index];
        final isSelected = theme.id == currentThemeId;

        return _ThemeCard(
          theme: theme,
          isSelected: isSelected,
          isLocked: isPremiumRequired,
          onTap: () => _selectTheme(context, ref, theme, isPremiumRequired),
        );
      },
    );
  }

  void _selectTheme(BuildContext context, WidgetRef ref, AppThemeConfig theme, bool isLocked) {
    if (isLocked) {
      // æ˜¾ç¤ºä¼šå‘˜å¼•å¯¼
      showModalBottomSheet(
        context: context,
        builder: (_) => PremiumUpgradeSheet(feature: 'ä¸“å±ä¸»é¢˜'),
      );
      return;
    }

    // æ˜¾ç¤ºé¢„è§ˆå¯¹è¯æ¡†
    showDialog(
      context: context,
      builder: (_) => ThemePreviewDialog(
        theme: theme,
        onConfirm: () {
          ref.read(themeProvider.notifier).setTheme(theme.id);
          Navigator.pop(context);
        },
      ),
    );
  }
}

/// ä¸»é¢˜å¡ç‰‡
class _ThemeCard extends StatelessWidget {
  final AppThemeConfig theme;
  final bool isSelected;
  final bool isLocked;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(12),
          border: isSelected ? Border.all(
            color: Theme.of(context).primaryColor,
            width: 2,
          ) : null,
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 8,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(12),
          child: Stack(
            children: [
              // ä¸»é¢˜é¢„è§ˆè‰²å—
              Column(
                children: [
                  // é¡¶éƒ¨ä¸»è‰²
                  Expanded(
                    flex: 2,
                    child: Container(color: theme.lightColors.primary),
                  ),
                  // åº•éƒ¨èƒŒæ™¯è‰²
                  Expanded(
                    flex: 1,
                    child: Container(
                      color: theme.lightColors.background,
                      padding: EdgeInsets.all(8),
                      child: Row(
                        children: [
                          Text(
                            theme.name,
                            style: TextStyle(
                              color: theme.lightColors.textPrimary,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),

              // é€‰ä¸­æ ‡è®°
              if (isSelected)
                Positioned(
                  top: 8,
                  right: 8,
                  child: Container(
                    padding: EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      shape: BoxShape.circle,
                    ),
                    child: Icon(Icons.check, size: 16, color: theme.lightColors.primary),
                  ),
                ),

              // é”å®šæ ‡è®°
              if (isLocked)
                Positioned.fill(
                  child: Container(
                    color: Colors.black.withOpacity(0.3),
                    child: Center(
                      child: Icon(Icons.lock, color: Colors.white, size: 32),
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }
}
```

### 25.7 ä¸»é¢˜é¢„è§ˆå¯¹è¯æ¡†

```dart
/// ä¸»é¢˜é¢„è§ˆå¯¹è¯æ¡†
class ThemePreviewDialog extends StatelessWidget {
  final AppThemeConfig theme;
  final VoidCallback onConfirm;

  @override
  Widget build(BuildContext context) {
    // ä½¿ç”¨ä¸´æ—¶ä¸»é¢˜åŒ…è£…é¢„è§ˆå†…å®¹
    return Theme(
      data: ThemeNotifier._buildMaterialTheme(theme.lightColors, theme),
      child: Dialog(
        child: Container(
          width: 320,
          padding: EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // é¢„è§ˆæ ‡é¢˜
              Text(
                'é¢„è§ˆ: ${theme.name}',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: theme.lightColors.textPrimary,
                ),
              ),

              SizedBox(height: 20),

              // æ¨¡æ‹Ÿç•Œé¢é¢„è§ˆ
              Container(
                height: 280,
                decoration: BoxDecoration(
                  color: theme.lightColors.background,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: theme.lightColors.border),
                ),
                child: Column(
                  children: [
                    // æ¨¡æ‹ŸAppBar
                    Container(
                      padding: EdgeInsets.all(12),
                      color: theme.lightColors.surface,
                      child: Row(
                        children: [
                          Icon(Icons.arrow_back, color: theme.lightColors.textPrimary, size: 20),
                          SizedBox(width: 12),
                          Text('è®°ä¸€ç¬”', style: TextStyle(
                            color: theme.lightColors.textPrimary,
                            fontWeight: FontWeight.w600,
                          )),
                        ],
                      ),
                    ),

                    // æ¨¡æ‹Ÿé‡‘é¢
                    Padding(
                      padding: EdgeInsets.all(16),
                      child: Text(
                        'Â¥ 128.00',
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.bold,
                          color: theme.lightColors.error,
                        ),
                      ),
                    ),

                    // æ¨¡æ‹Ÿåˆ†ç±»æŒ‰é’®
                    Padding(
                      padding: EdgeInsets.symmetric(horizontal: 12),
                      child: Wrap(
                        spacing: 8,
                        runSpacing: 8,
                        children: ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹'].map((cat) {
                          return Container(
                            padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                            decoration: BoxDecoration(
                              color: theme.lightColors.primary.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: Text(cat, style: TextStyle(
                              color: theme.lightColors.primary,
                              fontSize: 12,
                            )),
                          );
                        }).toList(),
                      ),
                    ),

                    Spacer(),

                    // æ¨¡æ‹Ÿä¿å­˜æŒ‰é’®
                    Padding(
                      padding: EdgeInsets.all(12),
                      child: Container(
                        width: double.infinity,
                        padding: EdgeInsets.symmetric(vertical: 12),
                        decoration: BoxDecoration(
                          color: theme.lightColors.primary,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Center(
                          child: Text('ä¿å­˜', style: TextStyle(
                            color: theme.lightColors.textOnPrimary,
                            fontWeight: FontWeight.w600,
                          )),
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              SizedBox(height: 20),

              // æ“ä½œæŒ‰é’®
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(context),
                      child: Text('å–æ¶ˆ'),
                    ),
                  ),
                  SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: onConfirm,
                      child: Text('åº”ç”¨'),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

### 25.8 ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»

```dart
/// ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»ç®¡ç†å™¨
class ThemeTransitionManager {
  /// æ‰§è¡Œä¸»é¢˜åˆ‡æ¢åŠ¨ç”»
  static Future<void> animateThemeChange({
    required BuildContext context,
    required VoidCallback onThemeChange,
    TransitionType type = TransitionType.fade,
  }) async {
    final overlay = Overlay.of(context);

    switch (type) {
      case TransitionType.fade:
        await _fadeTransition(overlay, onThemeChange);
        break;
      case TransitionType.circular:
        await _circularRevealTransition(context, overlay, onThemeChange);
        break;
      case TransitionType.slide:
        await _slideTransition(overlay, onThemeChange);
        break;
    }
  }

  /// æ·¡å…¥æ·¡å‡ºåˆ‡æ¢
  static Future<void> _fadeTransition(
    OverlayState overlay,
    VoidCallback onThemeChange,
  ) async {
    final entry = OverlayEntry(
      builder: (_) => TweenAnimationBuilder<double>(
        tween: Tween(begin: 0.0, end: 1.0),
        duration: Duration(milliseconds: 300),
        builder: (_, value, __) => Container(
          color: Colors.black.withOpacity(value * 0.3),
        ),
      ),
    );

    overlay.insert(entry);
    await Future.delayed(Duration(milliseconds: 150));
    onThemeChange();
    await Future.delayed(Duration(milliseconds: 300));
    entry.remove();
  }

  /// åœ†å½¢æ­ç¤ºåŠ¨ç”»
  static Future<void> _circularRevealTransition(
    BuildContext context,
    OverlayState overlay,
    VoidCallback onThemeChange,
  ) async {
    // è·å–ç‚¹å‡»ä½ç½®
    final box = context.findRenderObject() as RenderBox;
    final center = box.localToGlobal(box.size.center(Offset.zero));

    // åˆ›å»ºåœ†å½¢åŠ¨ç”»é®ç½©
    // ... å®ç°åœ†å½¢æ‰©å±•åŠ¨ç”»
  }
}

enum TransitionType { fade, circular, slide }
```

### 25.9 ä¸»é¢˜åŒæ­¥

```dart
/// ä¸»é¢˜åŒæ­¥æœåŠ¡
class ThemeSyncService {
  /// ä¸Šä¼ ç”¨æˆ·ä¸»é¢˜åå¥½
  Future<void> uploadPreference(String themeId, ThemeMode mode) async {
    if (!AuthService.isLoggedIn) return;

    await apiClient.post('/api/v1/user/preferences', data: {
      'theme_id': themeId,
      'theme_mode': mode.index,
    });
  }

  /// ä¸‹è½½ç”¨æˆ·ä¸»é¢˜åå¥½ï¼ˆç™»å½•ååŒæ­¥ï¼‰
  Future<ThemePreference?> downloadPreference() async {
    if (!AuthService.isLoggedIn) return null;

    final response = await apiClient.get('/api/v1/user/preferences');
    if (response.data['theme_id'] != null) {
      return ThemePreference(
        themeId: response.data['theme_id'],
        themeMode: ThemeMode.values[response.data['theme_mode'] ?? 0],
      );
    }
    return null;
  }
}
```

### 25.10 èŠ‚æ—¥ä¸»é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        èŠ‚æ—¥é™å®šä¸»é¢˜                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ„ èŠ‚æ—¥ä¸»é¢˜ (é™æ—¶å…è´¹)                                          â”‚
â”‚                                                                  â”‚
â”‚  â€¢ æ˜¥èŠ‚çº¢: 1æœˆ-2æœˆæœŸé—´å…è´¹ä½¿ç”¨                                    â”‚
â”‚  â€¢ åœ£è¯ç»¿: 12æœˆå…è´¹ä½¿ç”¨                                          â”‚
â”‚  â€¢ ä¸‡åœ£èŠ‚: 10æœˆå…è´¹ä½¿ç”¨                                          â”‚
â”‚  â€¢ æƒ…äººèŠ‚: 2æœˆ14æ—¥å‰åä¸€å‘¨                                       â”‚
â”‚                                                                  â”‚
â”‚  â° è‡ªåŠ¨åˆ‡æ¢é€»è¾‘                                                 â”‚
â”‚  â”œâ”€â”€ èŠ‚æ—¥æœŸé—´é¦–æ¬¡æ‰“å¼€Appæç¤ºæ˜¯å¦åˆ‡æ¢                              â”‚
â”‚  â”œâ”€â”€ èŠ‚æ—¥ç»“æŸåè‡ªåŠ¨æ¢å¤ä¹‹å‰ä¸»é¢˜                                   â”‚
â”‚  â””â”€â”€ ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­å…³é—­èŠ‚æ—¥ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// èŠ‚æ—¥ä¸»é¢˜ç®¡ç†
class SeasonalThemeManager {
  /// æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰èŠ‚æ—¥ä¸»é¢˜
  static SeasonalTheme? getCurrentSeasonalTheme() {
    final now = DateTime.now();

    // æ˜¥èŠ‚ (å†œå†é™¤å¤•å‰ä¸€å‘¨åˆ°æ­£æœˆåäº”)
    if (_isSpringFestivalPeriod(now)) {
      return SeasonalTheme(
        id: 'spring_festival',
        name: 'æ–°æ˜¥çº¢',
        startDate: _getSpringFestivalStart(now.year),
        endDate: _getSpringFestivalEnd(now.year),
      );
    }

    // åœ£è¯èŠ‚ (12æœˆ20æ—¥-12æœˆ26æ—¥)
    if (now.month == 12 && now.day >= 20 && now.day <= 26) {
      return SeasonalTheme(
        id: 'christmas',
        name: 'åœ£è¯ç»¿',
        startDate: DateTime(now.year, 12, 20),
        endDate: DateTime(now.year, 12, 26),
      );
    }

    return null;
  }

  /// æç¤ºç”¨æˆ·åˆ‡æ¢èŠ‚æ—¥ä¸»é¢˜
  static void promptSeasonalTheme(BuildContext context) async {
    final prefs = await SharedPreferences.getInstance();
    final seasonal = getCurrentSeasonalTheme();
    if (seasonal == null) return;

    final prompted = prefs.getBool('seasonal_${seasonal.id}_prompted') ?? false;
    if (prompted) return;

    // æ˜¾ç¤ºåˆ‡æ¢æç¤º
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text('ğŸ‰ ${seasonal.name}ä¸»é¢˜å·²ä¸Šçº¿'),
        content: Text('èŠ‚æ—¥æœŸé—´å…è´¹ä½¿ç”¨ï¼Œæ˜¯å¦ç«‹å³åˆ‡æ¢ï¼Ÿ'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('æš‚ä¸'),
          ),
          ElevatedButton(
            onPressed: () {
              // åˆ‡æ¢ä¸»é¢˜
              context.read(themeProvider.notifier).setTheme(seasonal.id);
              Navigator.pop(context);
            },
            child: Text('ç«‹å³ä½“éªŒ'),
          ),
        ],
      ),
    );

    await prefs.setBool('seasonal_${seasonal.id}_prompted', true);
  }
}
```

### 25.11 æ•°æ®åº“è®¾è®¡

```sql
-- ç”¨æˆ·ä¸»é¢˜åå¥½è¡¨
CREATE TABLE user_theme_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    theme_id VARCHAR(50) NOT NULL DEFAULT 'default_blue',
    theme_mode SMALLINT NOT NULL DEFAULT 0, -- 0:light, 1:dark, 2:system
    auto_seasonal BOOLEAN DEFAULT true,     -- æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢èŠ‚æ—¥ä¸»é¢˜
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- ä¸»é¢˜ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆç”¨äºåˆ†æï¼‰
CREATE TABLE theme_usage_stats (
    id SERIAL PRIMARY KEY,
    theme_id VARCHAR(50) NOT NULL,
    usage_count INTEGER DEFAULT 0,
    unique_users INTEGER DEFAULT 0,
    stat_date DATE NOT NULL,
    UNIQUE(theme_id, stat_date)
);
```

### 25.12 APIè®¾è®¡

```
#### ä¸»é¢˜åå¥½API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/user/theme-preference | è·å–ç”¨æˆ·ä¸»é¢˜åå¥½ |
| PUT | /api/v1/user/theme-preference | æ›´æ–°ä¸»é¢˜åå¥½ |
| GET | /api/v1/themes | è·å–å¯ç”¨ä¸»é¢˜åˆ—è¡¨ |
| GET | /api/v1/themes/seasonal | è·å–å½“å‰èŠ‚æ—¥ä¸»é¢˜ |

#### è¯·æ±‚/å“åº”ç¤ºä¾‹

# æ›´æ–°ä¸»é¢˜åå¥½
PUT /api/v1/user/theme-preference
{
  "theme_id": "ocean_blue",
  "theme_mode": 2,
  "auto_seasonal": true
}

# è·å–ä¸»é¢˜åˆ—è¡¨
GET /api/v1/themes
{
  "themes": [
    {
      "id": "default_blue",
      "name": "é»˜è®¤è“",
      "name_en": "Default Blue",
      "is_premium": false,
      "preview_url": "https://cdn.example.com/themes/default_blue.png"
    },
    {
      "id": "sakura_pink",
      "name": "æ¨±èŠ±ç²‰",
      "name_en": "Sakura Pink",
      "is_premium": true,
      "preview_url": "https://cdn.example.com/themes/sakura_pink.png"
    }
  ],
  "seasonal": {
    "id": "spring_festival",
    "name": "æ–°æ˜¥çº¢",
    "start_date": "2025-01-22",
    "end_date": "2025-02-12"
  }
}
```

---

## äºŒåå…­ã€æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 26.1 æ€§èƒ½ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ€§èƒ½æŒ‡æ ‡è¦æ±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âš¡ å“åº”æ—¶é—´ç›®æ ‡ (P95)                                           â”‚
â”‚  â”œâ”€â”€ é¡µé¢åˆ‡æ¢: < 300ms                                          â”‚
â”‚  â”œâ”€â”€ æŒ‰é’®ç‚¹å‡»åé¦ˆ: < 100ms                                       â”‚
â”‚  â”œâ”€â”€ åˆ—è¡¨æ»šåŠ¨: 60fps (16ms/å¸§)                                  â”‚
â”‚  â”œâ”€â”€ APIè¯·æ±‚: < 500ms                                           â”‚
â”‚  â”œâ”€â”€ å›¾ç‰‡åŠ è½½: < 1000ms                                         â”‚
â”‚  â””â”€â”€ æ•´ä½“æ“ä½œ: < 1000ms (ç”¨æˆ·æ„ŸçŸ¥)                               â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“± å¯åŠ¨æ—¶é—´                                                     â”‚
â”‚  â”œâ”€â”€ å†·å¯åŠ¨: < 2ç§’                                              â”‚
â”‚  â”œâ”€â”€ çƒ­å¯åŠ¨: < 500ms                                            â”‚
â”‚  â””â”€â”€ é¦–å±æ¸²æŸ“: < 1.5ç§’                                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¾ èµ„æºå ç”¨                                                     â”‚
â”‚  â”œâ”€â”€ å†…å­˜å ç”¨: < 150MB (æ­£å¸¸ä½¿ç”¨)                                â”‚
â”‚  â”œâ”€â”€ å®‰è£…åŒ…å¤§å°: < 50MB (Android) / < 80MB (iOS)                â”‚
â”‚  â””â”€â”€ æœ¬åœ°ç¼“å­˜: < 200MB                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 26.2 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```dart
/// 1. å›¾ç‰‡ä¼˜åŒ–
class ImageOptimization {
  /// å›¾ç‰‡æ‡’åŠ è½½
  static Widget lazyImage(String url, {double? width, double? height}) {
    return CachedNetworkImage(
      imageUrl: url,
      width: width,
      height: height,
      memCacheWidth: width?.toInt(),  // å†…å­˜ç¼“å­˜å°ºå¯¸ä¼˜åŒ–
      placeholder: (_, __) => Shimmer.fromColors(
        baseColor: Colors.grey[300]!,
        highlightColor: Colors.grey[100]!,
        child: Container(color: Colors.white),
      ),
      errorWidget: (_, __, ___) => Icon(Icons.error),
      fadeInDuration: Duration(milliseconds: 200),
    );
  }

  /// å›¾ç‰‡é¢„åŠ è½½ï¼ˆé¦–é¡µå…³é”®å›¾ç‰‡ï¼‰
  static Future<void> precacheImages(BuildContext context) async {
    final criticalImages = [
      'assets/images/logo.png',
      'assets/images/empty_state.png',
    ];
    for (final image in criticalImages) {
      precacheImage(AssetImage(image), context);
    }
  }
}

/// 2. åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–
class OptimizedListView extends StatelessWidget {
  final List<Transaction> transactions;

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      // å…³é”®ä¼˜åŒ–å‚æ•°
      itemCount: transactions.length,
      itemExtent: 72,  // å›ºå®šé«˜åº¦ï¼Œæå‡æ»šåŠ¨æ€§èƒ½
      cacheExtent: 500, // é¢„æ¸²æŸ“åŒºåŸŸ
      addAutomaticKeepAlives: false,  // å‡å°‘å†…å­˜å ç”¨
      addRepaintBoundaries: true,     // ç‹¬ç«‹é‡ç»˜è¾¹ç•Œ
      itemBuilder: (context, index) {
        return RepaintBoundary(
          child: TransactionItem(
            key: ValueKey(transactions[index].id),
            transaction: transactions[index],
          ),
        );
      },
    );
  }
}

/// 3. çŠ¶æ€ç®¡ç†ä¼˜åŒ– - ç²¾ç»†åŒ–è®¢é˜…
final transactionListProvider = StateNotifierProvider<TransactionListNotifier, AsyncValue<List<Transaction>>>((ref) {
  return TransactionListNotifier(ref);
});

// æ´¾ç”ŸçŠ¶æ€ - åªè®¢é˜…éœ€è¦çš„æ•°æ®
final todayTotalProvider = Provider<double>((ref) {
  final transactions = ref.watch(transactionListProvider).valueOrNull ?? [];
  return transactions
      .where((t) => t.date.isToday)
      .fold(0.0, (sum, t) => sum + t.amount);
});

/// 4. é˜²æŠ–å’ŒèŠ‚æµ
class Debouncer {
  final Duration delay;
  Timer? _timer;

  Debouncer({this.delay = const Duration(milliseconds: 300)});

  void run(VoidCallback action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }

  void dispose() => _timer?.cancel();
}

class Throttler {
  final Duration interval;
  DateTime? _lastRun;

  Throttler({this.interval = const Duration(milliseconds: 100)});

  void run(VoidCallback action) {
    final now = DateTime.now();
    if (_lastRun == null || now.difference(_lastRun!) > interval) {
      _lastRun = now;
      action();
    }
  }
}

/// 5. æŒ‰é’®ç‚¹å‡»å³æ—¶åé¦ˆ
class ResponsiveButton extends StatefulWidget {
  final VoidCallback onTap;
  final Widget child;

  @override
  State<ResponsiveButton> createState() => _ResponsiveButtonState();
}

class _ResponsiveButtonState extends State<ResponsiveButton> {
  bool _isPressed = false;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => setState(() => _isPressed = true),
      onTapUp: (_) {
        setState(() => _isPressed = false);
        // è§¦è§‰åé¦ˆ
        HapticFeedback.lightImpact();
        widget.onTap();
      },
      onTapCancel: () => setState(() => _isPressed = false),
      child: AnimatedScale(
        scale: _isPressed ? 0.95 : 1.0,
        duration: Duration(milliseconds: 100),
        child: widget.child,
      ),
    );
  }
}

/// 6. é¡µé¢é¢„åŠ è½½
class PagePreloader {
  static final Map<String, Widget> _cache = {};

  /// é¢„æ„å»ºä¸‹ä¸€ä¸ªå¯èƒ½è®¿é—®çš„é¡µé¢
  static void preload(String route, Widget Function() builder) {
    if (!_cache.containsKey(route)) {
      _cache[route] = builder();
    }
  }

  static Widget? get(String route) => _cache[route];

  static void clear() => _cache.clear();
}
```

### 26.3 ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

```dart
/// APIå®¢æˆ·ç«¯ä¼˜åŒ–é…ç½®
class OptimizedApiClient {
  late final Dio _dio;

  OptimizedApiClient() {
    _dio = Dio(BaseOptions(
      baseUrl: AppConfig.apiBaseUrl,
      connectTimeout: Duration(seconds: 10),
      receiveTimeout: Duration(seconds: 15),
      sendTimeout: Duration(seconds: 10),
    ));

    // æ‹¦æˆªå™¨é…ç½®
    _dio.interceptors.addAll([
      // 1. è¯·æ±‚ç¼“å­˜
      DioCacheInterceptor(options: CacheOptions(
        store: HiveCacheStore(AppConfig.cachePath),
        policy: CachePolicy.request,
        maxStale: Duration(days: 7),
        hitCacheOnErrorExcept: [401, 403],
      )),

      // 2. è¯·æ±‚é‡è¯•
      RetryInterceptor(
        dio: _dio,
        retries: 3,
        retryDelays: [
          Duration(seconds: 1),
          Duration(seconds: 2),
          Duration(seconds: 3),
        ],
      ),

      // 3. è¯·æ±‚æ—¥å¿—ï¼ˆä»…è°ƒè¯•æ¨¡å¼ï¼‰
      if (kDebugMode) LogInterceptor(
        requestBody: true,
        responseBody: true,
      ),
    ]);
  }

  /// å¹¶å‘è¯·æ±‚ä¼˜åŒ–
  Future<List<T>> batchRequest<T>(
    List<Future<T> Function()> requests, {
    int maxConcurrent = 3,
  }) async {
    final results = <T>[];
    for (var i = 0; i < requests.length; i += maxConcurrent) {
      final batch = requests.skip(i).take(maxConcurrent);
      final batchResults = await Future.wait(batch.map((r) => r()));
      results.addAll(batchResults);
    }
    return results;
  }
}

/// è¯·æ±‚åˆå¹¶ - ç›¸åŒè¯·æ±‚å»é‡
class RequestDeduplicator {
  static final Map<String, Future> _pendingRequests = {};

  static Future<T> dedupe<T>(String key, Future<T> Function() request) async {
    if (_pendingRequests.containsKey(key)) {
      return _pendingRequests[key] as Future<T>;
    }

    final future = request();
    _pendingRequests[key] = future;

    try {
      return await future;
    } finally {
      _pendingRequests.remove(key);
    }
  }
}

/// æ•°æ®é¢„å–
class DataPrefetcher {
  /// é¦–é¡µæ•°æ®é¢„å–
  static Future<void> prefetchHomeData(Ref ref) async {
    await Future.wait([
      ref.read(transactionListProvider.notifier).loadRecent(),
      ref.read(statisticsProvider.notifier).loadToday(),
      ref.read(budgetProvider.notifier).loadCurrent(),
    ]);
  }

  /// åå°é™é»˜åˆ·æ–°
  static void scheduleBackgroundRefresh(Ref ref) {
    Timer.periodic(Duration(minutes: 5), (_) {
      if (AppLifecycleState.resumed == WidgetsBinding.instance.lifecycleState) {
        ref.read(syncProvider.notifier).silentSync();
      }
    });
  }
}
```

### 26.4 åç«¯æ€§èƒ½ä¼˜åŒ–

```python
# 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload, joinedload

class TransactionRepository:
    async def get_list_optimized(
        self,
        user_id: UUID,
        page: int = 1,
        page_size: int = 20,
    ) -> list[Transaction]:
        """ä¼˜åŒ–çš„åˆ—è¡¨æŸ¥è¯¢"""
        query = (
            select(Transaction)
            .where(Transaction.user_id == user_id)
            .options(
                # é¢„åŠ è½½å…³è”æ•°æ®ï¼Œé¿å…N+1é—®é¢˜
                selectinload(Transaction.category),
                selectinload(Transaction.account),
            )
            .order_by(Transaction.transaction_date.desc())
            .offset((page - 1) * page_size)
            .limit(page_size)
        )
        result = await self.session.execute(query)
        return result.scalars().all()

    async def get_statistics_optimized(
        self,
        user_id: UUID,
        start_date: date,
        end_date: date,
    ) -> dict:
        """ä½¿ç”¨èšåˆæŸ¥è¯¢ï¼Œé¿å…åŠ è½½å¤§é‡æ•°æ®"""
        query = (
            select(
                Transaction.type,
                func.sum(Transaction.amount).label('total'),
                func.count().label('count'),
            )
            .where(
                Transaction.user_id == user_id,
                Transaction.transaction_date.between(start_date, end_date),
            )
            .group_by(Transaction.type)
        )
        result = await self.session.execute(query)
        return {row.type: {'total': row.total, 'count': row.count} for row in result}


# 2. Redisç¼“å­˜ç­–ç•¥
from redis import asyncio as aioredis
from functools import wraps
import json

class CacheService:
    def __init__(self, redis: aioredis.Redis):
        self.redis = redis

    async def get_or_set(
        self,
        key: str,
        factory: Callable,
        ttl: int = 300,  # 5åˆ†é’Ÿé»˜è®¤
    ):
        """ç¼“å­˜ç©¿é€ä¿æŠ¤"""
        cached = await self.redis.get(key)
        if cached:
            return json.loads(cached)

        # ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
        lock_key = f"lock:{key}"
        if await self.redis.setnx(lock_key, "1"):
            await self.redis.expire(lock_key, 10)
            try:
                data = await factory()
                await self.redis.setex(key, ttl, json.dumps(data))
                return data
            finally:
                await self.redis.delete(lock_key)
        else:
            # ç­‰å¾…å…¶ä»–è¯·æ±‚å®Œæˆ
            await asyncio.sleep(0.1)
            return await self.get_or_set(key, factory, ttl)

    async def invalidate_pattern(self, pattern: str):
        """æ‰¹é‡å¤±æ•ˆç¼“å­˜"""
        keys = await self.redis.keys(pattern)
        if keys:
            await self.redis.delete(*keys)


# ç¼“å­˜è£…é¥°å™¨
def cached(key_template: str, ttl: int = 300):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            cache = get_cache_service()
            key = key_template.format(**kwargs)
            return await cache.get_or_set(key, lambda: func(*args, **kwargs), ttl)
        return wrapper
    return decorator


# 3. æ¥å£å“åº”ä¼˜åŒ–
from fastapi import Response
from fastapi.responses import ORJSONResponse
import orjson

# ä½¿ç”¨æ›´å¿«çš„JSONåºåˆ—åŒ–åº“
app = FastAPI(default_response_class=ORJSONResponse)

# å“åº”å‹ç¼©
from fastapi.middleware.gzip import GZipMiddleware
app.add_middleware(GZipMiddleware, minimum_size=1000)


# 4. è¿æ¥æ± ä¼˜åŒ–
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.pool import AsyncAdaptedQueuePool

engine = create_async_engine(
    DATABASE_URL,
    poolclass=AsyncAdaptedQueuePool,
    pool_size=20,           # è¿æ¥æ± å¤§å°
    max_overflow=30,        # æœ€å¤§æº¢å‡ºè¿æ¥
    pool_timeout=30,        # è¿æ¥è¶…æ—¶
    pool_recycle=1800,      # è¿æ¥å›æ”¶æ—¶é—´
    pool_pre_ping=True,     # è¿æ¥å¥åº·æ£€æŸ¥
)


# 5. å¼‚æ­¥ä»»åŠ¡å¤„ç†
from celery import Celery

celery_app = Celery(
    'tasks',
    broker='redis://localhost:6379/1',
    backend='redis://localhost:6379/2',
)

@celery_app.task(bind=True, max_retries=3)
def process_receipt_async(self, image_data: bytes, user_id: str):
    """å¼‚æ­¥å¤„ç†å°ç¥¨è¯†åˆ«ï¼Œä¸é˜»å¡ä¸»è¯·æ±‚"""
    try:
        result = ocr_service.recognize(image_data)
        # é€šè¿‡WebSocketæˆ–æ¨é€é€šçŸ¥ç”¨æˆ·
        notify_user(user_id, result)
    except Exception as e:
        self.retry(exc=e, countdown=5)
```

### 26.5 æ€§èƒ½ç›‘æ§

```python
# è¯·æ±‚è€—æ—¶ç›‘æ§ä¸­é—´ä»¶
import time
from fastapi import Request
from prometheus_client import Histogram, Counter

REQUEST_LATENCY = Histogram(
    'http_request_duration_seconds',
    'HTTP request latency',
    ['method', 'endpoint', 'status'],
    buckets=[0.1, 0.25, 0.5, 0.75, 1.0, 2.5, 5.0, 10.0]
)

SLOW_REQUEST_COUNTER = Counter(
    'slow_requests_total',
    'Number of requests exceeding 1 second',
    ['method', 'endpoint']
)

@app.middleware("http")
async def performance_monitoring(request: Request, call_next):
    start_time = time.time()

    response = await call_next(request)

    duration = time.time() - start_time
    endpoint = request.url.path
    method = request.method

    # è®°å½•æŒ‡æ ‡
    REQUEST_LATENCY.labels(method, endpoint, response.status_code).observe(duration)

    # è¶…è¿‡1ç§’çš„æ…¢è¯·æ±‚å‘Šè­¦
    if duration > 1.0:
        SLOW_REQUEST_COUNTER.labels(method, endpoint).inc()
        logger.warning(f"Slow request: {method} {endpoint} took {duration:.2f}s")

    # æ·»åŠ å“åº”å¤´
    response.headers["X-Response-Time"] = f"{duration:.3f}s"

    return response
```

```dart
/// Flutterç«¯æ€§èƒ½ç›‘æ§
class PerformanceMonitor {
  static void init() {
    // å¸§ç‡ç›‘æ§
    WidgetsBinding.instance.addTimingsCallback((timings) {
      for (final timing in timings) {
        final buildDuration = timing.buildDuration.inMilliseconds;
        final rasterDuration = timing.rasterDuration.inMilliseconds;

        // ä¸¢å¸§æ£€æµ‹ (è¶…è¿‡16ms)
        if (buildDuration > 16 || rasterDuration > 16) {
          AnalyticsSDK().track('performance', {
            'type': 'frame_drop',
            'build_ms': buildDuration,
            'raster_ms': rasterDuration,
          });
        }
      }
    });
  }

  /// APIè¯·æ±‚è€—æ—¶è¿½è¸ª
  static Future<T> trackApiCall<T>(
    String name,
    Future<T> Function() request,
  ) async {
    final stopwatch = Stopwatch()..start();
    try {
      final result = await request();
      stopwatch.stop();

      AnalyticsSDK().track('performance', {
        'type': 'api_call',
        'name': name,
        'duration_ms': stopwatch.elapsedMilliseconds,
        'success': true,
      });

      // è¶…è¿‡1ç§’è­¦å‘Š
      if (stopwatch.elapsedMilliseconds > 1000) {
        debugPrint('âš ï¸ Slow API: $name took ${stopwatch.elapsedMilliseconds}ms');
      }

      return result;
    } catch (e) {
      stopwatch.stop();
      AnalyticsSDK().track('performance', {
        'type': 'api_call',
        'name': name,
        'duration_ms': stopwatch.elapsedMilliseconds,
        'success': false,
        'error': e.toString(),
      });
      rethrow;
    }
  }
}
```

---

## äºŒåä¸ƒã€å®‰å…¨ä¸éšç§è®¾è®¡

### 27.1 å®‰å…¨æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®‰å…¨æ¶æ„è®¾è®¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ”’ ä¼ è¾“å®‰å…¨                                                     â”‚
â”‚  â”œâ”€â”€ å…¨ç«™HTTPS (TLS 1.3)                                        â”‚
â”‚  â”œâ”€â”€ è¯ä¹¦å›ºå®š (Certificate Pinning)                             â”‚
â”‚  â”œâ”€â”€ HSTSå¼ºåˆ¶HTTPS                                              â”‚
â”‚  â””â”€â”€ æ•æ„Ÿæ•°æ®é¢å¤–åŠ å¯†ä¼ è¾“                                        â”‚
â”‚                                                                  â”‚
â”‚  ğŸ›¡ï¸ åº”ç”¨å®‰å…¨                                                    â”‚
â”‚  â”œâ”€â”€ ä»£ç æ··æ·† (ProGuard/R8)                                     â”‚
â”‚  â”œâ”€â”€ åè°ƒè¯•æ£€æµ‹                                                  â”‚
â”‚  â”œâ”€â”€ å®Œæ•´æ€§æ ¡éªŒ                                                  â”‚
â”‚  â””â”€â”€ å®‰å…¨é”®ç›˜ (é‡‘é¢è¾“å…¥)                                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¾ æ•°æ®å®‰å…¨                                                     â”‚
â”‚  â”œâ”€â”€ æœ¬åœ°æ•°æ®åŠ å¯†å­˜å‚¨                                            â”‚
â”‚  â”œâ”€â”€ æ•æ„Ÿä¿¡æ¯è„±æ•æ˜¾ç¤º                                            â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“å­—æ®µåŠ å¯†                                              â”‚
â”‚  â””â”€â”€ å®‰å…¨åˆ é™¤ (æ•°æ®æ“¦é™¤)                                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ‘¤ èº«ä»½å®‰å…¨                                                     â”‚
â”‚  â”œâ”€â”€ JWT + Refresh Token                                        â”‚
â”‚  â”œâ”€â”€ ç”Ÿç‰©è¯†åˆ«è®¤è¯                                                â”‚
â”‚  â”œâ”€â”€ è®¾å¤‡ç»‘å®š                                                    â”‚
â”‚  â””â”€â”€ å¼‚å¸¸ç™»å½•æ£€æµ‹                                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 27.2 HTTPSä¸ä¼ è¾“å®‰å…¨

```python
# Nginx HTTPSé…ç½®
"""
server {
    listen 443 ssl http2;
    server_name api.aibook.app;

    # TLS 1.3é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/api.aibook.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.aibook.app/privkey.pem;

    # HSTS (å¼ºåˆ¶HTTPS)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # å®‰å…¨å“åº”å¤´
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
}

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name api.aibook.app;
    return 301 https://$server_name$request_uri;
}
"""
```

```dart
/// Flutterè¯ä¹¦å›ºå®š
class SecureHttpClient {
  static Dio createSecureClient() {
    final dio = Dio();

    // è¯ä¹¦å›ºå®š
    (dio.httpClientAdapter as IOHttpClientAdapter).onHttpClientCreate = (client) {
      client.badCertificateCallback = (cert, host, port) {
        // éªŒè¯è¯ä¹¦æŒ‡çº¹
        final fingerprint = sha256.convert(cert.der).toString();
        final trustedFingerprints = [
          'ABC123...', // ç”Ÿäº§ç¯å¢ƒè¯ä¹¦æŒ‡çº¹
          'DEF456...', // å¤‡ç”¨è¯ä¹¦æŒ‡çº¹
        ];
        return trustedFingerprints.contains(fingerprint);
      };
      return client;
    };

    return dio;
  }
}

/// æ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“
class SecureTransmission {
  static final _key = encrypt.Key.fromSecureRandom(32);
  static final _encrypter = encrypt.Encrypter(encrypt.AES(_key));

  /// åŠ å¯†æ•æ„Ÿè¯·æ±‚æ•°æ®
  static String encryptPayload(Map<String, dynamic> data) {
    final json = jsonEncode(data);
    final iv = encrypt.IV.fromSecureRandom(16);
    final encrypted = _encrypter.encrypt(json, iv: iv);
    return '${iv.base64}:${encrypted.base64}';
  }

  /// è§£å¯†å“åº”æ•°æ®
  static Map<String, dynamic> decryptPayload(String encrypted) {
    final parts = encrypted.split(':');
    final iv = encrypt.IV.fromBase64(parts[0]);
    final decrypted = _encrypter.decrypt64(parts[1], iv: iv);
    return jsonDecode(decrypted);
  }
}
```

### 27.3 æœ¬åœ°æ•°æ®å®‰å…¨

```dart
/// å®‰å…¨å­˜å‚¨æœåŠ¡
class SecureStorageService {
  static final _secureStorage = FlutterSecureStorage(
    aOptions: AndroidOptions(
      encryptedSharedPreferences: true,
      keyCipherAlgorithm: KeyCipherAlgorithm.RSA_ECB_OAEPwithSHA_256andMGF1Padding,
      storageCipherAlgorithm: StorageCipherAlgorithm.AES_GCM_NoPadding,
    ),
    iOptions: IOSOptions(
      accessibility: KeychainAccessibility.first_unlock_this_device,
    ),
  );

  /// å­˜å‚¨æ•æ„Ÿæ•°æ®
  static Future<void> saveSecure(String key, String value) async {
    await _secureStorage.write(key: key, value: value);
  }

  /// è¯»å–æ•æ„Ÿæ•°æ®
  static Future<String?> readSecure(String key) async {
    return await _secureStorage.read(key: key);
  }

  /// åˆ é™¤æ•æ„Ÿæ•°æ®
  static Future<void> deleteSecure(String key) async {
    await _secureStorage.delete(key: key);
  }

  /// å®‰å…¨æ¸…é™¤æ‰€æœ‰æ•°æ®
  static Future<void> clearAll() async {
    await _secureStorage.deleteAll();
  }
}

/// æ•°æ®åº“åŠ å¯†
class EncryptedDatabase {
  static Future<Database> open() async {
    // ç”Ÿæˆæˆ–è·å–åŠ å¯†å¯†é’¥
    var key = await SecureStorageService.readSecure('db_key');
    if (key == null) {
      key = base64Encode(List<int>.generate(32, (_) => Random.secure().nextInt(256)));
      await SecureStorageService.saveSecure('db_key', key);
    }

    final path = await getDatabasesPath();
    final dbPath = join(path, 'aibook_encrypted.db');

    return openDatabase(
      dbPath,
      password: key,  // SQLCipheråŠ å¯†
      version: 1,
      onCreate: (db, version) async {
        // åˆ›å»ºè¡¨ç»“æ„
      },
    );
  }
}

/// æ•æ„Ÿä¿¡æ¯è„±æ•æ˜¾ç¤º
class DataMasker {
  /// æ‰‹æœºå·è„±æ•: 138****8888
  static String maskPhone(String phone) {
    if (phone.length != 11) return phone;
    return '${phone.substring(0, 3)}****${phone.substring(7)}';
  }

  /// é‚®ç®±è„±æ•: t***@example.com
  static String maskEmail(String email) {
    final parts = email.split('@');
    if (parts.length != 2) return email;
    final name = parts[0];
    final masked = name.length > 1
        ? '${name[0]}${'*' * (name.length - 1)}'
        : name;
    return '$masked@${parts[1]}';
  }

  /// é‡‘é¢è„±æ•ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰
  static String maskAmount(double amount, {bool show = true}) {
    return show ? 'Â¥${amount.toStringAsFixed(2)}' : 'Â¥****';
  }

  /// é“¶è¡Œå¡å·è„±æ•: **** **** **** 1234
  static String maskBankCard(String cardNo) {
    if (cardNo.length < 4) return cardNo;
    return '**** **** **** ${cardNo.substring(cardNo.length - 4)}';
  }
}
```

### 27.4 èº«ä»½è®¤è¯å®‰å…¨

```python
# JWTå®‰å…¨é…ç½®
from datetime import datetime, timedelta
from jose import jwt, JWTError
from passlib.context import CryptContext
import secrets

class AuthSecurity:
    # å¯†ç åŠ å¯†
    pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

    # JWTé…ç½®
    SECRET_KEY = os.getenv("JWT_SECRET_KEY")  # è‡³å°‘256ä½
    ALGORITHM = "HS256"
    ACCESS_TOKEN_EXPIRE = timedelta(minutes=30)
    REFRESH_TOKEN_EXPIRE = timedelta(days=30)

    @classmethod
    def hash_password(cls, password: str) -> str:
        return cls.pwd_context.hash(password)

    @classmethod
    def verify_password(cls, plain: str, hashed: str) -> bool:
        return cls.pwd_context.verify(plain, hashed)

    @classmethod
    def create_access_token(cls, user_id: str, device_id: str) -> str:
        expire = datetime.utcnow() + cls.ACCESS_TOKEN_EXPIRE
        payload = {
            "sub": user_id,
            "device_id": device_id,
            "exp": expire,
            "iat": datetime.utcnow(),
            "jti": secrets.token_urlsafe(16),  # å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºæ’¤é”€
        }
        return jwt.encode(payload, cls.SECRET_KEY, algorithm=cls.ALGORITHM)

    @classmethod
    def create_refresh_token(cls, user_id: str, device_id: str) -> str:
        expire = datetime.utcnow() + cls.REFRESH_TOKEN_EXPIRE
        payload = {
            "sub": user_id,
            "device_id": device_id,
            "exp": expire,
            "type": "refresh",
            "jti": secrets.token_urlsafe(16),
        }
        return jwt.encode(payload, cls.SECRET_KEY, algorithm=cls.ALGORITHM)


# ç™»å½•å®‰å…¨ç­–ç•¥
class LoginSecurity:
    MAX_ATTEMPTS = 5
    LOCKOUT_DURATION = timedelta(minutes=30)

    def __init__(self, redis: Redis):
        self.redis = redis

    async def check_login_allowed(self, identifier: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å…è®¸ç™»å½•"""
        key = f"login_attempts:{identifier}"
        attempts = await self.redis.get(key)
        return int(attempts or 0) < self.MAX_ATTEMPTS

    async def record_failed_attempt(self, identifier: str):
        """è®°å½•å¤±è´¥å°è¯•"""
        key = f"login_attempts:{identifier}"
        pipe = self.redis.pipeline()
        pipe.incr(key)
        pipe.expire(key, int(self.LOCKOUT_DURATION.total_seconds()))
        await pipe.execute()

    async def clear_attempts(self, identifier: str):
        """ç™»å½•æˆåŠŸåæ¸…é™¤è®°å½•"""
        await self.redis.delete(f"login_attempts:{identifier}")

    async def detect_anomaly(self, user_id: str, request: Request) -> bool:
        """å¼‚å¸¸ç™»å½•æ£€æµ‹"""
        current_ip = request.client.host
        current_device = request.headers.get("X-Device-ID")

        # è·å–å†å²ç™»å½•è®°å½•
        history_key = f"login_history:{user_id}"
        history = await self.redis.lrange(history_key, 0, 10)

        # æ£€æµ‹å¼‚å¸¸
        for record in history:
            data = json.loads(record)
            # çŸ­æ—¶é—´å†…ä»ä¸åŒåœ°åŒºç™»å½•
            if data["ip"] != current_ip:
                # å¯ä»¥é€šè¿‡IPåœ°ç†ä½ç½®åˆ¤æ–­
                return True

        return False
```

```dart
/// ç”Ÿç‰©è¯†åˆ«è®¤è¯
class BiometricAuth {
  static final _auth = LocalAuthentication();

  static Future<bool> isAvailable() async {
    final canCheck = await _auth.canCheckBiometrics;
    final isDeviceSupported = await _auth.isDeviceSupported();
    return canCheck && isDeviceSupported;
  }

  static Future<bool> authenticate({String reason = 'è¯·éªŒè¯èº«ä»½'}) async {
    try {
      return await _auth.authenticate(
        localizedReason: reason,
        options: AuthenticationOptions(
          stickyAuth: true,
          biometricOnly: false,  // å…è®¸PIN/å¯†ç ä½œä¸ºåå¤‡
        ),
      );
    } on PlatformException {
      return false;
    }
  }
}

/// åº”ç”¨é”
class AppLock {
  static const _lockTimeoutKey = 'app_lock_timeout';
  static const _lastActiveKey = 'last_active_time';

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è®¤è¯
  static Future<bool> needsAuthentication() async {
    final prefs = await SharedPreferences.getInstance();
    final timeout = prefs.getInt(_lockTimeoutKey) ?? 300000; // é»˜è®¤5åˆ†é’Ÿ
    final lastActive = prefs.getInt(_lastActiveKey) ?? 0;
    final now = DateTime.now().millisecondsSinceEpoch;

    return (now - lastActive) > timeout;
  }

  /// æ›´æ–°æ´»è·ƒæ—¶é—´
  static Future<void> updateLastActive() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt(_lastActiveKey, DateTime.now().millisecondsSinceEpoch);
  }
}
```

### 27.5 APIå®‰å…¨

```python
from fastapi import Security, HTTPException
from fastapi.security import APIKeyHeader
import hmac
import hashlib
import time

# è¯·æ±‚ç­¾åéªŒè¯
class RequestSigner:
    def __init__(self, secret_key: str):
        self.secret_key = secret_key

    def sign(self, method: str, path: str, timestamp: int, body: str = "") -> str:
        """ç”Ÿæˆè¯·æ±‚ç­¾å"""
        message = f"{method}\n{path}\n{timestamp}\n{body}"
        signature = hmac.new(
            self.secret_key.encode(),
            message.encode(),
            hashlib.sha256
        ).hexdigest()
        return signature

    def verify(self, signature: str, method: str, path: str, timestamp: int, body: str = "") -> bool:
        """éªŒè¯ç­¾å"""
        # æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
        if abs(time.time() - timestamp) > 300:
            return False

        expected = self.sign(method, path, timestamp, body)
        return hmac.compare_digest(signature, expected)


# APIé™æµ
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.get("/api/v1/transactions")
@limiter.limit("100/minute")  # æ¯åˆ†é’Ÿ100æ¬¡
async def get_transactions(request: Request):
    pass

@app.post("/api/v1/auth/login")
@limiter.limit("5/minute")  # ç™»å½•æ¥å£æ›´ä¸¥æ ¼
async def login(request: Request):
    pass


# SQLæ³¨å…¥é˜²æŠ¤ - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
from sqlalchemy import text

# âŒ å±é™©å†™æ³•
# query = f"SELECT * FROM users WHERE id = '{user_id}'"

# âœ… å®‰å…¨å†™æ³•
query = text("SELECT * FROM users WHERE id = :user_id")
result = await session.execute(query, {"user_id": user_id})


# XSSé˜²æŠ¤ - è¾“å‡ºç¼–ç 
from markupsafe import escape

@app.get("/api/v1/user/profile")
async def get_profile(user_id: str):
    user = await get_user(user_id)
    return {
        "name": escape(user.name),  # HTMLå®ä½“ç¼–ç 
        "bio": escape(user.bio),
    }


# CORSé…ç½®
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://aibook.app"],  # ä¸¥æ ¼é™åˆ¶æ¥æº
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)
```

### 27.6 éšç§ä¿æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        éšç§ä¿æŠ¤æªæ–½                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“‹ æ•°æ®æ”¶é›†åŸåˆ™                                                 â”‚
â”‚  â”œâ”€â”€ æœ€å°å¿…è¦: åªæ”¶é›†ä¸šåŠ¡å¿…éœ€çš„æ•°æ®                               â”‚
â”‚  â”œâ”€â”€ æ˜ç¡®å‘ŠçŸ¥: åœ¨éšç§æ”¿ç­–ä¸­æ¸…æ™°è¯´æ˜                               â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·æˆæƒ: æ•æ„Ÿæƒé™å¿…é¡»ç”¨æˆ·åŒæ„                               â”‚
â”‚  â””â”€â”€ å¯æ§å¯åˆ : ç”¨æˆ·å¯æŸ¥çœ‹å’Œåˆ é™¤è‡ªå·±çš„æ•°æ®                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” æ•°æ®åˆ†ç±»                                                     â”‚
â”‚  â”œâ”€â”€ å…¬å¼€æ•°æ®: ç”¨æˆ·åã€å¤´åƒ                                       â”‚
â”‚  â”œâ”€â”€ ç§å¯†æ•°æ®: äº¤æ˜“è®°å½•ã€ä½™é¢ï¼ˆä»…ç”¨æˆ·å¯è§ï¼‰                        â”‚
â”‚  â”œâ”€â”€ æ•æ„Ÿæ•°æ®: æ‰‹æœºå·ã€é‚®ç®±ã€é“¶è¡Œå¡ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰                    â”‚
â”‚  â””â”€â”€ æ ¸å¿ƒæ•°æ®: å¯†ç ã€Tokenï¼ˆä¸å¯é€†åŠ å¯†ï¼‰                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸš« ç¦æ­¢è¡Œä¸º                                                     â”‚
â”‚  â”œâ”€â”€ ç¦æ­¢å‡ºå”®ç”¨æˆ·æ•°æ®                                            â”‚
â”‚  â”œâ”€â”€ ç¦æ­¢æœªæˆæƒåˆ†äº«ç»™ç¬¬ä¸‰æ–¹                                       â”‚
â”‚  â”œâ”€â”€ ç¦æ­¢ç”¨äºç”¨æˆ·ç”»åƒè¥é”€                                         â”‚
â”‚  â””â”€â”€ ç¦æ­¢è¿‡åº¦æ”¶é›†ä¸ä¸šåŠ¡æ— å…³çš„ä¿¡æ¯                                 â”‚
â”‚                                                                  â”‚
â”‚  âš–ï¸ åˆè§„è¦æ±‚                                                     â”‚
â”‚  â”œâ”€â”€ ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹                                          â”‚
â”‚  â”œâ”€â”€ ã€Šæ•°æ®å®‰å…¨æ³•ã€‹                                              â”‚
â”‚  â”œâ”€â”€ ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹                                              â”‚
â”‚  â””â”€â”€ App Store / Google Play éšç§æ”¿ç­–                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
# ç”¨æˆ·æ•°æ®å¯¼å‡º (GDPRåˆè§„)
class DataExportService:
    async def export_user_data(self, user_id: UUID) -> dict:
        """å¯¼å‡ºç”¨æˆ·æ‰€æœ‰æ•°æ®"""
        user = await self.user_repo.get(user_id)
        transactions = await self.transaction_repo.get_all_by_user(user_id)
        accounts = await self.account_repo.get_all_by_user(user_id)

        return {
            "export_date": datetime.utcnow().isoformat(),
            "user_info": {
                "id": str(user.id),
                "phone": DataMasker.mask_phone(user.phone),
                "email": user.email,
                "created_at": user.created_at.isoformat(),
            },
            "accounts": [acc.to_export_dict() for acc in accounts],
            "transactions": [tx.to_export_dict() for tx in transactions],
        }


# ç”¨æˆ·æ•°æ®åˆ é™¤ (æ³¨é”€è´¦æˆ·)
class AccountDeletionService:
    async def delete_account(self, user_id: UUID):
        """å½»åº•åˆ é™¤ç”¨æˆ·æ•°æ®"""
        async with self.db.begin():
            # 1. åˆ é™¤äº¤æ˜“è®°å½•
            await self.transaction_repo.delete_all_by_user(user_id)

            # 2. åˆ é™¤è´¦æˆ·
            await self.account_repo.delete_all_by_user(user_id)

            # 3. åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼Œä¿ç•™30å¤©ï¼‰
            await self.user_repo.soft_delete(user_id)

            # 4. æ¸…é™¤ç¼“å­˜
            await self.cache.invalidate_pattern(f"user:{user_id}:*")

        # 5. å¼‚æ­¥æ¸…ç†ï¼ˆ30å¤©åå½»åº•åˆ é™¤ï¼‰
        schedule_permanent_deletion.delay(str(user_id), days=30)
```

---

## äºŒåå…«ã€ç”¨æˆ·åè®®ç³»ç»Ÿ

### 28.1 åè®®ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·åè®®ä½“ç³»                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“œ å¿…ç­¾åè®®                                                     â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·æœåŠ¡åè®® (Terms of Service)                             â”‚
â”‚  â”œâ”€â”€ éšç§æ”¿ç­– (Privacy Policy)                                   â”‚
â”‚  â””â”€â”€ å„¿ç«¥éšç§ä¿æŠ¤å£°æ˜ (å¦‚é€‚ç”¨)                                    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“‹ å¯é€‰åè®®                                                     â”‚
â”‚  â”œâ”€â”€ ä¼šå‘˜æœåŠ¡åè®® (è´­ä¹°ä¼šå‘˜æ—¶)                                    â”‚
â”‚  â”œâ”€â”€ ç¬¬ä¸‰æ–¹æ”¯ä»˜åè®® (ä½¿ç”¨æ”¯ä»˜åŠŸèƒ½æ—¶)                              â”‚
â”‚  â””â”€â”€ è¥é”€ä¿¡æ¯æ¥æ”¶åŒæ„ä¹¦                                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”„ åè®®æ›´æ–°æœºåˆ¶                                                 â”‚
â”‚  â”œâ”€â”€ é‡å¤§æ›´æ–°éœ€é‡æ–°ç¡®è®¤                                          â”‚
â”‚  â”œâ”€â”€ æ›´æ–°å…¬å‘Šæå‰7å¤©é€šçŸ¥                                         â”‚
â”‚  â””â”€â”€ ä¸åŒæ„å¯é€‰æ‹©æ³¨é”€è´¦æˆ·                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 28.2 ç”¨æˆ·æœåŠ¡åè®®å†…å®¹

```markdown
# AIæ™ºèƒ½è®°è´¦ç”¨æˆ·æœåŠ¡åè®®

æ›´æ–°æ—¥æœŸï¼š2025å¹´1æœˆ1æ—¥
ç”Ÿæ•ˆæ—¥æœŸï¼š2025å¹´1æœˆ1æ—¥

## ä¸€ã€åè®®çš„æ¥å—ä¸ä¿®æ”¹

1.1 æ¬¢è¿ä½¿ç”¨AIæ™ºèƒ½è®°è´¦ï¼ˆä»¥ä¸‹ç®€ç§°"æœ¬åº”ç”¨"ï¼‰ã€‚æœ¬åè®®æ˜¯æ‚¨ä¸[å…¬å¸åç§°]ä¹‹é—´å…³äºä½¿ç”¨æœ¬åº”ç”¨æœåŠ¡çš„æ³•å¾‹åè®®ã€‚

1.2 æ‚¨åœ¨æ³¨å†Œã€ç™»å½•æˆ–ä½¿ç”¨æœ¬åº”ç”¨æ—¶ï¼Œå³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æ¥å—æœ¬åè®®çš„å…¨éƒ¨æ¡æ¬¾ã€‚

1.3 æˆ‘ä»¬ä¿ç•™éšæ—¶ä¿®æ”¹æœ¬åè®®çš„æƒåˆ©ï¼Œä¿®æ”¹åçš„åè®®å°†é€šè¿‡åº”ç”¨å†…é€šçŸ¥æˆ–å…¶ä»–æ–¹å¼å‘ŠçŸ¥æ‚¨ã€‚

## äºŒã€æœåŠ¡å†…å®¹

2.1 æœ¬åº”ç”¨æä¾›ä»¥ä¸‹æœåŠ¡ï¼š
- æ‰‹åŠ¨è®°è´¦åŠŸèƒ½
- å›¾ç‰‡è¯†åˆ«è®°è´¦
- è¯­éŸ³è®°è´¦
- é‚®ç®±è´¦å•è§£æ
- ç»Ÿè®¡æŠ¥è¡¨åˆ†æ
- é¢„ç®—ç®¡ç†
- å¤šè´¦æœ¬ç®¡ç†
- æ•°æ®åŒæ­¥ä¸å¤‡ä»½

2.2 éƒ¨åˆ†åŠŸèƒ½éœ€è¦ä»˜è´¹ä¼šå‘˜æ‰èƒ½ä½¿ç”¨ï¼Œå…·ä½“ä»¥åº”ç”¨å†…æ ‡è¯†ä¸ºå‡†ã€‚

## ä¸‰ã€ç”¨æˆ·è´¦æˆ·

3.1 æ‚¨éœ€è¦æ³¨å†Œè´¦æˆ·æ‰èƒ½ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚æ³¨å†Œæ—¶éœ€æä¾›çœŸå®ã€å‡†ç¡®çš„ä¿¡æ¯ã€‚

3.2 æ‚¨æœ‰è´£ä»»å¦¥å–„ä¿ç®¡è´¦æˆ·ä¿¡æ¯ï¼Œå› è´¦æˆ·æ³„éœ²å¯¼è‡´çš„æŸå¤±ç”±æ‚¨è‡ªè¡Œæ‰¿æ‹…ã€‚

3.3 æ¯ä½ç”¨æˆ·åªèƒ½æ³¨å†Œä¸€ä¸ªè´¦æˆ·ï¼Œç¦æ­¢è½¬è®©ã€å‡ºå€Ÿè´¦æˆ·ã€‚

## å››ã€ç”¨æˆ·è¡Œä¸ºè§„èŒƒ

4.1 æ‚¨åŒæ„ä¸ä¼šåˆ©ç”¨æœ¬åº”ç”¨ï¼š
- ä»äº‹ä»»ä½•è¿æ³•æ´»åŠ¨
- ä¸Šä¼ è™šå‡ã€æ¬ºè¯ˆæ€§å†…å®¹
- ä¾µçŠ¯ä»–äººçŸ¥è¯†äº§æƒ
- ä¼ æ’­æ¶æ„è½¯ä»¶æˆ–ç—…æ¯’
- å¹²æ‰°æˆ–ç ´ååº”ç”¨æ­£å¸¸è¿è¡Œ
- æœªç»æˆæƒè®¿é—®ä»–äººè´¦æˆ·

4.2 è¿åä¸Šè¿°è§„èŒƒï¼Œæˆ‘ä»¬æœ‰æƒæš‚åœæˆ–ç»ˆæ­¢æ‚¨çš„è´¦æˆ·ã€‚

## äº”ã€çŸ¥è¯†äº§æƒ

5.1 æœ¬åº”ç”¨çš„æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºæ–‡å­—ã€å›¾ç‰‡ã€ä»£ç ã€å•†æ ‡ï¼‰å‡å—çŸ¥è¯†äº§æƒæ³•ä¿æŠ¤ã€‚

5.2 æ‚¨åœ¨ä½¿ç”¨æœ¬åº”ç”¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®ï¼Œå…¶æ‰€æœ‰æƒå½’æ‚¨æ‰€æœ‰ï¼Œä½†æ‚¨æˆæƒæˆ‘ä»¬ä¸ºæä¾›æœåŠ¡è€Œå¿…è¦çš„ä½¿ç”¨æƒã€‚

## å…­ã€éšç§ä¿æŠ¤

6.1 æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ä¿æŠ¤ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…ã€Šéšç§æ”¿ç­–ã€‹ã€‚

6.2 æœªç»æ‚¨åŒæ„ï¼Œæˆ‘ä»¬ä¸ä¼šå‘ç¬¬ä¸‰æ–¹æŠ«éœ²æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œæ³•å¾‹è¦æ±‚é™¤å¤–ã€‚

## ä¸ƒã€æœåŠ¡çš„ä¸­æ–­ä¸ç»ˆæ­¢

7.1 æˆ‘ä»¬å¯èƒ½å› ç»´æŠ¤ã€å‡çº§æˆ–ä¸å¯æŠ—åŠ›æš‚åœæœåŠ¡ï¼Œå°†å°½é‡æå‰é€šçŸ¥ã€‚

7.2 æ‚¨å¯éšæ—¶æ³¨é”€è´¦æˆ·ï¼Œæ³¨é”€åæ•°æ®å°†æŒ‰éšç§æ”¿ç­–å¤„ç†ã€‚

7.3 å¦‚æ‚¨ä¸¥é‡è¿åæœ¬åè®®ï¼Œæˆ‘ä»¬æœ‰æƒç»ˆæ­¢æœåŠ¡å¹¶ä¸äºˆé€€æ¬¾ã€‚

## å…«ã€å…è´£å£°æ˜

8.1 æœ¬åº”ç”¨æä¾›çš„AIè¯†åˆ«åŠŸèƒ½å¯èƒ½å­˜åœ¨è¯¯å·®ï¼Œè¯·æ‚¨æ ¸å®åç¡®è®¤ã€‚

8.2 æˆ‘ä»¬ä¸å¯¹å› ç½‘ç»œä¸­æ–­ã€ç³»ç»Ÿæ•…éšœç­‰å¯¼è‡´çš„æœåŠ¡ä¸­æ–­æ‰¿æ‹…è´£ä»»ã€‚

8.3 æœ¬åº”ç”¨ä»…ä¸ºè®°è´¦å·¥å…·ï¼Œä¸æä¾›æŠ•èµ„å»ºè®®ï¼Œæ‚¨çš„è´¢åŠ¡å†³ç­–ç”±æ‚¨è‡ªè¡Œè´Ÿè´£ã€‚

## ä¹ã€ä»˜è´¹æœåŠ¡

9.1 ä¼šå‘˜æœåŠ¡é‡‡ç”¨è®¢é˜…åˆ¶ï¼Œå…·ä½“ä»·æ ¼ä»¥åº”ç”¨å†…å±•ç¤ºä¸ºå‡†ã€‚

9.2 è®¢é˜…è‡ªåŠ¨ç»­è´¹ï¼Œæ‚¨å¯éšæ—¶åœ¨è´¦æˆ·è®¾ç½®ä¸­å–æ¶ˆã€‚

9.3 å·²è´­ä¹°çš„æœåŠ¡ï¼Œé™¤æ³•å¾‹è§„å®šå¤–ï¼Œä¸€èˆ¬ä¸äºˆé€€æ¬¾ã€‚

## åã€äº‰è®®è§£å†³

10.1 æœ¬åè®®é€‚ç”¨ä¸­åäººæ°‘å…±å’Œå›½æ³•å¾‹ã€‚

10.2 å› æœ¬åè®®äº§ç”Ÿçš„äº‰è®®ï¼ŒåŒæ–¹åº”åå•†è§£å†³ï¼›åå•†ä¸æˆï¼Œæäº¤[ä»²è£æœºæ„]ä»²è£ã€‚

## åä¸€ã€è”ç³»æˆ‘ä»¬

å¦‚æœ‰ç–‘é—®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- é‚®ç®±ï¼šsupport@aibook.app
- åº”ç”¨å†…åé¦ˆåŠŸèƒ½

---
[å…¬å¸åç§°] ä¿ç•™æœ¬åè®®çš„æœ€ç»ˆè§£é‡Šæƒã€‚
```

### 28.3 éšç§æ”¿ç­–å†…å®¹

```markdown
# AIæ™ºèƒ½è®°è´¦éšç§æ”¿ç­–

æ›´æ–°æ—¥æœŸï¼š2025å¹´1æœˆ1æ—¥
ç”Ÿæ•ˆæ—¥æœŸï¼š2025å¹´1æœˆ1æ—¥

## å¼•è¨€

[å…¬å¸åç§°]ï¼ˆä»¥ä¸‹ç®€ç§°"æˆ‘ä»¬"ï¼‰æ·±çŸ¥ä¸ªäººä¿¡æ¯å¯¹æ‚¨çš„é‡è¦æ€§ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§æ³•å¾‹æ³•è§„è¦æ±‚ï¼Œé‡‡å–ç›¸åº”å®‰å…¨ä¿æŠ¤æªæ–½ï¼Œä¿æŠ¤æ‚¨çš„ä¸ªäººä¿¡æ¯å®‰å…¨å¯æ§ã€‚

## ä¸€ã€æˆ‘ä»¬æ”¶é›†çš„ä¿¡æ¯

### 1.1 æ‚¨ä¸»åŠ¨æä¾›çš„ä¿¡æ¯
| ä¿¡æ¯ç±»å‹ | æ”¶é›†ç›®çš„ | æ˜¯å¦å¿…é¡» |
|---------|---------|---------|
| æ‰‹æœºå·ç  | è´¦æˆ·æ³¨å†Œä¸ç™»å½• | æ˜¯ |
| é‚®ç®±åœ°å€ | è´¦å•è§£æã€é€šçŸ¥ | å¦ |
| å¤´åƒã€æ˜µç§° | ä¸ªäººèµ„æ–™å±•ç¤º | å¦ |
| äº¤æ˜“è®°å½• | æ ¸å¿ƒè®°è´¦åŠŸèƒ½ | æ˜¯ |

### 1.2 è‡ªåŠ¨æ”¶é›†çš„ä¿¡æ¯
| ä¿¡æ¯ç±»å‹ | æ”¶é›†ç›®çš„ | æ˜¯å¦å¿…é¡» |
|---------|---------|---------|
| è®¾å¤‡æ ‡è¯†ç¬¦ | å®‰å…¨é˜²æŠ¤ã€è´¦æˆ·ä¿æŠ¤ | æ˜¯ |
| æ“ä½œç³»ç»Ÿç‰ˆæœ¬ | å…¼å®¹æ€§é€‚é… | æ˜¯ |
| åº”ç”¨ä½¿ç”¨æ•°æ® | äº§å“ä¼˜åŒ–æ”¹è¿› | å¦ï¼ˆå¯å…³é—­ï¼‰|
| å´©æºƒæ—¥å¿— | é—®é¢˜æ’æŸ¥ä¿®å¤ | æ˜¯ |

### 1.3 æ•æ„Ÿä¿¡æ¯è¯´æ˜
- **ç›¸æœºæƒé™**ï¼šç”¨äºæ‹ç…§è®°è´¦ï¼Œä»…åœ¨æ‚¨ä¸»åŠ¨ä½¿ç”¨æ—¶è°ƒç”¨
- **éº¦å…‹é£æƒé™**ï¼šç”¨äºè¯­éŸ³è®°è´¦ï¼Œä»…åœ¨æ‚¨ä¸»åŠ¨ä½¿ç”¨æ—¶è°ƒç”¨
- **ç›¸å†Œæƒé™**ï¼šç”¨äºé€‰æ‹©å›¾ç‰‡è¯†åˆ«ï¼Œä»…è¯»å–æ‚¨é€‰æ‹©çš„å›¾ç‰‡

## äºŒã€ä¿¡æ¯çš„ä½¿ç”¨

æˆ‘ä»¬æ”¶é›†çš„ä¿¡æ¯å°†ç”¨äºï¼š
1. æä¾›ã€ç»´æŠ¤å’Œæ”¹è¿›æˆ‘ä»¬çš„æœåŠ¡
2. å¤„ç†æ‚¨çš„è¯·æ±‚å’Œäº¤æ˜“
3. å‘é€æœåŠ¡ç›¸å…³é€šçŸ¥
4. å®‰å…¨é˜²æŠ¤å’Œæ¬ºè¯ˆæ£€æµ‹
5. éµå®ˆæ³•å¾‹ä¹‰åŠ¡

**æˆ‘ä»¬æ‰¿è¯ºä¸ä¼š**ï¼š
- å‡ºå”®æ‚¨çš„ä¸ªäººä¿¡æ¯
- å°†æ‚¨çš„ä¿¡æ¯ç”¨äºæœªç»åŒæ„çš„è¥é”€
- ä¸æ— å…³ç¬¬ä¸‰æ–¹åˆ†äº«æ‚¨çš„æ•°æ®

## ä¸‰ã€ä¿¡æ¯çš„å­˜å‚¨

3.1 **å­˜å‚¨åœ°ç‚¹**ï¼šæ‚¨çš„æ•°æ®å­˜å‚¨åœ¨ä½äºä¸­å›½å¢ƒå†…çš„æœåŠ¡å™¨ã€‚

3.2 **å­˜å‚¨æœŸé™**ï¼š
- è´¦æˆ·ä¿¡æ¯ï¼šè´¦æˆ·å­˜ç»­æœŸé—´åŠæ³¨é”€å30å¤©
- äº¤æ˜“è®°å½•ï¼šæŒ‰ç…§è´¢åŠ¡å‡­è¯ä¿ç®¡è¦æ±‚ä¿å­˜
- æ—¥å¿—æ•°æ®ï¼šæœ€é•¿ä¿å­˜90å¤©

3.3 **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿä¿¡æ¯é‡‡ç”¨AES-256åŠ å¯†å­˜å‚¨ã€‚

## å››ã€ä¿¡æ¯çš„å…±äº«

æˆ‘ä»¬ä»…åœ¨ä»¥ä¸‹æƒ…å†µå…±äº«æ‚¨çš„ä¿¡æ¯ï¼š

4.1 **ç»æ‚¨åŒæ„**ï¼šè·å¾—æ‚¨æ˜ç¡®åŒæ„åçš„å…±äº«

4.2 **æœåŠ¡æä¾›å•†**ï¼š
| åˆä½œæ–¹ | å…±äº«å†…å®¹ | ç”¨é€” |
|-------|---------|------|
| é˜¿é‡Œäº‘ | åŠ å¯†å­˜å‚¨æ•°æ® | äº‘æœåŠ¡æ‰˜ç®¡ |
| å¾®ä¿¡/æ”¯ä»˜å® | è®¢å•ä¿¡æ¯ | æ”¯ä»˜å¤„ç† |
| çŸ­ä¿¡æœåŠ¡å•† | æ‰‹æœºå· | éªŒè¯ç å‘é€ |

4.3 **æ³•å¾‹è¦æ±‚**ï¼šæ ¹æ®æ³•å¾‹æ³•è§„æˆ–æ”¿åºœè¦æ±‚

## äº”ã€æ‚¨çš„æƒåˆ©

æ‚¨å¯¹ä¸ªäººä¿¡æ¯äº«æœ‰ä»¥ä¸‹æƒåˆ©ï¼š

5.1 **æŸ¥é˜…æƒ**ï¼šæŸ¥çœ‹æ‚¨çš„ä¸ªäººä¿¡æ¯
   - è·¯å¾„ï¼šè®¾ç½® â†’ éšç§ â†’ ä¸ªäººä¿¡æ¯

5.2 **æ›´æ­£æƒ**ï¼šæ›´æ­£ä¸å‡†ç¡®çš„ä¿¡æ¯
   - è·¯å¾„ï¼šè®¾ç½® â†’ è´¦æˆ· â†’ ç¼–è¾‘èµ„æ–™

5.3 **åˆ é™¤æƒ**ï¼šåˆ é™¤æ‚¨çš„ä¿¡æ¯
   - è·¯å¾„ï¼šè®¾ç½® â†’ è´¦æˆ· â†’ æ³¨é”€è´¦æˆ·

5.4 **å¯¼å‡ºæƒ**ï¼šå¯¼å‡ºæ‚¨çš„æ•°æ®
   - è·¯å¾„ï¼šè®¾ç½® â†’ æ•°æ® â†’ å¯¼å‡ºæˆ‘çš„æ•°æ®

5.5 **æ’¤å›åŒæ„**ï¼šæ’¤å›æˆæƒåŒæ„
   - è·¯å¾„ï¼šè®¾ç½® â†’ éšç§ â†’ æƒé™ç®¡ç†

## å…­ã€æœªæˆå¹´äººä¿æŠ¤

6.1 æœ¬åº”ç”¨ä¸é¢å‘14å‘¨å²ä»¥ä¸‹å„¿ç«¥ã€‚

6.2 å¦‚æœæˆ‘ä»¬å‘ç°åœ¨æœªç»ç›‘æŠ¤äººåŒæ„çš„æƒ…å†µä¸‹æ”¶é›†äº†å„¿ç«¥ä¿¡æ¯ï¼Œå°†å°½å¿«åˆ é™¤ã€‚

6.3 ç›‘æŠ¤äººå¦‚æœ‰ç–‘é—®ï¼Œè¯·é€šè¿‡æ–‡æœ«æ–¹å¼è”ç³»æˆ‘ä»¬ã€‚

## ä¸ƒã€Cookieå’Œç±»ä¼¼æŠ€æœ¯

7.1 æˆ‘ä»¬ä½¿ç”¨Cookieå’Œç±»ä¼¼æŠ€æœ¯æ¥ï¼š
- è®°ä½æ‚¨çš„ç™»å½•çŠ¶æ€
- åˆ†æåº”ç”¨ä½¿ç”¨æƒ…å†µ
- æä¾›ä¸ªæ€§åŒ–ä½“éªŒ

7.2 æ‚¨å¯ä»¥åœ¨è®¾å¤‡è®¾ç½®ä¸­ç®¡ç†Cookieåå¥½ã€‚

## å…«ã€ä¿¡æ¯å®‰å…¨

æˆ‘ä»¬é‡‡å–ä»¥ä¸‹æªæ–½ä¿æŠ¤æ‚¨çš„ä¿¡æ¯ï¼š
- æ•°æ®ä¼ è¾“å…¨ç¨‹HTTPSåŠ å¯†
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- ä¸¥æ ¼çš„è®¿é—®æƒé™æ§åˆ¶
- å®šæœŸå®‰å…¨å®¡è®¡
- å‘˜å·¥å®‰å…¨åŸ¹è®­

## ä¹ã€éšç§æ”¿ç­–çš„æ›´æ–°

9.1 æˆ‘ä»¬å¯èƒ½é€‚æ—¶ä¿®è®¢æœ¬æ”¿ç­–ï¼Œé‡å¤§å˜æ›´å°†é€šè¿‡åº”ç”¨å†…é€šçŸ¥å‘ŠçŸ¥ã€‚

9.2 ç»§ç»­ä½¿ç”¨æœåŠ¡å³è¡¨ç¤ºåŒæ„æ›´æ–°åçš„æ”¿ç­–ã€‚

## åã€è”ç³»æˆ‘ä»¬

å¦‚æœ‰éšç§ç›¸å…³é—®é¢˜ï¼š
- **éšç§ä¸“å‘˜é‚®ç®±**ï¼šprivacy@aibook.app
- **å®¢æœçƒ­çº¿**ï¼š400-XXX-XXXX
- **åŠå…¬åœ°å€**ï¼š[å…¬å¸åœ°å€]

æˆ‘ä»¬å°†åœ¨15ä¸ªå·¥ä½œæ—¥å†…å›å¤æ‚¨çš„è¯·æ±‚ã€‚

---
Â© 2025 [å…¬å¸åç§°] ç‰ˆæƒæ‰€æœ‰
```

### 28.4 åè®®ç­¾ç½²æµç¨‹

```dart
/// åè®®æ•°æ®æ¨¡å‹
class Agreement {
  final String id;
  final String type;       // 'tos' | 'privacy' | 'membership'
  final String version;
  final String title;
  final String contentUrl;
  final bool isRequired;
  final DateTime effectiveDate;
}

/// åè®®ç®¡ç†æœåŠ¡
class AgreementService {
  final ApiClient _api;
  final SecureStorageService _storage;

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦ç­¾ç½²åè®®
  Future<List<Agreement>> checkPendingAgreements() async {
    final response = await _api.get('/api/v1/agreements/pending');
    return (response.data['agreements'] as List)
        .map((a) => Agreement.fromJson(a))
        .toList();
  }

  /// ç­¾ç½²åè®®
  Future<void> signAgreement(String agreementId) async {
    await _api.post('/api/v1/agreements/sign', data: {
      'agreement_id': agreementId,
      'signed_at': DateTime.now().toIso8601String(),
      'device_info': await DeviceInfo.getInfo(),
    });
  }

  /// è·å–åè®®å†…å®¹
  Future<String> getAgreementContent(String url) async {
    final response = await _api.get(url);
    return response.data;
  }

  /// æ£€æŸ¥æœ¬åœ°ç¼“å­˜çš„åè®®ç‰ˆæœ¬
  Future<bool> isAgreementUpToDate(String type, String version) async {
    final cachedVersion = await _storage.readSecure('agreement_${type}_version');
    return cachedVersion == version;
  }
}

/// åè®®ç­¾ç½²é¡µé¢
class AgreementSignPage extends ConsumerStatefulWidget {
  final List<Agreement> agreements;
  final VoidCallback onComplete;

  @override
  _AgreementSignPageState createState() => _AgreementSignPageState();
}

class _AgreementSignPageState extends ConsumerState<AgreementSignPage> {
  int _currentIndex = 0;
  bool _isChecked = false;
  bool _hasScrolledToBottom = false;
  String? _content;
  final _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _loadContent();
    _scrollController.addListener(_onScroll);
  }

  void _onScroll() {
    if (_scrollController.position.pixels >=
        _scrollController.position.maxScrollExtent - 50) {
      setState(() => _hasScrolledToBottom = true);
    }
  }

  Future<void> _loadContent() async {
    final content = await ref.read(agreementServiceProvider)
        .getAgreementContent(widget.agreements[_currentIndex].contentUrl);
    setState(() => _content = content);
  }

  @override
  Widget build(BuildContext context) {
    final agreement = widget.agreements[_currentIndex];
    final isLast = _currentIndex == widget.agreements.length - 1;

    return Scaffold(
      appBar: AppBar(
        title: Text(agreement.title),
        automaticallyImplyLeading: false,
      ),
      body: Column(
        children: [
          // è¿›åº¦æŒ‡ç¤º
          LinearProgressIndicator(
            value: (_currentIndex + 1) / widget.agreements.length,
          ),

          // åè®®å†…å®¹
          Expanded(
            child: _content == null
                ? Center(child: CircularProgressIndicator())
                : SingleChildScrollView(
                    controller: _scrollController,
                    padding: EdgeInsets.all(16),
                    child: MarkdownBody(data: _content!),
                  ),
          ),

          // åº•éƒ¨æ“ä½œåŒº
          Container(
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Theme.of(context).cardColor,
              boxShadow: [BoxShadow(blurRadius: 4, color: Colors.black12)],
            ),
            child: SafeArea(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // é˜…è¯»æç¤º
                  if (!_hasScrolledToBottom)
                    Padding(
                      padding: EdgeInsets.only(bottom: 12),
                      child: Text(
                        'è¯·é˜…è¯»å®Œæ•´åè®®å†…å®¹',
                        style: TextStyle(color: Colors.orange),
                      ),
                    ),

                  // åŒæ„å‹¾é€‰
                  CheckboxListTile(
                    value: _isChecked,
                    onChanged: _hasScrolledToBottom
                        ? (v) => setState(() => _isChecked = v!)
                        : null,
                    title: Text('æˆ‘å·²é˜…è¯»å¹¶åŒæ„${agreement.title}'),
                    controlAffinity: ListTileControlAffinity.leading,
                    contentPadding: EdgeInsets.zero,
                  ),

                  SizedBox(height: 12),

                  // æ“ä½œæŒ‰é’®
                  Row(
                    children: [
                      // ä¸åŒæ„æŒ‰é’®ï¼ˆéå¿…é¡»åè®®å¯è·³è¿‡ï¼‰
                      if (!agreement.isRequired)
                        Expanded(
                          child: OutlinedButton(
                            onPressed: _nextOrComplete,
                            child: Text('è·³è¿‡'),
                          ),
                        ),

                      if (!agreement.isRequired) SizedBox(width: 12),

                      // åŒæ„æŒ‰é’®
                      Expanded(
                        flex: 2,
                        child: ElevatedButton(
                          onPressed: _isChecked ? _signAndNext : null,
                          child: Text(isLast ? 'åŒæ„å¹¶å¼€å§‹ä½¿ç”¨' : 'åŒæ„å¹¶ç»§ç»­'),
                        ),
                      ),
                    ],
                  ),

                  // ä¸åŒæ„é€€å‡ºï¼ˆå¿…é¡»åè®®ï¼‰
                  if (agreement.isRequired)
                    TextButton(
                      onPressed: _showExitConfirmation,
                      child: Text(
                        'ä¸åŒæ„å¹¶é€€å‡º',
                        style: TextStyle(color: Colors.grey),
                      ),
                    ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _signAndNext() async {
    await ref.read(agreementServiceProvider)
        .signAgreement(widget.agreements[_currentIndex].id);

    _nextOrComplete();
  }

  void _nextOrComplete() {
    if (_currentIndex < widget.agreements.length - 1) {
      setState(() {
        _currentIndex++;
        _isChecked = false;
        _hasScrolledToBottom = false;
        _content = null;
      });
      _loadContent();
      _scrollController.jumpTo(0);
    } else {
      widget.onComplete();
    }
  }

  void _showExitConfirmation() {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text('ç¡®è®¤é€€å‡ºï¼Ÿ'),
        content: Text('ä¸åŒæ„åè®®å°†æ— æ³•ä½¿ç”¨æœ¬åº”ç”¨ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () => SystemNavigator.pop(),
            child: Text('é€€å‡º', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );
  }
}
```

### 28.5 åè®®ç‰ˆæœ¬ç®¡ç†

```python
# æ•°æ®åº“æ¨¡å‹
class AgreementVersion(Base):
    __tablename__ = "agreement_versions"

    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    type = Column(String(50), nullable=False)  # tos, privacy, membership
    version = Column(String(20), nullable=False)
    title = Column(String(200), nullable=False)
    content_url = Column(String(500), nullable=False)
    is_required = Column(Boolean, default=True)
    is_major_update = Column(Boolean, default=False)  # é‡å¤§æ›´æ–°éœ€é‡æ–°ç­¾ç½²
    effective_date = Column(Date, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    __table_args__ = (
        UniqueConstraint('type', 'version', name='uq_agreement_version'),
    )


class UserAgreementSign(Base):
    __tablename__ = "user_agreement_signs"

    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID, ForeignKey("users.id"), nullable=False)
    agreement_id = Column(UUID, ForeignKey("agreement_versions.id"), nullable=False)
    signed_at = Column(DateTime, nullable=False)
    ip_address = Column(String(50))
    device_info = Column(JSONB)


# APIæ¥å£
@router.get("/agreements/pending")
async def get_pending_agreements(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    """è·å–å¾…ç­¾ç½²çš„åè®®"""
    # è·å–æ‰€æœ‰ç”Ÿæ•ˆçš„åè®®
    active_agreements = await db.execute(
        select(AgreementVersion)
        .where(AgreementVersion.effective_date <= date.today())
        .order_by(AgreementVersion.type, AgreementVersion.version.desc())
    )

    # è·å–ç”¨æˆ·å·²ç­¾ç½²çš„åè®®
    signed = await db.execute(
        select(UserAgreementSign.agreement_id)
        .where(UserAgreementSign.user_id == current_user.id)
    )
    signed_ids = {row[0] for row in signed}

    # ç­›é€‰å¾…ç­¾ç½²çš„åè®®
    pending = []
    latest_by_type = {}

    for agreement in active_agreements.scalars():
        if agreement.type not in latest_by_type:
            latest_by_type[agreement.type] = agreement
            if agreement.id not in signed_ids:
                pending.append(agreement)
            elif agreement.is_major_update:
                # æ£€æŸ¥æ˜¯å¦åœ¨æ­¤ç‰ˆæœ¬åç­¾ç½²è¿‡
                # ...
                pass

    return {"agreements": [a.to_dict() for a in pending]}


@router.post("/agreements/sign")
async def sign_agreement(
    request: Request,
    data: AgreementSignRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    """ç­¾ç½²åè®®"""
    sign_record = UserAgreementSign(
        user_id=current_user.id,
        agreement_id=data.agreement_id,
        signed_at=datetime.utcnow(),
        ip_address=request.client.host,
        device_info=data.device_info,
    )

    db.add(sign_record)
    await db.commit()

    return {"success": True}
```

### 28.6 åè®®APIè®¾è®¡

```
#### åè®®ç®¡ç†API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/agreements/pending | è·å–å¾…ç­¾ç½²åè®® |
| GET | /api/v1/agreements/{type}/latest | è·å–æœ€æ–°åè®®ç‰ˆæœ¬ |
| GET | /api/v1/agreements/{id}/content | è·å–åè®®å†…å®¹ |
| POST | /api/v1/agreements/sign | ç­¾ç½²åè®® |
| GET | /api/v1/user/agreements | è·å–ç”¨æˆ·ç­¾ç½²è®°å½• |

#### ç®¡ç†åå°API
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/admin/agreements | åè®®ç‰ˆæœ¬åˆ—è¡¨ |
| POST | /api/v1/admin/agreements | åˆ›å»ºæ–°ç‰ˆæœ¬ |
| PUT | /api/v1/admin/agreements/{id} | æ›´æ–°åè®® |
| GET | /api/v1/admin/agreements/stats | ç­¾ç½²ç»Ÿè®¡ |
```

---

ä»¥ä¸Šæ˜¯AIæ™ºèƒ½è®°è´¦åº”ç”¨çš„å®Œæ•´æ¶æ„è®¾è®¡ï¼ŒåŒ…å«äº†æ‰€æœ‰ç¡®è®¤çš„åŠŸèƒ½éœ€æ±‚ã€‚å¦‚æœ‰éœ€è¦è°ƒæ•´çš„åœ°æ–¹è¯·æå‡ºã€‚
