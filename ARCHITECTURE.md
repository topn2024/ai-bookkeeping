# AIæ™ºèƒ½è®°è´¦åº”ç”¨ - æ¶æ„è®¾è®¡æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®åç§°
**AI Bookkeeping** (æ™ºèƒ½è®°è´¦)

### 1.2 é¡¹ç›®ç›®æ ‡
æ‰“é€ ä¸€æ¬¾AIé©±åŠ¨çš„æ™ºèƒ½è®°è´¦åº”ç”¨ï¼Œæ”¯æŒå¤šç§è®°è´¦æ–¹å¼ï¼ˆå›¾ç‰‡è¯†åˆ«ã€è¯­éŸ³è¾“å…¥ã€é‚®ç®±è´¦å•è§£æã€æ‰‹åŠ¨å½•å…¥ï¼‰ï¼Œæä¾›ä¸°å¯Œçš„ç»Ÿè®¡æŠ¥è¡¨åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·è½»æ¾ç®¡ç†ä¸ªäºº/å®¶åº­è´¢åŠ¡ã€‚

### 1.3 æ ¸å¿ƒåŠŸèƒ½
1. **æ™ºèƒ½è®°è´¦**
   - å›¾ç‰‡/æ‹ç…§è¯†åˆ«ï¼šè‡ªåŠ¨è¯†åˆ«å°ç¥¨ã€å‘ç¥¨ã€è´¦å•
   - è¯­éŸ³è®°è´¦ï¼šè¯­éŸ³è½¬æ–‡å­—è‡ªåŠ¨è§£æé‡‘é¢å’Œåˆ†ç±»
   - é‚®ç®±è´¦å•è§£æï¼šè‡ªåŠ¨è·å–ä¿¡ç”¨å¡è´¦å•ç”Ÿæˆè®°å½•
   - æ‰‹åŠ¨è®°è´¦ï¼šæ”¯æŒæ”¯å‡º/æ”¶å…¥/è½¬è´¦

2. **è´¦ç›®ç®¡ç†**
   - å¤šè´¦æœ¬æ”¯æŒ
   - å¤šæˆå‘˜åä½œ
   - åˆ†ç±»ç®¡ç†ï¼ˆæ”¯å‡º/æ”¶å…¥ï¼‰
   - è´¦æˆ·ç®¡ç†ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€ä¿¡ç”¨å¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡ç­‰ï¼‰

3. **ç»Ÿè®¡æŠ¥è¡¨**
   - æ”¶æ”¯æ€»è§ˆ
   - è¶‹åŠ¿åˆ†æï¼ˆæ—¥/å‘¨/æœˆ/å¹´ï¼‰
   - åˆ†ç±»å æ¯”
   - æŠ¥é”€ç»Ÿè®¡
   - é¢„ç®—ç®¡ç†

4. **ä¸ªäººä¸­å¿ƒ**
   - ä¼šå‘˜ç³»ç»Ÿ
   - ä¸»é¢˜è®¾ç½®
   - æ•°æ®å¯¼å…¥/å¯¼å‡º
   - å®šæ—¶è®°è´¦

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ (Mobile App)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Flutter (iOS & Android)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚   é¦–é¡µ   â”‚ â”‚   ç»Ÿè®¡   â”‚ â”‚   è´¦å•   â”‚ â”‚   æˆ‘çš„   â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS/REST API
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Gateway                              â”‚
â”‚                    (Nginx / Kong / AWS ALB)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡ (Backend)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Python FastAPI                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”‚  è®°è´¦æœåŠ¡    â”‚ â”‚  ç»Ÿè®¡æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  AIè¯†åˆ«æœåŠ¡  â”‚ â”‚  é‚®ä»¶è§£æ    â”‚ â”‚  é€šçŸ¥æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostgreSQL    â”‚ â”‚      Redis       â”‚ â”‚   MinIO/OSS      â”‚
â”‚   (ä¸»æ•°æ®åº“)     â”‚ â”‚   (ç¼“å­˜/é˜Ÿåˆ—)    â”‚ â”‚   (æ–‡ä»¶å­˜å‚¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AI æœåŠ¡å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Claude API   â”‚ â”‚ Whisper API  â”‚ â”‚ OCR Service  â”‚            â”‚
â”‚  â”‚ (æ–‡æœ¬ç†è§£)   â”‚ â”‚ (è¯­éŸ³è¯†åˆ«)   â”‚ â”‚ (å›¾ç‰‡è¯†åˆ«)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

#### å‰ç«¯ (Mobile App)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | **Flutter 3.x** | ä¸€å¥—ä»£ç ï¼ŒåŒæ—¶æ”¯æŒiOSå’ŒAndroid |
| çŠ¶æ€ç®¡ç† | **Riverpod** | ç®€æ´ã€ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç† |
| ç½‘ç»œè¯·æ±‚ | **Dio** | å¼ºå¤§çš„HTTPå®¢æˆ·ç«¯ |
| æœ¬åœ°å­˜å‚¨ | **Hive + SQLite** | ç¦»çº¿æ•°æ®ç¼“å­˜ |
| å›¾è¡¨ | **fl_chart** | ç¾è§‚çš„ç»Ÿè®¡å›¾è¡¨ |
| ç›¸æœº | **camera + image_picker** | æ‹ç…§å’Œå›¾ç‰‡é€‰æ‹© |
| è¯­éŸ³ | **speech_to_text** | è¯­éŸ³è¾“å…¥ |
| UIç»„ä»¶ | **è‡ªå®šä¹‰ç»„ä»¶åº“** | å‚ç…§è®¾è®¡ç¨¿å®šåˆ¶ |

#### åç«¯ (Backend)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| è¯­è¨€ | **Python 3.11+** | AIç”Ÿæ€ä¸°å¯Œ |
| æ¡†æ¶ | **FastAPI** | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| ORM | **SQLAlchemy 2.0** | æ•°æ®åº“æ˜ å°„ |
| æ•°æ®åº“ | **PostgreSQL 15** | ä¸»æ•°æ®å­˜å‚¨ |
| ç¼“å­˜ | **Redis 7** | ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ— |
| ä»»åŠ¡é˜Ÿåˆ— | **Celery** | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| æ–‡ä»¶å­˜å‚¨ | **MinIO / é˜¿é‡Œäº‘OSS** | å›¾ç‰‡ç­‰æ–‡ä»¶å­˜å‚¨ |

#### AIæœåŠ¡
| åŠŸèƒ½ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜ |
|------|----------|------|
| å›¾ç‰‡è¯†åˆ«(OCR) | **PaddleOCR** + Claude | æœ¬åœ°OCR + AIç†è§£ |
| è¯­éŸ³è¯†åˆ« | **Whisper API** | OpenAIè¯­éŸ³è½¬æ–‡å­— |
| æ™ºèƒ½åˆ†ç±» | **Claude API** | è‡ªåŠ¨è¯†åˆ«æ¶ˆè´¹ç±»å‹ |
| è´¦å•è§£æ | **Claude API** | è§£æé‚®ä»¶ä¸­çš„è´¦å• |

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    password_hash VARCHAR(255),
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    member_level INT DEFAULT 0,  -- 0:æ™®é€š 1:VIP
    member_expire_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬è¡¨
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(50),
    cover_image VARCHAR(500),
    book_type INT DEFAULT 0,  -- 0:æ™®é€š 1:å®¶åº­ 2:å•†åŠ¡
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬æˆå‘˜è¡¨
CREATE TABLE book_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    book_id UUID REFERENCES books(id),
    user_id UUID REFERENCES users(id),
    role INT DEFAULT 0,  -- 0:æˆå‘˜ 1:ç®¡ç†å‘˜ 2:æ‰€æœ‰è€…
    joined_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æˆ·è¡¨ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€æ”¯ä»˜å®ç­‰ï¼‰
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    account_type INT NOT NULL,  -- 1:ç°é‡‘ 2:å‚¨è“„å¡ 3:ä¿¡ç”¨å¡ 4:æ”¯ä»˜å® 5:å¾®ä¿¡
    icon VARCHAR(50),
    balance DECIMAL(15,2) DEFAULT 0,
    credit_limit DECIMAL(15,2),  -- ä¿¡ç”¨å¡é¢åº¦
    bill_day INT,  -- è´¦å•æ—¥
    repay_day INT,  -- è¿˜æ¬¾æ—¥
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,  -- NULLè¡¨ç¤ºç³»ç»Ÿé¢„è®¾
    parent_id UUID REFERENCES categories(id),
    name VARCHAR(50) NOT NULL,
    icon VARCHAR(50),
    category_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥
    sort_order INT DEFAULT 0,
    is_system BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦ç›®è®°å½•è¡¨
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    account_id UUID REFERENCES accounts(id),
    target_account_id UUID REFERENCES accounts(id),  -- è½¬è´¦ç›®æ ‡
    category_id UUID REFERENCES categories(id),
    transaction_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥ 3:è½¬è´¦
    amount DECIMAL(15,2) NOT NULL,
    fee DECIMAL(15,2) DEFAULT 0,  -- æ‰‹ç»­è´¹
    transaction_date DATE NOT NULL,
    transaction_time TIME,
    note VARCHAR(500),
    tags VARCHAR(200)[],
    images VARCHAR(500)[],
    location VARCHAR(200),
    is_reimbursable BOOLEAN DEFAULT FALSE,  -- å¯æŠ¥é”€
    is_reimbursed BOOLEAN DEFAULT FALSE,    -- å·²æŠ¥é”€
    is_exclude_stats BOOLEAN DEFAULT FALSE, -- ä¸è®¡æ”¶æ”¯
    source INT DEFAULT 0,  -- 0:æ‰‹åŠ¨ 1:å›¾ç‰‡ 2:è¯­éŸ³ 3:é‚®ä»¶
    ai_confidence DECIMAL(3,2),  -- AIè¯†åˆ«ç½®ä¿¡åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é¢„ç®—è¡¨
CREATE TABLE budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    category_id UUID REFERENCES categories(id),  -- NULLè¡¨ç¤ºæ€»é¢„ç®—
    budget_type INT NOT NULL,  -- 1:æœˆåº¦ 2:å¹´åº¦
    amount DECIMAL(15,2) NOT NULL,
    year INT NOT NULL,
    month INT,  -- å¹´åº¦é¢„ç®—ä¸ºNULL
    created_at TIMESTAMP DEFAULT NOW()
);

-- å®šæ—¶è®°è´¦è¡¨
CREATE TABLE scheduled_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    template_data JSONB NOT NULL,  -- è®°è´¦æ¨¡æ¿
    frequency INT NOT NULL,  -- 1:æ¯å¤© 2:æ¯å‘¨ 3:æ¯æœˆ 4:æ¯å¹´
    next_execute_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- é‚®ç®±ç»‘å®šè¡¨
CREATE TABLE email_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    email VARCHAR(100) NOT NULL,
    email_type INT NOT NULL,  -- 1:Gmail 2:Outlook 3:QQ 4:163
    access_token TEXT,
    refresh_token TEXT,
    last_sync_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 ç´¢å¼•è®¾è®¡

```sql
-- è´¦ç›®æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date DESC);
CREATE INDEX idx_transactions_book_date ON transactions(book_id, transaction_date DESC);
CREATE INDEX idx_transactions_category ON transactions(category_id, transaction_date DESC);

-- ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_stats ON transactions(user_id, book_id, transaction_type, transaction_date);
```

---

## å››ã€APIè®¾è®¡

### 4.1 APIè§„èŒƒ
- RESTfulé£æ ¼
- JWT Tokenè®¤è¯
- ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
    "code": 0,
    "message": "success",
    "data": {}
}
```

### 4.2 æ ¸å¿ƒAPIåˆ—è¡¨

#### è®¤è¯æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/auth/register | æ³¨å†Œ |
| POST | /api/v1/auth/login | ç™»å½• |
| POST | /api/v1/auth/refresh | åˆ·æ–°Token |
| POST | /api/v1/auth/logout | ç™»å‡º |

#### è´¦æœ¬æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/books | è·å–è´¦æœ¬åˆ—è¡¨ |
| POST | /api/v1/books | åˆ›å»ºè´¦æœ¬ |
| PUT | /api/v1/books/{id} | æ›´æ–°è´¦æœ¬ |
| DELETE | /api/v1/books/{id} | åˆ é™¤è´¦æœ¬ |
| POST | /api/v1/books/{id}/members | æ·»åŠ æˆå‘˜ |

#### è®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/transactions | è·å–è´¦ç›®åˆ—è¡¨ |
| POST | /api/v1/transactions | åˆ›å»ºè´¦ç›® |
| PUT | /api/v1/transactions/{id} | æ›´æ–°è´¦ç›® |
| DELETE | /api/v1/transactions/{id} | åˆ é™¤è´¦ç›® |
| POST | /api/v1/transactions/batch | æ‰¹é‡åˆ›å»º |

#### AIè®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/ai/recognize-image | å›¾ç‰‡è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/recognize-voice | è¯­éŸ³è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/parse-bill | è§£æè´¦å•é‚®ä»¶ |

#### ç»Ÿè®¡æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/stats/overview | æ”¶æ”¯æ¦‚è§ˆ |
| GET | /api/v1/stats/trend | è¶‹åŠ¿åˆ†æ |
| GET | /api/v1/stats/category | åˆ†ç±»ç»Ÿè®¡ |
| GET | /api/v1/stats/budget | é¢„ç®—æ‰§è¡Œæƒ…å†µ |

#### è´¦æˆ·æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/accounts | è´¦æˆ·åˆ—è¡¨ |
| POST | /api/v1/accounts | åˆ›å»ºè´¦æˆ· |
| PUT | /api/v1/accounts/{id} | æ›´æ–°è´¦æˆ· |
| GET | /api/v1/accounts/{id}/balance | è´¦æˆ·ä½™é¢ |

---

## äº”ã€å‰ç«¯é¡µé¢è®¾è®¡

### 5.1 é¡µé¢ç»“æ„

```
App
â”œâ”€â”€ å¯åŠ¨é¡µ (Splash)
â”œâ”€â”€ ç™»å½•/æ³¨å†Œ
â”‚   â”œâ”€â”€ æ‰‹æœºå·ç™»å½•
â”‚   â”œâ”€â”€ éªŒè¯ç ç™»å½•
â”‚   â””â”€â”€ ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ï¼‰
â”œâ”€â”€ ä¸»é¡µé¢ (åº•éƒ¨å¯¼èˆª)
â”‚   â”œâ”€â”€ é¦–é¡µ (Home)
â”‚   â”‚   â”œâ”€â”€ è´¦æœ¬åˆ‡æ¢
â”‚   â”‚   â”œâ”€â”€ æœ¬æœˆæ¦‚è§ˆå¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ å¿«æ·åŠŸèƒ½å…¥å£
â”‚   â”‚   â”œâ”€â”€ é¢„ç®—è¿›åº¦
â”‚   â”‚   â””â”€â”€ æœˆè´¦å•åˆ—è¡¨
â”‚   â”œâ”€â”€ ç»Ÿè®¡ (Stats)
â”‚   â”‚   â”œâ”€â”€ æ—¶é—´ç­›é€‰ï¼ˆæœˆ/å¹´/èŒƒå›´/æ—¥/å‘¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ æ€»è§ˆTab
â”‚   â”‚   â”œâ”€â”€ è¶‹åŠ¿Tab
â”‚   â”‚   â””â”€â”€ åˆ†ç±»Tab
â”‚   â”œâ”€â”€ è´¦å• (Bills)
â”‚   â”‚   â””â”€â”€ è´¦å•åˆ—è¡¨/æ—¥å†è§†å›¾
â”‚   â””â”€â”€ æˆ‘çš„ (Profile)
â”‚       â”œâ”€â”€ ä¼šå‘˜ä¿¡æ¯
â”‚       â”œâ”€â”€ è®¾ç½®åˆ—è¡¨
â”‚       â””â”€â”€ ç®¡ç†åŠŸèƒ½
â”œâ”€â”€ è®°è´¦é¡µé¢
â”‚   â”œâ”€â”€ æ”¯å‡ºè®°è´¦
â”‚   â”œâ”€â”€ æ”¶å…¥è®°è´¦
â”‚   â””â”€â”€ è½¬è´¦è®°è´¦
â”œâ”€â”€ AIè®°è´¦
â”‚   â”œâ”€â”€ æ‹ç…§/å›¾ç‰‡è¯†åˆ«
â”‚   â”œâ”€â”€ è¯­éŸ³è®°è´¦
â”‚   â””â”€â”€ è´¦å•å¯¼å…¥
â””â”€â”€ è®¾ç½®é¡µé¢
    â”œâ”€â”€ ä¸ªäººè®¾ç½®
    â”œâ”€â”€ è´¦æœ¬ç®¡ç†
    â”œâ”€â”€ åˆ†ç±»ç®¡ç†
    â”œâ”€â”€ è´¦æˆ·ç®¡ç†
    â””â”€â”€ ä¸»é¢˜è®¾ç½®
```

### 5.2 è®¾è®¡è§„èŒƒ

#### é¢œè‰²ç³»ç»Ÿ
```dart
// ä¸»è‰²è°ƒ
static const primary = Color(0xFF00C9A7);      // è–„è·ç»¿
static const primaryLight = Color(0xFFE8FFF8);

// åŠŸèƒ½è‰²
static const expense = Color(0xFFFF6B6B);      // æ”¯å‡ºçº¢
static const income = Color(0xFF4CAF50);       // æ”¶å…¥ç»¿
static const transfer = Color(0xFF2196F3);     // è½¬è´¦è“

// ä¸­æ€§è‰²
static const textPrimary = Color(0xFF333333);
static const textSecondary = Color(0xFF999999);
static const background = Color(0xFFF5F5F5);
static const cardBackground = Color(0xFFFFFFFF);
```

#### å­—ä½“è§„èŒƒ
```dart
// æ ‡é¢˜
static const headlineLarge = TextStyle(fontSize: 28, fontWeight: FontWeight.bold);
static const headlineMedium = TextStyle(fontSize: 24, fontWeight: FontWeight.bold);

// é‡‘é¢
static const amountLarge = TextStyle(fontSize: 32, fontWeight: FontWeight.bold);
static const amountMedium = TextStyle(fontSize: 20, fontWeight: FontWeight.w600);

// æ­£æ–‡
static const bodyLarge = TextStyle(fontSize: 16);
static const bodyMedium = TextStyle(fontSize: 14);
static const bodySmall = TextStyle(fontSize: 12);
```

---

## å…­ã€AIåŠŸèƒ½è®¾è®¡

### 6.1 å›¾ç‰‡è¯†åˆ«æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ‹ç…§  â”‚ â”€â”€â–¶ â”‚ OCRè¯†åˆ«  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ /é€‰å›¾ç‰‡  â”‚     â”‚ æ–‡å­—æå–  â”‚     â”‚ æ™ºèƒ½è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯†åˆ«å†…å®¹ï¼š**
- å•†æˆ·åç§°
- æ¶ˆè´¹é‡‘é¢
- æ¶ˆè´¹æ—¶é—´
- å•†å“æ˜ç»†
- è‡ªåŠ¨åˆ†ç±»å»ºè®®

### 6.2 è¯­éŸ³è®°è´¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯´è¯  â”‚ â”€â”€â–¶ â”‚ Whisper  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ æŒ‰ä½å½•éŸ³  â”‚     â”‚ è¯­éŸ³è½¬æ–‡å­—â”‚     â”‚ æ„å›¾è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹è¾“å…¥ï¼š**
- "ä»Šå¤©åˆé¥­èŠ±äº†35å—"
- "ä¹°äº†ä¸€æ¯å’–å•¡28å…ƒ"
- "è¿™ä¸ªæœˆå·¥èµ„åˆ°è´¦8000"

### 6.3 é‚®ç®±è´¦å•è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæƒé‚®ç®±  â”‚ â”€â”€â–¶ â”‚ è·å–é‚®ä»¶  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ æ‰¹é‡å¯¼å…¥  â”‚
â”‚ OAuth    â”‚     â”‚ ç­›é€‰è´¦å•  â”‚     â”‚ è§£æè´¦å•  â”‚     â”‚ ç”¨æˆ·ç¡®è®¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æŒé“¶è¡Œï¼š**
- æ‹›å•†é“¶è¡Œã€å·¥å•†é“¶è¡Œã€å»ºè®¾é“¶è¡Œç­‰
- æ”¯ä»˜å®ã€å¾®ä¿¡è´¦å•
- ä¿¡ç”¨å¡ç”µå­è´¦å•

---

## ä¸ƒã€é¡¹ç›®ç›®å½•ç»“æ„

### 7.1 å‰ç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-app/
â”œâ”€â”€ android/                    # AndroidåŸç”Ÿä»£ç 
â”œâ”€â”€ ios/                        # iOSåŸç”Ÿä»£ç 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart              # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ app.dart           # Appé…ç½®
â”‚   â”‚   â””â”€â”€ routes.dart        # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ constants/         # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ theme/             # ä¸»é¢˜é…ç½®
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ extensions/        # æ‰©å±•æ–¹æ³•
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ repositories/      # æ•°æ®ä»“åº“
â”‚   â”‚   â”œâ”€â”€ providers/         # çŠ¶æ€æä¾›è€…
â”‚   â”‚   â””â”€â”€ services/          # APIæœåŠ¡
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ home/              # é¦–é¡µæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ stats/             # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ bills/             # è´¦å•æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ profile/           # ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ transaction/       # è®°è´¦æ¨¡å—
â”‚   â”‚   â””â”€â”€ ai/                # AIè®°è´¦æ¨¡å—
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ widgets/           # é€šç”¨ç»„ä»¶
â”‚       â””â”€â”€ dialogs/           # å¼¹çª—ç»„ä»¶
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ images/                # å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ icons/                 # å›¾æ ‡èµ„æº
â”‚   â””â”€â”€ fonts/                 # å­—ä½“æ–‡ä»¶
â”œâ”€â”€ test/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ pubspec.yaml               # ä¾èµ–é…ç½®
â””â”€â”€ README.md
```

### 7.2 åç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # FastAPIå…¥å£
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ exceptions.py      # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py        # è®¤è¯æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ users.py       # ç”¨æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ books.py       # è´¦æœ¬æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ transactions.py# è®°è´¦æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.py    # è´¦æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ categories.py  # åˆ†ç±»æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ stats.py       # ç»Ÿè®¡æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ ai.py          # AIæ¥å£
â”‚   â”‚   â””â”€â”€ deps.py            # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ account.py         # è´¦æˆ·æ¨¡å‹
â”‚   â”‚   â””â”€â”€ category.py        # åˆ†ç±»æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·Schema
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬Schema
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦Schema
â”‚   â”‚   â””â”€â”€ stats.py           # ç»Ÿè®¡Schema
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py    # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”œâ”€â”€ stats_service.py   # ç»Ÿè®¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ ai_service.py      # AIæœåŠ¡
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ email_parser.py    # é‚®ä»¶è§£æä»»åŠ¡
â”‚       â””â”€â”€ scheduled.py       # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ Dockerfile                  # Dockeré…ç½®
â”œâ”€â”€ docker-compose.yml          # Dockerç¼–æ’
â””â”€â”€ README.md
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 å¼€å‘ç¯å¢ƒ
- æœ¬åœ°å¼€å‘ä½¿ç”¨Docker Compose
- çƒ­é‡è½½æ”¯æŒ

### 8.2 ç”Ÿäº§ç¯å¢ƒ

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   CDN (é™æ€)    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  è´Ÿè½½å‡è¡¡ (SLB) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚   â”‚   API Server 2  â”‚   â”‚   API Server N  â”‚
     â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                              â”‚                              â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚PostgreSQLâ”‚                   â”‚   Redis   â”‚                  â”‚   MinIO   â”‚
â”‚ (RDS)   â”‚                   â”‚  Cluster  â”‚                  â”‚   (OSS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æ¨èäº‘æœåŠ¡
- **æœåŠ¡å™¨**ï¼šé˜¿é‡Œäº‘ECS / AWS EC2
- **æ•°æ®åº“**ï¼šé˜¿é‡Œäº‘RDS PostgreSQL
- **ç¼“å­˜**ï¼šé˜¿é‡Œäº‘Redis
- **å­˜å‚¨**ï¼šé˜¿é‡Œäº‘OSS
- **å®¹å™¨**ï¼šé˜¿é‡Œäº‘ACK (Kubernetes)

---

## ä¹ã€å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] æ•°æ®å¯¼å‡º

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ

---

## åã€åˆ†ç±»é¢„è®¾

### 10.1 æ”¯å‡ºåˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | å­åˆ†ç±» |
|------|------|--------|
| ğŸ½ï¸ | é¤é¥® | æ—©é¤ã€åˆé¤ã€æ™šé¤ã€é¥®æ–™ã€é›¶é£Ÿ |
| ğŸ  | ä½æˆ¿ | æˆ¿ç§Ÿã€ç‰©ä¸šè´¹ã€æ°´ç”µç‡ƒæ°”ã€ç»´ä¿® |
| ğŸ® | å¨±ä¹ | æ¸¸æˆã€ç”µå½±ã€KTVã€æ—…æ¸¸ |
| ğŸ‘¥ | äººæƒ… | çº¢åŒ…ã€ç¤¼ç‰©ã€è¯·å®¢ |
| ğŸ‘¶ | è‚²å„¿ | å¥¶ç²‰ã€ç©å…·ã€æ•™è‚²ã€åŒ»ç–— |
| âœˆï¸ | å·®æ—… | æœºç¥¨ã€é…’åº—ã€æ‰“è½¦ã€ç«è½¦ |
| ğŸšŒ | äº¤é€š | å…¬äº¤ã€åœ°é“ã€æ‰“è½¦ã€å…±äº«å•è½¦ |
| ğŸš— | æ±½è½¦ | åŠ æ²¹ã€åœè½¦ã€ä¿å…»ã€ä¿é™© |
| ğŸ›’ | è´­ç‰© | æœè£…ã€æ—¥ç”¨å“ã€æ•°ç äº§å“ |
| ğŸ’¼ | åŠå…¬ | åŠå…¬ç”¨å“ã€æ‰“å°ã€å¿«é€’ |
| ğŸ¥ | åŒ»ç–— | æŒ‚å·ã€è¯å“ã€ä½“æ£€ |
| ğŸƒ | è¿åŠ¨ | å¥èº«å¡ã€è¿åŠ¨è£…å¤‡ |
| ğŸ“š | å­¦ä¹  | ä¹¦ç±ã€è¯¾ç¨‹ã€åŸ¹è®­ |
| ğŸ“± | ä¼šå‘˜è®¢é˜… | è§†é¢‘ä¼šå‘˜ã€éŸ³ä¹ä¼šå‘˜ã€è½¯ä»¶ |

### 10.2 æ”¶å…¥åˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | è¯´æ˜ |
|------|------|------|
| ğŸ’° | å·¥èµ„ | æœˆè–ªã€å‘¨è–ª |
| â° | åŠ ç­ | åŠ ç­è´¹ |
| ğŸ’¼ | å…¼èŒ | å…¼èŒæ”¶å…¥ |
| ğŸ“ˆ | ç†è´¢ | åˆ©æ¯ã€è‚¡ç¥¨ã€åŸºé‡‘ |
| ğŸ | ç¦åˆ© | å…¬å¸ç¦åˆ© |
| ğŸ† | å¥–é‡‘ | å¹´ç»ˆå¥–ã€ç»©æ•ˆå¥– |
| ğŸ¦ | å…¬ç§¯é‡‘ | å…¬ç§¯é‡‘æå– |
| ğŸ§§ | çº¢åŒ… | æ”¶åˆ°çš„çº¢åŒ… |
| ğŸ’ | ç¤¼é‡‘ | æ”¶åˆ°çš„ç¤¼é‡‘ |
| ğŸª | ç»è¥æ‰€å¾— | ç”Ÿæ„æ”¶å…¥ |
| ğŸ² | æ„å¤–æ¥é’± | ä¸­å¥–ã€é€€æ¬¾ç­‰ |

---

## åä¸€ã€å®‰å…¨è®¾è®¡

### 11.1 æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- HTTPSå…¨é“¾è·¯åŠ å¯†
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤

### 11.2 ç”¨æˆ·éšç§
- æœ€å°åŒ–æ•°æ®æ”¶é›†
- ç”¨æˆ·æ•°æ®å¯å¯¼å‡º/åˆ é™¤
- ç¬¬ä¸‰æ–¹æœåŠ¡æ•°æ®è„±æ•
- ç¬¦åˆGDPR/ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•

### 11.3 APIå®‰å…¨
- JWT Token + Refresh Token
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- æ¥å£ç­¾åéªŒè¯
- æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

---

## åäºŒã€ç¬¬ä¸‰æ–¹ç™»å½•è®¾è®¡

### 12.1 æ”¯æŒçš„ç™»å½•æ–¹å¼

| ç™»å½•æ–¹å¼ | å¹³å° | æŠ€æœ¯æ–¹æ¡ˆ |
|----------|------|----------|
| å¾®ä¿¡ç™»å½• | iOS/Android | å¾®ä¿¡å¼€æ”¾å¹³å°SDK |
| Appleç™»å½• | iOS | Sign in with Apple |
| æ‰‹æœºå·ç™»å½• | å…¨å¹³å° | çŸ­ä¿¡éªŒè¯ç  |
| é‚®ç®±ç™»å½• | å…¨å¹³å° | é‚®ç®±+å¯†ç  |

### 12.2 å¾®ä¿¡ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ å¾®ä¿¡æˆæƒ  â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ æ‹‰èµ·å¾®ä¿¡  â”‚     â”‚ è·å–code â”‚     â”‚ æ¢å–ä¿¡æ¯  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 Appleç™»å½•æµç¨‹ (iOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ Appleæˆæƒ â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ Face ID  â”‚     â”‚ è·å–Token â”‚     â”‚ éªŒè¯JWT  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.4 ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šè¡¨

```sql
-- ç¬¬ä¸‰æ–¹ç™»å½•ç»‘å®šè¡¨
CREATE TABLE oauth_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    provider VARCHAR(20) NOT NULL,      -- wechat, apple, google
    provider_user_id VARCHAR(100) NOT NULL,
    union_id VARCHAR(100),              -- å¾®ä¿¡UnionID
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    raw_data JSONB,                     -- åŸå§‹è¿”å›æ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(provider, provider_user_id)
);
```

---

## åä¸‰ã€å¤šè´§å¸ç³»ç»Ÿè®¾è®¡

### 13.1 è´§å¸æ”¯æŒ

æ”¯æŒå…¨çƒä¸»æµè´§å¸ï¼Œæ ¹æ®ç”¨æˆ·IPè‡ªåŠ¨è®¾ç½®é»˜è®¤è´§å¸ï¼š

| è´§å¸ä»£ç  | è´§å¸åç§° | ç¬¦å· | å›½å®¶/åœ°åŒº |
|----------|----------|------|-----------|
| CNY | äººæ°‘å¸ | Â¥ | ä¸­å›½å¤§é™† |
| USD | ç¾å…ƒ | $ | ç¾å›½ |
| EUR | æ¬§å…ƒ | â‚¬ | æ¬§ç›Ÿ |
| GBP | è‹±é•‘ | Â£ | è‹±å›½ |
| JPY | æ—¥å…ƒ | Â¥ | æ—¥æœ¬ |
| HKD | æ¸¯å¸ | HK$ | é¦™æ¸¯ |
| TWD | æ–°å°å¸ | NT$ | å°æ¹¾ |
| SGD | æ–°åŠ å¡å…ƒ | S$ | æ–°åŠ å¡ |
| AUD | æ¾³å…ƒ | A$ | æ¾³å¤§åˆ©äºš |
| CAD | åŠ å…ƒ | C$ | åŠ æ‹¿å¤§ |
| KRW | éŸ©å…ƒ | â‚© | éŸ©å›½ |
| THB | æ³°é“¢ | à¸¿ | æ³°å›½ |
| MYR | é©¬æ¥è¥¿äºšä»¤å‰ | RM | é©¬æ¥è¥¿äºš |

### 13.2 æ±‡ç‡ç®¡ç†

```sql
-- è´§å¸è¡¨
CREATE TABLE currencies (
    code VARCHAR(3) PRIMARY KEY,        -- ISO 4217
    name VARCHAR(50) NOT NULL,
    name_en VARCHAR(50) NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    decimal_places INT DEFAULT 2,
    is_active BOOLEAN DEFAULT TRUE
);

-- æ±‡ç‡è¡¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
CREATE TABLE exchange_rates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    base_currency VARCHAR(3) DEFAULT 'USD',
    target_currency VARCHAR(3) NOT NULL,
    rate DECIMAL(20,10) NOT NULL,
    rate_date DATE NOT NULL,
    source VARCHAR(50),                 -- æ•°æ®æ¥æº
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(base_currency, target_currency, rate_date)
);

-- ç”¨æˆ·è´§å¸è®¾ç½®
ALTER TABLE users ADD COLUMN default_currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE users ADD COLUMN detected_country VARCHAR(2);  -- IPæ£€æµ‹å›½å®¶
```

### 13.3 è´¦ç›®è´§å¸æ‰©å±•

```sql
-- è´¦ç›®è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE transactions ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE transactions ADD COLUMN original_amount DECIMAL(15,2);      -- åŸå§‹é‡‘é¢
ALTER TABLE transactions ADD COLUMN original_currency VARCHAR(3);        -- åŸå§‹è´§å¸
ALTER TABLE transactions ADD COLUMN exchange_rate DECIMAL(20,10);       -- è½¬æ¢æ±‡ç‡

-- è´¦æˆ·è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE accounts ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
```

### 13.4 è´§å¸è½¬æ¢é€»è¾‘

```python
# è´§å¸è½¬æ¢æœåŠ¡
class CurrencyService:
    async def convert(
        self,
        amount: Decimal,
        from_currency: str,
        to_currency: str,
        date: date = None
    ) -> tuple[Decimal, Decimal]:
        """
        è¿”å›: (è½¬æ¢åé‡‘é¢, æ±‡ç‡)
        """
        if from_currency == to_currency:
            return amount, Decimal('1')

        rate = await self.get_rate(from_currency, to_currency, date)
        converted = amount * rate
        return converted.quantize(Decimal('0.01')), rate

    async def get_rate(self, from_curr: str, to_curr: str, date: date = None):
        # 1. ä¼˜å…ˆä»ç¼“å­˜è·å–
        # 2. ä»æ•°æ®åº“è·å–
        # 3. è°ƒç”¨æ±‡ç‡APIæ›´æ–°
        pass
```

### 13.5 IPåœ°ç†ä½ç½®æ£€æµ‹

```python
# ç™»å½•/æ³¨å†Œæ—¶æ£€æµ‹ç”¨æˆ·æ‰€åœ¨å›½å®¶
async def detect_user_location(ip_address: str) -> dict:
    """
    ä½¿ç”¨ IP2Location æˆ– MaxMind GeoIP2 æ£€æµ‹
    è¿”å›: {country_code: 'CN', currency: 'CNY', language: 'zh-CN'}
    """
    # æ¨èä½¿ç”¨ MaxMind GeoLite2 (å…è´¹) æˆ– GeoIP2 (ä»˜è´¹)
    pass
```

---

## åå››ã€ç¦»çº¿æ¨¡å¼è®¾è®¡

### 14.1 ç¦»çº¿æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flutter App                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Repository Layer                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ Remote Sourceâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚ Local Source â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (API)      â”‚  Sync   â”‚  (SQLite)    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                     â”‚  Sync Manager   â”‚                      â”‚
â”‚                     â”‚ (å†²çªè§£å†³/é˜Ÿåˆ—) â”‚                      â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 æœ¬åœ°æ•°æ®åº“è®¾è®¡ (SQLite)

```sql
-- ç¦»çº¿æ“ä½œé˜Ÿåˆ—
CREATE TABLE sync_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_type TEXT NOT NULL,       -- create, update, delete
    entity_type TEXT NOT NULL,          -- transaction, account, category
    entity_id TEXT NOT NULL,
    payload TEXT NOT NULL,              -- JSONæ•°æ®
    created_at INTEGER NOT NULL,        -- Unix timestamp
    retry_count INTEGER DEFAULT 0,
    last_error TEXT,
    status TEXT DEFAULT 'pending'       -- pending, syncing, synced, failed
);

-- æœ¬åœ°è´¦ç›®ç¼“å­˜
CREATE TABLE local_transactions (
    id TEXT PRIMARY KEY,
    server_id TEXT,                     -- æœåŠ¡å™¨IDï¼Œæ–°å»ºæ—¶ä¸ºNULL
    data TEXT NOT NULL,                 -- JSONå®Œæ•´æ•°æ®
    is_synced INTEGER DEFAULT 0,
    local_updated_at INTEGER NOT NULL,
    server_updated_at INTEGER,
    is_deleted INTEGER DEFAULT 0
);

-- åŒæ­¥çŠ¶æ€è¡¨
CREATE TABLE sync_status (
    entity_type TEXT PRIMARY KEY,
    last_sync_at INTEGER,
    last_server_timestamp INTEGER
);
```

### 14.3 åŒæ­¥ç­–ç•¥

```dart
class SyncManager {
  // åŒæ­¥ä¼˜å…ˆçº§
  static const syncOrder = [
    'categories',    // 1. å…ˆåŒæ­¥åˆ†ç±»
    'accounts',      // 2. å†åŒæ­¥è´¦æˆ·
    'transactions',  // 3. æœ€ååŒæ­¥è´¦ç›®
  ];

  // å†²çªè§£å†³ç­–ç•¥
  ConflictResolution resolveConflict(LocalData local, ServerData server) {
    // ç­–ç•¥1: æœåŠ¡å™¨ä¼˜å…ˆ (é»˜è®¤)
    // ç­–ç•¥2: æœ¬åœ°ä¼˜å…ˆ
    // ç­–ç•¥3: æœ€æ–°ä¿®æ”¹ä¼˜å…ˆ
    // ç­–ç•¥4: ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©

    if (server.updatedAt > local.localUpdatedAt) {
      return ConflictResolution.useServer;
    }
    return ConflictResolution.useLocal;
  }
}
```

### 14.4 ç¦»çº¿æ•°æ®æ¸…ç†ç­–ç•¥

```dart
class OfflineDataManager {
  // æ¸…ç†é…ç½®
  static const config = {
    'maxLocalDays': 90,           // æœ€å¤šä¿ç•™90å¤©æ•°æ®
    'maxLocalSize': 100 * 1024 * 1024,  // æœ€å¤§100MB
    'cleanupThreshold': 80 * 1024 * 1024, // 80MBæ—¶å¼€å§‹æ¸…ç†
    'keepRecentDays': 30,         // å§‹ç»ˆä¿ç•™æœ€è¿‘30å¤©
  };

  Future<void> cleanupIfNeeded() async {
    final currentSize = await getLocalDataSize();

    if (currentSize > config['cleanupThreshold']) {
      // 1. åˆ é™¤è¶…è¿‡90å¤©çš„å·²åŒæ­¥æ•°æ®
      await deleteOldSyncedData(config['maxLocalDays']);

      // 2. å¦‚æœè¿˜è¶…è¿‡é˜ˆå€¼ï¼Œå‹ç¼©å›¾ç‰‡ç¼“å­˜
      await compressImageCache();

      // 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      await clearTempFiles();
    }
  }

  // å®šæœŸæ¸…ç†ä»»åŠ¡ (æ¯å‘¨ä¸€æ¬¡)
  void scheduleWeeklyCleanup() {
    // åœ¨WiFiç¯å¢ƒä¸‹æ‰§è¡Œ
    // åœ¨å……ç”µçŠ¶æ€ä¸‹æ‰§è¡Œ
    // åœ¨Appåå°æ—¶æ‰§è¡Œ
  }
}
```

### 14.5 å­˜å‚¨ç©ºé—´ç®¡ç†ç•Œé¢

```
å­˜å‚¨ç©ºé—´ç®¡ç†
â”œâ”€â”€ æ€»å ç”¨: 45.2 MB
â”‚   â”œâ”€â”€ è´¦ç›®æ•°æ®: 12.3 MB (3,240æ¡)
â”‚   â”œâ”€â”€ å›¾ç‰‡ç¼“å­˜: 28.5 MB (156å¼ )
â”‚   â””â”€â”€ å…¶ä»–ç¼“å­˜: 4.4 MB
â”œâ”€â”€ è‡ªåŠ¨æ¸…ç†: å¼€å¯
â”‚   â”œâ”€â”€ ä¿ç•™æœ€è¿‘: 90å¤©
â”‚   â””â”€â”€ æœ€å¤§ç©ºé—´: 100 MB
â””â”€â”€ [æ¸…ç†ç¼“å­˜] [å¯¼å‡ºæ•°æ®]
```

---

## åäº”ã€ä¼šå‘˜ç³»ç»Ÿè®¾è®¡

### 15.1 ä¼šå‘˜ç­‰çº§

| ç­‰çº§ | åç§° | ä»·æ ¼ | æœ‰æ•ˆæœŸ |
|------|------|------|--------|
| 0 | å…è´¹ç”¨æˆ· | å…è´¹ | æ°¸ä¹… |
| 1 | æœˆåº¦ä¼šå‘˜ | Â¥12/æœˆ | 1ä¸ªæœˆ |
| 2 | å¹´åº¦ä¼šå‘˜ | Â¥98/å¹´ | 1å¹´ |
| 3 | ç»ˆèº«ä¼šå‘˜ | Â¥298 | æ°¸ä¹… |

### 15.2 åŠŸèƒ½æƒç›Šå¯¹æ¯”

| åŠŸèƒ½ | å…è´¹ç”¨æˆ· | VIPä¼šå‘˜ |
|------|----------|---------|
| **åŸºç¡€è®°è´¦** | | |
| æ‰‹åŠ¨è®°è´¦ | âœ… æ— é™ | âœ… æ— é™ |
| è´¦æœ¬æ•°é‡ | 2ä¸ª | âœ… æ— é™ |
| è´¦æˆ·æ•°é‡ | 5ä¸ª | âœ… æ— é™ |
| æˆå‘˜åä½œ | 2äºº | âœ… 10äºº |
| **AIåŠŸèƒ½** | | |
| å›¾ç‰‡è¯†åˆ«è®°è´¦ | 5æ¬¡/æœˆ | âœ… æ— é™ |
| è¯­éŸ³è®°è´¦ | 10æ¬¡/æœˆ | âœ… æ— é™ |
| é‚®ç®±è´¦å•è§£æ | âŒ | âœ… |
| æ™ºèƒ½åˆ†ç±»å»ºè®® | âŒ | âœ… |
| **ç»Ÿè®¡æŠ¥è¡¨** | | |
| åŸºç¡€ç»Ÿè®¡ | âœ… | âœ… |
| è¶‹åŠ¿åˆ†æ | æœ€è¿‘3æœˆ | âœ… å…¨éƒ¨ |
| åˆ†ç±»å æ¯” | âœ… | âœ… |
| å¹´åº¦æŠ¥å‘Š | âŒ | âœ… |
| è‡ªå®šä¹‰æŠ¥è¡¨ | âŒ | âœ… |
| **æ•°æ®åŠŸèƒ½** | | |
| æ•°æ®å¯¼å‡º(CSV) | âŒ | âœ… |
| æ•°æ®å¯¼å‡º(Excel) | âŒ | âœ… |
| äº‘ç«¯å¤‡ä»½ | æ‰‹åŠ¨/æœˆ | âœ… è‡ªåŠ¨/æ—¥ |
| å†å²å¤‡ä»½ä¿ç•™ | 1ä»½ | âœ… 30ä»½ |
| **é«˜çº§åŠŸèƒ½** | | |
| å®šæ—¶è®°è´¦ | âŒ | âœ… |
| æ¡Œé¢å°ç»„ä»¶ | åŸºç¡€ | âœ… å…¨éƒ¨ |
| è‡ªå®šä¹‰åˆ†ç±»å›¾æ ‡ | âŒ | âœ… |
| ä¸»é¢˜çš®è‚¤ | 2æ¬¾ | âœ… å…¨éƒ¨ |
| å»å¹¿å‘Š | âŒ | âœ… |
| **ä¸“å±æœåŠ¡** | | |
| å®¢æœæ”¯æŒ | å·¥å• | âœ… ä¸“å±å®¢æœ |
| æ–°åŠŸèƒ½ä¼˜å…ˆä½“éªŒ | âŒ | âœ… |

### 15.3 ä¼šå‘˜æ•°æ®è¡¨

```sql
-- ä¼šå‘˜è®¢å•è¡¨
CREATE TABLE member_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    order_no VARCHAR(50) UNIQUE NOT NULL,
    product_type INT NOT NULL,           -- 1:æœˆåº¦ 2:å¹´åº¦ 3:ç»ˆèº«
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    payment_method VARCHAR(20),          -- wechat, alipay, apple
    payment_status INT DEFAULT 0,        -- 0:å¾…æ”¯ä»˜ 1:å·²æ”¯ä»˜ 2:å·²é€€æ¬¾
    paid_at TIMESTAMP,
    expire_at TIMESTAMP,
    transaction_id VARCHAR(100),         -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä¼šå‘˜æƒç›Šä½¿ç”¨è®°å½•
CREATE TABLE member_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    feature_type VARCHAR(50) NOT NULL,   -- ocr, voice, export
    usage_date DATE NOT NULL,
    usage_count INT DEFAULT 1,
    UNIQUE(user_id, feature_type, usage_date)
);

-- ç”¨æˆ·è¡¨æ‰©å±•
ALTER TABLE users ADD COLUMN member_type INT DEFAULT 0;
ALTER TABLE users ADD COLUMN member_start_at TIMESTAMP;
ALTER TABLE users ADD COLUMN member_expire_at TIMESTAMP;
ALTER TABLE users ADD COLUMN is_lifetime BOOLEAN DEFAULT FALSE;
```

### 15.4 ä¼šå‘˜åŠŸèƒ½é™åˆ¶æ£€æŸ¥

```python
class MembershipService:
    # å…è´¹ç”¨æˆ·é™åˆ¶
    FREE_LIMITS = {
        'max_books': 2,
        'max_accounts': 5,
        'max_members': 2,
        'ocr_monthly': 5,
        'voice_monthly': 10,
        'trend_months': 3,
    }

    async def check_feature_access(
        self,
        user_id: str,
        feature: str
    ) -> tuple[bool, str]:
        """
        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ä½¿ç”¨æŸåŠŸèƒ½
        è¿”å›: (æ˜¯å¦å…è®¸, æç¤ºæ¶ˆæ¯)
        """
        user = await self.get_user(user_id)

        if user.is_vip:
            return True, ""

        # æ£€æŸ¥é™åˆ¶
        if feature == 'ocr':
            used = await self.get_monthly_usage(user_id, 'ocr')
            if used >= self.FREE_LIMITS['ocr_monthly']:
                return False, "æœ¬æœˆå…è´¹è¯†åˆ«æ¬¡æ•°å·²ç”¨å®Œï¼Œå‡çº§VIPäº«æ— é™æ¬¡æ•°"

        return True, ""
```

### 15.5 ä¿ƒé”€æ´»åŠ¨æ”¯æŒ

```sql
-- ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(20) UNIQUE NOT NULL,
    coupon_type INT NOT NULL,            -- 1:æŠ˜æ‰£ 2:æ»¡å‡ 3:å…è´¹æ—¶é•¿
    discount_value DECIMAL(10,2),        -- æŠ˜æ‰£å€¼æˆ–é‡‘é¢
    min_amount DECIMAL(10,2),            -- æœ€ä½æ¶ˆè´¹
    applicable_products INT[],           -- é€‚ç”¨äº§å“
    total_count INT,                     -- æ€»æ•°é‡
    used_count INT DEFAULT 0,
    start_at TIMESTAMP,
    expire_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·ä¼˜æƒ åˆ¸
CREATE TABLE user_coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    coupon_id UUID REFERENCES coupons(id),
    status INT DEFAULT 0,                -- 0:æœªä½¿ç”¨ 1:å·²ä½¿ç”¨ 2:å·²è¿‡æœŸ
    used_at TIMESTAMP,
    order_id UUID,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## åå…­ã€å›½é™…åŒ–(i18n)è®¾è®¡

### 16.1 æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ä»£ç  | è¯­è¨€åç§° | é»˜è®¤åœ°åŒº |
|----------|----------|----------|
| zh-CN | ç®€ä½“ä¸­æ–‡ | ä¸­å›½å¤§é™† |
| zh-TW | ç¹ä½“ä¸­æ–‡ | å°æ¹¾ã€é¦™æ¸¯ã€æ¾³é—¨ |
| en-US | è‹±è¯­ | ç¾å›½ã€è‹±å›½ã€æ¾³æ´²ç­‰ |
| ja-JP | æ—¥è¯­ | æ—¥æœ¬ |
| ko-KR | éŸ©è¯­ | éŸ©å›½ |
| th-TH | æ³°è¯­ | æ³°å›½ |
| vi-VN | è¶Šå—è¯­ | è¶Šå— |
| ms-MY | é©¬æ¥è¯­ | é©¬æ¥è¥¿äºš |

### 16.2 è¯­è¨€æ£€æµ‹ä¼˜å…ˆçº§

```dart
class LocaleManager {
  Locale detectUserLocale(UserInfo? user, String? ipCountry) {
    // 1. ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„è¯­è¨€ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    if (user?.preferredLanguage != null) {
      return Locale(user!.preferredLanguage);
    }

    // 2. æ ¹æ®IPæ£€æµ‹çš„å›½å®¶
    if (ipCountry != null) {
      return _countryToLocale(ipCountry);
    }

    // 3. è®¾å¤‡ç³»ç»Ÿè¯­è¨€
    final deviceLocale = Platform.localeName;
    if (_supportedLocales.contains(deviceLocale)) {
      return Locale(deviceLocale);
    }

    // 4. é»˜è®¤ä¸­æ–‡
    return const Locale('zh', 'CN');
  }

  static const _countryLocaleMap = {
    'CN': 'zh-CN',
    'TW': 'zh-TW',
    'HK': 'zh-TW',
    'US': 'en-US',
    'GB': 'en-US',
    'JP': 'ja-JP',
    'KR': 'ko-KR',
    'TH': 'th-TH',
    // ...
  };
}
```

### 16.3 Flutterå›½é™…åŒ–å®ç°

```yaml
# pubspec.yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: ^0.18.0

flutter:
  generate: true
```

```dart
// lib/l10n/app_zh.arb
{
  "@@locale": "zh",
  "appName": "æ™ºèƒ½è®°è´¦",
  "home": "é¦–é¡µ",
  "stats": "ç»Ÿè®¡",
  "bills": "è´¦å•",
  "profile": "æˆ‘çš„",
  "expense": "æ”¯å‡º",
  "income": "æ”¶å…¥",
  "transfer": "è½¬è´¦",
  "monthlyExpense": "æœ¬æœˆæ”¯å‡º",
  "monthlyIncome": "æœ¬æœˆæ”¶å…¥",
  "balance": "ç»“ä½™",
  "budget": "é¢„ç®—",
  "category": "åˆ†ç±»",
  "account": "è´¦æˆ·",
  "note": "å¤‡æ³¨",
  "save": "ä¿å­˜",
  "cancel": "å–æ¶ˆ",
  "delete": "åˆ é™¤",
  "edit": "ç¼–è¾‘",
  "settings": "è®¾ç½®",
  "language": "è¯­è¨€",
  "currency": "è´§å¸",
  "theme": "ä¸»é¢˜",
  "about": "å…³äº",
  "logout": "é€€å‡ºç™»å½•",
  "upgradeToVip": "å‡çº§VIP",
  "aiRecognition": "AIè¯†åˆ«",
  "voiceInput": "è¯­éŸ³è®°è´¦",
  "scanReceipt": "æ‰«æå°ç¥¨",

  "categoryFood": "é¤é¥®",
  "categoryHousing": "ä½æˆ¿",
  "categoryEntertainment": "å¨±ä¹",
  "categoryTransport": "äº¤é€š",
  "categoryShopping": "è´­ç‰©",
  "categoryMedical": "åŒ»ç–—",
  "categorySalary": "å·¥èµ„",
  "categoryBonus": "å¥–é‡‘",

  "freeUsageExhausted": "æœ¬æœˆå…è´¹{feature}æ¬¡æ•°å·²ç”¨å®Œ",
  "@freeUsageExhausted": {
    "placeholders": {
      "feature": {"type": "String"}
    }
  }
}
```

```dart
// lib/l10n/app_en.arb
{
  "@@locale": "en",
  "appName": "AI Bookkeeping",
  "home": "Home",
  "stats": "Statistics",
  "bills": "Bills",
  "profile": "Profile",
  "expense": "Expense",
  "income": "Income",
  "transfer": "Transfer",
  "monthlyExpense": "Monthly Expense",
  "monthlyIncome": "Monthly Income",
  "balance": "Balance",
  // ...
}
```

### 16.4 åç«¯å¤šè¯­è¨€æ”¯æŒ

```python
# åç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯ä¹Ÿæ”¯æŒå¤šè¯­è¨€
class I18nMessages:
    messages = {
        'auth.invalid_password': {
            'zh-CN': 'å¯†ç é”™è¯¯',
            'en-US': 'Invalid password',
            'ja-JP': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
        },
        'member.quota_exceeded': {
            'zh-CN': 'æœ¬æœˆå…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å‡çº§VIP',
            'en-US': 'Free quota exceeded, please upgrade to VIP',
            'ja-JP': 'ä»Šæœˆã®ç„¡æ–™å›æ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„',
        },
    }

    @classmethod
    def get(cls, key: str, locale: str = 'zh-CN') -> str:
        return cls.messages.get(key, {}).get(locale, key)
```

### 16.5 ç”¨æˆ·è¯­è¨€è®¾ç½®

```sql
-- ç”¨æˆ·è¡¨æ·»åŠ è¯­è¨€è®¾ç½®
ALTER TABLE users ADD COLUMN preferred_language VARCHAR(10);
ALTER TABLE users ADD COLUMN detected_language VARCHAR(10);  -- IPæ£€æµ‹è¯­è¨€
```

---

## åä¸ƒã€æ•°æ®å¤‡ä»½ç³»ç»Ÿè®¾è®¡

### 17.1 å¤‡ä»½ç­–ç•¥

| ç”¨æˆ·ç±»å‹ | è‡ªåŠ¨å¤‡ä»½é¢‘ç‡ | ä¿ç•™ä»½æ•° | æ‰‹åŠ¨å¤‡ä»½ |
|----------|--------------|----------|----------|
| å…è´¹ç”¨æˆ· | æ¯æœˆ1æ¬¡ | 1ä»½ | âœ… |
| VIPä¼šå‘˜ | æ¯æ—¥1æ¬¡ | 30ä»½ | âœ… æ— é™ |

### 17.2 å¤‡ä»½æ•°æ®è¡¨

```sql
-- ç”¨æˆ·å¤‡ä»½è®°å½•è¡¨
CREATE TABLE user_backups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    backup_type INT NOT NULL,            -- 1:è‡ªåŠ¨ 2:æ‰‹åŠ¨
    backup_size BIGINT NOT NULL,         -- å­—èŠ‚æ•°
    file_path VARCHAR(500) NOT NULL,     -- OSSè·¯å¾„
    file_hash VARCHAR(64),               -- SHA256æ ¡éªŒ
    data_summary JSONB,                  -- æ•°æ®æ‘˜è¦
    status INT DEFAULT 0,                -- 0:è¿›è¡Œä¸­ 1:æˆåŠŸ 2:å¤±è´¥
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP                 -- è¿‡æœŸæ—¶é—´
);

-- æ•°æ®æ‘˜è¦ç¤ºä¾‹
-- {
--   "transactions_count": 1234,
--   "accounts_count": 5,
--   "books_count": 2,
--   "categories_count": 30,
--   "date_range": {"from": "2024-01-01", "to": "2024-12-27"},
--   "total_expense": 50000.00,
--   "total_income": 80000.00
-- }
```

### 17.3 å¤‡ä»½å†…å®¹

```json
{
  "version": "1.0",
  "created_at": "2024-12-27T10:00:00Z",
  "user_id": "xxx",
  "data": {
    "user_settings": {
      "default_currency": "CNY",
      "preferred_language": "zh-CN",
      "theme": "light"
    },
    "books": [...],
    "accounts": [...],
    "categories": [...],
    "transactions": [...],
    "budgets": [...],
    "scheduled_transactions": [...]
  }
}
```

### 17.4 å¤‡ä»½æœåŠ¡å®ç°

```python
class BackupService:
    async def create_backup(self, user_id: str, backup_type: int = 1) -> str:
        """åˆ›å»ºç”¨æˆ·æ•°æ®å¤‡ä»½"""

        # 1. æ”¶é›†ç”¨æˆ·æ‰€æœ‰æ•°æ®
        data = await self._collect_user_data(user_id)

        # 2. åºåˆ—åŒ–ä¸ºJSON
        json_data = json.dumps(data, ensure_ascii=False, default=str)

        # 3. å‹ç¼©
        compressed = gzip.compress(json_data.encode('utf-8'))

        # 4. åŠ å¯†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±å¯†é’¥ï¼‰
        encrypted = await self._encrypt_data(compressed, user_id)

        # 5. ä¸Šä¼ åˆ°OSS
        file_path = f"backups/{user_id}/{datetime.now().strftime('%Y%m%d_%H%M%S')}.backup"
        await self.oss.upload(file_path, encrypted)

        # 6. è®°å½•å¤‡ä»½ä¿¡æ¯
        backup_record = await self._save_backup_record(
            user_id=user_id,
            backup_type=backup_type,
            file_path=file_path,
            backup_size=len(encrypted),
            data_summary=self._generate_summary(data)
        )

        # 7. æ¸…ç†è¿‡æœŸå¤‡ä»½
        await self._cleanup_old_backups(user_id)

        return backup_record.id

    async def restore_backup(self, user_id: str, backup_id: str):
        """æ¢å¤ç”¨æˆ·æ•°æ®"""

        # 1. è·å–å¤‡ä»½æ–‡ä»¶
        backup = await self.get_backup(backup_id)
        encrypted = await self.oss.download(backup.file_path)

        # 2. è§£å¯†
        compressed = await self._decrypt_data(encrypted, user_id)

        # 3. è§£å‹
        json_data = gzip.decompress(compressed).decode('utf-8')
        data = json.loads(json_data)

        # 4. æ¢å¤æ•°æ®ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
        async with self.db.transaction():
            # æ¸…ç©ºç°æœ‰æ•°æ®
            await self._clear_user_data(user_id)
            # å¯¼å…¥å¤‡ä»½æ•°æ®
            await self._import_data(user_id, data)

        return True

    async def _cleanup_old_backups(self, user_id: str):
        """æ¸…ç†è¿‡æœŸå¤‡ä»½"""
        user = await self.get_user(user_id)
        keep_count = 30 if user.is_vip else 1

        # è·å–æ‰€æœ‰å¤‡ä»½ï¼ŒæŒ‰æ—¶é—´å€’åº
        backups = await self.get_user_backups(user_id, order_by='-created_at')

        # åˆ é™¤è¶…å‡ºä¿ç•™æ•°é‡çš„å¤‡ä»½
        for backup in backups[keep_count:]:
            await self.oss.delete(backup.file_path)
            await backup.delete()
```

### 17.5 å®šæ—¶å¤‡ä»½ä»»åŠ¡

```python
# Celeryå®šæ—¶ä»»åŠ¡
@celery.task
def scheduled_backup():
    """æ¯æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ"""

    # VIPç”¨æˆ·æ¯æ—¥å¤‡ä»½
    vip_users = User.query.filter(User.is_vip == True).all()
    for user in vip_users:
        create_backup.delay(user.id, backup_type=1)

    # å…è´¹ç”¨æˆ·æ¯æœˆ1å·å¤‡ä»½
    if datetime.now().day == 1:
        free_users = User.query.filter(User.is_vip == False).all()
        for user in free_users:
            create_backup.delay(user.id, backup_type=1)

# Celery Beaté…ç½®
CELERYBEAT_SCHEDULE = {
    'daily-backup': {
        'task': 'tasks.scheduled_backup',
        'schedule': crontab(hour=3, minute=0),
    },
}
```

### 17.6 å¤‡ä»½ç®¡ç†ç•Œé¢

```
æ•°æ®å¤‡ä»½
â”œâ”€â”€ æœ€è¿‘å¤‡ä»½: 2024-12-27 03:00
â”œâ”€â”€ å¤‡ä»½å¤§å°: 2.3 MB
â”œâ”€â”€ æ•°æ®æ¦‚è¦:
â”‚   â”œâ”€â”€ è´¦ç›®: 3,240æ¡
â”‚   â”œâ”€â”€ è´¦æœ¬: 2ä¸ª
â”‚   â””â”€â”€ æ—¶é—´èŒƒå›´: 2024-01 ~ 2024-12
â”œâ”€â”€ å†å²å¤‡ä»½ (VIP: 30ä»½ / å…è´¹: 1ä»½)
â”‚   â”œâ”€â”€ 2024-12-27 03:00 - 2.3 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â”œâ”€â”€ 2024-12-26 03:00 - 2.2 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â””â”€â”€ ...
â””â”€â”€ [ç«‹å³å¤‡ä»½] [å¯¼å‡ºåˆ°æœ¬åœ°]
```

---

## åå…«ã€æ‰©å±•æ€§æ¶æ„è®¾è®¡

### 18.1 å®¹é‡è§„åˆ’ç›®æ ‡

| é˜¶æ®µ | DAU | æ³¨å†Œç”¨æˆ· | æ—¥è®°è´¦é‡ | å¹¶å‘è¯·æ±‚ | æ•°æ®å¢é•¿/æœˆ |
|------|-----|----------|----------|----------|-------------|
| **åˆæœŸ** | 1,000 | 5,000 | 5,000æ¡ | 50 QPS | 500MB |
| **ä¸­æœŸ** | 10,000 | 50,000 | 50,000æ¡ | 500 QPS | 5GB |
| **è¿œæœŸ** | 100,000 | 500,000 | 500,000æ¡ | 5,000 QPS | 50GB |

### 18.2 ä¸‰é˜¶æ®µæ¶æ„æ¼”è¿›

#### é˜¶æ®µä¸€ï¼šå•æœºæ¶æ„ (1,000 DAU)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‘æœåŠ¡å™¨ (å•æœº)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Nginx     â”‚  â”‚   FastAPI   â”‚  â”‚   Celery    â”‚         â”‚
â”‚  â”‚  (åå‘ä»£ç†) â”‚  â”‚  (2 workers)â”‚  â”‚  (1 worker) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚  â”‚   MinIO     â”‚         â”‚
â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (æœ¬åœ°å­˜å‚¨) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æœˆè´¹ç”¨ |
|------|------|--------|
| ECS | 2æ ¸4G | Â¥150 |
| äº‘ç›˜ | 100GB SSD | Â¥40 |
| å¸¦å®½ | 5Mbps | Â¥100 |
| **åˆè®¡** | | **Â¥290/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 200ms (P95)
- æ”¯æŒå¹¶å‘: 50-100 QPS
- æ•°æ®åº“è¿æ¥æ•°: 20

---

#### é˜¶æ®µäºŒï¼šåˆ†ç¦»æ¶æ„ (10,000 DAU)

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     SLB     â”‚
                        â”‚  (è´Ÿè½½å‡è¡¡) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚ â”‚   ...   â”‚ â”‚   API Server 2  â”‚
     â”‚   (2æ ¸4G)       â”‚ â”‚         â”‚ â”‚   (2æ ¸4G)       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL â”‚       â”‚     Redis     â”‚      â”‚     OSS     â”‚
â”‚   (2æ ¸4G)   â”‚       â”‚    (1æ ¸2G)    â”‚      â”‚  (å¯¹è±¡å­˜å‚¨) â”‚
â”‚   ä¸»ä»å¤åˆ¶   â”‚       â”‚    å•å®ä¾‹     â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| SLB | æ ‡å‡†å‹ | 1 | Â¥50 |
| ECS (API) | 2æ ¸4G | 2 | Â¥300 |
| RDS PostgreSQL | 2æ ¸4G | 1 | Â¥400 |
| Redis | 1æ ¸2G | 1 | Â¥150 |
| OSS | 100GB | 1 | Â¥20 |
| å¸¦å®½ | 10Mbps | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥1,120/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 150ms (P95)
- æ”¯æŒå¹¶å‘: 300-500 QPS
- æ•°æ®åº“è¿æ¥æ± : 50
- è¯»å†™åˆ†ç¦»æ”¯æŒ

**å‡çº§è·¯å¾„ï¼ˆä»é˜¶æ®µä¸€ï¼‰ï¼š**
1. æ•°æ®åº“è¿ç§»åˆ°RDSï¼ˆçº¦2å°æ—¶åœæœºï¼‰
2. éƒ¨ç½²ç¬¬äºŒå°APIæœåŠ¡å™¨
3. é…ç½®SLBè´Ÿè½½å‡è¡¡
4. æ–‡ä»¶å­˜å‚¨è¿ç§»åˆ°OSS
5. **é¢„è®¡å‡çº§æˆæœ¬**: Â¥0ï¼ˆå¹³æ»‘è¿ç§»ï¼‰
6. **é¢„è®¡å‡çº§æ—¶é—´**: 1å¤©

---

#### é˜¶æ®µä¸‰ï¼šé›†ç¾¤æ¶æ„ (100,000 DAU)

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     CDN     â”‚
                           â”‚  (é™æ€èµ„æº) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚     SLB     â”‚
                           â”‚ (è´Ÿè½½å‡è¡¡)  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚
â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚                             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ PGä¸»åº“ â”‚â—„â”€â”€â”€â”€ åŒæ­¥å¤åˆ¶ â”€â”€â”€â–ºâ”‚  PGä»åº“   â”‚                 â”‚  PGä»åº“   â”‚
â”‚(4æ ¸16G)â”‚                   â”‚ (4æ ¸8G)   â”‚                 â”‚ (4æ ¸8G)   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚                     Redis Cluster                           â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â””â”€â”€â”¼â”€â”€â–ºâ”‚ Master1 â”‚   â”‚ Master2 â”‚   â”‚ Master3 â”‚                  â”‚
       â”‚   â”‚ Slave1  â”‚   â”‚ Slave2  â”‚   â”‚ Slave3  â”‚                  â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| ACKé›†ç¾¤ | 4æ ¸8GèŠ‚ç‚¹ | 4 | Â¥2,400 |
| SLB | é«˜æ€§èƒ½å‹ | 1 | Â¥200 |
| RDS PostgreSQL | 4æ ¸16Gä¸» + 4æ ¸8Gä»x2 | 3 | Â¥2,500 |
| Redisé›†ç¾¤ | 4Gé›†ç¾¤ç‰ˆ | 1 | Â¥800 |
| OSS | 1TB + CDN | 1 | Â¥300 |
| å¸¦å®½ | 50Mbps | 1 | Â¥1,000 |
| æ—¥å¿—æœåŠ¡ | SLS | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥7,400/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 100ms (P95)
- æ”¯æŒå¹¶å‘: 3,000-5,000 QPS
- æ•°æ®åº“è¿æ¥æ± : 200
- è‡ªåŠ¨æ‰©ç¼©å®¹æ”¯æŒ

---

### 18.3 æ•°æ®åº“æ‰©å±•ç­–ç•¥

#### åˆ†è¡¨ç­–ç•¥ï¼ˆ10ä¸‡DAUæ—¶å¯ç”¨ï¼‰

```sql
-- è´¦ç›®è¡¨æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨
-- transactions_0, transactions_1, ... transactions_15 (16å¼ è¡¨)

-- åˆ†è¡¨è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_transaction_table(user_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN 'transactions_' || (hashtext(user_id::text) & 15)::text;
END;
$$ LANGUAGE plpgsql;
```

#### è¯»å†™åˆ†ç¦»é…ç½®

```python
# SQLAlchemyè¯»å†™åˆ†ç¦»
DATABASES = {
    'default': {
        'write': 'postgresql://master:5432/bookkeeping',
        'read': [
            'postgresql://slave1:5432/bookkeeping',
            'postgresql://slave2:5432/bookkeeping',
        ]
    }
}

class RoutingSession:
    def get_bind(self, mapper=None, clause=None):
        if self._flushing:
            return engines['write']
        return random.choice(engines['read'])
```

#### çƒ­æ•°æ®åˆ†ç¦»

```sql
-- çƒ­æ•°æ®è¡¨ï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
CREATE TABLE transactions_hot (
    LIKE transactions INCLUDING ALL
);

-- å†·æ•°æ®è¡¨ï¼ˆ3ä¸ªæœˆå‰ï¼‰
CREATE TABLE transactions_cold (
    LIKE transactions INCLUDING ALL
);

-- å®šæ—¶è¿ç§»ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
-- å°†3ä¸ªæœˆå‰çš„æ•°æ®ä»hotè¿ç§»åˆ°cold
```

---

### 18.4 ç¼“å­˜ç­–ç•¥

#### å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°ç¼“å­˜   â”‚ â”€â”€â–º â”‚   Redis     â”‚ â”€â”€â–º â”‚  æ•°æ®åº“     â”‚
â”‚  (LRU 1min) â”‚     â”‚  (TTL 5min) â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜é”®è®¾è®¡

```python
CACHE_KEYS = {
    # ç”¨æˆ·ä¿¡æ¯ (TTL: 30åˆ†é’Ÿ)
    'user:{user_id}': 'user_info',

    # ç”¨æˆ·è´¦æœ¬åˆ—è¡¨ (TTL: 10åˆ†é’Ÿ)
    'user:{user_id}:books': 'book_list',

    # æœˆåº¦ç»Ÿè®¡ (TTL: 5åˆ†é’Ÿ)
    'stats:{user_id}:{book_id}:{year}:{month}': 'monthly_stats',

    # åˆ†ç±»åˆ—è¡¨ (TTL: 1å°æ—¶)
    'categories:{user_id}': 'category_list',

    # æ±‡ç‡ (TTL: 1å°æ—¶)
    'exchange_rate:{from}:{to}:{date}': 'rate',
}
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥

```python
class CacheManager:
    # å†™åå¤±æ•ˆæ¨¡å¼
    async def invalidate_on_write(self, user_id: str, entity: str):
        patterns = {
            'transaction': [
                f'stats:{user_id}:*',
                f'user:{user_id}:recent_transactions',
            ],
            'account': [
                f'user:{user_id}:accounts',
                f'account:{user_id}:*',
            ],
        }
        for pattern in patterns.get(entity, []):
            await self.redis.delete_pattern(pattern)
```

---

### 18.5 APIæ€§èƒ½ä¼˜åŒ–

#### æ¥å£é™æµé…ç½®

```python
from fastapi_limiter import RateLimiter

# é™æµè§„åˆ™
RATE_LIMITS = {
    # æ™®é€šæ¥å£: 100æ¬¡/åˆ†é’Ÿ
    'default': '100/minute',

    # AIæ¥å£: 10æ¬¡/åˆ†é’Ÿ (å…è´¹ç”¨æˆ·) / 60æ¬¡/åˆ†é’Ÿ (VIP)
    'ai_ocr': {'free': '10/minute', 'vip': '60/minute'},
    'ai_voice': {'free': '20/minute', 'vip': '120/minute'},

    # ç™»å½•æ¥å£: 5æ¬¡/åˆ†é’Ÿ (é˜²æš´åŠ›ç ´è§£)
    'auth_login': '5/minute',

    # å¯¼å‡ºæ¥å£: 5æ¬¡/å°æ—¶
    'export': '5/hour',
}
```

#### æ‰¹é‡æ¥å£ä¼˜åŒ–

```python
# æ‰¹é‡åˆ›å»ºè´¦ç›® (å‡å°‘ç½‘ç»œå¾€è¿”)
@router.post("/transactions/batch")
async def batch_create_transactions(
    transactions: List[TransactionCreate],  # æœ€å¤š50æ¡
    db: AsyncSession = Depends(get_db)
):
    # ä½¿ç”¨æ‰¹é‡æ’å…¥
    await db.execute(
        insert(Transaction),
        [t.dict() for t in transactions]
    )
```

#### å“åº”å‹ç¼©

```python
from fastapi.middleware.gzip import GZipMiddleware

app.add_middleware(GZipMiddleware, minimum_size=1000)
```

---

### 18.6 ç›‘æ§ä¸å‘Šè­¦

#### ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheus ç›‘æ§é…ç½®
metrics:
  # åº”ç”¨å±‚
  - api_request_total          # è¯·æ±‚æ€»æ•°
  - api_request_duration_seconds  # å“åº”æ—¶é—´
  - api_error_total            # é”™è¯¯æ•°

  # æ•°æ®åº“å±‚
  - db_connection_pool_size    # è¿æ¥æ± å¤§å°
  - db_query_duration_seconds  # æŸ¥è¯¢æ—¶é—´

  # ç¼“å­˜å±‚
  - cache_hit_ratio            # ç¼“å­˜å‘½ä¸­ç‡
  - cache_memory_usage         # å†…å­˜ä½¿ç”¨

  # ä¸šåŠ¡å±‚
  - active_users_daily         # æ—¥æ´»ç”¨æˆ·
  - transactions_created_total # è®°è´¦æ•°é‡
  - ai_requests_total          # AIè°ƒç”¨æ¬¡æ•°
```

#### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  # APIå“åº”æ—¶é—´ > 500ms
  - alert: HighApiLatency
    expr: api_request_duration_seconds{quantile="0.95"} > 0.5
    for: 5m

  # é”™è¯¯ç‡ > 1%
  - alert: HighErrorRate
    expr: rate(api_error_total[5m]) / rate(api_request_total[5m]) > 0.01
    for: 5m

  # æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ > 80%
  - alert: DbConnectionPoolHigh
    expr: db_connection_pool_size / db_connection_pool_max > 0.8
    for: 5m

  # Rediså†…å­˜ä½¿ç”¨ > 80%
  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
```

---

### 18.7 æˆæœ¬å¯¹æ¯”æ€»ç»“

| é˜¶æ®µ | DAU | æœˆè´¹ç”¨ | å•ç”¨æˆ·æˆæœ¬ | å‡çº§æˆæœ¬ |
|------|-----|--------|------------|----------|
| åˆæœŸ | 1,000 | Â¥290 | Â¥0.29 | - |
| ä¸­æœŸ | 10,000 | Â¥1,120 | Â¥0.11 | Â¥0 |
| è¿œæœŸ | 100,000 | Â¥7,400 | Â¥0.07 | Â¥0 |

**å…³é”®è®¾è®¡åŸåˆ™ï¼š**
1. **æ— çŠ¶æ€APIæœåŠ¡** - æ”¯æŒæ°´å¹³æ‰©å±•
2. **æ•°æ®åº“è¯»å†™åˆ†ç¦»** - æ‰©å±•è¯»æ€§èƒ½
3. **å¤šçº§ç¼“å­˜** - å‡å°‘æ•°æ®åº“å‹åŠ›
4. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** - AIå¤„ç†ä¸é˜»å¡ä¸»æµç¨‹
5. **å¹³æ»‘å‡çº§** - æ¯æ¬¡å‡çº§åœæœºæ—¶é—´ < 30åˆ†é’Ÿ

---

### 18.8 æŠ€æœ¯é€‰å‹å¯¹æ¯”

#### ä¸ºä»€ä¹ˆé€‰æ‹©å•ä½“æ¶æ„è€Œéå¾®æœåŠ¡ï¼ˆåˆæœŸï¼‰

| ç»´åº¦ | å•ä½“æ¶æ„ | å¾®æœåŠ¡æ¶æ„ |
|------|----------|------------|
| å¼€å‘å¤æ‚åº¦ | ä½ | é«˜ |
| éƒ¨ç½²å¤æ‚åº¦ | ä½ | é«˜ |
| è¿ç»´æˆæœ¬ | Â¥290/æœˆ | Â¥2000+/æœˆ |
| é€‚åˆé˜¶æ®µ | < 5ä¸‡DAU | > 10ä¸‡DAU |
| å›¢é˜Ÿè§„æ¨¡ | 1-3äºº | 5+äºº |

**ç»“è®ºï¼š** åˆæœŸé‡‡ç”¨å•ä½“æ¶æ„ï¼Œå½“DAUè¶…è¿‡5ä¸‡ä¸”å›¢é˜Ÿæ‰©å¤§åå†è€ƒè™‘å¾®æœåŠ¡æ‹†åˆ†ã€‚

#### æ½œåœ¨çš„å¾®æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆï¼ˆè¿œæœŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚  â”‚  è®°è´¦æœåŠ¡   â”‚  â”‚  ç»Ÿè®¡æœåŠ¡   â”‚
â”‚ user-svc   â”‚  â”‚ txn-svc    â”‚  â”‚ stats-svc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIæœåŠ¡    â”‚  â”‚  é€šçŸ¥æœåŠ¡   â”‚  â”‚  æ”¯ä»˜æœåŠ¡   â”‚
â”‚  ai-svc    â”‚  â”‚ notify-svc â”‚  â”‚ payment-svcâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åä¹ã€å¼€å‘è®¡åˆ’ï¼ˆæ›´æ–°ç‰ˆï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ï¼ˆæ‰‹æœºå·+ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰
- [ ] å¤šè¯­è¨€åŸºç¡€æ¡†æ¶
- [ ] ç¦»çº¿æ¨¡å¼åŸºç¡€æ”¯æŒ

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] å¤šè´§å¸æ”¯æŒ
- [ ] æ•°æ®å¯¼å‡º
- [ ] æ•°æ®å¤‡ä»½

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ
- [ ] æ”¯ä»˜é›†æˆ

### ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–è¿­ä»£
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ›´å¤šè¯­è¨€æ”¯æŒ
- [ ] æ›´å¤šè´§å¸æ”¯æŒ
- [ ] é«˜çº§æŠ¥è¡¨åŠŸèƒ½

---

ä»¥ä¸Šæ˜¯AIæ™ºèƒ½è®°è´¦åº”ç”¨çš„å®Œæ•´æ¶æ„è®¾è®¡ï¼ŒåŒ…å«äº†æ‰€æœ‰ç¡®è®¤çš„åŠŸèƒ½éœ€æ±‚ã€‚å¦‚æœ‰éœ€è¦è°ƒæ•´çš„åœ°æ–¹è¯·æå‡ºã€‚
