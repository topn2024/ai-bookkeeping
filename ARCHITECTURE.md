# AIæ™ºèƒ½è®°è´¦åº”ç”¨ - æ¶æ„è®¾è®¡æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®åç§°
**AI Bookkeeping** (æ™ºèƒ½è®°è´¦)

### 1.2 é¡¹ç›®ç›®æ ‡
æ‰“é€ ä¸€æ¬¾AIé©±åŠ¨çš„æ™ºèƒ½è®°è´¦åº”ç”¨ï¼Œæ”¯æŒå¤šç§è®°è´¦æ–¹å¼ï¼ˆå›¾ç‰‡è¯†åˆ«ã€è¯­éŸ³è¾“å…¥ã€é‚®ç®±è´¦å•è§£æã€æ‰‹åŠ¨å½•å…¥ï¼‰ï¼Œæä¾›ä¸°å¯Œçš„ç»Ÿè®¡æŠ¥è¡¨åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·è½»æ¾ç®¡ç†ä¸ªäºº/å®¶åº­è´¢åŠ¡ã€‚

### 1.3 æ ¸å¿ƒåŠŸèƒ½
1. **æ™ºèƒ½è®°è´¦**
   - å›¾ç‰‡/æ‹ç…§è¯†åˆ«ï¼šè‡ªåŠ¨è¯†åˆ«å°ç¥¨ã€å‘ç¥¨ã€è´¦å•
   - è¯­éŸ³è®°è´¦ï¼šè¯­éŸ³è½¬æ–‡å­—è‡ªåŠ¨è§£æé‡‘é¢å’Œåˆ†ç±»
   - é‚®ç®±è´¦å•è§£æï¼šè‡ªåŠ¨è·å–ä¿¡ç”¨å¡è´¦å•ç”Ÿæˆè®°å½•
   - æ‰‹åŠ¨è®°è´¦ï¼šæ”¯æŒæ”¯å‡º/æ”¶å…¥/è½¬è´¦

2. **è´¦ç›®ç®¡ç†**
   - å¤šè´¦æœ¬æ”¯æŒ
   - å¤šæˆå‘˜åä½œ
   - åˆ†ç±»ç®¡ç†ï¼ˆæ”¯å‡º/æ”¶å…¥ï¼‰
   - è´¦æˆ·ç®¡ç†ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€ä¿¡ç”¨å¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡ç­‰ï¼‰

3. **ç»Ÿè®¡æŠ¥è¡¨**
   - æ”¶æ”¯æ€»è§ˆ
   - è¶‹åŠ¿åˆ†æï¼ˆæ—¥/å‘¨/æœˆ/å¹´ï¼‰
   - åˆ†ç±»å æ¯”
   - æŠ¥é”€ç»Ÿè®¡
   - é¢„ç®—ç®¡ç†

4. **ä¸ªäººä¸­å¿ƒ**
   - ä¼šå‘˜ç³»ç»Ÿ
   - ä¸»é¢˜è®¾ç½®
   - æ•°æ®å¯¼å…¥/å¯¼å‡º
   - å®šæ—¶è®°è´¦

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯ (Mobile App)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Flutter (iOS & Android)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚   é¦–é¡µ   â”‚ â”‚   ç»Ÿè®¡   â”‚ â”‚   è´¦å•   â”‚ â”‚   æˆ‘çš„   â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS/REST API
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Gateway                              â”‚
â”‚                    (Nginx / Kong / AWS ALB)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡ (Backend)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Python FastAPI                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”‚  è®°è´¦æœåŠ¡    â”‚ â”‚  ç»Ÿè®¡æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  AIè¯†åˆ«æœåŠ¡  â”‚ â”‚  é‚®ä»¶è§£æ    â”‚ â”‚  é€šçŸ¥æœåŠ¡    â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostgreSQL    â”‚ â”‚      Redis       â”‚ â”‚   MinIO/OSS      â”‚
â”‚   (ä¸»æ•°æ®åº“)     â”‚ â”‚   (ç¼“å­˜/é˜Ÿåˆ—)    â”‚ â”‚   (æ–‡ä»¶å­˜å‚¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AI æœåŠ¡å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Claude API   â”‚ â”‚ Whisper API  â”‚ â”‚ OCR Service  â”‚            â”‚
â”‚  â”‚ (æ–‡æœ¬ç†è§£)   â”‚ â”‚ (è¯­éŸ³è¯†åˆ«)   â”‚ â”‚ (å›¾ç‰‡è¯†åˆ«)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

#### å‰ç«¯ (Mobile App)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | **Flutter 3.x** | ä¸€å¥—ä»£ç ï¼ŒåŒæ—¶æ”¯æŒiOSå’ŒAndroid |
| çŠ¶æ€ç®¡ç† | **Riverpod** | ç®€æ´ã€ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç† |
| ç½‘ç»œè¯·æ±‚ | **Dio** | å¼ºå¤§çš„HTTPå®¢æˆ·ç«¯ |
| æœ¬åœ°å­˜å‚¨ | **Hive + SQLite** | ç¦»çº¿æ•°æ®ç¼“å­˜ |
| å›¾è¡¨ | **fl_chart** | ç¾è§‚çš„ç»Ÿè®¡å›¾è¡¨ |
| ç›¸æœº | **camera + image_picker** | æ‹ç…§å’Œå›¾ç‰‡é€‰æ‹© |
| è¯­éŸ³ | **speech_to_text** | è¯­éŸ³è¾“å…¥ |
| UIç»„ä»¶ | **è‡ªå®šä¹‰ç»„ä»¶åº“** | å‚ç…§è®¾è®¡ç¨¿å®šåˆ¶ |

#### åç«¯ (Backend)
| æŠ€æœ¯ | é€‰å‹ | è¯´æ˜ |
|------|------|------|
| è¯­è¨€ | **Python 3.11+** | AIç”Ÿæ€ä¸°å¯Œ |
| æ¡†æ¶ | **FastAPI** | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| ORM | **SQLAlchemy 2.0** | æ•°æ®åº“æ˜ å°„ |
| æ•°æ®åº“ | **PostgreSQL 15** | ä¸»æ•°æ®å­˜å‚¨ |
| ç¼“å­˜ | **Redis 7** | ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ— |
| ä»»åŠ¡é˜Ÿåˆ— | **Celery** | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| æ–‡ä»¶å­˜å‚¨ | **MinIO / é˜¿é‡Œäº‘OSS** | å›¾ç‰‡ç­‰æ–‡ä»¶å­˜å‚¨ |

#### AIæœåŠ¡
| åŠŸèƒ½ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜ |
|------|----------|------|
| å›¾ç‰‡è¯†åˆ«(OCR) | **PaddleOCR** + Claude | æœ¬åœ°OCR + AIç†è§£ |
| è¯­éŸ³è¯†åˆ« | **Whisper API** | OpenAIè¯­éŸ³è½¬æ–‡å­— |
| æ™ºèƒ½åˆ†ç±» | **Claude API** | è‡ªåŠ¨è¯†åˆ«æ¶ˆè´¹ç±»å‹ |
| è´¦å•è§£æ | **Claude API** | è§£æé‚®ä»¶ä¸­çš„è´¦å• |

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    password_hash VARCHAR(255),
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    member_level INT DEFAULT 0,  -- 0:æ™®é€š 1:VIP
    member_expire_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬è¡¨
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(50),
    cover_image VARCHAR(500),
    book_type INT DEFAULT 0,  -- 0:æ™®é€š 1:å®¶åº­ 2:å•†åŠ¡
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æœ¬æˆå‘˜è¡¨
CREATE TABLE book_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    book_id UUID REFERENCES books(id),
    user_id UUID REFERENCES users(id),
    role INT DEFAULT 0,  -- 0:æˆå‘˜ 1:ç®¡ç†å‘˜ 2:æ‰€æœ‰è€…
    joined_at TIMESTAMP DEFAULT NOW()
);

-- è´¦æˆ·è¡¨ï¼ˆç°é‡‘ã€é“¶è¡Œå¡ã€æ”¯ä»˜å®ç­‰ï¼‰
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    account_type INT NOT NULL,  -- 1:ç°é‡‘ 2:å‚¨è“„å¡ 3:ä¿¡ç”¨å¡ 4:æ”¯ä»˜å® 5:å¾®ä¿¡
    icon VARCHAR(50),
    balance DECIMAL(15,2) DEFAULT 0,
    credit_limit DECIMAL(15,2),  -- ä¿¡ç”¨å¡é¢åº¦
    bill_day INT,  -- è´¦å•æ—¥
    repay_day INT,  -- è¿˜æ¬¾æ—¥
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,  -- NULLè¡¨ç¤ºç³»ç»Ÿé¢„è®¾
    parent_id UUID REFERENCES categories(id),
    name VARCHAR(50) NOT NULL,
    icon VARCHAR(50),
    category_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥
    sort_order INT DEFAULT 0,
    is_system BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è´¦ç›®è®°å½•è¡¨
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    account_id UUID REFERENCES accounts(id),
    target_account_id UUID REFERENCES accounts(id),  -- è½¬è´¦ç›®æ ‡
    category_id UUID REFERENCES categories(id),
    transaction_type INT NOT NULL,  -- 1:æ”¯å‡º 2:æ”¶å…¥ 3:è½¬è´¦
    amount DECIMAL(15,2) NOT NULL,
    fee DECIMAL(15,2) DEFAULT 0,  -- æ‰‹ç»­è´¹
    transaction_date DATE NOT NULL,
    transaction_time TIME,
    note VARCHAR(500),
    tags VARCHAR(200)[],
    images VARCHAR(500)[],
    location VARCHAR(200),
    is_reimbursable BOOLEAN DEFAULT FALSE,  -- å¯æŠ¥é”€
    is_reimbursed BOOLEAN DEFAULT FALSE,    -- å·²æŠ¥é”€
    is_exclude_stats BOOLEAN DEFAULT FALSE, -- ä¸è®¡æ”¶æ”¯
    source INT DEFAULT 0,  -- 0:æ‰‹åŠ¨ 1:å›¾ç‰‡ 2:è¯­éŸ³ 3:é‚®ä»¶
    ai_confidence DECIMAL(3,2),  -- AIè¯†åˆ«ç½®ä¿¡åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é¢„ç®—è¡¨
CREATE TABLE budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    book_id UUID REFERENCES books(id),
    category_id UUID REFERENCES categories(id),  -- NULLè¡¨ç¤ºæ€»é¢„ç®—
    budget_type INT NOT NULL,  -- 1:æœˆåº¦ 2:å¹´åº¦
    amount DECIMAL(15,2) NOT NULL,
    year INT NOT NULL,
    month INT,  -- å¹´åº¦é¢„ç®—ä¸ºNULL
    created_at TIMESTAMP DEFAULT NOW()
);

-- å®šæ—¶è®°è´¦è¡¨
CREATE TABLE scheduled_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    template_data JSONB NOT NULL,  -- è®°è´¦æ¨¡æ¿
    frequency INT NOT NULL,  -- 1:æ¯å¤© 2:æ¯å‘¨ 3:æ¯æœˆ 4:æ¯å¹´
    next_execute_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- é‚®ç®±ç»‘å®šè¡¨
CREATE TABLE email_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    email VARCHAR(100) NOT NULL,
    email_type INT NOT NULL,  -- 1:Gmail 2:Outlook 3:QQ 4:163
    access_token TEXT,
    refresh_token TEXT,
    last_sync_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 ç´¢å¼•è®¾è®¡

```sql
-- è´¦ç›®æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_user_date ON transactions(user_id, transaction_date DESC);
CREATE INDEX idx_transactions_book_date ON transactions(book_id, transaction_date DESC);
CREATE INDEX idx_transactions_category ON transactions(category_id, transaction_date DESC);

-- ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_transactions_stats ON transactions(user_id, book_id, transaction_type, transaction_date);
```

---

## å››ã€APIè®¾è®¡

### 4.1 APIè§„èŒƒ
- RESTfulé£æ ¼
- JWT Tokenè®¤è¯
- ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
    "code": 0,
    "message": "success",
    "data": {}
}
```

### 4.2 æ ¸å¿ƒAPIåˆ—è¡¨

#### è®¤è¯æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/auth/register | æ³¨å†Œ |
| POST | /api/v1/auth/login | ç™»å½• |
| POST | /api/v1/auth/refresh | åˆ·æ–°Token |
| POST | /api/v1/auth/logout | ç™»å‡º |

#### è´¦æœ¬æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/books | è·å–è´¦æœ¬åˆ—è¡¨ |
| POST | /api/v1/books | åˆ›å»ºè´¦æœ¬ |
| PUT | /api/v1/books/{id} | æ›´æ–°è´¦æœ¬ |
| DELETE | /api/v1/books/{id} | åˆ é™¤è´¦æœ¬ |
| POST | /api/v1/books/{id}/members | æ·»åŠ æˆå‘˜ |

#### è®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/transactions | è·å–è´¦ç›®åˆ—è¡¨ |
| POST | /api/v1/transactions | åˆ›å»ºè´¦ç›® |
| PUT | /api/v1/transactions/{id} | æ›´æ–°è´¦ç›® |
| DELETE | /api/v1/transactions/{id} | åˆ é™¤è´¦ç›® |
| POST | /api/v1/transactions/batch | æ‰¹é‡åˆ›å»º |

#### AIè®°è´¦æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/v1/ai/recognize-image | å›¾ç‰‡è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/recognize-voice | è¯­éŸ³è¯†åˆ«è®°è´¦ |
| POST | /api/v1/ai/parse-bill | è§£æè´¦å•é‚®ä»¶ |

#### ç»Ÿè®¡æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/stats/overview | æ”¶æ”¯æ¦‚è§ˆ |
| GET | /api/v1/stats/trend | è¶‹åŠ¿åˆ†æ |
| GET | /api/v1/stats/category | åˆ†ç±»ç»Ÿè®¡ |
| GET | /api/v1/stats/budget | é¢„ç®—æ‰§è¡Œæƒ…å†µ |

#### è´¦æˆ·æ¨¡å—
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/v1/accounts | è´¦æˆ·åˆ—è¡¨ |
| POST | /api/v1/accounts | åˆ›å»ºè´¦æˆ· |
| PUT | /api/v1/accounts/{id} | æ›´æ–°è´¦æˆ· |
| GET | /api/v1/accounts/{id}/balance | è´¦æˆ·ä½™é¢ |

---

## äº”ã€å‰ç«¯é¡µé¢è®¾è®¡

### 5.1 é¡µé¢ç»“æ„

```
App
â”œâ”€â”€ å¯åŠ¨é¡µ (Splash)
â”œâ”€â”€ ç™»å½•/æ³¨å†Œ
â”‚   â”œâ”€â”€ æ‰‹æœºå·ç™»å½•
â”‚   â”œâ”€â”€ éªŒè¯ç ç™»å½•
â”‚   â””â”€â”€ ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ï¼‰
â”œâ”€â”€ ä¸»é¡µé¢ (åº•éƒ¨å¯¼èˆª)
â”‚   â”œâ”€â”€ é¦–é¡µ (Home)
â”‚   â”‚   â”œâ”€â”€ è´¦æœ¬åˆ‡æ¢
â”‚   â”‚   â”œâ”€â”€ æœ¬æœˆæ¦‚è§ˆå¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ å¿«æ·åŠŸèƒ½å…¥å£
â”‚   â”‚   â”œâ”€â”€ é¢„ç®—è¿›åº¦
â”‚   â”‚   â””â”€â”€ æœˆè´¦å•åˆ—è¡¨
â”‚   â”œâ”€â”€ ç»Ÿè®¡ (Stats)
â”‚   â”‚   â”œâ”€â”€ æ—¶é—´ç­›é€‰ï¼ˆæœˆ/å¹´/èŒƒå›´/æ—¥/å‘¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ æ€»è§ˆTab
â”‚   â”‚   â”œâ”€â”€ è¶‹åŠ¿Tab
â”‚   â”‚   â””â”€â”€ åˆ†ç±»Tab
â”‚   â”œâ”€â”€ è´¦å• (Bills)
â”‚   â”‚   â””â”€â”€ è´¦å•åˆ—è¡¨/æ—¥å†è§†å›¾
â”‚   â””â”€â”€ æˆ‘çš„ (Profile)
â”‚       â”œâ”€â”€ ä¼šå‘˜ä¿¡æ¯
â”‚       â”œâ”€â”€ è®¾ç½®åˆ—è¡¨
â”‚       â””â”€â”€ ç®¡ç†åŠŸèƒ½
â”œâ”€â”€ è®°è´¦é¡µé¢
â”‚   â”œâ”€â”€ æ”¯å‡ºè®°è´¦
â”‚   â”œâ”€â”€ æ”¶å…¥è®°è´¦
â”‚   â””â”€â”€ è½¬è´¦è®°è´¦
â”œâ”€â”€ AIè®°è´¦
â”‚   â”œâ”€â”€ æ‹ç…§/å›¾ç‰‡è¯†åˆ«
â”‚   â”œâ”€â”€ è¯­éŸ³è®°è´¦
â”‚   â””â”€â”€ è´¦å•å¯¼å…¥
â””â”€â”€ è®¾ç½®é¡µé¢
    â”œâ”€â”€ ä¸ªäººè®¾ç½®
    â”œâ”€â”€ è´¦æœ¬ç®¡ç†
    â”œâ”€â”€ åˆ†ç±»ç®¡ç†
    â”œâ”€â”€ è´¦æˆ·ç®¡ç†
    â””â”€â”€ ä¸»é¢˜è®¾ç½®
```

### 5.2 è®¾è®¡è§„èŒƒ

#### é¢œè‰²ç³»ç»Ÿ
```dart
// ä¸»è‰²è°ƒ
static const primary = Color(0xFF00C9A7);      // è–„è·ç»¿
static const primaryLight = Color(0xFFE8FFF8);

// åŠŸèƒ½è‰²
static const expense = Color(0xFFFF6B6B);      // æ”¯å‡ºçº¢
static const income = Color(0xFF4CAF50);       // æ”¶å…¥ç»¿
static const transfer = Color(0xFF2196F3);     // è½¬è´¦è“

// ä¸­æ€§è‰²
static const textPrimary = Color(0xFF333333);
static const textSecondary = Color(0xFF999999);
static const background = Color(0xFFF5F5F5);
static const cardBackground = Color(0xFFFFFFFF);
```

#### å­—ä½“è§„èŒƒ
```dart
// æ ‡é¢˜
static const headlineLarge = TextStyle(fontSize: 28, fontWeight: FontWeight.bold);
static const headlineMedium = TextStyle(fontSize: 24, fontWeight: FontWeight.bold);

// é‡‘é¢
static const amountLarge = TextStyle(fontSize: 32, fontWeight: FontWeight.bold);
static const amountMedium = TextStyle(fontSize: 20, fontWeight: FontWeight.w600);

// æ­£æ–‡
static const bodyLarge = TextStyle(fontSize: 16);
static const bodyMedium = TextStyle(fontSize: 14);
static const bodySmall = TextStyle(fontSize: 12);
```

---

## å…­ã€AIåŠŸèƒ½è®¾è®¡

### 6.1 å›¾ç‰‡è¯†åˆ«æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ‹ç…§  â”‚ â”€â”€â–¶ â”‚ OCRè¯†åˆ«  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ /é€‰å›¾ç‰‡  â”‚     â”‚ æ–‡å­—æå–  â”‚     â”‚ æ™ºèƒ½è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯†åˆ«å†…å®¹ï¼š**
- å•†æˆ·åç§°
- æ¶ˆè´¹é‡‘é¢
- æ¶ˆè´¹æ—¶é—´
- å•†å“æ˜ç»†
- è‡ªåŠ¨åˆ†ç±»å»ºè®®

### 6.2 è¯­éŸ³è®°è´¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯´è¯  â”‚ â”€â”€â–¶ â”‚ Whisper  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ è¿”å›ç»“æœ  â”‚
â”‚ æŒ‰ä½å½•éŸ³  â”‚     â”‚ è¯­éŸ³è½¬æ–‡å­—â”‚     â”‚ æ„å›¾è§£æ  â”‚     â”‚ ç¡®è®¤ä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹è¾“å…¥ï¼š**
- "ä»Šå¤©åˆé¥­èŠ±äº†35å—"
- "ä¹°äº†ä¸€æ¯å’–å•¡28å…ƒ"
- "è¿™ä¸ªæœˆå·¥èµ„åˆ°è´¦8000"

### 6.3 é‚®ç®±è´¦å•è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæƒé‚®ç®±  â”‚ â”€â”€â–¶ â”‚ è·å–é‚®ä»¶  â”‚ â”€â”€â–¶ â”‚ Claude   â”‚ â”€â”€â–¶ â”‚ æ‰¹é‡å¯¼å…¥  â”‚
â”‚ OAuth    â”‚     â”‚ ç­›é€‰è´¦å•  â”‚     â”‚ è§£æè´¦å•  â”‚     â”‚ ç”¨æˆ·ç¡®è®¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æŒé“¶è¡Œï¼š**
- æ‹›å•†é“¶è¡Œã€å·¥å•†é“¶è¡Œã€å»ºè®¾é“¶è¡Œç­‰
- æ”¯ä»˜å®ã€å¾®ä¿¡è´¦å•
- ä¿¡ç”¨å¡ç”µå­è´¦å•

---

## ä¸ƒã€é¡¹ç›®ç›®å½•ç»“æ„

### 7.1 å‰ç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-app/
â”œâ”€â”€ android/                    # AndroidåŸç”Ÿä»£ç 
â”œâ”€â”€ ios/                        # iOSåŸç”Ÿä»£ç 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart              # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ app.dart           # Appé…ç½®
â”‚   â”‚   â””â”€â”€ routes.dart        # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ constants/         # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ theme/             # ä¸»é¢˜é…ç½®
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ extensions/        # æ‰©å±•æ–¹æ³•
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ repositories/      # æ•°æ®ä»“åº“
â”‚   â”‚   â”œâ”€â”€ providers/         # çŠ¶æ€æä¾›è€…
â”‚   â”‚   â””â”€â”€ services/          # APIæœåŠ¡
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ home/              # é¦–é¡µæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ stats/             # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ bills/             # è´¦å•æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ profile/           # ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ transaction/       # è®°è´¦æ¨¡å—
â”‚   â”‚   â””â”€â”€ ai/                # AIè®°è´¦æ¨¡å—
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ widgets/           # é€šç”¨ç»„ä»¶
â”‚       â””â”€â”€ dialogs/           # å¼¹çª—ç»„ä»¶
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ images/                # å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ icons/                 # å›¾æ ‡èµ„æº
â”‚   â””â”€â”€ fonts/                 # å­—ä½“æ–‡ä»¶
â”œâ”€â”€ test/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ pubspec.yaml               # ä¾èµ–é…ç½®
â””â”€â”€ README.md
```

### 7.2 åç«¯é¡¹ç›®ç»“æ„

```
ai-bookkeeping-server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # FastAPIå…¥å£
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ exceptions.py      # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py        # è®¤è¯æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ users.py       # ç”¨æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ books.py       # è´¦æœ¬æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ transactions.py# è®°è´¦æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ accounts.py    # è´¦æˆ·æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ categories.py  # åˆ†ç±»æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ stats.py       # ç»Ÿè®¡æ¥å£
â”‚   â”‚   â”‚   â””â”€â”€ ai.py          # AIæ¥å£
â”‚   â”‚   â””â”€â”€ deps.py            # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ account.py         # è´¦æˆ·æ¨¡å‹
â”‚   â”‚   â””â”€â”€ category.py        # åˆ†ç±»æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·Schema
â”‚   â”‚   â”œâ”€â”€ book.py            # è´¦æœ¬Schema
â”‚   â”‚   â”œâ”€â”€ transaction.py     # è®°è´¦Schema
â”‚   â”‚   â””â”€â”€ stats.py           # ç»Ÿè®¡Schema
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py    # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”œâ”€â”€ stats_service.py   # ç»Ÿè®¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ ai_service.py      # AIæœåŠ¡
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ email_parser.py    # é‚®ä»¶è§£æä»»åŠ¡
â”‚       â””â”€â”€ scheduled.py       # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                      # æµ‹è¯•ä»£ç 
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ Dockerfile                  # Dockeré…ç½®
â”œâ”€â”€ docker-compose.yml          # Dockerç¼–æ’
â””â”€â”€ README.md
```

---

## å…«ã€éƒ¨ç½²æ¶æ„

### 8.1 å¼€å‘ç¯å¢ƒ
- æœ¬åœ°å¼€å‘ä½¿ç”¨Docker Compose
- çƒ­é‡è½½æ”¯æŒ

### 8.2 ç”Ÿäº§ç¯å¢ƒ

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   CDN (é™æ€)    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  è´Ÿè½½å‡è¡¡ (SLB) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚   â”‚   API Server 2  â”‚   â”‚   API Server N  â”‚
     â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚   â”‚   (K8s Pod)     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                              â”‚                              â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚PostgreSQLâ”‚                   â”‚   Redis   â”‚                  â”‚   MinIO   â”‚
â”‚ (RDS)   â”‚                   â”‚  Cluster  â”‚                  â”‚   (OSS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æ¨èäº‘æœåŠ¡
- **æœåŠ¡å™¨**ï¼šé˜¿é‡Œäº‘ECS / AWS EC2
- **æ•°æ®åº“**ï¼šé˜¿é‡Œäº‘RDS PostgreSQL
- **ç¼“å­˜**ï¼šé˜¿é‡Œäº‘Redis
- **å­˜å‚¨**ï¼šé˜¿é‡Œäº‘OSS
- **å®¹å™¨**ï¼šé˜¿é‡Œäº‘ACK (Kubernetes)

---

## ä¹ã€å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] æ•°æ®å¯¼å‡º

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ

---

## åã€åˆ†ç±»é¢„è®¾

### 10.1 æ”¯å‡ºåˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | å­åˆ†ç±» |
|------|------|--------|
| ğŸ½ï¸ | é¤é¥® | æ—©é¤ã€åˆé¤ã€æ™šé¤ã€é¥®æ–™ã€é›¶é£Ÿ |
| ğŸ  | ä½æˆ¿ | æˆ¿ç§Ÿã€ç‰©ä¸šè´¹ã€æ°´ç”µç‡ƒæ°”ã€ç»´ä¿® |
| ğŸ® | å¨±ä¹ | æ¸¸æˆã€ç”µå½±ã€KTVã€æ—…æ¸¸ |
| ğŸ‘¥ | äººæƒ… | çº¢åŒ…ã€ç¤¼ç‰©ã€è¯·å®¢ |
| ğŸ‘¶ | è‚²å„¿ | å¥¶ç²‰ã€ç©å…·ã€æ•™è‚²ã€åŒ»ç–— |
| âœˆï¸ | å·®æ—… | æœºç¥¨ã€é…’åº—ã€æ‰“è½¦ã€ç«è½¦ |
| ğŸšŒ | äº¤é€š | å…¬äº¤ã€åœ°é“ã€æ‰“è½¦ã€å…±äº«å•è½¦ |
| ğŸš— | æ±½è½¦ | åŠ æ²¹ã€åœè½¦ã€ä¿å…»ã€ä¿é™© |
| ğŸ›’ | è´­ç‰© | æœè£…ã€æ—¥ç”¨å“ã€æ•°ç äº§å“ |
| ğŸ’¼ | åŠå…¬ | åŠå…¬ç”¨å“ã€æ‰“å°ã€å¿«é€’ |
| ğŸ¥ | åŒ»ç–— | æŒ‚å·ã€è¯å“ã€ä½“æ£€ |
| ğŸƒ | è¿åŠ¨ | å¥èº«å¡ã€è¿åŠ¨è£…å¤‡ |
| ğŸ“š | å­¦ä¹  | ä¹¦ç±ã€è¯¾ç¨‹ã€åŸ¹è®­ |
| ğŸ“± | ä¼šå‘˜è®¢é˜… | è§†é¢‘ä¼šå‘˜ã€éŸ³ä¹ä¼šå‘˜ã€è½¯ä»¶ |

### 10.2 æ”¶å…¥åˆ†ç±»
| å›¾æ ‡ | åˆ†ç±» | è¯´æ˜ |
|------|------|------|
| ğŸ’° | å·¥èµ„ | æœˆè–ªã€å‘¨è–ª |
| â° | åŠ ç­ | åŠ ç­è´¹ |
| ğŸ’¼ | å…¼èŒ | å…¼èŒæ”¶å…¥ |
| ğŸ“ˆ | ç†è´¢ | åˆ©æ¯ã€è‚¡ç¥¨ã€åŸºé‡‘ |
| ğŸ | ç¦åˆ© | å…¬å¸ç¦åˆ© |
| ğŸ† | å¥–é‡‘ | å¹´ç»ˆå¥–ã€ç»©æ•ˆå¥– |
| ğŸ¦ | å…¬ç§¯é‡‘ | å…¬ç§¯é‡‘æå– |
| ğŸ§§ | çº¢åŒ… | æ”¶åˆ°çš„çº¢åŒ… |
| ğŸ’ | ç¤¼é‡‘ | æ”¶åˆ°çš„ç¤¼é‡‘ |
| ğŸª | ç»è¥æ‰€å¾— | ç”Ÿæ„æ”¶å…¥ |
| ğŸ² | æ„å¤–æ¥é’± | ä¸­å¥–ã€é€€æ¬¾ç­‰ |

---

## åä¸€ã€å®‰å…¨è®¾è®¡

### 11.1 æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- HTTPSå…¨é“¾è·¯åŠ å¯†
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤

### 11.2 ç”¨æˆ·éšç§
- æœ€å°åŒ–æ•°æ®æ”¶é›†
- ç”¨æˆ·æ•°æ®å¯å¯¼å‡º/åˆ é™¤
- ç¬¬ä¸‰æ–¹æœåŠ¡æ•°æ®è„±æ•
- ç¬¦åˆGDPR/ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•

### 11.3 APIå®‰å…¨
- JWT Token + Refresh Token
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- æ¥å£ç­¾åéªŒè¯
- æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

---

## åäºŒã€ç¬¬ä¸‰æ–¹ç™»å½•è®¾è®¡

### 12.1 æ”¯æŒçš„ç™»å½•æ–¹å¼

| ç™»å½•æ–¹å¼ | å¹³å° | æŠ€æœ¯æ–¹æ¡ˆ |
|----------|------|----------|
| å¾®ä¿¡ç™»å½• | iOS/Android | å¾®ä¿¡å¼€æ”¾å¹³å°SDK |
| Appleç™»å½• | iOS | Sign in with Apple |
| æ‰‹æœºå·ç™»å½• | å…¨å¹³å° | çŸ­ä¿¡éªŒè¯ç  |
| é‚®ç®±ç™»å½• | å…¨å¹³å° | é‚®ç®±+å¯†ç  |

### 12.2 å¾®ä¿¡ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ å¾®ä¿¡æˆæƒ  â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ æ‹‰èµ·å¾®ä¿¡  â”‚     â”‚ è·å–code â”‚     â”‚ æ¢å–ä¿¡æ¯  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 Appleç™»å½•æµç¨‹ (iOS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Appç«¯   â”‚ â”€â”€â–¶ â”‚ Appleæˆæƒ â”‚ â”€â”€â–¶ â”‚  åç«¯    â”‚ â”€â”€â–¶ â”‚ è¿”å›Tokenâ”‚
â”‚ Face ID  â”‚     â”‚ è·å–Token â”‚     â”‚ éªŒè¯JWT  â”‚     â”‚ ç™»å½•æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.4 ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šè¡¨

```sql
-- ç¬¬ä¸‰æ–¹ç™»å½•ç»‘å®šè¡¨
CREATE TABLE oauth_bindings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    provider VARCHAR(20) NOT NULL,      -- wechat, apple, google
    provider_user_id VARCHAR(100) NOT NULL,
    union_id VARCHAR(100),              -- å¾®ä¿¡UnionID
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    raw_data JSONB,                     -- åŸå§‹è¿”å›æ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(provider, provider_user_id)
);
```

---

## åä¸‰ã€å¤šè´§å¸ç³»ç»Ÿè®¾è®¡

### 13.1 è´§å¸æ”¯æŒ

æ”¯æŒå…¨çƒä¸»æµè´§å¸ï¼Œæ ¹æ®ç”¨æˆ·IPè‡ªåŠ¨è®¾ç½®é»˜è®¤è´§å¸ï¼š

| è´§å¸ä»£ç  | è´§å¸åç§° | ç¬¦å· | å›½å®¶/åœ°åŒº |
|----------|----------|------|-----------|
| CNY | äººæ°‘å¸ | Â¥ | ä¸­å›½å¤§é™† |
| USD | ç¾å…ƒ | $ | ç¾å›½ |
| EUR | æ¬§å…ƒ | â‚¬ | æ¬§ç›Ÿ |
| GBP | è‹±é•‘ | Â£ | è‹±å›½ |
| JPY | æ—¥å…ƒ | Â¥ | æ—¥æœ¬ |
| HKD | æ¸¯å¸ | HK$ | é¦™æ¸¯ |
| TWD | æ–°å°å¸ | NT$ | å°æ¹¾ |
| SGD | æ–°åŠ å¡å…ƒ | S$ | æ–°åŠ å¡ |
| AUD | æ¾³å…ƒ | A$ | æ¾³å¤§åˆ©äºš |
| CAD | åŠ å…ƒ | C$ | åŠ æ‹¿å¤§ |
| KRW | éŸ©å…ƒ | â‚© | éŸ©å›½ |
| THB | æ³°é“¢ | à¸¿ | æ³°å›½ |
| MYR | é©¬æ¥è¥¿äºšä»¤å‰ | RM | é©¬æ¥è¥¿äºš |

### 13.2 æ±‡ç‡ç®¡ç†

```sql
-- è´§å¸è¡¨
CREATE TABLE currencies (
    code VARCHAR(3) PRIMARY KEY,        -- ISO 4217
    name VARCHAR(50) NOT NULL,
    name_en VARCHAR(50) NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    decimal_places INT DEFAULT 2,
    is_active BOOLEAN DEFAULT TRUE
);

-- æ±‡ç‡è¡¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
CREATE TABLE exchange_rates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    base_currency VARCHAR(3) DEFAULT 'USD',
    target_currency VARCHAR(3) NOT NULL,
    rate DECIMAL(20,10) NOT NULL,
    rate_date DATE NOT NULL,
    source VARCHAR(50),                 -- æ•°æ®æ¥æº
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(base_currency, target_currency, rate_date)
);

-- ç”¨æˆ·è´§å¸è®¾ç½®
ALTER TABLE users ADD COLUMN default_currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE users ADD COLUMN detected_country VARCHAR(2);  -- IPæ£€æµ‹å›½å®¶
```

### 13.3 è´¦ç›®è´§å¸æ‰©å±•

```sql
-- è´¦ç›®è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE transactions ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
ALTER TABLE transactions ADD COLUMN original_amount DECIMAL(15,2);      -- åŸå§‹é‡‘é¢
ALTER TABLE transactions ADD COLUMN original_currency VARCHAR(3);        -- åŸå§‹è´§å¸
ALTER TABLE transactions ADD COLUMN exchange_rate DECIMAL(20,10);       -- è½¬æ¢æ±‡ç‡

-- è´¦æˆ·è¡¨æ·»åŠ è´§å¸å­—æ®µ
ALTER TABLE accounts ADD COLUMN currency VARCHAR(3) DEFAULT 'CNY';
```

### 13.4 è´§å¸è½¬æ¢é€»è¾‘

```python
# è´§å¸è½¬æ¢æœåŠ¡
class CurrencyService:
    async def convert(
        self,
        amount: Decimal,
        from_currency: str,
        to_currency: str,
        date: date = None
    ) -> tuple[Decimal, Decimal]:
        """
        è¿”å›: (è½¬æ¢åé‡‘é¢, æ±‡ç‡)
        """
        if from_currency == to_currency:
            return amount, Decimal('1')

        rate = await self.get_rate(from_currency, to_currency, date)
        converted = amount * rate
        return converted.quantize(Decimal('0.01')), rate

    async def get_rate(self, from_curr: str, to_curr: str, date: date = None):
        # 1. ä¼˜å…ˆä»ç¼“å­˜è·å–
        # 2. ä»æ•°æ®åº“è·å–
        # 3. è°ƒç”¨æ±‡ç‡APIæ›´æ–°
        pass
```

### 13.5 IPåœ°ç†ä½ç½®æ£€æµ‹

```python
# ç™»å½•/æ³¨å†Œæ—¶æ£€æµ‹ç”¨æˆ·æ‰€åœ¨å›½å®¶
async def detect_user_location(ip_address: str) -> dict:
    """
    ä½¿ç”¨ IP2Location æˆ– MaxMind GeoIP2 æ£€æµ‹
    è¿”å›: {country_code: 'CN', currency: 'CNY', language: 'zh-CN'}
    """
    # æ¨èä½¿ç”¨ MaxMind GeoLite2 (å…è´¹) æˆ– GeoIP2 (ä»˜è´¹)
    pass
```

---

## åå››ã€ç¦»çº¿æ¨¡å¼è®¾è®¡

### 14.1 ç¦»çº¿æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flutter App                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Repository Layer                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ Remote Sourceâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚ Local Source â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (API)      â”‚  Sync   â”‚  (SQLite)    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                     â”‚  Sync Manager   â”‚                      â”‚
â”‚                     â”‚ (å†²çªè§£å†³/é˜Ÿåˆ—) â”‚                      â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 æœ¬åœ°æ•°æ®åº“è®¾è®¡ (SQLite)

```sql
-- ç¦»çº¿æ“ä½œé˜Ÿåˆ—
CREATE TABLE sync_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operation_type TEXT NOT NULL,       -- create, update, delete
    entity_type TEXT NOT NULL,          -- transaction, account, category
    entity_id TEXT NOT NULL,
    payload TEXT NOT NULL,              -- JSONæ•°æ®
    created_at INTEGER NOT NULL,        -- Unix timestamp
    retry_count INTEGER DEFAULT 0,
    last_error TEXT,
    status TEXT DEFAULT 'pending'       -- pending, syncing, synced, failed
);

-- æœ¬åœ°è´¦ç›®ç¼“å­˜
CREATE TABLE local_transactions (
    id TEXT PRIMARY KEY,
    server_id TEXT,                     -- æœåŠ¡å™¨IDï¼Œæ–°å»ºæ—¶ä¸ºNULL
    data TEXT NOT NULL,                 -- JSONå®Œæ•´æ•°æ®
    is_synced INTEGER DEFAULT 0,
    local_updated_at INTEGER NOT NULL,
    server_updated_at INTEGER,
    is_deleted INTEGER DEFAULT 0
);

-- åŒæ­¥çŠ¶æ€è¡¨
CREATE TABLE sync_status (
    entity_type TEXT PRIMARY KEY,
    last_sync_at INTEGER,
    last_server_timestamp INTEGER
);
```

### 14.3 åŒæ­¥ç­–ç•¥

```dart
class SyncManager {
  // åŒæ­¥ä¼˜å…ˆçº§
  static const syncOrder = [
    'categories',    // 1. å…ˆåŒæ­¥åˆ†ç±»
    'accounts',      // 2. å†åŒæ­¥è´¦æˆ·
    'transactions',  // 3. æœ€ååŒæ­¥è´¦ç›®
  ];

  // å†²çªè§£å†³ç­–ç•¥
  ConflictResolution resolveConflict(LocalData local, ServerData server) {
    // ç­–ç•¥1: æœåŠ¡å™¨ä¼˜å…ˆ (é»˜è®¤)
    // ç­–ç•¥2: æœ¬åœ°ä¼˜å…ˆ
    // ç­–ç•¥3: æœ€æ–°ä¿®æ”¹ä¼˜å…ˆ
    // ç­–ç•¥4: ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©

    if (server.updatedAt > local.localUpdatedAt) {
      return ConflictResolution.useServer;
    }
    return ConflictResolution.useLocal;
  }
}
```

### 14.4 ç¦»çº¿æ•°æ®æ¸…ç†ç­–ç•¥

```dart
class OfflineDataManager {
  // æ¸…ç†é…ç½®
  static const config = {
    'maxLocalDays': 90,           // æœ€å¤šä¿ç•™90å¤©æ•°æ®
    'maxLocalSize': 100 * 1024 * 1024,  // æœ€å¤§100MB
    'cleanupThreshold': 80 * 1024 * 1024, // 80MBæ—¶å¼€å§‹æ¸…ç†
    'keepRecentDays': 30,         // å§‹ç»ˆä¿ç•™æœ€è¿‘30å¤©
  };

  Future<void> cleanupIfNeeded() async {
    final currentSize = await getLocalDataSize();

    if (currentSize > config['cleanupThreshold']) {
      // 1. åˆ é™¤è¶…è¿‡90å¤©çš„å·²åŒæ­¥æ•°æ®
      await deleteOldSyncedData(config['maxLocalDays']);

      // 2. å¦‚æœè¿˜è¶…è¿‡é˜ˆå€¼ï¼Œå‹ç¼©å›¾ç‰‡ç¼“å­˜
      await compressImageCache();

      // 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      await clearTempFiles();
    }
  }

  // å®šæœŸæ¸…ç†ä»»åŠ¡ (æ¯å‘¨ä¸€æ¬¡)
  void scheduleWeeklyCleanup() {
    // åœ¨WiFiç¯å¢ƒä¸‹æ‰§è¡Œ
    // åœ¨å……ç”µçŠ¶æ€ä¸‹æ‰§è¡Œ
    // åœ¨Appåå°æ—¶æ‰§è¡Œ
  }
}
```

### 14.5 å­˜å‚¨ç©ºé—´ç®¡ç†ç•Œé¢

```
å­˜å‚¨ç©ºé—´ç®¡ç†
â”œâ”€â”€ æ€»å ç”¨: 45.2 MB
â”‚   â”œâ”€â”€ è´¦ç›®æ•°æ®: 12.3 MB (3,240æ¡)
â”‚   â”œâ”€â”€ å›¾ç‰‡ç¼“å­˜: 28.5 MB (156å¼ )
â”‚   â””â”€â”€ å…¶ä»–ç¼“å­˜: 4.4 MB
â”œâ”€â”€ è‡ªåŠ¨æ¸…ç†: å¼€å¯
â”‚   â”œâ”€â”€ ä¿ç•™æœ€è¿‘: 90å¤©
â”‚   â””â”€â”€ æœ€å¤§ç©ºé—´: 100 MB
â””â”€â”€ [æ¸…ç†ç¼“å­˜] [å¯¼å‡ºæ•°æ®]
```

---

## åäº”ã€ä¼šå‘˜ç³»ç»Ÿè®¾è®¡

### 15.1 ç”¨æˆ·ç±»å‹ä¸ä¼šå‘˜ç­‰çº§

#### ç”¨æˆ·ç±»å‹å®šä¹‰

| ç±»å‹ | è¯´æ˜ | è·å–æ–¹å¼ |
|------|------|----------|
| **æ³¨å†Œç”¨æˆ·** | é€šè¿‡å¾®ä¿¡/Apple/æ‰‹æœºå·ç™»å½•è‡ªåŠ¨æˆä¸º | ç™»å½•å³æ³¨å†Œ |
| **è¯•ç”¨ç”¨æˆ·** | æ³¨å†Œç”¨æˆ·ç”³è¯·AIè¯•ç”¨ | ç”³è¯·1æ¬¡ï¼Œ30å¤©æœ‰æ•ˆ |
| **ä»˜è´¹ä¼šå‘˜** | è´­ä¹°ä¼šå‘˜æœåŠ¡ | å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ |

#### ä¼šå‘˜ç­‰çº§

| ç­‰çº§ | åç§° | ä»·æ ¼ | æœ‰æ•ˆæœŸ |
|------|------|------|--------|
| 0 | æ³¨å†Œç”¨æˆ· | å…è´¹ | æ°¸ä¹… |
| 1 | AIè¯•ç”¨ | å…è´¹(ä»…1æ¬¡) | 30å¤© |
| 2 | æœˆåº¦ä¼šå‘˜ | Â¥12/æœˆ | 1ä¸ªæœˆ |
| 3 | å­£åº¦ä¼šå‘˜ | Â¥30/å­£ | 3ä¸ªæœˆ |
| 4 | å¹´åº¦ä¼šå‘˜ | Â¥98/å¹´ | 1å¹´ |
| 5 | ç»ˆèº«ä¼šå‘˜ | Â¥298 | æ°¸ä¹… |

### 15.2 åŠŸèƒ½æƒç›Šå¯¹æ¯”

| åŠŸèƒ½ | æ³¨å†Œç”¨æˆ· | AIè¯•ç”¨(30å¤©) | ä»˜è´¹ä¼šå‘˜ |
|------|----------|--------------|----------|
| **åŸºç¡€è®°è´¦** | | | |
| æ‰‹åŠ¨è®°è´¦ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| è´¦æœ¬æ•°é‡ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| è´¦æˆ·æ•°é‡ | âœ… æ— é™ | âœ… æ— é™ | âœ… æ— é™ |
| æˆå‘˜åä½œ | âœ… 10äºº | âœ… 10äºº | âœ… 10äºº |
| **AIåŠŸèƒ½** | | | |
| å›¾ç‰‡è¯†åˆ«è®°è´¦ | âŒ | âœ… æ— é™ | âœ… æ— é™ |
| è¯­éŸ³è®°è´¦ | âŒ | âœ… æ— é™ | âœ… æ— é™ |
| é‚®ç®±è´¦å•è§£æ | âŒ | âœ… | âœ… |
| æ™ºèƒ½åˆ†ç±»å»ºè®® | âŒ | âœ… | âœ… |
| **ç»Ÿè®¡æŠ¥è¡¨** | | | |
| åŸºç¡€ç»Ÿè®¡ | âœ… | âœ… | âœ… |
| è¶‹åŠ¿åˆ†æ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| åˆ†ç±»å æ¯” | âœ… | âœ… | âœ… |
| å¹´åº¦æŠ¥å‘Š | âœ… | âœ… | âœ… |
| è‡ªå®šä¹‰æŠ¥è¡¨ | âœ… | âœ… | âœ… |
| **æ•°æ®åŠŸèƒ½** | | | |
| æ•°æ®å¯¼å‡º(CSV) | âœ… | âœ… | âœ… |
| æ•°æ®å¯¼å‡º(Excel) | âœ… | âœ… | âœ… |
| äº‘ç«¯å¤‡ä»½ | âœ… è‡ªåŠ¨/æ—¥ | âœ… è‡ªåŠ¨/æ—¥ | âœ… è‡ªåŠ¨/æ—¥ |
| å†å²å¤‡ä»½ä¿ç•™ | âœ… 30ä»½ | âœ… 30ä»½ | âœ… 30ä»½ |
| **é«˜çº§åŠŸèƒ½** | | | |
| å®šæ—¶è®°è´¦ | âœ… | âœ… | âœ… |
| æ¡Œé¢å°ç»„ä»¶ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| è‡ªå®šä¹‰åˆ†ç±»å›¾æ ‡ | âœ… | âœ… | âœ… |
| ä¸»é¢˜çš®è‚¤ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ |
| å»å¹¿å‘Š | âœ… | âœ… | âœ… |

**æ€»ç»“**ï¼šæ³¨å†Œç”¨æˆ· = å…¨åŠŸèƒ½(é™¤AI) | AIè¯•ç”¨ = å…¨åŠŸèƒ½(30å¤©) | ä»˜è´¹ä¼šå‘˜ = å…¨åŠŸèƒ½(æ°¸ä¹…AI)

### 15.3 AIè¯•ç”¨ç”³è¯·æœºåˆ¶

```python
class AITrialService:
    """AIåŠŸèƒ½è¯•ç”¨æœåŠ¡"""

    TRIAL_DURATION_DAYS = 30  # è¯•ç”¨æœŸ30å¤©

    async def apply_trial(self, user_id: str) -> dict:
        """ç”³è¯·AIè¯•ç”¨"""
        user = await self.get_user(user_id)

        # æ£€æŸ¥æ˜¯å¦å·²ç»ç”³è¯·è¿‡è¯•ç”¨
        if user.has_used_trial:
            return {
                'success': False,
                'message': 'æ‚¨å·²ä½¿ç”¨è¿‡AIè¯•ç”¨æœºä¼šï¼Œè¯·å‡çº§ä¼šå‘˜äº«å—å®Œæ•´åŠŸèƒ½'
            }

        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»˜è´¹ä¼šå‘˜
        if user.is_paid_member:
            return {
                'success': False,
                'message': 'æ‚¨å·²æ˜¯ä»˜è´¹ä¼šå‘˜ï¼Œæ— éœ€ç”³è¯·è¯•ç”¨'
            }

        # æ¿€æ´»è¯•ç”¨
        trial_expire = datetime.now() + timedelta(days=self.TRIAL_DURATION_DAYS)
        await self.activate_trial(user_id, trial_expire)

        return {
            'success': True,
            'message': f'AIåŠŸèƒ½è¯•ç”¨å·²æ¿€æ´»ï¼Œæœ‰æ•ˆæœŸè‡³ {trial_expire.strftime("%Y-%m-%d")}',
            'expire_at': trial_expire
        }

    async def check_ai_access(self, user_id: str) -> tuple[bool, str]:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰AIåŠŸèƒ½æƒé™"""
        user = await self.get_user(user_id)

        # ä»˜è´¹ä¼šå‘˜
        if user.is_paid_member:
            return True, ""

        # è¯•ç”¨æœŸå†…
        if user.trial_expire_at and user.trial_expire_at > datetime.now():
            days_left = (user.trial_expire_at - datetime.now()).days
            return True, f"è¯•ç”¨æœŸå‰©ä½™{days_left}å¤©"

        # æœªå¼€é€š
        if not user.has_used_trial:
            return False, "æ‚¨å°šæœªå¼€é€šAIåŠŸèƒ½ï¼Œå¯ç”³è¯·30å¤©å…è´¹è¯•ç”¨"
        else:
            return False, "AIè¯•ç”¨å·²è¿‡æœŸï¼Œå‡çº§ä¼šå‘˜ç»§ç»­ä½¿ç”¨"
```

### 15.4 ä¼šå‘˜æ•°æ®è¡¨

```sql
-- ç”¨æˆ·è¡¨ï¼ˆæ‰©å±•å­—æ®µï¼‰
ALTER TABLE users ADD COLUMN user_type INT DEFAULT 0;        -- 0:æ³¨å†Œç”¨æˆ· 1:è¯•ç”¨ç”¨æˆ· 2:ä»˜è´¹ä¼šå‘˜
ALTER TABLE users ADD COLUMN has_used_trial BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦å·²ä½¿ç”¨è¯•ç”¨
ALTER TABLE users ADD COLUMN trial_expire_at TIMESTAMP;      -- è¯•ç”¨åˆ°æœŸæ—¶é—´
ALTER TABLE users ADD COLUMN member_level INT DEFAULT 0;     -- ä¼šå‘˜ç­‰çº§ 0:æ—  2:æœˆåº¦ 3:å­£åº¦ 4:å¹´åº¦ 5:ç»ˆèº«
ALTER TABLE users ADD COLUMN member_expire_at TIMESTAMP;     -- ä¼šå‘˜åˆ°æœŸæ—¶é—´
ALTER TABLE users ADD COLUMN is_lifetime BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦ç»ˆèº«ä¼šå‘˜

-- ä¼šå‘˜è®¢å•è¡¨
CREATE TABLE member_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    order_no VARCHAR(50) UNIQUE NOT NULL,
    product_type INT NOT NULL,           -- 2:æœˆåº¦ 3:å­£åº¦ 4:å¹´åº¦ 5:ç»ˆèº«
    original_amount DECIMAL(10,2) NOT NULL,  -- åŸä»·
    discount_amount DECIMAL(10,2) DEFAULT 0, -- ä¼˜æƒ é‡‘é¢
    pay_amount DECIMAL(10,2) NOT NULL,   -- å®ä»˜é‡‘é¢
    currency VARCHAR(3) DEFAULT 'CNY',
    payment_method VARCHAR(20),          -- wechat_pay, alipay
    payment_status INT DEFAULT 0,        -- 0:å¾…æ”¯ä»˜ 1:å·²æ”¯ä»˜ 2:å·²å–æ¶ˆ 3:å·²é€€æ¬¾
    paid_at TIMESTAMP,
    member_start_at TIMESTAMP,           -- ä¼šå‘˜å¼€å§‹æ—¶é—´
    member_expire_at TIMESTAMP,          -- ä¼šå‘˜åˆ°æœŸæ—¶é—´
    transaction_id VARCHAR(100),         -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    coupon_id UUID,                      -- ä½¿ç”¨çš„ä¼˜æƒ åˆ¸
    campaign_id UUID,                    -- å‚ä¸çš„æ´»åŠ¨
    refund_amount DECIMAL(10,2),
    refund_at TIMESTAMP,
    refund_reason TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è¯•ç”¨è®°å½•è¡¨
CREATE TABLE trial_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) UNIQUE,
    applied_at TIMESTAMP DEFAULT NOW(),
    expire_at TIMESTAMP NOT NULL,
    is_converted BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦è½¬åŒ–ä¸ºä»˜è´¹
    converted_at TIMESTAMP,
    converted_order_id UUID
);
```

---

## åäº”Aã€æ”¯ä»˜ç³»ç»Ÿè®¾è®¡

### 15A.1 æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

| æ”¯ä»˜æ–¹å¼ | åœºæ™¯ | æ¥å…¥æ–¹æ¡ˆ |
|----------|------|----------|
| **å¾®ä¿¡æ”¯ä»˜** | Appå†…æ”¯ä»˜ | å¾®ä¿¡å¼€æ”¾å¹³å° APPæ”¯ä»˜ |
| **æ”¯ä»˜å®** | Appå†…æ”¯ä»˜ | æ”¯ä»˜å®å¼€æ”¾å¹³å° APPæ”¯ä»˜ |
| **Apple Pay** | iOS Appå†…è´­ | StoreKit (IAP) |

### 15A.2 æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚     â”‚   App    â”‚     â”‚  åç«¯    â”‚     â”‚ æ”¯ä»˜å¹³å°  â”‚
â”‚ é€‰æ‹©å¥—é¤ â”‚     â”‚ åˆ›å»ºè®¢å• â”‚     â”‚ ç”Ÿæˆå‚æ•° â”‚     â”‚ å‘èµ·æ”¯ä»˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚
     â”‚ 1.é€‰æ‹©ä¼šå‘˜å¥—é¤  â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
     â”‚                â”‚ 2.è¯·æ±‚åˆ›å»ºè®¢å•  â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
     â”‚                â”‚                â”‚ 3.ç”Ÿæˆè®¢å•å·    â”‚
     â”‚                â”‚                â”‚ è°ƒç”¨æ”¯ä»˜API     â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 4.è¿”å›æ”¯ä»˜å‚æ•°  â”‚
     â”‚                â”‚ 5.è°ƒèµ·æ”¯ä»˜SDK   â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚ 6.ç”¨æˆ·å®Œæˆæ”¯ä»˜  â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚ 7.å¼‚æ­¥å›è°ƒé€šçŸ¥  â”‚
     â”‚                â”‚                â”‚ 8.æ›´æ–°è®¢å•çŠ¶æ€  â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ å¼€é€šä¼šå‘˜æƒç›Š    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 9.é€šçŸ¥ç”¨æˆ·     â”‚                â”‚
     â”‚  æ”¯ä»˜æˆåŠŸ       â”‚                â”‚                â”‚
```

### 15A.3 å¾®ä¿¡æ”¯ä»˜æ¥å…¥

```python
import hashlib
import time
from wechatpay import WeChatPay

class WeChatPayService:
    def __init__(self):
        self.client = WeChatPay(
            appid=settings.WECHAT_APP_ID,
            mch_id=settings.WECHAT_MCH_ID,
            api_key=settings.WECHAT_API_KEY,
            cert_path=settings.WECHAT_CERT_PATH,
            key_path=settings.WECHAT_KEY_PATH,
        )

    async def create_order(
        self,
        order_no: str,
        amount: int,  # å•ä½ï¼šåˆ†
        description: str,
        user_openid: str = None
    ) -> dict:
        """åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•ï¼ˆAPPæ”¯ä»˜ï¼‰"""

        params = {
            'body': description,
            'out_trade_no': order_no,
            'total_fee': amount,
            'spbill_create_ip': '127.0.0.1',
            'notify_url': f'{settings.API_BASE_URL}/api/v1/payment/wechat/notify',
            'trade_type': 'APP',
        }

        result = self.client.unified_order(**params)

        if result['return_code'] == 'SUCCESS':
            # ç”ŸæˆAPPè°ƒèµ·æ”¯ä»˜çš„å‚æ•°
            timestamp = str(int(time.time()))
            nonce_str = self._generate_nonce()
            prepay_id = result['prepay_id']

            sign_params = {
                'appid': settings.WECHAT_APP_ID,
                'partnerid': settings.WECHAT_MCH_ID,
                'prepayid': prepay_id,
                'package': 'Sign=WXPay',
                'noncestr': nonce_str,
                'timestamp': timestamp,
            }
            sign = self._generate_sign(sign_params)

            return {
                'success': True,
                'pay_params': {
                    **sign_params,
                    'sign': sign,
                }
            }

        return {'success': False, 'message': result.get('return_msg')}

    async def handle_notify(self, xml_data: str) -> dict:
        """å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ"""
        result = self.client.parse_notify(xml_data)

        if result['return_code'] == 'SUCCESS' and result['result_code'] == 'SUCCESS':
            order_no = result['out_trade_no']
            transaction_id = result['transaction_id']

            # æ›´æ–°è®¢å•çŠ¶æ€
            await self._complete_order(order_no, transaction_id)

            return {'return_code': 'SUCCESS', 'return_msg': 'OK'}

        return {'return_code': 'FAIL', 'return_msg': 'Verification failed'}
```

### 15A.4 æ”¯ä»˜å®æ¥å…¥

```python
from alipay import AliPay

class AlipayService:
    def __init__(self):
        self.client = AliPay(
            appid=settings.ALIPAY_APP_ID,
            app_private_key_string=settings.ALIPAY_PRIVATE_KEY,
            alipay_public_key_string=settings.ALIPAY_PUBLIC_KEY,
            sign_type='RSA2',
        )

    async def create_order(
        self,
        order_no: str,
        amount: str,  # å•ä½ï¼šå…ƒ
        subject: str,
    ) -> dict:
        """åˆ›å»ºæ”¯ä»˜å®è®¢å•ï¼ˆAPPæ”¯ä»˜ï¼‰"""

        order_string = self.client.api_alipay_trade_app_pay(
            out_trade_no=order_no,
            total_amount=amount,
            subject=subject,
            notify_url=f'{settings.API_BASE_URL}/api/v1/payment/alipay/notify',
        )

        return {
            'success': True,
            'order_string': order_string,  # ç›´æ¥ä¼ ç»™æ”¯ä»˜å®SDK
        }

    async def handle_notify(self, data: dict) -> str:
        """å¤„ç†æ”¯ä»˜å®å›è°ƒ"""
        # éªŒç­¾
        signature = data.pop('sign')
        if self.client.verify(data, signature):
            if data['trade_status'] in ('TRADE_SUCCESS', 'TRADE_FINISHED'):
                order_no = data['out_trade_no']
                transaction_id = data['trade_no']

                await self._complete_order(order_no, transaction_id)

                return 'success'

        return 'fail'
```

### 15A.5 æ”¯ä»˜ç›¸å…³æ•°æ®è¡¨

```sql
-- æ”¯ä»˜æµæ°´è¡¨
CREATE TABLE payment_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES member_orders(id),
    payment_method VARCHAR(20) NOT NULL,     -- wechat_pay, alipay, apple_iap
    transaction_id VARCHAR(100),             -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    status INT DEFAULT 0,                    -- 0:å¾…æ”¯ä»˜ 1:æˆåŠŸ 2:å¤±è´¥ 3:å·²é€€æ¬¾
    raw_notify TEXT,                         -- åŸå§‹å›è°ƒæ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é€€æ¬¾è®°å½•è¡¨
CREATE TABLE refund_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES member_orders(id),
    payment_transaction_id UUID REFERENCES payment_transactions(id),
    refund_no VARCHAR(50) UNIQUE NOT NULL,
    refund_amount DECIMAL(10,2) NOT NULL,
    reason TEXT,
    status INT DEFAULT 0,                    -- 0:å¤„ç†ä¸­ 1:æˆåŠŸ 2:å¤±è´¥
    operator_id UUID,                        -- æ“ä½œäººï¼ˆç®¡ç†å‘˜ï¼‰
    third_party_refund_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

---

## åäº”Bã€ç®¡ç†åå°è®¾è®¡

### 15B.1 ç®¡ç†åå°åŠŸèƒ½æ¨¡å—

```
ç®¡ç†åå°
â”œâ”€â”€ é¦–é¡µä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ ä»Šæ—¥æ•°æ®æ¦‚è§ˆï¼ˆæ–°å¢ç”¨æˆ·ã€æ´»è·ƒç”¨æˆ·ã€æ”¶å…¥ï¼‰
â”‚   â”œâ”€â”€ è¶‹åŠ¿å›¾è¡¨
â”‚   â””â”€â”€ å¾…å¤„ç†äº‹é¡¹
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ï¼ˆæœç´¢ã€ç­›é€‰ã€å¯¼å‡ºï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·è¯¦æƒ…ï¼ˆåŸºæœ¬ä¿¡æ¯ã€ä¼šå‘˜çŠ¶æ€ã€æ“ä½œè®°å½•ï¼‰
â”‚   â”œâ”€â”€ ä¼šå‘˜ç®¡ç†ï¼ˆå¼€é€šã€å»¶æœŸã€å–æ¶ˆï¼‰
â”‚   â””â”€â”€ ç”¨æˆ·å°ç¦/è§£å°
â”œâ”€â”€ è®¢å•ç®¡ç†
â”‚   â”œâ”€â”€ è®¢å•åˆ—è¡¨
â”‚   â”œâ”€â”€ è®¢å•è¯¦æƒ…
â”‚   â”œâ”€â”€ é€€æ¬¾å¤„ç†
â”‚   â””â”€â”€ è®¢å•ç»Ÿè®¡
â”œâ”€â”€ è¥é”€æ´»åŠ¨
â”‚   â”œâ”€â”€ æ´»åŠ¨ç®¡ç†ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€ä¸Šä¸‹çº¿ï¼‰
â”‚   â”œâ”€â”€ ä¼˜æƒ åˆ¸ç®¡ç†
â”‚   â”œâ”€â”€ æ´»åŠ¨æ•°æ®åˆ†æ
â”‚   â””â”€â”€ æ´»åŠ¨æ¨¡æ¿åº“
â”œâ”€â”€ å†…å®¹ç®¡ç†
â”‚   â”œâ”€â”€ å…¬å‘Šç®¡ç†
â”‚   â”œâ”€â”€ æ¨é€ç®¡ç†
â”‚   â””â”€â”€ Bannerç®¡ç†
â”œâ”€â”€ æ•°æ®ç»Ÿè®¡
â”‚   â”œâ”€â”€ ç”¨æˆ·ç»Ÿè®¡
â”‚   â”œâ”€â”€ æ”¶å…¥ç»Ÿè®¡
â”‚   â”œâ”€â”€ è½¬åŒ–æ¼æ–—
â”‚   â””â”€â”€ ç•™å­˜åˆ†æ
â””â”€â”€ ç³»ç»Ÿè®¾ç½®
    â”œâ”€â”€ ç®¡ç†å‘˜ç®¡ç†
    â”œâ”€â”€ è§’è‰²æƒé™
    â”œâ”€â”€ æ“ä½œæ—¥å¿—
    â””â”€â”€ ç³»ç»Ÿé…ç½®
```

### 15B.2 è¥é”€æ´»åŠ¨ç±»å‹æ¨¡æ¿

#### æ´»åŠ¨ç±»å‹ä¸€è§ˆ

| æ´»åŠ¨ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| **æ–°ç”¨æˆ·ä¸“äº«** | é¦–æ¬¡ä»˜è´¹ç‰¹ä»· | æ‹‰æ–°è½¬åŒ– |
| **é™æ—¶æŠ˜æ‰£** | æŒ‡å®šæ—¶é—´æ®µæŠ˜æ‰£ | ä¿ƒé”€å†²é‡ |
| **æ»¡å‡æ´»åŠ¨** | æ»¡è¶³æ¡ä»¶å‡å… | æå‡å®¢å•ä»· |
| **ä¹°èµ æ´»åŠ¨** | è´­ä¹°èµ é€æ—¶é•¿ | æå‡ä»˜è´¹ç‡ |
| **é‚€è¯·æœ‰ç¤¼** | é‚€è¯·å¥½å‹åŒæ–¹å—ç›Š | è£‚å˜æ‹‰æ–° |
| **ç»­è´¹ä¼˜æƒ ** | è€ç”¨æˆ·ç»­è´¹æŠ˜æ‰£ | æå‡ç»­è´¹ç‡ |
| **èŠ‚æ—¥æ´»åŠ¨** | èŠ‚å‡æ—¥ç‰¹åˆ«ä¼˜æƒ  | èŠ‚æ—¥è¥é”€ |
| **ä¼šå‘˜æ—¥** | å›ºå®šæ—¥æœŸç‰¹æƒ  | åŸ¹å…»æ¶ˆè´¹ä¹ æƒ¯ |
| **ç§¯åˆ†å…‘æ¢** | ç§¯åˆ†æ¢ä¼˜æƒ åˆ¸/æ—¶é•¿ | ç”¨æˆ·æ¿€åŠ± |
| **æŠ½å¥–æ´»åŠ¨** | éšæœºå¥–åŠ± | å¢åŠ è¶£å‘³æ€§ |

### 15B.3 æ´»åŠ¨é…ç½®æ•°æ®è¡¨

```sql
-- è¥é”€æ´»åŠ¨è¡¨
CREATE TABLE campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    campaign_type VARCHAR(50) NOT NULL,      -- æ´»åŠ¨ç±»å‹
    description TEXT,
    rules JSONB NOT NULL,                    -- æ´»åŠ¨è§„åˆ™é…ç½®
    start_at TIMESTAMP NOT NULL,
    end_at TIMESTAMP NOT NULL,
    target_users JSONB,                      -- ç›®æ ‡ç”¨æˆ·æ¡ä»¶
    budget DECIMAL(10,2),                    -- é¢„ç®—ä¸Šé™
    used_budget DECIMAL(10,2) DEFAULT 0,
    max_participants INT,                    -- æœ€å¤§å‚ä¸äººæ•°
    current_participants INT DEFAULT 0,
    status INT DEFAULT 0,                    -- 0:è‰ç¨¿ 1:å¾…å¼€å§‹ 2:è¿›è¡Œä¸­ 3:å·²ç»“æŸ 4:å·²å–æ¶ˆ
    created_by UUID,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ´»åŠ¨è§„åˆ™ç¤ºä¾‹ (rules JSONB)
-- æ–°ç”¨æˆ·ä¸“äº«:
-- {
--   "type": "new_user_discount",
--   "discount_type": "percent",    -- percent/fixed
--   "discount_value": 50,          -- 5æŠ˜ æˆ– å›ºå®šå‡å…é‡‘é¢
--   "applicable_products": [2,3,4], -- é€‚ç”¨çš„ä¼šå‘˜ç±»å‹
--   "limit_per_user": 1
-- }

-- é™æ—¶æŠ˜æ‰£:
-- {
--   "type": "time_limited_discount",
--   "discount_type": "percent",
--   "discount_value": 70,          -- 7æŠ˜
--   "applicable_products": [4],    -- ä»…å¹´åº¦ä¼šå‘˜
--   "flash_sale_times": [          -- ç§’æ€æ—¶æ®µ
--     {"start": "10:00", "end": "12:00"},
--     {"start": "20:00", "end": "22:00"}
--   ]
-- }

-- ä¹°èµ æ´»åŠ¨:
-- {
--   "type": "buy_get_free",
--   "buy_product": 4,              -- è´­ä¹°å¹´åº¦ä¼šå‘˜
--   "gift_days": 60,               -- èµ é€60å¤©
--   "gift_description": "ä¹°ä¸€å¹´é€ä¸¤ä¸ªæœˆ"
-- }

-- é‚€è¯·æœ‰ç¤¼:
-- {
--   "type": "referral",
--   "inviter_reward": {"type": "days", "value": 7},    -- é‚€è¯·äººè·å¾—7å¤©
--   "invitee_reward": {"type": "days", "value": 7},    -- è¢«é‚€è¯·äººè·å¾—7å¤©
--   "invitee_must_pay": true,      -- è¢«é‚€è¯·äººéœ€ä»˜è´¹æ‰ç®—æœ‰æ•ˆ
--   "max_invites": 10              -- æ¯äººæœ€å¤šé‚€è¯·10äºº
-- }

-- ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    coupon_type INT NOT NULL,                -- 1:æŠ˜æ‰£åˆ¸ 2:æ»¡å‡åˆ¸ 3:ä»£é‡‘åˆ¸ 4:å…è´¹æ—¶é•¿åˆ¸
    discount_value DECIMAL(10,2) NOT NULL,   -- æŠ˜æ‰£æ¯”ä¾‹/å‡å…é‡‘é¢/å…è´¹å¤©æ•°
    min_amount DECIMAL(10,2),                -- æœ€ä½æ¶ˆè´¹ï¼ˆæ»¡å‡åˆ¸ç”¨ï¼‰
    applicable_products INT[],               -- é€‚ç”¨äº§å“
    total_count INT,                         -- å‘æ”¾æ€»é‡
    claimed_count INT DEFAULT 0,             -- å·²é¢†å–æ•°é‡
    used_count INT DEFAULT 0,                -- å·²ä½¿ç”¨æ•°é‡
    claim_limit_per_user INT DEFAULT 1,      -- æ¯äººé™é¢†
    valid_days INT,                          -- é¢†å–åæœ‰æ•ˆå¤©æ•°
    start_at TIMESTAMP,
    expire_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·ä¼˜æƒ åˆ¸
CREATE TABLE user_coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    coupon_id UUID REFERENCES coupons(id),
    status INT DEFAULT 0,                    -- 0:æœªä½¿ç”¨ 1:å·²ä½¿ç”¨ 2:å·²è¿‡æœŸ
    claimed_at TIMESTAMP DEFAULT NOW(),
    expire_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP,
    used_order_id UUID,
    UNIQUE(user_id, coupon_id)
);

-- é‚€è¯·è®°å½•è¡¨
CREATE TABLE referral_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    inviter_user_id UUID REFERENCES users(id),
    invitee_user_id UUID REFERENCES users(id),
    inviter_reward_type VARCHAR(20),         -- days, coupon
    inviter_reward_value INT,
    inviter_rewarded BOOLEAN DEFAULT FALSE,
    invitee_reward_type VARCHAR(20),
    invitee_reward_value INT,
    invitee_rewarded BOOLEAN DEFAULT FALSE,
    invitee_paid BOOLEAN DEFAULT FALSE,      -- è¢«é‚€è¯·äººæ˜¯å¦å·²ä»˜è´¹
    created_at TIMESTAMP DEFAULT NOW()
);

-- æ´»åŠ¨å‚ä¸è®°å½•
CREATE TABLE campaign_participations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID REFERENCES campaigns(id),
    user_id UUID REFERENCES users(id),
    participation_type VARCHAR(50),          -- claim_coupon, place_order, invite
    order_id UUID,
    discount_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(campaign_id, user_id, participation_type)
);
```

### 15B.4 é¢„ç½®æ´»åŠ¨æ¨¡æ¿

```python
CAMPAIGN_TEMPLATES = {
    # æ–°ç”¨æˆ·ä¸“äº«
    'new_user_50off': {
        'name': 'æ–°ç”¨æˆ·é¦–å•5æŠ˜',
        'campaign_type': 'new_user_discount',
        'description': 'æ–°ç”¨æˆ·é¦–æ¬¡è´­ä¹°ä¼šå‘˜äº«5æŠ˜ä¼˜æƒ ',
        'rules': {
            'type': 'new_user_discount',
            'discount_type': 'percent',
            'discount_value': 50,
            'applicable_products': [2, 3, 4, 5],
            'limit_per_user': 1
        },
        'target_users': {'is_new': True, 'has_paid': False}
    },

    # é™æ—¶ç§’æ€
    'flash_sale': {
        'name': 'é™æ—¶ç§’æ€',
        'campaign_type': 'time_limited_discount',
        'description': 'æ•´ç‚¹ç§’æ€ï¼Œå¹´åº¦ä¼šå‘˜ä½è‡³6æŠ˜',
        'rules': {
            'type': 'time_limited_discount',
            'discount_type': 'percent',
            'discount_value': 60,
            'applicable_products': [4],
            'flash_sale_times': [
                {'start': '10:00', 'end': '10:30'},
                {'start': '14:00', 'end': '14:30'},
                {'start': '20:00', 'end': '20:30'}
            ]
        }
    },

    # ä¹°ä¸€å¹´é€ä¸¤æœˆ
    'buy_year_get_bonus': {
        'name': 'ä¹°ä¸€å¹´é€ä¸¤æœˆ',
        'campaign_type': 'buy_get_free',
        'description': 'è´­ä¹°å¹´åº¦ä¼šå‘˜ï¼Œé¢å¤–èµ é€2ä¸ªæœˆ',
        'rules': {
            'type': 'buy_get_free',
            'buy_product': 4,
            'gift_days': 60,
            'gift_description': 'ä¹°12ä¸ªæœˆé€2ä¸ªæœˆï¼Œå®é™…äº«å—14ä¸ªæœˆ'
        }
    },

    # é‚€è¯·æœ‰ç¤¼
    'invite_friends': {
        'name': 'é‚€è¯·å¥½å‹ï¼ŒåŒæ–¹å„å¾—7å¤©',
        'campaign_type': 'referral',
        'description': 'é‚€è¯·å¥½å‹æ³¨å†Œå¹¶ä»˜è´¹ï¼ŒåŒæ–¹å„å¾—7å¤©ä¼šå‘˜',
        'rules': {
            'type': 'referral',
            'inviter_reward': {'type': 'days', 'value': 7},
            'invitee_reward': {'type': 'days', 'value': 7},
            'invitee_must_pay': True,
            'max_invites': 20
        }
    },

    # è€ç”¨æˆ·ç»­è´¹
    'renewal_discount': {
        'name': 'è€ç”¨æˆ·ç»­è´¹8æŠ˜',
        'campaign_type': 'renewal_discount',
        'description': 'ä¼šå‘˜åˆ°æœŸå‰30å¤©å†…ç»­è´¹äº«8æŠ˜',
        'rules': {
            'type': 'renewal_discount',
            'discount_type': 'percent',
            'discount_value': 80,
            'days_before_expire': 30,
            'applicable_products': [2, 3, 4]
        },
        'target_users': {'is_member': True, 'expire_within_days': 30}
    },

    # èŠ‚æ—¥æ´»åŠ¨ - åŒ11
    'double_11': {
        'name': 'åŒ11ç‹‚æ¬¢',
        'campaign_type': 'festival',
        'description': 'åŒ11ç‰¹æƒ ï¼Œå¹´åº¦ä¼šå‘˜ç«‹å‡111å…ƒ',
        'rules': {
            'type': 'festival_discount',
            'discount_type': 'fixed',
            'discount_value': 111,
            'applicable_products': [4, 5],
            'festival': 'double_11'
        }
    },

    # ä¼šå‘˜æ—¥
    'member_day': {
        'name': 'æ¯æœˆ8å·ä¼šå‘˜æ—¥',
        'campaign_type': 'member_day',
        'description': 'æ¯æœˆ8å·ï¼Œå…¨åœº88æŠ˜',
        'rules': {
            'type': 'member_day',
            'day_of_month': 8,
            'discount_type': 'percent',
            'discount_value': 88,
            'applicable_products': [2, 3, 4, 5]
        }
    },

    # é¦–å……è¿”ç°
    'first_charge_bonus': {
        'name': 'é¦–å……å¤šé€30å¤©',
        'campaign_type': 'first_charge',
        'description': 'é¦–æ¬¡å……å€¼ä»»æ„å¥—é¤ï¼Œé¢å¤–èµ é€30å¤©',
        'rules': {
            'type': 'first_charge_bonus',
            'bonus_days': 30,
            'applicable_products': [2, 3, 4, 5]
        },
        'target_users': {'has_paid': False}
    },

    # è¿ç»­åŒ…æœˆä¼˜æƒ 
    'subscription': {
        'name': 'è¿ç»­åŒ…æœˆä¼˜æƒ ',
        'campaign_type': 'subscription',
        'description': 'å¼€é€šè‡ªåŠ¨ç»­è´¹ï¼Œæ¯æœˆä»…éœ€9.9å…ƒ',
        'rules': {
            'type': 'subscription',
            'monthly_price': 9.9,
            'original_price': 12,
            'auto_renew': True
        }
    },

    # ç­¾åˆ°é¢†ç§¯åˆ†
    'daily_checkin': {
        'name': 'ç­¾åˆ°é¢†ç§¯åˆ†',
        'campaign_type': 'checkin',
        'description': 'æ¯æ—¥ç­¾åˆ°é¢†ç§¯åˆ†ï¼Œç§¯åˆ†å¯å…‘æ¢ä¼šå‘˜',
        'rules': {
            'type': 'checkin',
            'daily_points': 10,
            'consecutive_bonus': [
                {'days': 7, 'bonus': 50},
                {'days': 30, 'bonus': 200}
            ],
            'exchange_rate': 1000  # 1000ç§¯åˆ†=1å¤©ä¼šå‘˜
        }
    }
}
```

### 15B.5 ç®¡ç†åå°æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| å‰ç«¯æ¡†æ¶ | **Vue 3 + Element Plus** | æˆç†Ÿçš„åå°UIæ–¹æ¡ˆ |
| çŠ¶æ€ç®¡ç† | **Pinia** | Vue 3æ¨è |
| å›¾è¡¨ | **ECharts** | ä¸°å¯Œçš„æ•°æ®å¯è§†åŒ– |
| æƒé™ | **RBAC** | åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ |
| åç«¯ | å¤ç”¨ä¸»API + ç®¡ç†ä¸“ç”¨æ¥å£ | å‡å°‘é‡å¤å¼€å‘ |

### 15B.6 ç®¡ç†å‘˜æƒé™è®¾è®¡

```sql
-- ç®¡ç†å‘˜è¡¨
CREATE TABLE admins (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    role_id UUID REFERENCES admin_roles(id),
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è§’è‰²è¡¨
CREATE TABLE admin_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    permissions JSONB NOT NULL,           -- æƒé™åˆ—è¡¨
    created_at TIMESTAMP DEFAULT NOW()
);

-- é¢„ç½®è§’è‰²
-- è¶…çº§ç®¡ç†å‘˜: ["*"]
-- è¿è¥: ["user:view", "user:edit", "campaign:*", "content:*", "stats:view"]
-- å®¢æœ: ["user:view", "order:view", "order:refund"]
-- æ•°æ®åˆ†æ: ["stats:*", "user:view"]

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE admin_operation_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_id UUID REFERENCES admins(id),
    operation VARCHAR(100) NOT NULL,
    target_type VARCHAR(50),              -- user, order, campaign
    target_id UUID,
    old_value JSONB,
    new_value JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## åå…­ã€å›½é™…åŒ–(i18n)è®¾è®¡

### 16.1 æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ä»£ç  | è¯­è¨€åç§° | é»˜è®¤åœ°åŒº |
|----------|----------|----------|
| zh-CN | ç®€ä½“ä¸­æ–‡ | ä¸­å›½å¤§é™† |
| zh-TW | ç¹ä½“ä¸­æ–‡ | å°æ¹¾ã€é¦™æ¸¯ã€æ¾³é—¨ |
| en-US | è‹±è¯­ | ç¾å›½ã€è‹±å›½ã€æ¾³æ´²ç­‰ |
| ja-JP | æ—¥è¯­ | æ—¥æœ¬ |
| ko-KR | éŸ©è¯­ | éŸ©å›½ |
| th-TH | æ³°è¯­ | æ³°å›½ |
| vi-VN | è¶Šå—è¯­ | è¶Šå— |
| ms-MY | é©¬æ¥è¯­ | é©¬æ¥è¥¿äºš |

### 16.2 è¯­è¨€æ£€æµ‹ä¼˜å…ˆçº§

```dart
class LocaleManager {
  Locale detectUserLocale(UserInfo? user, String? ipCountry) {
    // 1. ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„è¯­è¨€ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    if (user?.preferredLanguage != null) {
      return Locale(user!.preferredLanguage);
    }

    // 2. æ ¹æ®IPæ£€æµ‹çš„å›½å®¶
    if (ipCountry != null) {
      return _countryToLocale(ipCountry);
    }

    // 3. è®¾å¤‡ç³»ç»Ÿè¯­è¨€
    final deviceLocale = Platform.localeName;
    if (_supportedLocales.contains(deviceLocale)) {
      return Locale(deviceLocale);
    }

    // 4. é»˜è®¤ä¸­æ–‡
    return const Locale('zh', 'CN');
  }

  static const _countryLocaleMap = {
    'CN': 'zh-CN',
    'TW': 'zh-TW',
    'HK': 'zh-TW',
    'US': 'en-US',
    'GB': 'en-US',
    'JP': 'ja-JP',
    'KR': 'ko-KR',
    'TH': 'th-TH',
    // ...
  };
}
```

### 16.3 Flutterå›½é™…åŒ–å®ç°

```yaml
# pubspec.yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: ^0.18.0

flutter:
  generate: true
```

```dart
// lib/l10n/app_zh.arb
{
  "@@locale": "zh",
  "appName": "æ™ºèƒ½è®°è´¦",
  "home": "é¦–é¡µ",
  "stats": "ç»Ÿè®¡",
  "bills": "è´¦å•",
  "profile": "æˆ‘çš„",
  "expense": "æ”¯å‡º",
  "income": "æ”¶å…¥",
  "transfer": "è½¬è´¦",
  "monthlyExpense": "æœ¬æœˆæ”¯å‡º",
  "monthlyIncome": "æœ¬æœˆæ”¶å…¥",
  "balance": "ç»“ä½™",
  "budget": "é¢„ç®—",
  "category": "åˆ†ç±»",
  "account": "è´¦æˆ·",
  "note": "å¤‡æ³¨",
  "save": "ä¿å­˜",
  "cancel": "å–æ¶ˆ",
  "delete": "åˆ é™¤",
  "edit": "ç¼–è¾‘",
  "settings": "è®¾ç½®",
  "language": "è¯­è¨€",
  "currency": "è´§å¸",
  "theme": "ä¸»é¢˜",
  "about": "å…³äº",
  "logout": "é€€å‡ºç™»å½•",
  "upgradeToVip": "å‡çº§VIP",
  "aiRecognition": "AIè¯†åˆ«",
  "voiceInput": "è¯­éŸ³è®°è´¦",
  "scanReceipt": "æ‰«æå°ç¥¨",

  "categoryFood": "é¤é¥®",
  "categoryHousing": "ä½æˆ¿",
  "categoryEntertainment": "å¨±ä¹",
  "categoryTransport": "äº¤é€š",
  "categoryShopping": "è´­ç‰©",
  "categoryMedical": "åŒ»ç–—",
  "categorySalary": "å·¥èµ„",
  "categoryBonus": "å¥–é‡‘",

  "freeUsageExhausted": "æœ¬æœˆå…è´¹{feature}æ¬¡æ•°å·²ç”¨å®Œ",
  "@freeUsageExhausted": {
    "placeholders": {
      "feature": {"type": "String"}
    }
  }
}
```

```dart
// lib/l10n/app_en.arb
{
  "@@locale": "en",
  "appName": "AI Bookkeeping",
  "home": "Home",
  "stats": "Statistics",
  "bills": "Bills",
  "profile": "Profile",
  "expense": "Expense",
  "income": "Income",
  "transfer": "Transfer",
  "monthlyExpense": "Monthly Expense",
  "monthlyIncome": "Monthly Income",
  "balance": "Balance",
  // ...
}
```

### 16.4 åç«¯å¤šè¯­è¨€æ”¯æŒ

```python
# åç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯ä¹Ÿæ”¯æŒå¤šè¯­è¨€
class I18nMessages:
    messages = {
        'auth.invalid_password': {
            'zh-CN': 'å¯†ç é”™è¯¯',
            'en-US': 'Invalid password',
            'ja-JP': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
        },
        'member.quota_exceeded': {
            'zh-CN': 'æœ¬æœˆå…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å‡çº§VIP',
            'en-US': 'Free quota exceeded, please upgrade to VIP',
            'ja-JP': 'ä»Šæœˆã®ç„¡æ–™å›æ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„',
        },
    }

    @classmethod
    def get(cls, key: str, locale: str = 'zh-CN') -> str:
        return cls.messages.get(key, {}).get(locale, key)
```

### 16.5 ç”¨æˆ·è¯­è¨€è®¾ç½®

```sql
-- ç”¨æˆ·è¡¨æ·»åŠ è¯­è¨€è®¾ç½®
ALTER TABLE users ADD COLUMN preferred_language VARCHAR(10);
ALTER TABLE users ADD COLUMN detected_language VARCHAR(10);  -- IPæ£€æµ‹è¯­è¨€
```

---

## åä¸ƒã€æ•°æ®å¤‡ä»½ç³»ç»Ÿè®¾è®¡

### 17.1 å¤‡ä»½ç­–ç•¥

| ç”¨æˆ·ç±»å‹ | è‡ªåŠ¨å¤‡ä»½é¢‘ç‡ | ä¿ç•™ä»½æ•° | æ‰‹åŠ¨å¤‡ä»½ |
|----------|--------------|----------|----------|
| å…è´¹ç”¨æˆ· | æ¯æœˆ1æ¬¡ | 1ä»½ | âœ… |
| VIPä¼šå‘˜ | æ¯æ—¥1æ¬¡ | 30ä»½ | âœ… æ— é™ |

### 17.2 å¤‡ä»½æ•°æ®è¡¨

```sql
-- ç”¨æˆ·å¤‡ä»½è®°å½•è¡¨
CREATE TABLE user_backups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    backup_type INT NOT NULL,            -- 1:è‡ªåŠ¨ 2:æ‰‹åŠ¨
    backup_size BIGINT NOT NULL,         -- å­—èŠ‚æ•°
    file_path VARCHAR(500) NOT NULL,     -- OSSè·¯å¾„
    file_hash VARCHAR(64),               -- SHA256æ ¡éªŒ
    data_summary JSONB,                  -- æ•°æ®æ‘˜è¦
    status INT DEFAULT 0,                -- 0:è¿›è¡Œä¸­ 1:æˆåŠŸ 2:å¤±è´¥
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP                 -- è¿‡æœŸæ—¶é—´
);

-- æ•°æ®æ‘˜è¦ç¤ºä¾‹
-- {
--   "transactions_count": 1234,
--   "accounts_count": 5,
--   "books_count": 2,
--   "categories_count": 30,
--   "date_range": {"from": "2024-01-01", "to": "2024-12-27"},
--   "total_expense": 50000.00,
--   "total_income": 80000.00
-- }
```

### 17.3 å¤‡ä»½å†…å®¹

```json
{
  "version": "1.0",
  "created_at": "2024-12-27T10:00:00Z",
  "user_id": "xxx",
  "data": {
    "user_settings": {
      "default_currency": "CNY",
      "preferred_language": "zh-CN",
      "theme": "light"
    },
    "books": [...],
    "accounts": [...],
    "categories": [...],
    "transactions": [...],
    "budgets": [...],
    "scheduled_transactions": [...]
  }
}
```

### 17.4 å¤‡ä»½æœåŠ¡å®ç°

```python
class BackupService:
    async def create_backup(self, user_id: str, backup_type: int = 1) -> str:
        """åˆ›å»ºç”¨æˆ·æ•°æ®å¤‡ä»½"""

        # 1. æ”¶é›†ç”¨æˆ·æ‰€æœ‰æ•°æ®
        data = await self._collect_user_data(user_id)

        # 2. åºåˆ—åŒ–ä¸ºJSON
        json_data = json.dumps(data, ensure_ascii=False, default=str)

        # 3. å‹ç¼©
        compressed = gzip.compress(json_data.encode('utf-8'))

        # 4. åŠ å¯†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±å¯†é’¥ï¼‰
        encrypted = await self._encrypt_data(compressed, user_id)

        # 5. ä¸Šä¼ åˆ°OSS
        file_path = f"backups/{user_id}/{datetime.now().strftime('%Y%m%d_%H%M%S')}.backup"
        await self.oss.upload(file_path, encrypted)

        # 6. è®°å½•å¤‡ä»½ä¿¡æ¯
        backup_record = await self._save_backup_record(
            user_id=user_id,
            backup_type=backup_type,
            file_path=file_path,
            backup_size=len(encrypted),
            data_summary=self._generate_summary(data)
        )

        # 7. æ¸…ç†è¿‡æœŸå¤‡ä»½
        await self._cleanup_old_backups(user_id)

        return backup_record.id

    async def restore_backup(self, user_id: str, backup_id: str):
        """æ¢å¤ç”¨æˆ·æ•°æ®"""

        # 1. è·å–å¤‡ä»½æ–‡ä»¶
        backup = await self.get_backup(backup_id)
        encrypted = await self.oss.download(backup.file_path)

        # 2. è§£å¯†
        compressed = await self._decrypt_data(encrypted, user_id)

        # 3. è§£å‹
        json_data = gzip.decompress(compressed).decode('utf-8')
        data = json.loads(json_data)

        # 4. æ¢å¤æ•°æ®ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
        async with self.db.transaction():
            # æ¸…ç©ºç°æœ‰æ•°æ®
            await self._clear_user_data(user_id)
            # å¯¼å…¥å¤‡ä»½æ•°æ®
            await self._import_data(user_id, data)

        return True

    async def _cleanup_old_backups(self, user_id: str):
        """æ¸…ç†è¿‡æœŸå¤‡ä»½"""
        user = await self.get_user(user_id)
        keep_count = 30 if user.is_vip else 1

        # è·å–æ‰€æœ‰å¤‡ä»½ï¼ŒæŒ‰æ—¶é—´å€’åº
        backups = await self.get_user_backups(user_id, order_by='-created_at')

        # åˆ é™¤è¶…å‡ºä¿ç•™æ•°é‡çš„å¤‡ä»½
        for backup in backups[keep_count:]:
            await self.oss.delete(backup.file_path)
            await backup.delete()
```

### 17.5 å®šæ—¶å¤‡ä»½ä»»åŠ¡

```python
# Celeryå®šæ—¶ä»»åŠ¡
@celery.task
def scheduled_backup():
    """æ¯æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ"""

    # VIPç”¨æˆ·æ¯æ—¥å¤‡ä»½
    vip_users = User.query.filter(User.is_vip == True).all()
    for user in vip_users:
        create_backup.delay(user.id, backup_type=1)

    # å…è´¹ç”¨æˆ·æ¯æœˆ1å·å¤‡ä»½
    if datetime.now().day == 1:
        free_users = User.query.filter(User.is_vip == False).all()
        for user in free_users:
            create_backup.delay(user.id, backup_type=1)

# Celery Beaté…ç½®
CELERYBEAT_SCHEDULE = {
    'daily-backup': {
        'task': 'tasks.scheduled_backup',
        'schedule': crontab(hour=3, minute=0),
    },
}
```

### 17.6 å¤‡ä»½ç®¡ç†ç•Œé¢

```
æ•°æ®å¤‡ä»½
â”œâ”€â”€ æœ€è¿‘å¤‡ä»½: 2024-12-27 03:00
â”œâ”€â”€ å¤‡ä»½å¤§å°: 2.3 MB
â”œâ”€â”€ æ•°æ®æ¦‚è¦:
â”‚   â”œâ”€â”€ è´¦ç›®: 3,240æ¡
â”‚   â”œâ”€â”€ è´¦æœ¬: 2ä¸ª
â”‚   â””â”€â”€ æ—¶é—´èŒƒå›´: 2024-01 ~ 2024-12
â”œâ”€â”€ å†å²å¤‡ä»½ (VIP: 30ä»½ / å…è´¹: 1ä»½)
â”‚   â”œâ”€â”€ 2024-12-27 03:00 - 2.3 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â”œâ”€â”€ 2024-12-26 03:00 - 2.2 MB [æ¢å¤] [ä¸‹è½½] [åˆ é™¤]
â”‚   â””â”€â”€ ...
â””â”€â”€ [ç«‹å³å¤‡ä»½] [å¯¼å‡ºåˆ°æœ¬åœ°]
```

---

## åå…«ã€æ‰©å±•æ€§æ¶æ„è®¾è®¡

### 18.1 å®¹é‡è§„åˆ’ç›®æ ‡

| é˜¶æ®µ | DAU | æ³¨å†Œç”¨æˆ· | æ—¥è®°è´¦é‡ | å¹¶å‘è¯·æ±‚ | æ•°æ®å¢é•¿/æœˆ |
|------|-----|----------|----------|----------|-------------|
| **åˆæœŸ** | 1,000 | 5,000 | 5,000æ¡ | 50 QPS | 500MB |
| **ä¸­æœŸ** | 10,000 | 50,000 | 50,000æ¡ | 500 QPS | 5GB |
| **è¿œæœŸ** | 100,000 | 500,000 | 500,000æ¡ | 5,000 QPS | 50GB |

### 18.2 ä¸‰é˜¶æ®µæ¶æ„æ¼”è¿›

#### é˜¶æ®µä¸€ï¼šå•æœºæ¶æ„ (1,000 DAU)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‘æœåŠ¡å™¨ (å•æœº)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Nginx     â”‚  â”‚   FastAPI   â”‚  â”‚   Celery    â”‚         â”‚
â”‚  â”‚  (åå‘ä»£ç†) â”‚  â”‚  (2 workers)â”‚  â”‚  (1 worker) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚  â”‚   MinIO     â”‚         â”‚
â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (å•å®ä¾‹)   â”‚  â”‚  (æœ¬åœ°å­˜å‚¨) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æœˆè´¹ç”¨ |
|------|------|--------|
| ECS | 2æ ¸4G | Â¥150 |
| äº‘ç›˜ | 100GB SSD | Â¥40 |
| å¸¦å®½ | 5Mbps | Â¥100 |
| **åˆè®¡** | | **Â¥290/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 200ms (P95)
- æ”¯æŒå¹¶å‘: 50-100 QPS
- æ•°æ®åº“è¿æ¥æ•°: 20

---

#### é˜¶æ®µäºŒï¼šåˆ†ç¦»æ¶æ„ (10,000 DAU)

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     SLB     â”‚
                        â”‚  (è´Ÿè½½å‡è¡¡) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   API Server 1  â”‚ â”‚   ...   â”‚ â”‚   API Server 2  â”‚
     â”‚   (2æ ¸4G)       â”‚ â”‚         â”‚ â”‚   (2æ ¸4G)       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL â”‚       â”‚     Redis     â”‚      â”‚     OSS     â”‚
â”‚   (2æ ¸4G)   â”‚       â”‚    (1æ ¸2G)    â”‚      â”‚  (å¯¹è±¡å­˜å‚¨) â”‚
â”‚   ä¸»ä»å¤åˆ¶   â”‚       â”‚    å•å®ä¾‹     â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| SLB | æ ‡å‡†å‹ | 1 | Â¥50 |
| ECS (API) | 2æ ¸4G | 2 | Â¥300 |
| RDS PostgreSQL | 2æ ¸4G | 1 | Â¥400 |
| Redis | 1æ ¸2G | 1 | Â¥150 |
| OSS | 100GB | 1 | Â¥20 |
| å¸¦å®½ | 10Mbps | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥1,120/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 150ms (P95)
- æ”¯æŒå¹¶å‘: 300-500 QPS
- æ•°æ®åº“è¿æ¥æ± : 50
- è¯»å†™åˆ†ç¦»æ”¯æŒ

**å‡çº§è·¯å¾„ï¼ˆä»é˜¶æ®µä¸€ï¼‰ï¼š**
1. æ•°æ®åº“è¿ç§»åˆ°RDSï¼ˆçº¦2å°æ—¶åœæœºï¼‰
2. éƒ¨ç½²ç¬¬äºŒå°APIæœåŠ¡å™¨
3. é…ç½®SLBè´Ÿè½½å‡è¡¡
4. æ–‡ä»¶å­˜å‚¨è¿ç§»åˆ°OSS
5. **é¢„è®¡å‡çº§æˆæœ¬**: Â¥0ï¼ˆå¹³æ»‘è¿ç§»ï¼‰
6. **é¢„è®¡å‡çº§æ—¶é—´**: 1å¤©

---

#### é˜¶æ®µä¸‰ï¼šé›†ç¾¤æ¶æ„ (100,000 DAU)

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     CDN     â”‚
                           â”‚  (é™æ€èµ„æº) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                           â”‚     SLB     â”‚
                           â”‚ (è´Ÿè½½å‡è¡¡)  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚         â”‚  API Pod x N  â”‚
â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚         â”‚  (K8sé›†ç¾¤)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚                             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ PGä¸»åº“ â”‚â—„â”€â”€â”€â”€ åŒæ­¥å¤åˆ¶ â”€â”€â”€â–ºâ”‚  PGä»åº“   â”‚                 â”‚  PGä»åº“   â”‚
â”‚(4æ ¸16G)â”‚                   â”‚ (4æ ¸8G)   â”‚                 â”‚ (4æ ¸8G)   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚                     Redis Cluster                           â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â””â”€â”€â”¼â”€â”€â–ºâ”‚ Master1 â”‚   â”‚ Master2 â”‚   â”‚ Master3 â”‚                  â”‚
       â”‚   â”‚ Slave1  â”‚   â”‚ Slave2  â”‚   â”‚ Slave3  â”‚                  â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š**
| èµ„æº | é…ç½® | æ•°é‡ | æœˆè´¹ç”¨ |
|------|------|------|--------|
| ACKé›†ç¾¤ | 4æ ¸8GèŠ‚ç‚¹ | 4 | Â¥2,400 |
| SLB | é«˜æ€§èƒ½å‹ | 1 | Â¥200 |
| RDS PostgreSQL | 4æ ¸16Gä¸» + 4æ ¸8Gä»x2 | 3 | Â¥2,500 |
| Redisé›†ç¾¤ | 4Gé›†ç¾¤ç‰ˆ | 1 | Â¥800 |
| OSS | 1TB + CDN | 1 | Â¥300 |
| å¸¦å®½ | 50Mbps | 1 | Â¥1,000 |
| æ—¥å¿—æœåŠ¡ | SLS | 1 | Â¥200 |
| **åˆè®¡** | | | **Â¥7,400/æœˆ** |

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 100ms (P95)
- æ”¯æŒå¹¶å‘: 3,000-5,000 QPS
- æ•°æ®åº“è¿æ¥æ± : 200
- è‡ªåŠ¨æ‰©ç¼©å®¹æ”¯æŒ

---

### 18.3 æ•°æ®åº“æ‰©å±•ç­–ç•¥

#### åˆ†è¡¨ç­–ç•¥ï¼ˆ10ä¸‡DAUæ—¶å¯ç”¨ï¼‰

```sql
-- è´¦ç›®è¡¨æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨
-- transactions_0, transactions_1, ... transactions_15 (16å¼ è¡¨)

-- åˆ†è¡¨è·¯ç”±å‡½æ•°
CREATE OR REPLACE FUNCTION get_transaction_table(user_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN 'transactions_' || (hashtext(user_id::text) & 15)::text;
END;
$$ LANGUAGE plpgsql;
```

#### è¯»å†™åˆ†ç¦»é…ç½®

```python
# SQLAlchemyè¯»å†™åˆ†ç¦»
DATABASES = {
    'default': {
        'write': 'postgresql://master:5432/bookkeeping',
        'read': [
            'postgresql://slave1:5432/bookkeeping',
            'postgresql://slave2:5432/bookkeeping',
        ]
    }
}

class RoutingSession:
    def get_bind(self, mapper=None, clause=None):
        if self._flushing:
            return engines['write']
        return random.choice(engines['read'])
```

#### çƒ­æ•°æ®åˆ†ç¦»

```sql
-- çƒ­æ•°æ®è¡¨ï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
CREATE TABLE transactions_hot (
    LIKE transactions INCLUDING ALL
);

-- å†·æ•°æ®è¡¨ï¼ˆ3ä¸ªæœˆå‰ï¼‰
CREATE TABLE transactions_cold (
    LIKE transactions INCLUDING ALL
);

-- å®šæ—¶è¿ç§»ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
-- å°†3ä¸ªæœˆå‰çš„æ•°æ®ä»hotè¿ç§»åˆ°cold
```

---

### 18.4 ç¼“å­˜ç­–ç•¥

#### å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°ç¼“å­˜   â”‚ â”€â”€â–º â”‚   Redis     â”‚ â”€â”€â–º â”‚  æ•°æ®åº“     â”‚
â”‚  (LRU 1min) â”‚     â”‚  (TTL 5min) â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜é”®è®¾è®¡

```python
CACHE_KEYS = {
    # ç”¨æˆ·ä¿¡æ¯ (TTL: 30åˆ†é’Ÿ)
    'user:{user_id}': 'user_info',

    # ç”¨æˆ·è´¦æœ¬åˆ—è¡¨ (TTL: 10åˆ†é’Ÿ)
    'user:{user_id}:books': 'book_list',

    # æœˆåº¦ç»Ÿè®¡ (TTL: 5åˆ†é’Ÿ)
    'stats:{user_id}:{book_id}:{year}:{month}': 'monthly_stats',

    # åˆ†ç±»åˆ—è¡¨ (TTL: 1å°æ—¶)
    'categories:{user_id}': 'category_list',

    # æ±‡ç‡ (TTL: 1å°æ—¶)
    'exchange_rate:{from}:{to}:{date}': 'rate',
}
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥

```python
class CacheManager:
    # å†™åå¤±æ•ˆæ¨¡å¼
    async def invalidate_on_write(self, user_id: str, entity: str):
        patterns = {
            'transaction': [
                f'stats:{user_id}:*',
                f'user:{user_id}:recent_transactions',
            ],
            'account': [
                f'user:{user_id}:accounts',
                f'account:{user_id}:*',
            ],
        }
        for pattern in patterns.get(entity, []):
            await self.redis.delete_pattern(pattern)
```

---

### 18.5 APIæ€§èƒ½ä¼˜åŒ–

#### æ¥å£é™æµé…ç½®

```python
from fastapi_limiter import RateLimiter

# é™æµè§„åˆ™
RATE_LIMITS = {
    # æ™®é€šæ¥å£: 100æ¬¡/åˆ†é’Ÿ
    'default': '100/minute',

    # AIæ¥å£: 10æ¬¡/åˆ†é’Ÿ (å…è´¹ç”¨æˆ·) / 60æ¬¡/åˆ†é’Ÿ (VIP)
    'ai_ocr': {'free': '10/minute', 'vip': '60/minute'},
    'ai_voice': {'free': '20/minute', 'vip': '120/minute'},

    # ç™»å½•æ¥å£: 5æ¬¡/åˆ†é’Ÿ (é˜²æš´åŠ›ç ´è§£)
    'auth_login': '5/minute',

    # å¯¼å‡ºæ¥å£: 5æ¬¡/å°æ—¶
    'export': '5/hour',
}
```

#### æ‰¹é‡æ¥å£ä¼˜åŒ–

```python
# æ‰¹é‡åˆ›å»ºè´¦ç›® (å‡å°‘ç½‘ç»œå¾€è¿”)
@router.post("/transactions/batch")
async def batch_create_transactions(
    transactions: List[TransactionCreate],  # æœ€å¤š50æ¡
    db: AsyncSession = Depends(get_db)
):
    # ä½¿ç”¨æ‰¹é‡æ’å…¥
    await db.execute(
        insert(Transaction),
        [t.dict() for t in transactions]
    )
```

#### å“åº”å‹ç¼©

```python
from fastapi.middleware.gzip import GZipMiddleware

app.add_middleware(GZipMiddleware, minimum_size=1000)
```

---

### 18.6 ç›‘æ§ä¸å‘Šè­¦

#### ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheus ç›‘æ§é…ç½®
metrics:
  # åº”ç”¨å±‚
  - api_request_total          # è¯·æ±‚æ€»æ•°
  - api_request_duration_seconds  # å“åº”æ—¶é—´
  - api_error_total            # é”™è¯¯æ•°

  # æ•°æ®åº“å±‚
  - db_connection_pool_size    # è¿æ¥æ± å¤§å°
  - db_query_duration_seconds  # æŸ¥è¯¢æ—¶é—´

  # ç¼“å­˜å±‚
  - cache_hit_ratio            # ç¼“å­˜å‘½ä¸­ç‡
  - cache_memory_usage         # å†…å­˜ä½¿ç”¨

  # ä¸šåŠ¡å±‚
  - active_users_daily         # æ—¥æ´»ç”¨æˆ·
  - transactions_created_total # è®°è´¦æ•°é‡
  - ai_requests_total          # AIè°ƒç”¨æ¬¡æ•°
```

#### å‘Šè­¦è§„åˆ™

```yaml
alerts:
  # APIå“åº”æ—¶é—´ > 500ms
  - alert: HighApiLatency
    expr: api_request_duration_seconds{quantile="0.95"} > 0.5
    for: 5m

  # é”™è¯¯ç‡ > 1%
  - alert: HighErrorRate
    expr: rate(api_error_total[5m]) / rate(api_request_total[5m]) > 0.01
    for: 5m

  # æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ > 80%
  - alert: DbConnectionPoolHigh
    expr: db_connection_pool_size / db_connection_pool_max > 0.8
    for: 5m

  # Rediså†…å­˜ä½¿ç”¨ > 80%
  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
```

---

### 18.7 æˆæœ¬å¯¹æ¯”æ€»ç»“

| é˜¶æ®µ | DAU | æœˆè´¹ç”¨ | å•ç”¨æˆ·æˆæœ¬ | å‡çº§æˆæœ¬ |
|------|-----|--------|------------|----------|
| åˆæœŸ | 1,000 | Â¥290 | Â¥0.29 | - |
| ä¸­æœŸ | 10,000 | Â¥1,120 | Â¥0.11 | Â¥0 |
| è¿œæœŸ | 100,000 | Â¥7,400 | Â¥0.07 | Â¥0 |

**å…³é”®è®¾è®¡åŸåˆ™ï¼š**
1. **æ— çŠ¶æ€APIæœåŠ¡** - æ”¯æŒæ°´å¹³æ‰©å±•
2. **æ•°æ®åº“è¯»å†™åˆ†ç¦»** - æ‰©å±•è¯»æ€§èƒ½
3. **å¤šçº§ç¼“å­˜** - å‡å°‘æ•°æ®åº“å‹åŠ›
4. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** - AIå¤„ç†ä¸é˜»å¡ä¸»æµç¨‹
5. **å¹³æ»‘å‡çº§** - æ¯æ¬¡å‡çº§åœæœºæ—¶é—´ < 30åˆ†é’Ÿ

---

### 18.8 æŠ€æœ¯é€‰å‹å¯¹æ¯”

#### ä¸ºä»€ä¹ˆé€‰æ‹©å•ä½“æ¶æ„è€Œéå¾®æœåŠ¡ï¼ˆåˆæœŸï¼‰

| ç»´åº¦ | å•ä½“æ¶æ„ | å¾®æœåŠ¡æ¶æ„ |
|------|----------|------------|
| å¼€å‘å¤æ‚åº¦ | ä½ | é«˜ |
| éƒ¨ç½²å¤æ‚åº¦ | ä½ | é«˜ |
| è¿ç»´æˆæœ¬ | Â¥290/æœˆ | Â¥2000+/æœˆ |
| é€‚åˆé˜¶æ®µ | < 5ä¸‡DAU | > 10ä¸‡DAU |
| å›¢é˜Ÿè§„æ¨¡ | 1-3äºº | 5+äºº |

**ç»“è®ºï¼š** åˆæœŸé‡‡ç”¨å•ä½“æ¶æ„ï¼Œå½“DAUè¶…è¿‡5ä¸‡ä¸”å›¢é˜Ÿæ‰©å¤§åå†è€ƒè™‘å¾®æœåŠ¡æ‹†åˆ†ã€‚

#### æ½œåœ¨çš„å¾®æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆï¼ˆè¿œæœŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚  â”‚  è®°è´¦æœåŠ¡   â”‚  â”‚  ç»Ÿè®¡æœåŠ¡   â”‚
â”‚ user-svc   â”‚  â”‚ txn-svc    â”‚  â”‚ stats-svc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIæœåŠ¡    â”‚  â”‚  é€šçŸ¥æœåŠ¡   â”‚  â”‚  æ”¯ä»˜æœåŠ¡   â”‚
â”‚  ai-svc    â”‚  â”‚ notify-svc â”‚  â”‚ payment-svcâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åå…«Aã€æ—¥å¿—ç³»ç»Ÿè®¾è®¡

### 18A.1 æ—¥å¿—åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—é‡‡é›†å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Appæ—¥å¿—    â”‚  â”‚  APIæ—¥å¿—    â”‚  â”‚  ç³»ç»Ÿæ—¥å¿—   â”‚             â”‚
â”‚  â”‚ (Flutter)   â”‚  â”‚ (FastAPI)   â”‚  â”‚ (Nginxç­‰)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å¤„ç†å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Filebeat / Fluent Bit (æ—¥å¿—æ”¶é›†)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å­˜å‚¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Elasticsearch   â”‚    æˆ–    â”‚   é˜¿é‡Œäº‘SLS       â”‚          â”‚
â”‚  â”‚   (è‡ªå»º)          â”‚          â”‚   (äº‘æœåŠ¡)        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ—¥å¿—å±•ç¤ºå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     Kibana        â”‚    æˆ–    â”‚   SLSæ§åˆ¶å°       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18A.2 æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ« | åç§° | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|------|----------|------|
| **CRITICAL** | ä¸¥é‡ | ç³»ç»Ÿå´©æºƒã€æ•°æ®ä¸¢å¤± | æ•°æ®åº“è¿æ¥æ± è€—å°½ |
| **ERROR** | é”™è¯¯ | åŠŸèƒ½å¼‚å¸¸ã€éœ€è¦ä¿®å¤ | æ”¯ä»˜å›è°ƒéªŒç­¾å¤±è´¥ |
| **WARNING** | è­¦å‘Š | æ½œåœ¨é—®é¢˜ã€éœ€å…³æ³¨ | æ¥å£å“åº”æ—¶é—´è¿‡é•¿ |
| **INFO** | ä¿¡æ¯ | æ­£å¸¸ä¸šåŠ¡æµç¨‹ | ç”¨æˆ·ç™»å½•æˆåŠŸ |
| **DEBUG** | è°ƒè¯• | å¼€å‘è°ƒè¯•ä¿¡æ¯ | è¯·æ±‚å‚æ•°è¯¦æƒ… |

### 18A.3 æ—¥å¿—æ ¼å¼è§„èŒƒ

#### ç»Ÿä¸€JSONæ ¼å¼

```json
{
  "timestamp": "2024-12-27T15:30:45.123Z",
  "level": "INFO",
  "logger": "api.transactions",
  "trace_id": "abc123def456",
  "span_id": "span789",
  "user_id": "user_xxx",
  "request_id": "req_yyy",
  "message": "Transaction created successfully",
  "context": {
    "transaction_id": "txn_zzz",
    "amount": 35.50,
    "category": "é¤é¥®"
  },
  "duration_ms": 45,
  "host": "api-server-1",
  "env": "production"
}
```

### 18A.4 åç«¯æ—¥å¿—å®ç°

```python
# app/core/logging.py
import logging
import json
import sys
from datetime import datetime
from contextvars import ContextVar
from typing import Optional

# è¯·æ±‚ä¸Šä¸‹æ–‡
request_id_var: ContextVar[Optional[str]] = ContextVar('request_id', default=None)
trace_id_var: ContextVar[Optional[str]] = ContextVar('trace_id', default=None)
user_id_var: ContextVar[Optional[str]] = ContextVar('user_id', default=None)

class JSONFormatter(logging.Formatter):
    """JSONæ ¼å¼æ—¥å¿—è¾“å‡º"""

    def format(self, record: logging.LogRecord) -> str:
        log_data = {
            'timestamp': datetime.utcnow().isoformat() + 'Z',
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'trace_id': trace_id_var.get(),
            'request_id': request_id_var.get(),
            'user_id': user_id_var.get(),
            'host': socket.gethostname(),
            'env': settings.ENVIRONMENT,
        }

        # æ·»åŠ å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)

        # æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡
        if hasattr(record, 'context'):
            log_data['context'] = record.context

        # æ·»åŠ è€—æ—¶
        if hasattr(record, 'duration_ms'):
            log_data['duration_ms'] = record.duration_ms

        return json.dumps(log_data, ensure_ascii=False)


def setup_logging():
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)

    # æ§åˆ¶å°è¾“å‡º
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(console_handler)

    # æ–‡ä»¶è¾“å‡ºï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    if settings.ENVIRONMENT == 'production':
        file_handler = logging.handlers.RotatingFileHandler(
            filename='/var/log/app/api.log',
            maxBytes=100 * 1024 * 1024,  # 100MB
            backupCount=10,
            encoding='utf-8'
        )
        file_handler.setFormatter(JSONFormatter())
        root_logger.addHandler(file_handler)


class AppLogger:
    """åº”ç”¨æ—¥å¿—å·¥å…·ç±»"""

    def __init__(self, name: str):
        self.logger = logging.getLogger(name)

    def info(self, message: str, **context):
        self._log(logging.INFO, message, context)

    def warning(self, message: str, **context):
        self._log(logging.WARNING, message, context)

    def error(self, message: str, exc_info=None, **context):
        self._log(logging.ERROR, message, context, exc_info=exc_info)

    def debug(self, message: str, **context):
        self._log(logging.DEBUG, message, context)

    def _log(self, level: int, message: str, context: dict, exc_info=None):
        record = self.logger.makeRecord(
            self.logger.name, level, '', 0, message, (), exc_info
        )
        if context:
            record.context = context
        self.logger.handle(record)


# ä½¿ç”¨ç¤ºä¾‹
logger = AppLogger('api.transactions')
logger.info('Transaction created', transaction_id='txn_123', amount=35.50)
```

### 18A.5 è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

```python
# app/middleware/logging.py
import time
import uuid
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware

class RequestLoggingMiddleware(BaseHTTPMiddleware):
    """è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        # ç”Ÿæˆè¯·æ±‚IDå’Œè¿½è¸ªID
        request_id = str(uuid.uuid4())[:8]
        trace_id = request.headers.get('X-Trace-ID', str(uuid.uuid4()))

        # è®¾ç½®ä¸Šä¸‹æ–‡
        request_id_var.set(request_id)
        trace_id_var.set(trace_id)

        # è®°å½•å¼€å§‹æ—¶é—´
        start_time = time.time()

        # è¯·æ±‚æ—¥å¿—
        logger.info(
            'Request started',
            method=request.method,
            path=request.url.path,
            query=str(request.query_params),
            client_ip=request.client.host,
            user_agent=request.headers.get('User-Agent'),
        )

        try:
            response = await call_next(request)
            duration_ms = (time.time() - start_time) * 1000

            # å“åº”æ—¥å¿—
            logger.info(
                'Request completed',
                method=request.method,
                path=request.url.path,
                status_code=response.status_code,
                duration_ms=round(duration_ms, 2),
            )

            # æ·»åŠ è¿½è¸ªå¤´
            response.headers['X-Request-ID'] = request_id
            response.headers['X-Trace-ID'] = trace_id

            return response

        except Exception as e:
            duration_ms = (time.time() - start_time) * 1000
            logger.error(
                'Request failed',
                method=request.method,
                path=request.url.path,
                error=str(e),
                duration_ms=round(duration_ms, 2),
                exc_info=True,
            )
            raise
```

### 18A.6 ä¸šåŠ¡æ—¥å¿—è§„èŒƒ

```python
# ä¸šåŠ¡æ—¥å¿—ç¤ºä¾‹

# ç”¨æˆ·æ¨¡å—
logger = AppLogger('biz.user')
logger.info('User registered', user_id='xxx', method='wechat')
logger.info('User logged in', user_id='xxx', ip='1.2.3.4')
logger.warning('Login failed', phone='138****1234', reason='wrong_password', attempts=3)

# äº¤æ˜“æ¨¡å—
logger = AppLogger('biz.transaction')
logger.info('Transaction created', txn_id='xxx', user_id='xxx', type='expense', amount=35.5)
logger.info('Transaction updated', txn_id='xxx', changes={'amount': [35.5, 40.0]})
logger.info('Transaction deleted', txn_id='xxx', user_id='xxx')

# AIæ¨¡å—
logger = AppLogger('biz.ai')
logger.info('OCR started', user_id='xxx', image_size=1024000)
logger.info('OCR completed', user_id='xxx', duration_ms=1500, confidence=0.95)
logger.error('OCR failed', user_id='xxx', error='Image too blurry')

# æ”¯ä»˜æ¨¡å—
logger = AppLogger('biz.payment')
logger.info('Payment order created', order_no='xxx', amount=98, method='wechat_pay')
logger.info('Payment callback received', order_no='xxx', transaction_id='wx_xxx')
logger.info('Payment completed', order_no='xxx', user_id='xxx')
logger.error('Payment callback verification failed', order_no='xxx', reason='sign_mismatch')

# ä¼šå‘˜æ¨¡å—
logger = AppLogger('biz.membership')
logger.info('Trial activated', user_id='xxx', expire_at='2025-01-27')
logger.info('Member upgraded', user_id='xxx', level=4, expire_at='2026-01-27')
logger.info('Member expired', user_id='xxx', level=4)
```

### 18A.7 æ—¥å¿—å­˜å‚¨ä¸å½’æ¡£

```yaml
# æ—¥å¿—ä¿ç•™ç­–ç•¥
retention:
  # çƒ­æ•°æ®ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰
  hot:
    duration: 7d
    storage: SSD

  # æ¸©æ•°æ®ï¼ˆå†å²æŸ¥è¯¢ï¼‰
  warm:
    duration: 30d
    storage: HDD

  # å†·æ•°æ®ï¼ˆå½’æ¡£ï¼‰
  cold:
    duration: 365d
    storage: OSS
    compressed: true

# æ—¥å¿—ç´¢å¼•é…ç½®
indices:
  app-logs:
    shards: 3
    replicas: 1
    refresh_interval: 5s

  access-logs:
    shards: 5
    replicas: 1
    refresh_interval: 10s
```

### 18A.8 å‰ç«¯æ—¥å¿—é‡‡é›†

```dart
// lib/core/logging/app_logger.dart
import 'package:dio/dio.dart';

enum LogLevel { debug, info, warning, error }

class AppLogger {
  static final AppLogger _instance = AppLogger._internal();
  factory AppLogger() => _instance;
  AppLogger._internal();

  final List<LogEntry> _buffer = [];
  static const int _bufferSize = 50;
  static const Duration _flushInterval = Duration(minutes: 1);

  void log(LogLevel level, String message, {Map<String, dynamic>? context}) {
    final entry = LogEntry(
      timestamp: DateTime.now(),
      level: level,
      message: message,
      context: context,
      userId: AuthService.currentUserId,
      deviceId: DeviceInfo.deviceId,
      appVersion: AppConfig.version,
    );

    _buffer.add(entry);

    // é”™è¯¯æ—¥å¿—ç«‹å³ä¸ŠæŠ¥
    if (level == LogLevel.error) {
      _flush();
    } else if (_buffer.length >= _bufferSize) {
      _flush();
    }
  }

  Future<void> _flush() async {
    if (_buffer.isEmpty) return;

    final logs = List<LogEntry>.from(_buffer);
    _buffer.clear();

    try {
      await _uploadLogs(logs);
    } catch (e) {
      // ä¸Šä¼ å¤±è´¥ï¼Œå­˜å‚¨åˆ°æœ¬åœ°
      await _saveToLocal(logs);
    }
  }

  // å´©æºƒæ—¥å¿—
  void logCrash(dynamic error, StackTrace stackTrace) {
    log(
      LogLevel.error,
      'App crashed',
      context: {
        'error': error.toString(),
        'stackTrace': stackTrace.toString(),
      },
    );
    _flush();
  }

  // ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
  void logEvent(String event, {Map<String, dynamic>? params}) {
    log(LogLevel.info, event, context: params);
  }

  // é¡µé¢è®¿é—®æ—¥å¿—
  void logPageView(String pageName, {Map<String, dynamic>? params}) {
    log(LogLevel.info, 'page_view', context: {
      'page': pageName,
      ...?params,
    });
  }

  // æ€§èƒ½æ—¥å¿—
  void logPerformance(String metric, int durationMs) {
    log(LogLevel.info, 'performance', context: {
      'metric': metric,
      'duration_ms': durationMs,
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
final logger = AppLogger();
logger.logEvent('transaction_created', params: {'amount': 35.5});
logger.logPageView('home');
logger.logPerformance('api_transactions_list', 150);
```

---

## åå…«Bã€ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ

### 18B.1 ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç›‘æ§æ•°æ®æº                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  åº”ç”¨æŒ‡æ ‡   â”‚  â”‚  ç³»ç»ŸæŒ‡æ ‡   â”‚  â”‚  ä¸šåŠ¡æŒ‡æ ‡   â”‚             â”‚
â”‚  â”‚ (Metrics)  â”‚  â”‚ (Node)     â”‚  â”‚ (Custom)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Prometheus (æŒ‡æ ‡æ”¶é›†)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  - åº”ç”¨Metricsç«¯ç‚¹ (/metrics)                               â”‚ â”‚
â”‚  â”‚  - Node Exporter (ç³»ç»ŸæŒ‡æ ‡)                                 â”‚ â”‚
â”‚  â”‚  - Redis Exporter / PostgreSQL Exporter                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Grafana      â”‚ â”‚  Alertmanager   â”‚ â”‚   PagerDuty/    â”‚
â”‚   (å¯è§†åŒ–)      â”‚ â”‚    (å‘Šè­¦)       â”‚ â”‚   é’‰é’‰/é£ä¹¦     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18B.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»

#### åº”ç”¨å±‚æŒ‡æ ‡ (RED)

```python
# app/core/metrics.py
from prometheus_client import Counter, Histogram, Gauge

# è¯·æ±‚è®¡æ•° (Request)
http_requests_total = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status_code']
)

# é”™è¯¯è®¡æ•° (Error)
http_errors_total = Counter(
    'http_errors_total',
    'Total HTTP errors',
    ['method', 'endpoint', 'error_type']
)

# å“åº”æ—¶é—´ (Duration)
http_request_duration_seconds = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint'],
    buckets=[0.01, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)

# æ´»è·ƒè¿æ¥æ•°
http_active_connections = Gauge(
    'http_active_connections',
    'Number of active HTTP connections'
)
```

#### æ•°æ®åº“æŒ‡æ ‡

```python
# æ•°æ®åº“è¿æ¥æ± 
db_pool_connections = Gauge(
    'db_pool_connections',
    'Database connection pool status',
    ['state']  # active, idle, waiting
)

# æŸ¥è¯¢æ—¶é—´
db_query_duration_seconds = Histogram(
    'db_query_duration_seconds',
    'Database query duration',
    ['operation', 'table']
)

# æ…¢æŸ¥è¯¢è®¡æ•°
db_slow_queries_total = Counter(
    'db_slow_queries_total',
    'Total slow queries (>1s)',
    ['operation', 'table']
)
```

#### ä¸šåŠ¡æŒ‡æ ‡

```python
# ç”¨æˆ·æŒ‡æ ‡
users_registered_total = Counter(
    'users_registered_total',
    'Total registered users',
    ['method']  # wechat, apple, phone
)

users_active = Gauge(
    'users_active',
    'Current active users',
    ['period']  # dau, wau, mau
)

# è®°è´¦æŒ‡æ ‡
transactions_created_total = Counter(
    'transactions_created_total',
    'Total transactions created',
    ['type', 'source']  # expense/income, manual/ocr/voice
)

# AIæŒ‡æ ‡
ai_requests_total = Counter(
    'ai_requests_total',
    'Total AI requests',
    ['type', 'status']  # ocr/voice, success/failed
)

ai_request_duration_seconds = Histogram(
    'ai_request_duration_seconds',
    'AI request duration',
    ['type']
)

# æ”¯ä»˜æŒ‡æ ‡
payment_orders_total = Counter(
    'payment_orders_total',
    'Total payment orders',
    ['product', 'method', 'status']
)

payment_revenue_total = Counter(
    'payment_revenue_total',
    'Total revenue in cents',
    ['product', 'method']
)

# ä¼šå‘˜æŒ‡æ ‡
members_active = Gauge(
    'members_active',
    'Current active members',
    ['level']  # trial, monthly, yearly, lifetime
)

trial_conversions_total = Counter(
    'trial_conversions_total',
    'Trial to paid conversions'
)
```

### 18B.3 Metricsä¸­é—´ä»¶

```python
# app/middleware/metrics.py
import time
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware

class MetricsMiddleware(BaseHTTPMiddleware):
    """PrometheusæŒ‡æ ‡æ”¶é›†ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        # å¢åŠ æ´»è·ƒè¿æ¥æ•°
        http_active_connections.inc()

        method = request.method
        endpoint = self._get_endpoint(request)
        start_time = time.time()

        try:
            response = await call_next(request)
            status_code = response.status_code

            # è®°å½•è¯·æ±‚
            http_requests_total.labels(
                method=method,
                endpoint=endpoint,
                status_code=status_code
            ).inc()

            # è®°å½•è€—æ—¶
            duration = time.time() - start_time
            http_request_duration_seconds.labels(
                method=method,
                endpoint=endpoint
            ).observe(duration)

            return response

        except Exception as e:
            # è®°å½•é”™è¯¯
            http_errors_total.labels(
                method=method,
                endpoint=endpoint,
                error_type=type(e).__name__
            ).inc()
            raise

        finally:
            http_active_connections.dec()

    def _get_endpoint(self, request: Request) -> str:
        # å½’ä¸€åŒ–è·¯å¾„ï¼Œé¿å…é«˜åŸºæ•°
        # /api/v1/transactions/123 -> /api/v1/transactions/{id}
        path = request.url.path
        # æ›¿æ¢UUIDå’Œæ•°å­—ID
        import re
        path = re.sub(r'/[0-9a-f-]{36}', '/{id}', path)
        path = re.sub(r'/\d+', '/{id}', path)
        return path
```

### 18B.4 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# prometheus/alerts.yml
groups:
  - name: api_alerts
    rules:
      # APIå¯ç”¨æ€§å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          sum(rate(http_errors_total[5m]))
          / sum(rate(http_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "APIé”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡1%"

      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "APIå“åº”æ—¶é—´è¿‡é•¿"
          description: "P95å“åº”æ—¶é—´ {{ $value | humanizeDuration }}"

      # è¯·æ±‚é‡çªå¢
      - alert: RequestSpike
        expr: |
          sum(rate(http_requests_total[5m]))
          > 2 * sum(rate(http_requests_total[1h] offset 1d))
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "è¯·æ±‚é‡å¼‚å¸¸çªå¢"

  - name: database_alerts
    rules:
      # æ•°æ®åº“è¿æ¥æ± 
      - alert: DbConnectionPoolExhausted
        expr: db_pool_connections{state="waiting"} > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ± ç­‰å¾…è¿‡å¤š"

      # æ…¢æŸ¥è¯¢
      - alert: TooManySlowQueries
        expr: rate(db_slow_queries_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "æ…¢æŸ¥è¯¢è¿‡å¤š"

  - name: business_alerts
    rules:
      # æ”¯ä»˜æˆåŠŸç‡
      - alert: LowPaymentSuccessRate
        expr: |
          sum(rate(payment_orders_total{status="success"}[1h]))
          / sum(rate(payment_orders_total[1h])) < 0.95
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "æ”¯ä»˜æˆåŠŸç‡è¿‡ä½"
          description: "æˆåŠŸç‡ {{ $value | humanizePercentage }}"

      # AIæœåŠ¡å¼‚å¸¸
      - alert: AIServiceDown
        expr: |
          sum(rate(ai_requests_total{status="failed"}[5m]))
          / sum(rate(ai_requests_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "AIæœåŠ¡å¼‚å¸¸"

      # æ–°ç”¨æˆ·æ³¨å†Œéª¤é™
      - alert: RegistrationDrop
        expr: |
          sum(increase(users_registered_total[1h]))
          < 0.5 * sum(increase(users_registered_total[1h] offset 1d))
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "æ–°ç”¨æˆ·æ³¨å†Œé‡éª¤é™"

  - name: infrastructure_alerts
    rules:
      # CPUä½¿ç”¨ç‡
      - alert: HighCpuUsage
        expr: |
          100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPUä½¿ç”¨ç‡è¿‡é«˜: {{ $value }}%"

      # å†…å­˜ä½¿ç”¨ç‡
      - alert: HighMemoryUsage
        expr: |
          (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {{ $value }}%"

      # ç£ç›˜ä½¿ç”¨ç‡
      - alert: DiskSpaceLow
        expr: |
          (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³: {{ $value }}%"
```

### 18B.5 å‘Šè­¦é€šçŸ¥é…ç½®

```yaml
# alertmanager/config.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default'
  routes:
    # ä¸¥é‡å‘Šè­¦
    - match:
        severity: critical
      receiver: 'critical-alerts'
      repeat_interval: 1h

    # ä¸€èˆ¬å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 4h

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://webhook/default'

  - name: 'critical-alerts'
    webhook_configs:
      # é’‰é’‰å‘Šè­¦
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
        send_resolved: true
      # é£ä¹¦å‘Šè­¦
      - url: 'https://open.feishu.cn/open-apis/bot/v2/hook/xxx'
        send_resolved: true
    # ç”µè¯å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
    # pagerduty_configs:
    #   - service_key: 'xxx'

  - name: 'warning-alerts'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
```

### 18B.6 Grafanaä»ªè¡¨ç›˜

```json
{
  "dashboard": {
    "title": "AI Bookkeeping - Overview",
    "panels": [
      {
        "title": "è¯·æ±‚é‡ (QPS)",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[1m]))"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_errors_total[5m])) / sum(rate(http_requests_total[5m])) * 100"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´ (P95/P99)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "æ´»è·ƒç”¨æˆ·",
        "type": "stat",
        "targets": [
          {
            "expr": "users_active{period='dau'}"
          }
        ]
      },
      {
        "title": "ä»Šæ—¥æ”¶å…¥",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(increase(payment_revenue_total[24h])) / 100"
          }
        ]
      },
      {
        "title": "AIè°ƒç”¨é‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(ai_requests_total[5m])) by (type)"
          }
        ]
      }
    ]
  }
}
```

### 18B.7 å¥åº·æ£€æŸ¥æ¥å£

```python
# app/api/v1/health.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter()

@router.get("/health")
async def health_check():
    """åŸºç¡€å¥åº·æ£€æŸ¥"""
    return {"status": "healthy"}

@router.get("/health/ready")
async def readiness_check(db: AsyncSession = Depends(get_db)):
    """å°±ç»ªæ£€æŸ¥ï¼ˆå«ä¾èµ–æœåŠ¡ï¼‰"""
    checks = {}

    # æ•°æ®åº“æ£€æŸ¥
    try:
        await db.execute(text("SELECT 1"))
        checks['database'] = 'healthy'
    except Exception as e:
        checks['database'] = f'unhealthy: {e}'

    # Redisæ£€æŸ¥
    try:
        await redis.ping()
        checks['redis'] = 'healthy'
    except Exception as e:
        checks['redis'] = f'unhealthy: {e}'

    # æ•´ä½“çŠ¶æ€
    is_healthy = all(v == 'healthy' for v in checks.values())

    return {
        'status': 'healthy' if is_healthy else 'unhealthy',
        'checks': checks,
        'timestamp': datetime.utcnow().isoformat()
    }

@router.get("/health/live")
async def liveness_check():
    """å­˜æ´»æ£€æŸ¥"""
    return {"status": "alive"}
```

---

## åå…«Cã€ä»£ç æ¶æ„è§„èŒƒ

### 18C.1 é¡¹ç›®åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¡¨ç°å±‚ (Presentation)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  API Routes / Controllers / Schemas (Request/Response)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸šåŠ¡å±‚ (Business/Service)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Services / Use Cases / Domain Logic                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚ (Data/Repository)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Repositories / DAOs / External Services                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŸºç¡€è®¾æ–½å±‚ (Infrastructure)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Database / Cache / Message Queue / External APIs           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18C.2 åç«¯ç›®å½•ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```
server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py             # å®‰å…¨è®¤è¯
â”‚   â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ redis.py                # Redisè¿æ¥
â”‚   â”‚   â”œâ”€â”€ logging.py              # æ—¥å¿—é…ç½®
â”‚   â”‚   â”œâ”€â”€ metrics.py              # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚   â””â”€â”€ exceptions.py           # å¼‚å¸¸å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                        # APIå±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py                 # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ router.py           # è·¯ç”±æ±‡æ€»
â”‚   â”‚       â”œâ”€â”€ auth.py             # è®¤è¯æ¥å£
â”‚   â”‚       â”œâ”€â”€ users.py            # ç”¨æˆ·æ¥å£
â”‚   â”‚       â”œâ”€â”€ transactions.py     # è®°è´¦æ¥å£
â”‚   â”‚       â”œâ”€â”€ books.py            # è´¦æœ¬æ¥å£
â”‚   â”‚       â”œâ”€â”€ accounts.py         # è´¦æˆ·æ¥å£
â”‚   â”‚       â”œâ”€â”€ categories.py       # åˆ†ç±»æ¥å£
â”‚   â”‚       â”œâ”€â”€ stats.py            # ç»Ÿè®¡æ¥å£
â”‚   â”‚       â”œâ”€â”€ ai.py               # AIæ¥å£
â”‚   â”‚       â”œâ”€â”€ payment.py          # æ”¯ä»˜æ¥å£
â”‚   â”‚       â”œâ”€â”€ membership.py       # ä¼šå‘˜æ¥å£
â”‚   â”‚       â””â”€â”€ health.py           # å¥åº·æ£€æŸ¥
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                     # æ•°æ®åº“æ¨¡å‹ (SQLAlchemy)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ transaction.py
â”‚   â”‚   â”œâ”€â”€ book.py
â”‚   â”‚   â”œâ”€â”€ account.py
â”‚   â”‚   â”œâ”€â”€ category.py
â”‚   â”‚   â”œâ”€â”€ membership.py
â”‚   â”‚   â””â”€â”€ campaign.py
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                    # Pydanticæ¨¡å‹ (API Schema)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€Schema
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ transaction.py
â”‚   â”‚   â”œâ”€â”€ book.py
â”‚   â”‚   â”œâ”€â”€ account.py
â”‚   â”‚   â”œâ”€â”€ stats.py
â”‚   â”‚   â””â”€â”€ payment.py
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”œâ”€â”€ stats_service.py
â”‚   â”‚   â”œâ”€â”€ ai_service.py
â”‚   â”‚   â”œâ”€â”€ payment_service.py
â”‚   â”‚   â”œâ”€â”€ membership_service.py
â”‚   â”‚   â””â”€â”€ campaign_service.py
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/               # æ•°æ®ä»“åº“å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                 # åŸºç¡€ä»“åº“
â”‚   â”‚   â”œâ”€â”€ user_repository.py
â”‚   â”‚   â”œâ”€â”€ transaction_repository.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logging.py              # è¯·æ±‚æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ metrics.py              # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚   â”œâ”€â”€ error_handler.py        # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ rate_limit.py           # é™æµ
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/                      # å¼‚æ­¥ä»»åŠ¡ (Celery)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ celery_app.py
â”‚   â”‚   â”œâ”€â”€ email_tasks.py
â”‚   â”‚   â”œâ”€â”€ ai_tasks.py
â”‚   â”‚   â”œâ”€â”€ backup_tasks.py
â”‚   â”‚   â””â”€â”€ scheduled_tasks.py
â”‚   â”‚
â”‚   â”œâ”€â”€ integrations/               # å¤–éƒ¨æœåŠ¡é›†æˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ wechat/                 # å¾®ä¿¡é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â””â”€â”€ pay.py
â”‚   â”‚   â”œâ”€â”€ alipay/                 # æ”¯ä»˜å®é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ pay.py
â”‚   â”‚   â”œâ”€â”€ apple/                  # Appleé›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â””â”€â”€ iap.py
â”‚   â”‚   â”œâ”€â”€ ai/                     # AIæœåŠ¡é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ claude.py
â”‚   â”‚   â”‚   â”œâ”€â”€ whisper.py
â”‚   â”‚   â”‚   â””â”€â”€ ocr.py
â”‚   â”‚   â””â”€â”€ sms/                    # çŸ­ä¿¡æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ aliyun_sms.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ datetime.py
â”‚       â”œâ”€â”€ currency.py
â”‚       â”œâ”€â”€ validators.py
â”‚       â””â”€â”€ helpers.py
â”‚
â”œâ”€â”€ migrations/                     # æ•°æ®åº“è¿ç§» (Alembic)
â”‚   â”œâ”€â”€ versions/
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ alembic.ini
â”‚
â”œâ”€â”€ tests/                          # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                 # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ unit/                       # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”œâ”€â”€ integration/                # é›†æˆæµ‹è¯•
â”‚   â”‚   â””â”€â”€ api/
â”‚   â””â”€â”€ e2e/                        # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚
â”œâ”€â”€ scripts/                        # è„šæœ¬
â”‚   â”œâ”€â”€ init_db.py
â”‚   â”œâ”€â”€ seed_data.py
â”‚   â””â”€â”€ migrate.py
â”‚
â”œâ”€â”€ docker/                         # Dockeré…ç½®
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ Dockerfile.dev
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â”œâ”€â”€ requirements/                   # ä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ base.txt
â”‚   â”œâ”€â”€ dev.txt
â”‚   â””â”€â”€ prod.txt
â”‚
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ pyproject.toml                  # é¡¹ç›®é…ç½®
â””â”€â”€ README.md
```

### 18C.3 å‰ç«¯ç›®å½•ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```
app/
â”œâ”€â”€ android/                        # AndroidåŸç”Ÿä»£ç 
â”œâ”€â”€ ios/                            # iOSåŸç”Ÿä»£ç 
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart                   # å…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ app/                        # åº”ç”¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ app.dart                # Appæ ¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ routes.dart             # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ di.dart                 # ä¾èµ–æ³¨å…¥
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config/                 # é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ app_config.dart
â”‚   â”‚   â”‚   â””â”€â”€ api_config.dart
â”‚   â”‚   â”œâ”€â”€ constants/              # å¸¸é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ app_constants.dart
â”‚   â”‚   â”‚   â””â”€â”€ api_constants.dart
â”‚   â”‚   â”œâ”€â”€ theme/                  # ä¸»é¢˜
â”‚   â”‚   â”‚   â”œâ”€â”€ app_theme.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ app_colors.dart
â”‚   â”‚   â”‚   â””â”€â”€ app_text_styles.dart
â”‚   â”‚   â”œâ”€â”€ utils/                  # å·¥å…·ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ date_utils.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ currency_utils.dart
â”‚   â”‚   â”‚   â””â”€â”€ validators.dart
â”‚   â”‚   â”œâ”€â”€ extensions/             # æ‰©å±•æ–¹æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ string_ext.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ datetime_ext.dart
â”‚   â”‚   â”‚   â””â”€â”€ context_ext.dart
â”‚   â”‚   â”œâ”€â”€ logging/                # æ—¥å¿—
â”‚   â”‚   â”‚   â””â”€â”€ app_logger.dart
â”‚   â”‚   â””â”€â”€ errors/                 # é”™è¯¯å¤„ç†
â”‚   â”‚       â”œâ”€â”€ exceptions.dart
â”‚   â”‚       â””â”€â”€ error_handler.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                       # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ user_model.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction_model.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ book_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ repositories/           # æ•°æ®ä»“åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ base_repository.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ auth_repository.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction_repository.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ datasources/            # æ•°æ®æº
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/             # è¿œç¨‹æ•°æ®æº
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ api_client.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ api_endpoints.dart
â”‚   â”‚   â”‚   â””â”€â”€ local/              # æœ¬åœ°æ•°æ®æº
â”‚   â”‚   â”‚       â”œâ”€â”€ database.dart
â”‚   â”‚   â”‚       â””â”€â”€ preferences.dart
â”‚   â”‚   â””â”€â”€ providers/              # çŠ¶æ€æä¾›è€…
â”‚   â”‚       â”œâ”€â”€ auth_provider.dart
â”‚   â”‚       â”œâ”€â”€ transaction_provider.dart
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                     # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ entities/               # é¢†åŸŸå®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ user.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ usecases/               # ç”¨ä¾‹
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ interfaces/             # æ¥å£å®šä¹‰
â”‚   â”‚       â””â”€â”€ repositories/
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                   # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/                   # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ register_screen.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â””â”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ home/                   # é¦–é¡µæ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ home_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”‚       â”œâ”€â”€ overview_card.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ quick_actions.dart
â”‚   â”‚   â”‚       â””â”€â”€ recent_transactions.dart
â”‚   â”‚   â”œâ”€â”€ transaction/            # è®°è´¦æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ add_transaction_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ transaction_detail_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”‚       â”œâ”€â”€ category_selector.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ amount_input.dart
â”‚   â”‚   â”‚       â””â”€â”€ account_selector.dart
â”‚   â”‚   â”œâ”€â”€ stats/                  # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”œâ”€â”€ ai/                     # AIè®°è´¦æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ camera_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ voice_input_screen.dart
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”œâ”€â”€ profile/                # ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â””â”€â”€ settings/               # è®¾ç½®æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ screens/
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                     # å…±äº«ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ widgets/                # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ buttons/
â”‚   â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”‚   â”œâ”€â”€ inputs/
â”‚   â”‚   â”‚   â”œâ”€â”€ dialogs/
â”‚   â”‚   â”‚   â””â”€â”€ loading/
â”‚   â”‚   â””â”€â”€ layouts/                # å¸ƒå±€ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ app_scaffold.dart
â”‚   â”‚       â””â”€â”€ bottom_nav.dart
â”‚   â”‚
â”‚   â””â”€â”€ l10n/                       # å›½é™…åŒ–
â”‚       â”œâ”€â”€ app_zh.arb
â”‚       â”œâ”€â”€ app_en.arb
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ assets/                         # èµ„æºæ–‡ä»¶
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ icons/
â”‚   â”œâ”€â”€ fonts/
â”‚   â””â”€â”€ animations/
â”‚
â”œâ”€â”€ test/                           # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ widget/
â”‚   â””â”€â”€ integration/
â”‚
â”œâ”€â”€ pubspec.yaml                    # ä¾èµ–é…ç½®
â”œâ”€â”€ analysis_options.yaml           # ä»£ç åˆ†æé…ç½®
â””â”€â”€ README.md
```

### 18C.4 ç¼–ç è§„èŒƒ

#### Pythonåç«¯è§„èŒƒ

```python
# 1. å‘½åè§„èŒƒ
class UserService:          # ç±»åï¼šPascalCase
    def get_user_by_id():   # æ–¹æ³•åï¼šsnake_case
        user_name = ""      # å˜é‡åï¼šsnake_case
        MAX_RETRY = 3       # å¸¸é‡ï¼šUPPER_SNAKE_CASE

# 2. ç±»å‹æ³¨è§£
from typing import Optional, List
from pydantic import BaseModel

class UserCreate(BaseModel):
    email: str
    nickname: Optional[str] = None

async def get_users(skip: int = 0, limit: int = 100) -> List[User]:
    pass

# 3. æ–‡æ¡£å­—ç¬¦ä¸²
def create_transaction(
    user_id: str,
    amount: Decimal,
    category_id: str,
) -> Transaction:
    """
    åˆ›å»ºäº¤æ˜“è®°å½•

    Args:
        user_id: ç”¨æˆ·ID
        amount: äº¤æ˜“é‡‘é¢
        category_id: åˆ†ç±»ID

    Returns:
        åˆ›å»ºçš„äº¤æ˜“è®°å½•

    Raises:
        ValidationError: å‚æ•°éªŒè¯å¤±è´¥
        InsufficientBalanceError: ä½™é¢ä¸è¶³
    """
    pass

# 4. å¼‚å¸¸å¤„ç†
class AppException(Exception):
    """åº”ç”¨å¼‚å¸¸åŸºç±»"""
    def __init__(self, code: str, message: str, status_code: int = 400):
        self.code = code
        self.message = message
        self.status_code = status_code

class NotFoundError(AppException):
    def __init__(self, resource: str, id: str):
        super().__init__(
            code="NOT_FOUND",
            message=f"{resource} with id {id} not found",
            status_code=404
        )

# 5. ä¾èµ–æ³¨å…¥
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session() as session:
        yield session

@router.get("/users/{user_id}")
async def get_user(
    user_id: str,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    pass
```

#### Flutterå‰ç«¯è§„èŒƒ

```dart
// 1. å‘½åè§„èŒƒ
class TransactionService {}  // ç±»åï¼šPascalCase
void getUserById() {}        // æ–¹æ³•åï¼šcamelCase
final userName = '';         // å˜é‡åï¼šcamelCase
const maxRetry = 3;          // å¸¸é‡ï¼šcamelCase
final _privateVar = '';      // ç§æœ‰å˜é‡ï¼š_camelCase

// 2. æ–‡ä»¶å‘½å
// user_service.dart         // æ–‡ä»¶åï¼šsnake_case
// transaction_model.dart

// 3. Widgetè§„èŒƒ
class TransactionCard extends StatelessWidget {
  const TransactionCard({
    super.key,
    required this.transaction,
    this.onTap,
  });

  final Transaction transaction;
  final VoidCallback? onTap;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        title: Text(transaction.category),
        subtitle: Text(transaction.note ?? ''),
        trailing: Text(
          transaction.formattedAmount,
          style: TextStyle(
            color: transaction.isExpense ? Colors.red : Colors.green,
          ),
        ),
        onTap: onTap,
      ),
    );
  }
}

// 4. çŠ¶æ€ç®¡ç† (Riverpod)
final transactionListProvider = FutureProvider.family<List<Transaction>, TransactionFilter>(
  (ref, filter) async {
    final repository = ref.watch(transactionRepositoryProvider);
    return repository.getTransactions(filter);
  },
);

// 5. é”™è¯¯å¤„ç†
class AppException implements Exception {
  final String code;
  final String message;

  const AppException(this.code, this.message);
}

class NetworkException extends AppException {
  const NetworkException([String? message])
    : super('NETWORK_ERROR', message ?? 'Network error occurred');
}

// 6. æ‰©å±•æ–¹æ³•
extension DateTimeExt on DateTime {
  String get formatted => DateFormat('yyyy-MM-dd').format(this);
  bool get isToday => DateUtils.isSameDay(this, DateTime.now());
}
```

### 18C.5 Gitå·¥ä½œæµè§„èŒƒ

```bash
# åˆ†æ”¯å‘½å
main                    # ä¸»åˆ†æ”¯ï¼Œç”Ÿäº§ç¯å¢ƒ
develop                 # å¼€å‘åˆ†æ”¯
feature/xxx             # åŠŸèƒ½åˆ†æ”¯
bugfix/xxx              # ä¿®å¤åˆ†æ”¯
hotfix/xxx              # ç´§æ€¥ä¿®å¤åˆ†æ”¯
release/v1.0.0          # å‘å¸ƒåˆ†æ”¯

# Commit Messageè§„èŒƒ (Conventional Commits)
feat: æ·»åŠ ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
fix: ä¿®å¤ç™»å½•éªŒè¯ç å‘é€å¤±è´¥é—®é¢˜
docs: æ›´æ–°APIæ–‡æ¡£
style: æ ¼å¼åŒ–ä»£ç 
refactor: é‡æ„äº¤æ˜“æœåŠ¡
test: æ·»åŠ å•å…ƒæµ‹è¯•
chore: æ›´æ–°ä¾èµ–ç‰ˆæœ¬

# ç¤ºä¾‹
feat(auth): add WeChat login support
fix(payment): handle alipay callback timeout
docs(api): update transaction endpoint docs
refactor(service): extract common logic to base service
```

### 18C.6 APIè®¾è®¡è§„èŒƒ

```yaml
# RESTful APIè§„èŒƒ

# 1. URLè®¾è®¡
GET    /api/v1/transactions          # åˆ—è¡¨
POST   /api/v1/transactions          # åˆ›å»º
GET    /api/v1/transactions/{id}     # è¯¦æƒ…
PUT    /api/v1/transactions/{id}     # å…¨é‡æ›´æ–°
PATCH  /api/v1/transactions/{id}     # éƒ¨åˆ†æ›´æ–°
DELETE /api/v1/transactions/{id}     # åˆ é™¤

# 2. æŸ¥è¯¢å‚æ•°
GET /api/v1/transactions?page=1&page_size=20&sort=-created_at&type=expense

# 3. ç»Ÿä¸€å“åº”æ ¼å¼
# æˆåŠŸå“åº”
{
  "code": 0,
  "message": "success",
  "data": { ... },
  "meta": {
    "page": 1,
    "page_size": 20,
    "total": 100
  }
}

# é”™è¯¯å“åº”
{
  "code": "VALIDATION_ERROR",
  "message": "Validation failed",
  "errors": [
    {
      "field": "amount",
      "message": "Amount must be positive"
    }
  ]
}

# 4. HTTPçŠ¶æ€ç 
200 OK              # æˆåŠŸ
201 Created         # åˆ›å»ºæˆåŠŸ
204 No Content      # åˆ é™¤æˆåŠŸ
400 Bad Request     # è¯·æ±‚å‚æ•°é”™è¯¯
401 Unauthorized    # æœªè®¤è¯
403 Forbidden       # æ— æƒé™
404 Not Found       # èµ„æºä¸å­˜åœ¨
422 Unprocessable   # ä¸šåŠ¡é€»è¾‘é”™è¯¯
429 Too Many Requests # é™æµ
500 Internal Error  # æœåŠ¡å™¨é”™è¯¯

# 5. ç‰ˆæœ¬æ§åˆ¶
/api/v1/...         # URLç‰ˆæœ¬
Accept: application/vnd.api+json;version=1  # Headerç‰ˆæœ¬
```

### 18C.7 æµ‹è¯•è§„èŒƒ

```python
# tests/unit/services/test_transaction_service.py

import pytest
from decimal import Decimal
from unittest.mock import Mock, AsyncMock

class TestTransactionService:
    """äº¤æ˜“æœåŠ¡å•å…ƒæµ‹è¯•"""

    @pytest.fixture
    def service(self, mock_repository):
        return TransactionService(repository=mock_repository)

    @pytest.fixture
    def mock_repository(self):
        return Mock(spec=TransactionRepository)

    async def test_create_transaction_success(self, service):
        """æµ‹è¯•åˆ›å»ºäº¤æ˜“æˆåŠŸ"""
        # Arrange
        data = TransactionCreate(
            amount=Decimal("35.50"),
            type=TransactionType.EXPENSE,
            category_id="cat_123",
        )

        # Act
        result = await service.create_transaction("user_123", data)

        # Assert
        assert result.amount == Decimal("35.50")
        assert result.type == TransactionType.EXPENSE

    async def test_create_transaction_invalid_amount(self, service):
        """æµ‹è¯•åˆ›å»ºäº¤æ˜“-é‡‘é¢æ— æ•ˆ"""
        data = TransactionCreate(
            amount=Decimal("-10"),
            type=TransactionType.EXPENSE,
            category_id="cat_123",
        )

        with pytest.raises(ValidationError) as exc:
            await service.create_transaction("user_123", data)

        assert exc.value.code == "INVALID_AMOUNT"

# æµ‹è¯•è¦†ç›–ç‡è¦æ±‚
# - å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
# - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ > 90%
# - é›†æˆæµ‹è¯•è¦†ç›–ä¸»è¦APIæ¥å£
```

### 18C.8 ä»£ç å®¡æŸ¥æ¸…å•

```markdown
## Code Review Checklist

### åŠŸèƒ½æ€§
- [ ] ä»£ç å®ç°äº†éœ€æ±‚æè¿°çš„åŠŸèƒ½
- [ ] è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µå·²å¤„ç†
- [ ] æ²¡æœ‰å¼•å…¥å®‰å…¨æ¼æ´

### ä»£ç è´¨é‡
- [ ] å‘½åæ¸…æ™°ã€æœ‰æ„ä¹‰
- [ ] å‡½æ•°/æ–¹æ³•èŒè´£å•ä¸€
- [ ] æ²¡æœ‰é‡å¤ä»£ç 
- [ ] å¤æ‚é€»è¾‘æœ‰æ³¨é‡Šè¯´æ˜

### æ€§èƒ½
- [ ] æ²¡æœ‰N+1æŸ¥è¯¢é—®é¢˜
- [ ] å¤§æ•°æ®é‡æœ‰åˆ†é¡µå¤„ç†
- [ ] é€‚å½“ä½¿ç”¨ç¼“å­˜

### å¯ç»´æŠ¤æ€§
- [ ] æœ‰é€‚å½“çš„å•å…ƒæµ‹è¯•
- [ ] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
- [ ] é…ç½®é¡¹ä½¿ç”¨ç¯å¢ƒå˜é‡

### æ—¥å¿—ä¸ç›‘æ§
- [ ] å…³é”®ä¸šåŠ¡æœ‰æ—¥å¿—è®°å½•
- [ ] é”™è¯¯æ—¥å¿—åŒ…å«å¿…è¦ä¸Šä¸‹æ–‡
- [ ] æ·»åŠ äº†å¿…è¦çš„ç›‘æ§æŒ‡æ ‡
```

---

## åä¹ã€å¼€å‘è®¡åˆ’ï¼ˆæ›´æ–°ç‰ˆï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ (MVP)
- [ ] ç”¨æˆ·è®¤è¯ï¼ˆæ‰‹æœºå·+ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
- [ ] æ‰‹åŠ¨è®°è´¦ï¼ˆæ”¯å‡º/æ”¶å…¥/è½¬è´¦ï¼‰
- [ ] åŸºç¡€åˆ†ç±»ç®¡ç†
- [ ] è´¦ç›®åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] ç®€å•ç»Ÿè®¡ï¼ˆæœ¬æœˆæ”¶æ”¯ï¼‰
- [ ] å¤šè¯­è¨€åŸºç¡€æ¡†æ¶
- [ ] ç¦»çº¿æ¨¡å¼åŸºç¡€æ”¯æŒ

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å¤šè´¦æœ¬æ”¯æŒ
- [ ] è´¦æˆ·ç®¡ç†
- [ ] å®Œæ•´ç»Ÿè®¡æŠ¥è¡¨
- [ ] é¢„ç®—åŠŸèƒ½
- [ ] å¤šè´§å¸æ”¯æŒ
- [ ] æ•°æ®å¯¼å‡º
- [ ] æ•°æ®å¤‡ä»½

### ç¬¬ä¸‰é˜¶æ®µï¼šAIåŠŸèƒ½
- [ ] å›¾ç‰‡è¯†åˆ«è®°è´¦
- [ ] è¯­éŸ³è®°è´¦
- [ ] é‚®ç®±è´¦å•è§£æ
- [ ] æ™ºèƒ½åˆ†ç±»å»ºè®®

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½
- [ ] å¤šæˆå‘˜åä½œ
- [ ] å®šæ—¶è®°è´¦
- [ ] æ¡Œé¢å°ç»„ä»¶
- [ ] ä¼šå‘˜ç³»ç»Ÿ
- [ ] æ”¯ä»˜é›†æˆ

### ç¬¬äº”é˜¶æ®µï¼šä¼˜åŒ–è¿­ä»£
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ›´å¤šè¯­è¨€æ”¯æŒ
- [ ] æ›´å¤šè´§å¸æ”¯æŒ
- [ ] é«˜çº§æŠ¥è¡¨åŠŸèƒ½

---

ä»¥ä¸Šæ˜¯AIæ™ºèƒ½è®°è´¦åº”ç”¨çš„å®Œæ•´æ¶æ„è®¾è®¡ï¼ŒåŒ…å«äº†æ‰€æœ‰ç¡®è®¤çš„åŠŸèƒ½éœ€æ±‚ã€‚å¦‚æœ‰éœ€è¦è°ƒæ•´çš„åœ°æ–¹è¯·æå‡ºã€‚
