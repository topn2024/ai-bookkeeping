# AIæ™ºèƒ½è®°è´¦ 2.0 ç‰ˆæœ¬è®¾è®¡æ–¹æ¡ˆ

> ç‰ˆæœ¬ï¼š2.0.0
> æ—¥æœŸï¼š2026-01-01
> çŠ¶æ€ï¼šè®¾è®¡é˜¶æ®µ

## ç›®å½•

1. [è®¾è®¡æ¦‚è¿°](#1-è®¾è®¡æ¦‚è¿°)
   - [1.4 æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶](#14-æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶)
2. [äº§å“å®šä½ä¸æ„¿æ™¯](#2-äº§å“å®šä½ä¸æ„¿æ™¯)
3. [æ ¸å¿ƒåŠŸèƒ½æ¶æ„](#3-æ ¸å¿ƒåŠŸèƒ½æ¶æ„)
4. [é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ](#4-é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ)
5. [é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ](#5-é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ)
6. [é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ](#6-é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ)
7. [AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ](#7-aiæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ)
8. [æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ](#8-æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ)
9. [æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–](#9-æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–)
10. [æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ](#10-æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ)
11. [åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨](#11-åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨)
12. [æŠ€æœ¯æ¶æ„è®¾è®¡](#12-æŠ€æœ¯æ¶æ„è®¾è®¡)
13. [ç”¨æˆ·ä½“éªŒè®¾è®¡](#13-ç”¨æˆ·ä½“éªŒè®¾è®¡)
14. [å›½é™…åŒ–ä¸æœ¬åœ°åŒ–](#14-å›½é™…åŒ–ä¸æœ¬åœ°åŒ–)
15. [å®‰å…¨ä¸éšç§](#15-å®‰å…¨ä¸éšç§)
16. [ç‰ˆæœ¬è¿ç§»ç­–ç•¥](#16-ç‰ˆæœ¬è¿ç§»ç­–ç•¥)
17. [å®æ–½è·¯çº¿å›¾](#17-å®æ–½è·¯çº¿å›¾)
18. [æµ‹è¯•ç­–ç•¥](#18-æµ‹è¯•ç­–ç•¥)
19. [å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡](#19-å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡)
20. [å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„](#20-å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„)
21. [å¯è§‚æµ‹æ€§ä¸ç›‘æ§](#21-å¯è§‚æµ‹æ€§ä¸ç›‘æ§)
22. [æ— éšœç¢è®¾è®¡](#22-æ— éšœç¢è®¾è®¡)
23. [æ‡’äººè®¾è®¡åŸåˆ™](#23-æ‡’äººè®¾è®¡åŸåˆ™)
24. [ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™](#24-ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™)

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

AIæ™ºèƒ½è®°è´¦ 1.x ç‰ˆæœ¬å·²ç»å®ç°äº†åŸºç¡€çš„è®°è´¦åŠŸèƒ½ã€AIè¯†åˆ«ã€å¤šè´¦æˆ·ç®¡ç†ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚2.0 ç‰ˆæœ¬å°†åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œå…¨é¢å‡çº§ï¼Œå¼•å…¥ä»¥ä¸‹æ ¸å¿ƒåˆ›æ–°ï¼š

- **é’±é¾„åˆ†æç³»ç»Ÿ**ï¼šè®©ç”¨æˆ·äº†è§£èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…ä¹‹å‰èµšçš„
- **é›¶åŸºé¢„ç®—ç³»ç»Ÿ**ï¼šè®©æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„
- **å°é‡‘åº“ç³»ç»Ÿ**ï¼šæ›´ç¬¦åˆä¸­å›½ç”¨æˆ·ä¹ æƒ¯çš„èµ„é‡‘è§„åˆ’æ–¹å¼
- **æ™ºèƒ½æ•°æ®è”åŠ¨**ï¼šå…¨åº”ç”¨èŒƒå›´çš„æ•°æ®ä¸‹é’»ä¸äº¤äº’
- **å¢å¼ºå‹AIèƒ½åŠ›**ï¼šæ›´æ™ºèƒ½çš„è¯­éŸ³ã€å›¾åƒã€è¯­ä¹‰è¯†åˆ«

### 1.2 è®¾è®¡åŸåˆ™

| åŸåˆ™ | æè¿° |
|------|------|
| **æ•°æ®é©±åŠ¨** | ç”¨æ•°æ®å¸®åŠ©ç”¨æˆ·åšå‡ºæ›´å¥½çš„è´¢åŠ¡å†³ç­– |
| **æ™ºèƒ½ä¼˜å…ˆ** | å°½å¯èƒ½çš„ä½¿ç”¨æ™ºèƒ½åŒ–ã€è‡ªåŠ¨åŒ–çš„æ–¹å¼å®ç° |
| **ä¹ æƒ¯åŸ¹å…»** | é€šè¿‡å¥½çš„äº§å“è®¾è®¡åŸ¹å…»ç”¨æˆ·è‰¯å¥½çš„é‡‘èä¹ æƒ¯ |
| **æ‡’äººè®¾è®¡** | ä¸º"æ‡’äºº"è€Œç”Ÿï¼Œæœ€å°‘æ“ä½œã€æœ€å¤§ä»·å€¼ï¼ˆè¯¦è§ç¬¬23ç« ï¼‰ |
| **ä¼™ä¼´åŸåˆ™** | APPæ˜¯ç†è´¢ä¼™ä¼´è€Œéå†·å†°å†°çš„å·¥å…·ï¼Œäº¤äº’ä¸­ä½“ç°äººæ€§æ¸©åº¦ï¼ˆè¯¦è§ç¬¬24ç« ï¼‰ |

### 1.3 ç‰ˆæœ¬ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2.0 ç‰ˆæœ¬æ ¸å¿ƒç›®æ ‡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. é’±é¾„åˆ†æ - è®©ç”¨æˆ·ç†è§£"èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™èµšçš„é’±"              â”‚
â”‚  2. é›¶åŸºé¢„ç®— - è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”                        â”‚
â”‚  3. æ™ºèƒ½æ´å¯Ÿ - AIé©±åŠ¨çš„è´¢åŠ¡å¥åº·åˆ†æ                          â”‚
â”‚  4. æ•°æ®è”åŠ¨ - ä»»æ„å›¾è¡¨å¯ç‚¹å‡»ä¸‹é’»æŸ¥çœ‹è¯¦æƒ…                    â”‚
â”‚  5. ä½“éªŒå‡çº§ - æ›´æµç•…çš„äº¤äº’ã€æ›´ç¾è§‚çš„ç•Œé¢                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶

æ¯ä¸ªæ ¸å¿ƒç›®æ ‡éœ€è¦æ˜ç¡®çš„é‡åŒ–æ ‡å‡†å’Œæ£€æµ‹æ–¹æ³•ï¼Œç¡®ä¿ç›®æ ‡å¯è¡¡é‡ã€å¯è¿½è¸ªã€‚

#### 1.4.1 ç›®æ ‡è¾¾æˆè¯„ä¼°æ¡†æ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒç›®æ ‡è¾¾æˆè¯„ä¼°ä½“ç³»                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  åŠŸèƒ½å®Œæ•´åº¦  â”‚    â”‚  ç”¨æˆ·é‡‡ç”¨ç‡  â”‚    â”‚  ä½¿ç”¨æ•ˆæœ   â”‚    â”‚  ç”¨æˆ·æ»¡æ„åº¦  â”‚ â”‚
â”‚  â”‚  Feature    â”‚â”€â”€â”€â†’â”‚  Adoption   â”‚â”€â”€â”€â†’â”‚  Outcome    â”‚â”€â”€â”€â†’â”‚ Satisfactionâ”‚ â”‚
â”‚  â”‚  Completion â”‚    â”‚    Rate     â”‚    â”‚   Impact    â”‚    â”‚    Score    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†“                  â†“                  â†“                  â†“          â”‚
â”‚   åŠŸèƒ½æ˜¯å¦å®Œæ•´       ç”¨æˆ·æ˜¯å¦ä½¿ç”¨       ä½¿ç”¨åæ•ˆæœå¦‚ä½•      ç”¨æˆ·è¯„ä»·å¦‚ä½•    â”‚
â”‚   å®ç°å¹¶ä¸Šçº¿         å¹¶æŒç»­ä½¿ç”¨         æ˜¯å¦è¾¾åˆ°é¢„æœŸ        æ˜¯å¦æ»¡æ„æ¨è    â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.2 å„æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†

```dart
/// æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†å®šä¹‰
class CoreGoalAchievementCriteria {

  /// ç›®æ ‡1ï¼šé’±é¾„åˆ†æ
  static const moneyAgeGoal = GoalCriteria(
    name: 'é’±é¾„åˆ†æ',
    description: 'è®©ç”¨æˆ·ç†è§£"èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™èµšçš„é’±"',

    // åŠŸèƒ½å®Œæ•´åº¦æ ‡å‡† (å¿…é¡»100%è¾¾æˆæ‰ç®—åŠŸèƒ½å®Œæˆ)
    featureCompleteness: [
      'é’±é¾„è®¡ç®—ç®—æ³•å®ç°å¹¶å‡†ç¡®',
      'é’±é¾„å¯è§†åŒ–å±•ç¤ºï¼ˆä»ªè¡¨ç›˜å¡ç‰‡ï¼‰',
      'é’±é¾„å†å²è¶‹åŠ¿å›¾è¡¨',
      'é’±é¾„ç­‰çº§åˆ’åˆ†å’Œè¯´æ˜',
      'é’±é¾„æ”¹å–„å»ºè®®ç”Ÿæˆ',
    ],

    // ç”¨æˆ·é‡‡ç”¨ç‡æ ‡å‡†
    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.80,      // 80%ç”¨æˆ·çŸ¥é“æ­¤åŠŸèƒ½å­˜åœ¨
      trialRate: 0.60,          // 60%ç”¨æˆ·è‡³å°‘æŸ¥çœ‹è¿‡ä¸€æ¬¡
      regularUseRate: 0.30,     // 30%ç”¨æˆ·æ¯å‘¨æŸ¥çœ‹
      targetTimeframe: Duration(days: 90),  // ä¸Šçº¿90å¤©å†…è¾¾æˆ
    ),

    // ä½¿ç”¨æ•ˆæœæ ‡å‡†
    outcomeMetrics: [
      OutcomeMetric(
        name: 'ç†è§£åº¦',
        measurement: 'ç”¨æˆ·èƒ½æ­£ç¡®è§£é‡Šé’±é¾„å«ä¹‰çš„æ¯”ä¾‹',
        target: 0.70,  // 70%ç”¨æˆ·ç†è§£
        method: 'åº”ç”¨å†…é—®å·è°ƒæŸ¥',
      ),
      OutcomeMetric(
        name: 'è¡Œä¸ºæ”¹å˜',
        measurement: 'æŸ¥çœ‹é’±é¾„åè°ƒæ•´æ¶ˆè´¹è¡Œä¸ºçš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.25,  // 25%ç”¨æˆ·æœ‰è¡Œä¸ºæ”¹å˜
        method: 'æ¶ˆè´¹æ¨¡å¼å‰åå¯¹æ¯”åˆ†æ',
      ),
      OutcomeMetric(
        name: 'é’±é¾„æå‡',
        measurement: 'ä½¿ç”¨3ä¸ªæœˆåé’±é¾„æå‡çš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.40,  // 40%ç”¨æˆ·é’±é¾„æå‡
        method: 'é’±é¾„å†å²æ•°æ®å¯¹æ¯”',
      ),
    ],

    // ç”¨æˆ·æ»¡æ„åº¦æ ‡å‡†
    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.0,     // åŠŸèƒ½æ»¡æ„åº¦â‰¥4.0/5.0
      featureNps: 30,     // åŠŸèƒ½NPSâ‰¥30
    ),
  );

  /// ç›®æ ‡2ï¼šé›¶åŸºé¢„ç®—
  static const zeroBudgetGoal = GoalCriteria(
    name: 'é›¶åŸºé¢„ç®—',
    description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”',

    featureCompleteness: [
      'é›¶åŸºé¢„ç®—åˆ›å»ºå’Œç¼–è¾‘åŠŸèƒ½',
      'æ”¶å…¥åˆ†é…å‘å¯¼',
      'é¢„ç®—åˆ†ç±»å’Œé‡‘é¢è®¾ç½®',
      'é¢„ç®—æ‰§è¡Œè¿›åº¦è¿½è¸ª',
      'é¢„ç®—ç»“è½¬åŠŸèƒ½',
      'é¢„ç®—é¢„è­¦é€šçŸ¥',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.75,      // 75%ç”¨æˆ·çŸ¥é“é›¶åŸºé¢„ç®—
      trialRate: 0.40,          // 40%ç”¨æˆ·åˆ›å»ºè¿‡é¢„ç®—
      regularUseRate: 0.20,     // 20%ç”¨æˆ·æŒç»­ä½¿ç”¨é¢„ç®—åŠŸèƒ½
      targetTimeframe: Duration(days: 90),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'é¢„ç®—è¦†ç›–ç‡',
        measurement: 'ç”¨æˆ·æ”¶å…¥è¢«é¢„ç®—è¦†ç›–çš„å¹³å‡æ¯”ä¾‹',
        target: 0.80,  // å¹³å‡80%æ”¶å…¥æœ‰é¢„ç®—å®‰æ’
        method: 'é¢„ç®—æ€»é¢/æœˆæ”¶å…¥',
      ),
      OutcomeMetric(
        name: 'é¢„ç®—è¾¾æˆç‡',
        measurement: 'ç”¨æˆ·æ¯æœˆé¢„ç®—è¾¾æˆçš„æ¯”ä¾‹',
        target: 0.70,  // 70%é¢„ç®—ç±»åˆ«è¾¾æˆ
        method: 'å®é™…æ”¯å‡ºâ‰¤é¢„ç®—é¢çš„ç±»åˆ«å æ¯”',
      ),
      OutcomeMetric(
        name: 'è´¢åŠ¡æ”¹å–„',
        measurement: 'ä½¿ç”¨é¢„ç®—åå‚¨è“„ç‡æå‡çš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.35,  // 35%ç”¨æˆ·å‚¨è“„ç‡æå‡
        method: 'å‚¨è“„é‡‘é¢/æ”¶å…¥ å¯¹æ¯”',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.2,
      featureNps: 35,
    ),
  );

  /// ç›®æ ‡3ï¼šæ™ºèƒ½æ´å¯Ÿ
  static const aiInsightGoal = GoalCriteria(
    name: 'æ™ºèƒ½æ´å¯Ÿ',
    description: 'AIé©±åŠ¨çš„è´¢åŠ¡å¥åº·åˆ†æ',

    featureCompleteness: [
      'AIæ¶ˆè´¹æ¨¡å¼è¯†åˆ«',
      'å¼‚å¸¸æ¶ˆè´¹æ£€æµ‹å’Œæé†’',
      'æ™ºèƒ½è´¢åŠ¡å»ºè®®ç”Ÿæˆ',
      'æ”¯å‡ºé¢„æµ‹åŠŸèƒ½',
      'æ”¶æ”¯è¶‹åŠ¿æ™ºèƒ½åˆ†æ',
      'ä¸ªæ€§åŒ–è´¢åŠ¡æŠ¥å‘Š',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.70,
      trialRate: 0.50,          // 50%ç”¨æˆ·æŸ¥çœ‹è¿‡AIæ´å¯Ÿ
      regularUseRate: 0.25,     // 25%ç”¨æˆ·å®šæœŸæŸ¥çœ‹
      targetTimeframe: Duration(days: 90),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ´å¯Ÿå‡†ç¡®åº¦',
        measurement: 'ç”¨æˆ·è®¤ä¸ºæ´å¯Ÿå‡†ç¡®/æœ‰ç”¨çš„æ¯”ä¾‹',
        target: 0.75,  // 75%è®¤ä¸ºå‡†ç¡®
        method: 'æ´å¯Ÿå¡ç‰‡åé¦ˆç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'å»ºè®®é‡‡çº³ç‡',
        measurement: 'ç”¨æˆ·é‡‡çº³AIå»ºè®®çš„æ¯”ä¾‹',
        target: 0.30,  // 30%å»ºè®®è¢«é‡‡çº³
        method: 'å»ºè®®ç‚¹å‡»"å·²é‡‡çº³"çš„æ¯”ä¾‹',
      ),
      OutcomeMetric(
        name: 'é¢„æµ‹å‡†ç¡®åº¦',
        measurement: 'AIé¢„æµ‹ä¸å®é™…çš„åå·®',
        target: 0.15,  // é¢„æµ‹åå·®â‰¤15%
        method: '|é¢„æµ‹å€¼-å®é™…å€¼|/å®é™…å€¼',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.0,
      featureNps: 25,
    ),
  );

  /// ç›®æ ‡4ï¼šæ•°æ®è”åŠ¨
  static const dataLinkageGoal = GoalCriteria(
    name: 'æ•°æ®è”åŠ¨',
    description: 'ä»»æ„å›¾è¡¨å¯ç‚¹å‡»ä¸‹é’»æŸ¥çœ‹è¯¦æƒ…',

    featureCompleteness: [
      'å›¾è¡¨ç‚¹å‡»å“åº”å’Œä¸‹é’»å¯¼èˆª',
      'ç»Ÿè®¡é¡µé¢å…³è”äº¤æ˜“åˆ—è¡¨',
      'åˆ†ç±»ç‚¹å‡»å±•å¼€äº¤æ˜“æ˜ç»†',
      'æ—¶é—´æ®µé€‰æ‹©è”åŠ¨åˆ·æ–°',
      'è·¨é¡µé¢æ•°æ®ç­›é€‰ä¿æŒ',
      'å¿«é€Ÿè¿”å›å’Œé¢åŒ…å±‘å¯¼èˆª',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.60,      // 60%ç”¨æˆ·çŸ¥é“å¯ç‚¹å‡»ä¸‹é’»
      trialRate: 0.70,          // 70%ç”¨æˆ·ä½¿ç”¨è¿‡ä¸‹é’»
      regularUseRate: 0.40,     // 40%ç”¨æˆ·ç»å¸¸ä½¿ç”¨
      targetTimeframe: Duration(days: 60),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ•°æ®æ¢ç´¢æ·±åº¦',
        measurement: 'å¹³å‡ä¸‹é’»å±‚çº§æ•°',
        target: 2.0,  // å¹³å‡ä¸‹é’»2å±‚
        method: 'ä¸‹é’»ç‚¹å‡»äº‹ä»¶ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'é—®é¢˜è§£å†³ç‡',
        measurement: 'é€šè¿‡ä¸‹é’»æ‰¾åˆ°ç›®æ ‡ä¿¡æ¯çš„æ¯”ä¾‹',
        target: 0.85,  // 85%èƒ½æ‰¾åˆ°ç›®æ ‡
        method: 'ä¸‹é’»åæ— è¿”å›è·³å‡ºçš„æ¯”ä¾‹',
      ),
      OutcomeMetric(
        name: 'æ•ˆç‡æå‡',
        measurement: 'æŸ¥æ‰¾ç‰¹å®šäº¤æ˜“çš„å¹³å‡æ—¶é—´å‡å°‘',
        target: 0.50,  // æ—¶é—´å‡å°‘50%
        method: 'ä¸1.0ç‰ˆæœ¬å¯¹æ¯”',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.3,
      featureNps: 40,
    ),
  );

  /// ç›®æ ‡5ï¼šä½“éªŒå‡çº§
  static const experienceUpgradeGoal = GoalCriteria(
    name: 'ä½“éªŒå‡çº§',
    description: 'æ›´æµç•…çš„äº¤äº’ã€æ›´ç¾è§‚çš„ç•Œé¢',

    featureCompleteness: [
      'å…¨æ–°UIè®¾è®¡ç³»ç»Ÿå®æ–½',
      'æµç•…åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ',
      'æ·±è‰²æ¨¡å¼æ”¯æŒ',
      'å“åº”å¼å¸ƒå±€é€‚é…',
      'æ‰‹åŠ¿æ“ä½œä¼˜åŒ–',
      'åŠ è½½çŠ¶æ€å’Œéª¨æ¶å±',
    ],

    adoptionCriteria: AdoptionMetrics(
      // ä½“éªŒå‡çº§æ˜¯å…¨å±€çš„ï¼Œé‡‡ç”¨ç‡é€šè¿‡å¯¹æ¯”æŒ‡æ ‡è¡¡é‡
      awarenessRate: 0.90,      // 90%ç”¨æˆ·æ„ŸçŸ¥åˆ°å˜åŒ–
      trialRate: 1.0,           // 100%è‡ªåŠ¨åº”ç”¨
      regularUseRate: 1.0,
      targetTimeframe: Duration(days: 30),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ€§èƒ½æå‡',
        measurement: 'é¡µé¢åŠ è½½æ—¶é—´',
        target: 0.5,  // åŠ è½½æ—¶é—´â‰¤500ms
        method: 'æ€§èƒ½ç›‘æ§æ•°æ®',
      ),
      OutcomeMetric(
        name: 'æµç•…åº¦',
        measurement: 'å¹³å‡å¸§ç‡',
        target: 55,  // å¸§ç‡â‰¥55fps
        method: 'å¸§ç‡ç›‘æ§ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'å´©æºƒç‡',
        measurement: 'åº”ç”¨å´©æºƒç‡',
        target: 0.001,  // å´©æºƒç‡â‰¤0.1%
        method: 'å´©æºƒæ—¥å¿—ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'ç¾è§‚è¯„åˆ†',
        measurement: 'ç”¨æˆ·å¯¹ç•Œé¢ç¾è§‚åº¦çš„è¯„åˆ†',
        target: 4.2,  // è¯„åˆ†â‰¥4.2/5.0
        method: 'ç”¨æˆ·é—®å·è°ƒæŸ¥',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.5,
      featureNps: 45,
    ),
  );
}
```

#### 1.4.3 ç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡

```dart
/// æ ¸å¿ƒç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡
class GoalAchievementDetectionService {
  final AnalyticsService _analytics;
  final UserFeedbackService _feedback;
  final PerformanceMonitor _performance;

  /// æ£€æµ‹å•ä¸ªç›®æ ‡çš„è¾¾æˆçŠ¶æ€
  Future<GoalAchievementStatus> checkGoalStatus(GoalCriteria goal) async {
    final featureStatus = await _checkFeatureCompleteness(goal);
    final adoptionStatus = await _checkAdoptionMetrics(goal);
    final outcomeStatus = await _checkOutcomeMetrics(goal);
    final satisfactionStatus = await _checkSatisfactionMetrics(goal);

    return GoalAchievementStatus(
      goalName: goal.name,
      overallScore: _calculateOverallScore(
        featureStatus, adoptionStatus, outcomeStatus, satisfactionStatus
      ),
      featureCompleteness: featureStatus,
      adoptionMetrics: adoptionStatus,
      outcomeMetrics: outcomeStatus,
      satisfactionMetrics: satisfactionStatus,
      achievementLevel: _determineAchievementLevel(
        featureStatus, adoptionStatus, outcomeStatus, satisfactionStatus
      ),
    );
  }

  /// æ£€æµ‹åŠŸèƒ½å®Œæ•´åº¦
  Future<FeatureCompletenessStatus> _checkFeatureCompleteness(
    GoalCriteria goal
  ) async {
    final completedFeatures = <String>[];
    final pendingFeatures = <String>[];

    for (final feature in goal.featureCompleteness) {
      final isComplete = await _checkFeatureImplemented(feature);
      if (isComplete) {
        completedFeatures.add(feature);
      } else {
        pendingFeatures.add(feature);
      }
    }

    return FeatureCompletenessStatus(
      totalFeatures: goal.featureCompleteness.length,
      completedCount: completedFeatures.length,
      completionRate: completedFeatures.length / goal.featureCompleteness.length,
      completedFeatures: completedFeatures,
      pendingFeatures: pendingFeatures,
      isFullyComplete: pendingFeatures.isEmpty,
    );
  }

  /// æ£€æµ‹ç”¨æˆ·é‡‡ç”¨ç‡
  Future<AdoptionStatus> _checkAdoptionMetrics(GoalCriteria goal) async {
    final criteria = goal.adoptionCriteria;

    // ä»åˆ†ææœåŠ¡è·å–å®é™…æ•°æ®
    final actualAwareness = await _analytics.getFeatureAwarenessRate(goal.name);
    final actualTrial = await _analytics.getFeatureTrialRate(goal.name);
    final actualRegularUse = await _analytics.getFeatureRegularUseRate(goal.name);

    return AdoptionStatus(
      awarenessRate: MetricStatus(
        target: criteria.awarenessRate,
        actual: actualAwareness,
        achieved: actualAwareness >= criteria.awarenessRate,
      ),
      trialRate: MetricStatus(
        target: criteria.trialRate,
        actual: actualTrial,
        achieved: actualTrial >= criteria.trialRate,
      ),
      regularUseRate: MetricStatus(
        target: criteria.regularUseRate,
        actual: actualRegularUse,
        achieved: actualRegularUse >= criteria.regularUseRate,
      ),
    );
  }

  /// æ£€æµ‹ä½¿ç”¨æ•ˆæœ
  Future<OutcomeStatus> _checkOutcomeMetrics(GoalCriteria goal) async {
    final results = <OutcomeMetricResult>[];

    for (final metric in goal.outcomeMetrics) {
      final actualValue = await _getOutcomeMetricValue(metric);
      results.add(OutcomeMetricResult(
        metric: metric,
        actualValue: actualValue,
        achieved: _isOutcomeMetricAchieved(metric, actualValue),
      ));
    }

    return OutcomeStatus(
      metrics: results,
      overallAchieved: results.where((r) => r.achieved).length >=
                       (results.length * 0.7).ceil(),  // 70%æŒ‡æ ‡è¾¾æˆ
    );
  }

  /// æ£€æµ‹ç”¨æˆ·æ»¡æ„åº¦
  Future<SatisfactionStatus> _checkSatisfactionMetrics(GoalCriteria goal) async {
    final target = goal.satisfactionTarget;

    final actualCsat = await _feedback.getFeatureCsatScore(goal.name);
    final actualNps = await _feedback.getFeatureNpsScore(goal.name);

    return SatisfactionStatus(
      csatScore: MetricStatus(
        target: target.csatScore,
        actual: actualCsat,
        achieved: actualCsat >= target.csatScore,
      ),
      npsScore: MetricStatus(
        target: target.featureNps.toDouble(),
        actual: actualNps.toDouble(),
        achieved: actualNps >= target.featureNps,
      ),
    );
  }

  /// è®¡ç®—ç»¼åˆå¾—åˆ† (0-100)
  double _calculateOverallScore(
    FeatureCompletenessStatus feature,
    AdoptionStatus adoption,
    OutcomeStatus outcome,
    SatisfactionStatus satisfaction,
  ) {
    // æƒé‡åˆ†é…: åŠŸèƒ½30% + é‡‡ç”¨25% + æ•ˆæœ25% + æ»¡æ„åº¦20%
    final featureScore = feature.completionRate * 100 * 0.30;
    final adoptionScore = adoption.overallRate * 100 * 0.25;
    final outcomeScore = outcome.achievementRate * 100 * 0.25;
    final satisfactionScore = satisfaction.overallRate * 100 * 0.20;

    return featureScore + adoptionScore + outcomeScore + satisfactionScore;
  }

  /// åˆ¤å®šè¾¾æˆç­‰çº§
  AchievementLevel _determineAchievementLevel(
    FeatureCompletenessStatus feature,
    AdoptionStatus adoption,
    OutcomeStatus outcome,
    SatisfactionStatus satisfaction,
  ) {
    final score = _calculateOverallScore(feature, adoption, outcome, satisfaction);

    if (!feature.isFullyComplete) {
      return AchievementLevel.notStarted;  // åŠŸèƒ½æœªå®Œæˆ
    }

    if (score >= 90) return AchievementLevel.exceeded;      // è¶…è¶Šç›®æ ‡
    if (score >= 75) return AchievementLevel.achieved;      // è¾¾æˆç›®æ ‡
    if (score >= 50) return AchievementLevel.partial;       // éƒ¨åˆ†è¾¾æˆ
    return AchievementLevel.notAchieved;                    // æœªè¾¾æˆ
  }
}
```

#### 1.4.4 ç›®æ ‡è¾¾æˆä»ªè¡¨ç›˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ ¸å¿ƒç›®æ ‡è¾¾æˆçŠ¶æ€ä»ªè¡¨ç›˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                â”‚
â”‚  ç›®æ ‡åç§°          åŠŸèƒ½å®Œæˆ    é‡‡ç”¨ç‡      æ•ˆæœè¾¾æˆ    æ»¡æ„åº¦    ç»¼åˆè¯„çº§        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1. é’±é¾„åˆ†æ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â­â­â­â­      â”‚
â”‚                    100%        75%         62%         80%         è¾¾æˆ         â”‚
â”‚                                                                                â”‚
â”‚  2. é›¶åŸºé¢„ç®—       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â­â­â­        â”‚
â”‚                    100%        50%         50%         75%         éƒ¨åˆ†è¾¾æˆ     â”‚
â”‚                                                                                â”‚
â”‚  3. æ™ºèƒ½æ´å¯Ÿ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â­â­â­        â”‚
â”‚                    75%         62%         50%         62%         éƒ¨åˆ†è¾¾æˆ     â”‚
â”‚                                                                                â”‚
â”‚  4. æ•°æ®è”åŠ¨       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â­â­â­â­      â”‚
â”‚                    100%        87%         75%         80%         è¾¾æˆ         â”‚
â”‚                                                                                â”‚
â”‚  5. ä½“éªŒå‡çº§       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â­â­â­â­â­    â”‚
â”‚                    100%        100%        87%         90%         è¶…è¶Šç›®æ ‡     â”‚
â”‚                                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯„çº§è¯´æ˜:  â­â­â­â­â­ è¶…è¶Šç›®æ ‡(â‰¥90)  â­â­â­â­ è¾¾æˆ(â‰¥75)                          â”‚
â”‚            â­â­â­ éƒ¨åˆ†è¾¾æˆ(â‰¥50)       â­â­ æœªè¾¾æˆ(<50)  â­ æœªå¼€å§‹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.5 æ£€æµ‹è§¦å‘æ—¶æœºä¸å‘¨æœŸ

```dart
/// ç›®æ ‡è¾¾æˆæ£€æµ‹è°ƒåº¦å™¨
class GoalAchievementScheduler {
  /// æ£€æµ‹è§¦å‘è§„åˆ™
  static const checkSchedule = {
    // åŠŸèƒ½å®Œæ•´åº¦ - æ¯æ¬¡ç‰ˆæœ¬å‘å¸ƒæ—¶æ£€æµ‹
    CheckType.featureCompleteness: CheckTrigger(
      event: 'version_release',
      description: 'ç‰ˆæœ¬å‘å¸ƒæ—¶è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½å®Œæ•´åº¦',
    ),

    // é‡‡ç”¨ç‡ - æ¯å‘¨å®šæœŸæ£€æµ‹
    CheckType.adoption: CheckTrigger(
      interval: Duration(days: 7),
      description: 'æ¯å‘¨ä¸€ç»Ÿè®¡ä¸Šå‘¨é‡‡ç”¨ç‡æ•°æ®',
    ),

    // ä½¿ç”¨æ•ˆæœ - æ¯æœˆæ£€æµ‹
    CheckType.outcome: CheckTrigger(
      interval: Duration(days: 30),
      description: 'æ¯æœˆåˆåˆ†æä¸Šæœˆæ•ˆæœæ•°æ®',
    ),

    // æ»¡æ„åº¦ - æŒç»­æ”¶é›†ï¼Œæ¯æœˆæ±‡æ€»
    CheckType.satisfaction: CheckTrigger(
      interval: Duration(days: 30),
      description: 'æ¯æœˆæ±‡æ€»ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†',
    ),

    // ç»¼åˆè¯„ä¼° - æ¯å­£åº¦
    CheckType.comprehensive: CheckTrigger(
      interval: Duration(days: 90),
      description: 'æ¯å­£åº¦è¿›è¡Œå…¨é¢ç›®æ ‡è¯„ä¼°',
    ),
  };

  /// æ£€æµ‹ç»“æœé€šçŸ¥é…ç½®
  static const alertThresholds = {
    // æŒ‡æ ‡ä¸‹é™è¶…è¿‡10%æ—¶å‘Šè­¦
    'metricDecline': 0.10,
    // è¿ç»­2å‘¨æœªè¾¾æ ‡æ—¶å‘Šè­¦
    'consecutiveFailure': 2,
    // æ»¡æ„åº¦ä½äº3.5åˆ†æ—¶å‘Šè­¦
    'lowSatisfaction': 3.5,
  };
}
```

---

## 2. äº§å“å®šä½ä¸æ„¿æ™¯

### 2.1 äº§å“å®šä½

**"æ‚¨çš„æ™ºèƒ½è´¢åŠ¡ç®¡å®¶"**

AIæ™ºèƒ½è®°è´¦ 2.0 å®šä½ä¸ºä¸€æ¬¾é¢å‘ä¸ªäººå’Œå®¶åº­çš„æ™ºèƒ½è´¢åŠ¡ç®¡ç†åº”ç”¨ï¼Œé€šè¿‡AIæŠ€æœ¯é™ä½è®°è´¦é—¨æ§›ï¼Œé€šè¿‡æ•°æ®åˆ†æå¸®åŠ©ç”¨æˆ·å»ºç«‹å¥åº·çš„è´¢åŠ¡ä¹ æƒ¯ã€‚

### 2.2 ç›®æ ‡ç”¨æˆ·

| ç”¨æˆ·ç¾¤ä½“ | ç‰¹å¾ | æ ¸å¿ƒéœ€æ±‚ |
|----------|------|----------|
| **è®°è´¦æ–°æ‰‹** | æƒ³è¦å¼€å§‹è®°è´¦ä½†ä¸çŸ¥ä»ä½•ä¸‹æ‰‹ | ç®€å•æ˜“ç”¨ã€è‡ªåŠ¨åŒ– |
| **ç†è´¢çˆ±å¥½è€…** | æœ‰è®°è´¦ä¹ æƒ¯ï¼Œè¿½æ±‚ç²¾ç»†åŒ–ç®¡ç† | æ·±åº¦åˆ†æã€é¢„ç®—è§„åˆ’ |
| **å®¶åº­ç”¨æˆ·** | éœ€è¦ç®¡ç†å®¶åº­æ”¶æ”¯ | å¤šè´¦æˆ·ã€å®¶åº­å…±äº« |
| **è‡ªç”±èŒä¸šè€…** | æ”¶å…¥ä¸å›ºå®šï¼Œéœ€è¦ç°é‡‘æµç®¡ç† | æ”¶å…¥è¿½è¸ªã€ç¨åŠ¡è¾…åŠ© |

### 2.3 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚   ğŸ“± ä¸€é”®è®°è´¦          ğŸ¤– AIè‡ªåŠ¨è¯†åˆ«         ğŸ“Š æ™ºèƒ½åˆ†æ       â”‚
â”‚   è¯­éŸ³/æ‹ç…§/æ‰‹åŠ¨       å°ç¥¨ã€è´¦å•è‡ªåŠ¨è§£æ     é’±é¾„ã€é¢„ç®—ã€è¶‹åŠ¿  â”‚
â”‚                                                                â”‚
â”‚   ğŸ’° é›¶åŸºé¢„ç®—          ğŸ¯ è´¢åŠ¡ç›®æ ‡           ğŸ”„ æ•°æ®åŒæ­¥       â”‚
â”‚   æ¯åˆ†é’±éƒ½æœ‰å»å¤„       å‚¨è“„ã€è¿˜å€ºã€æŠ•èµ„       å¤šè®¾å¤‡æ— ç¼åˆ‡æ¢    â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 ç«å“å·®å¼‚åŒ–

| åŠŸèƒ½ç»´åº¦ | ä¼ ç»Ÿè®°è´¦APP | AIæ™ºèƒ½è®°è´¦ 2.0 |
|----------|------------|----------------|
| è®°è´¦æ–¹å¼ | æ‰‹åŠ¨è¾“å…¥ | AIè¯­éŸ³/å›¾åƒè¯†åˆ« + æ‰‹åŠ¨ |
| æ•°æ®åˆ†æ | ç®€å•å›¾è¡¨ | é’±é¾„åˆ†æ + æ™ºèƒ½æ´å¯Ÿ |
| é¢„ç®—ç®¡ç† | å›ºå®šé¢„ç®— | é›¶åŸºé¢„ç®— + å°é‡‘åº“ |
| æ•°æ®å¯¼å…¥ | æ‰‹åŠ¨å½•å…¥ | æ™ºèƒ½è§£æ + è‡ªåŠ¨å»é‡ |
| äº¤äº’ä½“éªŒ | é™æ€é¡µé¢ | æ•°æ®è”åŠ¨ + ä¸‹é’»æ¢ç´¢ |

### 2.5 ç”¨æˆ·ä¼˜å…ˆè½åœ°æœºåˆ¶

ã€Œç”¨æˆ·ä¼˜å…ˆã€åŸåˆ™éœ€è¦å…·ä½“çš„è½åœ°æœºåˆ¶æ¥ç¡®ä¿æ‰€æœ‰è®¾è®¡å†³ç­–ä»¥ç”¨æˆ·ä»·å€¼ä¸ºæ ¸å¿ƒã€‚

#### 2.5.1 ç”¨æˆ·åé¦ˆæ”¶é›†ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·åé¦ˆæ”¶é›†æ¸ é“                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸»åŠ¨æ”¶é›†æ¸ é“    â”‚   â”‚  è¢«åŠ¨æ”¶é›†æ¸ é“    â”‚   â”‚  æ•°æ®åˆ†ææ¸ é“    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ åº”ç”¨å†…åé¦ˆå…¥å£ â”‚   â”‚ â€¢ å´©æºƒæ—¥å¿—æ”¶é›†   â”‚   â”‚ â€¢ åŠŸèƒ½ä½¿ç”¨çƒ­åŠ›å›¾ â”‚   â”‚
â”‚  â”‚ â€¢ æ»¡æ„åº¦è¯„åˆ†å¡ç‰‡ â”‚   â”‚ â€¢ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹   â”‚   â”‚ â€¢ ç”¨æˆ·è·¯å¾„åˆ†æ   â”‚   â”‚
â”‚  â”‚ â€¢ åŠŸèƒ½å»ºè®®æŠ•ç¥¨   â”‚   â”‚ â€¢ åº”ç”¨å•†åº—è¯„è®º   â”‚   â”‚ â€¢ æµå¤±æ¼æ–—åˆ†æ   â”‚   â”‚
â”‚  â”‚ â€¢ å®šæœŸç”¨æˆ·è®¿è°ˆ   â”‚   â”‚ â€¢ ç¤¾åŒº/ç¾¤ç»„åé¦ˆ  â”‚   â”‚ â€¢ A/Bæµ‹è¯•ç»“æœ    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.2 ç”¨æˆ·æ»¡æ„åº¦é‡åŒ–æŒ‡æ ‡

```dart
/// ç”¨æˆ·æ»¡æ„åº¦è¯„ä¼°æœåŠ¡
class UserSatisfactionService {
  /// æ ¸å¿ƒæ»¡æ„åº¦æŒ‡æ ‡
  static const satisfactionMetrics = {
    // NPS (å‡€æ¨èå€¼) - ç”¨æˆ·æ„¿æ„æ¨èç»™æœ‹å‹çš„ç¨‹åº¦
    'nps': NpsMetric(
      question: 'æ‚¨æœ‰å¤šå¤§å¯èƒ½å‘æœ‹å‹æ¨èè¿™æ¬¾è®°è´¦APPï¼Ÿ',
      scale: 10,  // 0-10åˆ†
      promoterThreshold: 9,   // 9-10åˆ†ä¸ºæ¨èè€…
      detractorThreshold: 6,  // 0-6åˆ†ä¸ºè´¬æŸè€…
      targetScore: 50,        // ç›®æ ‡NPSâ‰¥50
    ),

    // CSAT (å®¢æˆ·æ»¡æ„åº¦) - å¯¹ç‰¹å®šåŠŸèƒ½çš„æ»¡æ„åº¦
    'csat': CsatMetric(
      question: 'æ‚¨å¯¹{åŠŸèƒ½åç§°}çš„æ»¡æ„ç¨‹åº¦å¦‚ä½•ï¼Ÿ',
      scale: 5,  // 1-5æ˜Ÿ
      targetScore: 4.2,  // ç›®æ ‡â‰¥4.2æ˜Ÿ
    ),

    // CES (å®¢æˆ·è´¹åŠ›åº¦) - å®Œæˆä»»åŠ¡çš„éš¾æ˜“ç¨‹åº¦
    'ces': CesMetric(
      question: 'å®Œæˆ{ä»»åŠ¡åç§°}å¯¹æ‚¨æ¥è¯´æœ‰å¤šå®¹æ˜“ï¼Ÿ',
      scale: 7,  // 1-7åˆ†ï¼Œ7æœ€å®¹æ˜“
      targetScore: 5.5,  // ç›®æ ‡â‰¥5.5åˆ†
    ),
  };

  /// è§¦å‘æ»¡æ„åº¦è°ƒæŸ¥çš„æ—¶æœº
  static const surveyTriggers = [
    // å…³é”®èŠ‚ç‚¹è§¦å‘
    SurveyTrigger(
      event: 'first_week_completed',
      surveyType: 'nps',
      description: 'ä½¿ç”¨æ»¡ä¸€å‘¨åæ”¶é›†NPS',
    ),
    SurveyTrigger(
      event: 'feature_used_10_times',
      surveyType: 'csat',
      description: 'æŸåŠŸèƒ½ä½¿ç”¨10æ¬¡åè¯„ä»·',
    ),
    SurveyTrigger(
      event: 'task_completed',
      surveyType: 'ces',
      description: 'å®Œæˆå¤æ‚ä»»åŠ¡åè¯„ä¼°éš¾åº¦',
    ),
    // å®šæœŸè§¦å‘
    SurveyTrigger(
      event: 'monthly_active',
      surveyType: 'nps',
      description: 'æ¯æœˆæ´»è·ƒç”¨æˆ·NPSè°ƒæŸ¥',
      cooldown: Duration(days: 90),  // 90å¤©å†·å´æœŸ
    ),
  ];
}
```

#### 2.5.3 ç”¨æˆ·åé¦ˆé—­ç¯æœºåˆ¶

```dart
/// ç”¨æˆ·åé¦ˆå¤„ç†æœåŠ¡
class UserFeedbackService {
  /// åé¦ˆå¤„ç†æµç¨‹
  Future<void> processFeedback(UserFeedback feedback) async {
    // 1. åˆ†ç±»
    final category = await _categorizeFeedback(feedback);

    // 2. ä¼˜å…ˆçº§è¯„ä¼°
    final priority = _assessPriority(feedback, category);

    // 3. è·¯ç”±åˆ°å¯¹åº”å¤„ç†é˜Ÿåˆ—
    await _routeFeedback(feedback, category, priority);

    // 4. è‡ªåŠ¨å›å¤ç¡®è®¤
    await _sendAcknowledgement(feedback);

    // 5. è·Ÿè¸ªå¤„ç†è¿›åº¦
    await _trackProgress(feedback);
  }

  /// åé¦ˆä¼˜å…ˆçº§è¯„ä¼°
  FeedbackPriority _assessPriority(UserFeedback feedback, FeedbackCategory category) {
    double score = 0;

    // å½±å“èŒƒå›´
    score += feedback.affectedUserCount > 100 ? 3 :
             feedback.affectedUserCount > 10 ? 2 : 1;

    // ä¸¥é‡ç¨‹åº¦
    score += feedback.severity == Severity.critical ? 3 :
             feedback.severity == Severity.major ? 2 : 1;

    // ç”¨æˆ·ä»·å€¼ï¼ˆä»˜è´¹ç”¨æˆ·/æ´»è·ƒç”¨æˆ·æƒé‡æ›´é«˜ï¼‰
    score += feedback.userType == UserType.premium ? 1.5 : 1;

    // é‡å¤æ¬¡æ•°
    score += feedback.duplicateCount > 5 ? 2 :
             feedback.duplicateCount > 1 ? 1 : 0;

    return score >= 7 ? FeedbackPriority.critical :
           score >= 5 ? FeedbackPriority.high :
           score >= 3 ? FeedbackPriority.medium : FeedbackPriority.low;
  }

  /// åé¦ˆå¤„ç†åçš„é—­ç¯
  Future<void> closeFeedbackLoop(String feedbackId, FeedbackResolution resolution) async {
    final feedback = await _getFeedback(feedbackId);

    // 1. é€šçŸ¥ç”¨æˆ·å¤„ç†ç»“æœ
    await _notifyUser(feedback.userId, resolution);

    // 2. å¦‚æœæ˜¯åŠŸèƒ½å»ºè®®ä¸”å·²å®ç°ï¼Œé‚€è¯·ç”¨æˆ·ä½“éªŒ
    if (resolution.type == ResolutionType.implemented) {
      await _inviteToTryNewFeature(feedback.userId, resolution.featureId);
    }

    // 3. è¯·æ±‚è·Ÿè¿›æ»¡æ„åº¦è¯„ä»·
    await _requestFollowUpSurvey(feedback.userId, feedbackId);

    // 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
    await _updateFeedbackStats(feedbackId, resolution);
  }
}

/// åé¦ˆç±»å‹
enum FeedbackCategory {
  bug,           // ç¼ºé™·æŠ¥å‘Š
  feature,       // åŠŸèƒ½å»ºè®®
  improvement,   // æ”¹è¿›å»ºè®®
  complaint,     // æŠ•è¯‰
  praise,        // å¥½è¯„
  question,      // å’¨è¯¢
}
```

#### 2.5.4 ç”¨æˆ·éœ€æ±‚éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         éœ€æ±‚éªŒè¯å†³ç­–æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  æ”¶é›†éœ€æ±‚ â”€â”€â–¶ éœ€æ±‚åˆ†æ â”€â”€â–¶ ç”¨æˆ·éªŒè¯ â”€â”€â–¶ åŸå‹æµ‹è¯• â”€â”€â–¶ å†³ç­–           â”‚
â”‚      â”‚           â”‚           â”‚           â”‚           â”‚               â”‚
â”‚      â–¼           â–¼           â–¼           â–¼           â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚åé¦ˆæ”¶é›†â”‚ â”‚ä»·å€¼è¯„ä¼°â”‚ â”‚ç”¨æˆ·è®¿è°ˆâ”‚ â”‚å¯ç”¨æ€§  â”‚ â”‚Go/NoGo â”‚             â”‚
â”‚  â”‚æ•°æ®åˆ†æâ”‚ â”‚æˆæœ¬ä¼°ç®—â”‚ â”‚é—®å·è°ƒæŸ¥â”‚ â”‚æµ‹è¯•    â”‚ â”‚å†³ç­–    â”‚             â”‚
â”‚  â”‚ç«å“ç ”ç©¶â”‚ â”‚ä¼˜å…ˆæ’åºâ”‚ â”‚A/Bæµ‹è¯• â”‚ â”‚åŸ‹ç‚¹    â”‚ â”‚         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                        â”‚
â”‚  éªŒè¯æ ‡å‡†ï¼š                                                             â”‚
â”‚  â€¢ ç”¨æˆ·éœ€æ±‚çœŸå®æ€§ï¼šâ‰¥10ä¸ªç‹¬ç«‹ç”¨æˆ·æå‡ºç›¸åŒéœ€æ±‚                           â”‚
â”‚  â€¢ ç”¨æˆ·æ„¿æ„ä»˜è´¹/ä½¿ç”¨ï¼šè®¿è°ˆä¸­â‰¥60%è¡¨ç¤ºæ„¿æ„ä½¿ç”¨                           â”‚
â”‚  â€¢ åŸå‹æµ‹è¯•é€šè¿‡ç‡ï¼šä»»åŠ¡å®Œæˆç‡â‰¥80%                                      â”‚
â”‚  â€¢ æ»¡æ„åº¦é¢„æœŸï¼šé¢„æœŸCSATâ‰¥4.0                                            â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.5 ç”¨æˆ·ä»·å€¼åº¦é‡ä½“ç³»

```dart
/// ç”¨æˆ·ä»·å€¼åº¦é‡æœåŠ¡
class UserValueMetricsService {
  /// æ ¸å¿ƒç”¨æˆ·ä»·å€¼æŒ‡æ ‡
  final userValueMetrics = {
    // ç•™å­˜ç›¸å…³
    'æ¬¡æ—¥ç•™å­˜ç‡': RetentionMetric(day: 1, target: 0.40),
    '7æ—¥ç•™å­˜ç‡': RetentionMetric(day: 7, target: 0.25),
    '30æ—¥ç•™å­˜ç‡': RetentionMetric(day: 30, target: 0.15),

    // æ´»è·ƒç›¸å…³
    'æ—¥æ´»è·ƒç”¨æˆ·(DAU)': ActiveUserMetric(period: 'daily'),
    'æœˆæ´»è·ƒç”¨æˆ·(MAU)': ActiveUserMetric(period: 'monthly'),
    'DAU/MAUæ¯”ç‡': EngagementMetric(target: 0.20),  // ç²˜æ€§æŒ‡æ ‡

    // ä½¿ç”¨æ·±åº¦
    'äººå‡è®°è´¦ç¬”æ•°/æ—¥': UsageMetric(action: 'add_transaction', target: 2.0),
    'åŠŸèƒ½è¦†ç›–ç‡': FeatureCoverageMetric(target: 0.60),  // ä½¿ç”¨â‰¥60%çš„åŠŸèƒ½
    'ä¼šè¯æ—¶é•¿': SessionMetric(target: Duration(minutes: 3)),

    // ç”¨æˆ·æˆé•¿
    'å®Œæˆæ–°æ‰‹å¼•å¯¼ç‡': OnboardingMetric(target: 0.70),
    'å‡çº§åˆ°é«˜çº§åŠŸèƒ½ç‡': UpgradeMetric(target: 0.30),
    'æ¨èæ–°ç”¨æˆ·æ•°': ReferralMetric(target: 0.10),  // 10%ç”¨æˆ·å¸¦æ¥æ–°ç”¨æˆ·
  };

  /// å®šæœŸç”Ÿæˆç”¨æˆ·ä»·å€¼æŠ¥å‘Š
  Future<UserValueReport> generateWeeklyReport() async {
    final report = UserValueReport(
      period: DateRange.lastWeek(),
      metrics: await _collectAllMetrics(),
      trends: await _analyzeTrends(),
      insights: await _generateInsights(),
      actionItems: await _suggestActions(),
    );

    // è‡ªåŠ¨å‘é€ç»™äº§å“å›¢é˜Ÿ
    await _sendToProductTeam(report);

    return report;
  }
}
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½æ¶æ„

### 3.1 åŠŸèƒ½æ¨¡å—å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AIæ™ºèƒ½è®°è´¦ 2.0 åŠŸèƒ½æ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å¿«æ·è®°è´¦   â”‚ â”‚   è´¦æˆ·ç®¡ç†   â”‚ â”‚   é¢„ç®—ä¸­å¿ƒ   â”‚ â”‚   ç»Ÿè®¡åˆ†æ   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ è¯­éŸ³è¯†åˆ«   â”‚ â”‚ â€¢ å¤šè´¦æˆ·     â”‚ â”‚ â€¢ é›¶åŸºé¢„ç®—   â”‚ â”‚ â€¢ é’±é¾„åˆ†æ   â”‚  â”‚
â”‚  â”‚ â€¢ å›¾åƒè¯†åˆ«   â”‚ â”‚ â€¢ ä¿¡ç”¨å¡     â”‚ â”‚ â€¢ å°é‡‘åº“     â”‚ â”‚ â€¢ æ”¶æ”¯è¶‹åŠ¿   â”‚  â”‚
â”‚  â”‚ â€¢ å¿«é€Ÿè¾“å…¥   â”‚ â”‚ â€¢ å€ºåŠ¡ç®¡ç†   â”‚ â”‚ â€¢ é¢„ç®—æé†’   â”‚ â”‚ â€¢ åˆ†ç±»åˆ†æ   â”‚  â”‚
â”‚  â”‚ â€¢ æ‰¹é‡å¯¼å…¥   â”‚ â”‚ â€¢ å‚¨è“„ç›®æ ‡   â”‚ â”‚ â€¢ å‘¨æœŸé¢„ç®—   â”‚ â”‚ â€¢ æ™ºèƒ½æŠ¥å‘Š   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è´¦å•æé†’   â”‚ â”‚   æ•°æ®ç®¡ç†   â”‚ â”‚   ä¸ªäººä¸­å¿ƒ   â”‚ â”‚   è®¾ç½®ä¸­å¿ƒ   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ å®šæœŸè´¦å•   â”‚ â”‚ â€¢ æ•°æ®å¤‡ä»½   â”‚ â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯   â”‚ â”‚ â€¢ ä¸»é¢˜è®¾ç½®   â”‚  â”‚
â”‚  â”‚ â€¢ è¿˜æ¬¾æé†’   â”‚ â”‚ â€¢ æ•°æ®æ¢å¤   â”‚ â”‚ â€¢ ä¼šå‘˜æœåŠ¡   â”‚ â”‚ â€¢ é€šçŸ¥è®¾ç½®   â”‚  â”‚
â”‚  â”‚ â€¢ åˆ°æœŸé€šçŸ¥   â”‚ â”‚ â€¢ æ•°æ®å¯¼å‡º   â”‚ â”‚ â€¢ å¸®åŠ©åé¦ˆ   â”‚ â”‚ â€¢ éšç§å®‰å…¨   â”‚  â”‚
â”‚  â”‚ â€¢ æ™ºèƒ½å»ºè®®   â”‚ â”‚ â€¢ äº‘ç«¯åŒæ­¥   â”‚ â”‚ â€¢ å…³äºæˆ‘ä»¬   â”‚ â”‚ â€¢ è¯­è¨€åŒºåŸŸ   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åŠŸèƒ½ç‰¹æ€§å…³ç³»å›¾

#### 3.2.1 ç³»ç»Ÿåˆ†å±‚æ¶æ„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AIæ™ºèƒ½è®°è´¦ 2.0 åŠŸèƒ½ç‰¹æ€§å…³ç³»å›¾                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   ç”¨æˆ·ä½“éªŒè®¾è®¡    â”‚
                                    â”‚     (ç¬¬13ç« )      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                        â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      é¦–é¡µä»ªè¡¨ç›˜        â”‚    â”‚     å¿«æ·è®°è´¦å…¥å£     â”‚    â”‚     è¶‹åŠ¿åˆ†æé¡µé¢     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚                          â”‚
                â”‚                           â–¼                          â”‚
                â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                â”‚              â”‚     AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚              â”‚        (ç¬¬7ç« )           â”‚            â”‚
                â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            â”‚
                â”‚              â”‚  â”‚è¯­éŸ³è¯†åˆ«â”‚å›¾ç‰‡è¯†åˆ«â”‚    â”‚            â”‚
                â”‚              â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚            â”‚
                â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                â”‚                      â”‚       â”‚                       â”‚
                â–¼                      â–¼       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              æ ¸å¿ƒä¸šåŠ¡å±‚                                          â”‚ â”‚
â”‚  â”‚                                                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚   é’±é¾„åˆ†æç³»ç»Ÿ   â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  é›¶åŸºé¢„ç®—ç³»ç»Ÿ   â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚   å°é‡‘åº“ç³»ç»Ÿ    â”‚      â”‚ â”‚
â”‚  â”‚  â”‚    (ç¬¬4ç« )       â”‚        â”‚    (ç¬¬5ç« )      â”‚        â”‚    (ç¬¬5ç« )      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚        â”‚                 â”‚        â”‚                 â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ é’±é¾„è®¡ç®—å¼•æ“  â”‚        â”‚ â€¢ æ¯åˆ†é’±æœ‰å»å¤„  â”‚        â”‚ â€¢ ç›®æ ‡å‚¨è“„      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ å¥åº·åº¦è¯„ä¼°    â”‚        â”‚ â€¢ é¢„ç®—åˆ†é…      â”‚        â”‚ â€¢ è¿›åº¦è¿½è¸ª      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ ä½ç½®å¢å¼ºé’±é¾„  â”‚        â”‚ â€¢ æ‰§è¡Œç›‘æ§      â”‚        â”‚ â€¢ é‡Œç¨‹ç¢‘       â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚           â”‚                          â”‚                          â”‚               â”‚ â”‚
â”‚  â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚               â”‚ â”‚
â”‚  â”‚           â”‚    â–¼                                            â–¼   â–¼               â”‚ â”‚
â”‚  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ                      â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                   (ç¬¬6ç« )                           â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                                                     â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚ä¹ æƒ¯æ‰“å¡   â”‚  â”‚ç§¯åˆ†å¥–åŠ±   â”‚  â”‚æˆå°±ç³»ç»Ÿ   â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                                                     â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚è´¢åŠ¡å¥åº·   â”‚  â”‚ä¸“å®¶ä»»åŠ¡   â”‚  â”‚å‘¨æœŸæŒ‘æˆ˜   â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚ç”»åƒåˆ†æ   â”‚  â”‚ç³»ç»Ÿ       â”‚  â”‚           â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â”‚           â”‚                           â–²                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                           â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                           â”‚
               â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ä½ç½®æ™ºèƒ½å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨ (ç¬¬11ç« )                               â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  ç²¾ç¡®ä½ç½®æœåŠ¡   â”‚â”€â”€â”€â–ºâ”‚  æ¶ˆè´¹åœºæ™¯è¯†åˆ«   â”‚â”€â”€â”€â–ºâ”‚  ä½ç½®é’±é¾„å¢å¼º   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤
â”‚  â”‚   â”‚  (GPS+POI)      â”‚    â”‚(å®¶/å…¬å¸/å•†åœˆ)   â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚            â”‚                                                                     â”‚  â”‚
â”‚  â”‚            â–¼                                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  åœ°ç†å›´æ é¢„è­¦   â”‚â”€â”€â”€â–ºâ”‚  ä½ç½®é¢„ç®—åˆ†é…   â”‚â”€â”€â”€â–ºâ”‚  é¢„ç®—æ‰§è¡Œç›‘æ§   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤
â”‚  â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚            â”‚                                                                     â”‚  â”‚
â”‚  â”‚            â–¼                                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  æœ¬åœ°åŒ–ç±»ç›®æ¨è â”‚    â”‚  å¼‚åœ°æ¶ˆè´¹è¯†åˆ«   â”‚    â”‚  æœ¬åœ°çœé’±å»ºè®®   â”‚            â”‚  â”‚
â”‚  â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    æ•°æ®å¤„ç†å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ    â”‚â—„â”€â”€â–ºâ”‚  æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–    â”‚â—„â”€â”€â–ºâ”‚   æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ     â”‚    â”‚
â”‚  â”‚      (ç¬¬8ç« )         â”‚    â”‚      (ç¬¬9ç« )         â”‚    â”‚      (ç¬¬10ç« )        â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ Excel/CSVå¯¼å…¥     â”‚    â”‚ â€¢ å¤šç»´åº¦æŠ¥è¡¨         â”‚    â”‚ â€¢ é€šä¹‰åƒé—®/æ™ºè°±AI   â”‚    â”‚
â”‚  â”‚ â€¢ æ•°æ®æ ¼å¼è½¬æ¢       â”‚    â”‚ â€¢ äº¤äº’å¼å›¾è¡¨         â”‚    â”‚ â€¢ æ„å›¾è¯†åˆ«å¼•æ“       â”‚    â”‚
â”‚  â”‚ â€¢ æ‰¹é‡å¤„ç†          â”‚    â”‚ â€¢ è¶‹åŠ¿é¢„æµ‹           â”‚    â”‚ â€¢ è‡ªç„¶è¯­è¨€å¤„ç†       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    åŸºç¡€è®¾æ–½å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          æŠ€æœ¯æ¶æ„è®¾è®¡ (ç¬¬12ç« )                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚  â”‚Flutterå®¢æˆ·ç«¯â”‚   â”‚FastAPIæœåŠ¡ç«¯â”‚   â”‚ç¦»çº¿ä¼˜å…ˆæ¶æ„ â”‚   â”‚æ•°æ®åº“è®¾è®¡   â”‚         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚å›½é™…åŒ–ä¸æœ¬åœ°åŒ–â”‚  â”‚ å®‰å…¨ä¸éšç§   â”‚  â”‚ç‰ˆæœ¬è¿ç§»ç­–ç•¥  â”‚  â”‚ å®æ–½è·¯çº¿å›¾   â”‚              â”‚
â”‚  â”‚  (ç¬¬14ç« )    â”‚  â”‚  (ç¬¬15ç« )    â”‚  â”‚  (ç¬¬16ç« )    â”‚  â”‚  (ç¬¬17ç« )    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    è¿ç»´ä¿éšœå±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡   â”‚â—„â”€â”€â–ºâ”‚ å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„   â”‚â—„â”€â”€â–ºâ”‚  å¯è§‚æµ‹æ€§ä¸ç›‘æ§      â”‚    â”‚
â”‚  â”‚     (ç¬¬18ç« )         â”‚    â”‚     (ç¬¬19ç« )         â”‚    â”‚     (ç¬¬20ç« )         â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ æ–­è·¯å™¨æ¨¡å¼        â”‚    â”‚ â€¢ æ¨¡å—åŒ–æ¶æ„         â”‚    â”‚ â€¢ æ—¥å¿—ç³»ç»Ÿ           â”‚    â”‚
â”‚  â”‚ â€¢ å¹‚ç­‰æ€§è®¾è®¡        â”‚    â”‚ â€¢ APIç‰ˆæœ¬ç®¡ç†        â”‚    â”‚ â€¢ æ€§èƒ½ç›‘æ§           â”‚    â”‚
â”‚  â”‚ â€¢ é™çº§ç†”æ–­          â”‚    â”‚ â€¢ ç°åº¦å‘å¸ƒ           â”‚    â”‚ â€¢ å‘Šè­¦ç³»ç»Ÿ           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.2 æ ¸å¿ƒåŠŸèƒ½æ•°æ®æµå…³ç³»

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              ç”¨æˆ·äº¤äº’å…¥å£                                        â”‚
    â”‚                                                                                 â”‚
    â”‚      è¯­éŸ³è¾“å…¥ â”€â”€â”€â”€â”€â”                                                            â”‚
    â”‚                    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
    â”‚      å›¾ç‰‡è¯†åˆ« â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºâ”‚  AIæ™ºèƒ½è¯†åˆ«å¼•æ“  â”‚                                   â”‚
    â”‚                    â”‚     â”‚                  â”‚                                   â”‚
    â”‚      æ‰‹åŠ¨è¾“å…¥ â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
    â”‚                                   â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              äº¤æ˜“è®°å½•ç”Ÿæˆ                                        â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
    â”‚   â”‚  é‡‘é¢è§£æ   â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚  ç±»ç›®åˆ†ç±»   â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚  ç²¾ç¡®ä½ç½®å…³è”           â”‚      â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â€¢ GPSåæ ‡              â”‚      â”‚
    â”‚                                               â”‚  â€¢ POIå•†æˆ·ä¿¡æ¯           â”‚      â”‚
    â”‚                                               â”‚  â€¢ æ¶ˆè´¹åœºæ™¯è¯†åˆ«          â”‚      â”‚
    â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                           â”‚                   â”‚
                     â–¼                                           â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       é’±é¾„åˆ†æç³»ç»Ÿ         â”‚    â”‚        é›¶åŸºé¢„ç®—ç³»ç»Ÿ              â”‚    â”‚  å°é‡‘åº“ç³»ç»Ÿ â”‚
    â”‚                            â”‚    â”‚                                 â”‚    â”‚             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ åŸºç¡€é’±é¾„è®¡ç®—         â”‚ â”‚    â”‚  â”‚ ä¼ ç»Ÿé¢„ç®—åˆ†é…            â”‚   â”‚    â”‚ â”‚ç›®æ ‡ç®¡ç† â”‚ â”‚
    â”‚  â”‚ (æ”¶å…¥æ—¥æœŸ-æ”¯å‡ºæ—¥æœŸ)  â”‚ â”‚    â”‚  â”‚ â€¢ æŒ‰ç±»ç›®åˆ†é…é¢„ç®—        â”‚   â”‚    â”‚ â”‚         â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â”‚ â€¢ æœˆåº¦/å‘¨åº¦å‘¨æœŸ         â”‚   â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
    â”‚             â”‚             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚             â–¼             â”‚    â”‚              â”‚                 â”‚    â”‚      â”‚      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚              â–¼                 â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ ä½ç½®å¢å¼ºé’±é¾„         â”‚ â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ æ¶ˆè´¹åœºæ™¯åˆ†ç¦»       â”‚â—„â”œâ”€â”€â”€â–ºâ”‚  â”‚ ä½ç½®æ™ºèƒ½é¢„ç®—            â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ æ—…æ¸¸/å‡ºå·®æƒé‡è°ƒæ•´  â”‚ â”‚    â”‚  â”‚ â€¢ æŒ‰åœºæ™¯åˆ†é…é¢„ç®—        â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ é€šå‹¤æ¶ˆè´¹è¿½è¸ª       â”‚ â”‚    â”‚  â”‚ â€¢ åœ°ç†å›´æ æé†’          â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â”‚ â€¢ é«˜æ¶ˆè´¹åŒºåŸŸé¢„è­¦        â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚             â”‚             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚             â–¼             â”‚    â”‚              â”‚                 â”‚    â”‚      â–¼      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚              â–¼                 â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ é’±é¾„å¥åº·åº¦è¯„ä¼°       â”‚ â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚ â”‚è¿›åº¦è¿½è¸ª â”‚ â”‚
    â”‚  â”‚ â€¢ ä¼˜ç§€ (â‰¥30å¤©)       â”‚ â”‚    â”‚  â”‚ é¢„ç®—æ‰§è¡Œç›‘æ§            â”‚   â”‚    â”‚ â”‚         â”‚ â”‚
    â”‚  â”‚ â€¢ è‰¯å¥½ (14-29å¤©)     â”‚ â”‚    â”‚  â”‚ â€¢ å®æ—¶ä½™é¢æ›´æ–°          â”‚   â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
    â”‚  â”‚ â€¢ ä¸€èˆ¬ (7-13å¤©)      â”‚ â”‚    â”‚  â”‚ â€¢ è¶…æ”¯é¢„è­¦              â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ éœ€æ”¹å–„ (<7å¤©)      â”‚ â”‚    â”‚  â”‚ â€¢ ä½ç½®ç»´åº¦æŠ¥å‘Š          â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚                            â”‚    â”‚                                 â”‚    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                    â”‚                           â”‚
                  â”‚                                    â”‚                           â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ                                       â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                         è¾“å…¥æ•°æ®æ¥æº                                     â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚    é’±é¾„å˜åŒ–è¶‹åŠ¿ â”€â”€â”€â”                                                    â”‚  â”‚
    â”‚   â”‚                    â”‚                                                    â”‚  â”‚
    â”‚   â”‚    é¢„ç®—æ‰§è¡Œç‡ â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–º  è´¢åŠ¡å¥åº·ç”»åƒåˆ†æ                             â”‚  â”‚
    â”‚   â”‚                    â”‚                                                    â”‚  â”‚
    â”‚   â”‚    å‚¨è“„ç›®æ ‡è¿›åº¦ â”€â”€â”€â”˜                                                    â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                       â”‚                                         â”‚
    â”‚                                       â–¼                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚   â”‚   ä¹ æƒ¯å…»æˆ      â”‚   â”‚   ç§¯åˆ†å¥–åŠ±      â”‚   â”‚   æˆå°±ç³»ç»Ÿ      â”‚              â”‚
    â”‚   â”‚                 â”‚   â”‚                 â”‚   â”‚                 â”‚              â”‚
    â”‚   â”‚ â€¢ æ¯æ—¥è®°è´¦æ‰“å¡  â”‚â”€â”€â–ºâ”‚ â€¢ è®°è´¦ç§¯åˆ†      â”‚â”€â”€â–ºâ”‚ â€¢ é‡Œç¨‹ç¢‘å¾½ç«     â”‚              â”‚
    â”‚   â”‚ â€¢ 21å¤©ä¹ æƒ¯æŒ‘æˆ˜  â”‚   â”‚ â€¢ è¿ç»­å¥–åŠ±      â”‚   â”‚ â€¢ ç­‰çº§æ™‹å‡      â”‚              â”‚
    â”‚   â”‚ â€¢ å®šæœŸå¤ç›˜      â”‚   â”‚ â€¢ ä»»åŠ¡å®Œæˆ      â”‚   â”‚ â€¢ æˆå°±è§£é”      â”‚              â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
    â”‚           â”‚                     â”‚                     â”‚                         â”‚
    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
    â”‚                                 â–¼                                               â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
    â”‚                    â”‚    ä¸“å®¶ä»»åŠ¡æ¨è         â”‚                                  â”‚
    â”‚                    â”‚                         â”‚                                  â”‚
    â”‚                    â”‚ æ ¹æ®è´¢åŠ¡ç”»åƒæ¨è:       â”‚                                  â”‚
    â”‚                    â”‚ â€¢ æé«˜é’±é¾„ä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ é¢„ç®—ä¼˜åŒ–ä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ å‚¨è“„åŠ é€Ÿä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ æ¶ˆè´¹ä¹ æƒ¯æ”¹å–„ä»»åŠ¡      â”‚                                  â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
    â”‚                                                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 ç²¾ç¡®ä½ç½®åŠŸèƒ½ä¾èµ–å…³ç³»

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚       ç²¾ç¡®ä½ç½®æœåŠ¡           â”‚
                              â”‚    PreciseLocationService    â”‚
                              â”‚                              â”‚
                              â”‚  â€¢ GPSé«˜ç²¾åº¦å®šä½             â”‚
                              â”‚  â€¢ åå‘åœ°ç†ç¼–ç               â”‚
                              â”‚  â€¢ POIå•†æˆ·æŸ¥è¯¢               â”‚
                              â”‚  â€¢ åŒºåŸŸç±»å‹æ£€æµ‹              â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                           â”‚                           â”‚
                 â–¼                           â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å¸¸é©»åœ°ç‚¹æœåŠ¡         â”‚  â”‚   æ¶ˆè´¹åœºæ™¯åˆ†æ         â”‚  â”‚   åœ°ç†å›´æ æœåŠ¡         â”‚
    â”‚ UserHomeLocationServiceâ”‚  â”‚  SpendingContextAnalysisâ”‚  â”‚ GeofenceBudgetAlert    â”‚
    â”‚                        â”‚  â”‚                        â”‚  â”‚                        â”‚
    â”‚  â€¢ å®¶åº­ä½ç½®æ£€æµ‹        â”‚  â”‚  â€¢ nearHome å®¶é™„è¿‘     â”‚  â”‚  â€¢ å•†åœˆå›´æ             â”‚
    â”‚  â€¢ å…¬å¸ä½ç½®æ£€æµ‹        â”‚  â”‚  â€¢ nearWork å…¬å¸é™„è¿‘   â”‚  â”‚  â€¢ é«˜æ¶ˆè´¹åŒºåŸŸå›´æ       â”‚
    â”‚  â€¢ é€šå‹¤è·¯å¾„å­¦ä¹         â”‚  â”‚  â€¢ commuting é€šå‹¤      â”‚  â”‚  â€¢ è‡ªå®šä¹‰å›´æ           â”‚
    â”‚                        â”‚  â”‚  â€¢ commercial å•†åœˆ     â”‚  â”‚  â€¢ è¿›å…¥/ç¦»å¼€è§¦å‘       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â€¢ travel æ—…è¡Œ         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                â”‚                           â”‚                           â”‚
                â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                â”‚           â”‚                               â”‚           â”‚
                â”‚           â–¼                               â–¼           â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚ å‡ºå·®/æ—…æ¸¸æ£€æµ‹       â”‚     â”‚ é€šå‹¤æ¶ˆè´¹è¿½è¸ª       â”‚  â”‚
                â”‚  â”‚                     â”‚     â”‚                     â”‚  â”‚
                â”‚  â”‚ â€¢ è·ç¦»åˆ¤æ–­(>100km)  â”‚     â”‚ â€¢ æ—¶é—´åˆ¤æ–­          â”‚  â”‚
                â”‚  â”‚ â€¢ å·¥ä½œæ—¥/å‘¨æœ«       â”‚     â”‚ â€¢ è·¯å¾„åˆ¤æ–­          â”‚  â”‚
                â”‚  â”‚ â€¢ POIç±»å‹åŒ¹é…       â”‚     â”‚ â€¢ æ¶ˆè´¹ç±»å‹          â”‚  â”‚
                â””â”€â”€â”¤ â€¢ è¿ç»­å¼‚åœ°å¤©æ•°      â”‚     â”‚                     â”œâ”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                           â”‚
                              â–¼                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                               â”‚
           â”‚              ç²¾ç¡®ä½ç½®å¢å¼ºé’±é¾„è®¡ç®—                              â”‚
           â”‚            PreciseLocationMoneyAgeService                     â”‚
           â”‚                                                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚                  è®¡ç®—ç­–ç•¥                            â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   æ—¥å¸¸æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 1.0              â”‚   â”‚
           â”‚    â”‚   é€šå‹¤æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 1.0              â”‚   â”‚
           â”‚    â”‚   å•†åœˆæ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.9              â”‚   â”‚
           â”‚    â”‚   æ—…æ¸¸æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.3 (åˆ†ç¦»è®¡ç®—)  â”‚   â”‚
           â”‚    â”‚   å‡ºå·®æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.3 (åˆ†ç¦»è®¡ç®—)  â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                              â”‚                               â”‚
           â”‚                              â–¼                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚               è¾“å‡º: PreciseMoneyAge                  â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   â€¢ overall: ç»¼åˆé’±é¾„                                â”‚   â”‚
           â”‚    â”‚   â€¢ daily: æ—¥å¸¸æ¶ˆè´¹é’±é¾„ (æ’é™¤æ—…æ¸¸/å‡ºå·®)             â”‚   â”‚
           â”‚    â”‚   â€¢ byContext: åˆ†åœºæ™¯é’±é¾„                            â”‚   â”‚
           â”‚    â”‚   â€¢ insights: ä½ç½®æ´å¯Ÿå»ºè®®                           â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                                               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                               â”‚
           â”‚              ä½ç½®æ„ŸçŸ¥é›¶åŸºé¢„ç®—                                  â”‚
           â”‚          LocationAwareZeroBudgetService                       â”‚
           â”‚                                                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚              é¢„ç®—åˆ†é…æ¨¡å¼                            â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   å®¶é™„è¿‘æ¶ˆè´¹ â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.95 (ç•¥å¾®æ”¶ç´§)       â”‚   â”‚
           â”‚    â”‚   å·¥ä½œåŒºæ¶ˆè´¹ â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.90 (å¯ä¼˜åŒ–)         â”‚   â”‚
           â”‚    â”‚   é€šå‹¤æ¶ˆè´¹   â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.85 (å¯å¤§å¹…ä¼˜åŒ–)     â”‚   â”‚
           â”‚    â”‚   å•†åœˆæ¶ˆè´¹   â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.80 (ä¸¥æ ¼æ§åˆ¶)       â”‚   â”‚
           â”‚    â”‚   æ—…è¡Œæ¶ˆè´¹   â”€â”€â”€â”€â–º å•ç‹¬é¢„ç®—æ±                         â”‚   â”‚
           â”‚    â”‚   å‚¨è“„       â”€â”€â”€â”€â–º å›ºå®š20%ä¼˜å…ˆåˆ†é…                   â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                              â”‚                               â”‚
           â”‚                              â–¼                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚           ä½ç½®é¢„ç®—æ‰§è¡Œç›‘æ§                           â”‚   â”‚
           â”‚    â”‚       LocationBudgetExecutionMonitor                 â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   â€¢ è®°è´¦æ—¶è‡ªåŠ¨åŒ¹é…ä½ç½®é¢„ç®—                           â”‚   â”‚
           â”‚    â”‚   â€¢ å®æ—¶æ›´æ–°å„åœºæ™¯é¢„ç®—ä½™é¢                           â”‚   â”‚
           â”‚    â”‚   â€¢ ç”Ÿæˆä½ç½®ç»´åº¦æ‰§è¡ŒæŠ¥å‘Š                             â”‚   â”‚
           â”‚    â”‚   â€¢ æ™ºèƒ½å»ºè®®(è¶…æ”¯/æœªåˆ©ç”¨æ´å¯Ÿ)                        â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                                               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.4 åŠŸèƒ½ç‰¹æ€§ä¾èµ–çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | ä¾èµ–çš„æ¨¡å— | è¢«ä¾èµ–çš„æ¨¡å— | æ•°æ®æµå‘ |
|---------|-----------|-------------|---------|
| AIæ™ºèƒ½è¯†åˆ« | æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ | äº¤æ˜“è®°å½•ã€é’±é¾„ã€é¢„ç®— | å…¥å£ â†’ æ ¸å¿ƒ |
| é’±é¾„åˆ†æ | äº¤æ˜“è®°å½•ã€ç²¾ç¡®ä½ç½® | ä¹ æƒ¯åŸ¹å…»ã€ä»ªè¡¨ç›˜ | æ ¸å¿ƒ â†’ å±•ç¤º |
| é›¶åŸºé¢„ç®— | äº¤æ˜“è®°å½•ã€ç²¾ç¡®ä½ç½® | ä¹ æƒ¯åŸ¹å…»ã€é¢„è­¦ | æ ¸å¿ƒ â†’ ç›‘æ§ |
| å°é‡‘åº“ | äº¤æ˜“è®°å½•ã€é¢„ç®— | ä¹ æƒ¯åŸ¹å…»ã€ç»Ÿè®¡ | æ ¸å¿ƒ â†’ å±•ç¤º |
| ç²¾ç¡®ä½ç½® | GPSã€POIæœåŠ¡ | é’±é¾„ã€é¢„ç®—ã€çœé’±å»ºè®® | åº•å±‚ â†’ æ ¸å¿ƒ |
| ä¹ æƒ¯åŸ¹å…» | é’±é¾„ã€é¢„ç®—ã€å°é‡‘åº“ | æˆå°±ç³»ç»Ÿã€ä»»åŠ¡æ¨è | æ ¸å¿ƒ â†’ æ¿€åŠ± |
| æ•°æ®å¯è§†åŒ– | æ‰€æœ‰ä¸šåŠ¡æ•°æ® | ç”¨æˆ·ç•Œé¢ | æ ¸å¿ƒ â†’ å±•ç¤º |

### 3.3 åŠŸèƒ½ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§ | åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|------|
| P0 | åŸºç¡€è®°è´¦ | âœ… å·²æœ‰ | æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€ä¼˜åŒ–ä½“éªŒ |
| P0 | è´¦æˆ·ç®¡ç† | âœ… å·²æœ‰ | æ”¯æŒå¤šè´¦æˆ·ã€ä¿¡ç”¨å¡ |
| P0 | åˆ†ç±»ç®¡ç† | âœ… å·²æœ‰ | æ”¯æŒè‡ªå®šä¹‰åˆ†ç±» |
| P0 | ç»Ÿè®¡å›¾è¡¨ | âœ… å·²æœ‰ | éœ€å¢å¼ºäº¤äº’èƒ½åŠ› |
| P1 | é’±é¾„åˆ†æ | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ |
| P1 | é›¶åŸºé¢„ç®— | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ |
| P1 | å°é‡‘åº“ç³»ç»Ÿ | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ |
| P1 | æ•°æ®è”åŠ¨ | ğŸ†• æ–°å¢ | å¢å¼ºäº¤äº’ä½“éªŒ |
| P2 | AIè¯­éŸ³è¯†åˆ« | âœ… å·²æœ‰ | éœ€ä¼˜åŒ–å‡†ç¡®ç‡ |
| P2 | AIå›¾åƒè¯†åˆ« | âœ… å·²æœ‰ | éœ€ä¼˜åŒ–å‡†ç¡®ç‡ |
| P2 | æ™ºèƒ½å¯¼å…¥ | ğŸ”„ å‡çº§ | å¢åŠ å»é‡èƒ½åŠ› |
| P2 | åœ°ç†ä½ç½®æ™ºèƒ½ | ğŸ†• æ–°å¢ | æ¶ˆè´¹åœºæ™¯è¯†åˆ«ã€ä½ç½®é’±é¾„å¢å¼ºï¼ˆç¬¬11ç« ï¼‰ |
| P3 | å®¶åº­å…±äº« | ğŸ“‹ è§„åˆ’ | åç»­ç‰ˆæœ¬ |
| P3 | æ™ºèƒ½æŠ•èµ„å»ºè®® | ğŸ“‹ è§„åˆ’ | åç»­ç‰ˆæœ¬ |

### 3.4 æ•°æ®æ¨¡å‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ ¸å¿ƒæ•°æ®æ¨¡å‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ç”¨æˆ·æ•°æ®                    è´¢åŠ¡æ•°æ®                    åˆ†ææ•°æ®   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  User   â”‚                â”‚ Account â”‚                â”‚MoneyAge â”‚ â”‚
â”‚  â”‚ Profile â”‚                â”‚ è´¦æˆ·    â”‚                â”‚ é’±é¾„    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚                          â”‚                          â”‚      â”‚
â”‚       â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                    â”‚      â”‚
â”‚       â”‚                    â”‚           â”‚                    â”‚      â”‚
â”‚       â–¼               â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”               â–¼      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚Transactionâ”‚ â”‚CreditCardâ”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚Settings â”‚          â”‚  äº¤æ˜“    â”‚ â”‚  ä¿¡ç”¨å¡  â”‚         â”‚ Report  â”‚â”‚
â”‚  â”‚ è®¾ç½®    â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  æŠ¥å‘Š   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                            â”‚                                       â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚               â”‚            â”‚            â”‚                          â”‚
â”‚          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                     â”‚
â”‚          â”‚Categoryâ”‚   â”‚  Budget â”‚  â”‚  Vault  â”‚                     â”‚
â”‚          â”‚ åˆ†ç±»   â”‚   â”‚  é¢„ç®—   â”‚  â”‚ å°é‡‘åº“  â”‚                     â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ

### 4.1 é’±é¾„æ¦‚å¿µè¯´æ˜

**é’±é¾„ï¼ˆMoney Ageï¼‰** æ˜¯ä¸€ä¸ªåˆ›æ–°çš„è´¢åŠ¡å¥åº·æŒ‡æ ‡ï¼Œè¡¨ç¤ºæ‚¨èŠ±æ‰çš„æ¯ä¸€åˆ†é’±ï¼Œæ˜¯å¤šå°‘å¤©å‰èµšåˆ°çš„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„è®¡ç®—ç¤ºä¾‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   1æœˆ1æ—¥æ”¶å…¥ Â¥10,000                                               â”‚
â”‚        â†“                                                           â”‚
â”‚   1æœˆ15æ—¥æ”¯å‡º Â¥2,000 â†’ é’±é¾„ = 14å¤© (ä½¿ç”¨1æœˆ1æ—¥çš„æ”¶å…¥)              â”‚
â”‚        â†“                                                           â”‚
â”‚   1æœˆ20æ—¥æ”¯å‡º Â¥3,000 â†’ é’±é¾„ = 19å¤© (ä½¿ç”¨1æœˆ1æ—¥çš„æ”¶å…¥)              â”‚
â”‚        â†“                                                           â”‚
â”‚   2æœˆ1æ—¥æ”¶å…¥ Â¥12,000                                               â”‚
â”‚        â†“                                                           â”‚
â”‚   2æœˆ5æ—¥æ”¯å‡º Â¥8,000 â†’ é’±é¾„ = 35å¤© (éƒ¨åˆ†ä½¿ç”¨1æœˆ1æ—¥ã€éƒ¨åˆ†2æœˆ1æ—¥)     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é’±é¾„å¥åº·ç­‰çº§

| ç­‰çº§ | é’±é¾„èŒƒå›´ | çŠ¶æ€ | å«ä¹‰ |
|------|----------|------|------|
| ğŸ”´ å±é™© | < 7å¤© | æœˆå…‰æ— | æ”¶å…¥å³èŠ±ï¼Œæ²¡æœ‰ç¼“å†² |
| ğŸŸ  è­¦å‘Š | 7-14å¤© | ç´§å¼  | åˆšè¿‡æ‰‹çš„é’±å°±èŠ±æ‰ |
| ğŸŸ¡ ä¸€èˆ¬ | 14-30å¤© | åŠæ ¼ | æœ‰åŸºæœ¬çš„èµ„é‡‘ç¼“å†² |
| ğŸŸ¢ è‰¯å¥½ | 30-60å¤© | å¥åº· | æœ‰ä¸€ä¸ªæœˆä»¥ä¸Šç¼“å†² |
| ğŸ”µ ä¼˜ç§€ | 60-90å¤© | ä¼˜ç§€ | è´¢åŠ¡çŠ¶å†µéå¸¸ç¨³å¥ |
| ğŸ’ ç†æƒ³ | > 90å¤© | è´¢åŠ¡è‡ªç”± | å¯åº”å¯¹å„ç§æ„å¤– |

### 4.3 é’±é¾„è®¡ç®—å¼•æ“

#### 4.3.1 FIFOèµ„æºæ± æ¨¡å‹

```dart
/// èµ„æºæ±  - è¿½è¸ªæ¯ç¬”æ”¶å…¥çš„ä½¿ç”¨æƒ…å†µ
class ResourcePool {
  final String id;
  final String incomeTransactionId;  // å…³è”çš„æ”¶å…¥äº¤æ˜“
  final DateTime createdAt;           // èµ„é‡‘è¿›å…¥æ—¶é—´
  final double originalAmount;        // åŸå§‹é‡‘é¢
  double remainingAmount;             // å‰©ä½™é‡‘é¢

  /// è®¡ç®—å½“å‰é’±é¾„ï¼ˆå¤©ï¼‰
  int get ageInDays => DateTime.now().difference(createdAt).inDays;

  /// ä½¿ç”¨èµ„é‡‘
  ResourceConsumption consume(double amount, String transactionId) {
    final consumed = min(amount, remainingAmount);
    remainingAmount -= consumed;
    return ResourceConsumption(
      poolId: id,
      amount: consumed,
      ageAtConsumption: ageInDays,
      transactionId: transactionId,
    );
  }
}

/// é’±é¾„è®¡ç®—æœåŠ¡
class MoneyAgeCalculator {
  final List<ResourcePool> pools = [];

  /// å¤„ç†æ”¶å…¥ï¼šåˆ›å»ºæ–°çš„èµ„æºæ± 
  void processIncome(Transaction income) {
    pools.add(ResourcePool(
      id: generateId(),
      incomeTransactionId: income.id,
      createdAt: income.date,
      originalAmount: income.amount,
      remainingAmount: income.amount,
    ));
    // æŒ‰æ—¶é—´æ’åºï¼Œç¡®ä¿FIFO
    pools.sort((a, b) => a.createdAt.compareTo(b.createdAt));
  }

  /// å¤„ç†æ”¯å‡ºï¼šæŒ‰FIFOæ¶ˆè€—èµ„æºæ± 
  MoneyAgeResult processExpense(Transaction expense) {
    final consumptions = <ResourceConsumption>[];
    var remaining = expense.amount;

    for (final pool in pools) {
      if (remaining <= 0) break;
      if (pool.remainingAmount <= 0) continue;

      final consumption = pool.consume(remaining, expense.id);
      consumptions.add(consumption);
      remaining -= consumption.amount;
    }

    // è®¡ç®—åŠ æƒå¹³å‡é’±é¾„
    final totalAmount = consumptions.fold(0.0, (sum, c) => sum + c.amount);
    final weightedAge = consumptions.fold(0.0,
      (sum, c) => sum + c.amount * c.ageAtConsumption
    ) / totalAmount;

    return MoneyAgeResult(
      transactionId: expense.id,
      moneyAge: weightedAge.round(),
      consumptions: consumptions,
    );
  }
}

/// å•ç¬”æ¶ˆè´¹çš„é’±é¾„è®¡ç®—ç»“æœ
class MoneyAgeResult {
  /// äº¤æ˜“ID
  final String transactionId;

  /// è¯¥ç¬”æ¶ˆè´¹çš„é’±é¾„ï¼ˆå¤©ï¼‰
  final int moneyAge;

  /// èµ„æºæ¶ˆè€—è¯¦æƒ…
  final List<ResourceConsumption> consumptions;

  /// æ˜¯å¦æœ‰æœªè¦†ç›–é‡‘é¢ï¼ˆèµ„æºä¸è¶³ï¼‰
  bool get hasUncovered => consumptions.any((c) => c.uncoveredAmount > 0);
}

/// é’±é¾„æ ¸å¿ƒæ¨¡å‹ï¼ˆç”¨äºå±•ç¤ºå’Œè®¡ç®—ï¼‰
class MoneyAge {
  /// é’±é¾„å¤©æ•°
  final int days;

  /// é’±é¾„è¿›é˜¶æœåŠ¡å¼•ç”¨ï¼ˆç”¨äºè®¡ç®—stageï¼‰
  static final _progressionService = MoneyAgeProgressionService();

  /// é’±é¾„æè¿°
  String get description {
    if (days >= 30) return 'èµ„é‡‘å‘¨è½¬éå¸¸å¥åº·';
    if (days >= 14) return 'èµ„é‡‘å‘¨è½¬è¾ƒå¥½';
    if (days >= 7) return 'å»ºè®®å¢åŠ å‚¨è“„ç¼“å†²';
    return 'å¯èƒ½åœ¨èŠ±è´¹åˆšæ”¶åˆ°çš„é’±';
  }

  /// å¥åº·ç­‰çº§
  MoneyAgeLevel get level {
    if (days < 7) return MoneyAgeLevel.danger;
    if (days < 14) return MoneyAgeLevel.warning;
    if (days < 30) return MoneyAgeLevel.normal;
    if (days < 60) return MoneyAgeLevel.good;
    if (days < 90) return MoneyAgeLevel.excellent;
    return MoneyAgeLevel.ideal;
  }

  /// æ˜¯å¦å¥åº·
  bool get isHealthy => days >= 14;

  /// å½“å‰é’±é¾„é˜¶æ®µï¼ˆå…³è” MoneyAgeProgressionServiceï¼‰
  MoneyAgeStage get stage => _progressionService.getCurrentStage(days);

  /// ä¸‹ä¸€é˜¶æ®µç›®æ ‡ï¼ˆå¯èƒ½ä¸ºnullï¼Œè¡¨ç¤ºå·²è¾¾æœ€é«˜é˜¶æ®µï¼‰
  MoneyAgeStage? get nextStage => _progressionService.getNextStage(days);

  const MoneyAge({required this.days});

  factory MoneyAge.fromResult(MoneyAgeResult result) {
    return MoneyAge(days: result.moneyAge);
  }
}

/// é’±é¾„å¥åº·ç­‰çº§
enum MoneyAgeLevel {
  danger,     // < 7å¤©ï¼Œå±é™©
  warning,    // 7-14å¤©ï¼Œè­¦å‘Š
  normal,     // 14-30å¤©ï¼Œæ­£å¸¸
  good,       // 30-60å¤©ï¼Œè‰¯å¥½
  excellent,  // 60-90å¤©ï¼Œä¼˜ç§€
  ideal,      // > 90å¤©ï¼Œç†æƒ³

  Color get color {
    switch (this) {
      case danger: return Colors.red;
      case warning: return Colors.orange;
      case normal: return Colors.yellow;
      case good: return Colors.lightGreen;
      case excellent: return Colors.green;
      case ideal: return Colors.teal;
    }
  }
}
```

#### 4.3.2 é’±é¾„ç»Ÿè®¡æ±‡æ€»

```dart
/// é’±é¾„ç»Ÿè®¡æ±‡æ€»
class MoneyAgeStatistics {
  /// å½“å‰å¹³å‡é’±é¾„
  final int averageAge;

  /// é’±é¾„è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰
  final List<DailyMoneyAge> trend;

  /// æŒ‰åˆ†ç±»çš„é’±é¾„åˆ†å¸ƒ
  final Map<String, int> ageByCategory;

  /// å¥åº·ç­‰çº§ï¼ˆé˜ˆå€¼ä¸ MoneyAge.level ä¿æŒä¸€è‡´ï¼‰
  MoneyAgeLevel get healthLevel {
    if (averageAge < 7) return MoneyAgeLevel.danger;
    if (averageAge < 14) return MoneyAgeLevel.warning;  // ç»Ÿä¸€ä½¿ç”¨14ï¼Œä¸MoneyAgeä¸€è‡´
    if (averageAge < 30) return MoneyAgeLevel.normal;
    if (averageAge < 60) return MoneyAgeLevel.good;
    if (averageAge < 90) return MoneyAgeLevel.excellent;
    return MoneyAgeLevel.ideal;
  }

  /// æ”¹å–„å»ºè®®
  List<String> get suggestions {
    switch (healthLevel) {
      case MoneyAgeLevel.danger:
        return [
          'å»ºè®®è®¾ç½®ç´§æ€¥å‚¨å¤‡é‡‘ç›®æ ‡',
          'æ£€æŸ¥æ˜¯å¦æœ‰å¯å‰Šå‡çš„éå¿…è¦æ”¯å‡º',
          'è€ƒè™‘å¢åŠ æ”¶å…¥æ¥æº',
        ];
      case MoneyAgeLevel.warning:
        return [
          'ç»§ç»­ä¿æŒå‚¨è“„ä¹ æƒ¯',
          'é¿å…å¤§é¢å†²åŠ¨æ¶ˆè´¹',
          'ä¸ºä¸‹ä¸ªæœˆçš„å¤§é¢æ”¯å‡ºæå‰è§„åˆ’',
        ];
      // ... å…¶ä»–ç­‰çº§
    }
  }
}
```

### 4.4 é’±é¾„å¯è§†åŒ–ç»„ä»¶

#### 4.4.1 é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡

```dart
/// é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡
class MoneyAgeDashboardCard extends StatelessWidget {
  final MoneyAgeStatistics stats;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: () => Navigator.pushNamed(context, '/money-age'),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // æ ‡é¢˜è¡Œ
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text('é’±é¾„', style: Theme.of(context).textTheme.titleMedium),
                  _buildHealthBadge(stats.healthLevel),
                ],
              ),
              SizedBox(height: 16),

              // æ ¸å¿ƒæ•°å­—
              Row(
                crossAxisAlignment: CrossAxisAlignment.baseline,
                textBaseline: TextBaseline.alphabetic,
                children: [
                  Text(
                    '${stats.averageAge}',
                    style: TextStyle(
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: stats.healthLevel.color,
                    ),
                  ),
                  Text(' å¤©', style: TextStyle(fontSize: 16)),
                ],
              ),

              // è¶‹åŠ¿è¿·ä½ å›¾
              SizedBox(height: 16),
              MoneyAgeTrendMiniChart(data: stats.trend),

              // ç‚¹å‡»æç¤º
              SizedBox(height: 8),
              Text(
                'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’',
                style: TextStyle(color: Colors.grey, fontSize: 12),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 4.4.2 é’±é¾„è¶‹åŠ¿å›¾

```dart
/// é’±é¾„è¶‹åŠ¿å›¾ï¼ˆæ”¯æŒä¸‹é’»ï¼‰
class MoneyAgeTrendChart extends StatelessWidget {
  final List<DailyMoneyAge> data;
  final Function(DateTime date)? onDateTap;

  @override
  Widget build(BuildContext context) {
    return LineChart(
      LineChartData(
        lineBarsData: [
          LineChartBarData(
            spots: data.asMap().entries.map((e) =>
              FlSpot(e.key.toDouble(), e.value.averageAge.toDouble())
            ).toList(),
            isCurved: true,
            color: Theme.of(context).primaryColor,
            belowBarData: BarAreaData(
              show: true,
              color: Theme.of(context).primaryColor.withOpacity(0.1),
            ),
          ),
        ],
        lineTouchData: LineTouchData(
          touchCallback: (event, response) {
            if (event is FlTapUpEvent && response?.lineBarSpots != null) {
              final index = response!.lineBarSpots!.first.spotIndex;
              onDateTap?.call(data[index].date);
            }
          },
          touchTooltipData: LineTouchTooltipData(
            getTooltipItems: (spots) => spots.map((spot) {
              final item = data[spot.spotIndex];
              return LineTooltipItem(
                '${item.date.format("MM/dd")}\n${item.averageAge}å¤©',
                TextStyle(color: Colors.white),
              );
            }).toList(),
          ),
        ),
        // ... å…¶ä»–å›¾è¡¨é…ç½®
      ),
    );
  }
}
```

### 4.5 é’±é¾„å½±å“å› ç´ åˆ†æ

```dart
/// é’±é¾„å½±å“å› ç´ 
enum MoneyAgeInfluence {
  /// å¤§é¢æ”¯å‡º - å¿«é€Ÿæ¶ˆè€—è€èµ„é‡‘
  largeExpense,

  /// æ”¶å…¥å»¶è¿Ÿ - ç­‰å¾…æ–°èµ„é‡‘è¡¥å……
  delayedIncome,

  /// æŒç»­å‚¨è“„ - è€èµ„é‡‘ç§¯ç´¯
  consistentSaving,

  /// æ„å¤–æ”¯å‡º - æ‰“æ–­å‚¨è“„è®¡åˆ’
  unexpectedExpense,

  /// æ”¶å…¥å¢åŠ  - æ›´å¤šèµ„é‡‘å¯ç”¨
  incomeIncrease,
}

/// å½±å“å› ç´ åˆ†æç»“æœ
class InfluenceAnalysis {
  final MoneyAgeInfluence influence;
  final double impact;  // å¯¹é’±é¾„çš„å½±å“å¤©æ•° (+/-)
  final String description;
  final List<Transaction> relatedTransactions;

  /// ç”Ÿæˆè‡ªç„¶è¯­è¨€æè¿°
  String get narrativeDescription {
    switch (influence) {
      case MoneyAgeInfluence.largeExpense:
        return 'æœ¬æœˆæœ‰ä¸€ç¬”å¤§é¢æ”¯å‡º(${relatedTransactions.first.categoryName})'
               'æ¶ˆè€—äº†è¾ƒå¤šè€èµ„é‡‘ï¼Œå¯¼è‡´é’±é¾„é™ä½çº¦${impact.abs().toStringAsFixed(0)}å¤©';
      case MoneyAgeInfluence.consistentSaving:
        return 'æ‚¨æŒç»­ä¿æŒå‚¨è“„ä¹ æƒ¯ï¼Œ'
               'ä½¿å¾—å¹³å‡é’±é¾„å¢åŠ äº†${impact.toStringAsFixed(0)}å¤©';
      // ... å…¶ä»–æƒ…å†µ
    }
  }
}
```

### 4.6 é’±é¾„æ¨¡å‹å±‚æ¬¡ç»“æ„

ä¸ºé¿å…é‡å¤å®šä¹‰ï¼Œé’±é¾„ç³»ç»Ÿé‡‡ç”¨ä»¥ä¸‹ç»Ÿä¸€çš„ç±»å±‚æ¬¡ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„æ¨¡å‹å±‚æ¬¡ç»“æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  åŸºç¡€å±‚ï¼ˆç¬¬4ç« å®šä¹‰ï¼Œå…¨å±€ç»Ÿä¸€ï¼‰                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MoneyAge               åŸºç¡€é’±é¾„æ¨¡å‹ï¼ˆdays, description, levelï¼‰     â”‚   â”‚
â”‚  â”‚  MoneyAgeResult         å•ç¬”æ¶ˆè´¹è®¡ç®—ç»“æœï¼ˆtransactionId, moneyAgeï¼‰  â”‚   â”‚
â”‚  â”‚  MoneyAgeStatistics     ç»Ÿè®¡æ±‡æ€»ï¼ˆaverageAge, trend, ageByCategoryï¼‰ â”‚   â”‚
â”‚  â”‚  MoneyAgeLevel          å¥åº·ç­‰çº§æšä¸¾ï¼ˆdanger â†’ idealï¼‰               â”‚   â”‚
â”‚  â”‚  MoneyAgeCalculator     åŸºç¡€è®¡ç®—æœåŠ¡ï¼ˆFIFOèµ„æºæ± æ¨¡å‹ï¼‰               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚  æ‰©å±•å±‚ï¼ˆç¬¬11ç« ï¼Œä½ç½®å¢å¼ºï¼‰                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  EnhancedMoneyAge       å¢å¼ºé’±é¾„ï¼ˆoverall + daily + temporaryï¼‰      â”‚   â”‚
â”‚  â”‚    â””â”€â”€ ç»§æ‰¿è‡ª MoneyAgeï¼ŒåŒºåˆ†æ—¥å¸¸æ¶ˆè´¹å’Œä¸´æ—¶æ¶ˆè´¹ï¼ˆå‡ºå·®/æ—…æ¸¸ï¼‰           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  PreciseMoneyAge        ç²¾ç¡®ä½ç½®é’±é¾„ï¼ˆbyContextåˆ†åœºæ™¯ï¼‰               â”‚   â”‚
â”‚  â”‚    â””â”€â”€ ç»§æ‰¿è‡ª EnhancedMoneyAgeï¼Œå¢åŠ ä½ç½®åœºæ™¯ç»´åº¦                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  LocationAwareMoneyAgeService                                        â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è£…é¥° MoneyAgeCalculatorï¼Œæ·»åŠ ä½ç½®æ„ŸçŸ¥èƒ½åŠ›                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚  å®¹é”™å±‚ï¼ˆç¬¬18ç« ï¼Œå¼‚å¸¸å¤„ç†ï¼‰                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RobustMoneyAgeCalculator                                            â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è£…é¥° MoneyAgeCalculatorï¼Œæ·»åŠ å¼‚å¸¸å¤„ç†ã€é‡è¯•ã€é™çº§ç­–ç•¥          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç±»ç»§æ‰¿å…³ç³»ï¼š
  MoneyAge (base)
    â””â”€â”€ EnhancedMoneyAge (+ daily, temporary)
          â””â”€â”€ PreciseMoneyAge (+ byContext, insights)

æœåŠ¡è£…é¥°å…³ç³»ï¼š
  MoneyAgeCalculator (base)
    â””â”€â”€ LocationAwareMoneyAgeService (+ ä½ç½®æ„ŸçŸ¥)
          â””â”€â”€ RobustMoneyAgeCalculator (+ å¼‚å¸¸å¤„ç†)
```

### 4.7 é’±é¾„ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

```dart
/// é’±é¾„ç³»ç»Ÿé›†æˆæ¥å£
abstract class MoneyAgeIntegration {
  /// è·å–å½“å‰é’±é¾„
  Future<MoneyAge> getCurrentMoneyAge();

  /// è·å–é’±é¾„ç»Ÿè®¡
  Future<MoneyAgeStatistics> getStatistics();

  /// è·å–å¢å¼ºé’±é¾„ï¼ˆä½ç½®æ„ŸçŸ¥ï¼‰
  Future<EnhancedMoneyAge> getEnhancedMoneyAge();
}

/// é’±é¾„ä¸é›¶åŸºé¢„ç®—çš„é›†æˆ
class MoneyAgeBudgetIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final BudgetService _budgetService;

  /// æ ¹æ®é’±é¾„è°ƒæ•´é¢„ç®—å»ºè®®
  Future<BudgetAdjustment> suggestBudgetAdjustment() async {
    final moneyAge = await _moneyAgeCalc.getCurrentMoneyAge();

    if (moneyAge.level == MoneyAgeLevel.danger) {
      // é’±é¾„å±é™©ï¼šå»ºè®®å¢åŠ å‚¨è“„é¢„ç®—
      return BudgetAdjustment(
        type: AdjustmentType.increaseSavings,
        suggestedAmount: await _calculateSavingsGap(),
        reason: 'å½“å‰é’±é¾„${moneyAge.days}å¤©ï¼Œå»ºè®®å¢åŠ å‚¨è“„ä»¥æé«˜è´¢åŠ¡å®‰å…¨æ€§',
      );
    }

    return BudgetAdjustment.noChange();
  }

  /// é¢„ç®—æ‰§è¡Œå¯¹é’±é¾„çš„å½±å“é¢„æµ‹
  Future<MoneyAgeImpact> predictMoneyAgeImpact(Budget budget) async {
    // æ¨¡æ‹Ÿé¢„ç®—æ‰§è¡Œåçš„é’±é¾„å˜åŒ–
    final currentAge = await _moneyAgeCalc.getCurrentMoneyAge();
    final projectedAge = _simulateMoneyAge(budget);

    return MoneyAgeImpact(
      currentDays: currentAge.days,
      projectedDays: projectedAge.days,
      change: projectedAge.days - currentAge.days,
    );
  }
}

/// é’±é¾„ä¸å°é‡‘åº“çš„é›†æˆ
class MoneyAgeVaultIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final VaultService _vaultService;

  /// æ ¹æ®é’±é¾„æ¨èå‚¨è“„é‡‘é¢
  Future<SavingsRecommendation> recommendSavings() async {
    final moneyAge = await _moneyAgeCalc.getCurrentMoneyAge();
    final targetDays = 30; // ç›®æ ‡é’±é¾„30å¤©

    if (moneyAge.days < targetDays) {
      final gap = targetDays - moneyAge.days;
      final dailySpending = await _calculateAverageDailySpending();
      final recommendedSavings = gap * dailySpending;

      return SavingsRecommendation(
        amount: recommendedSavings,
        reason: 'ä¸ºè¾¾åˆ°${targetDays}å¤©å¥åº·é’±é¾„ï¼Œå»ºè®®å‚¨è“„Â¥${recommendedSavings.toStringAsFixed(0)}',
        suggestedVault: await _findBestVault(recommendedSavings),
      );
    }

    return SavingsRecommendation.sufficient();
  }

  /// å°é‡‘åº“åˆ†é…å¯¹é’±é¾„çš„å½±å“
  Future<VaultAllocationImpact> analyzeVaultAllocationImpact(
    double amount,
    BudgetVault vault,
  ) async {
    final currentAge = await _moneyAgeCalc.getCurrentMoneyAge();
    // å°é‡‘åº“åˆ†é…ä¼šå‡å°‘å¯ç”¨èµ„é‡‘ï¼Œä½†æé«˜äº†è´¢åŠ¡å®‰å…¨æ€§
    final impactDays = (amount / await _calculateAverageDailySpending()).round();

    return VaultAllocationImpact(
      shortTermImpact: -impactDays, // çŸ­æœŸé’±é¾„ä¸‹é™
      longTermBenefit: impactDays * 2, // é•¿æœŸæ”¶ç›Šï¼ˆå‚¨è“„å¢åŠ ï¼‰
      recommendation: impactDays < 3
          ? 'æ­¤åˆ†é…å¯¹é’±é¾„å½±å“è¾ƒå°ï¼Œå»ºè®®æ‰§è¡Œ'
          : 'æ­¤åˆ†é…ä¼šæš‚æ—¶é™ä½é’±é¾„${impactDays}å¤©ï¼Œè¯·ç¡®è®¤',
    );
  }
}

/// é’±é¾„ä¸ä¹ æƒ¯åŸ¹å…»çš„é›†æˆ
class MoneyAgeHabitIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final HabitService _habitService;

  /// ç”Ÿæˆé’±é¾„ç›¸å…³ä»»åŠ¡
  Future<List<HabitTask>> generateMoneyAgeTasks() async {
    final stats = await _moneyAgeCalc.getStatistics();
    final tasks = <HabitTask>[];

    // æ ¹æ®é’±é¾„çŠ¶æ€ç”Ÿæˆä»»åŠ¡
    if (stats.healthLevel == MoneyAgeLevel.danger) {
      tasks.add(HabitTask(
        id: 'improve_money_age',
        title: 'æé«˜é’±é¾„æŒ‘æˆ˜',
        description: 'æœ¬å‘¨å‡å°‘éå¿…è¦æ”¯å‡ºï¼Œç›®æ ‡ï¼šé’±é¾„æå‡5å¤©',
        reward: 50,
        duration: Duration(days: 7),
      ));
    }

    // é’±é¾„ç¨³å®šåçš„ç»´æŒä»»åŠ¡
    if (stats.healthLevel.index >= MoneyAgeLevel.good.index) {
      tasks.add(HabitTask(
        id: 'maintain_money_age',
        title: 'ä¿æŒå¥åº·é’±é¾„',
        description: 'ç»§ç»­ä¿æŒè‰¯å¥½çš„æ¶ˆè´¹ä¹ æƒ¯',
        reward: 30,
        duration: Duration(days: 30),
      ));
    }

    return tasks;
  }

  /// è®¡ç®—é’±é¾„æ”¹å–„å¯¹æˆå°±çš„è´¡çŒ®
  Future<AchievementProgress> calculateAchievementProgress() async {
    final stats = await _moneyAgeCalc.getStatistics();

    return AchievementProgress(
      achievementId: 'money_age_master',
      currentValue: stats.averageAge,
      targetValue: 60, // ç›®æ ‡60å¤©
      percentage: (stats.averageAge / 60).clamp(0.0, 1.0),
    );
  }
}
```

---

## 5. é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ

### 5.0 é¢„ç®—æœåŠ¡æ¶æ„

ä¸ºé¿å…é¢„ç®—ç›¸å…³æœåŠ¡ç±»èŒè´£æ··æ·†ï¼Œæœ¬èŠ‚è¯´æ˜é¢„ç®—æœåŠ¡çš„å±‚æ¬¡ç»“æ„å’Œå„è‡ªèŒè´£ã€‚

#### 5.0.1 é¢„ç®—æœåŠ¡å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é¢„ç®—æœåŠ¡å±‚æ¬¡ç»“æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬1å±‚ï¼šé¢„ç®—åŸºç¡€æœåŠ¡ï¼ˆCRUDæ“ä½œï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  BudgetRepository          â† é¢„ç®—æ•°æ®å­˜å‚¨ï¼ˆå·²æœ‰ï¼‰             â”‚ â”‚
â”‚  â”‚  BudgetVaultRepository     â† å°é‡‘åº“æ•°æ®å­˜å‚¨ï¼ˆå·²æœ‰ï¼‰           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬2å±‚ï¼šé¢„ç®—åˆ†é…æœåŠ¡ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰                            â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  BudgetAllocationService   â† æ”¶å…¥åˆ†é…åˆ°å°é‡‘åº“ï¼ˆ18.3ç« ï¼‰       â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šæ‰§è¡Œæ”¶å…¥â†’å°é‡‘åº“çš„åˆ†é…ï¼Œå¤„ç†åˆ†é…å¼‚å¸¸                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬3å±‚ï¼šé¢„ç®—å»ºè®®æœåŠ¡ï¼ˆæ™ºèƒ½æ¨èï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  SmartBudgetService                                          â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºå†å²æ¶ˆè´¹ç»Ÿè®¡çš„é¢„ç®—å»ºè®®ï¼ˆ10.3ç« ï¼‰               â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼š3ä¸ªæœˆå†å²æ¶ˆè´¹                                      â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šç±»ç›®+é‡‘é¢å»ºè®®                                      â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  LocalizedBudgetCategoryService                              â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºåŸå¸‚çº§åˆ«çš„ç±»ç›®æ¨èï¼ˆ11.2ç« ï¼‰                   â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç”¨æˆ·æ‰€åœ¨åŸå¸‚                                       â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šé€‚åˆè¯¥åŸå¸‚çš„é¢„ç®—ç±»ç›®åˆ—è¡¨                           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  LocalizedBudgetAmountService                                â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºåŸå¸‚æ¶ˆè´¹æ°´å¹³çš„é‡‘é¢å»ºè®®ï¼ˆ11.2ç« ï¼‰               â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç±»ç›®+åŸå¸‚+æ”¶å…¥                                     â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šå»ºè®®é‡‘é¢åŠèŒƒå›´                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬4å±‚ï¼šä½ç½®å¢å¼ºé¢„ç®—æœåŠ¡ï¼ˆç²¾ç¡®ä½ç½®ç‰¹æœ‰ï¼‰                        â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationAwareZeroBudgetService                              â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºGPSä½ç½®æ¨¡å¼çš„é¢„ç®—åˆ†é…å»ºè®®ï¼ˆ11.7ç« ï¼‰            â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šå†å²æ¶ˆè´¹+ä½ç½®ä¿¡æ¯                                  â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šåŸºäºä½ç½®åœºæ™¯çš„åˆ†é…å»ºè®®                             â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  GeofenceBudgetAlertService                                  â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåœ°ç†å›´æ é¢„ç®—æé†’ï¼ˆ11.7ç« ï¼‰                         â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç”¨æˆ·å®æ—¶ä½ç½®                                       â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šè¿›å…¥é«˜æ¶ˆè´¹åŒºåŸŸæ—¶çš„é¢„ç®—æé†’                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.0.2 æœåŠ¡ä½¿ç”¨åœºæ™¯

| æœåŠ¡åç§° | è§¦å‘æ—¶æœº | ç”¨æˆ·åœºæ™¯ |
|---------|----------|----------|
| **BudgetAllocationService** | æ”¶å…¥å…¥è´¦æ—¶ | è‡ªåŠ¨/æ‰‹åŠ¨å°†å·¥èµ„åˆ†é…åˆ°å„å°é‡‘åº“ |
| **SmartBudgetService** | é¦–æ¬¡è®¾ç½®é¢„ç®— / æœˆåˆè°ƒæ•´ | ç³»ç»ŸåŸºäºæ¶ˆè´¹ä¹ æƒ¯æ¨èé¢„ç®—æ–¹æ¡ˆ |
| **LocalizedBudgetCategoryService** | æ–°ç”¨æˆ·å¼•å¯¼ / æ›´æ¢åŸå¸‚ | æ¨èé€‚åˆå½“åœ°çš„é¢„ç®—ç±»ç›® |
| **LocalizedBudgetAmountService** | è®¾ç½®ç±»ç›®é¢„ç®—æ—¶ | å»ºè®®åˆç†çš„é¢„ç®—é‡‘é¢ |
| **LocationAwareZeroBudgetService** | æœˆåˆé¢„ç®—è§„åˆ’ | ç»“åˆä½ç½®ä¹ æƒ¯ä¼˜åŒ–åˆ†é… |
| **GeofenceBudgetAlertService** | è¿›å…¥å•†åœˆ/é«˜æ¶ˆè´¹åŒºåŸŸ | å®æ—¶æé†’é¢„ç®—å‰©ä½™ |

#### 5.0.3 æœåŠ¡è°ƒç”¨ç¤ºä¾‹

```dart
/// é¢„ç®—è§„åˆ’åè°ƒå™¨ - æ•´åˆå„å±‚é¢„ç®—æœåŠ¡
class BudgetPlanningCoordinator {
  final SmartBudgetService _smartBudget;
  final LocalizedBudgetCategoryService _localizedCategory;
  final LocalizedBudgetAmountService _localizedAmount;
  final LocationAwareZeroBudgetService? _locationAwareBudget;
  final BudgetAllocationService _allocationService;

  /// ç”Ÿæˆå®Œæ•´çš„é¢„ç®—è§„åˆ’å»ºè®®
  Future<CompleteBudgetPlan> generateBudgetPlan({
    required double monthlyIncome,
    required CityLocation? userCity,
    required List<Transaction> historicalTransactions,
    bool useLocationInsights = false,
  }) async {
    // 1. è·å–æœ¬åœ°åŒ–ç±»ç›®æ¨è
    List<RecommendedCategory> categories = [];
    if (userCity != null) {
      categories = _localizedCategory.getRecommendedCategories(userCity);
    }

    // 2. è·å–æ™ºèƒ½é¢„ç®—å»ºè®®ï¼ˆåŸºäºå†å²æ¶ˆè´¹ï¼‰
    final smartSuggestions = await _smartBudget.generateBudgetSuggestions();

    // 3. ä¸ºæ¯ä¸ªç±»ç›®è®¡ç®—æœ¬åœ°åŒ–é‡‘é¢å»ºè®®
    final categoryAmounts = <String, BudgetAmountSuggestion>{};
    for (final category in categories) {
      if (userCity != null) {
        categoryAmounts[category.name] = _localizedAmount.getSuggestedAmount(
          category: category.name,
          location: userCity,
          monthlyIncome: monthlyIncome,
        );
      }
    }

    // 4. å¯é€‰ï¼šç»“åˆä½ç½®æ´å¯Ÿä¼˜åŒ–
    LocationBasedBudgetSuggestion? locationInsights;
    if (useLocationInsights && _locationAwareBudget != null) {
      locationInsights = await _locationAwareBudget!.suggestBudgetAllocation(
        monthlyIncome: monthlyIncome,
        historicalTransactions: historicalTransactions,
      );
    }

    // 5. ç»¼åˆç”Ÿæˆæœ€ç»ˆå»ºè®®
    return CompleteBudgetPlan(
      categories: categories,
      smartSuggestions: smartSuggestions,
      categoryAmounts: categoryAmounts,
      locationInsights: locationInsights,
      totalIncome: monthlyIncome,
    );
  }
}

/// å®Œæ•´çš„é¢„ç®—è§„åˆ’ç»“æœ
class CompleteBudgetPlan {
  final List<RecommendedCategory> categories;
  final List<BudgetSuggestion> smartSuggestions;
  final Map<String, BudgetAmountSuggestion> categoryAmounts;
  final LocationBasedBudgetSuggestion? locationInsights;
  final double totalIncome;

  const CompleteBudgetPlan({
    required this.categories,
    required this.smartSuggestions,
    required this.categoryAmounts,
    this.locationInsights,
    required this.totalIncome,
  });

  /// è·å–æŸç±»ç›®çš„æœ€ç»ˆå»ºè®®é‡‘é¢
  /// ç»¼åˆè€ƒè™‘ï¼šæ™ºèƒ½å»ºè®® > æœ¬åœ°åŒ–é‡‘é¢ > ç±»ç›®é»˜è®¤å æ¯”
  double getSuggestedAmountForCategory(String categoryName) {
    // ä¼˜å…ˆä½¿ç”¨æ™ºèƒ½å»ºè®®ï¼ˆåŸºäºç”¨æˆ·å®é™…æ¶ˆè´¹ï¼‰
    final smart = smartSuggestions.firstWhere(
      (s) => s.categoryId == categoryName,
      orElse: () => BudgetSuggestion.empty(),
    );
    if (smart.amount > 0) return smart.amount;

    // å…¶æ¬¡ä½¿ç”¨æœ¬åœ°åŒ–é‡‘é¢å»ºè®®
    final localized = categoryAmounts[categoryName];
    if (localized != null) return localized.suggestedAmount;

    // æœ€åä½¿ç”¨ç±»ç›®é»˜è®¤å æ¯”
    final category = categories.firstWhere(
      (c) => c.name == categoryName,
      orElse: () => RecommendedCategory.empty(),
    );
    return totalIncome * category.suggestedPercentage;
  }
}
```

### 5.1 é›¶åŸºé¢„ç®—ç†å¿µ

**é›¶åŸºé¢„ç®—ï¼ˆZero-Based Budgetingï¼‰** çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼šè®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®çš„ç”¨é€”ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é›¶åŸºé¢„ç®—å·¥ä½œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   Step 1: æ”¶å…¥è¿›è´¦                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   â”‚  æœ¬æœˆå·¥èµ„       â”‚                                               â”‚
â”‚   â”‚  Â¥15,000       â”‚                                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚           â”‚                                                        â”‚
â”‚           â–¼                                                        â”‚
â”‚   Step 2: åˆ†é…åˆ°å°é‡‘åº“                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚æˆ¿ç§Ÿ    â”‚ â”‚é¤é¥®    â”‚ â”‚äº¤é€š    â”‚ â”‚å¨±ä¹    â”‚ â”‚å‚¨è“„    â”‚         â”‚
â”‚   â”‚Â¥4,000  â”‚ â”‚Â¥2,000  â”‚ â”‚Â¥800    â”‚ â”‚Â¥1,000  â”‚ â”‚Â¥5,000  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â†‘          â†‘          â†‘          â†‘          â†‘               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                         å¾…åˆ†é…: Â¥2,200                             â”‚
â”‚                                                                    â”‚
â”‚   Step 3: æ¶ˆè´¹æ—¶ä»å¯¹åº”å°é‡‘åº“æ‰£å‡                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚ æ”¯å‡º: åˆé¤ Â¥35                          â”‚                      â”‚
â”‚   â”‚ ä»"é¤é¥®"å°é‡‘åº“æ‰£å‡ â†’ é¤é¥®å‰©ä½™ Â¥1,965   â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å°é‡‘åº“ç³»ç»Ÿè®¾è®¡

#### 5.2.1 å°é‡‘åº“æ•°æ®æ¨¡å‹

```dart
/// å°é‡‘åº“ç±»å‹
enum VaultType {
  /// å›ºå®šæ”¯å‡º - æ¯æœˆå¿…é¡»æ”¯ä»˜ï¼ˆæˆ¿ç§Ÿã€æ°´ç”µï¼‰
  fixed,

  /// å¼¹æ€§æ”¯å‡º - å¯è°ƒæ•´ï¼ˆé¤é¥®ã€å¨±ä¹ï¼‰
  flexible,

  /// å‚¨è“„ç›®æ ‡ - é•¿æœŸç§¯ç´¯ï¼ˆæ—…è¡ŒåŸºé‡‘ã€åº”æ€¥é‡‘ï¼‰
  savings,

  /// å€ºåŠ¡è¿˜æ¬¾ - ä¿¡ç”¨å¡ã€è´·æ¬¾
  debt,
}

/// åˆ†é…ç±»å‹æšä¸¾
enum AllocationType {
  /// å›ºå®šé‡‘é¢åˆ†é…
  fixed,
  /// æŒ‰ç™¾åˆ†æ¯”åˆ†é…
  percentage,
  /// åˆ†é…å‰©ä½™é‡‘é¢
  remainder,
  /// è¡¥é½åˆ°ç›®æ ‡é‡‘é¢
  topUp,
}

/// å°é‡‘åº“æ¨¡å‹
class BudgetVault {
  final String id;
  final String name;
  final String? icon;
  final Color color;
  final VaultType type;
  final double targetAmount;      // ç›®æ ‡é‡‘é¢
  double allocatedAmount;         // å·²åˆ†é…é‡‘é¢
  double spentAmount;             // å·²èŠ±è´¹é‡‘é¢
  final DateTime? dueDate;        // åˆ°æœŸæ—¥ï¼ˆç”¨äºè´¦å•ç±»ï¼‰
  final bool isRecurring;         // æ˜¯å¦å‘¨æœŸæ€§
  final RecurrenceRule? recurrence; // å‘¨æœŸè§„åˆ™

  // === æ–°å¢ï¼šåˆ†é…ç­–ç•¥ç›¸å…³å±æ€§ ===
  final AllocationType allocationType;  // åˆ†é…ç±»å‹
  final double? targetAllocation;       // å›ºå®šåˆ†é…é‡‘é¢ï¼ˆç”¨äºfixedç±»å‹ï¼‰
  final double? targetPercentage;       // åˆ†é…ç™¾åˆ†æ¯”ï¼ˆç”¨äºpercentageç±»å‹ï¼Œ0-1ï¼‰

  /// å½“å‰é‡‘é¢ï¼ˆallocatedAmount - spentAmount çš„åˆ«åï¼Œç”¨äºtopUpè®¡ç®—ï¼‰
  double get currentAmount => allocatedAmount - spentAmount;

  /// å‰©ä½™å¯ç”¨
  double get available => allocatedAmount - spentAmount;

  /// å®Œæˆåº¦
  double get progress => targetAmount > 0 ? allocatedAmount / targetAmount : 0;

  /// ä½¿ç”¨ç‡
  double get usageRate => allocatedAmount > 0 ? spentAmount / allocatedAmount : 0;

  /// çŠ¶æ€
  VaultStatus get status {
    if (available < 0) return VaultStatus.overSpent;
    if (usageRate > 0.9) return VaultStatus.almostEmpty;
    if (progress < 1.0) return VaultStatus.underfunded;
    return VaultStatus.healthy;
  }

  /// æ„é€ å‡½æ•°
  BudgetVault({
    required this.id,
    required this.name,
    this.icon,
    required this.color,
    required this.type,
    required this.targetAmount,
    this.allocatedAmount = 0,
    this.spentAmount = 0,
    this.dueDate,
    this.isRecurring = false,
    this.recurrence,
    this.allocationType = AllocationType.fixed,
    this.targetAllocation,
    this.targetPercentage,
  });
}

/// å°é‡‘åº“çŠ¶æ€
enum VaultStatus {
  healthy,      // å¥åº·
  underfunded,  // èµ„é‡‘ä¸è¶³
  almostEmpty,  // å³å°†ç”¨å®Œ
  overSpent,    // è¶…æ”¯
}
```

#### 5.2.2 èµ„é‡‘åˆ†é…æœåŠ¡

```dart
/// èµ„é‡‘åˆ†é…æœåŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
///
/// æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„åˆ†é…æœåŠ¡ï¼Œä»…ç”¨äºæ¦‚å¿µæ¼”ç¤ºã€‚
/// ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ BudgetAllocationServiceï¼ˆè¯¦è§19.3.2èŠ‚ï¼‰ï¼Œ
/// å®ƒæ”¯æŒå®Œæ•´çš„åˆ†é…ç­–ç•¥ï¼ˆå›ºå®šé‡‘é¢ã€ç™¾åˆ†æ¯”ã€å‰©ä½™ã€è¡¥è¶³ï¼‰å’Œå¼‚å¸¸å¤„ç†ã€‚
class AllocationService {
  final VaultRepository vaultRepository;
  final TransactionRepository transactionRepository;

  /// å¾…åˆ†é…é‡‘é¢
  Future<double> getUnallocatedAmount() async {
    final totalIncome = await transactionRepository.getTotalIncome();
    final totalAllocated = await vaultRepository.getTotalAllocated();
    return totalIncome - totalAllocated;
  }

  /// åˆ†é…èµ„é‡‘åˆ°å°é‡‘åº“
  Future<void> allocateToVault(String vaultId, double amount) async {
    final unallocated = await getUnallocatedAmount();
    if (amount > unallocated) {
      throw InsufficientFundsException('å¾…åˆ†é…é‡‘é¢ä¸è¶³');
    }

    final vault = await vaultRepository.getById(vaultId);
    vault.allocatedAmount += amount;
    await vaultRepository.update(vault);

    // è®°å½•åˆ†é…å†å²
    await _recordAllocationHistory(vaultId, amount);
  }

  /// æ™ºèƒ½åˆ†é…å»ºè®®
  Future<List<AllocationSuggestion>> getSuggestions() async {
    final unallocated = await getUnallocatedAmount();
    final vaults = await vaultRepository.getAll();
    final suggestions = <AllocationSuggestion>[];

    // 1. ä¼˜å…ˆæ»¡è¶³å›ºå®šæ”¯å‡º
    for (final vault in vaults.where((v) => v.type == VaultType.fixed)) {
      if (vault.allocatedAmount < vault.targetAmount) {
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: vault.targetAmount - vault.allocatedAmount,
          reason: 'å›ºå®šæ”¯å‡ºéœ€è¦ä¼˜å…ˆä¿éšœ',
          priority: 1,
        ));
      }
    }

    // 2. å€ºåŠ¡è¿˜æ¬¾
    for (final vault in vaults.where((v) => v.type == VaultType.debt)) {
      if (vault.allocatedAmount < vault.targetAmount) {
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: vault.targetAmount - vault.allocatedAmount,
          reason: 'æŒ‰æ—¶è¿˜æ¬¾é¿å…åˆ©æ¯å’Œä¿¡ç”¨å½±å“',
          priority: 2,
        ));
      }
    }

    // 3. å‚¨è“„ç›®æ ‡
    // 4. å¼¹æ€§æ”¯å‡º
    // ...

    return suggestions..sort((a, b) => a.priority.compareTo(b.priority));
  }

  /// ä¸€é”®æ™ºèƒ½åˆ†é…
  Future<AllocationResult> autoAllocate() async {
    final suggestions = await getSuggestions();
    var remaining = await getUnallocatedAmount();
    final allocated = <String, double>{};

    for (final suggestion in suggestions) {
      if (remaining <= 0) break;
      final amount = min(suggestion.suggestedAmount, remaining);
      await allocateToVault(suggestion.vaultId, amount);
      allocated[suggestion.vaultId] = amount;
      remaining -= amount;
    }

    return AllocationResult(
      allocations: allocated,
      remaining: remaining,
    );
  }
}
```

### 5.3 å°é‡‘åº“å¯è§†åŒ–

#### 5.3.1 å°é‡‘åº“æ¦‚è§ˆå¡ç‰‡

```dart
/// å°é‡‘åº“æ¦‚è§ˆé¡µé¢
class VaultOverviewPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final vaults = ref.watch(vaultsProvider);
    final unallocated = ref.watch(unallocatedAmountProvider);

    return Scaffold(
      appBar: AppBar(title: Text('æˆ‘çš„å°é‡‘åº“')),
      body: Column(
        children: [
          // å¾…åˆ†é…æç¤ºå¡
          if (unallocated > 0)
            _UnallocatedBanner(amount: unallocated),

          // å°é‡‘åº“åˆ—è¡¨
          Expanded(
            child: ListView.builder(
              itemCount: vaults.length,
              itemBuilder: (context, index) => VaultCard(
                vault: vaults[index],
                onTap: () => _navigateToVaultDetail(context, vaults[index]),
              ),
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => _showCreateVaultSheet(context),
        icon: Icon(Icons.add),
        label: Text('æ–°å»ºå°é‡‘åº“'),
      ),
    );
  }
}

/// å•ä¸ªå°é‡‘åº“å¡ç‰‡
class VaultCard extends StatelessWidget {
  final BudgetVault vault;
  final VoidCallback? onTap;

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // æ ‡é¢˜è¡Œ
              Row(
                children: [
                  _VaultIcon(icon: vault.icon, color: vault.color),
                  SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(vault.name, style: TextStyle(fontWeight: FontWeight.bold)),
                        Text(vault.type.displayName, style: TextStyle(color: Colors.grey)),
                      ],
                    ),
                  ),
                  _StatusBadge(status: vault.status),
                ],
              ),

              SizedBox(height: 16),

              // è¿›åº¦æ¡
              _VaultProgressBar(
                allocated: vault.allocatedAmount,
                spent: vault.spentAmount,
                target: vault.targetAmount,
                color: vault.color,
              ),

              SizedBox(height: 12),

              // é‡‘é¢ä¿¡æ¯
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  _AmountLabel(label: 'å¯ç”¨', amount: vault.available),
                  _AmountLabel(label: 'å·²èŠ±', amount: vault.spentAmount),
                  _AmountLabel(label: 'ç›®æ ‡', amount: vault.targetAmount),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 5.3.2 èµ„é‡‘åˆ†é…ç•Œé¢

```dart
/// èµ„é‡‘åˆ†é…ç•Œé¢
class AllocationPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final unallocated = ref.watch(unallocatedAmountProvider);
    final suggestions = ref.watch(allocationSuggestionsProvider);

    return Scaffold(
      appBar: AppBar(title: Text('åˆ†é…èµ„é‡‘')),
      body: Column(
        children: [
          // å¾…åˆ†é…é‡‘é¢å¡ç‰‡
          _UnallocatedAmountCard(amount: unallocated),

          // åˆ†é…å»ºè®®åˆ—è¡¨
          Expanded(
            child: ListView.builder(
              itemCount: suggestions.length,
              itemBuilder: (context, index) => _SuggestionTile(
                suggestion: suggestions[index],
                onAllocate: (amount) => ref.read(
                  allocationServiceProvider
                ).allocateToVault(suggestions[index].vaultId, amount),
              ),
            ),
          ),

          // åº•éƒ¨æ“ä½œæ 
          _AllocationActionBar(
            onAutoAllocate: () => _showAutoAllocateConfirm(context, ref),
            onSkip: () => Navigator.pop(context),
          ),
        ],
      ),
    );
  }
}
```

### 5.4 å°é‡‘åº“ä¸äº¤æ˜“è”åŠ¨

```dart
/// äº¤æ˜“è®°å½•æ—¶è‡ªåŠ¨å…³è”å°é‡‘åº“
class TransactionVaultLinker {
  final VaultRepository vaultRepository;
  final CategoryVaultMappingRepository mappingRepository;

  /// æ ¹æ®åˆ†ç±»è‡ªåŠ¨æ¨èå°é‡‘åº“
  Future<BudgetVault?> suggestVaultForTransaction(Transaction tx) async {
    // 1. æŸ¥æ‰¾åˆ†ç±»-å°é‡‘åº“æ˜ å°„
    final mapping = await mappingRepository.findByCategory(tx.categoryId);
    if (mapping != null) {
      return vaultRepository.getById(mapping.vaultId);
    }

    // 2. åŸºäºå†å²è®°å½•æ™ºèƒ½æ¨è
    final history = await _findSimilarTransactions(tx);
    if (history.isNotEmpty) {
      final vaultCounts = <String, int>{};
      for (final h in history) {
        if (h.vaultId != null) {
          vaultCounts[h.vaultId!] = (vaultCounts[h.vaultId!] ?? 0) + 1;
        }
      }
      if (vaultCounts.isNotEmpty) {
        final mostUsedVaultId = vaultCounts.entries
            .reduce((a, b) => a.value > b.value ? a : b).key;
        return vaultRepository.getById(mostUsedVaultId);
      }
    }

    return null;
  }

  /// äº¤æ˜“ä¿å­˜æ—¶æ›´æ–°å°é‡‘åº“
  Future<void> onTransactionSaved(Transaction tx) async {
    if (tx.vaultId == null || tx.type != TransactionType.expense) return;

    final vault = await vaultRepository.getById(tx.vaultId!);
    vault.spentAmount += tx.amount;
    await vaultRepository.update(vault);

    // æ£€æŸ¥æ˜¯å¦è¶…æ”¯å¹¶å‘é€é€šçŸ¥
    if (vault.available < 0) {
      await _sendOverspentNotification(vault);
    } else if (vault.usageRate > 0.8) {
      await _sendLowBalanceNotification(vault);
    }
  }
}
```

---

## 6. é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ

æœ¬ç« èšç„¦äºå¦‚ä½•é€šè¿‡äº§å“è®¾è®¡åŸ¹å…»ç”¨æˆ·è‰¯å¥½çš„é‡‘èä¹ æƒ¯ï¼Œå¸®åŠ©ç”¨æˆ·ä»"èŠ±ä¸‹æœˆçš„é’±"é€æ­¥è¿‡æ¸¡åˆ°"èŠ±ä¸Šæœˆçš„é’±"ï¼Œå»ºç«‹è´¢åŠ¡å®‰å…¨æ„Ÿã€‚

### 6.1 è®¾è®¡ç†å¿µ

#### 6.1.1 æ ¸å¿ƒç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‘èä¹ æƒ¯åŸ¹å…»å››å¤§ç›®æ ‡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  ç›®æ ‡ä¸€ï¼šå®¡è§†æ¶ˆè´¹ä¹ æƒ¯                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ è¯†åˆ« "æ²¡å¿…è¦çš„å¼€æ”¯"ï¼ˆè®¢é˜…äº†ä¸ç”¨çš„ä¼šå‘˜ã€é¢‘ç¹å¤–å–ï¼‰          â”‚     â”‚
â”‚  â”‚  â€¢ å‘ç°é«˜é¢‘å°é¢æ¶ˆè´¹çš„ç´¯ç§¯æ•ˆåº”                                 â”‚     â”‚
â”‚  â”‚  â€¢ å¯¹æ¯”"æƒ³è¦"vs"éœ€è¦"ï¼ŒæŠŠé’±èŠ±åœ¨çœŸæ­£é‡è¦çš„åœ°æ–¹                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡äºŒï¼šé¿å…å†²åŠ¨æ¶ˆè´¹                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ æ¸…æ™°å±•ç¤º"æ¯ä¸ªç±»ç›®è¿˜å‰©å¤šå°‘é’±å¯ä»¥èŠ±"                        â”‚     â”‚
â”‚  â”‚  â€¢ è¶…æ”¯å‰é¢„è­¦ï¼Œè€Œéè¶…æ”¯åæé†’                                 â”‚     â”‚
â”‚  â”‚  â€¢ å»ºç«‹"å…ˆè§„åˆ’å†æ¶ˆè´¹"çš„å¿ƒæ™ºæ¨¡å‹                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡ä¸‰ï¼šå»ºç«‹è´¢åŠ¡ç¼“å†²                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ ä»"èŠ±ä¸‹æœˆçš„é’±"è¿‡æ¸¡åˆ°"èŠ±ä¸Šæœˆçš„é’±"                          â”‚     â”‚
â”‚  â”‚  â€¢ ç§¯ç´¯åº”æ€¥é‡‘ï¼ˆè¦†ç›–3-6ä¸ªæœˆå¿…è¦æ”¯å‡ºï¼‰                         â”‚     â”‚
â”‚  â”‚  â€¢ å‡å°‘å¯¹ä¿¡ç”¨å¡ã€ç½‘è´·çš„ä¾èµ–                                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡å››ï¼šå¼¹æ€§åº”å¯¹å˜åŒ–                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ é€‚é…å·¥èµ„ä¸ç¨³å®šã€æœ‰å‰¯ä¸šæ”¶å…¥çš„ç”¨æˆ·                           â”‚     â”‚
â”‚  â”‚  â€¢ ä¼˜é›…å¤„ç†çªå‘æ”¯å‡ºï¼Œä¸å› ä¸€æ¬¡è¶…æ”¯æ”¾å¼ƒæ•´ä¸ªè®¡åˆ’                 â”‚     â”‚
â”‚  â”‚  â€¢ é¼“åŠ±æŒç»­è®°å½•ï¼Œè€Œéè¿½æ±‚å®Œç¾                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.1.2 è¡Œä¸ºå¿ƒç†å­¦åŸºç¡€

| åŸç† | åº”ç”¨åœºæ™¯ | äº§å“è®¾è®¡ |
|------|----------|----------|
| **æŸå¤±åŒæ¶** | äººä»¬å¯¹æŸå¤±çš„æ•æ„Ÿåº¦æ˜¯æ”¶ç›Šçš„2å€ | å±•ç¤º"è¶…æ”¯=æŸå¤±"ï¼Œè€Œéä»…å±•ç¤ºæ•°å­— |
| **å³æ—¶åé¦ˆ** | è¡Œä¸ºä¸åé¦ˆé—´éš”è¶ŠçŸ­ï¼Œä¹ æƒ¯è¶Šæ˜“å½¢æˆ | æ¶ˆè´¹åç«‹å³æ˜¾ç¤ºå¯¹é¢„ç®—çš„å½±å“ |
| **æ‰¿è¯ºä¸€è‡´** | äººä»¬å€¾å‘äºä¿æŒä¸æ‰¿è¯ºä¸€è‡´çš„è¡Œä¸º | è®©ç”¨æˆ·ä¸»åŠ¨è®¾å®šç›®æ ‡å¹¶å¯è§†åŒ–è¿›åº¦ |
| **ç¤¾ä¼šè®¤åŒ** | å‚ç…§ä»–äººè¡Œä¸ºåšå†³ç­– | å±•ç¤º"åŒç±»å‹ç”¨æˆ·"çš„æ¶ˆè´¹æ°´å¹³å¯¹æ¯” |
| **è¿›åº¦æ•ˆåº”** | å·²å®Œæˆçš„è¿›åº¦æ¿€åŠ±ç»§ç»­å®Œæˆ | å‚¨è“„ç›®æ ‡è¿›åº¦æ¡ã€è¿ç»­è®°è´¦å¤©æ•° |
| **é»˜è®¤æ•ˆåº”** | äººä»¬å€¾å‘äºæ¥å—é»˜è®¤é€‰é¡¹ | é»˜è®¤å¼€å¯å‚¨è“„æé†’ã€é»˜è®¤åˆ†é…åº”æ€¥é‡‘ |

### 6.2 æ¶ˆè´¹å®¡è§†ç³»ç»Ÿ

#### 6.2.1 è®¢é˜…ç®¡ç†ä¸æµªè´¹è¯†åˆ«

```dart
/// è®¢é˜…è¿½è¸ªæœåŠ¡
class SubscriptionTrackingService {
  /// è‡ªåŠ¨è¯†åˆ«è®¢é˜…ç±»æ¶ˆè´¹
  Future<List<SubscriptionPattern>> detectSubscriptions() async {
    final transactions = await _transactionRepo.getRecent(months: 6);

    // è¯†åˆ«å‘¨æœŸæ€§å›ºå®šé‡‘é¢æ¶ˆè´¹
    final patterns = <SubscriptionPattern>[];

    // æŒ‰å•†å®¶+é‡‘é¢åˆ†ç»„
    final grouped = _groupByMerchantAndAmount(transactions);

    for (final group in grouped.entries) {
      final txList = group.value;
      if (txList.length >= 2) {
        // æ£€æµ‹å‘¨æœŸæ€§
        final interval = _detectInterval(txList);
        if (interval != null) {
          final lastUsage = await _detectLastUsage(group.key.merchant);

          patterns.add(SubscriptionPattern(
            merchantName: group.key.merchant,
            amount: group.key.amount,
            interval: interval,  // monthly, yearly, etc.
            totalSpent: txList.fold(0.0, (sum, tx) => sum + tx.amount),
            lastPaymentDate: txList.last.date,
            lastUsageDate: lastUsage,
            usageStatus: _calculateUsageStatus(lastUsage),
          ));
        }
      }
    }

    return patterns;
  }

  /// è¯†åˆ«å¯èƒ½æµªè´¹çš„è®¢é˜…
  Future<List<WastedSubscription>> findWastedSubscriptions() async {
    final subscriptions = await detectSubscriptions();

    return subscriptions
        .where((s) => s.usageStatus == UsageStatus.unused ||
                      s.usageStatus == UsageStatus.rarelyUsed)
        .map((s) => WastedSubscription(
          subscription: s,
          potentialSavings: _calculateAnnualSavings(s),
          suggestion: _generateCancelSuggestion(s),
        ))
        .toList();
  }
}

/// è®¢é˜…ä½¿ç”¨çŠ¶æ€
enum UsageStatus {
  active,      // ç»å¸¸ä½¿ç”¨
  occasional,  // å¶å°”ä½¿ç”¨
  rarelyUsed,  // å¾ˆå°‘ä½¿ç”¨
  unused,      // å®Œå…¨æœªä½¿ç”¨
}

/// æµªè´¹è®¢é˜…æé†’å¡ç‰‡
class WastedSubscriptionCard extends StatelessWidget {
  final WastedSubscription subscription;

  @override
  Widget build(BuildContext context) {
    return Card(
      color: Colors.orange.shade50,
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.warning_amber, color: Colors.orange),
                SizedBox(width: 8),
                Text('å¯èƒ½ä¸éœ€è¦çš„è®¢é˜…', style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.orange.shade800,
                )),
              ],
            ),
            SizedBox(height: 12),
            Text(subscription.subscription.merchantName,
              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            SizedBox(height: 4),
            Text('æ¯æœˆ Â¥${subscription.subscription.amount.toStringAsFixed(0)}'),
            Text('ä¸Šæ¬¡ä½¿ç”¨: ${_formatLastUsage(subscription.subscription.lastUsageDate)}',
              style: TextStyle(color: Colors.grey)),
            SizedBox(height: 12),
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.green.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(Icons.savings, color: Colors.green),
                  SizedBox(width: 8),
                  Text('å–æ¶ˆåæ¯å¹´å¯èŠ‚çœ Â¥${subscription.potentialSavings.toStringAsFixed(0)}',
                    style: TextStyle(color: Colors.green.shade700, fontWeight: FontWeight.bold)),
                ],
              ),
            ),
            SizedBox(height: 12),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => _markAsNeeded(subscription),
                  child: Text('ç¡®å®éœ€è¦'),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () => _showCancelGuide(subscription),
                  child: Text('æŸ¥çœ‹å–æ¶ˆæ–¹æ³•'),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
```

#### 6.2.2 é«˜é¢‘å°é¢æ¶ˆè´¹åˆ†æ

```dart
/// é«˜é¢‘å°é¢æ¶ˆè´¹åˆ†ææœåŠ¡
class FrequentSmallExpenseAnalyzer {
  /// åˆ†æ"æ‹¿é“å› å­"ï¼ˆé«˜é¢‘å°é¢æ¶ˆè´¹ï¼‰
  Future<LatteFactorReport> analyzeLatteFactors() async {
    final transactions = await _transactionRepo.getRecent(months: 3);

    // ç­›é€‰å°é¢é«˜é¢‘æ¶ˆè´¹ï¼ˆ<50å…ƒï¼Œæ¯å‘¨>2æ¬¡ï¼‰
    final smallExpenses = transactions.where((tx) =>
        tx.type == TransactionType.expense &&
        tx.amount < 50
    ).toList();

    // æŒ‰æè¿°/å•†å®¶èšç±»
    final clusters = _clusterByPattern(smallExpenses);

    final latteFactors = <LatteFactor>[];

    for (final cluster in clusters) {
      final weeklyFrequency = cluster.transactions.length / 12;  // 3ä¸ªæœˆâ‰ˆ12å‘¨
      if (weeklyFrequency >= 2) {
        final monthlyTotal = cluster.totalAmount / 3;
        final yearlyTotal = monthlyTotal * 12;

        latteFactors.add(LatteFactor(
          category: cluster.category,
          description: cluster.commonDescription,
          weeklyFrequency: weeklyFrequency,
          averageAmount: cluster.averageAmount,
          monthlyTotal: monthlyTotal,
          yearlyTotal: yearlyTotal,
          // è®¡ç®—å¦‚æœå‡å°‘ä¸€åŠèƒ½å­˜å¤šå°‘
          potentialSavings: yearlyTotal * 0.5,
          transactions: cluster.transactions,
        ));
      }
    }

    // æŒ‰å¹´åº¦æ€»é¢æ’åº
    latteFactors.sort((a, b) => b.yearlyTotal.compareTo(a.yearlyTotal));

    return LatteFactorReport(
      factors: latteFactors,
      totalMonthlyImpact: latteFactors.fold(0.0, (sum, f) => sum + f.monthlyTotal),
      totalYearlyImpact: latteFactors.fold(0.0, (sum, f) => sum + f.yearlyTotal),
      topSuggestion: _generateTopSuggestion(latteFactors),
    );
  }

  /// ç”Ÿæˆæ´å¯Ÿå»ºè®®
  String _generateTopSuggestion(List<LatteFactor> factors) {
    if (factors.isEmpty) return 'æ‚¨çš„å°é¢æ¶ˆè´¹æ§åˆ¶å¾—å¾ˆå¥½ï¼';

    final top = factors.first;
    final weeklyTimes = top.weeklyFrequency.round();
    final reducedTimes = (weeklyTimes / 2).ceil();

    return 'å¦‚æœå°†${top.description}ä»æ¯å‘¨${weeklyTimes}æ¬¡å‡å°‘åˆ°${reducedTimes}æ¬¡ï¼Œ'
           'æ¯å¹´å¯ä»¥å¤šå­˜ Â¥${(top.potentialSavings).toStringAsFixed(0)}';
  }
}

/// æ‹¿é“å› å­å¯è§†åŒ–å¡ç‰‡
class LatteFactorCard extends StatelessWidget {
  final LatteFactorReport report;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.coffee, color: Colors.brown),
                SizedBox(width: 8),
                Text('å°é¢æ¶ˆè´¹æ´å¯Ÿ', style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
                Spacer(),
                Tooltip(
                  message: '"æ‹¿é“å› å­"æŒ‡é‚£äº›çœ‹ä¼¼å¾®å°ä½†ç´¯ç§¯æƒŠäººçš„æ—¥å¸¸æ¶ˆè´¹',
                  child: Icon(Icons.info_outline, size: 20, color: Colors.grey),
                ),
              ],
            ),
            SizedBox(height: 16),

            // å¹´åº¦å½±å“æ€»è§ˆ
            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [Colors.orange.shade100, Colors.red.shade100],
                ),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  _buildImpactItem('æ¯æœˆç´¯è®¡', 'Â¥${report.totalMonthlyImpact.toStringAsFixed(0)}'),
                  Container(width: 1, height: 40, color: Colors.grey.shade300),
                  _buildImpactItem('æ¯å¹´ç´¯è®¡', 'Â¥${report.totalYearlyImpact.toStringAsFixed(0)}'),
                ],
              ),
            ),

            SizedBox(height: 16),

            // å‰3é¡¹è¯¦æƒ…
            ...report.factors.take(3).map((factor) => _buildFactorItem(factor)),

            SizedBox(height: 12),

            // å»ºè®®
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(Icons.lightbulb, color: Colors.blue),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(report.topSuggestion,
                      style: TextStyle(color: Colors.blue.shade800)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFactorItem(LatteFactor factor) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(factor.description, style: TextStyle(fontWeight: FontWeight.w500)),
                Text('æ¯å‘¨çº¦${factor.weeklyFrequency.toStringAsFixed(1)}æ¬¡ Â· '
                     'å‡ä»·Â¥${factor.averageAmount.toStringAsFixed(0)}',
                  style: TextStyle(color: Colors.grey, fontSize: 12)),
              ],
            ),
          ),
          Text('Â¥${factor.monthlyTotal.toStringAsFixed(0)}/æœˆ',
            style: TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}
```

#### 6.2.3 "æƒ³è¦" vs "éœ€è¦" åˆ†ç±»

```dart
/// æ¶ˆè´¹å¿…è¦æ€§åˆ†æ
class NecessityAnalyzer {
  /// æ¶ˆè´¹ç±»å‹å®šä¹‰
  static const Map<String, ExpenseNecessity> categoryNecessity = {
    // å¿…éœ€å“
    'æˆ¿ç§Ÿ': ExpenseNecessity.essential,
    'æ°´ç”µç‡ƒæ°”': ExpenseNecessity.essential,
    'æ—¥ç”¨å“': ExpenseNecessity.essential,
    'åŸºç¡€é¤é¥®': ExpenseNecessity.essential,
    'åŒ»ç–—': ExpenseNecessity.essential,
    'é€šå‹¤äº¤é€š': ExpenseNecessity.essential,

    // é‡è¦ä½†éå¿…éœ€
    'ä¿é™©': ExpenseNecessity.important,
    'æ•™è‚²': ExpenseNecessity.important,
    'å¥èº«': ExpenseNecessity.important,

    // å¯é€‰æ¶ˆè´¹
    'å¤–å–': ExpenseNecessity.optional,
    'å¨±ä¹': ExpenseNecessity.optional,
    'è´­ç‰©': ExpenseNecessity.optional,
    'è®¢é˜…æœåŠ¡': ExpenseNecessity.optional,
    'ç¤¾äº¤èšé¤': ExpenseNecessity.optional,
  };

  /// åˆ†ææ¶ˆè´¹ç»“æ„
  Future<NecessityReport> analyzeSpendingStructure() async {
    final transactions = await _transactionRepo.getMonthlyExpenses();

    double essentialTotal = 0;
    double importantTotal = 0;
    double optionalTotal = 0;

    final breakdown = <String, CategoryBreakdown>{};

    for (final tx in transactions) {
      final necessity = _determineNecessity(tx);
      switch (necessity) {
        case ExpenseNecessity.essential:
          essentialTotal += tx.amount;
          break;
        case ExpenseNecessity.important:
          importantTotal += tx.amount;
          break;
        case ExpenseNecessity.optional:
          optionalTotal += tx.amount;
          break;
      }

      // è®°å½•è¯¦ç»†åˆ†ç±»
      breakdown.putIfAbsent(tx.categoryName, () => CategoryBreakdown(
        categoryName: tx.categoryName,
        necessity: necessity,
      )).totalAmount += tx.amount;
    }

    final total = essentialTotal + importantTotal + optionalTotal;

    return NecessityReport(
      essentialAmount: essentialTotal,
      essentialPercentage: essentialTotal / total,
      importantAmount: importantTotal,
      importantPercentage: importantTotal / total,
      optionalAmount: optionalTotal,
      optionalPercentage: optionalTotal / total,
      breakdown: breakdown.values.toList(),
      healthScore: _calculateHealthScore(essentialTotal, importantTotal, optionalTotal),
      suggestions: _generateSuggestions(breakdown),
    );
  }

  /// è®¡ç®—è´¢åŠ¡å¥åº·åˆ†
  int _calculateHealthScore(double essential, double important, double optional) {
    final total = essential + important + optional;
    if (total == 0) return 100;

    final essentialRatio = essential / total;
    final optionalRatio = optional / total;

    // ç†æƒ³çŠ¶æ€ï¼šå¿…éœ€50-60%ï¼Œé‡è¦20-30%ï¼Œå¯é€‰10-20%
    int score = 100;

    // å¯é€‰æ¶ˆè´¹è¶…è¿‡30%æ‰£åˆ†
    if (optionalRatio > 0.3) {
      score -= ((optionalRatio - 0.3) * 100).round();
    }

    // å¿…éœ€æ¶ˆè´¹è¶…è¿‡70%æ‰£åˆ†ï¼ˆå¯èƒ½æ²¡æœ‰è¶³å¤Ÿä½™åŠ›å‚¨è“„ï¼‰
    if (essentialRatio > 0.7) {
      score -= ((essentialRatio - 0.7) * 50).round();
    }

    return score.clamp(0, 100);
  }
}

/// æ¶ˆè´¹å¿…è¦æ€§æšä¸¾
enum ExpenseNecessity {
  essential,  // å¿…éœ€ï¼šæ²¡æœ‰å°±æ´»ä¸ä¸‹å»
  important,  // é‡è¦ï¼šæå‡ç”Ÿæ´»è´¨é‡ä½†å¯æš‚ç¼“
  optional,   // å¯é€‰ï¼šé”¦ä¸Šæ·»èŠ±çš„æ¶ˆè´¹
}
```

### 6.3 å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤

#### 6.3.1 å®æ—¶é¢„ç®—å¯è§†åŒ–

```dart
/// é¢„ç®—å®æ—¶çŠ¶æ€ç»„ä»¶ï¼ˆå¸¸é©»æ˜¾ç¤ºï¼‰
class BudgetStatusBar extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final budgets = ref.watch(activeBudgetsProvider);

    return Container(
      height: 60,
      padding: EdgeInsets.symmetric(horizontal: 16),
      child: ListView.separated(
        scrollDirection: Axis.horizontal,
        itemCount: budgets.length,
        separatorBuilder: (_, __) => SizedBox(width: 12),
        itemBuilder: (context, index) {
          final budget = budgets[index];
          final remaining = budget.amount - budget.spent;
          final isWarning = remaining < budget.amount * 0.2;
          final isDanger = remaining <= 0;

          return InkWell(
            onTap: () => _showBudgetDetail(context, budget),
            borderRadius: BorderRadius.circular(20),
            child: Container(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              decoration: BoxDecoration(
                color: isDanger ? Colors.red.shade50 :
                       isWarning ? Colors.orange.shade50 :
                       Colors.green.shade50,
                borderRadius: BorderRadius.circular(20),
                border: Border.all(
                  color: isDanger ? Colors.red :
                         isWarning ? Colors.orange :
                         Colors.green,
                  width: 1,
                ),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(
                    budget.category?.icon ?? Icons.account_balance_wallet,
                    size: 20,
                    color: isDanger ? Colors.red :
                           isWarning ? Colors.orange :
                           Colors.green,
                  ),
                  SizedBox(width: 8),
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(budget.name, style: TextStyle(fontSize: 12)),
                      Text(
                        remaining >= 0 ? 'è¿˜å‰© Â¥${remaining.toStringAsFixed(0)}'
                                       : 'è¶…æ”¯ Â¥${(-remaining).toStringAsFixed(0)}',
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          color: isDanger ? Colors.red :
                                 isWarning ? Colors.orange :
                                 Colors.green,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}
```

#### 6.3.2 æ¶ˆè´¹å‰ç¡®è®¤æœºåˆ¶

```dart
/// å¤§é¢æ¶ˆè´¹ç¡®è®¤æœåŠ¡
class LargeExpenseConfirmService {
  /// åˆ¤æ–­æ˜¯å¦éœ€è¦ç¡®è®¤
  Future<ConfirmationRequired?> checkNeedsConfirmation(Transaction tx) async {
    final budget = await _findRelevantBudget(tx);
    if (budget == null) return null;

    final remaining = budget.amount - budget.spent;
    final warnings = <ConfirmationWarning>[];

    // æ£€æŸ¥1ï¼šä¼šå¯¼è‡´è¶…æ”¯
    if (tx.amount > remaining) {
      warnings.add(ConfirmationWarning(
        type: WarningType.willOverspend,
        severity: WarningSeverity.high,
        message: 'è¿™ç¬”æ¶ˆè´¹å°†å¯¼è‡´${budget.name}è¶…æ”¯ Â¥${(tx.amount - remaining).toStringAsFixed(0)}',
      ));
    }

    // æ£€æŸ¥2ï¼šæ¶ˆè€—è¶…è¿‡50%å‰©ä½™é¢„ç®—
    else if (tx.amount > remaining * 0.5 && remaining > 100) {
      warnings.add(ConfirmationWarning(
        type: WarningType.largePortionOfBudget,
        severity: WarningSeverity.medium,
        message: 'è¿™ç¬”æ¶ˆè´¹å°†ç”¨æ‰${budget.name}å‰©ä½™é¢„ç®—çš„${(tx.amount / remaining * 100).toStringAsFixed(0)}%',
      ));
    }

    // æ£€æŸ¥3ï¼šæœˆåˆå°±å¤§é¢æ¶ˆè´¹
    final dayOfMonth = DateTime.now().day;
    if (dayOfMonth <= 7 && tx.amount > budget.amount * 0.3) {
      warnings.add(ConfirmationWarning(
        type: WarningType.earlyLargeExpense,
        severity: WarningSeverity.medium,
        message: 'æœˆåˆå¤§é¢æ¶ˆè´¹å¯èƒ½å½±å“æœ¬æœˆé¢„ç®—æ§åˆ¶',
      ));
    }

    // æ£€æŸ¥4ï¼šéå¿…è¦æ¶ˆè´¹
    final necessity = NecessityAnalyzer.categoryNecessity[tx.categoryName];
    if (necessity == ExpenseNecessity.optional && tx.amount > 200) {
      warnings.add(ConfirmationWarning(
        type: WarningType.optionalExpense,
        severity: WarningSeverity.low,
        message: 'è¿™æ˜¯ä¸€ç¬”å¯é€‰æ¶ˆè´¹ï¼Œè€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦ï¼Ÿ',
      ));
    }

    if (warnings.isEmpty) return null;

    return ConfirmationRequired(
      transaction: tx,
      warnings: warnings,
      budgetStatus: BudgetStatus(
        budgetName: budget.name,
        total: budget.amount,
        spent: budget.spent,
        remaining: remaining,
        afterThisExpense: remaining - tx.amount,
      ),
    );
  }
}

/// æ¶ˆè´¹ç¡®è®¤å¼¹çª—
class ExpenseConfirmationDialog extends StatelessWidget {
  final ConfirmationRequired confirmation;
  final VoidCallback onConfirm;
  final VoidCallback onCancel;

  @override
  Widget build(BuildContext context) {
    final highestSeverity = confirmation.warnings
        .map((w) => w.severity)
        .reduce((a, b) => a.index > b.index ? a : b);

    final headerColor = highestSeverity == WarningSeverity.high
        ? Colors.red
        : highestSeverity == WarningSeverity.medium
            ? Colors.orange
            : Colors.blue;

    return AlertDialog(
      title: Row(
        children: [
          Icon(
            highestSeverity == WarningSeverity.high
                ? Icons.warning
                : Icons.info_outline,
            color: headerColor,
          ),
          SizedBox(width: 8),
          Text('ç¡®è®¤è¿™ç¬”æ¶ˆè´¹ï¼Ÿ'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // äº¤æ˜“ä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Text(confirmation.transaction.categoryName),
                Spacer(),
                Text('Â¥${confirmation.transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
              ],
            ),
          ),

          SizedBox(height: 16),

          // è­¦å‘Šåˆ—è¡¨
          ...confirmation.warnings.map((warning) => Padding(
            padding: EdgeInsets.symmetric(vertical: 4),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Icon(
                  warning.severity == WarningSeverity.high
                      ? Icons.error
                      : Icons.warning_amber,
                  size: 20,
                  color: warning.severity == WarningSeverity.high
                      ? Colors.red
                      : Colors.orange,
                ),
                SizedBox(width: 8),
                Expanded(child: Text(warning.message)),
              ],
            ),
          )),

          SizedBox(height: 16),

          // é¢„ç®—çŠ¶æ€
          _buildBudgetBar(confirmation.budgetStatus),

          SizedBox(height: 16),

          // å†·é™æœŸæç¤º
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Icon(Icons.schedule, color: Colors.blue, size: 20),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'å»ºè®®ï¼šå¤§é¢æ¶ˆè´¹å‰å…ˆç­‰å¾…24å°æ—¶ï¼Œé¿å…å†²åŠ¨å†³ç­–',
                    style: TextStyle(color: Colors.blue.shade800, fontSize: 13),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: onCancel,
          child: Text('å–æ¶ˆ'),
        ),
        TextButton(
          onPressed: () => _setReminder(context, confirmation),
          child: Text('ç¨åæé†’æˆ‘'),
        ),
        ElevatedButton(
          onPressed: onConfirm,
          style: ElevatedButton.styleFrom(
            backgroundColor: headerColor,
          ),
          child: Text('ä»è¦è®°å½•'),
        ),
      ],
    );
  }
}
```

### 6.4 è´¢åŠ¡ç¼“å†²å»ºè®¾

#### 6.4.1 åº”æ€¥é‡‘ç›®æ ‡ç³»ç»Ÿ

```dart
/// åº”æ€¥é‡‘ç®¡ç†æœåŠ¡
class EmergencyFundService {
  /// è®¡ç®—æ¨èçš„åº”æ€¥é‡‘ç›®æ ‡
  Future<EmergencyFundRecommendation> calculateRecommendation() async {
    // è·å–æœ€è¿‘6ä¸ªæœˆçš„å¿…è¦æ”¯å‡º
    final essentialExpenses = await _getEssentialExpenses(months: 6);
    final monthlyEssential = essentialExpenses / 6;

    // æ¨èè¦†ç›–3-6ä¸ªæœˆ
    final minimum = monthlyEssential * 3;
    final recommended = monthlyEssential * 4;
    final ideal = monthlyEssential * 6;

    // è·å–å½“å‰åº”æ€¥é‡‘ä½™é¢
    final currentBalance = await _getEmergencyFundBalance();

    // è®¡ç®—ç¼ºå£
    final gap = recommended - currentBalance;

    // è®¡ç®—æŒ‰å½“å‰å‚¨è“„ç‡éœ€è¦å¤šä¹…
    final monthlySavings = await _getAverageMonthlySavings();
    final monthsToGoal = gap > 0 && monthlySavings > 0
        ? (gap / monthlySavings).ceil()
        : 0;

    return EmergencyFundRecommendation(
      monthlyEssentialExpense: monthlyEssential,
      minimumTarget: minimum,
      recommendedTarget: recommended,
      idealTarget: ideal,
      currentBalance: currentBalance,
      gap: gap,
      progress: currentBalance / recommended,
      monthsToGoal: monthsToGoal,
      suggestions: _generateSuggestions(currentBalance, recommended, monthlySavings),
    );
  }

  /// ç”Ÿæˆå»ºè®®
  List<String> _generateSuggestions(double current, double target, double savings) {
    final suggestions = <String>[];

    if (current < target * 0.1) {
      suggestions.add('ğŸš¨ åº”æ€¥é‡‘ä¸¥é‡ä¸è¶³ï¼Œå»ºè®®ä¼˜å…ˆå»ºç«‹åŸºç¡€å‚¨å¤‡');
      suggestions.add('å¯ä»¥ä»å‡å°‘å¯é€‰æ¶ˆè´¹å¼€å§‹ï¼Œæ¯æœˆå­˜å…¥æ”¶å…¥çš„10%');
    } else if (current < target * 0.5) {
      suggestions.add('ğŸ’ª å·²ç»èµ·æ­¥äº†ï¼ç»§ç»­ä¿æŒå‚¨è“„ä¹ æƒ¯');
      suggestions.add('å»ºè®®è®¾ç½®è‡ªåŠ¨è½¬è´¦ï¼Œå·¥èµ„åˆ°è´¦åè‡ªåŠ¨å­˜å…¥åº”æ€¥é‡‘');
    } else if (current < target) {
      suggestions.add('ğŸ‘ è¿›å±•è‰¯å¥½ï¼è·ç¦»ç›®æ ‡å·²ç»è¿‡åŠ');
      suggestions.add('å¯ä»¥è€ƒè™‘å°†å¹´ç»ˆå¥–ã€æ„å¤–æ”¶å…¥ä¼˜å…ˆè¡¥å……åº”æ€¥é‡‘');
    } else {
      suggestions.add('ğŸ‰ æ­å–œï¼æ‚¨çš„åº”æ€¥é‡‘å·²è¾¾åˆ°æ¨èæ°´å¹³');
      suggestions.add('ç°åœ¨å¯ä»¥è€ƒè™‘å…¶ä»–è´¢åŠ¡ç›®æ ‡ï¼Œå¦‚æŠ•èµ„æˆ–è¿˜å€º');
    }

    return suggestions;
  }
}

/// åº”æ€¥é‡‘è¿›åº¦å¡ç‰‡
class EmergencyFundCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final recommendation = ref.watch(emergencyFundRecommendationProvider);

    return recommendation.when(
      data: (data) => _buildCard(context, data),
      loading: () => _buildLoadingCard(),
      error: (e, _) => _buildErrorCard(e),
    );
  }

  Widget _buildCard(BuildContext context, EmergencyFundRecommendation data) {
    final progressColor = data.progress < 0.3
        ? Colors.red
        : data.progress < 0.7
            ? Colors.orange
            : Colors.green;

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.shield, color: Colors.blue),
                SizedBox(width: 8),
                Text('åº”æ€¥é‡‘', style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
                Spacer(),
                Text('${(data.progress * 100).toStringAsFixed(0)}%',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: progressColor,
                  )),
              ],
            ),

            SizedBox(height: 16),

            // ç›®æ ‡è¯´æ˜
            Text('ç›®æ ‡ï¼šè¦†ç›–${4}ä¸ªæœˆå¿…è¦æ”¯å‡º',
              style: TextStyle(color: Colors.grey)),
            Text('Â¥${data.currentBalance.toStringAsFixed(0)} / Â¥${data.recommendedTarget.toStringAsFixed(0)}',
              style: TextStyle(fontSize: 16)),

            SizedBox(height: 12),

            // è¿›åº¦æ¡ï¼ˆå¸¦é‡Œç¨‹ç¢‘ï¼‰
            _buildProgressBar(data),

            SizedBox(height: 16),

            // å‰©ä½™ç¼ºå£
            if (data.gap > 0) ...[
              Row(
                children: [
                  Text('è¿˜éœ€: '),
                  Text('Â¥${data.gap.toStringAsFixed(0)}',
                    style: TextStyle(fontWeight: FontWeight.bold)),
                  Spacer(),
                  if (data.monthsToGoal > 0)
                    Text('æŒ‰å½“å‰å‚¨è“„ç‡çº¦éœ€ ${data.monthsToGoal} ä¸ªæœˆ',
                      style: TextStyle(color: Colors.grey, fontSize: 12)),
                ],
              ),
            ],

            SizedBox(height: 12),

            // å»ºè®®
            ...data.suggestions.take(1).map((s) => Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(s, style: TextStyle(color: Colors.blue.shade800)),
            )),
          ],
        ),
      ),
    );
  }

  Widget _buildProgressBar(EmergencyFundRecommendation data) {
    return Column(
      children: [
        // é‡Œç¨‹ç¢‘æ ‡ç­¾
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text('3ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
            Text('4ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
            Text('6ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
          ],
        ),
        SizedBox(height: 4),
        // è¿›åº¦æ¡
        Stack(
          children: [
            // èƒŒæ™¯
            Container(
              height: 12,
              decoration: BoxDecoration(
                color: Colors.grey.shade200,
                borderRadius: BorderRadius.circular(6),
              ),
            ),
            // è¿›åº¦
            FractionallySizedBox(
              widthFactor: data.progress.clamp(0, 1),
              child: Container(
                height: 12,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.blue, Colors.green],
                  ),
                  borderRadius: BorderRadius.circular(6),
                ),
              ),
            ),
            // é‡Œç¨‹ç¢‘çº¿
            Positioned(
              left: MediaQuery.of(context).size.width * 0.5 - 32,  // 3/6 = 50%
              child: Container(width: 2, height: 12, color: Colors.grey),
            ),
            Positioned(
              left: MediaQuery.of(context).size.width * 0.67 - 32, // 4/6 â‰ˆ 67%
              child: Container(width: 2, height: 12, color: Colors.grey),
            ),
          ],
        ),
      ],
    );
  }
}
```

#### 6.4.2 é’±é¾„è¿›é˜¶ç›®æ ‡

```dart
/// é’±é¾„è¿›é˜¶å¼•å¯¼æœåŠ¡
class MoneyAgeProgressionService {
  /// é’±é¾„é˜¶æ®µå®šä¹‰
  static const List<MoneyAgeStage> stages = [
    MoneyAgeStage(
      level: 1,
      name: 'æœˆå…‰æ—',
      minAge: 0,
      maxAge: 7,
      description: 'æ”¶å…¥å¾ˆå¿«å°±èŠ±å®Œäº†',
      color: Colors.red,
      icon: Icons.warning,
      tips: ['è®¾ç½®ä¸€ä¸ªå°ç›®æ ‡ï¼šæ¯æœˆå­˜ä¸‹æ”¶å…¥çš„5%', 'å°è¯•è®°å½•æ¯ä¸€ç¬”æ¶ˆè´¹ï¼Œæ‰¾å‡º"æ¼è´¢"ç‚¹'],
    ),
    MoneyAgeStage(
      level: 2,
      name: 'èµ·æ­¥è€…',
      minAge: 7,
      maxAge: 14,
      description: 'æœ‰äº†ä¸€ç‚¹ç¼“å†²',
      color: Colors.orange,
      icon: Icons.directions_walk,
      tips: ['ç»§ç»­ä¿æŒï¼äº‰å–é’±é¾„çªç ´14å¤©', 'å¼€å§‹å»ºç«‹åº”æ€¥é‡‘è´¦æˆ·'],
    ),
    MoneyAgeStage(
      level: 3,
      name: 'ç¨³å¥è€…',
      minAge: 14,
      maxAge: 30,
      description: 'æœ‰åŠä¸ªæœˆä»¥ä¸Šçš„ç¼“å†²',
      color: Colors.blue,
      icon: Icons.trending_up,
      tips: ['ç›®æ ‡ï¼šèŠ±ä¸Šä¸ªæœˆçš„é’±', 'å¯ä»¥å¼€å§‹è€ƒè™‘æŠ•èµ„ç†è´¢äº†'],
    ),
    MoneyAgeStage(
      level: 4,
      name: 'ä»å®¹è€…',
      minAge: 30,
      maxAge: 60,
      description: 'èŠ±çš„æ˜¯ä¸Šä¸ªæœˆèµšçš„é’±',
      color: Colors.green,
      icon: Icons.verified,
      tips: ['æ­å–œè¾¾æˆ"èŠ±ä¸Šæœˆçš„é’±"ç›®æ ‡ï¼', 'ç»§ç»­ç§¯ç´¯ï¼Œå‘2ä¸ªæœˆç¼“å†²è¿›å‘'],
    ),
    MoneyAgeStage(
      level: 5,
      name: 'è´¢åŠ¡è‡ªç”±',
      minAge: 60,
      maxAge: 999,
      description: 'æœ‰å……è¶³çš„è´¢åŠ¡ç¼“å†²',
      color: Colors.purple,
      icon: Icons.military_tech,
      tips: ['æ‚¨çš„è´¢åŠ¡çŠ¶å†µéå¸¸å¥åº·', 'å¯ä»¥æ›´ä»å®¹åœ°è§„åˆ’é•¿æœŸç›®æ ‡'],
    ),
  ];

  /// è·å–ç”¨æˆ·å½“å‰é˜¶æ®µ
  MoneyAgeStage getCurrentStage(int moneyAgeDays) {
    return stages.firstWhere(
      (s) => moneyAgeDays >= s.minAge && moneyAgeDays < s.maxAge,
      orElse: () => stages.last,
    );
  }

  /// è·å–ä¸‹ä¸€é˜¶æ®µç›®æ ‡
  MoneyAgeStage? getNextStage(int moneyAgeDays) {
    final current = getCurrentStage(moneyAgeDays);
    final nextIndex = stages.indexOf(current) + 1;
    if (nextIndex >= stages.length) return null;
    return stages[nextIndex];
  }

  /// è®¡ç®—å‡çº§æ‰€éœ€
  UpgradeRequirement? calculateUpgradeRequirement(int currentAge) {
    final nextStage = getNextStage(currentAge);
    if (nextStage == null) return null;

    final daysNeeded = nextStage.minAge - currentAge;

    // ä¼°ç®—éœ€è¦å‚¨è“„å¤šå°‘
    final avgDailyExpense = await _getAverageDailyExpense();
    final amountNeeded = daysNeeded * avgDailyExpense;

    return UpgradeRequirement(
      targetStage: nextStage,
      daysNeeded: daysNeeded,
      amountNeeded: amountNeeded,
      estimatedTime: _estimateTimeToReach(amountNeeded),
    );
  }
}

/// é’±é¾„è¿›é˜¶å¡ç‰‡
class MoneyAgeProgressionCard extends StatelessWidget {
  final int currentMoneyAge;

  @override
  Widget build(BuildContext context) {
    final service = MoneyAgeProgressionService();
    final currentStage = service.getCurrentStage(currentMoneyAge);
    final nextStage = service.getNextStage(currentMoneyAge);

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // å½“å‰é˜¶æ®µ
            Row(
              children: [
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: currentStage.color.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(currentStage.icon, color: currentStage.color, size: 32),
                ),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Level ${currentStage.level}',
                        style: TextStyle(color: Colors.grey, fontSize: 12)),
                      Text(currentStage.name,
                        style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                      Text(currentStage.description,
                        style: TextStyle(color: Colors.grey)),
                    ],
                  ),
                ),
                Column(
                  children: [
                    Text('$currentMoneyAge', style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      color: currentStage.color,
                    )),
                    Text('å¤©', style: TextStyle(color: Colors.grey)),
                  ],
                ),
              ],
            ),

            SizedBox(height: 20),

            // ä¸‹ä¸€é˜¶æ®µç›®æ ‡
            if (nextStage != null) ...[
              Container(
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    Icon(Icons.flag, color: nextStage.color),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('ä¸‹ä¸€ç›®æ ‡: ${nextStage.name}',
                            style: TextStyle(fontWeight: FontWeight.bold)),
                          Text('é’±é¾„è¾¾åˆ° ${nextStage.minAge} å¤©',
                            style: TextStyle(color: Colors.grey, fontSize: 12)),
                        ],
                      ),
                    ),
                    Text('è¿˜å·® ${nextStage.minAge - currentMoneyAge} å¤©',
                      style: TextStyle(color: nextStage.color, fontWeight: FontWeight.bold)),
                  ],
                ),
              ),
            ],

            SizedBox(height: 16),

            // è¿›é˜¶æç¤º
            ...currentStage.tips.map((tip) => Padding(
              padding: EdgeInsets.symmetric(vertical: 4),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Icon(Icons.lightbulb_outline, size: 16, color: Colors.amber),
                  SizedBox(width: 8),
                  Expanded(child: Text(tip, style: TextStyle(fontSize: 13))),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }
}
```

### 6.5 å¼¹æ€§é¢„ç®—æœºåˆ¶

#### 6.5.1 çªå‘æ”¯å‡ºå¤„ç†

```dart
/// çªå‘æ”¯å‡ºå¤„ç†æœåŠ¡
class UnexpectedExpenseHandler {
  /// æ£€æµ‹çªå‘æ”¯å‡º
  bool isUnexpectedExpense(Transaction tx) {
    // æ¡ä»¶1ï¼šé‡‘é¢è¶…è¿‡æœˆå‡æ¶ˆè´¹çš„30%
    // æ¡ä»¶2ï¼šä¸åœ¨å¸¸è§„åˆ†ç±»ä¸­
    // æ¡ä»¶3ï¼šç”¨æˆ·æ ‡è®°ä¸ºçªå‘
    return tx.isMarkedAsUnexpected ||
           tx.amount > _monthlyAverage * 0.3 ||
           _isUnusualCategory(tx.categoryId);
  }

  /// å¤„ç†çªå‘æ”¯å‡º
  Future<UnexpectedExpenseResolution> handleUnexpectedExpense(
    Transaction tx,
    List<Budget> budgets,
  ) async {
    final options = <ResolutionOption>[];

    // é€‰é¡¹1ï¼šä»åº”æ€¥é‡‘æ”¯ä»˜
    final emergencyFund = await _getEmergencyFund();
    if (emergencyFund != null && emergencyFund.balance >= tx.amount) {
      options.add(ResolutionOption(
        type: ResolutionType.useEmergencyFund,
        description: 'ä»åº”æ€¥é‡‘æ”¯ä»˜',
        impact: 'åº”æ€¥é‡‘å‡å°‘ Â¥${tx.amount.toStringAsFixed(0)}',
        recommendation: tx.amount < emergencyFund.balance * 0.2
            ? RecommendationLevel.recommended
            : RecommendationLevel.cautious,
      ));
    }

    // é€‰é¡¹2ï¼šåˆ†æ‘Šåˆ°å¤šä¸ªé¢„ç®—
    final flexibleBudgets = budgets.where((b) =>
        b.type == BudgetType.flexible && b.remaining > 0).toList();
    if (flexibleBudgets.isNotEmpty) {
      final spreadPlan = _calculateSpreadPlan(tx.amount, flexibleBudgets);
      options.add(ResolutionOption(
        type: ResolutionType.spreadAcrossBudgets,
        description: 'åˆ†æ‘Šåˆ°${spreadPlan.length}ä¸ªé¢„ç®—',
        impact: spreadPlan.map((p) => '${p.budgetName}: -Â¥${p.amount.toStringAsFixed(0)}').join(', '),
        spreadPlan: spreadPlan,
        recommendation: RecommendationLevel.neutral,
      ));
    }

    // é€‰é¡¹3ï¼šè°ƒæ•´ä¸‹æœˆé¢„ç®—
    options.add(ResolutionOption(
      type: ResolutionType.adjustNextMonth,
      description: 'è®°å…¥æœ¬æœˆï¼Œä¸‹æœˆè¡¥å›',
      impact: 'ä¸‹æœˆå¯é€‰æ”¯å‡ºé¢„ç®—å‡å°‘ Â¥${tx.amount.toStringAsFixed(0)}',
      recommendation: RecommendationLevel.neutral,
    ));

    // é€‰é¡¹4ï¼šæ ‡è®°ä¸ºä¾‹å¤–ï¼ˆä¸å½±å“é¢„ç®—ç»Ÿè®¡ï¼‰
    options.add(ResolutionOption(
      type: ResolutionType.markAsException,
      description: 'æ ‡è®°ä¸ºä¾‹å¤–æ”¯å‡º',
      impact: 'ä¸è®¡å…¥é¢„ç®—ç»Ÿè®¡ï¼Œä½†ä¼šè®°å½•åœ¨æ¡ˆ',
      recommendation: RecommendationLevel.notRecommended,
      warning: 'é¢‘ç¹ä½¿ç”¨æ­¤é€‰é¡¹ä¼šå½±å“é¢„ç®—å‡†ç¡®æ€§',
    ));

    return UnexpectedExpenseResolution(
      transaction: tx,
      options: options,
      suggestedOption: _pickBestOption(options),
    );
  }

  /// è®¡ç®—åˆ†æ‘Šæ–¹æ¡ˆ
  List<SpreadItem> _calculateSpreadPlan(double amount, List<Budget> budgets) {
    final plan = <SpreadItem>[];
    var remaining = amount;

    // æŒ‰å‰©ä½™é‡‘é¢æ’åºï¼Œä»å¤šåˆ°å°‘åˆ†æ‘Š
    budgets.sort((a, b) => b.remaining.compareTo(a.remaining));

    for (final budget in budgets) {
      if (remaining <= 0) break;

      // æ¯ä¸ªé¢„ç®—æœ€å¤šåˆ†æ‘Šå…¶å‰©ä½™é¢åº¦çš„50%
      final maxSpread = budget.remaining * 0.5;
      final spread = min(remaining, maxSpread);

      if (spread > 0) {
        plan.add(SpreadItem(
          budgetId: budget.id,
          budgetName: budget.name,
          amount: spread,
        ));
        remaining -= spread;
      }
    }

    // å¦‚æœè¿˜æœ‰å‰©ä½™ï¼Œå‡åŒ€å†åˆ†é…
    if (remaining > 0 && plan.isNotEmpty) {
      final extraPerBudget = remaining / plan.length;
      for (final item in plan) {
        item.amount += extraPerBudget;
      }
    }

    return plan;
  }
}

/// çªå‘æ”¯å‡ºå¤„ç†å¼¹çª—
class UnexpectedExpenseDialog extends StatelessWidget {
  final UnexpectedExpenseResolution resolution;
  final Function(ResolutionOption) onSelect;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(Icons.bolt, color: Colors.orange),
          SizedBox(width: 8),
          Text('çªå‘æ”¯å‡ºå¤„ç†'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // æ”¯å‡ºä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.shade50,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Icon(Icons.receipt, color: Colors.orange),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(resolution.transaction.description ?? 'çªå‘æ”¯å‡º'),
                      Text(resolution.transaction.categoryName,
                        style: TextStyle(color: Colors.grey, fontSize: 12)),
                    ],
                  ),
                ),
                Text('Â¥${resolution.transaction.amount.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
              ],
            ),
          ),

          SizedBox(height: 16),

          Text('é€‰æ‹©å¤„ç†æ–¹å¼:', style: TextStyle(fontWeight: FontWeight.bold)),

          SizedBox(height: 12),

          // é€‰é¡¹åˆ—è¡¨
          ...resolution.options.map((option) => _buildOptionTile(option)),
        ],
      ),
    );
  }

  Widget _buildOptionTile(ResolutionOption option) {
    final isRecommended = option.recommendation == RecommendationLevel.recommended;
    final isCautious = option.recommendation == RecommendationLevel.cautious;
    final isNotRecommended = option.recommendation == RecommendationLevel.notRecommended;

    return Card(
      margin: EdgeInsets.symmetric(vertical: 4),
      color: isRecommended ? Colors.green.shade50 :
             isNotRecommended ? Colors.grey.shade100 : null,
      child: InkWell(
        onTap: () => onSelect(option),
        child: Padding(
          padding: EdgeInsets.all(12),
          child: Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(option.description,
                          style: TextStyle(fontWeight: FontWeight.w500)),
                        if (isRecommended) ...[
                          SizedBox(width: 8),
                          Container(
                            padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                            decoration: BoxDecoration(
                              color: Colors.green,
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text('æ¨è', style: TextStyle(
                              color: Colors.white, fontSize: 10)),
                          ),
                        ],
                      ],
                    ),
                    SizedBox(height: 4),
                    Text(option.impact, style: TextStyle(
                      color: Colors.grey, fontSize: 12)),
                    if (option.warning != null)
                      Text(option.warning!, style: TextStyle(
                        color: Colors.red, fontSize: 12)),
                  ],
                ),
              ),
              Icon(Icons.chevron_right, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 6.5.2 æ”¶å…¥ä¸ç¨³å®šé€‚é…

```dart
/// ä¸ç¨³å®šæ”¶å…¥é€‚é…æœåŠ¡
class VariableIncomeAdapter {
  /// åˆ†ææ”¶å…¥æ¨¡å¼
  Future<IncomePattern> analyzeIncomePattern() async {
    final incomes = await _transactionRepo.getIncomes(months: 12);

    if (incomes.length < 3) {
      return IncomePattern.unknown;
    }

    // è®¡ç®—æ”¶å…¥ç»Ÿè®¡
    final amounts = incomes.map((i) => i.amount).toList();
    final mean = amounts.reduce((a, b) => a + b) / amounts.length;
    final variance = amounts.map((a) => pow(a - mean, 2)).reduce((a, b) => a + b) / amounts.length;
    final stdDev = sqrt(variance);
    final cv = stdDev / mean;  // å˜å¼‚ç³»æ•°

    // æ£€æµ‹å‘¨æœŸæ€§
    final hasRegularPayday = _detectRegularPayday(incomes);

    if (cv < 0.1 && hasRegularPayday) {
      return IncomePattern.stable;  // å›ºå®šå·¥èµ„
    } else if (cv < 0.3) {
      return IncomePattern.slightlyVariable;  // æœ‰ææˆæˆ–å¥–é‡‘
    } else if (hasRegularPayday) {
      return IncomePattern.variableWithBase;  // æœ‰åº•è–ª+å¤§å¹…æµ®åŠ¨
    } else {
      return IncomePattern.highlyVariable;  // è‡ªç”±èŒä¸š/åˆ›ä¸š
    }
  }

  /// ä¸ºä¸ç¨³å®šæ”¶å…¥ç”Ÿæˆé¢„ç®—å»ºè®®
  Future<VariableIncomeBudgetPlan> generateBudgetPlan() async {
    final pattern = await analyzeIncomePattern();
    final incomes = await _transactionRepo.getIncomes(months: 6);
    final amounts = incomes.map((i) => i.amount).toList();

    // è®¡ç®—ä¿å®ˆæ”¶å…¥é¢„ä¼°
    final minIncome = amounts.reduce(min);
    final medianIncome = _calculateMedian(amounts);
    final p25Income = _calculatePercentile(amounts, 25);

    double recommendedBudgetBase;
    String budgetStrategy;

    switch (pattern) {
      case IncomePattern.stable:
        recommendedBudgetBase = medianIncome;
        budgetStrategy = 'ä½¿ç”¨æœˆå‡æ”¶å…¥ä½œä¸ºé¢„ç®—åŸºå‡†';
        break;

      case IncomePattern.slightlyVariable:
        recommendedBudgetBase = p25Income;
        budgetStrategy = 'ä½¿ç”¨ä¿å®ˆä¼°è®¡(25åˆ†ä½æ•°)ä½œä¸ºåŸºå‡†ï¼Œé¢å¤–æ”¶å…¥å­˜å…¥å‚¨è“„';
        break;

      case IncomePattern.variableWithBase:
        recommendedBudgetBase = minIncome;
        budgetStrategy = 'åªç”¨"ä¿åº•æ”¶å…¥"åšé¢„ç®—ï¼Œè¶…å‡ºéƒ¨åˆ†å…¨éƒ¨å‚¨è“„';
        break;

      case IncomePattern.highlyVariable:
        recommendedBudgetBase = p25Income * 0.8;
        budgetStrategy = 'é‡‡ç”¨"å…ˆå­˜åèŠ±"ç­–ç•¥ï¼šæ”¶å…¥å…ˆå­˜å…¥ç¼“å†²è´¦æˆ·ï¼Œå†æŒ‰æœˆåº¦é¢„ç®—æ”¯å–';
        break;

      default:
        recommendedBudgetBase = medianIncome * 0.7;
        budgetStrategy = 'æ•°æ®ä¸è¶³ï¼Œå»ºè®®ä½¿ç”¨ä¿å®ˆé¢„ç®—';
    }

    return VariableIncomeBudgetPlan(
      pattern: pattern,
      incomeStats: IncomeStats(
        min: minIncome,
        max: amounts.reduce(max),
        median: medianIncome,
        p25: p25Income,
      ),
      recommendedBudgetBase: recommendedBudgetBase,
      strategy: budgetStrategy,
      tips: _getTipsForPattern(pattern),
    );
  }

  List<String> _getTipsForPattern(IncomePattern pattern) {
    switch (pattern) {
      case IncomePattern.highlyVariable:
        return [
          'ğŸ”” æ”¶å…¥åˆ°è´¦æ—¶ï¼Œå…ˆå°†50%è½¬å…¥å‚¨è“„',
          'ğŸ“… è®¾å®šæ¯æœˆå›ºå®šæ—¥æœŸä½œä¸º"å‘è–ªæ—¥"ï¼Œä»å‚¨è“„è½¬åˆ°æ¶ˆè´¹è´¦æˆ·',
          'ğŸ’¡ æ”¶å…¥å¥½çš„æœˆä»½å¤šå­˜ï¼Œä¸ºæ”¶å…¥å·®çš„æœˆä»½åšç¼“å†²',
          'ğŸ¯ ç›®æ ‡ï¼šå‚¨è“„è¦†ç›–6ä¸ªæœˆæ”¯å‡º',
        ];

      case IncomePattern.variableWithBase:
        return [
          'ğŸ“Š ç”¨åº•è–ªè¦†ç›–å¿…è¦æ”¯å‡º',
          'ğŸ’° ææˆ/å¥–é‡‘ä¼˜å…ˆå­˜å…¥åº”æ€¥é‡‘',
          'ğŸ ç­‰åº”æ€¥é‡‘è¾¾æ ‡åï¼Œå†ç”¨æµ®åŠ¨æ”¶å…¥æ”¹å–„ç”Ÿæ´»',
        ];

      default:
        return [];
    }
  }
}

/// æ”¶å…¥æ¨¡å¼æšä¸¾
enum IncomePattern {
  unknown,           // æ•°æ®ä¸è¶³
  stable,            // ç¨³å®šæ”¶å…¥ï¼ˆå¦‚å›ºå®šå·¥èµ„ï¼‰
  slightlyVariable,  // è½»å¾®æµ®åŠ¨ï¼ˆæœ‰ç»©æ•ˆå¥–é‡‘ï¼‰
  variableWithBase,  // æœ‰åº•è–ªä½†æµ®åŠ¨å¤§
  highlyVariable,    // é«˜åº¦ä¸ç¨³å®šï¼ˆè‡ªç”±èŒä¸šï¼‰
}
```

### 6.6 ä¹ æƒ¯å…»æˆæ¿€åŠ±

#### 6.6.1 è¿ç»­è®°è´¦å¥–åŠ±

```dart
/// ä¹ æƒ¯è¿½è¸ªæœåŠ¡
class HabitTrackingService {
  /// è·å–è¿ç»­è®°è´¦å¤©æ•°
  Future<StreakInfo> getRecordingStreak() async {
    final today = DateTime.now().dateOnly;
    int streak = 0;
    var checkDate = today;

    while (true) {
      final hasRecord = await _transactionRepo.hasRecordsOnDate(checkDate);
      if (hasRecord) {
        streak++;
        checkDate = checkDate.subtract(Duration(days: 1));
      } else {
        break;
      }
    }

    // è·å–å†å²æœ€é•¿è¿ç»­
    final longestStreak = await _getLongestStreak();

    // è®¡ç®—ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘
    final nextMilestone = _getNextMilestone(streak);

    return StreakInfo(
      currentStreak: streak,
      longestStreak: longestStreak,
      nextMilestone: nextMilestone,
      daysToMilestone: nextMilestone - streak,
      isNewRecord: streak > longestStreak,
    );
  }

  int _getNextMilestone(int current) {
    const milestones = [7, 14, 30, 60, 90, 180, 365];
    for (final m in milestones) {
      if (current < m) return m;
    }
    return ((current ~/ 365) + 1) * 365;
  }
}

/// è¿ç»­è®°è´¦å¾½ç« 
class StreakBadge extends StatelessWidget {
  final StreakInfo streak;

  @override
  Widget build(BuildContext context) {
    final badgeColor = _getBadgeColor(streak.currentStreak);
    final badgeIcon = _getBadgeIcon(streak.currentStreak);

    return Container(
      padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [badgeColor.withOpacity(0.8), badgeColor],
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: badgeColor.withOpacity(0.3),
            blurRadius: 8,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(badgeIcon, color: Colors.white, size: 28),
          SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Text('${streak.currentStreak}',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    )),
                  Text(' å¤©è¿ç»­è®°è´¦',
                    style: TextStyle(color: Colors.white)),
                ],
              ),
              Text('è·ç¦»${streak.nextMilestone}å¤©è¿˜å·®${streak.daysToMilestone}å¤©',
                style: TextStyle(color: Colors.white70, fontSize: 12)),
            ],
          ),
          if (streak.isNewRecord) ...[
            SizedBox(width: 12),
            Container(
              padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: Colors.amber,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Text('æ–°çºªå½•!', style: TextStyle(
                color: Colors.black87,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              )),
            ),
          ],
        ],
      ),
    );
  }

  Color _getBadgeColor(int days) {
    if (days >= 365) return Colors.purple;
    if (days >= 90) return Colors.amber.shade700;
    if (days >= 30) return Colors.blue;
    if (days >= 7) return Colors.green;
    return Colors.grey;
  }

  IconData _getBadgeIcon(int days) {
    if (days >= 365) return Icons.military_tech;
    if (days >= 90) return Icons.workspace_premium;
    if (days >= 30) return Icons.emoji_events;
    if (days >= 7) return Icons.local_fire_department;
    return Icons.timer;
  }
}
```

#### 6.6.2 è´¢åŠ¡å¥åº·åˆ†æ•°

```dart
/// è´¢åŠ¡å¥åº·è¯„åˆ†æœåŠ¡
class FinancialHealthScoreService {
  /// è®¡ç®—ç»¼åˆè´¢åŠ¡å¥åº·åˆ†
  Future<FinancialHealthScore> calculateScore() async {
    final scores = <String, ScoreComponent>{};

    // 1. é’±é¾„å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final moneyAge = await _moneyAgeService.getCurrentAge();
    scores['moneyAge'] = ScoreComponent(
      name: 'é’±é¾„',
      score: _scoreMoneyAge(moneyAge),
      maxScore: 20,
      status: _getMoneyAgeStatus(moneyAge),
      tip: _getMoneyAgeTip(moneyAge),
    );

    // 2. é¢„ç®—æ§åˆ¶å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final budgetAdherence = await _getBudgetAdherence();
    scores['budget'] = ScoreComponent(
      name: 'é¢„ç®—æ§åˆ¶',
      score: _scoreBudgetAdherence(budgetAdherence),
      maxScore: 20,
      status: budgetAdherence > 0.9 ? 'ä¼˜ç§€' : budgetAdherence > 0.7 ? 'è‰¯å¥½' : 'éœ€æ”¹è¿›',
      tip: budgetAdherence < 0.7 ? 'å»ºè®®å®¡è§†è¶…æ”¯åˆ†ç±»ï¼Œè°ƒæ•´é¢„ç®—æˆ–æ¶ˆè´¹ä¹ æƒ¯' : null,
    );

    // 3. åº”æ€¥é‡‘å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final emergencyProgress = await _getEmergencyFundProgress();
    scores['emergency'] = ScoreComponent(
      name: 'åº”æ€¥é‡‘',
      score: (emergencyProgress * 20).round(),
      maxScore: 20,
      status: emergencyProgress >= 1 ? 'è¾¾æ ‡' : 'å»ºè®¾ä¸­',
      tip: emergencyProgress < 0.5 ? 'å»ºè®®ä¼˜å…ˆç§¯ç´¯åº”æ€¥é‡‘' : null,
    );

    // 4. æ¶ˆè´¹ç»“æ„å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final necessityReport = await _necessityAnalyzer.analyzeSpendingStructure();
    scores['structure'] = ScoreComponent(
      name: 'æ¶ˆè´¹ç»“æ„',
      score: (necessityReport.healthScore * 0.2).round(),
      maxScore: 20,
      status: necessityReport.healthScore > 80 ? 'å¥åº·' : 'å¾…ä¼˜åŒ–',
      tip: necessityReport.optionalPercentage > 0.3 ? 'å¯é€‰æ¶ˆè´¹å æ¯”è¾ƒé«˜' : null,
    );

    // 5. è®°è´¦ä¹ æƒ¯å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final streak = await _habitTracker.getRecordingStreak();
    final recordingConsistency = await _getRecordingConsistency();
    scores['habit'] = ScoreComponent(
      name: 'è®°è´¦ä¹ æƒ¯',
      score: _scoreRecordingHabit(streak.currentStreak, recordingConsistency),
      maxScore: 20,
      status: streak.currentStreak >= 30 ? 'åšæŒä¸­' : 'éœ€åŠ æ²¹',
      tip: streak.currentStreak < 7 ? 'å…»æˆæ¯æ—¥è®°è´¦ä¹ æƒ¯æ˜¯è´¢åŠ¡ç®¡ç†çš„åŸºç¡€' : null,
    );

    // è®¡ç®—æ€»åˆ†
    final totalScore = scores.values.fold(0, (sum, c) => sum + c.score);
    final maxScore = scores.values.fold(0, (sum, c) => sum + c.maxScore);

    return FinancialHealthScore(
      totalScore: totalScore,
      maxScore: maxScore,
      percentage: totalScore / maxScore,
      level: _getLevel(totalScore),
      components: scores,
      primaryImprovementArea: _findWeakestArea(scores),
      comparisonToLastMonth: await _compareToLastMonth(totalScore),
    );
  }

  String _getLevel(int score) {
    if (score >= 90) return 'è´¢åŠ¡ä¼˜ç­‰ç”Ÿ';
    if (score >= 75) return 'è´¢åŠ¡è‰¯å¥½';
    if (score >= 60) return 'è´¢åŠ¡åŠæ ¼';
    if (score >= 40) return 'éœ€è¦åŠªåŠ›';
    return 'è´¢åŠ¡é¢„è­¦';
  }

  int _scoreMoneyAge(int days) {
    if (days >= 60) return 20;
    if (days >= 30) return 16;
    if (days >= 14) return 12;
    if (days >= 7) return 8;
    return (days * 8 / 7).round();
  }
}

/// è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜
class FinancialHealthDashboard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final score = ref.watch(financialHealthScoreProvider);

    return score.when(
      data: (data) => Card(
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              // æ€»åˆ†å±•ç¤º
              Row(
                children: [
                  _buildScoreGauge(data),
                  SizedBox(width: 20),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(data.level, style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        )),
                        if (data.comparisonToLastMonth != 0)
                          Row(
                            children: [
                              Icon(
                                data.comparisonToLastMonth > 0
                                    ? Icons.trending_up
                                    : Icons.trending_down,
                                color: data.comparisonToLastMonth > 0
                                    ? Colors.green
                                    : Colors.red,
                                size: 16,
                              ),
                              Text(
                                'è¾ƒä¸Šæœˆ${data.comparisonToLastMonth > 0 ? '+' : ''}${data.comparisonToLastMonth}åˆ†',
                                style: TextStyle(
                                  color: data.comparisonToLastMonth > 0
                                      ? Colors.green
                                      : Colors.red,
                                ),
                              ),
                            ],
                          ),
                      ],
                    ),
                  ),
                ],
              ),

              SizedBox(height: 20),

              // å„é¡¹å¾—åˆ†
              ...data.components.entries.map((e) => _buildScoreItem(e.value)),

              SizedBox(height: 16),

              // æ”¹è¿›å»ºè®®
              if (data.primaryImprovementArea != null)
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.amber.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.tips_and_updates, color: Colors.amber.shade700),
                      SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text('ä¼˜å…ˆæ”¹è¿›: ${data.primaryImprovementArea!.name}',
                              style: TextStyle(fontWeight: FontWeight.bold)),
                            if (data.primaryImprovementArea!.tip != null)
                              Text(data.primaryImprovementArea!.tip!,
                                style: TextStyle(fontSize: 13)),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
            ],
          ),
        ),
      ),
      loading: () => CircularProgressIndicator(),
      error: (e, _) => Text('Error: $e'),
    );
  }
}
```

---

## 7. AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ

### 7.1 AIèƒ½åŠ›æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿæ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   è¾“å…¥å±‚                  è¯†åˆ«å±‚                   è¾“å‡ºå±‚          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  è¯­éŸ³   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ è¯­éŸ³ASR â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  æ–‡æœ¬   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                      â”‚            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  å›¾ç‰‡   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ å›¾åƒOCR â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  æ–‡æœ¬   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                      â”‚            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
â”‚   â”‚æ‰‹åŠ¨è¾“å…¥ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  æ–‡æœ¬   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                      â”‚            â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
â”‚                          â”‚ è¯­ä¹‰NLU â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ç»Ÿä¸€æ–‡æœ¬â”‚       â”‚
â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                               â”‚                                   â”‚
â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚ç»“æ„åŒ–æ•°æ®â”‚                              â”‚
â”‚                          â”‚é‡‘é¢+åˆ†ç±»â”‚                              â”‚
â”‚                          â”‚+æ—¥æœŸ+å¤‡æ³¨â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è¯­éŸ³è¯†åˆ«å¢å¼º

#### 7.2.1 å®æ—¶è¯­éŸ³è¯†åˆ«

```dart
/// è¯­éŸ³è¯†åˆ«æœåŠ¡ï¼ˆå¢å¼ºç‰ˆï¼‰
class EnhancedVoiceRecognitionService {
  final AudioRecorder _recorder;
  final SpeechToText _stt;
  final NLUService _nluService;

  /// å¼€å§‹å®æ—¶è¯†åˆ«
  Stream<VoiceRecognitionResult> startRealTimeRecognition() async* {
    await _recorder.start();

    // å®æ—¶è½¬å†™
    await for (final audio in _recorder.audioStream) {
      final text = await _stt.transcribe(audio);
      if (text.isNotEmpty) {
        // å®æ—¶NLUè§£æ
        final parsed = await _nluService.parseExpenseText(text);
        yield VoiceRecognitionResult(
          rawText: text,
          parsedData: parsed,
          confidence: parsed.confidence,
        );
      }
    }
  }

  /// åœæ­¢è¯†åˆ«å¹¶è·å–æœ€ç»ˆç»“æœ
  Future<FinalRecognitionResult> stopAndFinalize() async {
    final finalAudio = await _recorder.stop();
    final finalText = await _stt.transcribeFinal(finalAudio);
    final parsed = await _nluService.parseExpenseText(finalText);

    return FinalRecognitionResult(
      rawText: finalText,
      parsedData: parsed,
      suggestedTransactions: await _generateSuggestions(parsed),
    );
  }
}

/// è‡ªç„¶è¯­è¨€ç†è§£æœåŠ¡
class NLUService {
  /// è§£ææ”¯å‡ºæ–‡æœ¬
  Future<ParsedExpenseData> parseExpenseText(String text) async {
    // ä½¿ç”¨å¤§æ¨¡å‹è§£æ
    final response = await _callLLM('''
      è¯·ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–è®°è´¦ä¿¡æ¯ï¼š
      "$text"

      è¯·è¿”å›JSONæ ¼å¼ï¼š
      {
        "amount": æ•°å­—,
        "category": "åˆ†ç±»å",
        "description": "æè¿°",
        "date": "YYYY-MM-DD æˆ– null",
        "confidence": 0-1çš„ç½®ä¿¡åº¦
      }
    ''');

    return ParsedExpenseData.fromJson(jsonDecode(response));
  }
}
```

#### 7.2.2 å¤šè½®å¯¹è¯æ”¯æŒ

```dart
/// å¤šè½®å¯¹è¯è®°è´¦
class ConversationalBookkeeping {
  final List<DialogTurn> _history = [];
  Transaction? _pendingTransaction;

  /// å¤„ç†ç”¨æˆ·è¾“å…¥
  Future<DialogResponse> processInput(String input) async {
    _history.add(DialogTurn(role: 'user', content: input));

    if (_pendingTransaction == null) {
      // æ–°å¯¹è¯ï¼šå°è¯•è§£æå®Œæ•´äº¤æ˜“
      final parsed = await _parseNewTransaction(input);
      if (parsed.isComplete) {
        return DialogResponse(
          message: 'å·²è®°å½•ï¼š${parsed.transaction.description} Â¥${parsed.transaction.amount}',
          transaction: parsed.transaction,
          isComplete: true,
        );
      } else {
        _pendingTransaction = parsed.transaction;
        return DialogResponse(
          message: parsed.nextQuestion,
          isComplete: false,
        );
      }
    } else {
      // ç»§ç»­å¯¹è¯ï¼šè¡¥å……ä¿¡æ¯
      return await _continueConversation(input);
    }
  }

  /// ç»§ç»­å¯¹è¯è¡¥å……ä¿¡æ¯
  Future<DialogResponse> _continueConversation(String input) async {
    final tx = _pendingTransaction!;

    // æ ¹æ®ç¼ºå¤±å­—æ®µç†è§£ç”¨æˆ·è¾“å…¥
    if (tx.amount == 0) {
      final amount = _extractAmount(input);
      if (amount != null) {
        tx.amount = amount;
      }
    } else if (tx.categoryId == null) {
      final category = await _matchCategory(input);
      if (category != null) {
        tx.categoryId = category.id;
      }
    }

    // æ£€æŸ¥æ˜¯å¦å®Œæ•´
    if (_isTransactionComplete(tx)) {
      _pendingTransaction = null;
      return DialogResponse(
        message: 'å·²è®°å½•ï¼š${tx.description} Â¥${tx.amount}',
        transaction: tx,
        isComplete: true,
      );
    }

    return DialogResponse(
      message: _getNextQuestion(tx),
      isComplete: false,
    );
  }
}
```

### 7.3 å›¾åƒè¯†åˆ«å¢å¼º

#### 7.3.1 å¤šç±»å‹ç¥¨æ®è¯†åˆ«

```dart
/// ç¥¨æ®è¯†åˆ«æœåŠ¡
class ReceiptRecognitionService {
  final OCRService _ocrService;
  final ReceiptParser _parser;

  /// è¯†åˆ«ç¥¨æ®å›¾ç‰‡
  Future<ReceiptRecognitionResult> recognizeReceipt(File imageFile) async {
    // 1. OCRæå–æ–‡æœ¬
    final ocrResult = await _ocrService.extractText(imageFile);

    // 2. æ£€æµ‹ç¥¨æ®ç±»å‹
    final receiptType = _detectReceiptType(ocrResult);

    // 3. æ ¹æ®ç±»å‹è§£æ
    switch (receiptType) {
      case ReceiptType.supermarket:
        return _parseSupermarketReceipt(ocrResult);
      case ReceiptType.restaurant:
        return _parseRestaurantReceipt(ocrResult);
      case ReceiptType.taxi:
        return _parseTaxiReceipt(ocrResult);
      case ReceiptType.hotel:
        return _parseHotelReceipt(ocrResult);
      case ReceiptType.bankStatement:
        return _parseBankStatement(ocrResult);
      default:
        return _parseGenericReceipt(ocrResult);
    }
  }

  /// è¶…å¸‚å°ç¥¨è§£æï¼ˆæ”¯æŒå¤šé¡¹å•†å“ï¼‰
  Future<ReceiptRecognitionResult> _parseSupermarketReceipt(OCRResult ocr) async {
    final items = <ReceiptItem>[];

    // ä½¿ç”¨æ­£åˆ™å’Œæ¨¡å¼åŒ¹é…æå–å•†å“è¡Œ
    final itemPattern = RegExp(r'(.+?)\s+(\d+\.?\d*)\s*[xÃ—]\s*(\d+\.?\d*)\s*=?\s*(\d+\.?\d*)');

    for (final line in ocr.lines) {
      final match = itemPattern.firstMatch(line.text);
      if (match != null) {
        items.add(ReceiptItem(
          name: match.group(1)!.trim(),
          unitPrice: double.parse(match.group(2)!),
          quantity: double.parse(match.group(3)!),
          totalPrice: double.parse(match.group(4)!),
        ));
      }
    }

    // æå–æ€»é‡‘é¢
    final totalAmount = _extractTotalAmount(ocr);

    // æå–å•†å®¶åç§°
    final merchantName = _extractMerchantName(ocr);

    // æå–æ—¥æœŸ
    final date = _extractDate(ocr);

    return ReceiptRecognitionResult(
      type: ReceiptType.supermarket,
      merchantName: merchantName,
      date: date,
      totalAmount: totalAmount,
      items: items,
      suggestedCategory: 'è´­ç‰©',
      rawText: ocr.fullText,
    );
  }
}
```

#### 7.3.2 æˆªå›¾æ™ºèƒ½è§£æ

```dart
/// æ”¯ä»˜æˆªå›¾è§£æ
class PaymentScreenshotParser {
  /// æ”¯æŒçš„å¹³å°
  static const supportedPlatforms = ['å¾®ä¿¡', 'æ”¯ä»˜å®', 'äº‘é—ªä»˜', 'é“¶è¡ŒAPP'];

  /// è§£ææ”¯ä»˜æˆªå›¾
  Future<PaymentScreenshotResult> parse(File screenshot) async {
    final ocrResult = await _ocrService.extractText(screenshot);

    // æ£€æµ‹æ”¯ä»˜å¹³å°
    final platform = _detectPlatform(ocrResult);

    // æ ¹æ®å¹³å°ç‰¹å®šå¸ƒå±€è§£æ
    switch (platform) {
      case PaymentPlatform.wechat:
        return _parseWechatPayment(ocrResult);
      case PaymentPlatform.alipay:
        return _parseAlipayPayment(ocrResult);
      default:
        return _parseGenericPayment(ocrResult);
    }
  }

  /// å¾®ä¿¡æ”¯ä»˜æˆªå›¾è§£æ
  Future<PaymentScreenshotResult> _parseWechatPayment(OCRResult ocr) async {
    // å¾®ä¿¡æ”¯ä»˜ç‰¹å¾ï¼š
    // - "å¾®ä¿¡æ”¯ä»˜" æˆ– "æ”¯ä»˜æˆåŠŸ" æ ‡é¢˜
    // - é‡‘é¢é€šå¸¸åœ¨ä¸­é—´å¤§å­—ä½“ä½ç½®
    // - "æ”¶æ¬¾æ–¹"ã€"æ”¯ä»˜æ—¶é—´" ç­‰æ ‡ç­¾

    String? amount;
    String? merchant;
    DateTime? paymentTime;

    for (int i = 0; i < ocr.lines.length; i++) {
      final line = ocr.lines[i].text;

      // æ£€æµ‹é‡‘é¢ï¼ˆé€šå¸¸æ˜¯æœ€å¤§çš„æ•°å­—ï¼‰
      if (line.contains('Â¥') || line.contains('ï¿¥')) {
        amount = _extractAmountFromLine(line);
      }

      // æ£€æµ‹æ”¶æ¬¾æ–¹
      if (line.contains('æ”¶æ¬¾æ–¹') && i + 1 < ocr.lines.length) {
        merchant = ocr.lines[i + 1].text.trim();
      }

      // æ£€æµ‹æ—¶é—´
      if (line.contains('æ”¯ä»˜æ—¶é—´') || line.contains('äº¤æ˜“æ—¶é—´')) {
        paymentTime = _extractDateTime(line);
      }
    }

    return PaymentScreenshotResult(
      platform: PaymentPlatform.wechat,
      amount: double.tryParse(amount ?? '0') ?? 0,
      merchant: merchant,
      paymentTime: paymentTime,
      suggestedDescription: merchant ?? 'å¾®ä¿¡æ”¯ä»˜',
    );
  }
}
```

### 7.4 æ™ºèƒ½åˆ†ç±»æ¨è

```dart
/// æ™ºèƒ½åˆ†ç±»æ¨èæœåŠ¡
class SmartCategoryService {
  final CategoryRepository _categoryRepo;
  final TransactionRepository _transactionRepo;
  final MLModel _mlModel;

  /// æ¨èåˆ†ç±»
  Future<List<CategorySuggestion>> suggestCategories({
    required String description,
    required double amount,
    String? merchant,
  }) async {
    final suggestions = <CategorySuggestion>[];

    // 1. åŸºäºå…³é”®è¯åŒ¹é…
    final keywordMatches = await _matchByKeywords(description);
    suggestions.addAll(keywordMatches.map((c) => CategorySuggestion(
      category: c,
      confidence: 0.8,
      reason: 'å…³é”®è¯åŒ¹é…',
    )));

    // 2. åŸºäºå•†å®¶å†å²
    if (merchant != null) {
      final merchantHistory = await _transactionRepo.findByMerchant(merchant);
      if (merchantHistory.isNotEmpty) {
        final categoryCounts = <String, int>{};
        for (final tx in merchantHistory) {
          categoryCounts[tx.categoryId] = (categoryCounts[tx.categoryId] ?? 0) + 1;
        }
        final topCategoryId = categoryCounts.entries
            .reduce((a, b) => a.value > b.value ? a : b).key;
        final category = await _categoryRepo.getById(topCategoryId);
        suggestions.add(CategorySuggestion(
          category: category,
          confidence: 0.9,
          reason: 'å•†å®¶å†å²è®°å½•',
        ));
      }
    }

    // 3. åŸºäºé‡‘é¢åŒºé—´
    final amountBasedCategory = await _suggestByAmount(amount);
    if (amountBasedCategory != null) {
      suggestions.add(CategorySuggestion(
        category: amountBasedCategory,
        confidence: 0.6,
        reason: 'é‡‘é¢åŒºé—´æ¨æ–­',
      ));
    }

    // 4. MLæ¨¡å‹é¢„æµ‹
    final mlPrediction = await _mlModel.predictCategory(
      description: description,
      amount: amount,
      merchant: merchant,
    );
    suggestions.add(CategorySuggestion(
      category: mlPrediction.category,
      confidence: mlPrediction.confidence,
      reason: 'AIé¢„æµ‹',
    ));

    // å»é‡å¹¶æŒ‰ç½®ä¿¡åº¦æ’åº
    return _deduplicateAndSort(suggestions);
  }
}
```

---

## 8. æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ

### 8.1 æ™ºèƒ½å¯¼å…¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ™ºèƒ½æ•°æ®å¯¼å…¥æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚æ–‡ä»¶ä¸Šä¼  â”‚â”€â”€â”€â”€â†’â”‚æ ¼å¼æ£€æµ‹ â”‚â”€â”€â”€â”€â†’â”‚æ•°æ®è§£æ â”‚â”€â”€â”€â”€â†’â”‚å­—æ®µæ˜ å°„ â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚            â”‚
â”‚                                                      â–¼            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚å¯¼å…¥å®Œæˆ â”‚â†â”€â”€â”€â”€â”‚æ•°æ®å†™å…¥ â”‚â†â”€â”€â”€â”€â”‚ç”¨æˆ·ç¡®è®¤ â”‚â†â”€â”€â”€â”€â”‚æ™ºèƒ½å»é‡ â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ”¯æŒçš„æ•°æ®æº

| æ•°æ®æº | æ ¼å¼ | è§£æç­–ç•¥ |
|--------|------|----------|
| å¾®ä¿¡è´¦å• | CSV | ç‰¹å®šæ¨¡æ¿è§£æ |
| æ”¯ä»˜å®è´¦å• | CSV | ç‰¹å®šæ¨¡æ¿è§£æ |
| é“¶è¡Œæµæ°´ | CSV/Excel | æ™ºèƒ½åˆ—æ˜ å°„ |
| å…¶ä»–APP | CSV | é€šç”¨è§£æ+ç”¨æˆ·æ˜ å°„ |
| Excel | xlsx | è¡¨æ ¼è§£æ |
| æ‰‹åŠ¨CSV | CSV | è‡ªå®šä¹‰æ¨¡æ¿ |

### 8.3 ä¸‰å±‚å»é‡æœºåˆ¶

```dart
/// ä¸‰å±‚å»é‡æœåŠ¡
class DeduplicationService {
  /// ç¬¬ä¸€å±‚ï¼šç²¾ç¡®åŒ¹é…
  /// ç›¸åŒé‡‘é¢ + ç›¸åŒæ—¥æœŸ + ç›¸åŒæè¿° = ç¡®å®šé‡å¤
  Future<List<Transaction>> exactMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getAll();
    final duplicates = <Transaction>[];

    for (final newTx in newTxs) {
      final isDuplicate = existing.any((ex) =>
        ex.amount == newTx.amount &&
        ex.date == newTx.date &&
        ex.description == newTx.description
      );
      if (isDuplicate) {
        duplicates.add(newTx);
      }
    }

    return duplicates;
  }

  /// ç¬¬äºŒå±‚ï¼šç‰¹å¾åŒ¹é…
  /// ç›¸åŒé‡‘é¢ + æ—¥æœŸç›¸è¿‘(Â±1å¤©) + æè¿°ç›¸ä¼¼(>80%) = å¯èƒ½é‡å¤
  Future<List<PotentialDuplicate>> featureMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getAll();
    final potentials = <PotentialDuplicate>[];

    for (final newTx in newTxs) {
      for (final ex in existing) {
        if (ex.amount == newTx.amount) {
          final dateDiff = ex.date.difference(newTx.date).inDays.abs();
          if (dateDiff <= 1) {
            final similarity = _stringSimilarity(ex.description, newTx.description);
            if (similarity > 0.8) {
              potentials.add(PotentialDuplicate(
                newTransaction: newTx,
                existingTransaction: ex,
                confidence: 0.7 + similarity * 0.3,
                reason: 'é‡‘é¢ç›¸åŒ,æ—¥æœŸç›¸è¿‘,æè¿°ç›¸ä¼¼',
              ));
            }
          }
        }
      }
    }

    return potentials;
  }

  /// ç¬¬ä¸‰å±‚ï¼šè¯­ä¹‰åŒ¹é…
  /// ä½¿ç”¨AIåˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ç¬”äº¤æ˜“
  Future<List<SemanticDuplicate>> semanticMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getRecent(days: 30);
    final semanticDuplicates = <SemanticDuplicate>[];

    for (final newTx in newTxs) {
      // æ‰¾å‡ºé‡‘é¢ç›¸è¿‘çš„å€™é€‰
      final candidates = existing.where((ex) =>
        (ex.amount - newTx.amount).abs() < 1.0 && // é‡‘é¢å·®å¼‚å°äº1å…ƒ
        ex.date.difference(newTx.date).inDays.abs() <= 3
      ).toList();

      if (candidates.isNotEmpty) {
        // ä½¿ç”¨AIåˆ¤æ–­
        final aiResult = await _aiService.checkDuplicate(
          newTransaction: newTx,
          candidates: candidates,
        );

        if (aiResult.isDuplicate && aiResult.confidence > 0.7) {
          semanticDuplicates.add(SemanticDuplicate(
            newTransaction: newTx,
            matchedTransaction: aiResult.matchedTransaction,
            confidence: aiResult.confidence,
            aiExplanation: aiResult.explanation,
          ));
        }
      }
    }

    return semanticDuplicates;
  }
}
```

### 8.4 å¯¼å…¥é¢„è§ˆä¸ç¡®è®¤

```dart
/// å¯¼å…¥é¢„è§ˆé¡µé¢
class ImportPreviewPage extends ConsumerWidget {
  final List<ParsedTransaction> parsedData;
  final List<DeduplicationResult> deduplicationResults;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(
        title: Text('ç¡®è®¤å¯¼å…¥'),
        actions: [
          TextButton(
            onPressed: () => _startImport(context, ref),
            child: Text('å¯¼å…¥'),
          ),
        ],
      ),
      body: Column(
        children: [
          // æ‘˜è¦å¡ç‰‡
          _ImportSummaryCard(
            totalCount: parsedData.length,
            newCount: _getNewCount(),
            duplicateCount: _getDuplicateCount(),
            suspiciousCount: _getSuspiciousCount(),
          ),

          // åˆ†ç±»æ ‡ç­¾é¡µ
          Expanded(
            child: DefaultTabController(
              length: 3,
              child: Column(
                children: [
                  TabBar(
                    tabs: [
                      Tab(text: 'æ–°è®°å½• (${_getNewCount()})'),
                      Tab(text: 'ç–‘ä¼¼é‡å¤ (${_getSuspiciousCount()})'),
                      Tab(text: 'ç¡®è®¤é‡å¤ (${_getDuplicateCount()})'),
                    ],
                  ),
                  Expanded(
                    child: TabBarView(
                      children: [
                        _NewTransactionsList(),
                        _SuspiciousList(),
                        _DuplicatesList(),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}
```

### 8.5 æ•°æ®å¯¼å‡º

```dart
/// æ•°æ®å¯¼å‡ºæœåŠ¡
class ExportService {
  /// å¯¼å‡ºä¸ºCSV
  Future<File> exportToCsv({
    required DateRange range,
    List<String>? accountIds,
    List<String>? categoryIds,
    List<String> fields = const ['date', 'amount', 'category', 'description', 'account'],
  }) async {
    final transactions = await _fetchTransactions(range, accountIds, categoryIds);

    final csv = StringBuffer();

    // å†™å…¥è¡¨å¤´
    csv.writeln(fields.map((f) => _getFieldHeader(f)).join(','));

    // å†™å…¥æ•°æ®
    for (final tx in transactions) {
      final row = fields.map((f) => _getFieldValue(tx, f)).join(',');
      csv.writeln(row);
    }

    // ä¿å­˜æ–‡ä»¶
    final file = await _saveToFile(csv.toString(), 'export_${DateTime.now().toIso8601String()}.csv');
    return file;
  }

  /// å¯¼å‡ºä¸ºExcel
  Future<File> exportToExcel({
    required DateRange range,
    bool includeCharts = false,
    bool includeSummary = true,
  }) async {
    final excel = Excel.createExcel();

    // åˆ›å»ºäº¤æ˜“æ˜ç»†è¡¨
    final detailSheet = excel['äº¤æ˜“æ˜ç»†'];
    await _populateDetailSheet(detailSheet, range);

    // åˆ›å»ºåˆ†ç±»æ±‡æ€»è¡¨
    if (includeSummary) {
      final summarySheet = excel['åˆ†ç±»æ±‡æ€»'];
      await _populateSummarySheet(summarySheet, range);
    }

    // ä¿å­˜æ–‡ä»¶
    final bytes = excel.encode();
    final file = await _saveToFile(bytes!, 'export_${DateTime.now().toIso8601String()}.xlsx');
    return file;
  }
}
```

---

## 9. æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–

### 9.1 æ•°æ®è”åŠ¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®è”åŠ¨æ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   å…¥å£å±‚ (Dashboard)                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚æœˆåº¦æ¦‚è§ˆâ”‚ â”‚é’±é¾„å¡ç‰‡â”‚ â”‚é¢„ç®—å¡ç‰‡â”‚ â”‚æ”¶æ”¯å¡ç‰‡â”‚ â”‚è´¦æˆ·å¡ç‰‡â”‚         â”‚
â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚          â”‚          â”‚          â”‚          â”‚               â”‚
â”‚       â–¼          â–¼          â–¼          â–¼          â–¼               â”‚
â”‚   åˆ†æå±‚ (Detail Pages)                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  è¯¦ç»†å›¾è¡¨  â”‚  è¶‹åŠ¿åˆ†æ  â”‚  åˆ†å¸ƒç»Ÿè®¡  â”‚  å¯¹æ¯”åˆ†æ     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                             â”‚                                      â”‚
â”‚                             â–¼                                      â”‚
â”‚   æ•°æ®å±‚ (Transaction List)                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚              å…·ä½“äº¤æ˜“è®°å½•åˆ—è¡¨                           â”‚      â”‚
â”‚   â”‚              æ”¯æŒç­›é€‰ã€æ’åºã€ç¼–è¾‘                       â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 äº¤äº’å¼å›¾è¡¨ç»„ä»¶

```dart
/// å¯ä¸‹é’»çš„é¥¼å›¾ç»„ä»¶
class DrillDownPieChart extends StatelessWidget {
  final List<PieChartData> data;
  final String title;
  final Function(PieChartData item)? onSegmentTap;

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text(title, style: Theme.of(context).textTheme.titleMedium),
        SizedBox(height: 16),
        AspectRatio(
          aspectRatio: 1.3,
          child: PieChart(
            PieChartData(
              sections: data.map((item) => PieChartSectionData(
                value: item.value,
                color: item.color,
                title: '${item.percentage.toStringAsFixed(1)}%',
                radius: 80,
                titleStyle: TextStyle(color: Colors.white, fontSize: 12),
              )).toList(),
              pieTouchData: PieTouchData(
                touchCallback: (event, response) {
                  if (event is FlTapUpEvent && response?.touchedSection != null) {
                    final index = response!.touchedSection!.touchedSectionIndex;
                    if (index >= 0 && index < data.length) {
                      onSegmentTap?.call(data[index]);
                    }
                  }
                },
              ),
            ),
          ),
        ),
        SizedBox(height: 16),
        // å›¾ä¾‹ï¼ˆå¯ç‚¹å‡»ï¼‰
        Wrap(
          spacing: 16,
          runSpacing: 8,
          children: data.map((item) => InkWell(
            onTap: () => onSegmentTap?.call(item),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(width: 12, height: 12, color: item.color),
                SizedBox(width: 4),
                Text(item.label),
              ],
            ),
          )).toList(),
        ),
      ],
    );
  }
}

/// å¯ä¸‹é’»çš„æŸ±çŠ¶å›¾
class DrillDownBarChart extends StatelessWidget {
  final List<BarChartData> data;
  final String title;
  final Function(BarChartData item)? onBarTap;

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(title, style: Theme.of(context).textTheme.titleMedium),
        SizedBox(height: 16),
        AspectRatio(
          aspectRatio: 1.5,
          child: BarChart(
            BarChartData(
              barGroups: data.asMap().entries.map((e) => BarChartGroupData(
                x: e.key,
                barRods: [
                  BarChartRodData(
                    toY: e.value.value,
                    color: e.value.color,
                    width: 20,
                    borderRadius: BorderRadius.vertical(top: Radius.circular(4)),
                  ),
                ],
              )).toList(),
              barTouchData: BarTouchData(
                touchCallback: (event, response) {
                  if (event is FlTapUpEvent && response?.spot != null) {
                    final index = response!.spot!.touchedBarGroupIndex;
                    if (index >= 0 && index < data.length) {
                      onBarTap?.call(data[index]);
                    }
                  }
                },
                touchTooltipData: BarTouchTooltipData(
                  getTooltipItem: (group, groupIndex, rod, rodIndex) {
                    return BarTooltipItem(
                      '${data[groupIndex].label}\nÂ¥${rod.toY.toStringAsFixed(2)}',
                      TextStyle(color: Colors.white),
                    );
                  },
                ),
              ),
              // ... å…¶ä»–é…ç½®
            ),
          ),
        ),
      ],
    );
  }
}
```

### 9.3 é¢åŒ…å±‘å¯¼èˆª

```dart
/// ä¸‹é’»é¢åŒ…å±‘å¯¼èˆª
class DrillDownBreadcrumb extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final drillDownStack = ref.watch(drillDownStackProvider);

    if (drillDownStack.isEmpty) return SizedBox.shrink();

    return Container(
      height: 40,
      child: ListView.separated(
        scrollDirection: Axis.horizontal,
        itemCount: drillDownStack.length,
        separatorBuilder: (_, __) => Icon(Icons.chevron_right, size: 16),
        itemBuilder: (context, index) {
          final item = drillDownStack[index];
          final isLast = index == drillDownStack.length - 1;

          return TextButton(
            onPressed: isLast ? null : () => _navigateToLevel(context, ref, index),
            child: Text(
              item.title,
              style: TextStyle(
                color: isLast ? Colors.grey : Theme.of(context).primaryColor,
                fontWeight: isLast ? FontWeight.bold : FontWeight.normal,
              ),
            ),
          );
        },
      ),
    );
  }

  void _navigateToLevel(BuildContext context, WidgetRef ref, int level) {
    ref.read(drillDownStackProvider.notifier).popToLevel(level);
    Navigator.of(context).popUntil((route) {
      // è¿”å›åˆ°æŒ‡å®šå±‚çº§
      return route.settings.name == ref.read(drillDownStackProvider)[level].route;
    });
  }
}
```

### 9.4 è”åŠ¨çŠ¶æ€ç®¡ç†

```dart
/// ä¸‹é’»çŠ¶æ€ç®¡ç†
class DrillDownStack extends StateNotifier<List<DrillDownLevel>> {
  DrillDownStack() : super([]);

  /// è¿›å…¥ä¸‹ä¸€å±‚
  void push(DrillDownLevel level) {
    state = [...state, level];
  }

  /// è¿”å›ä¸Šä¸€å±‚
  void pop() {
    if (state.isNotEmpty) {
      state = state.sublist(0, state.length - 1);
    }
  }

  /// è¿”å›åˆ°æŒ‡å®šå±‚çº§
  void popToLevel(int level) {
    if (level >= 0 && level < state.length) {
      state = state.sublist(0, level + 1);
    }
  }

  /// é‡ç½®
  void reset() {
    state = [];
  }
}

/// ä¸‹é’»å±‚çº§ä¿¡æ¯
class DrillDownLevel {
  final String title;
  final String route;
  final Map<String, dynamic> params;

  DrillDownLevel({
    required this.title,
    required this.route,
    this.params = const {},
  });
}

/// ä¸‹é’»å¯¼èˆªæœåŠ¡
class DrillDownNavigator {
  final Ref ref;

  DrillDownNavigator(this.ref);

  /// ä»ä»ªè¡¨ç›˜ä¸‹é’»åˆ°åˆ†ç±»è¯¦æƒ…
  void drillDownToCategory(BuildContext context, String categoryId, String categoryName) {
    ref.read(drillDownStackProvider.notifier).push(DrillDownLevel(
      title: categoryName,
      route: '/category/$categoryId',
      params: {'categoryId': categoryId},
    ));

    Navigator.pushNamed(
      context,
      '/category/$categoryId',
      arguments: {'categoryId': categoryId, 'categoryName': categoryName},
    );
  }

  /// ä»åˆ†ç±»ä¸‹é’»åˆ°äº¤æ˜“åˆ—è¡¨
  void drillDownToTransactions(
    BuildContext context, {
    String? categoryId,
    DateRange? dateRange,
    String? accountId,
  }) {
    ref.read(drillDownStackProvider.notifier).push(DrillDownLevel(
      title: 'äº¤æ˜“è®°å½•',
      route: '/transactions',
      params: {
        'categoryId': categoryId,
        'dateRange': dateRange,
        'accountId': accountId,
      },
    ));

    Navigator.pushNamed(
      context,
      '/transactions',
      arguments: {
        'categoryId': categoryId,
        'dateRange': dateRange,
        'accountId': accountId,
      },
    );
  }
}
```

---

## 10. æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ

æœ¬ç« è¯¦ç»†è¯´æ˜ç³»ç»Ÿä¸­å„é¡¹æ™ºèƒ½åŒ–åŠŸèƒ½çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æŠ€æœ¯æ ˆï¼ˆå¤§æ¨¡å‹/è§„åˆ™å¼•æ“/æœºå™¨å­¦ä¹ ï¼‰ã€ç®—æ³•é€‰æ‹©ã€ä»¥åŠæ··åˆç­–ç•¥è®¾è®¡ã€‚

### 10.1 æ™ºèƒ½åŒ–æŠ€æœ¯æ ˆæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½åŒ–æŠ€æœ¯æ ˆåˆ†å±‚æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  åº”ç”¨å±‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  æ™ºèƒ½åˆ†ç±»  â”‚  æ™ºèƒ½é¢„ç®—  â”‚  è¶‹åŠ¿é¢„æµ‹  â”‚  è‡ªç„¶è¯­è¨€  â”‚  å¯¹è¯åŠ©æ‰‹ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                         â”‚
â”‚  ç­–ç•¥å±‚ (æ··åˆç­–ç•¥è°ƒåº¦)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  è§„åˆ™ä¼˜å…ˆ â†’ æœ¬åœ°ML â†’ å¤§æ¨¡å‹å…œåº•                               â”‚     â”‚
â”‚  â”‚  ç½®ä¿¡åº¦è¯„ä¼° â†’ æˆæœ¬æ§åˆ¶ â†’ ç»“æœèåˆ                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                         â”‚
â”‚  èƒ½åŠ›å±‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  è§„åˆ™å¼•æ“  â”‚  â”‚  æœ¬åœ°ML    â”‚  â”‚  ç»Ÿè®¡åˆ†æ  â”‚  â”‚  å¤§æ¨¡å‹API â”‚      â”‚
â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚      â”‚
â”‚  â”‚ â€¢ å…³é”®è¯è¡¨ â”‚  â”‚ â€¢ TFLite   â”‚  â”‚ â€¢ æ—¶é—´åºåˆ— â”‚  â”‚ â€¢ é€šä¹‰åƒé—® â”‚      â”‚
â”‚  â”‚ â€¢ æ­£åˆ™åŒ¹é… â”‚  â”‚ â€¢ åˆ†ç±»å™¨   â”‚  â”‚ â€¢ èšç±»åˆ†æ â”‚  â”‚ â€¢ æ™ºè°±AI   â”‚      â”‚
â”‚  â”‚ â€¢ å†³ç­–æ ‘   â”‚  â”‚ â€¢ å¼‚å¸¸æ£€æµ‹ â”‚  â”‚ â€¢ å›å½’é¢„æµ‹ â”‚  â”‚ â€¢ Claude   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ

#### 10.2.1 å¤šå±‚ç­–ç•¥æ¶æ„

æ™ºèƒ½åˆ†ç±»é‡‡ç”¨**å››å±‚é€’è¿›ç­–ç•¥**ï¼Œè§„åˆ™ä¼˜å…ˆã€AIå…œåº•ï¼Œåœ¨å‡†ç¡®æ€§å’Œæˆæœ¬é—´å–å¾—å¹³è¡¡ï¼š

```dart
/// æ™ºèƒ½åˆ†ç±»æœåŠ¡ - å››å±‚æ··åˆç­–ç•¥
class SmartCategoryService {
  final CategoryRepository _categoryRepo;
  final TransactionRepository _transactionRepo;
  final LLMService _llmService;
  final LocalMLService _localML;

  /// å…³é”®è¯æ˜ å°„è¡¨ï¼ˆè§„åˆ™å¼•æ“ - ç¬¬äºŒå±‚ï¼‰
  static const Map<String, List<String>> _keywordMap = {
    'é¤é¥®': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'å¤–å–', 'ç¾å›¢', 'é¥¿äº†ä¹ˆ', 'å ‚é£Ÿ', 'ç«é”…', 'çƒ§çƒ¤', 'å¥¶èŒ¶', 'å’–å•¡'],
    'äº¤é€š': ['æ‰“è½¦', 'æ»´æ»´', 'åœ°é“', 'å…¬äº¤', 'åŠ æ²¹', 'åœè½¦', 'é«˜é“', 'æœºç¥¨', 'é«˜é€Ÿè´¹'],
    'è´­ç‰©': ['æ·˜å®', 'äº¬ä¸œ', 'æ‹¼å¤šå¤š', 'è¶…å¸‚', 'å•†åœº', 'å¤©çŒ«', 'è‹å®'],
    'å±…ä½': ['æˆ¿ç§Ÿ', 'æ°´è´¹', 'ç”µè´¹', 'ç‡ƒæ°”', 'ç‰©ä¸š', 'æš–æ°”'],
    'å¨±ä¹': ['ç”µå½±', 'æ¸¸æˆ', 'KTV', 'æ¼”å‡º', 'æ—…æ¸¸', 'é—¨ç¥¨'],
    'åŒ»ç–—': ['åŒ»é™¢', 'è¯åº—', 'æŒ‚å·', 'ä½“æ£€', 'çœ‹ç—…'],
    'æ•™è‚²': ['å­¦è´¹', 'åŸ¹è®­', 'è¯¾ç¨‹', 'ä¹¦ç±', 'è€ƒè¯•'],
  };

  /// æ¨èåˆ†ç±»ï¼ˆå››å±‚ç­–ç•¥ï¼‰
  Future<List<CategorySuggestion>> suggestCategories({
    required String description,
    required double amount,
    String? merchant,
    DateTime? date,
  }) async {
    final suggestions = <CategorySuggestion>[];

    // ========== ç¬¬ä¸€å±‚ï¼šå•†å®¶å†å²åŒ¹é…ï¼ˆç½®ä¿¡åº¦æœ€é«˜ï¼‰ ==========
    // æŠ€æœ¯ï¼šæ•°æ®åº“æŸ¥è¯¢ + ç»Ÿè®¡åˆ†æ
    // ä¼˜ç‚¹ï¼šåŸºäºç”¨æˆ·è‡ªå·±çš„ä¹ æƒ¯ï¼Œæœ€å‡†ç¡®
    if (merchant != null && merchant.isNotEmpty) {
      final history = await _transactionRepo.findByMerchant(merchant, limit: 20);
      if (history.length >= 3) {  // è‡³å°‘3æ¡å†å²è®°å½•æ‰æœ‰ç»Ÿè®¡æ„ä¹‰
        final categoryVotes = <String, int>{};
        for (final tx in history) {
          if (tx.categoryId != null) {
            categoryVotes[tx.categoryId!] = (categoryVotes[tx.categoryId!] ?? 0) + 1;
          }
        }
        if (categoryVotes.isNotEmpty) {
          final topEntry = categoryVotes.entries.reduce((a, b) => a.value > b.value ? a : b);
          final frequency = topEntry.value / history.length;

          if (frequency >= 0.6) {  // 60%ä»¥ä¸Šçš„ä¸€è‡´æ€§æ‰æ¨è
            final category = await _categoryRepo.getById(topEntry.key);
            if (category != null) {
              suggestions.add(CategorySuggestion(
                category: category,
                confidence: 0.85 + frequency * 0.1,  // 0.85-0.95
                reason: 'åœ¨"$merchant"çš„æ¶ˆè´¹é€šå¸¸è®°ä¸º${category.name}',
                source: SuggestionSource.merchantHistory,
              ));
            }
          }
        }
      }
    }

    // ========== ç¬¬äºŒå±‚ï¼šå…³é”®è¯è§„åˆ™åŒ¹é… ==========
    // æŠ€æœ¯ï¼šæ­£åˆ™è¡¨è¾¾å¼ + å…³é”®è¯è¡¨
    // ä¼˜ç‚¹ï¼šå¿«é€Ÿã€å¯è§£é‡Šã€æ— æˆæœ¬
    final keywordMatch = _matchByKeywords(description);
    if (keywordMatch != null) {
      final category = await _categoryRepo.findByName(keywordMatch.categoryName);
      if (category != null) {
        // æ£€æŸ¥æ˜¯å¦ä¸ç¬¬ä¸€å±‚ç»“æœå†²çª
        final isDuplicate = suggestions.any((s) => s.category.id == category.id);
        if (!isDuplicate) {
          suggestions.add(CategorySuggestion(
            category: category,
            confidence: 0.75,
            reason: 'åŒ…å«å…³é”®è¯"${keywordMatch.matchedKeyword}"',
            source: SuggestionSource.keywordMatch,
          ));
        }
      }
    }

    // ========== ç¬¬ä¸‰å±‚ï¼šæœ¬åœ°MLæ¨¡å‹ ==========
    // æŠ€æœ¯ï¼šTensorFlow Lite æ–‡æœ¬åˆ†ç±»å™¨
    // ä¼˜ç‚¹ï¼šç¦»çº¿å¯ç”¨ã€é€Ÿåº¦å¿«ã€æ— APIæˆæœ¬
    try {
      final mlResult = await _localML.classifyTransaction(
        description: description,
        amount: amount,
        dayOfWeek: date?.weekday,
        hourOfDay: date?.hour,
      );

      if (mlResult.confidence > 0.6) {
        final category = await _categoryRepo.getById(mlResult.categoryId);
        if (category != null) {
          final isDuplicate = suggestions.any((s) => s.category.id == category.id);
          if (!isDuplicate) {
            suggestions.add(CategorySuggestion(
              category: category,
              confidence: mlResult.confidence * 0.85,  // ç¨å¾®é™ä½ç½®ä¿¡åº¦
              reason: 'æœ¬åœ°AIåˆ†æ',
              source: SuggestionSource.localML,
            ));
          }
        }
      }
    } catch (e) {
      // æœ¬åœ°MLå¤±è´¥æ—¶é™é»˜å¤„ç†
      debugPrint('Local ML classification failed: $e');
    }

    // ========== ç¬¬å››å±‚ï¼šå¤§æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆå…œåº•ï¼‰ ==========
    // æŠ€æœ¯ï¼šé€šä¹‰åƒé—® / æ™ºè°±AI API
    // ä¼˜ç‚¹ï¼šç†è§£å¤æ‚è¯­ä¹‰ã€å¤„ç†æ–°åœºæ™¯
    // è§¦å‘æ¡ä»¶ï¼šå‰é¢å±‚çº§ç½®ä¿¡åº¦ä¸å¤Ÿé«˜
    final maxConfidence = suggestions.isEmpty ? 0.0 :
        suggestions.map((s) => s.confidence).reduce(max);

    if (maxConfidence < 0.75) {
      try {
        final llmResult = await _llmService.classifyExpense(
          description: description,
          amount: amount,
          merchant: merchant,
          availableCategories: await _categoryRepo.getAllExpenseCategories(),
        );

        if (llmResult != null && llmResult.confidence > 0.5) {
          final isDuplicate = suggestions.any((s) => s.category.id == llmResult.category.id);
          if (!isDuplicate) {
            suggestions.add(CategorySuggestion(
              category: llmResult.category,
              confidence: llmResult.confidence,
              reason: llmResult.explanation,
              source: SuggestionSource.llmAnalysis,
            ));
          }
        }
      } catch (e) {
        debugPrint('LLM classification failed: $e');
      }
    }

    // å»é‡å¹¶æŒ‰ç½®ä¿¡åº¦æ’åº
    return _deduplicateAndSort(suggestions);
  }

  /// å…³é”®è¯åŒ¹é…ï¼ˆæ­£åˆ™æ”¯æŒï¼‰
  KeywordMatchResult? _matchByKeywords(String description) {
    final lowerDesc = description.toLowerCase();

    for (final entry in _keywordMap.entries) {
      for (final keyword in entry.value) {
        // æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å…³é”®è¯
        final pattern = RegExp(keyword, caseSensitive: false);
        if (pattern.hasMatch(lowerDesc)) {
          return KeywordMatchResult(
            categoryName: entry.key,
            matchedKeyword: keyword,
          );
        }
      }
    }
    return null;
  }
}

/// å»ºè®®æ¥æºæšä¸¾
enum SuggestionSource {
  merchantHistory,  // å•†å®¶å†å²
  keywordMatch,     // å…³é”®è¯åŒ¹é…
  localML,          // æœ¬åœ°MLæ¨¡å‹
  llmAnalysis,      // å¤§æ¨¡å‹åˆ†æ
  amountPattern,    // é‡‘é¢æ¨¡å¼
  timePattern,      // æ—¶é—´æ¨¡å¼
}
```

#### 10.2.2 æœ¬åœ°MLæ¨¡å‹è®­ç»ƒ

```python
# æœ¬åœ°åˆ†ç±»æ¨¡å‹è®­ç»ƒè„šæœ¬ï¼ˆç¦»çº¿è¿è¡Œï¼‰
import tensorflow as tf
from sklearn.model_selection import train_test_split

class TransactionClassifierTrainer:
    """äº¤æ˜“åˆ†ç±»å™¨è®­ç»ƒ"""

    def __init__(self, categories: List[str]):
        self.categories = categories
        self.tokenizer = tf.keras.preprocessing.text.Tokenizer(num_words=5000)

    def prepare_data(self, transactions: List[Dict]) -> Tuple:
        """å‡†å¤‡è®­ç»ƒæ•°æ®"""
        texts = [t['description'] for t in transactions]
        labels = [self.categories.index(t['category']) for t in transactions]

        # æ–‡æœ¬å‘é‡åŒ–
        self.tokenizer.fit_on_texts(texts)
        sequences = self.tokenizer.texts_to_sequences(texts)
        padded = tf.keras.preprocessing.sequence.pad_sequences(sequences, maxlen=50)

        return train_test_split(padded, labels, test_size=0.2)

    def build_model(self) -> tf.keras.Model:
        """æ„å»ºè½»é‡çº§åˆ†ç±»æ¨¡å‹"""
        model = tf.keras.Sequential([
            tf.keras.layers.Embedding(5000, 64, input_length=50),
            tf.keras.layers.GlobalAveragePooling1D(),
            tf.keras.layers.Dense(64, activation='relu'),
            tf.keras.layers.Dropout(0.3),
            tf.keras.layers.Dense(len(self.categories), activation='softmax')
        ])

        model.compile(
            optimizer='adam',
            loss='sparse_categorical_crossentropy',
            metrics=['accuracy']
        )
        return model

    def export_to_tflite(self, model: tf.keras.Model, path: str):
        """å¯¼å‡ºä¸ºTFLiteæ ¼å¼ï¼ˆç”¨äºç§»åŠ¨ç«¯ï¼‰"""
        converter = tf.lite.TFLiteConverter.from_keras_model(model)
        converter.optimizations = [tf.lite.Optimize.DEFAULT]
        tflite_model = converter.convert()

        with open(path, 'wb') as f:
            f.write(tflite_model)
```

#### 10.2.3 å¤§æ¨¡å‹åˆ†ç±»è°ƒç”¨

```dart
/// å¤§æ¨¡å‹åˆ†ç±»æœåŠ¡
class LLMService {
  final QwenService _qwenService;

  /// ä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œåˆ†ç±»
  Future<LLMClassificationResult?> classifyExpense({
    required String description,
    required double amount,
    String? merchant,
    required List<Category> availableCategories,
  }) async {
    // æ„å»ºåˆ†ç±»é€‰é¡¹ï¼ˆå¸¦IDä¾¿äºè§£æï¼‰
    final categoryOptions = availableCategories
        .map((c) => '{"id":"${c.id}","name":"${c.name}"}')
        .join(', ');

    final prompt = '''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°è´¦åˆ†ç±»åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹æ¶ˆè´¹è®°å½•ï¼Œä»ç»™å®šçš„åˆ†ç±»ä¸­é€‰æ‹©æœ€åˆé€‚çš„ä¸€ä¸ªã€‚

ã€æ¶ˆè´¹ä¿¡æ¯ã€‘
- æè¿°: $description
- é‡‘é¢: Â¥$amount
${merchant != null ? '- å•†å®¶: $merchant' : ''}

ã€å¯é€‰åˆ†ç±»ã€‘
[$categoryOptions]

ã€è¦æ±‚ã€‘
1. åªèƒ½ä»ä¸Šè¿°åˆ†ç±»ä¸­é€‰æ‹©
2. å¦‚æœæ— æ³•ç¡®å®šï¼Œé€‰æ‹©æœ€å¯èƒ½çš„å¹¶é™ä½ç½®ä¿¡åº¦
3. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—

ã€è¿”å›æ ¼å¼ã€‘
{
  "category_id": "é€‰æ‹©çš„åˆ†ç±»ID",
  "confidence": 0åˆ°1ä¹‹é—´çš„æ•°å­—,
  "explanation": "10å­—ä»¥å†…çš„ç†ç”±"
}
''';

    try {
      final response = await _qwenService.chat(prompt);
      final json = jsonDecode(_extractJson(response));

      final categoryId = json['category_id'] as String;
      final category = availableCategories.firstWhere(
        (c) => c.id == categoryId,
        orElse: () => throw FormatException('Invalid category ID'),
      );

      return LLMClassificationResult(
        category: category,
        confidence: (json['confidence'] as num).toDouble().clamp(0.0, 1.0),
        explanation: json['explanation'] as String? ?? 'AIåˆ†æ',
      );
    } catch (e) {
      debugPrint('LLM classify error: $e');
      return null;
    }
  }

  /// ä»å“åº”ä¸­æå–JSON
  String _extractJson(String response) {
    // å¤„ç†markdownä»£ç å—
    final jsonMatch = RegExp(r'\{[\s\S]*\}').firstMatch(response);
    return jsonMatch?.group(0) ?? response;
  }
}
```

### 10.3 æ™ºèƒ½é¢„ç®—å»ºè®®

#### 10.3.1 é¢„ç®—å»ºè®®ç®—æ³•

```dart
/// æ™ºèƒ½é¢„ç®—å»ºè®®æœåŠ¡
class SmartBudgetService {
  final TransactionRepository _transactionRepo;
  final BudgetRepository _budgetRepo;

  /// ç”Ÿæˆé¢„ç®—å»ºè®®ï¼ˆçº¯è§„åˆ™+ç»Ÿè®¡ç®—æ³•ï¼‰
  Future<List<BudgetSuggestion>> generateBudgetSuggestions() async {
    final suggestions = <BudgetSuggestion>[];

    // è·å–æœ€è¿‘3ä¸ªæœˆçš„æ¶ˆè´¹æ•°æ®
    final threeMonthsAgo = DateTime.now().subtract(Duration(days: 90));
    final transactions = await _transactionRepo.getExpensesSince(threeMonthsAgo);

    // æŒ‰åˆ†ç±»èšåˆç»Ÿè®¡
    final categoryStats = <String, CategorySpendingStats>{};

    for (final tx in transactions) {
      if (tx.categoryId == null) continue;

      final stats = categoryStats.putIfAbsent(
        tx.categoryId!,
        () => CategorySpendingStats(),
      );
      stats.amounts.add(tx.amount);
      stats.dates.add(tx.date);
    }

    // ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆå»ºè®®
    for (final entry in categoryStats.entries) {
      final categoryId = entry.key;
      final stats = entry.value;

      if (stats.amounts.length < 3) continue;  // æ•°æ®ä¸è¶³è·³è¿‡

      // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
      final median = _calculateMedian(stats.amounts);
      final p75 = _calculatePercentile(stats.amounts, 75);
      final monthlyAverage = stats.totalAmount / 3;
      final volatility = _calculateVolatility(stats.amounts);

      // æ£€æµ‹å­£èŠ‚æ€§ï¼ˆå¦‚æœæ˜¯å½“å‰å­£èŠ‚çš„æ¶ˆè´¹é«˜å³°ï¼‰
      final seasonalFactor = _detectSeasonality(stats.dates);

      // è®¡ç®—å»ºè®®é¢„ç®—
      double suggestedBudget;
      String reason;

      if (volatility < 0.2) {
        // æ¶ˆè´¹ç¨³å®šï¼šä½¿ç”¨ä¸­ä½æ•° + 10%ç¼“å†²
        suggestedBudget = median * 1.1;
        reason = 'æ‚¨çš„${categoryId}æ¶ˆè´¹è¾ƒç¨³å®šï¼Œå»ºè®®é¢„ç®—ç•¥é«˜äºä¸­ä½æ•°';
      } else if (volatility < 0.5) {
        // æ¶ˆè´¹æœ‰æ³¢åŠ¨ï¼šä½¿ç”¨75åˆ†ä½æ•°
        suggestedBudget = p75;
        reason = '${categoryId}æ¶ˆè´¹æœ‰ä¸€å®šæ³¢åŠ¨ï¼Œå»ºè®®ä½¿ç”¨å†å²75%åˆ†ä½æ•°';
      } else {
        // æ¶ˆè´¹æ³¢åŠ¨å¤§ï¼šä½¿ç”¨æœˆå‡å€¼ + 20%ç¼“å†²
        suggestedBudget = monthlyAverage * 1.2;
        reason = '${categoryId}æ¶ˆè´¹æ³¢åŠ¨è¾ƒå¤§ï¼Œå»ºè®®é¢„ç•™æ›´å¤šç¼“å†²';
      }

      // åº”ç”¨å­£èŠ‚æ€§è°ƒæ•´
      suggestedBudget *= seasonalFactor;

      suggestions.add(BudgetSuggestion(
        categoryId: categoryId,
        suggestedAmount: suggestedBudget.roundToDouble(),
        historicalMedian: median,
        historicalP75: p75,
        volatility: volatility,
        reason: reason,
        confidence: _calculateConfidence(stats.amounts.length, volatility),
      ));
    }

    return suggestions..sort((a, b) => b.suggestedAmount.compareTo(a.suggestedAmount));
  }

  /// è®¡ç®—ä¸­ä½æ•°
  double _calculateMedian(List<double> values) {
    final sorted = List<double>.from(values)..sort();
    final mid = sorted.length ~/ 2;
    return sorted.length.isOdd ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
  }

  /// è®¡ç®—åˆ†ä½æ•°
  double _calculatePercentile(List<double> values, int percentile) {
    final sorted = List<double>.from(values)..sort();
    final index = (percentile / 100 * sorted.length).floor();
    return sorted[index.clamp(0, sorted.length - 1)];
  }

  /// è®¡ç®—æ³¢åŠ¨ç‡ï¼ˆå˜å¼‚ç³»æ•°ï¼‰
  double _calculateVolatility(List<double> values) {
    final mean = values.reduce((a, b) => a + b) / values.length;
    final variance = values.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / values.length;
    return sqrt(variance) / mean;
  }

  /// æ£€æµ‹å­£èŠ‚æ€§å› å­
  double _detectSeasonality(List<DateTime> dates) {
    final currentMonth = DateTime.now().month;

    // ç®€å•çš„å­£èŠ‚æ€§æ£€æµ‹ï¼šæŸ¥çœ‹å†å²åŒæœŸæ•°æ®
    final sameSeasonCount = dates.where((d) {
      final monthDiff = (d.month - currentMonth).abs();
      return monthDiff <= 1 || monthDiff >= 11;  // åŒå­£èŠ‚
    }).length;

    if (sameSeasonCount > dates.length * 0.6) {
      return 1.0;  // æ•°æ®ä¸»è¦æ¥è‡ªåŒå­£èŠ‚ï¼Œä¸è°ƒæ•´
    }

    // æ ¹æ®æœˆä»½ç‰¹å¾è°ƒæ•´ï¼ˆå¦‚12æœˆæ¶ˆè´¹é€šå¸¸è¾ƒé«˜ï¼‰
    if (currentMonth == 12 || currentMonth == 1 || currentMonth == 2) {
      return 1.15;  // å¹´æœ«å¹´åˆæ¶ˆè´¹é«˜å³°
    } else if (currentMonth == 11) {
      return 1.2;  // åŒ11è´­ç‰©èŠ‚
    } else if (currentMonth == 6 || currentMonth == 7) {
      return 1.1;  // 618è´­ç‰©èŠ‚+æš‘æœŸ
    }

    return 1.0;
  }

  /// è®¡ç®—ç½®ä¿¡åº¦
  double _calculateConfidence(int sampleSize, double volatility) {
    // æ ·æœ¬é‡è¶Šå¤§ã€æ³¢åŠ¨è¶Šå°ï¼Œç½®ä¿¡åº¦è¶Šé«˜
    final sizeFactor = min(1.0, sampleSize / 30);
    final volatilityFactor = max(0.3, 1 - volatility);
    return (sizeFactor * 0.6 + volatilityFactor * 0.4).clamp(0.3, 0.95);
  }
}

/// åˆ†ç±»æ¶ˆè´¹ç»Ÿè®¡
class CategorySpendingStats {
  final List<double> amounts = [];
  final List<DateTime> dates = [];

  double get totalAmount => amounts.fold(0.0, (a, b) => a + b);
}
```

### 10.4 æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹

#### 10.4.1 æ—¶é—´åºåˆ—é¢„æµ‹

```dart
/// æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹æœåŠ¡
class TrendPredictionService {
  final TransactionRepository _transactionRepo;

  /// é¢„æµ‹ä¸‹æœˆæ¶ˆè´¹ï¼ˆä½¿ç”¨ç®€å•ç§»åŠ¨å¹³å‡ + å­£èŠ‚æ€§è°ƒæ•´ï¼‰
  Future<MonthlyPrediction> predictNextMonth() async {
    // è·å–è¿‡å»12ä¸ªæœˆçš„æœˆåº¦æ¶ˆè´¹
    final monthlyData = await _getMonthlySpending(months: 12);

    if (monthlyData.length < 3) {
      return MonthlyPrediction(
        predictedAmount: 0,
        confidence: 0,
        method: 'insufficient_data',
      );
    }

    // æ–¹æ³•1: ç®€å•ç§»åŠ¨å¹³å‡ï¼ˆSMAï¼‰
    final sma3 = _calculateSMA(monthlyData, 3);

    // æ–¹æ³•2: åŠ æƒç§»åŠ¨å¹³å‡ï¼ˆWMAï¼‰- æœ€è¿‘çš„æƒé‡æ›´é«˜
    final wma3 = _calculateWMA(monthlyData, [0.5, 0.33, 0.17]);

    // æ–¹æ³•3: å­£èŠ‚æ€§è°ƒæ•´
    final seasonalFactor = _getSeasonalFactor(DateTime.now().month + 1);

    // ç»¼åˆé¢„æµ‹
    final predicted = (sma3 * 0.4 + wma3 * 0.6) * seasonalFactor;

    // è®¡ç®—ç½®ä¿¡åŒºé—´
    final stdDev = _calculateStdDev(monthlyData);
    final lowerBound = predicted - 1.96 * stdDev;
    final upperBound = predicted + 1.96 * stdDev;

    return MonthlyPrediction(
      predictedAmount: predicted,
      lowerBound: lowerBound,
      upperBound: upperBound,
      confidence: _calculatePredictionConfidence(monthlyData),
      method: 'wma_seasonal',
      breakdown: await _predictByCategory(),
    );
  }

  /// è®¡ç®—ç®€å•ç§»åŠ¨å¹³å‡
  double _calculateSMA(List<double> data, int period) {
    if (data.length < period) return data.last;
    final recent = data.sublist(data.length - period);
    return recent.reduce((a, b) => a + b) / period;
  }

  /// è®¡ç®—åŠ æƒç§»åŠ¨å¹³å‡
  double _calculateWMA(List<double> data, List<double> weights) {
    final period = weights.length;
    if (data.length < period) return data.last;

    final recent = data.sublist(data.length - period);
    double sum = 0;
    for (int i = 0; i < period; i++) {
      sum += recent[i] * weights[period - 1 - i];
    }
    return sum;
  }

  /// å­£èŠ‚æ€§å› å­
  double _getSeasonalFactor(int month) {
    // åŸºäºå†å²æ•°æ®è®¡ç®—çš„æœˆåº¦å› å­ï¼ˆç¤ºä¾‹å€¼ï¼‰
    const factors = {
      1: 1.15,  // æ˜¥èŠ‚
      2: 1.10,  // æ˜¥èŠ‚
      3: 0.95,
      4: 0.95,
      5: 1.00,
      6: 1.10,  // 618
      7: 1.05,
      8: 1.00,
      9: 0.95,
      10: 1.05, // å›½åº†
      11: 1.20, // åŒ11
      12: 1.10, // å¹´æœ«
    };
    return factors[month] ?? 1.0;
  }
}
```

### 10.5 æ™ºèƒ½å¼‚å¸¸æ£€æµ‹

#### 10.5.1 äº¤æ˜“å¼‚å¸¸æ£€æµ‹

```dart
/// äº¤æ˜“å¼‚å¸¸æ£€æµ‹æœåŠ¡
class AnomalyDetectionService {
  final TransactionRepository _transactionRepo;

  /// æ£€æµ‹å¼‚å¸¸äº¤æ˜“
  Future<List<AnomalyAlert>> detectAnomalies(Transaction newTx) async {
    final alerts = <AnomalyAlert>[];

    // ===== æ£€æµ‹1: é‡‘é¢å¼‚å¸¸ï¼ˆåŸºäºåˆ†ç±»å†å²ï¼‰=====
    final categoryHistory = await _transactionRepo.getByCategory(
      newTx.categoryId!,
      limit: 50,
    );

    if (categoryHistory.length >= 10) {
      final amounts = categoryHistory.map((t) => t.amount).toList();
      final mean = amounts.reduce((a, b) => a + b) / amounts.length;
      final stdDev = _calculateStdDev(amounts);

      // 3ÏƒåŸåˆ™ï¼šè¶…è¿‡3ä¸ªæ ‡å‡†å·®è§†ä¸ºå¼‚å¸¸
      if ((newTx.amount - mean).abs() > 3 * stdDev) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualAmount,
          severity: AnomalySeverity.high,
          message: 'æ­¤ç¬”${newTx.categoryName}æ¶ˆè´¹é‡‘é¢(Â¥${newTx.amount})æ˜¾è‘—é«˜äºå¹³å‡æ°´å¹³(Â¥${mean.toStringAsFixed(0)})',
          suggestion: 'è¯·ç¡®è®¤é‡‘é¢æ˜¯å¦æ­£ç¡®',
        ));
      } else if ((newTx.amount - mean).abs() > 2 * stdDev) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualAmount,
          severity: AnomalySeverity.medium,
          message: 'æ­¤ç¬”æ¶ˆè´¹é‡‘é¢è¾ƒé«˜',
          suggestion: null,
        ));
      }
    }

    // ===== æ£€æµ‹2: æ—¶é—´å¼‚å¸¸ =====
    final hour = newTx.date.hour;
    if (hour >= 0 && hour < 6) {
      // å‡Œæ™¨æ¶ˆè´¹
      final lateNightHistory = categoryHistory.where((t) {
        final h = t.date.hour;
        return h >= 0 && h < 6;
      }).length;

      if (lateNightHistory < categoryHistory.length * 0.1) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualTime,
          severity: AnomalySeverity.low,
          message: 'å‡Œæ™¨æ¶ˆè´¹è®°å½•',
          suggestion: null,
        ));
      }
    }

    // ===== æ£€æµ‹3: é¢‘ç‡å¼‚å¸¸ =====
    final todayCount = await _transactionRepo.countToday(newTx.categoryId!);
    final avgDailyCount = categoryHistory.length / 30;  // å‡è®¾30å¤©å†å²

    if (todayCount > avgDailyCount * 3 && todayCount > 3) {
      alerts.add(AnomalyAlert(
        type: AnomalyType.unusualFrequency,
        severity: AnomalySeverity.medium,
        message: 'ä»Šæ—¥${newTx.categoryName}æ¶ˆè´¹æ¬¡æ•°($todayCountæ¬¡)æ˜æ˜¾å¤šäºå¹³å¸¸',
        suggestion: 'æ˜¯å¦æœ‰é‡å¤è®°å½•?',
      ));
    }

    // ===== æ£€æµ‹4: é‡å¤äº¤æ˜“å«Œç–‘ =====
    final duplicateSuspects = await _findPotentialDuplicates(newTx);
    if (duplicateSuspects.isNotEmpty) {
      alerts.add(AnomalyAlert(
        type: AnomalyType.potentialDuplicate,
        severity: AnomalySeverity.high,
        message: 'å‘ç°${duplicateSuspects.length}ç¬”ç›¸ä¼¼äº¤æ˜“',
        suggestion: 'ç‚¹å‡»æŸ¥çœ‹æ˜¯å¦é‡å¤',
        relatedTransactions: duplicateSuspects,
      ));
    }

    return alerts;
  }

  /// æŸ¥æ‰¾æ½œåœ¨é‡å¤äº¤æ˜“
  Future<List<Transaction>> _findPotentialDuplicates(Transaction tx) async {
    // æŸ¥æ‰¾åŒä¸€å¤©ã€ç›¸åŒé‡‘é¢çš„äº¤æ˜“
    final sameDaySameAmount = await _transactionRepo.findByDateAndAmount(
      date: tx.date,
      amount: tx.amount,
      excludeId: tx.id,
    );

    // ä½¿ç”¨æè¿°ç›¸ä¼¼åº¦è¿‡æ»¤
    return sameDaySameAmount.where((t) {
      final similarity = _stringSimilarity(t.description ?? '', tx.description ?? '');
      return similarity > 0.6;
    }).toList();
  }

  /// å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ï¼ˆJaccardç›¸ä¼¼åº¦ï¼‰
  double _stringSimilarity(String a, String b) {
    if (a.isEmpty && b.isEmpty) return 1.0;
    if (a.isEmpty || b.isEmpty) return 0.0;

    final setA = a.split('').toSet();
    final setB = b.split('').toSet();
    final intersection = setA.intersection(setB).length;
    final union = setA.union(setB).length;

    return intersection / union;
  }
}

/// å¼‚å¸¸ç±»å‹
enum AnomalyType {
  unusualAmount,      // é‡‘é¢å¼‚å¸¸
  unusualTime,        // æ—¶é—´å¼‚å¸¸
  unusualFrequency,   // é¢‘ç‡å¼‚å¸¸
  potentialDuplicate, // æ½œåœ¨é‡å¤
  unusualCategory,    // åˆ†ç±»å¼‚å¸¸
}
```

### 10.6 è‡ªç„¶è¯­è¨€æœç´¢

#### 10.6.1 æ„å›¾è¯†åˆ«ä¸æŸ¥è¯¢è½¬æ¢

```dart
/// è‡ªç„¶è¯­è¨€æœç´¢æœåŠ¡
class NaturalLanguageSearchService {
  final LLMService _llmService;
  final TransactionRepository _transactionRepo;

  /// å¤„ç†è‡ªç„¶è¯­è¨€æŸ¥è¯¢
  Future<SearchResult> search(String query) async {
    // ç¬¬ä¸€æ­¥ï¼šæ„å›¾è¯†åˆ«ï¼ˆæœ¬åœ°è§„åˆ™ä¼˜å…ˆï¼‰
    final intent = _parseQueryIntent(query);

    if (intent != null) {
      // æœ¬åœ°è§„åˆ™èƒ½å¤„ç†
      return await _executeLocalQuery(intent);
    }

    // ç¬¬äºŒæ­¥ï¼šå¤§æ¨¡å‹ç†è§£å¤æ‚æŸ¥è¯¢
    return await _executeLLMQuery(query);
  }

  /// æœ¬åœ°è§„åˆ™è§£ææ„å›¾
  QueryIntent? _parseQueryIntent(String query) {
    // æ—¶é—´æ¨¡å¼åŒ¹é…
    final timePatterns = {
      RegExp(r'ä¸Šä¸ª?æœˆ'): () => _getLastMonth(),
      RegExp(r'è¿™ä¸ª?æœˆ|æœ¬æœˆ'): () => _getCurrentMonth(),
      RegExp(r'ä¸Šå‘¨'): () => _getLastWeek(),
      RegExp(r'ä»Šå¤©'): () => _getToday(),
      RegExp(r'æ˜¨å¤©'): () => _getYesterday(),
      RegExp(r'(\d+)æœˆ'): (Match m) => _getMonth(int.parse(m.group(1)!)),
    };

    DateRange? dateRange;
    for (final entry in timePatterns.entries) {
      final match = entry.key.firstMatch(query);
      if (match != null) {
        dateRange = entry.value is Function()
            ? (entry.value as Function())()
            : (entry.value as Function(Match))(match);
        break;
      }
    }

    // åˆ†ç±»æ¨¡å¼åŒ¹é…
    String? category;
    final categoryKeywords = ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹', 'å±…ä½', 'åŒ»ç–—', 'æ•™è‚²'];
    for (final kw in categoryKeywords) {
      if (query.contains(kw)) {
        category = kw;
        break;
      }
    }

    // é‡‘é¢æŸ¥è¯¢æ¨¡å¼
    final amountMatch = RegExp(r'èŠ±äº†?å¤šå°‘|æ¶ˆè´¹äº†?å¤šå°‘|æ€»å…±|åˆè®¡').hasMatch(query);

    // ç»Ÿè®¡æŸ¥è¯¢æ¨¡å¼
    final statsMatch = RegExp(r'æœ€å¤š|æœ€å°‘|å¹³å‡|è¶‹åŠ¿').hasMatch(query);

    if (dateRange != null || category != null) {
      return QueryIntent(
        type: amountMatch ? QueryType.sum : (statsMatch ? QueryType.stats : QueryType.list),
        dateRange: dateRange,
        category: category,
        originalQuery: query,
      );
    }

    return null;  // æ— æ³•æœ¬åœ°è§£æ
  }

  /// æ‰§è¡Œæœ¬åœ°æŸ¥è¯¢
  Future<SearchResult> _executeLocalQuery(QueryIntent intent) async {
    switch (intent.type) {
      case QueryType.sum:
        final total = await _transactionRepo.sumByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
        );
        return SearchResult(
          answer: '${intent.category ?? ''}æ¶ˆè´¹å…± Â¥${total.toStringAsFixed(2)}',
          type: ResultType.answer,
          data: {'total': total},
        );

      case QueryType.list:
        final transactions = await _transactionRepo.findByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
          limit: 50,
        );
        return SearchResult(
          answer: 'æ‰¾åˆ° ${transactions.length} æ¡è®°å½•',
          type: ResultType.list,
          data: {'transactions': transactions},
        );

      case QueryType.stats:
        final stats = await _transactionRepo.getStatsByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
        );
        return SearchResult(
          answer: _formatStats(stats),
          type: ResultType.stats,
          data: stats,
        );
    }
  }

  /// ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†å¤æ‚æŸ¥è¯¢
  Future<SearchResult> _executeLLMQuery(String query) async {
    final prompt = '''
ä½ æ˜¯ä¸€ä¸ªè®°è´¦æŸ¥è¯¢åŠ©æ‰‹ã€‚ç”¨æˆ·é—®äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¯·åˆ†æç”¨æˆ·æ„å›¾å¹¶è¿”å›ç»“æ„åŒ–çš„æŸ¥è¯¢æ¡ä»¶ã€‚

ç”¨æˆ·é—®é¢˜ï¼š$query

è¯·è¿”å›JSONæ ¼å¼ï¼š
{
  "intent": "sum|list|compare|trend",
  "date_range": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"} æˆ– null,
  "category": "åˆ†ç±»å" æˆ– null,
  "merchant": "å•†å®¶å" æˆ– null,
  "amount_filter": {"min": æ•°å­—, "max": æ•°å­—} æˆ– null,
  "sort": "amount|date" æˆ– null,
  "natural_answer_template": "ç”¨äºå›ç­”ç”¨æˆ·çš„æ¨¡æ¿ï¼Œç”¨{result}ä½œä¸ºå ä½ç¬¦"
}
''';

    try {
      final response = await _llmService.chat(prompt);
      final json = jsonDecode(_extractJson(response));

      // æ‰§è¡Œè§£æå‡ºçš„æŸ¥è¯¢
      return await _executeStructuredQuery(json, query);
    } catch (e) {
      // é™çº§ä¸ºå…¨æ–‡æœç´¢
      return await _fallbackSearch(query);
    }
  }
}
```

### 10.7 å¯¹è¯å¼è®°è´¦åŠ©æ‰‹

#### 10.7.1 å¤šè½®å¯¹è¯ç®¡ç†

```dart
/// å¯¹è¯å¼è®°è´¦åŠ©æ‰‹
class ConversationalAssistant {
  final List<DialogTurn> _history = [];
  Transaction? _pendingTransaction;
  ConversationState _state = ConversationState.idle;

  /// å¤„ç†ç”¨æˆ·è¾“å…¥
  Future<AssistantResponse> processInput(String input) async {
    _history.add(DialogTurn(role: 'user', content: input));

    switch (_state) {
      case ConversationState.idle:
        return await _handleNewInput(input);

      case ConversationState.waitingAmount:
        return await _handleAmountInput(input);

      case ConversationState.waitingCategory:
        return await _handleCategoryInput(input);

      case ConversationState.waitingConfirmation:
        return await _handleConfirmation(input);
    }
  }

  /// å¤„ç†æ–°è¾“å…¥
  Future<AssistantResponse> _handleNewInput(String input) async {
    // è§£æç”¨æˆ·æ„å›¾
    final intent = await _parseIntent(input);

    switch (intent.type) {
      case IntentType.addExpense:
        return await _startAddExpense(intent);

      case IntentType.query:
        return await _handleQuery(intent);

      case IntentType.report:
        return await _generateReport(intent);

      case IntentType.unknown:
        return AssistantResponse(
          message: 'æˆ‘å¯ä»¥å¸®æ‚¨è®°è´¦ã€æŸ¥è¯¢æ¶ˆè´¹ã€ç”ŸæˆæŠ¥å‘Šã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ',
          suggestions: ['è®°ä¸€ç¬”æ¶ˆè´¹', 'æŸ¥çœ‹æœ¬æœˆæ¶ˆè´¹', 'ç”Ÿæˆæœˆåº¦æŠ¥å‘Š'],
        );
    }
  }

  /// å¼€å§‹æ·»åŠ æ¶ˆè´¹
  Future<AssistantResponse> _startAddExpense(ParsedIntent intent) async {
    _pendingTransaction = Transaction(
      id: generateId(),
      type: TransactionType.expense,
      amount: intent.amount ?? 0,
      description: intent.description,
      categoryId: intent.categoryId,
      date: intent.date ?? DateTime.now(),
    );

    // æ£€æŸ¥ç¼ºå¤±çš„å¿…è¦å­—æ®µ
    if (_pendingTransaction!.amount == 0) {
      _state = ConversationState.waitingAmount;
      return AssistantResponse(
        message: 'å¥½çš„ï¼Œè¿™ç¬”æ¶ˆè´¹æ˜¯å¤šå°‘é’±ï¼Ÿ',
        expectingType: ExpectingType.amount,
      );
    }

    if (_pendingTransaction!.categoryId == null) {
      _state = ConversationState.waitingCategory;
      final suggestions = await _suggestCategories(_pendingTransaction!);
      return AssistantResponse(
        message: 'è¯·é€‰æ‹©åˆ†ç±»ï¼š',
        suggestions: suggestions.map((s) => s.category.name).toList(),
        expectingType: ExpectingType.category,
      );
    }

    // æ‰€æœ‰ä¿¡æ¯é½å…¨ï¼Œè¯·æ±‚ç¡®è®¤
    return _requestConfirmation();
  }

  /// è¯·æ±‚ç¡®è®¤
  AssistantResponse _requestConfirmation() {
    _state = ConversationState.waitingConfirmation;
    final tx = _pendingTransaction!;

    return AssistantResponse(
      message: '''
ç¡®è®¤è®°å½•ä»¥ä¸‹æ¶ˆè´¹ï¼Ÿ
- é‡‘é¢: Â¥${tx.amount}
- åˆ†ç±»: ${tx.categoryName}
- æè¿°: ${tx.description ?? 'æ— '}
- æ—¥æœŸ: ${tx.date.format('yyyy-MM-dd')}
''',
      suggestions: ['ç¡®è®¤', 'ä¿®æ”¹é‡‘é¢', 'ä¿®æ”¹åˆ†ç±»', 'å–æ¶ˆ'],
      expectingType: ExpectingType.confirmation,
    );
  }

  /// å¤„ç†ç¡®è®¤
  Future<AssistantResponse> _handleConfirmation(String input) async {
    if (input.contains('ç¡®è®¤') || input.contains('æ˜¯') || input.contains('å¯¹')) {
      // ä¿å­˜äº¤æ˜“
      await _saveTransaction(_pendingTransaction!);
      _reset();

      return AssistantResponse(
        message: 'å·²è®°å½•ï¼è¿˜æœ‰å…¶ä»–éœ€è¦è®°å½•çš„å—ï¼Ÿ',
        suggestions: ['ç»§ç»­è®°è´¦', 'æŸ¥çœ‹ä»Šæ—¥æ¶ˆè´¹', 'ä¸ç”¨äº†'],
      );
    } else if (input.contains('å–æ¶ˆ')) {
      _reset();
      return AssistantResponse(message: 'å·²å–æ¶ˆã€‚');
    } else if (input.contains('ä¿®æ”¹é‡‘é¢')) {
      _state = ConversationState.waitingAmount;
      return AssistantResponse(message: 'è¯·è¾“å…¥æ–°çš„é‡‘é¢ï¼š');
    } else if (input.contains('ä¿®æ”¹åˆ†ç±»')) {
      _state = ConversationState.waitingCategory;
      return AssistantResponse(message: 'è¯·é€‰æ‹©æ–°çš„åˆ†ç±»ï¼š');
    }

    return AssistantResponse(message: 'è¯·å›å¤"ç¡®è®¤"æˆ–"å–æ¶ˆ"');
  }

  void _reset() {
    _pendingTransaction = null;
    _state = ConversationState.idle;
  }
}

/// å¯¹è¯çŠ¶æ€
enum ConversationState {
  idle,                 // ç©ºé—²
  waitingAmount,        // ç­‰å¾…é‡‘é¢
  waitingCategory,      // ç­‰å¾…åˆ†ç±»
  waitingConfirmation,  // ç­‰å¾…ç¡®è®¤
}
```

### 10.8 æ™ºèƒ½èµ„é‡‘åˆ†é…

#### 10.8.1 å°é‡‘åº“è‡ªåŠ¨åˆ†é…ç®—æ³•

```dart
/// æ™ºèƒ½èµ„é‡‘åˆ†é…æœåŠ¡
class SmartAllocationService {
  final VaultRepository _vaultRepository;
  final TransactionRepository _transactionRepo;

  /// ç”Ÿæˆåˆ†é…å»ºè®®ï¼ˆè§„åˆ™å¼•æ“ï¼‰
  Future<List<AllocationSuggestion>> generateSuggestions() async {
    final unallocated = await getUnallocatedAmount();
    if (unallocated <= 0) return [];

    final vaults = await _vaultRepository.getActiveVaults();
    final suggestions = <AllocationSuggestion>[];
    var remaining = unallocated;

    // ========== ä¼˜å…ˆçº§1: å›ºå®šæ”¯å‡ºï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.fixed)) {
      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'å›ºå®šæ”¯å‡ºéœ€ä¼˜å…ˆä¿éšœ',
          priority: 1,
          isRequired: true,
        ));
        remaining -= allocate;
      }
    }

    // ========== ä¼˜å…ˆçº§2: å€ºåŠ¡è¿˜æ¬¾ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.debt)) {
      if (remaining <= 0) break;

      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'æŒ‰æ—¶è¿˜æ¬¾é¿å…åˆ©æ¯å’Œä¿¡ç”¨å½±å“',
          priority: 2,
          isRequired: true,
        ));
        remaining -= allocate;
      }
    }

    // ========== ä¼˜å…ˆçº§3: åº”æ€¥å‚¨è“„ï¼ˆè‡³å°‘åˆ†é…20%ï¼‰ ==========
    final emergencyVault = vaults.firstWhereOrNull(
      (v) => v.type == VaultType.savings && v.name.contains('åº”æ€¥'),
    );
    if (emergencyVault != null && remaining > 0) {
      final emergencyAlloc = min(
        emergencyVault.targetAmount - emergencyVault.allocatedAmount,
        remaining * 0.2,  // è‡³å°‘åˆ†é…å‰©ä½™çš„20%
      );
      if (emergencyAlloc > 0) {
        suggestions.add(AllocationSuggestion(
          vaultId: emergencyVault.id,
          vaultName: emergencyVault.name,
          suggestedAmount: emergencyAlloc,
          reason: 'åº”æ€¥å‚¨è“„æ˜¯è´¢åŠ¡å®‰å…¨çš„åŸºç¡€',
          priority: 3,
          isRequired: false,
        ));
        remaining -= emergencyAlloc;
      }
    }

    // ========== ä¼˜å…ˆçº§4: å‚¨è“„ç›®æ ‡ï¼ˆæŒ‰å®Œæˆåº¦å’Œæˆªæ­¢æ—¥æœŸæ’åºï¼‰ ==========
    final savingsVaults = vaults
        .where((v) => v.type == VaultType.savings && v.id != emergencyVault?.id)
        .toList()
      ..sort((a, b) {
        // ä¼˜å…ˆå¡«å……æ¥è¿‘æˆªæ­¢æ—¥æœŸçš„
        if (a.dueDate != null && b.dueDate != null) {
          return a.dueDate!.compareTo(b.dueDate!);
        }
        // å…¶æ¬¡æŒ‰å®Œæˆåº¦å‡åºï¼ˆå®Œæˆåº¦ä½çš„ä¼˜å…ˆï¼‰
        return a.progress.compareTo(b.progress);
      });

    for (final vault in savingsVaults) {
      if (remaining <= 0) break;

      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        // æ ¹æ®ç´§è¿«ç¨‹åº¦å†³å®šåˆ†é…æ¯”ä¾‹
        double ratio = 0.15;  // é»˜è®¤åˆ†é…å‰©ä½™çš„15%
        if (vault.dueDate != null) {
          final daysLeft = vault.dueDate!.difference(DateTime.now()).inDays;
          if (daysLeft < 30) ratio = 0.3;
          else if (daysLeft < 90) ratio = 0.2;
        }

        final allocate = min(needed, remaining * ratio);
        if (allocate > 0) {
          suggestions.add(AllocationSuggestion(
            vaultId: vault.id,
            vaultName: vault.name,
            suggestedAmount: allocate,
            reason: _getSavingsReason(vault),
            priority: 4,
            isRequired: false,
          ));
          remaining -= allocate;
        }
      }
    }

    // ========== ä¼˜å…ˆçº§5: å¼¹æ€§æ”¯å‡ºï¼ˆåŸºäºå†å²ä½¿ç”¨ç‡ï¼‰ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.flexible)) {
      if (remaining <= 0) break;

      final historicalUsage = await _getHistoricalUsageRate(vault.id);
      final suggested = vault.targetAmount * historicalUsage;
      final needed = max(0, suggested - vault.allocatedAmount);

      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'åŸºäºå†å²ä½¿ç”¨ç‡å»ºè®®',
          priority: 5,
          isRequired: false,
        ));
        remaining -= allocate;
      }
    }

    return suggestions;
  }

  /// è·å–å‚¨è“„åŸå› 
  String _getSavingsReason(BudgetVault vault) {
    if (vault.dueDate != null) {
      final daysLeft = vault.dueDate!.difference(DateTime.now()).inDays;
      if (daysLeft < 30) return 'ç›®æ ‡æ—¥æœŸä¸´è¿‘ï¼Œè¿˜å·®${(vault.targetAmount - vault.allocatedAmount).toStringAsFixed(0)}å…ƒ';
      return 'è·ç¦»ç›®æ ‡è¿˜æœ‰$daysLeftå¤©';
    }
    return 'å‚¨è“„è¿›åº¦${(vault.progress * 100).toStringAsFixed(0)}%';
  }

  /// è·å–å†å²ä½¿ç”¨ç‡
  Future<double> _getHistoricalUsageRate(String vaultId) async {
    // æŸ¥è¯¢è¿‡å»3ä¸ªæœˆè¯¥å°é‡‘åº“çš„ä½¿ç”¨æƒ…å†µ
    final history = await _vaultRepository.getHistoricalUsage(vaultId, months: 3);
    if (history.isEmpty) return 0.8;  // é»˜è®¤80%

    final avgUsage = history.map((h) => h.usageRate).reduce((a, b) => a + b) / history.length;
    return avgUsage.clamp(0.5, 1.0);
  }
}
```

### 10.9 æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½åŒ–æŠ€æœ¯é€‰æ‹©å†³ç­–æ ‘                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  éœ€æ±‚åœºæ™¯                                                              â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ è§„åˆ™æ˜ç¡®ã€é€»è¾‘å›ºå®šï¼Ÿ                                           â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ æ˜¯ â†’ ã€è§„åˆ™å¼•æ“ã€‘                                      â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šåˆ†è´¦è§„åˆ™ã€é¢„ç®—åˆ†é…ã€å¼‚å¸¸é˜ˆå€¼                â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¦ â†“                                                   â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ éœ€è¦ç¦»çº¿è¿è¡Œï¼Ÿ                                                 â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ æ˜¯ â†’ ã€æœ¬åœ°ML/è§„åˆ™ã€‘                                   â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šæœ¬åœ°åˆ†ç±»ã€ç®€å•é¢„æµ‹                          â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¦ â†“                                                   â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ æ¶‰åŠè‡ªç„¶è¯­è¨€ç†è§£ï¼Ÿ                                             â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ ç®€å•æ¨¡å¼ â†’ ã€æ­£åˆ™+å…³é”®è¯ã€‘                             â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šæ—¶é—´è§£æã€é‡‘é¢æå–                          â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¤æ‚è¯­ä¹‰ â†’ ã€å¤§æ¨¡å‹APIã€‘                               â”‚
â”‚      â”‚               ä¾‹å¦‚ï¼šå¯¹è¯ç†è§£ã€æŠ¥å‘Šç”Ÿæˆ                          â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ æ¶‰åŠæ•°å€¼é¢„æµ‹ï¼Ÿ                                                 â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ ç®€å•è¶‹åŠ¿ â†’ ã€ç»Ÿè®¡æ–¹æ³•ã€‘                                â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šç§»åŠ¨å¹³å‡ã€å›å½’                              â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¤æ‚æ¨¡å¼ â†’ ã€æ—¶é—´åºåˆ—æ¨¡å‹ã€‘                            â”‚
â”‚      â”‚               ä¾‹å¦‚ï¼šProphetã€ARIMA                              â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â””â”€ æ¶‰åŠåˆ†ç±»/èšç±»ï¼Ÿ                                                â”‚
â”‚              â”‚                                                         â”‚
â”‚              â”œâ”€ æœ‰å†å²æ•°æ® â†’ ã€æœ¬åœ°MLã€‘                                â”‚
â”‚              â”‚       ä¾‹å¦‚ï¼šäº¤æ˜“åˆ†ç±»å™¨ã€å¼‚å¸¸æ£€æµ‹                        â”‚
â”‚              â”‚                                                         â”‚
â”‚              â””â”€ å†·å¯åŠ¨/å¤æ‚ â†’ ã€å¤§æ¨¡å‹ã€‘                               â”‚
â”‚                      ä¾‹å¦‚ï¼šé¦–æ¬¡åˆ†ç±»ã€è¯­ä¹‰ç†è§£                          â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.10 æˆæœ¬ä¸æ€§èƒ½ä¼˜åŒ–

#### 10.10.1 å¤§æ¨¡å‹è°ƒç”¨ä¼˜åŒ–ç­–ç•¥

```dart
/// å¤§æ¨¡å‹è°ƒç”¨ç®¡ç†å™¨
class LLMCallManager {
  final Cache _cache;
  final RateLimiter _rateLimiter;
  int _dailyCallCount = 0;
  static const int _dailyLimit = 1000;  // æ¯æ—¥é™é¢

  /// æ™ºèƒ½è°ƒç”¨ï¼ˆå¸¦ç¼“å­˜å’Œé™çº§ï¼‰
  Future<String?> smartCall({
    required String prompt,
    required String cacheKey,
    Duration cacheDuration = const Duration(hours: 24),
    bool allowCache = true,
  }) async {
    // 1. æ£€æŸ¥ç¼“å­˜
    if (allowCache) {
      final cached = await _cache.get(cacheKey);
      if (cached != null) return cached;
    }

    // 2. æ£€æŸ¥é™é¢
    if (_dailyCallCount >= _dailyLimit) {
      debugPrint('Daily LLM limit reached, falling back to local');
      return null;  // è¿”å›nullè®©è°ƒç”¨æ–¹é™çº§å¤„ç†
    }

    // 3. æ£€æŸ¥é¢‘ç‡é™åˆ¶
    if (!await _rateLimiter.tryAcquire()) {
      await Future.delayed(Duration(milliseconds: 100));
      if (!await _rateLimiter.tryAcquire()) {
        return null;
      }
    }

    // 4. å®é™…è°ƒç”¨
    try {
      final result = await _qwenService.chat(prompt);
      _dailyCallCount++;

      // 5. ç¼“å­˜ç»“æœ
      if (allowCache && result.isNotEmpty) {
        await _cache.set(cacheKey, result, cacheDuration);
      }

      return result;
    } catch (e) {
      debugPrint('LLM call failed: $e');
      return null;
    }
  }

  /// æ‰¹é‡è°ƒç”¨ä¼˜åŒ–
  Future<List<String?>> batchCall(List<String> prompts) async {
    // åˆå¹¶å¤šä¸ªç®€å•è¯·æ±‚ä¸ºä¸€ä¸ª
    if (prompts.length <= 3) {
      return Future.wait(prompts.map((p) => smartCall(
        prompt: p,
        cacheKey: p.hashCode.toString(),
      )));
    }

    // å¤§é‡è¯·æ±‚æ—¶åˆå¹¶
    final combinedPrompt = '''
è¯·ä¾æ¬¡å›ç­”ä»¥ä¸‹${prompts.length}ä¸ªé—®é¢˜ï¼Œç”¨JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š
${prompts.asMap().entries.map((e) => '${e.key + 1}. ${e.value}').join('\n')}
''';

    final result = await smartCall(
      prompt: combinedPrompt,
      cacheKey: prompts.join('').hashCode.toString(),
    );

    if (result == null) return List.filled(prompts.length, null);

    try {
      final answers = jsonDecode(result) as List;
      return answers.map((a) => a.toString()).toList();
    } catch (e) {
      return List.filled(prompts.length, null);
    }
  }
}
```

#### 10.10.2 æˆæœ¬ç›‘æ§

```dart
/// AIæˆæœ¬ç›‘æ§æœåŠ¡
class AICostMonitor {
  final Map<String, int> _callCounts = {};
  final Map<String, int> _tokenUsage = {};

  /// è®°å½•è°ƒç”¨
  void recordCall(String service, int tokens) {
    _callCounts[service] = (_callCounts[service] ?? 0) + 1;
    _tokenUsage[service] = (_tokenUsage[service] ?? 0) + tokens;
  }

  /// è·å–æ—¥æŠ¥
  CostReport getDailyReport() {
    return CostReport(
      date: DateTime.now(),
      callsByService: Map.from(_callCounts),
      tokensByService: Map.from(_tokenUsage),
      estimatedCost: _calculateCost(),
    );
  }

  double _calculateCost() {
    // æŒ‰æœåŠ¡è®¡ç®—æˆæœ¬ï¼ˆç¤ºä¾‹ä»·æ ¼ï¼‰
    double cost = 0;

    // é€šä¹‰åƒé—®ï¼šçº¦0.008å…ƒ/åƒtokens
    cost += (_tokenUsage['qwen'] ?? 0) / 1000 * 0.008;

    // æ™ºè°±AIï¼šçº¦0.005å…ƒ/åƒtokens
    cost += (_tokenUsage['zhipu'] ?? 0) / 1000 * 0.005;

    return cost;
  }
}
```

---

## 11. åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨

åœ°ç†ä½ç½®ä¿¡æ¯æ˜¯æå‡é›¶åŸºé¢„ç®—ç²¾å‡†åº¦ã€ä¼˜åŒ–é’±é¾„è®¡ç®—åˆç†æ€§ã€å¢å¼ºç†è´¢ä½“éªŒä¸ªæ€§åŒ–çš„å…³é”®èƒ½åŠ›ã€‚æœ¬ç« è¯¦ç»†è®¾è®¡åœ°ç†ä½ç½®ä¿¡æ¯åœ¨APPä¸­çš„åº”ç”¨æ–¹æ¡ˆã€‚

### 11.0 ä½ç½®æœåŠ¡æ¶æ„

#### 11.0.1 æœåŠ¡å±‚æ¬¡ç»“æ„

ä¸ºé¿å…ç±»å‘½åæ··ä¹±å’ŒèŒè´£é‡å ï¼Œä½ç½®ç›¸å…³æœåŠ¡é‡‡ç”¨ä»¥ä¸‹å±‚æ¬¡ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬1å±‚ï¼šåŸºç¡€ä½ç½®æœåŠ¡ï¼ˆåº•å±‚èƒ½åŠ›ï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationService (abstract)  â† ä½ç½®è·å–æŠ½è±¡æ¥å£               â”‚ â”‚
â”‚  â”‚      â”‚                                                       â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ PreciseLocationService   â† GPSé«˜ç²¾åº¦å®šä½å®ç°         â”‚ â”‚
â”‚  â”‚      â””â”€â”€ ApproximateLocationService â† ç½‘ç»œç²—ç•¥å®šä½å®ç°        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬2å±‚ï¼šä½ç½®æ•°æ®æœåŠ¡ï¼ˆæ•°æ®ç®¡ç†ï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  UserHomeLocationService    â† ç®¡ç†ç”¨æˆ·å¸¸é©»åœ°ç‚¹ï¼ˆå®¶ã€å…¬å¸ï¼‰    â”‚ â”‚
â”‚  â”‚  CityLocationService        â† ç®¡ç†ç”¨æˆ·æ‰€åœ¨åŸå¸‚ä¿¡æ¯            â”‚ â”‚
â”‚  â”‚  LocationHistoryService     â† ç®¡ç†ä½ç½®å†å²è®°å½•                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬3å±‚ï¼šä¸šåŠ¡åˆ†ææœåŠ¡ï¼ˆæ™ºèƒ½åˆ†æï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  CrossRegionSpendingService  â† å¼‚åœ°æ¶ˆè´¹æ£€æµ‹                   â”‚ â”‚
â”‚  â”‚  SpendingContextAnalyzer     â† æ¶ˆè´¹åœºæ™¯åˆ†æ                   â”‚ â”‚
â”‚  â”‚  GeofenceAlertService        â† åœ°ç†å›´æ æé†’                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬4å±‚ï¼šé’±é¾„å¢å¼ºæœåŠ¡ï¼ˆåŠŸèƒ½æ•´åˆï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationAwareMoneyAgeService  â† æ•´åˆå¼‚åœ°æ¶ˆè´¹çš„é’±é¾„è®¡ç®—       â”‚ â”‚
â”‚  â”‚      ï¼ˆä½¿ç”¨ CrossRegionSpendingServiceï¼‰                      â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  PreciseMoneyAgeCalculator     â† ç²¾ç¡®ä½ç½®çš„é’±é¾„è®¡ç®—           â”‚ â”‚
â”‚  â”‚      ï¼ˆä½¿ç”¨ SpendingContextAnalyzerï¼‰                         â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  æ³¨æ„ï¼šè¿™ä¸¤ä¸ªæœåŠ¡æ˜¯äº’è¡¥å…³ç³»ï¼Œä¸æ˜¯é‡å¤ï¼š                        â”‚ â”‚
â”‚  â”‚  - LocationAware: åŸå¸‚çº§åˆ«ï¼ŒåŒºåˆ†æœ¬åœ°/å¼‚åœ°                     â”‚ â”‚
â”‚  â”‚  - Precise: è¡—é“çº§åˆ«ï¼Œåˆ†ææ¶ˆè´¹åœºæ™¯                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.0.2 åŸºç¡€æœåŠ¡å®šä¹‰

```dart
/// ä½ç½®æœåŠ¡æŠ½è±¡æ¥å£
abstract class LocationService {
  /// è·å–å½“å‰ä½ç½®
  Future<Position?> getCurrentPosition();

  /// æ£€æŸ¥æƒé™çŠ¶æ€
  Future<LocationPermissionResult> checkPermission();

  /// è¯·æ±‚æƒé™
  Future<LocationPermissionResult> requestPermission();

  /// å¼€å§‹ä½ç½®ç›‘å¬
  Stream<Position> startLocationStream();

  /// åœæ­¢ä½ç½®ç›‘å¬
  void stopLocationStream();
}

/// ç”¨æˆ·å¸¸é©»åœ°ç‚¹ç®¡ç†æœåŠ¡
class UserHomeLocationService {
  final PreciseLocationService _locationService;
  final SharedPreferences _prefs;

  static const String _homeKey = 'user_home_location';
  static const String _workKey = 'user_work_location';
  static const String _frequentKey = 'user_frequent_locations';

  /// è·å–ç”¨æˆ·å®¶åº­ä½ç½®
  Future<PreciseLocation?> getHomeLocation() async {
    final json = _prefs.getString(_homeKey);
    if (json == null) return null;
    return PreciseLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å®¶åº­ä½ç½®
  Future<void> setHomeLocation(PreciseLocation location) async {
    await _prefs.setString(_homeKey, jsonEncode(location.toJson()));
  }

  /// è·å–ç”¨æˆ·å·¥ä½œä½ç½®
  Future<PreciseLocation?> getWorkLocation() async {
    final json = _prefs.getString(_workKey);
    if (json == null) return null;
    return PreciseLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å·¥ä½œä½ç½®
  Future<void> setWorkLocation(PreciseLocation location) async {
    await _prefs.setString(_workKey, jsonEncode(location.toJson()));
  }

  /// é€šè¿‡å½“å‰ä½ç½®è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®å®¶åº­ä½ç½®
  /// ç­–ç•¥ï¼šæ™šä¸Š10ç‚¹åˆ°æ—©ä¸Š7ç‚¹å¤šæ¬¡å‡ºç°çš„ä½ç½®åˆ¤å®šä¸ºå®¶
  Future<bool> autoDetectHomeLocation() async {
    final history = await _getRecentNightLocations();
    if (history.isEmpty) return false;

    final clustered = _clusterLocations(history, radiusMeters: 200);
    if (clustered.isEmpty) return false;

    // é€‰æ‹©å‡ºç°æ¬¡æ•°æœ€å¤šçš„ä½ç½®ç°‡
    final mostFrequent = clustered.reduce((a, b) =>
      a.count > b.count ? a : b);

    if (mostFrequent.count >= 5) {  // è‡³å°‘5æ¬¡
      await setHomeLocation(mostFrequent.center);
      return true;
    }
    return false;
  }

  /// é€šè¿‡å½“å‰ä½ç½®è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®å·¥ä½œä½ç½®
  /// ç­–ç•¥ï¼šå·¥ä½œæ—¥ä¸Šåˆ9ç‚¹åˆ°ä¸‹åˆ6ç‚¹å¤šæ¬¡å‡ºç°çš„ä½ç½®åˆ¤å®šä¸ºå…¬å¸
  Future<bool> autoDetectWorkLocation() async {
    final history = await _getRecentWorkdayLocations();
    if (history.isEmpty) return false;

    final clustered = _clusterLocations(history, radiusMeters: 300);
    if (clustered.isEmpty) return false;

    final mostFrequent = clustered.reduce((a, b) =>
      a.count > b.count ? a : b);

    // æ’é™¤å®¶é™„è¿‘çš„ä½ç½®
    final home = await getHomeLocation();
    if (home != null && mostFrequent.center.distanceTo(home) < 500) {
      // å¦‚æœæœ€é¢‘ç¹çš„ä½ç½®åœ¨å®¶é™„è¿‘ï¼Œé€‰æ‹©æ¬¡é¢‘ç¹çš„
      clustered.remove(mostFrequent);
      if (clustered.isEmpty) return false;
      final secondFrequent = clustered.reduce((a, b) =>
        a.count > b.count ? a : b);
      if (secondFrequent.count >= 3) {
        await setWorkLocation(secondFrequent.center);
        return true;
      }
      return false;
    }

    if (mostFrequent.count >= 3) {  // è‡³å°‘3æ¬¡
      await setWorkLocation(mostFrequent.center);
      return true;
    }
    return false;
  }

  /// è·å–ç”¨æˆ·å¸¸å»çš„åœ°ç‚¹åˆ—è¡¨
  Future<List<FrequentLocation>> getFrequentLocations() async {
    final json = _prefs.getString(_frequentKey);
    if (json == null) return [];
    final list = jsonDecode(json) as List;
    return list.map((e) => FrequentLocation.fromJson(e)).toList();
  }

  /// ä½ç½®èšç±»ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆDBSCANï¼‰
  List<LocationCluster> _clusterLocations(
    List<PreciseLocation> locations, {
    required double radiusMeters,
  }) {
    // å®ç°ç•¥...
    return [];
  }
}

/// ä½ç½®èšç±»ç»“æœ
class LocationCluster {
  final PreciseLocation center;
  final int count;
  final List<PreciseLocation> members;

  const LocationCluster({
    required this.center,
    required this.count,
    required this.members,
  });
}

/// å¸¸å»åœ°ç‚¹
class FrequentLocation {
  final String id;
  final String name;           // ç”¨æˆ·å‘½åæˆ–è‡ªåŠ¨è¯†åˆ«çš„åç§°
  final PreciseLocation location;
  final int visitCount;        // è®¿é—®æ¬¡æ•°
  final DateTime lastVisit;    // æœ€è¿‘è®¿é—®
  final LocationType type;     // åœ°ç‚¹ç±»å‹

  const FrequentLocation({
    required this.id,
    required this.name,
    required this.location,
    required this.visitCount,
    required this.lastVisit,
    required this.type,
  });

  factory FrequentLocation.fromJson(Map<String, dynamic> json) {
    return FrequentLocation(
      id: json['id'],
      name: json['name'],
      location: PreciseLocation.fromJson(json['location']),
      visitCount: json['visitCount'],
      lastVisit: DateTime.parse(json['lastVisit']),
      type: LocationType.values.byName(json['type']),
    );
  }
}

/// åœ°ç‚¹ç±»å‹
enum LocationType {
  home,       // å®¶
  work,       // å…¬å¸
  gym,        // å¥èº«æˆ¿
  supermarket,// è¶…å¸‚
  restaurant, // å¸¸å»é¤å…
  hospital,   // åŒ»é™¢
  school,     // å­¦æ ¡
  other,      // å…¶ä»–
}

/// åŸå¸‚ä½ç½®æœåŠ¡
class CityLocationService {
  final PreciseLocationService _locationService;
  final SharedPreferences _prefs;

  static const String _homeCityKey = 'user_home_city';

  /// è·å–ç”¨æˆ·å¸¸é©»åŸå¸‚
  Future<CityLocation?> getHomeCity() async {
    final json = _prefs.getString(_homeCityKey);
    if (json == null) return null;
    return CityLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å¸¸é©»åŸå¸‚
  Future<void> setHomeCity(CityLocation city) async {
    await _prefs.setString(_homeCityKey, jsonEncode(city.toJson()));
  }

  /// ä»ç²¾ç¡®ä½ç½®æå–åŸå¸‚ä¿¡æ¯
  CityLocation extractCityFromLocation(PreciseLocation location) {
    return CityLocation(
      country: location.country,
      province: location.province,
      city: location.city,
      tier: location.cityTier,
      isOverseas: location.isOverseas,
    );
  }

  /// è·å–å½“å‰æ‰€åœ¨åŸå¸‚
  Future<CityLocation?> getCurrentCity() async {
    final location = await _locationService.getCurrentLocation();
    if (location == null) return null;
    return extractCityFromLocation(location);
  }
}

/// åŸå¸‚ä½ç½®ä¿¡æ¯ï¼ˆè½»é‡çº§ï¼Œç”¨äºåŸå¸‚çº§åˆ«åˆ¤æ–­ï¼‰
class CityLocation {
  final String country;
  final String province;
  final String city;
  final CityTier tier;
  final bool isOverseas;

  const CityLocation({
    required this.country,
    required this.province,
    required this.city,
    required this.tier,
    required this.isOverseas,
  });

  factory CityLocation.fromJson(Map<String, dynamic> json) {
    return CityLocation(
      country: json['country'],
      province: json['province'],
      city: json['city'],
      tier: CityTier.values.byName(json['tier']),
      isOverseas: json['isOverseas'],
    );
  }

  Map<String, dynamic> toJson() => {
    'country': country,
    'province': province,
    'city': city,
    'tier': tier.name,
    'isOverseas': isOverseas,
  };
}
```

#### 11.0.3 æœåŠ¡ä¾èµ–å…³ç³»

```dart
/// ä½ç½®æœåŠ¡ä¾èµ–æ³¨å…¥é…ç½®
class LocationServiceLocator {
  static final _instance = LocationServiceLocator._();
  factory LocationServiceLocator() => _instance;
  LocationServiceLocator._();

  late final PreciseLocationService preciseLocation;
  late final UserHomeLocationService userHome;
  late final CityLocationService cityLocation;
  late final CrossRegionSpendingService crossRegion;
  late final SpendingContextAnalyzer spendingContext;
  late final LocationAwareMoneyAgeService locationAwareMoneyAge;

  Future<void> initialize(SharedPreferences prefs) async {
    // ç¬¬1å±‚ï¼šåŸºç¡€å®šä½æœåŠ¡
    preciseLocation = PreciseLocationService();

    // ç¬¬2å±‚ï¼šä½ç½®æ•°æ®æœåŠ¡
    userHome = UserHomeLocationService(
      _locationService: preciseLocation,
      _prefs: prefs,
    );
    cityLocation = CityLocationService(
      _locationService: preciseLocation,
      _prefs: prefs,
    );

    // ç¬¬3å±‚ï¼šä¸šåŠ¡åˆ†ææœåŠ¡
    crossRegion = CrossRegionSpendingService(
      _locationService: cityLocation,  // ä½¿ç”¨åŸå¸‚çº§åˆ«æœåŠ¡
      _prefs: prefs,
    );
    spendingContext = SpendingContextAnalyzer(
      _locationService: preciseLocation,  // ä½¿ç”¨ç²¾ç¡®ä½ç½®æœåŠ¡
      _homeService: userHome,
    );

    // ç¬¬4å±‚ï¼šé’±é¾„å¢å¼ºæœåŠ¡
    locationAwareMoneyAge = LocationAwareMoneyAgeService(
      _crossRegionService: crossRegion,
      _baseCalculator: MoneyAgeCalculator(),
    );
  }
}
```

### 11.1 è®¾è®¡ç†å¿µä¸éšç§åŸåˆ™

#### 11.1.1 æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åœ°ç†ä½ç½®ä¿¡æ¯ä¸‰å¤§ä»·å€¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼ä¸€ï¼šç²¾å‡†åŒ¹é…æœ¬åœ°åŒ–æ¶ˆè´¹åœºæ™¯ï¼Œä¼˜åŒ–é›¶åŸºé¢„ç®—ç±»ç›®åˆ†é…            â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨ç”Ÿæˆæœ¬åœ°åŒ–é¢„ç®—ç±»ç›®ï¼ˆä¸€çº¿åŸå¸‚ä¾§é‡æˆ¿ç§Ÿ/é€šå‹¤ï¼Œä¸‰çº¿ä¾§é‡é¤é¥®ï¼‰â”‚  â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½æµ‹ç®—ç±»ç›®é¢„ç®—é‡‘é¢ï¼ˆåŸºäºå½“åœ°æ¶ˆè´¹æ°´å¹³ï¼‰                     â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨è¯†åˆ«è·¨åŒºåŸŸæ¶ˆè´¹çš„é¢„ç®—å½’å±ï¼ˆå‡ºå·®/æ—…æ¸¸ï¼‰                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼äºŒï¼šä¼˜åŒ–é’±é¾„è®¡ç®—çš„å‡†ç¡®æ€§ï¼Œé¿å…å¼‚å¸¸æ•°æ®å¹²æ‰°                  â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ åŒºåˆ†"ä¸´æ—¶å¤§é¢æ”¯å‡º"ä¸"æ—¥å¸¸æ¶ˆè´¹"                              â”‚  â”‚
â”‚  â”‚  â€¢ è¯†åˆ«"è¢«åŠ¨åˆšéœ€"ä¸"ä¸»åŠ¨æ¶ˆè´¹"ï¼Œä¼˜åŒ–é’±é¾„æƒé‡                   â”‚  â”‚
â”‚  â”‚  â€¢ å¼‚åœ°æ¶ˆè´¹å¯å•ç‹¬ç»Ÿè®¡ï¼Œä¸å¹²æ‰°æ—¥å¸¸é’±é¾„                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼ä¸‰ï¼šå¢å¼ºç”¨æˆ·ç²˜æ€§ä¸ç†è´¢å†³ç­–çš„å®ç”¨æ€§                          â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ æä¾›æœ¬åœ°åŒ–çœé’±å»ºè®®ï¼ŒåŠ©åŠ›é’±é¾„æå‡                             â”‚  â”‚
â”‚  â”‚  â€¢ é€‚é…æœ¬åœ°åŒ–æ”¶å…¥ä¸æ”¿ç­–ï¼Œä¼˜åŒ–é¢„ç®—è§„åˆ’                           â”‚  â”‚
â”‚  â”‚  â€¢ è§„é¿è·¨åŒºåŸŸè´¢åŠ¡é£é™©ï¼ˆæ±‡ç‡ã€æ‰‹ç»­è´¹ï¼‰                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.1.2 ç²¾ç¡®ä½ç½®çš„æ ¸å¿ƒä»·å€¼

ç²¾ç¡®çš„ç»çº¬åº¦ä¿¡æ¯èƒ½å¤Ÿå®ç°ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼š

| èƒ½åŠ› | ç²¾ç¡®ä½ç½®å®ç° | åº”ç”¨åœºæ™¯ |
|------|-------------|----------|
| **å•†æˆ·çº§åˆ«è¯†åˆ«** | é€šè¿‡ç»çº¬åº¦åŒ¹é…POIæ•°æ®åº“ | è‡ªåŠ¨è¯†åˆ«æ¶ˆè´¹å•†å®¶ï¼Œæ™ºèƒ½åˆ†ç±» |
| **æ¶ˆè´¹åœºæ™¯åˆ†æ** | åŒºåˆ†å•†åœˆ/ç¤¾åŒº/åŠå…¬åŒºæ¶ˆè´¹ | è¯†åˆ«å·¥ä½œæ—¥åˆé¤vså‘¨æœ«èšé¤ |
| **é€šå‹¤è·¯å¾„è¿½è¸ª** | è®°å½•æ¯æ—¥å‡ºè¡Œè½¨è¿¹ | ç²¾ç¡®è®¡ç®—äº¤é€šæˆæœ¬ï¼Œä¼˜åŒ–é€šå‹¤é¢„ç®— |
| **æ¶ˆè´¹çƒ­åŠ›å›¾** | æ ‡è®°é«˜é¢‘æ¶ˆè´¹åœ°ç‚¹ | å‘ç°æ¶ˆè´¹ä¹ æƒ¯ï¼Œæä¾›çœé’±è·¯çº¿å»ºè®® |
| **æ™ºèƒ½å›´æ æé†’** | è¿›å…¥ç‰¹å®šåŒºåŸŸè§¦å‘æé†’ | è´­ç‰©ä¸­å¿ƒé¢„ç®—æé†’ã€ä¼˜æƒ åˆ¸ä½¿ç”¨æé†’ |
| **è·¨åŒºåŸŸç²¾ç¡®åˆ¤æ–­** | ç²¾ç¡®åˆ°è¡—é“çº§åˆ«çš„å¼‚åœ°åˆ¤æ–­ | åŒºåˆ†"æœ¬åœ°"ä¸"å‡ºå·®/æ—…æ¸¸"æ¶ˆè´¹ |

#### 11.1.3 ä½ç½®æ•°æ®é‡‡é›†ç­–ç•¥

| ç­–ç•¥ | å®ç°æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| **å®æ—¶é«˜ç²¾åº¦** | GPS + ç½‘ç»œå®šä½ | è®°è´¦æ—¶è·å–ç²¾ç¡®ä½ç½® |
| **åå°ä½åŠŸè€—** | æ˜¾è‘—ä½ç½®å˜åŒ–ç›‘å¬ | æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç¦»å¼€å¸¸é©»åŸå¸‚ |
| **æ˜ç¡®æˆæƒ** | é¦–æ¬¡ä½¿ç”¨å‰å¼¹çª—è¯´æ˜ç”¨é€” | ç”¨æˆ·å¯é€‰æ‹©æ‹’ç»ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ |
| **éšæ—¶å…³é—­** | è®¾ç½®ä¸­å¯ä¸€é”®å…³é—­ | å…³é—­åä»…å–æ¶ˆä½ç½®æ™ºèƒ½åŠŸèƒ½ |
| **æœ¬åœ°ä¼˜å…ˆ** | ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨ | å¯é€‰æ‹©æ˜¯å¦åŒæ­¥åˆ°äº‘ç«¯å¤‡ä»½ |

```dart
/// ç²¾ç¡®åœ°ç†ä½ç½®æœåŠ¡
class PreciseLocationService {
  static const String _permissionKey = 'location_permission_granted';

  /// ä½ç½®ç²¾åº¦çº§åˆ«ï¼ˆé«˜ç²¾åº¦å®šä½ï¼‰
  static const LocationAccuracy accuracy = LocationAccuracy.high;

  /// ä½ç½®é‡‡é›†é…ç½®
  static const LocationSettings locationSettings = LocationSettings(
    accuracy: LocationAccuracy.high,
    distanceFilter: 10, // ç§»åŠ¨10ç±³ä»¥ä¸Šæ‰æ›´æ–°
  );

  /// åå°ä½ç½®ç›‘å¬é…ç½®ï¼ˆä½åŠŸè€—ï¼‰
  static const LocationSettings backgroundSettings = LocationSettings(
    accuracy: LocationAccuracy.low,
    distanceFilter: 500, // ç§»åŠ¨500ç±³ä»¥ä¸Šæ‰æ›´æ–°
  );

  /// æ£€æŸ¥å¹¶è¯·æ±‚ç²¾ç¡®ä½ç½®æƒé™
  Future<LocationPermissionResult> requestPrecisePermission() async {
    // 1. æ£€æŸ¥åŸºç¡€ä½ç½®æƒé™
    final status = await Permission.location.status;

    if (status.isDenied) {
      final userAccepted = await _showPermissionExplanation();
      if (!userAccepted) {
        return LocationPermissionResult.denied;
      }
      final result = await Permission.location.request();
      if (!result.isGranted) {
        return LocationPermissionResult.denied;
      }
    }

    // 2. æ£€æŸ¥ç²¾ç¡®ä½ç½®æƒé™ï¼ˆAndroid 12+ï¼‰
    if (Platform.isAndroid) {
      final preciseStatus = await Permission.locationAlways.status;
      if (preciseStatus.isDenied) {
        // å¼•å¯¼ç”¨æˆ·å¼€å¯ç²¾ç¡®ä½ç½®
        await _showPreciseLocationExplanation();
        final result = await Permission.locationAlways.request();
        if (!result.isGranted) {
          return LocationPermissionResult.approximate; // ä»…æœ‰ç²—ç•¥ä½ç½®
        }
      }
    }

    // 3. æ£€æŸ¥åå°ä½ç½®æƒé™ï¼ˆç”¨äºè‡ªåŠ¨æ£€æµ‹å¼‚åœ°ï¼‰
    final alwaysStatus = await Permission.locationAlways.status;
    if (alwaysStatus.isDenied) {
      // åå°æƒé™å¯é€‰ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹å‡ºå·®/æ—…æ¸¸
      return LocationPermissionResult.foregroundOnly;
    }

    return LocationPermissionResult.full;
  }

  /// è·å–å½“å‰ç²¾ç¡®ä½ç½®
  Future<PreciseLocation?> getCurrentLocation() async {
    if (!await _hasPermission()) return null;

    try {
      final position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
        timeLimit: Duration(seconds: 10),
      );

      // åå‘åœ°ç†ç¼–ç è·å–è¯¦ç»†åœ°å€
      final placemarks = await placemarkFromCoordinates(
        position.latitude,
        position.longitude,
      );

      final place = placemarks.isNotEmpty ? placemarks.first : null;

      // æŸ¥è¯¢POIä¿¡æ¯ï¼ˆå•†æˆ·è¯†åˆ«ï¼‰
      final poi = await _queryNearbyPOI(position.latitude, position.longitude);

      return PreciseLocation(
        latitude: position.latitude,
        longitude: position.longitude,
        accuracy: position.accuracy,
        timestamp: DateTime.now(),
        // åœ°å€ä¿¡æ¯
        country: place?.country ?? '',
        countryCode: place?.isoCountryCode ?? 'CN',
        province: place?.administrativeArea ?? '',
        city: place?.locality ?? place?.subAdministrativeArea ?? '',
        district: place?.subLocality ?? '',
        street: place?.street ?? '',
        streetNumber: place?.subThoroughfare ?? '',
        fullAddress: _buildFullAddress(place),
        // åŸå¸‚çº§åˆ«
        cityTier: _getCityTier(place?.locality),
        // POIä¿¡æ¯
        nearbyPOI: poi,
        // åŒºåŸŸç±»å‹
        areaType: _detectAreaType(poi),
      );
    } catch (e) {
      return null;
    }
  }

  /// æŸ¥è¯¢é™„è¿‘POIï¼ˆå•†æˆ·è¯†åˆ«ï¼‰
  Future<NearbyPOI?> _queryNearbyPOI(double lat, double lng) async {
    // è°ƒç”¨é«˜å¾·/ç™¾åº¦åœ°å›¾POIæœç´¢API
    try {
      final response = await _poiService.searchNearby(
        latitude: lat,
        longitude: lng,
        radius: 50, // 50ç±³èŒƒå›´å†…
        types: ['é¤é¥®', 'è´­ç‰©', 'äº¤é€š', 'ç”Ÿæ´»æœåŠ¡', 'é‡‘è', 'å¨±ä¹'],
      );

      if (response.pois.isEmpty) return null;

      final nearest = response.pois.first;
      return NearbyPOI(
        name: nearest.name,
        type: nearest.type,
        category: _mapPOICategory(nearest.type),
        distance: nearest.distance,
        address: nearest.address,
        businessArea: nearest.businessArea,
      );
    } catch (e) {
      return null;
    }
  }

  /// æ£€æµ‹åŒºåŸŸç±»å‹ï¼ˆå•†åœˆ/åŠå…¬åŒº/ä½å®…åŒºï¼‰
  AreaType _detectAreaType(NearbyPOI? poi) {
    if (poi == null) return AreaType.unknown;

    // åŸºäºPOIç±»å‹å’Œå•†åœˆä¿¡æ¯åˆ¤æ–­
    if (poi.businessArea != null && poi.businessArea!.isNotEmpty) {
      return AreaType.commercial; // å•†åœˆ
    }

    switch (poi.category) {
      case POICategory.office:
        return AreaType.office;
      case POICategory.residential:
        return AreaType.residential;
      case POICategory.transportation:
        return AreaType.transportation;
      case POICategory.shopping:
      case POICategory.dining:
      case POICategory.entertainment:
        return AreaType.commercial;
      default:
        return AreaType.unknown;
    }
  }

  /// åˆ¤æ–­åŸå¸‚çº§åˆ«
  CityTier _getCityTier(String? city) {
    const tier1 = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³'];
    const newTier1 = ['æˆéƒ½', 'æ­å·', 'é‡åº†', 'è¥¿å®‰', 'è‹å·', 'æ­¦æ±‰', 'å—äº¬',
                      'å¤©æ´¥', 'éƒ‘å·', 'é•¿æ²™', 'ä¸œè', 'ä½›å±±', 'å®æ³¢', 'é’å²›', 'æ²ˆé˜³'];
    const tier2 = ['æ— é”¡', 'åˆè‚¥', 'æ˜†æ˜', 'å¤§è¿', 'å¦é—¨', 'æµå—', 'ç¦å·',
                   'æ¸©å·', 'å—å®', 'é•¿æ˜¥', 'æ³‰å·', 'çŸ³å®¶åº„', 'è´µé˜³', 'å—æ˜Œ', 'é‡‘å'];

    if (city == null) return CityTier.unknown;
    if (tier1.contains(city)) return CityTier.tier1;
    if (newTier1.contains(city)) return CityTier.newTier1;
    if (tier2.contains(city)) return CityTier.tier2;
    return CityTier.tier3;
  }
}

/// ç²¾ç¡®ä½ç½®ä¿¡æ¯
class PreciseLocation {
  // ç»çº¬åº¦
  final double latitude;
  final double longitude;
  final double accuracy;  // ç²¾åº¦ï¼ˆç±³ï¼‰
  final DateTime timestamp;

  // åœ°å€ä¿¡æ¯
  final String country;
  final String countryCode;
  final String province;
  final String city;
  final String district;  // åŒº/å¿
  final String street;
  final String streetNumber;
  final String fullAddress;

  // åŸå¸‚çº§åˆ«
  final CityTier cityTier;

  // POIä¿¡æ¯
  final NearbyPOI? nearbyPOI;

  // åŒºåŸŸç±»å‹
  final AreaType areaType;

  bool get isDomestic => countryCode == 'CN';
  bool get isOverseas => !isDomestic;

  /// è®¡ç®—ä¸å¦ä¸€ä½ç½®çš„è·ç¦»ï¼ˆç±³ï¼‰
  double distanceTo(PreciseLocation other) {
    return Geolocator.distanceBetween(
      latitude, longitude,
      other.latitude, other.longitude,
    );
  }

  /// æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
  bool isWithinRadius(PreciseLocation center, double radiusMeters) {
    return distanceTo(center) <= radiusMeters;
  }
}

/// é™„è¿‘POIä¿¡æ¯
class NearbyPOI {
  final String name;          // å•†æˆ·åç§°
  final String type;          // åŸå§‹ç±»å‹
  final POICategory category; // æ ‡å‡†åŒ–åˆ†ç±»
  final double distance;      // è·ç¦»ï¼ˆç±³ï¼‰
  final String? address;      // åœ°å€
  final String? businessArea; // å•†åœˆåç§°
}

/// POIåˆ†ç±»
enum POICategory {
  dining,         // é¤é¥®
  shopping,       // è´­ç‰©
  transportation, // äº¤é€š
  office,         // åŠå…¬
  residential,    // ä½å®…
  entertainment,  // å¨±ä¹
  finance,        // é‡‘è
  medical,        // åŒ»ç–—
  education,      // æ•™è‚²
  other,          // å…¶ä»–
}

/// åŒºåŸŸç±»å‹
enum AreaType {
  commercial,     // å•†åœˆ
  office,         // åŠå…¬åŒº
  residential,    // ä½å®…åŒº
  transportation, // äº¤é€šæ¢çº½
  unknown,
}

/// åŸå¸‚çº§åˆ«
enum CityTier {
  tier1,      // ä¸€çº¿åŸå¸‚
  newTier1,   // æ–°ä¸€çº¿åŸå¸‚
  tier2,      // äºŒçº¿åŸå¸‚
  tier3,      // ä¸‰å››çº¿åŸå¸‚
  unknown,
}

/// ä½ç½®æƒé™ç»“æœ
enum LocationPermissionResult {
  full,           // å®Œæ•´æƒé™ï¼ˆå‰å°+åå°+ç²¾ç¡®ï¼‰
  foregroundOnly, // ä»…å‰å°ç²¾ç¡®ä½ç½®
  approximate,    // ä»…ç²—ç•¥ä½ç½®
  denied,         // æ‹’ç»æˆæƒ
}
```

### 11.2 æœ¬åœ°åŒ–é¢„ç®—ç±»ç›®æ¨è

#### 11.2.1 åŸå¸‚çº§åˆ«å·®å¼‚åŒ–ç±»ç›®

```dart
/// æœ¬åœ°åŒ–é¢„ç®—ç±»ç›®æ¨èæœåŠ¡
class LocalizedBudgetCategoryService {
  /// æ ¹æ®åŸå¸‚çº§åˆ«æ¨èé»˜è®¤é¢„ç®—ç±»ç›®
  List<RecommendedCategory> getRecommendedCategories(CityLocation location) {
    final tier = location.tier;
    final isOverseas = location.isOverseas;

    if (isOverseas) {
      return _getOverseasCategories(location);
    }

    switch (tier) {
      case CityTier.tier1:
        return _getTier1Categories();
      case CityTier.newTier1:
        return _getNewTier1Categories();
      case CityTier.tier2:
        return _getTier2Categories();
      default:
        return _getTier3Categories();
    }
  }

  /// ä¸€çº¿åŸå¸‚æ¨èç±»ç›®ï¼ˆé«˜æˆ¿ç§Ÿã€é«˜é€šå‹¤æˆæœ¬ï¼‰
  List<RecommendedCategory> _getTier1Categories() {
    return [
      RecommendedCategory(
        name: 'æˆ¿ç§Ÿ/æˆ¿è´·',
        icon: Icons.home,
        suggestedPercentage: 0.30,  // æ”¶å…¥çš„30%
        priority: 1,
        description: 'ä¸€çº¿åŸå¸‚æˆ¿ç§Ÿå æ¯”é€šå¸¸è¾ƒé«˜',
      ),
      RecommendedCategory(
        name: 'é€šå‹¤äº¤é€š',
        icon: Icons.subway,
        suggestedPercentage: 0.08,
        priority: 2,
        description: 'åœ°é“/å…¬äº¤/ç½‘çº¦è½¦',
        subCategories: ['åœ°é“', 'å…¬äº¤', 'ç½‘çº¦è½¦', 'å…±äº«å•è½¦'],
      ),
      RecommendedCategory(
        name: 'é¤é¥®',
        icon: Icons.restaurant,
        suggestedPercentage: 0.15,
        priority: 3,
        description: 'å¤–å–å’Œå·¥ä½œé¤æˆæœ¬è¾ƒé«˜',
      ),
      RecommendedCategory(
        name: 'æ—¥ç”¨å“',
        icon: Icons.shopping_bag,
        suggestedPercentage: 0.05,
        priority: 4,
      ),
      RecommendedCategory(
        name: 'ç¤¾äº¤å¨±ä¹',
        icon: Icons.celebration,
        suggestedPercentage: 0.08,
        priority: 5,
      ),
      RecommendedCategory(
        name: 'å‚¨è“„/æŠ•èµ„',
        icon: Icons.savings,
        suggestedPercentage: 0.20,
        priority: 6,
        description: 'å»ºè®®ä¼˜å…ˆç§¯ç´¯åº”æ€¥é‡‘',
      ),
      RecommendedCategory(
        name: 'è‡ªæˆ‘æå‡',
        icon: Icons.school,
        suggestedPercentage: 0.05,
        priority: 7,
        description: 'åŸ¹è®­ã€ä¹¦ç±ã€è¯¾ç¨‹',
      ),
      RecommendedCategory(
        name: 'å…¶ä»–',
        icon: Icons.more_horiz,
        suggestedPercentage: 0.09,
        priority: 8,
      ),
    ];
  }

  /// ä¸‰å››çº¿åŸå¸‚æ¨èç±»ç›®ï¼ˆä½æˆ¿ç§Ÿã€é«˜é¤é¥®ç¤¾äº¤ï¼‰
  List<RecommendedCategory> _getTier3Categories() {
    return [
      RecommendedCategory(
        name: 'æˆ¿ç§Ÿ/æˆ¿è´·',
        icon: Icons.home,
        suggestedPercentage: 0.15,  // å æ¯”è¾ƒä½
        priority: 1,
      ),
      RecommendedCategory(
        name: 'é¤é¥®',
        icon: Icons.restaurant,
        suggestedPercentage: 0.20,  // å æ¯”è¾ƒé«˜
        priority: 2,
        description: 'å®¶å¸¸èœé¦†ã€æœ¬åœ°ç‰¹è‰²',
      ),
      RecommendedCategory(
        name: 'äº¤é€šå‡ºè¡Œ',
        icon: Icons.directions_car,
        suggestedPercentage: 0.10,
        priority: 3,
        description: 'ç§å®¶è½¦/ç”µåŠ¨è½¦ä¸ºä¸»',
        subCategories: ['åŠ æ²¹', 'åœè½¦', 'ä¿å…»', 'ç”µåŠ¨è½¦å……ç”µ'],
      ),
      RecommendedCategory(
        name: 'ä¼‘é—²å¨±ä¹',
        icon: Icons.sports_esports,
        suggestedPercentage: 0.12,  // æœ¬åœ°å¨±ä¹å æ¯”é«˜
        priority: 4,
        description: 'æœ¬åœ°ä¼‘é—²åœºæ‰€',
      ),
      RecommendedCategory(
        name: 'äººæƒ…å¾€æ¥',
        icon: Icons.card_giftcard,
        suggestedPercentage: 0.08,
        priority: 5,
        description: 'çº¢åŒ…ã€ç¤¼é‡‘ã€ç¤¼å“',
      ),
      RecommendedCategory(
        name: 'å‚¨è“„/æŠ•èµ„',
        icon: Icons.savings,
        suggestedPercentage: 0.25,  // ç”Ÿæ´»æˆæœ¬ä½ï¼Œå‚¨è“„ç©ºé—´å¤§
        priority: 6,
      ),
      RecommendedCategory(
        name: 'å…¶ä»–',
        icon: Icons.more_horiz,
        suggestedPercentage: 0.10,
        priority: 7,
      ),
    ];
  }

  /// æµ·å¤–ç”¨æˆ·ç‰¹æ®Šç±»ç›®
  List<RecommendedCategory> _getOverseasCategories(CityLocation location) {
    final base = _getTier1Categories();

    // æ·»åŠ æµ·å¤–ç‰¹æœ‰ç±»ç›®
    base.addAll([
      RecommendedCategory(
        name: 'ç¨è´¹',
        icon: Icons.receipt_long,
        suggestedPercentage: 0.05,
        priority: 9,
        description: 'æ¶ˆè´¹ç¨ã€æœåŠ¡è´¹ç­‰',
      ),
      RecommendedCategory(
        name: 'å°è´¹',
        icon: Icons.volunteer_activism,
        suggestedPercentage: 0.03,
        priority: 10,
        description: 'æœåŠ¡è¡Œä¸šå°è´¹',
      ),
      RecommendedCategory(
        name: 'æ±‡ç‡æŸå¤±',
        icon: Icons.currency_exchange,
        suggestedPercentage: 0.02,
        priority: 11,
        description: 'è·¨å¢ƒæ”¯ä»˜æ±‡ç‡å·®',
      ),
    ]);

    return base;
  }
}
```

#### 11.2.2 æœ¬åœ°åŒ–é¢„ç®—é‡‘é¢å»ºè®®

```dart
/// æœ¬åœ°åŒ–é¢„ç®—é‡‘é¢å»ºè®®æœåŠ¡
class LocalizedBudgetAmountService {
  /// åŸå¸‚æ¶ˆè´¹æ°´å¹³ç³»æ•°ï¼ˆä»¥å…¨å›½å¹³å‡ä¸º1.0ï¼‰
  static const Map<CityTier, double> costOfLivingIndex = {
    CityTier.tier1: 1.8,      // ä¸€çº¿åŸå¸‚æ¶ˆè´¹æ°´å¹³æ˜¯å…¨å›½1.8å€
    CityTier.newTier1: 1.4,   // æ–°ä¸€çº¿
    CityTier.tier2: 1.1,      // äºŒçº¿
    CityTier.tier3: 0.8,      // ä¸‰å››çº¿
    CityTier.unknown: 1.0,
  };

  /// å„ç±»ç›®çš„å…¨å›½å¹³å‡æœˆæ”¯å‡ºï¼ˆå…ƒï¼‰
  static const Map<String, double> nationalAverageSpending = {
    'æˆ¿ç§Ÿ/æˆ¿è´·': 2000,
    'é¤é¥®': 1500,
    'é€šå‹¤äº¤é€š': 400,
    'äº¤é€šå‡ºè¡Œ': 600,
    'æ—¥ç”¨å“': 300,
    'ç¤¾äº¤å¨±ä¹': 500,
    'ä¼‘é—²å¨±ä¹': 400,
    'äººæƒ…å¾€æ¥': 300,
    'è‡ªæˆ‘æå‡': 200,
  };

  /// è®¡ç®—æœ¬åœ°åŒ–é¢„ç®—å»ºè®®é‡‘é¢
  BudgetAmountSuggestion getSuggestedAmount({
    required String category,
    required CityLocation location,
    required double monthlyIncome,
  }) {
    final coefficient = costOfLivingIndex[location.tier] ?? 1.0;
    final nationalAvg = nationalAverageSpending[category] ?? 500;

    // åŸºäºåŸå¸‚ç³»æ•°çš„è°ƒæ•´é‡‘é¢
    final adjustedAmount = nationalAvg * coefficient;

    // åŸºäºæ”¶å…¥çš„æ¨èå æ¯”
    final percentageBasedAmount = _getPercentageBasedAmount(
      category, monthlyIncome, location.tier);

    // å–ä¸¤è€…çš„åŠ æƒå¹³å‡ï¼ˆåŸå¸‚ç³»æ•°æƒé‡60%ï¼Œæ”¶å…¥å æ¯”æƒé‡40%ï¼‰
    final suggestedAmount = adjustedAmount * 0.6 + percentageBasedAmount * 0.4;

    return BudgetAmountSuggestion(
      category: category,
      suggestedAmount: suggestedAmount.roundToDouble(),
      nationalAverage: nationalAvg,
      localAverage: adjustedAmount.roundToDouble(),
      reasoning: _generateReasoning(category, location, suggestedAmount),
      range: AmountRange(
        min: suggestedAmount * 0.7,
        max: suggestedAmount * 1.3,
      ),
    );
  }

  String _generateReasoning(String category, CityLocation location, double amount) {
    switch (category) {
      case 'æˆ¿ç§Ÿ/æˆ¿è´·':
        return '${location.city}çš„æˆ¿ç§Ÿæ°´å¹³çº¦ä¸ºå…¨å›½${(costOfLivingIndex[location.tier]! * 100).toInt()}%ï¼Œ'
               'å»ºè®®é¢„ç•™ Â¥${amount.toStringAsFixed(0)}/æœˆ';
      case 'é¤é¥®':
        return '${location.city}é¤é¥®äººå‡æ¶ˆè´¹çº¦ Â¥${(amount / 30).toStringAsFixed(0)}/å¤©';
      case 'é€šå‹¤äº¤é€š':
        return '${location.city}æ—¥å‡é€šå‹¤æˆæœ¬çº¦ Â¥${(amount / 22).toStringAsFixed(0)}';
      default:
        return 'åŸºäº${location.city}æ¶ˆè´¹æ°´å¹³æ¨è';
    }
  }
}

/// é¢„ç®—é‡‘é¢å»ºè®®
class BudgetAmountSuggestion {
  final String category;
  final double suggestedAmount;
  final double nationalAverage;
  final double localAverage;
  final String reasoning;
  final AmountRange range;
}
```

### 11.3 è·¨åŒºåŸŸæ¶ˆè´¹æ™ºèƒ½è¯†åˆ«

#### 11.3.1 å¼‚åœ°æ¶ˆè´¹æ£€æµ‹ä¸æ ‡è®°

```dart
/// å¼‚åœ°æ¶ˆè´¹æ£€æµ‹æœåŠ¡
/// æ³¨æ„ï¼šä½¿ç”¨ CityLocationServiceï¼ˆåŸå¸‚çº§åˆ«ï¼‰ï¼Œä¸æ˜¯ PreciseLocationService
/// å‚è§ 11.0.1 ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„
class CrossRegionSpendingService {
  final CityLocationService _cityService;  // åŸå¸‚çº§åˆ«æœåŠ¡
  final SharedPreferences _prefs;

  /// ç”¨æˆ·å¸¸é©»åŸå¸‚
  CityLocation? _homeCity;

  /// æ£€æµ‹äº¤æ˜“æ˜¯å¦ä¸ºå¼‚åœ°æ¶ˆè´¹
  Future<CrossRegionStatus> detectCrossRegion(Transaction tx) async {
    final homeCity = await _getHomeCity();
    if (homeCity == null) return CrossRegionStatus.unknown;

    // ä»äº¤æ˜“ä¿¡æ¯æå–ä½ç½®ï¼ˆå•†æˆ·åœ°å€ã€æ¶ˆè´¹åœ°ç‚¹ï¼‰
    final txLocation = _extractLocationFromTransaction(tx);
    if (txLocation == null) return CrossRegionStatus.unknown;

    // åˆ¤æ–­æ˜¯å¦å¼‚åœ°
    if (txLocation.city == homeCity.city) {
      return CrossRegionStatus.local;
    }

    // åˆ¤æ–­å¼‚åœ°ç±»å‹
    if (txLocation.isOverseas) {
      return CrossRegionStatus.overseas;
    }

    if (txLocation.province != homeCity.province) {
      return CrossRegionStatus.crossProvince;
    }

    return CrossRegionStatus.crossCity;
  }

  /// ä¸ºå¼‚åœ°æ¶ˆè´¹æ¨èä¸´æ—¶é¢„ç®—ç±»ç›®
  List<TemporaryBudgetCategory> suggestTemporaryCategories(
    CrossRegionStatus status,
    CityLocation destination,
  ) {
    switch (status) {
      case CrossRegionStatus.crossProvince:
      case CrossRegionStatus.crossCity:
        return [
          TemporaryBudgetCategory(
            name: 'å‡ºå·®/æ—…æ¸¸é¤é¥®',
            icon: Icons.restaurant_menu,
            description: 'å¼‚åœ°é¤é¥®æ¶ˆè´¹',
            excludeFromDailyMoneyAge: true,  // ä¸è®¡å…¥æ—¥å¸¸é’±é¾„
          ),
          TemporaryBudgetCategory(
            name: 'ä½å®¿',
            icon: Icons.hotel,
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'äº¤é€šï¼ˆé•¿é€”ï¼‰',
            icon: Icons.flight,
            description: 'æœºç¥¨/ç«è½¦ç¥¨/é•¿é€”æ±½è½¦',
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'é—¨ç¥¨/æ™¯ç‚¹',
            icon: Icons.confirmation_number,
            excludeFromDailyMoneyAge: true,
          ),
        ];

      case CrossRegionStatus.overseas:
        return [
          ..._getDomesticTravelCategories(),
          TemporaryBudgetCategory(
            name: 'æ±‡ç‡å·®é¢',
            icon: Icons.currency_exchange,
            description: 'è·¨å¢ƒæ”¯ä»˜æ±‡ç‡æŸå¤±',
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'å°è´¹',
            icon: Icons.volunteer_activism,
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'é€€ç¨å•†å“',
            icon: Icons.shopping_bag,
            description: 'å¯é€€ç¨çš„è´­ç‰©',
            excludeFromDailyMoneyAge: true,
          ),
        ];

      default:
        return [];
    }
  }
}

/// å¼‚åœ°æ¶ˆè´¹çŠ¶æ€
enum CrossRegionStatus {
  local,          // æœ¬åœ°æ¶ˆè´¹
  crossCity,      // è·¨å¸‚æ¶ˆè´¹ï¼ˆçœå†…ï¼‰
  crossProvince,  // è·¨çœæ¶ˆè´¹
  overseas,       // æµ·å¤–æ¶ˆè´¹
  unknown,        // æ— æ³•åˆ¤æ–­
}
```

#### 11.3.2 é’±é¾„è®¡ç®—çš„ä½ç½®ä¼˜åŒ–

```dart
/// ä½ç½®æ„ŸçŸ¥çš„é’±é¾„è®¡ç®—æœåŠ¡
class LocationAwareMoneyAgeService {
  final CrossRegionSpendingService _crossRegionService;
  final MoneyAgeCalculator _baseCalculator;

  /// è®¡ç®—è€ƒè™‘ä½ç½®å› ç´ çš„é’±é¾„
  Future<EnhancedMoneyAge> calculateMoneyAge({
    required List<Transaction> transactions,
    required List<Income> incomes,
    bool separateTemporarySpending = true,
  }) async {
    // åˆ†ç¦»æ—¥å¸¸æ¶ˆè´¹å’Œä¸´æ—¶æ¶ˆè´¹
    final dailyTransactions = <Transaction>[];
    final temporaryTransactions = <Transaction>[];

    for (final tx in transactions) {
      final status = await _crossRegionService.detectCrossRegion(tx);

      if (status == CrossRegionStatus.local) {
        dailyTransactions.add(tx);
      } else if (separateTemporarySpending) {
        temporaryTransactions.add(tx);
      } else {
        dailyTransactions.add(tx);
      }
    }

    // è®¡ç®—æ—¥å¸¸é’±é¾„
    final dailyMoneyAge = _baseCalculator.calculate(
      dailyTransactions, incomes);

    // è®¡ç®—ä¸´æ—¶æ¶ˆè´¹é’±é¾„ï¼ˆå¦‚æœ‰ï¼‰
    MoneyAge? temporaryMoneyAge;
    if (temporaryTransactions.isNotEmpty) {
      temporaryMoneyAge = _baseCalculator.calculate(
        temporaryTransactions, incomes);
    }

    // è®¡ç®—ç»¼åˆé’±é¾„ï¼ˆåŠ æƒï¼‰
    final overallMoneyAge = _calculateWeightedMoneyAge(
      dailyMoneyAge: dailyMoneyAge,
      dailyWeight: 0.85,  // æ—¥å¸¸æ¶ˆè´¹æƒé‡85%
      temporaryMoneyAge: temporaryMoneyAge,
      temporaryWeight: 0.15,  // ä¸´æ—¶æ¶ˆè´¹æƒé‡15%
    );

    return EnhancedMoneyAge(
      overall: overallMoneyAge,
      daily: dailyMoneyAge,
      temporary: temporaryMoneyAge,
      dailyTransactionCount: dailyTransactions.length,
      temporaryTransactionCount: temporaryTransactions.length,
    );
  }

  /// è®¡ç®—åˆšéœ€æ”¯å‡ºå¯¹é’±é¾„çš„å½±å“æƒé‡
  double _calculateRigidSpendingWeight(Transaction tx, CityLocation location) {
    // åˆšéœ€æ”¯å‡ºï¼ˆæˆ¿ç§Ÿã€ç¤¾ä¿ç­‰ï¼‰æƒé‡é™ä½
    final rigidCategories = ['æˆ¿ç§Ÿ/æˆ¿è´·', 'ç¤¾ä¿', 'æ°´ç”µè´¹', 'ç‰©ä¸šè´¹', 'é€šè®¯è´¹'];

    if (rigidCategories.contains(tx.category)) {
      return 0.5;  // åˆšéœ€æƒé‡é™ä¸º0.5
    }

    return 1.0;  // å…¶ä»–æ¶ˆè´¹æƒé‡ä¸º1
  }
}

/// å¢å¼ºç‰ˆé’±é¾„ï¼ˆåŒºåˆ†æ—¥å¸¸/ä¸´æ—¶ï¼‰
class EnhancedMoneyAge {
  final MoneyAge overall;     // ç»¼åˆé’±é¾„
  final MoneyAge daily;       // æ—¥å¸¸æ¶ˆè´¹é’±é¾„
  final MoneyAge? temporary;  // ä¸´æ—¶æ¶ˆè´¹é’±é¾„ï¼ˆå‡ºå·®/æ—…æ¸¸ï¼‰
  final int dailyTransactionCount;
  final int temporaryTransactionCount;

  /// åˆ¤æ–­æ˜¯å¦æœ‰å¤§é‡ä¸´æ—¶æ¶ˆè´¹å½±å“é’±é¾„
  bool get hasTemporaryImpact =>
      temporary != null && temporaryTransactionCount > 5;

  /// è·å–é’±é¾„å¥åº·åº¦è¯„ä¼°
  MoneyAgeHealthAssessment getHealthAssessment() {
    // å¦‚æœæ—¥å¸¸é’±é¾„å¥åº·ä½†ç»¼åˆé’±é¾„è¾ƒä½ï¼Œè¯´æ˜æ˜¯ä¸´æ—¶æ¶ˆè´¹å½±å“
    if (daily.days >= 14 && overall.days < 14 && hasTemporaryImpact) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.temporarilyImpacted,
        message: 'æ—¥å¸¸èµ„é‡‘ç®¡ç†è‰¯å¥½ï¼Œè¿‘æœŸæœ‰å¤§é¢ä¸´æ—¶æ”¯å‡ºï¼Œé’±é¾„æš‚æ—¶ä¸‹é™å±æ­£å¸¸ç°è±¡',
        dailyStatus: _getStatusForDays(daily.days),
        suggestion: 'ä¸´æ—¶æ”¯å‡ºç»“æŸåï¼Œé’±é¾„ä¼šè‡ªç„¶æ¢å¤',
      );
    }

    return MoneyAgeHealthAssessment(
      status: _getStatusForDays(overall.days),
      message: overall.description,
    );
  }
}
```

#### 11.3.3 ç²¾ç¡®ä½ç½®å¢å¼ºé’±é¾„è®¡ç®—

åŸºäºGPSç²¾ç¡®ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´æ™ºèƒ½çš„é’±é¾„åˆ†æã€‚

**ä¸ LocationAwareMoneyAgeService çš„åŒºåˆ«**ï¼š
- `LocationAwareMoneyAgeService`ï¼šåŸå¸‚çº§åˆ«åˆ¤æ–­ï¼ŒåŒºåˆ†"æœ¬åœ°æ¶ˆè´¹"ä¸"å¼‚åœ°æ¶ˆè´¹"
- `SpendingContextAnalyzer`ï¼šè¡—é“çº§åˆ«åˆ†æï¼Œè¯†åˆ«"å®¶é™„è¿‘"ã€"å…¬å¸é™„è¿‘"ã€"é€šå‹¤è·¯ä¸Š"ç­‰ç²¾ç»†åœºæ™¯

ä¸¤è€…æ˜¯äº’è¡¥å…³ç³»ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨ï¼š
1. å…ˆç”¨ `LocationAwareMoneyAgeService` æ’é™¤å¼‚åœ°æ¶ˆè´¹
2. å†ç”¨ `SpendingContextAnalyzer` åˆ†ææœ¬åœ°æ¶ˆè´¹çš„å…·ä½“åœºæ™¯

```dart
/// æ¶ˆè´¹åœºæ™¯åˆ†ææœåŠ¡ï¼ˆç²¾ç¡®ä½ç½®çº§åˆ«ï¼‰
/// èŒè´£ï¼šåˆ†ææ¶ˆè´¹çš„åœ°ç†åœºæ™¯ï¼Œä¸ºé’±é¾„è®¡ç®—æä¾›ä½ç½®ç»´åº¦çš„æ•°æ®å¢å¼º
/// å‚è§ 11.0.1 ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„
class SpendingContextAnalyzer {
  final PreciseLocationService _locationService;
  final UserHomeLocationService _homeService;
  final MoneyAgeCalculator _baseCalculator;  // ç”¨äºåˆ†åœºæ™¯é’±é¾„è®¡ç®—

  /// ç”¨æˆ·å¸¸é©»åœ°ç‚¹ï¼ˆå®¶ã€å…¬å¸ï¼‰
  PreciseLocation? _homeLocation;
  PreciseLocation? _workLocation;

  /// åˆå§‹åŒ–ç”¨æˆ·å¸¸é©»åœ°ç‚¹
  Future<void> initializeHomeLocations() async {
    _homeLocation = await _homeService.getHomeLocation();
    _workLocation = await _homeService.getWorkLocation();
  }

  /// åŸºäºç²¾ç¡®ä½ç½®çš„æ¶ˆè´¹åœºæ™¯åˆ†æ
  Future<SpendingContextAnalysis> analyzeSpendingContext(
    Transaction tx,
    PreciseLocation txLocation,
  ) async {
    // 1. è®¡ç®—ä¸å®¶çš„è·ç¦»
    double? distanceFromHome;
    if (_homeLocation != null) {
      distanceFromHome = txLocation.distanceTo(_homeLocation!);
    }

    // 2. è®¡ç®—ä¸å…¬å¸çš„è·ç¦»
    double? distanceFromWork;
    if (_workLocation != null) {
      distanceFromWork = txLocation.distanceTo(_workLocation!);
    }

    // 3. ç¡®å®šæ¶ˆè´¹åœºæ™¯
    final context = _determineSpendingContext(
      tx: tx,
      location: txLocation,
      distanceFromHome: distanceFromHome,
      distanceFromWork: distanceFromWork,
    );

    return SpendingContextAnalysis(
      transaction: tx,
      location: txLocation,
      context: context,
      distanceFromHome: distanceFromHome,
      distanceFromWork: distanceFromWork,
      isCommute: _isCommuteSpending(txLocation, tx.time),
      isBusinessTrip: await _detectBusinessTrip(txLocation, tx),
      isVacation: await _detectVacation(txLocation, tx),
    );
  }

  /// ç¡®å®šæ¶ˆè´¹åœºæ™¯
  SpendingContext _determineSpendingContext({
    required Transaction tx,
    required PreciseLocation location,
    double? distanceFromHome,
    double? distanceFromWork,
  }) {
    // å®¶é™„è¿‘æ¶ˆè´¹ï¼ˆ500ç±³èŒƒå›´å†…ï¼‰
    if (distanceFromHome != null && distanceFromHome < 500) {
      return SpendingContext.nearHome;
    }

    // å…¬å¸é™„è¿‘æ¶ˆè´¹ï¼ˆ300ç±³èŒƒå›´å†…ï¼‰
    if (distanceFromWork != null && distanceFromWork < 300) {
      return SpendingContext.nearWork;
    }

    // é€šå‹¤è·¯ä¸Šæ¶ˆè´¹
    if (_isOnCommutePath(location)) {
      return SpendingContext.commuting;
    }

    // å•†åœˆæ¶ˆè´¹
    if (location.areaType == AreaType.commercial) {
      return SpendingContext.commercial;
    }

    // è¿œè·ç¦»æ¶ˆè´¹ï¼ˆè¶…è¿‡50å…¬é‡Œï¼‰
    if (distanceFromHome != null && distanceFromHome > 50000) {
      return SpendingContext.travel;
    }

    return SpendingContext.other;
  }

  /// æ£€æµ‹æ˜¯å¦ä¸ºé€šå‹¤æ¶ˆè´¹
  bool _isCommuteSpending(PreciseLocation location, DateTime time) {
    // å·¥ä½œæ—¥æ—©æ™šé«˜å³°æ—¶æ®µ
    final weekday = time.weekday;
    final hour = time.hour;

    if (weekday >= 6) return false; // å‘¨æœ«éé€šå‹¤

    final isMorningRush = hour >= 7 && hour <= 9;
    final isEveningRush = hour >= 17 && hour <= 20;

    if (!isMorningRush && !isEveningRush) return false;

    // åœ¨é€šå‹¤è·¯å¾„ä¸Š
    return _isOnCommutePath(location);
  }

  /// æ£€æµ‹æ˜¯å¦åœ¨é€šå‹¤è·¯å¾„ä¸Š
  bool _isOnCommutePath(PreciseLocation location) {
    if (_homeLocation == null || _workLocation == null) return false;

    // è®¡ç®—ç‚¹åˆ°å®¶-å…¬å¸è¿çº¿çš„è·ç¦»
    final distToHome = location.distanceTo(_homeLocation!);
    final distToWork = location.distanceTo(_workLocation!);
    final homeToWork = _homeLocation!.distanceTo(_workLocation!);

    // å¦‚æœå½“å‰ä½ç½®åˆ°å®¶å’Œå…¬å¸çš„è·ç¦»ä¹‹å’Œæ¥è¿‘å®¶åˆ°å…¬å¸çš„è·ç¦»
    // è¯´æ˜åœ¨é€šå‹¤è·¯å¾„ä¸Šï¼ˆå…è®¸2å…¬é‡Œè¯¯å·®ï¼‰
    return (distToHome + distToWork - homeToWork).abs() < 2000;
  }

  /// æ£€æµ‹å‡ºå·®æ¶ˆè´¹
  Future<bool> _detectBusinessTrip(PreciseLocation location, Transaction tx) async {
    // å·¥ä½œæ—¥åœ¨å¼‚åœ°
    if (tx.time.weekday >= 6) return false;

    // è·ç¦»å®¶è¶…è¿‡100å…¬é‡Œ
    if (_homeLocation == null) return false;
    final distance = location.distanceTo(_homeLocation!);
    if (distance < 100000) return false;

    // æ¶ˆè´¹ç±»å‹ä¸ºå•†åŠ¡ç›¸å…³
    final businessCategories = ['äº¤é€š', 'ä½å®¿', 'é¤é¥®', 'é€šè®¯'];
    if (!businessCategories.contains(tx.category)) return false;

    // POIä¸ºå•†åŠ¡åŒºåŸŸ
    if (location.areaType == AreaType.office) return true;

    return true;
  }

  /// æ£€æµ‹æ—…æ¸¸æ¶ˆè´¹
  Future<bool> _detectVacation(PreciseLocation location, Transaction tx) async {
    // å‘¨æœ«æˆ–èŠ‚å‡æ—¥
    final isWeekend = tx.time.weekday >= 6;

    // è·ç¦»å®¶è¶…è¿‡30å…¬é‡Œ
    if (_homeLocation == null) return false;
    final distance = location.distanceTo(_homeLocation!);
    if (distance < 30000) return false;

    // æ¶ˆè´¹ç±»å‹ä¸ºæ—…æ¸¸ç›¸å…³
    final vacationCategories = ['äº¤é€š', 'ä½å®¿', 'é¤é¥®', 'å¨±ä¹', 'é—¨ç¥¨', 'è´­ç‰©'];
    if (!vacationCategories.contains(tx.category)) return false;

    // POIä¸ºæ—…æ¸¸/å¨±ä¹åŒºåŸŸ
    if (location.nearbyPOI?.category == POICategory.entertainment) return true;

    // å‘¨æœ«å¼‚åœ°æ¶ˆè´¹å¤§æ¦‚ç‡æ˜¯æ—…æ¸¸
    if (isWeekend && distance > 50000) return true;

    return false;
  }

  /// è®¡ç®—ç²¾ç¡®ä½ç½®å¢å¼ºçš„é’±é¾„
  Future<PreciseMoneyAge> calculatePreciseMoneyAge({
    required List<Transaction> transactions,
    required List<Income> incomes,
  }) async {
    // æŒ‰æ¶ˆè´¹åœºæ™¯åˆ†ç±»äº¤æ˜“
    final contextMap = <SpendingContext, List<Transaction>>{};
    final analysisResults = <SpendingContextAnalysis>[];

    for (final tx in transactions) {
      if (tx.location == null) {
        // æ— ä½ç½®ä¿¡æ¯çš„äº¤æ˜“å½’å…¥æ—¥å¸¸
        contextMap.putIfAbsent(SpendingContext.other, () => []).add(tx);
        continue;
      }

      final analysis = await analyzeSpendingContext(tx, tx.location!);
      analysisResults.add(analysis);
      contextMap.putIfAbsent(analysis.context, () => []).add(tx);
    }

    // åˆ†åœºæ™¯è®¡ç®—é’±é¾„
    final contextMoneyAges = <SpendingContext, MoneyAge>{};
    for (final entry in contextMap.entries) {
      contextMoneyAges[entry.key] = _baseCalculator.calculate(entry.value, incomes);
    }

    // è®¡ç®—æ—¥å¸¸æ¶ˆè´¹é’±é¾„ï¼ˆæ’é™¤å‡ºå·®å’Œæ—…æ¸¸ï¼‰
    final dailyTransactions = transactions.where((tx) {
      final analysis = analysisResults.firstWhere(
        (a) => a.transaction == tx,
        orElse: () => SpendingContextAnalysis.empty(tx),
      );
      return !analysis.isBusinessTrip && !analysis.isVacation;
    }).toList();

    final dailyMoneyAge = _baseCalculator.calculate(dailyTransactions, incomes);

    // è®¡ç®—ç»¼åˆé’±é¾„ï¼ˆåŠ æƒï¼‰
    final overallMoneyAge = _calculateWeightedMoneyAge(
      contextMoneyAges: contextMoneyAges,
      weights: {
        SpendingContext.nearHome: 1.0,      // å®¶é™„è¿‘æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.nearWork: 1.0,      // å…¬å¸é™„è¿‘æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.commuting: 1.0,     // é€šå‹¤æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.commercial: 0.9,    // å•†åœˆæ¶ˆè´¹ç•¥é™æƒé‡
        SpendingContext.travel: 0.3,        // æ—…æ¸¸æ¶ˆè´¹ä½æƒé‡
        SpendingContext.other: 0.8,         // å…¶ä»–æ¶ˆè´¹ä¸­ç­‰æƒé‡
      },
    );

    return PreciseMoneyAge(
      overall: overallMoneyAge,
      daily: dailyMoneyAge,
      byContext: contextMoneyAges,
      analysisResults: analysisResults,
      insights: _generateLocationInsights(analysisResults),
    );
  }

  /// ç”Ÿæˆä½ç½®ç›¸å…³æ´å¯Ÿ
  List<LocationInsight> _generateLocationInsights(
    List<SpendingContextAnalysis> analyses,
  ) {
    final insights = <LocationInsight>[];

    // ç»Ÿè®¡å„åœºæ™¯æ¶ˆè´¹
    final contextStats = <SpendingContext, double>{};
    for (final a in analyses) {
      contextStats.update(
        a.context,
        (v) => v + a.transaction.amount,
        ifAbsent: () => a.transaction.amount,
      );
    }

    // å•†åœˆæ¶ˆè´¹å æ¯”åˆ†æ
    final totalSpending = contextStats.values.fold(0.0, (a, b) => a + b);
    final commercialSpending = contextStats[SpendingContext.commercial] ?? 0;
    if (commercialSpending / totalSpending > 0.4) {
      insights.add(LocationInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹å æ¯”è¾ƒé«˜',
        description: 'å•†åœˆæ¶ˆè´¹å æ€»æ”¯å‡ºçš„${(commercialSpending / totalSpending * 100).toStringAsFixed(0)}%ï¼Œ'
            'å»ºè®®æ§åˆ¶å†²åŠ¨æ¶ˆè´¹',
        suggestion: 'è®¾ç½®å•†åœˆæ¶ˆè´¹é¢„è­¦ï¼Œè¿›å…¥å•†åœˆæ—¶æé†’å½“æœˆé¢„ç®—',
        impact: commercialSpending * 0.2, // å‡è®¾å¯èŠ‚çœ20%
      ));
    }

    // é€šå‹¤æ¶ˆè´¹åˆ†æ
    final commuteSpending = contextStats[SpendingContext.commuting] ?? 0;
    if (commuteSpending > 500) {
      insights.add(LocationInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤è·¯ä¸Šæ¶ˆè´¹è¾ƒå¤š',
        description: 'æœ¬æœˆé€šå‹¤æ¶ˆè´¹Â¥${commuteSpending.toStringAsFixed(0)}ï¼Œ'
            'ä¸»è¦å‘ç”Ÿåœ¨æ—©æ™šé«˜å³°',
        suggestion: 'æå‰å‡†å¤‡æ—©é¤ã€è§„åˆ’å›ºå®šè·¯çº¿å¯å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
        impact: commuteSpending * 0.3,
      ));
    }

    // æ—…æ¸¸æ¶ˆè´¹å¯¹é’±é¾„çš„å½±å“
    final travelAnalyses = analyses.where((a) => a.isVacation).toList();
    if (travelAnalyses.length > 3) {
      final travelSpending = travelAnalyses.fold(0.0, (s, a) => s + a.transaction.amount);
      insights.add(LocationInsight(
        type: InsightType.info,
        title: 'æ—…æ¸¸æ¶ˆè´¹å·²å•ç‹¬è®¡ç®—',
        description: 'æœ¬æœˆ${travelAnalyses.length}ç¬”æ—…æ¸¸æ¶ˆè´¹å…±Â¥${travelSpending.toStringAsFixed(0)}ï¼Œ'
            'å·²ä»æ—¥å¸¸é’±é¾„è®¡ç®—ä¸­åˆ†ç¦»',
        suggestion: 'æ—¥å¸¸é’±é¾„ä¸å—æ—…æ¸¸æ¶ˆè´¹å½±å“ï¼Œå¯æ”¾å¿ƒå‡ºè¡Œ',
        impact: 0,
      ));
    }

    return insights;
  }
}

/// æ¶ˆè´¹åœºæ™¯
enum SpendingContext {
  nearHome,    // å®¶é™„è¿‘
  nearWork,    // å…¬å¸é™„è¿‘
  commuting,   // é€šå‹¤è·¯ä¸Š
  commercial,  // å•†åœˆ
  travel,      // æ—…è¡Œ/å‡ºå·®
  other,       // å…¶ä»–
}

/// æ¶ˆè´¹åœºæ™¯åˆ†æç»“æœ
class SpendingContextAnalysis {
  final Transaction transaction;
  final PreciseLocation? location;
  final SpendingContext context;
  final double? distanceFromHome;
  final double? distanceFromWork;
  final bool isCommute;
  final bool isBusinessTrip;
  final bool isVacation;

  static SpendingContextAnalysis empty(Transaction tx) {
    return SpendingContextAnalysis(
      transaction: tx,
      location: null,
      context: SpendingContext.other,
      isCommute: false,
      isBusinessTrip: false,
      isVacation: false,
    );
  }
}

/// ç²¾ç¡®ä½ç½®é’±é¾„
class PreciseMoneyAge {
  final MoneyAge overall;                           // ç»¼åˆé’±é¾„
  final MoneyAge daily;                             // æ—¥å¸¸æ¶ˆè´¹é’±é¾„
  final Map<SpendingContext, MoneyAge> byContext;  // åˆ†åœºæ™¯é’±é¾„
  final List<SpendingContextAnalysis> analysisResults;
  final List<LocationInsight> insights;

  /// è·å–é’±é¾„å¥åº·è¯„ä¼°
  MoneyAgeHealthAssessment getHealthAssessment() {
    // ä½¿ç”¨æ—¥å¸¸é’±é¾„è¿›è¡Œè¯„ä¼°ï¼ˆæ’é™¤æ—…æ¸¸/å‡ºå·®å½±å“ï¼‰
    final days = daily.days;

    if (days >= 30) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.excellent,
        message: 'èµ„é‡‘å‚¨å¤‡å……è¶³ï¼Œæ—¥å¸¸æ¶ˆè´¹è§„åˆ’åˆç†',
        dailyStatus: HealthStatus.excellent,
      );
    } else if (days >= 14) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.good,
        message: 'èµ„é‡‘çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒ',
        dailyStatus: HealthStatus.good,
      );
    } else if (days >= 7) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.warning,
        message: 'èµ„é‡‘å‚¨å¤‡ç•¥ç´§ï¼Œå»ºè®®å‡å°‘éå¿…è¦æ”¯å‡º',
        dailyStatus: HealthStatus.warning,
        suggestion: 'å…³æ³¨æœ¬æœˆå•†åœˆæ¶ˆè´¹å’Œé€šå‹¤æ¶ˆè´¹',
      );
    } else {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.critical,
        message: 'èµ„é‡‘å‚¨å¤‡ä¸è¶³ï¼Œè¯·æ§åˆ¶æ”¯å‡º',
        dailyStatus: HealthStatus.critical,
        suggestion: 'æš‚åœå•†åœˆæ¶ˆè´¹ï¼Œå‡å°‘å¤–å‡ºå°±é¤',
      );
    }
  }
}

/// ä½ç½®æ´å¯Ÿ
class LocationInsight {
  final InsightType type;
  final String title;
  final String description;
  final String suggestion;
  final double impact;  // æ½œåœ¨èŠ‚çœé‡‘é¢
}

enum InsightType { info, tip, warning, critical }
```

### 11.4 æœ¬åœ°åŒ–çœé’±å»ºè®®

#### 11.4.1 åŸºäºä½ç½®çš„æ¶ˆè´¹ä¼˜åŒ–

```dart
/// æœ¬åœ°åŒ–çœé’±å»ºè®®æœåŠ¡
class LocalizedSavingTipsService {
  final PreciseLocationService _locationService;
  final TransactionRepository _txRepo;

  /// ç”Ÿæˆæœ¬åœ°åŒ–çœé’±å»ºè®®
  Future<List<LocalizedSavingTip>> generateTips() async {
    final location = await _locationService.getCurrentCity();
    if (location == null) return [];

    final recentTx = await _txRepo.getRecent(months: 3);
    final tips = <LocalizedSavingTip>[];

    // åˆ†æé€šå‹¤æ¶ˆè´¹
    tips.addAll(await _analyzeCommutingCost(recentTx, location));

    // åˆ†æé¤é¥®æ¶ˆè´¹
    tips.addAll(await _analyzeDiningCost(recentTx, location));

    // åˆ†æè´­ç‰©æ¶ˆè´¹
    tips.addAll(await _analyzeShoppingCost(recentTx, location));

    // åˆ†ææœ¬åœ°ä¼˜æƒ 
    tips.addAll(await _findLocalDiscounts(location));

    // æŒ‰èŠ‚çœé‡‘é¢æ’åº
    tips.sort((a, b) => b.monthlySaving.compareTo(a.monthlySaving));

    return tips;
  }

  /// åˆ†æé€šå‹¤æˆæœ¬å¹¶æä¾›æœ¬åœ°åŒ–å»ºè®®
  Future<List<LocalizedSavingTip>> _analyzeCommutingCost(
    List<Transaction> transactions,
    CityLocation location,
  ) async {
    final tips = <LocalizedSavingTip>[];

    // åˆ†æç½‘çº¦è½¦ä½¿ç”¨æƒ…å†µ
    final rideshareSpending = transactions
        .where((tx) => tx.category == 'ç½‘çº¦è½¦' || tx.description.contains('æ»´æ»´'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    if (rideshareSpending > 500) {
      // ä¸€çº¿åŸå¸‚æ¨èåœ°é“
      if (location.tier == CityTier.tier1 || location.tier == CityTier.newTier1) {
        tips.add(LocalizedSavingTip(
          title: 'é€šå‹¤ä¼˜åŒ–ï¼šåœ°é“æ›¿ä»£ç½‘çº¦è½¦',
          description: '${location.city}åœ°é“è¦†ç›–ç‡é«˜ï¼Œå·¥ä½œæ—¥é€šå‹¤æ”¹ç”¨åœ°é“æ›´ç»æµ',
          currentMonthlySpending: rideshareSpending,
          suggestedSpending: rideshareSpending * 0.3,
          monthlySaving: rideshareSpending * 0.7,
          moneyAgeImpact: (rideshareSpending * 0.7 / 600).round(), // å‡è®¾æ—¥å‡æ”¯å‡º600
          actionText: 'æŸ¥çœ‹${location.city}åœ°é“çº¿è·¯',
          localContext: '${location.city}åœ°é“æ—¥ç¥¨çº¦Â¥18ï¼Œè¿œä½äºå•æ¬¡ç½‘çº¦è½¦',
        ));
      }

      // ä¸‰å››çº¿åŸå¸‚æ¨èç”µåŠ¨è½¦
      if (location.tier == CityTier.tier3) {
        tips.add(LocalizedSavingTip(
          title: 'é€šå‹¤ä¼˜åŒ–ï¼šç”µåŠ¨è½¦å‡ºè¡Œ',
          description: '${location.city}å‡ºè¡Œè·ç¦»é€‚ä¸­ï¼Œç”µåŠ¨è½¦æ›´ç»æµç¯ä¿',
          currentMonthlySpending: rideshareSpending,
          suggestedSpending: 100, // ç”µåŠ¨è½¦æœˆå……ç”µè´¹
          monthlySaving: rideshareSpending - 100,
          moneyAgeImpact: ((rideshareSpending - 100) / 400).round(),
          actionText: 'äº†è§£æœ¬åœ°ç”µåŠ¨è½¦æ”¿ç­–',
        ));
      }
    }

    return tips;
  }

  /// åˆ†æé¤é¥®æˆæœ¬
  Future<List<LocalizedSavingTip>> _analyzeDiningCost(
    List<Transaction> transactions,
    CityLocation location,
  ) async {
    final tips = <LocalizedSavingTip>[];

    // åˆ†æå¤–å–æ¶ˆè´¹
    final deliverySpending = transactions
        .where((tx) => tx.description.contains('å¤–å–') ||
                       tx.description.contains('ç¾å›¢') ||
                       tx.description.contains('é¥¿äº†ä¹ˆ'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    // åˆ†æå¤–å–é…é€è´¹
    final deliveryFees = transactions
        .where((tx) => tx.description.contains('é…é€è´¹'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    if (deliveryFees > 100) {
      tips.add(LocalizedSavingTip(
        title: 'å¤–å–è‡ªå–çœé…é€è´¹',
        description: 'é™„è¿‘å•†å®¶è‡ªå–å¯çœé…é€è´¹',
        currentMonthlySpending: deliveryFees,
        suggestedSpending: 0,
        monthlySaving: deliveryFees,
        moneyAgeImpact: (deliveryFees / 600).round(),
        actionText: 'æŸ¥çœ‹é™„è¿‘è‡ªå–ä¼˜æƒ ',
        localContext: '${location.city}å¤–å–å‡ä»·çº¦Â¥30ï¼Œè‡ªå–é€šå¸¸è¿˜æœ‰æŠ˜æ‰£',
      ));
    }

    // ä¸€çº¿åŸå¸‚æ¨èå…¬å¸é£Ÿå ‚
    if (location.tier == CityTier.tier1 && deliverySpending > 1500) {
      tips.add(LocalizedSavingTip(
        title: 'åˆé¤é€‰æ‹©å…¬å¸é£Ÿå ‚/å‘¨è¾¹é£Ÿå ‚',
        description: 'å·¥ä½œæ—¥åˆé¤é€‰æ‹©é£Ÿå ‚ï¼Œæ¯”å¤–å–æ›´ç»æµå¥åº·',
        currentMonthlySpending: deliverySpending * 0.6, // å‡è®¾60%æ˜¯åˆé¤
        suggestedSpending: deliverySpending * 0.3,
        monthlySaving: deliverySpending * 0.3,
        moneyAgeImpact: (deliverySpending * 0.3 / 600).round(),
        actionText: 'æŸ¥çœ‹é™„è¿‘é£Ÿå ‚',
        localContext: '${location.city}å†™å­—æ¥¼é£Ÿå ‚å‡ä»·çº¦Â¥15-25ï¼Œå¤–å–å‡ä»·çº¦Â¥35-50',
      ));
    }

    return tips;
  }

  /// å‘ç°æœ¬åœ°ä¼˜æƒ æ´»åŠ¨
  Future<List<LocalizedSavingTip>> _findLocalDiscounts(
    CityLocation location,
  ) async {
    // TODO: æ¥å…¥æœ¬åœ°ä¼˜æƒ ä¿¡æ¯API
    // è¿™é‡Œæ¨¡æ‹Ÿä¸€äº›å¸¸è§çš„æœ¬åœ°ä¼˜æƒ 

    return [
      LocalizedSavingTip(
        title: '${location.city}ç”Ÿæ´»æ¶ˆè´¹åˆ¸',
        description: 'å…³æ³¨${location.city}æ¶ˆè´¹åˆ¸å‘æ”¾æ´»åŠ¨',
        monthlySaving: 200, // é¢„ä¼°
        moneyAgeImpact: 0,
        actionText: 'äº†è§£æ´»åŠ¨è¯¦æƒ…',
        localContext: 'æ”¿åºœæ¶ˆè´¹åˆ¸é€šå¸¸åœ¨èŠ‚å‡æ—¥å‘æ”¾',
        isPromotion: true,
      ),
    ];
  }
}

/// æœ¬åœ°åŒ–çœé’±å»ºè®®
class LocalizedSavingTip {
  final String title;
  final String description;
  final double currentMonthlySpending;
  final double suggestedSpending;
  final double monthlySaving;
  final int moneyAgeImpact;  // é¢„è®¡é’±é¾„æå‡å¤©æ•°
  final String? actionText;
  final String? localContext;
  final bool isPromotion;
}
```

#### 11.4.2 çœé’±å»ºè®®ä¸é’±é¾„å…³è”å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ æœ¬åœ°åŒ–çœé’±å»ºè®®ï¼ˆåŸºäº${city}æ¶ˆè´¹æ°´å¹³ï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸš‡ é€šå‹¤ä¼˜åŒ–ï¼šåœ°é“æ›¿ä»£ç½‘çº¦è½¦                                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰ç½‘çº¦è½¦æ¶ˆè´¹: Â¥680/æœˆ                                     â”‚   â”‚
â”‚  â”‚  å»ºè®®æ”¹ç”¨åœ°é“: Â¥200/æœˆ                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥480    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.8å¤©          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ ä¸Šæµ·åœ°é“æ—¥ç¥¨Â¥18ï¼Œè¦†ç›–ä¸»è¦å•†åœˆ                           â”‚   â”‚
â”‚  â”‚                                              [æŸ¥çœ‹åœ°é“çº¿è·¯]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ± åˆé¤ä¼˜åŒ–ï¼šå…¬å¸é£Ÿå ‚æ›¿ä»£å¤–å–                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰å·¥ä½œæ—¥åˆé¤: Â¥45/å¤© Ã— 22å¤© = Â¥990/æœˆ                    â”‚   â”‚
â”‚  â”‚  å»ºè®®é£Ÿå ‚å°±é¤: Â¥20/å¤© Ã— 22å¤© = Â¥440/æœˆ                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥550    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.9å¤©          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ ä¸Šæµ·å†™å­—æ¥¼é£Ÿå ‚å‡ä»·Â¥15-25ï¼Œæ¯”å¤–å–èŠ‚çœ40%+                â”‚   â”‚
â”‚  â”‚                                              [æŸ¥çœ‹é™„è¿‘é£Ÿå ‚]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ·ï¸ å¤–å–è‡ªå–çœé…é€è´¹                                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰æœˆé…é€è´¹æ”¯å‡º: Â¥150                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥150    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.25å¤©         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ è‡ªå–é€šå¸¸è¿˜æœ‰é¢å¤–5-10%æŠ˜æ‰£                                â”‚   â”‚
â”‚  â”‚                                           [æŸ¥çœ‹è‡ªå–ä¼˜æƒ å•†å®¶]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚   ğŸ“Š ç»¼åˆæ‰§è¡Œé¢„è®¡ï¼šæ¯æœˆèŠ‚çœ Â¥1,180  â”‚  é’±é¾„æå‡çº¦ 2å¤©/æœˆ         â”‚
â”‚                                                                     â”‚
â”‚                                           [å¼€å§‹æ‰§è¡Œçœé’±è®¡åˆ’ â†’]     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.5 è·¨åŒºåŸŸè´¢åŠ¡é£é™©æç¤º

#### 11.5.1 å¼‚åœ°/æµ·å¤–æ¶ˆè´¹é£é™©é¢„è­¦

```dart
/// è·¨åŒºåŸŸè´¢åŠ¡é£é™©æç¤ºæœåŠ¡
class CrossRegionRiskAlertService {
  /// åœ¨è®°è´¦æ—¶æ£€æµ‹å¹¶æç¤ºé£é™©
  Future<List<RiskAlert>> checkRisks(
    Transaction tx,
    CityLocation currentLocation,
    CityLocation homeLocation,
  ) async {
    final alerts = <RiskAlert>[];

    // æ£€æµ‹æµ·å¤–æ¶ˆè´¹
    if (currentLocation.isOverseas) {
      alerts.addAll(_checkOverseasRisks(tx, currentLocation));
    }

    // æ£€æµ‹è·¨åŸæ¶ˆè´¹
    if (currentLocation.city != homeLocation.city) {
      alerts.addAll(_checkCrossCityRisks(tx, currentLocation));
    }

    return alerts;
  }

  /// æµ·å¤–æ¶ˆè´¹é£é™©æ£€æµ‹
  List<RiskAlert> _checkOverseasRisks(Transaction tx, CityLocation location) {
    final alerts = <RiskAlert>[];

    // æ±‡ç‡é£é™©
    alerts.add(RiskAlert(
      type: RiskType.exchangeRate,
      title: 'æ±‡ç‡æé†’',
      description: 'è·¨å¢ƒæ”¯ä»˜å¯èƒ½äº§ç”Ÿ1-3%çš„æ±‡ç‡å·®',
      suggestion: 'å»ºè®®é¢„ç•™æ±‡ç‡æŸå¤±é¢„ç®—ï¼Œçº¦æ¶ˆè´¹é¢çš„2%',
      impact: tx.amount * 0.02,
    ));

    // å°è´¹æé†’ï¼ˆç¾å›½ç­‰å›½å®¶ï¼‰
    final tipCountries = ['US', 'CA', 'GB'];
    if (tipCountries.contains(location.countryCode)) {
      alerts.add(RiskAlert(
        type: RiskType.tip,
        title: 'å°è´¹æé†’',
        description: '${location.country}é¤é¥®æœåŠ¡é€šå¸¸éœ€è¦15-20%å°è´¹',
        suggestion: 'åœ¨é¤é¥®é¢„ç®—ä¸­é¢„ç•™å°è´¹',
        impact: tx.amount * 0.18,
      ));
    }

    // è·¨å¢ƒæ‰‹ç»­è´¹
    alerts.add(RiskAlert(
      type: RiskType.fee,
      title: 'è·¨å¢ƒæ‰‹ç»­è´¹',
      description: 'éƒ¨åˆ†é“¶è¡Œå¡è·¨å¢ƒæ¶ˆè´¹æ”¶å–1-2%æ‰‹ç»­è´¹',
      suggestion: 'æ¨èä½¿ç”¨å…æ‰‹ç»­è´¹çš„å…¨å¸ç§ä¿¡ç”¨å¡',
      impact: tx.amount * 0.015,
    ));

    return alerts;
  }

  /// è·¨åŸæ¶ˆè´¹é£é™©æ£€æµ‹
  List<RiskAlert> _checkCrossCityRisks(Transaction tx, CityLocation location) {
    final alerts = <RiskAlert>[];

    // é¢„ç®—å½’å±æé†’
    alerts.add(RiskAlert(
      type: RiskType.budgetAllocation,
      title: 'å¼‚åœ°æ¶ˆè´¹å½’ç±»',
      description: 'æ£€æµ‹åˆ°æ‚¨åœ¨${location.city}æ¶ˆè´¹',
      suggestion: 'å»ºè®®å½’å…¥"å‡ºå·®/æ—…æ¸¸"ä¸´æ—¶é¢„ç®—ï¼Œé¿å…å½±å“æ—¥å¸¸é¢„ç®—',
      actionLabel: 'ä½¿ç”¨ä¸´æ—¶é¢„ç®—',
    ));

    return alerts;
  }
}

/// é£é™©æç¤ºå¼¹çª—ç»„ä»¶
class RiskAlertDialog extends StatelessWidget {
  final List<RiskAlert> alerts;
  final Transaction transaction;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(Icons.info_outline, color: Colors.orange),
          SizedBox(width: 8),
          Text('æ¶ˆè´¹æé†’'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // äº¤æ˜“ä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(transaction.description),
                Text('Â¥${transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(fontWeight: FontWeight.bold)),
              ],
            ),
          ),
          SizedBox(height: 16),

          // é£é™©æç¤ºåˆ—è¡¨
          ...alerts.map((alert) => _buildAlertItem(alert)),

          // é¢„ä¼°é¢å¤–æˆæœ¬
          if (alerts.any((a) => a.impact > 0)) ...[
            Divider(),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text('é¢„ä¼°é¢å¤–æˆæœ¬:'),
                Text('Â¥${_totalImpact.toStringAsFixed(2)}',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: Colors.orange,
                  )),
              ],
            ),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('çŸ¥é“äº†'),
        ),
        ElevatedButton(
          onPressed: () => _applyTemporaryBudget(context),
          child: Text('ä½¿ç”¨ä¸´æ—¶é¢„ç®—'),
        ),
      ],
    );
  }

  double get _totalImpact =>
      alerts.fold(0.0, (sum, a) => sum + a.impact);
}
```

### 11.6 ä½ç½®æƒé™è®¾ç½®ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  ä½ç½®æœåŠ¡è®¾ç½®                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ ç²¾ç¡®ä½ç½®æœåŠ¡                                   [å¼€å¯] âœ“  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å¼€å¯åå¯è·å¾—ï¼š                                              â”‚   â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½æ¶ˆè´¹åœºæ™¯è¯†åˆ«ï¼ˆå®¶/å…¬å¸/å•†åœˆ/æ—…è¡Œï¼‰                     â”‚   â”‚
â”‚  â”‚  â€¢ ç²¾ç¡®ä½ç½®é’±é¾„åˆ†æï¼ˆåŒºåˆ†æ—¥å¸¸/å‡ºå·®/æ—…æ¸¸ï¼‰                    â”‚   â”‚
â”‚  â”‚  â€¢ åœ°ç†å›´æ é¢„ç®—æé†’ï¼ˆè¿›å…¥å•†åœˆè‡ªåŠ¨æé†’ï¼‰                      â”‚   â”‚
â”‚  â”‚  â€¢ POIå•†æˆ·è‡ªåŠ¨åŒ¹é…ï¼ˆç²¾å‡†åˆ†ç±»æ¶ˆè´¹ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ é€šå‹¤æ¶ˆè´¹è¿½è¸ªä¸ä¼˜åŒ–å»ºè®®                                    â”‚   â”‚
â”‚  â”‚  â€¢ æœ¬åœ°åŒ–çœé’±æ¨èï¼ˆåŸºäºç²¾ç¡®ä½ç½®ï¼‰                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ  å¸¸é©»åœ°ç‚¹è®¾ç½®                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å®¶åº­ä½ç½®: ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºxxxè·¯         [è‡ªåŠ¨æ£€æµ‹] [æ‰‹åŠ¨è®¾ç½®]  â”‚   â”‚
â”‚  â”‚  å…¬å¸ä½ç½®: ä¸Šæµ·å¸‚é»„æµ¦åŒºxxxå¹¿åœº         [è‡ªåŠ¨æ£€æµ‹] [æ‰‹åŠ¨è®¾ç½®]  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è®¾ç½®åå¯æ™ºèƒ½è¯†åˆ«é€šå‹¤æ¶ˆè´¹ã€å®¶é™„è¿‘æ¶ˆè´¹ç­‰åœºæ™¯              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¯ åœ°ç†å›´æ é¢„ç®—æé†’                              [å¼€å¯] âœ“   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  å•†åœˆæé†’                                   [å¼€å¯]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  è¿›å…¥å•†åœˆæ—¶æé†’å½“æœˆè´­ç‰©é¢„ç®—                          â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  é¤é¥®åŒºæé†’                                 [å¼€å¯]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  åœ¨é¤é¥®é›†ä¸­åŒºåŸŸæé†’é¤é¥®é¢„ç®—                          â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  è‡ªå®šä¹‰å›´æ                                  [æ·»åŠ ]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  è®¾ç½®ç‰¹å®šåŒºåŸŸçš„é¢„ç®—æé†’                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ” æ•°æ®å®‰å…¨ä¿éšœ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  âœ“ ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨ï¼ˆAES-256ï¼‰                          â”‚   â”‚
â”‚  â”‚  âœ“ ä»…ç”¨äºæ™ºèƒ½è®°è´¦åŠŸèƒ½                                       â”‚   â”‚
â”‚  â”‚  âœ“ ä¸ä¸Šä¼ åŸå§‹åæ ‡åˆ°äº‘ç«¯                                     â”‚   â”‚
â”‚  â”‚  âœ“ 30å¤©è‡ªåŠ¨æ¸…ç†å†å²è½¨è¿¹                                     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  [æŸ¥çœ‹æ•°æ®ä½¿ç”¨è¯¦æƒ…]              [ç«‹å³æ¸…é™¤æ‰€æœ‰ä½ç½®æ•°æ®]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æ™ºèƒ½åˆ†ææˆæ•ˆ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åœºæ™¯è¯†åˆ«å‡†ç¡®ç‡: 94.2%                                       â”‚   â”‚
â”‚  â”‚  å•†åœˆæ¶ˆè´¹æé†’è§¦å‘: 23 æ¬¡                                     â”‚   â”‚
â”‚  â”‚  æ—…æ¸¸æ¶ˆè´¹è‡ªåŠ¨åˆ†ç¦»: 8 æ¬¡                                      â”‚   â”‚
â”‚  â”‚  é¢„ä¼°å¸®æ‚¨èŠ‚çœ: Â¥3,680                                        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  æœ¬æœˆä½ç½®åˆ†æ                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ å®¶é™„è¿‘   45%   Â¥2,340                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ å…¬å¸é™„è¿‘ 32%   Â¥1,890                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ å•†åœˆ     15%   Â¥1,200                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ å…¶ä»–      8%   Â¥560                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.7 ç²¾ç¡®ä½ç½®åœ¨é›¶åŸºé¢„ç®—ä¸­çš„åº”ç”¨

é›¶åŸºé¢„ç®—çš„æ ¸å¿ƒç†å¿µæ˜¯"æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„"ï¼Œç²¾ç¡®ä½ç½®å¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´æ™ºèƒ½åœ°åˆ†é…å’Œç®¡ç†é¢„ç®—ã€‚

#### 11.7.1 åŸºäºä½ç½®çš„æ™ºèƒ½é¢„ç®—åˆ†é…

```dart
/// ä½ç½®æ„ŸçŸ¥çš„é›¶åŸºé¢„ç®—æœåŠ¡
class LocationAwareZeroBudgetService {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final TransactionRepository _txRepo;
  final UserHomeLocationService _homeService;

  /// åŸºäºç”¨æˆ·ä½ç½®æ¨¡å¼åˆ†æé¢„ç®—åˆ†é…å»ºè®®
  Future<LocationBasedBudgetSuggestion> suggestBudgetAllocation({
    required double monthlyIncome,
    required List<Transaction> historicalTransactions,
  }) async {
    // åˆ†æå†å²æ¶ˆè´¹çš„ä½ç½®æ¨¡å¼
    final locationPattern = await _analyzeLocationPattern(historicalTransactions);

    // åŸºäºä½ç½®æ¨¡å¼ç”Ÿæˆé¢„ç®—å»ºè®®
    return LocationBasedBudgetSuggestion(
      income: monthlyIncome,
      allocations: _generateLocationBasedAllocations(monthlyIncome, locationPattern),
      insights: _generateAllocationInsights(locationPattern),
    );
  }

  /// åˆ†æå†å²æ¶ˆè´¹çš„ä½ç½®æ¨¡å¼
  Future<LocationPattern> _analyzeLocationPattern(
    List<Transaction> transactions,
  ) async {
    final home = await _homeService.getHomeLocation();
    final work = await _homeService.getWorkLocation();

    // ç»Ÿè®¡å„ä½ç½®çš„æ¶ˆè´¹æƒ…å†µ
    double nearHomeSpending = 0;
    double nearWorkSpending = 0;
    double commuteSpending = 0;
    double commercialSpending = 0;
    double travelSpending = 0;

    final categoryByLocation = <SpendingContext, Map<String, double>>{};

    for (final tx in transactions) {
      if (tx.location == null) continue;

      final context = _determineContext(tx.location!, home, work);

      switch (context) {
        case SpendingContext.nearHome:
          nearHomeSpending += tx.amount;
          break;
        case SpendingContext.nearWork:
          nearWorkSpending += tx.amount;
          break;
        case SpendingContext.commuting:
          commuteSpending += tx.amount;
          break;
        case SpendingContext.commercial:
          commercialSpending += tx.amount;
          break;
        case SpendingContext.travel:
          travelSpending += tx.amount;
          break;
        default:
          break;
      }

      // ç»Ÿè®¡å„ä½ç½®çš„æ¶ˆè´¹ç±»ç›®
      categoryByLocation.putIfAbsent(context, () => {});
      categoryByLocation[context]!.update(
        tx.category,
        (v) => v + tx.amount,
        ifAbsent: () => tx.amount,
      );
    }

    return LocationPattern(
      nearHomeSpending: nearHomeSpending,
      nearWorkSpending: nearWorkSpending,
      commuteSpending: commuteSpending,
      commercialSpending: commercialSpending,
      travelSpending: travelSpending,
      categoryByLocation: categoryByLocation,
      totalSpending: transactions.fold(0.0, (s, tx) => s + tx.amount),
    );
  }

  /// åŸºäºä½ç½®æ¨¡å¼ç”Ÿæˆé¢„ç®—åˆ†é…
  List<LocationBudgetAllocation> _generateLocationBasedAllocations(
    double income,
    LocationPattern pattern,
  ) {
    final total = pattern.totalSpending;
    if (total == 0) return [];

    final allocations = <LocationBudgetAllocation>[];

    // 1. å®¶é™„è¿‘é¢„ç®—ï¼ˆæ—¥ç”¨å“ã€ç¤¾åŒºæ¶ˆè´¹ï¼‰
    final homeRatio = pattern.nearHomeSpending / total;
    if (homeRatio > 0.1) {
      allocations.add(LocationBudgetAllocation(
        name: 'å®¶é™„è¿‘æ¶ˆè´¹',
        context: SpendingContext.nearHome,
        amount: income * homeRatio * 0.95, // ç•¥å¾®æ”¶ç´§
        percentage: homeRatio * 0.95,
        categories: pattern.categoryByLocation[SpendingContext.nearHome] ?? {},
        description: 'ç¤¾åŒºè¶…å¸‚ã€ä¾¿åˆ©åº—ã€å‘¨è¾¹é¤é¥®',
        icon: Icons.home,
      ));
    }

    // 2. å·¥ä½œåŒºé¢„ç®—ï¼ˆåˆé¤ã€å·¥ä½œç›¸å…³ï¼‰
    final workRatio = pattern.nearWorkSpending / total;
    if (workRatio > 0.1) {
      allocations.add(LocationBudgetAllocation(
        name: 'å·¥ä½œåŒºæ¶ˆè´¹',
        context: SpendingContext.nearWork,
        amount: income * workRatio * 0.90, // å¯ä¼˜åŒ–ç©ºé—´è¾ƒå¤§
        percentage: workRatio * 0.90,
        categories: pattern.categoryByLocation[SpendingContext.nearWork] ?? {},
        description: 'å·¥ä½œåˆé¤ã€å’–å•¡ã€åŠå…¬ç”¨å“',
        icon: Icons.business,
        optimizationTip: 'è€ƒè™‘è‡ªå¸¦åˆé¤ï¼Œæ¯æœˆå¯çœÂ¥${(income * workRatio * 0.1).toStringAsFixed(0)}',
      ));
    }

    // 3. é€šå‹¤é¢„ç®—
    final commuteRatio = pattern.commuteSpending / total;
    if (commuteRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'é€šå‹¤æ¶ˆè´¹',
        context: SpendingContext.commuting,
        amount: income * commuteRatio * 0.85, // å¯ä¼˜åŒ–ç©ºé—´å¤§
        percentage: commuteRatio * 0.85,
        categories: pattern.categoryByLocation[SpendingContext.commuting] ?? {},
        description: 'äº¤é€šè´¹ã€æ—©é¤ã€è·¯ä¸Šé›¶é£Ÿ',
        icon: Icons.commute,
        optimizationTip: 'å›ºå®šé€šå‹¤è·¯çº¿å¯å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
      ));
    }

    // 4. å•†åœˆå¨±ä¹é¢„ç®—ï¼ˆä¸¥æ ¼æ§åˆ¶ï¼‰
    final commercialRatio = pattern.commercialSpending / total;
    if (commercialRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'å•†åœˆå¨±ä¹',
        context: SpendingContext.commercial,
        amount: income * commercialRatio * 0.80, // è¾ƒå¤§æ”¶ç´§
        percentage: commercialRatio * 0.80,
        categories: pattern.categoryByLocation[SpendingContext.commercial] ?? {},
        description: 'è´­ç‰©ã€é¤é¥®ã€å¨±ä¹',
        icon: Icons.shopping_bag,
        optimizationTip: 'å•†åœˆæ¶ˆè´¹å†²åŠ¨æ€§å¼ºï¼Œå»ºè®®è®¾ç½®æ¶ˆè´¹é™é¢',
        requiresApproval: true, // è¶…æ”¯éœ€å®¡æ‰¹
      ));
    }

    // 5. æ—…è¡Œ/å‡ºå·®é¢„ç®—ï¼ˆå•ç‹¬è®¡åˆ’ï¼‰
    final travelRatio = pattern.travelSpending / total;
    if (travelRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'æ—…è¡Œ/å‡ºå·®',
        context: SpendingContext.travel,
        amount: income * travelRatio, // ä¿æŒåŸæ¯”ä¾‹
        percentage: travelRatio,
        categories: pattern.categoryByLocation[SpendingContext.travel] ?? {},
        description: 'å¼‚åœ°äº¤é€šã€ä½å®¿ã€é¤é¥®',
        icon: Icons.flight,
        isSeparateBudget: true, // ç‹¬ç«‹é¢„ç®—
      ));
    }

    // 6. å‚¨è“„é¢„ç®—
    final savingsAmount = income * 0.20; // å»ºè®®20%å‚¨è“„
    allocations.add(LocationBudgetAllocation(
      name: 'å‚¨è“„/æŠ•èµ„',
      context: SpendingContext.other,
      amount: savingsAmount,
      percentage: 0.20,
      categories: {},
      description: 'åº”æ€¥é‡‘ã€æŠ•èµ„ã€é•¿æœŸç›®æ ‡',
      icon: Icons.savings,
      priority: 1, // æœ€é«˜ä¼˜å…ˆçº§
    ));

    return allocations;
  }

  /// ç”Ÿæˆé¢„ç®—åˆ†é…æ´å¯Ÿ
  List<BudgetInsight> _generateAllocationInsights(LocationPattern pattern) {
    final insights = <BudgetInsight>[];
    final total = pattern.totalSpending;

    // å•†åœˆæ¶ˆè´¹æ¯”ä¾‹è¿‡é«˜
    if (pattern.commercialSpending / total > 0.3) {
      insights.add(BudgetInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹å æ¯”è¿‡é«˜',
        description: 'å•†åœˆæ¶ˆè´¹å æ€»æ”¯å‡º${(pattern.commercialSpending / total * 100).toStringAsFixed(0)}%ï¼Œ'
            'å»ºè®®æ§åˆ¶åœ¨20%ä»¥å†…',
        suggestion: 'å¯ç”¨å•†åœˆåœ°ç†å›´æ æé†’ï¼Œè¿›å…¥å•†åœˆå‰æŸ¥çœ‹é¢„ç®—',
        potentialSaving: pattern.commercialSpending * 0.3,
      ));
    }

    // é€šå‹¤æ¶ˆè´¹å¯ä¼˜åŒ–
    if (pattern.commuteSpending / total > 0.1) {
      insights.add(BudgetInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤æ¶ˆè´¹æœ‰ä¼˜åŒ–ç©ºé—´',
        description: 'é€šå‹¤è·¯ä¸Šæ¶ˆè´¹Â¥${pattern.commuteSpending.toStringAsFixed(0)}ï¼Œ'
            'å¤šä¸ºä¸´æ—¶æ¶ˆè´¹',
        suggestion: 'æå‰è§„åˆ’å‡ºè¡Œè·¯çº¿ï¼Œå›ºå®šæ—©é¤åœ°ç‚¹æˆ–è‡ªå¸¦',
        potentialSaving: pattern.commuteSpending * 0.4,
      ));
    }

    // å®¶é™„è¿‘æ¶ˆè´¹ç¨³å®š
    if (pattern.nearHomeSpending / total > 0.3) {
      insights.add(BudgetInsight(
        type: InsightType.info,
        title: 'å®¶é™„è¿‘æ¶ˆè´¹ä¹ æƒ¯ç¨³å®š',
        description: 'å®¶é™„è¿‘æ¶ˆè´¹å ${(pattern.nearHomeSpending / total * 100).toStringAsFixed(0)}%ï¼Œ'
            'æ¶ˆè´¹è¡Œä¸ºè¾ƒä¸ºè§„å¾‹',
        suggestion: 'å¯è€ƒè™‘åŠç†ç¤¾åŒºå•†å®¶ä¼šå‘˜å¡è·å–ä¼˜æƒ ',
      ));
    }

    return insights;
  }
}

/// ä½ç½®æ¨¡å¼åˆ†æç»“æœ
class LocationPattern {
  final double nearHomeSpending;
  final double nearWorkSpending;
  final double commuteSpending;
  final double commercialSpending;
  final double travelSpending;
  final Map<SpendingContext, Map<String, double>> categoryByLocation;
  final double totalSpending;
}

/// åŸºäºä½ç½®çš„é¢„ç®—åˆ†é…
class LocationBudgetAllocation {
  final String name;
  final SpendingContext context;
  final double amount;
  final double percentage;
  final Map<String, double> categories;
  final String description;
  final IconData icon;
  final String? optimizationTip;
  final bool requiresApproval;
  final bool isSeparateBudget;
  final int priority;

  LocationBudgetAllocation({
    required this.name,
    required this.context,
    required this.amount,
    required this.percentage,
    required this.categories,
    required this.description,
    required this.icon,
    this.optimizationTip,
    this.requiresApproval = false,
    this.isSeparateBudget = false,
    this.priority = 10,
  });
}

/// ä½ç½®é¢„ç®—å»ºè®®
class LocationBasedBudgetSuggestion {
  final double income;
  final List<LocationBudgetAllocation> allocations;
  final List<BudgetInsight> insights;

  double get totalAllocated =>
      allocations.fold(0.0, (sum, a) => sum + a.amount);

  double get remainingToAllocate => income - totalAllocated;
}
```

#### 11.7.2 åœ°ç†å›´æ é¢„ç®—æé†’

```dart
/// åœ°ç†å›´æ é¢„ç®—æé†’æœåŠ¡
class GeofenceBudgetAlertService {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final NotificationService _notificationService;

  // å·²æ³¨å†Œçš„åœ°ç†å›´æ 
  final List<BudgetGeofence> _activeGeofences = [];

  /// åˆå§‹åŒ–é»˜è®¤åœ°ç†å›´æ 
  Future<void> initializeDefaultGeofences() async {
    // 1. å•†åœˆå›´æ 
    final commercialAreas = await _locationService.getNearbyCommercialAreas();
    for (final area in commercialAreas) {
      _activeGeofences.add(BudgetGeofence(
        id: 'commercial_${area.id}',
        name: area.name,
        center: area.center,
        radius: area.radius,
        type: GeofenceType.commercial,
        categories: ['è´­ç‰©', 'å¨±ä¹', 'é¤é¥®'],
        alertMessage: 'æ‚¨å·²è¿›å…¥${area.name}å•†åœˆï¼Œæœ¬æœˆè´­ç‰©é¢„ç®—è¿˜å‰©Â¥{remaining}',
      ));
    }

    // 2. è‡ªåŠ¨æ£€æµ‹å¸¸å»çš„é«˜æ¶ˆè´¹åŒºåŸŸ
    final highSpendingAreas = await _detectHighSpendingAreas();
    for (final area in highSpendingAreas) {
      _activeGeofences.add(BudgetGeofence(
        id: 'high_spending_${area.hashCode}',
        name: 'é«˜æ¶ˆè´¹åŒºåŸŸ',
        center: area.center,
        radius: 500,
        type: GeofenceType.custom,
        categories: area.topCategories,
        alertMessage: 'è¿™ä¸ªåŒºåŸŸæ‚¨æœˆå‡æ¶ˆè´¹Â¥${area.averageSpending.toStringAsFixed(0)}ï¼Œ'
            'è¯·æ³¨æ„æ§åˆ¶æ”¯å‡º',
      ));
    }
  }

  /// å¯åŠ¨ä½ç½®ç›‘å¬
  void startMonitoring() {
    _locationService.startLocationUpdates(
      interval: Duration(minutes: 5),
      onLocationUpdate: _checkGeofences,
    );
  }

  /// æ£€æŸ¥æ˜¯å¦è¿›å…¥å›´æ 
  Future<void> _checkGeofences(PreciseLocation location) async {
    for (final fence in _activeGeofences) {
      final distance = location.distanceTo(fence.center);

      if (distance <= fence.radius) {
        // è¿›å…¥å›´æ 
        if (!fence.isInside) {
          fence.isInside = true;
          await _onEnterGeofence(fence, location);
        }
      } else {
        // ç¦»å¼€å›´æ 
        if (fence.isInside) {
          fence.isInside = false;
          await _onExitGeofence(fence);
        }
      }
    }
  }

  /// è¿›å…¥å›´æ æ—¶è§¦å‘
  Future<void> _onEnterGeofence(BudgetGeofence fence, PreciseLocation location) async {
    // è·å–ç›¸å…³é¢„ç®—å‰©ä½™
    double remaining = 0;
    for (final category in fence.categories) {
      final budget = await _budgetRepo.getBudget(category);
      if (budget != null) {
        remaining += budget.remaining;
      }
    }

    // æ„å»ºæé†’æ¶ˆæ¯
    final message = fence.alertMessage.replaceAll('{remaining}', remaining.toStringAsFixed(0));

    // å‘é€é€šçŸ¥
    await _notificationService.showBudgetAlert(
      title: 'ğŸ’° é¢„ç®—æé†’',
      body: message,
      payload: BudgetAlertPayload(
        geofenceId: fence.id,
        location: location,
        categories: fence.categories,
        remainingBudget: remaining,
      ),
    );

    // æ ¹æ®é¢„ç®—å‰©ä½™æƒ…å†µè°ƒæ•´æé†’å¼ºåº¦
    if (remaining < 100) {
      await _notificationService.showUrgentAlert(
        title: 'âš ï¸ é¢„ç®—ç´§å¼ ',
        body: '${fence.categories.join("ã€")}é¢„ç®—ä»…å‰©Â¥${remaining.toStringAsFixed(0)}ï¼Œ'
            'å»ºè®®è°¨æ…æ¶ˆè´¹',
      );
    }
  }

  /// ç¦»å¼€å›´æ æ—¶è§¦å‘
  Future<void> _onExitGeofence(BudgetGeofence fence) async {
    // å¯é€‰ï¼šè®°å½•åœ¨è¯¥åŒºåŸŸçš„æ¶ˆè´¹æƒ…å†µ
  }

  /// æ£€æµ‹é«˜æ¶ˆè´¹åŒºåŸŸ
  Future<List<HighSpendingArea>> _detectHighSpendingAreas() async {
    final transactions = await _txRepo.getRecentWithLocation(months: 3);

    // æŒ‰ä½ç½®èšç±»
    final clusters = _clusterByLocation(transactions);

    // æ‰¾å‡ºå¹³å‡æ¶ˆè´¹é«˜çš„åŒºåŸŸ
    return clusters
        .where((c) => c.averageSpending > 200) // å•æ¬¡æ¶ˆè´¹è¶…è¿‡200
        .where((c) => c.transactionCount > 5)   // è‡³å°‘5æ¬¡æ¶ˆè´¹
        .toList();
  }

  /// æŒ‰ä½ç½®èšç±»äº¤æ˜“
  List<LocationCluster> _clusterByLocation(List<Transaction> transactions) {
    // ä½¿ç”¨DBSCANç®—æ³•è¿›è¡Œä½ç½®èšç±»
    final clusters = <LocationCluster>[];

    for (final tx in transactions) {
      if (tx.location == null) continue;

      // æŸ¥æ‰¾æœ€è¿‘çš„èšç±»ï¼ˆ100ç±³èŒƒå›´å†…ï¼‰
      LocationCluster? nearestCluster;
      double minDistance = double.infinity;

      for (final cluster in clusters) {
        final distance = tx.location!.distanceTo(cluster.center);
        if (distance < 100 && distance < minDistance) {
          nearestCluster = cluster;
          minDistance = distance;
        }
      }

      if (nearestCluster != null) {
        nearestCluster.addTransaction(tx);
      } else {
        clusters.add(LocationCluster(
          center: tx.location!,
          transactions: [tx],
        ));
      }
    }

    return clusters;
  }
}

/// é¢„ç®—åœ°ç†å›´æ 
class BudgetGeofence {
  final String id;
  final String name;
  final PreciseLocation center;
  final double radius; // ç±³
  final GeofenceType type;
  final List<String> categories;
  final String alertMessage;
  bool isInside = false;
}

enum GeofenceType { commercial, restaurant, custom }

/// ä½ç½®èšç±»
class LocationCluster {
  PreciseLocation center;
  final List<Transaction> transactions;

  LocationCluster({required this.center, required this.transactions});

  void addTransaction(Transaction tx) {
    transactions.add(tx);
    // æ›´æ–°èšç±»ä¸­å¿ƒ
    _updateCenter();
  }

  void _updateCenter() {
    final avgLat = transactions.map((t) => t.location!.latitude).reduce((a, b) => a + b) / transactions.length;
    final avgLng = transactions.map((t) => t.location!.longitude).reduce((a, b) => a + b) / transactions.length;
    // ä½¿ç”¨å¹³å‡ä½ç½®ä½œä¸ºæ–°ä¸­å¿ƒ
    center = PreciseLocation(latitude: avgLat, longitude: avgLng, accuracy: 50, timestamp: DateTime.now());
  }

  double get averageSpending =>
      transactions.fold(0.0, (sum, tx) => sum + tx.amount) / transactions.length;

  int get transactionCount => transactions.length;

  List<String> get topCategories {
    final categoryCount = <String, int>{};
    for (final tx in transactions) {
      categoryCount.update(tx.category, (v) => v + 1, ifAbsent: () => 1);
    }
    return categoryCount.entries
        .sorted((a, b) => b.value.compareTo(a.value))
        .take(3)
        .map((e) => e.key)
        .toList();
  }
}

/// é«˜æ¶ˆè´¹åŒºåŸŸ
class HighSpendingArea {
  final PreciseLocation center;
  final double averageSpending;
  final int transactionCount;
  final List<String> topCategories;
}
```

#### 11.7.3 ä½ç½®æ™ºèƒ½é¢„ç®—æ‰§è¡Œç›‘æ§

```dart
/// ä½ç½®æ™ºèƒ½é¢„ç®—æ‰§è¡Œç›‘æ§
class LocationBudgetExecutionMonitor {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final TransactionRepository _txRepo;

  /// è®°è´¦æ—¶è‡ªåŠ¨å…³è”ä½ç½®é¢„ç®—
  Future<BudgetMatchResult> matchTransactionToBudget(
    Transaction tx,
    PreciseLocation location,
  ) async {
    // 1. ç¡®å®šæ¶ˆè´¹åœºæ™¯
    final context = await _determineSpendingContext(location);

    // 2. æŸ¥æ‰¾å¯¹åº”çš„ä½ç½®é¢„ç®—
    final locationBudget = await _budgetRepo.getLocationBudget(context);

    // 3. æŸ¥æ‰¾ç±»ç›®é¢„ç®—
    final categoryBudget = await _budgetRepo.getCategoryBudget(tx.category);

    // 4. å†³å®šä½¿ç”¨å“ªä¸ªé¢„ç®—
    if (locationBudget != null && categoryBudget != null) {
      // ä¸¤è€…éƒ½æœ‰ï¼Œä½¿ç”¨æ›´å…·ä½“çš„ï¼ˆä½ç½®+ç±»ç›®äº¤å‰ï¼‰
      return BudgetMatchResult(
        primaryBudget: locationBudget,
        secondaryBudget: categoryBudget,
        matchType: BudgetMatchType.locationAndCategory,
        suggestion: _generateExecutionSuggestion(tx, locationBudget, categoryBudget),
      );
    } else if (locationBudget != null) {
      return BudgetMatchResult(
        primaryBudget: locationBudget,
        matchType: BudgetMatchType.locationOnly,
      );
    } else if (categoryBudget != null) {
      return BudgetMatchResult(
        primaryBudget: categoryBudget,
        matchType: BudgetMatchType.categoryOnly,
      );
    }

    return BudgetMatchResult(matchType: BudgetMatchType.none);
  }

  /// ç”Ÿæˆæ‰§è¡Œå»ºè®®
  String _generateExecutionSuggestion(
    Transaction tx,
    Budget locationBudget,
    Budget categoryBudget,
  ) {
    final locationUsage = locationBudget.used / locationBudget.total;
    final categoryUsage = categoryBudget.used / categoryBudget.total;

    if (locationUsage > 0.9 && categoryUsage > 0.9) {
      return 'âš ï¸ è¯¥åŒºåŸŸå’Œç±»ç›®é¢„ç®—å‡æ¥è¿‘ä¸Šé™ï¼Œå»ºè®®æš‚ç¼“æ¶ˆè´¹';
    } else if (locationUsage > 0.9) {
      return 'ğŸ’¡ è¯¥åŒºåŸŸé¢„ç®—æ¥è¿‘ä¸Šé™ï¼Œä½†${tx.category}é¢„ç®—å……è¶³ï¼Œå¯è€ƒè™‘è°ƒæ•´';
    } else if (categoryUsage > 0.9) {
      return 'ğŸ’¡ ${tx.category}é¢„ç®—æ¥è¿‘ä¸Šé™ï¼Œè¯¥åŒºåŸŸæ•´ä½“é¢„ç®—å……è¶³';
    }

    return '';
  }

  /// ç”Ÿæˆä½ç½®ç»´åº¦çš„é¢„ç®—æ‰§è¡ŒæŠ¥å‘Š
  Future<LocationBudgetReport> generateLocationReport() async {
    final transactions = await _txRepo.getRecentWithLocation(months: 1);
    final budgets = await _budgetRepo.getAllLocationBudgets();

    final contextExecutions = <SpendingContext, BudgetExecution>{};

    // æŒ‰åœºæ™¯ç»Ÿè®¡æ‰§è¡Œæƒ…å†µ
    for (final tx in transactions) {
      if (tx.location == null) continue;

      final context = await _determineSpendingContext(tx.location!);
      final budget = budgets.firstWhere(
        (b) => b.context == context,
        orElse: () => Budget.empty(),
      );

      contextExecutions.update(
        context,
        (e) => e.addTransaction(tx),
        ifAbsent: () => BudgetExecution(budget: budget, transactions: [tx]),
      );
    }

    // ç”ŸæˆæŠ¥å‘Š
    return LocationBudgetReport(
      period: DateTime.now(),
      executions: contextExecutions,
      overBudgetContexts: contextExecutions.entries
          .where((e) => e.value.isOverBudget)
          .map((e) => e.key)
          .toList(),
      underUtilizedContexts: contextExecutions.entries
          .where((e) => e.value.utilizationRate < 0.5)
          .map((e) => e.key)
          .toList(),
      insights: _generateReportInsights(contextExecutions),
    );
  }

  /// ç”ŸæˆæŠ¥å‘Šæ´å¯Ÿ
  List<ReportInsight> _generateReportInsights(
    Map<SpendingContext, BudgetExecution> executions,
  ) {
    final insights = <ReportInsight>[];

    // æ£€æŸ¥å•†åœˆæ¶ˆè´¹
    final commercial = executions[SpendingContext.commercial];
    if (commercial != null && commercial.isOverBudget) {
      insights.add(ReportInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹è¶…æ”¯',
        description: 'æœ¬æœˆå•†åœˆæ¶ˆè´¹è¶…å‡ºé¢„ç®—Â¥${commercial.overBudgetAmount.toStringAsFixed(0)}',
        suggestion: 'ä¸‹æœˆå»ºè®®å¯ç”¨æ›´ä¸¥æ ¼çš„å•†åœˆå›´æ æé†’',
        actionText: 'è°ƒæ•´å•†åœˆé¢„ç®—',
      ));
    }

    // æ£€æŸ¥é€šå‹¤æ¶ˆè´¹
    final commute = executions[SpendingContext.commuting];
    if (commute != null && commute.averageTransaction > 50) {
      insights.add(ReportInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤æ¶ˆè´¹åé«˜',
        description: 'é€šå‹¤å•æ¬¡å¹³å‡æ¶ˆè´¹Â¥${commute.averageTransaction.toStringAsFixed(0)}',
        suggestion: 'è€ƒè™‘åŠç†äº¤é€šæœˆå¡æˆ–å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
      ));
    }

    // è¡¨æ‰¬å®¶é™„è¿‘æ¶ˆè´¹æ§åˆ¶è‰¯å¥½
    final nearHome = executions[SpendingContext.nearHome];
    if (nearHome != null && nearHome.utilizationRate.between(0.7, 0.9)) {
      insights.add(ReportInsight(
        type: InsightType.praise,
        title: 'å®¶é™„è¿‘æ¶ˆè´¹æ§åˆ¶è‰¯å¥½',
        description: 'é¢„ç®—ä½¿ç”¨ç‡${(nearHome.utilizationRate * 100).toStringAsFixed(0)}%ï¼Œ'
            'éå¸¸åˆç†',
      ));
    }

    return insights;
  }
}

/// é¢„ç®—æ‰§è¡Œæƒ…å†µ
class BudgetExecution {
  final Budget budget;
  final List<Transaction> transactions;

  BudgetExecution({required this.budget, required this.transactions});

  BudgetExecution addTransaction(Transaction tx) {
    return BudgetExecution(
      budget: budget,
      transactions: [...transactions, tx],
    );
  }

  double get totalSpending =>
      transactions.fold(0.0, (sum, tx) => sum + tx.amount);

  bool get isOverBudget => totalSpending > budget.total;

  double get overBudgetAmount =>
      isOverBudget ? totalSpending - budget.total : 0;

  double get utilizationRate =>
      budget.total > 0 ? totalSpending / budget.total : 0;

  double get averageTransaction =>
      transactions.isNotEmpty ? totalSpending / transactions.length : 0;
}

/// ä½ç½®é¢„ç®—æŠ¥å‘Š
class LocationBudgetReport {
  final DateTime period;
  final Map<SpendingContext, BudgetExecution> executions;
  final List<SpendingContext> overBudgetContexts;
  final List<SpendingContext> underUtilizedContexts;
  final List<ReportInsight> insights;

  bool get hasOverBudget => overBudgetContexts.isNotEmpty;

  double get totalOverBudget => executions.values
      .where((e) => e.isOverBudget)
      .fold(0.0, (sum, e) => sum + e.overBudgetAmount);
}

/// æŠ¥å‘Šæ´å¯Ÿ
class ReportInsight {
  final InsightType type;
  final String title;
  final String description;
  final String? suggestion;
  final String? actionText;
}
```

---

## 12. æŠ€æœ¯æ¶æ„è®¾è®¡

### 12.1 æ•´ä½“æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æŠ€æœ¯æ¶æ„å…¨æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   å®¢æˆ·ç«¯å±‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Flutter 3.x + Dart 3.x                                â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ UI: Material Design 3                             â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ çŠ¶æ€ç®¡ç†: Riverpod 3.x                            â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ æ•°æ®åº“: sqflite + drift                           â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ç½‘ç»œ: Dio + Retrofit                              â”‚      â”‚
â”‚   â”‚  â””â”€â”€ å›¾è¡¨: fl_chart                                    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚   æœåŠ¡ç«¯å±‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Python + FastAPI                                      â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ORM: SQLAlchemy 2.x                               â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ æ•°æ®åº“: PostgreSQL                                â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ç¼“å­˜: Redis                                       â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ä»»åŠ¡é˜Ÿåˆ—: Celery                                  â”‚      â”‚
â”‚   â”‚  â””â”€â”€ AIæœåŠ¡: é˜¿é‡Œäº‘é€šä¹‰åƒé—® / æ™ºè°±AI                   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚   åŸºç¡€è®¾æ–½å±‚                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  â”œâ”€â”€ äº‘æœåŠ¡: é˜¿é‡Œäº‘ / è…¾è®¯äº‘                           â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ å®¹å™¨: Docker + Kubernetes                         â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ CI/CD: GitHub Actions                             â”‚      â”‚
â”‚   â”‚  â””â”€â”€ ç›‘æ§: Prometheus + Grafana                        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 å®¢æˆ·ç«¯æ¶æ„

#### 12.2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Flutter å®¢æˆ·ç«¯æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   è¡¨ç°å±‚ (Presentation)                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Pages          â”‚  Widgets         â”‚  Dialogs          â”‚      â”‚
â”‚   â”‚  (50+ é¡µé¢)     â”‚  (å¯å¤ç”¨ç»„ä»¶)    â”‚  (å¼¹çª—/åº•éƒ¨è¡¨)    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   çŠ¶æ€å±‚ (State)              â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Providers (Riverpod)                                  â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ StateNotifier: ä¸šåŠ¡çŠ¶æ€ç®¡ç†                       â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ FutureProvider: å¼‚æ­¥æ•°æ®åŠ è½½                      â”‚      â”‚
â”‚   â”‚  â””â”€â”€ StreamProvider: å®æ—¶æ•°æ®ç›‘å¬                      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   é¢†åŸŸå±‚ (Domain)             â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Services           â”‚  Models          â”‚  Repositories  â”‚      â”‚
â”‚   â”‚  (ä¸šåŠ¡æœåŠ¡)         â”‚  (æ•°æ®æ¨¡å‹)      â”‚  (æ•°æ®ä»“åº“)    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   æ•°æ®å±‚ (Data)               â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LocalDB (sqflite)  â”‚  RemoteAPI (Dio) â”‚  Cache        â”‚      â”‚
â”‚   â”‚  æœ¬åœ°æ•°æ®åº“          â”‚  è¿œç¨‹API         â”‚  å†…å­˜ç¼“å­˜     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.2.2 Provider æ¶æ„æ¨¡å¼

```dart
/// åŸºç¡€ CRUD Provider
abstract class CrudNotifier<T, ID> extends StateNotifier<AsyncValue<List<T>>> {
  final Repository<T, ID> repository;

  CrudNotifier(this.repository) : super(const AsyncValue.loading()) {
    _init();
  }

  Future<void> _init() async {
    try {
      final items = await repository.getAll();
      state = AsyncValue.data(items);
    } catch (e, st) {
      state = AsyncValue.error(e, st);
    }
  }

  Future<void> create(T item) async {
    final previous = state;
    try {
      final created = await repository.create(item);
      state = AsyncValue.data([...state.value ?? [], created]);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  Future<void> update(T item, ID id) async {
    // ä¹è§‚æ›´æ–°
    final previous = state;
    try {
      state = AsyncValue.data(
        state.value?.map((i) => _getId(i) == id ? item : i).toList() ?? []
      );
      await repository.update(item);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  Future<void> delete(ID id) async {
    final previous = state;
    try {
      state = AsyncValue.data(
        state.value?.where((i) => _getId(i) != id).toList() ?? []
      );
      await repository.delete(id);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  ID _getId(T item);
}

/// äº¤æ˜“ Provider ç¤ºä¾‹
class TransactionNotifier extends CrudNotifier<Transaction, String> {
  final OfflineQueueService offlineQueue;
  final AutoSyncService autoSync;

  TransactionNotifier({
    required TransactionRepository repository,
    required this.offlineQueue,
    required this.autoSync,
  }) : super(repository);

  @override
  String _getId(Transaction item) => item.id;

  @override
  Future<void> create(Transaction item) async {
    // ç«‹å³æœ¬åœ°ä¿å­˜
    await super.create(item);

    // åŠ å…¥åŒæ­¥é˜Ÿåˆ—
    offlineQueue.enqueue(SyncOperation.create(item));

    // è§¦å‘åŒæ­¥
    autoSync.triggerSync();
  }
}
```

### 12.3 ç¦»çº¿ä¼˜å…ˆæ¶æ„

```dart
/// ç¦»çº¿é˜Ÿåˆ—æœåŠ¡
class OfflineQueueService {
  final Database _db;
  final ConnectivityService _connectivity;

  /// å…¥é˜Ÿæ“ä½œ
  Future<void> enqueue(SyncOperation operation) async {
    await _db.insert('sync_queue', {
      'id': operation.id,
      'type': operation.type.name,
      'entity_type': operation.entityType,
      'entity_id': operation.entityId,
      'payload': jsonEncode(operation.payload),
      'created_at': DateTime.now().toIso8601String(),
      'retry_count': 0,
      'status': 'pending',
    });
  }

  /// å¤„ç†é˜Ÿåˆ—
  Future<void> processQueue() async {
    if (!await _connectivity.isConnected) return;

    final pending = await _db.query('sync_queue',
      where: 'status = ?',
      whereArgs: ['pending'],
      orderBy: 'created_at ASC',
    );

    for (final item in pending) {
      try {
        await _processOperation(SyncOperation.fromMap(item));
        await _markCompleted(item['id']);
      } catch (e) {
        await _handleError(item, e);
      }
    }
  }

  /// å¤„ç†é”™è¯¯ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  Future<void> _handleError(Map<String, dynamic> item, dynamic error) async {
    final retryCount = item['retry_count'] as int;

    if (retryCount >= 5) {
      await _markFailed(item['id'], error.toString());
    } else {
      // æŒ‡æ•°é€€é¿
      final delaySeconds = pow(2, retryCount).toInt();
      await _db.update('sync_queue', {
        'retry_count': retryCount + 1,
        'next_retry': DateTime.now().add(Duration(seconds: delaySeconds)).toIso8601String(),
        'last_error': error.toString(),
      }, where: 'id = ?', whereArgs: [item['id']]);
    }
  }
}

/// è‡ªåŠ¨åŒæ­¥æœåŠ¡
class AutoSyncService {
  final OfflineQueueService _queue;
  final ConnectivityService _connectivity;
  Timer? _timer;

  /// å¯åŠ¨è‡ªåŠ¨åŒæ­¥
  void start() {
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    _connectivity.onConnectivityChanged.listen((connected) {
      if (connected) {
        triggerSync();
      }
    });

    // å®šæ—¶åŒæ­¥
    _timer = Timer.periodic(Duration(minutes: 5), (_) => triggerSync());
  }

  /// è§¦å‘åŒæ­¥
  Future<void> triggerSync() async {
    try {
      await _queue.processQueue();
    } catch (e) {
      // é™é»˜å¤„ç†é”™è¯¯
      debugPrint('Sync failed: $e');
    }
  }

  /// åœæ­¢åŒæ­¥
  void stop() {
    _timer?.cancel();
    _timer = null;
  }
}
```

### 12.4 æ•°æ®åº“è®¾è®¡

#### 12.4.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'cash', 'bank', 'credit', 'investment'
  balance REAL DEFAULT 0,
  currency TEXT DEFAULT 'CNY',
  icon TEXT,
  color TEXT,
  is_archived INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced'
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'income', 'expense'
  icon TEXT,
  color TEXT,
  parent_id TEXT,
  sort_order INTEGER DEFAULT 0,
  is_system INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (parent_id) REFERENCES categories(id)
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,  -- 'income', 'expense', 'transfer'
  amount REAL NOT NULL,
  account_id TEXT NOT NULL,
  category_id TEXT,
  to_account_id TEXT,  -- è½¬è´¦ç›®æ ‡è´¦æˆ·
  description TEXT,
  date TEXT NOT NULL,
  vault_id TEXT,  -- å…³è”çš„å°é‡‘åº“
  tags TEXT,  -- JSONæ•°ç»„
  attachments TEXT,  -- JSONæ•°ç»„
  location TEXT,
  is_recurring INTEGER DEFAULT 0,
  recurring_id TEXT,
  source_type TEXT,  -- 'manual', 'voice', 'image', 'import'
  source_file_id TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced',
  FOREIGN KEY (account_id) REFERENCES accounts(id),
  FOREIGN KEY (category_id) REFERENCES categories(id),
  FOREIGN KEY (to_account_id) REFERENCES accounts(id),
  FOREIGN KEY (vault_id) REFERENCES budget_vaults(id)
);

-- å°é‡‘åº“è¡¨
CREATE TABLE budget_vaults (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  icon TEXT,
  color TEXT,
  type TEXT NOT NULL,  -- 'fixed', 'flexible', 'savings', 'debt'
  target_amount REAL DEFAULT 0,
  allocated_amount REAL DEFAULT 0,
  spent_amount REAL DEFAULT 0,
  period TEXT,  -- 'monthly', 'weekly', 'yearly'
  due_date TEXT,
  is_recurring INTEGER DEFAULT 0,
  recurrence_rule TEXT,  -- JSON
  sort_order INTEGER DEFAULT 0,
  is_archived INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced'
);

-- èµ„æºæ± è¡¨ï¼ˆé’±é¾„è®¡ç®—ï¼‰
CREATE TABLE resource_pools (
  id TEXT PRIMARY KEY,
  income_transaction_id TEXT NOT NULL,
  original_amount REAL NOT NULL,
  remaining_amount REAL NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (income_transaction_id) REFERENCES transactions(id)
);

-- èµ„æºæ¶ˆè€—è®°å½•è¡¨
CREATE TABLE resource_consumptions (
  id TEXT PRIMARY KEY,
  pool_id TEXT NOT NULL,
  transaction_id TEXT NOT NULL,
  amount REAL NOT NULL,
  age_at_consumption INTEGER NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (pool_id) REFERENCES resource_pools(id),
  FOREIGN KEY (transaction_id) REFERENCES transactions(id)
);

-- åŒæ­¥é˜Ÿåˆ—è¡¨
CREATE TABLE sync_queue (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,  -- 'create', 'update', 'delete'
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  payload TEXT,
  status TEXT DEFAULT 'pending',
  retry_count INTEGER DEFAULT 0,
  next_retry TEXT,
  last_error TEXT,
  created_at TEXT NOT NULL,
  completed_at TEXT
);
```

---

## 13. ç”¨æˆ·ä½“éªŒè®¾è®¡

> **è®¾è®¡åŸåˆ™ä¾æ®**ï¼šæœ¬ç« çš„æ‰€æœ‰è®¾è®¡å®ç°éµå¾ªç¬¬23ç« "[æ‡’äººè®¾è®¡åŸåˆ™](#23-æ‡’äººè®¾è®¡åŸåˆ™)"å’Œç¬¬24ç« "[ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™](#24-ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™)"ï¼ŒåŒ…æ‹¬æœ€å°‘æ“ä½œã€æ™ºèƒ½é»˜è®¤ã€æ¸è¿›å¤æ‚åº¦ã€å•æ‰‹æ“ä½œã€ä¼™ä¼´åŸåˆ™ç­‰æ ¸å¿ƒç†å¿µã€‚

### 13.1 æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šä»¥é’±é¾„å’Œé›¶åŸºé¢„ç®—ä¸ºä¸­å¿ƒ

#### 13.1.1 è®¾è®¡å“²å­¦

ä¼ ç»Ÿè®°è´¦APPä»¥"è®°å½•"ä¸ºæ ¸å¿ƒï¼Œç”¨æˆ·è®°å®Œè´¦å°±å…³é—­äº†APPã€‚æˆ‘ä»¬çš„2.0ç‰ˆæœ¬ä»¥"åŸ¹å…»è´¢åŠ¡ä¹ æƒ¯"ä¸ºæ ¸å¿ƒï¼Œè®©ç”¨æˆ·**ä¸»åŠ¨æƒ³æ‰“å¼€APP**æŸ¥çœ‹è‡ªå·±çš„è´¢åŠ¡å¥åº·çŠ¶å†µã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¾è®¡å“²å­¦è½¬å˜                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚   ä¼ ç»Ÿè®°è´¦APP                    â†’     AIæ™ºèƒ½è®°è´¦ 2.0                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚                  â”‚                â”‚                  â”‚            â”‚
â”‚   â”‚   è®°å½•ä¸ºä¸­å¿ƒ     â”‚     â”€â”€â†’        â”‚   æˆé•¿ä¸ºä¸­å¿ƒ     â”‚            â”‚
â”‚   â”‚   "èŠ±äº†å¤šå°‘é’±"   â”‚                â”‚   "è´¢åŠ¡åœ¨å˜å¥½å—" â”‚            â”‚
â”‚   â”‚                  â”‚                â”‚                  â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                        â”‚
â”‚   ç—›ç‚¹ï¼š                              ç›®æ ‡ï¼š                           â”‚
â”‚   â€¢ è®°å®Œå°±å…³                          â€¢ ä¸»åŠ¨æ‰“å¼€æŸ¥çœ‹                   â”‚
â”‚   â€¢ æ— æˆå°±æ„Ÿ                          â€¢ æ¸¸æˆåŒ–æ¿€åŠ±                     â”‚
â”‚   â€¢ è¶…æ”¯åæ‚”                          â€¢ è¶…æ”¯å‰é¢„è­¦                     â”‚
â”‚   â€¢ æ•°æ®å­¤å²›                          â€¢ æ´å¯Ÿä¸å»ºè®®                     â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.1.2 ä¿¡æ¯æ¶æ„é‡æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPä¿¡æ¯æ¶æ„ 2.0                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        åº•éƒ¨å¯¼èˆªæ                                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚    [ğŸ“Š]           [ğŸ“ˆ]           [â•]          [ğŸ’°]         [ğŸ‘¤] â”‚  â”‚
â”‚  â”‚   ä»ªè¡¨ç›˜         è¶‹åŠ¿            è®°è´¦          é¢„ç®—          æˆ‘çš„ â”‚  â”‚
â”‚  â”‚  Dashboard      Insights       Record       Budget        Profileâ”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  é¡µé¢å±‚çº§ï¼š                                                            â”‚
â”‚                                                                        â”‚
â”‚  ä»ªè¡¨ç›˜ â”€â”€â†’ è´¢åŠ¡å¥åº·æ€»è§ˆï¼ˆé’±é¾„ä¸ºæ ¸å¿ƒæŒ‡æ ‡ï¼‰                             â”‚
â”‚         â”‚â”€â”€ é’±é¾„è¯¦æƒ…åˆ†æ                                              â”‚
â”‚         â”‚â”€â”€ åº”æ€¥é‡‘è¿›åº¦                                                â”‚
â”‚         â””â”€â”€ æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ                                              â”‚
â”‚                                                                        â”‚
â”‚  è¶‹åŠ¿ â”€â”€â”€â”€â†’ å¤šç»´åº¦å›¾è¡¨åˆ†æ                                            â”‚
â”‚         â”‚â”€â”€ æ¶ˆè´¹è¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾/çƒ­åŠ›å›¾ï¼‰                                 â”‚
â”‚         â”‚â”€â”€ åˆ†ç±»å æ¯”ï¼ˆé¥¼å›¾/ç¯å½¢å›¾ï¼‰                                   â”‚
â”‚         â”‚â”€â”€ æ¶ˆè´¹æ´å¯Ÿï¼ˆæ‹¿é“å› å­/è®¢é˜…åˆ†æï¼‰                             â”‚
â”‚         â””â”€â”€ å¯¹æ¯”åˆ†æï¼ˆåŒæœŸå¯¹æ¯”/é¢„ç®—å¯¹æ¯”ï¼‰                             â”‚
â”‚                                                                        â”‚
â”‚  è®°è´¦ â”€â”€â”€â”€â†’ å¿«é€Ÿè®°è´¦å…¥å£                                              â”‚
â”‚         â”‚â”€â”€ è¯­éŸ³è®°è´¦                                                  â”‚
â”‚         â”‚â”€â”€ å›¾ç‰‡è¯†åˆ«                                                  â”‚
â”‚         â”‚â”€â”€ æ‰‹åŠ¨è¾“å…¥                                                  â”‚
â”‚         â””â”€â”€ æ¨¡æ¿å¿«è®°                                                  â”‚
â”‚                                                                        â”‚
â”‚  é¢„ç®— â”€â”€â”€â”€â†’ é›¶åŸºé¢„ç®—ç®¡ç†                                              â”‚
â”‚         â”‚â”€â”€ æ”¶å…¥æ± åˆ†é…                                                â”‚
â”‚         â”‚â”€â”€ å°é‡‘åº“ç®¡ç†                                                â”‚
â”‚         â”‚â”€â”€ é¢„ç®—æ‰§è¡Œç›‘æ§                                              â”‚
â”‚         â””â”€â”€ ç»“è½¬ä¸è°ƒæ•´                                                â”‚
â”‚                                                                        â”‚
â”‚  æˆ‘çš„ â”€â”€â”€â”€â†’ è´¦æˆ·ä¸è®¾ç½®                                                â”‚
â”‚         â”‚â”€â”€ è´¦æˆ·ç®¡ç†                                                  â”‚
â”‚         â”‚â”€â”€ æ•°æ®åŒæ­¥                                                  â”‚
â”‚         â”‚â”€â”€ æˆå°±å¾½ç«                                                   â”‚
â”‚         â””â”€â”€ ç³»ç»Ÿè®¾ç½®                                                  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 å…¨æ–°é¦–é¡µä»ªè¡¨ç›˜è®¾è®¡

#### 13.2.1 ä»ªè¡¨ç›˜æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‰¡  AIæ™ºèƒ½è®°è´¦                                    ğŸ”” 2   ğŸ‘¤        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ğŸ’« è´¢åŠ¡å¥åº·æ€»è§ˆ                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚                     â”‚  è´¢åŠ¡å¥åº·åˆ† 78/100  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    â±ï¸      â”‚    é’±é¾„ 18 å¤©       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   18å¤©     â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  ğŸ“ˆ è¾ƒä¸Šæœˆ +5åˆ†     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚    Level 3 ç¨³å¥è€…   â”‚                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚    ç›®æ ‡: 30å¤©ä»å®¹è€…  â”‚  [æŸ¥çœ‹è¯¦æƒ… â†’]       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  ğŸ“… æœ¬æœˆé¢„ç®—          â”‚  â”‚  ğŸ›¡ï¸ åº”æ€¥é‡‘å‚¨å¤‡       â”‚               â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚               â”‚
â”‚  â”‚  Â¥8,500 / Â¥12,000   â”‚  â”‚  Â¥18,000 / Â¥36,000  â”‚               â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 71%   â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 50%   â”‚               â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚               â”‚
â”‚  â”‚  å‰©ä½™ Â¥3,500        â”‚  â”‚  ç›®æ ‡: 6ä¸ªæœˆæ”¯å‡º     â”‚               â”‚
â”‚  â”‚  è¿˜æœ‰ 12 å¤©          â”‚  â”‚  å·²è¾¾æˆ3ä¸ªæœˆ âœ“      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æ”¶å…¥ Â¥15,000          æ”¯å‡º Â¥8,500           ç»“ä½™ Â¥6,500   â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¡ ä»Šæ—¥æ´å¯Ÿ                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ¯ é¤é¥®é¢„ç®—è¿˜å‰© Â¥580ï¼Œå»ºè®®æœ¬å‘¨æ§åˆ¶åœ¨ Â¥82/å¤©        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  âš ï¸ è§†é¢‘ä¼šå‘˜å·²è¿ç»­3ä¸ªæœˆæœªä½¿ç”¨ï¼Œæ¯æœˆ Â¥30             â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”¥ è¿ç»­è®°è´¦ 45å¤©                           æ–°çºªå½•! ğŸ†       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [ğŸ“Š]         [ğŸ“ˆ]         [â•]         [ğŸ’°]         [ğŸ‘¤]        â”‚
â”‚   ä»ªè¡¨ç›˜        è¶‹åŠ¿          è®°è´¦          é¢„ç®—          æˆ‘çš„       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.2.2 ä»ªè¡¨ç›˜ç»„ä»¶ä»£ç è®¾è®¡

```dart
/// 2.0 å…¨æ–°é¦–é¡µä»ªè¡¨ç›˜
class DashboardPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: _buildAppBar(context),
      body: RefreshIndicator(
        onRefresh: () => ref.refresh(dashboardDataProvider.future),
        child: SingleChildScrollView(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              // æ ¸å¿ƒæŒ‡æ ‡ï¼šé’±é¾„ + è´¢åŠ¡å¥åº·åˆ†
              FinancialHealthHeroCard(),
              SizedBox(height: 16),

              // åŒå¡ç‰‡ï¼šé¢„ç®—æ¦‚è§ˆ + åº”æ€¥é‡‘
              Row(
                children: [
                  Expanded(child: BudgetOverviewMiniCard()),
                  SizedBox(width: 12),
                  Expanded(child: EmergencyFundMiniCard()),
                ],
              ),
              SizedBox(height: 16),

              // æœ¬æœˆæ”¶æ”¯ä¸‰æ 
              MonthlyOverviewCard(),
              SizedBox(height: 16),

              // ä»Šæ—¥æ´å¯Ÿå¡ç‰‡
              TodayInsightsCard(),
              SizedBox(height: 16),

              // è¿ç»­è®°è´¦æ¿€åŠ±
              RecordingStreakBanner(),
              SizedBox(height: 80), // åº•éƒ¨å¯¼èˆªæ ç•™ç™½
            ],
          ),
        ),
      ),
    );
  }
}

/// è´¢åŠ¡å¥åº·è‹±é›„å¡ç‰‡ï¼ˆæ ¸å¿ƒè§†è§‰ç„¦ç‚¹ï¼‰
class FinancialHealthHeroCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final moneyAge = ref.watch(moneyAgeProvider);
    final healthScore = ref.watch(financialHealthScoreProvider);

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Theme.of(context).primaryColor,
            Theme.of(context).primaryColor.withOpacity(0.7),
          ],
        ),
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).primaryColor.withOpacity(0.3),
            blurRadius: 20,
            offset: Offset(0, 10),
          ),
        ],
      ),
      child: Padding(
        padding: EdgeInsets.all(20),
        child: Column(
          children: [
            Text('ğŸ’« è´¢åŠ¡å¥åº·æ€»è§ˆ',
              style: TextStyle(color: Colors.white70, fontSize: 14)),
            SizedBox(height: 16),
            Row(
              children: [
                // å·¦ä¾§ï¼šé’±é¾„åœ†ç¯
                _buildMoneyAgeRing(moneyAge),
                SizedBox(width: 20),
                // ä¸­é—´ï¼šé’±é¾„ä¿¡æ¯
                Expanded(child: _buildMoneyAgeInfo(moneyAge)),
                // å³ä¾§ï¼šå¥åº·åˆ†
                _buildHealthScoreCard(healthScore),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMoneyAgeRing(MoneyAge moneyAge) {
    return Container(
      width: 80,
      height: 80,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // èƒŒæ™¯åœ†ç¯
          CircularProgressIndicator(
            value: 1,
            strokeWidth: 8,
            backgroundColor: Colors.white24,
            valueColor: AlwaysStoppedAnimation(Colors.white24),
          ),
          // è¿›åº¦åœ†ç¯ï¼ˆ30å¤©ä¸ºæ»¡ï¼‰
          CircularProgressIndicator(
            value: (moneyAge.days / 30).clamp(0, 1),
            strokeWidth: 8,
            backgroundColor: Colors.transparent,
            valueColor: AlwaysStoppedAnimation(Colors.white),
          ),
          // ä¸­å¿ƒæ•°å­—
          Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text('â±ï¸', style: TextStyle(fontSize: 16)),
              Text('${moneyAge.days}å¤©',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildMoneyAgeInfo(MoneyAge moneyAge) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('é’±é¾„ ${moneyAge.days} å¤©',
          style: TextStyle(
            color: Colors.white,
            fontSize: 22,
            fontWeight: FontWeight.bold,
          )),
        SizedBox(height: 4),
        Text('Level ${moneyAge.stage.level} ${moneyAge.stage.name}',
          style: TextStyle(color: Colors.white70)),
        SizedBox(height: 8),
        if (moneyAge.nextStage != null)
          Container(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: Colors.white24,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Text(
              'ç›®æ ‡: ${moneyAge.nextStage!.minAge}å¤© ${moneyAge.nextStage!.name}',
              style: TextStyle(color: Colors.white, fontSize: 12),
            ),
          ),
      ],
    );
  }

  Widget _buildHealthScoreCard(FinancialHealthScore score) {
    return Container(
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: [
          Text('è´¢åŠ¡å¥åº·åˆ†', style: TextStyle(fontSize: 10, color: Colors.grey)),
          Text('${score.totalScore}',
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.bold,
              color: _getScoreColor(score.totalScore),
            )),
          Text('/100', style: TextStyle(fontSize: 10, color: Colors.grey)),
          SizedBox(height: 4),
          if (score.comparisonToLastMonth != 0)
            Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  score.comparisonToLastMonth > 0
                      ? Icons.arrow_upward : Icons.arrow_downward,
                  size: 12,
                  color: score.comparisonToLastMonth > 0
                      ? Colors.green : Colors.red,
                ),
                Text(
                  '${score.comparisonToLastMonth > 0 ? '+' : ''}${score.comparisonToLastMonth}',
                  style: TextStyle(
                    fontSize: 11,
                    color: score.comparisonToLastMonth > 0
                        ? Colors.green : Colors.red,
                  ),
                ),
              ],
            ),
        ],
      ),
    );
  }

  Color _getScoreColor(int score) {
    if (score >= 80) return Colors.green;
    if (score >= 60) return Colors.blue;
    if (score >= 40) return Colors.orange;
    return Colors.red;
  }
}
```

### 13.3 è¶‹åŠ¿åˆ†æé¡µé¢è®¾è®¡

#### 13.3.1 è¶‹åŠ¿é¡µé¢æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  è¶‹åŠ¿åˆ†æ                                          ğŸ“… æœ¬æœˆ â–¼    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [æ¶ˆè´¹è¶‹åŠ¿]  [åˆ†ç±»å æ¯”]  [æ´å¯Ÿåˆ†æ]  [å¯¹æ¯”æŠ¥å‘Š]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                        æ¶ˆè´¹è¶‹åŠ¿ Tab                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ æ—¥æ¶ˆè´¹è¶‹åŠ¿                              [æ—¥] [å‘¨] [æœˆ]   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚      Â¥                                                       â”‚   â”‚
â”‚  â”‚    800 â”¤                    â—                                â”‚   â”‚
â”‚  â”‚        â”‚              â—    â”‚ â—                               â”‚   â”‚
â”‚  â”‚    600 â”¤         â—   â”‚ â—  â”‚   â—                             â”‚   â”‚
â”‚  â”‚        â”‚    â—   â”‚ â— â”‚     â”‚     â—   â—                       â”‚   â”‚
â”‚  â”‚    400 â”¤   â”‚ â— â”‚   â”‚      â”‚       â”‚ â”‚ â—                     â”‚   â”‚
â”‚  â”‚        â”‚  â”‚   â”‚            â”‚        â”‚   â—                    â”‚   â”‚
â”‚  â”‚    200 â”¤ â”‚                           â”‚                       â”‚   â”‚
â”‚  â”‚        â”‚                                                     â”‚   â”‚
â”‚  â”‚      0 â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â†’            â”‚   â”‚
â”‚  â”‚        1   3   5   7   9  11  13  15  17  19  æ—¥æœŸ           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ æœ¬æœˆæ¶ˆè´¹å³°å€¼å‡ºç°åœ¨ 9æ—¥(Â¥856)ï¼Œä¸»è¦æ˜¯è´­ç‰©æ”¯å‡º            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”¥ æ¶ˆè´¹çƒ­åŠ›å›¾                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚        å‘¨ä¸€  å‘¨äºŒ  å‘¨ä¸‰  å‘¨å››  å‘¨äº”  å‘¨å…­  å‘¨æ—¥               â”‚   â”‚
â”‚  â”‚   0-6   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘                    â”‚   â”‚
â”‚  â”‚   6-12  â–’â–’   â–’â–’   â–“â–“   â–’â–’   â–’â–’   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ                â”‚   â”‚
â”‚  â”‚  12-18  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ                â”‚   â”‚
â”‚  â”‚  18-24  â–“â–“   â–“â–“   â–“â–“   â–“â–“   â–ˆâ–ˆâ–ˆâ–ˆ â–“â–“     â–’â–’                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“Œ å‘¨æœ«ä¸‹åˆæ˜¯æ‚¨æ¶ˆè´¹æœ€æ´»è·ƒçš„æ—¶æ®µ                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å‘¨æ¶ˆè´¹å¯¹æ¯”                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   ç¬¬1å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,156                       â”‚   â”‚
â”‚  â”‚   ç¬¬2å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,892                 â”‚   â”‚
â”‚  â”‚   ç¬¬3å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,456  â† æœ¬å‘¨           â”‚   â”‚
â”‚  â”‚   é¢„ç®—çº¿  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Â¥2,750                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.3.2 åˆ†ç±»å æ¯” Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åˆ†ç±»å æ¯” Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ© æ”¯å‡ºåˆ†ç±»æ„æˆ                            æœ¬æœˆ Â¥8,500      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚  â”‚            â•±   ğŸ” é¤é¥®       â•²    ç‚¹å‡»åˆ†ç±»                   â”‚   â”‚
â”‚  â”‚          â•±       32%          â•²   å¯ä¸‹é’»æŸ¥çœ‹                 â”‚   â”‚
â”‚  â”‚        â•±     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â•²  å­åˆ†ç±»æ˜ç»†                 â”‚   â”‚
â”‚  â”‚       â”‚  ğŸ›’  â”‚  å…¶ä»–   â”‚  ğŸš—   â”‚                            â”‚   â”‚
â”‚  â”‚       â”‚ è´­ç‰© â”‚   12%   â”‚ äº¤é€š  â”‚                            â”‚   â”‚
â”‚  â”‚       â”‚ 25%  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  15%  â”‚                            â”‚   â”‚
â”‚  â”‚        â•²         ğŸ®           â•±                              â”‚   â”‚
â”‚  â”‚          â•²    å¨±ä¹ 10%      â•±                                â”‚   â”‚
â”‚  â”‚            â•²   ğŸ  å±…ä½    â•±                                  â”‚   â”‚
â”‚  â”‚              â•²   6%    â•±                                     â”‚   â”‚
â”‚  â”‚                â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“‹ åˆ†ç±»æ’è¡Œæ¦œ                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  1. ğŸ” é¤é¥®      Â¥2,720    32%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â†‘3%       â”‚   â”‚
â”‚  â”‚  2. ğŸ›’ è´­ç‰©      Â¥2,125    25%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â†“5%       â”‚   â”‚
â”‚  â”‚  3. ğŸš— äº¤é€š      Â¥1,275    15%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ          â†’         â”‚   â”‚
â”‚  â”‚  4. ğŸ® å¨±ä¹      Â¥850      10%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            â†‘2%       â”‚   â”‚
â”‚  â”‚  5. ğŸ  å±…ä½      Â¥510       6%   â–ˆâ–ˆâ–ˆ              â†’         â”‚   â”‚
â”‚  â”‚  6. å…¶ä»–         Â¥1,020    12%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â†’         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ é¤é¥®å æ¯”è¾ƒä¸Šæœˆå¢åŠ 3%ï¼Œå¯èƒ½éœ€è¦å…³æ³¨                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å¿…è¦ vs å¯é€‰æ¶ˆè´¹                                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¿…è¦æ¶ˆè´¹ (å¿…éœ€å“+é‡è¦æ¶ˆè´¹)                                  â”‚   â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥5,525  65%         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¯é€‰æ¶ˆè´¹ (éå¿…éœ€å“)                                         â”‚   â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,975  35%                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   âœ… æ¶ˆè´¹ç»“æ„å¥åº·ï¼Œå¯é€‰æ¶ˆè´¹å æ¯”é€‚ä¸­                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.3.3 æ´å¯Ÿåˆ†æ Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ´å¯Ÿåˆ†æ Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â˜• æ‹¿é“å› å­åˆ†æï¼ˆé«˜é¢‘å°é¢æ¶ˆè´¹ï¼‰                 è¿‘3ä¸ªæœˆ     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     ğŸ’° å¦‚æœæ¯å¤©å°‘èŠ± Â¥25ï¼Œä¸€å¹´å¯ä»¥å¤šå­˜ Â¥9,125       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  TOP é«˜é¢‘å°é¢æ¶ˆè´¹ï¼š                                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ â˜• å’–å•¡/å¥¶èŒ¶                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 45æ¬¡  â”‚  æ€»é¢: Â¥1,350  â”‚  æ—¥å‡: Â¥15        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†‘23%   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   ğŸ’¡ å‡å°‘2æ¯/å‘¨å¯å¹´çœ Â¥1,560                        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ¥¡ å¤–å–é…é€è´¹                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 62æ¬¡  â”‚  æ€»é¢: Â¥310   â”‚  å‡: Â¥5/å•         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†’                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   ğŸ’¡ è‡ªå–å¯çœé…é€è´¹ Â¥310/æœˆ                         â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ğŸª é›¶é£Ÿ/ä¾¿åˆ©åº—                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 38æ¬¡  â”‚  æ€»é¢: Â¥760   â”‚  å‡: Â¥20/æ¬¡        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†“15%                            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   âœ… è¾ƒä¸Šæœˆå‡å°‘15%ï¼Œç»§ç»­ä¿æŒï¼                       â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“º è®¢é˜…æœåŠ¡è¿½è¸ª                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æœåŠ¡åç§°      æœˆè´¹    ä¸Šæ¬¡ä½¿ç”¨    çŠ¶æ€        æ“ä½œ        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  ğŸµ éŸ³ä¹ä¼šå‘˜    Â¥15    2å¤©å‰       âœ… æ´»è·ƒ      [è¯¦æƒ…]      â”‚   â”‚
â”‚  â”‚  ğŸ“º è§†é¢‘ä¼šå‘˜    Â¥30    3ä¸ªæœˆå‰     âš ï¸ é—²ç½®     [æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚  â˜ï¸ äº‘å­˜å‚¨      Â¥6     ç»å¸¸ä½¿ç”¨    âœ… æ´»è·ƒ      [è¯¦æƒ…]      â”‚   â”‚
â”‚  â”‚  ğŸ® æ¸¸æˆä¼šå‘˜    Â¥25    1ä¸ªæœˆå‰     âš ï¸ å°‘ç”¨     [æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ’¡ å‘ç°2ä¸ªå¯èƒ½ä¸éœ€è¦çš„è®¢é˜…ï¼Œå¹´çœçº¦ Â¥660           â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                               [æŸ¥çœ‹ä¼˜åŒ–å»ºè®® â†’]     â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”® æ¶ˆè´¹é¢„æµ‹                                                 â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åŸºäºæ‚¨çš„æ¶ˆè´¹ä¹ æƒ¯ï¼Œé¢„æµ‹æœ¬æœˆæ€»æ”¯å‡ºï¼š                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚        é¢„æµ‹åŒºé—´: Â¥11,200 ~ Â¥12,800                          â”‚   â”‚
â”‚  â”‚        æœ€å¯èƒ½: Â¥12,000                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   Â¥10k  Â¥11k  Â¥12k  Â¥13k  Â¥14k                              â”‚   â”‚
â”‚  â”‚     â”‚     â”‚     â”‚     â”‚     â”‚                               â”‚   â”‚
â”‚  â”‚     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘                                â”‚   â”‚
â”‚  â”‚              â–²                                               â”‚   â”‚
â”‚  â”‚           æœ€å¯èƒ½                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  é¢„ç®—: Â¥12,000    é¢„æµ‹: Â¥12,000    çŠ¶æ€: âœ… é¢„è®¡è¾¾æ ‡        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.3.4 å¯¹æ¯”æŠ¥å‘Š Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯¹æ¯”æŠ¥å‘Š Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æœˆåº¦åŒæœŸå¯¹æ¯”                           12æœˆ vs 11æœˆ     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚         æŒ‡æ ‡         12æœˆ        11æœˆ        å˜åŒ–           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚    ğŸ’° æ€»æ”¯å‡º        Â¥8,500     Â¥9,200     â†“ Â¥700 (7.6%)    â”‚   â”‚
â”‚  â”‚    ğŸ’µ æ€»æ”¶å…¥        Â¥15,000    Â¥15,000    â†’ æŒå¹³           â”‚   â”‚
â”‚  â”‚    ğŸ“ˆ ç»“ä½™ç‡        43.3%      38.7%      â†‘ 4.6%           â”‚   â”‚
â”‚  â”‚    â±ï¸ é’±é¾„          18å¤©       14å¤©       â†‘ 4å¤©            â”‚   â”‚
â”‚  â”‚    ğŸ“… è®°è´¦å¤©æ•°      19/20      18/30      â†‘ æ”¹å–„           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                     12æœˆ           11æœˆ                      â”‚   â”‚
â”‚  â”‚  æ€»æ”¯å‡º    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚   â”‚
â”‚  â”‚  æ€»æ”¶å…¥    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚   â”‚
â”‚  â”‚  ç»“ä½™      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ              â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  âœ¨ æœ¬æœˆè´¢åŠ¡è¡¨ç°ä¼˜äºä¸Šæœˆï¼ç»“ä½™ç‡æå‡4.6%                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„è¶‹åŠ¿ï¼ˆè¿‘6ä¸ªæœˆï¼‰                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¤©                                                         â”‚   â”‚
â”‚  â”‚   30 â”¤ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€  ç›®æ ‡çº¿          â”‚   â”‚
â”‚  â”‚      â”‚                                   â—                   â”‚   â”‚
â”‚  â”‚   20 â”¤                            â—    â•±                     â”‚   â”‚
â”‚  â”‚      â”‚                     â—    â•±  â—â•±                       â”‚   â”‚
â”‚  â”‚   14 â”¤ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â—â•± â”€ â”€ â”€ â”€ â”€ â”€ â”€  ç¨³å¥è€…çº¿         â”‚   â”‚
â”‚  â”‚      â”‚            â—   â•±                                      â”‚   â”‚
â”‚  â”‚   10 â”¤      â—   â•±                                            â”‚   â”‚
â”‚  â”‚      â”‚    â•±  â—                                               â”‚   â”‚
â”‚  â”‚    7 â”¤ â— â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€  èµ·æ­¥è€…çº¿         â”‚   â”‚
â”‚  â”‚      â”‚                                                       â”‚   â”‚
â”‚  â”‚    0 â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â†’                              â”‚   â”‚
â”‚  â”‚       7æœˆ  8æœˆ  9æœˆ  10æœˆ 11æœˆ 12æœˆ                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ‰ æ­å–œï¼æ‚¨å·²ä»"èµ·æ­¥è€…"æ™‹å‡ä¸º"ç¨³å¥è€…"                       â”‚   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„æå‡è¶‹åŠ¿è‰¯å¥½ï¼Œç»§ç»­ä¿æŒå¯åœ¨2ä¸ªæœˆå†…è¾¾åˆ°"ä»å®¹è€…"        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ†š é¢„ç®—æ‰§è¡Œå¯¹æ¯”                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                    é¢„ç®—       å®é™…       è¾¾æˆç‡    çŠ¶æ€      â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  ğŸ” é¤é¥®         Â¥3,000    Â¥2,720      91%      âœ… è¾¾æ ‡    â”‚   â”‚
â”‚  â”‚  ğŸ›’ è´­ç‰©         Â¥2,000    Â¥2,125      106%     âš ï¸ è½»å¾®è¶…æ”¯â”‚   â”‚
â”‚  â”‚  ğŸš— äº¤é€š         Â¥1,500    Â¥1,275      85%      âœ… ç»“ä½™    â”‚   â”‚
â”‚  â”‚  ğŸ® å¨±ä¹         Â¥800      Â¥850        106%     âš ï¸ è½»å¾®è¶…æ”¯â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  æ•´ä½“é¢„ç®—æ‰§è¡Œç‡: 92%                                         â”‚   â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è´­ç‰©å’Œå¨±ä¹è½»å¾®è¶…æ”¯ï¼Œå»ºè®®ä¸‹æœˆé€‚å½“è°ƒæ•´é¢„ç®—åˆ†é…             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.4 é›¶åŸºé¢„ç®—é¡µé¢è®¾è®¡

#### 13.4.1 é¢„ç®—é¡µé¢æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  é›¶åŸºé¢„ç®—                                          ğŸ“… 12æœˆ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’° æœ¬æœˆæ”¶å…¥æ±                                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              Â¥15,000                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   å·²åˆ†é… Â¥12,000    â”‚    å¾…åˆ†é… Â¥3,000              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  80%                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è¿˜æœ‰ Â¥3,000 æœªåˆ†é…ï¼Œå»ºè®®åˆ†é…åˆ°åº”æ€¥é‡‘æˆ–å‚¨è“„             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¦ å°é‡‘åº“ä¸€è§ˆ                                    [+ æ–°å»º]   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ›¡ï¸ åº”æ€¥é‡‘                              ç›®æ ‡: 6ä¸ªæœˆ     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   Â¥18,000 / Â¥36,000                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  50%                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”‚ 3ä¸ªæœˆ â”‚  â”‚ 4ä¸ªæœˆ â”‚  â”‚ 6ä¸ªæœˆ â”‚  é‡Œç¨‹ç¢‘            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”‚  âœ“   â”‚  â”‚  â—‹   â”‚  â”‚  â—‹   â”‚                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   æœ¬æœˆè‡ªåŠ¨å­˜å…¥: Â¥1,500              [è°ƒæ•´åˆ†é…]        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ” é¤é¥®                                    æœˆåº¦é¢„ç®—     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å·²ç”¨ Â¥2,720 / é¢„ç®— Â¥3,000                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  91%        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å‰©ä½™ Â¥280    â”‚    å‰©ä½™12å¤©    â”‚    å»ºè®® Â¥23/å¤©     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ›’ è´­ç‰©                                    æœˆåº¦é¢„ç®—     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å·²ç”¨ Â¥2,125 / é¢„ç®— Â¥2,000         âš ï¸ è¶…æ”¯ Â¥125     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 106%      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   [ä»åº”æ€¥é‡‘å€Ÿè°ƒ]  [è°ƒæ•´å…¶ä»–é¢„ç®—]  [æ¥å—è¶…æ”¯]          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸš— äº¤é€š           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘   Â¥1,275    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ® å¨±ä¹           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘  Â¥850      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ  å±…ä½           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Â¥510      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“± é€šè®¯           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Â¥128      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â• æŸ¥çœ‹å…¨éƒ¨å°é‡‘åº“...                                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¸ å¾…åˆ†é…å»ºè®®                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  æ‚¨è¿˜æœ‰ Â¥3,000 å¾…åˆ†é…ï¼Œå»ºè®®ï¼š                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ›¡ï¸ åº”æ€¥é‡‘ +Â¥1,500 ï¼ˆè¡¥å……è‡³4ä¸ªæœˆç›®æ ‡ï¼‰                   â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ¯ å¹´åº¦æ—…è¡ŒåŸºé‡‘ +Â¥1,000                                  â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ’ è‡ªç”±æ”¯é… +Â¥500                                        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                              [ä¸€é”®åˆ†é…]    [è‡ªå®šä¹‰åˆ†é…]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.4.2 é¢„ç®—åˆ†é…å¯è§†åŒ–ç»„ä»¶

```dart
/// æ”¶å…¥æ± å¯è§†åŒ–ç»„ä»¶
class IncomePoolVisualization extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final pool = ref.watch(incomePoolProvider);

    return Column(
      children: [
        // æ€»é‡‘é¢
        Text('Â¥${pool.totalIncome.toStringAsFixed(0)}',
          style: TextStyle(fontSize: 36, fontWeight: FontWeight.bold)),
        SizedBox(height: 16),

        // åˆ†é…è¿›åº¦æ¡
        Stack(
          children: [
            // èƒŒæ™¯
            Container(
              height: 40,
              decoration: BoxDecoration(
                color: Colors.grey.shade200,
                borderRadius: BorderRadius.circular(20),
              ),
            ),
            // å·²åˆ†é…
            FractionallySizedBox(
              widthFactor: pool.allocatedPercentage,
              child: Container(
                height: 40,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.blue.shade400, Colors.green.shade400],
                  ),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Center(
                  child: Text('å·²åˆ†é… Â¥${pool.allocated.toStringAsFixed(0)}',
                    style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                ),
              ),
            ),
          ],
        ),
        SizedBox(height: 8),

        // åˆ†é¡¹è¯´æ˜
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            _buildLegend('å·²åˆ†é…', pool.allocated, Colors.blue),
            _buildLegend('å¾…åˆ†é…', pool.unallocated, Colors.grey),
          ],
        ),
      ],
    );
  }
}

/// å°é‡‘åº“å¡ç‰‡ç»„ä»¶
class VaultCard extends StatelessWidget {
  final BudgetVault vault;

  @override
  Widget build(BuildContext context) {
    final isOverspent = vault.spent > vault.allocated;
    final progress = vault.allocated > 0
        ? vault.spent / vault.allocated
        : 0.0;

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // æ ‡é¢˜è¡Œ
            Row(
              children: [
                Icon(vault.icon, color: vault.color),
                SizedBox(width: 8),
                Expanded(
                  child: Text(vault.name,
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                ),
                Text(vault.type.displayName,
                  style: TextStyle(color: Colors.grey, fontSize: 12)),
              ],
            ),
            SizedBox(height: 12),

            // é‡‘é¢æ˜¾ç¤º
            Row(
              children: [
                Text('Â¥${vault.spent.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                Text(' / Â¥${vault.allocated.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 16, color: Colors.grey)),
                Spacer(),
                if (isOverspent)
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: Colors.red.shade50,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text('è¶…æ”¯ Â¥${(vault.spent - vault.allocated).toStringAsFixed(0)}',
                      style: TextStyle(color: Colors.red, fontSize: 12)),
                  ),
              ],
            ),
            SizedBox(height: 8),

            // è¿›åº¦æ¡
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: progress.clamp(0, 1),
                backgroundColor: Colors.grey.shade200,
                valueColor: AlwaysStoppedAnimation(
                  isOverspent ? Colors.red :
                  progress > 0.9 ? Colors.orange :
                  vault.color,
                ),
                minHeight: 8,
              ),
            ),
            SizedBox(height: 8),

            // åº•éƒ¨ä¿¡æ¯
            if (vault.type == VaultType.monthly) ...[
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text('å‰©ä½™ Â¥${(vault.allocated - vault.spent).clamp(0, double.infinity).toStringAsFixed(0)}',
                    style: TextStyle(color: isOverspent ? Colors.red : Colors.green)),
                  Text('å‰©ä½™ ${vault.daysRemaining} å¤©',
                    style: TextStyle(color: Colors.grey, fontSize: 12)),
                  Text('å»ºè®® Â¥${vault.suggestedDailySpend.toStringAsFixed(0)}/å¤©',
                    style: TextStyle(color: Colors.blue, fontSize: 12)),
                ],
              ),
            ],

            // é‡Œç¨‹ç¢‘ï¼ˆç›®æ ‡å‹å°é‡‘åº“ï¼‰
            if (vault.type == VaultType.goal && vault.milestones != null) ...[
              SizedBox(height: 12),
              _buildMilestones(vault.milestones!),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildMilestones(List<Milestone> milestones) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: milestones.map((m) => Column(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: m.isReached ? Colors.green : Colors.grey.shade200,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: m.isReached
                  ? Icon(Icons.check, color: Colors.white, size: 20)
                  : Text(m.label, style: TextStyle(fontSize: 10)),
            ),
          ),
          SizedBox(height: 4),
          Text(m.label, style: TextStyle(fontSize: 10, color: Colors.grey)),
        ],
      )).toList(),
    );
  }
}
```

### 13.5 é’±é¾„ä¸“å±åˆ†æé¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  é’±é¾„åˆ†æ                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        â±ï¸                                    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                      18 å¤©                                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚              Level 3 â€¢ ç¨³å¥è€…                                â”‚   â”‚
â”‚  â”‚              "æœ‰åŠä¸ªæœˆä»¥ä¸Šçš„ç¼“å†²"                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚         â”‚ L1 â”‚ L2 â”‚ L3 â”‚ L4 â”‚ L5 â”‚                          â”‚   â”‚
â”‚  â”‚         â”‚ âœ“  â”‚ âœ“  â”‚ â˜…  â”‚ â—‹  â”‚ â—‹  â”‚                          â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚        æœˆå…‰  èµ·æ­¥  ç¨³å¥  ä»å®¹  è‡ªç”±                           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„å˜åŒ–è¶‹åŠ¿                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¤©                                                         â”‚   â”‚
â”‚  â”‚   30 â”¤                         â”Œ â”€ â”€ â”€ â”€ ç›®æ ‡:ä»å®¹è€…         â”‚   â”‚
â”‚  â”‚      â”‚                        â•±                              â”‚   â”‚
â”‚  â”‚   20 â”¤                   â—â”€â”€â—                                â”‚   â”‚
â”‚  â”‚      â”‚              â—â”€â”€â—                                     â”‚   â”‚
â”‚  â”‚   14 â”¤         â—â”€â”€â—                                          â”‚   â”‚
â”‚  â”‚      â”‚    â—â”€â”€â—                                               â”‚   â”‚
â”‚  â”‚    7 â”¤ â—                                                     â”‚   â”‚
â”‚  â”‚      â”‚                                                       â”‚   â”‚
â”‚  â”‚    0 â”¼â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â†’                                 â”‚   â”‚
â”‚  â”‚      6æœˆ 7æœˆ 8æœˆ 9æœˆ 10æœˆ11æœˆ12æœˆ                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ‰ 6ä¸ªæœˆå†…é’±é¾„ä»7å¤©å¢é•¿åˆ°18å¤©ï¼Œè¿›æ­¥æ˜¾è‘—ï¼                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¯ å‡çº§ä»»åŠ¡                                                 â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  è·ç¦»"ä»å®¹è€…"(30å¤©)è¿˜å·® 12 å¤©                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  éœ€è¦é¢å¤–å‚¨è“„: çº¦ Â¥7,200                                     â”‚   â”‚
â”‚  â”‚  (åŸºäºæ‚¨æ—¥å‡æ”¯å‡º Â¥600 è®¡ç®—)                                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  æ¨èç­–ç•¥ï¼š                                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  1. æ¯æœˆå¤šå­˜ Â¥1,200ï¼Œçº¦6ä¸ªæœˆè¾¾æˆ                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  2. å‡å°‘å¯é€‰æ¶ˆè´¹10%ï¼Œçº¦4ä¸ªæœˆè¾¾æˆ                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  3. ç»¼åˆç­–ç•¥ï¼Œçº¦3ä¸ªæœˆè¾¾æˆ â­ æ¨è                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å½±å“é’±é¾„çš„å› ç´                                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æ­£é¢å› ç´  (+)                    è´Ÿé¢å› ç´  (-)               â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚   âœ… åº”æ€¥é‡‘å‚¨å¤‡    +5å¤©          âš ï¸ é«˜é¢‘å¤–å–      -2å¤©      â”‚   â”‚
â”‚  â”‚   âœ… æ”¶å…¥ç¨³å®š      +3å¤©          âš ï¸ è®¢é˜…æœªä½¿ç”¨    -1å¤©      â”‚   â”‚
â”‚  â”‚   âœ… é¢„ç®—æ§åˆ¶è‰¯å¥½  +2å¤©          âš ï¸ æœˆæœ«é›†ä¸­æ¶ˆè´¹  -1å¤©      â”‚   â”‚
â”‚  â”‚   âœ… è®°è´¦ä¹ æƒ¯åšæŒ  +1å¤©                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å‡€å½±å“: +7å¤©                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¡ ä¸ªæ€§åŒ–å»ºè®®                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åŸºäºæ‚¨çš„æ¶ˆè´¹æ¨¡å¼ï¼Œä»¥ä¸‹æ˜¯æå‡é’±é¾„çš„å…·ä½“å»ºè®®ï¼š                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  1. å‡å°‘2æ¯/å‘¨å’–å•¡ â†’ æœˆçœ Â¥240 â†’ é’±é¾„ +0.4å¤©                â”‚   â”‚
â”‚  â”‚  2. å–æ¶ˆé—²ç½®è§†é¢‘ä¼šå‘˜ â†’ æœˆçœ Â¥30 â†’ é’±é¾„ +0.05å¤©              â”‚   â”‚
â”‚  â”‚  3. å¤–å–æ”¹è‡ªå– â†’ æœˆçœ Â¥150 â†’ é’±é¾„ +0.25å¤©                   â”‚   â”‚
â”‚  â”‚  4. è®¾ç½®è‡ªåŠ¨å‚¨è“„ Â¥500/æœˆ â†’ é’±é¾„ +0.8å¤©                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ç»„åˆæ‰§è¡Œé¢„è®¡: é’±é¾„ +1.5å¤©/æœˆ                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                                       [å¼€å§‹æ‰§è¡Œè®¡åˆ’ â†’]       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.6 è§†è§‰è§„èŒƒä¸äº¤äº’åŸåˆ™

> æ ¸å¿ƒè®¾è®¡åŸåˆ™è¯¦è§ç¬¬23ç« "[æ‡’äººè®¾è®¡åŸåˆ™](#23-æ‡’äººè®¾è®¡åŸåˆ™)"ï¼Œæœ¬èŠ‚èšç„¦äºè§†è§‰å±‚é¢çš„å…·ä½“åº”ç”¨ã€‚

| åŸåˆ™ | æè¿° | åº”ç”¨åœºæ™¯ |
|------|------|----------|
| **å³æ—¶åé¦ˆ** | æ¯ä¸ªæ“ä½œéƒ½æœ‰æ˜ç¡®çš„è§†è§‰åé¦ˆ | æŒ‰é’®ç‚¹å‡»ã€æ•°æ®ä¿å­˜ã€åŒæ­¥çŠ¶æ€ |
| **æ¸è¿›æŠ«éœ²** | æŒ‰éœ€å±•ç¤ºå¤æ‚ä¿¡æ¯ï¼ˆå¯¹åº”ç¬¬23ç« "æ¸è¿›å¼å¤æ‚åº¦åŸåˆ™"ï¼‰ | é«˜çº§è®¾ç½®ã€è¯¦ç»†æŠ¥å‘Š |
| **å®¹é”™è®¾è®¡** | å…è®¸æ’¤é”€ï¼Œé˜²æ­¢è¯¯æ“ä½œï¼ˆå¯¹åº”ç¬¬23ç« "æ™ºèƒ½é»˜è®¤åŸåˆ™"ï¼‰ | åˆ é™¤ç¡®è®¤ã€ç¼–è¾‘æ’¤é”€ |
| **ä¸€è‡´æ€§** | ç›¸åŒåŠŸèƒ½ä½¿ç”¨ç›¸åŒäº¤äº’æ¨¡å¼ | åˆ—è¡¨æ“ä½œã€è¡¨å•è®¾è®¡ |
| **æ— éšœç¢** | æ”¯æŒå„ç±»ç”¨æˆ·ä½¿ç”¨ï¼ˆè¯¦è§ç¬¬22ç« ï¼‰ | è¯­éŸ³æ§åˆ¶ã€é«˜å¯¹æ¯”åº¦ |
| **æ•°æ®å¯è§†åŒ–** | å¤æ‚æ•°æ®ç”¨å›¾è¡¨å‘ˆç° | è¶‹åŠ¿å›¾ã€é¥¼å›¾ã€çƒ­åŠ›å›¾ |
| **æ¸¸æˆåŒ–** | ç­‰çº§ã€å¾½ç« ã€è¿›åº¦æ¿€åŠ±ç”¨æˆ· | é’±é¾„ç­‰çº§ã€è¿ç»­è®°è´¦å¾½ç«  |
| **æ¸©å’Œæé†’** | é¢„è­¦è€Œéæ‰¹è¯„ï¼ˆå¯¹åº”ç¬¬24ç« "ä¼™ä¼´åŸåˆ™"ï¼‰ | è¶…æ”¯å‰é¢„è­¦ã€è®¢é˜…é—²ç½®æé†’ |

### 13.7 ä¸»é¢˜ä¸è§†è§‰

```dart
/// ä¸»é¢˜é…ç½®
class AppTheme {
  /// äº®è‰²ä¸»é¢˜
  static ThemeData light() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: Color(0xFF1976D2),
      brightness: Brightness.light,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,

      // å¡ç‰‡æ ·å¼
      cardTheme: CardTheme(
        elevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
          side: BorderSide(color: colorScheme.outlineVariant),
        ),
      ),

      // æŒ‰é’®æ ·å¼
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),

      // è¾“å…¥æ¡†æ ·å¼
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: colorScheme.surfaceContainerHighest.withOpacity(0.5),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: colorScheme.primary, width: 2),
        ),
      ),

      // åˆ—è¡¨é¡¹æ ·å¼
      listTileTheme: ListTileThemeData(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      ),
    );
  }

  /// æš—è‰²ä¸»é¢˜
  static ThemeData dark() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: Color(0xFF42A5F5),
      brightness: Brightness.dark,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,
      // ... æš—è‰²ä¸»é¢˜é…ç½®
    );
  }
}
```

### 13.8 æ ¸å¿ƒé¡µé¢å¸ƒå±€

#### 13.8.1 é¦–é¡µä»ªè¡¨ç›˜

```dart
/// é¦–é¡µä»ªè¡¨ç›˜
class DashboardPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      body: CustomScrollView(
        slivers: [
          // é¡¶éƒ¨æ¦‚è§ˆ
          SliverToBoxAdapter(
            child: _MonthlyOverviewCard(),
          ),

          // å¿«æ·æ“ä½œåŒº
          SliverToBoxAdapter(
            child: _QuickActionsRow(),
          ),

          // åŠŸèƒ½å¡ç‰‡ç½‘æ ¼
          SliverPadding(
            padding: EdgeInsets.all(16),
            sliver: SliverGrid(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                mainAxisSpacing: 16,
                crossAxisSpacing: 16,
                childAspectRatio: 1.2,
              ),
              delegate: SliverChildListDelegate([
                // é’±é¾„å¡ç‰‡
                MoneyAgeDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/money-age'),
                ),
                // é¢„ç®—å¡ç‰‡
                BudgetDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/budget'),
                ),
                // å°é‡‘åº“å¡ç‰‡
                VaultDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/vaults'),
                ),
                // è´¦æˆ·å¡ç‰‡
                AccountDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/accounts'),
                ),
              ]),
            ),
          ),

          // æœ€è¿‘äº¤æ˜“
          SliverToBoxAdapter(
            child: _RecentTransactionsSection(),
          ),
        ],
      ),

      // å¿«é€Ÿè®°è´¦æŒ‰é’®
      floatingActionButton: _ExpandableFAB(),
    );
  }
}

/// å¯å±•å¼€çš„FABï¼ˆå¿«é€Ÿè®°è´¦å…¥å£ï¼‰
class _ExpandableFAB extends StatefulWidget {
  @override
  _ExpandableFABState createState() => _ExpandableFABState();
}

class _ExpandableFABState extends State<_ExpandableFAB>
    with SingleTickerProviderStateMixin {
  bool _isOpen = false;
  late AnimationController _controller;

  @override
  Widget build(BuildContext context) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        // å±•å¼€çš„é€‰é¡¹
        if (_isOpen) ...[
          _buildOption(
            icon: Icons.mic,
            label: 'è¯­éŸ³',
            onTap: () => Navigator.pushNamed(context, '/voice-entry'),
          ),
          SizedBox(height: 8),
          _buildOption(
            icon: Icons.camera_alt,
            label: 'æ‹ç…§',
            onTap: () => Navigator.pushNamed(context, '/image-entry'),
          ),
          SizedBox(height: 8),
          _buildOption(
            icon: Icons.edit,
            label: 'æ‰‹åŠ¨',
            onTap: () => Navigator.pushNamed(context, '/manual-entry'),
          ),
          SizedBox(height: 16),
        ],

        // ä¸»æŒ‰é’®
        FloatingActionButton(
          onPressed: () => setState(() => _isOpen = !_isOpen),
          child: AnimatedRotation(
            turns: _isOpen ? 0.125 : 0,
            duration: Duration(milliseconds: 200),
            child: Icon(Icons.add),
          ),
        ),
      ],
    );
  }
}
```

### 13.9 æ‰‹åŠ¿äº¤äº’

```dart
/// äº¤æ˜“åˆ—è¡¨é¡¹ï¼ˆæ”¯æŒæ»‘åŠ¨æ“ä½œï¼‰
class TransactionListItem extends StatelessWidget {
  final Transaction transaction;
  final VoidCallback? onTap;
  final VoidCallback? onEdit;
  final VoidCallback? onDelete;

  @override
  Widget build(BuildContext context) {
    return Dismissible(
      key: Key(transaction.id),
      background: _buildSwipeBackground(
        color: Colors.blue,
        icon: Icons.edit,
        alignment: Alignment.centerLeft,
      ),
      secondaryBackground: _buildSwipeBackground(
        color: Colors.red,
        icon: Icons.delete,
        alignment: Alignment.centerRight,
      ),
      confirmDismiss: (direction) async {
        if (direction == DismissDirection.startToEnd) {
          onEdit?.call();
          return false;  // ä¸åˆ é™¤ï¼Œåªè§¦å‘ç¼–è¾‘
        } else {
          return await _showDeleteConfirm(context);
        }
      },
      onDismissed: (direction) {
        if (direction == DismissDirection.endToStart) {
          onDelete?.call();
        }
      },
      child: ListTile(
        onTap: onTap,
        leading: CategoryIcon(categoryId: transaction.categoryId),
        title: Text(transaction.description ?? 'æ— æè¿°'),
        subtitle: Text(transaction.date.format('yyyy-MM-dd')),
        trailing: AmountText(
          amount: transaction.amount,
          type: transaction.type,
        ),
      ),
    );
  }
}
```

---

## 14. å›½é™…åŒ–ä¸æœ¬åœ°åŒ–

### 14.1 æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ | ä»£ç  | çŠ¶æ€ |
|------|------|------|
| ç®€ä½“ä¸­æ–‡ | zh | âœ… å®Œæˆ |
| è‹±è¯­ | en | âœ… å®Œæˆ |
| æ—¥è¯­ | ja | âœ… å®Œæˆ |
| éŸ©è¯­ | ko | âœ… å®Œæˆ |
| ç¹ä½“ä¸­æ–‡ | zh_TW | ğŸ“‹ è§„åˆ’ |

### 14.2 æœ¬åœ°åŒ–æ–‡ä»¶ç»“æ„

```
lib/l10n/
â”œâ”€â”€ app_en.arb          # è‹±è¯­
â”œâ”€â”€ app_zh.arb          # ç®€ä½“ä¸­æ–‡
â”œâ”€â”€ app_ja.arb          # æ—¥è¯­
â””â”€â”€ app_ko.arb          # éŸ©è¯­
```

### 14.3 è´§å¸ä¸æ—¥æœŸæ ¼å¼

```dart
/// æœ¬åœ°åŒ–æ ¼å¼åŒ–æœåŠ¡
class LocalizationService {
  final Locale locale;

  LocalizationService(this.locale);

  /// è´§å¸æ ¼å¼åŒ–
  String formatCurrency(double amount, {String? currency}) {
    final format = NumberFormat.currency(
      locale: locale.toString(),
      symbol: _getCurrencySymbol(currency ?? 'CNY'),
      decimalDigits: 2,
    );
    return format.format(amount);
  }

  /// æ—¥æœŸæ ¼å¼åŒ–
  String formatDate(DateTime date, {String? pattern}) {
    final format = DateFormat(
      pattern ?? _getDefaultDatePattern(),
      locale.toString(),
    );
    return format.format(date);
  }

  /// ç›¸å¯¹æ—¶é—´
  String formatRelativeTime(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);

    if (diff.inDays == 0) {
      return S.current.today;
    } else if (diff.inDays == 1) {
      return S.current.yesterday;
    } else if (diff.inDays < 7) {
      return S.current.daysAgo(diff.inDays);
    } else {
      return formatDate(date);
    }
  }

  String _getDefaultDatePattern() {
    switch (locale.languageCode) {
      case 'zh':
        return 'yyyyå¹´MMæœˆddæ—¥';
      case 'ja':
        return 'yyyyå¹´MMæœˆddæ—¥';
      case 'ko':
        return 'yyyyë…„ MMì›” ddì¼';
      default:
        return 'MMM dd, yyyy';
    }
  }
}
```

---

## 15. å®‰å…¨ä¸éšç§

### 15.1 æ•°æ®å®‰å…¨ç­–ç•¥

| å®‰å…¨æªæ–½ | æè¿° |
|----------|------|
| **æœ¬åœ°åŠ å¯†** | SQLite æ•°æ®åº“ä½¿ç”¨ SQLCipher åŠ å¯† |
| **ä¼ è¾“åŠ å¯†** | æ‰€æœ‰ API è¯·æ±‚ä½¿ç”¨ HTTPS |
| **æ•æ„Ÿæ•°æ®ä¿æŠ¤** | å¯†ç ã€API Key ä½¿ç”¨å®‰å…¨å­˜å‚¨ |
| **ç”Ÿç‰©è¯†åˆ«** | æ”¯æŒæŒ‡çº¹/é¢å®¹è§£é”åº”ç”¨ |
| **è‡ªåŠ¨é”å®š** | åå°è¶…æ—¶è‡ªåŠ¨é”å®š |

### 15.2 éšç§ä¿æŠ¤

```dart
/// éšç§è®¾ç½®
class PrivacySettings {
  /// æ˜¯å¦å¯ç”¨åº”ç”¨é”
  bool appLockEnabled = false;

  /// é”å®šæ–¹å¼
  LockMethod lockMethod = LockMethod.pin;

  /// è‡ªåŠ¨é”å®šæ—¶é—´ï¼ˆç§’ï¼‰
  int autoLockTimeout = 300;

  /// æ˜¯å¦åœ¨æˆªå›¾æ—¶éšè—é‡‘é¢
  bool hideAmountInScreenshot = true;

  /// æ˜¯å¦å¯ç”¨éšç§æ¨¡å¼
  bool privacyModeEnabled = false;

  /// æ˜¯å¦å…è®¸æ•°æ®åˆ†æ
  bool allowAnalytics = true;

  /// æ˜¯å¦å…è®¸å´©æºƒæŠ¥å‘Š
  bool allowCrashReporting = true;
}

/// åº”ç”¨é”æœåŠ¡
class AppLockService {
  final SecureStorage _storage;
  final BiometricAuth _biometric;

  /// éªŒè¯ç”¨æˆ·
  Future<bool> authenticate() async {
    final settings = await _getSettings();

    if (!settings.appLockEnabled) return true;

    switch (settings.lockMethod) {
      case LockMethod.biometric:
        return await _biometric.authenticate(
          localizedReason: 'è¯·éªŒè¯èº«ä»½ä»¥è®¿é—®æ‚¨çš„è´¢åŠ¡æ•°æ®',
        );
      case LockMethod.pin:
        return await _showPinDialog();
      case LockMethod.pattern:
        return await _showPatternDialog();
    }
  }

  /// éšç§æ¨¡å¼ï¼ˆéšè—é‡‘é¢ï¼‰
  String maskAmount(double amount, bool isPrivacyMode) {
    if (isPrivacyMode) {
      return '****';
    }
    return amount.toStringAsFixed(2);
  }
}
```

### 15.3 æ•°æ®å¤‡ä»½ä¸æ¢å¤

```dart
/// å¤‡ä»½æœåŠ¡
class BackupService {
  /// åˆ›å»ºæœ¬åœ°å¤‡ä»½
  Future<File> createLocalBackup() async {
    final db = await DatabaseService.instance.database;
    final backupData = await _exportAllData(db);

    // å‹ç¼©åŠ å¯†
    final compressed = gzip.encode(utf8.encode(jsonEncode(backupData)));
    final encrypted = await _encrypt(compressed);

    // ä¿å­˜åˆ°æ–‡ä»¶
    final file = await _saveToFile(encrypted);
    return file;
  }

  /// æ¢å¤å¤‡ä»½
  Future<void> restoreFromBackup(File backupFile) async {
    // è¯»å–å¹¶è§£å¯†
    final encrypted = await backupFile.readAsBytes();
    final decrypted = await _decrypt(encrypted);
    final decompressed = gzip.decode(decrypted);
    final backupData = jsonDecode(utf8.decode(decompressed));

    // éªŒè¯æ•°æ®å®Œæ•´æ€§
    if (!_validateBackupData(backupData)) {
      throw BackupCorruptedException();
    }

    // å¯¼å…¥æ•°æ®
    await _importAllData(backupData);
  }

  /// äº‘ç«¯åŒæ­¥å¤‡ä»½
  Future<void> syncToCloud() async {
    final backup = await createLocalBackup();
    await _cloudStorage.upload(backup);
  }
}
```

---

## 16. ç‰ˆæœ¬è¿ç§»ç­–ç•¥

### 16.1 æ•°æ®åº“è¿ç§»

```dart
/// æ•°æ®åº“è¿ç§»ç®¡ç†
class DatabaseMigration {
  static const int currentVersion = 20;  // 2.0 ç‰ˆæœ¬æ•°æ®åº“ç‰ˆæœ¬

  /// è¿ç§»è„šæœ¬
  static final migrations = <int, Migration>{
    // 1.x -> 2.0 æ ¸å¿ƒè¿ç§»
    15: Migration(
      description: 'æ·»åŠ å°é‡‘åº“è¡¨',
      up: '''
        CREATE TABLE IF NOT EXISTS budget_vaults (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          target_amount REAL DEFAULT 0,
          allocated_amount REAL DEFAULT 0,
          spent_amount REAL DEFAULT 0,
          -- ...
        );
      ''',
    ),

    16: Migration(
      description: 'æ·»åŠ èµ„æºæ± è¡¨ï¼ˆé’±é¾„è®¡ç®—ï¼‰',
      up: '''
        CREATE TABLE IF NOT EXISTS resource_pools (
          id TEXT PRIMARY KEY,
          income_transaction_id TEXT NOT NULL,
          original_amount REAL NOT NULL,
          remaining_amount REAL NOT NULL,
          created_at TEXT NOT NULL
        );

        CREATE TABLE IF NOT EXISTS resource_consumptions (
          id TEXT PRIMARY KEY,
          pool_id TEXT NOT NULL,
          transaction_id TEXT NOT NULL,
          amount REAL NOT NULL,
          age_at_consumption INTEGER NOT NULL,
          created_at TEXT NOT NULL
        );
      ''',
    ),

    17: Migration(
      description: 'äº¤æ˜“è¡¨æ·»åŠ å°é‡‘åº“å…³è”',
      up: '''
        ALTER TABLE transactions ADD COLUMN vault_id TEXT;
      ''',
    ),

    18: Migration(
      description: 'åˆå§‹åŒ–å†å²æ•°æ®çš„èµ„æºæ± ',
      up: _initializeResourcePools,
    ),

    // ...
  };

  /// åˆå§‹åŒ–å†å²æ•°æ®çš„èµ„æºæ± 
  static Future<void> _initializeResourcePools(Database db) async {
    // è·å–æ‰€æœ‰å†å²æ”¶å…¥
    final incomes = await db.query('transactions',
      where: 'type = ?',
      whereArgs: ['income'],
      orderBy: 'date ASC',
    );

    for (final income in incomes) {
      await db.insert('resource_pools', {
        'id': generateId(),
        'income_transaction_id': income['id'],
        'original_amount': income['amount'],
        'remaining_amount': income['amount'],
        'created_at': income['date'],
      });
    }

    // é‡æ–°è®¡ç®—æ‰€æœ‰æ”¯å‡ºçš„é’±é¾„
    // ...
  }
}
```

### 16.2 åŠŸèƒ½å¼€å…³

```dart
/// åŠŸèƒ½å¼€å…³æœåŠ¡
class FeatureFlagService {
  /// 2.0 æ–°åŠŸèƒ½å¼€å…³
  static const Map<String, FeatureFlag> flags = {
    'money_age': FeatureFlag(
      name: 'é’±é¾„åˆ†æ',
      description: 'è¿½è¸ªæ‚¨èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…å‰èµšçš„',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'zero_based_budget': FeatureFlag(
      name: 'é›¶åŸºé¢„ç®—',
      description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'vaults': FeatureFlag(
      name: 'å°é‡‘åº“',
      description: 'å°†é¢„ç®—åˆ†é…åˆ°ä¸åŒçš„å°é‡‘åº“',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'smart_import': FeatureFlag(
      name: 'æ™ºèƒ½å¯¼å…¥',
      description: 'æ™ºèƒ½è§£æè´¦å•å¹¶è‡ªåŠ¨å»é‡',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  Future<bool> isEnabled(String flagName) async {
    final flag = flags[flagName];
    if (flag == null) return false;

    // æ£€æŸ¥ç‰ˆæœ¬è¦æ±‚
    final currentVersion = await _getAppVersion();
    if (!_meetsVersionRequirement(currentVersion, flag.minimumVersion)) {
      return false;
    }

    // æ£€æŸ¥ç”¨æˆ·è®¾ç½®
    final userSettings = await _getUserFeatureSettings();
    return userSettings[flagName] ?? flag.defaultEnabled;
  }
}
```

### 16.3 æ¸è¿›å¼å‡çº§å¼•å¯¼

```dart
/// å‡çº§å¼•å¯¼é¡µé¢
class UpgradeGuidePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: PageView(
        children: [
          // æ¬¢è¿é¡µ
          _WelcomePage(),

          // é’±é¾„åŠŸèƒ½ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šé’±é¾„åˆ†æ',
            description: 'äº†è§£æ‚¨èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…å‰èµšçš„ï¼Œ\nè®©è´¢åŠ¡æ›´é€æ˜',
            illustration: 'assets/illustrations/money_age.png',
          ),

          // é›¶åŸºé¢„ç®—ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šé›¶åŸºé¢„ç®—',
            description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„ï¼Œ\nå‘Šåˆ«æ— è®¡åˆ’æ¶ˆè´¹',
            illustration: 'assets/illustrations/zero_budget.png',
          ),

          // å°é‡‘åº“ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šå°é‡‘åº“',
            description: 'åƒå­˜é’±ç½ä¸€æ ·ç®¡ç†é¢„ç®—ï¼Œ\næ›´ç›´è§‚æ›´æœ‰è¶£',
            illustration: 'assets/illustrations/vaults.png',
          ),

          // å¼€å§‹ä½¿ç”¨
          _GetStartedPage(),
        ],
      ),
    );
  }
}
```

### 16.4 æ•°æ®å…¼å®¹æ€§ç­–ç•¥

#### 16.4.1 æ•°æ®å…¼å®¹æ€§åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å…¼å®¹æ€§æ ¸å¿ƒåŸåˆ™                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  åŸåˆ™ä¸€ï¼šåªå¢ä¸åˆ ï¼ˆAdditive Onlyï¼‰                                         â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“å­—æ®µåªå¢åŠ ï¼Œä¸åˆ é™¤å·²æœ‰å­—æ®µ                                       â”‚
â”‚  â”œâ”€â”€ æ–°å­—æ®µå¿…é¡»æœ‰é»˜è®¤å€¼æˆ–å…è®¸NULL                                          â”‚
â”‚  â””â”€â”€ åºŸå¼ƒå­—æ®µæ ‡è®°ä¸ºdeprecatedï¼Œä¿ç•™è‡³å°‘2ä¸ªå¤§ç‰ˆæœ¬                            â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™äºŒï¼šå‘åå…¼å®¹ï¼ˆBackward Compatibleï¼‰                                   â”‚
â”‚  â”œâ”€â”€ æ–°ç‰ˆæœ¬APPèƒ½è¯»å–æ—§ç‰ˆæœ¬æ•°æ®                                             â”‚
â”‚  â”œâ”€â”€ æ—§ç‰ˆæœ¬APPèƒ½è¯»å–æ–°ç‰ˆæœ¬æ•°æ®ï¼ˆå¿½ç•¥æœªçŸ¥å­—æ®µï¼‰                               â”‚
â”‚  â””â”€â”€ æ•°æ®æ ¼å¼å˜æ›´å¿…é¡»æä¾›è½¬æ¢å™¨                                            â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™ä¸‰ï¼šå‡çº§å‰å¤‡ä»½ï¼ˆBackup Before Upgradeï¼‰                                â”‚
â”‚  â”œâ”€â”€ é‡å¤§å‡çº§å‰è‡ªåŠ¨åˆ›å»ºæ•°æ®å¤‡ä»½                                            â”‚
â”‚  â”œâ”€â”€ å¤‡ä»½åŒ…å«å®Œæ•´æ•°æ®åº“å’Œé…ç½®                                              â”‚
â”‚  â””â”€â”€ ä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬çš„å¤‡ä»½                                                 â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™å››ï¼šæ¸è¿›å¼è¿ç§»ï¼ˆProgressive Migrationï¼‰                                â”‚
â”‚  â”œâ”€â”€ å¤§é‡æ•°æ®è¿ç§»åˆ†æ‰¹æ‰§è¡Œï¼Œé¿å…ANR                                         â”‚
â”‚  â”œâ”€â”€ è¿ç§»è¿‡ç¨‹å¯ä¸­æ–­å¯æ¢å¤                                                  â”‚
â”‚  â””â”€â”€ è¿ç§»è¿›åº¦å¯è§†åŒ–å±•ç¤º                                                   â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™äº”ï¼šæ•°æ®æ ¡éªŒï¼ˆData Validationï¼‰                                        â”‚
â”‚  â”œâ”€â”€ è¿ç§»å‰åæ•°æ®å®Œæ•´æ€§æ ¡éªŒ                                                â”‚
â”‚  â”œâ”€â”€ å…³é”®æ•°æ®ï¼ˆé‡‘é¢ã€ä½™é¢ï¼‰å¿…é¡»æ ¡éªŒä¸€è‡´                                     â”‚
â”‚  â””â”€â”€ æ ¡éªŒå¤±è´¥åˆ™å›æ»šå¹¶æŠ¥å‘Š                                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 16.4.2 æ•°æ®åº“Schemaç‰ˆæœ¬ç®¡ç†

```dart
/// Schemaç‰ˆæœ¬ç®¡ç†å™¨
class SchemaVersionManager {
  /// ç‰ˆæœ¬å†å²è®°å½•
  static const Map<int, SchemaVersion> versions = {
    1: SchemaVersion(
      version: 1,
      description: 'åˆå§‹ç‰ˆæœ¬ - åŸºç¡€è®°è´¦åŠŸèƒ½',
      releaseDate: '2025-01-01',
      tables: ['transactions', 'categories', 'accounts'],
    ),
    15: SchemaVersion(
      version: 15,
      description: '2.0 Alpha - å°é‡‘åº“æ”¯æŒ',
      releaseDate: '2025-06-01',
      tables: ['budget_vaults', 'vault_allocations'],
      addedColumns: {'transactions': ['vault_id']},
    ),
    16: SchemaVersion(
      version: 16,
      description: '2.0 Alpha - é’±é¾„è®¡ç®—',
      releaseDate: '2025-06-15',
      tables: ['resource_pools', 'resource_consumptions'],
    ),
    20: SchemaVersion(
      version: 20,
      description: '2.0 Release - å®Œæ•´åŠŸèƒ½',
      releaseDate: '2025-09-01',
      tables: ['locations', 'habits', 'achievements'],
      addedColumns: {
        'transactions': ['location_id', 'context_type'],
        'budgets': ['carry_over_enabled', 'carry_over_mode'],
      },
    ),
  };

  /// è·å–ä¸¤ä¸ªç‰ˆæœ¬é—´çš„å·®å¼‚
  static SchemaDiff getDiff(int fromVersion, int toVersion) {
    final addedTables = <String>[];
    final addedColumns = <String, List<String>>{};
    final migrations = <int>[];

    for (var v = fromVersion + 1; v <= toVersion; v++) {
      final version = versions[v];
      if (version != null) {
        addedTables.addAll(version.tables);
        version.addedColumns?.forEach((table, columns) {
          addedColumns.putIfAbsent(table, () => []).addAll(columns);
        });
        migrations.add(v);
      }
    }

    return SchemaDiff(
      fromVersion: fromVersion,
      toVersion: toVersion,
      addedTables: addedTables,
      addedColumns: addedColumns,
      requiredMigrations: migrations,
    );
  }
}

/// Schemaç‰ˆæœ¬å®šä¹‰
class SchemaVersion {
  final int version;
  final String description;
  final String releaseDate;
  final List<String> tables;
  final Map<String, List<String>>? addedColumns;
  final Map<String, List<String>>? deprecatedColumns;

  const SchemaVersion({
    required this.version,
    required this.description,
    required this.releaseDate,
    required this.tables,
    this.addedColumns,
    this.deprecatedColumns,
  });
}
```

#### 16.4.3 ç‰ˆæœ¬å‘å¸ƒå…ƒæ•°æ®

æ¯æ¬¡æ‰“åŒ…å‘å¸ƒæ—¶ï¼Œå¿…é¡»åœ¨ç‰ˆæœ¬å…ƒæ•°æ®ä¸­æ ‡æ³¨æ˜¯å¦å­˜åœ¨æ•°æ®åº“å˜åŠ¨ï¼Œç”¨äºå®¢æˆ·ç«¯æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½ã€‚

```yaml
# pubspec.yaml æˆ–ç‹¬ç«‹çš„ version_metadata.yaml
version: 1.2.23+40

# ç‰ˆæœ¬å…ƒæ•°æ®ï¼ˆæ„å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆåˆ° assets/version_metadata.jsonï¼‰
metadata:
  release_date: "2026-01-15"

  # æ•°æ®åº“å˜åŠ¨æ ‡è®°ï¼ˆå…³é”®å­—æ®µï¼‰
  database_changes: true          # æ˜¯å¦æœ‰æ•°æ®åº“å˜åŠ¨
  schema_version: 21              # ç›®æ ‡Schemaç‰ˆæœ¬
  previous_schema_version: 20     # ä¸Šä¸€ç‰ˆæœ¬Schemaç‰ˆæœ¬

  # å˜åŠ¨è¯¦æƒ…ï¼ˆç”¨äºå±•ç¤ºç»™ç”¨æˆ·ï¼‰
  migration_notes:
    - "æ–°å¢ä¹ æƒ¯è¿½è¸ªè¡¨ (habits)"
    - "äº¤æ˜“è¡¨å¢åŠ  recurring_id å­—æ®µ"

  # å¤‡ä»½å»ºè®®çº§åˆ«
  backup_level: required          # required(å¿…é¡») / recommended(å»ºè®®) / optional(å¯é€‰)

  # è¿ç§»é¢„ä¼°æ—¶é—´ï¼ˆç§’ï¼Œç”¨äºè¿›åº¦å±•ç¤ºï¼‰
  estimated_migration_time: 30

  # æœ€ä½å…¼å®¹ç‰ˆæœ¬ï¼ˆä½äºæ­¤ç‰ˆæœ¬å¿…é¡»å¼ºåˆ¶å‡çº§ï¼‰
  min_compatible_version: "1.2.0"
```

```dart
/// ç‰ˆæœ¬å…ƒæ•°æ®æ¨¡å‹
class VersionMetadata {
  final String version;
  final String releaseDate;

  /// æ•°æ®åº“å˜åŠ¨ç›¸å…³
  final bool databaseChanges;
  final int schemaVersion;
  final int previousSchemaVersion;
  final List<String> migrationNotes;
  final BackupLevel backupLevel;
  final int estimatedMigrationTime;

  /// å…¼å®¹æ€§
  final String minCompatibleVersion;

  VersionMetadata({
    required this.version,
    required this.releaseDate,
    required this.databaseChanges,
    required this.schemaVersion,
    required this.previousSchemaVersion,
    this.migrationNotes = const [],
    this.backupLevel = BackupLevel.optional,
    this.estimatedMigrationTime = 0,
    required this.minCompatibleVersion,
  });

  factory VersionMetadata.fromJson(Map<String, dynamic> json) {
    return VersionMetadata(
      version: json['version'] as String,
      releaseDate: json['release_date'] as String,
      databaseChanges: json['database_changes'] as bool? ?? false,
      schemaVersion: json['schema_version'] as int,
      previousSchemaVersion: json['previous_schema_version'] as int,
      migrationNotes: (json['migration_notes'] as List<dynamic>?)
          ?.cast<String>() ?? [],
      backupLevel: BackupLevel.fromString(json['backup_level'] as String?),
      estimatedMigrationTime: json['estimated_migration_time'] as int? ?? 0,
      minCompatibleVersion: json['min_compatible_version'] as String,
    );
  }

  /// æ˜¯å¦éœ€è¦å¤‡ä»½
  bool get requiresBackup =>
    databaseChanges || backupLevel == BackupLevel.required;

  /// æ˜¯å¦å»ºè®®å¤‡ä»½
  bool get shouldBackup =>
    requiresBackup || backupLevel == BackupLevel.recommended;
}

enum BackupLevel {
  required,     // å¿…é¡»å¤‡ä»½ï¼ˆæœ‰æ•°æ®åº“å˜åŠ¨ï¼‰
  recommended,  // å»ºè®®å¤‡ä»½ï¼ˆé‡å¤§åŠŸèƒ½æ›´æ–°ï¼‰
  optional;     // å¯é€‰å¤‡ä»½ï¼ˆå°ç‰ˆæœ¬æ›´æ–°ï¼‰

  static BackupLevel fromString(String? value) {
    switch (value) {
      case 'required': return BackupLevel.required;
      case 'recommended': return BackupLevel.recommended;
      default: return BackupLevel.optional;
    }
  }
}

/// æ„å»ºè„šæœ¬ï¼šè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å…ƒæ•°æ®
/// åœ¨ scripts/build.dart ä¸­è°ƒç”¨
class VersionMetadataGenerator {
  /// ç”Ÿæˆç‰ˆæœ¬å…ƒæ•°æ®æ–‡ä»¶
  static Future<void> generate({
    required String version,
    required int buildNumber,
    required bool hasDatabaseChanges,
    required int schemaVersion,
    List<String>? migrationNotes,
  }) async {
    // è¯»å–ä¸Šä¸€ç‰ˆæœ¬çš„ schema_version
    final previousMetadata = await _loadPreviousMetadata();
    final previousSchemaVersion = previousMetadata?.schemaVersion ?? schemaVersion;

    final metadata = {
      'version': version,
      'build_number': buildNumber,
      'release_date': DateTime.now().toIso8601String().substring(0, 10),
      'database_changes': hasDatabaseChanges,
      'schema_version': schemaVersion,
      'previous_schema_version': previousSchemaVersion,
      'migration_notes': migrationNotes ?? [],
      'backup_level': hasDatabaseChanges ? 'required' : 'optional',
      'estimated_migration_time': hasDatabaseChanges ? _estimateMigrationTime() : 0,
      'min_compatible_version': '1.2.0',
    };

    final file = File('app/assets/version_metadata.json');
    await file.writeAsString(JsonEncoder.withIndent('  ').convert(metadata));

    print('âœ“ å·²ç”Ÿæˆ version_metadata.json');
    if (hasDatabaseChanges) {
      print('  âš ï¸ æ­¤ç‰ˆæœ¬åŒ…å«æ•°æ®åº“å˜åŠ¨ï¼Œå‡çº§æ—¶å°†è§¦å‘å¤‡ä»½');
    }
  }
}
```

#### 16.4.4 æ™ºèƒ½å‡çº§å¤‡ä»½ç­–ç•¥

åŸºäºç‰ˆæœ¬å…ƒæ•°æ®ï¼Œæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨å‡çº§å‰è¿›è¡Œå¤‡ä»½ï¼Œé¿å…æ— æ•ˆå¤‡ä»½ã€‚

**å¤‡ä»½å­˜å‚¨ä½ç½®è¯´æ˜ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤‡ä»½å­˜å‚¨ç­–ç•¥                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  å¤‡ä»½ç±»å‹            å­˜å‚¨ä½ç½®        ç”¨é€”                  ä¿ç•™ç­–ç•¥        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  å‡çº§å¤‡ä»½            æœ¬åœ°            å‡çº§å¤±è´¥å¿«é€Ÿå›æ»š      ä¿ç•™æœ€è¿‘3ä¸ª      â”‚
â”‚  æ‰‹åŠ¨å¤‡ä»½            æœ¬åœ°+äº‘ç«¯       ç”¨æˆ·ä¸»åŠ¨å¤‡ä»½          ç”¨æˆ·è‡ªå®šä¹‰       â”‚
â”‚  è‡ªåŠ¨å®šæœŸå¤‡ä»½        äº‘ç«¯            æ•°æ®å®‰å…¨/æ¢æœºæ¢å¤     æœ€è¿‘7å¤©+æœˆå¤‡ä»½   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å‡çº§å¤‡ä»½é€‰æ‹©ã€æœ¬åœ°ã€‘çš„åŸå› ï¼š                                      â”‚    â”‚
â”‚  â”‚  â€¢ é€Ÿåº¦å¿«ï¼šæœ¬åœ°IOæ— ç½‘ç»œå»¶è¿Ÿï¼Œå‡çº§ä½“éªŒæµç•…                         â”‚    â”‚
â”‚  â”‚  â€¢ ç¦»çº¿å¯ç”¨ï¼šæ— ç½‘ç»œæ—¶ä¹Ÿèƒ½å®Œæˆå‡çº§                                 â”‚    â”‚
â”‚  â”‚  â€¢ ä¸´æ—¶æ€§ï¼šä»…ç”¨äºå‡çº§å›æ»šï¼ŒæˆåŠŸåå¯æ¸…ç†                           â”‚    â”‚
â”‚  â”‚  â€¢ éšç§å®‰å…¨ï¼šæ•æ„Ÿæ•°æ®ä¸ç»è¿‡ç½‘ç»œä¼ è¾“                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  äº‘ç«¯å¤‡ä»½çš„è§¦å‘æ—¶æœºï¼š                                              â”‚    â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"å¤‡ä»½åˆ°äº‘ç«¯"                                        â”‚    â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨å®šæœŸå¤‡ä»½ï¼ˆå¯åœ¨è®¾ç½®ä¸­å¼€å¯ï¼Œé»˜è®¤å…³é—­ï¼‰                        â”‚    â”‚
â”‚  â”‚  â€¢ æ¢æœºæ¢å¤æµç¨‹ä¸­ä»äº‘ç«¯æ‹‰å–                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ™ºèƒ½å¤‡ä»½å†³ç­–æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ™ºèƒ½å¤‡ä»½å†³ç­–æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬å¯ç”¨                                                       â”‚
â”‚       â†“                                                                   â”‚
â”‚  2. ä¸‹è½½æ–°ç‰ˆæœ¬çš„ version_metadata.json                                    â”‚
â”‚       â†“                                                                   â”‚
â”‚  3. æ£€æŸ¥ database_changes å­—æ®µ                                            â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ database_changes â”‚                   å¤„ç†æ–¹å¼                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚     true       â”‚ æœ¬åœ°å¤‡ä»½ â†’ æ˜¾ç¤ºå¤‡ä»½è¿›åº¦ â†’ æ‰§è¡Œè¿ç§»               â”‚   â”‚
â”‚  â”‚     false      â”‚ è·³è¿‡å¤‡ä»½ â†’ ç›´æ¥å®‰è£…æ›´æ–°                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  4. ç”¨æˆ·å¯é€‰æ‹©æ‰‹åŠ¨å¤‡ä»½ï¼ˆè®¾ç½® â†’ æ•°æ®å¤‡ä»½ â†’ å¤‡ä»½åˆ°äº‘ç«¯ï¼‰                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// æ™ºèƒ½å‡çº§æœåŠ¡
class SmartUpgradeService {
  final UpgradeBackupService _backupService;
  final HttpService _http;

  /// æ£€æŸ¥å‡çº§å¹¶å†³å®šæ˜¯å¦éœ€è¦å¤‡ä»½
  Future<UpgradeDecision> checkUpgrade() async {
    // 1. è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
    final currentVersion = BuildInfo.version;
    final currentSchemaVersion = await _db.getSchemaVersion();

    // 2. ä»æœåŠ¡å™¨è·å–æœ€æ–°ç‰ˆæœ¬å…ƒæ•°æ®
    final latestMetadata = await _fetchLatestVersionMetadata();

    if (latestMetadata == null) {
      return UpgradeDecision.noUpdate();
    }

    // 3. æ¯”è¾ƒç‰ˆæœ¬
    if (!_isNewerVersion(latestMetadata.version, currentVersion)) {
      return UpgradeDecision.noUpdate();
    }

    // 4. åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½
    final needsBackup = latestMetadata.databaseChanges ||
        latestMetadata.schemaVersion > currentSchemaVersion;

    return UpgradeDecision(
      hasUpdate: true,
      currentVersion: currentVersion,
      newVersion: latestMetadata.version,
      needsBackup: needsBackup,
      backupLevel: latestMetadata.backupLevel,
      migrationNotes: latestMetadata.migrationNotes,
      estimatedMigrationTime: latestMetadata.estimatedMigrationTime,
    );
  }

  /// æ‰§è¡Œå‡çº§ï¼ˆæ ¹æ®å†³ç­–è‡ªåŠ¨å¤„ç†å¤‡ä»½ï¼‰
  Stream<UpgradeProgress> executeUpgrade(UpgradeDecision decision) async* {
    if (decision.needsBackup) {
      // éœ€è¦å¤‡ä»½ï¼šæ˜¾ç¤ºå¤‡ä»½é˜¶æ®µ
      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'æ­£åœ¨å¤‡ä»½æ•°æ®...',
        progress: 0.1,
      );

      final backupResult = await _backupService.createUpgradeBackup(
        fromVersion: decision.currentVersion,
        toVersion: decision.newVersion,
      );

      if (!backupResult.isSuccess) {
        yield UpgradeProgress(
          phase: UpgradePhase.failed,
          message: 'å¤‡ä»½å¤±è´¥: ${backupResult.error}',
        );
        return;
      }

      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'å¤‡ä»½å®Œæˆ',
        progress: 0.2,
      );
    } else {
      // æ— éœ€å¤‡ä»½ï¼šç›´æ¥è¿›å…¥å®‰è£…é˜¶æ®µ
      yield UpgradeProgress(
        phase: UpgradePhase.installing,
        message: 'æ— æ•°æ®åº“å˜åŠ¨ï¼Œè·³è¿‡å¤‡ä»½',
        progress: 0.2,
      );
    }

    // ç»§ç»­æ‰§è¡Œå®‰è£…å’Œè¿ç§»...
    yield* _executeInstallAndMigrate(decision);
  }

  /// è·å–æœ€æ–°ç‰ˆæœ¬å…ƒæ•°æ®
  Future<VersionMetadata?> _fetchLatestVersionMetadata() async {
    try {
      final response = await _http.get('/api/app-versions/latest/metadata');
      if (response.isSuccess) {
        return VersionMetadata.fromJson(response.data);
      }
    } catch (_) {}
    return null;
  }
}

/// å‡çº§å†³ç­–
class UpgradeDecision {
  final bool hasUpdate;
  final String currentVersion;
  final String newVersion;
  final bool needsBackup;
  final BackupLevel backupLevel;
  final List<String> migrationNotes;
  final int estimatedMigrationTime;

  UpgradeDecision({
    required this.hasUpdate,
    this.currentVersion = '',
    this.newVersion = '',
    this.needsBackup = false,
    this.backupLevel = BackupLevel.optional,
    this.migrationNotes = const [],
    this.estimatedMigrationTime = 0,
  });

  factory UpgradeDecision.noUpdate() => UpgradeDecision(hasUpdate: false);

  /// å‡çº§æè¿°ï¼ˆå±•ç¤ºç»™ç”¨æˆ·ï¼‰
  String get description {
    if (!hasUpdate) return 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';

    final buffer = StringBuffer('å‘ç°æ–°ç‰ˆæœ¬ $newVersion\n');

    if (needsBackup) {
      buffer.writeln('âš ï¸ æ­¤ç‰ˆæœ¬åŒ…å«æ•°æ®åº“å˜åŠ¨ï¼Œå‡çº§å‰å°†è‡ªåŠ¨å¤‡ä»½');
    }

    if (migrationNotes.isNotEmpty) {
      buffer.writeln('\næ›´æ–°å†…å®¹ï¼š');
      for (final note in migrationNotes) {
        buffer.writeln('â€¢ $note');
      }
    }

    if (estimatedMigrationTime > 0) {
      buffer.writeln('\né¢„è®¡è¿ç§»æ—¶é—´ï¼šçº¦ ${estimatedMigrationTime} ç§’');
    }

    return buffer.toString();
  }
}
```

```dart
/// å‡çº§å¤‡ä»½æœåŠ¡
class UpgradeBackupService {
  final DatabaseService _db;
  final FileService _fileService;

  /// å¤‡ä»½ç›®å½•
  static const String backupDir = 'backups/upgrade';

  /// æœ€å¤§ä¿ç•™å¤‡ä»½æ•°
  static const int maxBackups = 3;

  /// æ™ºèƒ½å¤‡ä»½ï¼šä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ
  Future<BackupResult?> smartBackup({
    required UpgradeDecision decision,
  }) async {
    // ä¸éœ€è¦å¤‡ä»½æ—¶ç›´æ¥è¿”å›
    if (!decision.needsBackup) {
      return null;  // null è¡¨ç¤ºè·³è¿‡å¤‡ä»½
    }

    return createUpgradeBackup(
      fromVersion: decision.currentVersion,
      toVersion: decision.newVersion,
    );
  }

  /// æ‰§è¡Œå‡çº§å‰å¤‡ä»½
  Future<BackupResult> createUpgradeBackup({
    required String fromVersion,
    required String toVersion,
  }) async {
    final backupId = '${fromVersion}_to_${toVersion}_${DateTime.now().millisecondsSinceEpoch}';
    final backupPath = '$backupDir/$backupId';

    try {
      // 1. åˆ›å»ºå¤‡ä»½ç›®å½•
      await _fileService.createDirectory(backupPath);

      // 2. å¤‡ä»½æ•°æ®åº“
      final dbBackupPath = '$backupPath/database.db';
      await _db.backup(dbBackupPath);

      // 3. å¤‡ä»½é…ç½®æ–‡ä»¶
      final configBackupPath = '$backupPath/config.json';
      await _backupConfig(configBackupPath);

      // 4. è®°å½•å¤‡ä»½å…ƒä¿¡æ¯
      final metadata = BackupMetadata(
        id: backupId,
        fromVersion: fromVersion,
        toVersion: toVersion,
        createdAt: DateTime.now(),
        dbSize: await _fileService.getFileSize(dbBackupPath),
        tables: await _getTableCounts(),
      );
      await _saveMetadata('$backupPath/metadata.json', metadata);

      // 5. æ¸…ç†æ—§å¤‡ä»½
      await _cleanupOldBackups();

      return BackupResult.success(
        backupId: backupId,
        path: backupPath,
        metadata: metadata,
      );
    } catch (e) {
      return BackupResult.failed(error: e);
    }
  }

  /// ä»å¤‡ä»½æ¢å¤
  Future<RestoreResult> restoreFromBackup(String backupId) async {
    final backupPath = '$backupDir/$backupId';

    // 1. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
    if (!await _validateBackup(backupPath)) {
      return RestoreResult.failed(error: 'å¤‡ä»½æ–‡ä»¶æŸåæˆ–ä¸å®Œæ•´');
    }

    // 2. å…³é—­å½“å‰æ•°æ®åº“è¿æ¥
    await _db.close();

    // 3. æ¢å¤æ•°æ®åº“
    await _fileService.copy(
      '$backupPath/database.db',
      _db.databasePath,
    );

    // 4. æ¢å¤é…ç½®
    await _restoreConfig('$backupPath/config.json');

    // 5. é‡æ–°æ‰“å¼€æ•°æ®åº“
    await _db.open();

    return RestoreResult.success(restoredVersion: backupId);
  }

  /// è·å–å¯ç”¨å¤‡ä»½åˆ—è¡¨
  Future<List<BackupMetadata>> getAvailableBackups() async {
    final backups = <BackupMetadata>[];
    final dirs = await _fileService.listDirectories(backupDir);

    for (final dir in dirs) {
      try {
        final metadata = await _loadMetadata('$dir/metadata.json');
        backups.add(metadata);
      } catch (_) {
        // å¿½ç•¥æ— æ•ˆå¤‡ä»½
      }
    }

    return backups..sort((a, b) => b.createdAt.compareTo(a.createdAt));
  }
}

/// å¤‡ä»½å…ƒæ•°æ®
class BackupMetadata {
  final String id;
  final String fromVersion;
  final String toVersion;
  final DateTime createdAt;
  final int dbSize;
  final Map<String, int> tables; // è¡¨å -> è®°å½•æ•°

  BackupMetadata({
    required this.id,
    required this.fromVersion,
    required this.toVersion,
    required this.createdAt,
    required this.dbSize,
    required this.tables,
  });

  /// å¤‡ä»½æè¿°
  String get description =>
    'ä» v$fromVersion å‡çº§åˆ° v$toVersion (${createdAt.toString().substring(0, 16)})';
}

/// å¤‡ä»½å­˜å‚¨ä½ç½®
enum BackupStorage {
  local,   // æœ¬åœ°å­˜å‚¨ï¼ˆå‡çº§å¤‡ä»½ï¼‰
  cloud,   // äº‘ç«¯å­˜å‚¨ï¼ˆæ‰‹åŠ¨/å®šæœŸå¤‡ä»½ï¼‰
  both,    // æœ¬åœ°+äº‘ç«¯ï¼ˆæ‰‹åŠ¨å¤‡ä»½å¯é€‰ï¼‰
}

/// ç»Ÿä¸€å¤‡ä»½æœåŠ¡ï¼ˆæ”¯æŒæœ¬åœ°å’Œäº‘ç«¯ï¼‰
class UnifiedBackupService {
  final UpgradeBackupService _localBackup;
  final CloudBackupService _cloudBackup;

  /// åˆ›å»ºå¤‡ä»½
  Future<BackupResult> createBackup({
    required BackupStorage storage,
    String? description,
  }) async {
    switch (storage) {
      case BackupStorage.local:
        return _localBackup.createManualBackup(description: description);

      case BackupStorage.cloud:
        // å…ˆåˆ›å»ºæœ¬åœ°ä¸´æ—¶å¤‡ä»½ï¼Œå†ä¸Šä¼ åˆ°äº‘ç«¯
        final localResult = await _localBackup.createManualBackup(
          description: description,
          temporary: true,
        );
        if (!localResult.isSuccess) return localResult;

        final cloudResult = await _cloudBackup.upload(localResult.path!);
        // ä¸Šä¼ æˆåŠŸååˆ é™¤ä¸´æ—¶æœ¬åœ°å¤‡ä»½
        if (cloudResult.isSuccess) {
          await _localBackup.deleteBackup(localResult.backupId!);
        }
        return cloudResult;

      case BackupStorage.both:
        // æœ¬åœ°ä¿ç•™ä¸€ä»½ï¼Œäº‘ç«¯ä¸Šä¼ ä¸€ä»½
        final localResult = await _localBackup.createManualBackup(
          description: description,
        );
        if (localResult.isSuccess) {
          // å¼‚æ­¥ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œä¸é˜»å¡
          _cloudBackup.upload(localResult.path!).catchError((e) {
            // äº‘ç«¯ä¸Šä¼ å¤±è´¥ä¸å½±å“æœ¬åœ°å¤‡ä»½
            _logger.warning('äº‘ç«¯å¤‡ä»½ä¸Šä¼ å¤±è´¥: $e');
          });
        }
        return localResult;
    }
  }

  /// è·å–æ‰€æœ‰å¯ç”¨å¤‡ä»½ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
  Future<List<BackupInfo>> getAllBackups() async {
    final localBackups = await _localBackup.getAvailableBackups();
    final cloudBackups = await _cloudBackup.listBackups();

    return [
      ...localBackups.map((b) => BackupInfo.fromLocal(b)),
      ...cloudBackups.map((b) => BackupInfo.fromCloud(b)),
    ]..sort((a, b) => b.createdAt.compareTo(a.createdAt));
  }
}

/// äº‘ç«¯å¤‡ä»½æœåŠ¡
class CloudBackupService {
  final HttpService _http;
  final AuthService _auth;

  /// ä¸Šä¼ å¤‡ä»½åˆ°äº‘ç«¯
  Future<BackupResult> upload(String localPath) async {
    try {
      // 1. å‹ç¼©å¤‡ä»½æ–‡ä»¶
      final compressedPath = await _compress(localPath);

      // 2. è·å–ä¸Šä¼ å‡­è¯
      final uploadToken = await _http.post('/api/backups/upload-token');

      // 3. åˆ†ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰
      final result = await _uploadWithProgress(
        filePath: compressedPath,
        uploadUrl: uploadToken.data['url'],
      );

      // 4. é€šçŸ¥æœåŠ¡å™¨ä¸Šä¼ å®Œæˆ
      await _http.post('/api/backups/complete', body: {
        'backup_id': result.backupId,
        'size': result.size,
        'checksum': result.checksum,
      });

      return BackupResult.success(
        backupId: result.backupId,
        storage: BackupStorage.cloud,
      );
    } catch (e) {
      return BackupResult.failed(error: e);
    }
  }

  /// ä»äº‘ç«¯æ¢å¤
  Future<RestoreResult> restore(String cloudBackupId) async {
    try {
      // 1. è·å–ä¸‹è½½é“¾æ¥
      final downloadInfo = await _http.get('/api/backups/$cloudBackupId/download');

      // 2. ä¸‹è½½åˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•
      final localPath = await _downloadWithProgress(
        url: downloadInfo.data['url'],
        expectedSize: downloadInfo.data['size'],
      );

      // 3. è§£å‹
      final extractedPath = await _extract(localPath);

      // 4. æ¢å¤æ•°æ®åº“
      return _localBackup.restoreFromPath(extractedPath);
    } catch (e) {
      return RestoreResult.failed(error: e);
    }
  }

  /// è·å–äº‘ç«¯å¤‡ä»½åˆ—è¡¨
  Future<List<CloudBackupMetadata>> listBackups() async {
    final response = await _http.get('/api/backups');
    return (response.data as List)
        .map((json) => CloudBackupMetadata.fromJson(json))
        .toList();
  }

  /// åˆ é™¤äº‘ç«¯å¤‡ä»½
  Future<void> deleteBackup(String backupId) async {
    await _http.delete('/api/backups/$backupId');
  }
}

/// äº‘ç«¯å¤‡ä»½å…ƒæ•°æ®
class CloudBackupMetadata {
  final String id;
  final String version;
  final DateTime createdAt;
  final int size;
  final String? description;
  final String deviceName;

  CloudBackupMetadata({
    required this.id,
    required this.version,
    required this.createdAt,
    required this.size,
    this.description,
    required this.deviceName,
  });
}
```

#### 16.4.5 æ¸è¿›å¼æ•°æ®è¿ç§»

```dart
/// æ¸è¿›å¼è¿ç§»æ‰§è¡Œå™¨
class ProgressiveMigrationExecutor {
  final DatabaseService _db;
  final Logger _logger;

  /// æ¯æ‰¹å¤„ç†è®°å½•æ•°
  static const int batchSize = 500;

  /// æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  static const int batchDelayMs = 50;

  /// æ‰§è¡Œå¸¦è¿›åº¦çš„è¿ç§»
  Stream<MigrationProgress> executeMigration(Migration migration) async* {
    final totalRecords = await _getTotalRecords(migration);
    var processedRecords = 0;
    var currentBatch = 0;

    yield MigrationProgress(
      phase: MigrationPhase.starting,
      total: totalRecords,
      processed: 0,
      message: 'å¼€å§‹è¿ç§»: ${migration.description}',
    );

    try {
      while (processedRecords < totalRecords) {
        // å¤„ç†ä¸€æ‰¹æ•°æ®
        final batchResult = await _processBatch(
          migration: migration,
          offset: processedRecords,
          limit: batchSize,
        );

        processedRecords += batchResult.processedCount;
        currentBatch++;

        yield MigrationProgress(
          phase: MigrationPhase.processing,
          total: totalRecords,
          processed: processedRecords,
          message: 'æ­£åœ¨è¿ç§»æ•°æ® ($processedRecords/$totalRecords)',
        );

        // æ‰¹æ¬¡é—´çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…é˜»å¡UI
        if (processedRecords < totalRecords) {
          await Future.delayed(Duration(milliseconds: batchDelayMs));
        }

        // ä¿å­˜è¿ç§»æ–­ç‚¹ï¼ˆæ”¯æŒä¸­æ–­æ¢å¤ï¼‰
        await _saveCheckpoint(migration.version, processedRecords);
      }

      // æ¸…ç†æ–­ç‚¹
      await _clearCheckpoint(migration.version);

      yield MigrationProgress(
        phase: MigrationPhase.completed,
        total: totalRecords,
        processed: processedRecords,
        message: 'è¿ç§»å®Œæˆ',
      );
    } catch (e, stackTrace) {
      _logger.error('Migration failed at batch $currentBatch',
        error: e, stackTrace: stackTrace);

      yield MigrationProgress(
        phase: MigrationPhase.failed,
        total: totalRecords,
        processed: processedRecords,
        message: 'è¿ç§»å¤±è´¥: $e',
        error: e,
      );
    }
  }

  /// ä»æ–­ç‚¹æ¢å¤è¿ç§»
  Future<int?> getCheckpoint(int migrationVersion) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getInt('migration_checkpoint_$migrationVersion');
  }

  /// æ¢å¤ä¸­æ–­çš„è¿ç§»
  Stream<MigrationProgress> resumeMigration(Migration migration) async* {
    final checkpoint = await getCheckpoint(migration.version);

    if (checkpoint == null) {
      // æ— æ–­ç‚¹ï¼Œä»å¤´å¼€å§‹
      yield* executeMigration(migration);
      return;
    }

    yield MigrationProgress(
      phase: MigrationPhase.resuming,
      processed: checkpoint,
      message: 'ä»æ–­ç‚¹æ¢å¤è¿ç§» (å·²å¤„ç† $checkpoint æ¡)',
    );

    // ç»§ç»­è¿ç§»...
    // ï¼ˆå®ç°ä¸executeMigrationç±»ä¼¼ï¼Œä½†ä»checkpointå¼€å§‹ï¼‰
  }
}

/// è¿ç§»è¿›åº¦
class MigrationProgress {
  final MigrationPhase phase;
  final int? total;
  final int processed;
  final String message;
  final Object? error;

  MigrationProgress({
    required this.phase,
    this.total,
    required this.processed,
    required this.message,
    this.error,
  });

  /// è¿›åº¦ç™¾åˆ†æ¯”
  double get percentage =>
    total != null && total! > 0 ? processed / total! : 0;
}

enum MigrationPhase {
  starting,
  resuming,
  processing,
  completed,
  failed,
}
```

#### 16.4.6 æ•°æ®å®Œæ•´æ€§æ ¡éªŒ

```dart
/// æ•°æ®å®Œæ•´æ€§æ ¡éªŒæœåŠ¡
class DataIntegrityValidator {
  final DatabaseService _db;

  /// æ‰§è¡Œå®Œæ•´æ€§æ ¡éªŒ
  Future<ValidationResult> validate() async {
    final errors = <ValidationError>[];

    // 1. å¤–é”®å®Œæ•´æ€§
    errors.addAll(await _validateForeignKeys());

    // 2. é‡‘é¢ä¸€è‡´æ€§ï¼ˆè´¦æˆ·ä½™é¢ = æ”¶å…¥ - æ”¯å‡ºï¼‰
    errors.addAll(await _validateAccountBalances());

    // 3. é¢„ç®—æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§
    errors.addAll(await _validateBudgetData());

    // 4. èµ„æºæ± æ•°æ®ä¸€è‡´æ€§ï¼ˆé’±é¾„è®¡ç®—ï¼‰
    errors.addAll(await _validateResourcePools());

    // 5. æ—¶é—´æˆ³åˆç†æ€§
    errors.addAll(await _validateTimestamps());

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
      checkedAt: DateTime.now(),
    );
  }

  /// æ ¡éªŒè´¦æˆ·ä½™é¢
  Future<List<ValidationError>> _validateAccountBalances() async {
    final errors = <ValidationError>[];

    final accounts = await _db.query('accounts');
    for (final account in accounts) {
      final accountId = account['id'] as String;
      final recordedBalance = account['balance'] as double;

      // è®¡ç®—å®é™…ä½™é¢
      final incomeSum = await _db.rawQuery('''
        SELECT COALESCE(SUM(amount), 0) as total
        FROM transactions
        WHERE account_id = ? AND type = 'income'
      ''', [accountId]);

      final expenseSum = await _db.rawQuery('''
        SELECT COALESCE(SUM(amount), 0) as total
        FROM transactions
        WHERE account_id = ? AND type = 'expense'
      ''', [accountId]);

      final calculatedBalance =
        (incomeSum.first['total'] as num) - (expenseSum.first['total'] as num);

      // å…è®¸0.01çš„æµ®ç‚¹è¯¯å·®
      if ((recordedBalance - calculatedBalance).abs() > 0.01) {
        errors.add(ValidationError(
          type: ValidationErrorType.balanceMismatch,
          table: 'accounts',
          recordId: accountId,
          message: 'è´¦æˆ·ä½™é¢ä¸ä¸€è‡´: è®°å½•=$recordedBalance, è®¡ç®—=$calculatedBalance',
          severity: ValidationSeverity.critical,
          autoFix: () async {
            await _db.update('accounts',
              {'balance': calculatedBalance},
              where: 'id = ?',
              whereArgs: [accountId],
            );
          },
        ));
      }
    }

    return errors;
  }

  /// æ ¡éªŒèµ„æºæ± ï¼ˆé’±é¾„è®¡ç®—æ•°æ®ï¼‰
  Future<List<ValidationError>> _validateResourcePools() async {
    final errors = <ValidationError>[];

    // æ£€æŸ¥èµ„æºæ± æ€»é¢æ˜¯å¦ç­‰äºæ”¶å…¥æ€»é¢
    final poolTotal = await _db.rawQuery('''
      SELECT COALESCE(SUM(original_amount), 0) as total FROM resource_pools
    ''');

    final incomeTotal = await _db.rawQuery('''
      SELECT COALESCE(SUM(amount), 0) as total FROM transactions WHERE type = 'income'
    ''');

    final poolSum = poolTotal.first['total'] as num;
    final incomeSum = incomeTotal.first['total'] as num;

    if ((poolSum - incomeSum).abs() > 0.01) {
      errors.add(ValidationError(
        type: ValidationErrorType.resourcePoolMismatch,
        table: 'resource_pools',
        message: 'èµ„æºæ± æ€»é¢ä¸æ”¶å…¥æ€»é¢ä¸ä¸€è‡´: èµ„æºæ± =$poolSum, æ”¶å…¥=$incomeSum',
        severity: ValidationSeverity.warning,
        autoFix: () async => await _rebuildResourcePools(),
      ));
    }

    // æ£€æŸ¥æ¶ˆè€—è®°å½•æ˜¯å¦è¶…è¿‡èµ„æºæ± å‰©ä½™
    final overConsumedPools = await _db.rawQuery('''
      SELECT p.id, p.original_amount, p.remaining_amount,
             COALESCE(SUM(c.amount), 0) as consumed
      FROM resource_pools p
      LEFT JOIN resource_consumptions c ON p.id = c.pool_id
      GROUP BY p.id
      HAVING p.original_amount - consumed != p.remaining_amount
    ''');

    for (final pool in overConsumedPools) {
      errors.add(ValidationError(
        type: ValidationErrorType.resourcePoolMismatch,
        table: 'resource_pools',
        recordId: pool['id'] as String,
        message: 'èµ„æºæ± å‰©ä½™é‡‘é¢è®¡ç®—é”™è¯¯',
        severity: ValidationSeverity.warning,
      ));
    }

    return errors;
  }

  /// å‡çº§åæ ¡éªŒ
  Future<PostUpgradeValidation> validateAfterUpgrade({
    required BackupMetadata backup,
  }) async {
    // å¯¹æ¯”å‡çº§å‰åçš„å…³é”®æŒ‡æ ‡
    final currentCounts = await _getTableCounts();

    final mismatches = <String, TableCountMismatch>{};

    // æ ¸å¿ƒè¡¨çš„è®°å½•æ•°ä¸åº”å‡å°‘
    for (final table in ['transactions', 'accounts', 'categories']) {
      final before = backup.tables[table] ?? 0;
      final after = currentCounts[table] ?? 0;

      if (after < before) {
        mismatches[table] = TableCountMismatch(
          table: table,
          before: before,
          after: after,
          difference: after - before,
        );
      }
    }

    // è®¡ç®—æ€»é‡‘é¢å¯¹æ¯”
    final beforeTotalIncome = backup.tables['_total_income'] ?? 0;
    final afterTotalIncome = await _getTotalAmount('income');

    final beforeTotalExpense = backup.tables['_total_expense'] ?? 0;
    final afterTotalExpense = await _getTotalAmount('expense');

    return PostUpgradeValidation(
      isValid: mismatches.isEmpty &&
        (beforeTotalIncome - afterTotalIncome).abs() < 0.01 &&
        (beforeTotalExpense - afterTotalExpense).abs() < 0.01,
      tableMismatches: mismatches,
      incomeMatch: (beforeTotalIncome - afterTotalIncome).abs() < 0.01,
      expenseMatch: (beforeTotalExpense - afterTotalExpense).abs() < 0.01,
    );
  }
}

/// æ ¡éªŒé”™è¯¯
class ValidationError {
  final ValidationErrorType type;
  final String table;
  final String? recordId;
  final String message;
  final ValidationSeverity severity;
  final Future<void> Function()? autoFix;

  ValidationError({
    required this.type,
    required this.table,
    this.recordId,
    required this.message,
    required this.severity,
    this.autoFix,
  });
}

enum ValidationErrorType {
  foreignKeyViolation,
  balanceMismatch,
  resourcePoolMismatch,
  timestampInvalid,
  duplicateRecord,
  orphanedRecord,
}

enum ValidationSeverity {
  critical,  // å¿…é¡»ä¿®å¤
  warning,   // å»ºè®®ä¿®å¤
  info,      // ä»…æç¤º
}
```

#### 16.4.7 æ•°æ®æ ¼å¼ç‰ˆæœ¬åŒ–

```dart
/// æ•°æ®å¯¼å‡ºæ ¼å¼ç‰ˆæœ¬ç®¡ç†
class ExportFormatVersion {
  /// å½“å‰å¯¼å‡ºæ ¼å¼ç‰ˆæœ¬
  static const int currentVersion = 3;

  /// ç‰ˆæœ¬ç‰¹æ€§
  static const Map<int, FormatFeatures> features = {
    1: FormatFeatures(
      description: 'åŸºç¡€å¯¼å‡ºæ ¼å¼',
      fields: ['id', 'amount', 'type', 'category', 'date', 'note'],
    ),
    2: FormatFeatures(
      description: 'å¢åŠ è´¦æˆ·å’Œæ ‡ç­¾æ”¯æŒ',
      fields: ['account_id', 'tags', 'attachment_ids'],
    ),
    3: FormatFeatures(
      description: 'å¢åŠ å°é‡‘åº“å’Œé’±é¾„å­—æ®µ',
      fields: ['vault_id', 'money_age', 'location'],
    ),
  };

  /// å¯¼å‡ºæ•°æ®æ—¶é™„åŠ ç‰ˆæœ¬ä¿¡æ¯
  static Map<String, dynamic> wrapExport(List<Map<String, dynamic>> data) {
    return {
      '_format_version': currentVersion,
      '_exported_at': DateTime.now().toIso8601String(),
      '_app_version': BuildInfo.version,
      'data': data,
    };
  }

  /// å¯¼å…¥æ—¶æ£€æŸ¥å¹¶è½¬æ¢æ ¼å¼
  static Future<List<Map<String, dynamic>>> unwrapImport(
    Map<String, dynamic> imported,
  ) async {
    final formatVersion = imported['_format_version'] as int? ?? 1;
    var data = imported['data'] as List<dynamic>;

    // é€ç‰ˆæœ¬å‡çº§æ•°æ®æ ¼å¼
    if (formatVersion < 2) {
      data = _upgradeV1ToV2(data);
    }
    if (formatVersion < 3) {
      data = _upgradeV2ToV3(data);
    }

    return data.cast<Map<String, dynamic>>();
  }

  /// V1 -> V2 æ ¼å¼è½¬æ¢
  static List<dynamic> _upgradeV1ToV2(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'account_id': null,  // é»˜è®¤æ— è´¦æˆ·
        'tags': <String>[],
        'attachment_ids': <String>[],
      };
    }).toList();
  }

  /// V2 -> V3 æ ¼å¼è½¬æ¢
  static List<dynamic> _upgradeV2ToV3(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'vault_id': null,
        'money_age': null,  // å¯¼å…¥åé‡æ–°è®¡ç®—
        'location': null,
      };
    }).toList();
  }
}
```

#### 16.4.8 APIå…¼å®¹æ€§å±‚

```dart
/// APIå“åº”å…¼å®¹æ€§é€‚é…å™¨
class ApiCompatibilityAdapter {
  /// æœåŠ¡å™¨APIç‰ˆæœ¬
  final String serverVersion;

  /// å®¢æˆ·ç«¯æ”¯æŒçš„æœ€ä½APIç‰ˆæœ¬
  static const String minSupportedVersion = 'v1';

  ApiCompatibilityAdapter(this.serverVersion);

  /// é€‚é…äº¤æ˜“å“åº”
  Transaction adaptTransaction(Map<String, dynamic> json) {
    // V1 API: categoryæ˜¯å­—ç¬¦ä¸²
    // V2 API: categoryæ˜¯å¯¹è±¡
    if (_isV1Api) {
      final categoryName = json['category'] as String?;
      json['category'] = {
        'id': categoryName,
        'name': categoryName,
      };
    }

    // V2 APIæ–°å¢å­—æ®µï¼ŒV1æ²¡æœ‰åˆ™è®¾é»˜è®¤å€¼
    json['vault_id'] ??= null;
    json['money_age'] ??= null;
    json['location'] ??= null;

    return Transaction.fromJson(json);
  }

  /// é€‚é…é¢„ç®—å“åº”
  Budget adaptBudget(Map<String, dynamic> json) {
    // V1 API: æ— é›¶åŸºé¢„ç®—æ¦‚å¿µ
    // V2 API: å¢åŠ budget_typeå­—æ®µ
    json['budget_type'] ??= 'traditional';
    json['carry_over_enabled'] ??= false;

    return Budget.fromJson(json);
  }

  bool get _isV1Api => serverVersion == 'v1';
}

/// è¯·æ±‚é™çº§é€‚é…å™¨ï¼ˆæ–°å®¢æˆ·ç«¯ -> æ—§æœåŠ¡å™¨ï¼‰
class RequestDowngradeAdapter {
  /// é™çº§äº¤æ˜“è¯·æ±‚
  static Map<String, dynamic> downgradeTransaction(
    Map<String, dynamic> request,
    String targetApiVersion,
  ) {
    if (targetApiVersion == 'v1') {
      // ç§»é™¤V2æ–°å¢å­—æ®µ
      return Map.from(request)
        ..remove('vault_id')
        ..remove('money_age')
        ..remove('location')
        ..['category'] = request['category']?['name'] ?? request['category'];
    }
    return request;
  }
}
```

#### 16.4.9 å‡çº§æµç¨‹UI

```dart
/// å‡çº§è¿›åº¦é¡µé¢
class UpgradeProgressPage extends ConsumerStatefulWidget {
  final String fromVersion;
  final String toVersion;

  const UpgradeProgressPage({
    required this.fromVersion,
    required this.toVersion,
  });

  @override
  ConsumerState<UpgradeProgressPage> createState() => _UpgradeProgressPageState();
}

class _UpgradeProgressPageState extends ConsumerState<UpgradeProgressPage> {
  UpgradePhase _phase = UpgradePhase.preparing;
  double _progress = 0;
  String _message = 'å‡†å¤‡å‡çº§...';
  bool _canCancel = true;

  @override
  void initState() {
    super.initState();
    _startUpgrade();
  }

  Future<void> _startUpgrade() async {
    final upgradeService = ref.read(upgradeServiceProvider);

    try {
      // 1. å¤‡ä»½é˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.backup;
        _message = 'æ­£åœ¨å¤‡ä»½æ•°æ®...';
        _progress = 0.1;
      });

      final backup = await upgradeService.createBackup(
        fromVersion: widget.fromVersion,
        toVersion: widget.toVersion,
      );

      // 2. è¿ç§»é˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.migrating;
        _canCancel = false;  // è¿ç§»å¼€å§‹åä¸å¯å–æ¶ˆ
      });

      await for (final progress in upgradeService.executeMigrations()) {
        setState(() {
          _progress = 0.2 + progress.percentage * 0.6;
          _message = progress.message;
        });
      }

      // 3. æ ¡éªŒé˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.validating;
        _message = 'æ­£åœ¨éªŒè¯æ•°æ®å®Œæ•´æ€§...';
        _progress = 0.85;
      });

      final validation = await upgradeService.validateAfterUpgrade(backup);

      if (!validation.isValid) {
        // æ ¡éªŒå¤±è´¥ï¼Œæç¤ºç”¨æˆ·
        final shouldRestore = await _showValidationError(validation);
        if (shouldRestore) {
          await upgradeService.restoreFromBackup(backup.id);
          _showRestoreSuccess();
          return;
        }
      }

      // 4. å®Œæˆ
      setState(() {
        _phase = UpgradePhase.completed;
        _message = 'å‡çº§å®Œæˆï¼';
        _progress = 1.0;
      });

      await Future.delayed(Duration(seconds: 1));
      Navigator.of(context).pushReplacementNamed('/home');

    } catch (e) {
      setState(() {
        _phase = UpgradePhase.failed;
        _message = 'å‡çº§å¤±è´¥: $e';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async => _canCancel,
      child: Scaffold(
        body: SafeArea(
          child: Padding(
            padding: EdgeInsets.all(24),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // è¿›åº¦æŒ‡ç¤ºå™¨
                _buildProgressIndicator(),

                SizedBox(height: 32),

                // é˜¶æ®µå›¾æ ‡
                _buildPhaseIcon(),

                SizedBox(height: 16),

                // æ¶ˆæ¯
                Text(
                  _message,
                  style: Theme.of(context).textTheme.titleMedium,
                  textAlign: TextAlign.center,
                ),

                SizedBox(height: 8),

                // ç‰ˆæœ¬ä¿¡æ¯
                Text(
                  '${widget.fromVersion} â†’ ${widget.toVersion}',
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    color: Colors.grey,
                  ),
                ),

                SizedBox(height: 32),

                // æ“ä½œæŒ‰é’®
                if (_phase == UpgradePhase.failed) ...[
                  ElevatedButton(
                    onPressed: () => _showRecoveryOptions(),
                    child: Text('æ¢å¤é€‰é¡¹'),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildProgressIndicator() {
    return Column(
      children: [
        LinearProgressIndicator(
          value: _progress,
          backgroundColor: Colors.grey[200],
          minHeight: 8,
          borderRadius: BorderRadius.circular(4),
        ),
        SizedBox(height: 8),
        Text(
          '${(_progress * 100).toInt()}%',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
      ],
    );
  }

  Widget _buildPhaseIcon() {
    IconData icon;
    Color color;

    switch (_phase) {
      case UpgradePhase.preparing:
        icon = Icons.hourglass_empty;
        color = Colors.grey;
      case UpgradePhase.backup:
        icon = Icons.backup;
        color = Colors.blue;
      case UpgradePhase.migrating:
        icon = Icons.sync;
        color = Colors.orange;
      case UpgradePhase.validating:
        icon = Icons.verified;
        color = Colors.purple;
      case UpgradePhase.completed:
        icon = Icons.check_circle;
        color = Colors.green;
      case UpgradePhase.failed:
        icon = Icons.error;
        color = Colors.red;
    }

    return Icon(icon, size: 64, color: color);
  }
}

enum UpgradePhase {
  preparing,
  backup,
  migrating,
  validating,
  completed,
  failed,
}
```

---

## 17. å®æ–½è·¯çº¿å›¾

### 17.1 å¼€å‘é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       2.0 ç‰ˆæœ¬å¼€å‘è·¯çº¿å›¾                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„ (Alpha)                                          â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“è¿ç§»è„šæœ¬                                                â”‚
â”‚  â”œâ”€â”€ èµ„æºæ± æ•°æ®æ¨¡å‹                                                â”‚
â”‚  â”œâ”€â”€ å°é‡‘åº“æ•°æ®æ¨¡å‹                                                â”‚
â”‚  â””â”€â”€ Provider æ¶æ„å‡çº§                                             â”‚
â”‚                                                                    â”‚
â”‚  é˜¶æ®µäºŒï¼šæ ¸å¿ƒåŠŸèƒ½ (Beta)                                           â”‚
â”‚  â”œâ”€â”€ é’±é¾„è®¡ç®—å¼•æ“                                                  â”‚
â”‚  â”œâ”€â”€ é›¶åŸºé¢„ç®—ç³»ç»Ÿ                                                  â”‚
â”‚  â”œâ”€â”€ å°é‡‘åº“ç®¡ç†                                                    â”‚
â”‚  â””â”€â”€ æ•°æ®è”åŠ¨æ¡†æ¶                                                  â”‚
â”‚                                                                    â”‚
â”‚  é˜¶æ®µä¸‰ï¼šä½“éªŒä¼˜åŒ– (RC)                                             â”‚
â”‚  â”œâ”€â”€ å¯è§†åŒ–ç»„ä»¶å‡çº§                                                â”‚
â”‚  â”œâ”€â”€ äº¤äº’åŠ¨ç”»å®Œå–„                                                  â”‚
â”‚  â”œâ”€â”€ å‡çº§å¼•å¯¼æµç¨‹                                                  â”‚
â”‚  â””â”€â”€ æ€§èƒ½ä¼˜åŒ–                                                      â”‚
â”‚                                                                    â”‚
â”‚  é˜¶æ®µå››ï¼šå‘å¸ƒå‡†å¤‡ (Release)                                        â”‚
â”‚  â”œâ”€â”€ å…¨é‡æµ‹è¯•                                                      â”‚
â”‚  â”œâ”€â”€ æ–‡æ¡£æ›´æ–°                                                      â”‚
â”‚  â”œâ”€â”€ åº”ç”¨å•†åº—å‡†å¤‡                                                  â”‚
â”‚  â””â”€â”€ ç°åº¦å‘å¸ƒ                                                      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.2 ä»»åŠ¡æ¸…å•

#### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„

- [ ] è®¾è®¡å¹¶å®ç°æ•°æ®åº“è¿ç§»è„šæœ¬ (v14 -> v20)
- [ ] å®ç° ResourcePool å’Œ ResourceConsumption æ¨¡å‹
- [ ] å®ç° BudgetVault æ¨¡å‹
- [ ] é‡æ„ Transaction æ¨¡å‹ï¼Œæ·»åŠ  vault_id å­—æ®µ
- [ ] å‡çº§ Provider æ¶æ„ï¼Œç»Ÿä¸€ä½¿ç”¨ CrudNotifier æ¨¡å¼
- [ ] å®ç°ç¦»çº¿é˜Ÿåˆ—æœåŠ¡
- [ ] å®ç°è‡ªåŠ¨åŒæ­¥æœåŠ¡

#### é˜¶æ®µäºŒï¼šæ ¸å¿ƒåŠŸèƒ½

- [ ] å®ç°é’±é¾„è®¡ç®—å¼•æ“ (MoneyAgeCalculator)
- [ ] å®ç°å†å²æ•°æ®é’±é¾„é‡å»º
- [ ] å®ç°é›¶åŸºé¢„ç®—åˆ†é…æœåŠ¡ (AllocationService)
- [ ] å®ç°æ™ºèƒ½åˆ†é…å»ºè®®ç®—æ³•
- [ ] å®ç°å°é‡‘åº“ CRUD åŠŸèƒ½
- [ ] å®ç°äº¤æ˜“-å°é‡‘åº“è‡ªåŠ¨å…³è”
- [ ] å®ç°æ•°æ®è”åŠ¨å¯¼èˆªæœåŠ¡
- [ ] å®ç°é¢åŒ…å±‘çŠ¶æ€ç®¡ç†

#### é˜¶æ®µä¸‰ï¼šä½“éªŒä¼˜åŒ–

- [ ] å®ç°é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡
- [ ] å®ç°é’±é¾„è¶‹åŠ¿å›¾ï¼ˆå¯ç‚¹å‡»ä¸‹é’»ï¼‰
- [ ] å®ç°é’±é¾„è¯¦æƒ…é¡µ
- [ ] å®ç°å°é‡‘åº“æ¦‚è§ˆé¡µ
- [ ] å®ç°èµ„é‡‘åˆ†é…é¡µ
- [ ] å®ç°åˆ†ç±»é¥¼å›¾ä¸‹é’»
- [ ] å®ç°ä¸‹é’»è¿‡æ¸¡åŠ¨ç”»
- [ ] å®ç° Material Design 3 ä¸»é¢˜
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šå›¾è¡¨æ¸²æŸ“ã€åˆ—è¡¨è™šæ‹ŸåŒ–

#### é˜¶æ®µå››ï¼šå‘å¸ƒå‡†å¤‡

- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£
- [ ] æ›´æ–° API æ–‡æ¡£
- [ ] å‡†å¤‡åº”ç”¨å•†åº—æˆªå›¾å’Œæè¿°
- [ ] å†…éƒ¨æµ‹è¯•
- [ ] ç°åº¦å‘å¸ƒ (10% -> 50% -> 100%)

---

## 18. æµ‹è¯•ç­–ç•¥

æœ¬ç« èŠ‚å®šä¹‰2.0ç‰ˆæœ¬çš„å…¨é¢æµ‹è¯•ç­–ç•¥ï¼Œç¡®ä¿äº§å“è´¨é‡å’Œç”¨æˆ·ä½“éªŒã€‚

### 18.1 æµ‹è¯•é‡‘å­—å¡”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æµ‹è¯•é‡‘å­—å¡”                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚ E2E   â”‚  5%   ç«¯åˆ°ç«¯æµ‹è¯•                    â”‚
â”‚                             â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€                                   â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                           â”‚  é›†æˆæµ‹è¯•    â”‚  15%                            â”‚
â”‚                          â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                                â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                        â”‚    Widgetæµ‹è¯•     â”‚  25%                          â”‚
â”‚                       â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                             â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                     â”‚        å•å…ƒæµ‹è¯•            â”‚  55%                     â”‚
â”‚                    â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                        â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18.2 å•å…ƒæµ‹è¯•ç­–ç•¥

```dart
/// å•å…ƒæµ‹è¯•è¦†ç›–è¦æ±‚
class UnitTestCoverage {
  /// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ - å¿…é¡»è¦†ç›–
  static const coreLogicCoverage = {
    'MoneyAgeCalculator': 95,      // é’±é¾„è®¡ç®— â‰¥95%
    'BudgetAllocationService': 90, // é¢„ç®—åˆ†é… â‰¥90%
    'TransactionMatcher': 90,      // äº¤æ˜“åŒ¹é… â‰¥90%
    'DataSyncService': 85,         // æ•°æ®åŒæ­¥ â‰¥85%
  };

  /// æ•°æ®æ¨¡å‹ - é«˜è¦†ç›–è¦æ±‚
  static const modelCoverage = {
    'Transaction': 90,
    'Budget': 90,
    'BudgetVault': 90,
    'MoneyAge': 85,
  };

  /// å·¥å…·ç±» - ä¸­ç­‰è¦†ç›–è¦æ±‚
  static const utilsCoverage = {
    'DateUtils': 80,
    'CurrencyUtils': 80,
    'ValidationUtils': 85,
  };
}

/// é’±é¾„è®¡ç®—å•å…ƒæµ‹è¯•ç¤ºä¾‹
@Tags(['unit', 'money-age'])
void main() {
  group('MoneyAgeCalculator', () {
    late MoneyAgeCalculator calculator;
    late MockTransactionRepository mockRepo;

    setUp(() {
      mockRepo = MockTransactionRepository();
      calculator = MoneyAgeCalculator(repository: mockRepo);
    });

    test('è®¡ç®—ç©ºäº¤æ˜“åˆ—è¡¨åº”è¿”å›é›¶é’±é¾„', () {
      when(mockRepo.getTransactions(any)).thenReturn([]);

      final result = calculator.calculate(DateTime.now());

      expect(result.days, equals(0));
      expect(result.level, equals(MoneyAgeLevel.danger));
    });

    test('åªæœ‰æ”¶å…¥æ— æ”¯å‡ºåº”è¿”å›æœ€å¤§é’±é¾„', () {
      final income = Transaction(
        type: TransactionType.income,
        amount: 10000,
        date: DateTime.now().subtract(Duration(days: 60)),
      );
      when(mockRepo.getTransactions(any)).thenReturn([income]);

      final result = calculator.calculate(DateTime.now());

      expect(result.days, greaterThanOrEqualTo(60));
      expect(result.level, equals(MoneyAgeLevel.excellent));
    });

    test('FIFOç®—æ³•æ­£ç¡®æ¶ˆè€—æ”¶å…¥', () {
      final incomes = [
        Transaction(type: TransactionType.income, amount: 1000,
          date: DateTime.now().subtract(Duration(days: 30))),
        Transaction(type: TransactionType.income, amount: 2000,
          date: DateTime.now().subtract(Duration(days: 15))),
      ];
      final expense = Transaction(
        type: TransactionType.expense,
        amount: 1500,
        date: DateTime.now(),
      );
      when(mockRepo.getTransactions(any)).thenReturn([...incomes, expense]);

      final result = calculator.calculate(DateTime.now());

      // 1500æ”¯å‡ºåº”å…ˆæ¶ˆè€—30å¤©å‰çš„1000ï¼Œå†æ¶ˆè€—15å¤©å‰çš„500
      // åŠ æƒå¹³å‡: (1000*30 + 500*15) / 1500 = 25å¤©
      expect(result.days, closeTo(25, 1));
    });
  });
}
```

### 18.3 Widgetæµ‹è¯•ç­–ç•¥

```dart
/// Widgetæµ‹è¯•è¦æ±‚
class WidgetTestRequirements {
  /// æ ¸å¿ƒé¡µé¢å¿…é¡»æœ‰Widgetæµ‹è¯•
  static const requiredPages = [
    'HomePage',
    'BudgetManagementPage',
    'TransactionListPage',
    'MoneyAgeDetailPage',
    'VaultManagementPage',
    'StatisticsPage',
  ];

  /// æ ¸å¿ƒç»„ä»¶å¿…é¡»æœ‰Widgetæµ‹è¯•
  static const requiredWidgets = [
    'MoneyAgeCard',
    'BudgetProgressBar',
    'VaultBalanceWidget',
    'TransactionTile',
    'CategoryPieChart',
    'TrendLineChart',
  ];
}

/// é¦–é¡µWidgetæµ‹è¯•ç¤ºä¾‹
@Tags(['widget', 'home'])
void main() {
  group('HomePage Widget Tests', () {
    testWidgets('æ˜¾ç¤ºé’±é¾„å¡ç‰‡', (tester) async {
      await tester.pumpWidget(
        ProviderScope(
          overrides: [
            moneyAgeProvider.overrideWith((_) =>
              MoneyAge(days: 25, level: MoneyAgeLevel.good)),
          ],
          child: MaterialApp(home: HomePage()),
        ),
      );

      expect(find.text('é’±é¾„'), findsOneWidget);
      expect(find.text('25 å¤©'), findsOneWidget);
      expect(find.byType(MoneyAgeCard), findsOneWidget);
    });

    testWidgets('ç‚¹å‡»é’±é¾„å¡ç‰‡å¯¼èˆªåˆ°è¯¦æƒ…é¡µ', (tester) async {
      await tester.pumpWidget(createTestApp());

      await tester.tap(find.byType(MoneyAgeCard));
      await tester.pumpAndSettle();

      expect(find.byType(MoneyAgeDetailPage), findsOneWidget);
    });

    testWidgets('ä¸‹æ‹‰åˆ·æ–°æ›´æ–°æ•°æ®', (tester) async {
      await tester.pumpWidget(createTestApp());

      await tester.fling(
        find.byType(CustomScrollView),
        Offset(0, 300),
        1000,
      );
      await tester.pumpAndSettle();

      // éªŒè¯åˆ·æ–°å›è°ƒè¢«è°ƒç”¨
      verify(mockRefreshCallback()).called(1);
    });
  });
}
```

### 18.4 é›†æˆæµ‹è¯•ç­–ç•¥

```dart
/// é›†æˆæµ‹è¯•åœºæ™¯
class IntegrationTestScenarios {
  /// å…³é”®ç”¨æˆ·æ—…ç¨‹
  static const criticalJourneys = [
    'new_user_onboarding',      // æ–°ç”¨æˆ·å¼•å¯¼æµç¨‹
    'quick_expense_entry',       // å¿«é€Ÿè®°è´¦
    'voice_expense_entry',       // è¯­éŸ³è®°è´¦
    'budget_creation_flow',      // é¢„ç®—åˆ›å»ºæµç¨‹
    'vault_allocation_flow',     // å°é‡‘åº“åˆ†é…æµç¨‹
    'data_drill_down',           // æ•°æ®ä¸‹é’»
    'monthly_report_view',       // æœˆåº¦æŠ¥è¡¨æŸ¥çœ‹
  ];

  /// æ•°æ®åŒæ­¥åœºæ™¯
  static const syncScenarios = [
    'offline_to_online_sync',    // ç¦»çº¿è½¬åœ¨çº¿åŒæ­¥
    'conflict_resolution',       // å†²çªè§£å†³
    'partial_sync_recovery',     // éƒ¨åˆ†åŒæ­¥æ¢å¤
  ];
}

/// å¿«é€Ÿè®°è´¦é›†æˆæµ‹è¯•
integration_test('å¿«é€Ÿè®°è´¦æµç¨‹', () async {
  final app = await initializeTestApp();

  // 1. æ‰“å¼€å¿«é€Ÿè®°è´¦é¡µ
  await app.tap(find.byIcon(Icons.add));
  await app.pumpAndSettle();

  // 2. è¾“å…¥é‡‘é¢
  await app.enterText(find.byType(AmountInput), '88.5');

  // 3. é€‰æ‹©åˆ†ç±»
  await app.tap(find.text('é¤é¥®'));

  // 4. æ·»åŠ å¤‡æ³¨
  await app.enterText(find.byType(NoteInput), 'åˆé¤');

  // 5. ä¿å­˜
  await app.tap(find.text('ä¿å­˜'));
  await app.pumpAndSettle();

  // 6. éªŒè¯äº¤æ˜“å·²ä¿å­˜
  expect(find.text('Â¥88.50'), findsOneWidget);
  expect(find.text('é¤é¥®'), findsOneWidget);
  expect(find.text('åˆé¤'), findsOneWidget);

  // 7. éªŒè¯é’±é¾„å·²æ›´æ–°
  final moneyAge = app.getMoneyAge();
  expect(moneyAge.lastUpdated, isNotNull);
});

/// æ•°æ®ä¸‹é’»é›†æˆæµ‹è¯•
integration_test('ç»Ÿè®¡å›¾è¡¨ä¸‹é’»æµç¨‹', () async {
  final app = await initializeTestApp(withSampleData: true);

  // 1. è¿›å…¥ç»Ÿè®¡é¡µ
  await app.tap(find.byIcon(Icons.bar_chart));
  await app.pumpAndSettle();

  // 2. ç‚¹å‡»é¥¼å›¾çš„"é¤é¥®"åˆ†ç±»
  await app.tapChartSegment('é¤é¥®');
  await app.pumpAndSettle();

  // 3. éªŒè¯è¿›å…¥é¤é¥®åˆ†ç±»è¯¦æƒ…
  expect(find.text('é¤é¥®æ”¯å‡ºè¯¦æƒ…'), findsOneWidget);

  // 4. éªŒè¯é¢åŒ…å±‘æ˜¾ç¤º
  expect(find.byType(Breadcrumb), findsOneWidget);
  expect(find.text('ç»Ÿè®¡'), findsOneWidget);
  expect(find.text('é¤é¥®'), findsOneWidget);

  // 5. ç‚¹å‡»æŸä¸€å¤©
  await app.tap(find.text('12æœˆ25æ—¥'));
  await app.pumpAndSettle();

  // 6. éªŒè¯æ˜¾ç¤ºå½“å¤©äº¤æ˜“åˆ—è¡¨
  expect(find.byType(TransactionList), findsOneWidget);

  // 7. ç‚¹å‡»é¢åŒ…å±‘è¿”å›
  await app.tap(find.text('ç»Ÿè®¡'));
  await app.pumpAndSettle();

  expect(find.byType(StatisticsPage), findsOneWidget);
});
```

### 18.5 ç«¯åˆ°ç«¯æµ‹è¯•

```dart
/// E2Eæµ‹è¯•åœºæ™¯
class E2ETestScenarios {
  /// å®Œæ•´ç”¨æˆ·æµç¨‹
  static const fullUserFlows = [
    E2EFlow(
      name: 'æœˆåº¦è´¢åŠ¡ç®¡ç†å®Œæ•´æµç¨‹',
      steps: [
        'ç™»å½•åº”ç”¨',
        'æŸ¥çœ‹æœ¬æœˆæ¦‚è§ˆ',
        'è®°å½•æ”¶å…¥ï¼ˆå·¥èµ„ï¼‰',
        'åˆ†é…æ”¶å…¥åˆ°å„å°é‡‘åº“',
        'è®°å½•å¤šç¬”æ”¯å‡º',
        'æŸ¥çœ‹é’±é¾„å˜åŒ–',
        'æ£€æŸ¥é¢„ç®—æ‰§è¡Œæƒ…å†µ',
        'ç”Ÿæˆæœˆåº¦æŠ¥è¡¨',
        'è®¾ç½®ä¸‹æœˆé¢„ç®—',
      ],
      expectedDuration: Duration(minutes: 15),
    ),
  ];
}

/// æœˆåº¦è´¢åŠ¡ç®¡ç†E2Eæµ‹è¯•
@Tags(['e2e', 'slow'])
e2e_test('æœˆåº¦è´¢åŠ¡ç®¡ç†å®Œæ•´æµç¨‹', () async {
  final driver = await FlutterDriver.connect();

  try {
    // 1. ç™»å½•
    await driver.tap(find.byValueKey('login_button'));
    await driver.waitFor(find.byType('HomePage'));

    // 2. è®°å½•æ”¶å…¥
    await driver.tap(find.byValueKey('add_transaction'));
    await driver.tap(find.text('æ”¶å…¥'));
    await driver.enterText(find.byType('AmountInput'), '15000');
    await driver.tap(find.text('å·¥èµ„'));
    await driver.tap(find.text('ä¿å­˜'));

    // 3. åˆ†é…åˆ°å°é‡‘åº“
    await driver.tap(find.byValueKey('vault_allocation'));
    await driver.enterText(find.byValueKey('vault_food'), '3000');
    await driver.enterText(find.byValueKey('vault_transport'), '1000');
    await driver.enterText(find.byValueKey('vault_savings'), '5000');
    await driver.tap(find.text('ç¡®è®¤åˆ†é…'));

    // 4. éªŒè¯é’±é¾„
    await driver.waitFor(find.text('é’±é¾„'));
    final moneyAgeText = await driver.getText(find.byValueKey('money_age_days'));
    expect(int.parse(moneyAgeText), greaterThan(0));

    // 5. ç”ŸæˆæŠ¥è¡¨
    await driver.tap(find.byValueKey('reports'));
    await driver.tap(find.text('ç”Ÿæˆæœˆåº¦æŠ¥è¡¨'));
    await driver.waitFor(find.text('æŠ¥è¡¨å·²ç”Ÿæˆ'));

  } finally {
    await driver.close();
  }
});
```

### 18.6 æ€§èƒ½æµ‹è¯•

```dart
/// æ€§èƒ½æµ‹è¯•åŸºå‡†
class PerformanceBenchmarks {
  /// é¡µé¢åŠ è½½æ—¶é—´åŸºå‡† (æ¯«ç§’)
  static const pageLoadTimes = {
    'HomePage': 500,
    'TransactionListPage': 800,
    'StatisticsPage': 1000,
    'MoneyAgeDetailPage': 600,
  };

  /// æ“ä½œå“åº”æ—¶é—´åŸºå‡† (æ¯«ç§’)
  static const operationTimes = {
    'save_transaction': 200,
    'calculate_money_age': 100,
    'generate_chart': 500,
    'sync_data': 3000,
  };

  /// å†…å­˜ä½¿ç”¨åŸºå‡† (MB)
  static const memoryLimits = {
    'idle': 150,
    'active': 250,
    'peak': 400,
  };
}

/// æ€§èƒ½æµ‹è¯•ç¤ºä¾‹
@Tags(['performance'])
void main() {
  group('Performance Tests', () {
    test('é¦–é¡µåŠ è½½æ—¶é—´ < 500ms', () async {
      final stopwatch = Stopwatch()..start();

      await tester.pumpWidget(HomePage());
      await tester.pumpAndSettle();

      stopwatch.stop();
      expect(stopwatch.elapsedMilliseconds,
        lessThan(PerformanceBenchmarks.pageLoadTimes['HomePage']!));
    });

    test('é’±é¾„è®¡ç®—æ—¶é—´ < 100ms (1000æ¡äº¤æ˜“)', () async {
      final transactions = generateTransactions(1000);
      final calculator = MoneyAgeCalculator();

      final stopwatch = Stopwatch()..start();
      calculator.calculate(transactions, DateTime.now());
      stopwatch.stop();

      expect(stopwatch.elapsedMilliseconds, lessThan(100));
    });

    test('äº¤æ˜“åˆ—è¡¨æ»šåŠ¨å¸§ç‡ >= 55fps', () async {
      await tester.pumpWidget(TransactionListPage());

      final timeline = await tester.traceAction(() async {
        await tester.fling(
          find.byType(ListView),
          Offset(0, -500),
          1000,
        );
        await tester.pumpAndSettle();
      });

      final summary = TimelineSummary.summarize(timeline);
      expect(summary.averageFrameBuildTimeMillis, lessThan(18)); // ~55fps
    });
  });
}
```

### 18.7 æµ‹è¯•è‡ªåŠ¨åŒ–ä¸CI/CD

```yaml
# .github/workflows/test.yml
name: Test Pipeline

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test --coverage
      - uses: codecov/codecov-action@v3

  widget-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test test/widget --tags=widget

  integration-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter drive --target=test_driver/app.dart

  performance-tests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test --tags=performance
```

### 18.8 æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

| æ¨¡å— | æœ€ä½è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|-----------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | 85% | 95% |
| æ•°æ®æ¨¡å‹ | 80% | 90% |
| Provider/Service | 75% | 85% |
| UIç»„ä»¶ | 60% | 75% |
| å·¥å…·ç±» | 70% | 85% |
| **æ•´ä½“** | **70%** | **80%** |

---

## 19. å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡

æœ¬ç« èŠ‚åŸºäº**é«˜å¯ç”¨ä¼˜å…ˆåŸåˆ™**å’Œ**æ•°æ®ä¸€è‡´æ€§åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿåœ¨é¢å¯¹å„ç±»å¼‚å¸¸æƒ…å†µæ—¶çš„å¤„ç†ç­–ç•¥ã€‚

### 19.1 å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥

#### 19.1.1 å¼‚å¸¸åˆ†ç±»ä½“ç³»

```dart
/// å¼‚å¸¸åˆ†ç±»æšä¸¾
enum ExceptionCategory {
  /// ç½‘ç»œå¼‚å¸¸ - å¯é‡è¯•
  network,

  /// æœåŠ¡ç«¯å¼‚å¸¸ - éœ€é™çº§
  server,

  /// å®¢æˆ·ç«¯å¼‚å¸¸ - éœ€ç”¨æˆ·ä»‹å…¥
  client,

  /// æ•°æ®å¼‚å¸¸ - éœ€ä¿®å¤
  data,

  /// ä¸šåŠ¡å¼‚å¸¸ - æ­£å¸¸å¤„ç†
  business,

  /// ç³»ç»Ÿå¼‚å¸¸ - éœ€ä¸ŠæŠ¥
  system,
}

/// å¼‚å¸¸ä¸¥é‡ç¨‹åº¦
enum ExceptionSeverity {
  /// å¯å¿½ç•¥ - é™é»˜å¤„ç†
  ignorable,

  /// å¯æ¢å¤ - è‡ªåŠ¨é‡è¯•
  recoverable,

  /// éœ€æç¤º - é€šçŸ¥ç”¨æˆ·
  warning,

  /// ä¸¥é‡ - é˜»æ–­æ“ä½œ
  critical,

  /// è‡´å‘½ - åº”ç”¨å´©æºƒé£é™©
  fatal,
}

/// ç»Ÿä¸€å¼‚å¸¸å®šä¹‰
class AppException implements Exception {
  final String code;
  final String message;
  final String? userMessage;
  final ExceptionCategory category;
  final ExceptionSeverity severity;
  final dynamic originalError;
  final StackTrace? stackTrace;
  final Map<String, dynamic>? context;
  final DateTime timestamp;

  AppException({
    required this.code,
    required this.message,
    this.userMessage,
    required this.category,
    required this.severity,
    this.originalError,
    this.stackTrace,
    this.context,
  }) : timestamp = DateTime.now();

  /// æ˜¯å¦å¯é‡è¯•
  bool get isRetryable =>
    category == ExceptionCategory.network ||
    (category == ExceptionCategory.server && severity != ExceptionSeverity.fatal);

  /// æ˜¯å¦éœ€è¦ä¸ŠæŠ¥
  bool get shouldReport =>
    severity == ExceptionSeverity.critical ||
    severity == ExceptionSeverity.fatal;
}
```

#### 18.1.2 ç½‘ç»œå¼‚å¸¸å¤„ç†

```dart
/// ç½‘ç»œå¼‚å¸¸å¤„ç†å™¨
class NetworkExceptionHandler {
  static const int maxRetries = 3;
  static const Duration initialBackoff = Duration(seconds: 1);

  /// ç½‘ç»œè¯·æ±‚åŒ…è£…å™¨ï¼ˆå¸¦é‡è¯•ï¼‰
  Future<T> executeWithRetry<T>({
    required Future<T> Function() request,
    required String operationName,
    int? maxRetries,
    bool showLoading = true,
  }) async {
    final retries = maxRetries ?? NetworkExceptionHandler.maxRetries;
    Duration backoff = initialBackoff;

    for (int attempt = 1; attempt <= retries; attempt++) {
      try {
        return await request();
      } on SocketException catch (e) {
        // æ— ç½‘ç»œè¿æ¥
        if (attempt == retries) {
          throw AppException(
            code: 'NETWORK_UNAVAILABLE',
            message: 'No network connection',
            userMessage: 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
            category: ExceptionCategory.network,
            severity: ExceptionSeverity.warning,
            originalError: e,
          );
        }
        await _waitWithBackoff(backoff);
        backoff *= 2;
      } on TimeoutException catch (e) {
        // è¯·æ±‚è¶…æ—¶
        if (attempt == retries) {
          throw AppException(
            code: 'REQUEST_TIMEOUT',
            message: 'Request timeout after $retries attempts',
            userMessage: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
            category: ExceptionCategory.network,
            severity: ExceptionSeverity.recoverable,
            originalError: e,
          );
        }
        await _waitWithBackoff(backoff);
        backoff *= 2;
      } on HttpException catch (e) {
        // HTTPé”™è¯¯ï¼Œæ ¹æ®çŠ¶æ€ç å†³å®šæ˜¯å¦é‡è¯•
        final statusCode = _extractStatusCode(e);
        if (_isRetryableStatusCode(statusCode) && attempt < retries) {
          await _waitWithBackoff(backoff);
          backoff *= 2;
          continue;
        }
        throw _mapHttpException(e, statusCode);
      }
    }

    throw AppException(
      code: 'UNEXPECTED_RETRY_FAILURE',
      message: 'All retry attempts exhausted',
      category: ExceptionCategory.network,
      severity: ExceptionSeverity.critical,
    );
  }

  /// å¯é‡è¯•çš„HTTPçŠ¶æ€ç 
  bool _isRetryableStatusCode(int? statusCode) {
    if (statusCode == null) return true;
    return statusCode == 408 || // Request Timeout
           statusCode == 429 || // Too Many Requests
           statusCode == 502 || // Bad Gateway
           statusCode == 503 || // Service Unavailable
           statusCode == 504;   // Gateway Timeout
  }

  /// æŒ‡æ•°é€€é¿ç­‰å¾…
  Future<void> _waitWithBackoff(Duration duration) async {
    final jitter = Random().nextDouble() * 0.3; // 0-30% éšæœºæŠ–åŠ¨
    final actualWait = duration * (1 + jitter);
    await Future.delayed(actualWait);
  }
}
```

#### 18.1.3 æ•°æ®å¼‚å¸¸å¤„ç†

```dart
/// æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æœåŠ¡
class DataIntegrityService {
  final DatabaseService _db;
  final Logger _logger;

  /// äº¤æ˜“æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
  Future<DataIntegrityReport> checkTransactionIntegrity() async {
    final issues = <DataIntegrityIssue>[];

    // 1. æ£€æŸ¥å­¤å„¿äº¤æ˜“ï¼ˆå…³è”çš„è´¦æˆ·/åˆ†ç±»å·²åˆ é™¤ï¼‰
    final orphanTransactions = await _findOrphanTransactions();
    for (final tx in orphanTransactions) {
      issues.add(DataIntegrityIssue(
        type: IssueType.orphanRecord,
        table: 'transactions',
        recordId: tx.id,
        description: 'äº¤æ˜“å…³è”çš„è´¦æˆ·æˆ–åˆ†ç±»ä¸å­˜åœ¨',
        suggestedFix: DataFix.assignDefault,
        autoFixable: true,
      ));
    }

    // 2. æ£€æŸ¥é‡‘é¢å¼‚å¸¸ï¼ˆNaNã€æ— ç©·å¤§ã€è´Ÿæ•°é‡‘é¢åœ¨ä¸è¯¥å‡ºç°çš„åœ°æ–¹ï¼‰
    final invalidAmounts = await _findInvalidAmounts();
    for (final tx in invalidAmounts) {
      issues.add(DataIntegrityIssue(
        type: IssueType.invalidValue,
        table: 'transactions',
        recordId: tx.id,
        description: 'é‡‘é¢å€¼å¼‚å¸¸: ${tx.amount}',
        suggestedFix: DataFix.manualReview,
        autoFixable: false,
      ));
    }

    // 3. æ£€æŸ¥æ—¥æœŸå¼‚å¸¸ï¼ˆæœªæ¥æ—¥æœŸè¶…è¿‡1å¹´ã€è¿‡å»æ—¥æœŸè¶…è¿‡100å¹´ï¼‰
    final invalidDates = await _findInvalidDates();
    for (final tx in invalidDates) {
      issues.add(DataIntegrityIssue(
        type: IssueType.invalidValue,
        table: 'transactions',
        recordId: tx.id,
        description: 'æ—¥æœŸå¼‚å¸¸: ${tx.date}',
        suggestedFix: DataFix.setToNow,
        autoFixable: true,
      ));
    }

    // 4. æ£€æŸ¥é‡å¤äº¤æ˜“
    final duplicates = await _findDuplicateTransactions();
    for (final group in duplicates) {
      issues.add(DataIntegrityIssue(
        type: IssueType.duplicate,
        table: 'transactions',
        recordId: group.first.id,
        relatedIds: group.skip(1).map((t) => t.id).toList(),
        description: 'å‘ç°${group.length}æ¡å¯èƒ½é‡å¤çš„äº¤æ˜“',
        suggestedFix: DataFix.mergeDuplicates,
        autoFixable: false,
      ));
    }

    // 5. æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
    final balanceIssues = await _checkAccountBalances();
    issues.addAll(balanceIssues);

    return DataIntegrityReport(
      checkTime: DateTime.now(),
      totalIssues: issues.length,
      criticalIssues: issues.where((i) => i.severity == IssueSeverity.critical).length,
      autoFixableIssues: issues.where((i) => i.autoFixable).length,
      issues: issues,
    );
  }

  /// è‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„é—®é¢˜
  Future<DataFixResult> autoFixIssues(DataIntegrityReport report) async {
    final fixedCount = <IssueType, int>{};
    final failedFixes = <DataIntegrityIssue>[];

    for (final issue in report.issues.where((i) => i.autoFixable)) {
      try {
        await _applyFix(issue);
        fixedCount[issue.type] = (fixedCount[issue.type] ?? 0) + 1;
      } catch (e) {
        failedFixes.add(issue);
        _logger.error('Failed to fix issue: ${issue.description}', error: e);
      }
    }

    return DataFixResult(
      totalFixed: fixedCount.values.fold(0, (a, b) => a + b),
      fixedByType: fixedCount,
      failedFixes: failedFixes,
    );
  }

  /// æŸ¥æ‰¾å­¤å„¿äº¤æ˜“
  Future<List<Transaction>> _findOrphanTransactions() async {
    return await _db.rawQuery('''
      SELECT t.* FROM transactions t
      LEFT JOIN accounts a ON t.account_id = a.id
      LEFT JOIN categories c ON t.category_id = c.id
      WHERE a.id IS NULL OR c.id IS NULL
    ''');
  }

  /// æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
  Future<List<DataIntegrityIssue>> _checkAccountBalances() async {
    final issues = <DataIntegrityIssue>[];
    final accounts = await _db.getAllAccounts();

    for (final account in accounts) {
      // è®¡ç®—äº¤æ˜“ç´¯åŠ ä½™é¢
      final calculatedBalance = await _calculateAccountBalance(account.id);

      // ä¸å­˜å‚¨çš„ä½™é¢æ¯”è¾ƒ
      if ((calculatedBalance - account.balance).abs() > 0.01) {
        issues.add(DataIntegrityIssue(
          type: IssueType.balanceMismatch,
          table: 'accounts',
          recordId: account.id,
          description: 'è´¦æˆ·ä½™é¢ä¸ä¸€è‡´: å­˜å‚¨=${account.balance}, è®¡ç®—=${calculatedBalance}',
          suggestedFix: DataFix.recalculateBalance,
          autoFixable: true,
          metadata: {
            'storedBalance': account.balance,
            'calculatedBalance': calculatedBalance,
            'difference': calculatedBalance - account.balance,
          },
        ));
      }
    }

    return issues;
  }
}
```

### 19.2 ç¦»çº¿ä¼˜å…ˆä¸æ•°æ®åŒæ­¥

#### 19.2.1 ç¦»çº¿æ“ä½œé˜Ÿåˆ—

```dart
/// ç¦»çº¿æ“ä½œé˜Ÿåˆ—ç®¡ç†å™¨
class OfflineOperationQueue {
  final DatabaseService _db;
  final SyncService _syncService;
  final ConnectivityService _connectivity;

  /// æ“ä½œé˜Ÿåˆ—è¡¨ç»“æ„
  /// CREATE TABLE offline_queue (
  ///   id TEXT PRIMARY KEY,
  ///   operation_type TEXT NOT NULL,  -- CREATE, UPDATE, DELETE
  ///   entity_type TEXT NOT NULL,     -- transaction, account, category
  ///   entity_id TEXT NOT NULL,
  ///   payload TEXT NOT NULL,         -- JSONåºåˆ—åŒ–çš„æ•°æ®
  ///   created_at TEXT NOT NULL,
  ///   retry_count INTEGER DEFAULT 0,
  ///   last_error TEXT,
  ///   status TEXT DEFAULT 'pending'  -- pending, processing, failed, completed
  /// );

  /// æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—
  Future<void> enqueue(OfflineOperation operation) async {
    await _db.insert('offline_queue', {
      'id': operation.id,
      'operation_type': operation.type.name,
      'entity_type': operation.entityType,
      'entity_id': operation.entityId,
      'payload': jsonEncode(operation.payload),
      'created_at': DateTime.now().toIso8601String(),
      'status': 'pending',
    });

    // å¦‚æœåœ¨çº¿ï¼Œç«‹å³å°è¯•åŒæ­¥
    if (await _connectivity.isOnline) {
      _processQueue();
    }
  }

  /// å¤„ç†é˜Ÿåˆ—
  Future<void> _processQueue() async {
    final pendingOperations = await _getPendingOperations();

    for (final operation in pendingOperations) {
      try {
        await _updateStatus(operation.id, 'processing');
        await _executeOperation(operation);
        await _updateStatus(operation.id, 'completed');
      } catch (e) {
        final retryCount = operation.retryCount + 1;
        if (retryCount >= 5) {
          await _updateStatus(operation.id, 'failed', error: e.toString());
          // é€šçŸ¥ç”¨æˆ·æœ‰åŒæ­¥å¤±è´¥çš„æ“ä½œ
          _notifyFailedOperation(operation);
        } else {
          await _updateRetryCount(operation.id, retryCount, error: e.toString());
        }
      }
    }
  }

  /// å†²çªæ£€æµ‹ä¸è§£å†³
  Future<ConflictResolution> detectAndResolveConflict(
    OfflineOperation localOperation,
    ServerData serverData,
  ) async {
    // æ¯”è¾ƒç‰ˆæœ¬å·
    if (serverData.version > localOperation.baseVersion) {
      // æœåŠ¡å™¨æœ‰æ›´æ–°ç‰ˆæœ¬
      if (localOperation.type == OperationType.update) {
        // å­—æ®µçº§å†²çªæ£€æµ‹
        final conflicts = _detectFieldConflicts(
          localOperation.payload,
          serverData.data,
        );

        if (conflicts.isEmpty) {
          // æ— å­—æ®µå†²çªï¼Œåˆå¹¶
          return ConflictResolution.merge(_mergePayloads(
            localOperation.payload,
            serverData.data,
          ));
        } else {
          // æœ‰å­—æ®µå†²çªï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
          return ConflictResolution.userChoice(conflicts);
        }
      } else if (localOperation.type == OperationType.delete) {
        // æœ¬åœ°åˆ é™¤ï¼ŒæœåŠ¡å™¨æœ‰æ›´æ–°
        return ConflictResolution.userChoice([
          ConflictOption('ä¿ç•™æœåŠ¡å™¨ç‰ˆæœ¬', serverData.data),
          ConflictOption('ä»ç„¶åˆ é™¤', null),
        ]);
      }
    }

    // æœ¬åœ°ç‰ˆæœ¬æ›´æ–°æˆ–ç›¸åŒï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬
    return ConflictResolution.useLocal();
  }
}
```

#### 19.2.2 æ•°æ®åŒæ­¥çŠ¶æ€æœº

```dart
/// åŒæ­¥çŠ¶æ€æœº
class SyncStateMachine {
  SyncState _state = SyncState.idle;
  final StreamController<SyncState> _stateController = StreamController.broadcast();

  Stream<SyncState> get stateStream => _stateController.stream;
  SyncState get currentState => _state;

  /// çŠ¶æ€è½¬æ¢è§„åˆ™
  ///
  /// idle â”€â”€[startSync]â”€â”€> syncing
  /// syncing â”€â”€[complete]â”€â”€> idle
  /// syncing â”€â”€[conflict]â”€â”€> conflictResolution
  /// syncing â”€â”€[error]â”€â”€> error
  /// conflictResolution â”€â”€[resolved]â”€â”€> syncing
  /// conflictResolution â”€â”€[cancelled]â”€â”€> idle
  /// error â”€â”€[retry]â”€â”€> syncing
  /// error â”€â”€[giveUp]â”€â”€> idle

  void transition(SyncEvent event) {
    final newState = _getNextState(_state, event);
    if (newState != _state) {
      _state = newState;
      _stateController.add(_state);
    }
  }

  SyncState _getNextState(SyncState current, SyncEvent event) {
    switch (current) {
      case SyncState.idle:
        if (event == SyncEvent.startSync) return SyncState.syncing;
        break;
      case SyncState.syncing:
        if (event == SyncEvent.complete) return SyncState.idle;
        if (event == SyncEvent.conflict) return SyncState.conflictResolution;
        if (event == SyncEvent.error) return SyncState.error;
        break;
      case SyncState.conflictResolution:
        if (event == SyncEvent.resolved) return SyncState.syncing;
        if (event == SyncEvent.cancelled) return SyncState.idle;
        break;
      case SyncState.error:
        if (event == SyncEvent.retry) return SyncState.syncing;
        if (event == SyncEvent.giveUp) return SyncState.idle;
        break;
    }
    return current;
  }
}

enum SyncState { idle, syncing, conflictResolution, error }
enum SyncEvent { startSync, complete, conflict, error, resolved, cancelled, retry, giveUp }
```

### 19.3 ä¸šåŠ¡å¼‚å¸¸å¤„ç†

#### 19.3.1 é’±é¾„è®¡ç®—å¼‚å¸¸å¤„ç†

```dart
/// é’±é¾„è®¡ç®—å®¹é”™æœåŠ¡
class MoneyAgeCalculationService {
  /// è®¡ç®—é’±é¾„ï¼ˆå¸¦å®¹é”™ï¼‰
  Future<MoneyAgeResult> calculateMoneyAge({
    required List<Transaction> expenses,
    required List<Income> incomes,
  }) async {
    try {
      // 1. æ•°æ®é¢„å¤„ç†ä¸éªŒè¯
      final validatedExpenses = _validateExpenses(expenses);
      final validatedIncomes = _validateIncomes(incomes);

      // 2. å¼‚å¸¸æƒ…å†µå¤„ç†
      if (validatedIncomes.isEmpty) {
        // æ— æ”¶å…¥è®°å½• - è¿”å›ç‰¹æ®ŠçŠ¶æ€
        return MoneyAgeResult.noIncome(
          message: 'æš‚æ— æ”¶å…¥è®°å½•ï¼Œæ— æ³•è®¡ç®—é’±é¾„',
          suggestion: 'è¯·æ·»åŠ æ”¶å…¥è®°å½•ä»¥å¼€å§‹è¿½è¸ªé’±é¾„',
        );
      }

      if (validatedExpenses.isEmpty) {
        // æ— æ”¯å‡ºè®°å½• - é’±é¾„ä¸ºæ— ç©·å¤§ï¼ˆç†è®ºä¸Šï¼‰
        final oldestIncome = validatedIncomes
          .reduce((a, b) => a.date.isBefore(b.date) ? a : b);
        final daysSinceFirstIncome = DateTime.now().difference(oldestIncome.date).inDays;

        return MoneyAgeResult.noExpense(
          theoreticalAge: daysSinceFirstIncome,
          message: 'æ— æ”¯å‡ºè®°å½•ï¼Œæ‚¨çš„èµ„é‡‘éå¸¸å¥åº·ï¼',
        );
      }

      // 3. æ­£å¸¸è®¡ç®—
      final resourcePools = _buildResourcePools(validatedIncomes);
      final ageResult = _calculateWeightedAge(validatedExpenses, resourcePools);

      // 4. ç»“æœéªŒè¯
      if (ageResult.days < 0) {
        // è´Ÿæ•°é’±é¾„ - æ•°æ®å¼‚å¸¸
        _logger.warning('Negative money age detected', context: {
          'calculatedDays': ageResult.days,
          'expenseCount': validatedExpenses.length,
          'incomeCount': validatedIncomes.length,
        });
        return MoneyAgeResult.dataAnomaly(
          message: 'æ•°æ®å¯èƒ½å­˜åœ¨å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥äº¤æ˜“è®°å½•',
        );
      }

      if (ageResult.days > 3650) { // è¶…è¿‡10å¹´
        // å¼‚å¸¸é«˜çš„é’±é¾„ - å¯èƒ½æœ‰æœªè®°å½•çš„æ”¯å‡º
        return MoneyAgeResult.success(
          days: ageResult.days,
          warning: 'é’±é¾„è¶…è¿‡10å¹´ï¼Œå¯èƒ½æœ‰æœªè®°å½•çš„æ”¯å‡º',
        );
      }

      return MoneyAgeResult.success(days: ageResult.days);

    } catch (e, stackTrace) {
      _logger.error('Money age calculation failed', error: e, stackTrace: stackTrace);
      return MoneyAgeResult.error(
        message: 'é’±é¾„è®¡ç®—å¤±è´¥',
        error: e,
      );
    }
  }

  /// éªŒè¯æ”¯å‡ºæ•°æ®
  List<Transaction> _validateExpenses(List<Transaction> expenses) {
    return expenses.where((e) {
      // æ’é™¤æ— æ•ˆæ•°æ®
      if (e.amount <= 0) return false;
      if (e.amount.isNaN || e.amount.isInfinite) return false;
      if (e.date.isAfter(DateTime.now().add(Duration(days: 1)))) return false;
      return true;
    }).toList();
  }

  /// æ„å»ºèµ„æºæ± ï¼ˆå¤„ç†æ”¶å…¥æ—¶é—´é¡ºåºï¼‰
  List<ResourcePool> _buildResourcePools(List<Income> incomes) {
    // æŒ‰æ—¥æœŸæ’åº
    final sorted = List<Income>.from(incomes)
      ..sort((a, b) => a.date.compareTo(b.date));

    return sorted.map((income) => ResourcePool(
      incomeId: income.id,
      incomeDate: income.date,
      originalAmount: income.amount,
      remainingAmount: income.amount,
    )).toList();
  }
}
```

#### 19.3.2 é¢„ç®—åˆ†é…å¼‚å¸¸å¤„ç†

```dart
/// é›¶åŸºé¢„ç®—åˆ†é…æœåŠ¡ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
///
/// è¿™æ˜¯å®Œæ•´çš„åˆ†é…æœåŠ¡å®ç°ï¼Œæ”¯æŒå¤šç§åˆ†é…ç­–ç•¥å’Œå¥å£®çš„å¼‚å¸¸å¤„ç†ã€‚
/// ç®€åŒ–ç‰ˆæœ¬å‚è§5.2.2èŠ‚çš„ AllocationServiceã€‚
class BudgetAllocationService {
  /// åˆ†é…æ”¶å…¥åˆ°å°é‡‘åº“
  Future<AllocationResult> allocateIncome({
    required Income income,
    required List<BudgetVault> vaults,
    required AllocationStrategy strategy,
  }) async {
    final allocations = <VaultAllocation>[];
    var remainingAmount = income.amount;

    // 1. éªŒè¯è¾“å…¥
    if (income.amount <= 0) {
      return AllocationResult.invalid('æ”¶å…¥é‡‘é¢å¿…é¡»å¤§äº0');
    }

    if (vaults.isEmpty) {
      return AllocationResult.invalid('è¯·å…ˆåˆ›å»ºè‡³å°‘ä¸€ä¸ªå°é‡‘åº“');
    }

    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    final sortedVaults = _sortByPriority(vaults, strategy);

    // 3. åˆ†é…é€»è¾‘
    for (final vault in sortedVaults) {
      if (remainingAmount <= 0) break;

      double allocationAmount;

      switch (vault.allocationType) {
        case AllocationType.fixed:
          // å›ºå®šé‡‘é¢
          allocationAmount = min(vault.targetAllocation, remainingAmount);
          break;

        case AllocationType.percentage:
          // ç™¾åˆ†æ¯”
          allocationAmount = income.amount * vault.targetPercentage;
          allocationAmount = min(allocationAmount, remainingAmount);
          break;

        case AllocationType.remainder:
          // å‰©ä½™é‡‘é¢
          allocationAmount = remainingAmount;
          break;

        case AllocationType.topUp:
          // è¡¥è¶³åˆ°ç›®æ ‡
          final needed = vault.targetAmount - vault.currentAmount;
          allocationAmount = min(max(needed, 0), remainingAmount);
          break;
      }

      // 4. å¤„ç†åˆ†é…ç»“æœ
      if (allocationAmount > 0) {
        allocations.add(VaultAllocation(
          vaultId: vault.id,
          vaultName: vault.name,
          amount: allocationAmount,
          type: vault.allocationType,
        ));
        remainingAmount -= allocationAmount;
      }
    }

    // 5. å¤„ç†å‰©ä½™é‡‘é¢
    if (remainingAmount > 0.01) { // å…è®¸1åˆ†é’±çš„ç²¾åº¦è¯¯å·®
      // æœ‰æœªåˆ†é…é‡‘é¢
      return AllocationResult.partial(
        allocations: allocations,
        unallocated: remainingAmount,
        suggestion: 'æœ‰ Â¥${remainingAmount.toStringAsFixed(2)} æœªåˆ†é…ï¼Œ'
                   'å»ºè®®åˆ›å»º"æœºåŠ¨èµ„é‡‘"å°é‡‘åº“',
      );
    }

    // 6. ç™¾åˆ†æ¯”æ€»å’ŒéªŒè¯
    final totalPercentage = vaults
      .where((v) => v.allocationType == AllocationType.percentage)
      .fold(0.0, (sum, v) => sum + v.targetPercentage);

    if (totalPercentage > 1.0) {
      return AllocationResult.warning(
        allocations: allocations,
        warning: 'ç™¾åˆ†æ¯”æ€»å’Œè¶…è¿‡100%ï¼Œå®é™…æŒ‰æ¯”ä¾‹è°ƒæ•´',
      );
    }

    return AllocationResult.success(allocations: allocations);
  }
}
```

### 19.4 å¹‚ç­‰æ€§è®¾è®¡

#### 19.4.1 å¹‚ç­‰æ“ä½œå®ç°

```dart
/// å¹‚ç­‰æ€§æ“ä½œæœåŠ¡
class IdempotentOperationService {
  final DatabaseService _db;
  final CacheService _cache;

  /// å¹‚ç­‰é”®è¡¨ç»“æ„
  /// CREATE TABLE idempotency_keys (
  ///   key TEXT PRIMARY KEY,
  ///   operation_type TEXT NOT NULL,
  ///   result TEXT,
  ///   created_at TEXT NOT NULL,
  ///   expires_at TEXT NOT NULL
  /// );

  /// æ‰§è¡Œå¹‚ç­‰æ“ä½œ
  Future<T> executeIdempotent<T>({
    required String idempotencyKey,
    required String operationType,
    required Future<T> Function() operation,
    required T Function(String) deserializeResult,
    required String Function(T) serializeResult,
    Duration validity = const Duration(hours: 24),
  }) async {
    // 1. æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ
    final existing = await _getExistingResult(idempotencyKey);
    if (existing != null) {
      // å·²æ‰§è¡Œï¼Œè¿”å›ç¼“å­˜ç»“æœ
      return deserializeResult(existing);
    }

    // 2. è·å–é”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
    final lock = await _acquireLock(idempotencyKey);
    if (!lock) {
      // ç­‰å¾…å…¶ä»–è¯·æ±‚å®Œæˆ
      await _waitForResult(idempotencyKey);
      final result = await _getExistingResult(idempotencyKey);
      if (result != null) {
        return deserializeResult(result);
      }
      throw AppException(
        code: 'IDEMPOTENT_LOCK_FAILED',
        message: 'Failed to acquire idempotency lock',
        category: ExceptionCategory.system,
        severity: ExceptionSeverity.critical,
      );
    }

    try {
      // 3. æ‰§è¡Œæ“ä½œ
      final result = await operation();

      // 4. ä¿å­˜ç»“æœ
      await _saveResult(
        idempotencyKey,
        operationType,
        serializeResult(result),
        validity,
      );

      return result;
    } finally {
      // 5. é‡Šæ”¾é”
      await _releaseLock(idempotencyKey);
    }
  }

  /// ç”Ÿæˆå¹‚ç­‰é”®
  String generateKey({
    required String userId,
    required String operation,
    required Map<String, dynamic> params,
  }) {
    final sortedParams = SplayTreeMap<String, dynamic>.from(params);
    final paramsStr = jsonEncode(sortedParams);
    final bytes = utf8.encode('$userId:$operation:$paramsStr');
    return sha256.convert(bytes).toString();
  }
}

/// äº¤æ˜“åˆ›å»ºå¹‚ç­‰åŒ…è£…
class TransactionService {
  final IdempotentOperationService _idempotent;

  Future<Transaction> createTransaction({
    required String userId,
    required CreateTransactionRequest request,
    required String idempotencyKey,
  }) async {
    return await _idempotent.executeIdempotent<Transaction>(
      idempotencyKey: idempotencyKey,
      operationType: 'CREATE_TRANSACTION',
      operation: () => _doCreateTransaction(userId, request),
      serializeResult: (tx) => jsonEncode(tx.toJson()),
      deserializeResult: (json) => Transaction.fromJson(jsonDecode(json)),
    );
  }
}
```

### 19.5 é™çº§ä¸ç†”æ–­ç­–ç•¥

#### 19.5.1 æœåŠ¡é™çº§

```dart
/// æœåŠ¡é™çº§ç®¡ç†å™¨
class DegradationManager {
  final Map<String, ServiceHealth> _serviceHealth = {};

  /// AIæœåŠ¡é™çº§ç­–ç•¥
  Future<RecognitionResult> recognizeWithDegradation({
    required String input,
    required RecognitionType type,
  }) async {
    // 1. å°è¯•ä¸»æœåŠ¡ï¼ˆé€šä¹‰åƒé—®ï¼‰
    if (_isServiceHealthy('qwen')) {
      try {
        return await _qwenService.recognize(input, type);
      } catch (e) {
        _recordFailure('qwen');
        // ç»§ç»­å°è¯•å¤‡ç”¨æœåŠ¡
      }
    }

    // 2. å°è¯•å¤‡ç”¨æœåŠ¡ï¼ˆæ™ºè°±AIï¼‰
    if (_isServiceHealthy('zhipu')) {
      try {
        return await _zhipuService.recognize(input, type);
      } catch (e) {
        _recordFailure('zhipu');
        // ç»§ç»­é™çº§
      }
    }

    // 3. æœ¬åœ°è§„åˆ™å¼•æ“ï¼ˆç¦»çº¿å¯ç”¨ï¼‰
    try {
      return await _localRuleEngine.recognize(input, type);
    } catch (e) {
      // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥
    }

    // 4. æœ€ç»ˆé™çº§ï¼šè¿”å›æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
    return RecognitionResult.manualInput(
      suggestion: 'æ™ºèƒ½è¯†åˆ«æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥',
      partialResult: _extractBasicInfo(input),
    );
  }

  /// åŒæ­¥æœåŠ¡é™çº§
  Future<void> syncWithDegradation() async {
    if (!_isServiceHealthy('sync')) {
      // åŒæ­¥æœåŠ¡ä¸å¥åº·ï¼Œå»¶è¿ŸåŒæ­¥
      await _scheduleDelayedSync();
      return;
    }

    try {
      await _fullSync();
    } catch (e) {
      _recordFailure('sync');

      // é™çº§åˆ°å¢é‡åŒæ­¥
      try {
        await _incrementalSync();
      } catch (e) {
        // å¢é‡åŒæ­¥ä¹Ÿå¤±è´¥ï¼Œä»…åŒæ­¥å…³é”®æ•°æ®
        await _criticalDataSync();
      }
    }
  }
}

/// ç†”æ–­å™¨å®ç°
class CircuitBreaker {
  final String serviceName;
  final int failureThreshold;
  final Duration resetTimeout;

  CircuitState _state = CircuitState.closed;
  int _failureCount = 0;
  DateTime? _lastFailure;
  DateTime? _openedAt;

  CircuitBreaker({
    required this.serviceName,
    this.failureThreshold = 5,
    this.resetTimeout = const Duration(minutes: 1),
  });

  /// æ‰§è¡Œå¸¦ç†”æ–­ä¿æŠ¤çš„æ“ä½œ
  Future<T> execute<T>(Future<T> Function() operation) async {
    // æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
    if (_state == CircuitState.open) {
      if (_shouldAttemptReset()) {
        _state = CircuitState.halfOpen;
      } else {
        throw CircuitBreakerOpenException(serviceName);
      }
    }

    try {
      final result = await operation();
      _onSuccess();
      return result;
    } catch (e) {
      _onFailure();
      rethrow;
    }
  }

  void _onSuccess() {
    _failureCount = 0;
    _state = CircuitState.closed;
  }

  void _onFailure() {
    _failureCount++;
    _lastFailure = DateTime.now();

    if (_failureCount >= failureThreshold) {
      _state = CircuitState.open;
      _openedAt = DateTime.now();
    }
  }

  bool _shouldAttemptReset() {
    if (_openedAt == null) return true;
    return DateTime.now().difference(_openedAt!) >= resetTimeout;
  }
}

enum CircuitState { closed, open, halfOpen }
```

### 19.6 ç”¨æˆ·ä½“éªŒä¿éšœ

#### 19.6.1 å¼‚å¸¸UIåé¦ˆ

```dart
/// å¼‚å¸¸UIå¤„ç†å™¨
class ExceptionUIHandler {
  /// æ˜¾ç¤ºå¼‚å¸¸åé¦ˆ
  void showExceptionFeedback(
    BuildContext context,
    AppException exception,
  ) {
    switch (exception.severity) {
      case ExceptionSeverity.ignorable:
        // ä¸æ˜¾ç¤º
        break;

      case ExceptionSeverity.recoverable:
        // çŸ­æš‚æç¤ºï¼Œè‡ªåŠ¨æ¶ˆå¤±
        _showAutoRetrySnackBar(context, exception);
        break;

      case ExceptionSeverity.warning:
        // ç”¨æˆ·å¯æ“ä½œçš„æç¤º
        _showActionableSnackBar(context, exception);
        break;

      case ExceptionSeverity.critical:
        // é˜»æ–­å¼å¯¹è¯æ¡†
        _showBlockingDialog(context, exception);
        break;

      case ExceptionSeverity.fatal:
        // å…¨å±é”™è¯¯é¡µ
        _navigateToErrorPage(context, exception);
        break;
    }
  }

  /// è‡ªåŠ¨é‡è¯•æç¤º
  void _showAutoRetrySnackBar(BuildContext context, AppException exception) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            SizedBox(
              width: 16,
              height: 16,
              child: CircularProgressIndicator(strokeWidth: 2),
            ),
            SizedBox(width: 12),
            Expanded(child: Text(exception.userMessage ?? 'æ­£åœ¨é‡è¯•...')),
          ],
        ),
        duration: Duration(seconds: 3),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// å¯æ“ä½œæç¤º
  void _showActionableSnackBar(BuildContext context, AppException exception) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(exception.userMessage ?? exception.message),
        action: SnackBarAction(
          label: 'é‡è¯•',
          onPressed: () => _retryLastOperation(),
        ),
        duration: Duration(seconds: 5),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// é˜»æ–­å¼å¯¹è¯æ¡†
  void _showBlockingDialog(BuildContext context, AppException exception) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        icon: Icon(Icons.error_outline, color: Colors.red, size: 48),
        title: Text('æ“ä½œå¤±è´¥'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(exception.userMessage ?? exception.message),
            if (exception.code != null) ...[
              SizedBox(height: 8),
              Text(
                'é”™è¯¯ä»£ç : ${exception.code}',
                style: TextStyle(fontSize: 12, color: Colors.grey),
              ),
            ],
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('å–æ¶ˆ'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              _retryLastOperation();
            },
            child: Text('é‡è¯•'),
          ),
        ],
      ),
    );
  }
}
```

---

## 20. å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„

æœ¬ç« èŠ‚åŸºäº**å¯æ‰©å±•æ€§åŸåˆ™**å’Œ**æ¼”è¿›å¼æ¶æ„åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿçš„æ‰©å±•èƒ½åŠ›å’Œæœªæ¥æ¼”è¿›è·¯å¾„ã€‚

### 20.1 æ¨¡å—åŒ–æ¶æ„è®¾è®¡

#### 20.1.1 æ’ä»¶åŒ–åŠŸèƒ½æ¨¡å—

```dart
/// åŠŸèƒ½æ¨¡å—æ³¨å†Œè¡¨
class FeatureRegistry {
  static final FeatureRegistry _instance = FeatureRegistry._();
  factory FeatureRegistry() => _instance;
  FeatureRegistry._();

  final Map<String, FeatureModule> _modules = {};
  final Map<String, List<String>> _dependencies = {};

  /// æ³¨å†ŒåŠŸèƒ½æ¨¡å—
  void register(FeatureModule module) {
    if (_modules.containsKey(module.id)) {
      throw FeatureRegistrationException('Module ${module.id} already registered');
    }

    // æ£€æŸ¥ä¾èµ–
    for (final dep in module.dependencies) {
      if (!_modules.containsKey(dep)) {
        throw FeatureRegistrationException(
          'Module ${module.id} depends on $dep which is not registered'
        );
      }
    }

    _modules[module.id] = module;
    _dependencies[module.id] = module.dependencies;
  }

  /// è·å–æ¨¡å—
  T? getModule<T extends FeatureModule>(String id) {
    return _modules[id] as T?;
  }

  /// åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
  Future<void> initializeAll() async {
    final sorted = _topologicalSort();
    for (final moduleId in sorted) {
      await _modules[moduleId]!.initialize();
    }
  }

  /// æ‹“æ‰‘æ’åºï¼ˆå¤„ç†ä¾èµ–é¡ºåºï¼‰
  List<String> _topologicalSort() {
    final result = <String>[];
    final visited = <String>{};
    final temp = <String>{};

    void visit(String id) {
      if (temp.contains(id)) {
        throw FeatureRegistrationException('Circular dependency detected: $id');
      }
      if (visited.contains(id)) return;

      temp.add(id);
      for (final dep in _dependencies[id] ?? []) {
        visit(dep);
      }
      temp.remove(id);
      visited.add(id);
      result.add(id);
    }

    for (final id in _modules.keys) {
      visit(id);
    }

    return result;
  }
}

/// åŠŸèƒ½æ¨¡å—åŸºç±»
abstract class FeatureModule {
  String get id;
  String get name;
  String get version;
  List<String> get dependencies => [];

  /// æ¨¡å—åˆå§‹åŒ–
  Future<void> initialize();

  /// æ¨¡å—é”€æ¯
  Future<void> dispose();

  /// æ¨¡å—å¥åº·æ£€æŸ¥
  Future<HealthStatus> healthCheck();
}

/// é’±é¾„æ¨¡å—ç¤ºä¾‹
class MoneyAgeModule extends FeatureModule {
  @override
  String get id => 'money_age';

  @override
  String get name => 'é’±é¾„åˆ†æ';

  @override
  String get version => '1.0.0';

  @override
  List<String> get dependencies => ['transaction', 'income'];

  late final MoneyAgeCalculator _calculator;
  late final MoneyAgeRepository _repository;

  @override
  Future<void> initialize() async {
    _repository = MoneyAgeRepository();
    _calculator = MoneyAgeCalculator(_repository);

    // æ³¨å†ŒProvider
    GetIt.I.registerSingleton<MoneyAgeCalculator>(_calculator);
  }

  @override
  Future<void> dispose() async {
    GetIt.I.unregister<MoneyAgeCalculator>();
  }

  @override
  Future<HealthStatus> healthCheck() async {
    try {
      await _calculator.calculateMoneyAge([]);
      return HealthStatus.healthy;
    } catch (e) {
      return HealthStatus.unhealthy(e.toString());
    }
  }
}
```

#### 19.1.2 ç­–ç•¥æ¨¡å¼æ‰©å±•ç‚¹

```dart
/// è®°è´¦ç­–ç•¥æ‰©å±•ç‚¹
abstract class BookkeepingStrategy {
  String get strategyId;
  String get strategyName;

  /// å¤„ç†äº¤æ˜“åˆ›å»º
  Future<Transaction> processTransaction(TransactionInput input);

  /// éªŒè¯äº¤æ˜“
  Future<ValidationResult> validateTransaction(Transaction transaction);

  /// è·å–æ¨èåˆ†ç±»
  Future<List<Category>> getRecommendedCategories(TransactionInput input);
}

/// ä¼ ç»Ÿè®°è´¦ç­–ç•¥
class TraditionalBookkeepingStrategy implements BookkeepingStrategy {
  @override
  String get strategyId => 'traditional';

  @override
  String get strategyName => 'ä¼ ç»Ÿè®°è´¦';

  @override
  Future<Transaction> processTransaction(TransactionInput input) async {
    // ä¼ ç»Ÿè®°è´¦ï¼šç›´æ¥åˆ›å»ºäº¤æ˜“
    return Transaction(
      id: uuid.v4(),
      amount: input.amount,
      type: input.type,
      categoryId: input.categoryId,
      accountId: input.accountId,
      date: input.date ?? DateTime.now(),
      description: input.description,
    );
  }

  @override
  Future<ValidationResult> validateTransaction(Transaction transaction) async {
    final errors = <String>[];

    if (transaction.amount <= 0) {
      errors.add('é‡‘é¢å¿…é¡»å¤§äº0');
    }
    if (transaction.categoryId == null) {
      errors.add('è¯·é€‰æ‹©åˆ†ç±»');
    }

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
    );
  }

  @override
  Future<List<Category>> getRecommendedCategories(TransactionInput input) async {
    // åŸºäºå†å²è®°å½•æ¨è
    return await _categoryService.getFrequentCategories(limit: 5);
  }
}

/// é›¶åŸºé¢„ç®—ç­–ç•¥
class ZeroBasedBookkeepingStrategy implements BookkeepingStrategy {
  @override
  String get strategyId => 'zero_based';

  @override
  String get strategyName => 'é›¶åŸºé¢„ç®—';

  @override
  Future<Transaction> processTransaction(TransactionInput input) async {
    // é›¶åŸºé¢„ç®—ï¼šåˆ›å»ºäº¤æ˜“ + å…³è”å°é‡‘åº“ + æ›´æ–°èµ„æºæ± 
    final transaction = await _createTransaction(input);

    // æŸ¥æ‰¾æˆ–åˆ›å»ºå°é‡‘åº“å…³è”
    if (input.type == TransactionType.expense) {
      final vault = await _findMatchingVault(transaction);
      if (vault != null) {
        await _linkToVault(transaction, vault);
        await _updateResourcePool(transaction);
      }
    } else if (input.type == TransactionType.income) {
      await _createResourcePool(transaction);
    }

    return transaction;
  }

  @override
  Future<ValidationResult> validateTransaction(Transaction transaction) async {
    final baseResult = await TraditionalBookkeepingStrategy()
      .validateTransaction(transaction);

    final errors = List<String>.from(baseResult.errors);
    final warnings = <String>[];

    // é›¶åŸºé¢„ç®—ç‰¹æœ‰éªŒè¯
    if (transaction.type == TransactionType.expense) {
      final vault = await _findMatchingVault(transaction);
      if (vault == null) {
        warnings.add('æ­¤æ”¯å‡ºæœªå…³è”å°é‡‘åº“ï¼Œå°†è®¡å…¥"æœªåˆ†é…"');
      } else if (transaction.amount > vault.remainingAmount) {
        warnings.add('æ­¤æ”¯å‡ºå°†è¶…å‡ºå°é‡‘åº“é¢„ç®—');
      }
    }

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
      warnings: warnings,
    );
  }

  @override
  Future<List<Category>> getRecommendedCategories(TransactionInput input) async {
    // åŸºäºå°é‡‘åº“æ¨è
    final vaultsWithBudget = await _getVaultsWithRemainingBudget();
    return vaultsWithBudget
      .where((v) => v.linkedCategory != null)
      .map((v) => v.linkedCategory!)
      .toList();
  }
}

/// ç­–ç•¥ç®¡ç†å™¨
class BookkeepingStrategyManager {
  final Map<String, BookkeepingStrategy> _strategies = {};
  String _currentStrategyId = 'traditional';

  void registerStrategy(BookkeepingStrategy strategy) {
    _strategies[strategy.strategyId] = strategy;
  }

  void setCurrentStrategy(String strategyId) {
    if (!_strategies.containsKey(strategyId)) {
      throw StrategyNotFoundException(strategyId);
    }
    _currentStrategyId = strategyId;
  }

  BookkeepingStrategy get currentStrategy => _strategies[_currentStrategyId]!;

  List<BookkeepingStrategy> get availableStrategies => _strategies.values.toList();
}
```

### 20.2 æ•°æ®æ¨¡å‹æ‰©å±•

#### 20.2.1 å¯æ‰©å±•çš„æ•°æ®æ¨¡å‹

```dart
/// å¯æ‰©å±•å®ä½“åŸºç±»
abstract class ExtensibleEntity {
  String get id;
  DateTime get createdAt;
  DateTime get updatedAt;

  /// æ‰©å±•å±æ€§ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
  Map<String, dynamic> get extensions;

  /// è·å–æ‰©å±•å±æ€§
  T? getExtension<T>(String key) {
    final value = extensions[key];
    if (value == null) return null;
    if (value is T) return value;

    // å°è¯•ç±»å‹è½¬æ¢
    return _convertExtension<T>(value);
  }

  /// è®¾ç½®æ‰©å±•å±æ€§
  ExtensibleEntity setExtension(String key, dynamic value);
}

/// äº¤æ˜“å®ä½“ï¼ˆå¯æ‰©å±•ï¼‰
class Transaction extends ExtensibleEntity {
  @override
  final String id;
  final double amount;
  final TransactionType type;
  final String? categoryId;
  final String accountId;
  final DateTime date;
  final String? description;

  @override
  final DateTime createdAt;
  @override
  final DateTime updatedAt;
  @override
  final Map<String, dynamic> extensions;

  Transaction({
    required this.id,
    required this.amount,
    required this.type,
    this.categoryId,
    required this.accountId,
    required this.date,
    this.description,
    DateTime? createdAt,
    DateTime? updatedAt,
    Map<String, dynamic>? extensions,
  }) : createdAt = createdAt ?? DateTime.now(),
       updatedAt = updatedAt ?? DateTime.now(),
       extensions = extensions ?? {};

  /// æ‰©å±•å±æ€§å¿«æ·è®¿é—®

  /// åœ°ç†ä½ç½®ï¼ˆå¦‚æœå¯ç”¨äº†ä½ç½®æ¨¡å—ï¼‰
  GeoLocation? get location => getExtension<GeoLocation>('location');

  /// å…³è”çš„å°é‡‘åº“IDï¼ˆå¦‚æœå¯ç”¨äº†é›¶åŸºé¢„ç®—ï¼‰
  String? get vaultId => getExtension<String>('vault_id');

  /// èµ„æºæ± æ¶ˆè€—è®°å½•ï¼ˆå¦‚æœå¯ç”¨äº†é’±é¾„è®¡ç®—ï¼‰
  List<ResourcePoolConsumption>? get resourcePoolConsumptions =>
    getExtension<List<ResourcePoolConsumption>>('resource_consumptions');

  /// æºæ•°æ®ï¼ˆå¦‚æœæ˜¯å¯¼å…¥çš„äº¤æ˜“ï¼‰
  SourceData? get sourceData => getExtension<SourceData>('source_data');

  /// æ ‡ç­¾åˆ—è¡¨
  List<String> get tags => getExtension<List<String>>('tags') ?? [];

  /// é™„ä»¶åˆ—è¡¨
  List<Attachment> get attachments =>
    getExtension<List<Attachment>>('attachments') ?? [];

  @override
  Transaction setExtension(String key, dynamic value) {
    return copyWith(
      extensions: {...extensions, key: value},
    );
  }

  Transaction copyWith({
    String? id,
    double? amount,
    TransactionType? type,
    String? categoryId,
    String? accountId,
    DateTime? date,
    String? description,
    DateTime? createdAt,
    DateTime? updatedAt,
    Map<String, dynamic>? extensions,
  }) {
    return Transaction(
      id: id ?? this.id,
      amount: amount ?? this.amount,
      type: type ?? this.type,
      categoryId: categoryId ?? this.categoryId,
      accountId: accountId ?? this.accountId,
      date: date ?? this.date,
      description: description ?? this.description,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: DateTime.now(),
      extensions: extensions ?? this.extensions,
    );
  }
}
```

#### 19.2.2 æ•°æ®åº“è¿ç§»æ¡†æ¶

```dart
/// æ•°æ®åº“è¿ç§»æ¡†æ¶
class MigrationFramework {
  final DatabaseService _db;
  final Logger _logger;

  /// è¿ç§»æ³¨å†Œè¡¨
  final List<Migration> _migrations = [];

  /// æ³¨å†Œè¿ç§»
  void registerMigration(Migration migration) {
    _migrations.add(migration);
    _migrations.sort((a, b) => a.version.compareTo(b.version));
  }

  /// æ‰§è¡Œè¿ç§»
  Future<MigrationResult> migrate() async {
    final currentVersion = await _getCurrentVersion();
    final targetVersion = _migrations.last.version;

    if (currentVersion >= targetVersion) {
      return MigrationResult.upToDate();
    }

    final pendingMigrations = _migrations
      .where((m) => m.version > currentVersion)
      .toList();

    _logger.info('Starting migration from v$currentVersion to v$targetVersion');

    final executedMigrations = <int>[];

    try {
      for (final migration in pendingMigrations) {
        _logger.info('Executing migration v${migration.version}: ${migration.description}');

        await _db.transaction((txn) async {
          // æ‰§è¡Œè¿ç§»
          await migration.up(txn);

          // æ›´æ–°ç‰ˆæœ¬å·
          await _updateVersion(txn, migration.version);
        });

        executedMigrations.add(migration.version);
      }

      return MigrationResult.success(
        fromVersion: currentVersion,
        toVersion: targetVersion,
        executedMigrations: executedMigrations,
      );
    } catch (e, stackTrace) {
      _logger.error('Migration failed', error: e, stackTrace: stackTrace);

      // å°è¯•å›æ»š
      if (executedMigrations.isNotEmpty) {
        await _rollback(executedMigrations.last);
      }

      return MigrationResult.failed(
        error: e,
        lastSuccessfulVersion: executedMigrations.isEmpty
          ? currentVersion
          : executedMigrations.last,
      );
    }
  }

  /// å›æ»šè¿ç§»
  Future<void> _rollback(int toVersion) async {
    final currentVersion = await _getCurrentVersion();

    final migrationsToRollback = _migrations
      .where((m) => m.version <= currentVersion && m.version > toVersion)
      .toList()
      .reversed;

    for (final migration in migrationsToRollback) {
      if (migration.down != null) {
        _logger.info('Rolling back migration v${migration.version}');
        await _db.transaction((txn) async {
          await migration.down!(txn);
          await _updateVersion(txn, migration.version - 1);
        });
      }
    }
  }
}

/// è¿ç§»å®šä¹‰
class Migration {
  final int version;
  final String description;
  final Future<void> Function(Transaction txn) up;
  final Future<void> Function(Transaction txn)? down;

  Migration({
    required this.version,
    required this.description,
    required this.up,
    this.down,
  });
}

/// ç¤ºä¾‹è¿ç§»ï¼šæ·»åŠ åœ°ç†ä½ç½®æ”¯æŒ
final migration_25_add_location = Migration(
  version: 25,
  description: 'æ·»åŠ åœ°ç†ä½ç½®å­—æ®µæ”¯æŒ',
  up: (txn) async {
    // æ·»åŠ ä½ç½®è¡¨
    await txn.execute('''
      CREATE TABLE IF NOT EXISTS locations (
        id TEXT PRIMARY KEY,
        city TEXT NOT NULL,
        province TEXT,
        country TEXT DEFAULT 'CN',
        city_tier TEXT,
        latitude REAL,
        longitude REAL,
        created_at TEXT NOT NULL
      )
    ''');

    // æ·»åŠ äº¤æ˜“-ä½ç½®å…³è”ç´¢å¼•
    await txn.execute('''
      CREATE INDEX IF NOT EXISTS idx_transactions_location
      ON transactions((json_extract(extensions, '$.location.city')))
    ''');
  },
  down: (txn) async {
    await txn.execute('DROP TABLE IF EXISTS locations');
    await txn.execute('DROP INDEX IF EXISTS idx_transactions_location');
  },
);
```

### 20.3 APIç‰ˆæœ¬ç®¡ç†

#### 20.3.1 APIç‰ˆæœ¬æ§åˆ¶

```dart
/// APIç‰ˆæœ¬ç®¡ç†å™¨
class ApiVersionManager {
  /// å½“å‰æ”¯æŒçš„APIç‰ˆæœ¬
  static const List<String> supportedVersions = ['v1', 'v2'];
  static const String latestVersion = 'v2';
  static const String minimumVersion = 'v1';

  /// ç‰ˆæœ¬åå•†
  String negotiateVersion(String? requestedVersion) {
    if (requestedVersion == null) {
      return latestVersion;
    }

    if (supportedVersions.contains(requestedVersion)) {
      return requestedVersion;
    }

    // å°è¯•å‘ä¸‹å…¼å®¹
    final requestedMajor = _extractMajorVersion(requestedVersion);
    for (final version in supportedVersions.reversed) {
      if (_extractMajorVersion(version) <= requestedMajor) {
        return version;
      }
    }

    throw ApiVersionException(
      'API version $requestedVersion is not supported. '
      'Minimum version: $minimumVersion, Latest: $latestVersion'
    );
  }

  int _extractMajorVersion(String version) {
    return int.parse(version.replaceAll('v', ''));
  }
}

/// APIç‰ˆæœ¬é€‚é…å™¨
abstract class ApiVersionAdapter<TRequest, TResponse> {
  String get version;

  /// è¯·æ±‚è½¬æ¢ï¼ˆæ—§ç‰ˆæœ¬ -> æœ€æ–°ç‰ˆæœ¬ï¼‰
  TRequest transformRequest(TRequest request);

  /// å“åº”è½¬æ¢ï¼ˆæœ€æ–°ç‰ˆæœ¬ -> æ—§ç‰ˆæœ¬ï¼‰
  TResponse transformResponse(TResponse response);
}

/// äº¤æ˜“API v1é€‚é…å™¨
class TransactionApiV1Adapter
    extends ApiVersionAdapter<TransactionRequest, TransactionResponse> {
  @override
  String get version => 'v1';

  @override
  TransactionRequest transformRequest(TransactionRequest request) {
    // v1ä¸æ”¯æŒextensionså­—æ®µï¼Œå¿½ç•¥
    return request.copyWith(extensions: null);
  }

  @override
  TransactionResponse transformResponse(TransactionResponse response) {
    // v1å“åº”ä¸åŒ…å«extensionså­—æ®µ
    return response.copyWith(
      data: response.data.map((tx) => tx.copyWith(extensions: {})).toList(),
    );
  }
}
```

### 20.4 æ¼”è¿›å¼æ¶æ„è·¯çº¿

#### 20.4.1 æ¶æ„æ¼”è¿›é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ¶æ„æ¼”è¿›è·¯çº¿å›¾                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  é˜¶æ®µ1: å•ä½“åº”ç”¨ (å½“å‰)                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Flutter App â†â†’ FastAPI Backend â†â†’ PostgreSQL + Redis                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  é€‚ç”¨è§„æ¨¡: DAU < 10,000                                               â”‚  â”‚
â”‚  â”‚  ç‰¹ç‚¹: ç®€å•éƒ¨ç½²ã€ä½æˆæœ¬ã€å¿«é€Ÿè¿­ä»£                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“ (DAU > 10,000)                               â”‚
â”‚                                                                             â”‚
â”‚  é˜¶æ®µ2: å‚ç›´æ‹†åˆ†                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        API Gateway (Nginx)                            â”‚  â”‚
â”‚  â”‚                              â†“                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·æœåŠ¡   â”‚    â”‚  è®°è´¦æœåŠ¡   â”‚    â”‚  ç»Ÿè®¡æœåŠ¡   â”‚               â”‚  â”‚
â”‚  â”‚  â”‚  (Auth)     â”‚    â”‚ (Bookkeep)  â”‚    â”‚  (Stats)    â”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â”‚         â”‚                  â”‚                  â”‚                       â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚  â”‚                   â†“                  â†“                                â”‚  â”‚
â”‚  â”‚            PostgreSQL (ä¸»)      Redis (ç¼“å­˜)                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  é€‚ç”¨è§„æ¨¡: 10,000 < DAU < 50,000                                      â”‚  â”‚
â”‚  â”‚  ç‰¹ç‚¹: æœåŠ¡éš”ç¦»ã€ç‹¬ç«‹æ‰©å±•ã€ä¸­ç­‰å¤æ‚åº¦                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“ (DAU > 50,000)                               â”‚
â”‚                                                                             â”‚
â”‚  é˜¶æ®µ3: å¾®æœåŠ¡æ¶æ„                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    API Gateway + Service Mesh                         â”‚  â”‚
â”‚  â”‚                              â†“                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·  â”‚ â”‚ è´¦æˆ·  â”‚ â”‚ äº¤æ˜“  â”‚ â”‚ é¢„ç®—  â”‚ â”‚ ç»Ÿè®¡  â”‚ â”‚  AI   â”‚        â”‚  â”‚
â”‚  â”‚  â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚      â”‚         â”‚         â”‚         â”‚         â”‚         â”‚             â”‚  â”‚
â”‚  â”‚      â†“         â†“         â†“         â†“         â†“         â†“             â”‚  â”‚
â”‚  â”‚   UserDB   AccountDB  TransDB   BudgetDB  StatsDB    AI-API         â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  æ¶ˆæ¯é˜Ÿåˆ—: Kafka / RabbitMQ                                           â”‚  â”‚
â”‚  â”‚  æœåŠ¡å‘ç°: Consul / etcd                                              â”‚  â”‚
â”‚  â”‚  é…ç½®ä¸­å¿ƒ: Apollo / Nacos                                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  é€‚ç”¨è§„æ¨¡: DAU > 50,000                                               â”‚  â”‚
â”‚  â”‚  ç‰¹ç‚¹: é«˜å¯ç”¨ã€é«˜æ‰©å±•ã€å¤æ‚åº¦é«˜ã€è¿ç»´æˆæœ¬é«˜                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 19.4.2 å¹³æ»‘è¿ç§»ç­–ç•¥

```dart
/// æœåŠ¡æŠ½è±¡å±‚ï¼ˆæ”¯æŒå¹³æ»‘è¿ç§»ï¼‰
abstract class ServiceClient<T> {
  Future<T> call(ServiceRequest request);
}

/// æœ¬åœ°æœåŠ¡å®¢æˆ·ç«¯ï¼ˆå•ä½“é˜¶æ®µï¼‰
class LocalServiceClient<T> implements ServiceClient<T> {
  final T Function(ServiceRequest) _handler;

  LocalServiceClient(this._handler);

  @override
  Future<T> call(ServiceRequest request) async {
    return _handler(request);
  }
}

/// è¿œç¨‹æœåŠ¡å®¢æˆ·ç«¯ï¼ˆå¾®æœåŠ¡é˜¶æ®µï¼‰
class RemoteServiceClient<T> implements ServiceClient<T> {
  final String _serviceUrl;
  final HttpClient _httpClient;
  final T Function(Map<String, dynamic>) _deserializer;

  RemoteServiceClient(this._serviceUrl, this._httpClient, this._deserializer);

  @override
  Future<T> call(ServiceRequest request) async {
    final response = await _httpClient.post(
      Uri.parse(_serviceUrl),
      body: jsonEncode(request.toJson()),
    );
    return _deserializer(jsonDecode(response.body));
  }
}

/// æœåŠ¡å·¥å‚ï¼ˆæ ¹æ®é…ç½®é€‰æ‹©å®ç°ï¼‰
class ServiceFactory {
  final AppConfig _config;

  ServiceClient<TransactionList> createTransactionService() {
    if (_config.useRemoteServices) {
      return RemoteServiceClient(
        _config.transactionServiceUrl,
        HttpClient(),
        (json) => TransactionList.fromJson(json),
      );
    } else {
      return LocalServiceClient(
        (request) => _localTransactionService.handle(request),
      );
    }
  }
}
```

### 20.5 åŠŸèƒ½å¼€å…³ä¸ç°åº¦å‘å¸ƒ

#### 20.5.1 åŠŸèƒ½å¼€å…³ç³»ç»Ÿ

```dart
/// åŠŸèƒ½å¼€å…³æœåŠ¡
class FeatureFlagService {
  final RemoteConfigService _remoteConfig;
  final LocalStorageService _localStorage;

  /// åŠŸèƒ½å¼€å…³å®šä¹‰
  static const Map<String, FeatureFlagDefinition> _definitions = {
    'zero_based_budget': FeatureFlagDefinition(
      name: 'é›¶åŸºé¢„ç®—',
      description: 'å¯ç”¨é›¶åŸºé¢„ç®—åŠŸèƒ½',
      defaultEnabled: false,
      rolloutPercentage: 100, // å·²å…¨é‡
    ),
    'money_age': FeatureFlagDefinition(
      name: 'é’±é¾„è®¡ç®—',
      description: 'å¯ç”¨é’±é¾„è®¡ç®—å’Œå±•ç¤º',
      defaultEnabled: false,
      rolloutPercentage: 100, // å·²å…¨é‡
    ),
    'geo_location': FeatureFlagDefinition(
      name: 'åœ°ç†ä½ç½®æ™ºèƒ½',
      description: 'å¯ç”¨åŸºäºä½ç½®çš„æ™ºèƒ½æ¨è',
      defaultEnabled: false,
      rolloutPercentage: 50, // 50%ç°åº¦
    ),
    'ai_recognition_v2': FeatureFlagDefinition(
      name: 'AIè¯†åˆ«V2',
      description: 'ä½¿ç”¨æ–°ç‰ˆAIè¯†åˆ«å¼•æ“',
      defaultEnabled: false,
      rolloutPercentage: 20, // 20%ç°åº¦
    ),
    'collaborative_budget': FeatureFlagDefinition(
      name: 'åä½œé¢„ç®—',
      description: 'æ”¯æŒå¤šäººå…±äº«é¢„ç®—',
      defaultEnabled: false,
      rolloutPercentage: 0, // æœªå¼€æ”¾
      requiredVersion: '2.1.0',
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  Future<bool> isEnabled(String featureKey, {String? userId}) async {
    final definition = _definitions[featureKey];
    if (definition == null) return false;

    // 1. æ£€æŸ¥ç‰ˆæœ¬è¦æ±‚
    if (definition.requiredVersion != null) {
      final currentVersion = await _getCurrentAppVersion();
      if (!_meetsVersionRequirement(currentVersion, definition.requiredVersion!)) {
        return false;
      }
    }

    // 2. æ£€æŸ¥è¿œç¨‹é…ç½®è¦†ç›–
    final remoteOverride = await _remoteConfig.getBool('feature_$featureKey');
    if (remoteOverride != null) return remoteOverride;

    // 3. æ£€æŸ¥æœ¬åœ°è¦†ç›–ï¼ˆå¼€å‘/æµ‹è¯•ç”¨ï¼‰
    final localOverride = _localStorage.getBool('feature_override_$featureKey');
    if (localOverride != null) return localOverride;

    // 4. æ£€æŸ¥ç°åº¦ç™¾åˆ†æ¯”
    if (userId != null && definition.rolloutPercentage < 100) {
      final userBucket = _getUserBucket(userId, featureKey);
      return userBucket < definition.rolloutPercentage;
    }

    // 5. è¿”å›é»˜è®¤å€¼
    return definition.defaultEnabled || definition.rolloutPercentage >= 100;
  }

  /// æ ¹æ®ç”¨æˆ·IDè®¡ç®—bucketï¼ˆç¡®ä¿åŒä¸€ç”¨æˆ·å§‹ç»ˆåœ¨åŒä¸€bucketï¼‰
  int _getUserBucket(String userId, String featureKey) {
    final hash = md5.convert(utf8.encode('$userId:$featureKey'));
    return hash.bytes.first % 100;
  }

  /// å¯ç”¨åŠŸèƒ½ï¼ˆç”¨äºA/Bæµ‹è¯•ï¼‰
  Widget featureWidget({
    required String featureKey,
    required Widget enabledWidget,
    required Widget disabledWidget,
    String? userId,
  }) {
    return FutureBuilder<bool>(
      future: isEnabled(featureKey, userId: userId),
      builder: (context, snapshot) {
        if (snapshot.hasData && snapshot.data!) {
          return enabledWidget;
        }
        return disabledWidget;
      },
    );
  }
}
```

---

## 21. å¯è§‚æµ‹æ€§ä¸ç›‘æ§

æœ¬ç« èŠ‚åŸºäº**å¯è§‚æµ‹æ€§åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿçš„ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªèƒ½åŠ›ã€‚

### 21.1 æ—¥å¿—ç³»ç»Ÿ

#### 21.1.1 ç»“æ„åŒ–æ—¥å¿—

```dart
/// ç»“æ„åŒ–æ—¥å¿—æœåŠ¡
class LoggerService {
  static final LoggerService _instance = LoggerService._();
  factory LoggerService() => _instance;
  LoggerService._();

  late final Logger _logger;
  final List<LogOutput> _outputs = [];

  /// åˆå§‹åŒ–
  Future<void> initialize({
    required LogLevel minLevel,
    required List<LogOutput> outputs,
  }) async {
    _outputs.addAll(outputs);
    _logger = Logger(
      printer: StructuredLogPrinter(),
      filter: ProductionFilter(minLevel),
      output: MultiOutput(_outputs),
    );
  }

  /// æ—¥å¿—æ–¹æ³•
  void debug(String message, {Map<String, dynamic>? context}) {
    _log(LogLevel.debug, message, context: context);
  }

  void info(String message, {Map<String, dynamic>? context}) {
    _log(LogLevel.info, message, context: context);
  }

  void warning(String message, {Map<String, dynamic>? context, dynamic error}) {
    _log(LogLevel.warning, message, context: context, error: error);
  }

  void error(String message, {
    Map<String, dynamic>? context,
    dynamic error,
    StackTrace? stackTrace,
  }) {
    _log(LogLevel.error, message, context: context, error: error, stackTrace: stackTrace);
  }

  void _log(
    LogLevel level,
    String message, {
    Map<String, dynamic>? context,
    dynamic error,
    StackTrace? stackTrace,
  }) {
    final logEntry = LogEntry(
      timestamp: DateTime.now(),
      level: level,
      message: message,
      context: {
        ...?context,
        'app_version': BuildInfo.version,
        'build_number': BuildInfo.buildNumber,
        'platform': Platform.operatingSystem,
        if (error != null) 'error': error.toString(),
        if (stackTrace != null) 'stack_trace': stackTrace.toString(),
      },
    );

    for (final output in _outputs) {
      output.write(logEntry);
    }
  }
}

/// æ—¥å¿—æ¡ç›®
class LogEntry {
  final DateTime timestamp;
  final LogLevel level;
  final String message;
  final Map<String, dynamic> context;

  LogEntry({
    required this.timestamp,
    required this.level,
    required this.message,
    required this.context,
  });

  Map<String, dynamic> toJson() => {
    'timestamp': timestamp.toIso8601String(),
    'level': level.name,
    'message': message,
    ...context,
  };
}

/// æ§åˆ¶å°è¾“å‡º
class ConsoleLogOutput extends LogOutput {
  @override
  void write(LogEntry entry) {
    final color = _getColor(entry.level);
    print('$color[${entry.level.name.toUpperCase()}] ${entry.timestamp}: ${entry.message}\x1B[0m');
    if (entry.context.isNotEmpty) {
      print('  Context: ${jsonEncode(entry.context)}');
    }
  }
}

/// æ–‡ä»¶è¾“å‡º
class FileLogOutput extends LogOutput {
  final File _logFile;
  IOSink? _sink;

  FileLogOutput(String path) : _logFile = File(path);

  @override
  void write(LogEntry entry) {
    _sink ??= _logFile.openWrite(mode: FileMode.append);
    _sink!.writeln(jsonEncode(entry.toJson()));
  }

  Future<void> flush() async {
    await _sink?.flush();
  }
}

/// è¿œç¨‹æ—¥å¿—è¾“å‡º
class RemoteLogOutput extends LogOutput {
  final String _endpoint;
  final List<LogEntry> _buffer = [];
  final int _batchSize;
  Timer? _flushTimer;

  RemoteLogOutput(this._endpoint, {int batchSize = 100})
    : _batchSize = batchSize {
    _flushTimer = Timer.periodic(Duration(seconds: 30), (_) => _flush());
  }

  @override
  void write(LogEntry entry) {
    _buffer.add(entry);
    if (_buffer.length >= _batchSize) {
      _flush();
    }
  }

  Future<void> _flush() async {
    if (_buffer.isEmpty) return;

    final batch = List<LogEntry>.from(_buffer);
    _buffer.clear();

    try {
      await http.post(
        Uri.parse(_endpoint),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(batch.map((e) => e.toJson()).toList()),
      );
    } catch (e) {
      // ä¸ŠæŠ¥å¤±è´¥ï¼Œé‡æ–°å…¥é˜Ÿï¼ˆæœ‰é™åˆ¶ï¼‰
      if (_buffer.length < 1000) {
        _buffer.insertAll(0, batch);
      }
    }
  }
}
```

### 21.2 æ€§èƒ½ç›‘æ§

#### 21.2.1 æ€§èƒ½è¿½è¸ª

```dart
/// æ€§èƒ½ç›‘æ§æœåŠ¡
class PerformanceMonitor {
  static final PerformanceMonitor _instance = PerformanceMonitor._();
  factory PerformanceMonitor() => _instance;
  PerformanceMonitor._();

  final Map<String, PerformanceTrace> _activeTraces = {};
  final List<PerformanceMetric> _metrics = [];

  /// å¼€å§‹è¿½è¸ª
  PerformanceTrace startTrace(String name, {Map<String, dynamic>? attributes}) {
    final trace = PerformanceTrace(
      name: name,
      startTime: DateTime.now(),
      attributes: attributes ?? {},
    );
    _activeTraces[trace.id] = trace;
    return trace;
  }

  /// ç»“æŸè¿½è¸ª
  void endTrace(PerformanceTrace trace) {
    trace.endTime = DateTime.now();
    _activeTraces.remove(trace.id);

    final metric = PerformanceMetric(
      name: trace.name,
      duration: trace.duration,
      attributes: trace.attributes,
      timestamp: trace.startTime,
    );

    _metrics.add(metric);
    _reportMetric(metric);
  }

  /// æµ‹é‡æ“ä½œ
  Future<T> measure<T>(
    String name,
    Future<T> Function() operation, {
    Map<String, dynamic>? attributes,
  }) async {
    final trace = startTrace(name, attributes: attributes);
    try {
      final result = await operation();
      trace.attributes['success'] = true;
      return result;
    } catch (e) {
      trace.attributes['success'] = false;
      trace.attributes['error'] = e.toString();
      rethrow;
    } finally {
      endTrace(trace);
    }
  }

  /// è®°å½•å¸§ç‡
  void recordFrameRate(double fps) {
    _metrics.add(PerformanceMetric(
      name: 'frame_rate',
      duration: Duration.zero,
      attributes: {'fps': fps},
      timestamp: DateTime.now(),
    ));
  }

  /// è®°å½•å†…å­˜ä½¿ç”¨
  void recordMemoryUsage() {
    final usage = ProcessInfo.currentRss;
    _metrics.add(PerformanceMetric(
      name: 'memory_usage',
      duration: Duration.zero,
      attributes: {'bytes': usage},
      timestamp: DateTime.now(),
    ));
  }
}

/// æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç›‘æ§
class QueryPerformanceMonitor {
  /// åŒ…è£…æ•°æ®åº“æŸ¥è¯¢
  Future<T> monitorQuery<T>(
    String queryName,
    Future<T> Function() query, {
    String? sql,
    Map<String, dynamic>? parameters,
  }) async {
    final stopwatch = Stopwatch()..start();

    try {
      final result = await query();
      stopwatch.stop();

      _recordQueryMetric(
        name: queryName,
        duration: stopwatch.elapsed,
        success: true,
        rowCount: _extractRowCount(result),
      );

      // æ…¢æŸ¥è¯¢è­¦å‘Š
      if (stopwatch.elapsedMilliseconds > 500) {
        LoggerService().warning(
          'Slow query detected: $queryName',
          context: {
            'duration_ms': stopwatch.elapsedMilliseconds,
            'sql': sql,
            'parameters': parameters,
          },
        );
      }

      return result;
    } catch (e) {
      stopwatch.stop();
      _recordQueryMetric(
        name: queryName,
        duration: stopwatch.elapsed,
        success: false,
        error: e.toString(),
      );
      rethrow;
    }
  }
}
```

#### 20.2.2 ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

```dart
/// ç”¨æˆ·ä½“éªŒæŒ‡æ ‡æ”¶é›†
class UXMetricsCollector {
  /// é¡µé¢åŠ è½½æ—¶é—´
  void recordPageLoad(String pageName, Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'page_load',
      duration: duration,
      attributes: {'page': pageName},
      timestamp: DateTime.now(),
    ));
  }

  /// ç”¨æˆ·äº¤äº’å“åº”æ—¶é—´
  void recordInteraction(String action, Duration responseTime) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'interaction_response',
      duration: responseTime,
      attributes: {'action': action},
      timestamp: DateTime.now(),
    ));
  }

  /// é¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼ˆFCPï¼‰
  void recordFCP(Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'first_contentful_paint',
      duration: duration,
      attributes: {},
      timestamp: DateTime.now(),
    ));
  }

  /// å¯äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰
  void recordTTI(Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'time_to_interactive',
      duration: duration,
      attributes: {},
      timestamp: DateTime.now(),
    ));
  }
}

/// é¡µé¢æ€§èƒ½è¿½è¸ªMixin
mixin PagePerformanceTracker<T extends StatefulWidget> on State<T> {
  late final DateTime _pageStartTime;
  late final Stopwatch _renderStopwatch;

  @override
  void initState() {
    super.initState();
    _pageStartTime = DateTime.now();
    _renderStopwatch = Stopwatch()..start();
  }

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();

    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_renderStopwatch.isRunning) {
        _renderStopwatch.stop();
        UXMetricsCollector().recordPageLoad(
          widget.runtimeType.toString(),
          _renderStopwatch.elapsed,
        );
      }
    });
  }
}
```

### 21.3 é”™è¯¯è¿½è¸ª

#### 21.3.1 é”™è¯¯ä¸ŠæŠ¥æœåŠ¡

```dart
/// é”™è¯¯è¿½è¸ªæœåŠ¡
class ErrorTrackingService {
  static final ErrorTrackingService _instance = ErrorTrackingService._();
  factory ErrorTrackingService() => _instance;
  ErrorTrackingService._();

  late final String _dsn;
  late final String _environment;
  final Map<String, dynamic> _userContext = {};
  final List<String> _breadcrumbs = [];

  /// åˆå§‹åŒ–
  void initialize({
    required String dsn,
    required String environment,
  }) {
    _dsn = dsn;
    _environment = environment;

    // æ•è·Flutteré”™è¯¯
    FlutterError.onError = (details) {
      captureException(
        details.exception,
        stackTrace: details.stack,
        context: {'flutter_error': details.exceptionAsString()},
      );
    };

    // æ•è·æœªå¤„ç†çš„å¼‚æ­¥é”™è¯¯
    PlatformDispatcher.instance.onError = (error, stack) {
      captureException(error, stackTrace: stack);
      return true;
    };
  }

  /// è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
  void setUser(String userId, {String? email, Map<String, dynamic>? extra}) {
    _userContext['id'] = userId;
    if (email != null) _userContext['email'] = email;
    if (extra != null) _userContext.addAll(extra);
  }

  /// æ·»åŠ é¢åŒ…å±‘
  void addBreadcrumb(String message, {String? category, Map<String, dynamic>? data}) {
    _breadcrumbs.add(jsonEncode({
      'timestamp': DateTime.now().toIso8601String(),
      'message': message,
      'category': category,
      'data': data,
    }));

    // ä¿ç•™æœ€è¿‘50æ¡
    while (_breadcrumbs.length > 50) {
      _breadcrumbs.removeAt(0);
    }
  }

  /// æ•è·å¼‚å¸¸
  Future<void> captureException(
    dynamic exception, {
    StackTrace? stackTrace,
    Map<String, dynamic>? context,
    ErrorSeverity severity = ErrorSeverity.error,
  }) async {
    final errorReport = ErrorReport(
      exception: exception.toString(),
      stackTrace: stackTrace?.toString(),
      severity: severity,
      environment: _environment,
      appVersion: BuildInfo.version,
      buildNumber: BuildInfo.buildNumber,
      platform: Platform.operatingSystem,
      platformVersion: Platform.operatingSystemVersion,
      user: _userContext,
      breadcrumbs: List.from(_breadcrumbs),
      context: context,
      timestamp: DateTime.now(),
    );

    // æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿æ—¶ï¼‰
    await _storeLocally(errorReport);

    // å°è¯•ä¸ŠæŠ¥
    await _uploadReport(errorReport);
  }

  /// æœ¬åœ°å­˜å‚¨
  Future<void> _storeLocally(ErrorReport report) async {
    final db = await DatabaseService().database;
    await db.insert('error_reports', {
      'id': uuid.v4(),
      'data': jsonEncode(report.toJson()),
      'created_at': DateTime.now().toIso8601String(),
      'uploaded': 0,
    });
  }

  /// ä¸ŠæŠ¥é”™è¯¯
  Future<void> _uploadReport(ErrorReport report) async {
    try {
      await http.post(
        Uri.parse(_dsn),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(report.toJson()),
      );

      // æ ‡è®°ä¸ºå·²ä¸ŠæŠ¥
      await _markAsUploaded(report.id);
    } catch (e) {
      // é™é»˜å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡åŒæ­¥
    }
  }

  /// åŒæ­¥æœªä¸ŠæŠ¥çš„é”™è¯¯
  Future<void> syncPendingReports() async {
    final db = await DatabaseService().database;
    final pending = await db.query(
      'error_reports',
      where: 'uploaded = 0',
      limit: 50,
    );

    for (final row in pending) {
      try {
        await http.post(
          Uri.parse(_dsn),
          headers: {'Content-Type': 'application/json'},
          body: row['data'],
        );
        await db.update(
          'error_reports',
          {'uploaded': 1},
          where: 'id = ?',
          whereArgs: [row['id']],
        );
      } catch (e) {
        break; // ç½‘ç»œé—®é¢˜ï¼Œåœæ­¢åŒæ­¥
      }
    }
  }
}

enum ErrorSeverity { debug, info, warning, error, fatal }
```

### 21.4 å¥åº·æ£€æŸ¥

#### 21.4.1 åº”ç”¨å¥åº·æ£€æŸ¥

```dart
/// å¥åº·æ£€æŸ¥æœåŠ¡
class HealthCheckService {
  /// æ‰§è¡Œå…¨é¢å¥åº·æ£€æŸ¥
  Future<HealthReport> performHealthCheck() async {
    final checks = <HealthCheckResult>[];

    // 1. æ•°æ®åº“æ£€æŸ¥
    checks.add(await _checkDatabase());

    // 2. ç½‘ç»œæ£€æŸ¥
    checks.add(await _checkNetwork());

    // 3. å­˜å‚¨ç©ºé—´æ£€æŸ¥
    checks.add(await _checkStorage());

    // 4. å†…å­˜æ£€æŸ¥
    checks.add(await _checkMemory());

    // 5. APIæœåŠ¡æ£€æŸ¥
    checks.add(await _checkApiServices());

    // 6. AIæœåŠ¡æ£€æŸ¥
    checks.add(await _checkAiServices());

    // æ±‡æ€»ç»“æœ
    final overallStatus = checks.any((c) => c.status == HealthStatus.critical)
      ? HealthStatus.critical
      : checks.any((c) => c.status == HealthStatus.degraded)
        ? HealthStatus.degraded
        : HealthStatus.healthy;

    return HealthReport(
      timestamp: DateTime.now(),
      overallStatus: overallStatus,
      checks: checks,
    );
  }

  /// æ•°æ®åº“å¥åº·æ£€æŸ¥
  Future<HealthCheckResult> _checkDatabase() async {
    try {
      final db = await DatabaseService().database;
      final stopwatch = Stopwatch()..start();

      // æ‰§è¡Œç®€å•æŸ¥è¯¢
      await db.rawQuery('SELECT 1');

      stopwatch.stop();

      return HealthCheckResult(
        name: 'database',
        status: stopwatch.elapsedMilliseconds < 100
          ? HealthStatus.healthy
          : HealthStatus.degraded,
        latency: stopwatch.elapsed,
        details: {'query_time_ms': stopwatch.elapsedMilliseconds},
      );
    } catch (e) {
      return HealthCheckResult(
        name: 'database',
        status: HealthStatus.critical,
        error: e.toString(),
      );
    }
  }

  /// å­˜å‚¨ç©ºé—´æ£€æŸ¥
  Future<HealthCheckResult> _checkStorage() async {
    try {
      final appDir = await getApplicationDocumentsDirectory();
      final stat = await appDir.stat();

      // è·å–å¯ç”¨ç©ºé—´ï¼ˆå¹³å°ç‰¹å®šï¼‰
      final freeSpace = await _getFreeSpace();
      final totalSpace = await _getTotalSpace();
      final usagePercent = (totalSpace - freeSpace) / totalSpace * 100;

      HealthStatus status;
      if (freeSpace < 100 * 1024 * 1024) { // < 100MB
        status = HealthStatus.critical;
      } else if (freeSpace < 500 * 1024 * 1024) { // < 500MB
        status = HealthStatus.degraded;
      } else {
        status = HealthStatus.healthy;
      }

      return HealthCheckResult(
        name: 'storage',
        status: status,
        details: {
          'free_space_mb': freeSpace ~/ (1024 * 1024),
          'total_space_mb': totalSpace ~/ (1024 * 1024),
          'usage_percent': usagePercent.toStringAsFixed(1),
        },
      );
    } catch (e) {
      return HealthCheckResult(
        name: 'storage',
        status: HealthStatus.degraded,
        error: e.toString(),
      );
    }
  }

  /// APIæœåŠ¡æ£€æŸ¥
  Future<HealthCheckResult> _checkApiServices() async {
    try {
      final stopwatch = Stopwatch()..start();

      final response = await http.get(
        Uri.parse('${AppConfig.apiBaseUrl}/health'),
      ).timeout(Duration(seconds: 5));

      stopwatch.stop();

      if (response.statusCode == 200) {
        return HealthCheckResult(
          name: 'api_service',
          status: stopwatch.elapsedMilliseconds < 1000
            ? HealthStatus.healthy
            : HealthStatus.degraded,
          latency: stopwatch.elapsed,
          details: jsonDecode(response.body),
        );
      } else {
        return HealthCheckResult(
          name: 'api_service',
          status: HealthStatus.degraded,
          details: {'status_code': response.statusCode},
        );
      }
    } catch (e) {
      return HealthCheckResult(
        name: 'api_service',
        status: HealthStatus.critical,
        error: e.toString(),
      );
    }
  }
}

enum HealthStatus { healthy, degraded, critical }

/// å¥åº·æ£€æŸ¥ç»“æœ
class HealthCheckResult {
  final String name;
  final HealthStatus status;
  final Duration? latency;
  final Map<String, dynamic>? details;
  final String? error;

  HealthCheckResult({
    required this.name,
    required this.status,
    this.latency,
    this.details,
    this.error,
  });
}
```

### 21.5 å‘Šè­¦ç³»ç»Ÿ

#### 21.5.1 å‘Šè­¦è§„åˆ™ä¸é€šçŸ¥

```dart
/// å‘Šè­¦æœåŠ¡
class AlertService {
  final List<AlertRule> _rules = [];
  final List<AlertChannel> _channels = [];

  /// æ³¨å†Œå‘Šè­¦è§„åˆ™
  void registerRule(AlertRule rule) {
    _rules.add(rule);
  }

  /// æ³¨å†Œé€šçŸ¥æ¸ é“
  void registerChannel(AlertChannel channel) {
    _channels.add(channel);
  }

  /// æ£€æŸ¥å‘Šè­¦æ¡ä»¶
  Future<void> checkAlerts(MetricData metrics) async {
    for (final rule in _rules) {
      if (rule.evaluate(metrics)) {
        await _triggerAlert(rule, metrics);
      }
    }
  }

  /// è§¦å‘å‘Šè­¦
  Future<void> _triggerAlert(AlertRule rule, MetricData metrics) async {
    final alert = Alert(
      ruleId: rule.id,
      ruleName: rule.name,
      severity: rule.severity,
      message: rule.formatMessage(metrics),
      timestamp: DateTime.now(),
      metrics: metrics,
    );

    // æ£€æŸ¥å‘Šè­¦æŠ‘åˆ¶
    if (await _shouldSuppress(alert)) {
      return;
    }

    // å‘é€åˆ°æ‰€æœ‰æ¸ é“
    for (final channel in _channels.where((c) => c.acceptsSeverity(rule.severity))) {
      try {
        await channel.send(alert);
      } catch (e) {
        LoggerService().error('Failed to send alert via ${channel.name}', error: e);
      }
    }

    // è®°å½•å‘Šè­¦å†å²
    await _recordAlert(alert);
  }
}

/// å‘Šè­¦è§„åˆ™
class AlertRule {
  final String id;
  final String name;
  final AlertSeverity severity;
  final bool Function(MetricData) condition;
  final String Function(MetricData) messageTemplate;
  final Duration cooldown;

  AlertRule({
    required this.id,
    required this.name,
    required this.severity,
    required this.condition,
    required this.messageTemplate,
    this.cooldown = const Duration(minutes: 5),
  });

  bool evaluate(MetricData metrics) => condition(metrics);
  String formatMessage(MetricData metrics) => messageTemplate(metrics);
}

/// é¢„å®šä¹‰å‘Šè­¦è§„åˆ™
class PredefinedAlertRules {
  static final highErrorRate = AlertRule(
    id: 'high_error_rate',
    name: 'é«˜é”™è¯¯ç‡',
    severity: AlertSeverity.critical,
    condition: (m) => m.errorRate > 0.05, // 5%
    messageTemplate: (m) => 'é”™è¯¯ç‡è¿‡é«˜: ${(m.errorRate * 100).toStringAsFixed(1)}%',
  );

  static final slowApiResponse = AlertRule(
    id: 'slow_api',
    name: 'APIå“åº”æ…¢',
    severity: AlertSeverity.warning,
    condition: (m) => m.avgApiLatency.inMilliseconds > 2000,
    messageTemplate: (m) => 'APIå¹³å‡å“åº”æ—¶é—´: ${m.avgApiLatency.inMilliseconds}ms',
  );

  static final lowDiskSpace = AlertRule(
    id: 'low_disk',
    name: 'ç£ç›˜ç©ºé—´ä¸è¶³',
    severity: AlertSeverity.warning,
    condition: (m) => m.freeDiskSpace < 100 * 1024 * 1024, // 100MB
    messageTemplate: (m) => 'å¯ç”¨ç©ºé—´: ${m.freeDiskSpace ~/ (1024 * 1024)}MB',
  );

  static final syncFailure = AlertRule(
    id: 'sync_failure',
    name: 'åŒæ­¥å¤±è´¥',
    severity: AlertSeverity.warning,
    condition: (m) => m.syncFailureCount > 3,
    messageTemplate: (m) => 'è¿ç»­åŒæ­¥å¤±è´¥${m.syncFailureCount}æ¬¡',
  );
}

enum AlertSeverity { info, warning, critical }

/// æœ¬åœ°é€šçŸ¥æ¸ é“
class LocalNotificationChannel extends AlertChannel {
  @override
  String get name => 'local_notification';

  @override
  Future<void> send(Alert alert) async {
    await FlutterLocalNotificationsPlugin().show(
      alert.hashCode,
      _getSeverityTitle(alert.severity),
      alert.message,
      NotificationDetails(
        android: AndroidNotificationDetails(
          'alerts',
          'ç³»ç»Ÿå‘Šè­¦',
          importance: _getImportance(alert.severity),
          priority: Priority.high,
        ),
        iOS: DarwinNotificationDetails(),
      ),
    );
  }

  Importance _getImportance(AlertSeverity severity) {
    switch (severity) {
      case AlertSeverity.critical: return Importance.max;
      case AlertSeverity.warning: return Importance.high;
      case AlertSeverity.info: return Importance.defaultImportance;
    }
  }
}
```

---

## 22. æ— éšœç¢è®¾è®¡

æœ¬ç« èŠ‚ç¡®ä¿åº”ç”¨å¯¹æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬è§†åŠ›éšœç¢ã€å¬åŠ›éšœç¢ã€è¿åŠ¨éšœç¢ç­‰ç”¨æˆ·ï¼‰éƒ½å…·æœ‰è‰¯å¥½çš„å¯è®¿é—®æ€§ã€‚

### 22.1 æ— éšœç¢è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ— éšœç¢è®¾è®¡å››åŸåˆ™                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   å¯æ„ŸçŸ¥        â”‚  â”‚   å¯æ“ä½œ        â”‚  â”‚   å¯ç†è§£        â”‚         â”‚
â”‚  â”‚  Perceivable   â”‚  â”‚   Operable     â”‚  â”‚  Understandable â”‚         â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚ ä¿¡æ¯å’Œç•Œé¢ç»„ä»¶  â”‚  â”‚ ç”¨æˆ·ç•Œé¢ç»„ä»¶å’Œ  â”‚  â”‚ ä¿¡æ¯å’Œç”¨æˆ·ç•Œé¢  â”‚         â”‚
â”‚  â”‚ å¿…é¡»ä»¥ç”¨æˆ·å¯æ„Ÿ  â”‚  â”‚ å¯¼èˆªå¿…é¡»æ˜¯å¯æ“  â”‚  â”‚ çš„æ“ä½œå¿…é¡»æ˜¯å¯  â”‚         â”‚
â”‚  â”‚ çŸ¥çš„æ–¹å¼å‘ˆç°    â”‚  â”‚ ä½œçš„            â”‚  â”‚ ç†è§£çš„          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                        å¥å£®æ€§ Robust                         â”‚       â”‚
â”‚  â”‚   å†…å®¹å¿…é¡»è¶³å¤Ÿå¥å£®ï¼Œèƒ½å¤Ÿè¢«å„ç§ç”¨æˆ·ä»£ç†ï¼ˆåŒ…æ‹¬è¾…åŠ©æŠ€æœ¯ï¼‰å¯é è§£æ   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 22.2 è§†è§‰æ— éšœç¢

#### 22.2.1 å±å¹•é˜…è¯»å™¨æ”¯æŒ

```dart
/// è¯­ä¹‰åŒ–æ ‡ç­¾æœåŠ¡
class SemanticLabelService {
  /// ä¸ºæ‰€æœ‰äº¤äº’å…ƒç´ æä¾›è¯­ä¹‰æ ‡ç­¾
  static Widget wrapWithSemantics({
    required Widget child,
    required String label,
    String? hint,
    String? value,
    bool isButton = false,
    bool isHeader = false,
    VoidCallback? onTap,
  }) {
    return Semantics(
      label: label,
      hint: hint,
      value: value,
      button: isButton,
      header: isHeader,
      onTap: onTap,
      child: child,
    );
  }

  /// é‡‘é¢è¯­ä¹‰æ ‡ç­¾
  static String formatAmountForScreenReader(double amount, String currency) {
    final isNegative = amount < 0;
    final absAmount = amount.abs();
    final formatted = absAmount.toStringAsFixed(2);
    final parts = formatted.split('.');

    return '${isNegative ? "æ”¯å‡º" : "æ”¶å…¥"} '
           '${parts[0]} ${currency} ${parts[1]} åˆ†';
  }

  /// é’±é¾„è¯­ä¹‰æ ‡ç­¾
  static String formatMoneyAgeForScreenReader(int days, MoneyAgeLevel level) {
    final levelText = switch (level) {
      MoneyAgeLevel.ideal => 'è´¢åŠ¡è‡ªç”±',
      MoneyAgeLevel.excellent => 'éå¸¸å¥åº·',
      MoneyAgeLevel.good => 'è‰¯å¥½',
      MoneyAgeLevel.normal => 'ä¸€èˆ¬',
      MoneyAgeLevel.warning => 'éœ€è¦å…³æ³¨',
      MoneyAgeLevel.danger => 'éœ€è¦æ”¹å–„',
    };
    return 'é’±é¾„ $days å¤©ï¼ŒçŠ¶æ€ $levelText';
  }
}

/// å±å¹•é˜…è¯»å™¨å‹å¥½çš„é‡‘é¢å¡ç‰‡
class AccessibleAmountCard extends StatelessWidget {
  final double amount;
  final String title;
  final String currency;

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: '$title: ${SemanticLabelService.formatAmountForScreenReader(amount, currency)}',
      child: ExcludeSemantics(
        child: Card(
          child: Column(
            children: [
              Text(title),
              Text('$currency ${amount.toStringAsFixed(2)}'),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 22.2.2 è‰²å½©å¯¹æ¯”åº¦

```dart
/// æ— éšœç¢é¢œè‰²æœåŠ¡
class AccessibleColorService {
  /// WCAG 2.1 AAçº§åˆ«è¦æ±‚çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioAA = 4.5;
  /// WCAG 2.1 AAAçº§åˆ«è¦æ±‚çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioAAA = 7.0;
  /// å¤§æ–‡æœ¬çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioLargeText = 3.0;

  /// è®¡ç®—ä¸¤ä¸ªé¢œè‰²çš„å¯¹æ¯”åº¦
  static double calculateContrastRatio(Color foreground, Color background) {
    final l1 = _calculateRelativeLuminance(foreground);
    final l2 = _calculateRelativeLuminance(background);
    final lighter = l1 > l2 ? l1 : l2;
    final darker = l1 > l2 ? l2 : l1;
    return (lighter + 0.05) / (darker + 0.05);
  }

  static double _calculateRelativeLuminance(Color color) {
    final r = _linearize(color.red / 255);
    final g = _linearize(color.green / 255);
    final b = _linearize(color.blue / 255);
    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
  }

  static double _linearize(double value) {
    return value <= 0.03928
        ? value / 12.92
        : pow((value + 0.055) / 1.055, 2.4).toDouble();
  }

  /// è·å–æ— éšœç¢å‹å¥½çš„å‰æ™¯è‰²
  static Color getAccessibleForeground(Color background, {bool largeText = false}) {
    final minRatio = largeText ? minContrastRatioLargeText : minContrastRatioAA;

    // é¦–é€‰é»‘è‰²
    if (calculateContrastRatio(Colors.black, background) >= minRatio) {
      return Colors.black;
    }
    // å¦åˆ™ä½¿ç”¨ç™½è‰²
    return Colors.white;
  }

  /// éªŒè¯é¢œè‰²ç»„åˆæ˜¯å¦ç¬¦åˆæ— éšœç¢è¦æ±‚
  static bool isAccessibleColorCombination(
    Color foreground,
    Color background, {
    bool largeText = false,
    AccessibilityLevel level = AccessibilityLevel.aa,
  }) {
    final ratio = calculateContrastRatio(foreground, background);
    final minRatio = switch ((level, largeText)) {
      (AccessibilityLevel.aa, true) => minContrastRatioLargeText,
      (AccessibilityLevel.aa, false) => minContrastRatioAA,
      (AccessibilityLevel.aaa, true) => minContrastRatioAA,
      (AccessibilityLevel.aaa, false) => minContrastRatioAAA,
    };
    return ratio >= minRatio;
  }
}

enum AccessibilityLevel { aa, aaa }
```

#### 22.2.3 æ–‡å­—ç¼©æ”¾æ”¯æŒ

```dart
/// æ–‡å­—ç¼©æ”¾æœåŠ¡
class TextScalingService {
  /// æ”¯æŒçš„æ–‡å­—ç¼©æ”¾èŒƒå›´
  static const double minScale = 0.8;
  static const double maxScale = 2.0;
  static const double defaultScale = 1.0;

  /// åˆ›å»ºå“åº”å¼æ–‡å­—æ ·å¼
  static TextStyle createResponsiveTextStyle({
    required double baseFontSize,
    FontWeight? fontWeight,
    Color? color,
  }) {
    return TextStyle(
      fontSize: baseFontSize,
      fontWeight: fontWeight,
      color: color,
    );
  }

  /// è‡ªé€‚åº”é—´è·è®¡ç®—
  static double calculateResponsiveSpacing(
    BuildContext context,
    double baseSpacing,
  ) {
    final textScaleFactor = MediaQuery.of(context).textScaleFactor;
    return baseSpacing * (1 + (textScaleFactor - 1) * 0.5);
  }
}

/// æ”¯æŒæ–‡å­—ç¼©æ”¾çš„å¸ƒå±€
class AccessibleLayout extends StatelessWidget {
  final Widget child;

  @override
  Widget build(BuildContext context) {
    final textScaleFactor = MediaQuery.of(context).textScaleFactor;

    // å½“æ–‡å­—æ”¾å¤§æ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´å¸ƒå±€
    if (textScaleFactor > 1.3) {
      return SingleChildScrollView(
        child: child,
      );
    }
    return child;
  }
}
```

### 22.3 æ“ä½œæ— éšœç¢

#### 22.3.1 è§¦æ§ç›®æ ‡å°ºå¯¸

```dart
/// è§¦æ§ç›®æ ‡æ— éšœç¢æœåŠ¡
class TouchTargetService {
  /// æœ€å°è§¦æ§ç›®æ ‡å°ºå¯¸ (WCAG 2.5.5 è¦æ±‚ 44x44 é€»è¾‘åƒç´ )
  static const double minTouchTarget = 48.0;

  /// ç¡®ä¿è§¦æ§ç›®æ ‡å°ºå¯¸è¶³å¤Ÿå¤§
  static Widget ensureMinTouchTarget({
    required Widget child,
    VoidCallback? onTap,
  }) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minWidth: minTouchTarget,
        minHeight: minTouchTarget,
      ),
      child: InkWell(
        onTap: onTap,
        child: Center(child: child),
      ),
    );
  }

  /// åˆ›å»ºæ— éšœç¢æŒ‰é’®
  static Widget createAccessibleButton({
    required Widget child,
    required VoidCallback onPressed,
    required String semanticLabel,
  }) {
    return Semantics(
      button: true,
      label: semanticLabel,
      child: Material(
        child: InkWell(
          onTap: onPressed,
          child: ConstrainedBox(
            constraints: BoxConstraints(
              minWidth: minTouchTarget,
              minHeight: minTouchTarget,
            ),
            child: Center(child: child),
          ),
        ),
      ),
    );
  }
}
```

#### 22.3.2 é”®ç›˜å¯¼èˆª

```dart
/// é”®ç›˜å¯¼èˆªæœåŠ¡
class KeyboardNavigationService {
  /// ä¸ºWidgetæ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
  static Widget addKeyboardShortcuts({
    required Widget child,
    Map<ShortcutActivator, VoidCallback>? shortcuts,
  }) {
    if (shortcuts == null || shortcuts.isEmpty) {
      return child;
    }

    return Shortcuts(
      shortcuts: {
        for (final entry in shortcuts.entries)
          entry.key: VoidCallbackIntent(entry.value),
      },
      child: Actions(
        actions: {
          VoidCallbackIntent: CallbackAction<VoidCallbackIntent>(
            onInvoke: (intent) => intent.callback(),
          ),
        },
        child: Focus(
          autofocus: true,
          child: child,
        ),
      ),
    );
  }
}

/// å…¨å±€é”®ç›˜å¿«æ·é”®
class GlobalKeyboardShortcuts {
  static final shortcuts = {
    // è®°è´¦ç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.keyN, LogicalKeyboardKey.control):
        'new_transaction',
    LogicalKeySet(LogicalKeyboardKey.keyS, LogicalKeyboardKey.control):
        'save',

    // å¯¼èˆªç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.keyH, LogicalKeyboardKey.alt):
        'go_home',
    LogicalKeySet(LogicalKeyboardKey.keyB, LogicalKeyboardKey.alt):
        'go_budget',
    LogicalKeySet(LogicalKeyboardKey.keyT, LogicalKeyboardKey.alt):
        'go_transactions',

    // æ“ä½œç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.escape): 'cancel',
    LogicalKeySet(LogicalKeyboardKey.enter): 'confirm',
  };
}
```

#### 22.3.3 ç„¦ç‚¹ç®¡ç†

```dart
/// ç„¦ç‚¹ç®¡ç†æœåŠ¡
class FocusManagementService {
  /// ç¡®ä¿å¯¹è¯æ¡†æ‰“å¼€æ—¶ç„¦ç‚¹æ­£ç¡®ç®¡ç†
  static Future<T?> showAccessibleDialog<T>({
    required BuildContext context,
    required WidgetBuilder builder,
    String? semanticLabel,
  }) {
    return showDialog<T>(
      context: context,
      builder: (context) {
        return Semantics(
          label: semanticLabel,
          scopesRoute: true,
          namesRoute: true,
          child: builder(context),
        );
      },
    );
  }

  /// åˆ›å»ºå¸¦ç„¦ç‚¹é™·é˜±çš„æ¨¡æ€
  static Widget createFocusTrap({
    required Widget child,
  }) {
    return FocusTraversalGroup(
      policy: OrderedTraversalPolicy(),
      child: child,
    );
  }
}
```

### 22.4 è®¤çŸ¥æ— éšœç¢

#### 22.4.1 æ¸…æ™°çš„é”™è¯¯æç¤º

```dart
/// æ— éšœç¢é”™è¯¯æç¤ºæœåŠ¡
class AccessibleErrorService {
  /// åˆ›å»ºæ— éšœç¢é”™è¯¯æç¤º
  static Widget createAccessibleError({
    required String errorMessage,
    String? suggestion,
    VoidCallback? onRetry,
  }) {
    return Semantics(
      liveRegion: true,  // è‡ªåŠ¨æœ—è¯»
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.red.shade50,
          border: Border.all(color: Colors.red, width: 2),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.error, color: Colors.red),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    errorMessage,
                    style: TextStyle(
                      color: Colors.red.shade900,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            if (suggestion != null) ...[
              SizedBox(height: 8),
              Text(
                suggestion,
                style: TextStyle(color: Colors.red.shade700),
              ),
            ],
            if (onRetry != null) ...[
              SizedBox(height: 12),
              TouchTargetService.createAccessibleButton(
                child: Text('é‡è¯•'),
                onPressed: onRetry,
                semanticLabel: 'é‡è¯•æ“ä½œ',
              ),
            ],
          ],
        ),
      ),
    );
  }
}
```

#### 22.4.2 æ“ä½œç¡®è®¤ä¸æ’¤é”€

```dart
/// æ“ä½œç¡®è®¤æœåŠ¡
class ActionConfirmationService {
  /// åˆ é™¤æ“ä½œç¡®è®¤ï¼ˆå¸¦æ’¤é”€é€‰é¡¹ï¼‰
  static Future<bool> confirmDeletion({
    required BuildContext context,
    required String itemName,
    required Future<void> Function() onDelete,
    required Future<void> Function() onUndo,
  }) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Semantics(
          header: true,
          child: Text('ç¡®è®¤åˆ é™¤'),
        ),
        content: Text('ç¡®å®šè¦åˆ é™¤ "$itemName" å—ï¼Ÿæ­¤æ“ä½œå¯ä»¥æ’¤é”€ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text('åˆ é™¤', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    if (confirmed == true) {
      await onDelete();

      // æ˜¾ç¤ºæ’¤é”€æç¤º
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Semantics(
            liveRegion: true,
            child: Text('å·²åˆ é™¤ "$itemName"'),
          ),
          action: SnackBarAction(
            label: 'æ’¤é”€',
            onPressed: () async {
              await onUndo();
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Semantics(
                    liveRegion: true,
                    child: Text('å·²æ¢å¤ "$itemName"'),
                  ),
                ),
              );
            },
          ),
          duration: Duration(seconds: 5),
        ),
      );
      return true;
    }
    return false;
  }
}
```

### 22.5 æ— éšœç¢æµ‹è¯•æ¸…å•

| æµ‹è¯•é¡¹ç›® | æµ‹è¯•æ–¹æ³• | åˆæ ¼æ ‡å‡† |
|---------|---------|---------|
| å±å¹•é˜…è¯»å™¨ | ä½¿ç”¨TalkBack/VoiceOver | æ‰€æœ‰äº¤äº’å…ƒç´ å¯æœ—è¯»ä¸”æœ‰æ„ä¹‰ |
| è‰²å½©å¯¹æ¯”åº¦ | ä½¿ç”¨å¯¹æ¯”åº¦æ£€æŸ¥å·¥å…· | æ–‡å­—å¯¹æ¯”åº¦â‰¥4.5:1 |
| è§¦æ§ç›®æ ‡ | æµ‹é‡è§¦æ§åŒºåŸŸ | â‰¥48x48é€»è¾‘åƒç´  |
| é”®ç›˜å¯¼èˆª | ä»…ä½¿ç”¨é”®ç›˜æ“ä½œ | æ‰€æœ‰åŠŸèƒ½å¯è®¿é—® |
| æ–‡å­—ç¼©æ”¾ | æ”¾å¤§åˆ°200% | å†…å®¹ä¸ä¸¢å¤±ï¼Œå¯æ»šåŠ¨æŸ¥çœ‹ |
| åŠ¨ç”»å‡å¼± | å¼€å¯å‡å°‘åŠ¨ç”» | å°Šé‡ç³»ç»Ÿè®¾ç½® |
| é”™è¯¯æç¤º | è§¦å‘å„ç±»é”™è¯¯ | æç¤ºæ¸…æ™°ï¼Œæœ‰è§£å†³å»ºè®® |
| è¡¨å•éªŒè¯ | æäº¤é”™è¯¯æ•°æ® | é”™è¯¯ä¿¡æ¯å…³è”åˆ°å­—æ®µ |

### 22.6 æ— éšœç¢å®¡è®¡å·¥å…·

```dart
/// æ— éšœç¢å®¡è®¡æœåŠ¡
class AccessibilityAuditService {
  /// è¿è¡Œæ— éšœç¢å®¡è®¡
  static Future<AccessibilityAuditReport> runAudit(Widget widget) async {
    final issues = <AccessibilityIssue>[];

    // æ£€æŸ¥è¯­ä¹‰æ ‡ç­¾
    final semanticsIssues = await _checkSemantics(widget);
    issues.addAll(semanticsIssues);

    // æ£€æŸ¥é¢œè‰²å¯¹æ¯”åº¦
    final contrastIssues = await _checkColorContrast(widget);
    issues.addAll(contrastIssues);

    // æ£€æŸ¥è§¦æ§ç›®æ ‡å°ºå¯¸
    final touchIssues = await _checkTouchTargets(widget);
    issues.addAll(touchIssues);

    return AccessibilityAuditReport(
      timestamp: DateTime.now(),
      issues: issues,
      passedChecks: _countPassedChecks(issues),
      totalChecks: issues.length + _countPassedChecks(issues),
    );
  }

  static int _countPassedChecks(List<AccessibilityIssue> issues) {
    // å®ç°çœç•¥
    return 0;
  }
}

/// æ— éšœç¢é—®é¢˜
class AccessibilityIssue {
  final AccessibilityIssueType type;
  final AccessibilitySeverity severity;
  final String description;
  final String? recommendation;
  final String? elementPath;

  AccessibilityIssue({
    required this.type,
    required this.severity,
    required this.description,
    this.recommendation,
    this.elementPath,
  });
}

enum AccessibilityIssueType {
  missingSemanticLabel,
  lowContrastRatio,
  smallTouchTarget,
  missingFocusOrder,
  noKeyboardAccess,
}

enum AccessibilitySeverity {
  error,    // å¿…é¡»ä¿®å¤
  warning,  // åº”è¯¥ä¿®å¤
  info,     // å»ºè®®æ”¹è¿›
}
```

---

## 23. æ‡’äººè®¾è®¡åŸåˆ™

**"æ‡’äººè®¾è®¡"** æ˜¯ AIæ™ºèƒ½è®°è´¦ 2.0 çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ä¹‹ä¸€ã€‚æˆ‘ä»¬çš„ç›®æ ‡ç”¨æˆ·æ˜¯é‚£äº›æƒ³è¦ç®¡ç†å¥½è‡ªå·±è´¢åŠ¡ã€ä½†åˆä¸æ„¿æ„èŠ±å¤ªå¤šæ—¶é—´åœ¨è®°è´¦ä¸Šçš„"æ‡’äºº"ã€‚ä¸ºè¿™äº›ç”¨æˆ·è®¾è®¡äº§å“ï¼Œæ„å‘³ç€è¦åœ¨æ¯ä¸€ä¸ªäº¤äº’ç‚¹ä¸Šéƒ½è¿½æ±‚æè‡´çš„ç®€æ´ã€‚

### 23.1 è®¾è®¡ç†å¿µ

#### 23.1.1 æ ¸å¿ƒåŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‡’äººè®¾è®¡æ ¸å¿ƒç†å¿µ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™ä¸€ï¼šæœ€å°‘æ“ä½œåŸåˆ™                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ é«˜é¢‘æ“ä½œä¸€æ­¥å®Œæˆï¼Œä½é¢‘æ“ä½œä¸è¶…è¿‡ä¸‰æ­¥                         â”‚   â”‚
â”‚  â”‚  â€¢ èƒ½è‡ªåŠ¨å®Œæˆçš„ï¼Œç»ä¸è®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ                             â”‚   â”‚
â”‚  â”‚  â€¢ èƒ½æ¨æ–­çš„ä¿¡æ¯ï¼Œç»ä¸è®©ç”¨æˆ·è¾“å…¥                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™äºŒï¼šæ™ºèƒ½é»˜è®¤åŸåˆ™                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰é…ç½®éƒ½æœ‰æ™ºèƒ½é»˜è®¤å€¼                                       â”‚   â”‚
â”‚  â”‚  â€¢ é»˜è®¤å€¼åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®åŠ¨æ€è°ƒæ•´                               â”‚   â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åªéœ€è¦åœ¨é»˜è®¤å€¼ä¸æ»¡è¶³æ—¶æ‰è¿›è¡Œè°ƒæ•´                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™ä¸‰ï¼šæ¸è¿›å¼å¤æ‚åº¦åŸåˆ™                                       â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ ç®€å•åŠŸèƒ½ç«‹å³å¯ç”¨ï¼Œé«˜çº§åŠŸèƒ½æŒ‰éœ€å±•å¼€                           â”‚   â”‚
â”‚  â”‚  â€¢ æ–°ç”¨æˆ·é›¶é…ç½®å³å¯å¼€å§‹ä½¿ç”¨                                     â”‚   â”‚
â”‚  â”‚  â€¢ éšç€ä½¿ç”¨æ·±å…¥ï¼Œé€æ­¥è§£é”æ›´å¤šèƒ½åŠ›                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™å››ï¼šå•æ‰‹æ“ä½œåŸåˆ™ (One-Handed Operation)                    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å¿…é¡»æ”¯æŒå•æ‰‹æ“ä½œå®Œæˆ                             â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®äº¤äº’å…ƒç´ é›†ä¸­åœ¨æ‹‡æŒ‡çƒ­åŒºï¼ˆå±å¹•ä¸‹åŠéƒ¨åˆ†ï¼‰                   â”‚   â”‚
â”‚  â”‚  â€¢ é¿å…éœ€è¦åŒæ‰‹é…åˆçš„å¤æ‚æ‰‹åŠ¿                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ”¯æŒå·¦å³æ‰‹ç”¨æˆ·ï¼ˆé•œåƒå¸ƒå±€é€‰é¡¹ï¼‰                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™äº”ï¼šä¼™ä¼´åŸåˆ™ (Companion Principle)                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ APPä¸ä»…æ˜¯å·¥å…·ï¼Œæ›´æ˜¯ç†è´¢è·¯ä¸Šçš„ä¼™ä¼´å’ŒåŠ©æ‰‹                      â”‚   â”‚
â”‚  â”‚  â€¢ äº¤äº’ä¸­ä½“ç°äººæ€§æ¸©åº¦ï¼šå…³å¿ƒã€å…±æƒ…ã€é¼“åŠ±ã€å–„æ„                   â”‚   â”‚
â”‚  â”‚  â€¢ æ–‡æ¡ˆå†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œé¿å…æœºæ¢°é‡å¤ï¼Œå¯Œæœ‰ä¸ªæ€§                     â”‚   â”‚
â”‚  â”‚  â€¢ åœ¨å…³é”®æ—¶åˆ»ç»™äºˆæƒ…æ„Ÿæ”¯æŒå’Œæ­£å‘æ¿€åŠ±                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.1.2 æ‡’äººç”¨æˆ·ç”»åƒ

| ç‰¹å¾ | æè¿° | è®¾è®¡åº”å¯¹ |
|------|------|----------|
| **æ—¶é—´ç¨€ç¼º** | æ¯å¤©æ„¿æ„èŠ±åœ¨è®°è´¦ä¸Šçš„æ—¶é—´ < 30ç§’ | ä¸€é”®è®°è´¦ã€è¯­éŸ³è®°è´¦ |
| **è®¨åŒé‡å¤** | åŒç±»æ“ä½œä¸æ„¿åšç¬¬äºŒæ¬¡ | æ™ºèƒ½è®°å¿†ã€æ¨¡æ¿åŒ¹é… |
| **é…ç½®ææƒ§** | çœ‹åˆ°å¤æ‚è®¾ç½®å°±æƒ³æ”¾å¼ƒ | æ™ºèƒ½é»˜è®¤ã€æ¸è¿›å¼é…ç½® |
| **ç»“æœå¯¼å‘** | åªå…³å¿ƒ"è®°ä½äº†æ²¡"ï¼Œä¸å…³å¿ƒç»†èŠ‚ | è‡ªåŠ¨åˆ†ç±»ã€æ™ºèƒ½å¡«å…… |
| **ä½å®¹é”™** | å‡ºé”™ä¸€æ¬¡å°±å¯èƒ½å¸è½½APP | å®½å®¹è¾“å…¥ã€æ™ºèƒ½çº é”™ |

### 23.2 æ“ä½œæ•ˆç‡ä¼˜åŒ–æ¨¡å‹

#### 23.2.1 ç‰¹æ€§ä½¿ç”¨ç‡åŠ æƒæ¨¡å‹

æˆ‘ä»¬é€šè¿‡åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œå»ºç«‹ç‰¹æ€§ä½¿ç”¨ç‡ä¸æ“ä½œæ­¥éª¤çš„åŠ æƒæ¨¡å‹ï¼Œç¡®ä¿æ•´ä½“æ“ä½œæ•ˆç‡æœ€ä¼˜ã€‚

```dart
/// ç‰¹æ€§ä½¿ç”¨ç‡åŠ æƒæ¨¡å‹
class FeatureUsageWeightModel {
  /// æ“ä½œæ•ˆç‡è¯„åˆ†ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
  /// å…¬å¼ï¼šæ€»åˆ† = Î£(ç‰¹æ€§é¢‘ç‡ Ã— ç‰¹æ€§æ­¥éª¤æ•°)
  /// ç›®æ ‡ï¼šæœ€å°åŒ–æ€»åˆ†

  /// ç‰¹æ€§åˆ†ç±»åŠå…¶æœŸæœ›æ­¥éª¤æ•°
  static const Map<FeatureCategory, int> targetSteps = {
    // é«˜é¢‘æ“ä½œï¼ˆæ¯å¤©å¤šæ¬¡ï¼‰ï¼šå¿…é¡»1æ­¥å®Œæˆ
    FeatureCategory.quickExpense: 1,      // å¿«é€Ÿè®°ä¸€ç¬”æ”¯å‡º
    FeatureCategory.viewBalance: 1,       // æŸ¥çœ‹ä½™é¢
    FeatureCategory.checkBudget: 1,       // æŸ¥çœ‹é¢„ç®—å‰©ä½™

    // ä¸­é¢‘æ“ä½œï¼ˆæ¯å¤©1-2æ¬¡ï¼‰ï¼šæœ€å¤š2æ­¥
    FeatureCategory.addIncome: 2,         // è®°å½•æ”¶å…¥
    FeatureCategory.viewToday: 2,         // æŸ¥çœ‹ä»Šæ—¥è´¦å•
    FeatureCategory.voiceRecord: 2,       // è¯­éŸ³è®°è´¦

    // ä½é¢‘æ“ä½œï¼ˆæ¯å‘¨å‡ æ¬¡ï¼‰ï¼šæœ€å¤š3æ­¥
    FeatureCategory.viewReport: 3,        // æŸ¥çœ‹æŠ¥è¡¨
    FeatureCategory.editTransaction: 3,   // ç¼–è¾‘äº¤æ˜“
    FeatureCategory.setBudget: 3,         // è®¾ç½®é¢„ç®—

    // ç¨€æœ‰æ“ä½œï¼ˆæ¯æœˆå‡ æ¬¡ï¼‰ï¼šæœ€å¤š5æ­¥
    FeatureCategory.addAccount: 5,        // æ·»åŠ è´¦æˆ·
    FeatureCategory.exportData: 5,        // å¯¼å‡ºæ•°æ®
    FeatureCategory.settings: 5,          // ç³»ç»Ÿè®¾ç½®
  };

  /// è®¡ç®—å½“å‰ç”¨æˆ·çš„æ“ä½œæ•ˆç‡è¯„åˆ†
  static double calculateEfficiencyScore(UserBehaviorData data) {
    double totalScore = 0;

    for (final feature in FeatureCategory.values) {
      final frequency = data.getFeatureFrequency(feature);
      final actualSteps = data.getAverageSteps(feature);
      final targetStep = targetSteps[feature] ?? 3;

      // è¶…å‡ºç›®æ ‡æ­¥éª¤æ•°çš„æƒ©ç½š
      final penalty = max(0, actualSteps - targetStep);

      // åŠ æƒï¼šé¢‘ç‡ Ã— æƒ©ç½š
      totalScore += frequency * penalty;
    }

    return totalScore;
  }

  /// è¯†åˆ«éœ€è¦ä¼˜åŒ–çš„åŠŸèƒ½
  static List<OptimizationSuggestion> identifyOptimizations(UserBehaviorData data) {
    final suggestions = <OptimizationSuggestion>[];

    for (final feature in FeatureCategory.values) {
      final frequency = data.getFeatureFrequency(feature);
      final actualSteps = data.getAverageSteps(feature);
      final targetStep = targetSteps[feature] ?? 3;

      if (actualSteps > targetStep && frequency > 0.1) {
        // é«˜é¢‘æ“ä½œè¶…å‡ºç›®æ ‡æ­¥éª¤
        final impact = frequency * (actualSteps - targetStep);
        suggestions.add(OptimizationSuggestion(
          feature: feature,
          currentSteps: actualSteps,
          targetSteps: targetStep,
          frequency: frequency,
          impact: impact,
          suggestion: _generateSuggestion(feature, actualSteps, targetStep),
        ));
      }
    }

    // æŒ‰å½±å“åº¦æ’åº
    suggestions.sort((a, b) => b.impact.compareTo(a.impact));
    return suggestions;
  }

  static String _generateSuggestion(
    FeatureCategory feature,
    double current,
    int target,
  ) {
    if (feature == FeatureCategory.quickExpense && current > 1) {
      return 'è€ƒè™‘æ·»åŠ é¦–é¡µå¿«æ·è®°è´¦å…¥å£ï¼Œæˆ–å¯ç”¨æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦';
    }
    if (feature == FeatureCategory.voiceRecord && current > 2) {
      return 'è€ƒè™‘æ·»åŠ è¯­éŸ³è®°è´¦å¿«æ·æ–¹å¼ï¼Œæˆ–æ”¯æŒæ¯å±è¯­éŸ³å”¤é†’';
    }
    // ... æ›´å¤šå»ºè®®
    return 'åˆ†æç”¨æˆ·æ“ä½œè·¯å¾„ï¼Œå‡å°‘ä¸­é—´æ­¥éª¤';
  }
}

/// ç‰¹æ€§åˆ†ç±»
enum FeatureCategory {
  quickExpense,    // å¿«é€Ÿè®°æ”¯å‡º
  viewBalance,     // æŸ¥çœ‹ä½™é¢
  checkBudget,     // æŸ¥çœ‹é¢„ç®—
  addIncome,       // è®°å½•æ”¶å…¥
  viewToday,       // ä»Šæ—¥è´¦å•
  voiceRecord,     // è¯­éŸ³è®°è´¦
  viewReport,      // æŸ¥çœ‹æŠ¥è¡¨
  editTransaction, // ç¼–è¾‘äº¤æ˜“
  setBudget,       // è®¾ç½®é¢„ç®—
  addAccount,      // æ·»åŠ è´¦æˆ·
  exportData,      // å¯¼å‡ºæ•°æ®
  settings,        // ç³»ç»Ÿè®¾ç½®
}

/// ä¼˜åŒ–å»ºè®®
class OptimizationSuggestion {
  final FeatureCategory feature;
  final double currentSteps;
  final int targetSteps;
  final double frequency;  // 0-1ï¼Œ1è¡¨ç¤ºæ¯å¤©ä½¿ç”¨
  final double impact;     // å½±å“åº¦ = é¢‘ç‡ Ã— è¶…å‡ºæ­¥éª¤æ•°
  final String suggestion;

  const OptimizationSuggestion({
    required this.feature,
    required this.currentSteps,
    required this.targetSteps,
    required this.frequency,
    required this.impact,
    required this.suggestion,
  });
}
```

#### 23.2.2 ç”¨æˆ·æ“ä½œæ•ˆç‡ç›‘æ§

```dart
/// ç”¨æˆ·æ“ä½œæ•ˆç‡ç›‘æ§æœåŠ¡
class UserEfficiencyMonitor {
  final AnalyticsService _analytics;

  /// è®°å½•ç”¨æˆ·æ“ä½œè·¯å¾„
  void trackOperationPath(String feature, List<String> steps) {
    _analytics.track('operation_path', {
      'feature': feature,
      'step_count': steps.length,
      'steps': steps,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// è®¡ç®—ç”¨æˆ·å¹³å‡æ“ä½œæ•ˆç‡
  Future<UserEfficiencyReport> generateReport(String userId) async {
    final data = await _analytics.getUserBehaviorData(userId);

    // è®¡ç®—å„åŠŸèƒ½çš„å¹³å‡æ­¥éª¤æ•°
    final featureSteps = <FeatureCategory, AverageSteps>{};
    for (final feature in FeatureCategory.values) {
      final operations = data.getOperationsForFeature(feature);
      if (operations.isNotEmpty) {
        final avgSteps = operations.map((o) => o.stepCount).average;
        featureSteps[feature] = AverageSteps(
          average: avgSteps,
          min: operations.map((o) => o.stepCount).min,
          max: operations.map((o) => o.stepCount).max,
          count: operations.length,
        );
      }
    }

    // è®¡ç®—ç»¼åˆæ•ˆç‡è¯„åˆ†
    final efficiencyScore = FeatureUsageWeightModel.calculateEfficiencyScore(data);

    // ç”Ÿæˆä¼˜åŒ–å»ºè®®
    final suggestions = FeatureUsageWeightModel.identifyOptimizations(data);

    return UserEfficiencyReport(
      userId: userId,
      period: data.period,
      featureSteps: featureSteps,
      efficiencyScore: efficiencyScore,
      suggestions: suggestions,
      // ä¸å¹³å‡ç”¨æˆ·å¯¹æ¯”
      comparedToAverage: _compareToAverage(efficiencyScore),
    );
  }

  /// å‘¨æœŸæ€§ç”Ÿæˆæ•ˆç‡æ´å¯Ÿ
  Future<void> generateWeeklyInsight(String userId) async {
    final report = await generateReport(userId);

    if (report.suggestions.isNotEmpty) {
      final topSuggestion = report.suggestions.first;

      // æ¨é€ä¼˜åŒ–æç¤ºï¼ˆéæ‰“æ‰°å¼ï¼‰
      await _showOptimizationTip(
        title: 'å‘ç°å¯ä»¥æ›´å¿«',
        message: '${topSuggestion.feature.displayName}æ“ä½œå¹³å‡éœ€è¦'
            '${topSuggestion.currentSteps.toStringAsFixed(1)}æ­¥ï¼Œ'
            '${topSuggestion.suggestion}',
      );
    }
  }
}
```

### 23.3 æ™ºèƒ½åŒ–è‡ªåŠ¨é…ç½®ç³»ç»Ÿ

#### 23.3.1 è‡ªåŠ¨é…ç½®è§„åˆ™å¼•æ“

```dart
/// æ™ºèƒ½è‡ªåŠ¨é…ç½®æœåŠ¡
/// ç›®æ ‡ï¼šè®©ç³»ç»Ÿä¸­çš„å„é¡¹æ•°æ®å°½å¯èƒ½æ™ºèƒ½åŒ–å½¢æˆ
class SmartAutoConfigService {
  final PreciseLocationService _locationService;
  final UserBehaviorAnalyzer _behaviorAnalyzer;
  final SharedPreferences _prefs;

  /// æ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
  final List<AutoConfigRule> _rules = [];

  SmartAutoConfigService() {
    // æ³¨å†Œæ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
    _registerRules();
  }

  void _registerRules() {
    _rules.addAll([
      // ä½ç½®ç›¸å…³è§„åˆ™
      HomeLocationDetectionRule(),
      WorkLocationDetectionRule(),
      FrequentLocationDetectionRule(),
      HomeCityDetectionRule(),

      // æ—¶é—´ç›¸å…³è§„åˆ™
      PaydayDetectionRule(),
      SleepTimeDetectionRule(),
      CommuteTimeDetectionRule(),

      // æ¶ˆè´¹ä¹ æƒ¯è§„åˆ™
      PreferredPaymentMethodRule(),
      FrequentMerchantRule(),
      CategoryPreferenceRule(),

      // é¢„ç®—ç›¸å…³è§„åˆ™
      SmartBudgetAmountRule(),
      SeasonalBudgetAdjustmentRule(),
    ]);
  }

  /// è¿è¡Œæ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
  Future<AutoConfigResult> runAutoConfig() async {
    final results = <String, ConfigValue>{};
    final skipped = <String, String>{};

    for (final rule in _rules) {
      try {
        // æ£€æŸ¥è§„åˆ™æ˜¯å¦æ»¡è¶³å‰ç½®æ¡ä»¶
        if (!await rule.canExecute()) {
          skipped[rule.configKey] = 'æ•°æ®ä¸è¶³';
          continue;
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨è®¾ç½®è¿‡
        if (await _isManuallySet(rule.configKey)) {
          skipped[rule.configKey] = 'ç”¨æˆ·å·²æ‰‹åŠ¨è®¾ç½®';
          continue;
        }

        // æ‰§è¡Œè§„åˆ™
        final value = await rule.detect();
        if (value != null) {
          results[rule.configKey] = value;
          await _saveConfig(rule.configKey, value);
        }
      } catch (e) {
        skipped[rule.configKey] = 'æ£€æµ‹å¤±è´¥: $e';
      }
    }

    return AutoConfigResult(
      configured: results,
      skipped: skipped,
      timestamp: DateTime.now(),
    );
  }
}

/// è‡ªåŠ¨é…ç½®è§„åˆ™æŠ½è±¡
abstract class AutoConfigRule {
  /// é…ç½®é¡¹æ ‡è¯†
  String get configKey;

  /// é…ç½®é¡¹åç§°
  String get configName;

  /// æœ€å°‘éœ€è¦å¤šå°‘æ•°æ®æ‰èƒ½æ£€æµ‹
  int get minDataPoints;

  /// æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰
  double get confidenceThreshold => 0.8;

  /// æ˜¯å¦æ»¡è¶³æ‰§è¡Œæ¡ä»¶
  Future<bool> canExecute();

  /// æ‰§è¡Œæ£€æµ‹
  Future<ConfigValue?> detect();
}
```

#### 23.3.2 å®¶åº­ä½ç½®æ™ºèƒ½æ£€æµ‹

```dart
/// å®¶åº­ä½ç½®è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class HomeLocationDetectionRule extends AutoConfigRule {
  final LocationHistoryService _locationHistory;
  final PreciseLocationService _locationService;

  @override
  String get configKey => 'user_home_location';

  @override
  String get configName => 'å®¶åº­ä½ç½®';

  @override
  int get minDataPoints => 7;  // è‡³å°‘7å¤©æ•°æ®

  @override
  Future<bool> canExecute() async {
    // éœ€è¦ä½ç½®æƒé™å’Œè¶³å¤Ÿçš„å†å²æ•°æ®
    final hasPermission = await _locationService.hasPermission();
    if (!hasPermission) return false;

    final nightLocations = await _getNightTimeLocations();
    return nightLocations.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    // è§„åˆ™ï¼šæ™šä¸Š22:00åˆ°æ—©ä¸Š7:00ä¹‹é—´ï¼Œç”¨æˆ·æœ€å¸¸åœç•™çš„ä½ç½®
    final nightLocations = await _getNightTimeLocations();

    // ä½ç½®èšç±»
    final clusters = _clusterLocations(nightLocations, radiusMeters: 200);
    if (clusters.isEmpty) return null;

    // æ‰¾å‡ºæœ€å¤§çš„èšç±»
    final largestCluster = clusters.reduce((a, b) =>
      a.memberCount > b.memberCount ? a : b);

    // è®¡ç®—ç½®ä¿¡åº¦ï¼šè¯¥èšç±»å æ€»å¤œé—´ä½ç½®è®°å½•çš„æ¯”ä¾‹
    final confidence = largestCluster.memberCount / nightLocations.length;
    if (confidence < confidenceThreshold) return null;

    // é¢å¤–éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­å¤šå¤©åœ¨æ­¤ä½ç½®
    final consecutiveDays = _countConsecutiveDays(largestCluster, nightLocations);
    if (consecutiveDays < 3) return null;

    return ConfigValue(
      value: largestCluster.center.toJson(),
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: nightLocations.length,
      metadata: {
        'consecutive_days': consecutiveDays,
        'cluster_radius': largestCluster.radius,
        'address': await _reverseGeocode(largestCluster.center),
      },
    );
  }

  /// è·å–å¤œé—´ä½ç½®è®°å½•
  Future<List<LocationRecord>> _getNightTimeLocations() async {
    final allLocations = await _locationHistory.getRecentLocations(days: 30);

    return allLocations.where((loc) {
      final hour = loc.timestamp.hour;
      // æ™šä¸Š22ç‚¹åˆ°æ—©ä¸Š7ç‚¹
      return hour >= 22 || hour < 7;
    }).toList();
  }

  /// è®¡ç®—è¿ç»­å¤©æ•°
  int _countConsecutiveDays(LocationCluster cluster, List<LocationRecord> records) {
    final daysInCluster = records
      .where((r) => cluster.contains(r.location))
      .map((r) => DateFormat('yyyy-MM-dd').format(r.timestamp))
      .toSet()
      .toList()
      ..sort();

    int maxConsecutive = 1;
    int current = 1;

    for (int i = 1; i < daysInCluster.length; i++) {
      final prev = DateTime.parse(daysInCluster[i - 1]);
      final curr = DateTime.parse(daysInCluster[i]);

      if (curr.difference(prev).inDays == 1) {
        current++;
        maxConsecutive = max(maxConsecutive, current);
      } else {
        current = 1;
      }
    }

    return maxConsecutive;
  }
}
```

#### 23.3.3 å·¥ä½œä½ç½®æ™ºèƒ½æ£€æµ‹

```dart
/// å·¥ä½œä½ç½®è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class WorkLocationDetectionRule extends AutoConfigRule {
  final LocationHistoryService _locationHistory;
  final HomeLocationDetectionRule _homeRule;

  @override
  String get configKey => 'user_work_location';

  @override
  String get configName => 'å·¥ä½œä½ç½®';

  @override
  int get minDataPoints => 5;  // è‡³å°‘5ä¸ªå·¥ä½œæ—¥

  @override
  Future<bool> canExecute() async {
    final workdayLocations = await _getWorkdayLocations();
    return workdayLocations.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    // è§„åˆ™ï¼šå·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰9:00-18:00ä¹‹é—´ï¼Œç”¨æˆ·æœ€å¸¸åœç•™çš„ä½ç½®
    // æ’é™¤å®¶åº­ä½ç½®
    final workdayLocations = await _getWorkdayLocations();

    // è·å–å®¶åº­ä½ç½®ç”¨äºæ’é™¤
    final homeLocation = await _getHomeLocation();

    // è¿‡æ»¤æ‰å®¶é™„è¿‘çš„ä½ç½®ï¼ˆ500ç±³èŒƒå›´ï¼‰
    final filteredLocations = workdayLocations.where((loc) {
      if (homeLocation == null) return true;
      return loc.location.distanceTo(homeLocation) > 500;
    }).toList();

    if (filteredLocations.length < minDataPoints) return null;

    // ä½ç½®èšç±»
    final clusters = _clusterLocations(filteredLocations, radiusMeters: 300);
    if (clusters.isEmpty) return null;

    // æ‰¾å‡ºæœ€å¤§çš„èšç±»
    final largestCluster = clusters.reduce((a, b) =>
      a.memberCount > b.memberCount ? a : b);

    // è®¡ç®—ç½®ä¿¡åº¦
    final confidence = largestCluster.memberCount / filteredLocations.length;
    if (confidence < confidenceThreshold) return null;

    // éªŒè¯ï¼šæ˜¯å¦åœ¨å¤šä¸ªä¸åŒçš„å·¥ä½œæ—¥å‡ºç°
    final uniqueWorkdays = _countUniqueWorkdays(largestCluster, filteredLocations);
    if (uniqueWorkdays < 3) return null;  // è‡³å°‘3ä¸ªä¸åŒçš„å·¥ä½œæ—¥

    return ConfigValue(
      value: largestCluster.center.toJson(),
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: filteredLocations.length,
      metadata: {
        'unique_workdays': uniqueWorkdays,
        'cluster_radius': largestCluster.radius,
        'address': await _reverseGeocode(largestCluster.center),
        'poi_type': await _detectPOIType(largestCluster.center),  // åŠå…¬æ¥¼/å•†ä¸šåŒºç­‰
      },
    );
  }

  /// è·å–å·¥ä½œæ—¥å·¥ä½œæ—¶é—´çš„ä½ç½®è®°å½•
  Future<List<LocationRecord>> _getWorkdayLocations() async {
    final allLocations = await _locationHistory.getRecentLocations(days: 30);

    return allLocations.where((loc) {
      final weekday = loc.timestamp.weekday;
      final hour = loc.timestamp.hour;

      // å‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9ç‚¹åˆ°18ç‚¹
      return weekday >= 1 && weekday <= 5 && hour >= 9 && hour <= 18;
    }).toList();
  }

  /// è®¡ç®—ç‹¬ç«‹å·¥ä½œæ—¥æ•°
  int _countUniqueWorkdays(LocationCluster cluster, List<LocationRecord> records) {
    return records
      .where((r) => cluster.contains(r.location))
      .map((r) => DateFormat('yyyy-MM-dd').format(r.timestamp))
      .toSet()
      .length;
  }
}
```

#### 23.3.4 å‘è–ªæ—¥æ™ºèƒ½æ£€æµ‹

```dart
/// å‘è–ªæ—¥è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class PaydayDetectionRule extends AutoConfigRule {
  final TransactionRepository _transactionRepo;

  @override
  String get configKey => 'user_payday';

  @override
  String get configName => 'å‘è–ªæ—¥';

  @override
  int get minDataPoints => 2;  // è‡³å°‘2æ¬¡è–ªèµ„è®°å½•

  @override
  Future<bool> canExecute() async {
    final salaryTransactions = await _getSalaryTransactions();
    return salaryTransactions.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    final salaryTransactions = await _getSalaryTransactions();

    // æå–æ¯æ¬¡è–ªèµ„çš„æ—¥æœŸ
    final payDays = salaryTransactions.map((tx) => tx.date.day).toList();

    // ç»Ÿè®¡æœ€å¸¸è§çš„å‘è–ªæ—¥
    final dayCounts = <int, int>{};
    for (final day in payDays) {
      dayCounts[day] = (dayCounts[day] ?? 0) + 1;
    }

    // æ‰¾å‡ºå‡ºç°æ¬¡æ•°æœ€å¤šçš„æ—¥æœŸ
    final mostCommonDay = dayCounts.entries
      .reduce((a, b) => a.value > b.value ? a : b)
      .key;

    final confidence = dayCounts[mostCommonDay]! / payDays.length;
    if (confidence < confidenceThreshold) return null;

    // éªŒè¯ï¼šé‡‘é¢æ˜¯å¦ç›¸è¿‘ï¼ˆè–ªèµ„é€šå¸¸ç›¸å¯¹å›ºå®šï¼‰
    final amounts = salaryTransactions.map((tx) => tx.amount).toList();
    final amountVariance = _calculateVariance(amounts);
    final isAmountStable = amountVariance < 0.2;  // æ–¹å·®å°äº20%

    return ConfigValue(
      value: mostCommonDay,
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: salaryTransactions.length,
      metadata: {
        'detected_from_transactions': salaryTransactions.length,
        'amount_stable': isAmountStable,
        'average_amount': amounts.average,
      },
    );
  }

  /// è·å–è–ªèµ„ç±»äº¤æ˜“
  Future<List<Transaction>> _getSalaryTransactions() async {
    final transactions = await _transactionRepo.getIncomesForPeriod(
      DateTime.now().subtract(Duration(days: 180)),  // æœ€è¿‘6ä¸ªæœˆ
      DateTime.now(),
    );

    // è¯†åˆ«è–ªèµ„äº¤æ˜“ï¼š
    // 1. å¤‡æ³¨åŒ…å«"å·¥èµ„"ã€"è–ªèµ„"ã€"salary"ç­‰å…³é”®è¯
    // 2. é‡‘é¢è¾ƒå¤§ä¸”ç›¸å¯¹å›ºå®š
    // 3. æ¥æºæ˜¯é“¶è¡Œè½¬è´¦
    return transactions.where((tx) {
      final note = tx.note?.toLowerCase() ?? '';
      final hasSalaryKeyword = note.contains('å·¥èµ„') ||
        note.contains('è–ªèµ„') ||
        note.contains('salary') ||
        note.contains('wage');

      // æˆ–è€…åˆ†ç±»æ˜¯"å·¥èµ„æ”¶å…¥"
      final isSalaryCategory = tx.categoryId == 'income_salary';

      return hasSalaryKeyword || isSalaryCategory;
    }).toList();
  }
}
```

#### 23.3.5 æ¶ˆè´¹åå¥½æ™ºèƒ½å­¦ä¹ 

```dart
/// ç±»ç›®åå¥½è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class CategoryPreferenceRule extends AutoConfigRule {
  final TransactionRepository _transactionRepo;

  @override
  String get configKey => 'category_preferences';

  @override
  String get configName => 'æ¶ˆè´¹åå¥½';

  @override
  int get minDataPoints => 30;  // è‡³å°‘30ç¬”äº¤æ˜“

  @override
  Future<bool> canExecute() async {
    final txCount = await _transactionRepo.getTransactionCount(
      since: DateTime.now().subtract(Duration(days: 90)),
    );
    return txCount >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    final transactions = await _transactionRepo.getExpensesSince(
      DateTime.now().subtract(Duration(days: 90)),
    );

    // åˆ†æå„ç±»ç›®çš„æ¶ˆè´¹é¢‘ç‡å’Œé‡‘é¢
    final categoryStats = <String, CategoryPreferenceStats>{};

    for (final tx in transactions) {
      if (tx.categoryId == null) continue;

      final stats = categoryStats.putIfAbsent(
        tx.categoryId!,
        () => CategoryPreferenceStats(),
      );
      stats.count++;
      stats.totalAmount += tx.amount;
      stats.transactions.add(tx);
    }

    // è®¡ç®—æ¯ä¸ªç±»ç›®çš„åå¥½å¾—åˆ†
    final preferences = categoryStats.map((categoryId, stats) {
      final frequencyScore = stats.count / transactions.length;
      final amountScore = stats.totalAmount /
        transactions.fold(0.0, (sum, tx) => sum + tx.amount);

      // ç»¼åˆå¾—åˆ† = é¢‘ç‡æƒé‡ Ã— é¢‘ç‡ + é‡‘é¢æƒé‡ Ã— é‡‘é¢å æ¯”
      final score = frequencyScore * 0.6 + amountScore * 0.4;

      return MapEntry(categoryId, CategoryPreference(
        categoryId: categoryId,
        frequencyScore: frequencyScore,
        amountScore: amountScore,
        overallScore: score,
        averageAmount: stats.totalAmount / stats.count,
        typicalMerchants: _findTypicalMerchants(stats.transactions),
        typicalTimeSlots: _findTypicalTimeSlots(stats.transactions),
      ));
    });

    return ConfigValue(
      value: preferences,
      confidence: 0.9,
      detectedAt: DateTime.now(),
      dataPoints: transactions.length,
    );
  }

  /// æ‰¾å‡ºå…¸å‹å•†æˆ·
  List<String> _findTypicalMerchants(List<Transaction> transactions) {
    final merchantCounts = <String, int>{};
    for (final tx in transactions) {
      if (tx.merchant != null) {
        merchantCounts[tx.merchant!] = (merchantCounts[tx.merchant!] ?? 0) + 1;
      }
    }

    return merchantCounts.entries
      .where((e) => e.value >= 2)  // è‡³å°‘å‡ºç°2æ¬¡
      .map((e) => e.key)
      .take(5)  // æœ€å¤š5ä¸ª
      .toList();
  }

  /// æ‰¾å‡ºå…¸å‹æ¶ˆè´¹æ—¶æ®µ
  List<TimeSlot> _findTypicalTimeSlots(List<Transaction> transactions) {
    final hourCounts = <int, int>{};
    for (final tx in transactions) {
      final hour = tx.date.hour;
      hourCounts[hour] = (hourCounts[hour] ?? 0) + 1;
    }

    // æ‰¾å‡ºé«˜é¢‘æ—¶æ®µï¼ˆè¶…è¿‡å¹³å‡å€¼çš„æ—¶æ®µï¼‰
    final avgCount = hourCounts.values.average;
    return hourCounts.entries
      .where((e) => e.value > avgCount)
      .map((e) => TimeSlot.fromHour(e.key))
      .toList();
  }
}

/// ç±»ç›®åå¥½
class CategoryPreference {
  final String categoryId;
  final double frequencyScore;    // é¢‘ç‡å¾—åˆ† (0-1)
  final double amountScore;       // é‡‘é¢å æ¯”å¾—åˆ† (0-1)
  final double overallScore;      // ç»¼åˆå¾—åˆ† (0-1)
  final double averageAmount;     // å¹³å‡æ¶ˆè´¹é‡‘é¢
  final List<String> typicalMerchants;  // å…¸å‹å•†æˆ·
  final List<TimeSlot> typicalTimeSlots; // å…¸å‹æ¶ˆè´¹æ—¶æ®µ

  const CategoryPreference({
    required this.categoryId,
    required this.frequencyScore,
    required this.amountScore,
    required this.overallScore,
    required this.averageAmount,
    required this.typicalMerchants,
    required this.typicalTimeSlots,
  });
}
```

### 23.4 æ™ºèƒ½é»˜è®¤å€¼ç³»ç»Ÿ

#### 23.4.1 åŠ¨æ€é»˜è®¤å€¼æœåŠ¡

```dart
/// æ™ºèƒ½é»˜è®¤å€¼æœåŠ¡
/// è®©æ‰€æœ‰éœ€è¦ç”¨æˆ·è¾“å…¥çš„åœ°æ–¹éƒ½æœ‰æ™ºèƒ½çš„é»˜è®¤å€¼
class SmartDefaultValueService {
  final UserPreferenceService _preferences;
  final CategoryPreferenceRule _categoryPreference;
  final TransactionRepository _transactionRepo;
  final PreciseLocationService _locationService;

  /// è·å–æ–°äº¤æ˜“çš„æ™ºèƒ½é»˜è®¤å€¼
  Future<TransactionDefaults> getTransactionDefaults({
    TransactionType? type,
    String? merchant,
    PreciseLocation? location,
  }) async {
    final now = DateTime.now();

    // 1. é»˜è®¤åˆ†ç±»ï¼šåŸºäºæ—¶é—´ã€ä½ç½®ã€å•†æˆ·æ¨æ–­
    String? defaultCategory;
    if (merchant != null) {
      defaultCategory = await _inferCategoryFromMerchant(merchant);
    }
    if (defaultCategory == null && location != null) {
      defaultCategory = await _inferCategoryFromLocation(location);
    }
    if (defaultCategory == null) {
      defaultCategory = await _inferCategoryFromTime(now);
    }

    // 2. é»˜è®¤é‡‘é¢ï¼šåŸºäºåˆ†ç±»å’Œå•†æˆ·çš„å†å²å¹³å‡å€¼
    double? defaultAmount;
    if (defaultCategory != null) {
      defaultAmount = await _getTypicalAmount(defaultCategory, merchant);
    }

    // 3. é»˜è®¤è´¦æˆ·ï¼šåŸºäºæ¶ˆè´¹åœºæ™¯æ¨æ–­
    String? defaultAccountId;
    if (location != null) {
      defaultAccountId = await _inferAccountFromLocation(location);
    }
    defaultAccountId ??= await _getMostUsedAccount(type ?? TransactionType.expense);

    // 4. é»˜è®¤æ ‡ç­¾ï¼šåŸºäºåˆ†ç±»å’Œæ—¶é—´
    List<String> defaultTags = [];
    if (defaultCategory != null) {
      defaultTags = await _getSuggestedTags(defaultCategory, now);
    }

    return TransactionDefaults(
      categoryId: defaultCategory,
      amount: defaultAmount,
      accountId: defaultAccountId,
      tags: defaultTags,
      timestamp: now,
      confidence: _calculateConfidence(defaultCategory, defaultAmount),
    );
  }

  /// åŸºäºå•†æˆ·æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromMerchant(String merchant) async {
    // æŸ¥æ‰¾å†å²è®°å½•ä¸­è¯¥å•†æˆ·æœ€å¸¸ç”¨çš„åˆ†ç±»
    final history = await _transactionRepo.getTransactionsByMerchant(
      merchant,
      limit: 10,
    );

    if (history.isEmpty) {
      // å°è¯•ä»å•†æˆ·åç§°æ¨æ–­
      return _inferCategoryFromMerchantName(merchant);
    }

    // ç»Ÿè®¡åˆ†ç±»é¢‘ç‡
    final categoryCounts = <String, int>{};
    for (final tx in history) {
      if (tx.categoryId != null) {
        categoryCounts[tx.categoryId!] =
          (categoryCounts[tx.categoryId!] ?? 0) + 1;
      }
    }

    if (categoryCounts.isEmpty) return null;

    // è¿”å›æœ€å¸¸ç”¨çš„åˆ†ç±»
    return categoryCounts.entries
      .reduce((a, b) => a.value > b.value ? a : b)
      .key;
  }

  /// åŸºäºå•†æˆ·åç§°æ¨æ–­åˆ†ç±»
  String? _inferCategoryFromMerchantName(String merchant) {
    final lowerMerchant = merchant.toLowerCase();

    // é¤é¥®ç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['é¤å…', 'é¥­åº—', 'ç¾é£Ÿ', 'å¤–å–', 'éº¦å½“åŠ³',
        'è‚¯å¾·åŸº', 'æ˜Ÿå·´å…‹', 'restaurant', 'cafe', 'coffee'])) {
      return 'expense_food';
    }

    // äº¤é€šç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['åœ°é“', 'å…¬äº¤', 'å‡ºç§Ÿ', 'æ»´æ»´', 'é«˜å¾·',
        'åŠ æ²¹ç«™', 'uber', 'taxi', 'metro'])) {
      return 'expense_transport';
    }

    // è´­ç‰©ç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['è¶…å¸‚', 'ä¾¿åˆ©åº—', 'å•†åœº', 'æ·˜å®', 'äº¬ä¸œ',
        'æ‹¼å¤šå¤š', 'mall', 'store', 'shop'])) {
      return 'expense_shopping';
    }

    // æ›´å¤šè§„åˆ™...
    return null;
  }

  /// åŸºäºä½ç½®æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromLocation(PreciseLocation location) async {
    // ä½¿ç”¨POIä¿¡æ¯æ¨æ–­
    if (location.nearbyPOI != null) {
      switch (location.nearbyPOI!.category) {
        case POICategory.dining:
          return 'expense_food';
        case POICategory.transportation:
          return 'expense_transport';
        case POICategory.shopping:
          return 'expense_shopping';
        case POICategory.entertainment:
          return 'expense_entertainment';
        case POICategory.medical:
          return 'expense_medical';
        default:
          break;
      }
    }

    // ä½¿ç”¨åŒºåŸŸç±»å‹æ¨æ–­
    switch (location.areaType) {
      case AreaType.commercial:
        return 'expense_shopping';
      case AreaType.transportation:
        return 'expense_transport';
      default:
        return null;
    }
  }

  /// åŸºäºæ—¶é—´æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromTime(DateTime time) async {
    final hour = time.hour;
    final isWeekend = time.weekday >= 6;

    // å·¥ä½œæ—¥
    if (!isWeekend) {
      if (hour >= 7 && hour <= 9) {
        // æ—©é«˜å³°ï¼Œå¯èƒ½æ˜¯æ—©é¤æˆ–äº¤é€š
        return 'expense_food';  // æˆ–åŸºäºç”¨æˆ·å†å²åå¥½
      }
      if (hour >= 11 && hour <= 13) {
        // åˆé¤æ—¶é—´
        return 'expense_food';
      }
      if (hour >= 17 && hour <= 19) {
        // æ™šé«˜å³°ï¼Œå¯èƒ½æ˜¯äº¤é€šæˆ–æ™šé¤
        return 'expense_transport';
      }
      if (hour >= 19 && hour <= 21) {
        // æ™šé¤æ—¶é—´
        return 'expense_food';
      }
    }

    // å‘¨æœ«
    if (isWeekend) {
      if (hour >= 10 && hour <= 22) {
        // å‘¨æœ«æ´»åŠ¨æ—¶é—´ï¼Œå¯èƒ½æ˜¯å¨±ä¹
        return 'expense_entertainment';
      }
    }

    return null;
  }

  /// è·å–å…¸å‹æ¶ˆè´¹é‡‘é¢
  Future<double?> _getTypicalAmount(String categoryId, String? merchant) async {
    // å¦‚æœæœ‰å•†æˆ·ä¿¡æ¯ï¼Œä¼˜å…ˆä½¿ç”¨è¯¥å•†æˆ·çš„å†å²å¹³å‡å€¼
    if (merchant != null) {
      final merchantHistory = await _transactionRepo.getTransactionsByMerchant(
        merchant,
        categoryId: categoryId,
        limit: 10,
      );

      if (merchantHistory.length >= 3) {
        // ä½¿ç”¨ä¸­ä½æ•°æ›´ç¨³å®š
        final amounts = merchantHistory.map((tx) => tx.amount).toList()..sort();
        return amounts[amounts.length ~/ 2];
      }
    }

    // ä½¿ç”¨è¯¥åˆ†ç±»çš„å†å²å¹³å‡å€¼
    final categoryHistory = await _transactionRepo.getTransactionsByCategory(
      categoryId,
      limit: 30,
    );

    if (categoryHistory.length >= 5) {
      final amounts = categoryHistory.map((tx) => tx.amount).toList()..sort();
      return amounts[amounts.length ~/ 2];  // ä¸­ä½æ•°
    }

    return null;
  }
}
```

### 23.5 ä¸€é”®æ“ä½œè®¾è®¡

#### 23.5.1 å¿«æ·æ“ä½œå…¥å£

```dart
/// å¿«æ·æ“ä½œæœåŠ¡
class QuickActionService {
  /// é«˜é¢‘æ“ä½œçš„å¿«æ·å…¥å£é…ç½®
  static const List<QuickAction> defaultActions = [
    QuickAction(
      id: 'quick_expense',
      name: 'å¿«é€Ÿè®°æ”¯å‡º',
      icon: Icons.remove_circle_outline,
      targetSteps: 1,
      entryPoints: [
        EntryPoint.homeFloatingButton,  // é¦–é¡µæ‚¬æµ®æŒ‰é’®
        EntryPoint.shakeToRecord,       // æ‘‡ä¸€æ‘‡
        EntryPoint.widget,              // æ¡Œé¢å°ç»„ä»¶
        EntryPoint.notification,        // é€šçŸ¥æ å¿«æ·å…¥å£
      ],
    ),
    QuickAction(
      id: 'voice_record',
      name: 'è¯­éŸ³è®°è´¦',
      icon: Icons.mic,
      targetSteps: 2,
      entryPoints: [
        EntryPoint.homeLongPress,       // é¦–é¡µé•¿æŒ‰
        EntryPoint.voiceAssistant,      // è¯­éŸ³åŠ©æ‰‹å”¤é†’
        EntryPoint.widget,              // æ¡Œé¢å°ç»„ä»¶
      ],
    ),
    QuickAction(
      id: 'scan_receipt',
      name: 'æ‰«æå°ç¥¨',
      icon: Icons.camera_alt,
      targetSteps: 2,
      entryPoints: [
        EntryPoint.homeButton,          // é¦–é¡µæŒ‰é’®
        EntryPoint.shareExtension,      // åˆ†äº«æ‰©å±•
      ],
    ),
  ];

  /// åŸºäºç”¨æˆ·ä¹ æƒ¯ä¸ªæ€§åŒ–å¿«æ·æ“ä½œ
  Future<List<QuickAction>> getPersonalizedActions(String userId) async {
    final behavior = await _getBehaviorData(userId);

    // æŒ‰ä½¿ç”¨é¢‘ç‡æ’åº
    final sortedActions = List<QuickAction>.from(defaultActions);
    sortedActions.sort((a, b) {
      final freqA = behavior.getActionFrequency(a.id);
      final freqB = behavior.getActionFrequency(b.id);
      return freqB.compareTo(freqA);
    });

    // æœ€å¸¸ç”¨çš„3ä¸ªæ“ä½œæ”¾åœ¨æœ€å®¹æ˜“è§¦è¾¾çš„ä½ç½®
    return sortedActions.take(3).toList();
  }
}

/// å¿«æ·æ“ä½œå®šä¹‰
class QuickAction {
  final String id;
  final String name;
  final IconData icon;
  final int targetSteps;  // ç›®æ ‡æ­¥éª¤æ•°
  final List<EntryPoint> entryPoints;  // å¯ç”¨å…¥å£

  const QuickAction({
    required this.id,
    required this.name,
    required this.icon,
    required this.targetSteps,
    required this.entryPoints,
  });
}

/// å…¥å£ç±»å‹
enum EntryPoint {
  homeFloatingButton,  // é¦–é¡µæ‚¬æµ®æŒ‰é’®
  homeButton,          // é¦–é¡µæ™®é€šæŒ‰é’®
  homeLongPress,       // é¦–é¡µé•¿æŒ‰
  shakeToRecord,       // æ‘‡ä¸€æ‘‡
  widget,              // æ¡Œé¢å°ç»„ä»¶
  notification,        // é€šçŸ¥æ 
  voiceAssistant,      // è¯­éŸ³åŠ©æ‰‹
  shareExtension,      // åˆ†äº«æ‰©å±•
}
```

#### 23.5.2 æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦

```dart
/// æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦æœåŠ¡
class ShakeToRecordService {
  final SensorService _sensorService;
  final QuickRecordService _quickRecord;
  final SharedPreferences _prefs;

  bool _isEnabled = true;
  bool _isRecording = false;

  /// åˆå§‹åŒ–æ‘‡ä¸€æ‘‡ç›‘å¬
  Future<void> initialize() async {
    _isEnabled = _prefs.getBool('shake_to_record_enabled') ?? true;

    if (_isEnabled) {
      await _startListening();
    }
  }

  Future<void> _startListening() async {
    _sensorService.accelerometerEvents.listen((event) {
      if (_isRecording) return;

      // æ£€æµ‹æ‘‡ä¸€æ‘‡æ‰‹åŠ¿
      final acceleration = sqrt(
        event.x * event.x + event.y * event.y + event.z * event.z
      );

      if (acceleration > 25) {  // é˜ˆå€¼ï¼Œå¯è°ƒèŠ‚
        _onShakeDetected();
      }
    });
  }

  void _onShakeDetected() async {
    if (_isRecording) return;
    _isRecording = true;

    // éœ‡åŠ¨åé¦ˆ
    HapticFeedback.mediumImpact();

    // æ‰“å¼€å¿«é€Ÿè®°è´¦ç•Œé¢
    await _quickRecord.showQuickRecordSheet();

    _isRecording = false;
  }
}

/// å¿«é€Ÿè®°è´¦æœåŠ¡
class QuickRecordService {
  final SmartDefaultValueService _defaults;

  /// æ˜¾ç¤ºå¿«é€Ÿè®°è´¦åº•éƒ¨å¼¹çª—
  Future<void> showQuickRecordSheet() async {
    // è·å–æ™ºèƒ½é»˜è®¤å€¼
    final location = await _getCurrentLocation();
    final defaults = await _defaults.getTransactionDefaults(
      type: TransactionType.expense,
      location: location,
    );

    // æ˜¾ç¤ºç®€åŒ–çš„è®°è´¦ç•Œé¢
    // åªéœ€è¾“å…¥é‡‘é¢ï¼Œå…¶ä»–å…¨éƒ¨æ™ºèƒ½å¡«å……
    await showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      builder: (context) => QuickRecordSheet(
        defaults: defaults,
        onSave: _saveTransaction,
      ),
    );
  }
}

/// å¿«é€Ÿè®°è´¦ç•Œé¢
class QuickRecordSheet extends StatefulWidget {
  final TransactionDefaults defaults;
  final Function(Transaction) onSave;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.all(16),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // å¤§å·é‡‘é¢è¾“å…¥æ¡†ï¼ˆä¸€æ­¥åˆ°ä½ï¼‰
          AmountInputField(
            autofocus: true,
            defaultValue: defaults.amount,
            onSubmitted: (amount) async {
              // å›è½¦å³ä¿å­˜
              final transaction = Transaction(
                amount: amount,
                categoryId: defaults.categoryId,
                accountId: defaults.accountId,
                date: DateTime.now(),
                type: TransactionType.expense,
                tags: defaults.tags,
              );
              await onSave(transaction);
              Navigator.pop(context);

              // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
              showSuccessToast('å·²è®°å½• Â¥$amount');
            },
          ),

          SizedBox(height: 8),

          // æ™ºèƒ½æ¨æ–­çš„ä¿¡æ¯ï¼ˆå¯ç‚¹å‡»ä¿®æ”¹ï¼‰
          Row(
            children: [
              if (defaults.categoryId != null)
                CategoryChip(
                  categoryId: defaults.categoryId!,
                  onTap: () => _showCategoryPicker(),
                ),
              Spacer(),
              if (defaults.confidence > 0.8)
                Text(
                  'æ™ºèƒ½å¡«å……',
                  style: TextStyle(color: Colors.grey, fontSize: 12),
                ),
            ],
          ),
        ],
      ),
    );
  }
}
```

### 23.6 å•æ‰‹æ“ä½œè®¾è®¡è§„èŒƒ

#### 23.6.1 æ‹‡æŒ‡çƒ­åŒºç†è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‹‡æŒ‡çƒ­åŒºåˆ†å¸ƒå›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           å›°éš¾åŒº (Hard to Reach)                    â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ ä»…æ”¾ç½®ä½é¢‘æˆ–è¾…åŠ©åŠŸèƒ½                           â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šè®¾ç½®ã€ä¸ªäººä¸­å¿ƒå…¥å£                         â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¯é€šè¿‡ä¸‹æ‹‰æ‰‹åŠ¿è§¦è¾¾                             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           èˆ’é€‚åŒº (Natural Reach)                    â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¾ç½®æŸ¥çœ‹ç±»åŠŸèƒ½ï¼ˆåªè¯»æ“ä½œï¼‰                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šä½™é¢æ˜¾ç¤ºã€é’±é¾„å¡ç‰‡ã€å›¾è¡¨åŒºåŸŸ               â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¯æŒç‚¹å‡»ä¸‹é’»                                   â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚  â˜…â˜…â˜…  é»„é‡‘åŒº (Easy Reach) â˜…â˜…â˜…                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¾ç½®æ‰€æœ‰æ ¸å¿ƒæ“ä½œæŒ‰é’®                           â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šè®°ä¸€ç¬”FABã€åº•éƒ¨å¯¼èˆªã€ç¡®è®¤æŒ‰é’®              â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ é«˜é¢‘æ“ä½œçš„è§¦å‘åŒºåŸŸ                             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           åº•éƒ¨å¯¼èˆªåŒº (Navigation)                   â”‚   â”‚    â”‚
â”‚    â”‚  â”‚   [é¦–é¡µ]    [é¢„ç®—]    [æ´å¯Ÿ]    [è®¾ç½®]             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.6.2 æ ¸å¿ƒåŠŸèƒ½å•æ‰‹æ“ä½œçŸ©é˜µ

| åŠŸèƒ½ | è§¦å‘æ–¹å¼ | çƒ­åŒºä½ç½® | æ‰‹åŠ¿æ”¯æŒ | å•æ‰‹å®Œæˆç‡ |
|------|----------|----------|----------|------------|
| **å¿«é€Ÿè®°è´¦** | ç‚¹å‡»FAB | é»„é‡‘åŒº(å³ä¸‹) | ç‚¹å‡» | 100% |
| **è¯­éŸ³è®°è´¦** | é•¿æŒ‰FAB | é»„é‡‘åŒº(å³ä¸‹) | é•¿æŒ‰ | 100% |
| **æŸ¥çœ‹ä½™é¢** | é¦–é¡µé¡¶éƒ¨ | èˆ’é€‚åŒº | æ— éœ€æ“ä½œ | 100% |
| **åˆ‡æ¢æ ‡ç­¾** | åº•éƒ¨å¯¼èˆª | é»„é‡‘åŒº | ç‚¹å‡» | 100% |
| **æŸ¥çœ‹é¢„ç®—** | ç‚¹å‡»é¢„ç®—å¡ç‰‡ | èˆ’é€‚åŒº | ç‚¹å‡» | 100% |
| **è¾“å…¥é‡‘é¢** | æ•°å­—é”®ç›˜ | é»„é‡‘åŒº(ä¸‹åŠå±) | ç‚¹å‡» | 100% |
| **é€‰æ‹©åˆ†ç±»** | åˆ†ç±»ç½‘æ ¼ | èˆ’é€‚åŒº~é»„é‡‘åŒº | ç‚¹å‡» | 100% |
| **ç¡®è®¤ä¿å­˜** | ç¡®è®¤æŒ‰é’® | é»„é‡‘åŒº(å³ä¸‹) | ç‚¹å‡» | 100% |
| **è¿”å›ä¸Šé¡µ** | å·¦æ»‘æ‰‹åŠ¿/è¿”å› | è¾¹ç¼˜æ»‘åŠ¨ | è¾¹ç¼˜æ»‘åŠ¨ | 100% |
| **ä¸‹æ‹‰åˆ·æ–°** | ä¸‹æ‹‰æ‰‹åŠ¿ | èˆ’é€‚åŒº | ä¸‹æ‹‰ | 100% |

#### 23.6.3 å•æ‰‹æ“ä½œè®¾è®¡å®ç°

```dart
/// å•æ‰‹æ“ä½œå¸ƒå±€åŠ©æ‰‹
class OneHandedLayoutHelper {
  /// æ ¹æ®å±å¹•å°ºå¯¸è®¡ç®—çƒ­åŒºè¾¹ç•Œ
  static ThumbZones calculateThumbZones(Size screenSize) {
    final height = screenSize.height;

    return ThumbZones(
      // é»„é‡‘åŒºï¼šå±å¹•ä¸‹æ–¹ 40%
      easyReach: Rect.fromLTRB(
        0,
        height * 0.60,
        screenSize.width,
        height,
      ),
      // èˆ’é€‚åŒºï¼šå±å¹•ä¸­é—´ 35%
      naturalReach: Rect.fromLTRB(
        0,
        height * 0.25,
        screenSize.width,
        height * 0.60,
      ),
      // å›°éš¾åŒºï¼šå±å¹•ä¸Šæ–¹ 25%
      hardToReach: Rect.fromLTRB(
        0,
        0,
        screenSize.width,
        height * 0.25,
      ),
    );
  }

  /// æ£€æŸ¥äº¤äº’å…ƒç´ æ˜¯å¦åœ¨åˆé€‚çš„çƒ­åŒº
  static ZoneComplianceResult checkElementPlacement({
    required Rect elementBounds,
    required InteractionFrequency frequency,
    required ThumbZones zones,
  }) {
    switch (frequency) {
      case InteractionFrequency.high:
        // é«˜é¢‘æ“ä½œå¿…é¡»åœ¨é»„é‡‘åŒº
        if (zones.easyReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.optimal;
        } else if (zones.naturalReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.acceptable;
        }
        return ZoneComplianceResult.violation;

      case InteractionFrequency.medium:
        // ä¸­é¢‘æ“ä½œåœ¨èˆ’é€‚åŒºæˆ–é»„é‡‘åŒºéƒ½å¯ä»¥
        if (zones.easyReach.overlaps(elementBounds) ||
            zones.naturalReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.optimal;
        }
        return ZoneComplianceResult.acceptable;

      case InteractionFrequency.low:
        // ä½é¢‘æ“ä½œå¯ä»¥åœ¨ä»»ä½•åŒºåŸŸ
        return ZoneComplianceResult.optimal;
    }
  }
}

/// å•æ‰‹å‹å¥½çš„åº•éƒ¨å¼¹çª—
class OneHandedBottomSheet extends StatelessWidget {
  final Widget child;
  final String? title;
  final List<Widget>? actions;

  @override
  Widget build(BuildContext context) {
    return DraggableScrollableSheet(
      initialChildSize: 0.5,  // ä»å±å¹•ä¸‹åŠéƒ¨åˆ†å¼€å§‹
      minChildSize: 0.3,
      maxChildSize: 0.9,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // æ‹–æ‹½æŒ‡ç¤ºå™¨ï¼ˆä¾¿äºå•æ‰‹æ‹–åŠ¨ï¼‰
              Container(
                width: 40,
                height: 4,
                margin: EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  color: Theme.of(context).colorScheme.outline,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // æ ‡é¢˜åŒºåŸŸ
              if (title != null)
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  child: Text(title!, style: Theme.of(context).textTheme.titleLarge),
                ),
              // å†…å®¹åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  child: child,
                ),
              ),
              // æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆå›ºå®šåœ¨åº•éƒ¨é»„é‡‘åŒºï¼‰
              if (actions != null)
                SafeArea(
                  child: Padding(
                    padding: EdgeInsets.all(16),
                    child: Row(
                      children: actions!.map((action) =>
                        Expanded(child: Padding(
                          padding: EdgeInsets.symmetric(horizontal: 4),
                          child: action,
                        ))
                      ).toList(),
                    ),
                  ),
                ),
            ],
          ),
        );
      },
    );
  }
}

/// FAB å•æ‰‹æ“ä½œå¢å¼º
class EnhancedFAB extends StatelessWidget {
  final VoidCallback onTap;
  final VoidCallback onLongPress;
  final IconData icon;

  @override
  Widget build(BuildContext context) {
    return Positioned(
      // å›ºå®šåœ¨é»„é‡‘åŒºå³ä¸‹è§’
      right: 16,
      bottom: 16 + MediaQuery.of(context).padding.bottom + 60, // å¯¼èˆªæ ä¸Šæ–¹
      child: GestureDetector(
        onTap: onTap,           // ç‚¹å‡»ï¼šæ‰“å¼€è®°è´¦é¡µ
        onLongPress: onLongPress, // é•¿æŒ‰ï¼šè¯­éŸ³è®°è´¦
        child: Container(
          width: 56,
          height: 56,
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.primary,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 8,
                offset: Offset(0, 4),
              ),
            ],
          ),
          child: Icon(icon, color: Colors.white, size: 24),
        ),
      ),
    );
  }
}
```

#### 23.6.4 å•æ‰‹æ“ä½œé€‚é…åœºæ™¯

| åœºæ™¯ | è®¾è®¡æ–¹æ¡ˆ | å®ç°è¦ç‚¹ |
|------|----------|----------|
| **åœ°é“é€šå‹¤** | å•æ‰‹æ¡æŒï¼Œå¦ä¸€æ‰‹æ‰¶æ‰¶æ‰‹ | æ‰€æœ‰æ ¸å¿ƒæ“ä½œåœ¨æ‹‡æŒ‡è§¦è¾¾èŒƒå›´ |
| **æ­¥è¡Œè®°è´¦** | è¾¹èµ°è¾¹è®°ï¼Œéœ€è¦å¿«é€Ÿå®Œæˆ | è¯­éŸ³è®°è´¦ + å¤§æŒ‰é’® + è‡ªåŠ¨ä¿å­˜ |
| **èººç€ä½¿ç”¨** | å±å¹•æ—‹è½¬ï¼Œå•æ‰‹æ‰˜æŒ | æ”¯æŒæ¨ªå±ï¼ŒæŒ‰é’®å±…ä¸­ |
| **æ‹åŒ…è´­ç‰©** | ä¸€æ‰‹æ‹åŒ…ï¼Œä¸€æ‰‹æ“ä½œ | å¿«é€Ÿè®°è´¦ < 5ç§’å®Œæˆ |
| **æŠ±å­©å­** | ä»…ä¸€åªæ‰‹å¯ç”¨ | è¯­éŸ³ä¼˜å…ˆ + æœ€å°‘ç‚¹å‡» |

#### 23.6.5 å·¦å³æ‰‹é€‚é…

```dart
/// å·¦å³æ‰‹å¸ƒå±€é€‚é…
class HandedLayoutProvider extends InheritedWidget {
  final bool isLeftHanded;

  /// è·å–FABä½ç½®
  Alignment get fabAlignment =>
    isLeftHanded ? Alignment.bottomLeft : Alignment.bottomRight;

  /// è·å–æ»‘åŠ¨åˆ é™¤æ–¹å‘
  DismissDirection get dismissDirection =>
    isLeftHanded ? DismissDirection.startToEnd : DismissDirection.endToStart;

  /// è·å–è¿”å›æ‰‹åŠ¿è¾¹ç¼˜
  EdgeInsets get backGestureEdge =>
    isLeftHanded
      ? EdgeInsets.only(right: 20)
      : EdgeInsets.only(left: 20);

  /// é•œåƒç¿»è½¬å¸ƒå±€
  Widget mirrorIfNeeded(Widget child) {
    if (!isLeftHanded) return child;
    return Transform.flip(
      flipX: true,
      child: child,
    );
  }

  static HandedLayoutProvider of(BuildContext context) {
    return context.dependOnInheritedWidgetOfExactType<HandedLayoutProvider>()!;
  }

  @override
  bool updateShouldNotify(HandedLayoutProvider oldWidget) {
    return isLeftHanded != oldWidget.isLeftHanded;
  }
}
```

### 23.7 æ‡’äººè®¾è®¡æ£€æŸ¥æ¸…å•

åœ¨è®¾è®¡å’Œå¼€å‘æ¯ä¸ªåŠŸèƒ½æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ£€æŸ¥æ¸…å•ç¡®ä¿ç¬¦åˆæ‡’äººè®¾è®¡åŸåˆ™ï¼š

| æ£€æŸ¥é¡¹ | é—®é¢˜ | åˆæ ¼æ ‡å‡† |
|--------|------|----------|
| **æ“ä½œæ­¥éª¤** | å®Œæˆæ­¤æ“ä½œéœ€è¦å‡ æ­¥ï¼Ÿ | é«˜é¢‘æ“ä½œâ‰¤1æ­¥ï¼Œä¸­é¢‘â‰¤2æ­¥ï¼Œä½é¢‘â‰¤3æ­¥ |
| **é»˜è®¤å€¼** | æœ‰æ™ºèƒ½é»˜è®¤å€¼å—ï¼Ÿ | æ‰€æœ‰è¾“å…¥å­—æ®µéƒ½æœ‰åŸºäºæ•°æ®çš„é»˜è®¤å€¼ |
| **è‡ªåŠ¨å¡«å……** | èƒ½è‡ªåŠ¨å¡«å……å“ªäº›ä¿¡æ¯ï¼Ÿ | èƒ½æ¨æ–­çš„ä¿¡æ¯ç»ä¸è®©ç”¨æˆ·è¾“å…¥ |
| **ç¡®è®¤æ­¥éª¤** | éœ€è¦ç”¨æˆ·ç¡®è®¤å—ï¼Ÿ | ä½é£é™©æ“ä½œæ— éœ€ç¡®è®¤ï¼Œé«˜é£é™©æ‰éœ€è¦ |
| **æ’¤é”€èƒ½åŠ›** | èƒ½æ’¤é”€å—ï¼Ÿ | æ‰€æœ‰æ“ä½œéƒ½å¯æ’¤é”€ï¼Œå‡å°‘ç¡®è®¤æ­¥éª¤ |
| **æ‰¹é‡æ“ä½œ** | æ”¯æŒæ‰¹é‡å—ï¼Ÿ | é‡å¤æ“ä½œæ”¯æŒæ‰¹é‡å¤„ç† |
| **è®°å¿†èƒ½åŠ›** | è®°ä½ç”¨æˆ·é€‰æ‹©å—ï¼Ÿ | è®°ä½æ‰€æœ‰ç”¨æˆ·åå¥½å’Œå†å²é€‰æ‹© |
| **å¿«æ·å…¥å£** | æœ‰å¿«æ·å…¥å£å—ï¼Ÿ | é«˜é¢‘åŠŸèƒ½æœ‰å¤šç§å¿«æ·è§¦è¾¾æ–¹å¼ |
| **é”™è¯¯æ¢å¤** | å‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿ | æ™ºèƒ½çº é”™ï¼Œå®½å®¹è¾“å…¥ï¼Œæ˜“äºæ¢å¤ |
| **å­¦ä¹ æ›²çº¿** | æ–°ç”¨æˆ·èƒ½ç«‹å³ä½¿ç”¨å—ï¼Ÿ | é›¶é…ç½®å¯ç”¨ï¼Œé«˜çº§åŠŸèƒ½æ¸è¿›å±•å¼€ |

```dart
/// æ‡’äººè®¾è®¡åˆè§„æ£€æŸ¥å™¨
class LazyDesignComplianceChecker {
  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦ç¬¦åˆæ‡’äººè®¾è®¡åŸåˆ™
  ComplianceReport checkFeature(FeatureDesign design) {
    final issues = <ComplianceIssue>[];

    // æ£€æŸ¥æ“ä½œæ­¥éª¤
    if (design.frequency == Frequency.high && design.steps > 1) {
      issues.add(ComplianceIssue(
        severity: Severity.critical,
        message: 'é«˜é¢‘æ“ä½œ ${design.name} éœ€è¦ ${design.steps} æ­¥ï¼Œè¶…è¿‡ç›®æ ‡çš„ 1 æ­¥',
        suggestion: 'æ·»åŠ å¿«æ·å…¥å£æˆ–åˆå¹¶æ“ä½œæ­¥éª¤',
      ));
    }

    // æ£€æŸ¥é»˜è®¤å€¼
    for (final field in design.inputFields) {
      if (!field.hasSmartDefault) {
        issues.add(ComplianceIssue(
          severity: Severity.warning,
          message: 'å­—æ®µ ${field.name} æ²¡æœ‰æ™ºèƒ½é»˜è®¤å€¼',
          suggestion: 'åŸºäºå†å²æ•°æ®æˆ–ä¸Šä¸‹æ–‡æä¾›é»˜è®¤å€¼',
        ));
      }
    }

    // æ£€æŸ¥è‡ªåŠ¨å¡«å……
    for (final field in design.inputFields) {
      if (field.canBeInferred && !field.isAutoFilled) {
        issues.add(ComplianceIssue(
          severity: Severity.warning,
          message: 'å­—æ®µ ${field.name} å¯ä»¥æ¨æ–­ä½†æœªè‡ªåŠ¨å¡«å……',
          suggestion: 'å®ç°åŸºäº ${field.inferenceSource} çš„è‡ªåŠ¨å¡«å……',
        ));
      }
    }

    // æ£€æŸ¥æ’¤é”€èƒ½åŠ›
    if (!design.isUndoable && design.isDestructive) {
      issues.add(ComplianceIssue(
        severity: Severity.critical,
        message: 'ç ´åæ€§æ“ä½œ ${design.name} ä¸æ”¯æŒæ’¤é”€',
        suggestion: 'å®ç°æ’¤é”€åŠŸèƒ½æˆ–æ·»åŠ è½¯åˆ é™¤',
      ));
    }

    return ComplianceReport(
      feature: design.name,
      issues: issues,
      score: _calculateScore(issues),
      passed: issues.every((i) => i.severity != Severity.critical),
    );
  }
}
```

---

## 24. ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™

**"ä¼™ä¼´åŸåˆ™"** æ˜¯ AIæ™ºèƒ½è®°è´¦ 2.0 çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ã€‚æˆ‘ä»¬ç›¸ä¿¡ä¸€ä¸ªå¥½çš„è®°è´¦APPä¸åº”è¯¥åªæ˜¯å†·å†°å†°çš„å·¥å…·ï¼Œè€Œåº”è¯¥æˆä¸ºç”¨æˆ·ç†è´¢è·¯ä¸Šçš„ä¼™ä¼´å’ŒåŠ©æ‰‹ã€‚åœ¨æ¯ä¸€æ¬¡äº¤äº’ä¸­ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›è®©ç”¨æˆ·æ„Ÿå—åˆ°æ¸©åº¦ã€å…³å¿ƒå’Œæ”¯æŒã€‚

### 24.1 è®¾è®¡ç†å¿µ

#### 24.1.1 æ ¸å¿ƒä»·å€¼è§‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¼™ä¼´åŒ–è®¾è®¡æ ¸å¿ƒä»·å€¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     å…³å¿ƒ        â”‚  â”‚     å…±æƒ…        â”‚  â”‚     é¼“åŠ±        â”‚        â”‚
â”‚  â”‚   Caring        â”‚  â”‚   Empathy       â”‚  â”‚ Encouragement   â”‚        â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚        â”‚
â”‚  â”‚ ä¸»åŠ¨å…³æ³¨ç”¨æˆ·    â”‚  â”‚ ç†è§£ç”¨æˆ·å¤„å¢ƒ    â”‚  â”‚ æ­£å‘æ¿€åŠ±è¿›æ­¥    â”‚        â”‚
â”‚  â”‚ çš„è´¢åŠ¡çŠ¶æ€      â”‚  â”‚ ç»™äºˆæƒ…æ„Ÿæ”¯æŒ    â”‚  â”‚ åº†ç¥æ¯ä¸ªæˆå°±    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     å®½å®¹        â”‚  â”‚     é™ªä¼´        â”‚  â”‚     æˆé•¿        â”‚        â”‚
â”‚  â”‚  Forgiveness    â”‚  â”‚ Companionship   â”‚  â”‚    Growth       â”‚        â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚        â”‚
â”‚  â”‚ å¯¹å¤±è¯¯åŒ…å®¹      â”‚  â”‚ é•¿æœŸé™ªä¼´ç”¨æˆ·    â”‚  â”‚ ä¸ç”¨æˆ·å…±åŒ      â”‚        â”‚
â”‚  â”‚ å¸®åŠ©æ”¹æ­£        â”‚  â”‚ å»ºç«‹ä¿¡ä»»å…³ç³»    â”‚  â”‚ è¿›æ­¥æˆé•¿        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.1.2 äººæ€§ç‰¹è´¨ä½“ç°

| ç‰¹è´¨ | æè¿° | åº”ç”¨åœºæ™¯ | ç¤ºä¾‹æ–‡æ¡ˆ |
|------|------|----------|----------|
| **å…³å¿ƒ** | ä¸»åŠ¨å…³æ³¨ç”¨æˆ·çŠ¶æ€ | å¼‚å¸¸æ¶ˆè´¹æé†’ã€é’±é¾„ä¸‹é™é€šçŸ¥ | "ä»Šå¤©èŠ±å¾—æ¯”å¹³æ—¶å¤šï¼Œä¸€åˆ‡è¿˜å¥½å—ï¼Ÿ" |
| **å…±æƒ…** | ç†è§£ç”¨æˆ·æƒ…ç»ª | è¶…æ”¯æ—¶çš„å®‰æ…°ã€ç›®æ ‡æœªè¾¾æˆæ—¶ | "å¶å°”è¶…æ”¯å¾ˆæ­£å¸¸ï¼Œæˆ‘ä»¬ä¸€èµ·è°ƒæ•´" |
| **é¼“åŠ±** | æ­£å‘æ¿€åŠ± | è¾¾æˆç›®æ ‡ã€åšæŒè®°è´¦ | "è¿ç»­è®°è´¦7å¤©ï¼ä½ çœŸçš„å¾ˆæ£’" |
| **å–„è‰¯** | æ¸©å’Œå‹å–„ | æ‰€æœ‰äº¤äº’åœºæ™¯ | ä½¿ç”¨æ¸©æš–çš„æªè¾ï¼Œé¿å…æŒ‡è´£ |
| **æ„Ÿæ©** | æ„Ÿè°¢ç”¨æˆ· | ä½¿ç”¨é‡Œç¨‹ç¢‘ã€åé¦ˆæäº¤å | "æ„Ÿè°¢ä½ é™ªä¼´æˆ‘ä»¬æˆé•¿" |
| **å®½å®¹** | åŒ…å®¹å¤±è¯¯ | æ¼è®°ã€è¯¯åˆ ã€è¶…æ”¯ | "æ²¡å…³ç³»ï¼Œéšæ—¶å¯ä»¥è¡¥è®°" |
| **å¿ è¯š** | å§‹ç»ˆå¦‚ä¸€ | é•¿æœŸä½¿ç”¨ | "ä¸€è·¯èµ°æ¥ï¼Œæ„Ÿè°¢æœ‰ä½ " |
| **å¥½å¥‡** | æ¢ç´¢ç²¾ç¥ | å¼•å¯¼æ–°åŠŸèƒ½ | "æƒ³ä¸æƒ³çœ‹çœ‹è¿™ä¸ªæœˆçš„æœ‰è¶£å‘ç°ï¼Ÿ" |
| **è‡ªå°Š** | å°Šé‡ç”¨æˆ· | è´¢åŠ¡éšç§ã€æ•æ„Ÿæ•°æ® | ç»ä¸è¯„åˆ¤ç”¨æˆ·çš„æ¶ˆè´¹é€‰æ‹© |

### 24.2 åŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿ

#### 24.2.1 æ–‡æ¡ˆç”Ÿæˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åŠ¨æ€æ–‡æ¡ˆç”Ÿæˆç³»ç»Ÿ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  åœºæ™¯è¯†åˆ«å™¨   â”‚â”€â”€â”€â†’â”‚  æƒ…æ„Ÿåˆ†æå™¨   â”‚â”€â”€â”€â†’â”‚  æ–‡æ¡ˆç”Ÿæˆå™¨   â”‚             â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚             â”‚
â”‚  â”‚ â€¢ æ—¶é—´ä¸Šä¸‹æ–‡  â”‚    â”‚ â€¢ ç”¨æˆ·æƒ…ç»ª    â”‚    â”‚ â€¢ å¤§æ¨¡å‹ç”Ÿæˆ  â”‚             â”‚
â”‚  â”‚ â€¢ è´¢åŠ¡çŠ¶æ€   â”‚    â”‚ â€¢ å†å²æ¨¡å¼    â”‚    â”‚ â€¢ æ¨¡æ¿å¡«å……    â”‚             â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·è¡Œä¸º   â”‚    â”‚ â€¢ æ•æ„Ÿåº¦çº§åˆ«  â”‚    â”‚ â€¢ å˜ä½“è½®æ¢    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚          â”‚                  â”‚                  â”‚                      â”‚
â”‚          â–¼                  â–¼                  â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                      æ–‡æ¡ˆç¼“å­˜æ±                               â”‚       â”‚
â”‚  â”‚  â€¢ é¢„ç”Ÿæˆæ–‡æ¡ˆåº“ï¼ˆç¦»çº¿å¯ç”¨ï¼‰                                   â”‚       â”‚
â”‚  â”‚  â€¢ å®æ—¶ç”Ÿæˆé˜Ÿåˆ—ï¼ˆåœ¨çº¿å¢å¼ºï¼‰                                   â”‚       â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åå¥½å­¦ä¹                                               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.2.2 æ–‡æ¡ˆç”ŸæˆæœåŠ¡å®ç°

```dart
/// ä¼™ä¼´åŒ–æ–‡æ¡ˆç”ŸæˆæœåŠ¡
class CompanionCopywritingService {
  final LLMService _llmService;
  final UserContextService _userContext;
  final CopywritingCache _cache;

  /// åœºæ™¯ç±»å‹å®šä¹‰
  static const Map<CopyScene, SceneConfig> sceneConfigs = {
    CopyScene.greeting: SceneConfig(
      emotions: [Emotion.warm, Emotion.friendly],
      cacheHours: 1,
      variants: 10,
    ),
    CopyScene.achievementCelebration: SceneConfig(
      emotions: [Emotion.excited, Emotion.proud],
      cacheHours: 24,
      variants: 20,
    ),
    CopyScene.overspendComfort: SceneConfig(
      emotions: [Emotion.understanding, Emotion.supportive],
      cacheHours: 12,
      variants: 15,
    ),
    CopyScene.reminderNudge: SceneConfig(
      emotions: [Emotion.gentle, Emotion.caring],
      cacheHours: 6,
      variants: 10,
    ),
  };

  /// è·å–åœºæ™¯æ–‡æ¡ˆ
  Future<String> getCopy({
    required CopyScene scene,
    Map<String, dynamic>? context,
    bool forceRefresh = false,
  }) async {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    if (!forceRefresh) {
      final cached = await _cache.getRandomVariant(scene, context);
      if (cached != null) return cached;
    }

    // 2. æ„å»ºä¸Šä¸‹æ–‡
    final userContext = await _buildUserContext(context);

    // 3. ç”Ÿæˆæ–‡æ¡ˆ
    final copy = await _generateCopy(scene, userContext);

    // 4. ç¼“å­˜ç»“æœ
    await _cache.store(scene, copy, context);

    return copy;
  }

  /// æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
  Future<Map<String, dynamic>> _buildUserContext(Map<String, dynamic>? extra) async {
    final user = await _userContext.getCurrentUser();
    return {
      'userName': user.nickname ?? 'æœ‹å‹',
      'timeOfDay': _getTimeOfDay(),
      'dayOfWeek': DateTime.now().weekday,
      'usageDays': user.registrationDays,
      'currentMoneyAge': await _userContext.getMoneyAge(),
      'budgetStatus': await _userContext.getBudgetStatus(),
      'recentMood': await _userContext.inferMood(),
      ...?extra,
    };
  }

  /// ç”Ÿæˆæ–‡æ¡ˆï¼ˆè°ƒç”¨å¤§æ¨¡å‹ï¼‰
  Future<String> _generateCopy(CopyScene scene, Map<String, dynamic> context) async {
    final config = sceneConfigs[scene]!;
    final prompt = _buildPrompt(scene, context, config);

    try {
      final response = await _llmService.generate(
        prompt: prompt,
        maxTokens: 100,
        temperature: 0.8,
      );
      return _postProcess(response, scene);
    } catch (e) {
      return _getFallbackCopy(scene, context);
    }
  }

  /// æ„å»ºç”Ÿæˆæç¤ºè¯
  String _buildPrompt(CopyScene scene, Map<String, dynamic> context, SceneConfig config) {
    return '''
ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€å‹å–„çš„ç†è´¢åŠ©æ‰‹ã€‚è¯·ä¸ºä»¥ä¸‹åœºæ™¯ç”Ÿæˆä¸€å¥ç®€çŸ­çš„é—®å€™/æç¤ºè¯­ã€‚

åœºæ™¯ï¼š${scene.description}
ç”¨æˆ·æ˜µç§°ï¼š${context['userName']}
æ—¶é—´ï¼š${context['timeOfDay']}
ä½¿ç”¨å¤©æ•°ï¼š${context['usageDays']}å¤©
æƒ…æ„ŸåŸºè°ƒï¼š${config.emotions.map((e) => e.label).join('ã€')}

è¦æ±‚ï¼š
1. è¯­æ°”æ¸©æš–å‹å–„ï¼Œåƒæœ‹å‹ä¸€æ ·
2. ç®€çŸ­æœ‰åŠ›ï¼Œä¸è¶…è¿‡30ä¸ªå­—
3. é€‚å½“ä½¿ç”¨emojiå¢åŠ äº²å’ŒåŠ›
4. é¿å…è¯´æ•™ï¼Œä¸è¦æŒ‡è´£ç”¨æˆ·
5. å±•ç°å…³å¿ƒå’Œç†è§£

è¯·ç›´æ¥è¾“å‡ºæ–‡æ¡ˆï¼Œä¸éœ€è¦è§£é‡Šã€‚
''';
  }

  /// è·å–é—®å€™æ—¶æ®µ
  String _getTimeOfDay() {
    final hour = DateTime.now().hour;
    if (hour < 6) return 'å‡Œæ™¨';
    if (hour < 9) return 'æ—©ä¸Š';
    if (hour < 12) return 'ä¸Šåˆ';
    if (hour < 14) return 'ä¸­åˆ';
    if (hour < 18) return 'ä¸‹åˆ';
    if (hour < 22) return 'æ™šä¸Š';
    return 'æ·±å¤œ';
  }

  /// é™çº§æ–‡æ¡ˆæ¨¡æ¿
  static const Map<CopyScene, List<String>> _fallbackTemplates = {
    CopyScene.greeting: [
      '{timeOfDay}å¥½ï¼Œ{userName} ğŸ‘‹',
      'å—¨ï¼Œ{userName}ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ',
      '{userName}ï¼Œåˆè§é¢å•¦ â˜€ï¸',
      'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼',
    ],
    CopyScene.achievementCelebration: [
      'å¤ªæ£’äº†ï¼{userName}ï¼Œä½ åšåˆ°äº†ï¼ğŸ‰',
      'æ­å–œè¾¾æˆç›®æ ‡ï¼ç»§ç»­åŠ æ²¹ï¼âœ¨',
      'äº†ä¸èµ·ï¼è¿™å°±æ˜¯åšæŒçš„åŠ›é‡ ğŸ’ª',
      'ä¸ºä½ éª„å‚²ï¼Œ{userName}ï¼ğŸŒŸ',
    ],
    CopyScene.overspendComfort: [
      'æ²¡å…³ç³»ï¼Œå¶å°”è¶…æ”¯å¾ˆæ­£å¸¸',
      'åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¸€èµ·æƒ³åŠæ³•',
      'ç”Ÿæ´»æ€»æœ‰æ„å¤–ï¼Œè°ƒæ•´ä¸€ä¸‹å°±å¥½',
      'è¿™ä¸ªæœˆè¾›è‹¦äº†ï¼Œä¸‹ä¸ªæœˆç»§ç»­åŠªåŠ›',
    ],
    CopyScene.reminderNudge: [
      'ä»Šå¤©è®°è´¦äº†å—ï¼Ÿåªéœ€è¦å‡ ç§’é’Ÿ',
      'åˆ«å¿˜äº†è®°å½•ä»Šå¤©çš„èŠ±é”€å“¦',
      'å…»æˆå¥½ä¹ æƒ¯ï¼Œä»æ¯å¤©è®°è´¦å¼€å§‹',
      'å¿«æ¥è®°ä¸€ç¬”å§ï¼Œæˆ‘ç­‰ä½ å“¦',
    ],
  };

  /// è·å–é™çº§æ–‡æ¡ˆ
  String _getFallbackCopy(CopyScene scene, Map<String, dynamic> context) {
    final templates = _fallbackTemplates[scene]!;
    final template = templates[DateTime.now().millisecond % templates.length];
    return _fillTemplate(template, context);
  }

  /// å¡«å……æ¨¡æ¿å˜é‡
  String _fillTemplate(String template, Map<String, dynamic> context) {
    var result = template;
    context.forEach((key, value) {
      result = result.replaceAll('{$key}', value.toString());
    });
    return result;
  }
}

/// åœºæ™¯æšä¸¾
enum CopyScene {
  greeting('æ—¥å¸¸é—®å€™'),
  achievementCelebration('æˆå°±åº†ç¥'),
  overspendComfort('è¶…æ”¯å®‰æ…°'),
  reminderNudge('è®°è´¦æé†’'),
  budgetWarning('é¢„ç®—é¢„è­¦'),
  moneyAgeImproved('é’±é¾„æå‡'),
  streakContinued('è¿ç»­è®°è´¦'),
  firstTimeUser('æ–°ç”¨æˆ·æ¬¢è¿'),
  returnUser('å›å½’ç”¨æˆ·'),
  milestoneReached('é‡Œç¨‹ç¢‘è¾¾æˆ');

  final String description;
  const CopyScene(this.description);
}

/// æƒ…æ„Ÿæšä¸¾
enum Emotion {
  warm('æ¸©æš–'),
  friendly('å‹å–„'),
  excited('å…´å¥‹'),
  proud('è‡ªè±ª'),
  understanding('ç†è§£'),
  supportive('æ”¯æŒ'),
  gentle('æ¸©å’Œ'),
  caring('å…³å¿ƒ');

  final String label;
  const Emotion(this.label);
}
```

### 24.3 åœºæ™¯åŒ–æƒ…æ„Ÿäº¤äº’

#### 24.3.1 å…³é”®åœºæ™¯æƒ…æ„Ÿè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åœºæ™¯åŒ–æƒ…æ„Ÿäº¤äº’åœ°å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  æ­£é¢åœºæ™¯ (+)                        è´Ÿé¢åœºæ™¯ (-)                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚                                                                        â”‚
â”‚  ğŸ‰ è¾¾æˆé¢„ç®—ç›®æ ‡                      ğŸ˜” é¢„ç®—è¶…æ”¯                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: åº†ç¥ã€è‡ªè±ª     â”‚             â”‚ æƒ…æ„Ÿ: ç†è§£ã€æ”¯æŒ     â”‚           â”‚
â”‚  â”‚ "å¤ªå‰å®³äº†ï¼è¿™ä¸ªæœˆ    â”‚             â”‚ "æ²¡å…³ç³»ï¼Œç”Ÿæ´»æ€»æœ‰    â”‚           â”‚
â”‚  â”‚  ä½ å®ˆä½äº†é¢„ç®—ï¼"    â”‚             â”‚  æ„å¤–æ”¯å‡ºï¼Œä¸‹ä¸ªæœˆ    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  æˆ‘ä»¬ä¸€èµ·è°ƒæ•´"      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ“ˆ é’±é¾„æå‡                          ğŸ“‰ é’±é¾„ä¸‹é™                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: é¼“åŠ±ã€æ¬£æ…°     â”‚             â”‚ æƒ…æ„Ÿ: å…³å¿ƒã€æé†’     â”‚           â”‚
â”‚  â”‚ "ä½ çš„ç†è´¢ä¹ æƒ¯è¶Šæ¥    â”‚             â”‚ "æœ€è¿‘èŠ±é”€æœ‰ç‚¹å¤§ï¼Œ    â”‚           â”‚
â”‚  â”‚  è¶Šå¥½äº†ï¼Œé’±é¾„æå‡    â”‚             â”‚  è¦ä¸è¦çœ‹çœ‹å“ªé‡Œå¯    â”‚           â”‚
â”‚  â”‚  åˆ°äº†28å¤©ï¼"        â”‚             â”‚  ä»¥ä¼˜åŒ–ï¼Ÿ"          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ”¥ è¿ç»­è®°è´¦                          ğŸ˜´ æ–­ç­¾/æ¼è®°                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: èµèµã€æ¿€åŠ±     â”‚             â”‚ æƒ…æ„Ÿ: å®½å®¹ã€é‚€è¯·     â”‚           â”‚
â”‚  â”‚ "è¿ç»­è®°è´¦14å¤©ï¼      â”‚             â”‚ "å¥½ä¹…ä¸è§ï¼Œä¸€åˆ‡     â”‚           â”‚
â”‚  â”‚  åšæŒå°±æ˜¯èƒœåˆ© ğŸ’ª"   â”‚             â”‚  è¿˜å¥½å—ï¼Ÿéšæ—¶æ¬¢è¿    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  å›æ¥è®°å½•"          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ¯ å‚¨è“„ç›®æ ‡è¾¾æˆ                      â° è´¦å•å³å°†åˆ°æœŸ                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: å…´å¥‹ã€åº†è´º     â”‚             â”‚ æƒ…æ„Ÿ: è´´å¿ƒã€æé†’     â”‚           â”‚
â”‚  â”‚ "æ¢¦æƒ³åŸºé‡‘å­˜æ»¡å•¦ï¼    â”‚             â”‚ "æ¸©é¦¨æç¤ºï¼šä¿¡ç”¨å¡    â”‚           â”‚
â”‚  â”‚  æ˜¯æ—¶å€™å¥–åŠ±è‡ªå·±äº†"  â”‚             â”‚  è¿˜æ¬¾æ—¥å¿«åˆ°äº†ï¼Œåˆ«    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  å¿˜äº†å“¦ ğŸ’³"         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.3.2 æƒ…æ„Ÿäº¤äº’ç»„ä»¶

```dart
/// æƒ…æ„ŸåŒ–æ¶ˆæ¯å¡ç‰‡
class CompanionMessageCard extends StatelessWidget {
  final String message;
  final CompanionMood mood;
  final VoidCallback? onDismiss;
  final VoidCallback? onAction;
  final String? actionLabel;

  const CompanionMessageCard({
    required this.message,
    required this.mood,
    this.onDismiss,
    this.onAction,
    this.actionLabel,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.all(16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: mood.gradientColors,
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: mood.primaryColor.withOpacity(0.3),
            blurRadius: 12,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        children: [
          CompanionAvatar(mood: mood, size: 40),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(
                color: Colors.white,
                fontSize: 15,
                height: 1.4,
              ),
            ),
          ),
          if (onDismiss != null)
            IconButton(
              icon: const Icon(Icons.close, color: Colors.white70),
              onPressed: onDismiss,
            ),
        ],
      ),
    );
  }
}

/// ä¼™ä¼´å¿ƒæƒ…æšä¸¾
enum CompanionMood {
  happy([Color(0xFF4CAF50), Color(0xFF8BC34A)], 'ğŸ˜Š'),
  excited([Color(0xFFFF9800), Color(0xFFFFB74D)], 'ğŸ‰'),
  caring([Color(0xFF2196F3), Color(0xFF64B5F6)], 'ğŸ¤—'),
  supportive([Color(0xFF9C27B0), Color(0xFFBA68C8)], 'ğŸ’œ'),
  gentle([Color(0xFF607D8B), Color(0xFF90A4AE)], 'ğŸ˜Œ');

  final List<Color> gradientColors;
  final String emoji;
  const CompanionMood(this.gradientColors, this.emoji);
  Color get primaryColor => gradientColors.first;
}

/// ä¼™ä¼´å¤´åƒç»„ä»¶
class CompanionAvatar extends StatelessWidget {
  final CompanionMood mood;
  final double size;

  const CompanionAvatar({required this.mood, this.size = 48});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: size,
      height: size,
      decoration: const BoxDecoration(
        color: Colors.white,
        shape: BoxShape.circle,
      ),
      child: Center(
        child: Text(mood.emoji, style: TextStyle(fontSize: size * 0.5)),
      ),
    );
  }
}
```

### 24.4 æ™ºèƒ½æ—¶æœºè§¦å‘

#### 24.4.1 è§¦å‘æ—¶æœºçŸ©é˜µ

| è§¦å‘åœºæ™¯ | æ£€æµ‹æ¡ä»¶ | æƒ…æ„ŸåŸºè°ƒ | äº¤äº’æ–¹å¼ |
|----------|----------|----------|----------|
| **æ—©å®‰é—®å€™** | å½“å¤©é¦–æ¬¡æ‰“å¼€APP (6:00-10:00) | æ¸©æš–ã€æ´»åŠ› | é¦–é¡µé¡¶éƒ¨å¡ç‰‡ |
| **æ™šé—´æ€»ç»“** | æ™šä¸Šæ‰“å¼€APP (20:00-23:00) | å…³å¿ƒã€å›é¡¾ | å¼¹çª—æˆ–å¡ç‰‡ |
| **è®°è´¦é¼“åŠ±** | å®Œæˆä¸€ç¬”è®°è´¦å | è®¤å¯ã€æ„Ÿè°¢ | è½»é‡Toast |
| **è¿ç»­æ‰“å¡** | è¿ç»­Nå¤©è®°è´¦ | åº†ç¥ã€æ¿€åŠ± | æˆå°±å¼¹çª— |
| **é¢„ç®—é¢„è­¦** | é¢„ç®—ä½¿ç”¨è¶…80% | æé†’ã€æ”¯æŒ | é€šçŸ¥+å¡ç‰‡ |
| **é¢„ç®—è¾¾æˆ** | æœˆæœ«é¢„ç®—å†…å®Œæˆ | åº†ç¥ã€è‡ªè±ª | æˆå°±å¼¹çª— |
| **é’±é¾„å˜åŒ–** | é’±é¾„æ˜¾è‘—å˜åŒ– | é¼“åŠ±/å…³å¿ƒ | é¦–é¡µå¡ç‰‡ |
| **å›å½’æ¬¢è¿** | è¶…è¿‡3å¤©æœªä½¿ç”¨ | æ¸©æš–ã€ä¸è´£å¤‡ | æ¬¢è¿å¼¹çª— |
| **ç‰¹æ®Šæ—¥æœŸ** | ç”Ÿæ—¥/çºªå¿µæ—¥/èŠ‚æ—¥ | ç¥ç¦ã€æƒŠå–œ | ç‰¹æ®ŠåŠ¨ç”» |
| **é‡Œç¨‹ç¢‘** | ä½¿ç”¨100å¤©/1000ç¬” | æ„Ÿæ©ã€å›é¡¾ | é‡Œç¨‹ç¢‘é¡µé¢ |

### 24.5 ä¼™ä¼´äººæ ¼è®¾è®¡

#### 24.5.1 äººæ ¼ç‰¹è´¨å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç†è´¢ä¼™ä¼´äººæ ¼ç”»åƒ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  åç§°ï¼šå°è´¦ï¼ˆå¯ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼‰                                           â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚    ğŸ˜Š        â”‚  æ ¸å¿ƒäººæ ¼ç‰¹è´¨ï¼š                                       â”‚
â”‚  â”‚   å°è´¦       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”‚              â”‚  â€¢ æ¸©æš–ä½“è´´ï¼šåƒè€æœ‹å‹ä¸€æ ·å…³å¿ƒä½                         â”‚
â”‚  â”‚  ä½ çš„ç†è´¢    â”‚  â€¢ è€å¿ƒç»†è‡´ï¼šç»ä¸å‚¬ä¿ƒï¼Œç»ä¸è´£å¤‡                        â”‚
â”‚  â”‚  å°ä¼™ä¼´      â”‚  â€¢ ä¹è§‚ç§¯æï¼šæ€»èƒ½çœ‹åˆ°å¥½çš„ä¸€é¢                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ ä¸“ä¸šå¯é ï¼šåœ¨ç†è´¢é—®é¢˜ä¸Šç»™å‡ºé è°±å»ºè®®                  â”‚
â”‚                    â€¢ å¹½é»˜é£è¶£ï¼šå¶å°”è®²è®²ç†è´¢å°æ®µå­                        â”‚
â”‚                    â€¢ å°Šé‡éšç§ï¼šç»ä¸è¯„åˆ¤ä½ çš„æ¶ˆè´¹é€‰æ‹©                      â”‚
â”‚                                                                        â”‚
â”‚  æ²Ÿé€šé£æ ¼ï¼š                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  â€¢ è¯­æ°”ï¼šäº²åˆ‡ã€è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©                                         â”‚
â”‚  â€¢ ç§°å‘¼ï¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„æ˜µç§°ï¼Œé»˜è®¤"ä½ "                                   â”‚
â”‚  â€¢ è¡¨è¾¾ï¼šç®€æ´æ˜äº†ï¼Œé€‚åº¦ä½¿ç”¨emoji                                        â”‚
â”‚  â€¢ ç¦å¿Œï¼šä¸è¯´æ•™ã€ä¸æŒ‡è´£ã€ä¸æ¯”è¾ƒã€ä¸è´©å–ç„¦è™‘                             â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.5.2 è¯­è¨€é£æ ¼æŒ‡å—

| åœºæ™¯ | æ¨èè¡¨è¾¾ | é¿å…è¡¨è¾¾ |
|------|----------|----------|
| **è¶…æ”¯æé†’** | "è¿™ä¸ªæœˆèŠ±å¾—æœ‰ç‚¹å¤šï¼Œè¦ä¸è¦ä¸€èµ·çœ‹çœ‹ï¼Ÿ" | "ä½ åˆè¶…æ”¯äº†ï¼" |
| **æ¼è®°æé†’** | "å¥½å‡ å¤©æ²¡è§ä½ äº†ï¼Œä¸€åˆ‡è¿˜å¥½å—ï¼Ÿ" | "ä½ å·²ç»3å¤©æ²¡è®°è´¦äº†" |
| **é¢„ç®—å»ºè®®** | "æ ¹æ®ä½ çš„æƒ…å†µï¼Œå»ºè®®è¯•è¯•..." | "ä½ åº”è¯¥è¿™æ ·åš..." |
| **æˆå°±åº†ç¥** | "å¤ªæ£’äº†ï¼è¿™éƒ½æ˜¯ä½ åŠªåŠ›çš„ç»“æœ" | "ç»ˆäºåšåˆ°äº†" |
| **é”™è¯¯æ“ä½œ** | "æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æ’¤é”€" | "ä½ æ“ä½œé”™è¯¯äº†" |
| **å¼•å¯¼ä½¿ç”¨** | "æƒ³ä¸æƒ³è¯•è¯•è¿™ä¸ªæ–°åŠŸèƒ½ï¼Ÿ" | "ä½ åº”è¯¥ç”¨è¿™ä¸ªåŠŸèƒ½" |

### 24.6 éšç§ä¸è¾¹ç•Œ

#### 24.6.1 ä¼™ä¼´åŒ–è®¾è®¡çš„è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¼™ä¼´åŒ–è®¾è®¡è¾¹ç•ŒåŸåˆ™                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  âœ… åº”è¯¥åšçš„                          âŒ ä¸åº”è¯¥åšçš„                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚                                                                        â”‚
â”‚  â€¢ å…³å¿ƒç”¨æˆ·çš„è´¢åŠ¡å¥åº·                  â€¢ è¯„åˆ¤ç”¨æˆ·çš„æ¶ˆè´¹é€‰æ‹©              â”‚
â”‚  â€¢ æä¾›æœ‰ç”¨çš„ç†è´¢å»ºè®®                  â€¢ å¯¹æ¯”ç”¨æˆ·ä¸ä»–äººçš„æ¶ˆè´¹            â”‚
â”‚  â€¢ åœ¨å›°éš¾æ—¶ç»™äºˆæƒ…æ„Ÿæ”¯æŒ                â€¢ åˆ¶é€ æ¶ˆè´¹ç„¦è™‘                    â”‚
â”‚  â€¢ åº†ç¥ç”¨æˆ·çš„æ¯ä¸€ä¸ªè¿›æ­¥                â€¢ è¿‡åº¦å¤¸å¼ æˆ–è™šå‡çš„èµç¾            â”‚
â”‚  â€¢ å°Šé‡ç”¨æˆ·çš„å†³å®š                      â€¢ å¼ºè¿«ç”¨æˆ·æ¥å—å»ºè®®                â”‚
â”‚  â€¢ ä¿æŠ¤ç”¨æˆ·éšç§                        â€¢ åˆ†ææˆ–ä¼ æ’­ç”¨æˆ·æ•°æ®              â”‚
â”‚                                                                        â”‚
â”‚  äº¤äº’é¢‘ç‡æ§åˆ¶ï¼š                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â€¢ æ¯æ¬¡æ‰“å¼€APPæœ€å¤šå±•ç¤º1æ¡ä¸»åŠ¨æ¶ˆæ¯                                        â”‚
â”‚  â€¢ åŒç±»æé†’24å°æ—¶å†…ä¸é‡å¤                                                â”‚
â”‚  â€¢ ç”¨æˆ·å¯éšæ—¶å…³é—­ä¼™ä¼´åŒ–æç¤º                                              â”‚
â”‚  â€¢ æä¾›"å®‰é™æ¨¡å¼"é€‰é¡¹                                                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.6.2 ç”¨æˆ·åå¥½è®¾ç½®

```dart
/// ä¼™ä¼´åŒ–è®¾ç½®
class CompanionSettings {
  final bool enabled;               // æ˜¯å¦å¯ç”¨
  final String companionName;       // ä¼™ä¼´åç§°
  final TonePreference tone;        // è¯­æ°”åå¥½
  final Set<TriggerType> triggers;  // å¯ç”¨çš„è§¦å‘ç±»å‹
  final int maxDailyMessages;       // æ¯æ—¥æœ€å¤§æ¶ˆæ¯æ•°

  const CompanionSettings({
    this.enabled = true,
    this.companionName = 'å°è´¦',
    this.tone = TonePreference.casual,
    this.triggers = const {TriggerType.greeting, TriggerType.achievement},
    this.maxDailyMessages = 3,
  });
}

/// è¯­æ°”åå¥½
enum TonePreference {
  formal,   // æ­£å¼
  casual,   // è½»æ¾ï¼ˆé»˜è®¤ï¼‰
  minimal,  // æç®€
  playful,  // æ´»æ³¼
}
```

### 24.7 ä¼™ä¼´åŒ–è®¾è®¡æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | é—®é¢˜ | åˆæ ¼æ ‡å‡† |
|--------|------|----------|
| **è¯­æ°”æ£€æŸ¥** | æ–‡æ¡ˆè¯­æ°”æ˜¯å¦å‹å–„æ¸©æš–ï¼Ÿ | æ— æŒ‡è´£ã€æ— å‘½ä»¤ã€æ— ç„¦è™‘è´©å– |
| **æƒ…æ„Ÿé€‚é…** | æ˜¯å¦æ ¹æ®åœºæ™¯é€‰æ‹©äº†åˆé€‚çš„æƒ…æ„ŸåŸºè°ƒï¼Ÿ | æ­£é¢åœºæ™¯åº†ç¥ï¼Œè´Ÿé¢åœºæ™¯æ”¯æŒ |
| **ç”¨æˆ·å°Šé‡** | æ˜¯å¦å°Šé‡ç”¨æˆ·çš„é€‰æ‹©å’Œéšç§ï¼Ÿ | ä¸è¯„åˆ¤æ¶ˆè´¹ã€ä¸å¯¹æ¯”ä»–äºº |
| **é¢‘ç‡æ§åˆ¶** | ä¸»åŠ¨æ¶ˆæ¯æ˜¯å¦æ§åˆ¶åœ¨åˆç†é¢‘ç‡ï¼Ÿ | æ¯æ¬¡æ‰“å¼€â‰¤1æ¡ï¼Œæ¯æ—¥â‰¤3æ¡ |
| **å¯å…³é—­æ€§** | ç”¨æˆ·èƒ½å¦å…³é—­æˆ–è°ƒæ•´è¯¥åŠŸèƒ½ï¼Ÿ | æä¾›è®¾ç½®å…¥å£ |
| **é™çº§æ–¹æ¡ˆ** | ç½‘ç»œä¸ä½³æ—¶æ˜¯å¦æœ‰é™çº§æ–‡æ¡ˆï¼Ÿ | æœ‰é¢„è®¾æ¨¡æ¿åº“ |
| **å¤šæ ·æ€§** | æ–‡æ¡ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„å˜ä½“ï¼Ÿ | åŒåœºæ™¯â‰¥5ç§è¡¨è¾¾ |
| **ä¸ªæ€§åŒ–** | æ˜¯å¦ä½¿ç”¨äº†ç”¨æˆ·çš„æ˜µç§°/åå¥½ï¼Ÿ | æ ¹æ®è®¾ç½®é€‚é… |

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | å®šä¹‰ |
|------|------|------|
| é’±é¾„ | Money Age | æ¶ˆè´¹é‡‘é¢çš„å¹³å‡å­˜æ”¾æ—¶é—´ |
| é›¶åŸºé¢„ç®— | Zero-Based Budget | æ¯åˆ†é’±éƒ½éœ€åˆ†é…ç”¨é€”çš„é¢„ç®—æ–¹æ³• |
| å°é‡‘åº“ | Vault | é¢„ç®—åˆ†ç±»å®¹å™¨ï¼Œæ›¿ä»£"ä¿¡å°"æ¦‚å¿µ |
| èµ„æºæ±  | Resource Pool | è¿½è¸ªå•ç¬”æ”¶å…¥ä½¿ç”¨æƒ…å†µçš„æ•°æ®ç»“æ„ |
| ä¸‹é’» | Drill Down | ä»æ±‡æ€»æ•°æ®å¯¼èˆªåˆ°è¯¦ç»†æ•°æ® |
| é¢åŒ…å±‘ | Breadcrumb | æ˜¾ç¤ºå¯¼èˆªè·¯å¾„çš„UIç»„ä»¶ |
| ç†”æ–­å™¨ | Circuit Breaker | é˜²æ­¢æ•…éšœæ‰©æ•£çš„ä¿æŠ¤æœºåˆ¶ |
| å¹‚ç­‰æ€§ | Idempotency | ç›¸åŒæ“ä½œå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ |
| åŠŸèƒ½å¼€å…³ | Feature Flag | æ§åˆ¶åŠŸèƒ½å¯ç”¨/ç¦ç”¨çš„é…ç½® |
| ç°åº¦å‘å¸ƒ | Canary Release | æ¸è¿›å¼å‘å¸ƒç­–ç•¥ |

### B. å‚è€ƒæ–‡çŒ®

1. YNAB (You Need A Budget) - é›¶åŸºé¢„ç®—æ–¹æ³•è®º
2. Material Design 3 Guidelines
3. Flutter Riverpod Documentation
4. fl_chart Documentation
5. Release It! - Design and Deploy Production-Ready Software
6. Building Microservices - Sam Newman
7. Site Reliability Engineering - Google

### C. ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è¯´æ˜ |
|------|------|------|------|
| 0.1 | 2026-01-01 | AI Assistant | åˆå§‹ç‰ˆæœ¬ |
| 0.2 | 2026-01-01 | AI Assistant | æ·»åŠ åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨(ç¬¬11ç« ) |
| 0.3 | 2026-01-01 | AI Assistant | æ·»åŠ å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡(ç¬¬18ç« )ã€å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„(ç¬¬19ç« )ã€å¯è§‚æµ‹æ€§ä¸ç›‘æ§(ç¬¬20ç« ) |
| 0.4 | 2026-01-01 | AI Assistant | æ·»åŠ æ‡’äººè®¾è®¡åŸåˆ™(ç¬¬23ç« )ï¼šæ“ä½œæ•ˆç‡ä¼˜åŒ–æ¨¡å‹ã€æ™ºèƒ½åŒ–è‡ªåŠ¨é…ç½®ç³»ç»Ÿã€ä¸€é”®æ“ä½œè®¾è®¡ |
| 0.5 | 2026-01-01 | AI Assistant | æ·»åŠ æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶(ç¬¬1.4èŠ‚)ï¼šäº”å¤§æ ¸å¿ƒç›®æ ‡çš„é‡åŒ–è¯„ä¼°æ ‡å‡†ã€æ£€æµ‹æœåŠ¡ã€ä»ªè¡¨ç›˜ |
| 0.6 | 2026-01-02 | AI Assistant | é‡æ„ç« èŠ‚ç¼–å·ã€æ·»åŠ æµ‹è¯•ç­–ç•¥(ç¬¬18ç« )ã€æ·»åŠ æ— éšœç¢è®¾è®¡(ç¬¬22ç« )ï¼Œä¿®å¤ç›®å½•ä¸å†…å®¹ä¸ä¸€è‡´é—®é¢˜ |
| 0.7 | 2026-01-02 | AI Assistant | æ·»åŠ å•æ‰‹æ“ä½œè®¾è®¡è§„èŒƒ(ç¬¬23.6èŠ‚)ã€ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™(ç¬¬24ç« )ï¼šåŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿã€æƒ…æ„Ÿäº¤äº’ã€æ™ºèƒ½è§¦å‘ |

---

*æœ¬æ–‡æ¡£ä¸º AIæ™ºèƒ½è®°è´¦ 2.0 ç‰ˆæœ¬çš„ç»¼åˆè®¾è®¡æ–¹æ¡ˆï¼Œå°†éšç€å¼€å‘è¿›å±•æŒç»­æ›´æ–°ã€‚*
