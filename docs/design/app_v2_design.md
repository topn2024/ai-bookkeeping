# AIæ™ºèƒ½è®°è´¦ 2.0 ç‰ˆæœ¬è®¾è®¡æ–¹æ¡ˆ

> ç‰ˆæœ¬ï¼š2.0.0
> æ—¥æœŸï¼š2026-01-01
> çŠ¶æ€ï¼šè®¾è®¡é˜¶æ®µ

## ç›®å½•


**ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¦‚è¿°ä¸æ„¿æ™¯**

- [äº§å“æ¦‚è¿°](#äº§å“æ¦‚è¿°)
1. [è®¾è®¡æ¦‚è¿°](#1-è®¾è®¡æ¦‚è¿°)
2. [äº§å“å®šä½ä¸æ„¿æ™¯](#2-äº§å“å®šä½ä¸æ„¿æ™¯)

**ç¬¬äºŒéƒ¨åˆ†ï¼šè®¾è®¡ç†å¿µä¸åŸåˆ™**

3. [æ‡’äººè®¾è®¡åŸåˆ™](#3-æ‡’äººè®¾è®¡åŸåˆ™)
4. [ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™](#4-ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™)
5. [æ— éšœç¢è®¾è®¡](#5-æ— éšœç¢è®¾è®¡)

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½**

6. [æ ¸å¿ƒåŠŸèƒ½æ¶æ„](#6-æ ¸å¿ƒåŠŸèƒ½æ¶æ„)
7. [é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ](#7-é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ)
8. [é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ](#8-é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ)
9. [é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ](#9-é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ)
10. [AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ](#10-aiæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ)
11. [æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ](#11-æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ)
12. [æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–](#12-æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–)
13. [å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ](#13-å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ)
14. [åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨](#14-åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨)

**ç¬¬å››éƒ¨åˆ†ï¼šæŠ€æœ¯æ¶æ„ä¸å®ç°**

15. [æŠ€æœ¯æ¶æ„è®¾è®¡](#15-æŠ€æœ¯æ¶æ„è®¾è®¡)
16. [æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ](#16-æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ)
17. [è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ](#17-è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ)
18. [æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ](#18-æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ)
19. [æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–](#19-æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–)

**ç¬¬äº”éƒ¨åˆ†ï¼šç”¨æˆ·ä½“éªŒè®¾è®¡**

20. [ç”¨æˆ·ä½“éªŒè®¾è®¡](#20-ç”¨æˆ·ä½“éªŒè®¾è®¡)
21. [å›½é™…åŒ–ä¸æœ¬åœ°åŒ–](#21-å›½é™…åŒ–ä¸æœ¬åœ°åŒ–)

**ç¬¬å…­éƒ¨åˆ†ï¼šå·¥ç¨‹ä¿éšœ**

22. [å®‰å…¨ä¸éšç§](#22-å®‰å…¨ä¸éšç§)
23. [å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡](#23-å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡)
24. [å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„](#24-å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„)
25. [å¯è§‚æµ‹æ€§ä¸ç›‘æ§](#25-å¯è§‚æµ‹æ€§ä¸ç›‘æ§)

**ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®æ–½è®¡åˆ’**

26. [ç‰ˆæœ¬è¿ç§»ç­–ç•¥](#26-ç‰ˆæœ¬è¿ç§»ç­–ç•¥)
27. [å®æ–½è·¯çº¿å›¾](#27-å®æ–½è·¯çº¿å›¾)

**ç¬¬å…«éƒ¨åˆ†ï¼šç”¨æˆ·å¢é•¿**

28. [ç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡](#28-ç”¨æˆ·å£ç¢‘ä¸npsæå‡è®¾è®¡)
29. [ä½æˆæœ¬è·å®¢ä¸è‡ªç„¶å¢é•¿è®¾è®¡](#29-ä½æˆæœ¬è·å®¢ä¸è‡ªç„¶å¢é•¿è®¾è®¡)

> **ç›¸å…³æ–‡æ¡£**: [AIæ™ºèƒ½è®°è´¦ 2.0 æµ‹è¯•ç­–ç•¥](./app_v2_test_strategy.md) - æµ‹è¯•éªŒè¯ç›¸å…³å†…å®¹

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¦‚è¿°ä¸æ„¿æ™¯

## äº§å“æ¦‚è¿°

### ä¸€å¥è¯å®šä½

> **AIæ™ºèƒ½è®°è´¦** â€”â€” ä½ çš„æ™ºèƒ½ç†è´¢ä¼™ä¼´ï¼Œè®©è®°è´¦ä»è´Ÿæ‹…å˜æˆä¹ æƒ¯ï¼Œè®©æ¯ä¸€åˆ†é’±éƒ½èŠ±å¾—æ˜ç™½ã€‚

### äº§å“æ„¿æ™¯

æˆ‘ä»¬ç›¸ä¿¡ï¼Œè®°è´¦ä¸åº”è¯¥æ˜¯æ¯ç‡¥çš„æ•°æ®å½•å…¥ï¼Œè€Œåº”è¯¥æˆä¸ºç†è§£è‡ªå·±ã€æŒæ§ç”Ÿæ´»çš„æ–¹å¼ã€‚AIæ™ºèƒ½è®°è´¦é€šè¿‡å‰æ²¿çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œå°†ç¹ççš„è®°è´¦è¿‡ç¨‹ç®€åŒ–åˆ°æè‡´ï¼ŒåŒæ—¶æä¾›æ·±åº¦çš„è´¢åŠ¡æ´å¯Ÿï¼Œå¸®åŠ©ç”¨æˆ·å»ºç«‹å¥åº·çš„é‡‘èä¹ æƒ¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚     "ä¸åªæ˜¯è®°è´¦å·¥å…·ï¼Œæ›´æ˜¯æ‡‚ä½ çš„ç†è´¢ä¼™ä¼´"                                          â”‚
â”‚                                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚                                                                      â”‚   â”‚
â”‚     â”‚   ğŸ˜®â€ğŸ’¨ ä¼ ç»Ÿè®°è´¦                    âœ¨ AIæ™ºèƒ½è®°è´¦                        â”‚   â”‚
â”‚     â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚   â”‚
â”‚     â”‚   æ‰‹åŠ¨è¾“å…¥æ¯ä¸€ç¬”      â”€â”€â”€â”€â”€â”€â”€â–º     è¯´å¥è¯/æ‹å¼ ç…§ï¼Œæå®š                 â”‚   â”‚
â”‚     â”‚   åˆ†ç±»æ€»æ˜¯é€‰é”™        â”€â”€â”€â”€â”€â”€â”€â–º     AIè‡ªåŠ¨è¯†åˆ«ï¼Œå‡†ç¡®åˆ†ç±»                â”‚   â”‚
â”‚     â”‚   è®°äº†ä¸çŸ¥é“æœ‰å•¥ç”¨    â”€â”€â”€â”€â”€â”€â”€â–º     é’±é¾„åˆ†æï¼Œçœ‹æ‡‚æ¶ˆè´¹                  â”‚   â”‚
â”‚     â”‚   é¢„ç®—æ€»æ˜¯è¶…æ”¯        â”€â”€â”€â”€â”€â”€â”€â–º     å°é‡‘åº“è§„åˆ’ï¼ŒèŠ±é’±æœ‰æ•°                â”‚   â”‚
â”‚     â”‚   æœˆå…‰ä¸çŸ¥ä¸ºä½•        â”€â”€â”€â”€â”€â”€â”€â–º     æ™ºèƒ½æ´å¯Ÿï¼ŒåŸ¹å…»å¥½ä¹ æƒ¯                â”‚   â”‚
â”‚     â”‚                                                                      â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåˆ›æ–°

#### ğŸ¯ é’±é¾„åˆ†æ â€”â€” çŸ¥é“èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™èµšçš„é’±

è¿™æ˜¯å¸‚é¢ä¸Šç‹¬ä¸€æ— äºŒçš„åˆ›æ–°åŠŸèƒ½ã€‚å½“ä½ ä¹°ä¸€æ¯å’–å•¡æ—¶ï¼Œç³»ç»Ÿä¼šå‘Šè¯‰ä½ ï¼š"è¿™æ¯å’–å•¡èŠ±çš„æ˜¯ä½ 15å¤©å‰èµšçš„é’±"ã€‚é€šè¿‡å¯è§†åŒ–çš„é’±é¾„ä»ªè¡¨ç›˜ï¼Œä½ èƒ½ç›´è§‚åœ°äº†è§£è‡ªå·±æ˜¯åœ¨"èŠ±ä¸Šä¸ªæœˆçš„é’±"è¿˜æ˜¯"èŠ±ä¸‹ä¸ªæœˆçš„é’±"ï¼Œä»è€Œå»ºç«‹å¯¹è´¢åŠ¡çŠ¶å†µçš„æ·±åº¦æ„ŸçŸ¥ã€‚

#### ğŸ’° é›¶åŸºé¢„ç®— + å°é‡‘åº“ â€”â€” è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰å½’å±

å‘Šåˆ«ä¼ ç»Ÿçš„"æ”¶å…¥-æ”¯å‡º=ç»“ä½™"æ€ç»´ã€‚2.0ç‰ˆæœ¬å¼•å…¥ä¿¡å°é¢„ç®—æ³•ï¼šæ¯æœˆæ”¶å…¥è‡ªåŠ¨åˆ†é…åˆ°ä¸åŒçš„"å°é‡‘åº“"ï¼ˆé¤é¥®ã€äº¤é€šã€å¨±ä¹ã€å‚¨è“„...ï¼‰ï¼Œæ¶ˆè´¹æ—¶ä»å¯¹åº”å°é‡‘åº“æ‰£é™¤ã€‚è¶…æ”¯æ—¶ç³»ç»Ÿæé†’ï¼Œæ¬ æ¬¾æ—¶æ™ºèƒ½è°ƒæ‹¨ï¼Œè®©é¢„ç®—ç®¡ç†å˜å¾—ç®€å•ç›´è§‚ã€‚

#### ğŸ¤– AIæ™ºèƒ½è¯†åˆ« â€”â€” è®°è´¦åªéœ€1ç§’

- **è¯­éŸ³è®°è´¦**ï¼š"åˆé¥­èŠ±äº†35ï¼Œæ‰“è½¦18å—" â†’ è‡ªåŠ¨è¯†åˆ«å¹¶è®°å½•ä¸¤ç¬”
- **å›¾ç‰‡è¯†åˆ«**ï¼šæ‹ç…§å°ç¥¨ã€å¤–å–æˆªå›¾ã€é“¶è¡Œè´¦å• â†’ è‡ªåŠ¨è§£æé‡‘é¢å’Œå•†æˆ·
- **æ™ºèƒ½åˆ†ç±»**ï¼šåŸºäºæ¶ˆè´¹åœºæ™¯ã€å•†æˆ·ä¿¡æ¯ã€å†å²ä¹ æƒ¯è‡ªåŠ¨åˆ†ç±»ï¼Œå‡†ç¡®ç‡>95%

#### ğŸŒ± é‡‘èä¹ æƒ¯åŸ¹å…» â€”â€” ä»æœˆå…‰æ—åˆ°è´¢åŠ¡è‡ªç”±

ç³»ç»Ÿä¸åªè®°å½•æ•°æ®ï¼Œæ›´å¸®ä½ æ”¹å˜è¡Œä¸ºï¼š
- **æ¶ˆè´¹å®¡è§†**ï¼šè¯†åˆ«è®¢é˜…æµªè´¹ã€æ‹¿é“å› å­ï¼ˆå°é¢é«˜é¢‘æ¶ˆè´¹ï¼‰
- **å†²åŠ¨é˜²æŠ¤**ï¼šå¤§é¢æ¶ˆè´¹24å°æ—¶å†·é™æœŸï¼Œé¢„ç®—é¢„è­¦æé†’
- **è´¢åŠ¡ç¼“å†²**ï¼šå¼•å¯¼å»ºç«‹åº”æ€¥é‡‘ï¼Œæ‘†è„±è´¢åŠ¡ç„¦è™‘

### è®¾è®¡ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä¸¤å¤§æ ¸å¿ƒè®¾è®¡å“²å­¦                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ğŸ›‹ï¸ æ‡’äººè®¾è®¡                â”‚  â”‚         ğŸ¤ ä¼™ä¼´åŒ–è®¾è®¡              â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  "ä¸ºä¸æƒ³è®°è´¦çš„äººè®¾è®¡è®°è´¦APP"       â”‚  â”‚  "ä¸æ˜¯å†·å†°å†°çš„å·¥å…·ï¼Œè€Œæ˜¯æ¸©æš–ä¼™ä¼´"  â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â€¢ é«˜é¢‘æ“ä½œä¸€æ­¥å®Œæˆ               â”‚  â”‚  â€¢ æ¸©æš–ä¸æ‰“æ‰°ï¼Œå…³å¿ƒæœ‰è¾¹ç•Œ          â”‚  â”‚
â”‚  â”‚  â€¢ èƒ½è‡ªåŠ¨çš„ç»ä¸æ‰‹åŠ¨               â”‚  â”‚  â€¢ é¼“åŠ±è€Œéè¯´æ•™ï¼Œé™ªä¼´è€Œéæ§åˆ¶      â”‚  â”‚
â”‚  â”‚  â€¢ èƒ½æ¨æ–­çš„ç»ä¸è®©ç”¨æˆ·è¾“å…¥         â”‚  â”‚  â€¢ è®°è´¦æˆåŠŸæ—¶ç»™äºˆå°å°çš„è‚¯å®š        â”‚  â”‚
â”‚  â”‚  â€¢ æ–°ç”¨æˆ·é›¶é…ç½®å³å¯ä½¿ç”¨           â”‚  â”‚  â€¢ è¾¾æˆç›®æ ‡æ—¶çœŸè¯šåœ°åº†ç¥            â”‚  â”‚
â”‚  â”‚  â€¢ å•æ‰‹å¯å®Œæˆæ‰€æœ‰æ ¸å¿ƒæ“ä½œ         â”‚  â”‚  â€¢ é‡åˆ°å›°éš¾æ—¶æä¾›è´´å¿ƒçš„å»ºè®®        â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®æ ‡ç”¨æˆ·

| ç”¨æˆ·ç±»å‹ | ç—›ç‚¹ | æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ |
|---------|------|---------------|
| **èŒåœºæ–°äºº** | å·¥èµ„ä¸çŸ¥é“èŠ±åˆ°å“ªäº†ï¼Œæœˆæœˆå…‰ | é’±é¾„åˆ†æè®©æ¶ˆè´¹é€æ˜ï¼Œå°é‡‘åº“å¼ºåˆ¶å‚¨è“„ |
| **å®¶åº­ç†è´¢è€…** | å®¶åº­å¼€æ”¯éš¾ä»¥è§„åˆ’å’Œè¿½è¸ª | å…±äº«è´¦æœ¬ã€é¢„ç®—åˆ†ç±»ã€æ”¯å‡ºè¶‹åŠ¿åˆ†æ |
| **ç†è´¢å…¥é—¨è€…** | æƒ³è®°è´¦ä½†å«Œéº»çƒ¦ï¼ŒåšæŒä¸ä¸‹æ¥ | è¯­éŸ³/æ‹ç…§è®°è´¦ï¼Œ30ç§’å®Œæˆä¸€å¤©çš„è´¦ |
| **é¢„ç®—æ§åˆ¶è€…** | é¢„ç®—æ€»è¶…æ”¯ï¼Œæ§åˆ¶ä¸ä½æ¶ˆè´¹ | å®æ—¶é¢„ç®—æé†’ã€å†²åŠ¨æ¶ˆè´¹å†·é™æœŸ |
| **å‚¨è“„ç›®æ ‡è€…** | æƒ³å­˜é’±ä½†æ€»æ˜¯å­˜ä¸ä¸‹æ¥ | è‡ªåŠ¨å‚¨è“„è§„åˆ’ã€ç›®æ ‡è¿›åº¦å¯è§†åŒ– |

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šå®¶åº­ç†è´¢è€…æ ¸å¿ƒåŠŸèƒ½è¯¦è§[ç¬¬13ç«  å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ](#13-å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ)

### äº§å“ä»·å€¼ä¸»å¼ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚                        AIæ™ºèƒ½è®°è´¦ â€”â€” ä¸‰æ­¥å®ç°è´¢åŠ¡è‡ªç”±                            â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚       â”‚
â”‚  â”‚   ğŸ“ è®°å¾—æ¸…æ¥š       â”‚  â”‚   ğŸ“Š çœ‹å¾—æ˜ç™½       â”‚  â”‚   ğŸ’ª èŠ±å¾—å€¼å¾—       â”‚       â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚       â”‚
â”‚  â”‚  AIæ™ºèƒ½è¯†åˆ«        â”‚  â”‚  å¯è§†åŒ–æŠ¥è¡¨        â”‚  â”‚  æ¶ˆè´¹æ´å¯Ÿ          â”‚       â”‚
â”‚  â”‚  è¯­éŸ³/å›¾ç‰‡/æ‰‹åŠ¨    â”‚  â”‚  æ•°æ®ä¸‹é’»åˆ†æ      â”‚  â”‚  ä¹ æƒ¯åŸ¹å…»å»ºè®®      â”‚       â”‚
â”‚  â”‚  è‡ªåŠ¨åˆ†ç±»å½’æ¡£      â”‚  â”‚  é’±é¾„è¶‹åŠ¿è¿½è¸ª      â”‚  â”‚  é¢„ç®—æ™ºèƒ½æé†’      â”‚       â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚       â”‚
â”‚  â”‚  "1ç§’è®°ä¸€ç¬”"       â”‚  â”‚  "ä¸€çœ¼çœ‹å…¨è²Œ"      â”‚  â”‚  "è¶ŠèŠ±è¶Šæœ‰æ•°"      â”‚       â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚            â”‚                       â”‚                       â”‚                  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                    â”‚                                          â”‚
â”‚                                    â–¼                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚                               â”‚                          â”‚
â”‚                    â”‚   ğŸ¯ ä»"ä¸çŸ¥é“é’±å»å“ªäº†"       â”‚                          â”‚
â”‚                    â”‚      åˆ°"æ¯ä¸€åˆ†é’±éƒ½æœ‰æ„ä¹‰"     â”‚                          â”‚
â”‚                    â”‚                               â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯äº®ç‚¹

| èƒ½åŠ› | æŠ€æœ¯æ–¹æ¡ˆ | ç”¨æˆ·ä»·å€¼ |
|-----|---------|---------|
| **è¯­éŸ³è¯†åˆ«** | é€šä¹‰åƒé—®å¤šæ¨¡æ€å¤§æ¨¡å‹ | è‡ªç„¶è¯­è¨€è¾“å…¥ï¼Œæ”¯æŒæ–¹è¨€å’Œè¿ç»­å¤šç¬” |
| **å›¾ç‰‡è¯†åˆ«** | OCR + LLMè¯­ä¹‰ç†è§£ | æ‹ç…§å³è®°è´¦ï¼Œæ”¯æŒå„ç±»ç¥¨æ®å’Œæˆªå›¾ |
| **æ™ºèƒ½åˆ†ç±»** | æœ¬åœ°MLæ¨¡å‹ + äº‘ç«¯å¢å¼º | ç¦»çº¿å¯ç”¨ï¼Œåœ¨çº¿æ›´å‡†ç¡® |
| **é’±é¾„è®¡ç®—** | FIFOèµ„æºæ± ç®—æ³• | æ¯«ç§’çº§è®¡ç®—ï¼Œæ”¯æŒå¤§é‡äº¤æ˜“ |
| **ç¦»çº¿ä¼˜å…ˆ** | æœ¬åœ°SQLite + äº‘ç«¯åŒæ­¥ | æ— ç½‘ç»œä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ |
| **éšç§å®‰å…¨** | ç«¯ä¾§åŠ å¯† + æœ€å°æƒé™ | æ•°æ®å®‰å…¨ï¼Œéšç§å¯æ§ |

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

AIæ™ºèƒ½è®°è´¦ 1.x ç‰ˆæœ¬å·²ç»å®ç°äº†åŸºç¡€çš„è®°è´¦åŠŸèƒ½ã€AIè¯†åˆ«ã€å¤šè´¦æˆ·ç®¡ç†ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚2.0 ç‰ˆæœ¬å°†åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œå…¨é¢å‡çº§ï¼Œå¼•å…¥ä»¥ä¸‹æ ¸å¿ƒåˆ›æ–°ï¼š

- **é’±é¾„åˆ†æç³»ç»Ÿ**ï¼šè®©ç”¨æˆ·äº†è§£èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…ä¹‹å‰èµšçš„
- **é›¶åŸºé¢„ç®—ç³»ç»Ÿ**ï¼šè®©æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„
- **å°é‡‘åº“ç³»ç»Ÿ**ï¼šæ›´ç¬¦åˆä¸­å›½ç”¨æˆ·ä¹ æƒ¯çš„èµ„é‡‘è§„åˆ’æ–¹å¼
- **æ™ºèƒ½æ•°æ®è”åŠ¨**ï¼šå…¨åº”ç”¨èŒƒå›´çš„æ•°æ®ä¸‹é’»ä¸äº¤äº’
- **å¢å¼ºå‹AIèƒ½åŠ›**ï¼šæ›´æ™ºèƒ½çš„è¯­éŸ³ã€å›¾åƒã€è¯­ä¹‰è¯†åˆ«

### 1.2 è®¾è®¡åŸåˆ™

| åŸåˆ™ | æè¿° |
|------|------|
| **æ•°æ®é©±åŠ¨** | ç”¨æ•°æ®å¸®åŠ©ç”¨æˆ·åšå‡ºæ›´å¥½çš„è´¢åŠ¡å†³ç­– |
| **æ™ºèƒ½ä¼˜å…ˆ** | å°½å¯èƒ½çš„ä½¿ç”¨æ™ºèƒ½åŒ–ã€è‡ªåŠ¨åŒ–çš„æ–¹å¼å®ç° |
| **ä¹ æƒ¯åŸ¹å…»** | é€šè¿‡å¥½çš„äº§å“è®¾è®¡åŸ¹å…»ç”¨æˆ·è‰¯å¥½çš„é‡‘èä¹ æƒ¯ |
| **æ‡’äººè®¾è®¡** | ä¸º"æ‡’äºº"è€Œç”Ÿï¼Œæœ€å°‘æ“ä½œã€æœ€å¤§ä»·å€¼ï¼ˆè¯¦è§ç¬¬4ç« ï¼‰ |
| **ä¼™ä¼´åŸåˆ™** | APPæ˜¯ç†è´¢ä¼™ä¼´è€Œéå†·å†°å†°çš„å·¥å…·ï¼Œäº¤äº’ä¸­ä½“ç°äººæ€§æ¸©åº¦ï¼ˆè¯¦è§ç¬¬4ç« ï¼‰ |

### 1.3 ç‰ˆæœ¬ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2.0 ç‰ˆæœ¬æ ¸å¿ƒç›®æ ‡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. é’±é¾„åˆ†æ - è®©ç”¨æˆ·ç†è§£"èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™èµšçš„é’±"              â”‚
â”‚  2. é›¶åŸºé¢„ç®— - è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”                        â”‚
â”‚  3. æ™ºèƒ½æ´å¯Ÿ - AIé©±åŠ¨çš„è´¢åŠ¡å¥åº·åˆ†æ                          â”‚
â”‚  4. æ•°æ®è”åŠ¨ - ä»»æ„å›¾è¡¨å¯ç‚¹å‡»ä¸‹é’»æŸ¥çœ‹è¯¦æƒ…                    â”‚
â”‚  5. ä½“éªŒå‡çº§ - æ›´æµç•…çš„äº¤äº’ã€æ›´ç¾è§‚çš„ç•Œé¢                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶

æ¯ä¸ªæ ¸å¿ƒç›®æ ‡éœ€è¦æ˜ç¡®çš„é‡åŒ–æ ‡å‡†å’Œæ£€æµ‹æ–¹æ³•ï¼Œç¡®ä¿ç›®æ ‡å¯è¡¡é‡ã€å¯è¿½è¸ªã€‚

#### 1.4.1 ç›®æ ‡è¾¾æˆè¯„ä¼°æ¡†æ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒç›®æ ‡è¾¾æˆè¯„ä¼°ä½“ç³»                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  åŠŸèƒ½å®Œæ•´åº¦  â”‚    â”‚  ç”¨æˆ·é‡‡ç”¨ç‡  â”‚    â”‚  ä½¿ç”¨æ•ˆæœ   â”‚    â”‚  ç”¨æˆ·æ»¡æ„åº¦  â”‚ â”‚
â”‚  â”‚  Feature    â”‚â”€â”€â”€â†’â”‚  Adoption   â”‚â”€â”€â”€â†’â”‚  Outcome    â”‚â”€â”€â”€â†’â”‚ Satisfactionâ”‚ â”‚
â”‚  â”‚  Completion â”‚    â”‚    Rate     â”‚    â”‚   Impact    â”‚    â”‚    Score    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†“                  â†“                  â†“                  â†“          â”‚
â”‚   åŠŸèƒ½æ˜¯å¦å®Œæ•´       ç”¨æˆ·æ˜¯å¦ä½¿ç”¨       ä½¿ç”¨åæ•ˆæœå¦‚ä½•      ç”¨æˆ·è¯„ä»·å¦‚ä½•    â”‚
â”‚   å®ç°å¹¶ä¸Šçº¿         å¹¶æŒç»­ä½¿ç”¨         æ˜¯å¦è¾¾åˆ°é¢„æœŸ        æ˜¯å¦æ»¡æ„æ¨è    â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.2 å„æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†

```dart
/// æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†å®šä¹‰
class CoreGoalAchievementCriteria {

  /// ç›®æ ‡1ï¼šé’±é¾„åˆ†æ
  static const moneyAgeGoal = GoalCriteria(
    name: 'é’±é¾„åˆ†æ',
    description: 'è®©ç”¨æˆ·ç†è§£"èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™èµšçš„é’±"',

    // åŠŸèƒ½å®Œæ•´åº¦æ ‡å‡† (å¿…é¡»100%è¾¾æˆæ‰ç®—åŠŸèƒ½å®Œæˆ)
    featureCompleteness: [
      'é’±é¾„è®¡ç®—ç®—æ³•å®ç°å¹¶å‡†ç¡®',
      'é’±é¾„å¯è§†åŒ–å±•ç¤ºï¼ˆä»ªè¡¨ç›˜å¡ç‰‡ï¼‰',
      'é’±é¾„å†å²è¶‹åŠ¿å›¾è¡¨',
      'é’±é¾„ç­‰çº§åˆ’åˆ†å’Œè¯´æ˜',
      'é’±é¾„æ”¹å–„å»ºè®®ç”Ÿæˆ',
    ],

    // ç”¨æˆ·é‡‡ç”¨ç‡æ ‡å‡†
    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.80,      // 80%ç”¨æˆ·çŸ¥é“æ­¤åŠŸèƒ½å­˜åœ¨
      trialRate: 0.60,          // 60%ç”¨æˆ·è‡³å°‘æŸ¥çœ‹è¿‡ä¸€æ¬¡
      regularUseRate: 0.30,     // 30%ç”¨æˆ·æ¯å‘¨æŸ¥çœ‹
      targetTimeframe: Duration(days: 90),  // ä¸Šçº¿90å¤©å†…è¾¾æˆ
    ),

    // ä½¿ç”¨æ•ˆæœæ ‡å‡†
    outcomeMetrics: [
      OutcomeMetric(
        name: 'ç†è§£åº¦',
        measurement: 'ç”¨æˆ·èƒ½æ­£ç¡®è§£é‡Šé’±é¾„å«ä¹‰çš„æ¯”ä¾‹',
        target: 0.70,  // 70%ç”¨æˆ·ç†è§£
        method: 'åº”ç”¨å†…é—®å·è°ƒæŸ¥',
      ),
      OutcomeMetric(
        name: 'è¡Œä¸ºæ”¹å˜',
        measurement: 'æŸ¥çœ‹é’±é¾„åè°ƒæ•´æ¶ˆè´¹è¡Œä¸ºçš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.25,  // 25%ç”¨æˆ·æœ‰è¡Œä¸ºæ”¹å˜
        method: 'æ¶ˆè´¹æ¨¡å¼å‰åå¯¹æ¯”åˆ†æ',
      ),
      OutcomeMetric(
        name: 'é’±é¾„æå‡',
        measurement: 'ä½¿ç”¨3ä¸ªæœˆåé’±é¾„æå‡çš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.40,  // 40%ç”¨æˆ·é’±é¾„æå‡
        method: 'é’±é¾„å†å²æ•°æ®å¯¹æ¯”',
      ),
    ],

    // ç”¨æˆ·æ»¡æ„åº¦æ ‡å‡†
    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.0,     // åŠŸèƒ½æ»¡æ„åº¦â‰¥4.0/5.0
      featureNps: 30,     // åŠŸèƒ½NPSâ‰¥30
    ),
  );

  /// ç›®æ ‡2ï¼šé›¶åŸºé¢„ç®—
  static const zeroBudgetGoal = GoalCriteria(
    name: 'é›¶åŸºé¢„ç®—',
    description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”',

    featureCompleteness: [
      'é›¶åŸºé¢„ç®—åˆ›å»ºå’Œç¼–è¾‘åŠŸèƒ½',
      'æ”¶å…¥åˆ†é…å‘å¯¼',
      'é¢„ç®—åˆ†ç±»å’Œé‡‘é¢è®¾ç½®',
      'é¢„ç®—æ‰§è¡Œè¿›åº¦è¿½è¸ª',
      'é¢„ç®—ç»“è½¬åŠŸèƒ½',
      'é¢„ç®—é¢„è­¦é€šçŸ¥',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.75,      // 75%ç”¨æˆ·çŸ¥é“é›¶åŸºé¢„ç®—
      trialRate: 0.40,          // 40%ç”¨æˆ·åˆ›å»ºè¿‡é¢„ç®—
      regularUseRate: 0.20,     // 20%ç”¨æˆ·æŒç»­ä½¿ç”¨é¢„ç®—åŠŸèƒ½
      targetTimeframe: Duration(days: 90),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'é¢„ç®—è¦†ç›–ç‡',
        measurement: 'ç”¨æˆ·æ”¶å…¥è¢«é¢„ç®—è¦†ç›–çš„å¹³å‡æ¯”ä¾‹',
        target: 0.80,  // å¹³å‡80%æ”¶å…¥æœ‰é¢„ç®—å®‰æ’
        method: 'é¢„ç®—æ€»é¢/æœˆæ”¶å…¥',
      ),
      OutcomeMetric(
        name: 'é¢„ç®—è¾¾æˆç‡',
        measurement: 'ç”¨æˆ·æ¯æœˆé¢„ç®—è¾¾æˆçš„æ¯”ä¾‹',
        target: 0.70,  // 70%é¢„ç®—ç±»åˆ«è¾¾æˆ
        method: 'å®é™…æ”¯å‡ºâ‰¤é¢„ç®—é¢çš„ç±»åˆ«å æ¯”',
      ),
      OutcomeMetric(
        name: 'è´¢åŠ¡æ”¹å–„',
        measurement: 'ä½¿ç”¨é¢„ç®—åå‚¨è“„ç‡æå‡çš„ç”¨æˆ·æ¯”ä¾‹',
        target: 0.35,  // 35%ç”¨æˆ·å‚¨è“„ç‡æå‡
        method: 'å‚¨è“„é‡‘é¢/æ”¶å…¥ å¯¹æ¯”',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.2,
      featureNps: 35,
    ),
  );

  /// ç›®æ ‡3ï¼šæ™ºèƒ½æ´å¯Ÿ
  static const aiInsightGoal = GoalCriteria(
    name: 'æ™ºèƒ½æ´å¯Ÿ',
    description: 'AIé©±åŠ¨çš„è´¢åŠ¡å¥åº·åˆ†æ',

    featureCompleteness: [
      'AIæ¶ˆè´¹æ¨¡å¼è¯†åˆ«',
      'å¼‚å¸¸æ¶ˆè´¹æ£€æµ‹å’Œæé†’',
      'æ™ºèƒ½è´¢åŠ¡å»ºè®®ç”Ÿæˆ',
      'æ”¯å‡ºé¢„æµ‹åŠŸèƒ½',
      'æ”¶æ”¯è¶‹åŠ¿æ™ºèƒ½åˆ†æ',
      'ä¸ªæ€§åŒ–è´¢åŠ¡æŠ¥å‘Š',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.70,
      trialRate: 0.50,          // 50%ç”¨æˆ·æŸ¥çœ‹è¿‡AIæ´å¯Ÿ
      regularUseRate: 0.25,     // 25%ç”¨æˆ·å®šæœŸæŸ¥çœ‹
      targetTimeframe: Duration(days: 90),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ´å¯Ÿå‡†ç¡®åº¦',
        measurement: 'ç”¨æˆ·è®¤ä¸ºæ´å¯Ÿå‡†ç¡®/æœ‰ç”¨çš„æ¯”ä¾‹',
        target: 0.75,  // 75%è®¤ä¸ºå‡†ç¡®
        method: 'æ´å¯Ÿå¡ç‰‡åé¦ˆç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'å»ºè®®é‡‡çº³ç‡',
        measurement: 'ç”¨æˆ·é‡‡çº³AIå»ºè®®çš„æ¯”ä¾‹',
        target: 0.30,  // 30%å»ºè®®è¢«é‡‡çº³
        method: 'å»ºè®®ç‚¹å‡»"å·²é‡‡çº³"çš„æ¯”ä¾‹',
      ),
      OutcomeMetric(
        name: 'é¢„æµ‹å‡†ç¡®åº¦',
        measurement: 'AIé¢„æµ‹ä¸å®é™…çš„åå·®',
        target: 0.15,  // é¢„æµ‹åå·®â‰¤15%
        method: '|é¢„æµ‹å€¼-å®é™…å€¼|/å®é™…å€¼',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.0,
      featureNps: 25,
    ),
  );

  /// ç›®æ ‡4ï¼šæ•°æ®è”åŠ¨
  static const dataLinkageGoal = GoalCriteria(
    name: 'æ•°æ®è”åŠ¨',
    description: 'ä»»æ„å›¾è¡¨å¯ç‚¹å‡»ä¸‹é’»æŸ¥çœ‹è¯¦æƒ…',

    featureCompleteness: [
      'å›¾è¡¨ç‚¹å‡»å“åº”å’Œä¸‹é’»å¯¼èˆª',
      'ç»Ÿè®¡é¡µé¢å…³è”äº¤æ˜“åˆ—è¡¨',
      'åˆ†ç±»ç‚¹å‡»å±•å¼€äº¤æ˜“æ˜ç»†',
      'æ—¶é—´æ®µé€‰æ‹©è”åŠ¨åˆ·æ–°',
      'è·¨é¡µé¢æ•°æ®ç­›é€‰ä¿æŒ',
      'å¿«é€Ÿè¿”å›å’Œé¢åŒ…å±‘å¯¼èˆª',
    ],

    adoptionCriteria: AdoptionMetrics(
      awarenessRate: 0.60,      // 60%ç”¨æˆ·çŸ¥é“å¯ç‚¹å‡»ä¸‹é’»
      trialRate: 0.70,          // 70%ç”¨æˆ·ä½¿ç”¨è¿‡ä¸‹é’»
      regularUseRate: 0.40,     // 40%ç”¨æˆ·ç»å¸¸ä½¿ç”¨
      targetTimeframe: Duration(days: 60),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ•°æ®æ¢ç´¢æ·±åº¦',
        measurement: 'å¹³å‡ä¸‹é’»å±‚çº§æ•°',
        target: 2.0,  // å¹³å‡ä¸‹é’»2å±‚
        method: 'ä¸‹é’»ç‚¹å‡»äº‹ä»¶ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'é—®é¢˜è§£å†³ç‡',
        measurement: 'é€šè¿‡ä¸‹é’»æ‰¾åˆ°ç›®æ ‡ä¿¡æ¯çš„æ¯”ä¾‹',
        target: 0.85,  // 85%èƒ½æ‰¾åˆ°ç›®æ ‡
        method: 'ä¸‹é’»åæ— è¿”å›è·³å‡ºçš„æ¯”ä¾‹',
      ),
      OutcomeMetric(
        name: 'æ•ˆç‡æå‡',
        measurement: 'æŸ¥æ‰¾ç‰¹å®šäº¤æ˜“çš„å¹³å‡æ—¶é—´å‡å°‘',
        target: 0.50,  // æ—¶é—´å‡å°‘50%
        method: 'ä¸1.0ç‰ˆæœ¬å¯¹æ¯”',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.3,
      featureNps: 40,
    ),
  );

  /// ç›®æ ‡5ï¼šä½“éªŒå‡çº§
  static const experienceUpgradeGoal = GoalCriteria(
    name: 'ä½“éªŒå‡çº§',
    description: 'æ›´æµç•…çš„äº¤äº’ã€æ›´ç¾è§‚çš„ç•Œé¢',

    featureCompleteness: [
      'å…¨æ–°UIè®¾è®¡ç³»ç»Ÿå®æ–½',
      'æµç•…åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ',
      'æ·±è‰²æ¨¡å¼æ”¯æŒ',
      'å“åº”å¼å¸ƒå±€é€‚é…',
      'æ‰‹åŠ¿æ“ä½œä¼˜åŒ–',
      'åŠ è½½çŠ¶æ€å’Œéª¨æ¶å±',
    ],

    adoptionCriteria: AdoptionMetrics(
      // ä½“éªŒå‡çº§æ˜¯å…¨å±€çš„ï¼Œé‡‡ç”¨ç‡é€šè¿‡å¯¹æ¯”æŒ‡æ ‡è¡¡é‡
      awarenessRate: 0.90,      // 90%ç”¨æˆ·æ„ŸçŸ¥åˆ°å˜åŒ–
      trialRate: 1.0,           // 100%è‡ªåŠ¨åº”ç”¨
      regularUseRate: 1.0,
      targetTimeframe: Duration(days: 30),
    ),

    outcomeMetrics: [
      OutcomeMetric(
        name: 'æ€§èƒ½æå‡',
        measurement: 'é¡µé¢åŠ è½½æ—¶é—´',
        target: 0.5,  // åŠ è½½æ—¶é—´â‰¤500ms
        method: 'æ€§èƒ½ç›‘æ§æ•°æ®',
      ),
      OutcomeMetric(
        name: 'æµç•…åº¦',
        measurement: 'å¹³å‡å¸§ç‡',
        target: 55,  // å¸§ç‡â‰¥55fps
        method: 'å¸§ç‡ç›‘æ§ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'å´©æºƒç‡',
        measurement: 'åº”ç”¨å´©æºƒç‡',
        target: 0.001,  // å´©æºƒç‡â‰¤0.1%
        method: 'å´©æºƒæ—¥å¿—ç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'ç¾è§‚è¯„åˆ†',
        measurement: 'ç”¨æˆ·å¯¹ç•Œé¢ç¾è§‚åº¦çš„è¯„åˆ†',
        target: 4.2,  // è¯„åˆ†â‰¥4.2/5.0
        method: 'ç”¨æˆ·é—®å·è°ƒæŸ¥',
      ),
    ],

    satisfactionTarget: SatisfactionMetric(
      csatScore: 4.5,
      featureNps: 45,
    ),
  );
}
```

#### 1.4.3 ç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡

```dart
/// æ ¸å¿ƒç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡
class GoalAchievementDetectionService {
  final AnalyticsService _analytics;
  final UserFeedbackService _feedback;
  final PerformanceMonitor _performance;

  /// æ£€æµ‹å•ä¸ªç›®æ ‡çš„è¾¾æˆçŠ¶æ€
  Future<GoalAchievementStatus> checkGoalStatus(GoalCriteria goal) async {
    final featureStatus = await _checkFeatureCompleteness(goal);
    final adoptionStatus = await _checkAdoptionMetrics(goal);
    final outcomeStatus = await _checkOutcomeMetrics(goal);
    final satisfactionStatus = await _checkSatisfactionMetrics(goal);

    return GoalAchievementStatus(
      goalName: goal.name,
      overallScore: _calculateOverallScore(
        featureStatus, adoptionStatus, outcomeStatus, satisfactionStatus
      ),
      featureCompleteness: featureStatus,
      adoptionMetrics: adoptionStatus,
      outcomeMetrics: outcomeStatus,
      satisfactionMetrics: satisfactionStatus,
      achievementLevel: _determineAchievementLevel(
        featureStatus, adoptionStatus, outcomeStatus, satisfactionStatus
      ),
    );
  }

  /// æ£€æµ‹åŠŸèƒ½å®Œæ•´åº¦
  Future<FeatureCompletenessStatus> _checkFeatureCompleteness(
    GoalCriteria goal
  ) async {
    final completedFeatures = <String>[];
    final pendingFeatures = <String>[];

    for (final feature in goal.featureCompleteness) {
      final isComplete = await _checkFeatureImplemented(feature);
      if (isComplete) {
        completedFeatures.add(feature);
      } else {
        pendingFeatures.add(feature);
      }
    }

    return FeatureCompletenessStatus(
      totalFeatures: goal.featureCompleteness.length,
      completedCount: completedFeatures.length,
      completionRate: completedFeatures.length / goal.featureCompleteness.length,
      completedFeatures: completedFeatures,
      pendingFeatures: pendingFeatures,
      isFullyComplete: pendingFeatures.isEmpty,
    );
  }

  /// æ£€æµ‹ç”¨æˆ·é‡‡ç”¨ç‡
  Future<AdoptionStatus> _checkAdoptionMetrics(GoalCriteria goal) async {
    final criteria = goal.adoptionCriteria;

    // ä»åˆ†ææœåŠ¡è·å–å®é™…æ•°æ®
    final actualAwareness = await _analytics.getFeatureAwarenessRate(goal.name);
    final actualTrial = await _analytics.getFeatureTrialRate(goal.name);
    final actualRegularUse = await _analytics.getFeatureRegularUseRate(goal.name);

    return AdoptionStatus(
      awarenessRate: MetricStatus(
        target: criteria.awarenessRate,
        actual: actualAwareness,
        achieved: actualAwareness >= criteria.awarenessRate,
      ),
      trialRate: MetricStatus(
        target: criteria.trialRate,
        actual: actualTrial,
        achieved: actualTrial >= criteria.trialRate,
      ),
      regularUseRate: MetricStatus(
        target: criteria.regularUseRate,
        actual: actualRegularUse,
        achieved: actualRegularUse >= criteria.regularUseRate,
      ),
    );
  }

  /// æ£€æµ‹ä½¿ç”¨æ•ˆæœ
  Future<OutcomeStatus> _checkOutcomeMetrics(GoalCriteria goal) async {
    final results = <OutcomeMetricResult>[];

    for (final metric in goal.outcomeMetrics) {
      final actualValue = await _getOutcomeMetricValue(metric);
      results.add(OutcomeMetricResult(
        metric: metric,
        actualValue: actualValue,
        achieved: _isOutcomeMetricAchieved(metric, actualValue),
      ));
    }

    return OutcomeStatus(
      metrics: results,
      overallAchieved: results.where((r) => r.achieved).length >=
                       (results.length * 0.7).ceil(),  // 70%æŒ‡æ ‡è¾¾æˆ
    );
  }

  /// æ£€æµ‹ç”¨æˆ·æ»¡æ„åº¦
  Future<SatisfactionStatus> _checkSatisfactionMetrics(GoalCriteria goal) async {
    final target = goal.satisfactionTarget;

    final actualCsat = await _feedback.getFeatureCsatScore(goal.name);
    final actualNps = await _feedback.getFeatureNpsScore(goal.name);

    return SatisfactionStatus(
      csatScore: MetricStatus(
        target: target.csatScore,
        actual: actualCsat,
        achieved: actualCsat >= target.csatScore,
      ),
      npsScore: MetricStatus(
        target: target.featureNps.toDouble(),
        actual: actualNps.toDouble(),
        achieved: actualNps >= target.featureNps,
      ),
    );
  }

  /// è®¡ç®—ç»¼åˆå¾—åˆ† (0-100)
  double _calculateOverallScore(
    FeatureCompletenessStatus feature,
    AdoptionStatus adoption,
    OutcomeStatus outcome,
    SatisfactionStatus satisfaction,
  ) {
    // æƒé‡åˆ†é…: åŠŸèƒ½30% + é‡‡ç”¨25% + æ•ˆæœ25% + æ»¡æ„åº¦20%
    final featureScore = feature.completionRate * 100 * 0.30;
    final adoptionScore = adoption.overallRate * 100 * 0.25;
    final outcomeScore = outcome.achievementRate * 100 * 0.25;
    final satisfactionScore = satisfaction.overallRate * 100 * 0.20;

    return featureScore + adoptionScore + outcomeScore + satisfactionScore;
  }

  /// åˆ¤å®šè¾¾æˆç­‰çº§
  AchievementLevel _determineAchievementLevel(
    FeatureCompletenessStatus feature,
    AdoptionStatus adoption,
    OutcomeStatus outcome,
    SatisfactionStatus satisfaction,
  ) {
    final score = _calculateOverallScore(feature, adoption, outcome, satisfaction);

    if (!feature.isFullyComplete) {
      return AchievementLevel.notStarted;  // åŠŸèƒ½æœªå®Œæˆ
    }

    if (score >= 90) return AchievementLevel.exceeded;      // è¶…è¶Šç›®æ ‡
    if (score >= 75) return AchievementLevel.achieved;      // è¾¾æˆç›®æ ‡
    if (score >= 50) return AchievementLevel.partial;       // éƒ¨åˆ†è¾¾æˆ
    return AchievementLevel.notAchieved;                    // æœªè¾¾æˆ
  }
}
```

#### 1.4.4 ç›®æ ‡è¾¾æˆä»ªè¡¨ç›˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ ¸å¿ƒç›®æ ‡è¾¾æˆçŠ¶æ€ä»ªè¡¨ç›˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                â”‚
â”‚  ç›®æ ‡åç§°          åŠŸèƒ½å®Œæˆ    é‡‡ç”¨ç‡      æ•ˆæœè¾¾æˆ    æ»¡æ„åº¦    ç»¼åˆè¯„çº§        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1. é’±é¾„åˆ†æ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â­â­â­â­      â”‚
â”‚                    100%        75%         62%         80%         è¾¾æˆ         â”‚
â”‚                                                                                â”‚
â”‚  2. é›¶åŸºé¢„ç®—       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â­â­â­        â”‚
â”‚                    100%        50%         50%         75%         éƒ¨åˆ†è¾¾æˆ     â”‚
â”‚                                                                                â”‚
â”‚  3. æ™ºèƒ½æ´å¯Ÿ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘    â­â­â­        â”‚
â”‚                    75%         62%         50%         62%         éƒ¨åˆ†è¾¾æˆ     â”‚
â”‚                                                                                â”‚
â”‚  4. æ•°æ®è”åŠ¨       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â­â­â­â­      â”‚
â”‚                    100%        87%         75%         80%         è¾¾æˆ         â”‚
â”‚                                                                                â”‚
â”‚  5. ä½“éªŒå‡çº§       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â­â­â­â­â­    â”‚
â”‚                    100%        100%        87%         90%         è¶…è¶Šç›®æ ‡     â”‚
â”‚                                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯„çº§è¯´æ˜:  â­â­â­â­â­ è¶…è¶Šç›®æ ‡(â‰¥90)  â­â­â­â­ è¾¾æˆ(â‰¥75)                          â”‚
â”‚            â­â­â­ éƒ¨åˆ†è¾¾æˆ(â‰¥50)       â­â­ æœªè¾¾æˆ(<50)  â­ æœªå¼€å§‹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.5 æ£€æµ‹è§¦å‘æ—¶æœºä¸å‘¨æœŸ

```dart
/// ç›®æ ‡è¾¾æˆæ£€æµ‹è°ƒåº¦å™¨
class GoalAchievementScheduler {
  /// æ£€æµ‹è§¦å‘è§„åˆ™
  static const checkSchedule = {
    // åŠŸèƒ½å®Œæ•´åº¦ - æ¯æ¬¡ç‰ˆæœ¬å‘å¸ƒæ—¶æ£€æµ‹
    CheckType.featureCompleteness: CheckTrigger(
      event: 'version_release',
      description: 'ç‰ˆæœ¬å‘å¸ƒæ—¶è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½å®Œæ•´åº¦',
    ),

    // é‡‡ç”¨ç‡ - æ¯å‘¨å®šæœŸæ£€æµ‹
    CheckType.adoption: CheckTrigger(
      interval: Duration(days: 7),
      description: 'æ¯å‘¨ä¸€ç»Ÿè®¡ä¸Šå‘¨é‡‡ç”¨ç‡æ•°æ®',
    ),

    // ä½¿ç”¨æ•ˆæœ - æ¯æœˆæ£€æµ‹
    CheckType.outcome: CheckTrigger(
      interval: Duration(days: 30),
      description: 'æ¯æœˆåˆåˆ†æä¸Šæœˆæ•ˆæœæ•°æ®',
    ),

    // æ»¡æ„åº¦ - æŒç»­æ”¶é›†ï¼Œæ¯æœˆæ±‡æ€»
    CheckType.satisfaction: CheckTrigger(
      interval: Duration(days: 30),
      description: 'æ¯æœˆæ±‡æ€»ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†',
    ),

    // ç»¼åˆè¯„ä¼° - æ¯å­£åº¦
    CheckType.comprehensive: CheckTrigger(
      interval: Duration(days: 90),
      description: 'æ¯å­£åº¦è¿›è¡Œå…¨é¢ç›®æ ‡è¯„ä¼°',
    ),
  };

  /// æ£€æµ‹ç»“æœé€šçŸ¥é…ç½®
  static const alertThresholds = {
    // æŒ‡æ ‡ä¸‹é™è¶…è¿‡10%æ—¶å‘Šè­¦
    'metricDecline': 0.10,
    // è¿ç»­2å‘¨æœªè¾¾æ ‡æ—¶å‘Šè­¦
    'consecutiveFailure': 2,
    // æ»¡æ„åº¦ä½äº3.5åˆ†æ—¶å‘Šè­¦
    'lowSatisfaction': 3.5,
  };
}
```

---


---

## 2. äº§å“å®šä½ä¸æ„¿æ™¯

### 2.1 äº§å“å®šä½

**"æ‚¨çš„æ™ºèƒ½è´¢åŠ¡ç®¡å®¶"**

AIæ™ºèƒ½è®°è´¦ 2.0 å®šä½ä¸ºä¸€æ¬¾é¢å‘ä¸ªäººå’Œå®¶åº­çš„æ™ºèƒ½è´¢åŠ¡ç®¡ç†åº”ç”¨ï¼Œé€šè¿‡AIæŠ€æœ¯é™ä½è®°è´¦é—¨æ§›ï¼Œé€šè¿‡æ•°æ®åˆ†æå¸®åŠ©ç”¨æˆ·å»ºç«‹å¥åº·çš„è´¢åŠ¡ä¹ æƒ¯ã€‚

### 2.2 ç›®æ ‡ç”¨æˆ·

| ç”¨æˆ·ç¾¤ä½“ | ç‰¹å¾ | æ ¸å¿ƒéœ€æ±‚ |
|----------|------|----------|
| **è®°è´¦æ–°æ‰‹** | æƒ³è¦å¼€å§‹è®°è´¦ä½†ä¸çŸ¥ä»ä½•ä¸‹æ‰‹ | ç®€å•æ˜“ç”¨ã€è‡ªåŠ¨åŒ– |
| **ç†è´¢çˆ±å¥½è€…** | æœ‰è®°è´¦ä¹ æƒ¯ï¼Œè¿½æ±‚ç²¾ç»†åŒ–ç®¡ç† | æ·±åº¦åˆ†æã€é¢„ç®—è§„åˆ’ |
| **å®¶åº­ç”¨æˆ·** | éœ€è¦ç®¡ç†å®¶åº­æ”¶æ”¯ | å¤šè´¦æˆ·ã€å®¶åº­å…±äº« |
| **è‡ªç”±èŒä¸šè€…** | æ”¶å…¥ä¸å›ºå®šï¼Œéœ€è¦ç°é‡‘æµç®¡ç† | æ”¶å…¥è¿½è¸ªã€ç¨åŠ¡è¾…åŠ© |

> ğŸ“ **ç›¸å…³æ–‡æ¡£**ï¼šè¯¦ç»†ç”¨æˆ·ç”»åƒï¼ˆå«5ç±»ç”¨æˆ·ç¾¤ä½“ã€è§„æ¨¡å æ¯”ã€ARPUã€è·å®¢æ¸ é“ï¼‰åŠå¸‚åœºåˆ†æè§[AIæ™ºèƒ½è®°è´¦2.0æˆ˜ç•¥åˆ†ææŠ¥å‘Šï¼ˆäº”çœ‹ä¸‰å®šï¼‰](../AIæ™ºèƒ½è®°è´¦2.0æˆ˜ç•¥åˆ†ææŠ¥å‘Šï¼ˆäº”çœ‹ä¸‰å®šï¼‰.md#32-å®¢æˆ·ç»†åˆ†åˆ†æ)

### 2.3 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚   ğŸ“± ä¸€é”®è®°è´¦          ğŸ¤– AIè‡ªåŠ¨è¯†åˆ«         ğŸ“Š æ™ºèƒ½åˆ†æ       â”‚
â”‚   è¯­éŸ³/æ‹ç…§/æ‰‹åŠ¨       å°ç¥¨ã€è´¦å•è‡ªåŠ¨è§£æ     é’±é¾„ã€é¢„ç®—ã€è¶‹åŠ¿  â”‚
â”‚                                                                â”‚
â”‚   ğŸ’° é›¶åŸºé¢„ç®—          ğŸ¯ è´¢åŠ¡ç›®æ ‡           ğŸ”„ æ•°æ®åŒæ­¥       â”‚
â”‚   æ¯åˆ†é’±éƒ½æœ‰å»å¤„       å‚¨è“„ã€è¿˜å€ºã€æŠ•èµ„       å¤šè®¾å¤‡æ— ç¼åˆ‡æ¢    â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 ç«å“å·®å¼‚åŒ–

| åŠŸèƒ½ç»´åº¦ | ä¼ ç»Ÿè®°è´¦APP | AIæ™ºèƒ½è®°è´¦ 2.0 |
|----------|------------|----------------|
| è®°è´¦æ–¹å¼ | æ‰‹åŠ¨è¾“å…¥ | AIè¯­éŸ³/å›¾åƒè¯†åˆ« + æ‰‹åŠ¨ |
| æ•°æ®åˆ†æ | ç®€å•å›¾è¡¨ | é’±é¾„åˆ†æ + æ™ºèƒ½æ´å¯Ÿ |
| é¢„ç®—ç®¡ç† | å›ºå®šé¢„ç®— | é›¶åŸºé¢„ç®— + å°é‡‘åº“ |
| æ•°æ®å¯¼å…¥ | æ‰‹åŠ¨å½•å…¥ | æ™ºèƒ½è§£æ + è‡ªåŠ¨å»é‡ |
| äº¤äº’ä½“éªŒ | é™æ€é¡µé¢ | æ•°æ®è”åŠ¨ + ä¸‹é’»æ¢ç´¢ |

### 2.5 ç”¨æˆ·ä¼˜å…ˆè½åœ°æœºåˆ¶

ã€Œç”¨æˆ·ä¼˜å…ˆã€åŸåˆ™éœ€è¦å…·ä½“çš„è½åœ°æœºåˆ¶æ¥ç¡®ä¿æ‰€æœ‰è®¾è®¡å†³ç­–ä»¥ç”¨æˆ·ä»·å€¼ä¸ºæ ¸å¿ƒã€‚

#### 2.5.1 ç”¨æˆ·åé¦ˆæ”¶é›†ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·åé¦ˆæ”¶é›†æ¸ é“                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸»åŠ¨æ”¶é›†æ¸ é“    â”‚   â”‚  è¢«åŠ¨æ”¶é›†æ¸ é“    â”‚   â”‚  æ•°æ®åˆ†ææ¸ é“    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ åº”ç”¨å†…åé¦ˆå…¥å£ â”‚   â”‚ â€¢ å´©æºƒæ—¥å¿—æ”¶é›†   â”‚   â”‚ â€¢ åŠŸèƒ½ä½¿ç”¨çƒ­åŠ›å›¾ â”‚   â”‚
â”‚  â”‚ â€¢ æ»¡æ„åº¦è¯„åˆ†å¡ç‰‡ â”‚   â”‚ â€¢ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹   â”‚   â”‚ â€¢ ç”¨æˆ·è·¯å¾„åˆ†æ   â”‚   â”‚
â”‚  â”‚ â€¢ åŠŸèƒ½å»ºè®®æŠ•ç¥¨   â”‚   â”‚ â€¢ åº”ç”¨å•†åº—è¯„è®º   â”‚   â”‚ â€¢ æµå¤±æ¼æ–—åˆ†æ   â”‚   â”‚
â”‚  â”‚ â€¢ å®šæœŸç”¨æˆ·è®¿è°ˆ   â”‚   â”‚ â€¢ ç¤¾åŒº/ç¾¤ç»„åé¦ˆ  â”‚   â”‚ â€¢ A/Bæµ‹è¯•ç»“æœ    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.2 ç”¨æˆ·æ»¡æ„åº¦é‡åŒ–æŒ‡æ ‡

```dart
/// ç”¨æˆ·æ»¡æ„åº¦è¯„ä¼°æœåŠ¡
class UserSatisfactionService {
  /// æ ¸å¿ƒæ»¡æ„åº¦æŒ‡æ ‡
  static const satisfactionMetrics = {
    // NPS (å‡€æ¨èå€¼) - ç”¨æˆ·æ„¿æ„æ¨èç»™æœ‹å‹çš„ç¨‹åº¦
    'nps': NpsMetric(
      question: 'æ‚¨æœ‰å¤šå¤§å¯èƒ½å‘æœ‹å‹æ¨èè¿™æ¬¾è®°è´¦APPï¼Ÿ',
      scale: 10,  // 0-10åˆ†
      promoterThreshold: 9,   // 9-10åˆ†ä¸ºæ¨èè€…
      detractorThreshold: 6,  // 0-6åˆ†ä¸ºè´¬æŸè€…
      targetScore: 50,        // ç›®æ ‡NPSâ‰¥50
    ),

    // CSAT (å®¢æˆ·æ»¡æ„åº¦) - å¯¹ç‰¹å®šåŠŸèƒ½çš„æ»¡æ„åº¦
    'csat': CsatMetric(
      question: 'æ‚¨å¯¹{åŠŸèƒ½åç§°}çš„æ»¡æ„ç¨‹åº¦å¦‚ä½•ï¼Ÿ',
      scale: 5,  // 1-5æ˜Ÿ
      targetScore: 4.2,  // ç›®æ ‡â‰¥4.2æ˜Ÿ
    ),

    // CES (å®¢æˆ·è´¹åŠ›åº¦) - å®Œæˆä»»åŠ¡çš„éš¾æ˜“ç¨‹åº¦
    'ces': CesMetric(
      question: 'å®Œæˆ{ä»»åŠ¡åç§°}å¯¹æ‚¨æ¥è¯´æœ‰å¤šå®¹æ˜“ï¼Ÿ',
      scale: 7,  // 1-7åˆ†ï¼Œ7æœ€å®¹æ˜“
      targetScore: 5.5,  // ç›®æ ‡â‰¥5.5åˆ†
    ),
  };

  /// è§¦å‘æ»¡æ„åº¦è°ƒæŸ¥çš„æ—¶æœº
  static const surveyTriggers = [
    // å…³é”®èŠ‚ç‚¹è§¦å‘
    SurveyTrigger(
      event: 'first_week_completed',
      surveyType: 'nps',
      description: 'ä½¿ç”¨æ»¡ä¸€å‘¨åæ”¶é›†NPS',
    ),
    SurveyTrigger(
      event: 'feature_used_10_times',
      surveyType: 'csat',
      description: 'æŸåŠŸèƒ½ä½¿ç”¨10æ¬¡åè¯„ä»·',
    ),
    SurveyTrigger(
      event: 'task_completed',
      surveyType: 'ces',
      description: 'å®Œæˆå¤æ‚ä»»åŠ¡åè¯„ä¼°éš¾åº¦',
    ),
    // å®šæœŸè§¦å‘
    SurveyTrigger(
      event: 'monthly_active',
      surveyType: 'nps',
      description: 'æ¯æœˆæ´»è·ƒç”¨æˆ·NPSè°ƒæŸ¥',
      cooldown: Duration(days: 90),  // 90å¤©å†·å´æœŸ
    ),
  ];
}
```

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šå®Œæ•´NPSç›‘æµ‹ä¸æå‡è®¾è®¡è¯¦è§[ç¬¬28ç«  ç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡](#28-ç”¨æˆ·å£ç¢‘ä¸npsæå‡è®¾è®¡)

#### 2.5.3 ç”¨æˆ·åé¦ˆé—­ç¯æœºåˆ¶

```dart
/// ç”¨æˆ·åé¦ˆå¤„ç†æœåŠ¡
class UserFeedbackService {
  /// åé¦ˆå¤„ç†æµç¨‹
  Future<void> processFeedback(UserFeedback feedback) async {
    // 1. åˆ†ç±»
    final category = await _categorizeFeedback(feedback);

    // 2. ä¼˜å…ˆçº§è¯„ä¼°
    final priority = _assessPriority(feedback, category);

    // 3. è·¯ç”±åˆ°å¯¹åº”å¤„ç†é˜Ÿåˆ—
    await _routeFeedback(feedback, category, priority);

    // 4. è‡ªåŠ¨å›å¤ç¡®è®¤
    await _sendAcknowledgement(feedback);

    // 5. è·Ÿè¸ªå¤„ç†è¿›åº¦
    await _trackProgress(feedback);
  }

  /// åé¦ˆä¼˜å…ˆçº§è¯„ä¼°
  FeedbackPriority _assessPriority(UserFeedback feedback, FeedbackCategory category) {
    double score = 0;

    // å½±å“èŒƒå›´
    score += feedback.affectedUserCount > 100 ? 3 :
             feedback.affectedUserCount > 10 ? 2 : 1;

    // ä¸¥é‡ç¨‹åº¦
    score += feedback.severity == Severity.critical ? 3 :
             feedback.severity == Severity.major ? 2 : 1;

    // ç”¨æˆ·ä»·å€¼ï¼ˆä»˜è´¹ç”¨æˆ·/æ´»è·ƒç”¨æˆ·æƒé‡æ›´é«˜ï¼‰
    score += feedback.userType == UserType.premium ? 1.5 : 1;

    // é‡å¤æ¬¡æ•°
    score += feedback.duplicateCount > 5 ? 2 :
             feedback.duplicateCount > 1 ? 1 : 0;

    return score >= 7 ? FeedbackPriority.critical :
           score >= 5 ? FeedbackPriority.high :
           score >= 3 ? FeedbackPriority.medium : FeedbackPriority.low;
  }

  /// åé¦ˆå¤„ç†åçš„é—­ç¯
  Future<void> closeFeedbackLoop(String feedbackId, FeedbackResolution resolution) async {
    final feedback = await _getFeedback(feedbackId);

    // 1. é€šçŸ¥ç”¨æˆ·å¤„ç†ç»“æœ
    await _notifyUser(feedback.userId, resolution);

    // 2. å¦‚æœæ˜¯åŠŸèƒ½å»ºè®®ä¸”å·²å®ç°ï¼Œé‚€è¯·ç”¨æˆ·ä½“éªŒ
    if (resolution.type == ResolutionType.implemented) {
      await _inviteToTryNewFeature(feedback.userId, resolution.featureId);
    }

    // 3. è¯·æ±‚è·Ÿè¿›æ»¡æ„åº¦è¯„ä»·
    await _requestFollowUpSurvey(feedback.userId, feedbackId);

    // 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
    await _updateFeedbackStats(feedbackId, resolution);
  }
}

/// åé¦ˆç±»å‹
enum FeedbackCategory {
  bug,           // ç¼ºé™·æŠ¥å‘Š
  feature,       // åŠŸèƒ½å»ºè®®
  improvement,   // æ”¹è¿›å»ºè®®
  complaint,     // æŠ•è¯‰
  praise,        // å¥½è¯„
  question,      // å’¨è¯¢
}
```

#### 2.5.4 ç”¨æˆ·éœ€æ±‚éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         éœ€æ±‚éªŒè¯å†³ç­–æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  æ”¶é›†éœ€æ±‚ â”€â”€â–¶ éœ€æ±‚åˆ†æ â”€â”€â–¶ ç”¨æˆ·éªŒè¯ â”€â”€â–¶ åŸå‹æµ‹è¯• â”€â”€â–¶ å†³ç­–           â”‚
â”‚      â”‚           â”‚           â”‚           â”‚           â”‚               â”‚
â”‚      â–¼           â–¼           â–¼           â–¼           â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚åé¦ˆæ”¶é›†â”‚ â”‚ä»·å€¼è¯„ä¼°â”‚ â”‚ç”¨æˆ·è®¿è°ˆâ”‚ â”‚å¯ç”¨æ€§  â”‚ â”‚Go/NoGo â”‚             â”‚
â”‚  â”‚æ•°æ®åˆ†æâ”‚ â”‚æˆæœ¬ä¼°ç®—â”‚ â”‚é—®å·è°ƒæŸ¥â”‚ â”‚æµ‹è¯•    â”‚ â”‚å†³ç­–    â”‚             â”‚
â”‚  â”‚ç«å“ç ”ç©¶â”‚ â”‚ä¼˜å…ˆæ’åºâ”‚ â”‚A/Bæµ‹è¯• â”‚ â”‚åŸ‹ç‚¹    â”‚ â”‚         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                        â”‚
â”‚  éªŒè¯æ ‡å‡†ï¼š                                                             â”‚
â”‚  â€¢ ç”¨æˆ·éœ€æ±‚çœŸå®æ€§ï¼šâ‰¥10ä¸ªç‹¬ç«‹ç”¨æˆ·æå‡ºç›¸åŒéœ€æ±‚                           â”‚
â”‚  â€¢ ç”¨æˆ·æ„¿æ„ä»˜è´¹/ä½¿ç”¨ï¼šè®¿è°ˆä¸­â‰¥60%è¡¨ç¤ºæ„¿æ„ä½¿ç”¨                           â”‚
â”‚  â€¢ åŸå‹æµ‹è¯•é€šè¿‡ç‡ï¼šä»»åŠ¡å®Œæˆç‡â‰¥80%                                      â”‚
â”‚  â€¢ æ»¡æ„åº¦é¢„æœŸï¼šé¢„æœŸCSATâ‰¥4.0                                            â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.5 ç”¨æˆ·ä»·å€¼åº¦é‡ä½“ç³»

```dart
/// ç”¨æˆ·ä»·å€¼åº¦é‡æœåŠ¡
class UserValueMetricsService {
  /// æ ¸å¿ƒç”¨æˆ·ä»·å€¼æŒ‡æ ‡
  final userValueMetrics = {
    // ç•™å­˜ç›¸å…³
    'æ¬¡æ—¥ç•™å­˜ç‡': RetentionMetric(day: 1, target: 0.40),
    '7æ—¥ç•™å­˜ç‡': RetentionMetric(day: 7, target: 0.25),
    '30æ—¥ç•™å­˜ç‡': RetentionMetric(day: 30, target: 0.15),

    // æ´»è·ƒç›¸å…³
    'æ—¥æ´»è·ƒç”¨æˆ·(DAU)': ActiveUserMetric(period: 'daily'),
    'æœˆæ´»è·ƒç”¨æˆ·(MAU)': ActiveUserMetric(period: 'monthly'),
    'DAU/MAUæ¯”ç‡': EngagementMetric(target: 0.20),  // ç²˜æ€§æŒ‡æ ‡

    // ä½¿ç”¨æ·±åº¦
    'äººå‡è®°è´¦ç¬”æ•°/æ—¥': UsageMetric(action: 'add_transaction', target: 2.0),
    'åŠŸèƒ½è¦†ç›–ç‡': FeatureCoverageMetric(target: 0.60),  // ä½¿ç”¨â‰¥60%çš„åŠŸèƒ½
    'ä¼šè¯æ—¶é•¿': SessionMetric(target: Duration(minutes: 3)),

    // ç”¨æˆ·æˆé•¿
    'å®Œæˆæ–°æ‰‹å¼•å¯¼ç‡': OnboardingMetric(target: 0.70),
    'å‡çº§åˆ°é«˜çº§åŠŸèƒ½ç‡': UpgradeMetric(target: 0.30),
    'æ¨èæ–°ç”¨æˆ·æ•°': ReferralMetric(target: 0.10),  // 10%ç”¨æˆ·å¸¦æ¥æ–°ç”¨æˆ·
  };

  /// å®šæœŸç”Ÿæˆç”¨æˆ·ä»·å€¼æŠ¥å‘Š
  Future<UserValueReport> generateWeeklyReport() async {
    final report = UserValueReport(
      period: DateRange.lastWeek(),
      metrics: await _collectAllMetrics(),
      trends: await _analyzeTrends(),
      insights: await _generateInsights(),
      actionItems: await _suggestActions(),
    );

    // è‡ªåŠ¨å‘é€ç»™äº§å“å›¢é˜Ÿ
    await _sendToProductTeam(report);

    return report;
  }
}
```

---


---

# ç¬¬äºŒéƒ¨åˆ†ï¼šè®¾è®¡ç†å¿µä¸åŸåˆ™

---

## 3. æ‡’äººè®¾è®¡åŸåˆ™

**"æ‡’äººè®¾è®¡"** æ˜¯ AIæ™ºèƒ½è®°è´¦ 2.0 çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ä¹‹ä¸€ã€‚æˆ‘ä»¬çš„ç›®æ ‡ç”¨æˆ·æ˜¯é‚£äº›æƒ³è¦ç®¡ç†å¥½è‡ªå·±è´¢åŠ¡ã€ä½†åˆä¸æ„¿æ„èŠ±å¤ªå¤šæ—¶é—´åœ¨è®°è´¦ä¸Šçš„"æ‡’äºº"ã€‚ä¸ºè¿™äº›ç”¨æˆ·è®¾è®¡äº§å“ï¼Œæ„å‘³ç€è¦åœ¨æ¯ä¸€ä¸ªäº¤äº’ç‚¹ä¸Šéƒ½è¿½æ±‚æè‡´çš„ç®€æ´ã€‚

### 3.1 è®¾è®¡ç†å¿µ

#### 3.1.1 æ ¸å¿ƒåŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‡’äººè®¾è®¡æ ¸å¿ƒç†å¿µ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™ä¸€ï¼šæœ€å°‘æ“ä½œåŸåˆ™                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ é«˜é¢‘æ“ä½œä¸€æ­¥å®Œæˆï¼Œä½é¢‘æ“ä½œä¸è¶…è¿‡ä¸‰æ­¥                         â”‚   â”‚
â”‚  â”‚  â€¢ èƒ½è‡ªåŠ¨å®Œæˆçš„ï¼Œç»ä¸è®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ                             â”‚   â”‚
â”‚  â”‚  â€¢ èƒ½æ¨æ–­çš„ä¿¡æ¯ï¼Œç»ä¸è®©ç”¨æˆ·è¾“å…¥                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™äºŒï¼šæ™ºèƒ½é»˜è®¤åŸåˆ™                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰é…ç½®éƒ½æœ‰æ™ºèƒ½é»˜è®¤å€¼                                       â”‚   â”‚
â”‚  â”‚  â€¢ é»˜è®¤å€¼åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®åŠ¨æ€è°ƒæ•´                               â”‚   â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åªéœ€è¦åœ¨é»˜è®¤å€¼ä¸æ»¡è¶³æ—¶æ‰è¿›è¡Œè°ƒæ•´                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™ä¸‰ï¼šæ¸è¿›å¼å¤æ‚åº¦åŸåˆ™                                       â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ ç®€å•åŠŸèƒ½ç«‹å³å¯ç”¨ï¼Œé«˜çº§åŠŸèƒ½æŒ‰éœ€å±•å¼€                           â”‚   â”‚
â”‚  â”‚  â€¢ æ–°ç”¨æˆ·é›¶é…ç½®å³å¯å¼€å§‹ä½¿ç”¨                                     â”‚   â”‚
â”‚  â”‚  â€¢ éšç€ä½¿ç”¨æ·±å…¥ï¼Œé€æ­¥è§£é”æ›´å¤šèƒ½åŠ›                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸåˆ™å››ï¼šå•æ‰‹æ“ä½œåŸåˆ™ (One-Handed Operation)                    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å¿…é¡»æ”¯æŒå•æ‰‹æ“ä½œå®Œæˆ                             â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®äº¤äº’å…ƒç´ é›†ä¸­åœ¨æ‹‡æŒ‡çƒ­åŒºï¼ˆå±å¹•ä¸‹åŠéƒ¨åˆ†ï¼‰                   â”‚   â”‚
â”‚  â”‚  â€¢ é¿å…éœ€è¦åŒæ‰‹é…åˆçš„å¤æ‚æ‰‹åŠ¿                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ”¯æŒå·¦å³æ‰‹ç”¨æˆ·ï¼ˆé•œåƒå¸ƒå±€é€‰é¡¹ï¼‰                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  ğŸ’¡ æ³¨ï¼šä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™è¯¦è§ç¬¬4ç« ã€Šä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™ã€‹                      â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.1.2 æ‡’äººç”¨æˆ·ç”»åƒ

| ç‰¹å¾ | æè¿° | è®¾è®¡åº”å¯¹ |
|------|------|----------|
| **æ—¶é—´ç¨€ç¼º** | æ¯å¤©æ„¿æ„èŠ±åœ¨è®°è´¦ä¸Šçš„æ—¶é—´ < 30ç§’ | ä¸€é”®è®°è´¦ã€è¯­éŸ³è®°è´¦ |
| **è®¨åŒé‡å¤** | åŒç±»æ“ä½œä¸æ„¿åšç¬¬äºŒæ¬¡ | æ™ºèƒ½è®°å¿†ã€æ¨¡æ¿åŒ¹é… |
| **é…ç½®ææƒ§** | çœ‹åˆ°å¤æ‚è®¾ç½®å°±æƒ³æ”¾å¼ƒ | æ™ºèƒ½é»˜è®¤ã€æ¸è¿›å¼é…ç½® |
| **ç»“æœå¯¼å‘** | åªå…³å¿ƒ"è®°ä½äº†æ²¡"ï¼Œä¸å…³å¿ƒç»†èŠ‚ | è‡ªåŠ¨åˆ†ç±»ã€æ™ºèƒ½å¡«å…… |
| **ä½å®¹é”™** | å‡ºé”™ä¸€æ¬¡å°±å¯èƒ½å¸è½½APP | å®½å®¹è¾“å…¥ã€æ™ºèƒ½çº é”™ |

### 3.2 æ“ä½œæ•ˆç‡ä¼˜åŒ–æ¨¡å‹

#### 3.2.1 ç‰¹æ€§ä½¿ç”¨ç‡åŠ æƒæ¨¡å‹

æˆ‘ä»¬é€šè¿‡åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œå»ºç«‹ç‰¹æ€§ä½¿ç”¨ç‡ä¸æ“ä½œæ­¥éª¤çš„åŠ æƒæ¨¡å‹ï¼Œç¡®ä¿æ•´ä½“æ“ä½œæ•ˆç‡æœ€ä¼˜ã€‚

```dart
/// ç‰¹æ€§ä½¿ç”¨ç‡åŠ æƒæ¨¡å‹
class FeatureUsageWeightModel {
  /// æ“ä½œæ•ˆç‡è¯„åˆ†ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
  /// å…¬å¼ï¼šæ€»åˆ† = Î£(ç‰¹æ€§é¢‘ç‡ Ã— ç‰¹æ€§æ­¥éª¤æ•°)
  /// ç›®æ ‡ï¼šæœ€å°åŒ–æ€»åˆ†

  /// ç‰¹æ€§åˆ†ç±»åŠå…¶æœŸæœ›æ­¥éª¤æ•°
  static const Map<FeatureCategory, int> targetSteps = {
    // é«˜é¢‘æ“ä½œï¼ˆæ¯å¤©å¤šæ¬¡ï¼‰ï¼šå¿…é¡»1æ­¥å®Œæˆ
    FeatureCategory.quickExpense: 1,      // å¿«é€Ÿè®°ä¸€ç¬”æ”¯å‡º
    FeatureCategory.viewBalance: 1,       // æŸ¥çœ‹ä½™é¢
    FeatureCategory.checkBudget: 1,       // æŸ¥çœ‹é¢„ç®—å‰©ä½™

    // ä¸­é¢‘æ“ä½œï¼ˆæ¯å¤©1-2æ¬¡ï¼‰ï¼šæœ€å¤š2æ­¥
    FeatureCategory.addIncome: 2,         // è®°å½•æ”¶å…¥
    FeatureCategory.viewToday: 2,         // æŸ¥çœ‹ä»Šæ—¥è´¦å•
    FeatureCategory.voiceRecord: 2,       // è¯­éŸ³è®°è´¦

    // ä½é¢‘æ“ä½œï¼ˆæ¯å‘¨å‡ æ¬¡ï¼‰ï¼šæœ€å¤š3æ­¥
    FeatureCategory.viewReport: 3,        // æŸ¥çœ‹æŠ¥è¡¨
    FeatureCategory.editTransaction: 3,   // ç¼–è¾‘äº¤æ˜“
    FeatureCategory.setBudget: 3,         // è®¾ç½®é¢„ç®—

    // ç¨€æœ‰æ“ä½œï¼ˆæ¯æœˆå‡ æ¬¡ï¼‰ï¼šæœ€å¤š5æ­¥
    FeatureCategory.addAccount: 5,        // æ·»åŠ è´¦æˆ·
    FeatureCategory.exportData: 5,        // å¯¼å‡ºæ•°æ®
    FeatureCategory.settings: 5,          // ç³»ç»Ÿè®¾ç½®
  };

  /// è®¡ç®—å½“å‰ç”¨æˆ·çš„æ“ä½œæ•ˆç‡è¯„åˆ†
  static double calculateEfficiencyScore(UserBehaviorData data) {
    double totalScore = 0;

    for (final feature in FeatureCategory.values) {
      final frequency = data.getFeatureFrequency(feature);
      final actualSteps = data.getAverageSteps(feature);
      final targetStep = targetSteps[feature] ?? 3;

      // è¶…å‡ºç›®æ ‡æ­¥éª¤æ•°çš„æƒ©ç½š
      final penalty = max(0, actualSteps - targetStep);

      // åŠ æƒï¼šé¢‘ç‡ Ã— æƒ©ç½š
      totalScore += frequency * penalty;
    }

    return totalScore;
  }

  /// è¯†åˆ«éœ€è¦ä¼˜åŒ–çš„åŠŸèƒ½
  static List<OptimizationSuggestion> identifyOptimizations(UserBehaviorData data) {
    final suggestions = <OptimizationSuggestion>[];

    for (final feature in FeatureCategory.values) {
      final frequency = data.getFeatureFrequency(feature);
      final actualSteps = data.getAverageSteps(feature);
      final targetStep = targetSteps[feature] ?? 3;

      if (actualSteps > targetStep && frequency > 0.1) {
        // é«˜é¢‘æ“ä½œè¶…å‡ºç›®æ ‡æ­¥éª¤
        final impact = frequency * (actualSteps - targetStep);
        suggestions.add(OptimizationSuggestion(
          feature: feature,
          currentSteps: actualSteps,
          targetSteps: targetStep,
          frequency: frequency,
          impact: impact,
          suggestion: _generateSuggestion(feature, actualSteps, targetStep),
        ));
      }
    }

    // æŒ‰å½±å“åº¦æ’åº
    suggestions.sort((a, b) => b.impact.compareTo(a.impact));
    return suggestions;
  }

  static String _generateSuggestion(
    FeatureCategory feature,
    double current,
    int target,
  ) {
    if (feature == FeatureCategory.quickExpense && current > 1) {
      return 'è€ƒè™‘æ·»åŠ é¦–é¡µå¿«æ·è®°è´¦å…¥å£ï¼Œæˆ–å¯ç”¨æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦';
    }
    if (feature == FeatureCategory.voiceRecord && current > 2) {
      return 'è€ƒè™‘æ·»åŠ è¯­éŸ³è®°è´¦å¿«æ·æ–¹å¼ï¼Œæˆ–æ”¯æŒæ¯å±è¯­éŸ³å”¤é†’';
    }
    // ... æ›´å¤šå»ºè®®
    return 'åˆ†æç”¨æˆ·æ“ä½œè·¯å¾„ï¼Œå‡å°‘ä¸­é—´æ­¥éª¤';
  }
}

/// ç‰¹æ€§åˆ†ç±»
enum FeatureCategory {
  quickExpense,    // å¿«é€Ÿè®°æ”¯å‡º
  viewBalance,     // æŸ¥çœ‹ä½™é¢
  checkBudget,     // æŸ¥çœ‹é¢„ç®—
  addIncome,       // è®°å½•æ”¶å…¥
  viewToday,       // ä»Šæ—¥è´¦å•
  voiceRecord,     // è¯­éŸ³è®°è´¦
  viewReport,      // æŸ¥çœ‹æŠ¥è¡¨
  editTransaction, // ç¼–è¾‘äº¤æ˜“
  setBudget,       // è®¾ç½®é¢„ç®—
  addAccount,      // æ·»åŠ è´¦æˆ·
  exportData,      // å¯¼å‡ºæ•°æ®
  settings,        // ç³»ç»Ÿè®¾ç½®
}

/// ä¼˜åŒ–å»ºè®®
class OptimizationSuggestion {
  final FeatureCategory feature;
  final double currentSteps;
  final int targetSteps;
  final double frequency;  // 0-1ï¼Œ1è¡¨ç¤ºæ¯å¤©ä½¿ç”¨
  final double impact;     // å½±å“åº¦ = é¢‘ç‡ Ã— è¶…å‡ºæ­¥éª¤æ•°
  final String suggestion;

  const OptimizationSuggestion({
    required this.feature,
    required this.currentSteps,
    required this.targetSteps,
    required this.frequency,
    required this.impact,
    required this.suggestion,
  });
}
```

#### 3.2.2 ç”¨æˆ·æ“ä½œæ•ˆç‡ç›‘æ§

```dart
/// ç”¨æˆ·æ“ä½œæ•ˆç‡ç›‘æ§æœåŠ¡
class UserEfficiencyMonitor {
  final AnalyticsService _analytics;

  /// è®°å½•ç”¨æˆ·æ“ä½œè·¯å¾„
  void trackOperationPath(String feature, List<String> steps) {
    _analytics.track('operation_path', {
      'feature': feature,
      'step_count': steps.length,
      'steps': steps,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// è®¡ç®—ç”¨æˆ·å¹³å‡æ“ä½œæ•ˆç‡
  Future<UserEfficiencyReport> generateReport(String userId) async {
    final data = await _analytics.getUserBehaviorData(userId);

    // è®¡ç®—å„åŠŸèƒ½çš„å¹³å‡æ­¥éª¤æ•°
    final featureSteps = <FeatureCategory, AverageSteps>{};
    for (final feature in FeatureCategory.values) {
      final operations = data.getOperationsForFeature(feature);
      if (operations.isNotEmpty) {
        final avgSteps = operations.map((o) => o.stepCount).average;
        featureSteps[feature] = AverageSteps(
          average: avgSteps,
          min: operations.map((o) => o.stepCount).min,
          max: operations.map((o) => o.stepCount).max,
          count: operations.length,
        );
      }
    }

    // è®¡ç®—ç»¼åˆæ•ˆç‡è¯„åˆ†
    final efficiencyScore = FeatureUsageWeightModel.calculateEfficiencyScore(data);

    // ç”Ÿæˆä¼˜åŒ–å»ºè®®
    final suggestions = FeatureUsageWeightModel.identifyOptimizations(data);

    return UserEfficiencyReport(
      userId: userId,
      period: data.period,
      featureSteps: featureSteps,
      efficiencyScore: efficiencyScore,
      suggestions: suggestions,
      // ä¸å¹³å‡ç”¨æˆ·å¯¹æ¯”
      comparedToAverage: _compareToAverage(efficiencyScore),
    );
  }

  /// å‘¨æœŸæ€§ç”Ÿæˆæ•ˆç‡æ´å¯Ÿ
  Future<void> generateWeeklyInsight(String userId) async {
    final report = await generateReport(userId);

    if (report.suggestions.isNotEmpty) {
      final topSuggestion = report.suggestions.first;

      // æ¨é€ä¼˜åŒ–æç¤ºï¼ˆéæ‰“æ‰°å¼ï¼‰
      await _showOptimizationTip(
        title: 'å‘ç°å¯ä»¥æ›´å¿«',
        message: '${topSuggestion.feature.displayName}æ“ä½œå¹³å‡éœ€è¦'
            '${topSuggestion.currentSteps.toStringAsFixed(1)}æ­¥ï¼Œ'
            '${topSuggestion.suggestion}',
      );
    }
  }
}
```

### 3.3 æ™ºèƒ½åŒ–è‡ªåŠ¨é…ç½®ç³»ç»Ÿ

#### 3.3.1 è‡ªåŠ¨é…ç½®è§„åˆ™å¼•æ“

```dart
/// æ™ºèƒ½è‡ªåŠ¨é…ç½®æœåŠ¡
/// ç›®æ ‡ï¼šè®©ç³»ç»Ÿä¸­çš„å„é¡¹æ•°æ®å°½å¯èƒ½æ™ºèƒ½åŒ–å½¢æˆ
class SmartAutoConfigService {
  final PreciseLocationService _locationService;
  final UserBehaviorAnalyzer _behaviorAnalyzer;
  final SharedPreferences _prefs;

  /// æ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
  final List<AutoConfigRule> _rules = [];

  SmartAutoConfigService() {
    // æ³¨å†Œæ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
    _registerRules();
  }

  void _registerRules() {
    _rules.addAll([
      // ä½ç½®ç›¸å…³è§„åˆ™
      HomeLocationDetectionRule(),
      WorkLocationDetectionRule(),
      FrequentLocationDetectionRule(),
      HomeCityDetectionRule(),

      // æ—¶é—´ç›¸å…³è§„åˆ™
      PaydayDetectionRule(),
      SleepTimeDetectionRule(),
      CommuteTimeDetectionRule(),

      // æ¶ˆè´¹ä¹ æƒ¯è§„åˆ™
      PreferredPaymentMethodRule(),
      FrequentMerchantRule(),
      CategoryPreferenceRule(),

      // é¢„ç®—ç›¸å…³è§„åˆ™
      SmartBudgetAmountRule(),
      SeasonalBudgetAdjustmentRule(),
    ]);
  }

  /// è¿è¡Œæ‰€æœ‰è‡ªåŠ¨é…ç½®è§„åˆ™
  Future<AutoConfigResult> runAutoConfig() async {
    final results = <String, ConfigValue>{};
    final skipped = <String, String>{};

    for (final rule in _rules) {
      try {
        // æ£€æŸ¥è§„åˆ™æ˜¯å¦æ»¡è¶³å‰ç½®æ¡ä»¶
        if (!await rule.canExecute()) {
          skipped[rule.configKey] = 'æ•°æ®ä¸è¶³';
          continue;
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨è®¾ç½®è¿‡
        if (await _isManuallySet(rule.configKey)) {
          skipped[rule.configKey] = 'ç”¨æˆ·å·²æ‰‹åŠ¨è®¾ç½®';
          continue;
        }

        // æ‰§è¡Œè§„åˆ™
        final value = await rule.detect();
        if (value != null) {
          results[rule.configKey] = value;
          await _saveConfig(rule.configKey, value);
        }
      } catch (e) {
        skipped[rule.configKey] = 'æ£€æµ‹å¤±è´¥: $e';
      }
    }

    return AutoConfigResult(
      configured: results,
      skipped: skipped,
      timestamp: DateTime.now(),
    );
  }
}

/// è‡ªåŠ¨é…ç½®è§„åˆ™æŠ½è±¡
abstract class AutoConfigRule {
  /// é…ç½®é¡¹æ ‡è¯†
  String get configKey;

  /// é…ç½®é¡¹åç§°
  String get configName;

  /// æœ€å°‘éœ€è¦å¤šå°‘æ•°æ®æ‰èƒ½æ£€æµ‹
  int get minDataPoints;

  /// æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰
  double get confidenceThreshold => 0.8;

  /// æ˜¯å¦æ»¡è¶³æ‰§è¡Œæ¡ä»¶
  Future<bool> canExecute();

  /// æ‰§è¡Œæ£€æµ‹
  Future<ConfigValue?> detect();
}
```

#### 3.3.2 å®¶åº­ä½ç½®æ™ºèƒ½æ£€æµ‹

```dart
/// å®¶åº­ä½ç½®è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class HomeLocationDetectionRule extends AutoConfigRule {
  final LocationHistoryService _locationHistory;
  final PreciseLocationService _locationService;

  @override
  String get configKey => 'user_home_location';

  @override
  String get configName => 'å®¶åº­ä½ç½®';

  @override
  int get minDataPoints => 7;  // è‡³å°‘7å¤©æ•°æ®

  @override
  Future<bool> canExecute() async {
    // éœ€è¦ä½ç½®æƒé™å’Œè¶³å¤Ÿçš„å†å²æ•°æ®
    final hasPermission = await _locationService.hasPermission();
    if (!hasPermission) return false;

    final nightLocations = await _getNightTimeLocations();
    return nightLocations.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    // è§„åˆ™ï¼šæ™šä¸Š22:00åˆ°æ—©ä¸Š7:00ä¹‹é—´ï¼Œç”¨æˆ·æœ€å¸¸åœç•™çš„ä½ç½®
    final nightLocations = await _getNightTimeLocations();

    // ä½ç½®èšç±»
    final clusters = _clusterLocations(nightLocations, radiusMeters: 200);
    if (clusters.isEmpty) return null;

    // æ‰¾å‡ºæœ€å¤§çš„èšç±»
    final largestCluster = clusters.reduce((a, b) =>
      a.memberCount > b.memberCount ? a : b);

    // è®¡ç®—ç½®ä¿¡åº¦ï¼šè¯¥èšç±»å æ€»å¤œé—´ä½ç½®è®°å½•çš„æ¯”ä¾‹
    final confidence = largestCluster.memberCount / nightLocations.length;
    if (confidence < confidenceThreshold) return null;

    // é¢å¤–éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­å¤šå¤©åœ¨æ­¤ä½ç½®
    final consecutiveDays = _countConsecutiveDays(largestCluster, nightLocations);
    if (consecutiveDays < 3) return null;

    return ConfigValue(
      value: largestCluster.center.toJson(),
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: nightLocations.length,
      metadata: {
        'consecutive_days': consecutiveDays,
        'cluster_radius': largestCluster.radius,
        'address': await _reverseGeocode(largestCluster.center),
      },
    );
  }

  /// è·å–å¤œé—´ä½ç½®è®°å½•
  Future<List<LocationRecord>> _getNightTimeLocations() async {
    final allLocations = await _locationHistory.getRecentLocations(days: 30);

    return allLocations.where((loc) {
      final hour = loc.timestamp.hour;
      // æ™šä¸Š22ç‚¹åˆ°æ—©ä¸Š7ç‚¹
      return hour >= 22 || hour < 7;
    }).toList();
  }

  /// è®¡ç®—è¿ç»­å¤©æ•°
  int _countConsecutiveDays(LocationCluster cluster, List<LocationRecord> records) {
    final daysInCluster = records
      .where((r) => cluster.contains(r.location))
      .map((r) => DateFormat('yyyy-MM-dd').format(r.timestamp))
      .toSet()
      .toList()
      ..sort();

    int maxConsecutive = 1;
    int current = 1;

    for (int i = 1; i < daysInCluster.length; i++) {
      final prev = DateTime.parse(daysInCluster[i - 1]);
      final curr = DateTime.parse(daysInCluster[i]);

      if (curr.difference(prev).inDays == 1) {
        current++;
        maxConsecutive = max(maxConsecutive, current);
      } else {
        current = 1;
      }
    }

    return maxConsecutive;
  }
}
```

#### 3.3.3 å·¥ä½œä½ç½®æ™ºèƒ½æ£€æµ‹

```dart
/// å·¥ä½œä½ç½®è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class WorkLocationDetectionRule extends AutoConfigRule {
  final LocationHistoryService _locationHistory;
  final HomeLocationDetectionRule _homeRule;

  @override
  String get configKey => 'user_work_location';

  @override
  String get configName => 'å·¥ä½œä½ç½®';

  @override
  int get minDataPoints => 5;  // è‡³å°‘5ä¸ªå·¥ä½œæ—¥

  @override
  Future<bool> canExecute() async {
    final workdayLocations = await _getWorkdayLocations();
    return workdayLocations.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    // è§„åˆ™ï¼šå·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰9:00-18:00ä¹‹é—´ï¼Œç”¨æˆ·æœ€å¸¸åœç•™çš„ä½ç½®
    // æ’é™¤å®¶åº­ä½ç½®
    final workdayLocations = await _getWorkdayLocations();

    // è·å–å®¶åº­ä½ç½®ç”¨äºæ’é™¤
    final homeLocation = await _getHomeLocation();

    // è¿‡æ»¤æ‰å®¶é™„è¿‘çš„ä½ç½®ï¼ˆ500ç±³èŒƒå›´ï¼‰
    final filteredLocations = workdayLocations.where((loc) {
      if (homeLocation == null) return true;
      return loc.location.distanceTo(homeLocation) > 500;
    }).toList();

    if (filteredLocations.length < minDataPoints) return null;

    // ä½ç½®èšç±»
    final clusters = _clusterLocations(filteredLocations, radiusMeters: 300);
    if (clusters.isEmpty) return null;

    // æ‰¾å‡ºæœ€å¤§çš„èšç±»
    final largestCluster = clusters.reduce((a, b) =>
      a.memberCount > b.memberCount ? a : b);

    // è®¡ç®—ç½®ä¿¡åº¦
    final confidence = largestCluster.memberCount / filteredLocations.length;
    if (confidence < confidenceThreshold) return null;

    // éªŒè¯ï¼šæ˜¯å¦åœ¨å¤šä¸ªä¸åŒçš„å·¥ä½œæ—¥å‡ºç°
    final uniqueWorkdays = _countUniqueWorkdays(largestCluster, filteredLocations);
    if (uniqueWorkdays < 3) return null;  // è‡³å°‘3ä¸ªä¸åŒçš„å·¥ä½œæ—¥

    return ConfigValue(
      value: largestCluster.center.toJson(),
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: filteredLocations.length,
      metadata: {
        'unique_workdays': uniqueWorkdays,
        'cluster_radius': largestCluster.radius,
        'address': await _reverseGeocode(largestCluster.center),
        'poi_type': await _detectPOIType(largestCluster.center),  // åŠå…¬æ¥¼/å•†ä¸šåŒºç­‰
      },
    );
  }

  /// è·å–å·¥ä½œæ—¥å·¥ä½œæ—¶é—´çš„ä½ç½®è®°å½•
  Future<List<LocationRecord>> _getWorkdayLocations() async {
    final allLocations = await _locationHistory.getRecentLocations(days: 30);

    return allLocations.where((loc) {
      final weekday = loc.timestamp.weekday;
      final hour = loc.timestamp.hour;

      // å‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9ç‚¹åˆ°18ç‚¹
      return weekday >= 1 && weekday <= 5 && hour >= 9 && hour <= 18;
    }).toList();
  }

  /// è®¡ç®—ç‹¬ç«‹å·¥ä½œæ—¥æ•°
  int _countUniqueWorkdays(LocationCluster cluster, List<LocationRecord> records) {
    return records
      .where((r) => cluster.contains(r.location))
      .map((r) => DateFormat('yyyy-MM-dd').format(r.timestamp))
      .toSet()
      .length;
  }
}
```

#### 3.3.4 å‘è–ªæ—¥æ™ºèƒ½æ£€æµ‹

```dart
/// å‘è–ªæ—¥è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class PaydayDetectionRule extends AutoConfigRule {
  final TransactionRepository _transactionRepo;

  @override
  String get configKey => 'user_payday';

  @override
  String get configName => 'å‘è–ªæ—¥';

  @override
  int get minDataPoints => 2;  // è‡³å°‘2æ¬¡è–ªèµ„è®°å½•

  @override
  Future<bool> canExecute() async {
    final salaryTransactions = await _getSalaryTransactions();
    return salaryTransactions.length >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    final salaryTransactions = await _getSalaryTransactions();

    // æå–æ¯æ¬¡è–ªèµ„çš„æ—¥æœŸ
    final payDays = salaryTransactions.map((tx) => tx.date.day).toList();

    // ç»Ÿè®¡æœ€å¸¸è§çš„å‘è–ªæ—¥
    final dayCounts = <int, int>{};
    for (final day in payDays) {
      dayCounts[day] = (dayCounts[day] ?? 0) + 1;
    }

    // æ‰¾å‡ºå‡ºç°æ¬¡æ•°æœ€å¤šçš„æ—¥æœŸ
    final mostCommonDay = dayCounts.entries
      .reduce((a, b) => a.value > b.value ? a : b)
      .key;

    final confidence = dayCounts[mostCommonDay]! / payDays.length;
    if (confidence < confidenceThreshold) return null;

    // éªŒè¯ï¼šé‡‘é¢æ˜¯å¦ç›¸è¿‘ï¼ˆè–ªèµ„é€šå¸¸ç›¸å¯¹å›ºå®šï¼‰
    final amounts = salaryTransactions.map((tx) => tx.amount).toList();
    final amountVariance = _calculateVariance(amounts);
    final isAmountStable = amountVariance < 0.2;  // æ–¹å·®å°äº20%

    return ConfigValue(
      value: mostCommonDay,
      confidence: confidence,
      detectedAt: DateTime.now(),
      dataPoints: salaryTransactions.length,
      metadata: {
        'detected_from_transactions': salaryTransactions.length,
        'amount_stable': isAmountStable,
        'average_amount': amounts.average,
      },
    );
  }

  /// è·å–è–ªèµ„ç±»äº¤æ˜“
  Future<List<Transaction>> _getSalaryTransactions() async {
    final transactions = await _transactionRepo.getIncomesForPeriod(
      DateTime.now().subtract(Duration(days: 180)),  // æœ€è¿‘6ä¸ªæœˆ
      DateTime.now(),
    );

    // è¯†åˆ«è–ªèµ„äº¤æ˜“ï¼š
    // 1. å¤‡æ³¨åŒ…å«"å·¥èµ„"ã€"è–ªèµ„"ã€"salary"ç­‰å…³é”®è¯
    // 2. é‡‘é¢è¾ƒå¤§ä¸”ç›¸å¯¹å›ºå®š
    // 3. æ¥æºæ˜¯é“¶è¡Œè½¬è´¦
    return transactions.where((tx) {
      final note = tx.note?.toLowerCase() ?? '';
      final hasSalaryKeyword = note.contains('å·¥èµ„') ||
        note.contains('è–ªèµ„') ||
        note.contains('salary') ||
        note.contains('wage');

      // æˆ–è€…åˆ†ç±»æ˜¯"å·¥èµ„æ”¶å…¥"
      final isSalaryCategory = tx.categoryId == 'income_salary';

      return hasSalaryKeyword || isSalaryCategory;
    }).toList();
  }
}
```

#### 3.3.5 æ¶ˆè´¹åå¥½æ™ºèƒ½å­¦ä¹ 

```dart
/// ç±»ç›®åå¥½è‡ªåŠ¨æ£€æµ‹è§„åˆ™
class CategoryPreferenceRule extends AutoConfigRule {
  final TransactionRepository _transactionRepo;

  @override
  String get configKey => 'category_preferences';

  @override
  String get configName => 'æ¶ˆè´¹åå¥½';

  @override
  int get minDataPoints => 30;  // è‡³å°‘30ç¬”äº¤æ˜“

  @override
  Future<bool> canExecute() async {
    final txCount = await _transactionRepo.getTransactionCount(
      since: DateTime.now().subtract(Duration(days: 90)),
    );
    return txCount >= minDataPoints;
  }

  @override
  Future<ConfigValue?> detect() async {
    final transactions = await _transactionRepo.getExpensesSince(
      DateTime.now().subtract(Duration(days: 90)),
    );

    // åˆ†æå„ç±»ç›®çš„æ¶ˆè´¹é¢‘ç‡å’Œé‡‘é¢
    final categoryStats = <String, CategoryPreferenceStats>{};

    for (final tx in transactions) {
      if (tx.categoryId == null) continue;

      final stats = categoryStats.putIfAbsent(
        tx.categoryId!,
        () => CategoryPreferenceStats(),
      );
      stats.count++;
      stats.totalAmount += tx.amount;
      stats.transactions.add(tx);
    }

    // è®¡ç®—æ¯ä¸ªç±»ç›®çš„åå¥½å¾—åˆ†
    final preferences = categoryStats.map((categoryId, stats) {
      final frequencyScore = stats.count / transactions.length;
      final amountScore = stats.totalAmount /
        transactions.fold(0.0, (sum, tx) => sum + tx.amount);

      // ç»¼åˆå¾—åˆ† = é¢‘ç‡æƒé‡ Ã— é¢‘ç‡ + é‡‘é¢æƒé‡ Ã— é‡‘é¢å æ¯”
      final score = frequencyScore * 0.6 + amountScore * 0.4;

      return MapEntry(categoryId, CategoryPreference(
        categoryId: categoryId,
        frequencyScore: frequencyScore,
        amountScore: amountScore,
        overallScore: score,
        averageAmount: stats.totalAmount / stats.count,
        typicalMerchants: _findTypicalMerchants(stats.transactions),
        typicalTimeSlots: _findTypicalTimeSlots(stats.transactions),
      ));
    });

    return ConfigValue(
      value: preferences,
      confidence: 0.9,
      detectedAt: DateTime.now(),
      dataPoints: transactions.length,
    );
  }

  /// æ‰¾å‡ºå…¸å‹å•†æˆ·
  List<String> _findTypicalMerchants(List<Transaction> transactions) {
    final merchantCounts = <String, int>{};
    for (final tx in transactions) {
      if (tx.merchant != null) {
        merchantCounts[tx.merchant!] = (merchantCounts[tx.merchant!] ?? 0) + 1;
      }
    }

    return merchantCounts.entries
      .where((e) => e.value >= 2)  // è‡³å°‘å‡ºç°2æ¬¡
      .map((e) => e.key)
      .take(5)  // æœ€å¤š5ä¸ª
      .toList();
  }

  /// æ‰¾å‡ºå…¸å‹æ¶ˆè´¹æ—¶æ®µ
  List<TimeSlot> _findTypicalTimeSlots(List<Transaction> transactions) {
    final hourCounts = <int, int>{};
    for (final tx in transactions) {
      final hour = tx.date.hour;
      hourCounts[hour] = (hourCounts[hour] ?? 0) + 1;
    }

    // æ‰¾å‡ºé«˜é¢‘æ—¶æ®µï¼ˆè¶…è¿‡å¹³å‡å€¼çš„æ—¶æ®µï¼‰
    final avgCount = hourCounts.values.average;
    return hourCounts.entries
      .where((e) => e.value > avgCount)
      .map((e) => TimeSlot.fromHour(e.key))
      .toList();
  }
}

/// ç±»ç›®åå¥½
class CategoryPreference {
  final String categoryId;
  final double frequencyScore;    // é¢‘ç‡å¾—åˆ† (0-1)
  final double amountScore;       // é‡‘é¢å æ¯”å¾—åˆ† (0-1)
  final double overallScore;      // ç»¼åˆå¾—åˆ† (0-1)
  final double averageAmount;     // å¹³å‡æ¶ˆè´¹é‡‘é¢
  final List<String> typicalMerchants;  // å…¸å‹å•†æˆ·
  final List<TimeSlot> typicalTimeSlots; // å…¸å‹æ¶ˆè´¹æ—¶æ®µ

  const CategoryPreference({
    required this.categoryId,
    required this.frequencyScore,
    required this.amountScore,
    required this.overallScore,
    required this.averageAmount,
    required this.typicalMerchants,
    required this.typicalTimeSlots,
  });
}
```

### 3.4 æ™ºèƒ½é»˜è®¤å€¼ç³»ç»Ÿ

#### 3.4.1 åŠ¨æ€é»˜è®¤å€¼æœåŠ¡

```dart
/// æ™ºèƒ½é»˜è®¤å€¼æœåŠ¡
/// è®©æ‰€æœ‰éœ€è¦ç”¨æˆ·è¾“å…¥çš„åœ°æ–¹éƒ½æœ‰æ™ºèƒ½çš„é»˜è®¤å€¼
class SmartDefaultValueService {
  final UserPreferenceService _preferences;
  final CategoryPreferenceRule _categoryPreference;
  final TransactionRepository _transactionRepo;
  final PreciseLocationService _locationService;

  /// è·å–æ–°äº¤æ˜“çš„æ™ºèƒ½é»˜è®¤å€¼
  Future<TransactionDefaults> getTransactionDefaults({
    TransactionType? type,
    String? merchant,
    PreciseLocation? location,
  }) async {
    final now = DateTime.now();

    // 1. é»˜è®¤åˆ†ç±»ï¼šåŸºäºæ—¶é—´ã€ä½ç½®ã€å•†æˆ·æ¨æ–­
    String? defaultCategory;
    if (merchant != null) {
      defaultCategory = await _inferCategoryFromMerchant(merchant);
    }
    if (defaultCategory == null && location != null) {
      defaultCategory = await _inferCategoryFromLocation(location);
    }
    if (defaultCategory == null) {
      defaultCategory = await _inferCategoryFromTime(now);
    }

    // 2. é»˜è®¤é‡‘é¢ï¼šåŸºäºåˆ†ç±»å’Œå•†æˆ·çš„å†å²å¹³å‡å€¼
    double? defaultAmount;
    if (defaultCategory != null) {
      defaultAmount = await _getTypicalAmount(defaultCategory, merchant);
    }

    // 3. é»˜è®¤è´¦æˆ·ï¼šåŸºäºæ¶ˆè´¹åœºæ™¯æ¨æ–­
    String? defaultAccountId;
    if (location != null) {
      defaultAccountId = await _inferAccountFromLocation(location);
    }
    defaultAccountId ??= await _getMostUsedAccount(type ?? TransactionType.expense);

    // 4. é»˜è®¤æ ‡ç­¾ï¼šåŸºäºåˆ†ç±»å’Œæ—¶é—´
    List<String> defaultTags = [];
    if (defaultCategory != null) {
      defaultTags = await _getSuggestedTags(defaultCategory, now);
    }

    return TransactionDefaults(
      categoryId: defaultCategory,
      amount: defaultAmount,
      accountId: defaultAccountId,
      tags: defaultTags,
      timestamp: now,
      confidence: _calculateConfidence(defaultCategory, defaultAmount),
    );
  }

  /// åŸºäºå•†æˆ·æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromMerchant(String merchant) async {
    // æŸ¥æ‰¾å†å²è®°å½•ä¸­è¯¥å•†æˆ·æœ€å¸¸ç”¨çš„åˆ†ç±»
    final history = await _transactionRepo.getTransactionsByMerchant(
      merchant,
      limit: 10,
    );

    if (history.isEmpty) {
      // å°è¯•ä»å•†æˆ·åç§°æ¨æ–­
      return _inferCategoryFromMerchantName(merchant);
    }

    // ç»Ÿè®¡åˆ†ç±»é¢‘ç‡
    final categoryCounts = <String, int>{};
    for (final tx in history) {
      if (tx.categoryId != null) {
        categoryCounts[tx.categoryId!] =
          (categoryCounts[tx.categoryId!] ?? 0) + 1;
      }
    }

    if (categoryCounts.isEmpty) return null;

    // è¿”å›æœ€å¸¸ç”¨çš„åˆ†ç±»
    return categoryCounts.entries
      .reduce((a, b) => a.value > b.value ? a : b)
      .key;
  }

  /// åŸºäºå•†æˆ·åç§°æ¨æ–­åˆ†ç±»
  String? _inferCategoryFromMerchantName(String merchant) {
    final lowerMerchant = merchant.toLowerCase();

    // é¤é¥®ç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['é¤å…', 'é¥­åº—', 'ç¾é£Ÿ', 'å¤–å–', 'éº¦å½“åŠ³',
        'è‚¯å¾·åŸº', 'æ˜Ÿå·´å…‹', 'restaurant', 'cafe', 'coffee'])) {
      return 'expense_food';
    }

    // äº¤é€šç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['åœ°é“', 'å…¬äº¤', 'å‡ºç§Ÿ', 'æ»´æ»´', 'é«˜å¾·',
        'åŠ æ²¹ç«™', 'uber', 'taxi', 'metro'])) {
      return 'expense_transport';
    }

    // è´­ç‰©ç±»å…³é”®è¯
    if (_containsAny(lowerMerchant, ['è¶…å¸‚', 'ä¾¿åˆ©åº—', 'å•†åœº', 'æ·˜å®', 'äº¬ä¸œ',
        'æ‹¼å¤šå¤š', 'mall', 'store', 'shop'])) {
      return 'expense_shopping';
    }

    // æ›´å¤šè§„åˆ™...
    return null;
  }

  /// åŸºäºä½ç½®æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromLocation(PreciseLocation location) async {
    // ä½¿ç”¨POIä¿¡æ¯æ¨æ–­
    if (location.nearbyPOI != null) {
      switch (location.nearbyPOI!.category) {
        case POICategory.dining:
          return 'expense_food';
        case POICategory.transportation:
          return 'expense_transport';
        case POICategory.shopping:
          return 'expense_shopping';
        case POICategory.entertainment:
          return 'expense_entertainment';
        case POICategory.medical:
          return 'expense_medical';
        default:
          break;
      }
    }

    // ä½¿ç”¨åŒºåŸŸç±»å‹æ¨æ–­
    switch (location.areaType) {
      case AreaType.commercial:
        return 'expense_shopping';
      case AreaType.transportation:
        return 'expense_transport';
      default:
        return null;
    }
  }

  /// åŸºäºæ—¶é—´æ¨æ–­åˆ†ç±»
  Future<String?> _inferCategoryFromTime(DateTime time) async {
    final hour = time.hour;
    final isWeekend = time.weekday >= 6;

    // å·¥ä½œæ—¥
    if (!isWeekend) {
      if (hour >= 7 && hour <= 9) {
        // æ—©é«˜å³°ï¼Œå¯èƒ½æ˜¯æ—©é¤æˆ–äº¤é€š
        return 'expense_food';  // æˆ–åŸºäºç”¨æˆ·å†å²åå¥½
      }
      if (hour >= 11 && hour <= 13) {
        // åˆé¤æ—¶é—´
        return 'expense_food';
      }
      if (hour >= 17 && hour <= 19) {
        // æ™šé«˜å³°ï¼Œå¯èƒ½æ˜¯äº¤é€šæˆ–æ™šé¤
        return 'expense_transport';
      }
      if (hour >= 19 && hour <= 21) {
        // æ™šé¤æ—¶é—´
        return 'expense_food';
      }
    }

    // å‘¨æœ«
    if (isWeekend) {
      if (hour >= 10 && hour <= 22) {
        // å‘¨æœ«æ´»åŠ¨æ—¶é—´ï¼Œå¯èƒ½æ˜¯å¨±ä¹
        return 'expense_entertainment';
      }
    }

    return null;
  }

  /// è·å–å…¸å‹æ¶ˆè´¹é‡‘é¢
  Future<double?> _getTypicalAmount(String categoryId, String? merchant) async {
    // å¦‚æœæœ‰å•†æˆ·ä¿¡æ¯ï¼Œä¼˜å…ˆä½¿ç”¨è¯¥å•†æˆ·çš„å†å²å¹³å‡å€¼
    if (merchant != null) {
      final merchantHistory = await _transactionRepo.getTransactionsByMerchant(
        merchant,
        categoryId: categoryId,
        limit: 10,
      );

      if (merchantHistory.length >= 3) {
        // ä½¿ç”¨ä¸­ä½æ•°æ›´ç¨³å®š
        final amounts = merchantHistory.map((tx) => tx.amount).toList()..sort();
        return amounts[amounts.length ~/ 2];
      }
    }

    // ä½¿ç”¨è¯¥åˆ†ç±»çš„å†å²å¹³å‡å€¼
    final categoryHistory = await _transactionRepo.getTransactionsByCategory(
      categoryId,
      limit: 30,
    );

    if (categoryHistory.length >= 5) {
      final amounts = categoryHistory.map((tx) => tx.amount).toList()..sort();
      return amounts[amounts.length ~/ 2];  // ä¸­ä½æ•°
    }

    return null;
  }
}
```

### 3.5 ä¸€é”®æ“ä½œè®¾è®¡

#### 3.5.1 å¿«æ·æ“ä½œå…¥å£

```dart
/// å¿«æ·æ“ä½œæœåŠ¡
class QuickActionService {
  /// é«˜é¢‘æ“ä½œçš„å¿«æ·å…¥å£é…ç½®
  static const List<QuickAction> defaultActions = [
    QuickAction(
      id: 'quick_expense',
      name: 'å¿«é€Ÿè®°æ”¯å‡º',
      icon: Icons.remove_circle_outline,
      targetSteps: 1,
      entryPoints: [
        EntryPoint.homeFloatingButton,  // é¦–é¡µæ‚¬æµ®æŒ‰é’®
        EntryPoint.shakeToRecord,       // æ‘‡ä¸€æ‘‡
        EntryPoint.widget,              // æ¡Œé¢å°ç»„ä»¶
        EntryPoint.notification,        // é€šçŸ¥æ å¿«æ·å…¥å£
      ],
    ),
    QuickAction(
      id: 'voice_record',
      name: 'è¯­éŸ³è®°è´¦',
      icon: Icons.mic,
      targetSteps: 2,
      entryPoints: [
        EntryPoint.homeLongPress,       // é¦–é¡µé•¿æŒ‰
        EntryPoint.voiceAssistant,      // è¯­éŸ³åŠ©æ‰‹å”¤é†’
        EntryPoint.widget,              // æ¡Œé¢å°ç»„ä»¶
      ],
    ),
    QuickAction(
      id: 'scan_receipt',
      name: 'æ‰«æå°ç¥¨',
      icon: Icons.camera_alt,
      targetSteps: 2,
      entryPoints: [
        EntryPoint.homeButton,          // é¦–é¡µæŒ‰é’®
        EntryPoint.shareExtension,      // åˆ†äº«æ‰©å±•
      ],
    ),
  ];

  /// åŸºäºç”¨æˆ·ä¹ æƒ¯ä¸ªæ€§åŒ–å¿«æ·æ“ä½œ
  Future<List<QuickAction>> getPersonalizedActions(String userId) async {
    final behavior = await _getBehaviorData(userId);

    // æŒ‰ä½¿ç”¨é¢‘ç‡æ’åº
    final sortedActions = List<QuickAction>.from(defaultActions);
    sortedActions.sort((a, b) {
      final freqA = behavior.getActionFrequency(a.id);
      final freqB = behavior.getActionFrequency(b.id);
      return freqB.compareTo(freqA);
    });

    // æœ€å¸¸ç”¨çš„3ä¸ªæ“ä½œæ”¾åœ¨æœ€å®¹æ˜“è§¦è¾¾çš„ä½ç½®
    return sortedActions.take(3).toList();
  }
}

/// å¿«æ·æ“ä½œå®šä¹‰
class QuickAction {
  final String id;
  final String name;
  final IconData icon;
  final int targetSteps;  // ç›®æ ‡æ­¥éª¤æ•°
  final List<EntryPoint> entryPoints;  // å¯ç”¨å…¥å£

  const QuickAction({
    required this.id,
    required this.name,
    required this.icon,
    required this.targetSteps,
    required this.entryPoints,
  });
}

/// å…¥å£ç±»å‹
enum EntryPoint {
  homeFloatingButton,  // é¦–é¡µæ‚¬æµ®æŒ‰é’®
  homeButton,          // é¦–é¡µæ™®é€šæŒ‰é’®
  homeLongPress,       // é¦–é¡µé•¿æŒ‰
  shakeToRecord,       // æ‘‡ä¸€æ‘‡
  widget,              // æ¡Œé¢å°ç»„ä»¶
  notification,        // é€šçŸ¥æ 
  voiceAssistant,      // è¯­éŸ³åŠ©æ‰‹
  shareExtension,      // åˆ†äº«æ‰©å±•
}
```

#### 3.5.2 æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦

```dart
/// æ‘‡ä¸€æ‘‡å¿«é€Ÿè®°è´¦æœåŠ¡
class ShakeToRecordService {
  final SensorService _sensorService;
  final QuickRecordService _quickRecord;
  final SharedPreferences _prefs;

  bool _isEnabled = true;
  bool _isRecording = false;

  /// åˆå§‹åŒ–æ‘‡ä¸€æ‘‡ç›‘å¬
  Future<void> initialize() async {
    _isEnabled = _prefs.getBool('shake_to_record_enabled') ?? true;

    if (_isEnabled) {
      await _startListening();
    }
  }

  Future<void> _startListening() async {
    _sensorService.accelerometerEvents.listen((event) {
      if (_isRecording) return;

      // æ£€æµ‹æ‘‡ä¸€æ‘‡æ‰‹åŠ¿
      final acceleration = sqrt(
        event.x * event.x + event.y * event.y + event.z * event.z
      );

      if (acceleration > 25) {  // é˜ˆå€¼ï¼Œå¯è°ƒèŠ‚
        _onShakeDetected();
      }
    });
  }

  void _onShakeDetected() async {
    if (_isRecording) return;
    _isRecording = true;

    // éœ‡åŠ¨åé¦ˆ
    HapticFeedback.mediumImpact();

    // æ‰“å¼€å¿«é€Ÿè®°è´¦ç•Œé¢
    await _quickRecord.showQuickRecordSheet();

    _isRecording = false;
  }
}

/// å¿«é€Ÿè®°è´¦æœåŠ¡
class QuickRecordService {
  final SmartDefaultValueService _defaults;

  /// æ˜¾ç¤ºå¿«é€Ÿè®°è´¦åº•éƒ¨å¼¹çª—
  Future<void> showQuickRecordSheet() async {
    // è·å–æ™ºèƒ½é»˜è®¤å€¼
    final location = await _getCurrentLocation();
    final defaults = await _defaults.getTransactionDefaults(
      type: TransactionType.expense,
      location: location,
    );

    // æ˜¾ç¤ºç®€åŒ–çš„è®°è´¦ç•Œé¢
    // åªéœ€è¾“å…¥é‡‘é¢ï¼Œå…¶ä»–å…¨éƒ¨æ™ºèƒ½å¡«å……
    await showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      builder: (context) => QuickRecordSheet(
        defaults: defaults,
        onSave: _saveTransaction,
      ),
    );
  }
}

/// å¿«é€Ÿè®°è´¦ç•Œé¢
class QuickRecordSheet extends StatefulWidget {
  final TransactionDefaults defaults;
  final Function(Transaction) onSave;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.all(16),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // å¤§å·é‡‘é¢è¾“å…¥æ¡†ï¼ˆä¸€æ­¥åˆ°ä½ï¼‰
          AmountInputField(
            autofocus: true,
            defaultValue: defaults.amount,
            onSubmitted: (amount) async {
              // å›è½¦å³ä¿å­˜
              final transaction = Transaction(
                amount: amount,
                categoryId: defaults.categoryId,
                accountId: defaults.accountId,
                date: DateTime.now(),
                type: TransactionType.expense,
                tags: defaults.tags,
              );
              await onSave(transaction);
              Navigator.pop(context);

              // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
              showSuccessToast('å·²è®°å½• Â¥$amount');
            },
          ),

          SizedBox(height: 8),

          // æ™ºèƒ½æ¨æ–­çš„ä¿¡æ¯ï¼ˆå¯ç‚¹å‡»ä¿®æ”¹ï¼‰
          Row(
            children: [
              if (defaults.categoryId != null)
                CategoryChip(
                  categoryId: defaults.categoryId!,
                  onTap: () => _showCategoryPicker(),
                ),
              Spacer(),
              if (defaults.confidence > 0.8)
                Text(
                  'æ™ºèƒ½å¡«å……',
                  style: TextStyle(color: Colors.grey, fontSize: 12),
                ),
            ],
          ),
        ],
      ),
    );
  }
}
```

### 3.6 å•æ‰‹æ“ä½œè®¾è®¡è§„èŒƒ

#### 3.6.1 æ‹‡æŒ‡çƒ­åŒºç†è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‹‡æŒ‡çƒ­åŒºåˆ†å¸ƒå›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           å›°éš¾åŒº (Hard to Reach)                    â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ ä»…æ”¾ç½®ä½é¢‘æˆ–è¾…åŠ©åŠŸèƒ½                           â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šè®¾ç½®ã€ä¸ªäººä¸­å¿ƒå…¥å£                         â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¯é€šè¿‡ä¸‹æ‹‰æ‰‹åŠ¿è§¦è¾¾                             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           èˆ’é€‚åŒº (Natural Reach)                    â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¾ç½®æŸ¥çœ‹ç±»åŠŸèƒ½ï¼ˆåªè¯»æ“ä½œï¼‰                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šä½™é¢æ˜¾ç¤ºã€é’±é¾„å¡ç‰‡ã€å›¾è¡¨åŒºåŸŸ               â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¯æŒç‚¹å‡»ä¸‹é’»                                   â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚  â˜…â˜…â˜…  é»„é‡‘åŒº (Easy Reach) â˜…â˜…â˜…                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ æ”¾ç½®æ‰€æœ‰æ ¸å¿ƒæ“ä½œæŒ‰é’®                           â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ å¦‚ï¼šè®°ä¸€ç¬”FABã€åº•éƒ¨å¯¼èˆªã€ç¡®è®¤æŒ‰é’®              â”‚   â”‚    â”‚
â”‚    â”‚  â”‚    â€¢ é«˜é¢‘æ“ä½œçš„è§¦å‘åŒºåŸŸ                             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚    â”‚  â”‚           åº•éƒ¨å¯¼èˆªåŒº (Navigation)                   â”‚   â”‚    â”‚
â”‚    â”‚  â”‚   [é¦–é¡µ]    [é¢„ç®—]    [æ´å¯Ÿ]    [è®¾ç½®]             â”‚   â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚    â”‚                                                             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.6.2 æ ¸å¿ƒåŠŸèƒ½å•æ‰‹æ“ä½œçŸ©é˜µ

| åŠŸèƒ½ | è§¦å‘æ–¹å¼ | çƒ­åŒºä½ç½® | æ‰‹åŠ¿æ”¯æŒ | å•æ‰‹å®Œæˆç‡ |
|------|----------|----------|----------|------------|
| **å¿«é€Ÿè®°è´¦** | ç‚¹å‡»FAB | é»„é‡‘åŒº(å³ä¸‹) | ç‚¹å‡» | 100% |
| **è¯­éŸ³è®°è´¦** | é•¿æŒ‰FAB | é»„é‡‘åŒº(å³ä¸‹) | é•¿æŒ‰ | 100% |
| **æŸ¥çœ‹ä½™é¢** | é¦–é¡µé¡¶éƒ¨ | èˆ’é€‚åŒº | æ— éœ€æ“ä½œ | 100% |
| **åˆ‡æ¢æ ‡ç­¾** | åº•éƒ¨å¯¼èˆª | é»„é‡‘åŒº | ç‚¹å‡» | 100% |
| **æŸ¥çœ‹é¢„ç®—** | ç‚¹å‡»é¢„ç®—å¡ç‰‡ | èˆ’é€‚åŒº | ç‚¹å‡» | 100% |
| **è¾“å…¥é‡‘é¢** | æ•°å­—é”®ç›˜ | é»„é‡‘åŒº(ä¸‹åŠå±) | ç‚¹å‡» | 100% |
| **é€‰æ‹©åˆ†ç±»** | åˆ†ç±»ç½‘æ ¼ | èˆ’é€‚åŒº~é»„é‡‘åŒº | ç‚¹å‡» | 100% |
| **ç¡®è®¤ä¿å­˜** | ç¡®è®¤æŒ‰é’® | é»„é‡‘åŒº(å³ä¸‹) | ç‚¹å‡» | 100% |
| **è¿”å›ä¸Šé¡µ** | å·¦æ»‘æ‰‹åŠ¿/è¿”å› | è¾¹ç¼˜æ»‘åŠ¨ | è¾¹ç¼˜æ»‘åŠ¨ | 100% |
| **ä¸‹æ‹‰åˆ·æ–°** | ä¸‹æ‹‰æ‰‹åŠ¿ | èˆ’é€‚åŒº | ä¸‹æ‹‰ | 100% |

#### 3.6.3 å•æ‰‹æ“ä½œè®¾è®¡å®ç°

```dart
/// å•æ‰‹æ“ä½œå¸ƒå±€åŠ©æ‰‹
class OneHandedLayoutHelper {
  /// æ ¹æ®å±å¹•å°ºå¯¸è®¡ç®—çƒ­åŒºè¾¹ç•Œ
  static ThumbZones calculateThumbZones(Size screenSize) {
    final height = screenSize.height;

    return ThumbZones(
      // é»„é‡‘åŒºï¼šå±å¹•ä¸‹æ–¹ 40%
      easyReach: Rect.fromLTRB(
        0,
        height * 0.60,
        screenSize.width,
        height,
      ),
      // èˆ’é€‚åŒºï¼šå±å¹•ä¸­é—´ 35%
      naturalReach: Rect.fromLTRB(
        0,
        height * 0.25,
        screenSize.width,
        height * 0.60,
      ),
      // å›°éš¾åŒºï¼šå±å¹•ä¸Šæ–¹ 25%
      hardToReach: Rect.fromLTRB(
        0,
        0,
        screenSize.width,
        height * 0.25,
      ),
    );
  }

  /// æ£€æŸ¥äº¤äº’å…ƒç´ æ˜¯å¦åœ¨åˆé€‚çš„çƒ­åŒº
  static ZoneComplianceResult checkElementPlacement({
    required Rect elementBounds,
    required InteractionFrequency frequency,
    required ThumbZones zones,
  }) {
    switch (frequency) {
      case InteractionFrequency.high:
        // é«˜é¢‘æ“ä½œå¿…é¡»åœ¨é»„é‡‘åŒº
        if (zones.easyReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.optimal;
        } else if (zones.naturalReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.acceptable;
        }
        return ZoneComplianceResult.violation;

      case InteractionFrequency.medium:
        // ä¸­é¢‘æ“ä½œåœ¨èˆ’é€‚åŒºæˆ–é»„é‡‘åŒºéƒ½å¯ä»¥
        if (zones.easyReach.overlaps(elementBounds) ||
            zones.naturalReach.overlaps(elementBounds)) {
          return ZoneComplianceResult.optimal;
        }
        return ZoneComplianceResult.acceptable;

      case InteractionFrequency.low:
        // ä½é¢‘æ“ä½œå¯ä»¥åœ¨ä»»ä½•åŒºåŸŸ
        return ZoneComplianceResult.optimal;
    }
  }
}

/// å•æ‰‹å‹å¥½çš„åº•éƒ¨å¼¹çª—
class OneHandedBottomSheet extends StatelessWidget {
  final Widget child;
  final String? title;
  final List<Widget>? actions;

  @override
  Widget build(BuildContext context) {
    return DraggableScrollableSheet(
      initialChildSize: 0.5,  // ä»å±å¹•ä¸‹åŠéƒ¨åˆ†å¼€å§‹
      minChildSize: 0.3,
      maxChildSize: 0.9,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // æ‹–æ‹½æŒ‡ç¤ºå™¨ï¼ˆä¾¿äºå•æ‰‹æ‹–åŠ¨ï¼‰
              Container(
                width: 40,
                height: 4,
                margin: EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  color: Theme.of(context).colorScheme.outline,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // æ ‡é¢˜åŒºåŸŸ
              if (title != null)
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  child: Text(title!, style: Theme.of(context).textTheme.titleLarge),
                ),
              // å†…å®¹åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  child: child,
                ),
              ),
              // æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆå›ºå®šåœ¨åº•éƒ¨é»„é‡‘åŒºï¼‰
              if (actions != null)
                SafeArea(
                  child: Padding(
                    padding: EdgeInsets.all(16),
                    child: Row(
                      children: actions!.map((action) =>
                        Expanded(child: Padding(
                          padding: EdgeInsets.symmetric(horizontal: 4),
                          child: action,
                        ))
                      ).toList(),
                    ),
                  ),
                ),
            ],
          ),
        );
      },
    );
  }
}

/// FAB å•æ‰‹æ“ä½œå¢å¼º
class EnhancedFAB extends StatelessWidget {
  final VoidCallback onTap;
  final VoidCallback onLongPress;
  final IconData icon;

  @override
  Widget build(BuildContext context) {
    return Positioned(
      // å›ºå®šåœ¨é»„é‡‘åŒºå³ä¸‹è§’
      right: 16,
      bottom: 16 + MediaQuery.of(context).padding.bottom + 60, // å¯¼èˆªæ ä¸Šæ–¹
      child: GestureDetector(
        onTap: onTap,           // ç‚¹å‡»ï¼šæ‰“å¼€è®°è´¦é¡µ
        onLongPress: onLongPress, // é•¿æŒ‰ï¼šè¯­éŸ³è®°è´¦
        child: Container(
          width: 56,
          height: 56,
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.primary,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 8,
                offset: Offset(0, 4),
              ),
            ],
          ),
          child: Icon(icon, color: Colors.white, size: 24),
        ),
      ),
    );
  }
}
```

#### 3.6.4 å•æ‰‹æ“ä½œé€‚é…åœºæ™¯

| åœºæ™¯ | è®¾è®¡æ–¹æ¡ˆ | å®ç°è¦ç‚¹ |
|------|----------|----------|
| **åœ°é“é€šå‹¤** | å•æ‰‹æ¡æŒï¼Œå¦ä¸€æ‰‹æ‰¶æ‰¶æ‰‹ | æ‰€æœ‰æ ¸å¿ƒæ“ä½œåœ¨æ‹‡æŒ‡è§¦è¾¾èŒƒå›´ |
| **æ­¥è¡Œè®°è´¦** | è¾¹èµ°è¾¹è®°ï¼Œéœ€è¦å¿«é€Ÿå®Œæˆ | è¯­éŸ³è®°è´¦ + å¤§æŒ‰é’® + è‡ªåŠ¨ä¿å­˜ |
| **èººç€ä½¿ç”¨** | å±å¹•æ—‹è½¬ï¼Œå•æ‰‹æ‰˜æŒ | æ”¯æŒæ¨ªå±ï¼ŒæŒ‰é’®å±…ä¸­ |
| **æ‹åŒ…è´­ç‰©** | ä¸€æ‰‹æ‹åŒ…ï¼Œä¸€æ‰‹æ“ä½œ | å¿«é€Ÿè®°è´¦ < 5ç§’å®Œæˆ |
| **æŠ±å­©å­** | ä»…ä¸€åªæ‰‹å¯ç”¨ | è¯­éŸ³ä¼˜å…ˆ + æœ€å°‘ç‚¹å‡» |

#### 3.6.5 å·¦å³æ‰‹é€‚é…

```dart
/// å·¦å³æ‰‹å¸ƒå±€é€‚é…
class HandedLayoutProvider extends InheritedWidget {
  final bool isLeftHanded;

  /// è·å–FABä½ç½®
  Alignment get fabAlignment =>
    isLeftHanded ? Alignment.bottomLeft : Alignment.bottomRight;

  /// è·å–æ»‘åŠ¨åˆ é™¤æ–¹å‘
  DismissDirection get dismissDirection =>
    isLeftHanded ? DismissDirection.startToEnd : DismissDirection.endToStart;

  /// è·å–è¿”å›æ‰‹åŠ¿è¾¹ç¼˜
  EdgeInsets get backGestureEdge =>
    isLeftHanded
      ? EdgeInsets.only(right: 20)
      : EdgeInsets.only(left: 20);

  /// é•œåƒç¿»è½¬å¸ƒå±€
  Widget mirrorIfNeeded(Widget child) {
    if (!isLeftHanded) return child;
    return Transform.flip(
      flipX: true,
      child: child,
    );
  }

  static HandedLayoutProvider of(BuildContext context) {
    return context.dependOnInheritedWidgetOfExactType<HandedLayoutProvider>()!;
  }

  @override
  bool updateShouldNotify(HandedLayoutProvider oldWidget) {
    return isLeftHanded != oldWidget.isLeftHanded;
  }
}
```

### 3.7 æ‡’äººè®¾è®¡æ£€æŸ¥æ¸…å•

åœ¨è®¾è®¡å’Œå¼€å‘æ¯ä¸ªåŠŸèƒ½æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ£€æŸ¥æ¸…å•ç¡®ä¿ç¬¦åˆæ‡’äººè®¾è®¡åŸåˆ™ï¼š

| æ£€æŸ¥é¡¹ | é—®é¢˜ | åˆæ ¼æ ‡å‡† |
|--------|------|----------|
| **æ“ä½œæ­¥éª¤** | å®Œæˆæ­¤æ“ä½œéœ€è¦å‡ æ­¥ï¼Ÿ | é«˜é¢‘æ“ä½œâ‰¤1æ­¥ï¼Œä¸­é¢‘â‰¤2æ­¥ï¼Œä½é¢‘â‰¤3æ­¥ |
| **é»˜è®¤å€¼** | æœ‰æ™ºèƒ½é»˜è®¤å€¼å—ï¼Ÿ | æ‰€æœ‰è¾“å…¥å­—æ®µéƒ½æœ‰åŸºäºæ•°æ®çš„é»˜è®¤å€¼ |
| **è‡ªåŠ¨å¡«å……** | èƒ½è‡ªåŠ¨å¡«å……å“ªäº›ä¿¡æ¯ï¼Ÿ | èƒ½æ¨æ–­çš„ä¿¡æ¯ç»ä¸è®©ç”¨æˆ·è¾“å…¥ |
| **ç¡®è®¤æ­¥éª¤** | éœ€è¦ç”¨æˆ·ç¡®è®¤å—ï¼Ÿ | ä½é£é™©æ“ä½œæ— éœ€ç¡®è®¤ï¼Œé«˜é£é™©æ‰éœ€è¦ |
| **æ’¤é”€èƒ½åŠ›** | èƒ½æ’¤é”€å—ï¼Ÿ | æ‰€æœ‰æ“ä½œéƒ½å¯æ’¤é”€ï¼Œå‡å°‘ç¡®è®¤æ­¥éª¤ |
| **æ‰¹é‡æ“ä½œ** | æ”¯æŒæ‰¹é‡å—ï¼Ÿ | é‡å¤æ“ä½œæ”¯æŒæ‰¹é‡å¤„ç† |
| **è®°å¿†èƒ½åŠ›** | è®°ä½ç”¨æˆ·é€‰æ‹©å—ï¼Ÿ | è®°ä½æ‰€æœ‰ç”¨æˆ·åå¥½å’Œå†å²é€‰æ‹© |
| **å¿«æ·å…¥å£** | æœ‰å¿«æ·å…¥å£å—ï¼Ÿ | é«˜é¢‘åŠŸèƒ½æœ‰å¤šç§å¿«æ·è§¦è¾¾æ–¹å¼ |
| **é”™è¯¯æ¢å¤** | å‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿ | æ™ºèƒ½çº é”™ï¼Œå®½å®¹è¾“å…¥ï¼Œæ˜“äºæ¢å¤ |
| **å­¦ä¹ æ›²çº¿** | æ–°ç”¨æˆ·èƒ½ç«‹å³ä½¿ç”¨å—ï¼Ÿ | é›¶é…ç½®å¯ç”¨ï¼Œé«˜çº§åŠŸèƒ½æ¸è¿›å±•å¼€ |

```dart
/// æ‡’äººè®¾è®¡åˆè§„æ£€æŸ¥å™¨
class LazyDesignComplianceChecker {
  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦ç¬¦åˆæ‡’äººè®¾è®¡åŸåˆ™
  ComplianceReport checkFeature(FeatureDesign design) {
    final issues = <ComplianceIssue>[];

    // æ£€æŸ¥æ“ä½œæ­¥éª¤
    if (design.frequency == Frequency.high && design.steps > 1) {
      issues.add(ComplianceIssue(
        severity: Severity.critical,
        message: 'é«˜é¢‘æ“ä½œ ${design.name} éœ€è¦ ${design.steps} æ­¥ï¼Œè¶…è¿‡ç›®æ ‡çš„ 1 æ­¥',
        suggestion: 'æ·»åŠ å¿«æ·å…¥å£æˆ–åˆå¹¶æ“ä½œæ­¥éª¤',
      ));
    }

    // æ£€æŸ¥é»˜è®¤å€¼
    for (final field in design.inputFields) {
      if (!field.hasSmartDefault) {
        issues.add(ComplianceIssue(
          severity: Severity.warning,
          message: 'å­—æ®µ ${field.name} æ²¡æœ‰æ™ºèƒ½é»˜è®¤å€¼',
          suggestion: 'åŸºäºå†å²æ•°æ®æˆ–ä¸Šä¸‹æ–‡æä¾›é»˜è®¤å€¼',
        ));
      }
    }

    // æ£€æŸ¥è‡ªåŠ¨å¡«å……
    for (final field in design.inputFields) {
      if (field.canBeInferred && !field.isAutoFilled) {
        issues.add(ComplianceIssue(
          severity: Severity.warning,
          message: 'å­—æ®µ ${field.name} å¯ä»¥æ¨æ–­ä½†æœªè‡ªåŠ¨å¡«å……',
          suggestion: 'å®ç°åŸºäº ${field.inferenceSource} çš„è‡ªåŠ¨å¡«å……',
        ));
      }
    }

    // æ£€æŸ¥æ’¤é”€èƒ½åŠ›
    if (!design.isUndoable && design.isDestructive) {
      issues.add(ComplianceIssue(
        severity: Severity.critical,
        message: 'ç ´åæ€§æ“ä½œ ${design.name} ä¸æ”¯æŒæ’¤é”€',
        suggestion: 'å®ç°æ’¤é”€åŠŸèƒ½æˆ–æ·»åŠ è½¯åˆ é™¤',
      ));
    }

    return ComplianceReport(
      feature: design.name,
      issues: issues,
      score: _calculateScore(issues),
      passed: issues.every((i) => i.severity != Severity.critical),
    );
  }
}
```

---


---

## 4. ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™

**"ä¼™ä¼´åŸåˆ™"** æ˜¯ AIæ™ºèƒ½è®°è´¦ 2.0 çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ã€‚æˆ‘ä»¬ç›¸ä¿¡ä¸€ä¸ªå¥½çš„è®°è´¦APPä¸åº”è¯¥åªæ˜¯å†·å†°å†°çš„å·¥å…·ï¼Œè€Œåº”è¯¥æˆä¸ºç”¨æˆ·ç†è´¢è·¯ä¸Šçš„ä¼™ä¼´å’ŒåŠ©æ‰‹ã€‚åœ¨æ¯ä¸€æ¬¡äº¤äº’ä¸­ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›è®©ç”¨æˆ·æ„Ÿå—åˆ°æ¸©åº¦ã€å…³å¿ƒå’Œæ”¯æŒã€‚

### 4.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥ä¼™ä¼´åŒ–è®¾è®¡ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¼™ä¼´åŒ–è®¾è®¡ - è®¾è®¡åŸåˆ™çŸ©é˜µ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æƒ…æ„Ÿå•ä¸€    â”‚  â”‚  æ–‡æ¡ˆä¸€è‡´    â”‚  â”‚  äº¤äº’æç®€    â”‚  â”‚  åœºæ™¯æ‰©å±•    â”‚       â”‚
â”‚  â”‚  èŒè´£       â”‚  â”‚  æ€§          â”‚  â”‚  è®¾è®¡       â”‚  â”‚  æ€§          â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æƒ…æ„ŸæœåŠ¡    â”‚  â”‚ ç»Ÿä¸€äººæ ¼    â”‚  â”‚ æœ€å°‘æ‰“æ‰°    â”‚  â”‚ å¯æ·»åŠ æ–°    â”‚       â”‚
â”‚  â”‚ ä¸“æ³¨å…³æ€€    â”‚  â”‚ è¯­æ°”ä¸€è‡´    â”‚  â”‚ ä¼˜é›…é™çº§    â”‚  â”‚ åœºæ™¯è§¦å‘    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ€§èƒ½ä¼˜åŒ–    â”‚  â”‚  å¯è§‚æµ‹æ€§    â”‚  â”‚  ç”¨æˆ·ä¸­å¿ƒ    â”‚  â”‚  éšç§è¾¹ç•Œ    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æ–‡æ¡ˆé¢„ç¼“å­˜  â”‚  â”‚ æƒ…æ„Ÿåé¦ˆ    â”‚  â”‚ å°Šé‡é€‰æ‹©    â”‚  â”‚ ä¸è¯„åˆ¤      â”‚       â”‚
â”‚  â”‚ ç¦»çº¿é™çº§    â”‚  â”‚ æ•ˆæœè¿½è¸ª    â”‚  â”‚ å¯è‡ªå®šä¹‰    â”‚  â”‚ ä¸è´©å–ç„¦è™‘  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  ä¼™ä¼´åŒ–è®¾è®¡æ ¸å¿ƒç†å¿µï¼š                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "æ¸©æš–ä¸æ‰“æ‰°ï¼Œå…³å¿ƒæœ‰è¾¹ç•Œï¼Œé¼“åŠ±è€Œéè¯´æ•™ï¼Œé™ªä¼´è€Œéæ§åˆ¶"                    â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   æ¸©æš– â”€â”€â†’ æ¯æ¬¡äº¤äº’ä¼ é€’å…³æ€€                                         â”‚   â”‚
â”‚  â”‚   ä¸æ‰“æ‰° â”€â”€â†’ æ§åˆ¶æ¶ˆæ¯é¢‘ç‡ï¼Œå°Šé‡ç”¨æˆ·æ³¨æ„åŠ›                            â”‚   â”‚
â”‚  â”‚   æœ‰è¾¹ç•Œ â”€â”€â†’ æ˜ç¡®ä»€ä¹ˆè¯¥åšä»€ä¹ˆä¸è¯¥åš                                  â”‚   â”‚
â”‚  â”‚   é¼“åŠ± â”€â”€â†’ æ­£å‘æ¿€åŠ±ï¼Œæ”¾å¤§è¿›æ­¥                                       â”‚   â”‚
â”‚  â”‚   é™ªä¼´ â”€â”€â†’ é•¿æœŸç¨³å®šçš„æƒ…æ„Ÿè¿æ¥                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.0.1 è®¾è®¡åŸåˆ™åœ¨ä¼™ä¼´åŒ–ä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | ä¼™ä¼´åŒ–åº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|-----------|---------|---------|
| **å•ä¸€èŒè´£** | æƒ…æ„ŸæœåŠ¡ç‹¬ç«‹ | CompanionServiceä¸“æ³¨æƒ…æ„Ÿäº¤äº’ | æœåŠ¡èŒè´£æ¸…æ™° |
| **æ•°æ®ä¸€è‡´æ€§** | äººæ ¼ç»Ÿä¸€ | ç»Ÿä¸€è¯­æ°”ã€ç§°å‘¼ã€è¡¨è¾¾é£æ ¼ | ç”¨æˆ·è®¤çŸ¥ä¸€è‡´ |
| **æç®€è®¾è®¡** | æœ€å°‘æ‰“æ‰° | æ¯æ¬¡â‰¤1æ¡ï¼Œæ¯æ—¥â‰¤3æ¡ | ç”¨æˆ·ä¸åŒçƒ¦ |
| **å¯æ‰©å±•æ€§** | åœºæ™¯å¯æ‰©å±• | æ’ä»¶åŒ–è§¦å‘å™¨ã€å¯é…ç½®æ–‡æ¡ˆ | æ˜“äºæ–°å¢åœºæ™¯ |
| **æ€§èƒ½ä¼˜åŒ–** | é¢„ç¼“å­˜æœºåˆ¶ | ç¦»çº¿æ–‡æ¡ˆåº“ã€LLMé¢„ç”Ÿæˆ | å“åº”<100ms |
| **å¯è§‚æµ‹æ€§** | æ•ˆæœè¿½è¸ª | æ¶ˆæ¯å±•ç¤ºç‡ã€ç‚¹å‡»ç‡ã€å…³é—­ç‡ | æŒç»­ä¼˜åŒ–ä¾æ® |

#### 4.0.2 ä¸å…¶ä»–2.0æ¨¡å—çš„åä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¼™ä¼´åŒ–ç³»ç»Ÿåä½œå…¨æ™¯å›¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                        â”‚   ä¼™ä¼´åŒ–æœåŠ¡     â”‚                                 â”‚
â”‚                        â”‚ CompanionServiceâ”‚                                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                 â”‚                                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚           â”‚                     â”‚                     â”‚                    â”‚
â”‚           â–¼                     â–¼                     â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    è§¦å‘ç³»ç»Ÿ      â”‚  â”‚    æ–‡æ¡ˆç³»ç»Ÿ      â”‚  â”‚    å‘ˆç°ç³»ç»Ÿ      â”‚            â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚            â”‚
â”‚  â”‚ â€¢ åœºæ™¯æ£€æµ‹      â”‚  â”‚ â€¢ LLMç”Ÿæˆ       â”‚  â”‚ â€¢ å¡ç‰‡ç»„ä»¶      â”‚            â”‚
â”‚  â”‚ â€¢ æ—¶æœºåˆ¤æ–­      â”‚  â”‚ â€¢ æ¨¡æ¿å¡«å……      â”‚  â”‚ â€¢ Toastæç¤º     â”‚            â”‚
â”‚  â”‚ â€¢ é¢‘ç‡æ§åˆ¶      â”‚  â”‚ â€¢ å˜ä½“è½®æ¢      â”‚  â”‚ â€¢ å¼¹çª—åŠ¨ç”»      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                     â”‚                     â”‚                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                 â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                       æ•°æ®æ¥æºç³»ç»Ÿ                            â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚                                                              â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚
â”‚  â”‚  â”‚ é’±é¾„ç³»ç»Ÿ  â”‚ â”‚ é¢„ç®—ç³»ç»Ÿ  â”‚ â”‚ äº¤æ˜“ç³»ç»Ÿ  â”‚ â”‚ ç”¨æˆ·è¡Œä¸º  â”‚        â”‚           â”‚
â”‚  â”‚  â”‚          â”‚ â”‚          â”‚ â”‚          â”‚ â”‚          â”‚        â”‚           â”‚
â”‚  â”‚  â”‚ é’±é¾„å˜åŒ–  â”‚ â”‚ é¢„ç®—çŠ¶æ€  â”‚ â”‚ è®°è´¦é¢‘ç‡  â”‚ â”‚ ä½¿ç”¨æ—¶é•¿  â”‚        â”‚           â”‚
â”‚  â”‚  â”‚ è¶‹åŠ¿æ–¹å‘  â”‚ â”‚ è¶…æ”¯é¢„è­¦  â”‚ â”‚ æ¶ˆè´¹æ¨¡å¼  â”‚ â”‚ æ´»è·ƒå¤©æ•°  â”‚        â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚           â”‚
â”‚  â”‚                                                              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.1 è®¾è®¡ç†å¿µ

#### 4.1.1 æ ¸å¿ƒä»·å€¼è§‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¼™ä¼´åŒ–è®¾è®¡æ ¸å¿ƒä»·å€¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     å…³å¿ƒ        â”‚  â”‚     å…±æƒ…        â”‚  â”‚     é¼“åŠ±        â”‚        â”‚
â”‚  â”‚   Caring        â”‚  â”‚   Empathy       â”‚  â”‚ Encouragement   â”‚        â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚        â”‚
â”‚  â”‚ ä¸»åŠ¨å…³æ³¨ç”¨æˆ·    â”‚  â”‚ ç†è§£ç”¨æˆ·å¤„å¢ƒ    â”‚  â”‚ æ­£å‘æ¿€åŠ±è¿›æ­¥    â”‚        â”‚
â”‚  â”‚ çš„è´¢åŠ¡çŠ¶æ€      â”‚  â”‚ ç»™äºˆæƒ…æ„Ÿæ”¯æŒ    â”‚  â”‚ åº†ç¥æ¯ä¸ªæˆå°±    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     å®½å®¹        â”‚  â”‚     é™ªä¼´        â”‚  â”‚     æˆé•¿        â”‚        â”‚
â”‚  â”‚  Forgiveness    â”‚  â”‚ Companionship   â”‚  â”‚    Growth       â”‚        â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚        â”‚
â”‚  â”‚ å¯¹å¤±è¯¯åŒ…å®¹      â”‚  â”‚ é•¿æœŸé™ªä¼´ç”¨æˆ·    â”‚  â”‚ ä¸ç”¨æˆ·å…±åŒ      â”‚        â”‚
â”‚  â”‚ å¸®åŠ©æ”¹æ­£        â”‚  â”‚ å»ºç«‹ä¿¡ä»»å…³ç³»    â”‚  â”‚ è¿›æ­¥æˆé•¿        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 äººæ€§ç‰¹è´¨ä½“ç°

| ç‰¹è´¨ | æè¿° | åº”ç”¨åœºæ™¯ | ç¤ºä¾‹æ–‡æ¡ˆ |
|------|------|----------|----------|
| **å…³å¿ƒ** | ä¸»åŠ¨å…³æ³¨ç”¨æˆ·çŠ¶æ€ | å¼‚å¸¸æ¶ˆè´¹æé†’ã€é’±é¾„ä¸‹é™é€šçŸ¥ | "ä»Šå¤©èŠ±å¾—æ¯”å¹³æ—¶å¤šï¼Œä¸€åˆ‡è¿˜å¥½å—ï¼Ÿ" |
| **å…±æƒ…** | ç†è§£ç”¨æˆ·æƒ…ç»ª | è¶…æ”¯æ—¶çš„å®‰æ…°ã€ç›®æ ‡æœªè¾¾æˆæ—¶ | "å¶å°”è¶…æ”¯å¾ˆæ­£å¸¸ï¼Œæˆ‘ä»¬ä¸€èµ·è°ƒæ•´" |
| **é¼“åŠ±** | æ­£å‘æ¿€åŠ± | è¾¾æˆç›®æ ‡ã€åšæŒè®°è´¦ | "è¿ç»­è®°è´¦7å¤©ï¼ä½ çœŸçš„å¾ˆæ£’" |
| **å–„è‰¯** | æ¸©å’Œå‹å–„ | æ‰€æœ‰äº¤äº’åœºæ™¯ | ä½¿ç”¨æ¸©æš–çš„æªè¾ï¼Œé¿å…æŒ‡è´£ |
| **æ„Ÿæ©** | æ„Ÿè°¢ç”¨æˆ· | ä½¿ç”¨é‡Œç¨‹ç¢‘ã€åé¦ˆæäº¤å | "æ„Ÿè°¢ä½ é™ªä¼´æˆ‘ä»¬æˆé•¿" |
| **å®½å®¹** | åŒ…å®¹å¤±è¯¯ | æ¼è®°ã€è¯¯åˆ ã€è¶…æ”¯ | "æ²¡å…³ç³»ï¼Œéšæ—¶å¯ä»¥è¡¥è®°" |
| **å¿ è¯š** | å§‹ç»ˆå¦‚ä¸€ | é•¿æœŸä½¿ç”¨ | "ä¸€è·¯èµ°æ¥ï¼Œæ„Ÿè°¢æœ‰ä½ " |
| **å¥½å¥‡** | æ¢ç´¢ç²¾ç¥ | å¼•å¯¼æ–°åŠŸèƒ½ | "æƒ³ä¸æƒ³çœ‹çœ‹è¿™ä¸ªæœˆçš„æœ‰è¶£å‘ç°ï¼Ÿ" |
| **è‡ªå°Š** | å°Šé‡ç”¨æˆ· | è´¢åŠ¡éšç§ã€æ•æ„Ÿæ•°æ® | ç»ä¸è¯„åˆ¤ç”¨æˆ·çš„æ¶ˆè´¹é€‰æ‹© |

### 4.2 åŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿ

#### 4.2.1 æ–‡æ¡ˆç”Ÿæˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åŠ¨æ€æ–‡æ¡ˆç”Ÿæˆç³»ç»Ÿ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  åœºæ™¯è¯†åˆ«å™¨   â”‚â”€â”€â”€â†’â”‚  æƒ…æ„Ÿåˆ†æå™¨   â”‚â”€â”€â”€â†’â”‚  æ–‡æ¡ˆç”Ÿæˆå™¨   â”‚             â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚             â”‚
â”‚  â”‚ â€¢ æ—¶é—´ä¸Šä¸‹æ–‡  â”‚    â”‚ â€¢ ç”¨æˆ·æƒ…ç»ª    â”‚    â”‚ â€¢ å¤§æ¨¡å‹ç”Ÿæˆ  â”‚             â”‚
â”‚  â”‚ â€¢ è´¢åŠ¡çŠ¶æ€   â”‚    â”‚ â€¢ å†å²æ¨¡å¼    â”‚    â”‚ â€¢ æ¨¡æ¿å¡«å……    â”‚             â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·è¡Œä¸º   â”‚    â”‚ â€¢ æ•æ„Ÿåº¦çº§åˆ«  â”‚    â”‚ â€¢ å˜ä½“è½®æ¢    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚          â”‚                  â”‚                  â”‚                      â”‚
â”‚          â–¼                  â–¼                  â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                      æ–‡æ¡ˆç¼“å­˜æ±                               â”‚       â”‚
â”‚  â”‚  â€¢ é¢„ç”Ÿæˆæ–‡æ¡ˆåº“ï¼ˆç¦»çº¿å¯ç”¨ï¼‰                                   â”‚       â”‚
â”‚  â”‚  â€¢ å®æ—¶ç”Ÿæˆé˜Ÿåˆ—ï¼ˆåœ¨çº¿å¢å¼ºï¼‰                                   â”‚       â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åå¥½å­¦ä¹                                               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 æ–‡æ¡ˆç”ŸæˆæœåŠ¡å®ç°

```dart
/// ä¼™ä¼´åŒ–æ–‡æ¡ˆç”ŸæˆæœåŠ¡
class CompanionCopywritingService {
  final LLMService _llmService;
  final UserContextService _userContext;
  final CopywritingCache _cache;

  /// åœºæ™¯ç±»å‹å®šä¹‰
  static const Map<CopyScene, SceneConfig> sceneConfigs = {
    CopyScene.greeting: SceneConfig(
      emotions: [Emotion.warm, Emotion.friendly],
      cacheHours: 1,
      variants: 10,
    ),
    CopyScene.achievementCelebration: SceneConfig(
      emotions: [Emotion.excited, Emotion.proud],
      cacheHours: 24,
      variants: 20,
    ),
    CopyScene.overspendComfort: SceneConfig(
      emotions: [Emotion.understanding, Emotion.supportive],
      cacheHours: 12,
      variants: 15,
    ),
    CopyScene.reminderNudge: SceneConfig(
      emotions: [Emotion.gentle, Emotion.caring],
      cacheHours: 6,
      variants: 10,
    ),
  };

  /// è·å–åœºæ™¯æ–‡æ¡ˆ
  Future<String> getCopy({
    required CopyScene scene,
    Map<String, dynamic>? context,
    bool forceRefresh = false,
  }) async {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    if (!forceRefresh) {
      final cached = await _cache.getRandomVariant(scene, context);
      if (cached != null) return cached;
    }

    // 2. æ„å»ºä¸Šä¸‹æ–‡
    final userContext = await _buildUserContext(context);

    // 3. ç”Ÿæˆæ–‡æ¡ˆ
    final copy = await _generateCopy(scene, userContext);

    // 4. ç¼“å­˜ç»“æœ
    await _cache.store(scene, copy, context);

    return copy;
  }

  /// æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
  Future<Map<String, dynamic>> _buildUserContext(Map<String, dynamic>? extra) async {
    final user = await _userContext.getCurrentUser();
    return {
      'userName': user.nickname ?? 'æœ‹å‹',
      'timeOfDay': _getTimeOfDay(),
      'dayOfWeek': DateTime.now().weekday,
      'usageDays': user.registrationDays,
      'currentMoneyAge': await _userContext.getMoneyAge(),
      'budgetStatus': await _userContext.getBudgetStatus(),
      'recentMood': await _userContext.inferMood(),
      ...?extra,
    };
  }

  /// ç”Ÿæˆæ–‡æ¡ˆï¼ˆè°ƒç”¨å¤§æ¨¡å‹ï¼‰
  Future<String> _generateCopy(CopyScene scene, Map<String, dynamic> context) async {
    final config = sceneConfigs[scene]!;
    final prompt = _buildPrompt(scene, context, config);

    try {
      final response = await _llmService.generate(
        prompt: prompt,
        maxTokens: 100,
        temperature: 0.8,
      );
      return _postProcess(response, scene);
    } catch (e) {
      return _getFallbackCopy(scene, context);
    }
  }

  /// æ„å»ºç”Ÿæˆæç¤ºè¯
  String _buildPrompt(CopyScene scene, Map<String, dynamic> context, SceneConfig config) {
    return '''
ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€å‹å–„çš„ç†è´¢åŠ©æ‰‹ã€‚è¯·ä¸ºä»¥ä¸‹åœºæ™¯ç”Ÿæˆä¸€å¥ç®€çŸ­çš„é—®å€™/æç¤ºè¯­ã€‚

åœºæ™¯ï¼š${scene.description}
ç”¨æˆ·æ˜µç§°ï¼š${context['userName']}
æ—¶é—´ï¼š${context['timeOfDay']}
ä½¿ç”¨å¤©æ•°ï¼š${context['usageDays']}å¤©
æƒ…æ„ŸåŸºè°ƒï¼š${config.emotions.map((e) => e.label).join('ã€')}

è¦æ±‚ï¼š
1. è¯­æ°”æ¸©æš–å‹å–„ï¼Œåƒæœ‹å‹ä¸€æ ·
2. ç®€çŸ­æœ‰åŠ›ï¼Œä¸è¶…è¿‡30ä¸ªå­—
3. é€‚å½“ä½¿ç”¨emojiå¢åŠ äº²å’ŒåŠ›
4. é¿å…è¯´æ•™ï¼Œä¸è¦æŒ‡è´£ç”¨æˆ·
5. å±•ç°å…³å¿ƒå’Œç†è§£

è¯·ç›´æ¥è¾“å‡ºæ–‡æ¡ˆï¼Œä¸éœ€è¦è§£é‡Šã€‚
''';
  }

  /// è·å–é—®å€™æ—¶æ®µ
  String _getTimeOfDay() {
    final hour = DateTime.now().hour;
    if (hour < 6) return 'å‡Œæ™¨';
    if (hour < 9) return 'æ—©ä¸Š';
    if (hour < 12) return 'ä¸Šåˆ';
    if (hour < 14) return 'ä¸­åˆ';
    if (hour < 18) return 'ä¸‹åˆ';
    if (hour < 22) return 'æ™šä¸Š';
    return 'æ·±å¤œ';
  }

  /// é™çº§æ–‡æ¡ˆæ¨¡æ¿
  static const Map<CopyScene, List<String>> _fallbackTemplates = {
    CopyScene.greeting: [
      '{timeOfDay}å¥½ï¼Œ{userName} ğŸ‘‹',
      'å—¨ï¼Œ{userName}ï¼Œä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ',
      '{userName}ï¼Œåˆè§é¢å•¦ â˜€ï¸',
      'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼',
    ],
    CopyScene.achievementCelebration: [
      'å¤ªæ£’äº†ï¼{userName}ï¼Œä½ åšåˆ°äº†ï¼ğŸ‰',
      'æ­å–œè¾¾æˆç›®æ ‡ï¼ç»§ç»­åŠ æ²¹ï¼âœ¨',
      'äº†ä¸èµ·ï¼è¿™å°±æ˜¯åšæŒçš„åŠ›é‡ ğŸ’ª',
      'ä¸ºä½ éª„å‚²ï¼Œ{userName}ï¼ğŸŒŸ',
    ],
    CopyScene.overspendComfort: [
      'æ²¡å…³ç³»ï¼Œå¶å°”è¶…æ”¯å¾ˆæ­£å¸¸',
      'åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¸€èµ·æƒ³åŠæ³•',
      'ç”Ÿæ´»æ€»æœ‰æ„å¤–ï¼Œè°ƒæ•´ä¸€ä¸‹å°±å¥½',
      'è¿™ä¸ªæœˆè¾›è‹¦äº†ï¼Œä¸‹ä¸ªæœˆç»§ç»­åŠªåŠ›',
    ],
    CopyScene.reminderNudge: [
      'ä»Šå¤©è®°è´¦äº†å—ï¼Ÿåªéœ€è¦å‡ ç§’é’Ÿ',
      'åˆ«å¿˜äº†è®°å½•ä»Šå¤©çš„èŠ±é”€å“¦',
      'å…»æˆå¥½ä¹ æƒ¯ï¼Œä»æ¯å¤©è®°è´¦å¼€å§‹',
      'å¿«æ¥è®°ä¸€ç¬”å§ï¼Œæˆ‘ç­‰ä½ å“¦',
    ],
  };

  /// è·å–é™çº§æ–‡æ¡ˆ
  String _getFallbackCopy(CopyScene scene, Map<String, dynamic> context) {
    final templates = _fallbackTemplates[scene]!;
    final template = templates[DateTime.now().millisecond % templates.length];
    return _fillTemplate(template, context);
  }

  /// å¡«å……æ¨¡æ¿å˜é‡
  String _fillTemplate(String template, Map<String, dynamic> context) {
    var result = template;
    context.forEach((key, value) {
      result = result.replaceAll('{$key}', value.toString());
    });
    return result;
  }
}

/// åœºæ™¯æšä¸¾
enum CopyScene {
  greeting('æ—¥å¸¸é—®å€™'),
  achievementCelebration('æˆå°±åº†ç¥'),
  overspendComfort('è¶…æ”¯å®‰æ…°'),
  reminderNudge('è®°è´¦æé†’'),
  budgetWarning('é¢„ç®—é¢„è­¦'),
  moneyAgeImproved('é’±é¾„æå‡'),
  streakContinued('è¿ç»­è®°è´¦'),
  firstTimeUser('æ–°ç”¨æˆ·æ¬¢è¿'),
  returnUser('å›å½’ç”¨æˆ·'),
  milestoneReached('é‡Œç¨‹ç¢‘è¾¾æˆ');

  final String description;
  const CopyScene(this.description);
}

/// æƒ…æ„Ÿæšä¸¾
enum Emotion {
  warm('æ¸©æš–'),
  friendly('å‹å–„'),
  excited('å…´å¥‹'),
  proud('è‡ªè±ª'),
  understanding('ç†è§£'),
  supportive('æ”¯æŒ'),
  gentle('æ¸©å’Œ'),
  caring('å…³å¿ƒ');

  final String label;
  const Emotion(this.label);
}
```

### 4.3 åœºæ™¯åŒ–æƒ…æ„Ÿäº¤äº’

#### 4.3.1 å…³é”®åœºæ™¯æƒ…æ„Ÿè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åœºæ™¯åŒ–æƒ…æ„Ÿäº¤äº’åœ°å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  æ­£é¢åœºæ™¯ (+)                        è´Ÿé¢åœºæ™¯ (-)                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚                                                                        â”‚
â”‚  ğŸ‰ è¾¾æˆé¢„ç®—ç›®æ ‡                      ğŸ˜” é¢„ç®—è¶…æ”¯                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: åº†ç¥ã€è‡ªè±ª     â”‚             â”‚ æƒ…æ„Ÿ: ç†è§£ã€æ”¯æŒ     â”‚           â”‚
â”‚  â”‚ "å¤ªå‰å®³äº†ï¼è¿™ä¸ªæœˆ    â”‚             â”‚ "æ²¡å…³ç³»ï¼Œç”Ÿæ´»æ€»æœ‰    â”‚           â”‚
â”‚  â”‚  ä½ å®ˆä½äº†é¢„ç®—ï¼"    â”‚             â”‚  æ„å¤–æ”¯å‡ºï¼Œä¸‹ä¸ªæœˆ    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  æˆ‘ä»¬ä¸€èµ·è°ƒæ•´"      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ“ˆ é’±é¾„æå‡                          ğŸ“‰ é’±é¾„ä¸‹é™                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: é¼“åŠ±ã€æ¬£æ…°     â”‚             â”‚ æƒ…æ„Ÿ: å…³å¿ƒã€æé†’     â”‚           â”‚
â”‚  â”‚ "ä½ çš„ç†è´¢ä¹ æƒ¯è¶Šæ¥    â”‚             â”‚ "æœ€è¿‘èŠ±é”€æœ‰ç‚¹å¤§ï¼Œ    â”‚           â”‚
â”‚  â”‚  è¶Šå¥½äº†ï¼Œé’±é¾„æå‡    â”‚             â”‚  è¦ä¸è¦çœ‹çœ‹å“ªé‡Œå¯    â”‚           â”‚
â”‚  â”‚  åˆ°äº†28å¤©ï¼"        â”‚             â”‚  ä»¥ä¼˜åŒ–ï¼Ÿ"          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ”¥ è¿ç»­è®°è´¦                          ğŸ˜´ æ–­ç­¾/æ¼è®°                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: èµèµã€æ¿€åŠ±     â”‚             â”‚ æƒ…æ„Ÿ: å®½å®¹ã€é‚€è¯·     â”‚           â”‚
â”‚  â”‚ "è¿ç»­è®°è´¦14å¤©ï¼      â”‚             â”‚ "å¥½ä¹…ä¸è§ï¼Œä¸€åˆ‡     â”‚           â”‚
â”‚  â”‚  åšæŒå°±æ˜¯èƒœåˆ© ğŸ’ª"   â”‚             â”‚  è¿˜å¥½å—ï¼Ÿéšæ—¶æ¬¢è¿    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  å›æ¥è®°å½•"          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â”‚  ğŸ¯ å‚¨è“„ç›®æ ‡è¾¾æˆ                      â° è´¦å•å³å°†åˆ°æœŸ                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æƒ…æ„Ÿ: å…´å¥‹ã€åº†è´º     â”‚             â”‚ æƒ…æ„Ÿ: è´´å¿ƒã€æé†’     â”‚           â”‚
â”‚  â”‚ "æ¢¦æƒ³åŸºé‡‘å­˜æ»¡å•¦ï¼    â”‚             â”‚ "æ¸©é¦¨æç¤ºï¼šä¿¡ç”¨å¡    â”‚           â”‚
â”‚  â”‚  æ˜¯æ—¶å€™å¥–åŠ±è‡ªå·±äº†"  â”‚             â”‚  è¿˜æ¬¾æ—¥å¿«åˆ°äº†ï¼Œåˆ«    â”‚           â”‚
â”‚  â”‚                     â”‚             â”‚  å¿˜äº†å“¦ ğŸ’³"         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.2 æƒ…æ„Ÿäº¤äº’ç»„ä»¶

```dart
/// æƒ…æ„ŸåŒ–æ¶ˆæ¯å¡ç‰‡
class CompanionMessageCard extends StatelessWidget {
  final String message;
  final CompanionMood mood;
  final VoidCallback? onDismiss;
  final VoidCallback? onAction;
  final String? actionLabel;

  const CompanionMessageCard({
    required this.message,
    required this.mood,
    this.onDismiss,
    this.onAction,
    this.actionLabel,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.all(16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: mood.gradientColors,
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: mood.primaryColor.withOpacity(0.3),
            blurRadius: 12,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        children: [
          CompanionAvatar(mood: mood, size: 40),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(
                color: Colors.white,
                fontSize: 15,
                height: 1.4,
              ),
            ),
          ),
          if (onDismiss != null)
            IconButton(
              icon: const Icon(Icons.close, color: Colors.white70),
              onPressed: onDismiss,
            ),
        ],
      ),
    );
  }
}

/// ä¼™ä¼´å¿ƒæƒ…æšä¸¾
enum CompanionMood {
  happy([Color(0xFF4CAF50), Color(0xFF8BC34A)], 'ğŸ˜Š'),
  excited([Color(0xFFFF9800), Color(0xFFFFB74D)], 'ğŸ‰'),
  caring([Color(0xFF2196F3), Color(0xFF64B5F6)], 'ğŸ¤—'),
  supportive([Color(0xFF9C27B0), Color(0xFFBA68C8)], 'ğŸ’œ'),
  gentle([Color(0xFF607D8B), Color(0xFF90A4AE)], 'ğŸ˜Œ');

  final List<Color> gradientColors;
  final String emoji;
  const CompanionMood(this.gradientColors, this.emoji);
  Color get primaryColor => gradientColors.first;
}

/// ä¼™ä¼´å¤´åƒç»„ä»¶
class CompanionAvatar extends StatelessWidget {
  final CompanionMood mood;
  final double size;

  const CompanionAvatar({required this.mood, this.size = 48});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: size,
      height: size,
      decoration: const BoxDecoration(
        color: Colors.white,
        shape: BoxShape.circle,
      ),
      child: Center(
        child: Text(mood.emoji, style: TextStyle(fontSize: size * 0.5)),
      ),
    );
  }
}
```

### 4.4 æ™ºèƒ½æ—¶æœºè§¦å‘

#### 4.4.1 è§¦å‘æ—¶æœºçŸ©é˜µ

| è§¦å‘åœºæ™¯ | æ£€æµ‹æ¡ä»¶ | æƒ…æ„ŸåŸºè°ƒ | äº¤äº’æ–¹å¼ |
|----------|----------|----------|----------|
| **æ—©å®‰é—®å€™** | å½“å¤©é¦–æ¬¡æ‰“å¼€APP (6:00-10:00) | æ¸©æš–ã€æ´»åŠ› | é¦–é¡µé¡¶éƒ¨å¡ç‰‡ |
| **æ™šé—´æ€»ç»“** | æ™šä¸Šæ‰“å¼€APP (20:00-23:00) | å…³å¿ƒã€å›é¡¾ | å¼¹çª—æˆ–å¡ç‰‡ |
| **è®°è´¦é¼“åŠ±** | å®Œæˆä¸€ç¬”è®°è´¦å | è®¤å¯ã€æ„Ÿè°¢ | è½»é‡Toast |
| **è¿ç»­æ‰“å¡** | è¿ç»­Nå¤©è®°è´¦ | åº†ç¥ã€æ¿€åŠ± | æˆå°±å¼¹çª— |
| **é¢„ç®—é¢„è­¦** | é¢„ç®—ä½¿ç”¨è¶…80% | æé†’ã€æ”¯æŒ | é€šçŸ¥+å¡ç‰‡ |
| **é¢„ç®—è¾¾æˆ** | æœˆæœ«é¢„ç®—å†…å®Œæˆ | åº†ç¥ã€è‡ªè±ª | æˆå°±å¼¹çª— |
| **é’±é¾„å˜åŒ–** | é’±é¾„æ˜¾è‘—å˜åŒ– | é¼“åŠ±/å…³å¿ƒ | é¦–é¡µå¡ç‰‡ |
| **å›å½’æ¬¢è¿** | è¶…è¿‡3å¤©æœªä½¿ç”¨ | æ¸©æš–ã€ä¸è´£å¤‡ | æ¬¢è¿å¼¹çª— |
| **ç‰¹æ®Šæ—¥æœŸ** | ç”Ÿæ—¥/çºªå¿µæ—¥/èŠ‚æ—¥ | ç¥ç¦ã€æƒŠå–œ | ç‰¹æ®ŠåŠ¨ç”» |
| **é‡Œç¨‹ç¢‘** | ä½¿ç”¨100å¤©/1000ç¬” | æ„Ÿæ©ã€å›é¡¾ | é‡Œç¨‹ç¢‘é¡µé¢ |

### 4.5 ä¼™ä¼´äººæ ¼è®¾è®¡

#### 4.5.1 äººæ ¼ç‰¹è´¨å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç†è´¢ä¼™ä¼´äººæ ¼ç”»åƒ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  åç§°ï¼šå°è´¦ï¼ˆå¯ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼‰                                           â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚    ğŸ˜Š        â”‚  æ ¸å¿ƒäººæ ¼ç‰¹è´¨ï¼š                                       â”‚
â”‚  â”‚   å°è´¦       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”‚              â”‚  â€¢ æ¸©æš–ä½“è´´ï¼šåƒè€æœ‹å‹ä¸€æ ·å…³å¿ƒä½                         â”‚
â”‚  â”‚  ä½ çš„ç†è´¢    â”‚  â€¢ è€å¿ƒç»†è‡´ï¼šç»ä¸å‚¬ä¿ƒï¼Œç»ä¸è´£å¤‡                        â”‚
â”‚  â”‚  å°ä¼™ä¼´      â”‚  â€¢ ä¹è§‚ç§¯æï¼šæ€»èƒ½çœ‹åˆ°å¥½çš„ä¸€é¢                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ ä¸“ä¸šå¯é ï¼šåœ¨ç†è´¢é—®é¢˜ä¸Šç»™å‡ºé è°±å»ºè®®                  â”‚
â”‚                    â€¢ å¹½é»˜é£è¶£ï¼šå¶å°”è®²è®²ç†è´¢å°æ®µå­                        â”‚
â”‚                    â€¢ å°Šé‡éšç§ï¼šç»ä¸è¯„åˆ¤ä½ çš„æ¶ˆè´¹é€‰æ‹©                      â”‚
â”‚                                                                        â”‚
â”‚  æ²Ÿé€šé£æ ¼ï¼š                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  â€¢ è¯­æ°”ï¼šäº²åˆ‡ã€è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©                                         â”‚
â”‚  â€¢ ç§°å‘¼ï¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„æ˜µç§°ï¼Œé»˜è®¤"ä½ "                                   â”‚
â”‚  â€¢ è¡¨è¾¾ï¼šç®€æ´æ˜äº†ï¼Œé€‚åº¦ä½¿ç”¨emoji                                        â”‚
â”‚  â€¢ ç¦å¿Œï¼šä¸è¯´æ•™ã€ä¸æŒ‡è´£ã€ä¸æ¯”è¾ƒã€ä¸è´©å–ç„¦è™‘                             â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.2 è¯­è¨€é£æ ¼æŒ‡å—

| åœºæ™¯ | æ¨èè¡¨è¾¾ | é¿å…è¡¨è¾¾ |
|------|----------|----------|
| **è¶…æ”¯æé†’** | "è¿™ä¸ªæœˆèŠ±å¾—æœ‰ç‚¹å¤šï¼Œè¦ä¸è¦ä¸€èµ·çœ‹çœ‹ï¼Ÿ" | "ä½ åˆè¶…æ”¯äº†ï¼" |
| **æ¼è®°æé†’** | "å¥½å‡ å¤©æ²¡è§ä½ äº†ï¼Œä¸€åˆ‡è¿˜å¥½å—ï¼Ÿ" | "ä½ å·²ç»3å¤©æ²¡è®°è´¦äº†" |
| **é¢„ç®—å»ºè®®** | "æ ¹æ®ä½ çš„æƒ…å†µï¼Œå»ºè®®è¯•è¯•..." | "ä½ åº”è¯¥è¿™æ ·åš..." |
| **æˆå°±åº†ç¥** | "å¤ªæ£’äº†ï¼è¿™éƒ½æ˜¯ä½ åŠªåŠ›çš„ç»“æœ" | "ç»ˆäºåšåˆ°äº†" |
| **é”™è¯¯æ“ä½œ** | "æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æ’¤é”€" | "ä½ æ“ä½œé”™è¯¯äº†" |
| **å¼•å¯¼ä½¿ç”¨** | "æƒ³ä¸æƒ³è¯•è¯•è¿™ä¸ªæ–°åŠŸèƒ½ï¼Ÿ" | "ä½ åº”è¯¥ç”¨è¿™ä¸ªåŠŸèƒ½" |

### 4.6 éšç§ä¸è¾¹ç•Œ

#### 4.6.1 ä¼™ä¼´åŒ–è®¾è®¡çš„è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¼™ä¼´åŒ–è®¾è®¡è¾¹ç•ŒåŸåˆ™                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  âœ… åº”è¯¥åšçš„                          âŒ ä¸åº”è¯¥åšçš„                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚                                                                        â”‚
â”‚  â€¢ å…³å¿ƒç”¨æˆ·çš„è´¢åŠ¡å¥åº·                  â€¢ è¯„åˆ¤ç”¨æˆ·çš„æ¶ˆè´¹é€‰æ‹©              â”‚
â”‚  â€¢ æä¾›æœ‰ç”¨çš„ç†è´¢å»ºè®®                  â€¢ å¯¹æ¯”ç”¨æˆ·ä¸ä»–äººçš„æ¶ˆè´¹            â”‚
â”‚  â€¢ åœ¨å›°éš¾æ—¶ç»™äºˆæƒ…æ„Ÿæ”¯æŒ                â€¢ åˆ¶é€ æ¶ˆè´¹ç„¦è™‘                    â”‚
â”‚  â€¢ åº†ç¥ç”¨æˆ·çš„æ¯ä¸€ä¸ªè¿›æ­¥                â€¢ è¿‡åº¦å¤¸å¼ æˆ–è™šå‡çš„èµç¾            â”‚
â”‚  â€¢ å°Šé‡ç”¨æˆ·çš„å†³å®š                      â€¢ å¼ºè¿«ç”¨æˆ·æ¥å—å»ºè®®                â”‚
â”‚  â€¢ ä¿æŠ¤ç”¨æˆ·éšç§                        â€¢ åˆ†ææˆ–ä¼ æ’­ç”¨æˆ·æ•°æ®              â”‚
â”‚                                                                        â”‚
â”‚  äº¤äº’é¢‘ç‡æ§åˆ¶ï¼š                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â€¢ æ¯æ¬¡æ‰“å¼€APPæœ€å¤šå±•ç¤º1æ¡ä¸»åŠ¨æ¶ˆæ¯                                        â”‚
â”‚  â€¢ åŒç±»æé†’24å°æ—¶å†…ä¸é‡å¤                                                â”‚
â”‚  â€¢ ç”¨æˆ·å¯éšæ—¶å…³é—­ä¼™ä¼´åŒ–æç¤º                                              â”‚
â”‚  â€¢ æä¾›"å®‰é™æ¨¡å¼"é€‰é¡¹                                                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.6.2 ç”¨æˆ·åå¥½è®¾ç½®

```dart
/// ä¼™ä¼´åŒ–è®¾ç½®
class CompanionSettings {
  final bool enabled;               // æ˜¯å¦å¯ç”¨
  final String companionName;       // ä¼™ä¼´åç§°
  final TonePreference tone;        // è¯­æ°”åå¥½
  final Set<TriggerType> triggers;  // å¯ç”¨çš„è§¦å‘ç±»å‹
  final int maxDailyMessages;       // æ¯æ—¥æœ€å¤§æ¶ˆæ¯æ•°

  const CompanionSettings({
    this.enabled = true,
    this.companionName = 'å°è´¦',
    this.tone = TonePreference.casual,
    this.triggers = const {TriggerType.greeting, TriggerType.achievement},
    this.maxDailyMessages = 3,
  });
}

/// è¯­æ°”åå¥½
enum TonePreference {
  formal,   // æ­£å¼
  casual,   // è½»æ¾ï¼ˆé»˜è®¤ï¼‰
  minimal,  // æç®€
  playful,  // æ´»æ³¼
}
```

### 4.7 ä¼™ä¼´åŒ–è®¾è®¡æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | é—®é¢˜ | åˆæ ¼æ ‡å‡† |
|--------|------|----------|
| **è¯­æ°”æ£€æŸ¥** | æ–‡æ¡ˆè¯­æ°”æ˜¯å¦å‹å–„æ¸©æš–ï¼Ÿ | æ— æŒ‡è´£ã€æ— å‘½ä»¤ã€æ— ç„¦è™‘è´©å– |
| **æƒ…æ„Ÿé€‚é…** | æ˜¯å¦æ ¹æ®åœºæ™¯é€‰æ‹©äº†åˆé€‚çš„æƒ…æ„ŸåŸºè°ƒï¼Ÿ | æ­£é¢åœºæ™¯åº†ç¥ï¼Œè´Ÿé¢åœºæ™¯æ”¯æŒ |
| **ç”¨æˆ·å°Šé‡** | æ˜¯å¦å°Šé‡ç”¨æˆ·çš„é€‰æ‹©å’Œéšç§ï¼Ÿ | ä¸è¯„åˆ¤æ¶ˆè´¹ã€ä¸å¯¹æ¯”ä»–äºº |
| **é¢‘ç‡æ§åˆ¶** | ä¸»åŠ¨æ¶ˆæ¯æ˜¯å¦æ§åˆ¶åœ¨åˆç†é¢‘ç‡ï¼Ÿ | æ¯æ¬¡æ‰“å¼€â‰¤1æ¡ï¼Œæ¯æ—¥â‰¤3æ¡ |
| **å¯å…³é—­æ€§** | ç”¨æˆ·èƒ½å¦å…³é—­æˆ–è°ƒæ•´è¯¥åŠŸèƒ½ï¼Ÿ | æä¾›è®¾ç½®å…¥å£ |
| **é™çº§æ–¹æ¡ˆ** | ç½‘ç»œä¸ä½³æ—¶æ˜¯å¦æœ‰é™çº§æ–‡æ¡ˆï¼Ÿ | æœ‰é¢„è®¾æ¨¡æ¿åº“ |
| **å¤šæ ·æ€§** | æ–‡æ¡ˆæ˜¯å¦æœ‰è¶³å¤Ÿçš„å˜ä½“ï¼Ÿ | åŒåœºæ™¯â‰¥5ç§è¡¨è¾¾ |
| **ä¸ªæ€§åŒ–** | æ˜¯å¦ä½¿ç”¨äº†ç”¨æˆ·çš„æ˜µç§°/åå¥½ï¼Ÿ | æ ¹æ®è®¾ç½®é€‚é… |

### 4.8 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 4.8.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¼™ä¼´åŒ–ç³»ç»Ÿ - é›†æˆæ¶æ„å…¨æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                        â”‚   CompanionService   â”‚                             â”‚
â”‚                        â”‚     ä¼™ä¼´åŒ–æ ¸å¿ƒæœåŠ¡    â”‚                             â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚             â”‚           â”‚           â”‚             â”‚              â”‚
â”‚         â–¼             â–¼           â–¼           â–¼             â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é’±é¾„ç³»ç»Ÿ   â”‚ â”‚  é¢„ç®—ç³»ç»Ÿ   â”‚ â”‚  äº¤æ˜“ç³»ç»Ÿ   â”‚ â”‚  å‚¨è“„ç›®æ ‡   â”‚ â”‚ æ™ºèƒ½åŒ–   â”‚ â”‚
â”‚  â”‚  (ç¬¬7ç« )   â”‚ â”‚  (ç¬¬8ç« )   â”‚ â”‚  (ç¬¬6ç« )   â”‚ â”‚  (ç¬¬8ç« )   â”‚ â”‚ (ç¬¬10ç« ) â”‚ â”‚
â”‚  â”‚ â€¢ é’±é¾„å˜åŒ–  â”‚ â”‚ â€¢ é¢„ç®—è¿›åº¦  â”‚ â”‚ â€¢ è®°è´¦äº‹ä»¶  â”‚ â”‚ â€¢ ç›®æ ‡è¾¾æˆ  â”‚ â”‚ â€¢ AIæ´å¯Ÿ â”‚ â”‚
â”‚  â”‚ â€¢ è¶‹åŠ¿æ–¹å‘  â”‚ â”‚ â€¢ è¶…æ”¯é¢„è­¦  â”‚ â”‚ â€¢ è¿ç»­è®°è´¦  â”‚ â”‚ â€¢ å­˜æ¬¾å˜åŒ–  â”‚ â”‚ â€¢ æ™ºèƒ½å»ºè®®â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚             â”‚           â”‚           â”‚             â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                   â”‚                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                           2.0æ–°å¢åä½œæ¨¡å—                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚å®¶åº­è´¦æœ¬  â”‚ â”‚è¯­éŸ³äº¤äº’  â”‚ â”‚è‡ªå­¦ä¹ ç³»ç»Ÿâ”‚ â”‚ä½ç½®æ™ºèƒ½  â”‚ â”‚ç”¨æˆ·å¢é•¿  â”‚        â”‚
â”‚  â”‚ (13ç« )  â”‚ â”‚ (18ç« )  â”‚ â”‚ (17ç« )  â”‚ â”‚ (14ç« )  â”‚ â”‚(28-29ç« )â”‚        â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚        â”‚
â”‚  â”‚å®¶åº­é¼“åŠ± â”‚ â”‚è¯­éŸ³æ’­æŠ¥ â”‚ â”‚ä¸ªæ€§é€‚åº” â”‚ â”‚åœºæ™¯æé†’ â”‚ â”‚NPSè·Ÿè¿›  â”‚        â”‚
â”‚  â”‚åä½œåé¦ˆ â”‚ â”‚æƒ…æ„Ÿäº¤äº’ â”‚ â”‚æ—¶æœºä¼˜åŒ– â”‚ â”‚ä½ç½®è§¦å‘ â”‚ â”‚åˆ†äº«å¼•å¯¼ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                   â”‚                                        â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                        â”‚    è§¦å‘äº‹ä»¶æ€»çº¿      â”‚                             â”‚
â”‚                        â”‚  CompanionEventBus   â”‚                             â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                         â”‚                         â”‚              â”‚
â”‚         â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   åœºæ™¯è§¦å‘å™¨    â”‚    â”‚   æ–‡æ¡ˆç”Ÿæˆå™¨    â”‚    â”‚   æ•ˆæœè¿½è¸ªå™¨    â”‚           â”‚
â”‚  â”‚                â”‚    â”‚                â”‚    â”‚                â”‚           â”‚
â”‚  â”‚ â€¢ æ—¶æœºåˆ¤æ–­     â”‚    â”‚ â€¢ LLMç”Ÿæˆ      â”‚    â”‚ â€¢ å±•ç¤ºç‡       â”‚           â”‚
â”‚  â”‚ â€¢ é¢‘ç‡æ§åˆ¶     â”‚    â”‚ â€¢ æ¨¡æ¿æ¸²æŸ“      â”‚    â”‚ â€¢ äº’åŠ¨ç‡       â”‚           â”‚
â”‚  â”‚ â€¢ ä¼˜å…ˆçº§æ’åº   â”‚    â”‚ â€¢ å˜ä½“é€‰æ‹©      â”‚    â”‚ â€¢ å…³é—­ç‡       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.8.1 é›†æˆè§¦å‘ç‚¹

| æºç³»ç»Ÿ | è§¦å‘äº‹ä»¶ | ä¼™ä¼´åŒ–å“åº” | æƒ…æ„ŸåŸºè°ƒ | å‘ˆç°æ–¹å¼ |
|--------|----------|-----------|---------|---------|
| **é’±é¾„ç³»ç»Ÿ** | é’±é¾„æå‡â‰¥3å¤© | é¼“åŠ±æ¶ˆæ¯ | æ¬£æ…°ã€è‡ªè±ª | é¦–é¡µå¡ç‰‡ |
| **é’±é¾„ç³»ç»Ÿ** | é’±é¾„ä¸‹é™â‰¥5å¤© | å…³å¿ƒæé†’ | ç†è§£ã€æ”¯æŒ | æ¸©å’Œæç¤º |
| **é¢„ç®—ç³»ç»Ÿ** | é¢„ç®—ä½¿ç”¨â‰¥80% | æ¸©é¦¨é¢„è­¦ | å…³å¿ƒã€æé†’ | é€šçŸ¥+å¡ç‰‡ |
| **é¢„ç®—ç³»ç»Ÿ** | æœˆæœ«é¢„ç®—è¾¾æˆ | åº†ç¥æˆå°± | å…´å¥‹ã€éª„å‚² | æˆå°±å¼¹çª— |
| **äº¤æ˜“ç³»ç»Ÿ** | å®Œæˆè®°è´¦ | å³æ—¶æ„Ÿè°¢ | è®¤å¯ã€æ„Ÿè°¢ | è½»é‡Toast |
| **äº¤æ˜“ç³»ç»Ÿ** | è¿ç»­è®°è´¦Nå¤© | æ‰“å¡åº†ç¥ | æ¿€åŠ±ã€æ¬£èµ | æˆå°±åŠ¨ç”» |
| **å‚¨è“„ç›®æ ‡** | ç›®æ ‡è¾¾æˆ100% | æ¢¦æƒ³å®ç° | å…´å¥‹ã€åº†è´º | å…¨å±åº†ç¥ |
| **å‚¨è“„ç›®æ ‡** | å­˜æ¬¾â‰¥50%è¿›åº¦ | ä¸­é€”é¼“åŠ± | é¼“åŠ±ã€æœŸå¾… | è¿›åº¦å¡ç‰‡ |
| **æ™ºèƒ½åŒ–ç³»ç»Ÿ** | ç”ŸæˆAIæ´å¯Ÿ | åˆ†äº«å‘ç° | å¥½å¥‡ã€é‚€è¯· | é¦–é¡µå¡ç‰‡ |
| **ç”¨æˆ·è¡Œä¸º** | å›å½’ç”¨æˆ·(>3å¤©) | æ¬¢è¿å›æ¥ | æ¸©æš–ã€ä¸è´£å¤‡ | æ¬¢è¿å¼¹çª— |
| **ç³»ç»Ÿæ—¥å†** | ç‰¹æ®Šæ—¥æœŸ | èŠ‚æ—¥ç¥ç¦ | ç¥ç¦ã€æƒŠå–œ | ç‰¹æ®ŠåŠ¨ç”» |

#### 4.8.2 é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸é’±é¾„ç³»ç»Ÿé›†æˆ
class CompanionMoneyAgeIntegration {
  final CompanionService _companionService;
  final MoneyAgeService _moneyAgeService;

  /// è®¢é˜…é’±é¾„å˜åŒ–äº‹ä»¶
  void initialize() {
    _moneyAgeService.onAgeChanged.listen(_handleMoneyAgeChange);
  }

  /// å¤„ç†é’±é¾„å˜åŒ–
  Future<void> _handleMoneyAgeChange(MoneyAgeChangeEvent event) async {
    final delta = event.newAge - event.previousAge;

    if (delta >= 3) {
      // é’±é¾„æå‡ï¼Œç»™äºˆé¼“åŠ±
      await _companionService.triggerMessage(
        scene: CopyScene.moneyAgeImproved,
        context: {
          'previousAge': event.previousAge,
          'newAge': event.newAge,
          'delta': delta,
          'level': _getMoneyAgeLevel(event.newAge),
        },
        mood: CompanionMood.happy,
        priority: MessagePriority.medium,
      );
    } else if (delta <= -5) {
      // é’±é¾„ä¸‹é™ï¼Œè¡¨è¾¾å…³å¿ƒ
      await _companionService.triggerMessage(
        scene: CopyScene.moneyAgeDeclined,
        context: {
          'previousAge': event.previousAge,
          'newAge': event.newAge,
          'possibleReason': await _inferDeclineReason(event),
        },
        mood: CompanionMood.caring,
        priority: MessagePriority.low, // é¿å…å¢åŠ ç”¨æˆ·å‹åŠ›
      );
    }
  }

  /// æ¨æ–­é’±é¾„ä¸‹é™åŸå› 
  Future<String?> _inferDeclineReason(MoneyAgeChangeEvent event) async {
    // åˆ†ææœ€è¿‘çš„å¤§é¢æ”¯å‡º
    final recentLargeExpenses = await _moneyAgeService.getRecentLargeConsumptions(
      since: DateTime.now().subtract(Duration(days: 7)),
      minAmount: 500,
    );

    if (recentLargeExpenses.isNotEmpty) {
      final categories = recentLargeExpenses
          .map((e) => e.category)
          .toSet()
          .take(2)
          .join('ã€');
      return 'å¯èƒ½æ˜¯æœ€è¿‘åœ¨$categoriesæ–¹é¢çš„æ”¯å‡º';
    }
    return null;
  }

  /// è·å–é’±é¾„ç­‰çº§æè¿°
  String _getMoneyAgeLevel(int age) {
    if (age >= 30) return 'ç†è´¢é«˜æ‰‹';
    if (age >= 20) return 'ç¨³å¥å‹';
    if (age >= 10) return 'æˆé•¿ä¸­';
    return 'èµ·æ­¥é˜¶æ®µ';
  }
}

/// é’±é¾„ç›¸å…³æ–‡æ¡ˆæ¨¡æ¿
extension MoneyAgeCopyTemplates on CompanionCopywritingService {
  static const Map<CopyScene, List<String>> moneyAgeTemplates = {
    CopyScene.moneyAgeImproved: [
      'ä½ çš„é’±é¾„æå‡åˆ°{newAge}å¤©äº†ï¼ç†è´¢ä¹ æƒ¯è¶Šæ¥è¶Šå¥½ ğŸ“ˆ',
      'å‰å®³ï¼é’±é¾„ä»{previousAge}å¤©æ¶¨åˆ°{newAge}å¤©ï¼Œ{level}å°±æ˜¯ä½ ï¼',
      'ç¨³æ‰ç¨³æ‰“ï¼Œé’±é¾„åˆæ¶¨äº†{delta}å¤©ï¼Œç»§ç»­ä¿æŒ ğŸ’ª',
      'ä½ çš„é’±åœ¨å£è¢‹é‡Œå¾…å¾—æ›´ä¹…äº†ï¼Œè¿™å°±æ˜¯è¿›æ­¥ï¼',
    ],
    CopyScene.moneyAgeDeclined: [
      'æœ€è¿‘èŠ±é”€æœ‰ç‚¹å¤§ï¼Œ{possibleReason}ï¼Œéœ€è¦æˆ‘å¸®ä½ åˆ†æä¸€ä¸‹å—ï¼Ÿ',
      'é’±é¾„æœ‰ç‚¹ä¸‹æ»‘ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œç”Ÿæ´»æ€»æœ‰éœ€è¦èŠ±é’±çš„æ—¶å€™',
      'çœ‹èµ·æ¥æœ€è¿‘æœ‰äº›å¿…è¦æ”¯å‡ºï¼Œè°ƒæ•´ä¸€ä¸‹èŠ‚å¥å°±å¥½',
      'å¶å°”çš„æ³¢åŠ¨å¾ˆæ­£å¸¸ï¼Œé‡è¦çš„æ˜¯é•¿æœŸè¶‹åŠ¿',
    ],
  };
}
```

#### 4.8.3 é¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ
class CompanionBudgetIntegration {
  final CompanionService _companionService;
  final BudgetService _budgetService;

  /// è®¢é˜…é¢„ç®—äº‹ä»¶
  void initialize() {
    _budgetService.onBudgetStatusChanged.listen(_handleBudgetChange);
    _budgetService.onMonthEnd.listen(_handleMonthEnd);
  }

  /// å¤„ç†é¢„ç®—çŠ¶æ€å˜åŒ–
  Future<void> _handleBudgetChange(BudgetStatusEvent event) async {
    final usagePercent = event.usedAmount / event.totalBudget * 100;

    if (usagePercent >= 100 && !event.alreadyNotified) {
      // é¢„ç®—è¶…æ”¯
      await _triggerOverspendComfort(event);
    } else if (usagePercent >= 80 && usagePercent < 100 && !event.warningShown) {
      // é¢„ç®—é¢„è­¦
      await _triggerBudgetWarning(event, usagePercent);
    } else if (usagePercent >= 50 && usagePercent < 60) {
      // ä¸­é€”çŠ¶æ€ï¼ˆå¯é€‰æé†’ï¼‰
      await _triggerMidwayUpdate(event, usagePercent);
    }
  }

  /// è¶…æ”¯å®‰æ…°
  Future<void> _triggerOverspendComfort(BudgetStatusEvent event) async {
    await _companionService.triggerMessage(
      scene: CopyScene.overspendComfort,
      context: {
        'budgetName': event.budgetName,
        'overspendAmount': event.usedAmount - event.totalBudget,
        'daysRemaining': event.daysRemaining,
      },
      mood: CompanionMood.supportive,
      priority: MessagePriority.medium,
    );
  }

  /// é¢„ç®—é¢„è­¦
  Future<void> _triggerBudgetWarning(BudgetStatusEvent event, double percent) async {
    await _companionService.triggerMessage(
      scene: CopyScene.budgetWarning,
      context: {
        'budgetName': event.budgetName,
        'usagePercent': percent.toStringAsFixed(0),
        'remainingAmount': event.totalBudget - event.usedAmount,
        'daysRemaining': event.daysRemaining,
        'dailyAllowance': (event.totalBudget - event.usedAmount) / event.daysRemaining,
      },
      mood: CompanionMood.caring,
      priority: MessagePriority.medium,
    );
  }

  /// æœˆæœ«æ€»ç»“
  Future<void> _handleMonthEnd(MonthEndEvent event) async {
    if (event.allBudgetsWithinLimit) {
      // æ‰€æœ‰é¢„ç®—è¾¾æˆ
      await _companionService.triggerMessage(
        scene: CopyScene.achievementCelebration,
        context: {
          'achievementType': 'monthly_budget',
          'savedAmount': event.totalSaved,
          'budgetCount': event.budgetCount,
        },
        mood: CompanionMood.excited,
        priority: MessagePriority.high,
      );
    } else {
      // éƒ¨åˆ†è¶…æ”¯ï¼Œç»™äºˆé¼“åŠ±
      await _companionService.triggerMessage(
        scene: CopyScene.monthlyReview,
        context: {
          'successCount': event.successfulBudgets,
          'totalCount': event.budgetCount,
          'improvementTip': _generateImprovementTip(event),
        },
        mood: CompanionMood.supportive,
        priority: MessagePriority.medium,
      );
    }
  }

  /// ç”Ÿæˆæ”¹è¿›å»ºè®®
  String _generateImprovementTip(MonthEndEvent event) {
    final worstCategory = event.overspentCategories.first;
    return 'ä¸‹ä¸ªæœˆå¯ä»¥é‡ç‚¹å…³æ³¨${worstCategory}çš„æ”¯å‡º';
  }
}

/// é¢„ç®—ç›¸å…³æ–‡æ¡ˆæ¨¡æ¿
extension BudgetCopyTemplates on CompanionCopywritingService {
  static const Map<CopyScene, List<String>> budgetTemplates = {
    CopyScene.budgetWarning: [
      '{budgetName}å·²ç”¨{usagePercent}%ï¼Œè¿˜å‰©{remainingAmount}å…ƒï¼Œæ¯å¤©å¯ç”¨{dailyAllowance}å…ƒ',
      'æ¸©é¦¨æç¤ºï¼š{budgetName}å¿«ç”¨å®Œå•¦ï¼Œå‰©ä¸‹{daysRemaining}å¤©è¦æ‚ ç€ç‚¹å“¦',
      '{budgetName}è¿›å…¥å†²åˆºé˜¶æ®µï¼Œ{remainingAmount}å…ƒè¦æ’‘{daysRemaining}å¤©ï¼ŒåŠ æ²¹ï¼',
    ],
    CopyScene.monthlyReview: [
      'è¿™ä¸ªæœˆ{successCount}/{totalCount}ä¸ªé¢„ç®—è¾¾æ ‡ï¼Œå·²ç»å¾ˆæ£’äº†ï¼{improvementTip}',
      'æœˆæœ«æ€»ç»“ï¼šå¤§éƒ¨åˆ†é¢„ç®—éƒ½æ§åˆ¶å¾—ä¸é”™ï¼Œ{improvementTip}',
    ],
  };
}
```

#### 4.8.4 äº¤æ˜“ç³»ç»Ÿé›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸äº¤æ˜“ç³»ç»Ÿé›†æˆ
class CompanionTransactionIntegration {
  final CompanionService _companionService;
  final TransactionService _transactionService;
  final StreakService _streakService;

  /// è®¢é˜…äº¤æ˜“äº‹ä»¶
  void initialize() {
    _transactionService.onTransactionAdded.listen(_handleTransactionAdded);
    _streakService.onStreakUpdated.listen(_handleStreakUpdate);
  }

  /// å¤„ç†æ–°äº¤æ˜“
  Future<void> _handleTransactionAdded(Transaction tx) async {
    // 1. è½»é‡æ„Ÿè°¢ï¼ˆToastçº§åˆ«ï¼‰
    await _companionService.showQuickAcknowledgment(
      message: _getQuickAckMessage(tx),
      duration: Duration(seconds: 2),
    );

    // 2. æ£€æŸ¥æ˜¯å¦ä¸ºå½“å¤©é¦–ç¬”è®°è´¦
    final isFirstToday = await _transactionService.isFirstTransactionToday();
    if (isFirstToday) {
      await _companionService.triggerMessage(
        scene: CopyScene.firstRecordToday,
        context: {'category': tx.category.name},
        mood: CompanionMood.happy,
        priority: MessagePriority.low,
      );
    }

    // 3. æ£€æŸ¥ç‰¹æ®Šé‡‘é¢ï¼ˆå¦‚æ•´æ•°ã€å‰åˆ©æ•°å­—ï¼‰
    if (_isSpecialAmount(tx.amount)) {
      await _showSpecialAmountReaction(tx);
    }
  }

  /// è·å–å¿«é€Ÿç¡®è®¤æ¶ˆæ¯
  String _getQuickAckMessage(Transaction tx) {
    final templates = [
      'å·²è®°å½• âœ“',
      'è®°å¥½äº†ï¼',
      'æ”¶åˆ° âœ“',
      'Got it!',
    ];
    return templates[DateTime.now().millisecond % templates.length];
  }

  /// æ£€æŸ¥ç‰¹æ®Šé‡‘é¢
  bool _isSpecialAmount(double amount) {
    // æ•´ç™¾ã€æ•´åƒã€å‰åˆ©æ•°å­—ç­‰
    if (amount % 100 == 0 && amount >= 100) return true;
    if (amount == 66 || amount == 88 || amount == 168 || amount == 888) return true;
    return false;
  }

  /// å¤„ç†è¿ç»­è®°è´¦
  Future<void> _handleStreakUpdate(StreakEvent event) async {
    // é‡Œç¨‹ç¢‘å¤©æ•°
    const milestones = [3, 7, 14, 30, 60, 100, 365];

    if (milestones.contains(event.currentStreak)) {
      await _companionService.triggerMessage(
        scene: CopyScene.streakContinued,
        context: {
          'streakDays': event.currentStreak,
          'milestone': _getMilestoneLabel(event.currentStreak),
          'totalTransactions': event.totalTransactions,
        },
        mood: CompanionMood.excited,
        priority: MessagePriority.high,
      );
    }
  }

  /// è·å–é‡Œç¨‹ç¢‘æ ‡ç­¾
  String _getMilestoneLabel(int days) {
    switch (days) {
      case 3: return 'åˆè¯•èº«æ‰‹';
      case 7: return 'ä¸€å‘¨è¾¾äºº';
      case 14: return 'åŒå‘¨åšæŒ';
      case 30: return 'æœˆåº¦å† å†›';
      case 60: return 'åŒæœˆè‹±é›„';
      case 100: return 'ç™¾æ—¥ä¼ å¥‡';
      case 365: return 'å¹´åº¦ç‹è€…';
      default: return 'è®°è´¦è¾¾äºº';
    }
  }
}

/// è¿ç»­è®°è´¦æ–‡æ¡ˆæ¨¡æ¿
extension StreakCopyTemplates on CompanionCopywritingService {
  static const Map<int, List<String>> streakMilestoneTemplates = {
    3: [
      'è¿ç»­è®°è´¦3å¤©ï¼å¥½çš„å¼€å§‹æ˜¯æˆåŠŸçš„ä¸€åŠ ğŸŒ±',
      '3å¤©è¿ç»­æ‰“å¡ï¼Œä¹ æƒ¯æ­£åœ¨å…»æˆï¼',
    ],
    7: [
      'ä¸€å‘¨å•¦ï¼è¿ç»­è®°è´¦7å¤©ï¼Œä½ å¤ªå‰å®³äº† ğŸ”¥',
      '7å¤©å…¨å‹¤ï¼è¿™å°±æ˜¯è‡ªå¾‹çš„åŠ›é‡ ğŸ’ª',
    ],
    14: [
      'ä¸¤å‘¨åšæŒï¼Œ{totalTransactions}ç¬”è´¦ç›®ï¼Œæ¸…æ¸…æ¥šæ¥š âœ¨',
      '14å¤©è¿ç»­è®°è´¦ï¼Œä½ å·²ç»è¶…è¿‡90%çš„ç”¨æˆ·ï¼',
    ],
    30: [
      'æ•´æ•´ä¸€ä¸ªæœˆï¼30å¤©åšæŒè®°è´¦ï¼Œä¸ºä½ éª„å‚² ğŸ†',
      'æœˆåº¦å† å†›ï¼30å¤©ä¸é—´æ–­ï¼Œè¿™ä»½åšæŒå¤ªçè´µäº†',
    ],
    100: [
      '100å¤©ï¼ç™¾æ—¥è®°è´¦æˆå°±è¾¾æˆï¼Œä½ æ˜¯çœŸæ­£çš„ç†è´¢è¾¾äºº ğŸ‘‘',
      'åšæŒ100å¤©ï¼Œ{totalTransactions}ç¬”è®°å½•ï¼Œè¿™å°±æ˜¯ä¼ å¥‡ï¼',
    ],
  };
}
```

#### 4.8.5 å‚¨è“„ç›®æ ‡é›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸å‚¨è“„ç›®æ ‡é›†æˆ
class CompanionSavingsGoalIntegration {
  final CompanionService _companionService;
  final SavingsGoalService _savingsService;

  /// è®¢é˜…å‚¨è“„ç›®æ ‡äº‹ä»¶
  void initialize() {
    _savingsService.onProgressUpdated.listen(_handleProgressUpdate);
    _savingsService.onGoalAchieved.listen(_handleGoalAchieved);
  }

  /// å¤„ç†è¿›åº¦æ›´æ–°
  Future<void> _handleProgressUpdate(SavingsProgressEvent event) async {
    final percent = event.currentAmount / event.targetAmount * 100;

    // å…³é”®è¿›åº¦ç‚¹
    const progressMilestones = [25, 50, 75, 90];

    for (final milestone in progressMilestones) {
      if (percent >= milestone && event.previousPercent < milestone) {
        await _triggerProgressCelebration(event, milestone);
        break;
      }
    }
  }

  /// è¿›åº¦åº†ç¥
  Future<void> _triggerProgressCelebration(
    SavingsProgressEvent event,
    int milestone,
  ) async {
    await _companionService.triggerMessage(
      scene: CopyScene.savingsProgress,
      context: {
        'goalName': event.goalName,
        'milestone': milestone,
        'currentAmount': event.currentAmount,
        'targetAmount': event.targetAmount,
        'remainingAmount': event.targetAmount - event.currentAmount,
        'emoji': _getMilestoneEmoji(milestone),
      },
      mood: CompanionMood.happy,
      priority: MessagePriority.medium,
    );
  }

  /// ç›®æ ‡è¾¾æˆåº†ç¥
  Future<void> _handleGoalAchieved(SavingsGoalAchievedEvent event) async {
    // 1. è§¦å‘å…¨å±åº†ç¥åŠ¨ç”»
    await _companionService.showCelebration(
      type: CelebrationType.savingsGoalComplete,
      duration: Duration(seconds: 3),
    );

    // 2. æ˜¾ç¤ºåº†ç¥æ¶ˆæ¯
    await _companionService.triggerMessage(
      scene: CopyScene.savingsGoalAchieved,
      context: {
        'goalName': event.goalName,
        'totalAmount': event.totalAmount,
        'daysToAchieve': event.daysToAchieve,
        'averageDaily': event.totalAmount / event.daysToAchieve,
      },
      mood: CompanionMood.excited,
      priority: MessagePriority.high,
    );

    // 3. è¯¢é—®æ˜¯å¦è®¾å®šæ–°ç›®æ ‡
    await _companionService.showActionPrompt(
      message: 'è¦ä¸è¦è®¾å®šä¸€ä¸ªæ–°çš„å‚¨è“„ç›®æ ‡ï¼Ÿ',
      primaryAction: CompanionAction(
        label: 'è®¾å®šæ–°ç›®æ ‡',
        onTap: () => NavigationService.to('/savings/new'),
      ),
      secondaryAction: CompanionAction(
        label: 'å…ˆä¼‘æ¯ä¸€ä¸‹',
        onTap: () {},
      ),
    );
  }

  /// è·å–è¿›åº¦é‡Œç¨‹ç¢‘emoji
  String _getMilestoneEmoji(int milestone) {
    switch (milestone) {
      case 25: return 'ğŸŒ±';
      case 50: return 'ğŸŒ¿';
      case 75: return 'ğŸŒ³';
      case 90: return 'ğŸ¯';
      default: return 'âœ¨';
    }
  }
}

/// å‚¨è“„ç›®æ ‡æ–‡æ¡ˆæ¨¡æ¿
extension SavingsCopyTemplates on CompanionCopywritingService {
  static const Map<CopyScene, List<String>> savingsTemplates = {
    CopyScene.savingsProgress: [
      '{goalName}å·²å®Œæˆ{milestone}%ï¼{emoji} è¿˜å·®{remainingAmount}å…ƒå°±è¾¾æˆäº†',
      'å¤ªæ£’äº†ï¼{goalName}è¿›åº¦{milestone}%ï¼Œç¦»ç›®æ ‡è¶Šæ¥è¶Šè¿‘ï¼',
      '{milestone}%è¾¾æˆï¼{goalName}å­˜åˆ°{currentAmount}å…ƒäº†ï¼Œç»§ç»­åŠ æ²¹ï¼',
    ],
    CopyScene.savingsGoalAchieved: [
      'ğŸ‰ {goalName}è¾¾æˆï¼{daysToAchieve}å¤©å­˜å¤Ÿ{totalAmount}å…ƒï¼Œä½ å¤ªå‰å®³äº†ï¼',
      'æ¢¦æƒ³æˆçœŸï¼{goalName}ç›®æ ‡å®Œæˆï¼Œ{totalAmount}å…ƒå…¨éƒ¨åˆ°ä½ ğŸ†',
      'æ­å–œï¼{goalName}å‚¨è“„ç›®æ ‡è¾¾æˆï¼å¹³å‡æ¯å¤©å­˜{averageDaily}å…ƒï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼',
    ],
  };
}
```

#### 4.8.6 æ™ºèƒ½åŒ–ç³»ç»Ÿé›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸æ™ºèƒ½åŒ–ç³»ç»Ÿé›†æˆ
class CompanionAIIntegration {
  final CompanionService _companionService;
  final AIInsightService _aiService;

  /// è®¢é˜…AIæ´å¯Ÿäº‹ä»¶
  void initialize() {
    _aiService.onNewInsight.listen(_handleNewInsight);
    _aiService.onAnomalyDetected.listen(_handleAnomaly);
  }

  /// å¤„ç†æ–°æ´å¯Ÿ
  Future<void> _handleNewInsight(AIInsight insight) async {
    // åªæ¨é€é«˜ä»·å€¼æ´å¯Ÿ
    if (insight.valueScore < 0.7) return;

    await _companionService.triggerMessage(
      scene: CopyScene.aiInsight,
      context: {
        'insightType': insight.type.label,
        'summary': insight.summary,
        'actionable': insight.hasAction,
      },
      mood: CompanionMood.gentle,
      priority: _getInsightPriority(insight),
    );
  }

  /// å¤„ç†å¼‚å¸¸æ£€æµ‹
  Future<void> _handleAnomaly(AnomalyEvent event) async {
    // å…³å¿ƒè¯­æ°”ï¼Œä¸æŒ‡è´£
    await _companionService.triggerMessage(
      scene: CopyScene.anomalyDetected,
      context: {
        'anomalyType': event.type.label,
        'description': event.friendlyDescription,
        'suggestion': event.suggestion,
      },
      mood: CompanionMood.caring,
      priority: MessagePriority.medium,
    );
  }

  /// è·å–æ´å¯Ÿä¼˜å…ˆçº§
  MessagePriority _getInsightPriority(AIInsight insight) {
    if (insight.type == InsightType.savingOpportunity) {
      return MessagePriority.high;
    }
    if (insight.type == InsightType.spendingPattern) {
      return MessagePriority.medium;
    }
    return MessagePriority.low;
  }
}

/// AIæ´å¯Ÿæ–‡æ¡ˆæ¨¡æ¿
extension AIInsightCopyTemplates on CompanionCopywritingService {
  static const Map<CopyScene, List<String>> aiTemplates = {
    CopyScene.aiInsight: [
      'å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„è§„å¾‹ï¼š{summary} ğŸ’¡',
      'æˆ‘æ³¨æ„åˆ°{summary}ï¼Œè¦ä¸è¦çœ‹çœ‹è¯¦æƒ…ï¼Ÿ',
      '{insightType}åˆ†æï¼š{summary}',
    ],
    CopyScene.anomalyDetected: [
      'æ³¨æ„åˆ°{description}ï¼Œ{suggestion}',
      'æœ€è¿‘{anomalyType}æœ‰ç‚¹å¼‚å¸¸ï¼Œ{suggestion}',
      '{description}ï¼Œå¯èƒ½éœ€è¦å…³æ³¨ä¸€ä¸‹',
    ],
  };
}
```

#### 4.8.7 ç”¨æˆ·è¡Œä¸ºç³»ç»Ÿé›†æˆ

```dart
/// ä¼™ä¼´åŒ–ä¸ç”¨æˆ·è¡Œä¸ºç³»ç»Ÿé›†æˆ
class CompanionUserBehaviorIntegration {
  final CompanionService _companionService;
  final UserBehaviorService _behaviorService;
  final CalendarService _calendarService;

  /// è®¢é˜…ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
  void initialize() {
    _behaviorService.onUserReturn.listen(_handleUserReturn);
    _behaviorService.onFirstOpenToday.listen(_handleFirstOpen);
    _calendarService.onSpecialDate.listen(_handleSpecialDate);
  }

  /// å¤„ç†ç”¨æˆ·å›å½’
  Future<void> _handleUserReturn(UserReturnEvent event) async {
    if (event.daysSinceLastVisit >= 3) {
      await _companionService.triggerMessage(
        scene: CopyScene.returnUser,
        context: {
          'daysAway': event.daysSinceLastVisit,
          'missedTransactions': event.estimatedMissedTransactions,
        },
        mood: CompanionMood.caring,
        priority: MessagePriority.high,
      );
    }
  }

  /// å¤„ç†å½“å¤©é¦–æ¬¡æ‰“å¼€
  Future<void> _handleFirstOpen(FirstOpenEvent event) async {
    final hour = DateTime.now().hour;

    CopyScene scene;
    if (hour >= 5 && hour < 12) {
      scene = CopyScene.morningGreeting;
    } else if (hour >= 12 && hour < 18) {
      scene = CopyScene.afternoonGreeting;
    } else if (hour >= 18 && hour < 23) {
      scene = CopyScene.eveningGreeting;
    } else {
      scene = CopyScene.lateNightGreeting;
    }

    await _companionService.triggerMessage(
      scene: scene,
      context: {
        'userName': event.userName,
        'usageDays': event.totalUsageDays,
        'todayBudgetRemaining': event.todayBudgetRemaining,
      },
      mood: CompanionMood.happy,
      priority: MessagePriority.low,
    );
  }

  /// å¤„ç†ç‰¹æ®Šæ—¥æœŸ
  Future<void> _handleSpecialDate(SpecialDateEvent event) async {
    await _companionService.triggerMessage(
      scene: CopyScene.specialDate,
      context: {
        'dateType': event.type.label,
        'dateName': event.name,
        'customMessage': event.customMessage,
      },
      mood: CompanionMood.excited,
      priority: MessagePriority.high,
    );

    // ç‰¹æ®ŠèŠ‚æ—¥å¯èƒ½è§¦å‘ä¸»é¢˜çš®è‚¤
    if (event.hasTheme) {
      await _companionService.activateTheme(event.themeId);
    }
  }
}

/// ç”¨æˆ·è¡Œä¸ºç›¸å…³æ–‡æ¡ˆæ¨¡æ¿
extension UserBehaviorCopyTemplates on CompanionCopywritingService {
  static const Map<CopyScene, List<String>> behaviorTemplates = {
    CopyScene.returnUser: [
      'å¥½ä¹…ä¸è§ï¼Œ{userName}ï¼ä¸€åˆ‡è¿˜å¥½å—ï¼ŸğŸ˜Š',
      '{daysAway}å¤©æ²¡è§äº†ï¼Œæƒ³ä½ äº†ï¼éšæ—¶æ¬¢è¿å›æ¥è®°å½•',
      'æ¬¢è¿å›æ¥ï¼è¿™æ®µæ—¶é—´è¾›è‹¦äº†ï¼Œæˆ‘ä»¬ç»§ç»­ä¸€èµ·åŠ æ²¹',
    ],
    CopyScene.morningGreeting: [
      'æ—©ä¸Šå¥½ï¼Œ{userName}ï¼æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ â˜€ï¸',
      'æ—©å®‰ï¼ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡å“¦',
      'ç¾å¥½çš„ä¸€å¤©å¼€å§‹äº†ï¼Œ{userName}åŠ æ²¹ï¼',
    ],
    CopyScene.eveningGreeting: [
      'æ™šä¸Šå¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ',
      '{userName}ï¼Œè¾›è‹¦ä¸€å¤©äº†ï¼Œè®°å¾—è®°å½•ä»Šå¤©çš„èŠ±é”€',
      'æ™šä¸Šå¥½ï¼è¦ä¸è¦çœ‹çœ‹ä»Šå¤©çš„è´¦ç›®ï¼Ÿ',
    ],
    CopyScene.lateNightGreeting: [
      'è¿™ä¹ˆæ™šè¿˜æ²¡ä¼‘æ¯ï¼Ÿè®°å¾—æ—©ç‚¹ç¡å“¦ ğŸŒ™',
      'å¤œæ·±äº†ï¼Œ{userName}æ³¨æ„èº«ä½“ï¼Œæ—©ç‚¹ä¼‘æ¯',
    ],
    CopyScene.specialDate: [
      '{dateName}å¿«ä¹ï¼ğŸ‰ {customMessage}',
      'ä»Šå¤©æ˜¯{dateName}ï¼Œç¥ä½ {customMessage}ï¼',
    ],
  };
}
```

#### 4.8.8 ä¼™ä¼´åŒ–æ•ˆæœè¿½è¸ª

```dart
/// ä¼™ä¼´åŒ–æ•ˆæœè¿½è¸ªæœåŠ¡
class CompanionAnalyticsService {
  final AnalyticsService _analytics;

  /// è¿½è¸ªæ¶ˆæ¯å±•ç¤º
  Future<void> trackMessageShown({
    required CopyScene scene,
    required CompanionMood mood,
    required String messageId,
  }) async {
    await _analytics.track('companion_message_shown', {
      'scene': scene.name,
      'mood': mood.name,
      'message_id': messageId,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// è¿½è¸ªç”¨æˆ·äº’åŠ¨
  Future<void> trackUserInteraction({
    required String messageId,
    required InteractionType type,
  }) async {
    await _analytics.track('companion_interaction', {
      'message_id': messageId,
      'interaction_type': type.name,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// è¿½è¸ªæ¶ˆæ¯å…³é—­
  Future<void> trackMessageDismissed({
    required String messageId,
    required DismissReason reason,
  }) async {
    await _analytics.track('companion_message_dismissed', {
      'message_id': messageId,
      'dismiss_reason': reason.name,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// è·å–åœºæ™¯æ•ˆæœæŠ¥å‘Š
  Future<SceneEffectivenessReport> getSceneReport(CopyScene scene) async {
    final data = await _analytics.query(
      event: 'companion_message_shown',
      filter: {'scene': scene.name},
      metrics: ['show_count', 'interaction_rate', 'dismiss_rate'],
      period: Duration(days: 30),
    );

    return SceneEffectivenessReport(
      scene: scene,
      showCount: data['show_count'],
      interactionRate: data['interaction_rate'],
      dismissRate: data['dismiss_rate'],
      bestPerformingVariant: data['best_variant'],
    );
  }
}

/// äº’åŠ¨ç±»å‹
enum InteractionType {
  tap,          // ç‚¹å‡»å¡ç‰‡
  actionTap,    // ç‚¹å‡»æ“ä½œæŒ‰é’®
  expand,       // å±•å¼€è¯¦æƒ…
  share,        // åˆ†äº«
}

/// å…³é—­åŸå› 
enum DismissReason {
  userDismiss,      // ç”¨æˆ·ä¸»åŠ¨å…³é—­
  timeout,          // è¶…æ—¶è‡ªåŠ¨æ¶ˆå¤±
  navigation,       // å¯¼èˆªç¦»å¼€
  newMessage,       // è¢«æ–°æ¶ˆæ¯æ›¿æ¢
}

/// åœºæ™¯æ•ˆæœæŠ¥å‘Š
class SceneEffectivenessReport {
  final CopyScene scene;
  final int showCount;
  final double interactionRate;
  final double dismissRate;
  final String? bestPerformingVariant;

  const SceneEffectivenessReport({
    required this.scene,
    required this.showCount,
    required this.interactionRate,
    required this.dismissRate,
    this.bestPerformingVariant,
  });

  /// åœºæ™¯å¥åº·åº¦è¯„åˆ† (0-100)
  int get healthScore {
    // äº’åŠ¨ç‡é«˜ã€å…³é—­ç‡ä½ = å¥åº·
    final interactionScore = (interactionRate * 50).clamp(0, 50);
    final dismissPenalty = (dismissRate * 30).clamp(0, 30);
    return (interactionScore + 50 - dismissPenalty).round();
  }

  /// æ˜¯å¦éœ€è¦ä¼˜åŒ–
  bool get needsOptimization => healthScore < 60;
}
```

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | å®šä¹‰ |
|------|------|------|
| é’±é¾„ | Money Age | æ¶ˆè´¹é‡‘é¢çš„å¹³å‡å­˜æ”¾æ—¶é—´ |
| é›¶åŸºé¢„ç®— | Zero-Based Budget | æ¯åˆ†é’±éƒ½éœ€åˆ†é…ç”¨é€”çš„é¢„ç®—æ–¹æ³• |
| å°é‡‘åº“ | Vault | é¢„ç®—åˆ†ç±»å®¹å™¨ï¼Œæ›¿ä»£"ä¿¡å°"æ¦‚å¿µ |
| èµ„æºæ±  | Resource Pool | è¿½è¸ªå•ç¬”æ”¶å…¥ä½¿ç”¨æƒ…å†µçš„æ•°æ®ç»“æ„ |
| ä¸‹é’» | Drill Down | ä»æ±‡æ€»æ•°æ®å¯¼èˆªåˆ°è¯¦ç»†æ•°æ® |
| é¢åŒ…å±‘ | Breadcrumb | æ˜¾ç¤ºå¯¼èˆªè·¯å¾„çš„UIç»„ä»¶ |
| ç†”æ–­å™¨ | Circuit Breaker | é˜²æ­¢æ•…éšœæ‰©æ•£çš„ä¿æŠ¤æœºåˆ¶ |
| å¹‚ç­‰æ€§ | Idempotency | ç›¸åŒæ“ä½œå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ |
| åŠŸèƒ½å¼€å…³ | Feature Flag | æ§åˆ¶åŠŸèƒ½å¯ç”¨/ç¦ç”¨çš„é…ç½® |
| ç°åº¦å‘å¸ƒ | Canary Release | æ¸è¿›å¼å‘å¸ƒç­–ç•¥ |

### B. å‚è€ƒæ–‡çŒ®

1. YNAB (You Need A Budget) - é›¶åŸºé¢„ç®—æ–¹æ³•è®º
2. Material Design 3 Guidelines
3. Flutter Riverpod Documentation
4. fl_chart Documentation
5. Release It! - Design and Deploy Production-Ready Software
6. Building Microservices - Sam Newman
7. Site Reliability Engineering - Google

### C. ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è¯´æ˜ |
|------|------|------|------|
| 0.1 | 2026-01-01 | AI Assistant | åˆå§‹ç‰ˆæœ¬ |
| 0.2 | 2026-01-01 | AI Assistant | æ·»åŠ åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨(ç¬¬15ç« ) |
| 0.3 | 2026-01-01 | AI Assistant | æ·»åŠ å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡(ç¬¬20ç« )ã€å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„(ç¬¬21ç« )ã€å¯è§‚æµ‹æ€§ä¸ç›‘æ§(ç¬¬22ç« ) |
| 0.4 | 2026-01-01 | AI Assistant | æ·»åŠ æ‡’äººè®¾è®¡åŸåˆ™(ç¬¬3ç« )ï¼šæ“ä½œæ•ˆç‡ä¼˜åŒ–æ¨¡å‹ã€æ™ºèƒ½åŒ–è‡ªåŠ¨é…ç½®ç³»ç»Ÿã€ä¸€é”®æ“ä½œè®¾è®¡ |
| 0.5 | 2026-01-01 | AI Assistant | æ·»åŠ æ ¸å¿ƒç›®æ ‡è¾¾æˆæ ‡å‡†ä¸æ£€æµ‹æœºåˆ¶(ç¬¬1.4èŠ‚)ï¼šäº”å¤§æ ¸å¿ƒç›®æ ‡çš„é‡åŒ–è¯„ä¼°æ ‡å‡†ã€æ£€æµ‹æœåŠ¡ã€ä»ªè¡¨ç›˜ |
| 0.6 | 2026-01-02 | AI Assistant | é‡æ„ç« èŠ‚ç¼–å·ã€æ·»åŠ æµ‹è¯•ç­–ç•¥(ç¬¬20ç« )ã€æ·»åŠ æ— éšœç¢è®¾è®¡(ç¬¬5ç« )ï¼Œä¿®å¤ç›®å½•ä¸å†…å®¹ä¸ä¸€è‡´é—®é¢˜ |
| 0.7 | 2026-01-02 | AI Assistant | æ·»åŠ å•æ‰‹æ“ä½œè®¾è®¡è§„èŒƒ(ç¬¬23.6èŠ‚)ã€ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™(ç¬¬4ç« )ï¼šåŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿã€æƒ…æ„Ÿäº¤äº’ã€æ™ºèƒ½è§¦å‘ |

---

*æœ¬æ–‡æ¡£ä¸º AIæ™ºèƒ½è®°è´¦ 2.0 ç‰ˆæœ¬çš„ç»¼åˆè®¾è®¡æ–¹æ¡ˆï¼Œå°†éšç€å¼€å‘è¿›å±•æŒç»­æ›´æ–°ã€‚*

---

## 5. æ— éšœç¢è®¾è®¡

æœ¬ç« èŠ‚ç¡®ä¿åº”ç”¨å¯¹æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬è§†åŠ›éšœç¢ã€å¬åŠ›éšœç¢ã€è¿åŠ¨éšœç¢ç­‰ç”¨æˆ·ï¼‰éƒ½å…·æœ‰è‰¯å¥½çš„å¯è®¿é—®æ€§ï¼Œè®©AIæ™ºèƒ½è®°è´¦2.0æˆä¸ºçœŸæ­£æ„ä¹‰ä¸Šçš„"äººäººå¯ç”¨"äº§å“ã€‚

### 5.0 è®¾è®¡åŸåˆ™å›é¡¾

#### 24.0.1 æ— éšœç¢è®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ— éšœç¢è®¾è®¡ - è®¾è®¡åŸåˆ™åº”ç”¨çŸ©é˜µ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å•ä¸€èŒè´£   â”‚    â”‚ æ•°æ®ä¸€è‡´æ€§  â”‚    â”‚  æç®€è®¾è®¡   â”‚    â”‚  å¯æ‰©å±•æ€§   â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ æ— éšœç¢æœåŠ¡  â”‚    â”‚ è¯­ä¹‰ä¸€è‡´    â”‚    â”‚ æœ€å°‘äº¤äº’    â”‚    â”‚ è¾…åŠ©æŠ€æœ¯    â”‚      â”‚
â”‚  â”‚ ç‹¬ç«‹å°è£…    â”‚    â”‚ æ ‡ç­¾å‡†ç¡®    â”‚    â”‚ æ“ä½œç®€åŒ–    â”‚    â”‚ æ¥å£æ ‡å‡†    â”‚      â”‚
â”‚  â”‚ æŒ‰åœºæ™¯æ‹†åˆ†  â”‚    â”‚ çŠ¶æ€åŒæ­¥    â”‚    â”‚ ä¿¡æ¯èšç„¦    â”‚    â”‚ å¯é…ç½®æ€§    â”‚      â”‚
â”‚  â”‚ ç»Ÿä¸€è°ƒç”¨    â”‚    â”‚ åé¦ˆåŠæ—¶    â”‚    â”‚ è‡ªåŠ¨é€‚é…    â”‚    â”‚ æ¸è¿›å¢å¼º    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                     WCAG 2.1 æ ¸å¿ƒå‡†åˆ™                            â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚           â”‚
â”‚  â”‚  â”‚  å¯æ„ŸçŸ¥ â†’ å¯æ“ä½œ â†’ å¯ç†è§£ â†’ å¥å£®æ€§                        â”‚   â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚                                                      â”‚                â”‚
â”‚         â–¼                                                      â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æ€§èƒ½ä¼˜åŒ–   â”‚                                        â”‚  å¯è§‚æµ‹æ€§   â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ è¯­ä¹‰ç¼“å­˜    â”‚                                        â”‚ æ— éšœç¢å®¡è®¡  â”‚        â”‚
â”‚  â”‚ å»¶è¿ŸåŠ è½½    â”‚                                        â”‚ é—®é¢˜è¿½è¸ª    â”‚        â”‚
â”‚  â”‚ è½»é‡è®¡ç®—    â”‚                                        â”‚ ç”¨æˆ·åé¦ˆ    â”‚        â”‚
â”‚  â”‚ å¼‚æ­¥æ’­æŠ¥    â”‚                                        â”‚ åˆè§„æŠ¥å‘Š    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.0.2 è®¾è®¡ç†å¿µ

| è®¾è®¡ç»´åº¦ | åœ¨æ— éšœç¢è®¾è®¡çš„ä½“ç° | å…·ä½“å®ç° |
|---------|------------------|---------|
| **å•ä¸€èŒè´£** | æ— éšœç¢æœåŠ¡ç‹¬ç«‹å°è£… | SemanticLabelServiceã€AccessibleColorServiceã€TouchTargetServiceå„å¸å…¶èŒ |
| **æ•°æ®ä¸€è‡´æ€§** | è¯­ä¹‰æ ‡ç­¾ä¸UIåŒæ­¥ | é‡‘é¢å˜åŒ–æ—¶è¯­ä¹‰æ ‡ç­¾åŒæ­¥æ›´æ–°ï¼›çŠ¶æ€å˜åŒ–åŠæ—¶é€šçŸ¥è¾…åŠ©æŠ€æœ¯ |
| **æç®€è®¾è®¡** | æœ€å°‘äº¤äº’å®Œæˆæ“ä½œ | è¯­éŸ³è®°è´¦ä¸€å¥è¯å®Œæˆï¼›å‡å°‘æ“ä½œæ­¥éª¤ï¼›æ™ºèƒ½é»˜è®¤å€¼ |
| **å¯æ‰©å±•æ€§** | æ”¯æŒå¤šç§è¾…åŠ©æŠ€æœ¯ | å…¼å®¹TalkBack/VoiceOverï¼›æ”¯æŒå¤–æ¥è®¾å¤‡ï¼›å¼€æ”¾æ— éšœç¢API |
| **æ€§èƒ½ä¼˜åŒ–** | è¯­ä¹‰è®¡ç®—è½»é‡åŒ– | è¯­ä¹‰æ ‡ç­¾ç¼“å­˜ï¼›å¼‚æ­¥æ’­æŠ¥ï¼›é¿å…é˜»å¡ä¸»çº¿ç¨‹ |
| **å¯è§‚æµ‹æ€§** | æ— éšœç¢é—®é¢˜å¯è¿½è¸ª | å®¡è®¡æŠ¥å‘Šç”Ÿæˆï¼›ç”¨æˆ·åé¦ˆæ”¶é›†ï¼›WCAGåˆè§„æ£€æµ‹ |

#### 24.0.3 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ— éšœç¢è®¾è®¡ - ç³»ç»ŸååŒå…¨æ™¯å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚     æ— éšœç¢è®¾è®¡         â”‚                              â”‚
â”‚                          â”‚  AccessibilityService â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                      â”‚                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚             â”‚           â”‚               â”‚           â”‚             â”‚       â”‚
â”‚    â–¼             â–¼           â–¼               â–¼           â–¼             â–¼       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚è¯­éŸ³è®°è´¦â”‚  â”‚é’±é¾„å±•ç¤ºâ”‚  â”‚ é¢„ç®—ç®¡ç†  â”‚  â”‚ äº¤æ˜“åˆ—è¡¨  â”‚  â”‚æŠ¥è¡¨ç»Ÿè®¡â”‚  â”‚è®¾ç½®é¡µé¢   â”‚  â”‚
â”‚ â”‚       â”‚  â”‚       â”‚  â”‚           â”‚  â”‚           â”‚  â”‚       â”‚  â”‚           â”‚  â”‚
â”‚ â”‚è¯­éŸ³åé¦ˆâ”‚  â”‚è¯­ä¹‰æ ‡ç­¾â”‚  â”‚çŠ¶æ€æ’­æŠ¥   â”‚  â”‚åˆ—è¡¨å¯¼èˆª   â”‚  â”‚å›¾è¡¨æè¿°â”‚  â”‚å¿«æ·æ“ä½œ   â”‚  â”‚
â”‚ â”‚è¯†åˆ«ç»“æœâ”‚  â”‚é¢œè‰²å¯¹æ¯”â”‚  â”‚è¿›åº¦æç¤º   â”‚  â”‚é¡¹ç›®è¯­ä¹‰   â”‚  â”‚æ•°æ®æ‘˜è¦â”‚  â”‚åå¥½è®¾ç½®   â”‚  â”‚
â”‚ â”‚æœ—è¯»ç¡®è®¤â”‚  â”‚è§¦è§‰åé¦ˆâ”‚  â”‚è¶…æ”¯è­¦å‘Š   â”‚  â”‚æ‰‹åŠ¿æ”¯æŒ   â”‚  â”‚è¶‹åŠ¿è¯´æ˜â”‚  â”‚è¾…åŠ©é€‰é¡¹   â”‚  â”‚
â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚          â”‚            â”‚              â”‚            â”‚            â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚             æ— éšœç¢ä½“éªŒå±‚                      â”‚                   â”‚
â”‚              â”‚  è¯­ä¹‰åŒ– â†’ å¯æ„ŸçŸ¥ â†’ å¯æ“ä½œ â†’ å¯ç†è§£ â†’ å¥å£®    â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                         è¾…åŠ©æŠ€æœ¯æ”¯æŒçŸ©é˜µ                             â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ å±å¹•é˜…è¯»å™¨    â”‚ è¯­éŸ³æ§åˆ¶       â”‚ æ”¾å¤§/ç¼©æ”¾     â”‚ å¼€å…³æ§åˆ¶          â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ â€¢ TalkBack    â”‚ â€¢ è¯­éŸ³å‘½ä»¤     â”‚ â€¢ æ–‡å­—ç¼©æ”¾    â”‚ â€¢ å¤–æ¥å¼€å…³        â”‚       â”‚
â”‚  â”‚ â€¢ VoiceOver   â”‚ â€¢ è¯­éŸ³å¯¼èˆª     â”‚ â€¢ ç•Œé¢æ”¾å¤§    â”‚ â€¢ æ‰«ææ¨¡å¼        â”‚       â”‚
â”‚  â”‚ â€¢ è¯­ä¹‰æ ‡ç­¾    â”‚ â€¢ è¯­éŸ³è®°è´¦     â”‚ â€¢ é«˜å¯¹æ¯”æ¨¡å¼  â”‚ â€¢ å•ç‚¹æ‰«æ        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.1 æ— éšœç¢è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ— éšœç¢è®¾è®¡å››åŸåˆ™                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   å¯æ„ŸçŸ¥        â”‚  â”‚   å¯æ“ä½œ        â”‚  â”‚   å¯ç†è§£        â”‚         â”‚
â”‚  â”‚  Perceivable   â”‚  â”‚   Operable     â”‚  â”‚  Understandable â”‚         â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚ ä¿¡æ¯å’Œç•Œé¢ç»„ä»¶  â”‚  â”‚ ç”¨æˆ·ç•Œé¢ç»„ä»¶å’Œ  â”‚  â”‚ ä¿¡æ¯å’Œç”¨æˆ·ç•Œé¢  â”‚         â”‚
â”‚  â”‚ å¿…é¡»ä»¥ç”¨æˆ·å¯æ„Ÿ  â”‚  â”‚ å¯¼èˆªå¿…é¡»æ˜¯å¯æ“  â”‚  â”‚ çš„æ“ä½œå¿…é¡»æ˜¯å¯  â”‚         â”‚
â”‚  â”‚ çŸ¥çš„æ–¹å¼å‘ˆç°    â”‚  â”‚ ä½œçš„            â”‚  â”‚ ç†è§£çš„          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                        å¥å£®æ€§ Robust                         â”‚       â”‚
â”‚  â”‚   å†…å®¹å¿…é¡»è¶³å¤Ÿå¥å£®ï¼Œèƒ½å¤Ÿè¢«å„ç§ç”¨æˆ·ä»£ç†ï¼ˆåŒ…æ‹¬è¾…åŠ©æŠ€æœ¯ï¼‰å¯é è§£æ   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è§†è§‰æ— éšœç¢

#### 5.2.1 å±å¹•é˜…è¯»å™¨æ”¯æŒ

```dart
/// è¯­ä¹‰åŒ–æ ‡ç­¾æœåŠ¡
class SemanticLabelService {
  /// ä¸ºæ‰€æœ‰äº¤äº’å…ƒç´ æä¾›è¯­ä¹‰æ ‡ç­¾
  static Widget wrapWithSemantics({
    required Widget child,
    required String label,
    String? hint,
    String? value,
    bool isButton = false,
    bool isHeader = false,
    VoidCallback? onTap,
  }) {
    return Semantics(
      label: label,
      hint: hint,
      value: value,
      button: isButton,
      header: isHeader,
      onTap: onTap,
      child: child,
    );
  }

  /// é‡‘é¢è¯­ä¹‰æ ‡ç­¾
  static String formatAmountForScreenReader(double amount, String currency) {
    final isNegative = amount < 0;
    final absAmount = amount.abs();
    final formatted = absAmount.toStringAsFixed(2);
    final parts = formatted.split('.');

    return '${isNegative ? "æ”¯å‡º" : "æ”¶å…¥"} '
           '${parts[0]} ${currency} ${parts[1]} åˆ†';
  }

  /// é’±é¾„è¯­ä¹‰æ ‡ç­¾
  static String formatMoneyAgeForScreenReader(int days, MoneyAgeLevel level) {
    final levelText = switch (level) {
      MoneyAgeLevel.ideal => 'è´¢åŠ¡è‡ªç”±',
      MoneyAgeLevel.excellent => 'éå¸¸å¥åº·',
      MoneyAgeLevel.good => 'è‰¯å¥½',
      MoneyAgeLevel.normal => 'ä¸€èˆ¬',
      MoneyAgeLevel.warning => 'éœ€è¦å…³æ³¨',
      MoneyAgeLevel.danger => 'éœ€è¦æ”¹å–„',
    };
    return 'é’±é¾„ $days å¤©ï¼ŒçŠ¶æ€ $levelText';
  }
}

/// å±å¹•é˜…è¯»å™¨å‹å¥½çš„é‡‘é¢å¡ç‰‡
class AccessibleAmountCard extends StatelessWidget {
  final double amount;
  final String title;
  final String currency;

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: '$title: ${SemanticLabelService.formatAmountForScreenReader(amount, currency)}',
      child: ExcludeSemantics(
        child: Card(
          child: Column(
            children: [
              Text(title),
              Text('$currency ${amount.toStringAsFixed(2)}'),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 5.2.2 è‰²å½©å¯¹æ¯”åº¦

```dart
/// æ— éšœç¢é¢œè‰²æœåŠ¡
class AccessibleColorService {
  /// WCAG 2.1 AAçº§åˆ«è¦æ±‚çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioAA = 4.5;
  /// WCAG 2.1 AAAçº§åˆ«è¦æ±‚çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioAAA = 7.0;
  /// å¤§æ–‡æœ¬çš„æœ€ä½å¯¹æ¯”åº¦
  static const double minContrastRatioLargeText = 3.0;

  /// è®¡ç®—ä¸¤ä¸ªé¢œè‰²çš„å¯¹æ¯”åº¦
  static double calculateContrastRatio(Color foreground, Color background) {
    final l1 = _calculateRelativeLuminance(foreground);
    final l2 = _calculateRelativeLuminance(background);
    final lighter = l1 > l2 ? l1 : l2;
    final darker = l1 > l2 ? l2 : l1;
    return (lighter + 0.05) / (darker + 0.05);
  }

  static double _calculateRelativeLuminance(Color color) {
    final r = _linearize(color.red / 255);
    final g = _linearize(color.green / 255);
    final b = _linearize(color.blue / 255);
    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
  }

  static double _linearize(double value) {
    return value <= 0.03928
        ? value / 12.92
        : pow((value + 0.055) / 1.055, 2.4).toDouble();
  }

  /// è·å–æ— éšœç¢å‹å¥½çš„å‰æ™¯è‰²
  static Color getAccessibleForeground(Color background, {bool largeText = false}) {
    final minRatio = largeText ? minContrastRatioLargeText : minContrastRatioAA;

    // é¦–é€‰é»‘è‰²
    if (calculateContrastRatio(Colors.black, background) >= minRatio) {
      return Colors.black;
    }
    // å¦åˆ™ä½¿ç”¨ç™½è‰²
    return Colors.white;
  }

  /// éªŒè¯é¢œè‰²ç»„åˆæ˜¯å¦ç¬¦åˆæ— éšœç¢è¦æ±‚
  static bool isAccessibleColorCombination(
    Color foreground,
    Color background, {
    bool largeText = false,
    AccessibilityLevel level = AccessibilityLevel.aa,
  }) {
    final ratio = calculateContrastRatio(foreground, background);
    final minRatio = switch ((level, largeText)) {
      (AccessibilityLevel.aa, true) => minContrastRatioLargeText,
      (AccessibilityLevel.aa, false) => minContrastRatioAA,
      (AccessibilityLevel.aaa, true) => minContrastRatioAA,
      (AccessibilityLevel.aaa, false) => minContrastRatioAAA,
    };
    return ratio >= minRatio;
  }
}

enum AccessibilityLevel { aa, aaa }
```

#### 5.2.3 æ–‡å­—ç¼©æ”¾æ”¯æŒ

```dart
/// æ–‡å­—ç¼©æ”¾æœåŠ¡
class TextScalingService {
  /// æ”¯æŒçš„æ–‡å­—ç¼©æ”¾èŒƒå›´
  static const double minScale = 0.8;
  static const double maxScale = 2.0;
  static const double defaultScale = 1.0;

  /// åˆ›å»ºå“åº”å¼æ–‡å­—æ ·å¼
  static TextStyle createResponsiveTextStyle({
    required double baseFontSize,
    FontWeight? fontWeight,
    Color? color,
  }) {
    return TextStyle(
      fontSize: baseFontSize,
      fontWeight: fontWeight,
      color: color,
    );
  }

  /// è‡ªé€‚åº”é—´è·è®¡ç®—
  static double calculateResponsiveSpacing(
    BuildContext context,
    double baseSpacing,
  ) {
    final textScaleFactor = MediaQuery.of(context).textScaleFactor;
    return baseSpacing * (1 + (textScaleFactor - 1) * 0.5);
  }
}

/// æ”¯æŒæ–‡å­—ç¼©æ”¾çš„å¸ƒå±€
class AccessibleLayout extends StatelessWidget {
  final Widget child;

  @override
  Widget build(BuildContext context) {
    final textScaleFactor = MediaQuery.of(context).textScaleFactor;

    // å½“æ–‡å­—æ”¾å¤§æ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´å¸ƒå±€
    if (textScaleFactor > 1.3) {
      return SingleChildScrollView(
        child: child,
      );
    }
    return child;
  }
}
```

### 5.3 æ“ä½œæ— éšœç¢

#### 5.3.1 è§¦æ§ç›®æ ‡å°ºå¯¸

```dart
/// è§¦æ§ç›®æ ‡æ— éšœç¢æœåŠ¡
class TouchTargetService {
  /// æœ€å°è§¦æ§ç›®æ ‡å°ºå¯¸ (WCAG 2.5.5 è¦æ±‚ 44x44 é€»è¾‘åƒç´ )
  static const double minTouchTarget = 48.0;

  /// ç¡®ä¿è§¦æ§ç›®æ ‡å°ºå¯¸è¶³å¤Ÿå¤§
  static Widget ensureMinTouchTarget({
    required Widget child,
    VoidCallback? onTap,
  }) {
    return ConstrainedBox(
      constraints: BoxConstraints(
        minWidth: minTouchTarget,
        minHeight: minTouchTarget,
      ),
      child: InkWell(
        onTap: onTap,
        child: Center(child: child),
      ),
    );
  }

  /// åˆ›å»ºæ— éšœç¢æŒ‰é’®
  static Widget createAccessibleButton({
    required Widget child,
    required VoidCallback onPressed,
    required String semanticLabel,
  }) {
    return Semantics(
      button: true,
      label: semanticLabel,
      child: Material(
        child: InkWell(
          onTap: onPressed,
          child: ConstrainedBox(
            constraints: BoxConstraints(
              minWidth: minTouchTarget,
              minHeight: minTouchTarget,
            ),
            child: Center(child: child),
          ),
        ),
      ),
    );
  }
}
```

#### 5.3.2 é”®ç›˜å¯¼èˆª

```dart
/// é”®ç›˜å¯¼èˆªæœåŠ¡
class KeyboardNavigationService {
  /// ä¸ºWidgetæ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
  static Widget addKeyboardShortcuts({
    required Widget child,
    Map<ShortcutActivator, VoidCallback>? shortcuts,
  }) {
    if (shortcuts == null || shortcuts.isEmpty) {
      return child;
    }

    return Shortcuts(
      shortcuts: {
        for (final entry in shortcuts.entries)
          entry.key: VoidCallbackIntent(entry.value),
      },
      child: Actions(
        actions: {
          VoidCallbackIntent: CallbackAction<VoidCallbackIntent>(
            onInvoke: (intent) => intent.callback(),
          ),
        },
        child: Focus(
          autofocus: true,
          child: child,
        ),
      ),
    );
  }
}

/// å…¨å±€é”®ç›˜å¿«æ·é”®
class GlobalKeyboardShortcuts {
  static final shortcuts = {
    // è®°è´¦ç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.keyN, LogicalKeyboardKey.control):
        'new_transaction',
    LogicalKeySet(LogicalKeyboardKey.keyS, LogicalKeyboardKey.control):
        'save',

    // å¯¼èˆªç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.keyH, LogicalKeyboardKey.alt):
        'go_home',
    LogicalKeySet(LogicalKeyboardKey.keyB, LogicalKeyboardKey.alt):
        'go_budget',
    LogicalKeySet(LogicalKeyboardKey.keyT, LogicalKeyboardKey.alt):
        'go_transactions',

    // æ“ä½œç›¸å…³
    LogicalKeySet(LogicalKeyboardKey.escape): 'cancel',
    LogicalKeySet(LogicalKeyboardKey.enter): 'confirm',
  };
}
```

#### 5.3.3 ç„¦ç‚¹ç®¡ç†

```dart
/// ç„¦ç‚¹ç®¡ç†æœåŠ¡
class FocusManagementService {
  /// ç¡®ä¿å¯¹è¯æ¡†æ‰“å¼€æ—¶ç„¦ç‚¹æ­£ç¡®ç®¡ç†
  static Future<T?> showAccessibleDialog<T>({
    required BuildContext context,
    required WidgetBuilder builder,
    String? semanticLabel,
  }) {
    return showDialog<T>(
      context: context,
      builder: (context) {
        return Semantics(
          label: semanticLabel,
          scopesRoute: true,
          namesRoute: true,
          child: builder(context),
        );
      },
    );
  }

  /// åˆ›å»ºå¸¦ç„¦ç‚¹é™·é˜±çš„æ¨¡æ€
  static Widget createFocusTrap({
    required Widget child,
  }) {
    return FocusTraversalGroup(
      policy: OrderedTraversalPolicy(),
      child: child,
    );
  }
}
```

### 5.4 è®¤çŸ¥æ— éšœç¢

#### 5.4.1 æ¸…æ™°çš„é”™è¯¯æç¤º

```dart
/// æ— éšœç¢é”™è¯¯æç¤ºæœåŠ¡
class AccessibleErrorService {
  /// åˆ›å»ºæ— éšœç¢é”™è¯¯æç¤º
  static Widget createAccessibleError({
    required String errorMessage,
    String? suggestion,
    VoidCallback? onRetry,
  }) {
    return Semantics(
      liveRegion: true,  // è‡ªåŠ¨æœ—è¯»
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.red.shade50,
          border: Border.all(color: Colors.red, width: 2),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.error, color: Colors.red),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    errorMessage,
                    style: TextStyle(
                      color: Colors.red.shade900,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            if (suggestion != null) ...[
              SizedBox(height: 8),
              Text(
                suggestion,
                style: TextStyle(color: Colors.red.shade700),
              ),
            ],
            if (onRetry != null) ...[
              SizedBox(height: 12),
              TouchTargetService.createAccessibleButton(
                child: Text('é‡è¯•'),
                onPressed: onRetry,
                semanticLabel: 'é‡è¯•æ“ä½œ',
              ),
            ],
          ],
        ),
      ),
    );
  }
}
```

#### 5.4.2 æ“ä½œç¡®è®¤ä¸æ’¤é”€

```dart
/// æ“ä½œç¡®è®¤æœåŠ¡
class ActionConfirmationService {
  /// åˆ é™¤æ“ä½œç¡®è®¤ï¼ˆå¸¦æ’¤é”€é€‰é¡¹ï¼‰
  static Future<bool> confirmDeletion({
    required BuildContext context,
    required String itemName,
    required Future<void> Function() onDelete,
    required Future<void> Function() onUndo,
  }) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Semantics(
          header: true,
          child: Text('ç¡®è®¤åˆ é™¤'),
        ),
        content: Text('ç¡®å®šè¦åˆ é™¤ "$itemName" å—ï¼Ÿæ­¤æ“ä½œå¯ä»¥æ’¤é”€ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text('åˆ é™¤', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    if (confirmed == true) {
      await onDelete();

      // æ˜¾ç¤ºæ’¤é”€æç¤º
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Semantics(
            liveRegion: true,
            child: Text('å·²åˆ é™¤ "$itemName"'),
          ),
          action: SnackBarAction(
            label: 'æ’¤é”€',
            onPressed: () async {
              await onUndo();
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Semantics(
                    liveRegion: true,
                    child: Text('å·²æ¢å¤ "$itemName"'),
                  ),
                ),
              );
            },
          ),
          duration: Duration(seconds: 5),
        ),
      );
      return true;
    }
    return false;
  }
}
```

### 5.5 æ— éšœç¢æµ‹è¯•æ¸…å•

| æµ‹è¯•é¡¹ç›® | æµ‹è¯•æ–¹æ³• | åˆæ ¼æ ‡å‡† |
|---------|---------|---------|
| å±å¹•é˜…è¯»å™¨ | ä½¿ç”¨TalkBack/VoiceOver | æ‰€æœ‰äº¤äº’å…ƒç´ å¯æœ—è¯»ä¸”æœ‰æ„ä¹‰ |
| è‰²å½©å¯¹æ¯”åº¦ | ä½¿ç”¨å¯¹æ¯”åº¦æ£€æŸ¥å·¥å…· | æ–‡å­—å¯¹æ¯”åº¦â‰¥4.5:1 |
| è§¦æ§ç›®æ ‡ | æµ‹é‡è§¦æ§åŒºåŸŸ | â‰¥48x48é€»è¾‘åƒç´  |
| é”®ç›˜å¯¼èˆª | ä»…ä½¿ç”¨é”®ç›˜æ“ä½œ | æ‰€æœ‰åŠŸèƒ½å¯è®¿é—® |
| æ–‡å­—ç¼©æ”¾ | æ”¾å¤§åˆ°200% | å†…å®¹ä¸ä¸¢å¤±ï¼Œå¯æ»šåŠ¨æŸ¥çœ‹ |
| åŠ¨ç”»å‡å¼± | å¼€å¯å‡å°‘åŠ¨ç”» | å°Šé‡ç³»ç»Ÿè®¾ç½® |
| é”™è¯¯æç¤º | è§¦å‘å„ç±»é”™è¯¯ | æç¤ºæ¸…æ™°ï¼Œæœ‰è§£å†³å»ºè®® |
| è¡¨å•éªŒè¯ | æäº¤é”™è¯¯æ•°æ® | é”™è¯¯ä¿¡æ¯å…³è”åˆ°å­—æ®µ |

### 5.6 æ— éšœç¢å®¡è®¡å·¥å…·

```dart
/// æ— éšœç¢å®¡è®¡æœåŠ¡
class AccessibilityAuditService {
  /// è¿è¡Œæ— éšœç¢å®¡è®¡
  static Future<AccessibilityAuditReport> runAudit(Widget widget) async {
    final issues = <AccessibilityIssue>[];

    // æ£€æŸ¥è¯­ä¹‰æ ‡ç­¾
    final semanticsIssues = await _checkSemantics(widget);
    issues.addAll(semanticsIssues);

    // æ£€æŸ¥é¢œè‰²å¯¹æ¯”åº¦
    final contrastIssues = await _checkColorContrast(widget);
    issues.addAll(contrastIssues);

    // æ£€æŸ¥è§¦æ§ç›®æ ‡å°ºå¯¸
    final touchIssues = await _checkTouchTargets(widget);
    issues.addAll(touchIssues);

    return AccessibilityAuditReport(
      timestamp: DateTime.now(),
      issues: issues,
      passedChecks: _countPassedChecks(issues),
      totalChecks: issues.length + _countPassedChecks(issues),
    );
  }

  static int _countPassedChecks(List<AccessibilityIssue> issues) {
    // å®ç°çœç•¥
    return 0;
  }
}

/// æ— éšœç¢é—®é¢˜
class AccessibilityIssue {
  final AccessibilityIssueType type;
  final AccessibilitySeverity severity;
  final String description;
  final String? recommendation;
  final String? elementPath;

  AccessibilityIssue({
    required this.type,
    required this.severity,
    required this.description,
    this.recommendation,
    this.elementPath,
  });
}

enum AccessibilityIssueType {
  missingSemanticLabel,
  lowContrastRatio,
  smallTouchTarget,
  missingFocusOrder,
  noKeyboardAccess,
}

enum AccessibilitySeverity {
  error,    // å¿…é¡»ä¿®å¤
  warning,  // åº”è¯¥ä¿®å¤
  info,     // å»ºè®®æ”¹è¿›
}
```

### 5.7 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 5.7.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ— éšœç¢è®¾è®¡ - ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚    æ— éšœç¢æœåŠ¡ä¸­å¿ƒ      â”‚                              â”‚
â”‚                          â”‚ AccessibilityService  â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â–¼             â–¼           â–¼               â–¼           â–¼             â–¼       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚è¯­éŸ³è®°è´¦â”‚  â”‚é’±é¾„ç³»ç»Ÿâ”‚  â”‚ é¢„ç®—ç³»ç»Ÿ  â”‚  â”‚ äº¤æ˜“ç³»ç»Ÿ  â”‚  â”‚æŠ¥è¡¨ç³»ç»Ÿâ”‚  â”‚æ™ºèƒ½åŒ–ç³»ç»Ÿ â”‚  â”‚
â”‚ â”‚ (18ç« )â”‚  â”‚ (7ç« ) â”‚  â”‚  (8ç« )   â”‚  â”‚  (6ç« )   â”‚  â”‚ (12ç« )â”‚  â”‚  (10ç« )  â”‚  â”‚
â”‚ â”‚è¯­éŸ³åé¦ˆâ”‚  â”‚è¯­ä¹‰æè¿°â”‚  â”‚è¿›åº¦æ’­æŠ¥   â”‚  â”‚åˆ—è¡¨è¯­ä¹‰   â”‚  â”‚å›¾è¡¨æè¿°â”‚  â”‚AIè¯­éŸ³äº¤äº’ â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                              2.0æ–°å¢æ— éšœç¢é›†æˆ                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ å®¶åº­è´¦æœ¬  â”‚  â”‚ ä¹ æƒ¯åŸ¹å…»  â”‚  â”‚ ä½ç½®æ™ºèƒ½  â”‚  â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ â”‚  â”‚ ä¼™ä¼´åŒ–    â”‚     â”‚
â”‚ â”‚  (13ç« )  â”‚  â”‚  (9ç« )   â”‚  â”‚  (14ç« )  â”‚  â”‚  (17ç« )  â”‚  â”‚  (4ç« )   â”‚     â”‚
â”‚ â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚     â”‚
â”‚ â”‚ æˆå‘˜è¯­ä¹‰  â”‚  â”‚ æˆå°±æ’­æŠ¥  â”‚  â”‚ ä½ç½®æ’­æŠ¥  â”‚  â”‚ æ™ºèƒ½é€‚é…  â”‚  â”‚ æƒ…æ„ŸåŒ–è¯­éŸ³ â”‚     â”‚
â”‚ â”‚ åä½œæé†’  â”‚  â”‚ è¿›åº¦æè¿°  â”‚  â”‚ å›´æ æé†’  â”‚  â”‚ ä¸ªæ€§ç®€åŒ–  â”‚  â”‚ é¼“åŠ±æœ—è¯»  â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.7.1 é›†æˆè§¦å‘ç‚¹

| é›†æˆæ¨¡å— | è§¦å‘åœºæ™¯ | æ— éšœç¢å¤„ç† | è¾…åŠ©æŠ€æœ¯è¾“å‡º |
|---------|---------|-----------|-------------|
| **è¯­éŸ³è®°è´¦** | è¯­éŸ³è¯†åˆ«å®Œæˆ | ç»“æœæœ—è¯»ç¡®è®¤ | TTSæ’­æŠ¥è¯†åˆ«å†…å®¹ |
| **é’±é¾„ç³»ç»Ÿ** | é’±é¾„æ•°æ®å±•ç¤º | è¯­ä¹‰åŒ–æè¿° | "æ‚¨çš„é’±é¾„15å¤©ï¼ŒçŠ¶æ€å¥åº·" |
| **é¢„ç®—ç³»ç»Ÿ** | é¢„ç®—ä½¿ç”¨ç‡å˜åŒ– | è¿›åº¦æ’­æŠ¥ | "é¤é¥®é¢„ç®—å·²ç”¨80%ï¼Œå‰©ä½™200å…ƒ" |
| **äº¤æ˜“ç³»ç»Ÿ** | äº¤æ˜“åˆ—è¡¨æ»šåŠ¨ | é¡¹ç›®è¯­ä¹‰æ ‡ç­¾ | "æ”¯å‡º50å…ƒï¼Œæ˜Ÿå·´å…‹ï¼Œå’–å•¡" |
| **æŠ¥è¡¨ç³»ç»Ÿ** | å›¾è¡¨å±•ç¤º | æ•°æ®æè¿°ç”Ÿæˆ | "æœ¬æœˆæ”¯å‡ºè¶‹åŠ¿ä¸Šå‡15%" |
| **æ™ºèƒ½åŒ–ç³»ç»Ÿ** | å¯¹è¯å¼äº¤äº’ | è‡ªç„¶è¯­è¨€å“åº” | AIè¯­éŸ³å¯¹è¯åé¦ˆ |

#### 5.7.2 ä¸è¯­éŸ³è®°è´¦ç³»ç»Ÿé›†æˆ

```dart
/// è¯­éŸ³è®°è´¦æ— éšœç¢é›†æˆ
class VoiceAccountingAccessibility {
  final TtsService _tts;
  final HapticService _haptic;

  Future<void> onRecordingStart() async {
    await _haptic.vibrate(duration: 100);
    await _tts.speak('å¼€å§‹å½•éŸ³ï¼Œè¯·è¯´å‡ºæ‚¨çš„è®°è´¦å†…å®¹');
  }

  Future<void> onTransactionSaved(Transaction tx) async {
    await _haptic.vibrate(pattern: [100, 50, 100]);
    await _tts.speak('è®°è´¦æˆåŠŸï¼${tx.amount}å…ƒ');
  }
}
```

#### 5.7.3 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// é’±é¾„ç³»ç»Ÿæ— éšœç¢é›†æˆ
class MoneyAgeAccessibility {
  static String describeMoneyAge({required int age, required MoneyAgeLevel level}) {
    final levelText = switch (level) {
      MoneyAgeLevel.ideal => 'è´¢åŠ¡è‡ªç”±',
      MoneyAgeLevel.excellent => 'éå¸¸å¥åº·',
      MoneyAgeLevel.good => 'çŠ¶æ€è‰¯å¥½',
      _ => 'éœ€è¦å…³æ³¨',
    };
    return 'æ‚¨çš„èµ„é‡‘å¹³å‡æŒæœ‰$ageå¤©ï¼Œ$levelText';
  }
}
```

#### 5.7.4 ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// é¢„ç®—ç³»ç»Ÿæ— éšœç¢é›†æˆ
class BudgetAccessibility {
  static String describeBudgetUsage({
    required String name, required double rate, required double remaining,
  }) {
    if (rate >= 1.0) return '$nameé¢„ç®—å·²ç”¨å®Œ';
    if (rate >= 0.9) return '$nameé¢„ç®—å‘Šæ€¥ï¼Œå‰©ä½™${remaining.toInt()}å…ƒ';
    return '$nameé¢„ç®—æ­£å¸¸ï¼Œå‰©ä½™${remaining.toInt()}å…ƒ';
  }
}
```

#### 5.7.5 ä¸äº¤æ˜“ç³»ç»Ÿé›†æˆ

```dart
/// äº¤æ˜“ç³»ç»Ÿæ— éšœç¢é›†æˆ
class TransactionAccessibility {
  static String describeTransaction(Transaction tx) {
    final type = tx.type == TransactionType.expense ? 'æ”¯å‡º' : 'æ”¶å…¥';
    return '$type${tx.amount}å…ƒï¼Œ${tx.categoryName ?? "æœªåˆ†ç±»"}';
  }
}
```

#### 5.7.6 ä¸æŠ¥è¡¨ç³»ç»Ÿé›†æˆ

```dart
/// æŠ¥è¡¨ç³»ç»Ÿæ— éšœç¢é›†æˆ
class ReportAccessibility {
  static String generateSummary(ReportData data) {
    return 'æœ¬æœˆæ”¶å…¥${data.totalIncome.toInt()}å…ƒï¼Œæ”¯å‡º${data.totalExpense.toInt()}å…ƒï¼Œ'
           'ç»“ä½™${data.balance.toInt()}å…ƒ';
  }
}
```

#### 5.7.7 ä¸æ™ºèƒ½åŒ–ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½åŒ–ç³»ç»Ÿæ— éšœç¢é›†æˆ
class AIAccessibility {
  final TtsService _tts;

  Future<void> speakAIInsight(AIInsight insight) async {
    await _tts.speak('æ™ºèƒ½åˆ†æï¼š${insight.title}ã€‚${insight.description}');
  }
}
```

---


---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½

---

## 6. æ ¸å¿ƒåŠŸèƒ½æ¶æ„

### 6.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥æ ¸å¿ƒåŠŸèƒ½æ¶æ„ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ ¸å¿ƒåŠŸèƒ½æ¶æ„ - è®¾è®¡åŸåˆ™çŸ©é˜µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ¨¡å—å•ä¸€    â”‚  â”‚  æ•°æ®è”åŠ¨    â”‚  â”‚  æ¸è¿›å¤æ‚    â”‚  â”‚  æ’ä»¶æ‰©å±•    â”‚       â”‚
â”‚  â”‚  èŒè´£       â”‚  â”‚  ä¸€è‡´æ€§      â”‚  â”‚  åº¦è®¾è®¡      â”‚  â”‚  æ€§          â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æ¯æ¨¡å—ä¸“æ³¨  â”‚  â”‚ é’±é¾„/é¢„ç®—   â”‚  â”‚ åŸºç¡€â†’é«˜çº§   â”‚  â”‚ æ–°åŠŸèƒ½å¯    â”‚       â”‚
â”‚  â”‚ å•ä¸€åŠŸèƒ½    â”‚  â”‚ /ä¹ æƒ¯è”åŠ¨   â”‚  â”‚ åŠŸèƒ½é€’è¿›    â”‚  â”‚ çƒ­æ’æ‹”      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ€§èƒ½åˆ†å±‚    â”‚  â”‚  ç”¨æˆ·ä¸­å¿ƒ    â”‚  â”‚  æ™ºèƒ½å¢å¼º    â”‚  â”‚  å¯è§‚æµ‹æ€§    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æ ¸å¿ƒ/å¢å¼º   â”‚  â”‚ ä»¥ç”¨æˆ·ä¹ æƒ¯  â”‚  â”‚ AIè¾…åŠ©å†³ç­–  â”‚  â”‚ å…¨åŠŸèƒ½å¯    â”‚       â”‚
â”‚  â”‚ åŠŸèƒ½åˆ†ç¦»    â”‚  â”‚ åŸ¹å…»ä¸ºç›®æ ‡  â”‚  â”‚ è€Œéæ›¿ä»£    â”‚  â”‚ è¿½è¸ªç›‘æ§    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  æ ¸å¿ƒåŠŸèƒ½æ¶æ„ç†å¿µï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "é’±é¾„ä¸ºé­‚ï¼Œé¢„ç®—ä¸ºéª¨ï¼Œä¹ æƒ¯ä¸ºè¡€ï¼Œæ™ºèƒ½ä¸ºç¿¼"                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   é’±é¾„ä¸ºé­‚ â”€â”€â†’ é’±é¾„åˆ†æè´¯ç©¿æ‰€æœ‰åŠŸèƒ½ï¼Œæ˜¯æ ¸å¿ƒå·®å¼‚åŒ–ç‰¹æ€§                  â”‚   â”‚
â”‚  â”‚   é¢„ç®—ä¸ºéª¨ â”€â”€â†’ é›¶åŸºé¢„ç®—æä¾›è´¢åŠ¡è§„åˆ’çš„ç»“æ„åŒ–æ¡†æ¶                        â”‚   â”‚
â”‚  â”‚   ä¹ æƒ¯ä¸ºè¡€ â”€â”€â†’ ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿè®©åŠŸèƒ½æ´»èµ·æ¥ï¼Œå½¢æˆæ­£å‘å¾ªç¯                  â”‚   â”‚
â”‚  â”‚   æ™ºèƒ½ä¸ºç¿¼ â”€â”€â†’ AIæ™ºèƒ½åŒ–è®©è®°è´¦æ›´è½»æ¾ï¼Œé™ä½ç”¨æˆ·è´Ÿæ‹…                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.0.1 è®¾è®¡åŸåˆ™åœ¨åŠŸèƒ½æ¶æ„ä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | æ¶æ„åº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|---------|---------|---------|
| **å•ä¸€èŒè´£** | æ¨¡å—åŒ–è®¾è®¡ | è®°è´¦/é’±é¾„/é¢„ç®—/ä¹ æƒ¯/å®¶åº­/å¢é•¿ç‹¬ç«‹æ¨¡å— | æ¨¡å—å¯ç‹¬ç«‹è¿­ä»£ |
| **æ•°æ®ä¸€è‡´æ€§** | æ•°æ®è”åŠ¨ | äº¤æ˜“â†’é’±é¾„â†’é¢„ç®—â†’ä¹ æƒ¯â†’å®¶åº­è‡ªåŠ¨æµè½¬ | æ•°æ®é›¶æ‰‹åŠ¨åŒæ­¥ |
| **æç®€è®¾è®¡** | æ¸è¿›å¤æ‚åº¦ | æ ¸å¿ƒåŠŸèƒ½é›¶é…ç½®ï¼Œé«˜çº§åŠŸèƒ½æŒ‰éœ€å¯ç”¨ | æ–°ç”¨æˆ·5åˆ†é’Ÿä¸Šæ‰‹ |
| **å¯æ‰©å±•æ€§** | æ’ä»¶æ¶æ„ | åŠŸèƒ½æ¨¡å—çƒ­æ’æ‹”ï¼ŒAPIæ ‡å‡†åŒ– | æ–°æ¨¡å—1å‘¨å†…é›†æˆ |
| **æ€§èƒ½ä¼˜åŒ–** | åˆ†å±‚è®¡ç®— | æ ¸å¿ƒåŠŸèƒ½æœ¬åœ°åŒ–ï¼Œå¢å¼ºåŠŸèƒ½äº‘ç«¯åŒ– | æ ¸å¿ƒåŠŸèƒ½0å»¶è¿Ÿ |
| **å¯è§‚æµ‹æ€§** | å…¨é“¾è·¯è¿½è¸ª | åŠŸèƒ½ä½¿ç”¨ç‡ã€NPSã€è½¬åŒ–ç‡ã€ç•™å­˜ç‡ç›‘æ§ | åŠŸèƒ½å¥åº·åº¦å¯è§† |
| **ç”¨æˆ·å¢é•¿** | å¢é•¿å¼•æ“ | å£ç¢‘è£‚å˜ã€å®¶åº­é‚€è¯·ã€å†…å®¹è·å®¢ | CACâ‰¤30å…ƒ |

#### 6.0.2 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—åä½œå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒåŠŸèƒ½æ¨¡å—åä½œå…¨æ™¯å›¾ (2.0ç‰ˆ)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                              â”‚   ç”¨æˆ·äº¤äº’å±‚     â”‚                                 â”‚
â”‚                              â”‚  å¿«æ·è®°è´¦å…¥å£    â”‚                                 â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                       â”‚                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚                                 â”‚                                 â”‚        â”‚
â”‚     â–¼                                 â–¼                                 â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æ™ºèƒ½è¯­éŸ³äº¤äº’    â”‚       â”‚   å›¾åƒè®°è´¦       â”‚       â”‚   æ‰‹åŠ¨è®°è´¦       â”‚        â”‚
â”‚  â”‚   (ç¬¬18ç« )      â”‚       â”‚   (ç¬¬10ç« )      â”‚       â”‚                 â”‚        â”‚
â”‚  â”‚                 â”‚       â”‚                 â”‚       â”‚  æç®€è¾“å…¥       â”‚        â”‚
â”‚  â”‚ å¤šè½®å¯¹è¯/çº é”™  â”‚       â”‚ æ‹ç…§å³è®°è´¦     â”‚       â”‚                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                         â”‚                         â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                    â”‚    AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ (ç¬¬10ç« )       â”‚                           â”‚
â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                           â”‚
â”‚                    â”‚  â”‚  è¯­éŸ³è¯†åˆ«  â”‚  å›¾åƒè¯†åˆ«  â”‚     â”‚                           â”‚
â”‚                    â”‚  â”‚  æ„å›¾ç†è§£  â”‚  OCRè§£æ  â”‚     â”‚                           â”‚
â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                    â”‚                                             â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                           â”‚   äº¤æ˜“è®°å½•ä¸­å¿ƒ   â”‚                                    â”‚
â”‚                           â”‚ TransactionHub  â”‚                                    â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                    â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                                 â”‚                                 â”‚           â”‚
â”‚  â–¼                                 â–¼                                 â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   é’±é¾„ç³»ç»Ÿ      â”‚    â”‚   é¢„ç®—ç³»ç»Ÿ      â”‚    â”‚   å°é‡‘åº“ç³»ç»Ÿ    â”‚    â”‚ å®¶åº­è´¦æœ¬ â”‚ â”‚
â”‚  â”‚   (ç¬¬7ç« )      â”‚    â”‚   (ç¬¬8ç« )      â”‚    â”‚   (ç¬¬8ç« )      â”‚    â”‚ (ç¬¬13ç« ) â”‚ â”‚
â”‚  â”‚               â”‚    â”‚               â”‚    â”‚               â”‚    â”‚          â”‚ â”‚
â”‚  â”‚ æ¶ˆè´¹å¥åº·åº¦    â”‚    â”‚ é›¶åŸºé¢„ç®—åˆ†é…  â”‚    â”‚ ç›®æ ‡å‚¨è“„ç®¡ç†  â”‚    â”‚ å¤šæˆå‘˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ åä½œå…±äº« â”‚ â”‚
â”‚          â”‚                      â”‚                      â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â”‚                      â”‚                         â”‚
â”‚                                 â–¼                      â”‚                         â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                         â”‚
â”‚                    â”‚   é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                    â”‚       (ç¬¬9ç« )           â”‚                                   â”‚
â”‚                    â”‚                         â”‚                                   â”‚
â”‚                    â”‚ æ‰“å¡/æˆå°±/ä»»åŠ¡/æŒ‘æˆ˜     â”‚                                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                 â”‚                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚                             â”‚                             â”‚                  â”‚
â”‚   â–¼                             â–¼                             â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ    â”‚    â”‚ æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–  â”‚    â”‚  ç”¨æˆ·å¢é•¿ä½“ç³»        â”‚            â”‚
â”‚  â”‚  (ç¬¬17ç« )    â”‚    â”‚    (ç¬¬12ç« )      â”‚    â”‚  (ç¬¬28-29ç« )        â”‚            â”‚
â”‚  â”‚              â”‚    â”‚                  â”‚    â”‚                     â”‚            â”‚
â”‚  â”‚ ä¸ªæ€§åŒ–é€‚é…  â”‚    â”‚ å¤šç»´æŠ¥è¡¨/å›¾è¡¨   â”‚    â”‚ NPS/å£ç¢‘/è£‚å˜      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.1 åŠŸèƒ½æ¨¡å—å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AIæ™ºèƒ½è®°è´¦ 2.0 åŠŸèƒ½æ¶æ„å…¨æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• æ ¸å¿ƒè®°è´¦åŠŸèƒ½ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   æ™ºèƒ½è®°è´¦   â”‚ â”‚   è´¦æˆ·ç®¡ç†   â”‚ â”‚   é¢„ç®—ä¸­å¿ƒ   â”‚ â”‚   ç»Ÿè®¡åˆ†æ   â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ â€¢ è¯­éŸ³è®°è´¦   â”‚ â”‚ â€¢ å¤šè´¦æˆ·     â”‚ â”‚ â€¢ é›¶åŸºé¢„ç®—   â”‚ â”‚ â€¢ é’±é¾„åˆ†æ   â”‚              â”‚
â”‚  â”‚   (ç¬¬18ç« )   â”‚ â”‚ â€¢ ä¿¡ç”¨å¡     â”‚ â”‚ â€¢ å°é‡‘åº“     â”‚ â”‚ â€¢ æ”¶æ”¯è¶‹åŠ¿   â”‚              â”‚
â”‚  â”‚ â€¢ å›¾åƒè¯†åˆ«   â”‚ â”‚ â€¢ å€ºåŠ¡ç®¡ç†   â”‚ â”‚ â€¢ é¢„ç®—æé†’   â”‚ â”‚ â€¢ åˆ†ç±»åˆ†æ   â”‚              â”‚
â”‚  â”‚   (ç¬¬10ç« )   â”‚ â”‚ â€¢ å‚¨è“„ç›®æ ‡   â”‚ â”‚ â€¢ å‘¨æœŸé¢„ç®—   â”‚ â”‚   (ç¬¬12ç« )   â”‚              â”‚
â”‚  â”‚ â€¢ å¿«é€Ÿè¾“å…¥   â”‚ â”‚              â”‚ â”‚   (ç¬¬8ç« )    â”‚ â”‚ â€¢ æ™ºèƒ½æŠ¥å‘Š   â”‚              â”‚
â”‚  â”‚ â€¢ æ‰¹é‡å¯¼å…¥   â”‚ â”‚              â”‚ â”‚              â”‚ â”‚   (ç¬¬7ç« )    â”‚              â”‚
â”‚  â”‚   (ç¬¬11ç« )   â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• åä½œä¸å¢é•¿ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   å®¶åº­è´¦æœ¬   â”‚ â”‚   ä¹ æƒ¯åŸ¹å…»   â”‚ â”‚   ç”¨æˆ·å£ç¢‘   â”‚ â”‚   ç”¨æˆ·å¢é•¿   â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ â€¢ å¤šæˆå‘˜ç®¡ç† â”‚ â”‚ â€¢ ä¹ æƒ¯æ‰“å¡   â”‚ â”‚ â€¢ NPSç›‘æµ‹    â”‚ â”‚ â€¢ å£ç¢‘è£‚å˜   â”‚              â”‚
â”‚  â”‚ â€¢ é¢„ç®—åä½œ   â”‚ â”‚ â€¢ æˆå°±ç³»ç»Ÿ   â”‚ â”‚ â€¢ æƒŠå–œæ—¶åˆ»   â”‚ â”‚ â€¢ å®¶åº­è£‚å˜   â”‚              â”‚
â”‚  â”‚ â€¢ æ”¯å‡ºåˆ†æ‘Š   â”‚ â”‚ â€¢ ä¸“å®¶ä»»åŠ¡   â”‚ â”‚ â€¢ æ¨èè€…åŸ¹è‚² â”‚ â”‚ â€¢ å†…å®¹è·å®¢   â”‚              â”‚
â”‚  â”‚ â€¢ å®¶åº­ç»Ÿè®¡   â”‚ â”‚ â€¢ å‘¨æœŸæŒ‘æˆ˜   â”‚ â”‚   (ç¬¬28ç« )   â”‚ â”‚   (ç¬¬29ç« )   â”‚              â”‚
â”‚  â”‚   (ç¬¬13ç« )   â”‚ â”‚   (ç¬¬9ç« )    â”‚ â”‚              â”‚ â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• æ™ºèƒ½åŒ–èƒ½åŠ› â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ AIæ™ºèƒ½è¯†åˆ«   â”‚ â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ   â”‚ â”‚ è¯­éŸ³äº¤äº’     â”‚ â”‚ ä½ç½®æ™ºèƒ½     â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ â€¢ è¯­éŸ³è¯†åˆ«   â”‚ â”‚ â€¢ ä¸ªäººä¹ æƒ¯   â”‚ â”‚ â€¢ æ„å›¾è¯†åˆ«   â”‚ â”‚ â€¢ åœºæ™¯è¯†åˆ«   â”‚              â”‚
â”‚  â”‚ â€¢ å›¾åƒOCR    â”‚ â”‚ â€¢ ååŒå­¦ä¹    â”‚ â”‚ â€¢ å¤šè½®å¯¹è¯   â”‚ â”‚ â€¢ åœ°ç†å›´æ    â”‚              â”‚
â”‚  â”‚ â€¢ æ™ºèƒ½åˆ†ç±»   â”‚ â”‚ â€¢ æ¨¡å‹ä¼˜åŒ–   â”‚ â”‚ â€¢ è¯­éŸ³åé¦ˆ   â”‚ â”‚ â€¢ ä½ç½®é¢„ç®—   â”‚              â”‚
â”‚  â”‚   (ç¬¬10ç« )   â”‚ â”‚   (ç¬¬17ç« )   â”‚ â”‚   (ç¬¬18ç« )   â”‚ â”‚   (ç¬¬14ç« )   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ç³»ç»Ÿæ”¯æ’‘ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   æ•°æ®ç®¡ç†   â”‚ â”‚   ä¸ªäººä¸­å¿ƒ   â”‚ â”‚   è®¾ç½®ä¸­å¿ƒ   â”‚ â”‚   å®‰å…¨éšç§   â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ â€¢ æ•°æ®å¯¼å…¥   â”‚ â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯   â”‚ â”‚ â€¢ ä¸»é¢˜è®¾ç½®   â”‚ â”‚ â€¢ æ•°æ®åŠ å¯†   â”‚              â”‚
â”‚  â”‚ â€¢ æ•°æ®å¯¼å‡º   â”‚ â”‚ â€¢ ä¼šå‘˜æœåŠ¡   â”‚ â”‚ â€¢ é€šçŸ¥è®¾ç½®   â”‚ â”‚ â€¢ æƒé™æ§åˆ¶   â”‚              â”‚
â”‚  â”‚ â€¢ äº‘ç«¯åŒæ­¥   â”‚ â”‚ â€¢ å¸®åŠ©åé¦ˆ   â”‚ â”‚ â€¢ è¯­è¨€åŒºåŸŸ   â”‚ â”‚ â€¢ éšç§ä¿æŠ¤   â”‚              â”‚
â”‚  â”‚   (ç¬¬11ç« )   â”‚ â”‚ â€¢ æ— éšœç¢     â”‚ â”‚   (ç¬¬21ç« )   â”‚ â”‚   (ç¬¬22ç« )   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åŠŸèƒ½ç‰¹æ€§å…³ç³»å›¾

#### 6.2.1 ç³»ç»Ÿåˆ†å±‚æ¶æ„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AIæ™ºèƒ½è®°è´¦ 2.0 åŠŸèƒ½ç‰¹æ€§å…³ç³»å›¾                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   ç”¨æˆ·ä½“éªŒè®¾è®¡    â”‚
                                    â”‚     (ç¬¬17ç« )      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                        â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      é¦–é¡µä»ªè¡¨ç›˜        â”‚    â”‚     å¿«æ·è®°è´¦å…¥å£     â”‚    â”‚     è¶‹åŠ¿åˆ†æé¡µé¢     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚                          â”‚
                â”‚                           â–¼                          â”‚
                â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                â”‚              â”‚     AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚              â”‚        (ç¬¬10ç« )           â”‚            â”‚
                â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            â”‚
                â”‚              â”‚  â”‚è¯­éŸ³è¯†åˆ«â”‚å›¾ç‰‡è¯†åˆ«â”‚    â”‚            â”‚
                â”‚              â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚            â”‚
                â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                â”‚                      â”‚       â”‚                       â”‚
                â–¼                      â–¼       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              æ ¸å¿ƒä¸šåŠ¡å±‚                                          â”‚ â”‚
â”‚  â”‚                                                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ é’±é¾„åˆ†æç³»ç»Ÿ â”‚â—„â”€â”€â–ºâ”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ â”‚â—„â”€â”€â–ºâ”‚  å°é‡‘åº“ç³»ç»Ÿ  â”‚â—„â”€â”€â–ºâ”‚ å®¶åº­è´¦æœ¬ç³»ç»Ÿ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   (ç¬¬7ç« )   â”‚    â”‚   (ç¬¬8ç« )   â”‚    â”‚   (ç¬¬8ç« )   â”‚    â”‚  (ç¬¬13ç« )   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚        â”‚                 â”‚        â”‚                 â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ é’±é¾„è®¡ç®—å¼•æ“  â”‚        â”‚ â€¢ æ¯åˆ†é’±æœ‰å»å¤„  â”‚        â”‚ â€¢ ç›®æ ‡å‚¨è“„      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ å¥åº·åº¦è¯„ä¼°    â”‚        â”‚ â€¢ é¢„ç®—åˆ†é…      â”‚        â”‚ â€¢ è¿›åº¦è¿½è¸ª      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ ä½ç½®å¢å¼ºé’±é¾„  â”‚        â”‚ â€¢ æ‰§è¡Œç›‘æ§      â”‚        â”‚ â€¢ é‡Œç¨‹ç¢‘       â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚           â”‚                          â”‚                          â”‚               â”‚ â”‚
â”‚  â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚               â”‚ â”‚
â”‚  â”‚           â”‚    â–¼                                            â–¼   â–¼               â”‚ â”‚
â”‚  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ                      â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                   (ç¬¬9ç« )                           â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                                                     â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚ä¹ æƒ¯æ‰“å¡   â”‚  â”‚ç§¯åˆ†å¥–åŠ±   â”‚  â”‚æˆå°±ç³»ç»Ÿ   â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                                                     â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚è´¢åŠ¡å¥åº·   â”‚  â”‚ä¸“å®¶ä»»åŠ¡   â”‚  â”‚å‘¨æœŸæŒ‘æˆ˜   â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â”‚ç”»åƒåˆ†æ   â”‚  â”‚ç³»ç»Ÿ       â”‚  â”‚           â”‚       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚ â”‚
â”‚  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â”‚           â”‚                           â–²                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                           â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                           â”‚
               â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ä½ç½®æ™ºèƒ½å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨ (ç¬¬14ç« )                               â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  ç²¾ç¡®ä½ç½®æœåŠ¡   â”‚â”€â”€â”€â–ºâ”‚  æ¶ˆè´¹åœºæ™¯è¯†åˆ«   â”‚â”€â”€â”€â–ºâ”‚  ä½ç½®é’±é¾„å¢å¼º   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤
â”‚  â”‚   â”‚  (GPS+POI)      â”‚    â”‚(å®¶/å…¬å¸/å•†åœˆ)   â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚            â”‚                                                                     â”‚  â”‚
â”‚  â”‚            â–¼                                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  åœ°ç†å›´æ é¢„è­¦   â”‚â”€â”€â”€â–ºâ”‚  ä½ç½®é¢„ç®—åˆ†é…   â”‚â”€â”€â”€â–ºâ”‚  é¢„ç®—æ‰§è¡Œç›‘æ§   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤
â”‚  â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚            â”‚                                                                     â”‚  â”‚
â”‚  â”‚            â–¼                                                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚   â”‚  æœ¬åœ°åŒ–ç±»ç›®æ¨è â”‚    â”‚  å¼‚åœ°æ¶ˆè´¹è¯†åˆ«   â”‚    â”‚  æœ¬åœ°çœé’±å»ºè®®   â”‚            â”‚  â”‚
â”‚  â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚            â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    æ•°æ®å¤„ç†å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ    â”‚â—„â”€â”€â–ºâ”‚  æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–    â”‚â—„â”€â”€â–ºâ”‚   æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ     â”‚    â”‚
â”‚  â”‚      (ç¬¬11ç« )         â”‚    â”‚      (ç¬¬12ç« )         â”‚    â”‚      (ç¬¬16ç« )        â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ Excel/CSVå¯¼å…¥     â”‚    â”‚ â€¢ å¤šç»´åº¦æŠ¥è¡¨         â”‚    â”‚ â€¢ é€šä¹‰åƒé—®/æ™ºè°±AI   â”‚    â”‚
â”‚  â”‚ â€¢ æ•°æ®æ ¼å¼è½¬æ¢       â”‚    â”‚ â€¢ äº¤äº’å¼å›¾è¡¨         â”‚    â”‚ â€¢ æ„å›¾è¯†åˆ«å¼•æ“       â”‚    â”‚
â”‚  â”‚ â€¢ æ‰¹é‡å¤„ç†          â”‚    â”‚ â€¢ è¶‹åŠ¿é¢„æµ‹           â”‚    â”‚ â€¢ è‡ªç„¶è¯­è¨€å¤„ç†       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    åŸºç¡€è®¾æ–½å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          æŠ€æœ¯æ¶æ„è®¾è®¡ (ç¬¬15ç« )                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚  â”‚Flutterå®¢æˆ·ç«¯â”‚   â”‚FastAPIæœåŠ¡ç«¯â”‚   â”‚ç¦»çº¿ä¼˜å…ˆæ¶æ„ â”‚   â”‚æ•°æ®åº“è®¾è®¡   â”‚         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚å›½é™…åŒ–ä¸æœ¬åœ°åŒ–â”‚  â”‚ å®‰å…¨ä¸éšç§   â”‚  â”‚ç‰ˆæœ¬è¿ç§»ç­–ç•¥  â”‚  â”‚ å®æ–½è·¯çº¿å›¾   â”‚              â”‚
â”‚  â”‚  (ç¬¬18ç« )    â”‚  â”‚  (ç¬¬19ç« )    â”‚  â”‚  (ç¬¬23ç« )    â”‚  â”‚  (ç¬¬24ç« )    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    è¿ç»´ä¿éšœå±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡   â”‚â—„â”€â”€â–ºâ”‚ å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„   â”‚â—„â”€â”€â–ºâ”‚  å¯è§‚æµ‹æ€§ä¸ç›‘æ§      â”‚    â”‚
â”‚  â”‚     (ç¬¬20ç« )         â”‚    â”‚     (ç¬¬21ç« )         â”‚    â”‚     (ç¬¬22ç« )         â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ æ–­è·¯å™¨æ¨¡å¼        â”‚    â”‚ â€¢ æ¨¡å—åŒ–æ¶æ„         â”‚    â”‚ â€¢ æ—¥å¿—ç³»ç»Ÿ           â”‚    â”‚
â”‚  â”‚ â€¢ å¹‚ç­‰æ€§è®¾è®¡        â”‚    â”‚ â€¢ APIç‰ˆæœ¬ç®¡ç†        â”‚    â”‚ â€¢ æ€§èƒ½ç›‘æ§           â”‚    â”‚
â”‚  â”‚ â€¢ é™çº§ç†”æ–­          â”‚    â”‚ â€¢ ç°åº¦å‘å¸ƒ           â”‚    â”‚ â€¢ å‘Šè­¦ç³»ç»Ÿ           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ç”¨æˆ·å¢é•¿å±‚ (2.0æ–°å¢)                                  â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç”¨æˆ·å£ç¢‘ä¸NPSæå‡    â”‚â—„â”€â”€â–ºâ”‚  ä½æˆæœ¬è·å®¢ä¸å¢é•¿    â”‚â—„â”€â”€â–ºâ”‚  å®¶åº­è´¦æœ¬è£‚å˜        â”‚    â”‚
â”‚  â”‚     (ç¬¬28ç« )         â”‚    â”‚     (ç¬¬29ç« )         â”‚    â”‚     (ç¬¬13ç« )         â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ NPSç›‘æµ‹ç³»ç»Ÿ        â”‚    â”‚ â€¢ äº§å“å†…ç½®å¢é•¿å¼•æ“   â”‚    â”‚ â€¢ å®¶åº­æˆå‘˜é‚€è¯·       â”‚    â”‚
â”‚  â”‚ â€¢ æƒŠå–œæ—¶åˆ»è®¾è®¡       â”‚    â”‚ â€¢ ASOä¼˜åŒ–           â”‚    â”‚ â€¢ AAåˆ†æ‘Šè£‚å˜         â”‚    â”‚
â”‚  â”‚ â€¢ æ¨èè€…åŸ¹è‚²         â”‚    â”‚ â€¢ ç¤¾äº¤è£‚å˜æœºåˆ¶       â”‚    â”‚ â€¢ å…±åŒç›®æ ‡æ¿€åŠ±       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    è®¾è®¡åŸåˆ™å±‚                                           â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    æ— éšœç¢è®¾è®¡        â”‚    â”‚   æ‡’äººè®¾è®¡åŸåˆ™       â”‚    â”‚   ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™     â”‚    â”‚
â”‚  â”‚     (ç¬¬5ç« )         â”‚    â”‚     (ç¬¬3ç« )         â”‚    â”‚     (ç¬¬4ç« )         â”‚    â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                      â”‚    â”‚
â”‚  â”‚ â€¢ è§†è§‰æ— éšœç¢        â”‚    â”‚ â€¢ æœ€å°‘æ“ä½œåŸåˆ™       â”‚    â”‚ â€¢ åŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿ       â”‚    â”‚
â”‚  â”‚ â€¢ æ“ä½œæ— éšœç¢        â”‚    â”‚ â€¢ æ™ºèƒ½é»˜è®¤åŸåˆ™       â”‚    â”‚ â€¢ åœºæ™¯åŒ–æƒ…æ„Ÿäº¤äº’     â”‚    â”‚
â”‚  â”‚ â€¢ è®¤çŸ¥æ— éšœç¢        â”‚    â”‚ â€¢ å•æ‰‹æ“ä½œè®¾è®¡       â”‚    â”‚ â€¢ æ™ºèƒ½æ—¶æœºè§¦å‘       â”‚    â”‚
â”‚  â”‚ â€¢ WCAG 2.1åˆè§„      â”‚    â”‚ â€¢ æ¸è¿›å¼å¤æ‚åº¦       â”‚    â”‚ â€¢ ä¼™ä¼´äººæ ¼è®¾è®¡       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           è®¾è®¡åŸåˆ™è´¯ç©¿å…¨ç³»ç»Ÿ                                      â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â”‚    æ— éšœç¢è®¾è®¡ â”€â”€â”€â”€â”€â”€â”€â”€â–º ç¡®ä¿æ‰€æœ‰ç”¨æˆ·å¯è®¿é—®ï¼Œç¬¦åˆWCAG 2.1 AAçº§æ ‡å‡†                â”‚  â”‚
â”‚  â”‚    æ‡’äººè®¾è®¡   â”€â”€â”€â”€â”€â”€â”€â”€â–º é«˜é¢‘æ“ä½œ1æ­¥å®Œæˆï¼Œä½é¢‘æ“ä½œä¸è¶…è¿‡3æ­¥                       â”‚  â”‚
â”‚  â”‚    ä¼™ä¼´åŒ–è®¾è®¡ â”€â”€â”€â”€â”€â”€â”€â”€â–º æ¸©æš–ä¸æ‰“æ‰°ï¼Œå…³å¿ƒæœ‰è¾¹ç•Œï¼Œé¼“åŠ±è€Œéè¯´æ•™                     â”‚  â”‚
â”‚  â”‚                                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.2.2 æ ¸å¿ƒåŠŸèƒ½æ•°æ®æµå…³ç³»

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              ç”¨æˆ·äº¤äº’å…¥å£                                        â”‚
    â”‚                                                                                 â”‚
    â”‚      è¯­éŸ³è¾“å…¥ â”€â”€â”€â”€â”€â”                                                            â”‚
    â”‚                    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
    â”‚      å›¾ç‰‡è¯†åˆ« â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºâ”‚  AIæ™ºèƒ½è¯†åˆ«å¼•æ“  â”‚                                   â”‚
    â”‚                    â”‚     â”‚                  â”‚                                   â”‚
    â”‚      æ‰‹åŠ¨è¾“å…¥ â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
    â”‚                                   â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              äº¤æ˜“è®°å½•ç”Ÿæˆ                                        â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
    â”‚   â”‚  é‡‘é¢è§£æ   â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚  ç±»ç›®åˆ†ç±»   â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚  ç²¾ç¡®ä½ç½®å…³è”           â”‚      â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â€¢ GPSåæ ‡              â”‚      â”‚
    â”‚                                               â”‚  â€¢ POIå•†æˆ·ä¿¡æ¯           â”‚      â”‚
    â”‚                                               â”‚  â€¢ æ¶ˆè´¹åœºæ™¯è¯†åˆ«          â”‚      â”‚
    â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                                           â”‚                   â”‚
                     â–¼                                           â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       é’±é¾„åˆ†æç³»ç»Ÿ         â”‚    â”‚        é›¶åŸºé¢„ç®—ç³»ç»Ÿ              â”‚    â”‚  å°é‡‘åº“ç³»ç»Ÿ â”‚
    â”‚                            â”‚    â”‚                                 â”‚    â”‚             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ åŸºç¡€é’±é¾„è®¡ç®—         â”‚ â”‚    â”‚  â”‚ ä¼ ç»Ÿé¢„ç®—åˆ†é…            â”‚   â”‚    â”‚ â”‚ç›®æ ‡ç®¡ç† â”‚ â”‚
    â”‚  â”‚ (æ”¶å…¥æ—¥æœŸ-æ”¯å‡ºæ—¥æœŸ)  â”‚ â”‚    â”‚  â”‚ â€¢ æŒ‰ç±»ç›®åˆ†é…é¢„ç®—        â”‚   â”‚    â”‚ â”‚         â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â”‚ â€¢ æœˆåº¦/å‘¨åº¦å‘¨æœŸ         â”‚   â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
    â”‚             â”‚             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚             â–¼             â”‚    â”‚              â”‚                 â”‚    â”‚      â”‚      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚              â–¼                 â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ ä½ç½®å¢å¼ºé’±é¾„         â”‚ â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ æ¶ˆè´¹åœºæ™¯åˆ†ç¦»       â”‚â—„â”œâ”€â”€â”€â–ºâ”‚  â”‚ ä½ç½®æ™ºèƒ½é¢„ç®—            â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ æ—…æ¸¸/å‡ºå·®æƒé‡è°ƒæ•´  â”‚ â”‚    â”‚  â”‚ â€¢ æŒ‰åœºæ™¯åˆ†é…é¢„ç®—        â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ é€šå‹¤æ¶ˆè´¹è¿½è¸ª       â”‚ â”‚    â”‚  â”‚ â€¢ åœ°ç†å›´æ æé†’          â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â”‚ â€¢ é«˜æ¶ˆè´¹åŒºåŸŸé¢„è­¦        â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚             â”‚             â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚             â–¼             â”‚    â”‚              â”‚                 â”‚    â”‚      â–¼      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚              â–¼                 â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ é’±é¾„å¥åº·åº¦è¯„ä¼°       â”‚ â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚ â”‚è¿›åº¦è¿½è¸ª â”‚ â”‚
    â”‚  â”‚ â€¢ ä¼˜ç§€ (â‰¥30å¤©)       â”‚ â”‚    â”‚  â”‚ é¢„ç®—æ‰§è¡Œç›‘æ§            â”‚   â”‚    â”‚ â”‚         â”‚ â”‚
    â”‚  â”‚ â€¢ è‰¯å¥½ (14-29å¤©)     â”‚ â”‚    â”‚  â”‚ â€¢ å®æ—¶ä½™é¢æ›´æ–°          â”‚   â”‚    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
    â”‚  â”‚ â€¢ ä¸€èˆ¬ (7-13å¤©)      â”‚ â”‚    â”‚  â”‚ â€¢ è¶…æ”¯é¢„è­¦              â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â”‚ â€¢ éœ€æ”¹å–„ (<7å¤©)      â”‚ â”‚    â”‚  â”‚ â€¢ ä½ç½®ç»´åº¦æŠ¥å‘Š          â”‚   â”‚    â”‚      â”‚      â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚      â”‚      â”‚
    â”‚                            â”‚    â”‚                                 â”‚    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                    â”‚                           â”‚
                  â”‚                                    â”‚                           â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ                                       â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                         è¾“å…¥æ•°æ®æ¥æº                                     â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚    é’±é¾„å˜åŒ–è¶‹åŠ¿ â”€â”€â”€â”                                                    â”‚  â”‚
    â”‚   â”‚                    â”‚                                                    â”‚  â”‚
    â”‚   â”‚    é¢„ç®—æ‰§è¡Œç‡ â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–º  è´¢åŠ¡å¥åº·ç”»åƒåˆ†æ                             â”‚  â”‚
    â”‚   â”‚                    â”‚                                                    â”‚  â”‚
    â”‚   â”‚    å‚¨è“„ç›®æ ‡è¿›åº¦ â”€â”€â”€â”˜                                                    â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                       â”‚                                         â”‚
    â”‚                                       â–¼                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚   â”‚   ä¹ æƒ¯å…»æˆ      â”‚   â”‚   ç§¯åˆ†å¥–åŠ±      â”‚   â”‚   æˆå°±ç³»ç»Ÿ      â”‚              â”‚
    â”‚   â”‚                 â”‚   â”‚                 â”‚   â”‚                 â”‚              â”‚
    â”‚   â”‚ â€¢ æ¯æ—¥è®°è´¦æ‰“å¡  â”‚â”€â”€â–ºâ”‚ â€¢ è®°è´¦ç§¯åˆ†      â”‚â”€â”€â–ºâ”‚ â€¢ é‡Œç¨‹ç¢‘å¾½ç«     â”‚              â”‚
    â”‚   â”‚ â€¢ 21å¤©ä¹ æƒ¯æŒ‘æˆ˜  â”‚   â”‚ â€¢ è¿ç»­å¥–åŠ±      â”‚   â”‚ â€¢ ç­‰çº§æ™‹å‡      â”‚              â”‚
    â”‚   â”‚ â€¢ å®šæœŸå¤ç›˜      â”‚   â”‚ â€¢ ä»»åŠ¡å®Œæˆ      â”‚   â”‚ â€¢ æˆå°±è§£é”      â”‚              â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
    â”‚           â”‚                     â”‚                     â”‚                         â”‚
    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
    â”‚                                 â–¼                                               â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
    â”‚                    â”‚    ä¸“å®¶ä»»åŠ¡æ¨è         â”‚                                  â”‚
    â”‚                    â”‚                         â”‚                                  â”‚
    â”‚                    â”‚ æ ¹æ®è´¢åŠ¡ç”»åƒæ¨è:       â”‚                                  â”‚
    â”‚                    â”‚ â€¢ æé«˜é’±é¾„ä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ é¢„ç®—ä¼˜åŒ–ä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ å‚¨è“„åŠ é€Ÿä»»åŠ¡          â”‚                                  â”‚
    â”‚                    â”‚ â€¢ æ¶ˆè´¹ä¹ æƒ¯æ”¹å–„ä»»åŠ¡      â”‚                                  â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
    â”‚                                                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           è®¾è®¡åŸåˆ™å±‚ (è´¯ç©¿å…¨æµç¨‹)                                 â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      æ‡’äººè®¾è®¡åŸåˆ™ (ç¬¬3ç« )                               â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   ç”¨æˆ·äº¤äº’å…¥å£ â”€â”€â”€â”€â–º è¯­éŸ³ä¸€å¥è¯è®°è´¦ï¼Œå•æ‰‹æ“ä½œï¼Œ1æ­¥å®Œæˆ                   â”‚  â”‚
    â”‚   â”‚   äº¤æ˜“è®°å½•ç”Ÿæˆ â”€â”€â”€â”€â–º æ™ºèƒ½é»˜è®¤åˆ†ç±»ï¼Œæ™ºèƒ½å¡«å……é‡‘é¢ï¼Œé›¶é…ç½®                  â”‚  â”‚
    â”‚   â”‚   æ ¸å¿ƒä¸šåŠ¡ç³»ç»Ÿ â”€â”€â”€â”€â–º è‡ªåŠ¨è”åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨åŒæ­¥ï¼Œæ¸è¿›å¼å¤æ‚åº¦                â”‚  â”‚
    â”‚   â”‚   ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ â”€â”€â”€â”€â–º è‡ªåŠ¨æ‰“å¡ï¼Œæ™ºèƒ½æ¨èä»»åŠ¡ï¼Œæœ€å°‘æ“ä½œåŸåˆ™                â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                       â”‚                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™ (ç¬¬4ç« )                             â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   è®°è´¦å®Œæˆå â”€â”€â”€â”€â”€â”€â”€â”€â–º æ¸©æš–é¼“åŠ±æ–‡æ¡ˆï¼Œåœºæ™¯åŒ–æƒ…æ„Ÿåé¦ˆ                      â”‚  â”‚
    â”‚   â”‚   é’±é¾„å˜åŒ–æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â–º æ™ºèƒ½æ—¶æœºè§¦å‘ï¼Œæå‡æ—¶åº†ç¥/ä¸‹é™æ—¶å…³å¿ƒ               â”‚  â”‚
    â”‚   â”‚   é¢„ç®—é¢„è­¦æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â–º æ¸©å’Œæé†’è€Œéè­¦å‘Šï¼Œé¼“åŠ±è€Œéè¯´æ•™                    â”‚  â”‚
    â”‚   â”‚   æˆå°±è§£é”æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â–º ä¼™ä¼´äººæ ¼åŒ–ç¥è´ºï¼Œå¢å¼ºç”¨æˆ·ç²˜æ€§                      â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                       â”‚                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      æ— éšœç¢è®¾è®¡ (ç¬¬5ç« )                                 â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   è§†è§‰å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º é«˜å¯¹æ¯”åº¦ï¼Œå¯ç¼©æ”¾æ–‡å­—ï¼Œè¯­ä¹‰åŒ–æ ‡ç­¾                  â”‚  â”‚
    â”‚   â”‚   æ“ä½œå±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å¤§è§¦æ§åŒºåŸŸ(â‰¥48dp)ï¼Œæ‰‹åŠ¿æ”¯æŒï¼Œé”®ç›˜å¯¼èˆª            â”‚  â”‚
    â”‚   â”‚   è®¤çŸ¥å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ç®€æ´ä¿¡æ¯æ¶æ„ï¼Œä¸€è‡´æ€§äº¤äº’ï¼Œé”™è¯¯æç¤ºæ¸…æ™°            â”‚  â”‚
    â”‚   â”‚   è¾…åŠ©æŠ€æœ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º TalkBack/VoiceOverå…¼å®¹ï¼Œè¯­éŸ³æ§åˆ¶æ”¯æŒ              â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      å¯è§‚æµ‹æ€§ä¸ç›‘æ§ (ç¬¬25ç« )                             â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   å…¨é“¾è·¯è¿½è¸ª â”€â”€â”€â”€â”€â”€â”€â”€â–º ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼Œæ€§èƒ½æŒ‡æ ‡ï¼Œé”™è¯¯è¿½è¸ª                  â”‚  â”‚
    â”‚   â”‚   ä¸šåŠ¡æŒ‡æ ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º é’±é¾„åˆ†å¸ƒï¼Œé¢„ç®—æ‰§è¡Œç‡ï¼Œä¹ æƒ¯æ‰“å¡ç‡                  â”‚  â”‚
    â”‚   â”‚   å¥åº·ç›‘æ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º AIæœåŠ¡å¯ç”¨æ€§ï¼ŒåŒæ­¥æˆåŠŸç‡ï¼Œå“åº”æ—¶é—´                â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      å®¶åº­è´¦æœ¬åä½œ (ç¬¬13ç« )                               â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   äº¤æ˜“åŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å…±äº«è®°è´¦ï¼Œæˆå‘˜è´¡çŒ®å±•ç¤ºï¼Œå®æ—¶åä½œ                  â”‚  â”‚
    â”‚   â”‚   é¢„ç®—å…±äº« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å®¶åº­é¢„ç®—ï¼Œæˆå‘˜é…é¢ï¼Œæ™ºèƒ½åˆ†é…                      â”‚  â”‚
    â”‚   â”‚   æƒé™ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º è§’è‰²æ§åˆ¶ï¼Œéšç§ä¿æŠ¤ï¼Œè®¿é—®æ§åˆ¶                      â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      è¯­éŸ³äº¤äº’ç³»ç»Ÿ (ç¬¬18ç« )                               â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   æ„å›¾ç†è§£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º è¯­éŸ³è¯†åˆ«ï¼Œæ„å›¾åˆ†ç±»ï¼Œå¤šè½®å¯¹è¯                      â”‚  â”‚
    â”‚   â”‚   è‡ªå­¦ä¹ å¢å¼º â”€â”€â”€â”€â”€â”€â”€â”€â–º ä¸ªæ€§åŒ–é€‚åº”ï¼ŒååŒå­¦ä¹ ï¼Œæ¨¡å‹è¿­ä»£                    â”‚  â”‚
    â”‚   â”‚   åé¦ˆä¼˜åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ç”¨æˆ·çº æ­£ï¼Œå‡†ç¡®ç‡æå‡ï¼ŒæŒç»­æ”¹è¿›                    â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                                 â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚                      ç”¨æˆ·å¢é•¿ç³»ç»Ÿ (ç¬¬28-29ç« )                            â”‚  â”‚
    â”‚   â”‚                                                                         â”‚  â”‚
    â”‚   â”‚   NPSæå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ»¡æ„åº¦è¿½è¸ªï¼Œå£ç¢‘ä¼ æ’­ï¼Œç”¨æˆ·æ¨è                    â”‚  â”‚
    â”‚   â”‚   è‡ªç„¶å¢é•¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º é‚€è¯·è£‚å˜ï¼Œåˆ†äº«å¼•å¯¼ï¼ŒASOä¼˜åŒ–                       â”‚  â”‚
    â”‚   â”‚   ç•™å­˜è½¬åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æˆå°±æ¿€åŠ±ï¼Œä¹ æƒ¯å·©å›ºï¼Œä»·å€¼å±•ç¤º                      â”‚  â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.2.3 ç²¾ç¡®ä½ç½®åŠŸèƒ½ä¾èµ–å…³ç³»

> ğŸ“ **è¯¦ç»†è®¾è®¡**ï¼šä½ç½®æ™ºèƒ½åŒ–å®Œæ•´æ–¹æ¡ˆè¯¦è§[ç¬¬14ç«  åœ°ï¿½ï¿½ï¿½ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨](#14-åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä½ç½®æœåŠ¡ä¸å…¶ä»–æ¨¡å—é›†æˆå…³ç³»                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ AIè¯†åˆ«    â”‚   â”‚ é’±é¾„ç³»ç»Ÿ  â”‚   â”‚ é¢„ç®—ç³»ç»Ÿ  â”‚   â”‚ å®¶åº­è´¦æœ¬  â”‚   â”‚ è¯­éŸ³äº¤äº’  â”‚   â”‚
â”‚   â”‚ (10ç« )   â”‚   â”‚ (7ç« )    â”‚   â”‚ (8ç« )    â”‚   â”‚ (13ç« )   â”‚   â”‚ (18ç« )   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€ï¿½ï¿½â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚               â”‚               â”‚               â”‚               â”‚         â”‚
â”‚         â”‚    ä½ç½®è¾…åŠ©    â”‚   ä½ç½®å¢å¼º    â”‚   ä½ç½®é¢„ç®—    â”‚   æˆå‘˜ä½ç½®    â”‚  ä½ç½®æŸ¥è¯¢ â”‚
â”‚         â”‚    åˆ†ç±»è¯†åˆ«    â”‚   é’±é¾„è®¡ç®—    â”‚   æé†’è§¦å‘    â”‚   å…±äº«å±•ç¤º    â”‚  è¯­éŸ³æ”¯æŒ â”‚
â”‚         â”‚               â”‚               â”‚               â”‚               â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                         â”‚                                         â”‚
â”‚                                         â–¼                                         â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                         â”‚       ç²¾ç¡®ä½ç½®æœåŠ¡ (14ç« )      â”‚                         â”‚
â”‚                         â”‚    PreciseLocationService     â”‚                         â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ç½®æœåŠ¡å†…éƒ¨æ¶æ„ï¼š**

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚       ç²¾ç¡®ä½ç½®æœåŠ¡           â”‚
                              â”‚    PreciseLocationService    â”‚
                              â”‚                              â”‚
                              â”‚  â€¢ GPSé«˜ç²¾åº¦å®šä½             â”‚
                              â”‚  â€¢ åå‘åœ°ç†ç¼–ç               â”‚
                              â”‚  â€¢ POIå•†æˆ·æŸ¥è¯¢               â”‚
                              â”‚  â€¢ åŒºåŸŸç±»å‹æ£€æµ‹              â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                           â”‚                           â”‚
                 â–¼                           â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å¸¸é©»åœ°ç‚¹æœåŠ¡         â”‚  â”‚   æ¶ˆè´¹åœºæ™¯åˆ†æ         â”‚  â”‚   åœ°ç†å›´æ æœåŠ¡         â”‚
    â”‚ UserHomeLocationServiceâ”‚  â”‚  SpendingContextAnalysisâ”‚  â”‚ GeofenceBudgetAlert    â”‚
    â”‚                        â”‚  â”‚                        â”‚  â”‚                        â”‚
    â”‚  â€¢ å®¶åº­ä½ç½®æ£€æµ‹        â”‚  â”‚  â€¢ nearHome å®¶é™„è¿‘     â”‚  â”‚  â€¢ å•†åœˆå›´æ             â”‚
    â”‚  â€¢ å…¬å¸ä½ç½®æ£€æµ‹        â”‚  â”‚  â€¢ nearWork å…¬å¸é™„è¿‘   â”‚  â”‚  â€¢ é«˜æ¶ˆè´¹åŒºåŸŸå›´æ       â”‚
    â”‚  â€¢ é€šå‹¤è·¯å¾„å­¦ä¹         â”‚  â”‚  â€¢ commuting é€šå‹¤      â”‚  â”‚  â€¢ è‡ªå®šä¹‰å›´æ           â”‚
    â”‚                        â”‚  â”‚  â€¢ commercial å•†åœˆ     â”‚  â”‚  â€¢ è¿›å…¥/ç¦»å¼€è§¦å‘       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â€¢ travel æ—…è¡Œ         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                â”‚                           â”‚                           â”‚
                â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                â”‚           â”‚                               â”‚           â”‚
                â”‚           â–¼                               â–¼           â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚ å‡ºå·®/æ—…æ¸¸æ£€æµ‹       â”‚     â”‚ é€šå‹¤æ¶ˆè´¹è¿½è¸ª       â”‚  â”‚
                â”‚  â”‚                     â”‚     â”‚                     â”‚  â”‚
                â”‚  â”‚ â€¢ è·ç¦»åˆ¤æ–­(>100km)  â”‚     â”‚ â€¢ æ—¶é—´åˆ¤æ–­          â”‚  â”‚
                â”‚  â”‚ â€¢ å·¥ä½œæ—¥/å‘¨æœ«       â”‚     â”‚ â€¢ è·¯å¾„åˆ¤æ–­          â”‚  â”‚
                â”‚  â”‚ â€¢ POIç±»å‹åŒ¹é…       â”‚     â”‚ â€¢ æ¶ˆè´¹ç±»å‹          â”‚  â”‚
                â””â”€â”€â”¤ â€¢ è¿ç»­å¼‚åœ°å¤©æ•°      â”‚     â”‚                     â”œâ”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                           â”‚
                              â–¼                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                               â”‚
           â”‚              ç²¾ç¡®ä½ç½®å¢å¼ºé’±é¾„è®¡ç®—                              â”‚
           â”‚            PreciseLocationMoneyAgeService                     â”‚
           â”‚                                                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚                  è®¡ç®—ç­–ç•¥                            â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   æ—¥å¸¸æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 1.0              â”‚   â”‚
           â”‚    â”‚   é€šå‹¤æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 1.0              â”‚   â”‚
           â”‚    â”‚   å•†åœˆæ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.9              â”‚   â”‚
           â”‚    â”‚   æ—…æ¸¸æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.3 (åˆ†ç¦»è®¡ç®—)  â”‚   â”‚
           â”‚    â”‚   å‡ºå·®æ¶ˆè´¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æƒé‡ 0.3 (åˆ†ç¦»è®¡ç®—)  â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                              â”‚                               â”‚
           â”‚                              â–¼                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚               è¾“å‡º: PreciseMoneyAge                  â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   â€¢ overall: ç»¼åˆé’±é¾„                                â”‚   â”‚
           â”‚    â”‚   â€¢ daily: æ—¥å¸¸æ¶ˆè´¹é’±é¾„ (æ’é™¤æ—…æ¸¸/å‡ºå·®)             â”‚   â”‚
           â”‚    â”‚   â€¢ byContext: åˆ†åœºæ™¯é’±é¾„                            â”‚   â”‚
           â”‚    â”‚   â€¢ insights: ä½ç½®æ´å¯Ÿå»ºè®®                           â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                                               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                               â”‚
           â”‚              ä½ç½®æ„ŸçŸ¥é›¶åŸºé¢„ç®—                                  â”‚
           â”‚          LocationAwareZeroBudgetService                       â”‚
           â”‚                                                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚              é¢„ç®—åˆ†é…æ¨¡å¼                            â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   å®¶é™„è¿‘æ¶ˆè´¹ â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.95 (ç•¥å¾®æ”¶ç´§)       â”‚   â”‚
           â”‚    â”‚   å·¥ä½œåŒºæ¶ˆè´¹ â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.90 (å¯ä¼˜åŒ–)         â”‚   â”‚
           â”‚    â”‚   é€šå‹¤æ¶ˆè´¹   â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.85 (å¯å¤§å¹…ä¼˜åŒ–)     â”‚   â”‚
           â”‚    â”‚   å•†åœˆæ¶ˆè´¹   â”€â”€â”€â”€â–º å†å²å æ¯” Ã— 0.80 (ä¸¥æ ¼æ§åˆ¶)       â”‚   â”‚
           â”‚    â”‚   æ—…è¡Œæ¶ˆè´¹   â”€â”€â”€â”€â–º å•ç‹¬é¢„ç®—æ±                         â”‚   â”‚
           â”‚    â”‚   å‚¨è“„       â”€â”€â”€â”€â–º å›ºå®š20%ä¼˜å…ˆåˆ†é…                   â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                              â”‚                               â”‚
           â”‚                              â–¼                               â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚    â”‚           ä½ç½®é¢„ç®—æ‰§è¡Œç›‘æ§                           â”‚   â”‚
           â”‚    â”‚       LocationBudgetExecutionMonitor                 â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â”‚   â€¢ è®°è´¦æ—¶è‡ªåŠ¨åŒ¹é…ä½ç½®é¢„ç®—                           â”‚   â”‚
           â”‚    â”‚   â€¢ å®æ—¶æ›´æ–°å„åœºæ™¯é¢„ç®—ä½™é¢                           â”‚   â”‚
           â”‚    â”‚   â€¢ ç”Ÿæˆä½ç½®ç»´åº¦æ‰§è¡ŒæŠ¥å‘Š                             â”‚   â”‚
           â”‚    â”‚   â€¢ æ™ºèƒ½å»ºè®®(è¶…æ”¯/æœªåˆ©ç”¨æ´å¯Ÿ)                        â”‚   â”‚
           â”‚    â”‚                                                      â”‚   â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                                               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ç½®æ•°æ®å…±äº«æœºåˆ¶ï¼š**

| æ¶ˆè´¹æ¨¡å— | ä½ç½®æ•°æ®ç”¨é€” | é›†æˆæ–¹å¼ |
|---------|-------------|---------|
| **AIæ™ºèƒ½è¯†åˆ«** (10ç« ) | POIå•†æˆ·ä¿¡æ¯è¾…åŠ©åˆ†ç±»è¯†åˆ« | å®æ—¶æŸ¥è¯¢ |
| **é’±é¾„åˆ†æ** (7ç« ) | åœºæ™¯åˆ†ç¦»è®¡ç®—ã€æ—…æ¸¸/å‡ºå·®æƒé‡è°ƒæ•´ | äº‹ä»¶è®¢é˜… |
| **é›¶åŸºé¢„ç®—** (8ç« ) | åœ°ç†å›´æ é¢„ç®—æé†’ã€ä½ç½®é¢„ç®—åˆ†é… | å›´æ è§¦å‘ |
| **å®¶åº­è´¦æœ¬** (13ç« ) | æˆå‘˜ä½ç½®å±•ç¤ºï¼ˆéœ€æˆæƒï¼‰ã€æ¶ˆè´¹åœ°ç‚¹å…±äº« | æˆæƒæŸ¥è¯¢ |
| **è¯­éŸ³äº¤äº’** (18ç« ) | "é™„è¿‘å“ªé‡Œæ¶ˆè´¹æœ€å¤š"ç­‰ä½ç½®æŸ¥è¯¢ | APIè°ƒç”¨ |
| **ä¹ æƒ¯åŸ¹å…»** (9ç« ) | é€šå‹¤æ¶ˆè´¹è¿½è¸ªã€é«˜æ¶ˆè´¹åŒºåŸŸæé†’ | äº‹ä»¶è®¢é˜… |
| **æ•°æ®å¯è§†åŒ–** (12ç« ) | æ¶ˆè´¹çƒ­åŠ›å›¾ã€ä½ç½®åˆ†å¸ƒå›¾ | æ•°æ®èšåˆ |

#### 6.2.4 åŠŸèƒ½ç‰¹æ€§ä¾èµ–çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | ç« èŠ‚ | ä¾èµ–çš„æ¨¡å— | è¢«ä¾èµ–çš„æ¨¡å— | æ•°æ®æµå‘ |
|---------|------|-----------|-------------|---------|
| AIæ™ºèƒ½è¯†åˆ« | 10ç«  | æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ(16ç« ) | äº¤æ˜“è®°å½•ã€é’±é¾„ã€é¢„ç®— | å…¥å£ â†’ æ ¸å¿ƒ |
| é’±é¾„åˆ†æ | 7ç«  | äº¤æ˜“è®°å½•ã€ç²¾ç¡®ä½ç½®(14ç« ) | ä¹ æƒ¯åŸ¹å…»ã€ä»ªè¡¨ç›˜ã€ä¼™ä¼´åŒ– | æ ¸å¿ƒ â†’ å±•ç¤º |
| é›¶åŸºé¢„ç®— | 8ç«  | äº¤æ˜“è®°å½•ã€ç²¾ç¡®ä½ç½®(14ç« ) | ä¹ æƒ¯åŸ¹å…»ã€é¢„è­¦ã€ä¼™ä¼´åŒ– | æ ¸å¿ƒ â†’ ç›‘æ§ |
| å°é‡‘åº“ | 8ç«  | äº¤æ˜“è®°å½•ã€é¢„ç®— | ä¹ æƒ¯åŸ¹å…»ã€ç»Ÿè®¡ã€ä¼™ä¼´åŒ– | æ ¸å¿ƒ â†’ å±•ç¤º |
| ç²¾ç¡®ä½ç½® | 14ç«  | GPSã€POIæœåŠ¡ | é’±é¾„ã€é¢„ç®—ã€çœé’±å»ºè®® | åº•å±‚ â†’ æ ¸å¿ƒ |
| ä¹ æƒ¯åŸ¹å…» | 9ç«  | é’±é¾„ã€é¢„ç®—ã€å°é‡‘åº“ | æˆå°±ç³»ç»Ÿã€ä»»åŠ¡æ¨èã€ä¼™ä¼´åŒ– | æ ¸å¿ƒ â†’ æ¿€åŠ± |
| æ•°æ®å¯è§†åŒ– | 12ç«  | æ‰€æœ‰ä¸šåŠ¡æ•°æ® | ç”¨æˆ·ç•Œé¢ | æ ¸å¿ƒ â†’ å±•ç¤º |
| **å®¶åº­è´¦æœ¬** | 13ç«  | ç”¨æˆ·ç®¡ç†ã€é¢„ç®—ç³»ç»Ÿ | æˆå‘˜åä½œã€å…±äº«é¢„ç®— | æ ¸å¿ƒ â†’ åä½œ |
| **è¯­éŸ³äº¤äº’** | 18ç«  | AIè¯†åˆ«(10ç« )ã€è‡ªå­¦ä¹ (17ç« ) | å¿«é€Ÿè®°è´¦ã€æŸ¥è¯¢æŠ¥è¡¨ | å…¥å£ â†’ æ ¸å¿ƒ |
| **è‡ªå­¦ä¹ ç³»ç»Ÿ** | 17ç«  | ç”¨æˆ·è¡Œä¸ºã€äº¤æ˜“æ•°æ® | AIè¯†åˆ«ã€æ™ºèƒ½åˆ†ç±» | æ•°æ® â†’ æ¨¡å‹ |
| **æ•°æ®å¯¼å…¥å¯¼å‡º** | 11ç«  | äº¤æ˜“è®°å½•ã€è´¦æˆ· | æ•°æ®è¿ç§»ã€å¤‡ä»½ | æ ¸å¿ƒ â†” å¤–éƒ¨ |
| **å¯è§‚æµ‹æ€§** | 25ç«  | æ‰€æœ‰ä¸šåŠ¡æ¨¡å— | è¿ç»´ã€å‘Šè­¦ã€åˆ†æ | å…¨é“¾è·¯ â†’ ç›‘æ§ |
| **æ— éšœç¢è®¾è®¡** | 5ç«  | ç”¨æˆ·ç•Œé¢å±‚ | æ‰€æœ‰ç”¨æˆ·äº¤äº’ | æ¨ªåˆ‡ â†’ å…¨å±€ |
| **æ‡’äººè®¾è®¡** | 3ç«  | ç”¨æˆ·è¡Œä¸ºæ•°æ® | æ‰€æœ‰äº¤äº’æµç¨‹ | æ¨ªåˆ‡ â†’ å…¨å±€ |
| **ä¼™ä¼´åŒ–è®¾è®¡** | 4ç«  | é’±é¾„ã€é¢„ç®—ã€ä¹ æƒ¯ | æ–‡æ¡ˆã€æé†’ã€æ¿€åŠ± | æ¨ªåˆ‡ â†’ å…¨å±€ |
| **ç”¨æˆ·å£ç¢‘** | 28ç«  | ä¹ æƒ¯åŸ¹å…»ã€æˆå°±ç³»ç»Ÿ | NPSæå‡ã€åˆ†äº«å¼•å¯¼ | æ ¸å¿ƒ â†’ å¢é•¿ |
| **è‡ªç„¶å¢é•¿** | 29ç«  | ç”¨æˆ·å£ç¢‘ã€ç¤¾äº¤ | é‚€è¯·è£‚å˜ã€ASO | å¢é•¿ â†’ è·å®¢ |

#### 6.2.5 è®¾è®¡åŸåˆ™æ¨ªåˆ‡å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®¾è®¡åŸåˆ™æ¨ªåˆ‡å…³ç³»å›¾                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚                               ä¸šåŠ¡åŠŸèƒ½å±‚                                         â”‚â”‚
â”‚   â”‚                                                                                 â”‚â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚   â”‚ â”‚è®°è´¦å…¥å£â”‚â”‚é’±é¾„ç³»ç»Ÿâ”‚â”‚é¢„ç®—ç³»ç»Ÿâ”‚â”‚ä¹ æƒ¯ç³»ç»Ÿâ”‚â”‚å®¶åº­è´¦æœ¬â”‚â”‚è¯­éŸ³äº¤äº’â”‚â”‚æ•°æ®å¯¼å…¥â”‚â”‚æŠ¥è¡¨ç³»ç»Ÿâ”‚â”‚â”‚
â”‚   â”‚ â”‚(10ç« ) â”‚â”‚ (7ç« ) â”‚â”‚ (8ç« ) â”‚â”‚ (9ç« ) â”‚â”‚(13ç« ) â”‚â”‚(18ç« ) â”‚â”‚(11ç« ) â”‚â”‚(12ç« ) â”‚â”‚â”‚
â”‚   â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â”‚â”‚
â”‚   â”‚     â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚    â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                       æ‡’äººè®¾è®¡åŸåˆ™ (ç¬¬3ç« ) æ¨ªåˆ‡                          â”‚ â”‚
â”‚   â”‚  â€¢ é«˜é¢‘æ“ä½œ1æ­¥å®Œæˆ   â€¢ æ™ºèƒ½é»˜è®¤å€¼   â€¢ å•æ‰‹å¯æ“ä½œ   â€¢ æ¸è¿›å¤æ‚åº¦          â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                      ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™ (ç¬¬4ç« ) æ¨ªåˆ‡                         â”‚ â”‚
â”‚   â”‚  â€¢ åŠ¨æ€æ–‡æ¡ˆç³»ç»Ÿ   â€¢ åœºæ™¯åŒ–æƒ…æ„Ÿ   â€¢ æ™ºèƒ½æ—¶æœºè§¦å‘   â€¢ ä¼™ä¼´äººæ ¼             â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                       æ— éšœç¢è®¾è®¡ (ç¬¬5ç« ) æ¨ªåˆ‡                            â”‚ â”‚
â”‚   â”‚  â€¢ è§†è§‰æ— éšœç¢   â€¢ æ“ä½œæ— éšœç¢   â€¢ è®¤çŸ¥æ— éšœç¢   â€¢ WCAG 2.1 AAåˆè§„          â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                      å®‰å…¨ä¸éšç§ (ç¬¬22ç« ) æ¨ªåˆ‡                            â”‚ â”‚
â”‚   â”‚  â€¢ æ•°æ®åŠ å¯†   â€¢ æƒé™æœ€å°åŒ–   â€¢ éšç§åˆè§„(GDPR)   â€¢ æ•æ„Ÿæ•°æ®è„±æ•           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                     å¼‚å¸¸å¤„ç†ä¸å®¹é”™ (ç¬¬23ç« ) æ¨ªåˆ‡                         â”‚ â”‚
â”‚   â”‚  â€¢ ä¼˜é›…é™çº§   â€¢ ç¦»çº¿å®¹é”™   â€¢ é”™è¯¯æ¢å¤   â€¢ ç”¨æˆ·å‹å¥½æç¤º                   â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                     æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ– (ç¬¬19ç« ) æ¨ªåˆ‡                         â”‚ â”‚
â”‚   â”‚  â€¢ å¯åŠ¨æ—¶é—´<2s   â€¢ é¦–å±æ¸²æŸ“<500ms   â€¢ å†…å­˜<150MB   â€¢ 60fpsæµç•…          â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
â”‚   â”‚                     å¯è§‚æµ‹æ€§ä¸ç›‘æ§ (ç¬¬25ç« ) æ¨ªåˆ‡                         â”‚ â”‚
â”‚   â”‚  â€¢ æ—¥å¿—ç³»ç»Ÿ   â€¢ æ€§èƒ½ç›‘æ§   â€¢ é”™è¯¯è¿½è¸ª   â€¢ ä¸šåŠ¡æŒ‡æ ‡   â€¢ ç”¨æˆ·è¡Œä¸ºåˆ†æ      â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 åŠŸèƒ½ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§ | åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|------|
| P0 | åŸºç¡€è®°è´¦ | âœ… å·²æœ‰ | æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€ä¼˜åŒ–ä½“éªŒ |
| P0 | è´¦æˆ·ç®¡ç† | âœ… å·²æœ‰ | æ”¯æŒå¤šè´¦æˆ·ã€ä¿¡ç”¨å¡ |
| P0 | åˆ†ç±»ç®¡ç† | âœ… å·²æœ‰ | æ”¯æŒè‡ªå®šä¹‰åˆ†ç±» |
| P0 | ç»Ÿè®¡å›¾è¡¨ | âœ… å·²æœ‰ | éœ€å¢å¼ºäº¤äº’èƒ½åŠ› |
| P1 | é’±é¾„åˆ†æ | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ï¼ˆç¬¬7ç« ï¼‰ |
| P1 | é›¶åŸºé¢„ç®— | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ï¼ˆç¬¬8ç« ï¼‰ |
| P1 | å°é‡‘åº“ç³»ç»Ÿ | ğŸ†• æ–°å¢ | 2.0æ ¸å¿ƒç‰¹æ€§ï¼ˆç¬¬8ç« ï¼‰ |
| P1 | é‡‘èä¹ æƒ¯åŸ¹å…» | ğŸ†• æ–°å¢ | æ‰“å¡/æˆå°±/ä»»åŠ¡ç³»ç»Ÿï¼ˆç¬¬9ç« ï¼‰ |
| P1 | æ•°æ®è”åŠ¨ | ğŸ†• æ–°å¢ | å¢å¼ºäº¤äº’ä½“éªŒï¼ˆç¬¬12ç« ï¼‰ |
| P1 | **å®¶åº­è´¦æœ¬** | ğŸ†• æ–°å¢ | å¤šæˆå‘˜åä½œã€å…±äº«é¢„ç®—ï¼ˆç¬¬13ç« ï¼‰ |
| P1 | **æ‡’äººè®¾è®¡** | ğŸ†• æ–°å¢ | æœ€å°‘æ“ä½œã€æ™ºèƒ½é»˜è®¤ã€å•æ‰‹æ“ä½œï¼ˆç¬¬3ç« ï¼‰ |
| P1 | **ä¼™ä¼´åŒ–è®¾è®¡** | ğŸ†• æ–°å¢ | åŠ¨æ€æ–‡æ¡ˆã€æƒ…æ„Ÿäº¤äº’ã€æ™ºèƒ½æ—¶æœºï¼ˆç¬¬4ç« ï¼‰ |
| P2 | AIè¯­éŸ³è¯†åˆ« | âœ… å·²æœ‰ | éœ€ä¼˜åŒ–å‡†ç¡®ç‡ï¼ˆç¬¬10ç« ï¼‰ |
| P2 | AIå›¾åƒè¯†åˆ« | âœ… å·²æœ‰ | éœ€ä¼˜åŒ–å‡†ç¡®ç‡ï¼ˆç¬¬10ç« ï¼‰ |
| P2 | æ™ºèƒ½è¯­éŸ³äº¤äº’ | ğŸ†• æ–°å¢ | è¯­éŸ³æ„å›¾ç†è§£ã€å¤šè½®å¯¹è¯ï¼ˆç¬¬18ç« ï¼‰ |
| P2 | æ™ºèƒ½å¯¼å…¥å¯¼å‡º | ğŸ”„ å‡çº§ | æ‰¹é‡å¯¼å…¥ã€å¤šå› å­å»é‡ï¼ˆç¬¬11ç« ï¼‰ |
| P2 | è‡ªå­¦ä¹ ç³»ç»Ÿ | ğŸ†• æ–°å¢ | ä¸ªæ€§åŒ–é€‚åº”ã€ååŒå­¦ä¹ ï¼ˆç¬¬17ç« ï¼‰ |
| P2 | åœ°ç†ä½ç½®æ™ºèƒ½ | ğŸ†• æ–°å¢ | æ¶ˆè´¹åœºæ™¯è¯†åˆ«ã€ä½ç½®é’±é¾„å¢å¼ºï¼ˆç¬¬14ç« ï¼‰ |
| P2 | **æ— éšœç¢è®¾è®¡** | ğŸ†• æ–°å¢ | WCAG 2.1 AAåˆè§„ã€å…¨ç”¨æˆ·å¯è®¿é—®ï¼ˆç¬¬5ç« ï¼‰ |
| P2 | **æ€§èƒ½ä¼˜åŒ–** | ğŸ†• æ–°å¢ | å¯åŠ¨<2sã€é¦–å±<500msã€60fpsï¼ˆç¬¬19ç« ï¼‰ |
| P2 | **å¯è§‚æµ‹æ€§** | ğŸ†• æ–°å¢ | æ—¥å¿—/ç›‘æ§/å‘Šè­¦/ä¸šåŠ¡æŒ‡æ ‡ï¼ˆç¬¬25ç« ï¼‰ |
| P2 | **ç”¨æˆ·å£ç¢‘** | ğŸ†• æ–°å¢ | NPSæå‡ã€å£ç¢‘ä¼ æ’­ï¼ˆç¬¬28ç« ï¼‰ |
| P2 | **è‡ªç„¶å¢é•¿** | ğŸ†• æ–°å¢ | é‚€è¯·è£‚å˜ã€ASOä¼˜åŒ–ï¼ˆç¬¬29ç« ï¼‰ |
| P3 | æ™ºèƒ½æŠ•èµ„å»ºè®® | ğŸ“‹ è§„åˆ’ | åç»­ç‰ˆæœ¬ |

#### 6.3.1 è®¾è®¡åŸåˆ™ä¼˜å…ˆçº§è¯´æ˜

| è®¾è®¡åŸåˆ™ | ç« èŠ‚ | ä¼˜å…ˆçº§ | å®æ–½èŒƒå›´ | æ ¸å¿ƒä»·å€¼ |
|---------|------|--------|---------|---------|
| **æ‡’äººè®¾è®¡** | 3ç«  | P1 | å…¨å±€æ¨ªåˆ‡ | é™ä½ç”¨æˆ·æ“ä½œæˆæœ¬ï¼Œæå‡è®°è´¦æ•ˆç‡ï¼Œå‡å°‘æµå¤± |
| **ä¼™ä¼´åŒ–è®¾è®¡** | 4ç«  | P1 | å…¨å±€æ¨ªåˆ‡ | å¢å¼ºç”¨æˆ·ç²˜æ€§ï¼Œæå‡ç•™å­˜ç‡ï¼Œå·®å¼‚åŒ–ä½“éªŒ |
| **æ— éšœç¢è®¾è®¡** | 5ç«  | P2 | å…¨å±€æ¨ªåˆ‡ | æ‰©å¤§ç”¨æˆ·ç¾¤ä½“ï¼Œç¬¦åˆåˆè§„è¦æ±‚ï¼Œç¤¾ä¼šè´£ä»» |
| **å®‰å…¨ä¸éšç§** | 22ç«  | P1 | å…¨å±€æ¨ªåˆ‡ | æ•°æ®å®‰å…¨ï¼Œéšç§åˆè§„ï¼Œç”¨æˆ·ä¿¡ä»» |
| **å¼‚å¸¸å¤„ç†** | 23ç«  | P1 | å…¨å±€æ¨ªåˆ‡ | ç³»ç»Ÿç¨³å®šï¼Œç”¨æˆ·ä½“éªŒï¼Œé—®é¢˜æ¢å¤ |
| **æ€§èƒ½ä¼˜åŒ–** | 19ç«  | P2 | å…¨å±€æ¨ªåˆ‡ | å“åº”é€Ÿåº¦ï¼Œèµ„æºæ•ˆç‡ï¼Œæµç•…ä½“éªŒ |
| **å¯è§‚æµ‹æ€§** | 25ç«  | P2 | å…¨å±€æ¨ªåˆ‡ | è¿ç»´ä¿éšœï¼Œé—®é¢˜å®šä½ï¼Œæ•°æ®é©±åŠ¨å†³ç­– |
| **ç”¨æˆ·å¢é•¿** | 28-29ç«  | P2 | å¢é•¿å±‚ | NPSæå‡ï¼Œè‡ªç„¶è£‚å˜ï¼Œä½æˆæœ¬è·å®¢ |

### 6.4 æ•°æ®æ¨¡å‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   æ ¸å¿ƒæ•°æ®æ¨¡å‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ç”¨æˆ·ä¸åä½œ              è´¢åŠ¡æ•°æ®                    åˆ†ææ•°æ®           å¢é•¿æ•°æ®    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  User   â”‚            â”‚ Account â”‚                â”‚MoneyAge â”‚       â”‚   NPS   â”‚  â”‚
â”‚  â”‚ Profile â”‚            â”‚ è´¦æˆ·    â”‚                â”‚ é’±é¾„    â”‚       â”‚  è¯„åˆ†   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                      â”‚                          â”‚                 â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                    â”‚           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Family  â”‚           â”‚           â”‚                    â”‚           â”‚  Invite   â”‚  â”‚
â”‚  â”‚ Ledger  â”‚      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”               â–¼           â”‚  Code     â”‚  â”‚
â”‚  â”‚ å®¶åº­è´¦æœ¬â”‚      â”‚Transactionâ”‚ â”‚CreditCardâ”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚  äº¤æ˜“    â”‚ â”‚  ä¿¡ç”¨å¡  â”‚         â”‚ Report  â”‚                   â”‚
â”‚       â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  æŠ¥å‘Š   â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â”‚ Member  â”‚           â”‚                                                         â”‚
â”‚  â”‚ æˆå‘˜    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚         â”‚                                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚         â”‚Categoryâ”‚ â”‚ Budget â”‚ â”‚  Vault  â”‚                                        â”‚
â”‚         â”‚ åˆ†ç±»   â”‚ â”‚ é¢„ç®—   â”‚ â”‚ å°é‡‘åº“  â”‚                                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                                     â”‚
â”‚  è¾…åŠ©æ•°æ®                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚Location â”‚  â”‚  Habit  â”‚  â”‚Achievementâ”‚ â”‚ Import  â”‚  â”‚Settings â”‚                  â”‚
â”‚  â”‚ä½ç½®è®°å½• â”‚  â”‚ä¹ æƒ¯æ‰“å¡ â”‚  â”‚ æˆå°±å¾½ç«  â”‚  â”‚å¯¼å…¥æ‰¹æ¬¡ â”‚  â”‚ç”¨æˆ·è®¾ç½® â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ“ **æ•°æ®æ¨¡å‹è¯¦æƒ…**ï¼š
> - å®¶åº­è´¦æœ¬ä¸æˆå‘˜ç®¡ç†ï¼šè¯¦è§[ç¬¬13ç« ](#13-å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ)
> - é’±é¾„èµ„æºæ± æ¨¡å‹ï¼šè¯¦è§[ç¬¬7ç« ](#7-é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ)
> - é¢„ç®—ä¸å°é‡‘åº“æ¨¡å‹ï¼šè¯¦è§[ç¬¬8ç« ](#8-é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ)
> - å¯¼å…¥æ‰¹æ¬¡ä¸å»é‡ï¼šè¯¦è§[ç¬¬11ç« ](#11-æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ)

### 6.5 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 6.5.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒåŠŸèƒ½æ¶æ„ - ç³»ç»Ÿé›†æˆå…¨æ™¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                           â”‚   æ ¸å¿ƒåŠŸèƒ½æ¶æ„ä¸­å¿ƒ   â”‚                                    â”‚
â”‚                           â”‚ CoreArchitectureHub â”‚                                    â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                      â”‚                                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚            â”‚            â”‚       â”‚       â”‚            â”‚            â”‚             â”‚
â”‚    â–¼            â–¼            â–¼       â–¼       â–¼            â–¼            â–¼             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚é’±é¾„ç³»ç»Ÿâ”‚ â”‚é¢„ç®—ç³»ç»Ÿâ”‚ â”‚ä¹ æƒ¯ç³»ç»Ÿâ”‚ â”‚å®¶åº­è´¦æœ¬â”‚ â”‚æŠ¥è¡¨ç³»ç»Ÿâ”‚ â”‚æ™ºèƒ½ç³»ç»Ÿâ”‚ â”‚è¯­éŸ³äº¤äº’â”‚        â”‚
â”‚ â”‚ (7ç« ) â”‚ â”‚ (8ç« ) â”‚ â”‚ (9ç« ) â”‚ â”‚(13ç« ) â”‚ â”‚(12ç« ) â”‚ â”‚(10ç« ) â”‚ â”‚(18ç« ) â”‚        â”‚
â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚        â”‚
â”‚ â”‚æ¶ˆè´¹å¥åº·â”‚ â”‚é›¶åŸºé¢„ç®—â”‚ â”‚æ‰“å¡æˆå°±â”‚ â”‚æˆå‘˜åä½œâ”‚ â”‚å¯è§†åŒ–  â”‚ â”‚AIè¯†åˆ«  â”‚ â”‚æ„å›¾ç†è§£â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚    â”‚            â”‚            â”‚       â”‚       â”‚            â”‚            â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                      â”‚                                               â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                           â”‚    åŠŸèƒ½äº‹ä»¶æ€»çº¿      â”‚                                    â”‚
â”‚                           â”‚  FeatureEventBus    â”‚                                    â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                      â”‚                                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚             â”‚                   â”‚                   â”‚             â”‚             â”‚
â”‚    â–¼             â–¼                   â–¼                   â–¼             â–¼             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ä½ç½®æ™ºèƒ½  â”‚ â”‚è‡ªå­¦ä¹ ç³»ç»Ÿâ”‚    â”‚  ä¼™ä¼´åŒ–ç³»ç»Ÿ  â”‚    â”‚æ— éšœç¢ç³»ç»Ÿâ”‚ â”‚ç”¨æˆ·å¢é•¿  â”‚          â”‚
â”‚ â”‚ (14ç« )  â”‚ â”‚ (17ç« )  â”‚    â”‚   (4ç« )     â”‚    â”‚ (5ç« )   â”‚ â”‚(28-29ç« )â”‚          â”‚
â”‚ â”‚         â”‚ â”‚         â”‚    â”‚             â”‚    â”‚         â”‚ â”‚         â”‚          â”‚
â”‚ â”‚åœºæ™¯è¯†åˆ« â”‚ â”‚ä¸ªæ€§é€‚åº” â”‚    â”‚ æƒ…æ„ŸåŒ–äº¤äº’  â”‚    â”‚å…¨ç”¨æˆ·å¯ç”¨â”‚ â”‚NPS/è£‚å˜ â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.5.1 é›†æˆè§¦å‘ç‚¹

| æºæ¨¡å— | ç« èŠ‚ | ç›®æ ‡æ¨¡å— | è§¦å‘äº‹ä»¶ | é›†æˆæ•ˆæœ |
|--------|------|---------|---------|---------|
| **è®°è´¦å…¥å£** | 10ç«  | é’±é¾„ç³»ç»Ÿ | æ–°å¢äº¤æ˜“ | è‡ªåŠ¨æ›´æ–°èµ„æºæ±  |
| **è®°è´¦å…¥å£** | 10ç«  | é¢„ç®—ç³»ç»Ÿ | æ–°å¢æ”¯å‡º | è‡ªåŠ¨æ‰£å‡é¢„ç®— |
| **è®°è´¦å…¥å£** | 10ç«  | ä¹ æƒ¯ç³»ç»Ÿ | å®Œæˆè®°è´¦ | æ‰“å¡ç§¯åˆ† |
| **è®°è´¦å…¥å£** | 10ç«  | å®¶åº­è´¦æœ¬ | å…±äº«äº¤æ˜“ | é€šçŸ¥å…¶ä»–æˆå‘˜ |
| **é’±é¾„ç³»ç»Ÿ** | 7ç«  | ä¹ æƒ¯ç³»ç»Ÿ | é’±é¾„å˜åŒ– | è§¦å‘ä»»åŠ¡æ¨è |
| **é’±é¾„ç³»ç»Ÿ** | 7ç«  | ä¼™ä¼´åŒ– | é’±é¾„æå‡/ä¸‹é™ | é¼“åŠ±/å…³å¿ƒæ¶ˆæ¯ |
| **é¢„ç®—ç³»ç»Ÿ** | 8ç«  | ä¹ æƒ¯ç³»ç»Ÿ | é¢„ç®—è¾¾æˆ | æˆå°±è§£é” |
| **é¢„ç®—ç³»ç»Ÿ** | 8ç«  | ä¼™ä¼´åŒ– | é¢„ç®—é¢„è­¦/è¾¾æˆ | æé†’/åº†ç¥æ¶ˆæ¯ |
| **é¢„ç®—ç³»ç»Ÿ** | 8ç«  | å®¶åº­è´¦æœ¬ | å…±äº«é¢„ç®—å˜åŒ– | æˆå‘˜é¢„ç®—åŒæ­¥ |
| **å®¶åº­è´¦æœ¬** | 13ç«  | ä¹ æƒ¯ç³»ç»Ÿ | æˆå‘˜æ´»è·ƒ | å®¶åº­è´¡çŒ®ç§¯åˆ† |
| **å®¶åº­è´¦æœ¬** | 13ç«  | ç”¨æˆ·å¢é•¿ | é‚€è¯·æˆåŠŸ | è£‚å˜è®¡æ•° |
| **ä½ç½®æ™ºèƒ½** | 14ç«  | é’±é¾„ç³»ç»Ÿ | åœºæ™¯è¯†åˆ« | ä½ç½®å¢å¼ºé’±é¾„ |
| **ä½ç½®æ™ºèƒ½** | 14ç«  | é¢„ç®—ç³»ç»Ÿ | åœ°ç†å›´æ  | ä½ç½®é¢„ç®—æé†’ |
| **AIæ™ºèƒ½** | 10ç«  | è®°è´¦å…¥å£ | è¯­éŸ³/å›¾åƒè¯†åˆ« | è‡ªåŠ¨è§£æè®°è´¦ |
| **è¯­éŸ³äº¤äº’** | 18ç«  | AIæ™ºèƒ½ | è¯­éŸ³æ„å›¾ | å¤šè½®å¯¹è¯å¤„ç† |
| **è‡ªå­¦ä¹ ç³»ç»Ÿ** | 17ç«  | AIæ™ºèƒ½ | æ¨¡å‹æ›´æ–° | è¯†åˆ«å‡†ç¡®ç‡æå‡ |
| **ä¹ æƒ¯ç³»ç»Ÿ** | 9ç«  | ç”¨æˆ·å¢é•¿ | æˆå°±è§£é” | è§¦å‘åˆ†äº«å¼•å¯¼ |
| **ç”¨æˆ·å¢é•¿** | 28-29ç«  | ä¼™ä¼´åŒ– | NPSåé¦ˆ | ä¸ªæ€§åŒ–è·Ÿè¿› |

#### 6.5.2 åŠŸèƒ½æ¨¡å—æ³¨å†Œæœºåˆ¶

```dart
/// åŠŸèƒ½æ¨¡å—æ³¨å†Œä¸­å¿ƒ
class FeatureModuleRegistry {
  static final Map<String, FeatureModule> _modules = {};
  static final FeatureEventBus _eventBus = FeatureEventBus();

  /// æ³¨å†ŒåŠŸèƒ½æ¨¡å—
  static void register(FeatureModule module) {
    _modules[module.id] = module;
    module.initialize(_eventBus);
  }

  /// è·å–æ¨¡å—
  static T? getModule<T extends FeatureModule>(String id) {
    return _modules[id] as T?;
  }

  /// åˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒæ¨¡å—
  static Future<void> initializeCoreModules() async {
    // æŒ‰ä¾èµ–é¡ºåºåˆå§‹åŒ–
    // ç¬¬ä¸€å±‚ï¼šåŸºç¡€æ¨¡å—
    await register(TransactionModule());     // äº¤æ˜“æ¨¡å—ï¼ˆåŸºç¡€ï¼‰
    await register(AccountModule());         // è´¦æˆ·æ¨¡å—
    await register(CategoryModule());        // åˆ†ç±»æ¨¡å—

    // ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒä¸šåŠ¡æ¨¡å—
    await register(MoneyAgeModule());        // é’±é¾„æ¨¡å—ï¼ˆç¬¬7ç« ï¼‰
    await register(BudgetModule());          // é¢„ç®—æ¨¡å—ï¼ˆç¬¬8ç« ï¼‰
    await register(VaultModule());           // å°é‡‘åº“æ¨¡å—ï¼ˆç¬¬8ç« ï¼‰
    await register(HabitModule());           // ä¹ æƒ¯æ¨¡å—ï¼ˆç¬¬9ç« ï¼‰
    await register(FamilyLedgerModule());    // å®¶åº­è´¦æœ¬æ¨¡å—ï¼ˆç¬¬13ç« ï¼‰

    // ç¬¬ä¸‰å±‚ï¼šæ™ºèƒ½å¢å¼ºæ¨¡å—
    await register(AIModule());              // AIæ™ºèƒ½æ¨¡å—ï¼ˆç¬¬10ç« ï¼‰
    await register(ImportExportModule());    // å¯¼å…¥å¯¼å‡ºæ¨¡å—ï¼ˆç¬¬11ç« ï¼‰
    await register(VoiceInteractionModule()); // è¯­éŸ³äº¤äº’æ¨¡å—ï¼ˆç¬¬18ç« ï¼‰
    await register(SelfLearningModule());    // è‡ªå­¦ä¹ æ¨¡å—ï¼ˆç¬¬17ç« ï¼‰
    await register(LocationModule());        // ä½ç½®æ™ºèƒ½æ¨¡å—ï¼ˆç¬¬14ç« ï¼‰

    // ç¬¬å››å±‚ï¼šå±•ç¤ºä¸äº¤äº’æ¨¡å—
    await register(ReportModule());          // æŠ¥è¡¨æ¨¡å—ï¼ˆç¬¬12ç« ï¼‰
    await register(CompanionModule());       // ä¼™ä¼´åŒ–æ¨¡å—ï¼ˆç¬¬4ç« ï¼‰
    await register(AccessibilityModule());   // æ— éšœç¢æ¨¡å—ï¼ˆç¬¬5ç« ï¼‰

    // ç¬¬äº”å±‚ï¼šå¢é•¿æ¨¡å—
    await register(UserGrowthModule());      // ç”¨æˆ·å¢é•¿æ¨¡å—ï¼ˆç¬¬28-29ç« ï¼‰
  }
}

/// åŠŸèƒ½æ¨¡å—åŸºç±»
abstract class FeatureModule {
  String get id;
  String get name;
  int get priority;
  List<String> get dependencies;

  Future<void> initialize(FeatureEventBus eventBus);
  Future<void> dispose();

  /// æ¨¡å—å¥åº·æ£€æŸ¥
  Future<ModuleHealthStatus> healthCheck();
}

/// åŠŸèƒ½äº‹ä»¶æ€»çº¿
class FeatureEventBus {
  final _controller = StreamController<FeatureEvent>.broadcast();

  /// å‘å¸ƒäº‹ä»¶
  void publish(FeatureEvent event) {
    _controller.add(event);
  }

  /// è®¢é˜…äº‹ä»¶
  StreamSubscription<T> subscribe<T extends FeatureEvent>(
    void Function(T event) handler,
  ) {
    return _controller.stream
        .where((event) => event is T)
        .cast<T>()
        .listen(handler);
  }
}
```

#### 6.5.3 äº¤æ˜“æ¨¡å—ä¸ä¸‹æ¸¸ç³»ç»Ÿé›†æˆ

```dart
/// äº¤æ˜“æ¨¡å—é›†æˆå®ç°
class TransactionModuleIntegration {
  final FeatureEventBus _eventBus;
  final MoneyAgeService _moneyAgeService;
  final BudgetService _budgetService;
  final HabitService _habitService;
  final CompanionService _companionService;

  /// å¤„ç†æ–°å¢äº¤æ˜“
  Future<void> onTransactionCreated(Transaction tx) async {
    // 1. å‘å¸ƒäº¤æ˜“åˆ›å»ºäº‹ä»¶
    _eventBus.publish(TransactionCreatedEvent(tx));

    // 2. æ›´æ–°é’±é¾„ç³»ç»Ÿ
    if (tx.type == TransactionType.expense) {
      await _moneyAgeService.consumeFromPools(
        amount: tx.amount,
        transactionId: tx.id,
        date: tx.date,
      );
    } else if (tx.type == TransactionType.income) {
      await _moneyAgeService.createResourcePool(
        amount: tx.amount,
        transactionId: tx.id,
        date: tx.date,
      );
    }

    // 3. æ›´æ–°é¢„ç®—ç³»ç»Ÿ
    if (tx.type == TransactionType.expense && tx.vaultId != null) {
      await _budgetService.recordExpense(
        vaultId: tx.vaultId!,
        amount: tx.amount,
        categoryId: tx.categoryId,
      );
    }

    // 4. æ›´æ–°ä¹ æƒ¯ç³»ç»Ÿï¼ˆæ‰“å¡ï¼‰
    await _habitService.recordActivity(
      type: HabitActivityType.transaction,
      data: {'transactionId': tx.id, 'amount': tx.amount},
    );

    // 5. è§¦å‘ä¼™ä¼´åŒ–åé¦ˆ
    await _companionService.onTransactionSaved(tx);
  }
}

/// äº¤æ˜“åˆ›å»ºäº‹ä»¶
class TransactionCreatedEvent extends FeatureEvent {
  final Transaction transaction;
  TransactionCreatedEvent(this.transaction);
}
```

#### 6.5.4 é’±é¾„æ¨¡å—ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

```dart
/// é’±é¾„æ¨¡å—é›†æˆå®ç°
class MoneyAgeModuleIntegration {
  final FeatureEventBus _eventBus;
  final HabitService _habitService;
  final CompanionService _companionService;
  final ReportService _reportService;

  /// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
  void initialize() {
    // ç›‘å¬é’±é¾„å˜åŒ–
    _eventBus.subscribe<MoneyAgeChangedEvent>(_onMoneyAgeChanged);
  }

  /// å¤„ç†é’±é¾„å˜åŒ–
  Future<void> _onMoneyAgeChanged(MoneyAgeChangedEvent event) async {
    final delta = event.newAge - event.previousAge;

    // 1. ä¹ æƒ¯ç³»ç»Ÿï¼šæ›´æ–°è´¢åŠ¡ç”»åƒ
    await _habitService.updateFinancialProfile(
      moneyAge: event.newAge,
      trend: delta > 0 ? Trend.improving : Trend.declining,
    );

    // 2. ä¼™ä¼´åŒ–ç³»ç»Ÿï¼šæƒ…æ„Ÿåé¦ˆ
    if (delta >= 3) {
      await _companionService.triggerMessage(
        scene: CopyScene.moneyAgeImproved,
        context: {'delta': delta, 'newAge': event.newAge},
      );
    } else if (delta <= -5) {
      await _companionService.triggerMessage(
        scene: CopyScene.moneyAgeDeclined,
        context: {'delta': delta, 'newAge': event.newAge},
      );
    }

    // 3. æŠ¥è¡¨ç³»ç»Ÿï¼šè®°å½•å†å²æ•°æ®ç‚¹
    await _reportService.recordMoneyAgeDataPoint(
      date: DateTime.now(),
      age: event.newAge,
      context: event.context,
    );

    // 4. æ¨èä»»åŠ¡
    if (event.newAge < 14) {
      await _habitService.recommendTask(
        type: TaskType.improveMoneyAge,
        priority: TaskPriority.high,
      );
    }
  }
}
```

#### 6.5.5 é¢„ç®—æ¨¡å—ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

```dart
/// é¢„ç®—æ¨¡å—é›†æˆå®ç°
class BudgetModuleIntegration {
  final FeatureEventBus _eventBus;
  final HabitService _habitService;
  final CompanionService _companionService;
  final LocationService _locationService;

  /// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
  void initialize() {
    _eventBus.subscribe<BudgetStatusChangedEvent>(_onBudgetStatusChanged);
    _locationService.onGeofenceEntered.listen(_onGeofenceEntered);
  }

  /// å¤„ç†é¢„ç®—çŠ¶æ€å˜åŒ–
  Future<void> _onBudgetStatusChanged(BudgetStatusChangedEvent event) async {
    final usagePercent = event.usedAmount / event.totalBudget * 100;

    // 1. é¢„ç®—è¾¾æˆæ£€æŸ¥
    if (event.isMonthEnd && usagePercent <= 100) {
      // è§£é”æˆå°±
      await _habitService.unlockAchievement(
        type: AchievementType.budgetAchieved,
        data: {'vaultName': event.vaultName, 'savedPercent': 100 - usagePercent},
      );
      // åº†ç¥æ¶ˆæ¯
      await _companionService.triggerCelebration(
        type: CelebrationType.budgetAchieved,
        context: {'vaultName': event.vaultName},
      );
    }

    // 2. é¢„ç®—é¢„è­¦
    if (usagePercent >= 80 && usagePercent < 100) {
      await _companionService.triggerMessage(
        scene: CopyScene.budgetWarning,
        context: {
          'vaultName': event.vaultName,
          'usagePercent': usagePercent.round(),
          'remaining': event.totalBudget - event.usedAmount,
        },
      );
    }
  }

  /// å¤„ç†åœ°ç†å›´æ è¿›å…¥äº‹ä»¶
  Future<void> _onGeofenceEntered(GeofenceEvent event) async {
    // æŸ¥æ‰¾è¯¥åŒºåŸŸå…³è”çš„é¢„ç®—
    final linkedBudget = await _findLinkedBudget(event.geofenceId);
    if (linkedBudget != null) {
      await _companionService.triggerMessage(
        scene: CopyScene.locationBudgetReminder,
        context: {
          'locationName': event.locationName,
          'budgetName': linkedBudget.name,
          'remaining': linkedBudget.remaining,
        },
      );
    }
  }
}
```

#### 6.5.6 åŠŸèƒ½å¥åº·åº¦ç›‘æ§

```dart
/// åŠŸèƒ½æ¨¡å—å¥åº·åº¦ç›‘æ§
class FeatureHealthMonitor {
  final FeatureModuleRegistry _registry;
  final MetricsService _metrics;

  /// æ”¶é›†æ‰€æœ‰æ¨¡å—å¥åº·çŠ¶æ€
  Future<FeatureHealthReport> collectHealthReport() async {
    final moduleStatuses = <String, ModuleHealthStatus>{};

    for (final module in _registry.allModules) {
      try {
        moduleStatuses[module.id] = await module.healthCheck();
      } catch (e) {
        moduleStatuses[module.id] = ModuleHealthStatus.error(e.toString());
      }
    }

    return FeatureHealthReport(
      timestamp: DateTime.now(),
      modules: moduleStatuses,
      overallHealth: _calculateOverallHealth(moduleStatuses),
    );
  }

  /// åŠŸèƒ½ä½¿ç”¨ç‡ç»Ÿè®¡
  Future<FeatureUsageStats> getUsageStats({
    required DateTime from,
    required DateTime to,
  }) async {
    return FeatureUsageStats(
      transactionCount: await _metrics.getCount('transaction_created', from, to),
      moneyAgeViews: await _metrics.getCount('money_age_viewed', from, to),
      budgetInteractions: await _metrics.getCount('budget_interaction', from, to),
      habitCheckIns: await _metrics.getCount('habit_check_in', from, to),
      aiRecognitions: await _metrics.getCount('ai_recognition', from, to),
      companionInteractions: await _metrics.getCount('companion_interaction', from, to),
    );
  }
}

/// æ¨¡å—å¥åº·çŠ¶æ€
class ModuleHealthStatus {
  final bool isHealthy;
  final String? errorMessage;
  final Map<String, dynamic> metrics;

  ModuleHealthStatus.healthy(this.metrics) : isHealthy = true, errorMessage = null;
  ModuleHealthStatus.error(this.errorMessage) : isHealthy = false, metrics = {};
}

/// åŠŸèƒ½å¥åº·æŠ¥å‘Š
class FeatureHealthReport {
  final DateTime timestamp;
  final Map<String, ModuleHealthStatus> modules;
  final double overallHealth; // 0-100

  const FeatureHealthReport({
    required this.timestamp,
    required this.modules,
    required this.overallHealth,
  });

  /// æ˜¯å¦æ‰€æœ‰æ¨¡å—å¥åº·
  bool get allHealthy => modules.values.every((s) => s.isHealthy);

  /// è·å–ä¸å¥åº·çš„æ¨¡å—
  List<String> get unhealthyModules =>
      modules.entries.where((e) => !e.value.isHealthy).map((e) => e.key).toList();
}
```

---


---

## 7. é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ

### 7.0 è®¾è®¡åŸåˆ™å›é¡¾

é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿæ˜¯2.0ç‰ˆæœ¬çš„**æ ¸å¿ƒåˆ›æ–°ç‰¹æ€§**ï¼Œå…¶è®¾è®¡éµå¾ªä»¥ä¸‹æ¶æ„åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å•ä¸€èŒè´£åŸåˆ™   â”‚     â”‚   æ•°æ®ä¸€è‡´æ€§    â”‚     â”‚   æç®€è®¾è®¡åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ é’±é¾„è®¡ç®—å¼•æ“ç‹¬ç«‹ â”‚     â”‚ FIFOèµ„æºæ± æ¨¡å‹  â”‚     â”‚ æ— éœ€å¤æ‚é…ç½®    â”‚      â”‚
â”‚   â”‚ äºè®°è´¦æ ¸å¿ƒæ¨¡å—   â”‚     â”‚ ä¿è¯è¿½è¸ªå‡†ç¡®æ€§  â”‚     â”‚ è‡ªåŠ¨åŒ–è®¡ç®—å±•ç¤º  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚      é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ          â”‚                       â”‚
â”‚                    â”‚   MoneyAgeAnalysisSystem      â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–²                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å¯æ‰©å±•æ€§åŸåˆ™   â”‚     â”‚   æ€§èƒ½ä¸æˆæœ¬    â”‚     â”‚   å¯è§‚æµ‹æ€§åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ æ”¯æŒè‡ªå®šä¹‰åˆ†æ   â”‚     â”‚ å¢é‡è®¡ç®—ä¼˜åŒ–    â”‚     â”‚ é’±é¾„è¶‹åŠ¿å¯è§†åŒ–  â”‚      â”‚
â”‚   â”‚ å‘¨æœŸå’Œå¥åº·ç­‰çº§   â”‚     â”‚ ç¼“å­˜çƒ­ç‚¹æ•°æ®    â”‚     â”‚ å¥åº·ç­‰çº§ç›´è§‚å±•ç¤ºâ”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š

| åŸåˆ™ | åœ¨é’±é¾„ç³»ç»Ÿä¸­çš„ä½“ç° |
|------|-------------------|
| **å•ä¸€èŒè´£** | MoneyAgeCalculator ä¸“æ³¨è®¡ç®—ï¼ŒMoneyAgeVisualizer ä¸“æ³¨å±•ç¤ºï¼Œäº’ä¸è€¦åˆ |
| **æ•°æ®ä¸€è‡´æ€§** | FIFOèµ„æºæ± æ¨¡å‹ç¡®ä¿æ¯ç¬”æ”¯å‡ºéƒ½èƒ½è¿½æº¯åˆ°å‡†ç¡®çš„æ”¶å…¥æ¥æº |
| **æç®€è®¾è®¡** | ç”¨æˆ·æ— éœ€é…ç½®ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†ææ‰€æœ‰äº¤æ˜“å¹¶ç”Ÿæˆé’±é¾„æŠ¥å‘Š |
| **å¯æ‰©å±•æ€§** | æ”¯æŒè‡ªå®šä¹‰å¥åº·ç­‰çº§é˜ˆå€¼ï¼Œå¯æ‰©å±•å¤šç»´åº¦åˆ†æï¼ˆæŒ‰ç±»åˆ«ã€æŒ‰è´¦æˆ·ç­‰ï¼‰ |
| **æ€§èƒ½ä¼˜åŒ–** | å¢é‡è®¡ç®—ç®—æ³•ï¼Œåªé‡ç®—å—å½±å“çš„èµ„æºæ± ï¼Œé¿å…å…¨é‡é‡ç®— |
| **å¯è§‚æµ‹æ€§** | ä»ªè¡¨ç›˜ã€è¶‹åŠ¿å›¾ã€å½±å“å› ç´ åˆ†æï¼Œè®©æŠ½è±¡æ•°æ®å˜å¾—ç›´è§‚å¯ç†è§£ |

**ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é’±é¾„ç³»ç»Ÿä¸2.0æ ¸å¿ƒæ¨¡å—ååŒå›¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                       â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                              â”‚   é’±é¾„åˆ†æç³»ç»Ÿ    â”‚                                     â”‚
â”‚                              â”‚    (æœ¬ç« Â·æ ¸å¿ƒ)   â”‚                                     â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                       â”‚                                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚             â”‚               â”‚               â”‚             â”‚                 â”‚
â”‚         â–¼             â–¼               â–¼               â–¼             â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚é›¶åŸºé¢„ç®—ç³»ç»Ÿâ”‚ â”‚é‡‘èä¹ æƒ¯åŸ¹å…»â”‚ â”‚ ä¼™ä¼´åŒ–åé¦ˆ â”‚ â”‚ å®¶åº­è´¦æœ¬  â”‚ â”‚ è¯­éŸ³äº¤äº’  â”‚          â”‚
â”‚  â”‚  (ç¬¬8ç« )  â”‚ â”‚  (ç¬¬9ç« )  â”‚ â”‚  (ç¬¬4ç« )  â”‚ â”‚ (ç¬¬13ç« ) â”‚ â”‚ (ç¬¬18ç« ) â”‚          â”‚
â”‚  â”‚           â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚          â”‚
â”‚  â”‚é’±é¾„åé¦ˆâ†’  â”‚ â”‚é’±é¾„ä½œä¸º   â”‚ â”‚é’±é¾„å˜åŒ–â†’  â”‚ â”‚å®¶åº­é’±é¾„   â”‚ â”‚"æˆ‘çš„é’±é¾„  â”‚          â”‚
â”‚  â”‚é¢„ç®—è°ƒæ•´   â”‚ â”‚æ ¸å¿ƒæŒ‡æ ‡   â”‚ â”‚æƒ…æ„Ÿåé¦ˆ   â”‚ â”‚ç»Ÿè®¡å±•ç¤º   â”‚ â”‚å¤šå°‘å¤©"   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚             â”‚             â”‚             â”‚             â”‚                 â”‚
â”‚        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚             â”‚             â”‚                 â”‚
â”‚        â”‚   â”‚                   â”‚   â”‚             â”‚             â”‚                 â”‚
â”‚        â–¼   â–¼                   â–¼   â–¼             â–¼             â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ æ¶ˆè´¹å®¡è§†  â”‚          â”‚ å†²åŠ¨æ¶ˆè´¹  â”‚   â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ â”‚ â”‚ ç”¨æˆ·å¢é•¿  â”‚          â”‚
â”‚  â”‚(ç¬¬9ç« 6.2èŠ‚)â”‚          â”‚  é˜²æŠ¤    â”‚   â”‚ (ç¬¬17ç« )  â”‚ â”‚(ç¬¬28-29ç« )â”‚          â”‚
â”‚  â”‚           â”‚          â”‚(ç¬¬9ç« 6.3èŠ‚)â”‚   â”‚           â”‚ â”‚           â”‚          â”‚
â”‚  â”‚å›é¡¾å“ªäº›   â”‚          â”‚ä½é’±é¾„æ—¶   â”‚   â”‚é’±é¾„æ¨¡å¼   â”‚ â”‚é’±é¾„é‡Œç¨‹ç¢‘ â”‚          â”‚
â”‚  â”‚æ‹‰ä½é’±é¾„   â”‚          â”‚è§¦å‘é¢„è­¦   â”‚   â”‚å­¦ä¹ ä¼˜åŒ–   â”‚ â”‚åˆ†äº«å¼•å¯¼   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                  æ‰©å±•ååŒå±‚                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ä½ç½®æ™ºèƒ½  â”‚ â”‚ AIè¯†åˆ«    â”‚ â”‚ æ•°æ®å¯è§†åŒ– â”‚ â”‚ æ•°æ®å¯¼å…¥  â”‚ â”‚ å›½é™…åŒ–    â”‚          â”‚
â”‚  â”‚ (ç¬¬14ç« ) â”‚ â”‚ (ç¬¬10ç« ) â”‚ â”‚ (ç¬¬12ç« )  â”‚ â”‚ (ç¬¬11ç« ) â”‚ â”‚ (ç¬¬21ç« ) â”‚          â”‚
â”‚  â”‚           â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚          â”‚
â”‚  â”‚åœºæ™¯é’±é¾„   â”‚ â”‚äº¤æ˜“â†’é’±é¾„  â”‚ â”‚é’±é¾„è¶‹åŠ¿å›¾ â”‚ â”‚å†å²é’±é¾„   â”‚ â”‚å¤šè¯­è¨€     â”‚          â”‚
â”‚  â”‚åˆ†ç»´åˆ†æ   â”‚ â”‚å®æ—¶æ›´æ–°   â”‚ â”‚å¯è§†åŒ–å±•ç¤º â”‚ â”‚é‡å»ºè®¡ç®—   â”‚ â”‚é’±é¾„æ–‡æ¡ˆ   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                       â”‚
â”‚   ğŸ’¡ é’±é¾„æ˜¯è¡¡é‡è´¢åŠ¡å¥åº·çš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œè´¯ç©¿æ‰€æœ‰é‡‘èä¹ æƒ¯åŸ¹å…»æ¨¡å—                            â”‚
â”‚                                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1 é’±é¾„æ¦‚å¿µè¯´æ˜

**é’±é¾„ï¼ˆMoney Ageï¼‰** æ˜¯ä¸€ä¸ªåˆ›æ–°çš„è´¢åŠ¡å¥åº·æŒ‡æ ‡ï¼Œè¡¨ç¤ºæ‚¨èŠ±æ‰çš„æ¯ä¸€åˆ†é’±ï¼Œæ˜¯å¤šå°‘å¤©å‰èµšåˆ°çš„ã€‚

#### 7.1.1 æ ¸å¿ƒç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            é’±é¾„æ ¸å¿ƒç†å¿µ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ä¼ ç»Ÿè®°è´¦æ€ç»´ï¼š                                                             â”‚
â”‚   "æˆ‘è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘é’±ï¼Ÿ" â†’ åªå…³æ³¨æ”¯å‡ºé‡‘é¢                                    â”‚
â”‚                                                                             â”‚
â”‚   é’±é¾„æ€ç»´ï¼ˆ2.0åˆ›æ–°ï¼‰ï¼š                                                      â”‚
â”‚   "æˆ‘èŠ±çš„æ˜¯å¤šä¹…ä»¥å‰èµšçš„é’±ï¼Ÿ" â†’ å…³æ³¨èµ„é‡‘çš„æ—¶é—´ä»·å€¼                            â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚                     é’±é¾„ = æ”¯å‡ºæ—¶é—´ - æ”¶å…¥æ—¶é—´                   â”‚       â”‚
â”‚   â”‚                                                                 â”‚       â”‚
â”‚   â”‚   é’±é¾„è¶Šé«˜ â†’ èµ„é‡‘å­˜ç•™æ—¶é—´è¶Šé•¿ â†’ è´¢åŠ¡ç¼“å†²è¶Šå……è¶³ â†’ è´¢åŠ¡è¶Šå¥åº·     â”‚       â”‚
â”‚   â”‚   é’±é¾„è¶Šä½ â†’ å…¥ä¸æ•·å‡º/æœˆå…‰æ— â†’ æ— æ³•åº”å¯¹æ„å¤– â†’ éœ€è¦æ”¹å–„ä¹ æƒ¯      â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’¡ é’±é¾„æ˜¯"æ‡’äººè´¢åŠ¡å¥åº·æ£€æµ‹å™¨"ï¼šæ— éœ€å¤æ‚åˆ†æï¼Œä¸€ä¸ªæ•°å­—å‘Šè¯‰ä½ è´¢åŠ¡çŠ¶æ€        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.1.2 è®¡ç®—ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„è®¡ç®—ç¤ºä¾‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   1æœˆ1æ—¥æ”¶å…¥ Â¥10,000                                               â”‚
â”‚        â†“                                                           â”‚
â”‚   1æœˆ15æ—¥æ”¯å‡º Â¥2,000 â†’ é’±é¾„ = 14å¤© (ä½¿ç”¨1æœˆ1æ—¥çš„æ”¶å…¥)              â”‚
â”‚        â†“                                                           â”‚
â”‚   1æœˆ20æ—¥æ”¯å‡º Â¥3,000 â†’ é’±é¾„ = 19å¤© (ä½¿ç”¨1æœˆ1æ—¥çš„æ”¶å…¥)              â”‚
â”‚        â†“                                                           â”‚
â”‚   2æœˆ1æ—¥æ”¶å…¥ Â¥12,000                                               â”‚
â”‚        â†“                                                           â”‚
â”‚   2æœˆ5æ—¥æ”¯å‡º Â¥8,000 â†’ é’±é¾„ = 35å¤© (éƒ¨åˆ†ä½¿ç”¨1æœˆ1æ—¥ã€éƒ¨åˆ†2æœˆ1æ—¥)     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.1.3 é’±é¾„åº”ç”¨åœºæ™¯

| åœºæ™¯ | é’±é¾„çš„ä»·å€¼ | ä¸å…¶ä»–ç³»ç»Ÿè”åŠ¨ |
|------|-----------|---------------|
| **æ—¥å¸¸æ¶ˆè´¹å†³ç­–** | ä½é’±é¾„æ—¶æé†’è°¨æ…æ¶ˆè´¹ | å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤(ç¬¬9ç« 6.3èŠ‚) |
| **é¢„ç®—æ‰§è¡Œç›‘æ§** | é’±é¾„ä¸‹é™é¢„è­¦é¢„ç®—è¶…æ”¯ | é›¶åŸºé¢„ç®—ç³»ç»Ÿ(ç¬¬8ç« ) |
| **è´¢åŠ¡å¥åº·è¯„ä¼°** | é•¿æœŸé’±é¾„è¶‹åŠ¿åæ˜ è´¢åŠ¡ä¹ æƒ¯ | ä¹ æƒ¯å…»æˆæ¿€åŠ±(ç¬¬9ç« 6.6èŠ‚) |
| **æ¶ˆè´¹å¤ç›˜åˆ†æ** | å›é¡¾å“ªäº›æ”¯å‡ºæ‹‰ä½äº†é’±é¾„ | æ¶ˆè´¹å®¡è§†(ç¬¬9ç« 6.2èŠ‚) |
| **åº”æ€¥å‚¨å¤‡è§„åˆ’** | é’±é¾„ç›®æ ‡æŒ‡å¯¼å‚¨è“„è®¡åˆ’ | è´¢åŠ¡ç¼“å†²(ç¬¬9ç« 6.4èŠ‚) |

### 7.2 é’±é¾„å¥åº·ç­‰çº§

| ç­‰çº§ | é’±é¾„èŒƒå›´ | çŠ¶æ€ | å«ä¹‰ |
|------|----------|------|------|
| ğŸ”´ å±é™© | < 7å¤© | æœˆå…‰æ— | æ”¶å…¥å³èŠ±ï¼Œæ²¡æœ‰ç¼“å†² |
| ğŸŸ  è­¦å‘Š | 7-14å¤© | ç´§å¼  | åˆšè¿‡æ‰‹çš„é’±å°±èŠ±æ‰ |
| ğŸŸ¡ ä¸€èˆ¬ | 14-30å¤© | åŠæ ¼ | æœ‰åŸºæœ¬çš„èµ„é‡‘ç¼“å†² |
| ğŸŸ¢ è‰¯å¥½ | 30-60å¤© | å¥åº· | æœ‰ä¸€ä¸ªæœˆä»¥ä¸Šç¼“å†² |
| ğŸ”µ ä¼˜ç§€ | 60-90å¤© | ä¼˜ç§€ | è´¢åŠ¡çŠ¶å†µéå¸¸ç¨³å¥ |
| ğŸ’ ç†æƒ³ | > 90å¤© | è´¢åŠ¡è‡ªç”± | å¯åº”å¯¹å„ç§æ„å¤– |

### 7.3 é’±é¾„è®¡ç®—å¼•æ“

é’±é¾„è®¡ç®—å¼•æ“æ˜¯æœ¬ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œé‡‡ç”¨**FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰èµ„æºæ± æ¨¡å‹**å®ç°ç²¾ç¡®çš„èµ„é‡‘è¿½è¸ªã€‚

#### 7.3.0 è®¡ç®—å¼•æ“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„è®¡ç®—å¼•æ“æ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         äº¤æ˜“äº‹ä»¶æµ                                   â”‚   â”‚
â”‚   â”‚   æ”¶å…¥ â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ”¯å‡º   â”‚   â”‚
â”‚   â”‚            â”‚                                                        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â–¼                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚   â”‚    ResourcePoolManager  â”‚ â—„â”€â”€â”€â”€ èµ„æºæ± ç®¡ç†å™¨                            â”‚
â”‚   â”‚    (èµ„æºæ± ç®¡ç†å™¨)        â”‚                                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        èµ„æºæ± é˜Ÿåˆ—ï¼ˆFIFOï¼‰                            â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚
â”‚   â”‚   â”‚Pool #1 â”‚ â”‚Pool #2 â”‚ â”‚Pool #3 â”‚ â”‚Pool #4 â”‚ â”‚Pool #5 â”‚  ...      â”‚    â”‚
â”‚   â”‚   â”‚1æœˆå·¥èµ„ â”‚ â”‚1æœˆå¥–é‡‘ â”‚ â”‚2æœˆå·¥èµ„ â”‚ â”‚2æœˆå…¼èŒ â”‚ â”‚3æœˆå·¥èµ„ â”‚           â”‚    â”‚
â”‚   â”‚   â”‚Â¥8,000  â”‚ â”‚Â¥2,000  â”‚ â”‚Â¥8,500  â”‚ â”‚Â¥1,500  â”‚ â”‚Â¥9,000  â”‚           â”‚    â”‚
â”‚   â”‚   â”‚å‰©ä½™Â¥0  â”‚ â”‚å‰©ä½™Â¥0  â”‚ â”‚å‰©ä½™Â¥500â”‚ â”‚å‰©ä½™Â¥1.5kâ”‚ â”‚å‰©ä½™Â¥9k â”‚           â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚
â”‚   â”‚      â†‘å·²ç”¨å®Œ    â†‘å·²ç”¨å®Œ    â†‘éƒ¨åˆ†ç”¨   â†‘å½“å‰æ¶ˆè´¹   â†‘å¾…ç”¨              â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                                                             â”‚
â”‚                â–¼                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚   MoneyAgeCalculator   â”‚ â”€â”€â–º â”‚   MoneyAgeResult       â”‚                 â”‚
â”‚   â”‚   (è®¡ç®—åŠ æƒå¹³å‡é’±é¾„)    â”‚     â”‚   { moneyAge: 45å¤©     â”‚                 â”‚
â”‚   â”‚                        â”‚     â”‚     consumptions: [...] â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     healthLevel: good } â”‚                 â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç®—æ³•ç‰¹æ€§**ï¼š

| ç‰¹æ€§ | è¯´æ˜ | æŠ€æœ¯å®ç° |
|------|------|----------|
| **FIFOåŸåˆ™** | å…ˆèµšçš„é’±å…ˆèŠ±ï¼Œç¬¦åˆçœŸå®èµ„é‡‘æµåŠ¨ | èµ„æºæ± æŒ‰æ—¶é—´æ’åºï¼Œé¡ºåºæ¶ˆè´¹ |
| **å¢é‡è®¡ç®—** | åªé‡ç®—å—å½±å“äº¤æ˜“ï¼Œæ€§èƒ½ä¼˜åŒ– | äº¤æ˜“å˜æ›´æ—¶æ ‡è®°è„æ•°æ®ï¼Œå®šæ—¶åˆ·æ–° |
| **åŠ æƒå¹³å‡** | å•ç¬”æ”¯å‡ºè·¨å¤šä¸ªæ”¶å…¥æ± æ—¶ç²¾ç¡®è®¡ç®— | Î£(é‡‘é¢Ã—é’±é¾„) / æ€»é‡‘é¢ |
| **èµ„æºè¿½æº¯** | æ¯ç¬”æ”¯å‡ºå¯è¿½æº¯åˆ°å…·ä½“æ”¶å…¥æ¥æº | ResourceConsumption è®°å½•æ¶ˆè´¹é“¾è·¯ |
| **ç¦»çº¿ä¼˜å…ˆ** | æœ¬åœ°è®¡ç®—ï¼Œæ— éœ€ç½‘ç»œ | SQLiteå­˜å‚¨èµ„æºæ± çŠ¶æ€ |

#### 7.3.1 FIFOèµ„æºæ± æ¨¡å‹

```dart
/// èµ„æºæ±  - è¿½è¸ªæ¯ç¬”æ”¶å…¥çš„ä½¿ç”¨æƒ…å†µ
class ResourcePool {
  final String id;
  final String incomeTransactionId;  // å…³è”çš„æ”¶å…¥äº¤æ˜“
  final DateTime createdAt;           // èµ„é‡‘è¿›å…¥æ—¶é—´
  final double originalAmount;        // åŸå§‹é‡‘é¢
  double remainingAmount;             // å‰©ä½™é‡‘é¢

  /// è®¡ç®—å½“å‰é’±é¾„ï¼ˆå¤©ï¼‰
  int get ageInDays => DateTime.now().difference(createdAt).inDays;

  /// ä½¿ç”¨èµ„é‡‘
  ResourceConsumption consume(double amount, String transactionId) {
    final consumed = min(amount, remainingAmount);
    remainingAmount -= consumed;
    return ResourceConsumption(
      poolId: id,
      amount: consumed,
      ageAtConsumption: ageInDays,
      transactionId: transactionId,
    );
  }
}

/// é’±é¾„è®¡ç®—æœåŠ¡
class MoneyAgeCalculator {
  final List<ResourcePool> pools = [];

  /// å¤„ç†æ”¶å…¥ï¼šåˆ›å»ºæ–°çš„èµ„æºæ± 
  void processIncome(Transaction income) {
    pools.add(ResourcePool(
      id: generateId(),
      incomeTransactionId: income.id,
      createdAt: income.date,
      originalAmount: income.amount,
      remainingAmount: income.amount,
    ));
    // æŒ‰æ—¶é—´æ’åºï¼Œç¡®ä¿FIFO
    pools.sort((a, b) => a.createdAt.compareTo(b.createdAt));
  }

  /// å¤„ç†æ”¯å‡ºï¼šæŒ‰FIFOæ¶ˆè€—èµ„æºæ± 
  MoneyAgeResult processExpense(Transaction expense) {
    final consumptions = <ResourceConsumption>[];
    var remaining = expense.amount;

    for (final pool in pools) {
      if (remaining <= 0) break;
      if (pool.remainingAmount <= 0) continue;

      final consumption = pool.consume(remaining, expense.id);
      consumptions.add(consumption);
      remaining -= consumption.amount;
    }

    // è®¡ç®—åŠ æƒå¹³å‡é’±é¾„
    final totalAmount = consumptions.fold(0.0, (sum, c) => sum + c.amount);
    final weightedAge = consumptions.fold(0.0,
      (sum, c) => sum + c.amount * c.ageAtConsumption
    ) / totalAmount;

    return MoneyAgeResult(
      transactionId: expense.id,
      moneyAge: weightedAge.round(),
      consumptions: consumptions,
    );
  }
}

/// å•ç¬”æ¶ˆè´¹çš„é’±é¾„è®¡ç®—ç»“æœ
class MoneyAgeResult {
  /// äº¤æ˜“ID
  final String transactionId;

  /// è¯¥ç¬”æ¶ˆè´¹çš„é’±é¾„ï¼ˆå¤©ï¼‰
  final int moneyAge;

  /// èµ„æºæ¶ˆè€—è¯¦æƒ…
  final List<ResourceConsumption> consumptions;

  /// æ˜¯å¦æœ‰æœªè¦†ç›–é‡‘é¢ï¼ˆèµ„æºä¸è¶³ï¼‰
  bool get hasUncovered => consumptions.any((c) => c.uncoveredAmount > 0);
}

/// é’±é¾„æ ¸å¿ƒæ¨¡å‹ï¼ˆç”¨äºå±•ç¤ºå’Œè®¡ç®—ï¼‰
class MoneyAge {
  /// é’±é¾„å¤©æ•°
  final int days;

  /// é’±é¾„è¿›é˜¶æœåŠ¡å¼•ç”¨ï¼ˆç”¨äºè®¡ç®—stageï¼‰
  static final _progressionService = MoneyAgeProgressionService();

  /// é’±é¾„æè¿°
  String get description {
    if (days >= 30) return 'èµ„é‡‘å‘¨è½¬éå¸¸å¥åº·';
    if (days >= 14) return 'èµ„é‡‘å‘¨è½¬è¾ƒå¥½';
    if (days >= 7) return 'å»ºè®®å¢åŠ å‚¨è“„ç¼“å†²';
    return 'å¯èƒ½åœ¨èŠ±è´¹åˆšæ”¶åˆ°çš„é’±';
  }

  /// å¥åº·ç­‰çº§
  MoneyAgeLevel get level {
    if (days < 7) return MoneyAgeLevel.danger;
    if (days < 14) return MoneyAgeLevel.warning;
    if (days < 30) return MoneyAgeLevel.normal;
    if (days < 60) return MoneyAgeLevel.good;
    if (days < 90) return MoneyAgeLevel.excellent;
    return MoneyAgeLevel.ideal;
  }

  /// æ˜¯å¦å¥åº·
  bool get isHealthy => days >= 14;

  /// å½“å‰é’±é¾„é˜¶æ®µï¼ˆå…³è” MoneyAgeProgressionServiceï¼‰
  MoneyAgeStage get stage => _progressionService.getCurrentStage(days);

  /// ä¸‹ä¸€é˜¶æ®µç›®æ ‡ï¼ˆå¯èƒ½ä¸ºnullï¼Œè¡¨ç¤ºå·²è¾¾æœ€é«˜é˜¶æ®µï¼‰
  MoneyAgeStage? get nextStage => _progressionService.getNextStage(days);

  const MoneyAge({required this.days});

  factory MoneyAge.fromResult(MoneyAgeResult result) {
    return MoneyAge(days: result.moneyAge);
  }
}

/// é’±é¾„å¥åº·ç­‰çº§
enum MoneyAgeLevel {
  danger,     // < 7å¤©ï¼Œå±é™©
  warning,    // 7-14å¤©ï¼Œè­¦å‘Š
  normal,     // 14-30å¤©ï¼Œæ­£å¸¸
  good,       // 30-60å¤©ï¼Œè‰¯å¥½
  excellent,  // 60-90å¤©ï¼Œä¼˜ç§€
  ideal,      // > 90å¤©ï¼Œç†æƒ³

  Color get color {
    switch (this) {
      case danger: return Colors.red;
      case warning: return Colors.orange;
      case normal: return Colors.yellow;
      case good: return Colors.lightGreen;
      case excellent: return Colors.green;
      case ideal: return Colors.teal;
    }
  }
}
```

#### 7.3.2 é’±é¾„ç»Ÿè®¡æ±‡æ€»

```dart
/// é’±é¾„ç»Ÿè®¡æ±‡æ€»
class MoneyAgeStatistics {
  /// å½“å‰å¹³å‡é’±é¾„
  final int averageAge;

  /// é’±é¾„è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰
  final List<DailyMoneyAge> trend;

  /// æŒ‰åˆ†ç±»çš„é’±é¾„åˆ†å¸ƒ
  final Map<String, int> ageByCategory;

  /// å¥åº·ç­‰çº§ï¼ˆé˜ˆå€¼ä¸ MoneyAge.level ä¿æŒä¸€è‡´ï¼‰
  MoneyAgeLevel get healthLevel {
    if (averageAge < 7) return MoneyAgeLevel.danger;
    if (averageAge < 14) return MoneyAgeLevel.warning;  // ç»Ÿä¸€ä½¿ç”¨14ï¼Œä¸MoneyAgeä¸€è‡´
    if (averageAge < 30) return MoneyAgeLevel.normal;
    if (averageAge < 60) return MoneyAgeLevel.good;
    if (averageAge < 90) return MoneyAgeLevel.excellent;
    return MoneyAgeLevel.ideal;
  }

  /// æ”¹å–„å»ºè®®
  List<String> get suggestions {
    switch (healthLevel) {
      case MoneyAgeLevel.danger:
        return [
          'å»ºè®®è®¾ç½®ç´§æ€¥å‚¨å¤‡é‡‘ç›®æ ‡',
          'æ£€æŸ¥æ˜¯å¦æœ‰å¯å‰Šå‡çš„éå¿…è¦æ”¯å‡º',
          'è€ƒè™‘å¢åŠ æ”¶å…¥æ¥æº',
        ];
      case MoneyAgeLevel.warning:
        return [
          'ç»§ç»­ä¿æŒå‚¨è“„ä¹ æƒ¯',
          'é¿å…å¤§é¢å†²åŠ¨æ¶ˆè´¹',
          'ä¸ºä¸‹ä¸ªæœˆçš„å¤§é¢æ”¯å‡ºæå‰è§„åˆ’',
        ];
      // ... å…¶ä»–ç­‰çº§
    }
  }
}
```

### 7.4 é’±é¾„å¯è§†åŒ–ç»„ä»¶

é’±é¾„å¯è§†åŒ–ç»„ä»¶éµå¾ª**å¯è§‚æµ‹æ€§åŸåˆ™**ï¼Œå°†æŠ½è±¡çš„é’±é¾„æ•°æ®è½¬åŒ–ä¸ºç›´è§‚ã€æ˜“ç†è§£çš„å›¾å½¢ç•Œé¢ã€‚

#### 7.4.0 å¯è§†åŒ–ç»„ä»¶å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é’±é¾„å¯è§†åŒ–ç»„ä»¶ä½“ç³»                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                          é¦–é¡µä»ªè¡¨ç›˜åŒºåŸŸ                              â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  é’±é¾„å¡ç‰‡    â”‚  â”‚  é¢„ç®—å¡ç‰‡    â”‚  â”‚  æœ¬æœˆæ”¯å‡ºå¡ç‰‡        â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  â”‚  45   â”‚  â”‚  â”‚  â”‚ 68%   â”‚  â”‚  â”‚  â”‚ Â¥3,280        â”‚  â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  â”‚  å¤©   â”‚  â”‚  â”‚  â”‚       â”‚  â”‚  â”‚  â”‚               â”‚  â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  ğŸŸ¢ è‰¯å¥½    â”‚  â”‚  â¬›â¬›â¬›â¬œâ¬œ   â”‚  â”‚  è¾ƒä¸Šæœˆ -12%        â”‚  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼ ç‚¹å‡»è¿›å…¥                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                          é’±é¾„è¯¦æƒ…é¡µ                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚   â”‚   â”‚  30å¤©é’±é¾„è¶‹åŠ¿å›¾                                            â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  â•±â•²    â•±â•²                                                â”‚     â”‚   â”‚
â”‚   â”‚   â”‚ â•±  â•²â”€â”€â•±  â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚     â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚   â”‚   â”‚  é’±é¾„å½±å“å› ç´ åˆ†æ                                          â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  ğŸœ é¤é¥® -8å¤©  ğŸ›’ è´­ç‰© -5å¤©  ğŸš— äº¤é€š -2å¤©  ğŸ’° å·¥èµ„ +30å¤©    â”‚     â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚   â”‚   â”‚  é’±é¾„é˜¶æ®µè¿›åº¦                                              â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  æœˆå…‰æ— â†’ ç´§å¼  â†’ [å½“å‰: è‰¯å¥½] â†’ ä¼˜ç§€ â†’ è´¢åŠ¡è‡ªç”±             â”‚     â”‚   â”‚
â”‚   â”‚   â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚     â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯è§†åŒ–è®¾è®¡åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|----------|
| **ä¸€çœ¼å¯è§** | æ ¸å¿ƒæ•°æ®æ— éœ€ç‚¹å‡»å³å¯è·å– | é¦–é¡µé’±é¾„å¡ç‰‡çªå‡ºæ˜¾ç¤ºå¤©æ•° |
| **é¢œè‰²ç¼–ç ** | ç”¨è‰²å½©ä¼ è¾¾å¥åº·çŠ¶æ€ | 6çº§é¢œè‰²å¯¹åº”6ä¸ªå¥åº·ç­‰çº§ |
| **æ¸è¿›æŠ«éœ²** | ä»æ¦‚è§ˆåˆ°è¯¦æƒ…é€å±‚å±•å¼€ | é¦–é¡µå¡ç‰‡â†’è¯¦æƒ…é¡µâ†’å½±å“åˆ†æ |
| **æ•°æ®å…³è”** | é’±é¾„ä¸äº¤æ˜“ã€é¢„ç®—è”åŠ¨å±•ç¤º | ç‚¹å‡»è¶‹åŠ¿å›¾å¯ä¸‹é’»åˆ°å…·ä½“äº¤æ˜“ |
| **åŠ¨æ•ˆåé¦ˆ** | çŠ¶æ€å˜åŒ–æœ‰åŠ¨ç”»è¿‡æ¸¡ | ç­‰çº§æå‡æ—¶æ’­æ”¾åº†ç¥åŠ¨ç”» |

#### 7.4.1 é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡

```dart
/// é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡
class MoneyAgeDashboardCard extends StatelessWidget {
  final MoneyAgeStatistics stats;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: () => Navigator.pushNamed(context, '/money-age'),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // æ ‡é¢˜è¡Œ
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text('é’±é¾„', style: Theme.of(context).textTheme.titleMedium),
                  _buildHealthBadge(stats.healthLevel),
                ],
              ),
              SizedBox(height: 16),

              // æ ¸å¿ƒæ•°å­—
              Row(
                crossAxisAlignment: CrossAxisAlignment.baseline,
                textBaseline: TextBaseline.alphabetic,
                children: [
                  Text(
                    '${stats.averageAge}',
                    style: TextStyle(
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: stats.healthLevel.color,
                    ),
                  ),
                  Text(' å¤©', style: TextStyle(fontSize: 16)),
                ],
              ),

              // è¶‹åŠ¿è¿·ä½ å›¾
              SizedBox(height: 16),
              MoneyAgeTrendMiniChart(data: stats.trend),

              // ç‚¹å‡»æç¤º
              SizedBox(height: 8),
              Text(
                'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’',
                style: TextStyle(color: Colors.grey, fontSize: 12),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 7.4.2 é’±é¾„è¶‹åŠ¿å›¾

```dart
/// é’±é¾„è¶‹åŠ¿å›¾ï¼ˆæ”¯æŒä¸‹é’»ï¼‰
class MoneyAgeTrendChart extends StatelessWidget {
  final List<DailyMoneyAge> data;
  final Function(DateTime date)? onDateTap;

  @override
  Widget build(BuildContext context) {
    return LineChart(
      LineChartData(
        lineBarsData: [
          LineChartBarData(
            spots: data.asMap().entries.map((e) =>
              FlSpot(e.key.toDouble(), e.value.averageAge.toDouble())
            ).toList(),
            isCurved: true,
            color: Theme.of(context).primaryColor,
            belowBarData: BarAreaData(
              show: true,
              color: Theme.of(context).primaryColor.withOpacity(0.1),
            ),
          ),
        ],
        lineTouchData: LineTouchData(
          touchCallback: (event, response) {
            if (event is FlTapUpEvent && response?.lineBarSpots != null) {
              final index = response!.lineBarSpots!.first.spotIndex;
              onDateTap?.call(data[index].date);
            }
          },
          touchTooltipData: LineTouchTooltipData(
            getTooltipItems: (spots) => spots.map((spot) {
              final item = data[spot.spotIndex];
              return LineTooltipItem(
                '${item.date.format("MM/dd")}\n${item.averageAge}å¤©',
                TextStyle(color: Colors.white),
              );
            }).toList(),
          ),
        ),
        // ... å…¶ä»–å›¾è¡¨é…ç½®
      ),
    );
  }
}
```

### 7.5 é’±é¾„å½±å“å› ç´ åˆ†æ

```dart
/// é’±é¾„å½±å“å› ç´ 
enum MoneyAgeInfluence {
  /// å¤§é¢æ”¯å‡º - å¿«é€Ÿæ¶ˆè€—è€èµ„é‡‘
  largeExpense,

  /// æ”¶å…¥å»¶è¿Ÿ - ç­‰å¾…æ–°èµ„é‡‘è¡¥å……
  delayedIncome,

  /// æŒç»­å‚¨è“„ - è€èµ„é‡‘ç§¯ç´¯
  consistentSaving,

  /// æ„å¤–æ”¯å‡º - æ‰“æ–­å‚¨è“„è®¡åˆ’
  unexpectedExpense,

  /// æ”¶å…¥å¢åŠ  - æ›´å¤šèµ„é‡‘å¯ç”¨
  incomeIncrease,
}

/// å½±å“å› ç´ åˆ†æç»“æœ
class InfluenceAnalysis {
  final MoneyAgeInfluence influence;
  final double impact;  // å¯¹é’±é¾„çš„å½±å“å¤©æ•° (+/-)
  final String description;
  final List<Transaction> relatedTransactions;

  /// ç”Ÿæˆè‡ªç„¶è¯­è¨€æè¿°
  String get narrativeDescription {
    switch (influence) {
      case MoneyAgeInfluence.largeExpense:
        return 'æœ¬æœˆæœ‰ä¸€ç¬”å¤§é¢æ”¯å‡º(${relatedTransactions.first.categoryName})'
               'æ¶ˆè€—äº†è¾ƒå¤šè€èµ„é‡‘ï¼Œå¯¼è‡´é’±é¾„é™ä½çº¦${impact.abs().toStringAsFixed(0)}å¤©';
      case MoneyAgeInfluence.consistentSaving:
        return 'æ‚¨æŒç»­ä¿æŒå‚¨è“„ä¹ æƒ¯ï¼Œ'
               'ä½¿å¾—å¹³å‡é’±é¾„å¢åŠ äº†${impact.toStringAsFixed(0)}å¤©';
      // ... å…¶ä»–æƒ…å†µ
    }
  }
}
```

### 7.6 é’±é¾„æ¨¡å‹å±‚æ¬¡ç»“æ„

ä¸ºé¿å…é‡å¤å®šä¹‰ï¼Œé’±é¾„ç³»ç»Ÿé‡‡ç”¨ä»¥ä¸‹ç»Ÿä¸€çš„ç±»å±‚æ¬¡ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é’±é¾„æ¨¡å‹å±‚æ¬¡ç»“æ„                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  åŸºç¡€å±‚ï¼ˆç¬¬7ç« å®šä¹‰ï¼Œå…¨å±€ç»Ÿä¸€ï¼‰                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MoneyAge               åŸºç¡€é’±é¾„æ¨¡å‹ï¼ˆdays, description, levelï¼‰             â”‚   â”‚
â”‚  â”‚  MoneyAgeResult         å•ç¬”æ¶ˆè´¹è®¡ç®—ç»“æœï¼ˆtransactionId, moneyAgeï¼‰          â”‚   â”‚
â”‚  â”‚  MoneyAgeStatistics     ç»Ÿè®¡æ±‡æ€»ï¼ˆaverageAge, trend, ageByCategoryï¼‰         â”‚   â”‚
â”‚  â”‚  MoneyAgeLevel          å¥åº·ç­‰çº§æšä¸¾ï¼ˆdanger â†’ idealï¼‰                       â”‚   â”‚
â”‚  â”‚  MoneyAgeCalculator     åŸºç¡€è®¡ç®—æœåŠ¡ï¼ˆFIFOèµ„æºæ± æ¨¡å‹ï¼‰                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                           â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚            â”‚                            â”‚                            â”‚              â”‚
â”‚            â–¼                            â–¼                            â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ä½ç½®å¢å¼ºå±‚ï¼ˆç¬¬14ç« ï¼‰ â”‚   â”‚ å®¶åº­åä½œå±‚ï¼ˆç¬¬13ç« ï¼‰ â”‚   â”‚ è‡ªå­¦ä¹ å±‚ï¼ˆç¬¬17ç« ï¼‰  â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ EnhancedMoneyAge    â”‚   â”‚ FamilyMoneyAge      â”‚   â”‚ SmartMoneyAge       â”‚       â”‚
â”‚  â”‚ â€¢ overall ç»¼åˆé’±é¾„  â”‚   â”‚ â€¢ familyAverage     â”‚   â”‚ â€¢ predictedAge      â”‚       â”‚
â”‚  â”‚ â€¢ daily æ—¥å¸¸é’±é¾„    â”‚   â”‚   å®¶åº­å¹³å‡é’±é¾„      â”‚   â”‚   é¢„æµ‹é’±é¾„è¶‹åŠ¿      â”‚       â”‚
â”‚  â”‚ â€¢ temporary ä¸´æ—¶é’±é¾„â”‚   â”‚ â€¢ memberAges        â”‚   â”‚ â€¢ suggestions       â”‚       â”‚
â”‚  â”‚                     â”‚   â”‚   æˆå‘˜é’±é¾„åˆ—è¡¨      â”‚   â”‚   ä¼˜åŒ–å»ºè®®          â”‚       â”‚
â”‚  â”‚ PreciseMoneyAge     â”‚   â”‚ â€¢ contributions     â”‚   â”‚ â€¢ patterns          â”‚       â”‚
â”‚  â”‚ â€¢ byContext åˆ†åœºæ™¯  â”‚   â”‚   æˆå‘˜è´¡çŒ®åº¦        â”‚   â”‚   æ¶ˆè´¹æ¨¡å¼è¯†åˆ«      â”‚       â”‚
â”‚  â”‚ â€¢ insights æ´å¯Ÿå»ºè®® â”‚   â”‚                     â”‚   â”‚                     â”‚       â”‚
â”‚  â”‚                     â”‚   â”‚ FamilyMoneyAge-     â”‚   â”‚ MoneyAgeLearning-   â”‚       â”‚
â”‚  â”‚ LocationAware-      â”‚   â”‚ Calculator          â”‚   â”‚ Service             â”‚       â”‚
â”‚  â”‚ MoneyAgeService     â”‚   â”‚ â””â”€æ±‡æ€»å®¶åº­æˆå‘˜é’±é¾„  â”‚   â”‚ â””â”€å­¦ä¹ ç”¨æˆ·æ¶ˆè´¹æ¨¡å¼  â”‚       â”‚
â”‚  â”‚ â””â”€æ·»åŠ ä½ç½®æ„ŸçŸ¥èƒ½åŠ›  â”‚   â”‚                     â”‚   â”‚   ä¼˜åŒ–é’±é¾„é¢„æµ‹      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚            â”‚                            â”‚                            â”‚              â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¯­éŸ³äº¤äº’å±‚ï¼ˆç¬¬18ç« ï¼Œé’±é¾„æ’­æŠ¥ï¼‰                                               â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  MoneyAgeVoiceService                                                       â”‚   â”‚
â”‚  â”‚    â””â”€â”€ é’±é¾„è¯­éŸ³æ’­æŠ¥ï¼š"æ‚¨å½“å‰çš„é’±é¾„æ˜¯45å¤©ï¼Œå¤„äºè‰¯å¥½æ°´å¹³"                      â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  MoneyAgeQueryHandler                                                       â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å¤„ç†è¯­éŸ³æŸ¥è¯¢ï¼š"æˆ‘çš„é’±é¾„å¤šå°‘å¤©"ã€"è¿™ç¬”æ¶ˆè´¹èŠ±çš„æ˜¯ä»€ä¹ˆæ—¶å€™çš„é’±"          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                           â”‚
â”‚                                         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å®¹é”™å±‚ï¼ˆç¬¬23ç« ï¼Œå¼‚å¸¸å¤„ç†ï¼‰                                                   â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  RobustMoneyAgeCalculator                                                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è£…é¥° MoneyAgeCalculatorï¼Œæ·»åŠ å¼‚å¸¸å¤„ç†ã€é‡è¯•ã€é™çº§ç­–ç•¥                 â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  MoneyAgeFallbackService                                                    â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è®¡ç®—å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç¼“å­˜é’±é¾„æˆ–ä¼°ç®—å€¼                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç±»ç»§æ‰¿å…³ç³»**ï¼š

```
MoneyAge (base)
  â”œâ”€â”€ EnhancedMoneyAge (+ daily, temporary)
  â”‚     â””â”€â”€ PreciseMoneyAge (+ byContext, insights)
  â”œâ”€â”€ FamilyMoneyAge (+ familyAverage, memberAges, contributions)
  â””â”€â”€ SmartMoneyAge (+ predictedAge, suggestions, patterns)
```

**æœåŠ¡è£…é¥°å…³ç³»**ï¼š

```
MoneyAgeCalculator (base)
  â”œâ”€â”€ LocationAwareMoneyAgeService (+ ä½ç½®æ„ŸçŸ¥)
  â”œâ”€â”€ FamilyMoneyAgeCalculator (+ å®¶åº­æ±‡æ€»)
  â”œâ”€â”€ MoneyAgeLearningService (+ è‡ªå­¦ä¹ ä¼˜åŒ–)
  â”œâ”€â”€ MoneyAgeVoiceService (+ è¯­éŸ³æ’­æŠ¥)
  â””â”€â”€ RobustMoneyAgeCalculator (+ å¼‚å¸¸å¤„ç†)
```

### 7.7 é’±é¾„ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

é’±é¾„ä½œä¸º2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè´¢åŠ¡å¥åº·æŒ‡æ ‡ï¼Œéœ€è¦ä¸å¤šä¸ªç³»ç»Ÿæ·±åº¦é›†æˆï¼Œå½¢æˆå®Œæ•´çš„"é‡‘èä¹ æƒ¯åŸ¹å…»"é—­ç¯ã€‚

#### 7.7.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          é’±é¾„ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾ï¼ˆ2.0ç‰ˆæœ¬ï¼‰                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                       â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                              â”‚    é’±é¾„æ™ºèƒ½åˆ†æç³»ç»Ÿ    â”‚                                â”‚
â”‚                              â”‚   MoneyAgeSystem      â”‚                                â”‚
â”‚                              â”‚   (æœ¬ç« Â·æ ¸å¿ƒæŒ‡æ ‡)     â”‚                                â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                          â”‚                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                 æ ¸å¿ƒä¸šåŠ¡é›†æˆå±‚                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                          â”‚                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚              â”‚              â”‚               â”‚              â”‚              â”‚     â”‚
â”‚    â–¼              â–¼              â–¼               â–¼              â–¼              â–¼     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚é›¶åŸºé¢„ç®—â”‚  â”‚ä¹ æƒ¯åŸ¹å…»â”‚  â”‚ æ¶ˆè´¹å®¡è§†   â”‚  â”‚ å†²åŠ¨æ¶ˆè´¹  â”‚  â”‚è´¢åŠ¡ç¼“å†²â”‚  â”‚ä¼™ä¼´åŒ–  â”‚      â”‚
â”‚ â”‚ (8ç« ) â”‚  â”‚ (9ç« ) â”‚  â”‚(9ç« 6.2èŠ‚) â”‚  â”‚  é˜²æŠ¤    â”‚  â”‚(9ç« 6.4)â”‚  â”‚ (4ç« ) â”‚      â”‚
â”‚ â”‚        â”‚  â”‚        â”‚  â”‚           â”‚  â”‚(9ç« 6.3èŠ‚) â”‚  â”‚        â”‚  â”‚        â”‚      â”‚
â”‚ â”‚é’±é¾„åé¦ˆâ”‚  â”‚é’±é¾„æå‡â”‚  â”‚é’±é¾„ä½œä¸º   â”‚  â”‚ä½é’±é¾„æ—¶   â”‚  â”‚é’±é¾„ç›®æ ‡â”‚  â”‚é’±é¾„æ’­æŠ¥â”‚      â”‚
â”‚ â”‚é¢„ç®—è°ƒæ•´â”‚  â”‚æˆå°±å¥–åŠ±â”‚  â”‚å®¡è§†æŒ‡æ ‡   â”‚  â”‚è§¦å‘é¢„è­¦   â”‚  â”‚å‚¨è“„è§„åˆ’â”‚  â”‚æƒ…æ„Ÿåé¦ˆâ”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                 åä½œä¸äº¤äº’é›†æˆå±‚                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ å®¶åº­è´¦æœ¬    â”‚  â”‚ è¯­éŸ³äº¤äº’    â”‚  â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚ ç”¨æˆ·å¢é•¿    â”‚                  â”‚
â”‚  â”‚  (ç¬¬13ç« )  â”‚  â”‚  (ç¬¬18ç« )  â”‚  â”‚  (ç¬¬17ç« )  â”‚  â”‚ (ç¬¬28-29ç« ) â”‚                  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚                  â”‚
â”‚  â”‚ å®¶åº­é’±é¾„    â”‚  â”‚ "æˆ‘çš„é’±é¾„   â”‚  â”‚ é’±é¾„æ¨¡å¼    â”‚  â”‚ é’±é¾„é‡Œç¨‹ç¢‘  â”‚                  â”‚
â”‚  â”‚ ç»Ÿè®¡æ±‡æ€»    â”‚  â”‚  å¤šå°‘å¤©"   â”‚  â”‚ å­¦ä¹ ä¼˜åŒ–    â”‚  â”‚ åˆ†äº«å¼•å¯¼    â”‚                  â”‚
â”‚  â”‚ æˆå‘˜è´¡çŒ®    â”‚  â”‚ è¯­éŸ³æ’­æŠ¥    â”‚  â”‚ è¶‹åŠ¿é¢„æµ‹    â”‚  â”‚ NPSå…³è”     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                   æŠ€æœ¯æ”¯æ’‘é›†æˆå±‚                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ä½ç½®æ™ºèƒ½ â”‚ â”‚AIè¯†åˆ«   â”‚ â”‚æ•°æ®å¯è§†åŒ–â”‚ â”‚æ•°æ®å¯¼å…¥ â”‚ â”‚å›½é™…åŒ–   â”‚ â”‚å¼‚å¸¸å¤„ç† â”‚            â”‚
â”‚  â”‚ (14ç« ) â”‚ â”‚ (10ç« ) â”‚ â”‚ (12ç« )  â”‚ â”‚ (11ç« ) â”‚ â”‚ (21ç« ) â”‚ â”‚ (23ç« ) â”‚            â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚            â”‚
â”‚  â”‚åœºæ™¯é’±é¾„ â”‚ â”‚äº¤æ˜“â†’   â”‚ â”‚é’±é¾„è¶‹åŠ¿ â”‚ â”‚å†å²é’±é¾„ â”‚ â”‚å¤šè¯­è¨€   â”‚ â”‚è®¡ç®—é™çº§ â”‚            â”‚
â”‚  â”‚åˆ†ç»´åˆ†æ â”‚ â”‚é’±é¾„æ›´æ–° â”‚ â”‚å›¾è¡¨å±•ç¤º â”‚ â”‚é‡å»ºè®¡ç®— â”‚ â”‚é’±é¾„æ–‡æ¡ˆ â”‚ â”‚å®¹é”™å¤„ç† â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é›†æˆè§¦å‘ç‚¹**ï¼š

| è§¦å‘äº‹ä»¶ | é›†æˆåŠ¨ä½œ | æ¶‰åŠç³»ç»Ÿ |
|----------|----------|----------|
| æ–°å¢æ”¶å…¥ | åˆ›å»ºèµ„æºæ± ï¼Œæ›´æ–°é’±é¾„ç»Ÿè®¡ | èµ„æºæ± ç®¡ç†å™¨ |
| æ–°å¢æ”¯å‡º | FIFOæ¶ˆè´¹èµ„æºæ± ï¼Œè®¡ç®—å•ç¬”é’±é¾„ | æ‰€æœ‰é›†æˆç³»ç»Ÿ |
| é’±é¾„ç­‰çº§å˜åŒ– | è§¦å‘é¢„è­¦/åº†ç¥ï¼Œæ›´æ–°æˆå°± | å†²åŠ¨é˜²æŠ¤(9ç« )ã€ä¹ æƒ¯åŸ¹å…»(9ç« )ã€ä¼™ä¼´åŒ–(4ç« ) |
| å‘¨æœŸç»“ç®— | ç”Ÿæˆé’±é¾„æŠ¥å‘Šï¼Œè°ƒæ•´é¢„ç®—å»ºè®® | é›¶åŸºé¢„ç®—(8ç« )ã€æ¶ˆè´¹å®¡è§†(9ç« ) |
| ç›®æ ‡è¾¾æˆ | å‘æ”¾å¥–åŠ±ï¼Œæ›´æ–°è¿›åº¦ | ä¹ æƒ¯åŸ¹å…»(9ç« )ã€è´¢åŠ¡ç¼“å†²(9ç« ) |
| å®¶åº­æˆå‘˜è®°è´¦ | æ›´æ–°å®¶åº­é’±é¾„ç»Ÿè®¡ | å®¶åº­è´¦æœ¬(13ç« ) |
| è¯­éŸ³æŸ¥è¯¢é’±é¾„ | è¿”å›é’±é¾„æ’­æŠ¥æ–‡æ¡ˆ | è¯­éŸ³äº¤äº’(18ç« ) |
| é’±é¾„é‡Œç¨‹ç¢‘ | è§¦å‘åˆ†äº«å¼•å¯¼ | ç”¨æˆ·å¢é•¿(28-29ç« ) |

#### 7.7.1 é›†æˆæ¥å£å®šä¹‰

```dart
/// é’±é¾„ç³»ç»Ÿé›†æˆæ¥å£
abstract class MoneyAgeIntegration {
  /// è·å–å½“å‰é’±é¾„
  Future<MoneyAge> getCurrentMoneyAge();

  /// è·å–é’±é¾„ç»Ÿè®¡
  Future<MoneyAgeStatistics> getStatistics();

  /// è·å–å¢å¼ºé’±é¾„ï¼ˆä½ç½®æ„ŸçŸ¥ï¼‰
  Future<EnhancedMoneyAge> getEnhancedMoneyAge();
}

#### 7.7.2 ä¸é›¶åŸºé¢„ç®—ç³»ç»Ÿé›†æˆ

/// é’±é¾„ä¸é›¶åŸºé¢„ç®—çš„é›†æˆ
class MoneyAgeBudgetIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final BudgetService _budgetService;

  /// æ ¹æ®é’±é¾„è°ƒæ•´é¢„ç®—å»ºè®®
  Future<BudgetAdjustment> suggestBudgetAdjustment() async {
    final moneyAge = await _moneyAgeCalc.getCurrentMoneyAge();

    if (moneyAge.level == MoneyAgeLevel.danger) {
      // é’±é¾„å±é™©ï¼šå»ºè®®å¢åŠ å‚¨è“„é¢„ç®—
      return BudgetAdjustment(
        type: AdjustmentType.increaseSavings,
        suggestedAmount: await _calculateSavingsGap(),
        reason: 'å½“å‰é’±é¾„${moneyAge.days}å¤©ï¼Œå»ºè®®å¢åŠ å‚¨è“„ä»¥æé«˜è´¢åŠ¡å®‰å…¨æ€§',
      );
    }

    return BudgetAdjustment.noChange();
  }

  /// é¢„ç®—æ‰§è¡Œå¯¹é’±é¾„çš„å½±å“é¢„æµ‹
  Future<MoneyAgeImpact> predictMoneyAgeImpact(Budget budget) async {
    // æ¨¡æ‹Ÿé¢„ç®—æ‰§è¡Œåçš„é’±é¾„å˜åŒ–
    final currentAge = await _moneyAgeCalc.getCurrentMoneyAge();
    final projectedAge = _simulateMoneyAge(budget);

    return MoneyAgeImpact(
      currentDays: currentAge.days,
      projectedDays: projectedAge.days,
      change: projectedAge.days - currentAge.days,
    );
  }
}

#### 7.7.3 ä¸å°é‡‘åº“ç³»ç»Ÿé›†æˆ

/// é’±é¾„ä¸å°é‡‘åº“çš„é›†æˆ
class MoneyAgeVaultIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final VaultService _vaultService;

  /// æ ¹æ®é’±é¾„æ¨èå‚¨è“„é‡‘é¢
  Future<SavingsRecommendation> recommendSavings() async {
    final moneyAge = await _moneyAgeCalc.getCurrentMoneyAge();
    final targetDays = 30; // ç›®æ ‡é’±é¾„30å¤©

    if (moneyAge.days < targetDays) {
      final gap = targetDays - moneyAge.days;
      final dailySpending = await _calculateAverageDailySpending();
      final recommendedSavings = gap * dailySpending;

      return SavingsRecommendation(
        amount: recommendedSavings,
        reason: 'ä¸ºè¾¾åˆ°${targetDays}å¤©å¥åº·é’±é¾„ï¼Œå»ºè®®å‚¨è“„Â¥${recommendedSavings.toStringAsFixed(0)}',
        suggestedVault: await _findBestVault(recommendedSavings),
      );
    }

    return SavingsRecommendation.sufficient();
  }

  /// å°é‡‘åº“åˆ†é…å¯¹é’±é¾„çš„å½±å“
  Future<VaultAllocationImpact> analyzeVaultAllocationImpact(
    double amount,
    BudgetVault vault,
  ) async {
    final currentAge = await _moneyAgeCalc.getCurrentMoneyAge();
    // å°é‡‘åº“åˆ†é…ä¼šå‡å°‘å¯ç”¨èµ„é‡‘ï¼Œä½†æé«˜äº†è´¢åŠ¡å®‰å…¨æ€§
    final impactDays = (amount / await _calculateAverageDailySpending()).round();

    return VaultAllocationImpact(
      shortTermImpact: -impactDays, // çŸ­æœŸé’±é¾„ä¸‹é™
      longTermBenefit: impactDays * 2, // é•¿æœŸæ”¶ç›Šï¼ˆå‚¨è“„å¢åŠ ï¼‰
      recommendation: impactDays < 3
          ? 'æ­¤åˆ†é…å¯¹é’±é¾„å½±å“è¾ƒå°ï¼Œå»ºè®®æ‰§è¡Œ'
          : 'æ­¤åˆ†é…ä¼šæš‚æ—¶é™ä½é’±é¾„${impactDays}å¤©ï¼Œè¯·ç¡®è®¤',
    );
  }
}

#### 7.7.4 ä¸ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ

/// é’±é¾„ä¸ä¹ æƒ¯åŸ¹å…»çš„é›†æˆ
class MoneyAgeHabitIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final HabitService _habitService;

  /// ç”Ÿæˆé’±é¾„ç›¸å…³ä»»åŠ¡
  Future<List<HabitTask>> generateMoneyAgeTasks() async {
    final stats = await _moneyAgeCalc.getStatistics();
    final tasks = <HabitTask>[];

    // æ ¹æ®é’±é¾„çŠ¶æ€ç”Ÿæˆä»»åŠ¡
    if (stats.healthLevel == MoneyAgeLevel.danger) {
      tasks.add(HabitTask(
        id: 'improve_money_age',
        title: 'æé«˜é’±é¾„æŒ‘æˆ˜',
        description: 'æœ¬å‘¨å‡å°‘éå¿…è¦æ”¯å‡ºï¼Œç›®æ ‡ï¼šé’±é¾„æå‡5å¤©',
        reward: 50,
        duration: Duration(days: 7),
      ));
    }

    // é’±é¾„ç¨³å®šåçš„ç»´æŒä»»åŠ¡
    if (stats.healthLevel.index >= MoneyAgeLevel.good.index) {
      tasks.add(HabitTask(
        id: 'maintain_money_age',
        title: 'ä¿æŒå¥åº·é’±é¾„',
        description: 'ç»§ç»­ä¿æŒè‰¯å¥½çš„æ¶ˆè´¹ä¹ æƒ¯',
        reward: 30,
        duration: Duration(days: 30),
      ));
    }

    return tasks;
  }

  /// è®¡ç®—é’±é¾„æ”¹å–„å¯¹æˆå°±çš„è´¡çŒ®
  Future<AchievementProgress> calculateAchievementProgress() async {
    final stats = await _moneyAgeCalc.getStatistics();

    return AchievementProgress(
      achievementId: 'money_age_master',
      currentValue: stats.averageAge,
      targetValue: 60, // ç›®æ ‡60å¤©
      percentage: (stats.averageAge / 60).clamp(0.0, 1.0),
    );
  }
}
```

---


---

## 8. é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ

é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿæ˜¯2.0ç‰ˆæœ¬çš„**æ ¸å¿ƒè´¢åŠ¡ç®¡ç†æ¨¡å—**ï¼Œå®ç°"è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”"çš„ç†è´¢ç†å¿µã€‚

### 8.0 è®¾è®¡åŸåˆ™å›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é›¶åŸºé¢„ç®—ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å•ä¸€èŒè´£åŸåˆ™   â”‚     â”‚   æ•°æ®ä¸€è‡´æ€§    â”‚     â”‚   æç®€è®¾è®¡åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ å°é‡‘åº“ç‹¬ç«‹ç®¡ç†   â”‚     â”‚ åˆ†é…é‡‘é¢å®æ—¶    â”‚     â”‚ ä¸€é”®æ™ºèƒ½åˆ†é…    â”‚      â”‚
â”‚   â”‚ æ¯ä¸ªé‡‘åº“å•ç‹¬é¢„ç®— â”‚     â”‚ ä¸äº¤æ˜“åŒæ­¥æ›´æ–°  â”‚     â”‚ è‡ªåŠ¨åˆ†ç±»å…³è”    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚    é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“ç³»ç»Ÿ        â”‚                       â”‚
â”‚                    â”‚   ZeroBudgetVaultSystem       â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–²                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å¯æ‰©å±•æ€§åŸåˆ™   â”‚     â”‚   æ€§èƒ½ä¸æˆæœ¬    â”‚     â”‚   å¯è§‚æµ‹æ€§åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ è‡ªå®šä¹‰å°é‡‘åº“ç±»å‹ â”‚     â”‚ æœ¬åœ°ä¼˜å…ˆè®¡ç®—    â”‚     â”‚ é¢„ç®—æ‰§è¡Œå¯è§†åŒ–  â”‚      â”‚
â”‚   â”‚ çµæ´»åˆ†é…ç­–ç•¥     â”‚     â”‚ å¢é‡åŒæ­¥æ›´æ–°    â”‚     â”‚ è¶…æ”¯å®æ—¶é¢„è­¦    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š

| åŸåˆ™ | åœ¨é¢„ç®—ç³»ç»Ÿä¸­çš„ä½“ç° |
|------|-------------------|
| **å•ä¸€èŒè´£** | æ¯ä¸ªå°é‡‘åº“ç‹¬ç«‹ç®¡ç†ï¼ŒèŒè´£æ¸…æ™°ï¼ˆå›ºå®šæ”¯å‡ºã€å¼¹æ€§æ”¯å‡ºã€å‚¨è“„ç›®æ ‡ã€å€ºåŠ¡è¿˜æ¬¾ï¼‰ |
| **æ•°æ®ä¸€è‡´æ€§** | äº¤æ˜“è‡ªåŠ¨å…³è”å°é‡‘åº“ï¼Œåˆ†é…é‡‘é¢ä¸æ¶ˆè´¹é‡‘é¢å®æ—¶åŒæ­¥ |
| **æç®€è®¾è®¡** | ä¸€é”®æ™ºèƒ½åˆ†é…ã€è‡ªåŠ¨åˆ†ç±»å…³è”ã€æ— éœ€æ‰‹åŠ¨è®°è´¦åå†åˆ†é… |
| **å¯æ‰©å±•æ€§** | æ”¯æŒè‡ªå®šä¹‰å°é‡‘åº“ç±»å‹ã€å¤šç§åˆ†é…ç­–ç•¥ï¼ˆå›ºå®šã€ç™¾åˆ†æ¯”ã€è¡¥é½ã€å‰©ä½™ï¼‰ |
| **æ€§èƒ½ä¼˜åŒ–** | æœ¬åœ°SQLiteå­˜å‚¨ï¼Œå¢é‡è®¡ç®—é¢„ç®—çŠ¶æ€ |
| **å¯è§‚æµ‹æ€§** | é¢„ç®—ä»ªè¡¨ç›˜ã€è¶…æ”¯é¢„è­¦ã€æ¶ˆè´¹è¶‹åŠ¿åˆ†æ |

**ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¢„ç®—ç³»ç»Ÿä¸2.0æ ¸å¿ƒæ¨¡å—ååŒå›¾                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  é’±é¾„åˆ†æç³»ç»Ÿ â”‚â—„â”€â”€â”€â”€â”€â”€â”€ é¢„ç®—æ‰§è¡Œå½±å“ â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ  â”‚            â”‚
â”‚   â”‚  (ç¬¬7ç« )     â”‚         é’±é¾„/é¢„ç®—è”åŠ¨         â”‚  (æœ¬ç« )      â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â–¼                                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ æ¶ˆè´¹å®¡è§†      â”‚â—„â”€â”€â”€â”€â”€â”€â”€ é¢„ç®—ä½œä¸ºå®¡è§† â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ è´¢åŠ¡ç¼“å†²      â”‚            â”‚
â”‚   â”‚  (ç¬¬9ç« 6.2èŠ‚) â”‚         å‚è€ƒåŸºå‡†              â”‚  (ç¬¬9ç« 6.4èŠ‚) â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â–¼                                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤  â”‚â—„â”€â”€â”€â”€â”€â”€â”€ é¢„ç®—ä½™é¢è§¦å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ ä¹ æƒ¯å…»æˆæ¿€åŠ±  â”‚            â”‚
â”‚   â”‚  (ç¬¬9ç« 6.3èŠ‚) â”‚          æ¶ˆè´¹æé†’             â”‚  (ç¬¬9ç« 6.6èŠ‚) â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                            æ–°å¢2.0æ¨¡å—ååŒ                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  å®¶åº­è´¦æœ¬     â”‚â—„â”€â”€â”€â”€â”€â”€â”€ å®¶åº­å…±äº«é¢„ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ è¯­éŸ³äº¤äº’      â”‚            â”‚
â”‚   â”‚  (ç¬¬13ç« )    â”‚         æˆå‘˜é…é¢åˆ†é…           â”‚  (ç¬¬18ç« )    â”‚            â”‚
â”‚   â”‚             â”‚                               â”‚             â”‚            â”‚
â”‚   â”‚ å®¶åº­å°é‡‘åº“â†’  â”‚                               â”‚ "è¿˜å‰©å¤šå°‘"â†’  â”‚            â”‚
â”‚   â”‚ å…±äº«/ç‹¬ç«‹    â”‚                               â”‚ é¢„ç®—æ’­æŠ¥    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â–¼                                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  ä½ç½®æ™ºèƒ½åŒ–   â”‚â—„â”€â”€â”€â”€â”€â”€â”€ åœºæ™¯åŒ–é¢„ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ    â”‚            â”‚
â”‚   â”‚  (ç¬¬14ç« )    â”‚         åœ°ç†å›´æ æé†’           â”‚  (ç¬¬17ç« )    â”‚            â”‚
â”‚   â”‚             â”‚                               â”‚             â”‚            â”‚
â”‚   â”‚ é«˜æ¶ˆè´¹åŒºåŸŸâ†’  â”‚                               â”‚ å†å²å­¦ä¹ â†’   â”‚            â”‚
â”‚   â”‚ é¢„ç®—é¢„è­¦    â”‚                               â”‚ é¢„ç®—å»ºè®®    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’¡ é¢„ç®—ç³»ç»Ÿæ˜¯"é‡‘èä¹ æƒ¯åŸ¹å…»"çš„åŸºç¡€è®¾æ–½ï¼Œä¸ºå…¶ä»–ç³»ç»Ÿæä¾›æ¶ˆè´¹çº¦æŸå’Œç›®æ ‡          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.1 é¢„ç®—æœåŠ¡æ¶æ„

ä¸ºé¿å…é¢„ç®—ç›¸å…³æœåŠ¡ç±»èŒè´£æ··æ·†ï¼Œæœ¬èŠ‚è¯´æ˜é¢„ç®—æœåŠ¡çš„å±‚æ¬¡ç»“æ„å’Œå„è‡ªèŒè´£ã€‚

#### 8.1.1 é¢„ç®—æœåŠ¡å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é¢„ç®—æœåŠ¡å±‚æ¬¡ç»“æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬1å±‚ï¼šé¢„ç®—åŸºç¡€æœåŠ¡ï¼ˆCRUDæ“ä½œï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  BudgetRepository          â† é¢„ç®—æ•°æ®å­˜å‚¨ï¼ˆå·²æœ‰ï¼‰             â”‚ â”‚
â”‚  â”‚  BudgetVaultRepository     â† å°é‡‘åº“æ•°æ®å­˜å‚¨ï¼ˆå·²æœ‰ï¼‰           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬2å±‚ï¼šé¢„ç®—åˆ†é…æœåŠ¡ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰                            â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  BudgetAllocationService   â† æ”¶å…¥åˆ†é…åˆ°å°é‡‘åº“ï¼ˆæœ¬ç« 8.3èŠ‚ï¼‰    â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šæ‰§è¡Œæ”¶å…¥â†’å°é‡‘åº“çš„åˆ†é…ï¼Œå¤„ç†åˆ†é…å¼‚å¸¸                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬3å±‚ï¼šé¢„ç®—å»ºè®®æœåŠ¡ï¼ˆæ™ºèƒ½æ¨èï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  SmartBudgetService                                          â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºå†å²æ¶ˆè´¹ç»Ÿè®¡çš„é¢„ç®—å»ºè®®ï¼ˆç¬¬10ç« AIè¯†åˆ«ï¼‰         â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼š3ä¸ªæœˆå†å²æ¶ˆè´¹                                      â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šç±»ç›®+é‡‘é¢å»ºè®®                                      â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  LocalizedBudgetCategoryService                              â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºåŸå¸‚çº§åˆ«çš„ç±»ç›®æ¨èï¼ˆç¬¬14ç« ä½ç½®æ™ºèƒ½åŒ–ï¼‰         â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç”¨æˆ·æ‰€åœ¨åŸå¸‚                                       â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šé€‚åˆè¯¥åŸå¸‚çš„é¢„ç®—ç±»ç›®åˆ—è¡¨                           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  LocalizedBudgetAmountService                                â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºåŸå¸‚æ¶ˆè´¹æ°´å¹³çš„é‡‘é¢å»ºè®®ï¼ˆç¬¬14ç« ä½ç½®æ™ºèƒ½åŒ–ï¼‰     â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç±»ç›®+åŸå¸‚+æ”¶å…¥                                     â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šå»ºè®®é‡‘é¢åŠèŒƒå›´                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬4å±‚ï¼šä½ç½®å¢å¼ºé¢„ç®—æœåŠ¡ï¼ˆç²¾ç¡®ä½ç½®ç‰¹æœ‰ï¼‰                        â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationAwareZeroBudgetService                              â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåŸºäºGPSä½ç½®æ¨¡å¼çš„é¢„ç®—åˆ†é…å»ºè®®ï¼ˆç¬¬14ç« ï¼‰            â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šå†å²æ¶ˆè´¹+ä½ç½®ä¿¡æ¯                                  â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šåŸºäºä½ç½®åœºæ™¯çš„åˆ†é…å»ºè®®                             â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  GeofenceBudgetAlertService                                  â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šåœ°ç†å›´æ é¢„ç®—æé†’ï¼ˆç¬¬14ç« ï¼‰                         â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šç”¨æˆ·å®æ—¶ä½ç½®                                       â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šè¿›å…¥é«˜æ¶ˆè´¹åŒºåŸŸæ—¶çš„é¢„ç®—æé†’                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬5å±‚ï¼šåä½œæ‰©å±•æœåŠ¡ï¼ˆ2.0æ–°å¢ï¼‰                                 â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  FamilyBudgetService                                         â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šå®¶åº­å…±äº«é¢„ç®—ç®¡ç†ï¼ˆç¬¬13ç« å®¶åº­è´¦æœ¬ï¼‰                 â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šå®¶åº­æˆå‘˜ã€å…±äº«å°é‡‘åº“é…ç½®                           â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šæˆå‘˜é…é¢åˆ†é…ã€å…±äº«é¢„ç®—çŠ¶æ€                         â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  VoiceBudgetQueryService                                     â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šè¯­éŸ³æŸ¥è¯¢é¢„ç®—ä½™é¢ï¼ˆç¬¬18ç« è¯­éŸ³äº¤äº’ï¼‰                 â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šè¯­éŸ³æ„å›¾ï¼ˆæŸ¥è¯¢é¢„ç®—ï¼‰                               â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šé¢„ç®—æ’­æŠ¥æ–‡æ¡ˆ                                       â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  SelfLearningBudgetService                                   â”‚ â”‚
â”‚  â”‚      èŒè´£ï¼šè‡ªå­¦ä¹ é¢„ç®—å»ºè®®ä¼˜åŒ–ï¼ˆç¬¬17ç« è‡ªå­¦ä¹ ç³»ç»Ÿï¼‰             â”‚ â”‚
â”‚  â”‚      è¾“å…¥ï¼šå†å²é¢„ç®—æ‰§è¡Œæƒ…å†µã€ç”¨æˆ·åé¦ˆ                         â”‚ â”‚
â”‚  â”‚      è¾“å‡ºï¼šä¸ªæ€§åŒ–é¢„ç®—è°ƒæ•´å»ºè®®                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.1.2 æœåŠ¡ä½¿ç”¨åœºæ™¯

| æœåŠ¡åç§° | è§¦å‘æ—¶æœº | ç”¨æˆ·åœºæ™¯ |
|---------|----------|----------|
| **BudgetAllocationService** | æ”¶å…¥å…¥è´¦æ—¶ | è‡ªåŠ¨/æ‰‹åŠ¨å°†å·¥èµ„åˆ†é…åˆ°å„å°é‡‘åº“ |
| **SmartBudgetService** | é¦–æ¬¡è®¾ç½®é¢„ç®— / æœˆåˆè°ƒæ•´ | ç³»ç»ŸåŸºäºæ¶ˆè´¹ä¹ æƒ¯æ¨èé¢„ç®—æ–¹æ¡ˆ |
| **LocalizedBudgetCategoryService** | æ–°ç”¨æˆ·å¼•å¯¼ / æ›´æ¢åŸå¸‚ | æ¨èé€‚åˆå½“åœ°çš„é¢„ç®—ç±»ç›® |
| **LocalizedBudgetAmountService** | è®¾ç½®ç±»ç›®é¢„ç®—æ—¶ | å»ºè®®åˆç†çš„é¢„ç®—é‡‘é¢ |
| **LocationAwareZeroBudgetService** | æœˆåˆé¢„ç®—è§„åˆ’ | ç»“åˆä½ç½®ä¹ æƒ¯ä¼˜åŒ–åˆ†é… |
| **GeofenceBudgetAlertService** | è¿›å…¥å•†åœˆ/é«˜æ¶ˆè´¹åŒºåŸŸ | å®æ—¶æé†’é¢„ç®—å‰©ä½™ |

#### 8.1.3 æœåŠ¡è°ƒç”¨ç¤ºä¾‹

```dart
/// é¢„ç®—è§„åˆ’åè°ƒå™¨ - æ•´åˆå„å±‚é¢„ç®—æœåŠ¡
class BudgetPlanningCoordinator {
  final SmartBudgetService _smartBudget;
  final LocalizedBudgetCategoryService _localizedCategory;
  final LocalizedBudgetAmountService _localizedAmount;
  final LocationAwareZeroBudgetService? _locationAwareBudget;
  final BudgetAllocationService _allocationService;

  /// ç”Ÿæˆå®Œæ•´çš„é¢„ç®—è§„åˆ’å»ºè®®
  Future<CompleteBudgetPlan> generateBudgetPlan({
    required double monthlyIncome,
    required CityLocation? userCity,
    required List<Transaction> historicalTransactions,
    bool useLocationInsights = false,
  }) async {
    // 1. è·å–æœ¬åœ°åŒ–ç±»ç›®æ¨è
    List<RecommendedCategory> categories = [];
    if (userCity != null) {
      categories = _localizedCategory.getRecommendedCategories(userCity);
    }

    // 2. è·å–æ™ºèƒ½é¢„ç®—å»ºè®®ï¼ˆåŸºäºå†å²æ¶ˆè´¹ï¼‰
    final smartSuggestions = await _smartBudget.generateBudgetSuggestions();

    // 3. ä¸ºæ¯ä¸ªç±»ç›®è®¡ç®—æœ¬åœ°åŒ–é‡‘é¢å»ºè®®
    final categoryAmounts = <String, BudgetAmountSuggestion>{};
    for (final category in categories) {
      if (userCity != null) {
        categoryAmounts[category.name] = _localizedAmount.getSuggestedAmount(
          category: category.name,
          location: userCity,
          monthlyIncome: monthlyIncome,
        );
      }
    }

    // 4. å¯é€‰ï¼šç»“åˆä½ç½®æ´å¯Ÿä¼˜åŒ–
    LocationBasedBudgetSuggestion? locationInsights;
    if (useLocationInsights && _locationAwareBudget != null) {
      locationInsights = await _locationAwareBudget!.suggestBudgetAllocation(
        monthlyIncome: monthlyIncome,
        historicalTransactions: historicalTransactions,
      );
    }

    // 5. ç»¼åˆç”Ÿæˆæœ€ç»ˆå»ºè®®
    return CompleteBudgetPlan(
      categories: categories,
      smartSuggestions: smartSuggestions,
      categoryAmounts: categoryAmounts,
      locationInsights: locationInsights,
      totalIncome: monthlyIncome,
    );
  }
}

/// å®Œæ•´çš„é¢„ç®—è§„åˆ’ç»“æœ
class CompleteBudgetPlan {
  final List<RecommendedCategory> categories;
  final List<BudgetSuggestion> smartSuggestions;
  final Map<String, BudgetAmountSuggestion> categoryAmounts;
  final LocationBasedBudgetSuggestion? locationInsights;
  final double totalIncome;

  const CompleteBudgetPlan({
    required this.categories,
    required this.smartSuggestions,
    required this.categoryAmounts,
    this.locationInsights,
    required this.totalIncome,
  });

  /// è·å–æŸç±»ç›®çš„æœ€ç»ˆå»ºè®®é‡‘é¢
  /// ç»¼åˆè€ƒè™‘ï¼šæ™ºèƒ½å»ºè®® > æœ¬åœ°åŒ–é‡‘é¢ > ç±»ç›®é»˜è®¤å æ¯”
  double getSuggestedAmountForCategory(String categoryName) {
    // ä¼˜å…ˆä½¿ç”¨æ™ºèƒ½å»ºè®®ï¼ˆåŸºäºç”¨æˆ·å®é™…æ¶ˆè´¹ï¼‰
    final smart = smartSuggestions.firstWhere(
      (s) => s.categoryId == categoryName,
      orElse: () => BudgetSuggestion.empty(),
    );
    if (smart.amount > 0) return smart.amount;

    // å…¶æ¬¡ä½¿ç”¨æœ¬åœ°åŒ–é‡‘é¢å»ºè®®
    final localized = categoryAmounts[categoryName];
    if (localized != null) return localized.suggestedAmount;

    // æœ€åä½¿ç”¨ç±»ç›®é»˜è®¤å æ¯”
    final category = categories.firstWhere(
      (c) => c.name == categoryName,
      orElse: () => RecommendedCategory.empty(),
    );
    return totalIncome * category.suggestedPercentage;
  }
}
```

### 8.2 é›¶åŸºé¢„ç®—ç†å¿µ

**é›¶åŸºé¢„ç®—ï¼ˆZero-Based Budgetingï¼‰** çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼šè®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®çš„ç”¨é€”ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       é›¶åŸºé¢„ç®—å·¥ä½œæµç¨‹ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   Step 1: æ”¶å…¥è¿›è´¦                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  æœ¬æœˆå·¥èµ„       â”‚     â”‚ ğŸ¤ è¯­éŸ³æ’­æŠ¥ï¼ˆç¬¬18ç« ï¼‰                        â”‚   â”‚
â”‚   â”‚  Â¥15,000       â”‚â”€â”€â”€â”€â–ºâ”‚ "å·¥èµ„åˆ°è´¦15000å…ƒï¼Œå¼€å§‹åˆ†é…å—ï¼Ÿ"              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   Step 2: æ™ºèƒ½åˆ†é…å»ºè®®                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ğŸ§  è‡ªå­¦ä¹ ç³»ç»Ÿï¼ˆç¬¬17ç« ï¼‰åˆ†æå†å²æ•°æ®ï¼Œç”Ÿæˆä¸ªæ€§åŒ–åˆ†é…å»ºè®®              â”‚  â”‚
â”‚   â”‚ ğŸ“ ä½ç½®æ™ºèƒ½åŒ–ï¼ˆç¬¬14ç« ï¼‰ç»“åˆæ¶ˆè´¹åœ°ç‚¹æ¨¡å¼ä¼˜åŒ–åˆ†é…                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   Step 3: åˆ†é…åˆ°å°é‡‘åº“                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚æˆ¿ç§Ÿ    â”‚ â”‚é¤é¥®    â”‚ â”‚äº¤é€š    â”‚ â”‚å¨±ä¹    â”‚ â”‚å‚¨è“„    â”‚ â”‚å®¶åº­å…±äº«â”‚      â”‚
â”‚   â”‚Â¥4,000  â”‚ â”‚Â¥2,000  â”‚ â”‚Â¥800    â”‚ â”‚Â¥1,000  â”‚ â”‚Â¥5,000  â”‚ â”‚Â¥1,000  â”‚      â”‚
â”‚   â”‚[å›ºå®š]  â”‚ â”‚[å¼¹æ€§]  â”‚ â”‚[å¼¹æ€§]  â”‚ â”‚[å¼¹æ€§]  â”‚ â”‚[ç›®æ ‡]  â”‚ â”‚[å…±äº«]  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â†‘          â†‘          â†‘          â†‘          â†‘          â†‘            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                    â”‚                       â”‚
â”‚                         å¾…åˆ†é…: Â¥1,200             â”‚                       â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                          â”‚ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­è´¦æœ¬ï¼ˆç¬¬13ç« ï¼‰â”‚              â”‚
â”‚                                          â”‚ å®¶åº­æˆå‘˜å…±äº«å¯è§  â”‚              â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                             â”‚
â”‚   Step 4: æ¶ˆè´¹æ—¶ä»å¯¹åº”å°é‡‘åº“æ‰£å‡                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ æ”¯å‡º: åˆé¤ Â¥35                                                       â”‚  â”‚
â”‚   â”‚ ä»"é¤é¥®"å°é‡‘åº“æ‰£å‡ â†’ é¤é¥®å‰©ä½™ Â¥1,965                                â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚ ğŸ’° é’±é¾„è”åŠ¨ï¼ˆç¬¬7ç« ï¼‰ï¼šæ¶ˆè´¹FIFOèµ„æºæ± ï¼Œè®¡ç®—å•ç¬”é’±é¾„                   â”‚  â”‚
â”‚   â”‚ âš ï¸ å†²åŠ¨é˜²æŠ¤ï¼ˆç¬¬9ç« ï¼‰ï¼šä½™é¢<20%æ—¶è§¦å‘æ¶ˆè´¹æé†’                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   Step 5: å‘¨æœŸå¤ç›˜                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ğŸ“Š æ¶ˆè´¹å®¡è§†ï¼ˆç¬¬9ç« ï¼‰ï¼šç”Ÿæˆé¢„ç®—æ‰§è¡ŒæŠ¥å‘Š                               â”‚  â”‚
â”‚   â”‚ ğŸ¯ ä¹ æƒ¯åŸ¹å…»ï¼ˆç¬¬9ç« ï¼‰ï¼šé¢„ç®—è¾¾æˆ â†’ æˆå°±å¥–åŠ±                            â”‚  â”‚
â”‚   â”‚ ğŸ“ˆ ç”¨æˆ·å¢é•¿ï¼ˆç¬¬28-29ç« ï¼‰ï¼šè¾¾æˆé‡Œç¨‹ç¢‘ â†’ åˆ†äº«å¼•å¯¼                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 å°é‡‘åº“ç³»ç»Ÿè®¾è®¡

#### 8.3.1 å°é‡‘åº“æ•°æ®æ¨¡å‹

```dart
/// å°é‡‘åº“ç±»å‹
enum VaultType {
  /// å›ºå®šæ”¯å‡º - æ¯æœˆå¿…é¡»æ”¯ä»˜ï¼ˆæˆ¿ç§Ÿã€æ°´ç”µï¼‰
  fixed,

  /// å¼¹æ€§æ”¯å‡º - å¯è°ƒæ•´ï¼ˆé¤é¥®ã€å¨±ä¹ï¼‰
  flexible,

  /// å‚¨è“„ç›®æ ‡ - é•¿æœŸç§¯ç´¯ï¼ˆæ—…è¡ŒåŸºé‡‘ã€åº”æ€¥é‡‘ï¼‰
  savings,

  /// å€ºåŠ¡è¿˜æ¬¾ - ä¿¡ç”¨å¡ã€è´·æ¬¾
  debt,
}

/// åˆ†é…ç±»å‹æšä¸¾
enum AllocationType {
  /// å›ºå®šé‡‘é¢åˆ†é…
  fixed,
  /// æŒ‰ç™¾åˆ†æ¯”åˆ†é…
  percentage,
  /// åˆ†é…å‰©ä½™é‡‘é¢
  remainder,
  /// è¡¥é½åˆ°ç›®æ ‡é‡‘é¢
  topUp,
}

/// å°é‡‘åº“æ¨¡å‹
class BudgetVault {
  final String id;
  final String name;
  final String? icon;
  final Color color;
  final VaultType type;
  final double targetAmount;      // ç›®æ ‡é‡‘é¢
  double allocatedAmount;         // å·²åˆ†é…é‡‘é¢
  double spentAmount;             // å·²èŠ±è´¹é‡‘é¢
  final DateTime? dueDate;        // åˆ°æœŸæ—¥ï¼ˆç”¨äºè´¦å•ç±»ï¼‰
  final bool isRecurring;         // æ˜¯å¦å‘¨æœŸæ€§
  final RecurrenceRule? recurrence; // å‘¨æœŸè§„åˆ™

  // === æ–°å¢ï¼šåˆ†é…ç­–ç•¥ç›¸å…³å±æ€§ ===
  final AllocationType allocationType;  // åˆ†é…ç±»å‹
  final double? targetAllocation;       // å›ºå®šåˆ†é…é‡‘é¢ï¼ˆç”¨äºfixedç±»å‹ï¼‰
  final double? targetPercentage;       // åˆ†é…ç™¾åˆ†æ¯”ï¼ˆç”¨äºpercentageç±»å‹ï¼Œ0-1ï¼‰

  /// å½“å‰é‡‘é¢ï¼ˆallocatedAmount - spentAmount çš„åˆ«åï¼Œç”¨äºtopUpè®¡ç®—ï¼‰
  double get currentAmount => allocatedAmount - spentAmount;

  /// å‰©ä½™å¯ç”¨
  double get available => allocatedAmount - spentAmount;

  /// å®Œæˆåº¦
  double get progress => targetAmount > 0 ? allocatedAmount / targetAmount : 0;

  /// ä½¿ç”¨ç‡
  double get usageRate => allocatedAmount > 0 ? spentAmount / allocatedAmount : 0;

  /// çŠ¶æ€
  VaultStatus get status {
    if (available < 0) return VaultStatus.overSpent;
    if (usageRate > 0.9) return VaultStatus.almostEmpty;
    if (progress < 1.0) return VaultStatus.underfunded;
    return VaultStatus.healthy;
  }

  /// æ„é€ å‡½æ•°
  BudgetVault({
    required this.id,
    required this.name,
    this.icon,
    required this.color,
    required this.type,
    required this.targetAmount,
    this.allocatedAmount = 0,
    this.spentAmount = 0,
    this.dueDate,
    this.isRecurring = false,
    this.recurrence,
    this.allocationType = AllocationType.fixed,
    this.targetAllocation,
    this.targetPercentage,
  });
}

/// å°é‡‘åº“çŠ¶æ€
enum VaultStatus {
  healthy,      // å¥åº·
  underfunded,  // èµ„é‡‘ä¸è¶³
  almostEmpty,  // å³å°†ç”¨å®Œ
  overSpent,    // è¶…æ”¯
}
```

#### 8.3.2 èµ„é‡‘åˆ†é…æœåŠ¡

```dart
/// èµ„é‡‘åˆ†é…æœåŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
///
/// æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„åˆ†é…æœåŠ¡ï¼Œä»…ç”¨äºæ¦‚å¿µæ¼”ç¤ºã€‚
/// ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ BudgetAllocationServiceï¼ˆè¯¦è§19.3.2èŠ‚ï¼‰ï¼Œ
/// å®ƒæ”¯æŒå®Œæ•´çš„åˆ†é…ç­–ç•¥ï¼ˆå›ºå®šé‡‘é¢ã€ç™¾åˆ†æ¯”ã€å‰©ä½™ã€è¡¥è¶³ï¼‰å’Œå¼‚å¸¸å¤„ç†ã€‚
class AllocationService {
  final VaultRepository vaultRepository;
  final TransactionRepository transactionRepository;

  /// å¾…åˆ†é…é‡‘é¢
  Future<double> getUnallocatedAmount() async {
    final totalIncome = await transactionRepository.getTotalIncome();
    final totalAllocated = await vaultRepository.getTotalAllocated();
    return totalIncome - totalAllocated;
  }

  /// åˆ†é…èµ„é‡‘åˆ°å°é‡‘åº“
  Future<void> allocateToVault(String vaultId, double amount) async {
    final unallocated = await getUnallocatedAmount();
    if (amount > unallocated) {
      throw InsufficientFundsException('å¾…åˆ†é…é‡‘é¢ä¸è¶³');
    }

    final vault = await vaultRepository.getById(vaultId);
    vault.allocatedAmount += amount;
    await vaultRepository.update(vault);

    // è®°å½•åˆ†é…å†å²
    await _recordAllocationHistory(vaultId, amount);
  }

  /// æ™ºèƒ½åˆ†é…å»ºè®®
  Future<List<AllocationSuggestion>> getSuggestions() async {
    final unallocated = await getUnallocatedAmount();
    final vaults = await vaultRepository.getAll();
    final suggestions = <AllocationSuggestion>[];

    // 1. ä¼˜å…ˆæ»¡è¶³å›ºå®šæ”¯å‡º
    for (final vault in vaults.where((v) => v.type == VaultType.fixed)) {
      if (vault.allocatedAmount < vault.targetAmount) {
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: vault.targetAmount - vault.allocatedAmount,
          reason: 'å›ºå®šæ”¯å‡ºéœ€è¦ä¼˜å…ˆä¿éšœ',
          priority: 1,
        ));
      }
    }

    // 2. å€ºåŠ¡è¿˜æ¬¾
    for (final vault in vaults.where((v) => v.type == VaultType.debt)) {
      if (vault.allocatedAmount < vault.targetAmount) {
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: vault.targetAmount - vault.allocatedAmount,
          reason: 'æŒ‰æ—¶è¿˜æ¬¾é¿å…åˆ©æ¯å’Œä¿¡ç”¨å½±å“',
          priority: 2,
        ));
      }
    }

    // 3. å‚¨è“„ç›®æ ‡
    // 4. å¼¹æ€§æ”¯å‡º
    // ...

    return suggestions..sort((a, b) => a.priority.compareTo(b.priority));
  }

  /// ä¸€é”®æ™ºèƒ½åˆ†é…
  Future<AllocationResult> autoAllocate() async {
    final suggestions = await getSuggestions();
    var remaining = await getUnallocatedAmount();
    final allocated = <String, double>{};

    for (final suggestion in suggestions) {
      if (remaining <= 0) break;
      final amount = min(suggestion.suggestedAmount, remaining);
      await allocateToVault(suggestion.vaultId, amount);
      allocated[suggestion.vaultId] = amount;
      remaining -= amount;
    }

    return AllocationResult(
      allocations: allocated,
      remaining: remaining,
    );
  }
}
```

### 8.4 å°é‡‘åº“å¯è§†åŒ–

#### 8.4.1 å°é‡‘åº“æ¦‚è§ˆå¡ç‰‡

```dart
/// å°é‡‘åº“æ¦‚è§ˆé¡µé¢
class VaultOverviewPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final vaults = ref.watch(vaultsProvider);
    final unallocated = ref.watch(unallocatedAmountProvider);

    return Scaffold(
      appBar: AppBar(title: Text('æˆ‘çš„å°é‡‘åº“')),
      body: Column(
        children: [
          // å¾…åˆ†é…æç¤ºå¡
          if (unallocated > 0)
            _UnallocatedBanner(amount: unallocated),

          // å°é‡‘åº“åˆ—è¡¨
          Expanded(
            child: ListView.builder(
              itemCount: vaults.length,
              itemBuilder: (context, index) => VaultCard(
                vault: vaults[index],
                onTap: () => _navigateToVaultDetail(context, vaults[index]),
              ),
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => _showCreateVaultSheet(context),
        icon: Icon(Icons.add),
        label: Text('æ–°å»ºå°é‡‘åº“'),
      ),
    );
  }
}

/// å•ä¸ªå°é‡‘åº“å¡ç‰‡
class VaultCard extends StatelessWidget {
  final BudgetVault vault;
  final VoidCallback? onTap;

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // æ ‡é¢˜è¡Œ
              Row(
                children: [
                  _VaultIcon(icon: vault.icon, color: vault.color),
                  SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(vault.name, style: TextStyle(fontWeight: FontWeight.bold)),
                        Text(vault.type.displayName, style: TextStyle(color: Colors.grey)),
                      ],
                    ),
                  ),
                  _StatusBadge(status: vault.status),
                ],
              ),

              SizedBox(height: 16),

              // è¿›åº¦æ¡
              _VaultProgressBar(
                allocated: vault.allocatedAmount,
                spent: vault.spentAmount,
                target: vault.targetAmount,
                color: vault.color,
              ),

              SizedBox(height: 12),

              // é‡‘é¢ä¿¡æ¯
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  _AmountLabel(label: 'å¯ç”¨', amount: vault.available),
                  _AmountLabel(label: 'å·²èŠ±', amount: vault.spentAmount),
                  _AmountLabel(label: 'ç›®æ ‡', amount: vault.targetAmount),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 8.4.2 èµ„é‡‘åˆ†é…ç•Œé¢

```dart
/// èµ„é‡‘åˆ†é…ç•Œé¢
class AllocationPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final unallocated = ref.watch(unallocatedAmountProvider);
    final suggestions = ref.watch(allocationSuggestionsProvider);

    return Scaffold(
      appBar: AppBar(title: Text('åˆ†é…èµ„é‡‘')),
      body: Column(
        children: [
          // å¾…åˆ†é…é‡‘é¢å¡ç‰‡
          _UnallocatedAmountCard(amount: unallocated),

          // åˆ†é…å»ºè®®åˆ—è¡¨
          Expanded(
            child: ListView.builder(
              itemCount: suggestions.length,
              itemBuilder: (context, index) => _SuggestionTile(
                suggestion: suggestions[index],
                onAllocate: (amount) => ref.read(
                  allocationServiceProvider
                ).allocateToVault(suggestions[index].vaultId, amount),
              ),
            ),
          ),

          // åº•éƒ¨æ“ä½œæ 
          _AllocationActionBar(
            onAutoAllocate: () => _showAutoAllocateConfirm(context, ref),
            onSkip: () => Navigator.pop(context),
          ),
        ],
      ),
    );
  }
}
```

### 8.5 å°é‡‘åº“ä¸äº¤æ˜“è”åŠ¨

```dart
/// äº¤æ˜“è®°å½•æ—¶è‡ªåŠ¨å…³è”å°é‡‘åº“
class TransactionVaultLinker {
  final VaultRepository vaultRepository;
  final CategoryVaultMappingRepository mappingRepository;

  /// æ ¹æ®åˆ†ç±»è‡ªåŠ¨æ¨èå°é‡‘åº“
  Future<BudgetVault?> suggestVaultForTransaction(Transaction tx) async {
    // 1. æŸ¥æ‰¾åˆ†ç±»-å°é‡‘åº“æ˜ å°„
    final mapping = await mappingRepository.findByCategory(tx.categoryId);
    if (mapping != null) {
      return vaultRepository.getById(mapping.vaultId);
    }

    // 2. åŸºäºå†å²è®°å½•æ™ºèƒ½æ¨è
    final history = await _findSimilarTransactions(tx);
    if (history.isNotEmpty) {
      final vaultCounts = <String, int>{};
      for (final h in history) {
        if (h.vaultId != null) {
          vaultCounts[h.vaultId!] = (vaultCounts[h.vaultId!] ?? 0) + 1;
        }
      }
      if (vaultCounts.isNotEmpty) {
        final mostUsedVaultId = vaultCounts.entries
            .reduce((a, b) => a.value > b.value ? a : b).key;
        return vaultRepository.getById(mostUsedVaultId);
      }
    }

    return null;
  }

  /// äº¤æ˜“ä¿å­˜æ—¶æ›´æ–°å°é‡‘åº“
  Future<void> onTransactionSaved(Transaction tx) async {
    if (tx.vaultId == null || tx.type != TransactionType.expense) return;

    final vault = await vaultRepository.getById(tx.vaultId!);
    vault.spentAmount += tx.amount;
    await vaultRepository.update(vault);

    // æ£€æŸ¥æ˜¯å¦è¶…æ”¯å¹¶å‘é€é€šçŸ¥
    if (vault.available < 0) {
      await _sendOverspentNotification(vault);
    } else if (vault.usageRate > 0.8) {
      await _sendLowBalanceNotification(vault);
    }
  }
}
```

### 8.6 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

é¢„ç®—ç³»ç»Ÿä½œä¸º2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè´¢åŠ¡ç®¡ç†æ¨¡å—ï¼Œéœ€è¦ä¸å¤šä¸ªç³»ç»Ÿæ·±åº¦é›†æˆã€‚

#### 8.6.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¢„ç®—ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾ï¼ˆ2.0ç‰ˆæœ¬ï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                         â”‚   é›¶åŸºé¢„ç®—ä¸å°é‡‘åº“     â”‚                           â”‚
â”‚                         â”‚   ZeroBudgetSystem    â”‚                           â”‚
â”‚                         â”‚   (æœ¬ç« Â·æ ¸å¿ƒç®¡ç†)     â”‚                           â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                     â”‚                                       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚                             â”‚                             â”‚         â”‚
â”‚       â–¼                             â–¼                             â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é’±é¾„åˆ†æç³»ç»Ÿ â”‚            â”‚ äº¤æ˜“è®°è´¦ç³»ç»Ÿ â”‚            â”‚ é‡‘èä¹ æƒ¯åŸ¹å…» â”‚      â”‚
â”‚  â”‚  (ç¬¬7ç« )    â”‚            â”‚  (ç¬¬6ç« )    â”‚            â”‚  (ç¬¬9ç« )    â”‚      â”‚
â”‚  â”‚             â”‚            â”‚             â”‚            â”‚             â”‚      â”‚
â”‚  â”‚ é¢„ç®—æ‰§è¡Œâ†’   â”‚            â”‚ äº¤æ˜“è‡ªåŠ¨    â”‚            â”‚ é¢„ç®—ç›®æ ‡â†’   â”‚      â”‚
â”‚  â”‚ é’±é¾„å˜åŒ–    â”‚            â”‚ å…³è”å°é‡‘åº“  â”‚            â”‚ ä¹ æƒ¯ä»»åŠ¡    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              æ ¸å¿ƒé›†æˆå±‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ¶ˆè´¹å®¡è§†     â”‚  â”‚ å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤ â”‚  â”‚ è´¢åŠ¡ç¼“å†²     â”‚  â”‚ ä¹ æƒ¯å…»æˆæ¿€åŠ± â”‚        â”‚
â”‚  â”‚  (ç¬¬9ç« 6.2èŠ‚)â”‚  â”‚  (ç¬¬9ç« 6.3èŠ‚)â”‚  â”‚  (ç¬¬9ç« 6.4èŠ‚)â”‚  â”‚  (ç¬¬9ç« 6.6èŠ‚)â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ é¢„ç®—ä½™é¢â†’   â”‚  â”‚ ä½ä½™é¢â†’    â”‚  â”‚ å‚¨è“„å°é‡‘åº“â†’ â”‚  â”‚ é¢„ç®—å®Œæˆâ†’   â”‚        â”‚
â”‚  â”‚ å®¡è§†å‚è€ƒ    â”‚  â”‚ æ¶ˆè´¹æ‹¦æˆª    â”‚  â”‚ ç¼“å†²ç›®æ ‡    â”‚  â”‚ æˆå°±å¥–åŠ±    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              æ‰©å±•é›†æˆå±‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ä½ç½®æ™ºèƒ½åŒ–  â”‚  â”‚  æ•°æ®è”åŠ¨    â”‚  â”‚  ä¼™ä¼´åŒ–è®¾è®¡  â”‚  â”‚  å›½é™…åŒ–     â”‚        â”‚
â”‚  â”‚  (ç¬¬14ç« )   â”‚  â”‚  (ç¬¬12ç« )   â”‚  â”‚  (ç¬¬4ç« )    â”‚  â”‚  (ç¬¬21ç« )   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ åœ°ç†å›´æ â†’   â”‚  â”‚ æœåŠ¡ç«¯åŒæ­¥   â”‚  â”‚ é¢„ç®—æ’­æŠ¥â†’   â”‚  â”‚ å¤šå¸ç§é¢„ç®—  â”‚        â”‚
â”‚  â”‚ é¢„ç®—æé†’    â”‚  â”‚ é¢„ç®—æ•°æ®    â”‚  â”‚ æƒ…æ„Ÿåé¦ˆ    â”‚  â”‚ æœ¬åœ°åŒ–å±•ç¤º  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              åä½œæ‰©å±•å±‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å®¶åº­è´¦æœ¬   â”‚  â”‚  è¯­éŸ³äº¤äº’    â”‚  â”‚  è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚  ç”¨æˆ·å¢é•¿   â”‚        â”‚
â”‚  â”‚  (ç¬¬13ç« )   â”‚  â”‚  (ç¬¬18ç« )   â”‚  â”‚  (ç¬¬17ç« )   â”‚  â”‚  (ç¬¬28-29ç« )â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ å®¶åº­å…±äº«â†’   â”‚  â”‚ è¯­éŸ³æŸ¥è¯¢â†’   â”‚  â”‚ å†å²åˆ†æâ†’   â”‚  â”‚ é¢„ç®—è¾¾æˆâ†’   â”‚        â”‚
â”‚  â”‚ é¢„ç®—åˆ†é…    â”‚  â”‚ é¢„ç®—æ’­æŠ¥    â”‚  â”‚ æ™ºèƒ½å»ºè®®    â”‚  â”‚ åˆ†äº«å¼•å¯¼    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é›†æˆè§¦å‘ç‚¹**ï¼š

| è§¦å‘äº‹ä»¶ | é›†æˆåŠ¨ä½œ | æ¶‰åŠç³»ç»Ÿ |
|----------|----------|----------|
| æ”¶å…¥å…¥è´¦ | è§¦å‘åˆ†é…æµç¨‹ï¼Œè‡ªåŠ¨/æ‰‹åŠ¨åˆ†é…åˆ°å°é‡‘åº“ | åˆ†é…æœåŠ¡ã€é’±é¾„ç³»ç»Ÿ(7ç« ) |
| æ”¯å‡ºè®°å½• | è‡ªåŠ¨å…³è”å°é‡‘åº“ï¼Œæ‰£å‡å¯ç”¨ä½™é¢ | äº¤æ˜“ç³»ç»Ÿ(6ç« )ã€å°é‡‘åº“ |
| å°é‡‘åº“ä½™é¢å˜åŒ– | è§¦å‘é¢„è­¦/åº†ç¥ï¼Œæ›´æ–°é¢„ç®—ä»ªè¡¨ç›˜ | å†²åŠ¨é˜²æŠ¤(9ç« )ã€å¯è§‚æµ‹æ€§(25ç« ) |
| æœˆåº¦ç»“ç®— | ç”Ÿæˆé¢„ç®—æŠ¥å‘Šï¼Œç»“è½¬/æ¸…é›¶å¤„ç† | æ¶ˆè´¹å®¡è§†(9ç« )ã€ä¹ æƒ¯åŸ¹å…»(9ç« ) |
| è¿›å…¥é«˜æ¶ˆè´¹åŒºåŸŸ | è§¦å‘åœ°ç†å›´æ é¢„ç®—æé†’ | ä½ç½®æ™ºèƒ½åŒ–(14ç« ) |
| å®¶åº­æˆå‘˜æ”¶å…¥ | è§¦å‘å®¶åº­å…±äº«é¢„ç®—åˆ†é… | å®¶åº­è´¦æœ¬(13ç« ) |
| è¯­éŸ³æŸ¥è¯¢é¢„ç®— | è¿”å›é¢„ç®—ä½™é¢æ’­æŠ¥ | è¯­éŸ³äº¤äº’(18ç« ) |
| é¢„ç®—ç›®æ ‡è¾¾æˆ | è§¦å‘æˆå°±åˆ†äº«å¼•å¯¼ | ç”¨æˆ·å¢é•¿(28-29ç« ) |
| è¿ç»­è¶…æ”¯ | è‡ªå­¦ä¹ è°ƒæ•´å»ºè®® | è‡ªå­¦ä¹ ç³»ç»Ÿ(17ç« ) |

#### 8.6.1 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// é¢„ç®—æ‰§è¡Œå¯¹é’±é¾„çš„å½±å“åˆ†æ
class BudgetMoneyAgeIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final VaultRepository _vaultRepo;

  /// åˆ†æé¢„ç®—åˆ†é…å¯¹é’±é¾„çš„é¢„æœŸå½±å“
  Future<MoneyAgeImpactPrediction> predictAllocationImpact(
    List<AllocationSuggestion> allocations,
  ) async {
    final currentAge = await _moneyAgeCalc.getCurrentMoneyAge();

    // å‚¨è“„ç±»å°é‡‘åº“åˆ†é…ä¼šæé«˜é’±é¾„
    double savingsImpact = 0;
    for (final alloc in allocations) {
      final vault = await _vaultRepo.getById(alloc.vaultId);
      if (vault.type == VaultType.savings) {
        // å‚¨è“„ç›¸å½“äºå»¶è¿Ÿæ¶ˆè´¹ï¼Œä¼šæé«˜é’±é¾„
        savingsImpact += alloc.suggestedAmount /
            await _calculateDailySpending();
      }
    }

    return MoneyAgeImpactPrediction(
      currentAge: currentAge.days,
      projectedAge: currentAge.days + savingsImpact.round(),
      recommendation: savingsImpact > 0
          ? 'æœ¬æ¬¡åˆ†é…å°†æå‡é’±é¾„çº¦${savingsImpact.round()}å¤©'
          : 'æœ¬æ¬¡åˆ†é…å¯¹é’±é¾„æ— æ˜¾è‘—å½±å“',
    );
  }

  /// æ ¹æ®é’±é¾„çŠ¶æ€è°ƒæ•´é¢„ç®—å»ºè®®
  Future<BudgetAdjustmentSuggestion> suggestBudgetAdjustment() async {
    final moneyAge = await _moneyAgeCalc.getCurrentMoneyAge();

    if (moneyAge.level == MoneyAgeLevel.danger) {
      // é’±é¾„å±é™©ï¼šå»ºè®®å¢åŠ å‚¨è“„é¢„ç®—æ¯”ä¾‹
      return BudgetAdjustmentSuggestion(
        adjustmentType: AdjustmentType.increaseSavings,
        targetPercentage: 0.20, // å»ºè®®å‚¨è“„20%
        reason: 'å½“å‰é’±é¾„${moneyAge.days}å¤©ï¼Œå»ºè®®æé«˜å‚¨è“„æ¯”ä¾‹ä»¥å»ºç«‹è´¢åŠ¡ç¼“å†²',
      );
    }

    return BudgetAdjustmentSuggestion.noChange();
  }
}
```

#### 8.6.2 ä¸ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ

```dart
/// é¢„ç®—ç³»ç»Ÿä¸ä¹ æƒ¯åŸ¹å…»çš„é›†æˆ
class BudgetHabitIntegration {
  final VaultRepository _vaultRepo;
  final HabitTaskService _habitService;

  /// ç”Ÿæˆé¢„ç®—ç›¸å…³çš„ä¹ æƒ¯ä»»åŠ¡
  Future<List<HabitTask>> generateBudgetTasks() async {
    final vaults = await _vaultRepo.getAll();
    final tasks = <HabitTask>[];

    for (final vault in vaults) {
      // å‚¨è“„ç›®æ ‡ç±»å°é‡‘åº“ â†’ å‚¨è“„ä»»åŠ¡
      if (vault.type == VaultType.savings && vault.progress < 1.0) {
        tasks.add(HabitTask(
          id: 'savings_${vault.id}',
          title: '${vault.name}å‚¨è“„æŒ‘æˆ˜',
          description: 'è·ç¦»ç›®æ ‡è¿˜å·®Â¥${(vault.targetAmount - vault.allocatedAmount).toStringAsFixed(0)}',
          reward: 30,
          category: HabitCategory.savings,
        ));
      }

      // å¼¹æ€§æ”¯å‡ºç±»å°é‡‘åº“è¶…æ”¯ â†’ èŠ‚çº¦ä»»åŠ¡
      if (vault.type == VaultType.flexible && vault.status == VaultStatus.overSpent) {
        tasks.add(HabitTask(
          id: 'reduce_${vault.id}',
          title: '${vault.name}èŠ‚çº¦æŒ‘æˆ˜',
          description: 'æœ¬æœˆ${vault.name}è¶…æ”¯Â¥${(-vault.available).toStringAsFixed(0)}',
          reward: 20,
          category: HabitCategory.spending,
        ));
      }
    }

    return tasks;
  }

  /// é¢„ç®—å®Œæˆæ—¶å‘æ”¾å¥–åŠ±
  Future<void> onBudgetAchieved(BudgetVault vault) async {
    if (vault.type == VaultType.savings && vault.progress >= 1.0) {
      await _habitService.completeTask('savings_${vault.id}');
      await _habitService.awardPoints(50); // é¢å¤–å¥–åŠ±
    }
  }
}
```

#### 8.6.3 ä¸å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤é›†æˆ

```dart
/// é¢„ç®—ä½™é¢è§¦å‘çš„æ¶ˆè´¹æ‹¦æˆª
class BudgetImpulseProtection {
  final VaultRepository _vaultRepo;
  final ImpulseProtectionService _impulseService;

  /// æ¶ˆè´¹å‰æ£€æŸ¥é¢„ç®—çŠ¶æ€
  Future<SpendingCheckResult> checkBeforeSpending({
    required double amount,
    required String categoryId,
    required String? vaultId,
  }) async {
    if (vaultId == null) {
      return SpendingCheckResult.allowed();
    }

    final vault = await _vaultRepo.getById(vaultId);

    // ä½™é¢ä¸è¶³æ—¶è§¦å‘æ‹¦æˆª
    if (amount > vault.available) {
      return SpendingCheckResult.blocked(
        reason: '${vault.name}ä½™é¢ä¸è¶³',
        suggestion: 'å½“å‰å¯ç”¨Â¥${vault.available.toStringAsFixed(0)}ï¼Œ'
            'æœ¬æ¬¡æ¶ˆè´¹Â¥${amount.toStringAsFixed(0)}',
        alternatives: [
          'ä»å…¶ä»–å°é‡‘åº“è°ƒæ‹¨',
          'å‡å°‘æ¶ˆè´¹é‡‘é¢',
          'æ ‡è®°ä¸ºè®¡åˆ’å¤–æ”¯å‡º',
        ],
      );
    }

    // æ¶ˆè´¹åä½™é¢è¿‡ä½æ—¶å‘å‡ºè­¦å‘Š
    final remainingAfter = vault.available - amount;
    if (remainingAfter < vault.targetAmount * 0.1) {
      return SpendingCheckResult.warning(
        message: 'æ¶ˆè´¹å${vault.name}ä»…å‰©Â¥${remainingAfter.toStringAsFixed(0)}',
        suggestion: 'æœ¬æœˆè¿˜æœ‰${_getRemainingDays()}å¤©ï¼Œå»ºè®®è°¨æ…æ¶ˆè´¹',
      );
    }

    return SpendingCheckResult.allowed();
  }

  int _getRemainingDays() {
    final now = DateTime.now();
    final endOfMonth = DateTime(now.year, now.month + 1, 0);
    return endOfMonth.day - now.day;
  }
}
```

#### 8.6.4 ä¸ä½ç½®æ™ºèƒ½åŒ–é›†æˆ

```dart
/// åœ°ç†å›´æ è§¦å‘çš„é¢„ç®—æé†’
class LocationBudgetReminder {
  final VaultRepository _vaultRepo;
  final GeofenceService _geofenceService;
  final NotificationService _notificationService;

  /// è¿›å…¥å•†åœˆæ—¶æ¨é€é¢„ç®—çŠ¶æ€
  Future<void> onEnterShoppingArea(GeofenceEvent event) async {
    // è·å–ä¸è¯¥åŒºåŸŸç›¸å…³çš„å°é‡‘åº“ï¼ˆå¦‚ï¼šè´­ç‰©ã€é¤é¥®ï¼‰
    final relevantVaults = await _getVaultsForLocation(event.location);

    if (relevantVaults.isEmpty) return;

    final messages = <String>[];
    for (final vault in relevantVaults) {
      final status = _getVaultStatusMessage(vault);
      if (status != null) {
        messages.add(status);
      }
    }

    if (messages.isNotEmpty) {
      await _notificationService.show(
        title: 'é¢„ç®—æé†’',
        body: messages.join('\n'),
        category: NotificationCategory.budgetReminder,
      );
    }
  }

  String? _getVaultStatusMessage(BudgetVault vault) {
    if (vault.available <= 0) {
      return 'âš ï¸ ${vault.name}å·²è¶…æ”¯';
    } else if (vault.usageRate > 0.8) {
      return 'ğŸ’¡ ${vault.name}å‰©ä½™Â¥${vault.available.toStringAsFixed(0)}';
    }
    return null;
  }

  Future<List<BudgetVault>> _getVaultsForLocation(Location location) async {
    // æ ¹æ®ä½ç½®ç±»å‹åŒ¹é…ç›¸å…³å°é‡‘åº“
    final locationType = await _geofenceService.getLocationType(location);
    final allVaults = await _vaultRepo.getAll();

    return allVaults.where((v) {
      switch (locationType) {
        case LocationType.shopping:
          return v.name.contains('è´­ç‰©') || v.name.contains('å¨±ä¹');
        case LocationType.restaurant:
          return v.name.contains('é¤é¥®') || v.name.contains('ç¾é£Ÿ');
        case LocationType.supermarket:
          return v.name.contains('æ—¥ç”¨') || v.name.contains('ç”Ÿæ´»');
        default:
          return false;
      }
    }).toList();
  }
}
```

---


---

## 9. é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ

æœ¬ç« èšç„¦äºå¦‚ä½•é€šè¿‡äº§å“è®¾è®¡åŸ¹å…»ç”¨æˆ·è‰¯å¥½çš„é‡‘èä¹ æƒ¯ï¼Œå¸®åŠ©ç”¨æˆ·ä»"èŠ±ä¸‹æœˆçš„é’±"é€æ­¥è¿‡æ¸¡åˆ°"èŠ±ä¸Šæœˆçš„é’±"ï¼Œå»ºç«‹è´¢åŠ¡å®‰å…¨æ„Ÿã€‚

### 9.0 è®¾è®¡åŸåˆ™å›é¡¾ä¸æ¨¡å—å…³ç³»

é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿæ˜¯2.0ç‰ˆæœ¬çš„**æ ¸å¿ƒç”¨æˆ·ä»·å€¼æ¨¡å—**ï¼Œå°†ç¬¬7ç« é’±é¾„åˆ†æå’Œç¬¬8ç« é¢„ç®—ç®¡ç†çš„èƒ½åŠ›è½¬åŒ–ä¸ºå¯è½åœ°çš„è¡Œä¸ºå¼•å¯¼ã€‚

#### 9.0.1 è®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å•ä¸€èŒè´£åŸåˆ™   â”‚     â”‚   æ•°æ®ä¸€è‡´æ€§    â”‚     â”‚   æç®€è®¾è®¡åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ æ¯ä¸ªå­ç³»ç»Ÿç‹¬ç«‹   â”‚     â”‚ ç»Ÿä¸€å¼•ç”¨é’±é¾„å’Œ  â”‚     â”‚ æ— éœ€å¤æ‚é…ç½®    â”‚      â”‚
â”‚   â”‚ æ¶ˆè´¹å®¡è§†/é˜²æŠ¤/  â”‚     â”‚ é¢„ç®—ç³»ç»Ÿçš„æ•°æ®  â”‚     â”‚ é»˜è®¤å¼€å¯æ ¸å¿ƒåŠŸèƒ½â”‚      â”‚
â”‚   â”‚ ç¼“å†²/æ¿€åŠ±åˆ†ç¦»   â”‚     â”‚ é¿å…é‡å¤è®¡ç®—    â”‚     â”‚ æ¸è¿›å¼å¼•å¯¼     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚     é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ           â”‚                       â”‚
â”‚                    â”‚   FinancialHabitSystem        â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–²                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å¯æ‰©å±•æ€§åŸåˆ™   â”‚     â”‚   æ€§èƒ½ä¸æˆæœ¬    â”‚     â”‚   å¯è§‚æµ‹æ€§åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ æ”¯æŒè‡ªå®šä¹‰è§„åˆ™   â”‚     â”‚ æœ¬åœ°ä¼˜å…ˆè®¡ç®—    â”‚     â”‚ å®æ—¶åé¦ˆå’Œå¯è§†åŒ–â”‚      â”‚
â”‚   â”‚ çµæ´»çš„æ¿€åŠ±æœºåˆ¶   â”‚     â”‚ å¢é‡æ›´æ–°çŠ¶æ€    â”‚     â”‚ è¿›åº¦è¿½è¸ªä»ªè¡¨ç›˜  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.0.2 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿä¸2.0æ ¸å¿ƒæ¨¡å—ååŒå›¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                         â”‚   é‡‘èä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ     â”‚                           â”‚
â”‚                         â”‚   (æœ¬ç« Â·æ ¸å¿ƒä»·å€¼)     â”‚                           â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                     â”‚                                       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚                             â”‚                             â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 9.2 æ¶ˆè´¹å®¡è§†  â”‚            â”‚ 9.3 å†²åŠ¨é˜²æŠ¤ â”‚            â”‚ 9.4 è´¢åŠ¡ç¼“å†² â”‚   â”‚
â”‚  â”‚              â”‚            â”‚              â”‚            â”‚              â”‚   â”‚
â”‚  â”‚ è®¢é˜…æµªè´¹è¯†åˆ«  â”‚            â”‚ é¢„ç®—ä½™é¢é¢„è­¦  â”‚            â”‚ åº”æ€¥é‡‘ç›®æ ‡   â”‚   â”‚
â”‚  â”‚ æ‹¿é“å› å­åˆ†æ  â”‚            â”‚ æ¶ˆè´¹å‰ç¡®è®¤    â”‚            â”‚ é’±é¾„è¿›é˜¶    â”‚   â”‚
â”‚  â”‚ æƒ³è¦vséœ€è¦   â”‚            â”‚ å…ˆè§„åˆ’å†æ¶ˆè´¹  â”‚            â”‚ å€ºåŠ¡å¥åº·    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                           â”‚                           â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚    9.5 å¼¹æ€§é¢„ç®— + 9.6 æ¿€åŠ±     â”‚                       â”‚
â”‚                    â”‚    çªå‘æ”¯å‡º / æ”¶å…¥ä¸ç¨³å®šé€‚é…   â”‚                       â”‚
â”‚                    â”‚    è¿ç»­è®°è´¦ / è´¢åŠ¡å¥åº·åˆ† / æ‰¿è¯º â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                            ä¸Šæ¸¸ä¾èµ–æ¨¡å—                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  é’±é¾„åˆ†æç³»ç»Ÿ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€  æ ¸å¿ƒæŒ‡æ ‡  â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ  â”‚            â”‚
â”‚   â”‚   (ç¬¬7ç« )    â”‚          é’±é¾„/é¢„ç®—           â”‚   (ç¬¬8ç« )    â”‚            â”‚
â”‚   â”‚              â”‚          æ•°æ®æä¾›            â”‚              â”‚            â”‚
â”‚   â”‚ æä¾›ï¼š       â”‚                              â”‚ æä¾›ï¼š       â”‚            â”‚
â”‚   â”‚ â€¢ MoneyAge   â”‚                              â”‚ â€¢ BudgetVaultâ”‚            â”‚
â”‚   â”‚ â€¢ å¥åº·ç­‰çº§   â”‚                              â”‚ â€¢ åˆ†é…æœåŠ¡   â”‚            â”‚
â”‚   â”‚ â€¢ è¶‹åŠ¿åˆ†æ   â”‚                              â”‚ â€¢ ä½™é¢çŠ¶æ€   â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                            ä¸‹æ¸¸æ¶ˆè´¹æ¨¡å—                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ AIæ™ºèƒ½è¯†åˆ«   â”‚  â”‚ æ•°æ®è”åŠ¨     â”‚  â”‚ ä¼™ä¼´åŒ–è®¾è®¡   â”‚  â”‚ åœ°ç†ä½ç½®æ™ºèƒ½ â”‚   â”‚
â”‚   â”‚  (ç¬¬10ç« )    â”‚  â”‚  (ç¬¬12ç« )    â”‚  â”‚  (ç¬¬4ç« )     â”‚  â”‚  (ç¬¬14ç« )    â”‚   â”‚
â”‚   â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚
â”‚   â”‚ æ¶ˆè´¹æ´å¯Ÿâ†’    â”‚  â”‚ ä¹ æƒ¯æ•°æ®â†’    â”‚  â”‚ æ¿€åŠ±åé¦ˆâ†’    â”‚  â”‚ ä½ç½®åœºæ™¯â†’    â”‚   â”‚
â”‚   â”‚ ä¹ æƒ¯åˆ†æ     â”‚  â”‚ å¯è§†åŒ–å±•ç¤º   â”‚  â”‚ æƒ…æ„ŸåŒ–è¡¨è¾¾   â”‚  â”‚ æ¶ˆè´¹æé†’     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                          2.0æ–°å¢åä½œæ¨¡å—                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å®¶åº­è´¦æœ¬    â”‚  â”‚  è¯­éŸ³äº¤äº’    â”‚  â”‚  è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚  ç”¨æˆ·å¢é•¿    â”‚   â”‚
â”‚   â”‚  (ç¬¬13ç« )    â”‚  â”‚  (ç¬¬18ç« )    â”‚  â”‚  (ç¬¬17ç« )    â”‚  â”‚ (ç¬¬28-29ç« )  â”‚   â”‚
â”‚   â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚
â”‚   â”‚ å®¶åº­ä¹ æƒ¯â†’    â”‚  â”‚ è¯­éŸ³æ‰“å¡â†’    â”‚  â”‚ å†å²å­¦ä¹ â†’    â”‚  â”‚ ä¹ æƒ¯è¾¾æˆâ†’    â”‚   â”‚
â”‚   â”‚ ååŒåŸ¹å…»     â”‚  â”‚ ä¹ æƒ¯æé†’     â”‚  â”‚ ä¸ªæ€§åŒ–å»ºè®®   â”‚  â”‚ åˆ†äº«ä¼ æ’­     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.0.3 å­ç³»ç»ŸèŒè´£è¾¹ç•Œ

| å­ç³»ç»Ÿ | èŒè´£ | æ ¸å¿ƒä¾èµ– | è¾“å‡º |
|--------|------|----------|------|
| **9.2 æ¶ˆè´¹å®¡è§†** | è¯†åˆ«æµªè´¹æ¨¡å¼ï¼Œæä¾›å¯æ“ä½œæ´å¯Ÿ | äº¤æ˜“è®°å½•ã€AIåˆ†æ(ç¬¬10ç« ) | æµªè´¹è¯†åˆ«æŠ¥å‘Šã€ä¼˜åŒ–å»ºè®® |
| **9.3 å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤** | æ¶ˆè´¹å‰é¢„è­¦ï¼Œå»ºç«‹å¿ƒæ™ºæ¨¡å‹ | é¢„ç®—ä½™é¢(ç¬¬8ç« )ã€é’±é¾„(ç¬¬7ç« ) | æ¶ˆè´¹ç¡®è®¤å¼¹çª—ã€é¢„ç®—å¯è§†åŒ– |
| **9.4 è´¢åŠ¡ç¼“å†²å»ºè®¾** | å¼•å¯¼å‚¨è“„ï¼Œå»ºç«‹å®‰å…¨æ„Ÿ | é’±é¾„é˜¶æ®µ(ç¬¬7ç« )ã€å‚¨è“„å°é‡‘åº“(ç¬¬8ç« ) | åº”æ€¥é‡‘è¿›åº¦ã€é’±é¾„è¿›é˜¶ç›®æ ‡ |
| **9.5 å¼¹æ€§é¢„ç®—æœºåˆ¶** | å¤„ç†æ„å¤–ï¼Œé€‚é…ä¸ç¨³å®šæ”¶å…¥ | é¢„ç®—åˆ†é…(ç¬¬8ç« )ã€è‡ªå­¦ä¹ (ç¬¬17ç« ) | çªå‘æ”¯å‡ºå¤„ç†æµç¨‹ |
| **9.6 ä¹ æƒ¯å…»æˆæ¿€åŠ±** | æ­£å‘åé¦ˆï¼ŒæŒç»­æ¿€åŠ± | è®°è´¦æ•°æ®ã€é’±é¾„è¶‹åŠ¿ã€ç”¨æˆ·å¢é•¿(ç¬¬28-29ç« ) | è¿ç»­è®°è´¦å¥–åŠ±ã€è´¢åŠ¡å¥åº·åˆ† |

**2.0æ–°å¢åä½œä¾èµ–**ï¼š

| å­ç³»ç»Ÿ | æ–°å¢ä¾èµ–æ¨¡å— | åä½œå†…å®¹ |
|--------|-------------|---------|
| æ¶ˆè´¹å®¡è§† | è¯­éŸ³äº¤äº’(ç¬¬18ç« ) | è¯­éŸ³æ’­æŠ¥æ¶ˆè´¹æ´å¯Ÿ |
| å†²åŠ¨é˜²æŠ¤ | å®¶åº­è´¦æœ¬(ç¬¬13ç« ) | å®¶åº­æˆå‘˜æ¶ˆè´¹æé†’ |
| è´¢åŠ¡ç¼“å†² | è‡ªå­¦ä¹ ç³»ç»Ÿ(ç¬¬17ç« ) | ä¸ªæ€§åŒ–å‚¨è“„ç›®æ ‡è°ƒæ•´ |
| ä¹ æƒ¯æ¿€åŠ± | ç”¨æˆ·å¢é•¿(ç¬¬28-29ç« ) | æˆå°±åˆ†äº«ä¸é‚€è¯·å¼•å¯¼ |

#### 9.0.4 é’±é¾„ç­‰çº§ä¸é˜¶æ®µçš„ç»Ÿä¸€è¯´æ˜

æœ¬ç« çš„é’±é¾„è¿›é˜¶ç³»ç»Ÿ (6.4.2èŠ‚ MoneyAgeProgressionService) ä¸ç¬¬7ç« çš„é’±é¾„å¥åº·ç­‰çº§ (MoneyAgeLevel) ååŒå·¥ä½œï¼Œä¸¤è€…å…³ç³»å¦‚ä¸‹ï¼š

| å¤©æ•°èŒƒå›´ | MoneyAgeLevel (çŠ¶æ€å±•ç¤º) | MoneyAgeStage (è¿›é˜¶ç›®æ ‡) | ç”¨é€” |
|----------|--------------------------|--------------------------|------|
| 0-7å¤©    | danger (å±é™©)            | Level 1 æœˆå…‰æ—           | éœ€ç´§æ€¥å¹²é¢„ |
| 7-14å¤©   | warning (è­¦å‘Š)           | Level 2 èµ·æ­¥è€…           | åˆæ­¥æ”¹å–„ |
| 14-30å¤©  | normal (ä¸€èˆ¬)            | Level 3 ç¨³å¥è€…           | åŸºç¡€å¥åº· |
| 30-60å¤©  | good (è‰¯å¥½)              | Level 4 ä»å®¹è€…           | è‰¯å¥½çŠ¶æ€ |
| 60-90å¤©  | excellent (ä¼˜ç§€)         | Level 5 è´¢åŠ¡è‡ªç”±         | ä¼˜ç§€çŠ¶æ€ |
| 90å¤©ä»¥ä¸Š | ideal (ç†æƒ³)             | Level 5 è´¢åŠ¡è‡ªç”±(è¿›é˜¶)   | ç†æƒ³çŠ¶æ€ |

**è®¾è®¡è¯´æ˜**ï¼š
- **MoneyAgeLevel** (6çº§)ï¼šç”¨äºå®æ—¶çŠ¶æ€å±•ç¤ºï¼Œé¢œè‰²ç¼–ç ï¼Œç²¾ç»†åŒºåˆ†60å¤©ä»¥ä¸Šçš„ä¸¤ä¸ªç­‰çº§
- **MoneyAgeStage** (5çº§)ï¼šç”¨äºè¿›é˜¶ç›®æ ‡è®¾å®šï¼Œå‡å°‘ç”¨æˆ·è®¤çŸ¥è´Ÿæ‹…ï¼Œ60å¤©ä»¥ä¸Šç»Ÿä¸€ä¸º"è´¢åŠ¡è‡ªç”±"

ä¸¤è€…åœ¨é˜ˆå€¼è¾¹ç•Œä¿æŒä¸€è‡´(7/14/30/60å¤©)ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ã€‚

### 9.1 è®¾è®¡ç†å¿µ

#### 9.1.1 æ ¸å¿ƒç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‘èä¹ æƒ¯åŸ¹å…»å››å¤§ç›®æ ‡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  ç›®æ ‡ä¸€ï¼šå®¡è§†æ¶ˆè´¹ä¹ æƒ¯                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ è¯†åˆ« "æ²¡å¿…è¦çš„å¼€æ”¯"ï¼ˆè®¢é˜…äº†ä¸ç”¨çš„ä¼šå‘˜ã€é¢‘ç¹å¤–å–ï¼‰          â”‚     â”‚
â”‚  â”‚  â€¢ å‘ç°é«˜é¢‘å°é¢æ¶ˆè´¹çš„ç´¯ç§¯æ•ˆåº”                                 â”‚     â”‚
â”‚  â”‚  â€¢ å¯¹æ¯”"æƒ³è¦"vs"éœ€è¦"ï¼ŒæŠŠé’±èŠ±åœ¨çœŸæ­£é‡è¦çš„åœ°æ–¹                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡äºŒï¼šé¿å…å†²åŠ¨æ¶ˆè´¹                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ æ¸…æ™°å±•ç¤º"æ¯ä¸ªç±»ç›®è¿˜å‰©å¤šå°‘é’±å¯ä»¥èŠ±"                        â”‚     â”‚
â”‚  â”‚  â€¢ è¶…æ”¯å‰é¢„è­¦ï¼Œè€Œéè¶…æ”¯åæé†’                                 â”‚     â”‚
â”‚  â”‚  â€¢ å»ºç«‹"å…ˆè§„åˆ’å†æ¶ˆè´¹"çš„å¿ƒæ™ºæ¨¡å‹                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡ä¸‰ï¼šå»ºç«‹è´¢åŠ¡ç¼“å†²                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ ä»"èŠ±ä¸‹æœˆçš„é’±"è¿‡æ¸¡åˆ°"èŠ±ä¸Šæœˆçš„é’±"                          â”‚     â”‚
â”‚  â”‚  â€¢ ç§¯ç´¯åº”æ€¥é‡‘ï¼ˆè¦†ç›–3-6ä¸ªæœˆå¿…è¦æ”¯å‡ºï¼‰                         â”‚     â”‚
â”‚  â”‚  â€¢ å‡å°‘å¯¹ä¿¡ç”¨å¡ã€ç½‘è´·çš„ä¾èµ–                                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â”‚  ç›®æ ‡å››ï¼šå¼¹æ€§åº”å¯¹å˜åŒ–                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  â€¢ é€‚é…å·¥èµ„ä¸ç¨³å®šã€æœ‰å‰¯ä¸šæ”¶å…¥çš„ç”¨æˆ·                           â”‚     â”‚
â”‚  â”‚  â€¢ ä¼˜é›…å¤„ç†çªå‘æ”¯å‡ºï¼Œä¸å› ä¸€æ¬¡è¶…æ”¯æ”¾å¼ƒæ•´ä¸ªè®¡åˆ’                 â”‚     â”‚
â”‚  â”‚  â€¢ é¼“åŠ±æŒç»­è®°å½•ï¼Œè€Œéè¿½æ±‚å®Œç¾                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.1.2 è¡Œä¸ºå¿ƒç†å­¦åŸºç¡€

| åŸç† | åº”ç”¨åœºæ™¯ | äº§å“è®¾è®¡ |
|------|----------|----------|
| **æŸå¤±åŒæ¶** | äººä»¬å¯¹æŸå¤±çš„æ•æ„Ÿåº¦æ˜¯æ”¶ç›Šçš„2å€ | å±•ç¤º"è¶…æ”¯=æŸå¤±"ï¼Œè€Œéä»…å±•ç¤ºæ•°å­— |
| **å³æ—¶åé¦ˆ** | è¡Œä¸ºä¸åé¦ˆé—´éš”è¶ŠçŸ­ï¼Œä¹ æƒ¯è¶Šæ˜“å½¢æˆ | æ¶ˆè´¹åç«‹å³æ˜¾ç¤ºå¯¹é¢„ç®—çš„å½±å“ |
| **æ‰¿è¯ºä¸€è‡´** | äººä»¬å€¾å‘äºä¿æŒä¸æ‰¿è¯ºä¸€è‡´çš„è¡Œä¸º | è®©ç”¨æˆ·ä¸»åŠ¨è®¾å®šç›®æ ‡å¹¶å¯è§†åŒ–è¿›åº¦ |
| **ç¤¾ä¼šè®¤åŒ** | å‚ç…§ä»–äººè¡Œä¸ºåšå†³ç­– | å±•ç¤º"åŒç±»å‹ç”¨æˆ·"çš„æ¶ˆè´¹æ°´å¹³å¯¹æ¯” |
| **è¿›åº¦æ•ˆåº”** | å·²å®Œæˆçš„è¿›åº¦æ¿€åŠ±ç»§ç»­å®Œæˆ | å‚¨è“„ç›®æ ‡è¿›åº¦æ¡ã€è¿ç»­è®°è´¦å¤©æ•° |
| **é»˜è®¤æ•ˆåº”** | äººä»¬å€¾å‘äºæ¥å—é»˜è®¤é€‰é¡¹ | é»˜è®¤å¼€å¯å‚¨è“„æé†’ã€é»˜è®¤åˆ†é…åº”æ€¥é‡‘ |

### 9.2 æ¶ˆè´¹å®¡è§†ç³»ç»Ÿ

#### 9.2.1 è®¢é˜…ç®¡ç†ä¸æµªè´¹è¯†åˆ«

```dart
/// è®¢é˜…è¿½è¸ªæœåŠ¡
class SubscriptionTrackingService {
  /// è‡ªåŠ¨è¯†åˆ«è®¢é˜…ç±»æ¶ˆè´¹
  Future<List<SubscriptionPattern>> detectSubscriptions() async {
    final transactions = await _transactionRepo.getRecent(months: 6);

    // è¯†åˆ«å‘¨æœŸæ€§å›ºå®šé‡‘é¢æ¶ˆè´¹
    final patterns = <SubscriptionPattern>[];

    // æŒ‰å•†å®¶+é‡‘é¢åˆ†ç»„
    final grouped = _groupByMerchantAndAmount(transactions);

    for (final group in grouped.entries) {
      final txList = group.value;
      if (txList.length >= 2) {
        // æ£€æµ‹å‘¨æœŸæ€§
        final interval = _detectInterval(txList);
        if (interval != null) {
          final lastUsage = await _detectLastUsage(group.key.merchant);

          patterns.add(SubscriptionPattern(
            merchantName: group.key.merchant,
            amount: group.key.amount,
            interval: interval,  // monthly, yearly, etc.
            totalSpent: txList.fold(0.0, (sum, tx) => sum + tx.amount),
            lastPaymentDate: txList.last.date,
            lastUsageDate: lastUsage,
            usageStatus: _calculateUsageStatus(lastUsage),
          ));
        }
      }
    }

    return patterns;
  }

  /// è¯†åˆ«å¯èƒ½æµªè´¹çš„è®¢é˜…
  Future<List<WastedSubscription>> findWastedSubscriptions() async {
    final subscriptions = await detectSubscriptions();

    return subscriptions
        .where((s) => s.usageStatus == UsageStatus.unused ||
                      s.usageStatus == UsageStatus.rarelyUsed)
        .map((s) => WastedSubscription(
          subscription: s,
          potentialSavings: _calculateAnnualSavings(s),
          suggestion: _generateCancelSuggestion(s),
        ))
        .toList();
  }
}

/// è®¢é˜…ä½¿ç”¨çŠ¶æ€
enum UsageStatus {
  active,      // ç»å¸¸ä½¿ç”¨
  occasional,  // å¶å°”ä½¿ç”¨
  rarelyUsed,  // å¾ˆå°‘ä½¿ç”¨
  unused,      // å®Œå…¨æœªä½¿ç”¨
}

/// æµªè´¹è®¢é˜…æé†’å¡ç‰‡
class WastedSubscriptionCard extends StatelessWidget {
  final WastedSubscription subscription;

  @override
  Widget build(BuildContext context) {
    return Card(
      color: Colors.orange.shade50,
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.warning_amber, color: Colors.orange),
                SizedBox(width: 8),
                Text('å¯èƒ½ä¸éœ€è¦çš„è®¢é˜…', style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.orange.shade800,
                )),
              ],
            ),
            SizedBox(height: 12),
            Text(subscription.subscription.merchantName,
              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            SizedBox(height: 4),
            Text('æ¯æœˆ Â¥${subscription.subscription.amount.toStringAsFixed(0)}'),
            Text('ä¸Šæ¬¡ä½¿ç”¨: ${_formatLastUsage(subscription.subscription.lastUsageDate)}',
              style: TextStyle(color: Colors.grey)),
            SizedBox(height: 12),
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.green.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(Icons.savings, color: Colors.green),
                  SizedBox(width: 8),
                  Text('å–æ¶ˆåæ¯å¹´å¯èŠ‚çœ Â¥${subscription.potentialSavings.toStringAsFixed(0)}',
                    style: TextStyle(color: Colors.green.shade700, fontWeight: FontWeight.bold)),
                ],
              ),
            ),
            SizedBox(height: 12),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => _markAsNeeded(subscription),
                  child: Text('ç¡®å®éœ€è¦'),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () => _showCancelGuide(subscription),
                  child: Text('æŸ¥çœ‹å–æ¶ˆæ–¹æ³•'),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
```

#### 9.2.2 é«˜é¢‘å°é¢æ¶ˆè´¹åˆ†æ

```dart
/// é«˜é¢‘å°é¢æ¶ˆè´¹åˆ†ææœåŠ¡
class FrequentSmallExpenseAnalyzer {
  /// åˆ†æ"æ‹¿é“å› å­"ï¼ˆé«˜é¢‘å°é¢æ¶ˆè´¹ï¼‰
  Future<LatteFactorReport> analyzeLatteFactors() async {
    final transactions = await _transactionRepo.getRecent(months: 3);

    // ç­›é€‰å°é¢é«˜é¢‘æ¶ˆè´¹ï¼ˆ<50å…ƒï¼Œæ¯å‘¨>2æ¬¡ï¼‰
    final smallExpenses = transactions.where((tx) =>
        tx.type == TransactionType.expense &&
        tx.amount < 50
    ).toList();

    // æŒ‰æè¿°/å•†å®¶èšç±»
    final clusters = _clusterByPattern(smallExpenses);

    final latteFactors = <LatteFactor>[];

    for (final cluster in clusters) {
      final weeklyFrequency = cluster.transactions.length / 12;  // 3ä¸ªæœˆâ‰ˆ12å‘¨
      if (weeklyFrequency >= 2) {
        final monthlyTotal = cluster.totalAmount / 3;
        final yearlyTotal = monthlyTotal * 12;

        latteFactors.add(LatteFactor(
          category: cluster.category,
          description: cluster.commonDescription,
          weeklyFrequency: weeklyFrequency,
          averageAmount: cluster.averageAmount,
          monthlyTotal: monthlyTotal,
          yearlyTotal: yearlyTotal,
          // è®¡ç®—å¦‚æœå‡å°‘ä¸€åŠèƒ½å­˜å¤šå°‘
          potentialSavings: yearlyTotal * 0.5,
          transactions: cluster.transactions,
        ));
      }
    }

    // æŒ‰å¹´åº¦æ€»é¢æ’åº
    latteFactors.sort((a, b) => b.yearlyTotal.compareTo(a.yearlyTotal));

    return LatteFactorReport(
      factors: latteFactors,
      totalMonthlyImpact: latteFactors.fold(0.0, (sum, f) => sum + f.monthlyTotal),
      totalYearlyImpact: latteFactors.fold(0.0, (sum, f) => sum + f.yearlyTotal),
      topSuggestion: _generateTopSuggestion(latteFactors),
    );
  }

  /// ç”Ÿæˆæ´å¯Ÿå»ºè®®
  String _generateTopSuggestion(List<LatteFactor> factors) {
    if (factors.isEmpty) return 'æ‚¨çš„å°é¢æ¶ˆè´¹æ§åˆ¶å¾—å¾ˆå¥½ï¼';

    final top = factors.first;
    final weeklyTimes = top.weeklyFrequency.round();
    final reducedTimes = (weeklyTimes / 2).ceil();

    return 'å¦‚æœå°†${top.description}ä»æ¯å‘¨${weeklyTimes}æ¬¡å‡å°‘åˆ°${reducedTimes}æ¬¡ï¼Œ'
           'æ¯å¹´å¯ä»¥å¤šå­˜ Â¥${(top.potentialSavings).toStringAsFixed(0)}';
  }
}

/// æ‹¿é“å› å­å¯è§†åŒ–å¡ç‰‡
class LatteFactorCard extends StatelessWidget {
  final LatteFactorReport report;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.coffee, color: Colors.brown),
                SizedBox(width: 8),
                Text('å°é¢æ¶ˆè´¹æ´å¯Ÿ', style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
                Spacer(),
                Tooltip(
                  message: '"æ‹¿é“å› å­"æŒ‡é‚£äº›çœ‹ä¼¼å¾®å°ä½†ç´¯ç§¯æƒŠäººçš„æ—¥å¸¸æ¶ˆè´¹',
                  child: Icon(Icons.info_outline, size: 20, color: Colors.grey),
                ),
              ],
            ),
            SizedBox(height: 16),

            // å¹´åº¦å½±å“æ€»è§ˆ
            Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [Colors.orange.shade100, Colors.red.shade100],
                ),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  _buildImpactItem('æ¯æœˆç´¯è®¡', 'Â¥${report.totalMonthlyImpact.toStringAsFixed(0)}'),
                  Container(width: 1, height: 40, color: Colors.grey.shade300),
                  _buildImpactItem('æ¯å¹´ç´¯è®¡', 'Â¥${report.totalYearlyImpact.toStringAsFixed(0)}'),
                ],
              ),
            ),

            SizedBox(height: 16),

            // å‰3é¡¹è¯¦æƒ…
            ...report.factors.take(3).map((factor) => _buildFactorItem(factor)),

            SizedBox(height: 12),

            // å»ºè®®
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(Icons.lightbulb, color: Colors.blue),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(report.topSuggestion,
                      style: TextStyle(color: Colors.blue.shade800)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFactorItem(LatteFactor factor) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(factor.description, style: TextStyle(fontWeight: FontWeight.w500)),
                Text('æ¯å‘¨çº¦${factor.weeklyFrequency.toStringAsFixed(1)}æ¬¡ Â· '
                     'å‡ä»·Â¥${factor.averageAmount.toStringAsFixed(0)}',
                  style: TextStyle(color: Colors.grey, fontSize: 12)),
              ],
            ),
          ),
          Text('Â¥${factor.monthlyTotal.toStringAsFixed(0)}/æœˆ',
            style: TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}
```

#### 9.2.3 "æƒ³è¦" vs "éœ€è¦" åˆ†ç±»

```dart
/// æ¶ˆè´¹å¿…è¦æ€§åˆ†æ
class NecessityAnalyzer {
  /// æ¶ˆè´¹ç±»å‹å®šä¹‰
  static const Map<String, ExpenseNecessity> categoryNecessity = {
    // å¿…éœ€å“
    'æˆ¿ç§Ÿ': ExpenseNecessity.essential,
    'æ°´ç”µç‡ƒæ°”': ExpenseNecessity.essential,
    'æ—¥ç”¨å“': ExpenseNecessity.essential,
    'åŸºç¡€é¤é¥®': ExpenseNecessity.essential,
    'åŒ»ç–—': ExpenseNecessity.essential,
    'é€šå‹¤äº¤é€š': ExpenseNecessity.essential,

    // é‡è¦ä½†éå¿…éœ€
    'ä¿é™©': ExpenseNecessity.important,
    'æ•™è‚²': ExpenseNecessity.important,
    'å¥èº«': ExpenseNecessity.important,

    // å¯é€‰æ¶ˆè´¹
    'å¤–å–': ExpenseNecessity.optional,
    'å¨±ä¹': ExpenseNecessity.optional,
    'è´­ç‰©': ExpenseNecessity.optional,
    'è®¢é˜…æœåŠ¡': ExpenseNecessity.optional,
    'ç¤¾äº¤èšé¤': ExpenseNecessity.optional,
  };

  /// åˆ†ææ¶ˆè´¹ç»“æ„
  Future<NecessityReport> analyzeSpendingStructure() async {
    final transactions = await _transactionRepo.getMonthlyExpenses();

    double essentialTotal = 0;
    double importantTotal = 0;
    double optionalTotal = 0;

    final breakdown = <String, CategoryBreakdown>{};

    for (final tx in transactions) {
      final necessity = _determineNecessity(tx);
      switch (necessity) {
        case ExpenseNecessity.essential:
          essentialTotal += tx.amount;
          break;
        case ExpenseNecessity.important:
          importantTotal += tx.amount;
          break;
        case ExpenseNecessity.optional:
          optionalTotal += tx.amount;
          break;
      }

      // è®°å½•è¯¦ç»†åˆ†ç±»
      breakdown.putIfAbsent(tx.categoryName, () => CategoryBreakdown(
        categoryName: tx.categoryName,
        necessity: necessity,
      )).totalAmount += tx.amount;
    }

    final total = essentialTotal + importantTotal + optionalTotal;

    return NecessityReport(
      essentialAmount: essentialTotal,
      essentialPercentage: essentialTotal / total,
      importantAmount: importantTotal,
      importantPercentage: importantTotal / total,
      optionalAmount: optionalTotal,
      optionalPercentage: optionalTotal / total,
      breakdown: breakdown.values.toList(),
      healthScore: _calculateHealthScore(essentialTotal, importantTotal, optionalTotal),
      suggestions: _generateSuggestions(breakdown),
    );
  }

  /// è®¡ç®—è´¢åŠ¡å¥åº·åˆ†
  int _calculateHealthScore(double essential, double important, double optional) {
    final total = essential + important + optional;
    if (total == 0) return 100;

    final essentialRatio = essential / total;
    final optionalRatio = optional / total;

    // ç†æƒ³çŠ¶æ€ï¼šå¿…éœ€50-60%ï¼Œé‡è¦20-30%ï¼Œå¯é€‰10-20%
    int score = 100;

    // å¯é€‰æ¶ˆè´¹è¶…è¿‡30%æ‰£åˆ†
    if (optionalRatio > 0.3) {
      score -= ((optionalRatio - 0.3) * 100).round();
    }

    // å¿…éœ€æ¶ˆè´¹è¶…è¿‡70%æ‰£åˆ†ï¼ˆå¯èƒ½æ²¡æœ‰è¶³å¤Ÿä½™åŠ›å‚¨è“„ï¼‰
    if (essentialRatio > 0.7) {
      score -= ((essentialRatio - 0.7) * 50).round();
    }

    return score.clamp(0, 100);
  }
}

/// æ¶ˆè´¹å¿…è¦æ€§æšä¸¾
enum ExpenseNecessity {
  essential,  // å¿…éœ€ï¼šæ²¡æœ‰å°±æ´»ä¸ä¸‹å»
  important,  // é‡è¦ï¼šæå‡ç”Ÿæ´»è´¨é‡ä½†å¯æš‚ç¼“
  optional,   // å¯é€‰ï¼šé”¦ä¸Šæ·»èŠ±çš„æ¶ˆè´¹
}
```

#### 9.2.4 å¯æ“ä½œæ´å¯Ÿè¡ŒåŠ¨æŒ‡å—

å½“AIæ´å¯Ÿåˆ°ç”¨æˆ·éœ€è¦åšå‡ºå…·ä½“æ¶ˆè´¹ä¹ æƒ¯æ”¹å˜æ—¶ï¼Œæä¾›**å…·ä½“å¯æ“ä½œçš„å»ºè®®å’ŒæŒ‡å—**ï¼Œè€Œéæ³›æ³›çš„æé†’ã€‚

```dart
/// å¯æ“ä½œæ´å¯ŸæœåŠ¡
class ActionableInsightService {
  final InsightAnalysisService _analysisService;
  final OperationGuideRepository _guideRepository;
  final WebSearchService _webSearch;
  final LLMService _llmService;
  final TransactionRepository _transactionRepository;

  /// ç”Ÿæˆå¯æ“ä½œçš„æ´å¯Ÿå»ºè®®
  Future<ActionableInsight> generateActionableInsight(
    SpendingInsight insight,
  ) async {
    // æ ¹æ®æ´å¯Ÿç±»å‹ç”Ÿæˆå…·ä½“è¡ŒåŠ¨æŒ‡å—
    final guides = await _getOperationGuides(insight);

    return ActionableInsight(
      insight: insight,
      actionGuides: guides,
      estimatedSaving: _calculatePotentialSaving(insight, guides),
      priority: _calculatePriority(insight),
    );
  }

  /// è·å–æ“ä½œæŒ‡å—ï¼ˆå¤šæºè·å–ç­–ç•¥ï¼‰
  Future<List<OperationGuide>> _getOperationGuides(
    SpendingInsight insight,
  ) async {
    switch (insight.type) {
      case InsightType.subscriptionOverload:
        return await _getSubscriptionCancellationGuides(insight);
      case InsightType.recurringExpenseOptimization:
        return await _getRecurringOptimizationGuides(insight);
      case InsightType.unnecessaryFees:
        return await _getFeeAvoidanceGuides(insight);
      case InsightType.betterAlternative:
        return await _getAlternativeGuides(insight);
      default:
        return await _getGenericGuides(insight);
    }
  }

  /// è·å–è®¢é˜…å–æ¶ˆæŒ‡å—
  Future<List<OperationGuide>> _getSubscriptionCancellationGuides(
    SpendingInsight insight,
  ) async {
    final subscriptions = insight.relatedTransactions
        .map((t) => t.merchant)
        .toSet();

    final guides = <OperationGuide>[];

    for (final subscription in subscriptions) {
      // 1. ä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜è·å–
      var guide = await _guideRepository.getCachedGuide(
        type: GuideType.subscriptionCancel,
        target: subscription,
      );

      if (guide == null || guide.isExpired) {
        // 2. ä»ç½‘ä¸Šæœç´¢æœ€æ–°æŒ‡å—
        guide = await _fetchGuideFromWeb(subscription);

        // 3. å¦‚æœç½‘ä¸Šæ²¡æœ‰ï¼Œä½¿ç”¨LLMç”Ÿæˆ
        guide ??= await _generateGuideWithLLM(subscription);

        // ç¼“å­˜æŒ‡å—
        if (guide != null) {
          await _guideRepository.cacheGuide(guide);
        }
      }

      if (guide != null) {
        guides.add(guide);
      }
    }

    return guides;
  }

  /// ä»ç½‘ä¸Šè·å–æ“ä½œæŒ‡å—
  Future<OperationGuide?> _fetchGuideFromWeb(String serviceName) async {
    try {
      // æœç´¢"å¦‚ä½•å–æ¶ˆXXXè®¢é˜…"
      final searchResults = await _webSearch.search(
        query: 'å¦‚ä½•å–æ¶ˆ${serviceName}è®¢é˜… æ­¥éª¤',
        maxResults: 3,
      );

      if (searchResults.isEmpty) return null;

      // æå–å¹¶ç»“æ„åŒ–æ­¥éª¤
      final steps = await _llmService.extractSteps(
        searchResults.map((r) => r.content).join('\n'),
        context: 'å–æ¶ˆ${serviceName}è®¢é˜…',
      );

      return OperationGuide(
        id: Uuid().v4(),
        type: GuideType.subscriptionCancel,
        target: serviceName,
        title: 'å¦‚ä½•å–æ¶ˆ${serviceName}è®¢é˜…',
        steps: steps,
        source: GuideSource.webSearch,
        sourceUrl: searchResults.first.url,
        fetchedAt: DateTime.now(),
        expiresAt: DateTime.now().add(Duration(days: 30)), // 30å¤©è¿‡æœŸ
      );
    } catch (e) {
      return null;
    }
  }

  /// ä½¿ç”¨LLMç”Ÿæˆæ“ä½œæŒ‡å—
  Future<OperationGuide?> _generateGuideWithLLM(String serviceName) async {
    try {
      final response = await _llmService.generate(
        prompt: '''
è¯·æä¾›å–æ¶ˆ"$serviceName"è®¢é˜…æœåŠ¡çš„è¯¦ç»†æ­¥éª¤æŒ‡å—ï¼š
1. åˆ—å‡ºå…·ä½“æ“ä½œæ­¥éª¤ï¼ˆ5-10æ­¥ï¼‰
2. åŒ…å«å¯èƒ½çš„æ³¨æ„äº‹é¡¹
3. è¯´æ˜å–æ¶ˆåçš„å½±å“
4. æä¾›æ›¿ä»£æ–¹æ¡ˆå»ºè®®ï¼ˆå¦‚æœæœ‰ï¼‰

è¯·ä»¥ç»“æ„åŒ–æ ¼å¼è¾“å‡ºã€‚
''',
      );

      final steps = _parseStepsFromLLMResponse(response);

      return OperationGuide(
        id: Uuid().v4(),
        type: GuideType.subscriptionCancel,
        target: serviceName,
        title: 'å¦‚ä½•å–æ¶ˆ${serviceName}è®¢é˜…',
        steps: steps,
        source: GuideSource.llmGenerated,
        fetchedAt: DateTime.now(),
        expiresAt: DateTime.now().add(Duration(days: 14)), // LLMç”Ÿæˆçš„14å¤©è¿‡æœŸ
        disclaimer: 'æ­¤æŒ‡å—ç”±AIç”Ÿæˆï¼Œå»ºè®®å®é™…æ“ä½œå‰ç¡®è®¤æœ€æ–°æµç¨‹',
      );
    } catch (e) {
      return null;
    }
  }
}

/// æ“ä½œæŒ‡å—æ¨¡å‹
class OperationGuide {
  final String id;
  final GuideType type;
  final String target;           // ç›®æ ‡æœåŠ¡/äº§å“åç§°
  final String title;
  final List<GuideStep> steps;   // å…·ä½“æ­¥éª¤
  final GuideSource source;      // æ¥æº
  final String? sourceUrl;       // æ¥æºURL
  final DateTime fetchedAt;      // è·å–æ—¶é—´
  final DateTime expiresAt;      // è¿‡æœŸæ—¶é—´
  final String? disclaimer;      // å…è´£å£°æ˜
  final List<String>? warnings;  // æ³¨æ„äº‹é¡¹
  final List<String>? alternatives; // æ›¿ä»£æ–¹æ¡ˆ

  bool get isExpired => DateTime.now().isAfter(expiresAt);

  /// å‰©ä½™æœ‰æ•ˆå¤©æ•°
  int get remainingDays => expiresAt.difference(DateTime.now()).inDays;
}

/// æŒ‡å—æ­¥éª¤
class GuideStep {
  final int order;
  final String instruction;      // æ“ä½œè¯´æ˜
  final String? imageUrl;        // å¯é€‰çš„æˆªå›¾/ç¤ºæ„å›¾
  final String? tip;             // å°è´´å£«
  final bool isOptional;         // æ˜¯å¦å¯é€‰æ­¥éª¤
}

/// æŒ‡å—ç±»å‹
enum GuideType {
  subscriptionCancel,    // è®¢é˜…å–æ¶ˆ
  feeAvoidance,          // è´¹ç”¨è§„é¿
  accountClosure,        // è´¦æˆ·æ³¨é”€
  planDowngrade,         // å¥—é¤é™çº§
  refundRequest,         // é€€æ¬¾ç”³è¯·
  alternativeSwitch,     // æ›¿ä»£å“åˆ‡æ¢
  discountApplication,   // ä¼˜æƒ ç”³è¯·
}

/// æŒ‡å—æ¥æº
enum GuideSource {
  preCached,      // é¢„ç½®ç¼“å­˜ï¼ˆå¸¸ç”¨æœåŠ¡ï¼‰
  webSearch,      // ç½‘ç»œæœç´¢
  llmGenerated,   // LLMç”Ÿæˆ
  userContributed, // ç”¨æˆ·è´¡çŒ®
}

/// å¯æ“ä½œæ´å¯Ÿ
class ActionableInsight {
  final SpendingInsight insight;
  final List<OperationGuide> actionGuides;
  final double estimatedSaving;  // é¢„ä¼°èŠ‚çœé‡‘é¢
  final InsightPriority priority;

  /// æ˜¯å¦æœ‰å¯æ‰§è¡Œçš„æŒ‡å—
  bool get hasActionableGuides => actionGuides.isNotEmpty;

  /// è·å–ä¸»è¦æ“ä½œæŒ‡å—
  OperationGuide? get primaryGuide =>
      actionGuides.isNotEmpty ? actionGuides.first : null;
}
```

**æŒ‡å—ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```dart
/// æŒ‡å—ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡
class GuideLifecycleManager {
  final OperationGuideRepository _guideRepository;
  final TransactionRepository _transactionRepository;
  final ActionableInsightService _insightService;

  /// å®šæœŸæ£€è§†ç”¨æˆ·å¼€é”€ï¼Œé¢„å‡†å¤‡ç›¸å…³æŒ‡å—
  Future<void> periodicGuidePreparation() async {
    // è·å–ç”¨æˆ·å½“å‰çš„æ¶ˆè´¹ç±»åˆ«å’Œå•†æˆ·
    final recentExpenses = await _transactionRepository.getRecentExpenses(
      days: 90,
    );

    // è¯†åˆ«å¯èƒ½éœ€è¦ä¼˜åŒ–çš„æ¶ˆè´¹
    final optimizableExpenses = _identifyOptimizableExpenses(recentExpenses);

    // é¢„å…ˆå‡†å¤‡æŒ‡å—
    for (final expense in optimizableExpenses) {
      await _prepareGuidesForExpense(expense);
    }

    // æ¸…ç†ä¸å†éœ€è¦çš„æŒ‡å—
    await _cleanupUnusedGuides(recentExpenses);
  }

  /// è¯†åˆ«å¯ä¼˜åŒ–çš„æ¶ˆè´¹
  List<OptimizableExpense> _identifyOptimizableExpenses(
    List<Transaction> expenses,
  ) {
    final result = <OptimizableExpense>[];

    // è¯†åˆ«è®¢é˜…ç±»æ¶ˆè´¹
    final subscriptions = _identifySubscriptions(expenses);
    for (final sub in subscriptions) {
      result.add(OptimizableExpense(
        type: OptimizationType.subscription,
        merchant: sub.merchant,
        monthlyAmount: sub.amount,
        frequency: sub.frequency,
      ));
    }

    // è¯†åˆ«å¯èƒ½æœ‰æ›´ä¼˜æ–¹æ¡ˆçš„æ¶ˆè´¹
    final optimizable = _identifyBetterAlternatives(expenses);
    result.addAll(optimizable);

    // è¯†åˆ«å¯è§„é¿çš„è´¹ç”¨
    final fees = _identifyAvoidableFees(expenses);
    result.addAll(fees);

    return result;
  }

  /// é¢„å‡†å¤‡æŒ‡å—
  Future<void> _prepareGuidesForExpense(OptimizableExpense expense) async {
    final existingGuide = await _guideRepository.getCachedGuide(
      type: _mapToGuideType(expense.type),
      target: expense.merchant,
    );

    // å¦‚æœæ²¡æœ‰æŒ‡å—æˆ–å·²è¿‡æœŸï¼Œé¢„å…ˆè·å–
    if (existingGuide == null || existingGuide.isExpired) {
      final guide = await _insightService._fetchGuideFromWeb(expense.merchant);
      if (guide != null) {
        await _guideRepository.cacheGuide(guide);
      }
    }
  }

  /// æ¸…ç†ä¸å†éœ€è¦çš„æŒ‡å—
  Future<void> _cleanupUnusedGuides(List<Transaction> recentExpenses) async {
    final currentMerchants = recentExpenses
        .map((t) => t.merchant)
        .toSet();

    // è·å–æ‰€æœ‰ç¼“å­˜çš„æŒ‡å—
    final cachedGuides = await _guideRepository.getAllCachedGuides();

    for (final guide in cachedGuides) {
      // å¦‚æœç”¨æˆ·ä¸å†æœ‰å¯¹åº”çš„æ¶ˆè´¹ï¼Œä¸”æŒ‡å—å·²è¿‡æœŸï¼Œåˆ™æ¸…é™¤
      if (!currentMerchants.contains(guide.target) && guide.isExpired) {
        await _guideRepository.deleteGuide(guide.id);
      }

      // å³ä½¿ç”¨æˆ·è¿˜æœ‰æ¶ˆè´¹ï¼Œè¶…è¿‡90å¤©æœªä½¿ç”¨ä¹Ÿæ¸…ç†
      if (guide.lastAccessedAt != null) {
        final daysSinceAccess = DateTime.now()
            .difference(guide.lastAccessedAt!)
            .inDays;
        if (daysSinceAccess > 90) {
          await _guideRepository.deleteGuide(guide.id);
        }
      }
    }
  }

  /// æ›´æ–°å¸¸ç”¨æœåŠ¡çš„é¢„ç½®æŒ‡å—
  Future<void> updatePreCachedGuides() async {
    // å¸¸ç”¨è®¢é˜…æœåŠ¡åˆ—è¡¨
    final commonServices = [
      'Netflix', 'çˆ±å¥‡è‰º', 'è…¾è®¯è§†é¢‘', 'ä¼˜é…·', 'Bç«™å¤§ä¼šå‘˜',
      'Spotify', 'Apple Music', 'QQéŸ³ä¹', 'ç½‘æ˜“äº‘éŸ³ä¹',
      'iCloud', 'OneDrive', 'Dropbox', 'ç™¾åº¦ç½‘ç›˜',
      'Adobe Creative Cloud', 'Microsoft 365',
      'äº¬ä¸œPlus', 'æ·˜å®88VIP', 'ç¾å›¢ä¼šå‘˜', 'é¥¿äº†ä¹ˆä¼šå‘˜',
    ];

    for (final service in commonServices) {
      final guide = await _guideRepository.getCachedGuide(
        type: GuideType.subscriptionCancel,
        target: service,
      );

      // æ¯30å¤©æ›´æ–°ä¸€æ¬¡é¢„ç½®æŒ‡å—
      if (guide == null || guide.remainingDays < 0) {
        final newGuide = await _insightService._fetchGuideFromWeb(service);
        if (newGuide != null) {
          await _guideRepository.cacheGuide(newGuide.copyWith(
            source: GuideSource.preCached,
          ));
        }
      }
    }
  }
}

/// å¯ä¼˜åŒ–æ¶ˆè´¹
class OptimizableExpense {
  final OptimizationType type;
  final String merchant;
  final double monthlyAmount;
  final String? frequency;
  final String? betterAlternative;
}

enum OptimizationType {
  subscription,       // è®¢é˜…
  recurringFee,       // å‘¨æœŸæ€§è´¹ç”¨
  betterAlternative,  // æœ‰æ›´ä¼˜æ›¿ä»£
  avoidableFee,       // å¯è§„é¿è´¹ç”¨
}
```

**æŒ‡å—å†…å®¹å±•ç¤ºUI**ï¼š

```dart
/// æ“ä½œæŒ‡å—è¯¦æƒ…é¡µ
class OperationGuideDetailPage extends StatelessWidget {
  final OperationGuide guide;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(guide.title),
        actions: [
          // åˆ†äº«æŒ‡å—
          IconButton(
            icon: Icon(Icons.share),
            onPressed: () => _shareGuide(context),
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // æ¥æºä¿¡æ¯
            _buildSourceInfo(),

            SizedBox(height: 16),

            // é¢„ä¼°èŠ‚çœ
            if (guide.type == GuideType.subscriptionCancel)
              _buildSavingEstimate(),

            SizedBox(height: 24),

            // æ­¥éª¤åˆ—è¡¨
            Text(
              'æ“ä½œæ­¥éª¤',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 12),

            ...guide.steps.asMap().entries.map((entry) =>
              _buildStepCard(entry.key + 1, entry.value),
            ),

            // æ³¨æ„äº‹é¡¹
            if (guide.warnings?.isNotEmpty == true) ...[
              SizedBox(height: 24),
              _buildWarningsSection(),
            ],

            // æ›¿ä»£æ–¹æ¡ˆ
            if (guide.alternatives?.isNotEmpty == true) ...[
              SizedBox(height: 24),
              _buildAlternativesSection(),
            ],

            // å…è´£å£°æ˜
            if (guide.disclaimer != null) ...[
              SizedBox(height: 24),
              _buildDisclaimer(),
            ],

            SizedBox(height: 32),

            // æ“ä½œæŒ‰é’®
            _buildActionButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildStepCard(int stepNumber, GuideStep step) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.grey.shade50,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.grey.shade200),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // æ­¥éª¤ç¼–å·
          Container(
            width: 28,
            height: 28,
            decoration: BoxDecoration(
              color: step.isOptional ? Colors.grey : Colors.blue,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: Text(
                '$stepNumber',
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
          SizedBox(width: 12),

          // æ­¥éª¤å†…å®¹
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (step.isOptional)
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    margin: EdgeInsets.only(bottom: 4),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade300,
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      'å¯é€‰',
                      style: TextStyle(fontSize: 10, color: Colors.grey.shade700),
                    ),
                  ),
                Text(
                  step.instruction,
                  style: TextStyle(fontSize: 15),
                ),
                if (step.tip != null) ...[
                  SizedBox(height: 8),
                  Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: Colors.blue.shade50,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.lightbulb_outline,
                          size: 16, color: Colors.blue),
                        SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            step.tip!,
                            style: TextStyle(
                              fontSize: 13,
                              color: Colors.blue.shade700,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSourceInfo() {
    final sourceText = switch (guide.source) {
      GuideSource.preCached => 'å®˜æ–¹é¢„ç½®æŒ‡å—',
      GuideSource.webSearch => 'ç½‘ç»œæœç´¢æ•´ç†',
      GuideSource.llmGenerated => 'AIæ™ºèƒ½ç”Ÿæˆ',
      GuideSource.userContributed => 'ç”¨æˆ·è´¡çŒ®',
    };

    return Container(
      padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: Colors.grey.shade100,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.info_outline, size: 16, color: Colors.grey.shade600),
          SizedBox(width: 8),
          Text(
            '$sourceText Â· æ›´æ–°äº${_formatDate(guide.fetchedAt)}',
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey.shade600,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionButtons(BuildContext context) {
    return Column(
      children: [
        // ä¸»æ“ä½œï¼šæ ‡è®°å®Œæˆ
        SizedBox(
          width: double.infinity,
          child: ElevatedButton.icon(
            onPressed: () => _markAsCompleted(context),
            icon: Icon(Icons.check_circle),
            label: Text('æˆ‘å·²å®Œæˆæ­¤æ“ä½œ'),
            style: ElevatedButton.styleFrom(
              padding: EdgeInsets.symmetric(vertical: 16),
            ),
          ),
        ),
        SizedBox(height: 12),

        // æ¬¡è¦æ“ä½œ
        Row(
          children: [
            Expanded(
              child: OutlinedButton.icon(
                onPressed: () => _reportIssue(context),
                icon: Icon(Icons.flag_outlined),
                label: Text('æŒ‡å—æœ‰è¯¯'),
              ),
            ),
            SizedBox(width: 12),
            Expanded(
              child: OutlinedButton.icon(
                onPressed: () => _refreshGuide(context),
                icon: Icon(Icons.refresh),
                label: Text('åˆ·æ–°æŒ‡å—'),
              ),
            ),
          ],
        ),
      ],
    );
  }
}
```

### 9.3 å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤

#### 9.3.1 å®æ—¶é¢„ç®—å¯è§†åŒ–

```dart
/// é¢„ç®—å®æ—¶çŠ¶æ€ç»„ä»¶ï¼ˆå¸¸é©»æ˜¾ç¤ºï¼‰
class BudgetStatusBar extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final budgets = ref.watch(activeBudgetsProvider);

    return Container(
      height: 60,
      padding: EdgeInsets.symmetric(horizontal: 16),
      child: ListView.separated(
        scrollDirection: Axis.horizontal,
        itemCount: budgets.length,
        separatorBuilder: (_, __) => SizedBox(width: 12),
        itemBuilder: (context, index) {
          final budget = budgets[index];
          final remaining = budget.amount - budget.spent;
          final isWarning = remaining < budget.amount * 0.2;
          final isDanger = remaining <= 0;

          return InkWell(
            onTap: () => _showBudgetDetail(context, budget),
            borderRadius: BorderRadius.circular(20),
            child: Container(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              decoration: BoxDecoration(
                color: isDanger ? Colors.red.shade50 :
                       isWarning ? Colors.orange.shade50 :
                       Colors.green.shade50,
                borderRadius: BorderRadius.circular(20),
                border: Border.all(
                  color: isDanger ? Colors.red :
                         isWarning ? Colors.orange :
                         Colors.green,
                  width: 1,
                ),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(
                    budget.category?.icon ?? Icons.account_balance_wallet,
                    size: 20,
                    color: isDanger ? Colors.red :
                           isWarning ? Colors.orange :
                           Colors.green,
                  ),
                  SizedBox(width: 8),
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(budget.name, style: TextStyle(fontSize: 12)),
                      Text(
                        remaining >= 0 ? 'è¿˜å‰© Â¥${remaining.toStringAsFixed(0)}'
                                       : 'è¶…æ”¯ Â¥${(-remaining).toStringAsFixed(0)}',
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          color: isDanger ? Colors.red :
                                 isWarning ? Colors.orange :
                                 Colors.green,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}
```

#### 9.3.2 æ¶ˆè´¹å‰ç¡®è®¤æœºåˆ¶

```dart
/// å¤§é¢æ¶ˆè´¹ç¡®è®¤æœåŠ¡
class LargeExpenseConfirmService {
  /// åˆ¤æ–­æ˜¯å¦éœ€è¦ç¡®è®¤
  Future<ConfirmationRequired?> checkNeedsConfirmation(Transaction tx) async {
    final budget = await _findRelevantBudget(tx);
    if (budget == null) return null;

    final remaining = budget.amount - budget.spent;
    final warnings = <ConfirmationWarning>[];

    // æ£€æŸ¥1ï¼šä¼šå¯¼è‡´è¶…æ”¯
    if (tx.amount > remaining) {
      warnings.add(ConfirmationWarning(
        type: WarningType.willOverspend,
        severity: WarningSeverity.high,
        message: 'è¿™ç¬”æ¶ˆè´¹å°†å¯¼è‡´${budget.name}è¶…æ”¯ Â¥${(tx.amount - remaining).toStringAsFixed(0)}',
      ));
    }

    // æ£€æŸ¥2ï¼šæ¶ˆè€—è¶…è¿‡50%å‰©ä½™é¢„ç®—
    else if (tx.amount > remaining * 0.5 && remaining > 100) {
      warnings.add(ConfirmationWarning(
        type: WarningType.largePortionOfBudget,
        severity: WarningSeverity.medium,
        message: 'è¿™ç¬”æ¶ˆè´¹å°†ç”¨æ‰${budget.name}å‰©ä½™é¢„ç®—çš„${(tx.amount / remaining * 100).toStringAsFixed(0)}%',
      ));
    }

    // æ£€æŸ¥3ï¼šæœˆåˆå°±å¤§é¢æ¶ˆè´¹
    final dayOfMonth = DateTime.now().day;
    if (dayOfMonth <= 7 && tx.amount > budget.amount * 0.3) {
      warnings.add(ConfirmationWarning(
        type: WarningType.earlyLargeExpense,
        severity: WarningSeverity.medium,
        message: 'æœˆåˆå¤§é¢æ¶ˆè´¹å¯èƒ½å½±å“æœ¬æœˆé¢„ç®—æ§åˆ¶',
      ));
    }

    // æ£€æŸ¥4ï¼šéå¿…è¦æ¶ˆè´¹
    final necessity = NecessityAnalyzer.categoryNecessity[tx.categoryName];
    if (necessity == ExpenseNecessity.optional && tx.amount > 200) {
      warnings.add(ConfirmationWarning(
        type: WarningType.optionalExpense,
        severity: WarningSeverity.low,
        message: 'è¿™æ˜¯ä¸€ç¬”å¯é€‰æ¶ˆè´¹ï¼Œè€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦ï¼Ÿ',
      ));
    }

    if (warnings.isEmpty) return null;

    return ConfirmationRequired(
      transaction: tx,
      warnings: warnings,
      budgetStatus: BudgetStatus(
        budgetName: budget.name,
        total: budget.amount,
        spent: budget.spent,
        remaining: remaining,
        afterThisExpense: remaining - tx.amount,
      ),
    );
  }
}

/// æ¶ˆè´¹ç¡®è®¤å¼¹çª—
class ExpenseConfirmationDialog extends StatelessWidget {
  final ConfirmationRequired confirmation;
  final VoidCallback onConfirm;
  final VoidCallback onCancel;

  @override
  Widget build(BuildContext context) {
    final highestSeverity = confirmation.warnings
        .map((w) => w.severity)
        .reduce((a, b) => a.index > b.index ? a : b);

    final headerColor = highestSeverity == WarningSeverity.high
        ? Colors.red
        : highestSeverity == WarningSeverity.medium
            ? Colors.orange
            : Colors.blue;

    return AlertDialog(
      title: Row(
        children: [
          Icon(
            highestSeverity == WarningSeverity.high
                ? Icons.warning
                : Icons.info_outline,
            color: headerColor,
          ),
          SizedBox(width: 8),
          Text('ç¡®è®¤è¿™ç¬”æ¶ˆè´¹ï¼Ÿ'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // äº¤æ˜“ä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Text(confirmation.transaction.categoryName),
                Spacer(),
                Text('Â¥${confirmation.transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
              ],
            ),
          ),

          SizedBox(height: 16),

          // è­¦å‘Šåˆ—è¡¨
          ...confirmation.warnings.map((warning) => Padding(
            padding: EdgeInsets.symmetric(vertical: 4),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Icon(
                  warning.severity == WarningSeverity.high
                      ? Icons.error
                      : Icons.warning_amber,
                  size: 20,
                  color: warning.severity == WarningSeverity.high
                      ? Colors.red
                      : Colors.orange,
                ),
                SizedBox(width: 8),
                Expanded(child: Text(warning.message)),
              ],
            ),
          )),

          SizedBox(height: 16),

          // é¢„ç®—çŠ¶æ€
          _buildBudgetBar(confirmation.budgetStatus),

          SizedBox(height: 16),

          // å†·é™æœŸæç¤º
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Icon(Icons.schedule, color: Colors.blue, size: 20),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'å»ºè®®ï¼šå¤§é¢æ¶ˆè´¹å‰å…ˆç­‰å¾…24å°æ—¶ï¼Œé¿å…å†²åŠ¨å†³ç­–',
                    style: TextStyle(color: Colors.blue.shade800, fontSize: 13),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: onCancel,
          child: Text('å–æ¶ˆ'),
        ),
        TextButton(
          onPressed: () => _setReminder(context, confirmation),
          child: Text('ç¨åæé†’æˆ‘'),
        ),
        ElevatedButton(
          onPressed: onConfirm,
          style: ElevatedButton.styleFrom(
            backgroundColor: headerColor,
          ),
          child: Text('ä»è¦è®°å½•'),
        ),
      ],
    );
  }
}
```

#### 9.3.3 å…ˆè§„åˆ’å†æ¶ˆè´¹å¼•å¯¼

å»ºç«‹"å…ˆè§„åˆ’å†æ¶ˆè´¹"çš„å¿ƒæ™ºæ¨¡å‹ï¼Œè®©ç”¨æˆ·å…»æˆæ¶ˆè´¹å‰å…ˆæ€è€ƒçš„ä¹ æƒ¯ã€‚

```dart
/// æ¶ˆè´¹è§„åˆ’å¼•å¯¼æœåŠ¡
class SpendingPlanningService {
  /// æœˆåˆé¢„ç®—è§„åˆ’å¼•å¯¼
  Future<MonthlyPlanningGuide> generateMonthlyPlanningGuide() async {
    final lastMonthExpenses = await _transactionRepo.getLastMonthExpenses();
    final incomeEstimate = await _estimateMonthlyIncome();
    final fixedExpenses = await _getFixedExpenses();
    final savingsGoal = await _getSavingsGoal();

    // è®¡ç®—å¯æ”¯é…é‡‘é¢
    final disposable = incomeEstimate - fixedExpenses - savingsGoal;

    // æŒ‰ç±»åˆ«å»ºè®®é¢„ç®—åˆ†é…
    final suggestedBudgets = _suggestBudgetAllocation(
      disposable,
      lastMonthExpenses,
    );

    return MonthlyPlanningGuide(
      estimatedIncome: incomeEstimate,
      fixedExpenses: fixedExpenses,
      savingsAllocation: savingsGoal,
      disposableAmount: disposable,
      suggestedBudgets: suggestedBudgets,
      planningQuestions: _generatePlanningQuestions(lastMonthExpenses),
    );
  }

  /// ç”Ÿæˆè§„åˆ’å¼•å¯¼é—®é¢˜
  List<PlanningQuestion> _generatePlanningQuestions(
    Map<String, double> lastMonthExpenses,
  ) {
    return [
      PlanningQuestion(
        question: 'è¿™ä¸ªæœˆæœ‰ä»€ä¹ˆç‰¹åˆ«çš„è®¡åˆ’éœ€è¦èŠ±é’±å—ï¼Ÿ',
        hint: 'å¦‚ï¼šç”Ÿæ—¥èšä¼šã€æ—…è¡Œã€å¤§ä»¶è´­ä¹°',
        icon: Icons.event,
        type: QuestionType.plannedExpense,
      ),
      PlanningQuestion(
        question: 'ä¸Šä¸ªæœˆå“ªäº›æ¶ˆè´¹è®©ä½ è§‰å¾—"ä¸è¯¥èŠ±"ï¼Ÿ',
        hint: 'å›é¡¾ä¸Šæœˆï¼Œæ ‡è®°ä¸æƒ³é‡å¤çš„æ¶ˆè´¹',
        icon: Icons.thumb_down_outlined,
        type: QuestionType.regrettedExpense,
        relatedData: lastMonthExpenses,
      ),
      PlanningQuestion(
        question: 'è¿™ä¸ªæœˆæƒ³åœ¨å“ªæ–¹é¢çœä¸€ç‚¹ï¼Ÿ',
        hint: 'é€‰æ‹©ä¸€ä¸ªæƒ³æ§åˆ¶çš„æ¶ˆè´¹ç±»åˆ«',
        icon: Icons.savings,
        type: QuestionType.savingsTarget,
      ),
      PlanningQuestion(
        question: 'æœ‰ä»€ä¹ˆæƒ³ä¹°ä½†å¯ä»¥ç­‰ç­‰çš„ä¸œè¥¿ï¼Ÿ',
        hint: 'åŠ å…¥æ„¿æœ›æ¸…å•ï¼Œç­‰é¢„ç®—å……è£•å†ä¹°',
        icon: Icons.shopping_cart_outlined,
        type: QuestionType.wishList,
      ),
    ];
  }

  /// å¤§é¢æ¶ˆè´¹å†³ç­–å¼•å¯¼
  Future<PurchaseDecisionGuide> guideLargePurchaseDecision(
    double amount,
    String category,
  ) async {
    final budget = await _getBudgetForCategory(category);
    final monthlyIncome = await _getAverageMonthlyIncome();
    final hourlyRate = monthlyIncome / 22 / 8; // å‡è®¾æ¯æœˆ22å¤©ï¼Œæ¯å¤©8å°æ—¶

    return PurchaseDecisionGuide(
      amount: amount,
      workHoursEquivalent: (amount / hourlyRate).round(),
      budgetImpact: budget != null
          ? BudgetImpact(
              budgetName: budget.name,
              percentageOfBudget: amount / budget.amount,
              willExceed: budget.remaining < amount,
            )
          : null,
      waitingPeriodSuggestion: _suggestWaitingPeriod(amount),
      alternativeQuestions: [
        'è¿™ä¸ªä¸œè¥¿èƒ½ç»™ä½ å¸¦æ¥å¤šä¹…çš„å¿«ä¹ï¼Ÿ',
        'ä¸€ä¸ªæœˆåä½ è¿˜ä¼šæƒ³ä¹°å—ï¼Ÿ',
        'æœ‰æ²¡æœ‰æ›´ä¾¿å®œçš„æ›¿ä»£å“ï¼Ÿ',
        'ä¹°è¿™ä¸ªéœ€è¦å·¥ä½œ${(amount / hourlyRate).round()}å°æ—¶ï¼Œå€¼å¾—å—ï¼Ÿ',
      ],
      decisionActions: [
        DecisionAction(
          label: 'åŠ å…¥æ„¿æœ›æ¸…å•',
          description: 'ç­‰${_suggestWaitingPeriod(amount).inDays}å¤©åå†å†³å®š',
          type: ActionType.addToWishList,
        ),
        DecisionAction(
          label: 'è®¾ç½®æé†’',
          description: 'ä¸‹ä¸ªæœˆé¢„ç®—å……è£•æ—¶æé†’æˆ‘',
          type: ActionType.setReminder,
        ),
        DecisionAction(
          label: 'æˆ‘ç¡®å®éœ€è¦',
          description: 'è¿™æ˜¯è®¡åˆ’å†…çš„å¿…è¦æ”¯å‡º',
          type: ActionType.confirmPurchase,
        ),
      ],
    );
  }

  Duration _suggestWaitingPeriod(double amount) {
    if (amount > 5000) return Duration(days: 30);
    if (amount > 1000) return Duration(days: 7);
    if (amount > 500) return Duration(days: 3);
    return Duration(days: 1);
  }
}

/// æ„¿æœ›æ¸…å•ç®¡ç†
class WishListService {
  /// æ·»åŠ åˆ°æ„¿æœ›æ¸…å•
  Future<WishListItem> addToWishList({
    required String name,
    required double estimatedPrice,
    required String category,
    String? reason,
  }) async {
    final item = WishListItem(
      id: Uuid().v4(),
      name: name,
      estimatedPrice: estimatedPrice,
      category: category,
      reason: reason,
      addedAt: DateTime.now(),
      reminderDate: DateTime.now().add(Duration(days: 7)),
      status: WishListStatus.waiting,
    );

    await _wishListRepo.add(item);

    // è®¾ç½®æé†’
    await _notificationService.scheduleWishListReminder(item);

    return item;
  }

  /// è·å–å¯ä»¥è´­ä¹°çš„æ„¿æœ›æ¸…å•é¡¹ï¼ˆç­‰å¾…æœŸå·²è¿‡+é¢„ç®—å……è¶³ï¼‰
  Future<List<WishListItem>> getAffordableWishes() async {
    final wishes = await _wishListRepo.getAll();
    final now = DateTime.now();
    final affordable = <WishListItem>[];

    for (final wish in wishes) {
      // ç­‰å¾…æœŸå·²è¿‡
      if (now.isAfter(wish.reminderDate)) {
        // æ£€æŸ¥é¢„ç®—
        final budget = await _getBudgetForCategory(wish.category);
        if (budget == null || budget.remaining >= wish.estimatedPrice) {
          affordable.add(wish);
        }
      }
    }

    return affordable;
  }

  /// æ„¿æœ›æ¸…å•å›é¡¾ï¼ˆå®šæœŸæ£€è§†è¿˜æƒ³ä¸æƒ³ä¹°ï¼‰
  Future<WishListReview> generateReview() async {
    final wishes = await _wishListRepo.getAll();
    final now = DateTime.now();

    final needsReview = wishes.where((w) =>
      w.status == WishListStatus.waiting &&
      now.difference(w.addedAt).inDays > 30
    ).toList();

    return WishListReview(
      totalItems: wishes.length,
      waitingItems: wishes.where((w) => w.status == WishListStatus.waiting).length,
      needsReview: needsReview,
      potentialSavings: needsReview.fold(0.0, (sum, w) => sum + w.estimatedPrice),
      message: needsReview.isNotEmpty
          ? 'æœ‰${needsReview.length}ä¸ªæ„¿æœ›å·²ç­‰å¾…è¶…è¿‡30å¤©ï¼Œè¿˜æƒ³ä¹°å—ï¼Ÿ'
          : null,
    );
  }
}

/// æ„¿æœ›æ¸…å•çŠ¶æ€
enum WishListStatus {
  waiting,    // ç­‰å¾…ä¸­
  purchased,  // å·²è´­ä¹°
  abandoned,  // æ”¾å¼ƒäº†
  postponed,  // å†ç­‰ç­‰
}

/// æœˆåˆè§„åˆ’æé†’å¡ç‰‡
class MonthlyPlanningCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isMonthStart = DateTime.now().day <= 3;
    final hasPlannedThisMonth = ref.watch(hasMonthlyPlanProvider);

    if (!isMonthStart || hasPlannedThisMonth) {
      return SizedBox.shrink();
    }

    return Card(
      color: Colors.blue.shade50,
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.calendar_month, color: Colors.blue),
                SizedBox(width: 8),
                Text('æ–°çš„ä¸€æœˆï¼Œå…ˆè§„åˆ’å†æ¶ˆè´¹',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Colors.blue.shade800,
                  )),
              ],
            ),
            SizedBox(height: 12),
            Text('èŠ±3åˆ†é’Ÿè§„åˆ’ä¸€ä¸‹è¿™ä¸ªæœˆçš„é¢„ç®—ï¼Œè®©æ¯ä¸€ç¬”é’±éƒ½èŠ±å¾—æ˜æ˜ç™½ç™½',
              style: TextStyle(color: Colors.blue.shade700)),
            SizedBox(height: 16),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => _startMonthlyPlanning(context),
                child: Text('å¼€å§‹è§„åˆ’'),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 9.4 è´¢åŠ¡ç¼“å†²å»ºè®¾

#### 9.4.1 åº”æ€¥é‡‘ç›®æ ‡ç³»ç»Ÿ

```dart
/// åº”æ€¥é‡‘ç®¡ç†æœåŠ¡
class EmergencyFundService {
  /// è®¡ç®—æ¨èçš„åº”æ€¥é‡‘ç›®æ ‡
  Future<EmergencyFundRecommendation> calculateRecommendation() async {
    // è·å–æœ€è¿‘6ä¸ªæœˆçš„å¿…è¦æ”¯å‡º
    final essentialExpenses = await _getEssentialExpenses(months: 6);
    final monthlyEssential = essentialExpenses / 6;

    // æ¨èè¦†ç›–3-6ä¸ªæœˆ
    final minimum = monthlyEssential * 3;
    final recommended = monthlyEssential * 4;
    final ideal = monthlyEssential * 6;

    // è·å–å½“å‰åº”æ€¥é‡‘ä½™é¢
    final currentBalance = await _getEmergencyFundBalance();

    // è®¡ç®—ç¼ºå£
    final gap = recommended - currentBalance;

    // è®¡ç®—æŒ‰å½“å‰å‚¨è“„ç‡éœ€è¦å¤šä¹…
    final monthlySavings = await _getAverageMonthlySavings();
    final monthsToGoal = gap > 0 && monthlySavings > 0
        ? (gap / monthlySavings).ceil()
        : 0;

    return EmergencyFundRecommendation(
      monthlyEssentialExpense: monthlyEssential,
      minimumTarget: minimum,
      recommendedTarget: recommended,
      idealTarget: ideal,
      currentBalance: currentBalance,
      gap: gap,
      progress: currentBalance / recommended,
      monthsToGoal: monthsToGoal,
      suggestions: _generateSuggestions(currentBalance, recommended, monthlySavings),
    );
  }

  /// ç”Ÿæˆå»ºè®®
  List<String> _generateSuggestions(double current, double target, double savings) {
    final suggestions = <String>[];

    if (current < target * 0.1) {
      suggestions.add('ğŸš¨ åº”æ€¥é‡‘ä¸¥é‡ä¸è¶³ï¼Œå»ºè®®ä¼˜å…ˆå»ºç«‹åŸºç¡€å‚¨å¤‡');
      suggestions.add('å¯ä»¥ä»å‡å°‘å¯é€‰æ¶ˆè´¹å¼€å§‹ï¼Œæ¯æœˆå­˜å…¥æ”¶å…¥çš„10%');
    } else if (current < target * 0.5) {
      suggestions.add('ğŸ’ª å·²ç»èµ·æ­¥äº†ï¼ç»§ç»­ä¿æŒå‚¨è“„ä¹ æƒ¯');
      suggestions.add('å»ºè®®è®¾ç½®è‡ªåŠ¨è½¬è´¦ï¼Œå·¥èµ„åˆ°è´¦åè‡ªåŠ¨å­˜å…¥åº”æ€¥é‡‘');
    } else if (current < target) {
      suggestions.add('ğŸ‘ è¿›å±•è‰¯å¥½ï¼è·ç¦»ç›®æ ‡å·²ç»è¿‡åŠ');
      suggestions.add('å¯ä»¥è€ƒè™‘å°†å¹´ç»ˆå¥–ã€æ„å¤–æ”¶å…¥ä¼˜å…ˆè¡¥å……åº”æ€¥é‡‘');
    } else {
      suggestions.add('ğŸ‰ æ­å–œï¼æ‚¨çš„åº”æ€¥é‡‘å·²è¾¾åˆ°æ¨èæ°´å¹³');
      suggestions.add('ç°åœ¨å¯ä»¥è€ƒè™‘å…¶ä»–è´¢åŠ¡ç›®æ ‡ï¼Œå¦‚æŠ•èµ„æˆ–è¿˜å€º');
    }

    return suggestions;
  }
}

/// åº”æ€¥é‡‘è¿›åº¦å¡ç‰‡
class EmergencyFundCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final recommendation = ref.watch(emergencyFundRecommendationProvider);

    return recommendation.when(
      data: (data) => _buildCard(context, data),
      loading: () => _buildLoadingCard(),
      error: (e, _) => _buildErrorCard(e),
    );
  }

  Widget _buildCard(BuildContext context, EmergencyFundRecommendation data) {
    final progressColor = data.progress < 0.3
        ? Colors.red
        : data.progress < 0.7
            ? Colors.orange
            : Colors.green;

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.shield, color: Colors.blue),
                SizedBox(width: 8),
                Text('åº”æ€¥é‡‘', style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
                Spacer(),
                Text('${(data.progress * 100).toStringAsFixed(0)}%',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: progressColor,
                  )),
              ],
            ),

            SizedBox(height: 16),

            // ç›®æ ‡è¯´æ˜
            Text('ç›®æ ‡ï¼šè¦†ç›–${4}ä¸ªæœˆå¿…è¦æ”¯å‡º',
              style: TextStyle(color: Colors.grey)),
            Text('Â¥${data.currentBalance.toStringAsFixed(0)} / Â¥${data.recommendedTarget.toStringAsFixed(0)}',
              style: TextStyle(fontSize: 16)),

            SizedBox(height: 12),

            // è¿›åº¦æ¡ï¼ˆå¸¦é‡Œç¨‹ç¢‘ï¼‰
            _buildProgressBar(data),

            SizedBox(height: 16),

            // å‰©ä½™ç¼ºå£
            if (data.gap > 0) ...[
              Row(
                children: [
                  Text('è¿˜éœ€: '),
                  Text('Â¥${data.gap.toStringAsFixed(0)}',
                    style: TextStyle(fontWeight: FontWeight.bold)),
                  Spacer(),
                  if (data.monthsToGoal > 0)
                    Text('æŒ‰å½“å‰å‚¨è“„ç‡çº¦éœ€ ${data.monthsToGoal} ä¸ªæœˆ',
                      style: TextStyle(color: Colors.grey, fontSize: 12)),
                ],
              ),
            ],

            SizedBox(height: 12),

            // å»ºè®®
            ...data.suggestions.take(1).map((s) => Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(s, style: TextStyle(color: Colors.blue.shade800)),
            )),
          ],
        ),
      ),
    );
  }

  Widget _buildProgressBar(EmergencyFundRecommendation data) {
    return Column(
      children: [
        // é‡Œç¨‹ç¢‘æ ‡ç­¾
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text('3ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
            Text('4ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
            Text('6ä¸ªæœˆ', style: TextStyle(fontSize: 10, color: Colors.grey)),
          ],
        ),
        SizedBox(height: 4),
        // è¿›åº¦æ¡
        Stack(
          children: [
            // èƒŒæ™¯
            Container(
              height: 12,
              decoration: BoxDecoration(
                color: Colors.grey.shade200,
                borderRadius: BorderRadius.circular(6),
              ),
            ),
            // è¿›åº¦
            FractionallySizedBox(
              widthFactor: data.progress.clamp(0, 1),
              child: Container(
                height: 12,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.blue, Colors.green],
                  ),
                  borderRadius: BorderRadius.circular(6),
                ),
              ),
            ),
            // é‡Œç¨‹ç¢‘çº¿
            Positioned(
              left: MediaQuery.of(context).size.width * 0.5 - 32,  // 3/6 = 50%
              child: Container(width: 2, height: 12, color: Colors.grey),
            ),
            Positioned(
              left: MediaQuery.of(context).size.width * 0.67 - 32, // 4/6 â‰ˆ 67%
              child: Container(width: 2, height: 12, color: Colors.grey),
            ),
          ],
        ),
      ],
    );
  }
}
```

#### 9.4.2 é’±é¾„è¿›é˜¶ç›®æ ‡

```dart
/// é’±é¾„è¿›é˜¶å¼•å¯¼æœåŠ¡
class MoneyAgeProgressionService {
  /// é’±é¾„é˜¶æ®µå®šä¹‰
  static const List<MoneyAgeStage> stages = [
    MoneyAgeStage(
      level: 1,
      name: 'æœˆå…‰æ—',
      minAge: 0,
      maxAge: 7,
      description: 'æ”¶å…¥å¾ˆå¿«å°±èŠ±å®Œäº†',
      color: Colors.red,
      icon: Icons.warning,
      tips: ['è®¾ç½®ä¸€ä¸ªå°ç›®æ ‡ï¼šæ¯æœˆå­˜ä¸‹æ”¶å…¥çš„5%', 'å°è¯•è®°å½•æ¯ä¸€ç¬”æ¶ˆè´¹ï¼Œæ‰¾å‡º"æ¼è´¢"ç‚¹'],
    ),
    MoneyAgeStage(
      level: 2,
      name: 'èµ·æ­¥è€…',
      minAge: 7,
      maxAge: 14,
      description: 'æœ‰äº†ä¸€ç‚¹ç¼“å†²',
      color: Colors.orange,
      icon: Icons.directions_walk,
      tips: ['ç»§ç»­ä¿æŒï¼äº‰å–é’±é¾„çªç ´14å¤©', 'å¼€å§‹å»ºç«‹åº”æ€¥é‡‘è´¦æˆ·'],
    ),
    MoneyAgeStage(
      level: 3,
      name: 'ç¨³å¥è€…',
      minAge: 14,
      maxAge: 30,
      description: 'æœ‰åŠä¸ªæœˆä»¥ä¸Šçš„ç¼“å†²',
      color: Colors.blue,
      icon: Icons.trending_up,
      tips: ['ç›®æ ‡ï¼šèŠ±ä¸Šä¸ªæœˆçš„é’±', 'å¯ä»¥å¼€å§‹è€ƒè™‘æŠ•èµ„ç†è´¢äº†'],
    ),
    MoneyAgeStage(
      level: 4,
      name: 'ä»å®¹è€…',
      minAge: 30,
      maxAge: 60,
      description: 'èŠ±çš„æ˜¯ä¸Šä¸ªæœˆèµšçš„é’±',
      color: Colors.green,
      icon: Icons.verified,
      tips: ['æ­å–œè¾¾æˆ"èŠ±ä¸Šæœˆçš„é’±"ç›®æ ‡ï¼', 'ç»§ç»­ç§¯ç´¯ï¼Œå‘2ä¸ªæœˆç¼“å†²è¿›å‘'],
    ),
    MoneyAgeStage(
      level: 5,
      name: 'è´¢åŠ¡è‡ªç”±',
      minAge: 60,
      maxAge: 999,
      description: 'æœ‰å……è¶³çš„è´¢åŠ¡ç¼“å†²',
      color: Colors.purple,
      icon: Icons.military_tech,
      tips: ['æ‚¨çš„è´¢åŠ¡çŠ¶å†µéå¸¸å¥åº·', 'å¯ä»¥æ›´ä»å®¹åœ°è§„åˆ’é•¿æœŸç›®æ ‡'],
    ),
  ];

  /// è·å–ç”¨æˆ·å½“å‰é˜¶æ®µ
  MoneyAgeStage getCurrentStage(int moneyAgeDays) {
    return stages.firstWhere(
      (s) => moneyAgeDays >= s.minAge && moneyAgeDays < s.maxAge,
      orElse: () => stages.last,
    );
  }

  /// è·å–ä¸‹ä¸€é˜¶æ®µç›®æ ‡
  MoneyAgeStage? getNextStage(int moneyAgeDays) {
    final current = getCurrentStage(moneyAgeDays);
    final nextIndex = stages.indexOf(current) + 1;
    if (nextIndex >= stages.length) return null;
    return stages[nextIndex];
  }

  /// è®¡ç®—å‡çº§æ‰€éœ€
  UpgradeRequirement? calculateUpgradeRequirement(int currentAge) {
    final nextStage = getNextStage(currentAge);
    if (nextStage == null) return null;

    final daysNeeded = nextStage.minAge - currentAge;

    // ä¼°ç®—éœ€è¦å‚¨è“„å¤šå°‘
    final avgDailyExpense = await _getAverageDailyExpense();
    final amountNeeded = daysNeeded * avgDailyExpense;

    return UpgradeRequirement(
      targetStage: nextStage,
      daysNeeded: daysNeeded,
      amountNeeded: amountNeeded,
      estimatedTime: _estimateTimeToReach(amountNeeded),
    );
  }
}

/// é’±é¾„è¿›é˜¶å¡ç‰‡
class MoneyAgeProgressionCard extends StatelessWidget {
  final int currentMoneyAge;

  @override
  Widget build(BuildContext context) {
    final service = MoneyAgeProgressionService();
    final currentStage = service.getCurrentStage(currentMoneyAge);
    final nextStage = service.getNextStage(currentMoneyAge);

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // å½“å‰é˜¶æ®µ
            Row(
              children: [
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: currentStage.color.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(currentStage.icon, color: currentStage.color, size: 32),
                ),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Level ${currentStage.level}',
                        style: TextStyle(color: Colors.grey, fontSize: 12)),
                      Text(currentStage.name,
                        style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                      Text(currentStage.description,
                        style: TextStyle(color: Colors.grey)),
                    ],
                  ),
                ),
                Column(
                  children: [
                    Text('$currentMoneyAge', style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.bold,
                      color: currentStage.color,
                    )),
                    Text('å¤©', style: TextStyle(color: Colors.grey)),
                  ],
                ),
              ],
            ),

            SizedBox(height: 20),

            // ä¸‹ä¸€é˜¶æ®µç›®æ ‡
            if (nextStage != null) ...[
              Container(
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    Icon(Icons.flag, color: nextStage.color),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('ä¸‹ä¸€ç›®æ ‡: ${nextStage.name}',
                            style: TextStyle(fontWeight: FontWeight.bold)),
                          Text('é’±é¾„è¾¾åˆ° ${nextStage.minAge} å¤©',
                            style: TextStyle(color: Colors.grey, fontSize: 12)),
                        ],
                      ),
                    ),
                    Text('è¿˜å·® ${nextStage.minAge - currentMoneyAge} å¤©',
                      style: TextStyle(color: nextStage.color, fontWeight: FontWeight.bold)),
                  ],
                ),
              ),
            ],

            SizedBox(height: 16),

            // è¿›é˜¶æç¤º
            ...currentStage.tips.map((tip) => Padding(
              padding: EdgeInsets.symmetric(vertical: 4),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Icon(Icons.lightbulb_outline, size: 16, color: Colors.amber),
                  SizedBox(width: 8),
                  Expanded(child: Text(tip, style: TextStyle(fontSize: 13))),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }
}
```

#### 9.4.3 å€ºåŠ¡å¥åº·ç®¡ç†

å¸®åŠ©ç”¨æˆ·å‡å°‘å¯¹ä¿¡ç”¨å¡å’Œç½‘è´·çš„ä¾èµ–ï¼Œå»ºç«‹å¥åº·çš„å€ºåŠ¡ç»“æ„ã€‚

```dart
/// å€ºåŠ¡å¥åº·ç›‘æµ‹æœåŠ¡
class DebtHealthService {
  /// åˆ†æå€ºåŠ¡å¥åº·çŠ¶å†µ
  Future<DebtHealthReport> analyzeDebtHealth() async {
    final debts = await _debtRepository.getAllActiveDebts();
    final monthlyIncome = await _getAverageMonthlyIncome();
    final monthlyExpense = await _getAverageMonthlyExpense();

    // è®¡ç®—å€ºåŠ¡æŒ‡æ ‡
    final totalDebt = debts.fold(0.0, (sum, d) => sum + d.remainingAmount);
    final monthlyPayment = debts.fold(0.0, (sum, d) => sum + d.monthlyPayment);
    final debtToIncomeRatio = totalDebt / (monthlyIncome * 12); // å¹´æ”¶å…¥æ¯”
    final paymentToIncomeRatio = monthlyPayment / monthlyIncome;

    // åˆ†ç±»å€ºåŠ¡
    final creditCardDebt = debts.where((d) => d.type == DebtType.creditCard).toList();
    final loanDebt = debts.where((d) => d.type == DebtType.loan).toList();
    final bnplDebt = debts.where((d) => d.type == DebtType.buyNowPayLater).toList();

    // è®¡ç®—ä¿¡ç”¨å¡åˆ©æ¯æˆæœ¬
    final creditCardInterest = _calculateCreditCardInterestCost(creditCardDebt);

    // ç”Ÿæˆå¥åº·è¯„ä¼°
    final healthLevel = _assessDebtHealthLevel(
      debtToIncomeRatio,
      paymentToIncomeRatio,
      creditCardDebt.length,
    );

    return DebtHealthReport(
      totalDebt: totalDebt,
      monthlyPayment: monthlyPayment,
      debtToIncomeRatio: debtToIncomeRatio,
      paymentToIncomeRatio: paymentToIncomeRatio,
      healthLevel: healthLevel,
      creditCardStats: CreditCardStats(
        count: creditCardDebt.length,
        totalBalance: creditCardDebt.fold(0.0, (sum, d) => sum + d.remainingAmount),
        monthlyInterest: creditCardInterest,
        utilizationRate: _calculateUtilizationRate(creditCardDebt),
      ),
      bnplStats: BnplStats(
        count: bnplDebt.length,
        totalBalance: bnplDebt.fold(0.0, (sum, d) => sum + d.remainingAmount),
        upcomingPayments: _getUpcomingBnplPayments(bnplDebt),
      ),
      recommendations: _generateDebtRecommendations(
        healthLevel,
        creditCardDebt,
        loanDebt,
        bnplDebt,
        monthlyIncome - monthlyExpense,
      ),
    );
  }

  /// è¯„ä¼°å€ºåŠ¡å¥åº·ç­‰çº§
  DebtHealthLevel _assessDebtHealthLevel(
    double debtToIncome,
    double paymentToIncome,
    int creditCardCount,
  ) {
    // å€ºåŠ¡/å¹´æ”¶å…¥ > 50% æˆ– æœˆè¿˜æ¬¾/æœˆæ”¶å…¥ > 40% ä¸ºå±é™©
    if (debtToIncome > 0.5 || paymentToIncome > 0.4) {
      return DebtHealthLevel.critical;
    }
    // å€ºåŠ¡/å¹´æ”¶å…¥ > 30% æˆ– ä¿¡ç”¨å¡ > 3å¼  ä¸ºè­¦å‘Š
    if (debtToIncome > 0.3 || paymentToIncome > 0.25 || creditCardCount > 3) {
      return DebtHealthLevel.warning;
    }
    // æœ‰å€ºåŠ¡ä½†å¯æ§
    if (debtToIncome > 0) {
      return DebtHealthLevel.moderate;
    }
    // æ— å€ºä¸€èº«è½»
    return DebtHealthLevel.healthy;
  }

  /// ç”Ÿæˆå€ºåŠ¡ä¼˜åŒ–å»ºè®®
  List<DebtRecommendation> _generateDebtRecommendations(
    DebtHealthLevel level,
    List<Debt> creditCards,
    List<Debt> loans,
    List<Debt> bnpl,
    double monthlySurplus,
  ) {
    final recommendations = <DebtRecommendation>[];

    // ä¿¡ç”¨å¡åˆ©æ¯è­¦å‘Š
    if (creditCards.isNotEmpty) {
      final highInterestCards = creditCards.where(
        (c) => c.interestRate > 0 && c.remainingAmount > 0
      ).toList();

      if (highInterestCards.isNotEmpty) {
        recommendations.add(DebtRecommendation(
          priority: RecommendationPriority.high,
          type: RecommendationType.payOffHighInterest,
          title: 'ä¼˜å…ˆè¿˜æ¸…ä¿¡ç”¨å¡æ¬ æ¬¾',
          description: 'ä¿¡ç”¨å¡å¹´åŒ–åˆ©ç‡é€šå¸¸é«˜è¾¾18%ï¼Œæ¬ æ¬¾ä¼šå¿«é€Ÿç§¯ç´¯åˆ©æ¯',
          action: 'è®¾ç½®è‡ªåŠ¨å…¨é¢è¿˜æ¬¾ï¼Œé¿å…äº§ç”Ÿåˆ©æ¯',
          potentialSavings: _calculateInterestSavings(highInterestCards),
          icon: Icons.credit_card_off,
        ));
      }
    }

    // å¤šå¼ ä¿¡ç”¨å¡æ•´åˆå»ºè®®
    if (creditCards.length > 3) {
      recommendations.add(DebtRecommendation(
        priority: RecommendationPriority.medium,
        type: RecommendationType.consolidate,
        title: 'è€ƒè™‘æ•´åˆä¿¡ç”¨å¡',
        description: 'æŒæœ‰${creditCards.length}å¼ ä¿¡ç”¨å¡ï¼Œç®¡ç†å¤æ‚ä¸”å®¹æ˜“æ¼è¿˜',
        action: 'ä¿ç•™1-2å¼ ä¸»åŠ›å¡ï¼Œæ³¨é”€ä¸å¸¸ç”¨çš„å¡',
        icon: Icons.merge_type,
      ));
    }

    // åˆ†æœŸä»˜æ¬¾è­¦å‘Š
    if (bnpl.isNotEmpty) {
      final totalBnpl = bnpl.fold(0.0, (sum, d) => sum + d.remainingAmount);
      if (totalBnpl > monthlySurplus * 2) {
        recommendations.add(DebtRecommendation(
          priority: RecommendationPriority.high,
          type: RecommendationType.reduceBnpl,
          title: 'æ§åˆ¶åˆ†æœŸä»˜æ¬¾',
          description: 'å½“å‰åˆ†æœŸå¾…è¿˜ Â¥${totalBnpl.toStringAsFixed(0)}ï¼Œè¶…è¿‡2ä¸ªæœˆç»“ä½™',
          action: 'æš‚åœæ–°çš„åˆ†æœŸè´­ä¹°ï¼Œä¸“æ³¨è¿˜æ¸…ç°æœ‰åˆ†æœŸ',
          icon: Icons.credit_score,
        ));
      }
    }

    // é›ªçƒè¿˜æ¬¾æ³•å»ºè®®
    if (level == DebtHealthLevel.warning || level == DebtHealthLevel.critical) {
      recommendations.add(DebtRecommendation(
        priority: RecommendationPriority.medium,
        type: RecommendationType.debtSnowball,
        title: 'ä½¿ç”¨é›ªçƒè¿˜æ¬¾æ³•',
        description: 'å…ˆè¿˜æ¸…æœ€å°çš„å€ºåŠ¡ï¼Œè·å¾—æˆå°±æ„Ÿåç»§ç»­æ”»å…‹ä¸‹ä¸€ä¸ª',
        action: 'æŸ¥çœ‹é›ªçƒè¿˜æ¬¾è®¡åˆ’',
        icon: Icons.ac_unit,
      ));
    }

    return recommendations;
  }
}

/// é›ªçƒè¿˜æ¬¾è®¡åˆ’æœåŠ¡
class DebtSnowballService {
  /// ç”Ÿæˆé›ªçƒè¿˜æ¬¾è®¡åˆ’
  Future<SnowballPlan> generateSnowballPlan(double monthlyBudget) async {
    final debts = await _debtRepository.getAllActiveDebts();

    // æŒ‰ä½™é¢ä»å°åˆ°å¤§æ’åºï¼ˆé›ªçƒæ³•ï¼‰
    debts.sort((a, b) => a.remainingAmount.compareTo(b.remainingAmount));

    final steps = <SnowballStep>[];
    var availableForExtra = monthlyBudget;

    // å…ˆæ”¯ä»˜æ‰€æœ‰æœ€ä½è¿˜æ¬¾
    for (final debt in debts) {
      availableForExtra -= debt.minimumPayment;
    }

    // æ¨¡æ‹Ÿè¿˜æ¬¾è¿‡ç¨‹
    final simulatedDebts = debts.map((d) => SimulatedDebt.from(d)).toList();
    int month = 0;

    while (simulatedDebts.any((d) => d.remaining > 0)) {
      month++;
      var extraPayment = availableForExtra;

      for (final debt in simulatedDebts) {
        if (debt.remaining <= 0) continue;

        // æ”¯ä»˜æœ€ä½è¿˜æ¬¾
        var payment = debt.minimumPayment;

        // å¯¹æœ€å°å€ºåŠ¡é¢å¤–è¿˜æ¬¾
        if (debt == simulatedDebts.firstWhere((d) => d.remaining > 0)) {
          payment += extraPayment;
        }

        // ä¸èƒ½è¶…è¿‡å‰©ä½™é‡‘é¢
        payment = min(payment, debt.remaining);
        debt.remaining -= payment;

        if (debt.remaining <= 0) {
          steps.add(SnowballStep(
            debtName: debt.name,
            paidOffMonth: month,
            freedUpAmount: debt.minimumPayment,
          ));
          // é‡Šæ”¾çš„æœ€ä½è¿˜æ¬¾åŠ å…¥é¢å¤–è¿˜æ¬¾
          availableForExtra += debt.minimumPayment;
        }
      }
    }

    return SnowballPlan(
      totalMonths: month,
      steps: steps,
      totalInterestSaved: _calculateInterestSaved(debts, month),
      motivationalMessage: _generateMotivationalMessage(steps),
    );
  }
}

/// å€ºåŠ¡å¥åº·ç­‰çº§
enum DebtHealthLevel {
  healthy,   // å¥åº·ï¼šæ— å€ºåŠ¡
  moderate,  // é€‚åº¦ï¼šæœ‰å€ºåŠ¡ä½†å¯æ§
  warning,   // è­¦å‘Šï¼šå€ºåŠ¡åé«˜
  critical,  // å±é™©ï¼šå€ºåŠ¡è¿‡é«˜
}

/// å€ºåŠ¡ç±»å‹
enum DebtType {
  creditCard,      // ä¿¡ç”¨å¡
  loan,            // è´·æ¬¾ï¼ˆæˆ¿è´·ã€è½¦è´·ç­‰ï¼‰
  buyNowPayLater,  // å…ˆä¹°åä»˜/åˆ†æœŸ
  personal,        // ä¸ªäººå€Ÿæ¬¾
}

/// å€ºåŠ¡å¥åº·å¡ç‰‡
class DebtHealthCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final report = ref.watch(debtHealthReportProvider);

    return report.when(
      data: (data) => _buildCard(context, data),
      loading: () => _buildLoadingCard(),
      error: (e, _) => SizedBox.shrink(),
    );
  }

  Widget _buildCard(BuildContext context, DebtHealthReport report) {
    final levelColor = switch (report.healthLevel) {
      DebtHealthLevel.healthy => Colors.green,
      DebtHealthLevel.moderate => Colors.blue,
      DebtHealthLevel.warning => Colors.orange,
      DebtHealthLevel.critical => Colors.red,
    };

    final levelText = switch (report.healthLevel) {
      DebtHealthLevel.healthy => 'æ— å€ºä¸€èº«è½»',
      DebtHealthLevel.moderate => 'å€ºåŠ¡å¯æ§',
      DebtHealthLevel.warning => 'éœ€è¦å…³æ³¨',
      DebtHealthLevel.critical => 'éœ€è¦æ”¹å–„',
    };

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.account_balance, color: levelColor),
                SizedBox(width: 8),
                Text('å€ºåŠ¡å¥åº·', style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
                Spacer(),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                  decoration: BoxDecoration(
                    color: levelColor.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(levelText, style: TextStyle(
                    color: levelColor,
                    fontWeight: FontWeight.bold,
                  )),
                ),
              ],
            ),

            if (report.totalDebt > 0) ...[
              SizedBox(height: 16),

              // å€ºåŠ¡æ¦‚è§ˆ
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  _buildStatItem('æ€»å€ºåŠ¡', 'Â¥${report.totalDebt.toStringAsFixed(0)}'),
                  _buildStatItem('æœˆè¿˜æ¬¾', 'Â¥${report.monthlyPayment.toStringAsFixed(0)}'),
                  _buildStatItem('è¿˜æ¬¾å æ¯”', '${(report.paymentToIncomeRatio * 100).toStringAsFixed(0)}%'),
                ],
              ),

              // ä¿¡ç”¨å¡åˆ©æ¯è­¦å‘Š
              if (report.creditCardStats.monthlyInterest > 0) ...[
                SizedBox(height: 16),
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.red.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.warning, color: Colors.red, size: 20),
                      SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          'ä¿¡ç”¨å¡æ¯æœˆäº§ç”Ÿçº¦ Â¥${report.creditCardStats.monthlyInterest.toStringAsFixed(0)} åˆ©æ¯',
                          style: TextStyle(color: Colors.red.shade800),
                        ),
                      ),
                    ],
                  ),
                ),
              ],

              // é¦–æ¡å»ºè®®
              if (report.recommendations.isNotEmpty) ...[
                SizedBox(height: 16),
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Icon(report.recommendations.first.icon,
                        color: Colors.blue, size: 20),
                      SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(report.recommendations.first.title,
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: Colors.blue.shade800,
                              )),
                            Text(report.recommendations.first.action,
                              style: TextStyle(
                                fontSize: 12,
                                color: Colors.blue.shade600,
                              )),
                          ],
                        ),
                      ),
                      Icon(Icons.chevron_right, color: Colors.blue),
                    ],
                  ),
                ),
              ],
            ],
          ],
        ),
      ),
    );
  }
}
```

### 9.5 å¼¹æ€§é¢„ç®—æœºåˆ¶

#### 9.5.1 çªå‘æ”¯å‡ºå¤„ç†

```dart
/// çªå‘æ”¯å‡ºå¤„ç†æœåŠ¡
class UnexpectedExpenseHandler {
  /// æ£€æµ‹çªå‘æ”¯å‡º
  bool isUnexpectedExpense(Transaction tx) {
    // æ¡ä»¶1ï¼šé‡‘é¢è¶…è¿‡æœˆå‡æ¶ˆè´¹çš„30%
    // æ¡ä»¶2ï¼šä¸åœ¨å¸¸è§„åˆ†ç±»ä¸­
    // æ¡ä»¶3ï¼šç”¨æˆ·æ ‡è®°ä¸ºçªå‘
    return tx.isMarkedAsUnexpected ||
           tx.amount > _monthlyAverage * 0.3 ||
           _isUnusualCategory(tx.categoryId);
  }

  /// å¤„ç†çªå‘æ”¯å‡º
  Future<UnexpectedExpenseResolution> handleUnexpectedExpense(
    Transaction tx,
    List<Budget> budgets,
  ) async {
    final options = <ResolutionOption>[];

    // é€‰é¡¹1ï¼šä»åº”æ€¥é‡‘æ”¯ä»˜
    final emergencyFund = await _getEmergencyFund();
    if (emergencyFund != null && emergencyFund.balance >= tx.amount) {
      options.add(ResolutionOption(
        type: ResolutionType.useEmergencyFund,
        description: 'ä»åº”æ€¥é‡‘æ”¯ä»˜',
        impact: 'åº”æ€¥é‡‘å‡å°‘ Â¥${tx.amount.toStringAsFixed(0)}',
        recommendation: tx.amount < emergencyFund.balance * 0.2
            ? RecommendationLevel.recommended
            : RecommendationLevel.cautious,
      ));
    }

    // é€‰é¡¹2ï¼šåˆ†æ‘Šåˆ°å¤šä¸ªé¢„ç®—
    final flexibleBudgets = budgets.where((b) =>
        b.type == BudgetType.flexible && b.remaining > 0).toList();
    if (flexibleBudgets.isNotEmpty) {
      final spreadPlan = _calculateSpreadPlan(tx.amount, flexibleBudgets);
      options.add(ResolutionOption(
        type: ResolutionType.spreadAcrossBudgets,
        description: 'åˆ†æ‘Šåˆ°${spreadPlan.length}ä¸ªé¢„ç®—',
        impact: spreadPlan.map((p) => '${p.budgetName}: -Â¥${p.amount.toStringAsFixed(0)}').join(', '),
        spreadPlan: spreadPlan,
        recommendation: RecommendationLevel.neutral,
      ));
    }

    // é€‰é¡¹3ï¼šè°ƒæ•´ä¸‹æœˆé¢„ç®—
    options.add(ResolutionOption(
      type: ResolutionType.adjustNextMonth,
      description: 'è®°å…¥æœ¬æœˆï¼Œä¸‹æœˆè¡¥å›',
      impact: 'ä¸‹æœˆå¯é€‰æ”¯å‡ºé¢„ç®—å‡å°‘ Â¥${tx.amount.toStringAsFixed(0)}',
      recommendation: RecommendationLevel.neutral,
    ));

    // é€‰é¡¹4ï¼šæ ‡è®°ä¸ºä¾‹å¤–ï¼ˆä¸å½±å“é¢„ç®—ç»Ÿè®¡ï¼‰
    options.add(ResolutionOption(
      type: ResolutionType.markAsException,
      description: 'æ ‡è®°ä¸ºä¾‹å¤–æ”¯å‡º',
      impact: 'ä¸è®¡å…¥é¢„ç®—ç»Ÿè®¡ï¼Œä½†ä¼šè®°å½•åœ¨æ¡ˆ',
      recommendation: RecommendationLevel.notRecommended,
      warning: 'é¢‘ç¹ä½¿ç”¨æ­¤é€‰é¡¹ä¼šå½±å“é¢„ç®—å‡†ç¡®æ€§',
    ));

    return UnexpectedExpenseResolution(
      transaction: tx,
      options: options,
      suggestedOption: _pickBestOption(options),
    );
  }

  /// è®¡ç®—åˆ†æ‘Šæ–¹æ¡ˆ
  List<SpreadItem> _calculateSpreadPlan(double amount, List<Budget> budgets) {
    final plan = <SpreadItem>[];
    var remaining = amount;

    // æŒ‰å‰©ä½™é‡‘é¢æ’åºï¼Œä»å¤šåˆ°å°‘åˆ†æ‘Š
    budgets.sort((a, b) => b.remaining.compareTo(a.remaining));

    for (final budget in budgets) {
      if (remaining <= 0) break;

      // æ¯ä¸ªé¢„ç®—æœ€å¤šåˆ†æ‘Šå…¶å‰©ä½™é¢åº¦çš„50%
      final maxSpread = budget.remaining * 0.5;
      final spread = min(remaining, maxSpread);

      if (spread > 0) {
        plan.add(SpreadItem(
          budgetId: budget.id,
          budgetName: budget.name,
          amount: spread,
        ));
        remaining -= spread;
      }
    }

    // å¦‚æœè¿˜æœ‰å‰©ä½™ï¼Œå‡åŒ€å†åˆ†é…
    if (remaining > 0 && plan.isNotEmpty) {
      final extraPerBudget = remaining / plan.length;
      for (final item in plan) {
        item.amount += extraPerBudget;
      }
    }

    return plan;
  }
}

/// çªå‘æ”¯å‡ºå¤„ç†å¼¹çª—
class UnexpectedExpenseDialog extends StatelessWidget {
  final UnexpectedExpenseResolution resolution;
  final Function(ResolutionOption) onSelect;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(Icons.bolt, color: Colors.orange),
          SizedBox(width: 8),
          Text('çªå‘æ”¯å‡ºå¤„ç†'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // æ”¯å‡ºä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.shade50,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              children: [
                Icon(Icons.receipt, color: Colors.orange),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(resolution.transaction.description ?? 'çªå‘æ”¯å‡º'),
                      Text(resolution.transaction.categoryName,
                        style: TextStyle(color: Colors.grey, fontSize: 12)),
                    ],
                  ),
                ),
                Text('Â¥${resolution.transaction.amount.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
              ],
            ),
          ),

          SizedBox(height: 16),

          Text('é€‰æ‹©å¤„ç†æ–¹å¼:', style: TextStyle(fontWeight: FontWeight.bold)),

          SizedBox(height: 12),

          // é€‰é¡¹åˆ—è¡¨
          ...resolution.options.map((option) => _buildOptionTile(option)),
        ],
      ),
    );
  }

  Widget _buildOptionTile(ResolutionOption option) {
    final isRecommended = option.recommendation == RecommendationLevel.recommended;
    final isCautious = option.recommendation == RecommendationLevel.cautious;
    final isNotRecommended = option.recommendation == RecommendationLevel.notRecommended;

    return Card(
      margin: EdgeInsets.symmetric(vertical: 4),
      color: isRecommended ? Colors.green.shade50 :
             isNotRecommended ? Colors.grey.shade100 : null,
      child: InkWell(
        onTap: () => onSelect(option),
        child: Padding(
          padding: EdgeInsets.all(12),
          child: Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(option.description,
                          style: TextStyle(fontWeight: FontWeight.w500)),
                        if (isRecommended) ...[
                          SizedBox(width: 8),
                          Container(
                            padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                            decoration: BoxDecoration(
                              color: Colors.green,
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text('æ¨è', style: TextStyle(
                              color: Colors.white, fontSize: 10)),
                          ),
                        ],
                      ],
                    ),
                    SizedBox(height: 4),
                    Text(option.impact, style: TextStyle(
                      color: Colors.grey, fontSize: 12)),
                    if (option.warning != null)
                      Text(option.warning!, style: TextStyle(
                        color: Colors.red, fontSize: 12)),
                  ],
                ),
              ),
              Icon(Icons.chevron_right, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }
}
```

#### 9.5.2 æ”¶å…¥ä¸ç¨³å®šé€‚é…

```dart
/// ä¸ç¨³å®šæ”¶å…¥é€‚é…æœåŠ¡
class VariableIncomeAdapter {
  /// åˆ†ææ”¶å…¥æ¨¡å¼
  Future<IncomePattern> analyzeIncomePattern() async {
    final incomes = await _transactionRepo.getIncomes(months: 12);

    if (incomes.length < 3) {
      return IncomePattern.unknown;
    }

    // è®¡ç®—æ”¶å…¥ç»Ÿè®¡
    final amounts = incomes.map((i) => i.amount).toList();
    final mean = amounts.reduce((a, b) => a + b) / amounts.length;
    final variance = amounts.map((a) => pow(a - mean, 2)).reduce((a, b) => a + b) / amounts.length;
    final stdDev = sqrt(variance);
    final cv = stdDev / mean;  // å˜å¼‚ç³»æ•°

    // æ£€æµ‹å‘¨æœŸæ€§
    final hasRegularPayday = _detectRegularPayday(incomes);

    if (cv < 0.1 && hasRegularPayday) {
      return IncomePattern.stable;  // å›ºå®šå·¥èµ„
    } else if (cv < 0.3) {
      return IncomePattern.slightlyVariable;  // æœ‰ææˆæˆ–å¥–é‡‘
    } else if (hasRegularPayday) {
      return IncomePattern.variableWithBase;  // æœ‰åº•è–ª+å¤§å¹…æµ®åŠ¨
    } else {
      return IncomePattern.highlyVariable;  // è‡ªç”±èŒä¸š/åˆ›ä¸š
    }
  }

  /// ä¸ºä¸ç¨³å®šæ”¶å…¥ç”Ÿæˆé¢„ç®—å»ºè®®
  Future<VariableIncomeBudgetPlan> generateBudgetPlan() async {
    final pattern = await analyzeIncomePattern();
    final incomes = await _transactionRepo.getIncomes(months: 6);
    final amounts = incomes.map((i) => i.amount).toList();

    // è®¡ç®—ä¿å®ˆæ”¶å…¥é¢„ä¼°
    final minIncome = amounts.reduce(min);
    final medianIncome = _calculateMedian(amounts);
    final p25Income = _calculatePercentile(amounts, 25);

    double recommendedBudgetBase;
    String budgetStrategy;

    switch (pattern) {
      case IncomePattern.stable:
        recommendedBudgetBase = medianIncome;
        budgetStrategy = 'ä½¿ç”¨æœˆå‡æ”¶å…¥ä½œä¸ºé¢„ç®—åŸºå‡†';
        break;

      case IncomePattern.slightlyVariable:
        recommendedBudgetBase = p25Income;
        budgetStrategy = 'ä½¿ç”¨ä¿å®ˆä¼°è®¡(25åˆ†ä½æ•°)ä½œä¸ºåŸºå‡†ï¼Œé¢å¤–æ”¶å…¥å­˜å…¥å‚¨è“„';
        break;

      case IncomePattern.variableWithBase:
        recommendedBudgetBase = minIncome;
        budgetStrategy = 'åªç”¨"ä¿åº•æ”¶å…¥"åšé¢„ç®—ï¼Œè¶…å‡ºéƒ¨åˆ†å…¨éƒ¨å‚¨è“„';
        break;

      case IncomePattern.highlyVariable:
        recommendedBudgetBase = p25Income * 0.8;
        budgetStrategy = 'é‡‡ç”¨"å…ˆå­˜åèŠ±"ç­–ç•¥ï¼šæ”¶å…¥å…ˆå­˜å…¥ç¼“å†²è´¦æˆ·ï¼Œå†æŒ‰æœˆåº¦é¢„ç®—æ”¯å–';
        break;

      default:
        recommendedBudgetBase = medianIncome * 0.7;
        budgetStrategy = 'æ•°æ®ä¸è¶³ï¼Œå»ºè®®ä½¿ç”¨ä¿å®ˆé¢„ç®—';
    }

    return VariableIncomeBudgetPlan(
      pattern: pattern,
      incomeStats: IncomeStats(
        min: minIncome,
        max: amounts.reduce(max),
        median: medianIncome,
        p25: p25Income,
      ),
      recommendedBudgetBase: recommendedBudgetBase,
      strategy: budgetStrategy,
      tips: _getTipsForPattern(pattern),
    );
  }

  List<String> _getTipsForPattern(IncomePattern pattern) {
    switch (pattern) {
      case IncomePattern.highlyVariable:
        return [
          'ğŸ”” æ”¶å…¥åˆ°è´¦æ—¶ï¼Œå…ˆå°†50%è½¬å…¥å‚¨è“„',
          'ğŸ“… è®¾å®šæ¯æœˆå›ºå®šæ—¥æœŸä½œä¸º"å‘è–ªæ—¥"ï¼Œä»å‚¨è“„è½¬åˆ°æ¶ˆè´¹è´¦æˆ·',
          'ğŸ’¡ æ”¶å…¥å¥½çš„æœˆä»½å¤šå­˜ï¼Œä¸ºæ”¶å…¥å·®çš„æœˆä»½åšç¼“å†²',
          'ğŸ¯ ç›®æ ‡ï¼šå‚¨è“„è¦†ç›–6ä¸ªæœˆæ”¯å‡º',
        ];

      case IncomePattern.variableWithBase:
        return [
          'ğŸ“Š ç”¨åº•è–ªè¦†ç›–å¿…è¦æ”¯å‡º',
          'ğŸ’° ææˆ/å¥–é‡‘ä¼˜å…ˆå­˜å…¥åº”æ€¥é‡‘',
          'ğŸ ç­‰åº”æ€¥é‡‘è¾¾æ ‡åï¼Œå†ç”¨æµ®åŠ¨æ”¶å…¥æ”¹å–„ç”Ÿæ´»',
        ];

      default:
        return [];
    }
  }
}

/// æ”¶å…¥æ¨¡å¼æšä¸¾
enum IncomePattern {
  unknown,           // æ•°æ®ä¸è¶³
  stable,            // ç¨³å®šæ”¶å…¥ï¼ˆå¦‚å›ºå®šå·¥èµ„ï¼‰
  slightlyVariable,  // è½»å¾®æµ®åŠ¨ï¼ˆæœ‰ç»©æ•ˆå¥–é‡‘ï¼‰
  variableWithBase,  // æœ‰åº•è–ªä½†æµ®åŠ¨å¤§
  highlyVariable,    // é«˜åº¦ä¸ç¨³å®šï¼ˆè‡ªç”±èŒä¸šï¼‰
}
```

### 9.6 ä¹ æƒ¯å…»æˆæ¿€åŠ±

#### 9.6.1 è¿ç»­è®°è´¦å¥–åŠ±

```dart
/// ä¹ æƒ¯è¿½è¸ªæœåŠ¡
class HabitTrackingService {
  /// è·å–è¿ç»­è®°è´¦å¤©æ•°
  Future<StreakInfo> getRecordingStreak() async {
    final today = DateTime.now().dateOnly;
    int streak = 0;
    var checkDate = today;

    while (true) {
      final hasRecord = await _transactionRepo.hasRecordsOnDate(checkDate);
      if (hasRecord) {
        streak++;
        checkDate = checkDate.subtract(Duration(days: 1));
      } else {
        break;
      }
    }

    // è·å–å†å²æœ€é•¿è¿ç»­
    final longestStreak = await _getLongestStreak();

    // è®¡ç®—ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘
    final nextMilestone = _getNextMilestone(streak);

    return StreakInfo(
      currentStreak: streak,
      longestStreak: longestStreak,
      nextMilestone: nextMilestone,
      daysToMilestone: nextMilestone - streak,
      isNewRecord: streak > longestStreak,
    );
  }

  int _getNextMilestone(int current) {
    const milestones = [7, 14, 30, 60, 90, 180, 365];
    for (final m in milestones) {
      if (current < m) return m;
    }
    return ((current ~/ 365) + 1) * 365;
  }
}

/// è¿ç»­è®°è´¦å¾½ç« 
class StreakBadge extends StatelessWidget {
  final StreakInfo streak;

  @override
  Widget build(BuildContext context) {
    final badgeColor = _getBadgeColor(streak.currentStreak);
    final badgeIcon = _getBadgeIcon(streak.currentStreak);

    return Container(
      padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [badgeColor.withOpacity(0.8), badgeColor],
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: badgeColor.withOpacity(0.3),
            blurRadius: 8,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(badgeIcon, color: Colors.white, size: 28),
          SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Text('${streak.currentStreak}',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    )),
                  Text(' å¤©è¿ç»­è®°è´¦',
                    style: TextStyle(color: Colors.white)),
                ],
              ),
              Text('è·ç¦»${streak.nextMilestone}å¤©è¿˜å·®${streak.daysToMilestone}å¤©',
                style: TextStyle(color: Colors.white70, fontSize: 12)),
            ],
          ),
          if (streak.isNewRecord) ...[
            SizedBox(width: 12),
            Container(
              padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: Colors.amber,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Text('æ–°çºªå½•!', style: TextStyle(
                color: Colors.black87,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              )),
            ),
          ],
        ],
      ),
    );
  }

  Color _getBadgeColor(int days) {
    if (days >= 365) return Colors.purple;
    if (days >= 90) return Colors.amber.shade700;
    if (days >= 30) return Colors.blue;
    if (days >= 7) return Colors.green;
    return Colors.grey;
  }

  IconData _getBadgeIcon(int days) {
    if (days >= 365) return Icons.military_tech;
    if (days >= 90) return Icons.workspace_premium;
    if (days >= 30) return Icons.emoji_events;
    if (days >= 7) return Icons.local_fire_department;
    return Icons.timer;
  }
}
```

#### 9.6.2 è´¢åŠ¡å¥åº·åˆ†æ•°

```dart
/// è´¢åŠ¡å¥åº·è¯„åˆ†æœåŠ¡
class FinancialHealthScoreService {
  /// è®¡ç®—ç»¼åˆè´¢åŠ¡å¥åº·åˆ†
  Future<FinancialHealthScore> calculateScore() async {
    final scores = <String, ScoreComponent>{};

    // 1. é’±é¾„å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final moneyAge = await _moneyAgeService.getCurrentAge();
    scores['moneyAge'] = ScoreComponent(
      name: 'é’±é¾„',
      score: _scoreMoneyAge(moneyAge),
      maxScore: 20,
      status: _getMoneyAgeStatus(moneyAge),
      tip: _getMoneyAgeTip(moneyAge),
    );

    // 2. é¢„ç®—æ§åˆ¶å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final budgetAdherence = await _getBudgetAdherence();
    scores['budget'] = ScoreComponent(
      name: 'é¢„ç®—æ§åˆ¶',
      score: _scoreBudgetAdherence(budgetAdherence),
      maxScore: 20,
      status: budgetAdherence > 0.9 ? 'ä¼˜ç§€' : budgetAdherence > 0.7 ? 'è‰¯å¥½' : 'éœ€æ”¹è¿›',
      tip: budgetAdherence < 0.7 ? 'å»ºè®®å®¡è§†è¶…æ”¯åˆ†ç±»ï¼Œè°ƒæ•´é¢„ç®—æˆ–æ¶ˆè´¹ä¹ æƒ¯' : null,
    );

    // 3. åº”æ€¥é‡‘å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final emergencyProgress = await _getEmergencyFundProgress();
    scores['emergency'] = ScoreComponent(
      name: 'åº”æ€¥é‡‘',
      score: (emergencyProgress * 20).round(),
      maxScore: 20,
      status: emergencyProgress >= 1 ? 'è¾¾æ ‡' : 'å»ºè®¾ä¸­',
      tip: emergencyProgress < 0.5 ? 'å»ºè®®ä¼˜å…ˆç§¯ç´¯åº”æ€¥é‡‘' : null,
    );

    // 4. æ¶ˆè´¹ç»“æ„å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final necessityReport = await _necessityAnalyzer.analyzeSpendingStructure();
    scores['structure'] = ScoreComponent(
      name: 'æ¶ˆè´¹ç»“æ„',
      score: (necessityReport.healthScore * 0.2).round(),
      maxScore: 20,
      status: necessityReport.healthScore > 80 ? 'å¥åº·' : 'å¾…ä¼˜åŒ–',
      tip: necessityReport.optionalPercentage > 0.3 ? 'å¯é€‰æ¶ˆè´¹å æ¯”è¾ƒé«˜' : null,
    );

    // 5. è®°è´¦ä¹ æƒ¯å¾—åˆ†ï¼ˆ0-20åˆ†ï¼‰
    final streak = await _habitTracker.getRecordingStreak();
    final recordingConsistency = await _getRecordingConsistency();
    scores['habit'] = ScoreComponent(
      name: 'è®°è´¦ä¹ æƒ¯',
      score: _scoreRecordingHabit(streak.currentStreak, recordingConsistency),
      maxScore: 20,
      status: streak.currentStreak >= 30 ? 'åšæŒä¸­' : 'éœ€åŠ æ²¹',
      tip: streak.currentStreak < 7 ? 'å…»æˆæ¯æ—¥è®°è´¦ä¹ æƒ¯æ˜¯è´¢åŠ¡ç®¡ç†çš„åŸºç¡€' : null,
    );

    // è®¡ç®—æ€»åˆ†
    final totalScore = scores.values.fold(0, (sum, c) => sum + c.score);
    final maxScore = scores.values.fold(0, (sum, c) => sum + c.maxScore);

    return FinancialHealthScore(
      totalScore: totalScore,
      maxScore: maxScore,
      percentage: totalScore / maxScore,
      level: _getLevel(totalScore),
      components: scores,
      primaryImprovementArea: _findWeakestArea(scores),
      comparisonToLastMonth: await _compareToLastMonth(totalScore),
    );
  }

  String _getLevel(int score) {
    if (score >= 90) return 'è´¢åŠ¡ä¼˜ç­‰ç”Ÿ';
    if (score >= 75) return 'è´¢åŠ¡è‰¯å¥½';
    if (score >= 60) return 'è´¢åŠ¡åŠæ ¼';
    if (score >= 40) return 'éœ€è¦åŠªåŠ›';
    return 'è´¢åŠ¡é¢„è­¦';
  }

  int _scoreMoneyAge(int days) {
    if (days >= 60) return 20;
    if (days >= 30) return 16;
    if (days >= 14) return 12;
    if (days >= 7) return 8;
    return (days * 8 / 7).round();
  }
}

/// è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜
class FinancialHealthDashboard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final score = ref.watch(financialHealthScoreProvider);

    return score.when(
      data: (data) => Card(
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              // æ€»åˆ†å±•ç¤º
              Row(
                children: [
                  _buildScoreGauge(data),
                  SizedBox(width: 20),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(data.level, style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        )),
                        if (data.comparisonToLastMonth != 0)
                          Row(
                            children: [
                              Icon(
                                data.comparisonToLastMonth > 0
                                    ? Icons.trending_up
                                    : Icons.trending_down,
                                color: data.comparisonToLastMonth > 0
                                    ? Colors.green
                                    : Colors.red,
                                size: 16,
                              ),
                              Text(
                                'è¾ƒä¸Šæœˆ${data.comparisonToLastMonth > 0 ? '+' : ''}${data.comparisonToLastMonth}åˆ†',
                                style: TextStyle(
                                  color: data.comparisonToLastMonth > 0
                                      ? Colors.green
                                      : Colors.red,
                                ),
                              ),
                            ],
                          ),
                      ],
                    ),
                  ),
                ],
              ),

              SizedBox(height: 20),

              // å„é¡¹å¾—åˆ†
              ...data.components.entries.map((e) => _buildScoreItem(e.value)),

              SizedBox(height: 16),

              // æ”¹è¿›å»ºè®®
              if (data.primaryImprovementArea != null)
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.amber.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.tips_and_updates, color: Colors.amber.shade700),
                      SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text('ä¼˜å…ˆæ”¹è¿›: ${data.primaryImprovementArea!.name}',
                              style: TextStyle(fontWeight: FontWeight.bold)),
                            if (data.primaryImprovementArea!.tip != null)
                              Text(data.primaryImprovementArea!.tip!,
                                style: TextStyle(fontSize: 13)),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
            ],
          ),
        ),
      ),
      loading: () => CircularProgressIndicator(),
      error: (e, _) => Text('Error: $e'),
    );
  }
}
```

#### 9.6.3 åŒ…å®¹æ€§è®°è´¦æ¿€åŠ±

é¼“åŠ±æŒç»­è®°å½•è€Œéè¿½æ±‚å®Œç¾ï¼Œè®©ä¸­æ–­åçš„ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾å›å½’ã€‚

```dart
/// åŒ…å®¹æ€§æ¿€åŠ±æœåŠ¡
class InclusiveMotivationService {
  /// åˆ†æç”¨æˆ·è®°è´¦æ¨¡å¼å¹¶ç”ŸæˆåŒ…å®¹æ€§åé¦ˆ
  Future<MotivationFeedback> generateFeedback() async {
    final today = DateTime.now();
    final recordingDays = await _getRecordingDaysInMonth(today);
    final totalDays = today.day;
    final recordingRate = recordingDays / totalDays;

    // æ£€æµ‹ä¸­æ–­æƒ…å†µ
    final lastRecordDate = await _getLastRecordDate();
    final gapDays = lastRecordDate != null
        ? today.difference(lastRecordDate).inDays
        : 999;

    // æ ¹æ®ä¸åŒæƒ…å†µç”Ÿæˆåé¦ˆ
    if (gapDays == 0) {
      return _generateActiveUserFeedback(recordingDays, recordingRate);
    } else if (gapDays <= 3) {
      return _generateShortGapFeedback(gapDays, recordingDays);
    } else if (gapDays <= 7) {
      return _generateMediumGapFeedback(gapDays);
    } else {
      return _generateLongGapFeedback(gapDays, lastRecordDate);
    }
  }

  /// çŸ­æš‚ä¸­æ–­ï¼ˆ1-3å¤©ï¼‰çš„åé¦ˆ
  MotivationFeedback _generateShortGapFeedback(int gapDays, int recordedDays) {
    return MotivationFeedback(
      type: FeedbackType.encouragement,
      icon: Icons.wb_sunny,
      primaryMessage: 'æ¬¢è¿å›æ¥ï¼',
      secondaryMessage: gapDays == 1
          ? 'æ˜¨å¤©æ²¡è®°ä¹Ÿæ²¡å…³ç³»ï¼Œé‡è¦çš„æ˜¯ä»Šå¤©ç»§ç»­'
          : 'ä¼‘æ¯äº†$gapDayså¤©ï¼Œç°åœ¨ç»§ç»­å°±å¥½',
      encouragement: 'æœ¬æœˆå·²è®°å½•$recordedDayså¤©ï¼Œä¿æŒèŠ‚å¥å°±å¾ˆæ£’ï¼',
      showQuickEntry: true,
      quickEntryPrompt: 'å¿«é€Ÿè¡¥è®°è¿™å‡ å¤©çš„æ”¯å‡ºï¼Ÿ',
      actions: [
        MotivationAction(
          label: 'å¼€å§‹è®°å½•',
          type: ActionType.startRecording,
          isPrimary: true,
        ),
        MotivationAction(
          label: 'è¡¥è®°æ˜¨å¤©',
          type: ActionType.backfillYesterday,
        ),
      ],
    );
  }

  /// ä¸­ç­‰ä¸­æ–­ï¼ˆ4-7å¤©ï¼‰çš„åé¦ˆ
  MotivationFeedback _generateMediumGapFeedback(int gapDays) {
    return MotivationFeedback(
      type: FeedbackType.welcomeBack,
      icon: Icons.favorite,
      primaryMessage: 'å¥½ä¹…ä¸è§ï¼',
      secondaryMessage: 'ä¸­æ–­$gapDayså¤©ä¸ç®—ä»€ä¹ˆï¼Œèƒ½å›æ¥å°±æ˜¯èƒœåˆ©',
      encouragement: 'ä¸éœ€è¦è¡¥å…¨æ‰€æœ‰è®°å½•ï¼Œä»ä»Šå¤©å¼€å§‹å°±å¥½',
      showQuickEntry: true,
      quickEntryPrompt: 'è®°ä¸€ç¬”ä»Šå¤©çš„æ¶ˆè´¹ï¼Œé‡æ–°å¼€å§‹',
      tips: [
        'ä¸ç”¨çº ç»“é—æ¼çš„è®°å½•ï¼Œå¤§ä½“äº†è§£å³å¯',
        'å¯ä»¥è®°ä¸ªå¤§æ¦‚æ•°å­—ï¼Œæ¯”å®Œç¾ä¸»ä¹‰æ›´é‡è¦çš„æ˜¯æŒç»­',
      ],
      actions: [
        MotivationAction(
          label: 'ä»ä»Šå¤©å¼€å§‹',
          type: ActionType.startRecording,
          isPrimary: true,
        ),
        MotivationAction(
          label: 'å¿«é€Ÿä¼°ç®—è¿™å‘¨',
          type: ActionType.quickEstimate,
        ),
      ],
    );
  }

  /// é•¿æœŸä¸­æ–­ï¼ˆ>7å¤©ï¼‰çš„åé¦ˆ
  MotivationFeedback _generateLongGapFeedback(
    int gapDays,
    DateTime? lastRecordDate,
  ) {
    return MotivationFeedback(
      type: FeedbackType.freshStart,
      icon: Icons.refresh,
      primaryMessage: 'é‡æ–°å¼€å§‹ï¼Œæ°¸è¿œä¸æ™šï¼',
      secondaryMessage: lastRecordDate != null
          ? 'ä¸Šæ¬¡è®°å½•æ˜¯${_formatDate(lastRecordDate)}ï¼Œæ²¡å…³ç³»'
          : 'è®©æˆ‘ä»¬ä¸€èµ·å¼€å§‹æ–°çš„è®°è´¦æ—…ç¨‹',
      encouragement: 'æ¯ä¸€æ¬¡å›å½’éƒ½æ˜¯æ–°çš„èµ·ç‚¹',
      showQuickEntry: true,
      quickEntryPrompt: 'ä¸ç”¨ç®¡ä¹‹å‰çš„ï¼Œå°±è®°ä»Šå¤©çš„',
      tips: [
        'è¿‡å»çš„ä¸å¿…è¿½ç©¶ï¼Œæœªæ¥çš„æ¯ä¸€å¤©æ‰é‡è¦',
        '80%çš„è®°å½•ç‡å°±å·²ç»å¾ˆæ£’äº†',
        'ç®€å•è®°å½• > ä¸è®°å½• > è¿½æ±‚å®Œç¾è€Œæ”¾å¼ƒ',
      ],
      freshStartOptions: [
        FreshStartOption(
          label: 'æ–°çš„ä¸€å‘¨ï¼Œæ–°çš„å¼€å§‹',
          description: 'ä»æœ¬å‘¨ä¸€å¼€å§‹è®°å½•',
          startDate: _getThisMonday(),
        ),
        FreshStartOption(
          label: 'æ–°çš„ä¸€æœˆï¼Œæ–°çš„å¼€å§‹',
          description: 'ä»æœ¬æœˆ1å·å¼€å§‹è®°å½•',
          startDate: _getFirstDayOfMonth(),
        ),
        FreshStartOption(
          label: 'å°±ä»ä»Šå¤©å¼€å§‹',
          description: 'ä¸ç®¡ä¹‹å‰ï¼Œä»ä»Šå¤©è®°èµ·',
          startDate: DateTime.now(),
        ),
      ],
      actions: [
        MotivationAction(
          label: 'é‡æ–°å¼€å§‹',
          type: ActionType.freshStart,
          isPrimary: true,
        ),
      ],
    );
  }
}

/// çµæ´»çš„è®°è´¦ç‡ç›®æ ‡
class FlexibleRecordingGoal {
  /// æ ¹æ®ç”¨æˆ·å†å²è®¾å®šå¯è¾¾æˆçš„ç›®æ ‡
  static RecordingGoal calculateRealisticGoal(RecordingHistory history) {
    // è®¡ç®—ç”¨æˆ·å®é™…çš„è®°å½•ç‡
    final actualRate = history.averageRecordingRate;

    // è®¾å®šç¨é«˜äºå®é™…çš„ç›®æ ‡ï¼ˆ10%æå‡ï¼‰
    final targetRate = (actualRate + 0.1).clamp(0.5, 1.0);

    // è½¬æ¢ä¸ºå‹å¥½çš„è¡¨è¾¾
    String goalDescription;
    if (targetRate >= 0.9) {
      goalDescription = 'æ¯å¤©è®°å½•';
    } else if (targetRate >= 0.8) {
      goalDescription = 'ä¸€å‘¨è®°5-6å¤©';
    } else if (targetRate >= 0.7) {
      goalDescription = 'ä¸€å‘¨è®°5å¤©';
    } else if (targetRate >= 0.5) {
      goalDescription = 'ä¸€å‘¨è®°3-4å¤©';
    } else {
      goalDescription = 'ä¸€å‘¨è‡³å°‘è®°2å¤©';
    }

    return RecordingGoal(
      targetRate: targetRate,
      description: goalDescription,
      previousRate: actualRate,
      achievementMessage: 'ä½ è®¾å®šçš„ç›®æ ‡æ˜¯"$goalDescription"ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ï¼',
    );
  }
}

/// ä¸­æ–­æ¢å¤åŠ©æ‰‹
class BreakRecoveryAssistant {
  /// ç”Ÿæˆå¿«é€Ÿä¼°ç®—å»ºè®®
  Future<QuickEstimateGuide> generateQuickEstimate(int missedDays) async {
    // è·å–ç”¨æˆ·çš„æ¶ˆè´¹æ¨¡å¼
    final patterns = await _getSpendingPatterns();
    final avgDailySpending = patterns.averageDailySpending;

    // ç”Ÿæˆä¼°ç®—å»ºè®®
    final estimatedTotal = avgDailySpending * missedDays;

    return QuickEstimateGuide(
      missedDays: missedDays,
      estimatedTotal: estimatedTotal,
      suggestion: 'æ ¹æ®ä½ çš„æ¶ˆè´¹ä¹ æƒ¯ï¼Œè¿™${missedDays}å¤©å¤§çº¦èŠ±äº†'
                  ' Â¥${estimatedTotal.toStringAsFixed(0)}',
      quickCategories: patterns.topCategories.take(5).map((c) =>
        QuickCategoryEstimate(
          category: c.name,
          suggestedAmount: c.dailyAverage * missedDays,
          adjustable: true,
        )
      ).toList(),
      confirmMessage: 'è¿™åªæ˜¯ä¼°ç®—ï¼Œå¤§ä½“äº†è§£å°±å¥½ï¼Œä¸å¿…ç²¾ç¡®',
    );
  }

  /// ç”Ÿæˆæ¢å¤è®¡åˆ’
  RecoveryPlan generateRecoveryPlan(int gapDays) {
    if (gapDays <= 3) {
      return RecoveryPlan(
        type: RecoveryType.quick,
        title: 'å¿«é€Ÿå›å½’',
        steps: [
          'è®°å½•ä»Šå¤©çš„æ¶ˆè´¹',
          'å¦‚æœè®°å¾—ï¼Œè¡¥è®°æ˜¨å¤©çš„å¤§é¢æ¶ˆè´¹',
          'å®Œæˆï¼ä¸å¿…è¿½ç©¶æ›´æ—©çš„',
        ],
        estimatedTime: Duration(minutes: 2),
      );
    } else if (gapDays <= 7) {
      return RecoveryPlan(
        type: RecoveryType.moderate,
        title: 'è½»æ¾æ¢å¤',
        steps: [
          'ä»ä»Šå¤©å¼€å§‹è®°å½•',
          'å¯é€‰ï¼šå¿«é€Ÿä¼°ç®—æœ¬å‘¨æ€»æ¶ˆè´¹',
          'è®¾ä¸ªæé†’ï¼Œæ˜å¤©ç»§ç»­',
        ],
        estimatedTime: Duration(minutes: 5),
      );
    } else {
      return RecoveryPlan(
        type: RecoveryType.freshStart,
        title: 'å…¨æ–°å¼€å§‹',
        steps: [
          'é€‰æ‹©ä¸€ä¸ªå¼€å§‹æ—¥æœŸï¼ˆä»Šå¤©/æœ¬å‘¨ä¸€/æœ¬æœˆ1å·ï¼‰',
          'åªè®°å½•ä»é‚£å¤©èµ·çš„æ¶ˆè´¹',
          'ä¹‹å‰çš„å°±å½“ç¿»ç¯‡äº†',
        ],
        estimatedTime: Duration(minutes: 1),
        encouragement: 'è¿‡å»ä¸é‡è¦ï¼Œæ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹',
      );
    }
  }
}

/// æ¿€åŠ±åé¦ˆç±»å‹
enum FeedbackType {
  encouragement,  // é¼“åŠ±
  welcomeBack,    // æ¬¢è¿å›æ¥
  freshStart,     // å…¨æ–°å¼€å§‹
  celebration,    // åº†ç¥
}

/// æ¢å¤è®¡åˆ’ç±»å‹
enum RecoveryType {
  quick,      // å¿«é€Ÿå›å½’
  moderate,   // è½»æ¾æ¢å¤
  freshStart, // å…¨æ–°å¼€å§‹
}

/// ä¸­æ–­æ¢å¤æç¤ºå¡ç‰‡
class BreakRecoveryCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final feedback = ref.watch(motivationFeedbackProvider);

    return feedback.when(
      data: (data) {
        // ä»Šå¤©å·²è®°å½•åˆ™ä¸æ˜¾ç¤º
        if (data.type == FeedbackType.celebration) {
          return SizedBox.shrink();
        }

        return Card(
          color: _getCardColor(data.type),
          child: Padding(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(data.icon, color: _getIconColor(data.type), size: 28),
                    SizedBox(width: 12),
                    Text(data.primaryMessage,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: _getTextColor(data.type),
                      )),
                  ],
                ),
                SizedBox(height: 8),
                Text(data.secondaryMessage,
                  style: TextStyle(color: _getSecondaryTextColor(data.type))),

                if (data.encouragement != null) ...[
                  SizedBox(height: 12),
                  Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.5),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      children: [
                        Icon(Icons.emoji_events, color: Colors.amber, size: 20),
                        SizedBox(width: 8),
                        Expanded(child: Text(data.encouragement!)),
                      ],
                    ),
                  ),
                ],

                // å°è´´å£«
                if (data.tips != null && data.tips!.isNotEmpty) ...[
                  SizedBox(height: 12),
                  ...data.tips!.map((tip) => Padding(
                    padding: EdgeInsets.symmetric(vertical: 2),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('ğŸ’¡ ', style: TextStyle(fontSize: 12)),
                        Expanded(child: Text(tip, style: TextStyle(fontSize: 13))),
                      ],
                    ),
                  )),
                ],

                SizedBox(height: 16),

                // æ“ä½œæŒ‰é’®
                Row(
                  children: data.actions.map((action) =>
                    Expanded(
                      child: Padding(
                        padding: EdgeInsets.symmetric(horizontal: 4),
                        child: action.isPrimary
                            ? ElevatedButton(
                                onPressed: () => _handleAction(context, action),
                                child: Text(action.label),
                              )
                            : OutlinedButton(
                                onPressed: () => _handleAction(context, action),
                                child: Text(action.label),
                              ),
                      ),
                    ),
                  ).toList(),
                ),
              ],
            ),
          ),
        );
      },
      loading: () => SizedBox.shrink(),
      error: (_, __) => SizedBox.shrink(),
    );
  }

  Color _getCardColor(FeedbackType type) {
    switch (type) {
      case FeedbackType.encouragement:
        return Colors.green.shade50;
      case FeedbackType.welcomeBack:
        return Colors.blue.shade50;
      case FeedbackType.freshStart:
        return Colors.purple.shade50;
      default:
        return Colors.grey.shade50;
    }
  }
}
```

#### 9.6.4 ç¤¾ä¼šè®¤åŒå‚ç…§

åˆ©ç”¨"ç¤¾ä¼šè®¤åŒ"å¿ƒç†ï¼Œå±•ç¤ºåŒç±»å‹ç”¨æˆ·çš„æ¶ˆè´¹æ°´å¹³ï¼Œå¸®åŠ©ç”¨æˆ·å»ºç«‹åˆç†çš„æ¶ˆè´¹æ ‡å‡†ã€‚

```dart
/// ç¤¾ä¼šè®¤åŒå¯¹æ¯”æœåŠ¡
class SocialComparisonService {
  /// è·å–åŒç±»å‹ç”¨æˆ·çš„æ¶ˆè´¹æ°´å¹³å¯¹æ¯”
  Future<PeerComparisonReport> getPeerComparison() async {
    final userProfile = await _getUserProfile();
    final userSpending = await _getUserMonthlySpending();

    // åŸºäºç”¨æˆ·ç‰¹å¾åŒ¹é…åŒç±»ç¾¤ä½“ï¼ˆæœ¬åœ°è®¡ç®—ï¼Œä¿æŠ¤éšç§ï¼‰
    final peerGroup = _determinePeerGroup(userProfile);

    // è·å–è¯¥ç¾¤ä½“çš„åŒ¿åç»Ÿè®¡æ•°æ®ï¼ˆä»æœåŠ¡å™¨è·å–èšåˆæ•°æ®ï¼‰
    final peerStats = await _getPeerStatistics(peerGroup);

    return PeerComparisonReport(
      userProfile: userProfile,
      peerGroup: peerGroup,
      comparisons: _generateComparisons(userSpending, peerStats),
      insights: _generateInsights(userSpending, peerStats),
      privacyNote: 'æ•°æ®æ¥è‡ªåŒ¿åç»Ÿè®¡ï¼Œæˆ‘ä»¬ä¸ä¼šæ”¶é›†æ‚¨çš„ä¸ªäººæ¶ˆè´¹æ˜ç»†',
    );
  }

  /// ç¡®å®šç”¨æˆ·æ‰€å±çš„åŒç±»ç¾¤ä½“
  PeerGroup _determinePeerGroup(UserProfile profile) {
    // åŸºäºåŸå¸‚çº§åˆ«ã€æ”¶å…¥åŒºé—´ã€å¹´é¾„æ®µç­‰ç‰¹å¾åˆ†ç»„
    return PeerGroup(
      cityTier: profile.cityTier,           // ä¸€äºŒä¸‰çº¿åŸå¸‚
      incomeRange: profile.incomeRange,     // æ”¶å…¥åŒºé—´
      lifeStage: profile.lifeStage,         // å­¦ç”Ÿ/èŒåœºæ–°äºº/å·²å©šç­‰
      description: _generateGroupDescription(profile),
    );
  }

  /// ç”Ÿæˆå¯¹æ¯”æ•°æ®
  List<SpendingComparison> _generateComparisons(
    UserSpending userSpending,
    PeerStatistics peerStats,
  ) {
    final comparisons = <SpendingComparison>[];

    // æ€»ä½“æ¶ˆè´¹å¯¹æ¯”
    comparisons.add(SpendingComparison(
      category: 'æœˆæ€»æ”¯å‡º',
      userAmount: userSpending.totalMonthly,
      peerMedian: peerStats.medianMonthlySpending,
      peerP25: peerStats.p25MonthlySpending,
      peerP75: peerStats.p75MonthlySpending,
      userPercentile: _calculatePercentile(
        userSpending.totalMonthly,
        peerStats.spendingDistribution,
      ),
    ));

    // å„ç±»åˆ«å¯¹æ¯”
    for (final category in userSpending.byCategory.keys) {
      final userAmount = userSpending.byCategory[category]!;
      final peerCategoryStats = peerStats.byCategoryStats[category];

      if (peerCategoryStats != null) {
        comparisons.add(SpendingComparison(
          category: category,
          userAmount: userAmount,
          peerMedian: peerCategoryStats.median,
          peerP25: peerCategoryStats.p25,
          peerP75: peerCategoryStats.p75,
          userPercentile: _calculatePercentile(
            userAmount,
            peerCategoryStats.distribution,
          ),
        ));
      }
    }

    return comparisons;
  }

  /// ç”Ÿæˆæ´å¯Ÿå»ºè®®
  List<ComparisonInsight> _generateInsights(
    UserSpending userSpending,
    PeerStatistics peerStats,
  ) {
    final insights = <ComparisonInsight>[];

    // æ‰¾å‡ºæ˜æ˜¾é«˜äºåŒç±»çš„æ¶ˆè´¹ç±»åˆ«
    for (final category in userSpending.byCategory.keys) {
      final userAmount = userSpending.byCategory[category]!;
      final peerCategoryStats = peerStats.byCategoryStats[category];

      if (peerCategoryStats != null) {
        final ratio = userAmount / peerCategoryStats.median;

        if (ratio > 1.5) {
          insights.add(ComparisonInsight(
            type: InsightType.aboveAverage,
            category: category,
            message: '${category}æ”¯å‡ºé«˜äºåŒç±»ç”¨æˆ·${((ratio - 1) * 100).toStringAsFixed(0)}%',
            suggestion: 'å¯ä»¥çœ‹çœ‹æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´',
            severity: ratio > 2 ? InsightSeverity.high : InsightSeverity.medium,
          ));
        } else if (ratio < 0.5) {
          insights.add(ComparisonInsight(
            type: InsightType.belowAverage,
            category: category,
            message: '${category}æ”¯å‡ºä½äºåŒç±»ç”¨æˆ·${((1 - ratio) * 100).toStringAsFixed(0)}%',
            suggestion: 'æ§åˆ¶å¾—ä¸é”™ï¼ç»§ç»­ä¿æŒ',
            severity: InsightSeverity.positive,
          ));
        }
      }
    }

    // å‚¨è“„ç‡å¯¹æ¯”
    final userSavingsRate = userSpending.savingsRate;
    final peerSavingsRate = peerStats.medianSavingsRate;

    if (userSavingsRate > peerSavingsRate) {
      insights.add(ComparisonInsight(
        type: InsightType.positive,
        category: 'å‚¨è“„ç‡',
        message: 'ä½ çš„å‚¨è“„ç‡${(userSavingsRate * 100).toStringAsFixed(0)}%ï¼Œ'
                 'é«˜äºåŒç±»ç”¨æˆ·å¹³å‡çš„${(peerSavingsRate * 100).toStringAsFixed(0)}%',
        suggestion: 'è´¢åŠ¡å¥åº·åº¦å¾ˆå¥½ï¼',
        severity: InsightSeverity.positive,
      ));
    }

    return insights;
  }
}

/// åŒç±»ç¾¤ä½“å®šä¹‰
class PeerGroup {
  final CityTier cityTier;
  final IncomeRange incomeRange;
  final LifeStage lifeStage;
  final String description;
}

enum CityTier { firstTier, secondTier, thirdTier, other }
enum IncomeRange { under5k, from5kTo10k, from10kTo20k, from20kTo50k, above50k }
enum LifeStage { student, youngProfessional, established, family, retirement }

/// æ¶ˆè´¹å¯¹æ¯”æ•°æ®
class SpendingComparison {
  final String category;
  final double userAmount;
  final double peerMedian;
  final double peerP25;  // 25åˆ†ä½ï¼ˆèŠ‚ä¿­å‹ï¼‰
  final double peerP75;  // 75åˆ†ä½ï¼ˆå®½è£•å‹ï¼‰
  final int userPercentile;  // ç”¨æˆ·åœ¨ç¾¤ä½“ä¸­çš„ä½ç½®

  /// ç”¨æˆ·ç›¸å¯¹äºä¸­ä½æ•°çš„ä½ç½®æè¿°
  String get positionDescription {
    if (userPercentile <= 25) return 'èŠ‚ä¿­å‹';
    if (userPercentile <= 50) return 'èŠ‚çº¦å‹';
    if (userPercentile <= 75) return 'é€‚ä¸­å‹';
    return 'å®½è£•å‹';
  }
}

/// åŒç±»å¯¹æ¯”å¡ç‰‡
class PeerComparisonCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final report = ref.watch(peerComparisonProvider);

    return report.when(
      data: (data) => Card(
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Icon(Icons.people_outline, color: Colors.blue),
                  SizedBox(width: 8),
                  Text('åŒç±»ç”¨æˆ·å¯¹æ¯”', style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  )),
                  Spacer(),
                  Tooltip(
                    message: data.privacyNote,
                    child: Icon(Icons.info_outline, size: 18, color: Colors.grey),
                  ),
                ],
              ),

              SizedBox(height: 8),
              Text(
                'ä¸${data.peerGroup.description}ç›¸æ¯”',
                style: TextStyle(color: Colors.grey, fontSize: 13),
              ),

              SizedBox(height: 16),

              // æ€»ä½“æ¶ˆè´¹ä½ç½®
              _buildOverallPosition(data.comparisons.first),

              SizedBox(height: 16),

              // å„ç±»åˆ«å¯¹æ¯”ï¼ˆä»…æ˜¾ç¤ºåç¦»è¾ƒå¤§çš„ï¼‰
              ...data.insights.take(3).map((insight) =>
                _buildInsightItem(insight),
              ),

              SizedBox(height: 12),

              // æŸ¥çœ‹è¯¦æƒ…
              Center(
                child: TextButton(
                  onPressed: () => _showDetailedComparison(context, data),
                  child: Text('æŸ¥çœ‹è¯¦ç»†å¯¹æ¯”'),
                ),
              ),
            ],
          ),
        ),
      ),
      loading: () => SizedBox.shrink(),
      error: (_, __) => SizedBox.shrink(),
    );
  }

  Widget _buildOverallPosition(SpendingComparison overall) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.blue.shade50,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: [
          Text('ä½ çš„æœˆæ”¯å‡ºæ°´å¹³', style: TextStyle(fontSize: 12, color: Colors.grey)),
          SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                overall.positionDescription,
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.blue,
                ),
              ),
              SizedBox(width: 8),
              Text(
                '(å‰${overall.userPercentile}%)',
                style: TextStyle(color: Colors.grey),
              ),
            ],
          ),
          SizedBox(height: 12),
          // ä½ç½®å¯è§†åŒ–æ¡
          _buildPercentileBar(overall.userPercentile),
          SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text('èŠ‚ä¿­', style: TextStyle(fontSize: 10, color: Colors.grey)),
              Text('é€‚ä¸­', style: TextStyle(fontSize: 10, color: Colors.grey)),
              Text('å®½è£•', style: TextStyle(fontSize: 10, color: Colors.grey)),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildPercentileBar(int percentile) {
    return Stack(
      children: [
        Container(
          height: 8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [Colors.green, Colors.yellow, Colors.orange],
            ),
            borderRadius: BorderRadius.circular(4),
          ),
        ),
        Positioned(
          left: (percentile / 100) * 200 - 6,  // å‡è®¾å®½åº¦200
          child: Container(
            width: 12,
            height: 12,
            decoration: BoxDecoration(
              color: Colors.blue,
              shape: BoxShape.circle,
              border: Border.all(color: Colors.white, width: 2),
            ),
          ),
        ),
      ],
    );
  }
}
```

#### 9.6.5 æ‰¿è¯ºä¸€è‡´æœºåˆ¶

åˆ©ç”¨"æ‰¿è¯ºä¸€è‡´"å¿ƒç†ï¼Œè®©ç”¨æˆ·ä¸»åŠ¨åšå‡ºè´¢åŠ¡æ‰¿è¯ºï¼Œå¹¶æŒç»­æé†’å’Œè¿½è¸ªã€‚

```dart
/// è´¢åŠ¡æ‰¿è¯ºæœåŠ¡
class FinancialCommitmentService {
  /// åˆ›å»ºè´¢åŠ¡æ‰¿è¯º
  Future<FinancialCommitment> createCommitment({
    required CommitmentType type,
    required String description,
    required double targetAmount,
    required DateTime deadline,
    bool isPublic = false,  // æ˜¯å¦å…¬å¼€ï¼ˆå¢åŠ ç¤¾ä¼šå‹åŠ›ï¼‰
  }) async {
    final commitment = FinancialCommitment(
      id: Uuid().v4(),
      type: type,
      description: description,
      targetAmount: targetAmount,
      deadline: deadline,
      createdAt: DateTime.now(),
      isPublic: isPublic,
      status: CommitmentStatus.active,
    );

    await _commitmentRepo.save(commitment);

    // è®¾ç½®å®šæœŸæé†’
    await _scheduleReminders(commitment);

    return commitment;
  }

  /// è·å–æ¨èçš„æ‰¿è¯º
  Future<List<CommitmentSuggestion>> getSuggestedCommitments() async {
    final suggestions = <CommitmentSuggestion>[];
    final userStats = await _getUserFinancialStats();

    // æ ¹æ®ç”¨æˆ·çŠ¶å†µæ¨èæ‰¿è¯º
    if (userStats.savingsRate < 0.1) {
      suggestions.add(CommitmentSuggestion(
        type: CommitmentType.savingsRate,
        title: 'å‚¨è“„ç‡æ‰¿è¯º',
        description: 'æ‰¿è¯ºæ¯æœˆå‚¨è“„æ”¶å…¥çš„10%',
        targetValue: 0.1,
        rationale: 'ç›®å‰å‚¨è“„ç‡è¾ƒä½ï¼Œå»ºè®®ä»10%å¼€å§‹',
        difficulty: CommitmentDifficulty.moderate,
      ));
    }

    if (userStats.recordingRate < 0.7) {
      suggestions.add(CommitmentSuggestion(
        type: CommitmentType.recordingFrequency,
        title: 'è®°è´¦ä¹ æƒ¯æ‰¿è¯º',
        description: 'æ‰¿è¯ºæ¯å‘¨è‡³å°‘è®°è´¦5å¤©',
        targetValue: 5,
        rationale: 'å…»æˆè®°è´¦ä¹ æƒ¯æ˜¯è´¢åŠ¡ç®¡ç†çš„åŸºç¡€',
        difficulty: CommitmentDifficulty.easy,
      ));
    }

    final topExpenseCategory = userStats.topExpenseCategory;
    if (topExpenseCategory != null && topExpenseCategory.isOptional) {
      suggestions.add(CommitmentSuggestion(
        type: CommitmentType.categoryLimit,
        title: '${topExpenseCategory.name}æ§åˆ¶æ‰¿è¯º',
        description: 'æ‰¿è¯ºæœ¬æœˆ${topExpenseCategory.name}æ”¯å‡ºä¸è¶…è¿‡Â¥${(topExpenseCategory.lastMonthAmount * 0.8).toStringAsFixed(0)}',
        targetValue: topExpenseCategory.lastMonthAmount * 0.8,
        rationale: 'è¿™æ˜¯ä½ æœ€å¤§çš„å¯é€‰æ¶ˆè´¹ç±»åˆ«ï¼Œæ§åˆ¶å®ƒèƒ½æœ‰æ•ˆæå‡å‚¨è“„',
        difficulty: CommitmentDifficulty.moderate,
      ));
    }

    return suggestions;
  }

  /// æ£€æŸ¥æ‰¿è¯ºå®Œæˆæƒ…å†µ
  Future<CommitmentProgress> checkCommitmentProgress(
    FinancialCommitment commitment,
  ) async {
    final now = DateTime.now();
    final totalDays = commitment.deadline.difference(commitment.createdAt).inDays;
    final elapsedDays = now.difference(commitment.createdAt).inDays;
    final progressRatio = elapsedDays / totalDays;

    double currentValue;
    double expectedValue;

    switch (commitment.type) {
      case CommitmentType.savingsAmount:
        currentValue = await _getCurrentSavings(commitment.createdAt);
        expectedValue = commitment.targetAmount * progressRatio;
        break;

      case CommitmentType.savingsRate:
        currentValue = await _getCurrentSavingsRate(commitment.createdAt);
        expectedValue = commitment.targetAmount;  // å‚¨è“„ç‡ç›®æ ‡æ˜¯å›ºå®šçš„
        break;

      case CommitmentType.categoryLimit:
        currentValue = await _getCategorySpending(
          commitment.categoryId!,
          commitment.createdAt,
        );
        expectedValue = commitment.targetAmount * progressRatio;
        break;

      case CommitmentType.recordingFrequency:
        currentValue = await _getRecordingDays(commitment.createdAt).toDouble();
        expectedValue = commitment.targetAmount * (elapsedDays / 7);
        break;

      default:
        currentValue = 0;
        expectedValue = 0;
    }

    final isOnTrack = currentValue >= expectedValue * 0.9;  // 90%å®¹é”™

    return CommitmentProgress(
      commitment: commitment,
      currentValue: currentValue,
      expectedValue: expectedValue,
      progressRatio: progressRatio,
      isOnTrack: isOnTrack,
      daysRemaining: commitment.deadline.difference(now).inDays,
      encouragement: _generateEncouragement(isOnTrack, progressRatio),
    );
  }

  /// ç”Ÿæˆé¼“åŠ±ä¿¡æ¯
  String _generateEncouragement(bool isOnTrack, double progressRatio) {
    if (isOnTrack) {
      if (progressRatio < 0.3) {
        return 'å¼€å±€ä¸é”™ï¼ä¿æŒè¿™ä¸ªåŠ¿å¤´';
      } else if (progressRatio < 0.7) {
        return 'è¿›å±•é¡ºåˆ©ï¼Œä½ å·²ç»å®Œæˆä¸€åŠä»¥ä¸Šäº†';
      } else {
        return 'èƒœåˆ©åœ¨æœ›ï¼å†åšæŒä¸€ä¸‹';
      }
    } else {
      if (progressRatio < 0.5) {
        return 'è¿˜æœ‰æ—¶é—´è°ƒæ•´ï¼Œæˆ‘ä»¬ä¸€èµ·åŠªåŠ›';
      } else {
        return 'è¿›åº¦æœ‰äº›è½åï¼Œä½†è¿˜æ²¡ç»“æŸï¼ŒåŠ æ²¹ï¼';
      }
    }
  }
}

/// è´¢åŠ¡æ‰¿è¯ºç±»å‹
enum CommitmentType {
  savingsAmount,       // å‚¨è“„é‡‘é¢
  savingsRate,         // å‚¨è“„ç‡
  categoryLimit,       // ç±»åˆ«é™é¢
  recordingFrequency,  // è®°è´¦é¢‘ç‡
  debtPayoff,          // è¿˜å€º
  noSpendDay,          // ä¸æ¶ˆè´¹æ—¥
}

/// æ‰¿è¯ºéš¾åº¦
enum CommitmentDifficulty {
  easy,      // ç®€å•ï¼ˆé«˜æˆåŠŸç‡ï¼‰
  moderate,  // é€‚ä¸­
  challenge, // æŒ‘æˆ˜
}

/// è´¢åŠ¡æ‰¿è¯º
class FinancialCommitment {
  final String id;
  final CommitmentType type;
  final String description;
  final double targetAmount;
  final DateTime deadline;
  final DateTime createdAt;
  final bool isPublic;
  final CommitmentStatus status;
  final String? categoryId;  // ç±»åˆ«é™é¢æ—¶ä½¿ç”¨

  /// ç”¨æˆ·çš„æ‰¿è¯ºå®£è¨€ï¼ˆè‡ªå·±å†™çš„è¯æ›´æœ‰ä»ªå¼æ„Ÿï¼‰
  final String? personalStatement;
}

enum CommitmentStatus {
  active,     // è¿›è¡Œä¸­
  completed,  // å·²å®Œæˆ
  failed,     // æœªå®Œæˆ
  abandoned,  // ä¸»åŠ¨æ”¾å¼ƒ
}

/// æ‰¿è¯ºåˆ›å»ºå‘å¯¼
class CommitmentCreationWizard extends StatefulWidget {
  @override
  _CommitmentCreationWizardState createState() => _CommitmentCreationWizardState();
}

class _CommitmentCreationWizardState extends State<CommitmentCreationWizard> {
  int _currentStep = 0;
  CommitmentType? _selectedType;
  double? _targetValue;
  DateTime? _deadline;
  String? _personalStatement;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('åšå‡ºè´¢åŠ¡æ‰¿è¯º')),
      body: Stepper(
        currentStep: _currentStep,
        onStepContinue: _onStepContinue,
        onStepCancel: _onStepCancel,
        steps: [
          Step(
            title: Text('é€‰æ‹©æ‰¿è¯ºç±»å‹'),
            content: _buildTypeSelection(),
            isActive: _currentStep >= 0,
          ),
          Step(
            title: Text('è®¾å®šç›®æ ‡'),
            content: _buildTargetSetting(),
            isActive: _currentStep >= 1,
          ),
          Step(
            title: Text('å†™ä¸‹ä½ çš„æ‰¿è¯º'),
            content: _buildStatementInput(),
            isActive: _currentStep >= 2,
          ),
          Step(
            title: Text('ç¡®è®¤æ‰¿è¯º'),
            content: _buildConfirmation(),
            isActive: _currentStep >= 3,
          ),
        ],
      ),
    );
  }

  Widget _buildStatementInput() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ç”¨è‡ªå·±çš„è¯å†™ä¸‹è¿™ä¸ªæ‰¿è¯º',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
        SizedBox(height: 8),
        Text(
          'ç ”ç©¶è¡¨æ˜ï¼Œäº²æ‰‹å†™ä¸‹çš„æ‰¿è¯ºæ›´å®¹æ˜“åšæŒ',
          style: TextStyle(color: Colors.grey, fontSize: 13),
        ),
        SizedBox(height: 16),
        TextField(
          maxLines: 3,
          decoration: InputDecoration(
            hintText: 'ä¾‹å¦‚ï¼šæˆ‘æ‰¿è¯ºè¿™ä¸ªæœˆå‡å°‘å¤–å–æ”¯å‡ºï¼ŒæŠŠçœä¸‹çš„é’±å­˜èµ·æ¥...',
            border: OutlineInputBorder(),
          ),
          onChanged: (value) => _personalStatement = value,
        ),
        SizedBox(height: 12),
        // æ‰¿è¯ºæ¨¡æ¿å»ºè®®
        Wrap(
          spacing: 8,
          children: [
            _buildStatementChip('æˆ‘æ‰¿è¯ºæ¯æœˆå‚¨è“„...'),
            _buildStatementChip('æˆ‘è¦åœ¨...ä¹‹å‰å­˜åˆ°...'),
            _buildStatementChip('è¿™ä¸ªæœˆæˆ‘ä¼šæ§åˆ¶...'),
          ],
        ),
      ],
    );
  }

  Widget _buildConfirmation() {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.blue.shade50,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.blue.shade200),
      ),
      child: Column(
        children: [
          Icon(Icons.handshake, size: 48, color: Colors.blue),
          SizedBox(height: 16),
          Text(
            'ä½ çš„æ‰¿è¯º',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          SizedBox(height: 12),
          Text(
            _personalStatement ?? _getDefaultStatement(),
            style: TextStyle(fontSize: 16),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: 16),
          Text(
            'æˆªæ­¢æ—¥æœŸ: ${_formatDate(_deadline!)}',
            style: TextStyle(color: Colors.grey),
          ),
          SizedBox(height: 24),
          Text(
            'ç‚¹å‡»"ç¡®è®¤"åï¼Œæˆ‘ä»¬ä¼šå®šæœŸæé†’ä½ è¿›åº¦',
            style: TextStyle(fontSize: 12, color: Colors.grey),
          ),
        ],
      ),
    );
  }
}

/// æ‰¿è¯ºè¿›åº¦å¡ç‰‡
class CommitmentProgressCard extends StatelessWidget {
  final CommitmentProgress progress;

  @override
  Widget build(BuildContext context) {
    final isOnTrack = progress.isOnTrack;

    return Card(
      color: isOnTrack ? Colors.green.shade50 : Colors.orange.shade50,
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(
                  isOnTrack ? Icons.check_circle : Icons.schedule,
                  color: isOnTrack ? Colors.green : Colors.orange,
                ),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    progress.commitment.description,
                    style: TextStyle(fontWeight: FontWeight.bold),
                  ),
                ),
                Text(
                  '${progress.daysRemaining}å¤©åæˆªæ­¢',
                  style: TextStyle(color: Colors.grey, fontSize: 12),
                ),
              ],
            ),

            SizedBox(height: 12),

            // è¿›åº¦æ¡
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: progress.progressRatio,
                backgroundColor: Colors.grey.shade200,
                valueColor: AlwaysStoppedAnimation(
                  isOnTrack ? Colors.green : Colors.orange,
                ),
              ),
            ),

            SizedBox(height: 8),

            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'å½“å‰: ${_formatValue(progress.currentValue, progress.commitment.type)}',
                  style: TextStyle(fontSize: 13),
                ),
                Text(
                  'ç›®æ ‡: ${_formatValue(progress.commitment.targetAmount, progress.commitment.type)}',
                  style: TextStyle(fontSize: 13, color: Colors.grey),
                ),
              ],
            ),

            SizedBox(height: 12),

            // é¼“åŠ±ä¿¡æ¯
            Container(
              padding: EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.5),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(
                    isOnTrack ? Icons.thumb_up : Icons.support,
                    size: 16,
                    color: isOnTrack ? Colors.green : Colors.orange,
                  ),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      progress.encouragement,
                      style: TextStyle(fontSize: 13),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

---


---

## 10. AIæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ

æœ¬ç« ä¸“æ³¨äºAIè¯†åˆ«ç³»ç»Ÿçš„**è¾“å…¥å¤„ç†ä¸ä¿¡æ¯æå–**èƒ½åŠ›ï¼ŒåŒ…æ‹¬è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰ã€å›¾åƒè¯†åˆ«ï¼ˆOCRï¼‰å’Œè‡ªç„¶è¯­è¨€ç†è§£ï¼ˆNLUï¼‰ã€‚è¯†åˆ«ç»“æœçš„**æ™ºèƒ½å†³ç­–**ï¼ˆå¦‚æ™ºèƒ½åˆ†ç±»ã€é¢„ç®—å»ºè®®ç­‰ï¼‰è¯¦è§ç¬¬16ç« "æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ"ã€‚

### 10.1 AIè¯†åˆ«ç³»ç»Ÿæ€»è§ˆ

#### 10.1.1 ç³»ç»Ÿå®šä½ä¸èŒè´£åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AIèƒ½åŠ›åˆ†å±‚æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    åº”ç”¨å±‚ (ç”¨æˆ·äº¤äº’ç•Œé¢)                              â”‚  â”‚
â”‚   â”‚   è¯­éŸ³è®°è´¦  â”‚  æ‹ç…§è®°è´¦  â”‚  æ–‡å­—è®°è´¦  â”‚  å¯¹è¯è®°è´¦  â”‚  æ‰¹é‡å¯¼å…¥      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              ç¬¬10ç« : AIè¯†åˆ«ç³»ç»Ÿ (è¾“å…¥å¤„ç†ä¸ä¿¡æ¯æå–)                   â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚   â”‚  â”‚ è¯­éŸ³ASR  â”‚  â”‚ å›¾åƒOCR  â”‚  â”‚ NLUè§£æ  â”‚  â”‚ å¤šç¬”æ‹†åˆ† â”‚            â”‚  â”‚
â”‚   â”‚  â”‚ å£°éŸ³â†’æ–‡æœ¬â”‚  â”‚ å›¾ç‰‡â†’æ–‡æœ¬â”‚  â”‚ æ–‡æœ¬â†’ç»“æ„â”‚  â”‚ æ‰¹é‡å¤„ç† â”‚            â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚   â”‚                              â†“                                       â”‚  â”‚
â”‚   â”‚                     ç»“æ„åŒ–äº¤æ˜“æ•°æ®                                    â”‚  â”‚
â”‚   â”‚              (é‡‘é¢ã€æè¿°ã€æ—¥æœŸã€å•†å®¶ã€ç½®ä¿¡åº¦)                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚            ç¬¬16ç« : æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ (æ™ºèƒ½å†³ç­–ä¸åˆ†æ)                    â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚   â”‚  â”‚ æ™ºèƒ½åˆ†ç±» â”‚  â”‚ é¢„ç®—å»ºè®® â”‚  â”‚ è¶‹åŠ¿é¢„æµ‹ â”‚  â”‚ æ´å¯Ÿç”Ÿæˆ â”‚            â”‚  â”‚
â”‚   â”‚  â”‚ å››å±‚ç­–ç•¥ â”‚  â”‚ ç»Ÿè®¡ç®—æ³• â”‚  â”‚ æ—¶é—´åºåˆ— â”‚  â”‚ æ¨¡å¼è¯†åˆ« â”‚            â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 10.1.2 è¯†åˆ«èƒ½åŠ›çŸ©é˜µ

| è¾“å…¥ç±»å‹ | è¯†åˆ«å¼•æ“ | è¾“å‡ºæ ¼å¼ | å…¸å‹åœºæ™¯ | ç¦»çº¿æ”¯æŒ |
|----------|----------|----------|----------|----------|
| è¯­éŸ³ | ASRï¼ˆé˜¿é‡Œäº‘/æœ¬åœ°Whisperï¼‰ | æ–‡æœ¬ â†’ ç»“æ„åŒ– | "æ—©é¤èŠ±äº†15å—" | éƒ¨åˆ†æ”¯æŒ |
| å›¾ç‰‡-å°ç¥¨ | OCR + æ¨¡æ¿åŒ¹é… | å•†å“åˆ—è¡¨ + æ€»ä»· | è¶…å¸‚è´­ç‰©å°ç¥¨ | æ˜¯ |
| å›¾ç‰‡-æˆªå›¾ | OCR + å¸ƒå±€åˆ†æ | æ”¯ä»˜ä¿¡æ¯ | å¾®ä¿¡/æ”¯ä»˜å®æˆªå›¾ | æ˜¯ |
| å›¾ç‰‡-æ‰‹å†™ | OCR + æ‰‹å†™è¯†åˆ« | æ–‡æœ¬ â†’ ç»“æ„åŒ– | æ‰‹å†™è´¦å•ç¬”è®° | å¦ |
| æ–‡å­—è¾“å…¥ | NLUè¯­ä¹‰è§£æ | ç»“æ„åŒ–äº¤æ˜“ | "æ˜¨å¤©å’Œæœ‹å‹åƒç«é”…AA" | æ˜¯ |
| æ··åˆè¾“å…¥ | å¤šæ¨¡æ€èåˆ | ç»“æ„åŒ–äº¤æ˜“ | è¯­éŸ³+æˆªå›¾ç»„åˆ | éƒ¨åˆ†æ”¯æŒ |

#### 10.1.3 è¯†åˆ«æµæ°´çº¿æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AIè¯†åˆ«æµæ°´çº¿ (Pipeline)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¾“å…¥é‡‡é›†           é¢„å¤„ç†              è¯†åˆ«å¼•æ“            åå¤„ç†          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ éº¦å…‹é£ â”‚â”€â”€â”€â”€â”€â†’â”‚ é™å™ª/VAD   â”‚â”€â”€â”€â”€â”€â†’â”‚ ASRå¼•æ“    â”‚â”€â”€â”€â”€â”€â†’â”‚            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚            â”‚   â”‚
â”‚                                                           â”‚            â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   NLU      â”‚   â”‚
â”‚  â”‚ ç›¸æœº   â”‚â”€â”€â”€â”€â”€â†’â”‚ è£å‰ª/å¢å¼º  â”‚â”€â”€â”€â”€â”€â†’â”‚ OCRå¼•æ“    â”‚â”€â”€â”€â”€â”€â†’â”‚   è§£æ     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚            â”‚   â”‚
â”‚                                                           â”‚   â†“        â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚ ç»“æ„åŒ–    â”‚   â”‚
â”‚  â”‚ é”®ç›˜   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ æ•°æ®      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚            â”‚   â”‚
â”‚                                                           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚          â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”‚
â”‚                         â”‚              åå¤„ç†æ¨¡å—                     â”‚     â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚     â”‚
â”‚                         â”‚  â”‚ å¤šç¬”æ‹†åˆ†â”‚ â”‚ ç½®ä¿¡åº¦  â”‚ â”‚ çº é”™è¡¥å…¨â”‚      â”‚     â”‚
â”‚                         â”‚  â”‚ æ£€æµ‹    â”‚ â”‚ è¯„ä¼°    â”‚ â”‚ æ¨¡å—    â”‚      â”‚     â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 å¤šæ¨¡æ€è¾“å…¥ç»Ÿä¸€æ¶æ„

#### 10.2.1 ç»Ÿä¸€å…¥å£æœåŠ¡

```dart
/// å¤šæ¨¡æ€è¾“å…¥ç»Ÿä¸€æœåŠ¡
/// æä¾›è¯­éŸ³ã€å›¾åƒã€æ–‡æœ¬çš„ç»Ÿä¸€å…¥å£ï¼Œç®€åŒ–ä¸Šå±‚è°ƒç”¨
class UnifiedRecognitionService {
  final VoiceRecognitionEngine _voiceEngine;
  final ImageRecognitionEngine _imageEngine;
  final NLUEngine _nluEngine;
  final RecognitionPipeline _pipeline;

  /// ç»Ÿä¸€è¯†åˆ«å…¥å£
  Future<RecognitionResult> recognize(RecognitionInput input) async {
    switch (input.type) {
      case InputType.voice:
        return await _processVoice(input as VoiceInput);
      case InputType.image:
        return await _processImage(input as ImageInput);
      case InputType.text:
        return await _processText(input as TextInput);
      case InputType.mixed:
        return await _processMixed(input as MixedInput);
    }
  }

  /// å¤„ç†è¯­éŸ³è¾“å…¥
  Future<RecognitionResult> _processVoice(VoiceInput input) async {
    // 1. è¯­éŸ³è½¬æ–‡æœ¬
    final asrResult = await _voiceEngine.transcribe(input.audioData);

    // 2. NLUè§£æ
    final nluResult = await _nluEngine.parse(
      asrResult.text,
      context: input.context,
    );

    // 3. æ„å»ºç»“æœ
    return RecognitionResult(
      source: RecognitionSource.voice,
      rawText: asrResult.text,
      transactions: nluResult.transactions,
      confidence: _calculateConfidence(asrResult, nluResult),
      metadata: RecognitionMetadata(
        asrConfidence: asrResult.confidence,
        nluConfidence: nluResult.confidence,
        processingTime: DateTime.now().difference(input.timestamp),
      ),
    );
  }

  /// å¤„ç†å›¾åƒè¾“å…¥
  Future<RecognitionResult> _processImage(ImageInput input) async {
    // 1. å›¾åƒç±»å‹æ£€æµ‹
    final imageType = await _imageEngine.detectType(input.imageData);

    // 2. æ ¹æ®ç±»å‹é€‰æ‹©å¤„ç†ç­–ç•¥
    final ocrResult = await _imageEngine.process(input.imageData, imageType);

    // 3. NLUè§£æï¼ˆå¯¹äºéœ€è¦è¯­ä¹‰ç†è§£çš„å›¾åƒï¼‰
    final nluResult = imageType.needsNLU
        ? await _nluEngine.parse(ocrResult.text, context: input.context)
        : NLUResult.fromStructured(ocrResult.structuredData);

    return RecognitionResult(
      source: RecognitionSource.image,
      rawText: ocrResult.text,
      transactions: nluResult.transactions,
      confidence: _calculateConfidence(ocrResult, nluResult),
      imageType: imageType,
      metadata: RecognitionMetadata(
        ocrConfidence: ocrResult.confidence,
        nluConfidence: nluResult.confidence,
        detectedFields: ocrResult.detectedFields,
      ),
    );
  }

  /// å¤„ç†æ··åˆè¾“å…¥ï¼ˆå¦‚è¯­éŸ³+æˆªå›¾ï¼‰
  Future<RecognitionResult> _processMixed(MixedInput input) async {
    // å¹¶è¡Œå¤„ç†å„æ¨¡æ€
    final results = await Future.wait([
      if (input.voiceInput != null) _processVoice(input.voiceInput!),
      if (input.imageInput != null) _processImage(input.imageInput!),
      if (input.textInput != null) _processText(input.textInput!),
    ]);

    // èåˆå¤šæ¨¡æ€ç»“æœ
    return _fuseResults(results);
  }

  /// å¤šæ¨¡æ€ç»“æœèåˆ
  RecognitionResult _fuseResults(List<RecognitionResult> results) {
    if (results.length == 1) return results.first;

    // æŒ‰ç½®ä¿¡åº¦åŠ æƒèåˆ
    final transactions = <ParsedTransaction>[];
    final seenAmounts = <double>{};

    // ä¼˜å…ˆä½¿ç”¨é«˜ç½®ä¿¡åº¦ç»“æœ
    final sortedResults = List<RecognitionResult>.from(results)
      ..sort((a, b) => b.confidence.compareTo(a.confidence));

    for (final result in sortedResults) {
      for (final tx in result.transactions) {
        // å»é‡ï¼šç›¸åŒé‡‘é¢çš„äº¤æ˜“åªä¿ç•™ç½®ä¿¡åº¦æœ€é«˜çš„
        if (!seenAmounts.contains(tx.amount)) {
          transactions.add(tx);
          seenAmounts.add(tx.amount);
        }
      }
    }

    return RecognitionResult(
      source: RecognitionSource.mixed,
      transactions: transactions,
      confidence: sortedResults.first.confidence,
      fusedFrom: results.map((r) => r.source).toList(),
    );
  }
}
```

#### 10.2.2 è¾“å…¥é¢„å¤„ç†å™¨

```dart
/// è¾“å…¥é¢„å¤„ç†æœåŠ¡
class InputPreprocessor {

  /// éŸ³é¢‘é¢„å¤„ç†
  Future<ProcessedAudio> preprocessAudio(Uint8List rawAudio) async {
    // 1. æ ¼å¼è½¬æ¢ï¼ˆç»Ÿä¸€ä¸º16kHzå•å£°é“PCMï¼‰
    final normalized = await _normalizeAudioFormat(rawAudio);

    // 2. é™å™ªå¤„ç†
    final denoised = await _applyNoiseReduction(normalized);

    // 3. VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰åˆ‡åˆ†
    final segments = await _detectVoiceSegments(denoised);

    // 4. é™éŸ³æ®µè¿‡æ»¤
    final filtered = segments.where((s) => s.isSpeech).toList();

    return ProcessedAudio(
      data: _mergeSegments(filtered),
      segments: filtered,
      duration: _calculateDuration(filtered),
      sampleRate: 16000,
    );
  }

  /// å›¾åƒé¢„å¤„ç†
  Future<ProcessedImage> preprocessImage(Uint8List rawImage) async {
    // 1. è§£ç å›¾åƒ
    final decoded = await _decodeImage(rawImage);

    // 2. æ–¹å‘æ ¡æ­£ï¼ˆEXIFä¿¡æ¯ï¼‰
    final oriented = await _correctOrientation(decoded);

    // 3. å°ºå¯¸å½’ä¸€åŒ–ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œæœ€å¤§è¾¹1920ï¼‰
    final resized = await _resizeIfNeeded(oriented, maxSize: 1920);

    // 4. å¯¹æ¯”åº¦å¢å¼ºï¼ˆå¯é€‰ï¼Œé’ˆå¯¹å°ç¥¨ç­‰ä½å¯¹æ¯”åº¦å›¾åƒï¼‰
    final enhanced = await _enhanceContrastIfNeeded(resized);

    // 5. å»æ–œæ ¡æ­£ï¼ˆé’ˆå¯¹å€¾æ–œæ‹æ‘„ï¼‰
    final deskewed = await _deskewIfNeeded(enhanced);

    return ProcessedImage(
      data: deskewed,
      originalSize: Size(decoded.width.toDouble(), decoded.height.toDouble()),
      processedSize: Size(deskewed.width.toDouble(), deskewed.height.toDouble()),
      preprocessSteps: _getAppliedSteps(),
    );
  }

  /// VADè¯­éŸ³æ´»åŠ¨æ£€æµ‹
  Future<List<AudioSegment>> _detectVoiceSegments(Uint8List audio) async {
    final segments = <AudioSegment>[];
    const frameSize = 480; // 30ms at 16kHz
    const threshold = 0.02; // èƒ½é‡é˜ˆå€¼

    int speechStart = -1;
    int silenceCount = 0;
    const maxSilenceFrames = 15; // å…è®¸çš„æœ€å¤§é™éŸ³å¸§æ•°ï¼ˆ450msï¼‰

    for (int i = 0; i < audio.length; i += frameSize * 2) {
      final frameEnd = min(i + frameSize * 2, audio.length);
      final frame = audio.sublist(i, frameEnd);
      final energy = _calculateFrameEnergy(frame);

      if (energy > threshold) {
        if (speechStart == -1) {
          speechStart = i;
        }
        silenceCount = 0;
      } else {
        if (speechStart != -1) {
          silenceCount++;
          if (silenceCount >= maxSilenceFrames) {
            segments.add(AudioSegment(
              startMs: (speechStart / 32).round(),
              endMs: (i / 32).round(),
              isSpeech: true,
            ));
            speechStart = -1;
            silenceCount = 0;
          }
        }
      }
    }

    // å¤„ç†æœ€åä¸€ä¸ªè¯­éŸ³æ®µ
    if (speechStart != -1) {
      segments.add(AudioSegment(
        startMs: (speechStart / 32).round(),
        endMs: (audio.length / 32).round(),
        isSpeech: true,
      ));
    }

    return segments;
  }
}
```

### 10.3 è¯­éŸ³è¯†åˆ«å¼•æ“

#### 10.3.1 ASRæŠ€æœ¯æ–¹æ¡ˆ

```dart
/// è¯­éŸ³è¯†åˆ«å¼•æ“
/// æ”¯æŒåœ¨çº¿ï¼ˆé˜¿é‡Œäº‘ï¼‰å’Œç¦»çº¿ï¼ˆWhisperï¼‰ä¸¤ç§æ¨¡å¼
class VoiceRecognitionEngine {
  final AliCloudASRService _aliASR;
  final LocalWhisperService _whisper;
  final NetworkChecker _networkChecker;

  /// ASRæœåŠ¡é€‰æ‹©ç­–ç•¥
  Future<ASRResult> transcribe(ProcessedAudio audio) async {
    // 1. æ£€æµ‹ç½‘ç»œçŠ¶æ€
    final hasNetwork = await _networkChecker.isOnline();

    // 2. é€‰æ‹©ASRå¼•æ“
    if (hasNetwork && audio.duration < Duration(seconds: 60)) {
      // çŸ­éŸ³é¢‘ + æœ‰ç½‘ç»œï¼šä½¿ç”¨åœ¨çº¿æœåŠ¡ï¼ˆæ›´å‡†ç¡®ï¼‰
      try {
        return await _aliASR.transcribe(audio);
      } catch (e) {
        // åœ¨çº¿æœåŠ¡å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°
        return await _whisper.transcribe(audio);
      }
    } else {
      // é•¿éŸ³é¢‘æˆ–æ— ç½‘ç»œï¼šä½¿ç”¨æœ¬åœ°Whisper
      return await _whisper.transcribe(audio);
    }
  }

  /// æµå¼è¯†åˆ«ï¼ˆå®æ—¶è½¬å†™ï¼‰
  Stream<ASRPartialResult> transcribeStream(Stream<Uint8List> audioStream) async* {
    // ä½¿ç”¨é˜¿é‡Œäº‘å®æ—¶è¯­éŸ³è¯†åˆ«
    await for (final partial in _aliASR.transcribeStream(audioStream)) {
      yield partial;
    }
  }
}

/// é˜¿é‡Œäº‘ASRæœåŠ¡
class AliCloudASRService {
  final String _appKey;
  final String _accessKeyId;
  final String _accessKeySecret;

  /// ä¸€å¥è¯è¯†åˆ«ï¼ˆçŸ­éŸ³é¢‘ï¼‰
  Future<ASRResult> transcribe(ProcessedAudio audio) async {
    final token = await _getToken();

    final response = await http.post(
      Uri.parse('https://nls-gateway.cn-shanghai.aliyuncs.com/stream/v1/asr'),
      headers: {
        'X-NLS-Token': token,
        'Content-Type': 'application/octet-stream',
      },
      body: audio.data,
    );

    final result = jsonDecode(response.body);

    return ASRResult(
      text: result['result'] ?? '',
      confidence: (result['confidence'] as num?)?.toDouble() ?? 0.8,
      words: _parseWords(result['words']),
      duration: audio.duration,
    );
  }

  /// å®æ—¶è¯­éŸ³è¯†åˆ«ï¼ˆæµå¼ï¼‰
  Stream<ASRPartialResult> transcribeStream(Stream<Uint8List> audioStream) async* {
    final ws = await WebSocket.connect(
      'wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1',
    );

    // å‘é€è¯†åˆ«å¼€å§‹æŒ‡ä»¤
    ws.add(jsonEncode({
      'header': {
        'message_id': _generateMessageId(),
        'task_id': _generateTaskId(),
        'namespace': 'SpeechTranscriber',
        'name': 'StartTranscription',
        'appkey': _appKey,
      },
      'payload': {
        'format': 'pcm',
        'sample_rate': 16000,
        'enable_intermediate_result': true,
        'enable_punctuation_prediction': true,
        'enable_inverse_text_normalization': true,
      },
    }));

    // å‘é€éŸ³é¢‘æ•°æ®å¹¶æ¥æ”¶ç»“æœ
    audioStream.listen((chunk) => ws.add(chunk));

    await for (final message in ws) {
      final data = jsonDecode(message);
      final name = data['header']['name'];

      if (name == 'TranscriptionResultChanged') {
        // ä¸­é—´ç»“æœ
        yield ASRPartialResult(
          text: data['payload']['result'],
          isFinal: false,
          index: data['payload']['index'],
        );
      } else if (name == 'SentenceEnd') {
        // ä¸€å¥è¯ç»“æŸ
        yield ASRPartialResult(
          text: data['payload']['result'],
          isFinal: true,
          index: data['payload']['index'],
          confidence: data['payload']['confidence'],
        );
      }
    }
  }
}

/// æœ¬åœ°WhisperæœåŠ¡ï¼ˆç¦»çº¿è¯†åˆ«ï¼‰
class LocalWhisperService {
  late final WhisperModel _model;
  bool _isInitialized = false;

  /// åˆå§‹åŒ–æ¨¡å‹
  Future<void> initialize() async {
    if (_isInitialized) return;

    // åŠ è½½tiny.enæ¨¡å‹ï¼ˆçº¦75MBï¼Œå¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®åº¦ï¼‰
    _model = await WhisperModel.load('assets/models/whisper-tiny.bin');
    _isInitialized = true;
  }

  /// è½¬å†™éŸ³é¢‘
  Future<ASRResult> transcribe(ProcessedAudio audio) async {
    await initialize();

    final result = await _model.transcribe(
      audio.data,
      language: 'zh',  // ä¸­æ–‡
      task: WhisperTask.transcribe,
    );

    return ASRResult(
      text: result.text,
      confidence: result.avgLogProb > -0.5 ? 0.9 : 0.7,
      words: result.words,
      duration: audio.duration,
      isOffline: true,
    );
  }
}
```

#### 10.3.2 è¯­éŸ³è®°è´¦ä¸“ç”¨ä¼˜åŒ–

```dart
/// è®°è´¦é¢†åŸŸè¯­éŸ³è¯†åˆ«ä¼˜åŒ–
class BookkeepingASROptimizer {

  /// è®°è´¦ä¸“ç”¨çƒ­è¯è¡¨
  static const List<HotWord> bookkeepingHotWords = [
    // é‡‘é¢è¡¨è¾¾
    HotWord('å—é’±', weight: 2.0),
    HotWord('å…ƒ', weight: 2.0),
    HotWord('æ¯›', weight: 1.5),
    HotWord('åˆ†', weight: 1.5),

    // å¸¸è§åˆ†ç±»
    HotWord('æ—©é¤', weight: 1.8),
    HotWord('åˆé¤', weight: 1.8),
    HotWord('æ™šé¤', weight: 1.8),
    HotWord('å¤–å–', weight: 1.8),
    HotWord('æ‰“è½¦', weight: 1.8),
    HotWord('åœ°é“', weight: 1.8),
    HotWord('å…¬äº¤', weight: 1.8),
    HotWord('æˆ¿ç§Ÿ', weight: 1.8),
    HotWord('æ°´ç”µè´¹', weight: 1.8),

    // æ—¶é—´è¡¨è¾¾
    HotWord('ä»Šå¤©', weight: 1.5),
    HotWord('æ˜¨å¤©', weight: 1.5),
    HotWord('å‰å¤©', weight: 1.5),
    HotWord('ä¸Šå‘¨', weight: 1.5),
    HotWord('ä¸Šä¸ªæœˆ', weight: 1.5),

    // åŠ¨ä½œè¯
    HotWord('èŠ±äº†', weight: 1.8),
    HotWord('ä¹°äº†', weight: 1.8),
    HotWord('å……å€¼', weight: 1.8),
    HotWord('è½¬è´¦', weight: 1.8),
    HotWord('æ”¶å…¥', weight: 1.8),
    HotWord('å·¥èµ„', weight: 1.8),
  ];

  /// åå¤„ç†ï¼šæ•°å­—è¯†åˆ«çº é”™
  String postProcessNumbers(String text) {
    // å¸¸è§æ•°å­—è¯†åˆ«é”™è¯¯ä¿®æ­£
    final corrections = {
      'ä¸€': '1', 'äºŒ': '2', 'ä¸‰': '3', 'å››': '4', 'äº”': '5',
      'å…­': '6', 'ä¸ƒ': '7', 'å…«': '8', 'ä¹': '9', 'å': '10',
      'ä¸¤': '2', 'ä¿©': '2',
      'ç™¾': '00', 'åƒ': '000', 'ä¸‡': '0000',
    };

    var result = text;

    // å¤„ç†"åäº”å—"è¿™ç§å½¢å¼
    result = result.replaceAllMapped(
      RegExp(r'(å)([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])'),
      (m) => '1${corrections[m.group(2)]}',
    );

    // å¤„ç†"ä¸€ç™¾äºŒå"è¿™ç§å½¢å¼
    result = result.replaceAllMapped(
      RegExp(r'([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])ç™¾([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])?å?([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹])?'),
      (m) {
        final hundreds = corrections[m.group(1)] ?? '0';
        final tens = m.group(2) != null ? corrections[m.group(2)] : '0';
        final ones = m.group(3) != null ? corrections[m.group(3)] : '0';
        return '$hundreds$tens$ones';
      },
    );

    return result;
  }

  /// åå¤„ç†ï¼šé‡‘é¢å•ä½æ ‡å‡†åŒ–
  String normalizeAmountUnit(String text) {
    return text
      .replaceAll(RegExp(r'å—é’±?'), 'å…ƒ')
      .replaceAll(RegExp(r'æ¯›'), 'è§’')
      .replaceAll(RegExp(r'(\d+)å…ƒ(\d)è§’'), r'\1.\2å…ƒ')
      .replaceAll(RegExp(r'(\d+)å…ƒ(\d)åˆ†'), r'\1.0\2å…ƒ');
  }
}
```

### 10.4 å›¾åƒè¯†åˆ«å¼•æ“

#### 10.4.1 å›¾åƒç±»å‹æ£€æµ‹

```dart
/// å›¾åƒè¯†åˆ«å¼•æ“
class ImageRecognitionEngine {
  final OCRService _ocrService;
  final ImageClassifier _classifier;
  final ReceiptParser _receiptParser;
  final ScreenshotParser _screenshotParser;

  /// æ£€æµ‹å›¾åƒç±»å‹
  Future<ImageType> detectType(ProcessedImage image) async {
    // ä½¿ç”¨è½»é‡çº§åˆ†ç±»å™¨å¿«é€Ÿåˆ¤æ–­å›¾åƒç±»å‹
    final classResult = await _classifier.classify(image);

    // ç½®ä¿¡åº¦é˜ˆå€¼
    if (classResult.confidence > 0.8) {
      return classResult.type;
    }

    // ç½®ä¿¡åº¦ä¸è¶³æ—¶ï¼Œä½¿ç”¨è§„åˆ™è¾…åŠ©åˆ¤æ–­
    return _ruleBasedDetection(image);
  }

  /// åŸºäºè§„åˆ™çš„å›¾åƒç±»å‹æ£€æµ‹
  Future<ImageType> _ruleBasedDetection(ProcessedImage image) async {
    // 1. æ£€æµ‹æ˜¯å¦ä¸ºæˆªå›¾ï¼ˆæ£€æŸ¥çŠ¶æ€æ ã€å¯¼èˆªæ ç‰¹å¾ï¼‰
    if (await _hasScreenshotFeatures(image)) {
      return ImageType.screenshot;
    }

    // 2. æ£€æµ‹æ˜¯å¦ä¸ºå°ç¥¨ï¼ˆé•¿å®½æ¯”ã€ç™½åº•é»‘å­—ç‰¹å¾ï¼‰
    final aspectRatio = image.processedSize.height / image.processedSize.width;
    if (aspectRatio > 2.0) {
      return ImageType.receipt;
    }

    // 3. æ£€æµ‹æ˜¯å¦ä¸ºå‘ç¥¨ï¼ˆå‘ç¥¨å·ã€ç¨å·ç­‰ç‰¹å¾ï¼‰
    final ocrPreview = await _ocrService.quickOCR(image, lines: 5);
    if (_hasInvoiceKeywords(ocrPreview)) {
      return ImageType.invoice;
    }

    // 4. é»˜è®¤ä¸ºæ™®é€šå›¾ç‰‡
    return ImageType.generic;
  }

  /// æ ¹æ®ç±»å‹å¤„ç†å›¾åƒ
  Future<OCRResult> process(ProcessedImage image, ImageType type) async {
    switch (type) {
      case ImageType.receipt:
        return await _processReceipt(image);
      case ImageType.screenshot:
        return await _processScreenshot(image);
      case ImageType.invoice:
        return await _processInvoice(image);
      case ImageType.handwritten:
        return await _processHandwritten(image);
      default:
        return await _processGeneric(image);
    }
  }
}

/// å›¾åƒç±»å‹æšä¸¾
enum ImageType {
  receipt,      // è´­ç‰©å°ç¥¨
  screenshot,   // æ”¯ä»˜æˆªå›¾
  invoice,      // æ­£å¼å‘ç¥¨
  handwritten,  // æ‰‹å†™ç¬”è®°
  bankStatement,// é“¶è¡Œæµæ°´æˆªå›¾
  generic,      // é€šç”¨å›¾ç‰‡
}
```

#### 10.4.2 å°ç¥¨è¯†åˆ«

```dart
/// å°ç¥¨è¯†åˆ«è§£æå™¨
class ReceiptParser {
  final OCRService _ocrService;

  /// è§£æè¶…å¸‚å°ç¥¨
  Future<ReceiptParseResult> parseSupermarketReceipt(ProcessedImage image) async {
    // 1. OCRè¯†åˆ«
    final ocrResult = await _ocrService.recognize(image);

    // 2. æå–å•†å®¶ä¿¡æ¯ï¼ˆé€šå¸¸åœ¨é¡¶éƒ¨ï¼‰
    final merchantName = _extractMerchantName(ocrResult);

    // 3. æå–æ—¥æœŸæ—¶é—´
    final dateTime = _extractDateTime(ocrResult);

    // 4. æå–å•†å“åˆ—è¡¨
    final items = _extractItems(ocrResult);

    // 5. æå–æ€»é‡‘é¢
    final totalAmount = _extractTotalAmount(ocrResult);

    // 6. æå–æ”¯ä»˜æ–¹å¼
    final paymentMethod = _extractPaymentMethod(ocrResult);

    return ReceiptParseResult(
      merchantName: merchantName,
      dateTime: dateTime,
      items: items,
      totalAmount: totalAmount,
      paymentMethod: paymentMethod,
      rawText: ocrResult.fullText,
      confidence: _calculateOverallConfidence(ocrResult, items, totalAmount),
    );
  }

  /// æå–å•†å“åˆ—è¡¨
  List<ReceiptItem> _extractItems(OCRResult ocr) {
    final items = <ReceiptItem>[];

    // å•†å“è¡Œæ¨¡å¼ï¼šå•†å“å æ•°é‡ å•ä»· é‡‘é¢
    // å¸¸è§æ ¼å¼ï¼š
    // "å¯å£å¯ä¹ 2 3.50 7.00"
    // "è‹¹æœ 0.5kg 12.00/kg 6.00"
    // "ç‰›å¥¶*2 5.00"

    final patterns = [
      // æ ¼å¼1: åç§° æ•°é‡ å•ä»· å°è®¡
      RegExp(r'^(.+?)\s+(\d+\.?\d*)\s+(\d+\.?\d*)\s+(\d+\.?\d*)$'),
      // æ ¼å¼2: åç§°*æ•°é‡ é‡‘é¢
      RegExp(r'^(.+?)[*Ã—x](\d+)\s+(\d+\.?\d*)$'),
      // æ ¼å¼3: åç§° é‡‘é¢ï¼ˆæ•°é‡ä¸º1ï¼‰
      RegExp(r'^(.+?)\s+(\d+\.?\d*)$'),
    ];

    for (final line in ocr.lines) {
      final text = line.text.trim();

      // è·³è¿‡éå•†å“è¡Œï¼ˆæ ‡é¢˜ã€å°è®¡ç­‰ï¼‰
      if (_isNonItemLine(text)) continue;

      for (final pattern in patterns) {
        final match = pattern.firstMatch(text);
        if (match != null) {
          items.add(_parseMatchToItem(match, pattern));
          break;
        }
      }
    }

    return items;
  }

  /// æå–æ€»é‡‘é¢
  double? _extractTotalAmount(OCRResult ocr) {
    // æ€»é‡‘é¢å…³é”®è¯
    final keywords = ['åˆè®¡', 'æ€»è®¡', 'å®ä»˜', 'åº”ä»˜', 'æ€»é¢', 'TOTAL', 'é‡‘é¢'];

    for (final line in ocr.lines.reversed) {
      final text = line.text;

      for (final keyword in keywords) {
        if (text.contains(keyword)) {
          // æå–é‡‘é¢
          final amountMatch = RegExp(r'(\d+\.?\d*)').firstMatch(text);
          if (amountMatch != null) {
            return double.tryParse(amountMatch.group(1)!);
          }
        }
      }
    }

    // å¦‚æœæ²¡æ‰¾åˆ°æ€»è®¡è¡Œï¼Œè®¡ç®—å•†å“å°è®¡ä¹‹å’Œ
    return null;
  }

  /// éªŒè¯ï¼šå•†å“å°è®¡ä¹‹å’Œåº”æ¥è¿‘æ€»é‡‘é¢
  bool _validateTotal(List<ReceiptItem> items, double? totalAmount) {
    if (totalAmount == null) return true;

    final itemsSum = items.fold<double>(0, (sum, item) => sum + item.total);
    final diff = (itemsSum - totalAmount).abs();

    // å…è®¸1å…ƒä»¥å†…çš„è¯¯å·®ï¼ˆå¯èƒ½æœ‰ä¼˜æƒ ã€å››èˆäº”å…¥ç­‰ï¼‰
    return diff < 1.0;
  }
}
```

#### 10.4.3 æ”¯ä»˜æˆªå›¾è¯†åˆ«

```dart
/// æ”¯ä»˜æˆªå›¾è§£æå™¨
class ScreenshotParser {
  final OCRService _ocrService;

  /// æ”¯ä»˜å¹³å°ç‰¹å¾
  static const Map<PaymentPlatform, List<String>> platformKeywords = {
    PaymentPlatform.wechat: ['å¾®ä¿¡æ”¯ä»˜', 'æ”¯ä»˜æˆåŠŸ', 'å·²æ”¯ä»˜', 'å¾®ä¿¡çº¢åŒ…'],
    PaymentPlatform.alipay: ['æ”¯ä»˜å®', 'ä»˜æ¬¾æˆåŠŸ', 'å·²ä»˜æ¬¾', 'èŠ±å‘—'],
    PaymentPlatform.unionpay: ['äº‘é—ªä»˜', 'é“¶è”', 'é—ªä»˜'],
    PaymentPlatform.bankApp: ['å·¥å•†é“¶è¡Œ', 'å»ºè®¾é“¶è¡Œ', 'å†œä¸šé“¶è¡Œ', 'æ‹›å•†é“¶è¡Œ', 'è½¬è´¦æˆåŠŸ'],
  };

  /// è§£ææ”¯ä»˜æˆªå›¾
  Future<ScreenshotParseResult> parse(ProcessedImage image) async {
    // 1. OCRè¯†åˆ«
    final ocrResult = await _ocrService.recognize(image);

    // 2. æ£€æµ‹æ”¯ä»˜å¹³å°
    final platform = _detectPlatform(ocrResult);

    // 3. æ ¹æ®å¹³å°ç‰¹å®šå¸ƒå±€æå–ä¿¡æ¯
    final parseResult = await _parseByPlatform(ocrResult, platform);

    return parseResult;
  }

  /// è§£æå¾®ä¿¡æ”¯ä»˜æˆªå›¾
  Future<ScreenshotParseResult> _parseWechatPayment(OCRResult ocr) async {
    String? amount;
    String? merchant;
    DateTime? paymentTime;
    String? orderNo;

    // å¾®ä¿¡æ”¯ä»˜æˆªå›¾å¸ƒå±€åˆ†æ
    // é€šå¸¸ç»“æ„ï¼š
    // - é¡¶éƒ¨ï¼šæ”¯ä»˜æˆåŠŸ/å¾…æ”¯ä»˜
    // - ä¸­é—´å¤§å­—ï¼šé‡‘é¢ï¼ˆÂ¥XX.XXï¼‰
    // - ä¸‹æ–¹ï¼šæ”¶æ¬¾æ–¹ã€æ”¯ä»˜æ—¶é—´ã€è®¢å•å·

    for (int i = 0; i < ocr.lines.length; i++) {
      final line = ocr.lines[i];
      final text = line.text;

      // æå–é‡‘é¢ï¼ˆå¯»æ‰¾æœ€å¤§çš„æ•°å­—ï¼Œé€šå¸¸æ˜¯æ”¯ä»˜é‡‘é¢ï¼‰
      if (text.contains('Â¥') || text.contains('ï¿¥')) {
        final amountMatch = RegExp(r'[Â¥ï¿¥]\s*(\d+\.?\d*)').firstMatch(text);
        if (amountMatch != null) {
          final value = amountMatch.group(1)!;
          if (amount == null || double.parse(value) > double.parse(amount)) {
            amount = value;
          }
        }
      }

      // æå–æ”¶æ¬¾æ–¹
      if (text.contains('æ”¶æ¬¾æ–¹') || text.contains('ä»˜æ¬¾ç»™')) {
        // æ”¶æ¬¾æ–¹åç§°é€šå¸¸åœ¨ä¸‹ä¸€è¡Œæˆ–åŒä¸€è¡Œå†’å·å
        if (text.contains(':') || text.contains('ï¼š')) {
          merchant = text.split(RegExp(r'[:ï¼š]')).last.trim();
        } else if (i + 1 < ocr.lines.length) {
          merchant = ocr.lines[i + 1].text.trim();
        }
      }

      // æå–æ—¶é—´
      final timeMatch = RegExp(
        r'(\d{4}[-/å¹´]\d{1,2}[-/æœˆ]\d{1,2}æ—¥?\s*\d{1,2}:\d{2}(:\d{2})?)'
      ).firstMatch(text);
      if (timeMatch != null) {
        paymentTime = _parseDateTime(timeMatch.group(1)!);
      }

      // æå–è®¢å•å·
      if (text.contains('è®¢å•å·') || text.contains('äº¤æ˜“å•å·')) {
        orderNo = RegExp(r'[A-Za-z0-9]{16,32}').firstMatch(text)?.group(0);
      }
    }

    return ScreenshotParseResult(
      platform: PaymentPlatform.wechat,
      amount: double.tryParse(amount ?? '0'),
      merchant: merchant,
      paymentTime: paymentTime,
      orderNo: orderNo,
      confidence: _calculateConfidence(amount, merchant, paymentTime),
    );
  }

  /// è§£ææ”¯ä»˜å®æˆªå›¾
  Future<ScreenshotParseResult> _parseAlipayPayment(OCRResult ocr) async {
    // æ”¯ä»˜å®å¸ƒå±€ä¸å¾®ä¿¡ç±»ä¼¼ï¼Œä½†æœ‰ä¸€äº›å·®å¼‚
    String? amount;
    String? merchant;
    DateTime? paymentTime;
    String? orderNo;
    PaymentStatus status = PaymentStatus.unknown;

    for (final line in ocr.lines) {
      final text = line.text;

      // æ£€æµ‹æ”¯ä»˜çŠ¶æ€
      if (text.contains('ä»˜æ¬¾æˆåŠŸ') || text.contains('å·²ä»˜æ¬¾')) {
        status = PaymentStatus.success;
      } else if (text.contains('å¾…ä»˜æ¬¾') || text.contains('ç­‰å¾…ä»˜æ¬¾')) {
        status = PaymentStatus.pending;
      }

      // æå–é‡‘é¢
      final amountMatch = RegExp(r'(\d+\.?\d*)å…ƒ?').firstMatch(text);
      if (amountMatch != null && !text.contains('ä½™é¢')) {
        amount = amountMatch.group(1);
      }

      // æå–å•†å®¶
      if (text.contains('å•†å®¶') || text.contains('æ”¶æ¬¾')) {
        merchant = text.replaceAll(RegExp(r'å•†å®¶[:ï¼š]|æ”¶æ¬¾[:ï¼š]'), '').trim();
      }
    }

    return ScreenshotParseResult(
      platform: PaymentPlatform.alipay,
      amount: double.tryParse(amount ?? '0'),
      merchant: merchant,
      paymentTime: paymentTime,
      orderNo: orderNo,
      status: status,
      confidence: _calculateConfidence(amount, merchant, paymentTime),
    );
  }
}
```

### 10.5 è‡ªç„¶è¯­è¨€ç†è§£å¼•æ“

#### 10.5.1 NLUè§£ææ¶æ„

```dart
/// è‡ªç„¶è¯­è¨€ç†è§£å¼•æ“
/// å°†è‡ªç”±æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–è®°è´¦æ•°æ®
class NLUEngine {
  final EntityExtractor _entityExtractor;
  final IntentClassifier _intentClassifier;
  final LLMService _llmService;
  final ContextManager _contextManager;

  /// NLUå¤„ç†æµç¨‹
  Future<NLUResult> parse(String text, {RecognitionContext? context}) async {
    // 1. é¢„å¤„ç†ï¼šæ ‡å‡†åŒ–æ–‡æœ¬
    final normalized = _preprocess(text);

    // 2. æ„å›¾è¯†åˆ«ï¼šåˆ¤æ–­æ˜¯å•ç¬”è®°è´¦ã€å¤šç¬”è®°è´¦ã€æŸ¥è¯¢è¿˜æ˜¯å…¶ä»–
    final intent = await _intentClassifier.classify(normalized);

    // 3. å®ä½“æå–ï¼šæå–é‡‘é¢ã€æ—¥æœŸã€å•†å®¶ã€æè¿°ç­‰
    final entities = await _entityExtractor.extract(normalized);

    // 4. æ ¹æ®æ„å›¾å¤„ç†
    switch (intent.type) {
      case IntentType.singleExpense:
        return await _parseSingleExpense(normalized, entities, context);
      case IntentType.multipleExpense:
        return await _parseMultipleExpenses(normalized, entities, context);
      case IntentType.income:
        return await _parseIncome(normalized, entities, context);
      case IntentType.transfer:
        return await _parseTransfer(normalized, entities, context);
      case IntentType.query:
        return NLUResult.query(intent: intent);
      default:
        // ä¸ç¡®å®šæ„å›¾æ—¶ï¼Œä½¿ç”¨LLMå…œåº•
        return await _llmFallback(normalized, context);
    }
  }

  /// æ–‡æœ¬é¢„å¤„ç†
  String _preprocess(String text) {
    return text
      .trim()
      .replaceAll(RegExp(r'\s+'), ' ')  // åˆå¹¶ç©ºç™½
      .replaceAll('ï¼Œ', ',')  // æ ‡å‡†åŒ–æ ‡ç‚¹
      .replaceAll('ã€‚', '.')
      .replaceAll('ï¼š', ':');
  }
}

/// æ„å›¾åˆ†ç±»å™¨
class IntentClassifier {
  /// æ„å›¾åˆ†ç±»è§„åˆ™
  Future<IntentResult> classify(String text) async {
    // æ”¶å…¥æ„å›¾å…³é”®è¯
    final incomeKeywords = ['æ”¶å…¥', 'å·¥èµ„', 'å¥–é‡‘', 'æŠ¥é”€', 'æ”¶åˆ°', 'è¿›è´¦', 'åˆ°è´¦'];
    // è½¬è´¦æ„å›¾å…³é”®è¯
    final transferKeywords = ['è½¬è´¦', 'è½¬ç»™', 'è¿˜æ¬¾', 'è¿˜é’±', 'å€Ÿç»™'];
    // æŸ¥è¯¢æ„å›¾å…³é”®è¯
    final queryKeywords = ['æŸ¥è¯¢', 'å¤šå°‘', 'èŠ±äº†', 'ç»Ÿè®¡', 'æœ¬æœˆ', 'ä¸Šå‘¨'];
    // å¤šç¬”è®°è´¦å…³é”®è¯
    final multiKeywords = ['è¿˜æœ‰', 'å¦å¤–', 'ä»¥åŠ', 'å’Œ', 'åŠ ä¸Š', ';', 'ï¼›'];

    if (incomeKeywords.any((k) => text.contains(k))) {
      return IntentResult(type: IntentType.income, confidence: 0.85);
    }

    if (transferKeywords.any((k) => text.contains(k))) {
      return IntentResult(type: IntentType.transfer, confidence: 0.85);
    }

    if (queryKeywords.any((k) => text.contains(k)) && !_hasAmount(text)) {
      return IntentResult(type: IntentType.query, confidence: 0.80);
    }

    if (multiKeywords.any((k) => text.contains(k)) && _countAmounts(text) > 1) {
      return IntentResult(type: IntentType.multipleExpense, confidence: 0.85);
    }

    // é»˜è®¤å•ç¬”æ”¯å‡º
    return IntentResult(type: IntentType.singleExpense, confidence: 0.75);
  }
}
```

#### 10.5.2 å®ä½“æå–

```dart
/// å®ä½“æå–å™¨
class EntityExtractor {

  /// æå–æ‰€æœ‰å®ä½“
  Future<ExtractedEntities> extract(String text) async {
    return ExtractedEntities(
      amounts: _extractAmounts(text),
      dates: _extractDates(text),
      merchants: _extractMerchants(text),
      descriptions: _extractDescriptions(text),
      people: _extractPeople(text),
    );
  }

  /// æå–é‡‘é¢å®ä½“
  List<AmountEntity> _extractAmounts(String text) {
    final amounts = <AmountEntity>[];

    // é‡‘é¢æ¨¡å¼åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    final patterns = [
      // Â¥123.45 æˆ– ï¿¥123.45
      (RegExp(r'[Â¥ï¿¥]\s*(\d+\.?\d*)'), 'currency_symbol'),
      // 123.45å…ƒ
      (RegExp(r'(\d+\.?\d*)\s*[å…ƒå—]'), 'unit_suffix'),
      // 123å—5æ¯› æˆ– 123å…ƒ5è§’
      (RegExp(r'(\d+)\s*[å…ƒå—](\d)[æ¯›è§’]'), 'mixed_unit'),
      // ä¸€ç™¾äºŒåä¸‰å—
      (RegExp(r'([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+)\s*[å…ƒå—]'), 'chinese_number'),
      // çº¯æ•°å­—ï¼ˆéœ€è¦ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼‰
      (RegExp(r'(?<![.\d])(\d+\.?\d*)(?![.\d])'), 'pure_number'),
    ];

    for (final (pattern, type) in patterns) {
      for (final match in pattern.allMatches(text)) {
        final rawValue = match.group(1)!;
        final value = type == 'chinese_number'
            ? _chineseToNumber(rawValue)
            : double.parse(rawValue);

        // å¤„ç†æ··åˆå•ä½ï¼ˆå¦‚ 123å—5æ¯›ï¼‰
        if (type == 'mixed_unit' && match.groupCount >= 2) {
          final cents = int.parse(match.group(2)!) / 10;
          amounts.add(AmountEntity(
            value: value + cents,
            rawText: match.group(0)!,
            position: match.start,
            confidence: 0.95,
          ));
        } else {
          amounts.add(AmountEntity(
            value: value,
            rawText: match.group(0)!,
            position: match.start,
            confidence: type == 'pure_number' ? 0.6 : 0.9,
          ));
        }
      }
    }

    // å»é‡ï¼ˆä½ç½®é‡å çš„ä¿ç•™ç½®ä¿¡åº¦é«˜çš„ï¼‰
    return _deduplicateByPosition(amounts);
  }

  /// æå–æ—¥æœŸå®ä½“
  List<DateEntity> _extractDates(String text) {
    final dates = <DateEntity>[];
    final now = DateTime.now();

    // ç›¸å¯¹æ—¥æœŸ
    final relativeDates = {
      'ä»Šå¤©': now,
      'æ˜¨å¤©': now.subtract(Duration(days: 1)),
      'å‰å¤©': now.subtract(Duration(days: 2)),
      'å¤§å‰å¤©': now.subtract(Duration(days: 3)),
      'ä¸Šå‘¨': now.subtract(Duration(days: now.weekday + 7)),
      'ä¸Šä¸ªæœˆ': DateTime(now.year, now.month - 1, now.day),
    };

    for (final entry in relativeDates.entries) {
      if (text.contains(entry.key)) {
        dates.add(DateEntity(
          value: entry.value,
          rawText: entry.key,
          position: text.indexOf(entry.key),
          isRelative: true,
          confidence: 0.95,
        ));
      }
    }

    // å‘¨å‡ è¡¨è¾¾
    final weekdayPattern = RegExp(r'(è¿™ä¸ª?|ä¸Šä¸ª?)?å‘¨([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])');
    for (final match in weekdayPattern.allMatches(text)) {
      final prefix = match.group(1);
      final dayName = match.group(2)!;
      final targetWeekday = _weekdayNameToNumber(dayName);

      var date = now;
      if (prefix?.contains('ä¸Š') ?? false) {
        // ä¸Šå‘¨X
        date = date.subtract(Duration(days: 7));
      }

      // è°ƒæ•´åˆ°ç›®æ ‡å‘¨å‡ 
      final daysToSubtract = (date.weekday - targetWeekday + 7) % 7;
      date = date.subtract(Duration(days: daysToSubtract));

      dates.add(DateEntity(
        value: date,
        rawText: match.group(0)!,
        position: match.start,
        isRelative: true,
        confidence: 0.90,
      ));
    }

    // ç»å¯¹æ—¥æœŸ (2024-01-15, 1æœˆ15æ—¥, 1/15ç­‰)
    final absolutePatterns = [
      RegExp(r'(\d{4})[-/å¹´](\d{1,2})[-/æœˆ](\d{1,2})æ—¥?'),
      RegExp(r'(\d{1,2})[-/æœˆ](\d{1,2})æ—¥?'),
    ];

    for (final pattern in absolutePatterns) {
      for (final match in pattern.allMatches(text)) {
        final groups = match.groups([1, 2, 3]).whereType<String>().toList();
        int year, month, day;

        if (groups.length == 3) {
          year = int.parse(groups[0]);
          month = int.parse(groups[1]);
          day = int.parse(groups[2]);
        } else {
          year = now.year;
          month = int.parse(groups[0]);
          day = int.parse(groups[1]);
        }

        dates.add(DateEntity(
          value: DateTime(year, month, day),
          rawText: match.group(0)!,
          position: match.start,
          isRelative: false,
          confidence: 0.95,
        ));
      }
    }

    return dates;
  }

  /// æå–å•†å®¶/æè¿°
  List<MerchantEntity> _extractMerchants(String text) {
    final merchants = <MerchantEntity>[];

    // å¸¸è§å•†å®¶å…³é”®è¯
    final merchantPatterns = [
      RegExp(r'åœ¨(.{2,10}?)(ä¹°|åƒ|æ¶ˆè´¹|èŠ±|ç”¨)'),
      RegExp(r'(å»)?(.{2,8}?)(åƒé¥­|è´­ç‰©|æ¶ˆè´¹)'),
      RegExp(r'(.{2,10}?)(çš„|è®¢å•|å¤–å–)'),
    ];

    for (final pattern in merchantPatterns) {
      final match = pattern.firstMatch(text);
      if (match != null) {
        final merchantName = match.group(1) ?? match.group(2);
        if (merchantName != null && merchantName.length >= 2) {
          merchants.add(MerchantEntity(
            name: merchantName.trim(),
            rawText: match.group(0)!,
            position: match.start,
            confidence: 0.7,
          ));
        }
      }
    }

    // å·²çŸ¥å•†å®¶åç§°åŒ¹é…ï¼ˆåŸºäºç”¨æˆ·å†å²ï¼‰
    // è¿™éƒ¨åˆ†éœ€è¦ä¸ç”¨æˆ·æ•°æ®ç»“åˆ

    return merchants;
  }

  /// ä¸­æ–‡æ•°å­—è½¬é˜¿æ‹‰ä¼¯æ•°å­—
  double _chineseToNumber(String chinese) {
    final digitMap = {
      'é›¶': 0, 'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4,
      'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9,
      'ä¸¤': 2,
    };

    final unitMap = {'å': 10, 'ç™¾': 100, 'åƒ': 1000, 'ä¸‡': 10000};

    double result = 0;
    double current = 0;

    for (final char in chinese.split('')) {
      if (digitMap.containsKey(char)) {
        current = digitMap[char]!.toDouble();
      } else if (unitMap.containsKey(char)) {
        if (current == 0 && char == 'å') current = 1;
        current *= unitMap[char]!;
        result += current;
        current = 0;
      }
    }

    return result + current;
  }
}
```

#### 10.5.3 LLMå¢å¼ºè§£æ

```dart
/// LLMå¢å¼ºè§£ææœåŠ¡
class LLMEnhancedParser {
  final QwenService _qwenService;

  /// ä½¿ç”¨LLMè§£æå¤æ‚æ–‡æœ¬
  Future<List<ParsedTransaction>> parseWithLLM(
    String text, {
    RecognitionContext? context,
  }) async {
    final prompt = '''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°è´¦åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–è®°è´¦ä¿¡æ¯ã€‚

ã€ç”¨æˆ·è¾“å…¥ã€‘
$text

ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘
${context != null ? '''
- å½“å‰æ—¥æœŸ: ${context.currentDate}
- ç”¨æˆ·å¸¸ç”¨åˆ†ç±»: ${context.frequentCategories.join(', ')}
- æœ€è¿‘è®°è´¦: ${context.recentTransactions.map((t) => '${t.description} Â¥${t.amount}').join(', ')}
''' : 'æ— '}

ã€è¦æ±‚ã€‘
1. è¯†åˆ«æ‰€æœ‰è®°è´¦ä¿¡æ¯ï¼ˆå¯èƒ½æœ‰å¤šç¬”ï¼‰
2. æ¯ç¬”è®°å½•éœ€åŒ…å«ï¼šé‡‘é¢(å¿…å¡«)ã€æè¿°(å¿…å¡«)ã€æ—¥æœŸ(å¯é€‰)ã€åˆ†ç±»å»ºè®®(å¯é€‰)
3. å¦‚æœæ–‡æœ¬ä¸­æåˆ°AAåˆ¶æˆ–åˆ†æ‘Šï¼Œéœ€è¦è®¡ç®—å®é™…é‡‘é¢
4. è¿”å›çº¯JSONæ•°ç»„ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—

ã€è¿”å›æ ¼å¼ã€‘
[
  {
    "amount": æ•°å­—,
    "description": "ç®€çŸ­æè¿°",
    "date": "YYYY-MM-DD æˆ– null",
    "suggestedCategory": "åˆ†ç±»å æˆ– null",
    "isExpense": true/false,
    "confidence": 0-1çš„ç½®ä¿¡åº¦,
    "notes": "è¡¥å……è¯´æ˜ï¼ˆå¦‚æœ‰AAç­‰ç‰¹æ®Šæƒ…å†µï¼‰"
  }
]
''';

    try {
      final response = await _qwenService.chat(prompt);
      final json = _extractJsonArray(response);
      final list = jsonDecode(json) as List;

      return list.map((item) => ParsedTransaction(
        amount: (item['amount'] as num).toDouble(),
        description: item['description'] as String,
        date: item['date'] != null ? DateTime.parse(item['date']) : null,
        suggestedCategory: item['suggestedCategory'] as String?,
        isExpense: item['isExpense'] as bool? ?? true,
        confidence: (item['confidence'] as num?)?.toDouble() ?? 0.8,
        notes: item['notes'] as String?,
        source: ParseSource.llm,
      )).toList();
    } catch (e) {
      debugPrint('LLM parse error: $e');
      return [];
    }
  }

  /// ä»å“åº”ä¸­æå–JSONæ•°ç»„
  String _extractJsonArray(String response) {
    final match = RegExp(r'\[[\s\S]*\]').firstMatch(response);
    return match?.group(0) ?? '[]';
  }
}
```

### 10.6 å¤šç¬”äº¤æ˜“æ™ºèƒ½æ‹†åˆ†

#### 10.6.1 å¤šç¬”äº¤æ˜“æ£€æµ‹

```dart
/// å¤šç¬”äº¤æ˜“æ£€æµ‹ä¸æ‹†åˆ†æœåŠ¡
class MultiTransactionDetector {
  final EntityExtractor _entityExtractor;
  final LLMEnhancedParser _llmParser;

  /// æ£€æµ‹æ˜¯å¦åŒ…å«å¤šç¬”äº¤æ˜“
  Future<MultiTransactionDetectionResult> detect(String text) async {
    // 1. æå–æ‰€æœ‰é‡‘é¢å®ä½“
    final entities = await _entityExtractor.extract(text);
    final amounts = entities.amounts;

    // 2. æ£€æµ‹å¤šç¬”äº¤æ˜“æŒ‡ç¤ºè¯
    final indicators = _detectMultiIndicators(text);

    // 3. åˆ¤æ–­æ˜¯å¦å¤šç¬”
    final isMultiple = amounts.length > 1 || indicators.isNotEmpty;

    if (!isMultiple) {
      return MultiTransactionDetectionResult(
        isMultiple: false,
        confidence: 0.9,
      );
    }

    // 4. å°è¯•æ‹†åˆ†
    final segments = await _segmentText(text, amounts, indicators);

    return MultiTransactionDetectionResult(
      isMultiple: true,
      segmentCount: segments.length,
      segments: segments,
      confidence: _calculateConfidence(amounts, indicators, segments),
    );
  }

  /// æ£€æµ‹å¤šç¬”äº¤æ˜“æŒ‡ç¤ºè¯
  List<MultiIndicator> _detectMultiIndicators(String text) {
    final indicators = <MultiIndicator>[];

    // åˆ†éš”ç¬¦ç±»å‹
    final separators = [
      (RegExp(r'[,ï¼Œ]'), SeparatorType.comma),
      (RegExp(r'[;ï¼›]'), SeparatorType.semicolon),
      (RegExp(r'[ã€‚.]'), SeparatorType.period),
      (RegExp(r'\n'), SeparatorType.newline),
    ];

    // è¿æ¥è¯ç±»å‹
    final connectors = [
      (RegExp(r'è¿˜æœ‰'), ConnectorType.addition),
      (RegExp(r'å¦å¤–'), ConnectorType.addition),
      (RegExp(r'ä»¥åŠ'), ConnectorType.addition),
      (RegExp(r'å’Œ'), ConnectorType.conjunction),
      (RegExp(r'åŠ ä¸Š'), ConnectorType.addition),
      (RegExp(r'å†'), ConnectorType.addition),
    ];

    for (final (pattern, type) in separators) {
      for (final match in pattern.allMatches(text)) {
        indicators.add(MultiIndicator(
          type: IndicatorType.separator,
          separatorType: type,
          position: match.start,
        ));
      }
    }

    for (final (pattern, type) in connectors) {
      for (final match in pattern.allMatches(text)) {
        indicators.add(MultiIndicator(
          type: IndicatorType.connector,
          connectorType: type,
          position: match.start,
        ));
      }
    }

    return indicators..sort((a, b) => a.position.compareTo(b.position));
  }

  /// æ–‡æœ¬åˆ†æ®µ
  Future<List<TextSegment>> _segmentText(
    String text,
    List<AmountEntity> amounts,
    List<MultiIndicator> indicators,
  ) async {
    if (amounts.length <= 1 && indicators.isEmpty) {
      return [TextSegment(text: text, startPos: 0, endPos: text.length)];
    }

    final segments = <TextSegment>[];
    final splitPositions = <int>[0];

    // æ ¹æ®æŒ‡ç¤ºè¯å’Œé‡‘é¢ä½ç½®ç¡®å®šåˆ†å‰²ç‚¹
    for (final indicator in indicators) {
      if (indicator.type == IndicatorType.separator) {
        splitPositions.add(indicator.position);
      } else if (indicator.type == IndicatorType.connector) {
        // è¿æ¥è¯ååˆ†å‰²
        splitPositions.add(indicator.position + 2);
      }
    }

    splitPositions.add(text.length);

    // åˆ›å»ºåˆ†æ®µ
    for (int i = 0; i < splitPositions.length - 1; i++) {
      final start = splitPositions[i];
      final end = splitPositions[i + 1];
      final segmentText = text.substring(start, end).trim();

      if (segmentText.isNotEmpty) {
        segments.add(TextSegment(
          text: segmentText,
          startPos: start,
          endPos: end,
        ));
      }
    }

    // éªŒè¯æ¯ä¸ªåˆ†æ®µæ˜¯å¦åŒ…å«æœ‰æ•ˆé‡‘é¢
    final validSegments = <TextSegment>[];
    for (final segment in segments) {
      final hasAmount = amounts.any((a) =>
        a.position >= segment.startPos && a.position < segment.endPos
      );

      if (hasAmount) {
        validSegments.add(segment);
      } else {
        // æ— é‡‘é¢çš„æ®µè½å¯èƒ½æ˜¯è¡¥å……æè¿°ï¼Œåˆå¹¶åˆ°å‰ä¸€æ®µ
        if (validSegments.isNotEmpty) {
          final prev = validSegments.last;
          validSegments[validSegments.length - 1] = TextSegment(
            text: '${prev.text} ${segment.text}',
            startPos: prev.startPos,
            endPos: segment.endPos,
          );
        }
      }
    }

    return validSegments;
  }
}
```

#### 10.6.2 AAåˆ¶ä¸åˆ†æ‘Šå¤„ç†

```dart
/// AAåˆ¶ä¸é‡‘é¢åˆ†æ‘Šå¤„ç†
class SplitBillHandler {

  /// æ£€æµ‹å¹¶å¤„ç†AAåˆ¶
  Future<AADetectionResult> detectAndProcessAA(String text, double totalAmount) async {
    // AAåˆ¶å…³é”®è¯
    final aaKeywords = ['AA', 'aa', 'A A', 'å¹³æ‘Š', 'å‡æ‘Š', 'åˆ†æ‘Š', 'å„ä»˜', 'æ¯äºº'];
    final hasAAKeyword = aaKeywords.any((k) => text.contains(k));

    if (!hasAAKeyword) {
      return AADetectionResult(isAA: false);
    }

    // æå–äººæ•°
    final peopleCount = _extractPeopleCount(text);

    if (peopleCount != null && peopleCount > 1) {
      final perPersonAmount = totalAmount / peopleCount;

      return AADetectionResult(
        isAA: true,
        totalAmount: totalAmount,
        peopleCount: peopleCount,
        perPersonAmount: perPersonAmount,
        confidence: 0.9,
      );
    }

    // å¦‚æœæ— æ³•ç¡®å®šäººæ•°ï¼Œè¿”å›å¾…ç¡®è®¤çŠ¶æ€
    return AADetectionResult(
      isAA: true,
      totalAmount: totalAmount,
      needsConfirmation: true,
      confidence: 0.7,
    );
  }

  /// æå–äººæ•°
  int? _extractPeopleCount(String text) {
    // æ¨¡å¼1: "å’ŒXXä¸€èµ·" -> 2äºº
    if (RegExp(r'å’Œ.+ä¸€èµ·').hasMatch(text)) {
      final peopleMatch = RegExp(r'å’Œ(\d+)ä¸ªäºº').firstMatch(text);
      if (peopleMatch != null) {
        return int.parse(peopleMatch.group(1)!) + 1;
      }
      return 2; // é»˜è®¤2äºº
    }

    // æ¨¡å¼2: "Xä¸ªäºº/ä½"
    final countPatterns = [
      RegExp(r'(\d+)\s*ä¸ªäºº'),
      RegExp(r'(\d+)\s*äºº'),
      RegExp(r'(\d+)\s*ä½'),
      RegExp(r'([äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å])\s*ä¸ªäºº'),
    ];

    for (final pattern in countPatterns) {
      final match = pattern.firstMatch(text);
      if (match != null) {
        final value = match.group(1)!;
        if (RegExp(r'\d+').hasMatch(value)) {
          return int.parse(value);
        } else {
          return _chineseToInt(value);
        }
      }
    }

    // æ¨¡å¼3: "æˆ‘ä»¬ä¸‰ä¸ª"
    final pronounPattern = RegExp(r'æˆ‘ä»¬([äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]|\d+)ä¸ª');
    final pronounMatch = pronounPattern.firstMatch(text);
    if (pronounMatch != null) {
      final value = pronounMatch.group(1)!;
      return RegExp(r'\d+').hasMatch(value) ? int.parse(value) : _chineseToInt(value);
    }

    return null;
  }

  int _chineseToInt(String chinese) {
    const map = {'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10};
    return map[chinese] ?? 2;
  }
}

/// AAæ£€æµ‹ç»“æœ
class AADetectionResult {
  final bool isAA;
  final double? totalAmount;
  final int? peopleCount;
  final double? perPersonAmount;
  final bool needsConfirmation;
  final double confidence;

  AADetectionResult({
    required this.isAA,
    this.totalAmount,
    this.peopleCount,
    this.perPersonAmount,
    this.needsConfirmation = false,
    this.confidence = 0.0,
  });
}
```

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šAAåˆ†æ‘Šä¸šåŠ¡é€»è¾‘å®ç°è¯¦è§[ç¬¬13.4èŠ‚ äº¤æ˜“åä½œä¸åˆ†æ‘Š](#134-äº¤æ˜“åä½œä¸åˆ†æ‘Š)

### 10.7 ä¸Šä¸‹æ–‡æ„ŸçŸ¥ä¸è¿ç»­è®°è´¦

#### 10.7.1 ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†

```dart
/// ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨
class RecognitionContextManager {
  final Map<String, ConversationSession> _sessions = {};
  final TransactionRepository _transactionRepo;
  final CategoryRepository _categoryRepo;

  /// è·å–æˆ–åˆ›å»ºä¼šè¯
  ConversationSession getOrCreateSession(String userId) {
    return _sessions.putIfAbsent(userId, () => ConversationSession(userId: userId));
  }

  /// æ„å»ºè¯†åˆ«ä¸Šä¸‹æ–‡
  Future<RecognitionContext> buildContext(String userId) async {
    final session = getOrCreateSession(userId);

    // è·å–ç”¨æˆ·å¸¸ç”¨åˆ†ç±»
    final frequentCategories = await _categoryRepo.getFrequentlyUsed(userId, limit: 10);

    // è·å–æœ€è¿‘äº¤æ˜“
    final recentTransactions = await _transactionRepo.getRecent(userId, limit: 5);

    // è·å–ä¸Šä¸€ç¬”å¾…ç¡®è®¤äº¤æ˜“
    final pendingTransaction = session.pendingTransaction;

    return RecognitionContext(
      currentDate: DateTime.now(),
      frequentCategories: frequentCategories,
      recentTransactions: recentTransactions,
      pendingTransaction: pendingTransaction,
      conversationHistory: session.history,
      lastMentionedMerchant: session.lastMentionedMerchant,
      lastMentionedCategory: session.lastMentionedCategory,
    );
  }

  /// æ›´æ–°ä¼šè¯çŠ¶æ€
  void updateSession(String userId, RecognitionResult result) {
    final session = getOrCreateSession(userId);

    // è®°å½•æœ¬æ¬¡è¯†åˆ«ç»“æœ
    session.addToHistory(ConversationTurn(
      input: result.rawText,
      output: result.transactions,
      timestamp: DateTime.now(),
    ));

    // æ›´æ–°ä¸Šä¸‹æ–‡æåŠ
    if (result.transactions.isNotEmpty) {
      final tx = result.transactions.first;
      if (tx.merchant != null) {
        session.lastMentionedMerchant = tx.merchant;
      }
      if (tx.categoryId != null) {
        session.lastMentionedCategory = tx.categoryId;
      }
    }
  }
}

/// ä¼šè¯çŠ¶æ€
class ConversationSession {
  final String userId;
  final List<ConversationTurn> history = [];
  ParsedTransaction? pendingTransaction;
  String? lastMentionedMerchant;
  String? lastMentionedCategory;
  DateTime lastActiveTime = DateTime.now();

  ConversationSession({required this.userId});

  void addToHistory(ConversationTurn turn) {
    history.add(turn);
    lastActiveTime = DateTime.now();

    // ä¿ç•™æœ€è¿‘10è½®å¯¹è¯
    if (history.length > 10) {
      history.removeAt(0);
    }
  }

  bool get isExpired => DateTime.now().difference(lastActiveTime) > Duration(minutes: 30);
}
```

#### 10.7.2 ä¸Šä¸‹æ–‡è¡¥å…¨

```dart
/// ä¸Šä¸‹æ–‡æ„ŸçŸ¥è¡¥å…¨æœåŠ¡
class ContextAwareCompleter {

  /// ä½¿ç”¨ä¸Šä¸‹æ–‡è¡¥å…¨ç¼ºå¤±å­—æ®µ
  Future<ParsedTransaction> complete(
    ParsedTransaction transaction,
    RecognitionContext context,
  ) async {
    var completed = transaction;

    // 1. è¡¥å…¨æ—¥æœŸï¼ˆå¦‚æœæœªæŒ‡å®šï¼Œé»˜è®¤ä»Šå¤©ï¼‰
    if (completed.date == null) {
      completed = completed.copyWith(date: context.currentDate);
    }

    // 2. è¡¥å…¨åˆ†ç±»ï¼ˆåŸºäºæè¿°å’Œä¸Šä¸‹æ–‡ï¼‰
    if (completed.categoryId == null) {
      final suggestedCategory = await _suggestCategory(completed, context);
      if (suggestedCategory != null) {
        completed = completed.copyWith(
          categoryId: suggestedCategory.id,
          categoryConfidence: suggestedCategory.confidence,
        );
      }
    }

    // 3. è¡¥å…¨å•†å®¶ï¼ˆä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­æœ€è¿‘æåŠçš„å•†å®¶ï¼‰
    if (completed.merchant == null && context.lastMentionedMerchant != null) {
      // æ£€æŸ¥æè¿°ä¸­æ˜¯å¦æœ‰ä»£è¯æŒ‡å‘å‰ä¸€å•†å®¶
      if (_hasProximateReference(completed.description)) {
        completed = completed.copyWith(merchant: context.lastMentionedMerchant);
      }
    }

    // 4. è¡¥å…¨é‡‘é¢å•ä½ï¼ˆå¤„ç†çœç•¥æƒ…å†µå¦‚"15å—"ï¼‰
    completed = _normalizeAmount(completed);

    return completed;
  }

  /// æ£€æµ‹æ˜¯å¦æœ‰æŒ‡ä»£å‰æ–‡çš„è¡¨è¾¾
  bool _hasProximateReference(String? description) {
    if (description == null) return false;

    final proxyWords = ['é‚£é‡Œ', 'é‚£å„¿', 'åŒä¸€å®¶', 'è¿˜æ˜¯', 'åˆ'];
    return proxyWords.any((w) => description.contains(w));
  }

  /// åŸºäºä¸Šä¸‹æ–‡æ¨èåˆ†ç±»
  Future<CategorySuggestion?> _suggestCategory(
    ParsedTransaction transaction,
    RecognitionContext context,
  ) async {
    // 1. æ£€æŸ¥æè¿°æ˜¯å¦åŒ¹é…å¸¸ç”¨åˆ†ç±»
    for (final category in context.frequentCategories) {
      if (_descriptionMatchesCategory(transaction.description, category)) {
        return CategorySuggestion(
          id: category.id,
          name: category.name,
          confidence: 0.85,
          reason: 'åŒ¹é…å¸¸ç”¨åˆ†ç±»',
        );
      }
    }

    // 2. æ£€æŸ¥æœ€è¿‘åŒç±»äº¤æ˜“
    for (final recent in context.recentTransactions) {
      if (_isSimilarTransaction(transaction, recent)) {
        return CategorySuggestion(
          id: recent.categoryId!,
          name: recent.categoryName,
          confidence: 0.80,
          reason: 'ä¸æœ€è¿‘äº¤æ˜“ç›¸ä¼¼',
        );
      }
    }

    // 3. ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­æœ€åæåŠçš„åˆ†ç±»ï¼ˆé€‚ç”¨äºè¿ç»­è®°è´¦åœºæ™¯ï¼‰
    if (context.lastMentionedCategory != null) {
      return CategorySuggestion(
        id: context.lastMentionedCategory!,
        confidence: 0.6,
        reason: 'å»¶ç»­ä¸Šä¸€ç¬”åˆ†ç±»',
      );
    }

    return null;
  }
}
```

### 10.8 ç¦»çº¿è¯†åˆ«ä¸é™çº§ç­–ç•¥

#### 10.8.1 ç¦»çº¿èƒ½åŠ›çŸ©é˜µ

```dart
/// ç¦»çº¿èƒ½åŠ›ç®¡ç†å™¨
class OfflineCapabilityManager {

  /// ç¦»çº¿èƒ½åŠ›é…ç½®
  static const Map<RecognitionFeature, OfflineSupport> capabilities = {
    // è¯­éŸ³è¯†åˆ«
    RecognitionFeature.voiceASR: OfflineSupport(
      supported: true,
      engine: 'Whisper Tiny',
      accuracy: 0.75,
      latency: '2-5ç§’',
      modelSize: '75MB',
    ),

    // OCRè¯†åˆ«
    RecognitionFeature.imageOCR: OfflineSupport(
      supported: true,
      engine: 'ML Kit / Tesseract',
      accuracy: 0.85,
      latency: '1-2ç§’',
      modelSize: '20MB',
    ),

    // NLUå®ä½“æå–
    RecognitionFeature.nluEntityExtract: OfflineSupport(
      supported: true,
      engine: 'è§„åˆ™å¼•æ“',
      accuracy: 0.80,
      latency: '<100ms',
      modelSize: '0',
    ),

    // æ™ºèƒ½åˆ†ç±»
    RecognitionFeature.smartCategory: OfflineSupport(
      supported: true,
      engine: 'TFLite + è§„åˆ™',
      accuracy: 0.70,
      latency: '<200ms',
      modelSize: '5MB',
    ),

    // LLMå¢å¼ºè§£æ
    RecognitionFeature.llmEnhanced: OfflineSupport(
      supported: false,
      fallback: 'è§„åˆ™å¼•æ“å…œåº•',
    ),

    // å¤æ‚è¯­ä¹‰ç†è§£
    RecognitionFeature.complexSemantic: OfflineSupport(
      supported: false,
      fallback: 'åŸºç¡€å®ä½“æå–',
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  Future<bool> isFeatureAvailable(RecognitionFeature feature) async {
    final isOnline = await _networkChecker.isOnline();

    if (isOnline) return true;

    return capabilities[feature]?.supported ?? false;
  }

  /// è·å–å½“å‰å¯ç”¨çš„æœ€ä½³ç­–ç•¥
  Future<RecognitionStrategy> getBestStrategy() async {
    final isOnline = await _networkChecker.isOnline();

    if (isOnline) {
      return RecognitionStrategy.full;
    }

    return RecognitionStrategy.offline;
  }
}

/// ç¦»çº¿æ”¯æŒä¿¡æ¯
class OfflineSupport {
  final bool supported;
  final String? engine;
  final double? accuracy;
  final String? latency;
  final String? modelSize;
  final String? fallback;

  const OfflineSupport({
    required this.supported,
    this.engine,
    this.accuracy,
    this.latency,
    this.modelSize,
    this.fallback,
  });
}
```

#### 10.8.2 é™çº§ç­–ç•¥å®ç°

```dart
/// è¯†åˆ«æœåŠ¡é™çº§ç®¡ç†å™¨
class RecognitionDegradationManager {
  final OfflineCapabilityManager _offlineManager;
  final CircuitBreaker _circuitBreaker;

  /// æ‰§è¡Œè¯†åˆ«ï¼ˆå¸¦é™çº§ï¼‰
  Future<RecognitionResult> recognizeWithDegradation(
    RecognitionInput input,
    RecognitionStrategy preferredStrategy,
  ) async {
    // 1. æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
    if (_circuitBreaker.isOpen) {
      return await _executeOffline(input);
    }

    // 2. å°è¯•é¦–é€‰ç­–ç•¥
    try {
      switch (preferredStrategy) {
        case RecognitionStrategy.full:
          return await _executeFull(input);
        case RecognitionStrategy.hybrid:
          return await _executeHybrid(input);
        case RecognitionStrategy.offline:
          return await _executeOffline(input);
      }
    } catch (e) {
      // 3. è®°å½•å¤±è´¥å¹¶é™çº§
      _circuitBreaker.recordFailure();
      return await _handleDegradation(input, e);
    }
  }

  /// å®Œæ•´åœ¨çº¿ç­–ç•¥
  Future<RecognitionResult> _executeFull(RecognitionInput input) async {
    // ä½¿ç”¨æ‰€æœ‰åœ¨çº¿èƒ½åŠ›
    final result = await _onlineRecognitionService.recognize(input);
    _circuitBreaker.recordSuccess();
    return result;
  }

  /// æ··åˆç­–ç•¥ï¼ˆæœ¬åœ°é¢„å¤„ç† + åœ¨çº¿å¢å¼ºï¼‰
  Future<RecognitionResult> _executeHybrid(RecognitionInput input) async {
    // æœ¬åœ°å¿«é€Ÿè¯†åˆ«
    final localResult = await _offlineRecognitionService.recognize(input);

    // å¦‚æœç½®ä¿¡åº¦è¶³å¤Ÿé«˜ï¼Œç›´æ¥è¿”å›
    if (localResult.confidence > 0.85) {
      return localResult;
    }

    // ç½®ä¿¡åº¦ä¸è¶³ï¼Œä½¿ç”¨åœ¨çº¿æœåŠ¡å¢å¼º
    try {
      final enhancedResult = await _onlineRecognitionService.enhance(localResult);
      _circuitBreaker.recordSuccess();
      return enhancedResult;
    } catch (e) {
      // åœ¨çº¿å¢å¼ºå¤±è´¥ï¼Œè¿”å›æœ¬åœ°ç»“æœ
      return localResult.copyWith(
        isEnhanced: false,
        degradationReason: 'åœ¨çº¿å¢å¼ºæœåŠ¡æš‚ä¸å¯ç”¨',
      );
    }
  }

  /// çº¯ç¦»çº¿ç­–ç•¥
  Future<RecognitionResult> _executeOffline(RecognitionInput input) async {
    return await _offlineRecognitionService.recognize(input);
  }

  /// å¤„ç†é™çº§
  Future<RecognitionResult> _handleDegradation(
    RecognitionInput input,
    Object error,
  ) async {
    // è®°å½•é™çº§äº‹ä»¶
    _analytics.logDegradation(error: error, input: input.type);

    // å°è¯•ç¦»çº¿è¯†åˆ«
    final offlineResult = await _executeOffline(input);

    return offlineResult.copyWith(
      isDegraded: true,
      degradationReason: _getDegradationReason(error),
    );
  }

  String _getDegradationReason(Object error) {
    if (error is SocketException) {
      return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²ä½¿ç”¨ç¦»çº¿è¯†åˆ«';
    } else if (error is TimeoutException) {
      return 'æœåŠ¡å“åº”è¶…æ—¶ï¼Œå·²ä½¿ç”¨ç¦»çº¿è¯†åˆ«';
    } else {
      return 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä½¿ç”¨ç¦»çº¿è¯†åˆ«';
    }
  }
}

/// ç†”æ–­å™¨
class CircuitBreaker {
  int _failureCount = 0;
  DateTime? _lastFailureTime;
  static const int _failureThreshold = 3;
  static const Duration _resetTimeout = Duration(minutes: 5);

  bool get isOpen {
    if (_failureCount < _failureThreshold) return false;
    if (_lastFailureTime == null) return false;

    // è¶…è¿‡é‡ç½®æ—¶é—´åè‡ªåŠ¨å…³é—­
    if (DateTime.now().difference(_lastFailureTime!) > _resetTimeout) {
      _failureCount = 0;
      return false;
    }

    return true;
  }

  void recordFailure() {
    _failureCount++;
    _lastFailureTime = DateTime.now();
  }

  void recordSuccess() {
    _failureCount = 0;
  }
}
```

### 10.9 è¯†åˆ«è´¨é‡ä¿éšœ

#### 10.9.1 ç½®ä¿¡åº¦è¯„ä¼°æ¨¡å‹

```dart
/// è¯†åˆ«ç»“æœç½®ä¿¡åº¦è¯„ä¼°å™¨
class ConfidenceEvaluator {

  /// è¯„ä¼°æ•´ä½“è¯†åˆ«ç½®ä¿¡åº¦
  double evaluate(RecognitionResult result) {
    // å„ç»´åº¦æƒé‡
    const weights = {
      'source': 0.3,      // æ•°æ®æ¥æºå¯é æ€§
      'completeness': 0.25, // å­—æ®µå®Œæ•´åº¦
      'consistency': 0.25,  // å†…éƒ¨ä¸€è‡´æ€§
      'model': 0.2,       // æ¨¡å‹ç½®ä¿¡åº¦
    };

    double score = 0;

    // 1. æ¥æºå¯é æ€§è¯„åˆ†
    score += weights['source']! * _evaluateSourceReliability(result);

    // 2. å­—æ®µå®Œæ•´åº¦è¯„åˆ†
    score += weights['completeness']! * _evaluateCompleteness(result);

    // 3. å†…éƒ¨ä¸€è‡´æ€§è¯„åˆ†
    score += weights['consistency']! * _evaluateConsistency(result);

    // 4. æ¨¡å‹ç½®ä¿¡åº¦
    score += weights['model']! * result.metadata.modelConfidence;

    return score.clamp(0.0, 1.0);
  }

  /// è¯„ä¼°æ¥æºå¯é æ€§
  double _evaluateSourceReliability(RecognitionResult result) {
    // ä¸åŒæ¥æºçš„åŸºç¡€å¯é æ€§
    const sourceReliability = {
      RecognitionSource.image: 0.9,    // å›¾åƒè¯æ®æœ€å¯é 
      RecognitionSource.voice: 0.8,    // è¯­éŸ³æ¬¡ä¹‹
      RecognitionSource.text: 0.85,    // æ–‡æœ¬è¾“å…¥è¾ƒå¯é 
      RecognitionSource.mixed: 0.85,   // æ··åˆæ¥æº
    };

    return sourceReliability[result.source] ?? 0.7;
  }

  /// è¯„ä¼°å­—æ®µå®Œæ•´åº¦
  double _evaluateCompleteness(RecognitionResult result) {
    if (result.transactions.isEmpty) return 0;

    final tx = result.transactions.first;
    int filledFields = 0;
    int totalFields = 5;

    if (tx.amount > 0) filledFields++;
    if (tx.description?.isNotEmpty ?? false) filledFields++;
    if (tx.date != null) filledFields++;
    if (tx.categoryId != null) filledFields++;
    if (tx.merchant?.isNotEmpty ?? false) filledFields++;

    return filledFields / totalFields;
  }

  /// è¯„ä¼°å†…éƒ¨ä¸€è‡´æ€§
  double _evaluateConsistency(RecognitionResult result) {
    if (result.transactions.isEmpty) return 0;

    double score = 1.0;

    for (final tx in result.transactions) {
      // æ£€æŸ¥é‡‘é¢åˆç†æ€§
      if (tx.amount <= 0 || tx.amount > 1000000) {
        score -= 0.2;
      }

      // æ£€æŸ¥æ—¥æœŸåˆç†æ€§
      if (tx.date != null) {
        final daysDiff = DateTime.now().difference(tx.date!).inDays;
        if (daysDiff < -1 || daysDiff > 365) {
          score -= 0.1;
        }
      }

      // æ£€æŸ¥æè¿°ä¸åˆ†ç±»æ˜¯å¦åŒ¹é…ï¼ˆå¦‚æœéƒ½æœ‰ï¼‰
      if (tx.description != null && tx.categoryId != null) {
        if (!_descriptionMatchesCategory(tx.description!, tx.categoryId!)) {
          score -= 0.1;
        }
      }
    }

    return score.clamp(0.0, 1.0);
  }
}
```

#### 10.9.2 ç”¨æˆ·åé¦ˆå­¦ä¹ 

```dart
/// ç”¨æˆ·åé¦ˆå­¦ä¹ æœåŠ¡
class FeedbackLearningService {
  final FeedbackRepository _feedbackRepo;
  final LocalMLService _localML;

  /// è®°å½•ç”¨æˆ·åé¦ˆ
  Future<void> recordFeedback(RecognitionFeedback feedback) async {
    await _feedbackRepo.save(feedback);

    // è§¦å‘å¢é‡å­¦ä¹ ï¼ˆå¦‚æœç§¯ç´¯è¶³å¤Ÿæ ·æœ¬ï¼‰
    final pendingCount = await _feedbackRepo.getPendingCount();
    if (pendingCount >= 50) {
      await _triggerIncrementalLearning();
    }
  }

  /// å¢é‡å­¦ä¹ 
  Future<void> _triggerIncrementalLearning() async {
    final feedbacks = await _feedbackRepo.getPendingFeedbacks(limit: 100);

    // æŒ‰åé¦ˆç±»å‹åˆ†ç»„å¤„ç†
    final categoryCorrections = feedbacks
        .where((f) => f.type == FeedbackType.categoryCorrection)
        .toList();

    final amountCorrections = feedbacks
        .where((f) => f.type == FeedbackType.amountCorrection)
        .toList();

    // æ›´æ–°æœ¬åœ°MLæ¨¡å‹
    if (categoryCorrections.length >= 20) {
      await _updateCategoryModel(categoryCorrections);
    }

    // æ›´æ–°è§„åˆ™å¼•æ“
    await _updateRules(feedbacks);

    // æ ‡è®°å·²å¤„ç†
    await _feedbackRepo.markAsProcessed(feedbacks.map((f) => f.id).toList());
  }

  /// æ›´æ–°åˆ†ç±»æ¨¡å‹
  Future<void> _updateCategoryModel(List<RecognitionFeedback> corrections) async {
    // å‡†å¤‡è®­ç»ƒæ•°æ®
    final trainingData = corrections.map((c) => TrainingSample(
      input: c.originalRecognition.rawText,
      expectedOutput: c.correctedValue,
    )).toList();

    // å¢é‡è®­ç»ƒ
    await _localML.incrementalTrain(trainingData);
  }

  /// æ›´æ–°è§„åˆ™å¼•æ“
  Future<void> _updateRules(List<RecognitionFeedback> feedbacks) async {
    // åˆ†æåé¦ˆæ¨¡å¼ï¼Œå‘ç°æ–°è§„åˆ™
    final patterns = _analyzePatterns(feedbacks);

    for (final pattern in patterns) {
      if (pattern.occurrences >= 5 && pattern.confidence > 0.8) {
        // æ·»åŠ æ–°è§„åˆ™
        await _ruleEngine.addRule(Rule(
          pattern: pattern.regex,
          action: pattern.action,
          priority: pattern.priority,
        ));
      }
    }
  }
}

/// è¯†åˆ«åé¦ˆ
class RecognitionFeedback {
  final String id;
  final FeedbackType type;
  final RecognitionResult originalRecognition;
  final dynamic correctedValue;
  final DateTime timestamp;
  final String? userId;

  RecognitionFeedback({
    required this.id,
    required this.type,
    required this.originalRecognition,
    required this.correctedValue,
    required this.timestamp,
    this.userId,
  });
}

enum FeedbackType {
  categoryCorrection,   // åˆ†ç±»ä¿®æ­£
  amountCorrection,     // é‡‘é¢ä¿®æ­£
  dateCorrection,       // æ—¥æœŸä¿®æ­£
  merchantCorrection,   // å•†å®¶ä¿®æ­£
  splitCorrection,      // å¤šç¬”æ‹†åˆ†ä¿®æ­£
  rejected,             // æ•´ä½“æ‹’ç»
}
```

---


---

## 11. æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ

æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿæ˜¯2.0ç‰ˆæœ¬çš„**æ•°æ®è¿ç§»ä¸äº’é€šåŸºç¡€è®¾æ–½**ï¼Œå¸®åŠ©ç”¨æˆ·ä»å…¶ä»–è®°è´¦å·¥å…·è¿ç§»æ•°æ®ï¼Œå¹¶æ”¯æŒæ•°æ®å¤‡ä»½ä¸åˆ†äº«ã€‚

### 11.0 è®¾è®¡åŸåˆ™å›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å•ä¸€èŒè´£åŸåˆ™   â”‚     â”‚   æ•°æ®ä¸€è‡´æ€§    â”‚     â”‚   æç®€è®¾è®¡åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ è§£æå™¨ç‹¬ç«‹äº    â”‚     â”‚ ä¸‰å±‚å»é‡ä¿è¯    â”‚     â”‚ æ™ºèƒ½æ ¼å¼è¯†åˆ«    â”‚      â”‚
â”‚   â”‚ å¯¼å…¥é€»è¾‘        â”‚     â”‚ æ•°æ®ä¸é‡å¤      â”‚     â”‚ ä¸€é”®å¯¼å…¥å¯¼å‡º    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚    æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ            â”‚                       â”‚
â”‚                    â”‚   DataImportExportSystem      â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–²                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   å¯æ‰©å±•æ€§åŸåˆ™   â”‚     â”‚   æ€§èƒ½ä¸æˆæœ¬    â”‚     â”‚   å¯è§‚æµ‹æ€§åŸåˆ™   â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ æ’ä»¶åŒ–è§£æå™¨    â”‚     â”‚ æ‰¹é‡å¤„ç†ä¼˜åŒ–    â”‚     â”‚ å¯¼å…¥è¿›åº¦å¯è§†åŒ–  â”‚      â”‚
â”‚   â”‚ æ”¯æŒæ–°æ•°æ®æº    â”‚     â”‚ å¤§æ–‡ä»¶åˆ†ç‰‡å¤„ç†  â”‚     â”‚ å»é‡ç»“æœé€æ˜    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š

| åŸåˆ™ | åœ¨å¯¼å…¥å¯¼å‡ºç³»ç»Ÿä¸­çš„ä½“ç° |
|------|----------------------|
| **å•ä¸€èŒè´£** | æ¯ç§æ•°æ®æºæœ‰ç‹¬ç«‹è§£æå™¨ï¼ˆå¾®ä¿¡Parserã€æ”¯ä»˜å®Parserç­‰ï¼‰ï¼Œäº’ä¸å¹²æ‰° |
| **æ•°æ®ä¸€è‡´æ€§** | ä¸‰å±‚å»é‡æœºåˆ¶ï¼ˆç²¾ç¡®åŒ¹é…â†’ç‰¹å¾åŒ¹é…â†’è¯­ä¹‰åŒ¹é…ï¼‰ç¡®ä¿ä¸äº§ç”Ÿé‡å¤æ•°æ® |
| **æç®€è®¾è®¡** | æ™ºèƒ½æ ¼å¼æ£€æµ‹ï¼Œç”¨æˆ·åªéœ€é€‰æ‹©æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® |
| **å¯æ‰©å±•æ€§** | è§£æå™¨æ’ä»¶åŒ–è®¾è®¡ï¼Œå¯å¿«é€Ÿæ·»åŠ æ–°é“¶è¡Œ/æ–°APPçš„è´¦å•æ ¼å¼æ”¯æŒ |
| **æ€§èƒ½ä¼˜åŒ–** | å¤§æ–‡ä»¶åˆ†ç‰‡å¤„ç†ã€æ‰¹é‡å†™å…¥ã€è¿›åº¦åé¦ˆ |
| **å¯è§‚æµ‹æ€§** | å¯¼å…¥é¢„è§ˆã€å»é‡ç»“æœå±•ç¤ºã€é”™è¯¯è¯¦æƒ…è¯´æ˜ |

**ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯¼å…¥å¯¼å‡ºç³»ç»Ÿä¸2.0æ ¸å¿ƒæ¨¡å—ååŒå›¾                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  äº¤æ˜“è®°è´¦ç³»ç»Ÿ â”‚â—„â”€â”€â”€â”€â”€â”€â”€ å¯¼å…¥æ•°æ®å†™å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ  â”‚            â”‚
â”‚   â”‚  (ç¬¬6ç« )     â”‚         äº¤æ˜“è¡¨              â”‚  (æœ¬ç« )      â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â–¼                                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  é’±é¾„åˆ†æç³»ç»Ÿ â”‚â—„â”€â”€â”€â”€â”€â”€â”€ å¯¼å…¥åè§¦å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ  â”‚            â”‚
â”‚   â”‚  (ç¬¬7ç« )     â”‚         é’±é¾„é‡ç®—              â”‚  (ç¬¬8ç« )     â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â”‚                                             â”‚                   â”‚
â”‚          â–¼                                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  AIè¯†åˆ«ç³»ç»Ÿ   â”‚â—„â”€â”€â”€â”€â”€â”€â”€ æ™ºèƒ½åˆ†ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ æ•°æ®è”åŠ¨ç³»ç»Ÿ  â”‚            â”‚
â”‚   â”‚  (ç¬¬10ç« )    â”‚         è¾…åŠ©å¯¼å…¥              â”‚  (ç¬¬12ç« )    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                          2.0æ–°å¢åä½œæ¨¡å—                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å®¶åº­è´¦æœ¬    â”‚  â”‚  è¯­éŸ³äº¤äº’    â”‚  â”‚  è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚  ä½ç½®æ™ºèƒ½åŒ–  â”‚   â”‚
â”‚   â”‚  (ç¬¬13ç« )    â”‚  â”‚  (ç¬¬18ç« )    â”‚  â”‚  (ç¬¬17ç« )    â”‚  â”‚  (ç¬¬14ç« )    â”‚   â”‚
â”‚   â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚
â”‚   â”‚ å®¶åº­å…±äº«å¯¼å…¥ â”‚  â”‚ è¯­éŸ³è§¦å‘å¯¼å…¥ â”‚  â”‚ å­¦ä¹ ç”¨æˆ·ä¹ æƒ¯ â”‚  â”‚ ä½ç½®å¢å¼ºåˆ†ç±» â”‚   â”‚
â”‚   â”‚ æˆå‘˜æ•°æ®åŒæ­¥ â”‚  â”‚ è¿›åº¦æ’­æŠ¥     â”‚  â”‚ ä¼˜åŒ–åˆ†ç±»å»ºè®® â”‚  â”‚ åœºæ™¯è¡¥å……     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’¡ å¯¼å…¥å¯¼å‡ºæ˜¯æ•°æ®è¿ç§»çš„å…¥å£ï¼Œéœ€è¦ä¸å¤šä¸ªç³»ç»ŸååŒç¡®ä¿æ•°æ®å®Œæ•´æ€§              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.1 æ™ºèƒ½å¯¼å…¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ™ºèƒ½æ•°æ®å¯¼å…¥æµç¨‹ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚ ç”¨æˆ·æˆæƒ    â”‚â”€â”€â”€â”€â†’â”‚ æ™ºèƒ½ç›®å½•å‘ç° â”‚â”€â”€â”€â”€â†’â”‚ è´¦å•æ–‡ä»¶æ£€æµ‹ â”‚                  â”‚
â”‚   â”‚ å­˜å‚¨æƒé™    â”‚     â”‚ æ‰«æé»˜è®¤è·¯å¾„ â”‚     â”‚ è¯†åˆ«å¯å¯¼å…¥æ–‡ä»¶â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                   â”‚                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                              â”‚                    â”‚                    â”‚    â”‚
â”‚                              â–¼                    â–¼                    â–¼    â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                       â”‚ æ‰¾åˆ°æ–‡ä»¶  â”‚        â”‚ æœªæ‰¾åˆ°æ–‡ä»¶ â”‚        â”‚æ‰‹åŠ¨é€‰æ‹© â”‚â”‚
â”‚                       â”‚ å±•ç¤ºåˆ—è¡¨  â”‚        â”‚ å¼•å¯¼ç”¨æˆ·   â”‚        â”‚å…¶ä»–ç›®å½• â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”‚                             â”‚                    â”‚                   â”‚     â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚æ–‡ä»¶é€‰æ‹© â”‚â”€â”€â”€â”€â†’â”‚æ ¼å¼æ£€æµ‹ â”‚â”€â”€â”€â”€â†’â”‚æ•°æ®è§£æ â”‚â”€â”€â”€â”€â†’â”‚å­—æ®µæ˜ å°„ â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                      â”‚                     â”‚
â”‚                                                      â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚å¯¼å…¥å®Œæˆ â”‚â†â”€â”€â”€â”€â”‚æ•°æ®å†™å…¥ â”‚â†â”€â”€â”€â”€â”‚ç”¨æˆ·ç¡®è®¤ â”‚â†â”€â”€â”€â”€â”‚æ™ºèƒ½å»é‡ â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.1.1 æ™ºèƒ½è´¦å•ç›®å½•å‘ç°

ç”¨æˆ·æˆæƒå­˜å‚¨æƒé™åï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰«æå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰åº”ç”¨çš„é»˜è®¤è´¦å•å¯¼å‡ºç›®å½•ï¼Œç®€åŒ–ç”¨æˆ·æ“ä½œæµç¨‹ã€‚

**é»˜è®¤æ‰«æç›®å½•é…ç½®**ï¼š

```dart
/// è´¦å•ç›®å½•å‘ç°æœåŠ¡
class BillDirectoryDiscoveryService {
  /// å„å¹³å°é»˜è®¤è´¦å•å¯¼å‡ºè·¯å¾„
  static final Map<String, List<String>> defaultBillPaths = {
    'wechat': [
      // Android å¾®ä¿¡è´¦å•é»˜è®¤å¯¼å‡ºè·¯å¾„
      '/storage/emulated/0/Download/å¾®ä¿¡æ”¯ä»˜è´¦å•',
      '/storage/emulated/0/Download/WeChat',
      '/storage/emulated/0/tencent/MicroMsg/Download',
      '/storage/emulated/0/Android/data/com.tencent.mm/files/Download',
      // é€šç”¨ä¸‹è½½ç›®å½•
      '/storage/emulated/0/Download',
    ],
    'alipay': [
      // Android æ”¯ä»˜å®è´¦å•é»˜è®¤å¯¼å‡ºè·¯å¾„
      '/storage/emulated/0/Download/æ”¯ä»˜å®è´¦å•',
      '/storage/emulated/0/Download/alipay',
      '/storage/emulated/0/alipay',
      '/storage/emulated/0/Android/data/com.eg.android.AlipayGphone/files/bill',
      // é€šç”¨ä¸‹è½½ç›®å½•
      '/storage/emulated/0/Download',
    ],
    'unionpay': [
      // äº‘é—ªä»˜è´¦å•å¯¼å‡ºè·¯å¾„
      '/storage/emulated/0/Download/äº‘é—ªä»˜è´¦å•',
      '/storage/emulated/0/Download/UnionPay',
    ],
    'bank': [
      // é“¶è¡ŒAPPå¸¸è§å¯¼å‡ºè·¯å¾„
      '/storage/emulated/0/Download',
      '/storage/emulated/0/Documents',
    ],
  };

  /// è´¦å•æ–‡ä»¶ååŒ¹é…æ¨¡å¼
  static final Map<String, List<RegExp>> filePatterns = {
    'wechat': [
      RegExp(r'å¾®ä¿¡æ”¯ä»˜è´¦å•.*\.csv$', caseSensitive: false),
      RegExp(r'wechat.*bill.*\.csv$', caseSensitive: false),
    ],
    'alipay': [
      RegExp(r'alipay_record.*\.csv$', caseSensitive: false),
      RegExp(r'æ”¯ä»˜å®.*è´¦å•.*\.csv$', caseSensitive: false),
    ],
    'unionpay': [
      RegExp(r'äº‘é—ªä»˜.*è´¦å•.*\.csv$', caseSensitive: false),
    ],
    'generic': [
      RegExp(r'.*è´¦å•.*\.(csv|xlsx?)$', caseSensitive: false),
      RegExp(r'.*bill.*\.(csv|xlsx?)$', caseSensitive: false),
    ],
  };

  /// æ‰«æå‘ç°çš„è´¦å•æ–‡ä»¶
  Future<BillDiscoveryResult> discoverBills() async {
    final discovered = <DiscoveredBill>[];
    final scannedPaths = <String>[];

    for (final entry in defaultBillPaths.entries) {
      final source = entry.key;
      final paths = entry.value;

      for (final path in paths) {
        scannedPaths.add(path);
        final dir = Directory(path);

        if (!await dir.exists()) continue;

        await for (final entity in dir.list()) {
          if (entity is File) {
            final fileName = entity.path.split('/').last;
            final matchedSource = _matchFileToSource(fileName);

            if (matchedSource != null) {
              final stat = await entity.stat();
              discovered.add(DiscoveredBill(
                path: entity.path,
                fileName: fileName,
                source: matchedSource,
                size: stat.size,
                modifiedTime: stat.modified,
              ));
            }
          }
        }
      }
    }

    // æŒ‰ä¿®æ”¹æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    discovered.sort((a, b) => b.modifiedTime.compareTo(a.modifiedTime));

    return BillDiscoveryResult(
      bills: discovered,
      scannedPaths: scannedPaths,
      isEmpty: discovered.isEmpty,
    );
  }

  /// åŒ¹é…æ–‡ä»¶ååˆ°æ•°æ®æº
  String? _matchFileToSource(String fileName) {
    for (final entry in filePatterns.entries) {
      for (final pattern in entry.value) {
        if (pattern.hasMatch(fileName)) {
          return entry.key;
        }
      }
    }
    return null;
  }
}

/// å‘ç°çš„è´¦å•æ–‡ä»¶
class DiscoveredBill {
  final String path;
  final String fileName;
  final String source;      // wechat, alipay, unionpay, bank, generic
  final int size;
  final DateTime modifiedTime;

  DiscoveredBill({
    required this.path,
    required this.fileName,
    required this.source,
    required this.size,
    required this.modifiedTime,
  });

  /// è·å–æ•°æ®æºæ˜¾ç¤ºåç§°
  String get sourceDisplayName {
    switch (source) {
      case 'wechat': return 'å¾®ä¿¡æ”¯ä»˜';
      case 'alipay': return 'æ”¯ä»˜å®';
      case 'unionpay': return 'äº‘é—ªä»˜';
      case 'bank': return 'é“¶è¡Œè´¦å•';
      default: return 'å…¶ä»–è´¦å•';
    }
  }

  /// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  String get formattedSize {
    if (size < 1024) return '$size B';
    if (size < 1024 * 1024) return '${(size / 1024).toStringAsFixed(1)} KB';
    return '${(size / (1024 * 1024)).toStringAsFixed(1)} MB';
  }
}

/// è´¦å•å‘ç°ç»“æœ
class BillDiscoveryResult {
  final List<DiscoveredBill> bills;
  final List<String> scannedPaths;
  final bool isEmpty;

  BillDiscoveryResult({
    required this.bills,
    required this.scannedPaths,
    required this.isEmpty,
  });

  /// æŒ‰æ•°æ®æºåˆ†ç»„
  Map<String, List<DiscoveredBill>> get groupedBySource {
    final grouped = <String, List<DiscoveredBill>>{};
    for (final bill in bills) {
      grouped.putIfAbsent(bill.source, () => []).add(bill);
    }
    return grouped;
  }
}
```

**æ™ºèƒ½å‘ç°äº¤äº’æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ™ºèƒ½è´¦å•å‘ç°äº¤äº’æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ç”¨æˆ·ç‚¹å‡»"å¯¼å…¥è´¦å•"                                                         â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚
â”‚   â”‚ æ£€æŸ¥å­˜å‚¨æƒé™        â”‚                                                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚              â”‚                                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚      â”‚               â”‚                                                     â”‚
â”‚      â–¼               â–¼                                                     â”‚
â”‚   å·²æˆæƒ          æœªæˆæƒ                                                    â”‚
â”‚      â”‚               â”‚                                                     â”‚
â”‚      â”‚               â–¼                                                     â”‚
â”‚      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚        â”‚ è¯·æ±‚æƒé™å¼¹çª—                         â”‚                     â”‚
â”‚      â”‚        â”‚ "ä¸ºäº†è‡ªåŠ¨å‘ç°è´¦å•æ–‡ä»¶ï¼Œéœ€è¦è®¿é—®å­˜å‚¨"  â”‚                     â”‚
â”‚      â”‚        â”‚ [å…è®¸] [ä»…æ‰‹åŠ¨é€‰æ‹©]                  â”‚                     â”‚
â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚                       â”‚                                             â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                              â”‚                                         â”‚   â”‚
â”‚                              â–¼                                         â–¼   â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                       â”‚ æ‰«æé»˜è®¤ç›®å½• â”‚                           â”‚æ‰‹åŠ¨é€‰æ‹© â”‚â”‚
â”‚                       â”‚ æ˜¾ç¤ºè¿›åº¦æ¡   â”‚                           â”‚æ–‡ä»¶    â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                       â”‚     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚     â”‚
â”‚              â”‚               â”‚               â”‚                       â”‚     â”‚
â”‚              â–¼               â–¼               â–¼                       â”‚     â”‚
â”‚        æ‰¾åˆ°å¤šä¸ªæ–‡ä»¶    æ‰¾åˆ°1ä¸ªæ–‡ä»¶     æœªæ‰¾åˆ°æ–‡ä»¶                     â”‚     â”‚
â”‚              â”‚               â”‚               â”‚                       â”‚     â”‚
â”‚              â–¼               â–¼               â–¼                       â”‚     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚   â”‚ è´¦å•åˆ—è¡¨é¡µé¢    â”‚ â”‚ ç›´æ¥è¿›å…¥  â”‚ â”‚ æç¤ºé¡µé¢                   â”‚   â”‚     â”‚
â”‚   â”‚                 â”‚ â”‚ é¢„è§ˆé¡µé¢  â”‚ â”‚                           â”‚   â”‚     â”‚
â”‚   â”‚ ğŸ“„ å¾®ä¿¡è´¦å•     â”‚ â”‚           â”‚ â”‚ ğŸ˜• æœªæ‰¾åˆ°è´¦å•æ–‡ä»¶          â”‚   â”‚     â”‚
â”‚   â”‚   3æœˆè´¦å•.csv   â”‚ â”‚           â”‚ â”‚                           â”‚   â”‚     â”‚
â”‚   â”‚   2æœˆè´¦å•.csv   â”‚ â”‚           â”‚ â”‚ å¯èƒ½çš„åŸå› ï¼š              â”‚   â”‚     â”‚
â”‚   â”‚ ğŸ“„ æ”¯ä»˜å®è´¦å•   â”‚ â”‚           â”‚ â”‚ â€¢ æ‚¨è¿˜æœªå¯¼å‡ºè´¦å•          â”‚   â”‚     â”‚
â”‚   â”‚   2024Q1.csv    â”‚ â”‚           â”‚ â”‚ â€¢ è´¦å•ä¿å­˜åœ¨å…¶ä»–ä½ç½®      â”‚   â”‚     â”‚
â”‚   â”‚                 â”‚ â”‚           â”‚ â”‚                           â”‚   â”‚     â”‚
â”‚   â”‚ [å¯¼å…¥é€‰ä¸­] [é€‰æ‹©å…¶ä»–ç›®å½•]     â”‚ â”‚ [æŸ¥çœ‹å¯¼å‡ºæ•™ç¨‹] [é€‰æ‹©å…¶ä»–ç›®å½•]â”‚   â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚                                                                       â”‚     â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœªæ‰¾åˆ°è´¦å•æ—¶çš„å¼•å¯¼**ï¼š

| åœºæ™¯ | å¼•å¯¼å†…å®¹ | æ“ä½œé€‰é¡¹ |
|------|---------|---------|
| ç›®å½•ä¸ºç©º | "å¾®ä¿¡/æ”¯ä»˜å®è´¦å•ç›®å½•ä¸ºç©º" | [æŸ¥çœ‹å¯¼å‡ºæ•™ç¨‹] [æ‰“å¼€å…¶ä»–æ–‡ä»¶å¤¹] |
| æ— æƒé™è®¿é—® | "æ— æ³•è®¿é—®é»˜è®¤ç›®å½•ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©" | [æˆäºˆæƒé™] [æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶] |
| æ–‡ä»¶æ ¼å¼ä¸åŒ¹é… | "ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°CSV/Excelè´¦å•æ–‡ä»¶" | [æŸ¥çœ‹æ”¯æŒæ ¼å¼] [æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶] |
| é¦–æ¬¡ä½¿ç”¨ | "å…ˆä»å¾®ä¿¡/æ”¯ä»˜å®å¯¼å‡ºè´¦å•" | [å¾®ä¿¡å¯¼å‡ºæ•™ç¨‹] [æ”¯ä»˜å®å¯¼å‡ºæ•™ç¨‹] |

**è´¦å•å¯¼å‡ºæ•™ç¨‹å…¥å£**ï¼š

```dart
/// å¯¼å‡ºæ•™ç¨‹æœåŠ¡
class BillExportTutorialService {
  /// è·å–å„å¹³å°å¯¼å‡ºæ•™ç¨‹
  static final Map<String, ExportTutorial> tutorials = {
    'wechat': ExportTutorial(
      platform: 'å¾®ä¿¡æ”¯ä»˜',
      steps: [
        'æ‰“å¼€å¾®ä¿¡ â†’ æˆ‘ â†’ æœåŠ¡ â†’ é’±åŒ…',
        'ç‚¹å‡»å³ä¸Šè§’"è´¦å•"',
        'ç‚¹å‡»å³ä¸Šè§’"..." â†’ å¯¼å‡ºè´¦å•',
        'é€‰æ‹©å¯¼å‡ºæ—¶é—´èŒƒå›´',
        'è´¦å•å°†é€šè¿‡å¾®ä¿¡æ–‡ä»¶åŠ©æ‰‹å‘é€',
        'åœ¨æ–‡ä»¶åŠ©æ‰‹ä¸­ä¿å­˜åˆ°æ‰‹æœº',
      ],
      videoUrl: 'https://example.com/wechat-export-tutorial',
      screenshotPaths: ['wechat_step1.png', 'wechat_step2.png'],
    ),
    'alipay': ExportTutorial(
      platform: 'æ”¯ä»˜å®',
      steps: [
        'æ‰“å¼€æ”¯ä»˜å® â†’ æˆ‘çš„ â†’ è´¦å•',
        'ç‚¹å‡»å³ä¸Šè§’"..." â†’ å¯¼å‡ºè´¦å•',
        'é€‰æ‹©å¼€å…·æ–¹å¼ï¼š"è‡ªç”¨è´¦å•ä¸‹è½½"',
        'é€‰æ‹©æ—¶é—´èŒƒå›´ï¼ˆæœ€é•¿1å¹´ï¼‰',
        'ç”³è¯·åé€šè¿‡æ”¯ä»˜å®æ¶ˆæ¯æ¨é€ä¸‹è½½',
      ],
      videoUrl: 'https://example.com/alipay-export-tutorial',
      screenshotPaths: ['alipay_step1.png', 'alipay_step2.png'],
    ),
  };
}
```

### 11.2 æ”¯æŒçš„æ•°æ®æº

#### 11.2.1 æ•°æ®æºæ¦‚è§ˆ

| æ•°æ®æº | æ ¼å¼ | è§£æç­–ç•¥ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|--------|------|----------|--------|------|
| å¾®ä¿¡è´¦å• | CSV | ç‰¹å®šæ¨¡æ¿è§£æ | P0 | âœ… å·²æ”¯æŒ |
| æ”¯ä»˜å®è´¦å• | CSV | ç‰¹å®šæ¨¡æ¿è§£æ | P0 | âœ… å·²æ”¯æŒ |
| é“¶è¡Œæµæ°´ | CSV/Excel | æ™ºèƒ½åˆ—æ˜ å°„ | P1 | âœ… å·²æ”¯æŒ |
| äº‘é—ªä»˜è´¦å• | CSV | ç‰¹å®šæ¨¡æ¿è§£æ | P1 | âœ… å·²æ”¯æŒ |
| äº¬ä¸œé‡‘è | CSV | ç‰¹å®šæ¨¡æ¿è§£æ | P2 | âœ… å·²æ”¯æŒ |
| ç¾å›¢/é¥¿äº†ä¹ˆ | CSV | è®¢å•è§£æ | P2 | âœ… å·²æ”¯æŒ |
| ä¿¡ç”¨å¡è´¦å• | PDF/CSV | æ™ºèƒ½è§£æ(10ç« ) | P1 | âœ… å·²æ”¯æŒ |
| å…¶ä»–APP | CSV | é€šç”¨è§£æ+ç”¨æˆ·æ˜ å°„ | P2 | âœ… å·²æ”¯æŒ |
| Excel | xlsx | è¡¨æ ¼è§£æ | P1 | âœ… å·²æ”¯æŒ |
| æ‰‹åŠ¨CSV | CSV | è‡ªå®šä¹‰æ¨¡æ¿ | P2 | âœ… å·²æ”¯æŒ |
| è¯­éŸ³æ‰¹é‡å¯¼å…¥ | éŸ³é¢‘ | è¯­éŸ³è¯†åˆ«(18ç« ) | P2 | ğŸ”„ å¼€å‘ä¸­ |
| å›¾ç‰‡ç¥¨æ® | å›¾ç‰‡ | OCRè¯†åˆ«(10ç« ) | P2 | âœ… å·²æ”¯æŒ |

**2.0æ–°å¢æ•°æ®æºæ”¯æŒ**ï¼š

| æ•°æ®æºç±»å‹ | ç‰¹ç‚¹ | é›†æˆæ¨¡å— |
|-----------|------|---------|
| **è¯­éŸ³æ‰¹é‡å½•å…¥** | è¿ç»­è¯­éŸ³æè¿°å¤šç¬”äº¤æ˜“ï¼ŒAIåˆ†å‰²è§£æ | è¯­éŸ³äº¤äº’(18ç« ) |
| **å›¾ç‰‡ç¥¨æ®æ‰¹é‡** | æ‹ç…§å¤šå¼ ç¥¨æ®ï¼ŒOCRæ‰¹é‡è¯†åˆ« | AIè¯†åˆ«(10ç« ) |
| **å®¶åº­æˆå‘˜å¯¼å…¥** | å¯¼å…¥æ—¶å¯åˆ†é…ç»™å®¶åº­æˆå‘˜ | å®¶åº­è´¦æœ¬(13ç« ) |
| **å†å²æ•°æ®å­¦ä¹ ** | è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·åˆ†ç±»ä¹ æƒ¯ä¼˜åŒ–åç»­å¯¼å…¥ | è‡ªå­¦ä¹ (17ç« ) |

#### 11.2.2 è§£æå™¨æ’ä»¶æ¶æ„

```dart
/// è´¦å•è§£æå™¨æŠ½è±¡åŸºç±»
abstract class BillParser {
  /// è§£æå™¨åç§°
  String get name;

  /// æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å
  List<String> get supportedExtensions;

  /// æ£€æµ‹æ–‡ä»¶æ˜¯å¦åŒ¹é…æ­¤è§£æå™¨
  Future<bool> canParse(String content);

  /// è§£ææ–‡ä»¶å†…å®¹
  Future<ParseResult> parse(String content);

  /// è·å–å­—æ®µæ˜ å°„é…ç½®
  FieldMapping get fieldMapping;
}

/// å¾®ä¿¡è´¦å•è§£æå™¨
class WeChatBillParser extends BillParser {
  @override
  String get name => 'å¾®ä¿¡æ”¯ä»˜è´¦å•';

  @override
  List<String> get supportedExtensions => ['csv'];

  @override
  Future<bool> canParse(String content) async {
    // æ£€æµ‹å¾®ä¿¡è´¦å•ç‰¹å¾ï¼šè¡¨å¤´åŒ…å«"å¾®ä¿¡æ”¯ä»˜è´¦å•æ˜ç»†"
    return content.contains('å¾®ä¿¡æ”¯ä»˜è´¦å•æ˜ç»†') ||
           content.contains('äº¤æ˜“æ—¶é—´,äº¤æ˜“ç±»å‹,äº¤æ˜“å¯¹æ–¹');
  }

  @override
  FieldMapping get fieldMapping => FieldMapping(
    dateColumn: 'äº¤æ˜“æ—¶é—´',
    amountColumn: 'é‡‘é¢(å…ƒ)',
    descriptionColumn: 'å•†å“',
    categoryColumn: 'äº¤æ˜“ç±»å‹',
    counterpartyColumn: 'äº¤æ˜“å¯¹æ–¹',
    statusColumn: 'å½“å‰çŠ¶æ€',
  );
}

/// æ”¯ä»˜å®è´¦å•è§£æå™¨
class AlipayBillParser extends BillParser {
  @override
  String get name => 'æ”¯ä»˜å®è´¦å•';

  @override
  Future<bool> canParse(String content) async {
    return content.contains('æ”¯ä»˜å®äº¤æ˜“è®°å½•æ˜ç»†') ||
           content.contains('äº¤æ˜“å·,å•†å®¶è®¢å•å·');
  }

  @override
  FieldMapping get fieldMapping => FieldMapping(
    dateColumn: 'äº¤æ˜“åˆ›å»ºæ—¶é—´',
    amountColumn: 'é‡‘é¢ï¼ˆå…ƒï¼‰',
    descriptionColumn: 'å•†å“åç§°',
    categoryColumn: 'äº¤æ˜“åˆ†ç±»',
    counterpartyColumn: 'äº¤æ˜“å¯¹æ–¹',
    statusColumn: 'äº¤æ˜“çŠ¶æ€',
  );
}

/// è§£æå™¨æ³¨å†Œè¡¨
class ParserRegistry {
  static final List<BillParser> _parsers = [
    WeChatBillParser(),
    AlipayBillParser(),
    GenericBankParser(),
    UniversalCsvParser(),
  ];

  /// è‡ªåŠ¨æ£€æµ‹å¹¶è·å–åˆé€‚çš„è§£æå™¨
  static Future<BillParser?> detectParser(String content) async {
    for (final parser in _parsers) {
      if (await parser.canParse(content)) {
        return parser;
      }
    }
    return null;
  }

  /// æ³¨å†Œè‡ªå®šä¹‰è§£æå™¨
  static void register(BillParser parser) {
    _parsers.insert(0, parser); // è‡ªå®šä¹‰è§£æå™¨ä¼˜å…ˆ
  }
}
```

#### 11.2.3 æ™ºèƒ½æ ¼å¼æ£€æµ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ™ºèƒ½æ ¼å¼æ£€æµ‹æµç¨‹                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚   â”‚  ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â”‚                                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚ è¯»å–æ–‡ä»¶å¤´   â”‚â”€â”€â”€â”€â†’â”‚ ç¼–ç æ£€æµ‹    â”‚â”€â”€â”€â”€â†’â”‚ åˆ†éš”ç¬¦æ£€æµ‹   â”‚                  â”‚
â”‚   â”‚ (å‰1KB)     â”‚     â”‚ (UTF-8/GBK) â”‚     â”‚ (,/;/\t)   â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                   â”‚                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚ ç‰¹å¾åŒ¹é…    â”‚â”€â”€â”€â”€â†’â”‚ è§£æå™¨é€‰æ‹©  â”‚â”€â”€â”€â”€â†’â”‚ å­—æ®µæ˜ å°„    â”‚                  â”‚
â”‚   â”‚ (è¡¨å¤´å…³é”®è¯) â”‚     â”‚ (å¾®ä¿¡/æ”¯ä»˜å®)â”‚     â”‚ (è‡ªåŠ¨/æ‰‹åŠ¨) â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â”‚   æ£€æµ‹æˆåŠŸç‡ç›®æ ‡ï¼š                                                           â”‚
â”‚   â€¢ å¾®ä¿¡/æ”¯ä»˜å®è´¦å•ï¼š99%+ è‡ªåŠ¨è¯†åˆ«                                           â”‚
â”‚   â€¢ ä¸»æµé“¶è¡Œæµæ°´ï¼š90%+ è‡ªåŠ¨è¯†åˆ«                                              â”‚
â”‚   â€¢ å…¶ä»–CSVï¼šæä¾›æ™ºèƒ½åˆ—æ˜ å°„è¾…åŠ©                                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 ä¸‰å±‚å»é‡æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸‰å±‚å»é‡æœºåˆ¶æ¶æ„ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         ç¬¬ä¸€å±‚ï¼šç²¾ç¡®åŒ¹é…                              â”‚  â”‚
â”‚   â”‚   é‡‘é¢ç›¸åŒ + æ—¥æœŸç›¸åŒ + æè¿°ç›¸åŒ â†’ ç¡®å®šé‡å¤ (ç½®ä¿¡åº¦ 100%)             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                       â”‚
â”‚                                    â–¼ æœªåŒ¹é…                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         ç¬¬äºŒå±‚ï¼šç‰¹å¾åŒ¹é…                              â”‚  â”‚
â”‚   â”‚   é‡‘é¢ç›¸åŒ + æ—¥æœŸç›¸è¿‘(Â±1å¤©) + æè¿°ç›¸ä¼¼(>80%) â†’ å¯èƒ½é‡å¤ (70-95%)     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                       â”‚
â”‚                                    â–¼ æœªåŒ¹é…                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         ç¬¬ä¸‰å±‚ï¼šè¯­ä¹‰åŒ¹é…                              â”‚  â”‚
â”‚   â”‚   AIåˆ¤æ–­(ç¬¬10ç« ) + è‡ªå­¦ä¹ å†å²(ç¬¬17ç« ) â†’ æ™ºèƒ½åˆ¤é‡ (60-90%)            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                       â”‚
â”‚                                    â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                      2.0æ–°å¢ï¼šå¤šå› å­ç»¼åˆè¯„åˆ†                          â”‚  â”‚
â”‚   â”‚   â€¢ ç”¨æˆ·å†å²ä¿®æ­£è®°å½•å­¦ä¹ (ç¬¬17ç« ) â†’ ä¸ªæ€§åŒ–å»é‡é˜ˆå€¼                     â”‚  â”‚
â”‚   â”‚   â€¢ ä½ç½®ä¿¡æ¯è¾…åŠ©åˆ¤æ–­(ç¬¬14ç« ) â†’ åŒåœ°ç‚¹æ¶ˆè´¹æ£€æµ‹                         â”‚  â”‚
â”‚   â”‚   â€¢ å®¶åº­æˆå‘˜äº¤å‰éªŒè¯(ç¬¬13ç« ) â†’ å®¶åº­é‡å¤æ¶ˆè´¹æ£€æµ‹                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»é‡ç½®ä¿¡åº¦å±•ç¤ºè§„èŒƒ**ï¼š

| ç½®ä¿¡åº¦èŒƒå›´ | å±•ç¤ºæ ·å¼ | ç”¨æˆ·æ“ä½œ |
|-----------|---------|---------|
| 100% | çº¢è‰²æ ‡è®°"ç¡®å®šé‡å¤" | é»˜è®¤è·³è¿‡ï¼Œå¯æ‰‹åŠ¨å¯¼å…¥ |
| 80-99% | æ©™è‰²æ ‡è®°"é«˜åº¦ç–‘ä¼¼" | å±•ç¤ºå¯¹æ¯”ï¼Œä¸€é”®è·³è¿‡/å¯¼å…¥ |
| 60-79% | é»„è‰²æ ‡è®°"å¯èƒ½é‡å¤" | å±•ç¤ºè¯¦æƒ…ï¼Œç”¨æˆ·å†³å®š |
| <60% | æ— æ ‡è®° | æ­£å¸¸å¯¼å…¥ |

```dart
/// ä¸‰å±‚å»é‡æœåŠ¡
class DeduplicationService {
  /// ç¬¬ä¸€å±‚ï¼šç²¾ç¡®åŒ¹é…
  /// ç›¸åŒé‡‘é¢ + ç›¸åŒæ—¥æœŸ + ç›¸åŒæè¿° = ç¡®å®šé‡å¤
  Future<List<Transaction>> exactMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getAll();
    final duplicates = <Transaction>[];

    for (final newTx in newTxs) {
      final isDuplicate = existing.any((ex) =>
        ex.amount == newTx.amount &&
        ex.date == newTx.date &&
        ex.description == newTx.description
      );
      if (isDuplicate) {
        duplicates.add(newTx);
      }
    }

    return duplicates;
  }

  /// ç¬¬äºŒå±‚ï¼šç‰¹å¾åŒ¹é…
  /// ç›¸åŒé‡‘é¢ + æ—¥æœŸç›¸è¿‘(Â±1å¤©) + æè¿°ç›¸ä¼¼(>80%) = å¯èƒ½é‡å¤
  Future<List<PotentialDuplicate>> featureMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getAll();
    final potentials = <PotentialDuplicate>[];

    for (final newTx in newTxs) {
      for (final ex in existing) {
        if (ex.amount == newTx.amount) {
          final dateDiff = ex.date.difference(newTx.date).inDays.abs();
          if (dateDiff <= 1) {
            final similarity = _stringSimilarity(ex.description, newTx.description);
            if (similarity > 0.8) {
              potentials.add(PotentialDuplicate(
                newTransaction: newTx,
                existingTransaction: ex,
                confidence: 0.7 + similarity * 0.3,
                reason: 'é‡‘é¢ç›¸åŒ,æ—¥æœŸç›¸è¿‘,æè¿°ç›¸ä¼¼',
              ));
            }
          }
        }
      }
    }

    return potentials;
  }

  /// ç¬¬ä¸‰å±‚ï¼šè¯­ä¹‰åŒ¹é…
  /// ä½¿ç”¨AIåˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ç¬”äº¤æ˜“
  Future<List<SemanticDuplicate>> semanticMatch(List<Transaction> newTxs) async {
    final existing = await _transactionRepo.getRecent(days: 30);
    final semanticDuplicates = <SemanticDuplicate>[];

    for (final newTx in newTxs) {
      // æ‰¾å‡ºé‡‘é¢ç›¸è¿‘çš„å€™é€‰
      final candidates = existing.where((ex) =>
        (ex.amount - newTx.amount).abs() < 1.0 && // é‡‘é¢å·®å¼‚å°äº1å…ƒ
        ex.date.difference(newTx.date).inDays.abs() <= 3
      ).toList();

      if (candidates.isNotEmpty) {
        // ä½¿ç”¨AIåˆ¤æ–­
        final aiResult = await _aiService.checkDuplicate(
          newTransaction: newTx,
          candidates: candidates,
        );

        if (aiResult.isDuplicate && aiResult.confidence > 0.7) {
          semanticDuplicates.add(SemanticDuplicate(
            newTransaction: newTx,
            matchedTransaction: aiResult.matchedTransaction,
            confidence: aiResult.confidence,
            aiExplanation: aiResult.explanation,
          ));
        }
      }
    }

    return semanticDuplicates;
  }
}
```

### 11.4 å¯¼å…¥é¢„è§ˆä¸ç¡®è®¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¯¼å…¥é¢„è§ˆé¡µé¢ç»“æ„ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  å¯¼å…¥æ‘˜è¦å¡ç‰‡                                                        â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚   â”‚  â”‚ æ€»è®°å½•æ•°  â”‚ â”‚ æ–°è®°å½•   â”‚ â”‚ ç–‘ä¼¼é‡å¤  â”‚ â”‚ ç¡®è®¤é‡å¤  â”‚               â”‚  â”‚
â”‚   â”‚  â”‚   156    â”‚ â”‚   142   â”‚ â”‚    8     â”‚ â”‚    6     â”‚               â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜åˆ†é…ï¼ˆä»…å®¶åº­è´¦æœ¬ç”¨æˆ·æ˜¾ç¤ºï¼‰                          â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚   â”‚  â”‚ ğŸ‘¤ å…¨éƒ¨åˆ†é…ç»™ï¼š[æˆ‘è‡ªå·± â–¼]  æˆ–  ğŸ”€ æŒ‰è®°å½•é€æ¡åˆ†é…                â”‚ â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  2.0æ–°å¢ï¼šæ™ºèƒ½åˆ†ç±»é¢„è§ˆ                                               â”‚  â”‚
â”‚   â”‚  â€¢ AIå·²è‡ªåŠ¨åˆ†ç±» 142 æ¡ (å‡†ç¡®ç‡é¢„ä¼° 94%)                              â”‚  â”‚
â”‚   â”‚  â€¢ éœ€è¦æ‰‹åŠ¨ç¡®è®¤ 8 æ¡ (ä½ç½®ä¿¡åº¦)                                      â”‚  â”‚
â”‚   â”‚  â€¢ è‡ªå­¦ä¹ å·²ä¼˜åŒ– 23 æ¡åˆ†ç±» (åŸºäºæ‚¨çš„å†å²ä¿®æ­£)                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  åˆ†ç±»æ ‡ç­¾é¡µ                                                          â”‚  â”‚
â”‚   â”‚  [æ–°è®°å½•(142)] [ç–‘ä¼¼é‡å¤(8)] [ç¡®è®¤é‡å¤(6)] [éœ€ç¡®è®¤åˆ†ç±»(8)]           â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚   â”‚  â”‚ äº¤æ˜“åˆ—è¡¨...                                                    â”‚ â”‚  â”‚
â”‚   â”‚  â”‚ â€¢ ç‚¹å‡»å¯ç¼–è¾‘åˆ†ç±»/æˆå‘˜                                          â”‚ â”‚  â”‚
â”‚   â”‚  â”‚ â€¢ å·¦æ»‘è·³è¿‡/å³æ»‘å¯¼å…¥                                            â”‚ â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// å¯¼å…¥é¢„è§ˆé¡µé¢ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰
class ImportPreviewPage extends ConsumerWidget {
  final List<ParsedTransaction> parsedData;
  final List<DeduplicationResult> deduplicationResults;
  final bool isFamilyAccount; // 2.0æ–°å¢ï¼šæ˜¯å¦ä¸ºå®¶åº­è´¦æœ¬

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(
        title: Text('ç¡®è®¤å¯¼å…¥'),
        actions: [
          TextButton(
            onPressed: () => _startImport(context, ref),
            child: Text('å¯¼å…¥'),
          ),
        ],
      ),
      body: Column(
        children: [
          // æ‘˜è¦å¡ç‰‡
          _ImportSummaryCard(
            totalCount: parsedData.length,
            newCount: _getNewCount(),
            duplicateCount: _getDuplicateCount(),
            suspiciousCount: _getSuspiciousCount(),
          ),

          // 2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜åˆ†é…ï¼ˆä»…å®¶åº­è´¦æœ¬æ˜¾ç¤ºï¼‰
          if (isFamilyAccount) _FamilyMemberAssignmentCard(
            onAssignAll: (memberId) => _assignAllToMember(memberId),
            onAssignIndividually: () => _enableIndividualAssignment(),
          ),

          // 2.0æ–°å¢ï¼šæ™ºèƒ½åˆ†ç±»é¢„è§ˆ
          _AIClassificationPreviewCard(
            autoClassifiedCount: _getAutoClassifiedCount(),
            accuracyEstimate: _getAccuracyEstimate(),
            needsConfirmCount: _getNeedsConfirmCount(),
            selfLearningOptimizedCount: _getSelfLearningCount(),
          ),

          // åˆ†ç±»æ ‡ç­¾é¡µï¼ˆ2.0æ‰©å±•ï¼‰
          Expanded(
            child: DefaultTabController(
              length: 4, // 2.0: æ–°å¢"éœ€ç¡®è®¤åˆ†ç±»"æ ‡ç­¾
              child: Column(
                children: [
                  TabBar(
                    tabs: [
                      Tab(text: 'æ–°è®°å½• (${_getNewCount()})'),
                      Tab(text: 'ç–‘ä¼¼é‡å¤ (${_getSuspiciousCount()})'),
                      Tab(text: 'ç¡®è®¤é‡å¤ (${_getDuplicateCount()})'),
                      Tab(text: 'éœ€ç¡®è®¤åˆ†ç±» (${_getNeedsConfirmCount()})'), // 2.0æ–°å¢
                    ],
                  ),
                  Expanded(
                    child: TabBarView(
                      children: [
                        _NewTransactionsList(),
                        _SuspiciousList(),
                        _DuplicatesList(),
                        _NeedsConfirmList(), // 2.0æ–°å¢
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}
```

### 11.5 æ•°æ®å¯¼å‡º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å¯¼å‡ºåŠŸèƒ½çŸ©é˜µï¼ˆ2.0å¢å¼ºç‰ˆï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  å¯¼å‡ºæ ¼å¼æ”¯æŒ                                                        â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â”‚  â”‚   CSV    â”‚ â”‚  Excel   â”‚ â”‚   PDF    â”‚ â”‚   JSON   â”‚ â”‚  å¤‡ä»½åŒ…   â”‚  â”‚  â”‚
â”‚   â”‚  â”‚ é€šç”¨æ ¼å¼  â”‚ â”‚ å¸¦å›¾è¡¨   â”‚ â”‚ æŠ¥è¡¨æ‰“å°  â”‚ â”‚ APIå…¼å®¹  â”‚ â”‚ å®Œæ•´æ¢å¤  â”‚  â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  2.0æ–°å¢å¯¼å‡ºé€‰é¡¹                                                     â”‚  â”‚
â”‚   â”‚  â€¢ å®¶åº­æŠ¥è¡¨å¯¼å‡ºï¼šæŒ‰æˆå‘˜åˆ†ç»„/åˆå¹¶æ±‡æ€» (ç¬¬13ç« )                         â”‚  â”‚
â”‚   â”‚  â€¢ é’±é¾„åˆ†æå¯¼å‡ºï¼šèµ„æºæ± æ˜ç»†/FIFOæµæ°´ (ç¬¬7ç« )                          â”‚  â”‚
â”‚   â”‚  â€¢ é¢„ç®—æ‰§è¡Œå¯¼å‡ºï¼šå°é‡‘åº“æ”¶æ”¯/é¢„ç®—è¾¾æˆç‡ (ç¬¬8ç« )                         â”‚  â”‚
â”‚   â”‚  â€¢ ä¹ æƒ¯æ•°æ®å¯¼å‡ºï¼šæ‰“å¡è®°å½•/æˆå°±é‡Œç¨‹ç¢‘ (ç¬¬9ç« )                          â”‚  â”‚
â”‚   â”‚  â€¢ ä½ç½®æ•°æ®å¯¼å‡ºï¼šæ¶ˆè´¹åœ°ç‚¹/çƒ­åŠ›å›¾æ•°æ® (ç¬¬14ç« )                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  éšç§ä¿æŠ¤é€‰é¡¹                                                        â”‚  â”‚
â”‚   â”‚  â˜‘ è„±æ•å¤„ç†ï¼šéšè—å•†å®¶åç§°/è´¦æˆ·å·                                    â”‚  â”‚
â”‚   â”‚  â˜‘ åŠ å¯†å¯¼å‡ºï¼šè®¾ç½®è§£å‹å¯†ç                                            â”‚  â”‚
â”‚   â”‚  â˜‘ æ°´å°æ·»åŠ ï¼šå¯¼å‡ºæ–‡ä»¶æ·»åŠ ç”¨æˆ·æ ‡è¯†                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// æ•°æ®å¯¼å‡ºæœåŠ¡ï¼ˆ2.0å¢å¼ºç‰ˆï¼‰
class ExportService {
  /// å¯¼å‡ºä¸ºCSV
  Future<File> exportToCsv({
    required DateRange range,
    List<String>? accountIds,
    List<String>? categoryIds,
    List<String>? memberIds, // 2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜ç­›é€‰
    List<String> fields = const ['date', 'amount', 'category', 'description', 'account'],
    bool desensitize = false, // 2.0æ–°å¢ï¼šè„±æ•å¤„ç†
  }) async {
    final transactions = await _fetchTransactions(range, accountIds, categoryIds, memberIds);

    final csv = StringBuffer();

    // å†™å…¥è¡¨å¤´
    csv.writeln(fields.map((f) => _getFieldHeader(f)).join(','));

    // å†™å…¥æ•°æ®
    for (final tx in transactions) {
      final row = fields.map((f) => _getFieldValue(tx, f, desensitize)).join(',');
      csv.writeln(row);
    }

    // ä¿å­˜æ–‡ä»¶
    final file = await _saveToFile(csv.toString(), 'export_${DateTime.now().toIso8601String()}.csv');
    return file;
  }

  /// å¯¼å‡ºä¸ºExcelï¼ˆ2.0å¢å¼ºç‰ˆï¼‰
  Future<File> exportToExcel({
    required DateRange range,
    bool includeCharts = false,
    bool includeSummary = true,
    bool includeMoneyAge = false, // 2.0æ–°å¢ï¼šé’±é¾„åˆ†æ
    bool includeBudget = false, // 2.0æ–°å¢ï¼šé¢„ç®—æ‰§è¡Œ
    bool includeFamilyBreakdown = false, // 2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜åˆ†ç»„
  }) async {
    final excel = Excel.createExcel();

    // åˆ›å»ºäº¤æ˜“æ˜ç»†è¡¨
    final detailSheet = excel['äº¤æ˜“æ˜ç»†'];
    await _populateDetailSheet(detailSheet, range);

    // åˆ›å»ºåˆ†ç±»æ±‡æ€»è¡¨
    if (includeSummary) {
      final summarySheet = excel['åˆ†ç±»æ±‡æ€»'];
      await _populateSummarySheet(summarySheet, range);
    }

    // 2.0æ–°å¢ï¼šé’±é¾„åˆ†æè¡¨
    if (includeMoneyAge) {
      final moneyAgeSheet = excel['é’±é¾„åˆ†æ'];
      await _populateMoneyAgeSheet(moneyAgeSheet, range);
    }

    // 2.0æ–°å¢ï¼šé¢„ç®—æ‰§è¡Œè¡¨
    if (includeBudget) {
      final budgetSheet = excel['é¢„ç®—æ‰§è¡Œ'];
      await _populateBudgetSheet(budgetSheet, range);
    }

    // 2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜åˆ†ç»„è¡¨
    if (includeFamilyBreakdown) {
      final familySheet = excel['å®¶åº­æˆå‘˜'];
      await _populateFamilySheet(familySheet, range);
    }

    // ä¿å­˜æ–‡ä»¶
    final bytes = excel.encode();
    final file = await _saveToFile(bytes!, 'export_${DateTime.now().toIso8601String()}.xlsx');
    return file;
  }

  /// 2.0æ–°å¢ï¼šå¯¼å‡ºä¸ºPDFæŠ¥è¡¨
  Future<File> exportToPdf({
    required DateRange range,
    required PdfReportType reportType,
    bool includeWatermark = true,
  }) async {
    final pdf = PdfDocument();

    switch (reportType) {
      case PdfReportType.monthly:
        await _generateMonthlyReport(pdf, range);
        break;
      case PdfReportType.annual:
        await _generateAnnualReport(pdf, range);
        break;
      case PdfReportType.family:
        await _generateFamilyReport(pdf, range);
        break;
    }

    if (includeWatermark) {
      _addWatermark(pdf);
    }

    final bytes = await pdf.save();
    final file = await _saveToFile(bytes, 'report_${DateTime.now().toIso8601String()}.pdf');
    return file;
  }

  /// 2.0æ–°å¢ï¼šå®Œæ•´å¤‡ä»½å¯¼å‡º
  Future<File> exportFullBackup({
    String? password,
    bool includeSettings = true,
    bool includeLearningData = true, // è‡ªå­¦ä¹ æ•°æ®(ç¬¬17ç« )
  }) async {
    final backup = BackupPackage();

    // å¯¼å‡ºæ‰€æœ‰äº¤æ˜“
    backup.transactions = await _transactionRepo.getAll();

    // å¯¼å‡ºè´¦æˆ·å’Œåˆ†ç±»
    backup.accounts = await _accountRepo.getAll();
    backup.categories = await _categoryRepo.getAll();

    // 2.0æ–°å¢ï¼šå¯¼å‡ºé’±é¾„èµ„æºæ± 
    backup.resourcePools = await _resourcePoolRepo.getAll();

    // 2.0æ–°å¢ï¼šå¯¼å‡ºå°é‡‘åº“é…ç½®
    backup.vaults = await _vaultRepo.getAll();

    // 2.0æ–°å¢ï¼šå¯¼å‡ºå®¶åº­æ•°æ®
    backup.familyData = await _familyRepo.getAll();

    // 2.0æ–°å¢ï¼šå¯¼å‡ºè‡ªå­¦ä¹ æ•°æ®
    if (includeLearningData) {
      backup.learningData = await _learningRepo.getAll();
    }

    // è®¾ç½®
    if (includeSettings) {
      backup.settings = await _settingsRepo.getAll();
    }

    // æ‰“åŒ…å¹¶å¯é€‰åŠ å¯†
    final file = await _packageBackup(backup, password);
    return file;
  }
}
```

### 11.6 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

å¯¼å…¥å¯¼å‡ºç³»ç»Ÿä½œä¸ºæ•°æ®è¿ç§»çš„å…¥å£ï¼Œéœ€è¦ä¸å¤šä¸ª2.0æ ¸å¿ƒç³»ç»ŸååŒå·¥ä½œã€‚

#### 11.6.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¯¼å…¥å¯¼å‡ºç³»ç»Ÿé›†æˆå…¨æ™¯å›¾ï¼ˆ2.0ç‰ˆæœ¬ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                         â”‚   æ•°æ®å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ     â”‚                           â”‚
â”‚                         â”‚   ImportExportSystem  â”‚                           â”‚
â”‚                         â”‚   (æœ¬ç« Â·æ•°æ®è¿ç§»)     â”‚                           â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                     â”‚                                       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚                             â”‚                             â”‚         â”‚
â”‚       â–¼                             â–¼                             â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ äº¤æ˜“è®°è´¦ç³»ç»Ÿ â”‚            â”‚  AIè¯†åˆ«ç³»ç»Ÿ  â”‚            â”‚  é’±é¾„åˆ†æç³»ç»Ÿ â”‚      â”‚
â”‚  â”‚  (ç¬¬6ç« )    â”‚            â”‚  (ç¬¬10ç« )   â”‚            â”‚  (ç¬¬7ç« )    â”‚      â”‚
â”‚  â”‚             â”‚            â”‚             â”‚            â”‚             â”‚      â”‚
â”‚  â”‚ å¯¼å…¥æ•°æ®â†’   â”‚            â”‚ æ™ºèƒ½åˆ†ç±»    â”‚            â”‚ å¯¼å…¥åè§¦å‘   â”‚      â”‚
â”‚  â”‚ å†™å…¥äº¤æ˜“è¡¨  â”‚            â”‚ è¾…åŠ©è¯†åˆ«    â”‚            â”‚ é’±é¾„é‡ç®—    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              æ ¸å¿ƒé›†æˆå±‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ â”‚  â”‚ é‡‘èä¹ æƒ¯åŸ¹å…» â”‚  â”‚ æ•°æ®è”åŠ¨ç³»ç»Ÿ â”‚  â”‚ å®‰å…¨ä¸éšç§  â”‚        â”‚
â”‚  â”‚  (ç¬¬8ç« )    â”‚  â”‚  (ç¬¬9ç« )    â”‚  â”‚  (ç¬¬12ç« )   â”‚  â”‚  (ç¬¬22ç« )   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ å¯¼å…¥äº¤æ˜“â†’   â”‚  â”‚ æ¶ˆè´¹ä¹ æƒ¯    â”‚  â”‚ è§¦å‘æ•°æ®    â”‚  â”‚ æ•æ„Ÿæ•°æ®    â”‚        â”‚
â”‚  â”‚ æ›´æ–°é¢„ç®—    â”‚  â”‚ æ¨¡å¼åˆ†æ    â”‚  â”‚ åŒæ­¥        â”‚  â”‚ è„±æ•å¤„ç†    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              åä½œæ‰©å±•å±‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å®¶åº­è´¦æœ¬   â”‚  â”‚  è¯­éŸ³äº¤äº’    â”‚  â”‚  è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚  ä½ç½®æ™ºèƒ½åŒ–  â”‚        â”‚
â”‚  â”‚  (ç¬¬13ç« )   â”‚  â”‚  (ç¬¬18ç« )   â”‚  â”‚  (ç¬¬17ç« )   â”‚  â”‚  (ç¬¬14ç« )   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ å®¶åº­å…±äº«â†’   â”‚  â”‚ è¯­éŸ³è§¦å‘â†’   â”‚  â”‚ å†å²å­¦ä¹ â†’   â”‚  â”‚ ä½ç½®å¢å¼ºâ†’   â”‚        â”‚
â”‚  â”‚ æ•°æ®å¯¼å…¥    â”‚  â”‚ å¯¼å…¥/æ’­æŠ¥   â”‚  â”‚ åˆ†ç±»å»ºè®®    â”‚  â”‚ åˆ†ç±»è¡¥å……    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é›†æˆè§¦å‘ç‚¹**ï¼š

| è§¦å‘äº‹ä»¶ | é›†æˆåŠ¨ä½œ | æ¶‰åŠç³»ç»Ÿ |
|----------|----------|----------|
| å¯¼å…¥å¼€å§‹ | æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œé”å®šç›¸å…³æ“ä½œ | UIå±‚ |
| è§£æå®Œæˆ | è°ƒç”¨AIè¾…åŠ©åˆ†ç±»ï¼Œå¡«å……ç¼ºå¤±ä¿¡æ¯ | AIè¯†åˆ«ç³»ç»Ÿ(ç¬¬10ç« ) |
| å»é‡å®Œæˆ | å±•ç¤ºå»é‡ç»“æœï¼Œç”¨æˆ·ç¡®è®¤ | UIå±‚ |
| å¯¼å…¥å®Œæˆ | è§¦å‘é’±é¾„é‡ç®—ï¼Œæ›´æ–°é¢„ç®—çŠ¶æ€ | é’±é¾„ç³»ç»Ÿ(ç¬¬7ç« )ã€é¢„ç®—ç³»ç»Ÿ(ç¬¬8ç« ) |
| å¯¼å‡ºè¯·æ±‚ | æŸ¥è¯¢äº¤æ˜“æ•°æ®ï¼Œç”Ÿæˆæ–‡ä»¶ | äº¤æ˜“ç³»ç»Ÿ(ç¬¬6ç« ) |
| æ•æ„Ÿæ•°æ®å¯¼å‡º | è„±æ•å¤„ç†ï¼Œå®‰å…¨åŠ å¯† | å®‰å…¨ä¸éšç§(ç¬¬22ç« ) |
| å®¶åº­å¯¼å…¥ | å…±äº«æ•°æ®åˆ†å‘ï¼Œæˆå‘˜é€šçŸ¥ | å®¶åº­è´¦æœ¬(ç¬¬13ç« ) |
| è¯­éŸ³è§¦å‘å¯¼å…¥ | è¯­éŸ³æ‰“å¼€å¯¼å…¥é¡µï¼Œè¿›åº¦æ’­æŠ¥ | è¯­éŸ³äº¤äº’(ç¬¬18ç« ) |
| æ‰¹é‡å¯¼å…¥å­¦ä¹  | è®°å½•ç”¨æˆ·åˆ†ç±»ä¿®æ­£ï¼Œä¼˜åŒ–æ¨¡å‹ | è‡ªå­¦ä¹ ç³»ç»Ÿ(ç¬¬17ç« ) |
| ä½ç½®è¡¥å…… | æ ¹æ®äº¤æ˜“åœ°ç‚¹å¢å¼ºåˆ†ç±» | ä½ç½®æ™ºèƒ½åŒ–(ç¬¬14ç« ) |

#### 11.6.1 ä¸AIè¯†åˆ«ç³»ç»Ÿé›†æˆ

```dart
/// å¯¼å…¥æ—¶è°ƒç”¨AIè¾…åŠ©åˆ†ç±»
class ImportAIAssistant {
  final QwenService _aiService;
  final CategoryRepository _categoryRepo;

  /// ä¸ºå¯¼å…¥çš„äº¤æ˜“æ™ºèƒ½åˆ†ç±»
  Future<List<ParsedTransaction>> enrichWithAI(
    List<ParsedTransaction> transactions,
  ) async {
    final categories = await _categoryRepo.getAll();
    final categoryNames = categories.map((c) => c.name).toList();

    final enriched = <ParsedTransaction>[];

    for (final tx in transactions) {
      // å¦‚æœå·²æœ‰åˆ†ç±»ä¸”åŒ¹é…ç³»ç»Ÿåˆ†ç±»ï¼Œè·³è¿‡
      if (tx.category != null && categoryNames.contains(tx.category)) {
        enriched.add(tx);
        continue;
      }

      // è°ƒç”¨AIè¯†åˆ«åˆ†ç±»
      final aiResult = await _aiService.categorizeTransaction(
        description: tx.description,
        amount: tx.amount,
        counterparty: tx.counterparty,
        availableCategories: categoryNames,
      );

      enriched.add(tx.copyWith(
        category: aiResult.category,
        confidence: aiResult.confidence,
        aiSuggested: true,
      ));
    }

    return enriched;
  }

  /// æ‰¹é‡AIåˆ†ç±»ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
  Future<List<ParsedTransaction>> batchEnrichWithAI(
    List<ParsedTransaction> transactions, {
    int batchSize = 20,
  }) async {
    final results = <ParsedTransaction>[];

    for (var i = 0; i < transactions.length; i += batchSize) {
      final batch = transactions.skip(i).take(batchSize).toList();
      final enrichedBatch = await _aiService.batchCategorize(batch);
      results.addAll(enrichedBatch);

      // è¿›åº¦å›è°ƒ
      onProgress?.call(i + batch.length, transactions.length);
    }

    return results;
  }

  Function(int current, int total)? onProgress;
}
```

#### 11.6.2 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// å¯¼å…¥å®Œæˆåè§¦å‘é’±é¾„é‡ç®—
class ImportMoneyAgeIntegration {
  final MoneyAgeCalculator _moneyAgeCalc;
  final TransactionRepository _txRepo;

  /// å¯¼å…¥å®Œæˆåçš„åå¤„ç†
  Future<ImportPostProcessResult> onImportComplete(
    ImportResult importResult,
  ) async {
    // 1. è·å–å¯¼å…¥çš„äº¤æ˜“
    final importedTxs = importResult.importedTransactions;

    // 2. æŒ‰æ—¥æœŸæ’åºï¼Œæ‰¾å‡ºæœ€æ—©çš„äº¤æ˜“æ—¥æœŸ
    importedTxs.sort((a, b) => a.date.compareTo(b.date));
    final earliestDate = importedTxs.first.date;

    // 3. ä»è¯¥æ—¥æœŸå¼€å§‹é‡ç®—é’±é¾„
    await _moneyAgeCalc.recalculateFrom(earliestDate);

    // 4. è·å–é‡ç®—åçš„é’±é¾„ç»Ÿè®¡
    final newStats = await _moneyAgeCalc.getStatistics();

    // 5. ç”Ÿæˆå½±å“æŠ¥å‘Š
    return ImportPostProcessResult(
      importedCount: importedTxs.length,
      recalculatedFrom: earliestDate,
      newMoneyAge: newStats.averageAge,
      previousMoneyAge: importResult.previousMoneyAge,
      moneyAgeChange: newStats.averageAge - importResult.previousMoneyAge,
    );
  }
}
```

#### 11.6.3 ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// å¯¼å…¥äº¤æ˜“è‡ªåŠ¨å…³è”å°é‡‘åº“
class ImportBudgetIntegration {
  final VaultRepository _vaultRepo;
  final CategoryVaultMappingRepository _mappingRepo;

  /// ä¸ºå¯¼å…¥çš„äº¤æ˜“å…³è”å°é‡‘åº“
  Future<void> linkImportedTransactionsToVaults(
    List<Transaction> transactions,
  ) async {
    final mappings = await _mappingRepo.getAll();
    final vaults = await _vaultRepo.getAll();

    for (final tx in transactions) {
      if (tx.type != TransactionType.expense) continue;

      // æ ¹æ®åˆ†ç±»æŸ¥æ‰¾å¯¹åº”çš„å°é‡‘åº“
      final mapping = mappings.firstWhere(
        (m) => m.categoryId == tx.categoryId,
        orElse: () => null,
      );

      if (mapping != null) {
        final vault = vaults.firstWhere(
          (v) => v.id == mapping.vaultId,
          orElse: () => null,
        );

        if (vault != null) {
          // æ›´æ–°äº¤æ˜“çš„å°é‡‘åº“å…³è”
          tx.vaultId = vault.id;

          // æ›´æ–°å°é‡‘åº“å·²èŠ±è´¹é‡‘é¢
          vault.spentAmount += tx.amount;
          await _vaultRepo.update(vault);
        }
      }
    }
  }

  /// ç”Ÿæˆé¢„ç®—å½±å“æŠ¥å‘Š
  Future<BudgetImpactReport> generateBudgetImpactReport(
    List<Transaction> importedTransactions,
  ) async {
    final vaultImpacts = <String, double>{};

    for (final tx in importedTransactions) {
      if (tx.vaultId != null) {
        vaultImpacts[tx.vaultId!] =
            (vaultImpacts[tx.vaultId!] ?? 0) + tx.amount;
      }
    }

    final affectedVaults = <VaultImpact>[];
    for (final entry in vaultImpacts.entries) {
      final vault = await _vaultRepo.getById(entry.key);
      affectedVaults.add(VaultImpact(
        vault: vault,
        addedSpending: entry.value,
        newAvailable: vault.available - entry.value,
        isOverspent: vault.available - entry.value < 0,
      ));
    }

    return BudgetImpactReport(
      totalImpact: vaultImpacts.values.fold(0, (a, b) => a + b),
      affectedVaults: affectedVaults,
      vaultsOverspent: affectedVaults.where((v) => v.isOverspent).length,
    );
  }
}
```

#### 11.6.4 ä¸æ•°æ®å¤‡ä»½ç³»ç»Ÿé›†æˆ

```dart
/// å®Œæ•´æ•°æ®å¯¼å‡ºï¼ˆç”¨äºå¤‡ä»½ï¼‰
class FullDataExport {
  final TransactionRepository _txRepo;
  final VaultRepository _vaultRepo;
  final CategoryRepository _categoryRepo;
  final SettingsRepository _settingsRepo;

  /// å¯¼å‡ºå®Œæ•´å¤‡ä»½
  Future<BackupFile> exportFullBackup() async {
    final backup = BackupData(
      version: '2.0',
      exportDate: DateTime.now(),
      transactions: await _txRepo.getAll(),
      vaults: await _vaultRepo.getAll(),
      categories: await _categoryRepo.getAll(),
      settings: await _settingsRepo.getAll(),
      metadata: BackupMetadata(
        deviceId: await _getDeviceId(),
        appVersion: await _getAppVersion(),
        transactionCount: await _txRepo.count(),
      ),
    );

    // åºåˆ—åŒ–å¹¶å‹ç¼©
    final jsonStr = jsonEncode(backup.toJson());
    final compressed = gzip.encode(utf8.encode(jsonStr));

    // ä¿å­˜æ–‡ä»¶
    final fileName = 'ai_bookkeeping_backup_${DateTime.now().toIso8601String()}.abk';
    final file = await _saveToFile(compressed, fileName);

    return BackupFile(
      file: file,
      size: compressed.length,
      recordCount: backup.transactions.length,
    );
  }

  /// ä»å¤‡ä»½æ¢å¤
  Future<RestoreResult> restoreFromBackup(File backupFile) async {
    // è¯»å–å¹¶è§£å‹
    final compressed = await backupFile.readAsBytes();
    final jsonStr = utf8.decode(gzip.decode(compressed));
    final backup = BackupData.fromJson(jsonDecode(jsonStr));

    // ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
    if (!_isCompatibleVersion(backup.version)) {
      throw IncompatibleBackupException(
        'å¤‡ä»½ç‰ˆæœ¬ ${backup.version} ä¸å½“å‰ç‰ˆæœ¬ä¸å…¼å®¹',
      );
    }

    // æ¢å¤æ•°æ®
    await _categoryRepo.replaceAll(backup.categories);
    await _vaultRepo.replaceAll(backup.vaults);
    await _txRepo.replaceAll(backup.transactions);
    await _settingsRepo.replaceAll(backup.settings);

    return RestoreResult(
      success: true,
      restoredTransactions: backup.transactions.length,
      restoredVaults: backup.vaults.length,
      backupDate: backup.exportDate,
    );
  }
}
```

---


---

## 12. æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–

æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–æ˜¯2.0ç‰ˆæœ¬çš„æ ¸å¿ƒä½“éªŒå‡çº§ä¹‹ä¸€ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿä»ä»»æ„å›¾è¡¨ã€å¡ç‰‡ã€æ•°æ®ç‚¹å‡ºå‘ï¼Œå±‚å±‚æ·±å…¥åˆ°å…·ä½“çš„äº¤æ˜“æ˜ç»†ï¼ŒçœŸæ­£å®ç°"æ•°æ®é©±åŠ¨å†³ç­–"ã€‚

### 12.0 è®¾è®¡åŸåˆ™å›é¡¾

æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–ç³»ç»Ÿéµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™çŸ©é˜µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–è®¾è®¡åŸåˆ™çŸ©é˜µ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   æ— å¤„ä¸è”åŠ¨     â”‚     â”‚   æ‰€è§å³å¯ç‚¹    â”‚     â”‚   å±‚å±‚å¯ä¸‹é’»    â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ æ¯ä¸ªæ•°æ®å±•ç¤ºç‚¹  â”‚     â”‚ å›¾è¡¨ã€å¡ç‰‡ã€æ ‡ç­¾â”‚     â”‚ ä»æ¦‚è§ˆåˆ°æ˜ç»†   â”‚      â”‚
â”‚   â”‚ éƒ½å¯è·³è½¬å…³è”æ•°æ®â”‚     â”‚ éƒ½æœ‰ç‚¹å‡»å“åº”    â”‚     â”‚ é€å±‚æ·±å…¥æ¢ç´¢    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚      æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–ç³»ç»Ÿ       â”‚                       â”‚
â”‚                    â”‚   DataLinkageVisualization    â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–²                                       â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚                       â”‚                       â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   çŠ¶æ€å¯ä¿æŒ    â”‚     â”‚   å¿«é€Ÿå¯è¿”å›    â”‚     â”‚   æ™ºèƒ½å¯æ¨è    â”‚      â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚   â”‚ è·¨é¡µé¢ç­›é€‰æ¡ä»¶  â”‚     â”‚ é¢åŒ…å±‘å¯¼èˆªæ”¯æŒ  â”‚     â”‚ ä¸‹é’»åå±•ç¤ºç›¸å…³  â”‚      â”‚
â”‚   â”‚ è‡ªåŠ¨ä¼ é€’ä¿æŒ    â”‚     â”‚ ä»»æ„å±‚çº§å¿«é€Ÿè¿”å›â”‚     â”‚ æ´å¯Ÿå’Œå»ºè®®      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š

| åŸåˆ™ | åœ¨æ•°æ®è”åŠ¨ç³»ç»Ÿä¸­çš„ä½“ç° |
|------|----------------------|
| **æ— å¤„ä¸è”åŠ¨** | ä»ªè¡¨ç›˜æ¯ä¸ªå¡ç‰‡ã€å›¾è¡¨æ¯ä¸ªåˆ†åŒºã€åˆ—è¡¨æ¯æ¡è®°å½•éƒ½å¯ç‚¹å‡»è·³è½¬ |
| **æ‰€è§å³å¯ç‚¹** | è§†è§‰æç¤ºå¯ç‚¹å‡»æ€§ï¼ˆé¢œè‰²é«˜äº®ã€hoveræ•ˆæœã€æŒ‡ç¤ºå›¾æ ‡ï¼‰ |
| **å±‚å±‚å¯ä¸‹é’»** | æ”¯æŒæ— é™å±‚çº§ä¸‹é’»ï¼Œä»å¹´åº¦æ¦‚è§ˆåˆ°å•ç¬”äº¤æ˜“ |
| **çŠ¶æ€å¯ä¿æŒ** | ç­›é€‰æ¡ä»¶ã€æ—¶é—´èŒƒå›´åœ¨é¡µé¢é—´ä¼ é€’ä¸ä¸¢å¤± |
| **å¿«é€Ÿå¯è¿”å›** | é¢åŒ…å±‘å¯¼èˆªã€æ‰‹åŠ¿è¿”å›ã€ä¸€é”®å›åˆ°é¦–é¡µ |
| **æ™ºèƒ½å¯æ¨è** | ä¸‹é’»åæ™ºèƒ½å±•ç¤ºè¯¥ç»´åº¦çš„æ´å¯Ÿå’Œæ”¹å–„å»ºè®® |

**ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®è”åŠ¨ç³»ç»Ÿä¸2.0æ ¸å¿ƒæ¨¡å—ååŒå›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                         â”‚   æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–     â”‚                           â”‚
â”‚                         â”‚   (æœ¬ç« Â·æ ¸å¿ƒäº¤äº’)     â”‚                           â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                     â”‚                                       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚                             â”‚                             â”‚         â”‚
â”‚       â–¼                             â–¼                             â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ é’±é¾„åˆ†æç³»ç»Ÿ â”‚            â”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ â”‚            â”‚ é‡‘èä¹ æƒ¯åŸ¹å…» â”‚      â”‚
â”‚  â”‚  (ç¬¬7ç« )    â”‚            â”‚  (ç¬¬8ç« )    â”‚            â”‚  (ç¬¬9ç« )    â”‚      â”‚
â”‚  â”‚             â”‚            â”‚             â”‚            â”‚             â”‚      â”‚
â”‚  â”‚ é’±é¾„å¡ç‰‡â†’   â”‚            â”‚ é¢„ç®—å¡ç‰‡â†’   â”‚            â”‚ ä¹ æƒ¯æ•°æ®â†’   â”‚      â”‚
â”‚  â”‚ é’±é¾„è¯¦æƒ…é¡µ  â”‚            â”‚ å°é‡‘åº“è¯¦æƒ…  â”‚            â”‚ è¶‹åŠ¿å›¾è¡¨    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              æ ¸å¿ƒæ•°æ®æº                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ äº¤æ˜“è®°è´¦ç³»ç»Ÿ â”‚  â”‚  AIè¯†åˆ«ç³»ç»Ÿ  â”‚  â”‚ æ•°æ®å¯¼å…¥å¯¼å‡º â”‚  â”‚  ä¼™ä¼´åŒ–è®¾è®¡  â”‚        â”‚
â”‚  â”‚  (ç¬¬6ç« )    â”‚  â”‚  (ç¬¬10ç« )   â”‚  â”‚  (ç¬¬11ç« )   â”‚  â”‚  (ç¬¬4ç« )    â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ äº¤æ˜“è®°å½•â†’   â”‚  â”‚ åˆ†ç±»æ´å¯Ÿâ†’   â”‚  â”‚ å¯¼å…¥æ•°æ®â†’   â”‚  â”‚ æƒ…æ„ŸåŒ–â†’     â”‚        â”‚
â”‚  â”‚ åˆ—è¡¨/è¯¦æƒ…   â”‚  â”‚ æ™ºèƒ½åˆ†æ    â”‚  â”‚ æ‰¹é‡å±•ç¤º    â”‚  â”‚ åé¦ˆå±•ç¤º    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                          2.0æ–°å¢åä½œæ¨¡å—                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å®¶åº­è´¦æœ¬   â”‚  â”‚  è¯­éŸ³äº¤äº’    â”‚  â”‚  è‡ªå­¦ä¹ ç³»ç»Ÿ  â”‚  â”‚  ä½ç½®æ™ºèƒ½åŒ–  â”‚        â”‚
â”‚  â”‚  (ç¬¬13ç« )   â”‚  â”‚  (ç¬¬18ç« )   â”‚  â”‚  (ç¬¬17ç« )   â”‚  â”‚  (ç¬¬14ç« )   â”‚        â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚  â”‚ å®¶åº­æ•°æ®â†’   â”‚  â”‚ è¯­éŸ³æŸ¥è¯¢â†’   â”‚  â”‚ ä¸ªæ€§åŒ–â†’     â”‚  â”‚ ä½ç½®æ¶ˆè´¹â†’   â”‚        â”‚
â”‚  â”‚ æˆå‘˜è§†å›¾    â”‚  â”‚ æ•°æ®æ’­æŠ¥    â”‚  â”‚ è¶‹åŠ¿é¢„æµ‹    â”‚  â”‚ çƒ­åŠ›å›¾     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              æ•°æ®æµå‘                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚    å…¥å£å±‚                    åˆ†æå±‚                    æ•°æ®å±‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ä»ªè¡¨ç›˜å¡ç‰‡â”‚ â”€â”€ç‚¹å‡»â”€â”€â–º  â”‚è¯¦æƒ…åˆ†æé¡µâ”‚ â”€â”€ç‚¹å‡»â”€â”€â–º  â”‚äº¤æ˜“åˆ—è¡¨ â”‚            â”‚
â”‚  â”‚è¶‹åŠ¿æ¦‚è§ˆ â”‚              â”‚åˆ†ç±»ç»Ÿè®¡ â”‚              â”‚å•ç¬”è¯¦æƒ…â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â–²                        â–²                        â”‚                  â”‚
â”‚       â”‚                        â”‚                        â”‚                  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                           é¢åŒ…å±‘è¿”å›                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.1 æ•°æ®è”åŠ¨æ¶æ„

#### 12.1.1 ä¸‰å±‚è”åŠ¨æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®è”åŠ¨ä¸‰å±‚æ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘                        å…¥å£å±‚ (Entry Layer)                         â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚è´¢åŠ¡å¥åº·â”‚ â”‚é’±é¾„å¡ç‰‡â”‚ â”‚é¢„ç®—æ¦‚è§ˆâ”‚ â”‚æ”¶æ”¯æ¦‚è§ˆâ”‚ â”‚è´¦æˆ·ä½™é¢â”‚ â”‚ä»Šæ—¥æ´å¯Ÿâ”‚ â•‘   â”‚
â”‚  â•‘  â”‚æ€»è§ˆå¡ç‰‡â”‚ â”‚ä»ªè¡¨ç›˜ â”‚ â”‚å°é‡‘åº“ â”‚ â”‚ä¸‰æ å¡ç‰‡â”‚ â”‚æ±‡æ€»å¡ç‰‡â”‚ â”‚å»ºè®®å¡ç‰‡â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•   â”‚
â”‚         â”‚          â”‚          â”‚          â”‚          â”‚          â”‚          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                          2.0æ–°å¢å…¥å£å¡ç‰‡                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚å®¶åº­è´¦æœ¬â”‚ â”‚ä¹ æƒ¯æ‰“å¡â”‚ â”‚ä½ç½®æ¶ˆè´¹â”‚ â”‚è¯­éŸ³å¿«æ·â”‚ â”‚æˆå°±å‹‹ç« â”‚ â”‚å­¦ä¹ è¿›åº¦â”‚       â”‚
â”‚  â”‚æˆå‘˜å¡ç‰‡â”‚ â”‚è¿›åº¦å¡ç‰‡â”‚ â”‚çƒ­åŠ›å›¾ â”‚ â”‚å…¥å£å¡ç‰‡â”‚ â”‚å±•ç¤ºå¢™ â”‚ â”‚ä¸ªæ€§åŒ– â”‚       â”‚
â”‚  â”‚ (13ç« )â”‚ â”‚ (9ç« ) â”‚ â”‚(14ç« ) â”‚ â”‚(18ç« ) â”‚ â”‚(9ç« )  â”‚ â”‚(17ç« ) â”‚       â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚      â”‚          â”‚          â”‚          â”‚          â”‚          â”‚            â”‚
â”‚      â–¼          â–¼          â–¼          â–¼          â–¼          â–¼            â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘                       åˆ†æå±‚ (Analysis Layer)                       â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘  â”‚ é’±é¾„è¯¦æƒ… â”‚ é¢„ç®—æ‰§è¡Œ â”‚ åˆ†ç±»ç»Ÿè®¡ â”‚ è¶‹åŠ¿å›¾è¡¨ â”‚ è´¦æˆ·æ˜ç»† â”‚ AIæ´å¯Ÿ â”‚  â•‘   â”‚
â”‚  â•‘  â”‚ è¶‹åŠ¿åˆ†æ â”‚ å°é‡‘åº“è¯¦æƒ…â”‚ ç¯å½¢å›¾  â”‚ çƒ­åŠ›å›¾  â”‚ æ”¶æ”¯å¯¹æ¯” â”‚ å»ºè®®è¯¦æƒ…â”‚  â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘   â”‚
â”‚  â•‘                        2.0æ–°å¢åˆ†æè§†å›¾                              â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘  â”‚ å®¶åº­æŠ¥è¡¨ â”‚ ä¹ æƒ¯ç»Ÿè®¡ â”‚ ä½ç½®åˆ†æ â”‚ è¯­éŸ³å†å² â”‚ æˆå°±è¯¦æƒ… â”‚ ä¸ªæ€§ç”»åƒâ”‚  â•‘   â”‚
â”‚  â•‘  â”‚ æˆå‘˜å¯¹æ¯” â”‚ è¿ç»­è®°å½• â”‚ åœ°ç†å›¾è¡¨ â”‚ è¯†åˆ«è®°å½• â”‚ è§£é”è¿›åº¦ â”‚ åå¥½åˆ†æâ”‚  â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                 â”‚                                          â”‚
â”‚                                 â–¼                                          â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘                        æ•°æ®å±‚ (Data Layer)                          â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘  â”‚                      äº¤æ˜“è®°å½•åˆ—è¡¨                             â”‚  â•‘   â”‚
â”‚  â•‘  â”‚   â€¢ æŒ‰ç­›é€‰æ¡ä»¶è¿‡æ»¤ï¼ˆåˆ†ç±»/æ—¶é—´/è´¦æˆ·/é‡‘é¢/æ ‡ç­¾ï¼‰               â”‚  â•‘   â”‚
â”‚  â•‘  â”‚   â€¢ æ”¯æŒæ’åºã€æœç´¢ã€æ‰¹é‡æ“ä½œ                                 â”‚  â•‘   â”‚
â”‚  â•‘  â”‚   â€¢ ç‚¹å‡»è¿›å…¥å•ç¬”äº¤æ˜“è¯¦æƒ…/ç¼–è¾‘                                â”‚  â•‘   â”‚
â”‚  â•‘  â”‚   â€¢ 2.0æ–°å¢ï¼šå®¶åº­æˆå‘˜ç­›é€‰ã€ä½ç½®ç­›é€‰ã€è¯­éŸ³è®°å½•å…³è”ç­›é€‰        â”‚  â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                            â”‚
â”‚  ğŸ’¡ æ¯ä¸€å±‚éƒ½å¯ç‚¹å‡»è¿›å…¥ä¸‹ä¸€å±‚ï¼Œä¹Ÿå¯é€šè¿‡é¢åŒ…å±‘å¿«é€Ÿè¿”å›ä»»æ„ä¸Šå±‚               â”‚
â”‚  ğŸ’¡ 2.0æ–°å¢ï¼šè¯­éŸ³è¯´"æŸ¥çœ‹é¤é¥®æ”¯å‡º"å¯ç›´è¾¾åˆ†ç±»è¯¦æƒ…é¡µ(ç¬¬18ç« )                  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.1.2 è”åŠ¨è§¦å‘ç‚¹æ¸…å•

| å…¥å£ç»„ä»¶ | ç‚¹å‡»è¡Œä¸º | è·³è½¬ç›®æ ‡ | ä¼ é€’å‚æ•° |
|----------|----------|----------|----------|
| è´¢åŠ¡å¥åº·åˆ†å¡ç‰‡ | ç‚¹å‡»æ•´ä½“ | è´¢åŠ¡å¥åº·è¯¦æƒ…é¡µ | å½“å‰æœˆä»½ |
| é’±é¾„ä»ªè¡¨ç›˜ | ç‚¹å‡»æ•°å€¼ | é’±é¾„è¶‹åŠ¿åˆ†æé¡µ | æ—¶é—´èŒƒå›´ |
| é¢„ç®—æ¦‚è§ˆå¡ç‰‡ | ç‚¹å‡»è¿›åº¦æ¡ | é¢„ç®—æ‰§è¡Œè¯¦æƒ…é¡µ | é¢„ç®—å‘¨æœŸ |
| æ”¶æ”¯ä¸‰æ å¡ç‰‡ | ç‚¹å‡»æ”¶å…¥/æ”¯å‡º/ç»“ä½™ | å¯¹åº”äº¤æ˜“åˆ—è¡¨ | ç±»å‹ç­›é€‰ |
| åˆ†ç±»é¥¼å›¾æ‰‡åŒº | ç‚¹å‡»åˆ†ç±» | åˆ†ç±»è¯¦æƒ…é¡µ | åˆ†ç±»ID+æ—¶é—´èŒƒå›´ |
| è¶‹åŠ¿æŠ˜çº¿å›¾ | ç‚¹å‡»æ•°æ®ç‚¹ | å½“æ—¥äº¤æ˜“åˆ—è¡¨ | æ—¥æœŸ |
| çƒ­åŠ›å›¾æ ¼å­ | ç‚¹å‡»æ ¼å­ | æ—¶æ®µäº¤æ˜“åˆ—è¡¨ | æ—¥æœŸ+æ—¶æ®µ |
| æ´å¯Ÿå»ºè®®å¡ç‰‡ | ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…" | ç›¸å…³äº¤æ˜“/åˆ†ç±» | æ´å¯Ÿç±»å‹å‚æ•° |
| è´¦æˆ·å¡ç‰‡ | ç‚¹å‡»è´¦æˆ· | è´¦æˆ·æ”¶æ”¯æ˜ç»† | è´¦æˆ·ID |

**2.0æ–°å¢å…¥å£è§¦å‘ç‚¹**ï¼š

| å…¥å£ç»„ä»¶ | ç‚¹å‡»è¡Œä¸º | è·³è½¬ç›®æ ‡ | ä¼ é€’å‚æ•° | æ¥æºç« èŠ‚ |
|----------|----------|----------|----------|---------|
| å®¶åº­æˆå‘˜å¡ç‰‡ | ç‚¹å‡»æˆå‘˜å¤´åƒ | æˆå‘˜æ¶ˆè´¹è¯¦æƒ…é¡µ | æˆå‘˜ID+æ—¶é—´èŒƒå›´ | 13ç«  |
| å®¶åº­è´¦æœ¬æ¦‚è§ˆ | ç‚¹å‡»"æŸ¥çœ‹å…¨éƒ¨" | å®¶åº­æŠ¥è¡¨åˆ†æé¡µ | å®¶åº­ID | 13ç«  |
| ä¹ æƒ¯æ‰“å¡å¡ç‰‡ | ç‚¹å‡»è¿›åº¦ç¯ | ä¹ æƒ¯ç»Ÿè®¡è¯¦æƒ…é¡µ | ä¹ æƒ¯ç±»å‹ | 9ç«  |
| æˆå°±å‹‹ç« å¢™ | ç‚¹å‡»å‹‹ç«  | æˆå°±è¯¦æƒ…é¡µ | æˆå°±ID | 9ç«  |
| ä½ç½®æ¶ˆè´¹çƒ­åŠ›å›¾ | ç‚¹å‡»åŒºåŸŸ | ä½ç½®æ¶ˆè´¹åˆ†æé¡µ | åœ°ç†åæ ‡èŒƒå›´ | 14ç«  |
| è¯­éŸ³å¿«æ·å…¥å£ | ç‚¹å‡»éº¦å…‹é£ | è¯­éŸ³è®°è´¦é¡µ | æ—  | 18ç«  |
| è¯­éŸ³å†å²å¡ç‰‡ | ç‚¹å‡»è®°å½• | è¯­éŸ³è¯†åˆ«è¯¦æƒ…é¡µ | è®°å½•ID | 18ç«  |
| å­¦ä¹ è¿›åº¦å¡ç‰‡ | ç‚¹å‡»"ä¸ªæ€§åŒ–" | ç”¨æˆ·åå¥½ç”»åƒé¡µ | ç”¨æˆ·ID | 17ç«  |

#### 12.1.3 è”åŠ¨æ¶æ„å®ç°

```dart
/// æ•°æ®è”åŠ¨é…ç½®ä¸­å¿ƒ
class DataLinkageConfig {
  /// è”åŠ¨è·¯ç”±æ˜ å°„
  static const Map<String, LinkageRoute> routeMap = {
    'money_age_card': LinkageRoute(
      target: '/money-age/detail',
      transitionType: TransitionType.slideUp,
      analyticsEvent: 'drill_down_money_age',
    ),
    'budget_overview': LinkageRoute(
      target: '/budget/execution',
      transitionType: TransitionType.slideRight,
      analyticsEvent: 'drill_down_budget',
    ),
    'category_pie_segment': LinkageRoute(
      target: '/category/:id/detail',
      transitionType: TransitionType.zoomIn,
      analyticsEvent: 'drill_down_category',
    ),
    'transaction_list': LinkageRoute(
      target: '/transaction/:id',
      transitionType: TransitionType.slideUp,
      analyticsEvent: 'view_transaction_detail',
    ),
  };
}

/// è”åŠ¨è·¯ç”±ä¿¡æ¯
class LinkageRoute {
  final String target;
  final TransitionType transitionType;
  final String analyticsEvent;

  const LinkageRoute({
    required this.target,
    required this.transitionType,
    required this.analyticsEvent,
  });
}

/// è¿‡æ¸¡åŠ¨ç”»ç±»å‹
enum TransitionType {
  slideRight,   // æ ‡å‡†æ¨ªå‘æ»‘å…¥
  slideUp,      // åº•éƒ¨æ»‘å…¥ï¼ˆè¯¦æƒ…é¡µï¼‰
  zoomIn,       // ç¼©æ”¾è¿›å…¥ï¼ˆå›¾è¡¨ä¸‹é’»ï¼‰
  fade,         // æ·¡å…¥æ·¡å‡º
}
```

### 12.2 å¯è§†åŒ–ç»„ä»¶ä½“ç³»

#### 12.2.1 ç»„ä»¶åˆ†ç±»ä¸è®¾è®¡è§„èŒƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¯è§†åŒ–ç»„ä»¶ä½“ç³»                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         å›¾è¡¨ç»„ä»¶ (Charts)                            â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ é¥¼å›¾/   â”‚ â”‚ æŸ±çŠ¶å›¾  â”‚ â”‚ æŠ˜çº¿å›¾  â”‚ â”‚ çƒ­åŠ›å›¾  â”‚ â”‚ æ¼æ–—å›¾  â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ ç¯å½¢å›¾  â”‚ â”‚ å †å å›¾  â”‚ â”‚ é¢ç§¯å›¾  â”‚ â”‚ æ—¥å†å›¾  â”‚ â”‚ é›·è¾¾å›¾  â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         å¡ç‰‡ç»„ä»¶ (Cards)                             â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ æ•°å€¼å¡ç‰‡â”‚ â”‚ è¿›åº¦å¡ç‰‡â”‚ â”‚ å¯¹æ¯”å¡ç‰‡â”‚ â”‚ è¶‹åŠ¿å¡ç‰‡â”‚ â”‚ æ´å¯Ÿå¡ç‰‡â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ å•æŒ‡æ ‡  â”‚ â”‚ ç¯å½¢è¿›åº¦â”‚ â”‚ åŒæœŸå¯¹æ¯”â”‚ â”‚ è¿·ä½ å›¾  â”‚ â”‚ AIå»ºè®®  â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         æŒ‡æ ‡ç»„ä»¶ (Metrics)                           â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ å¤§æ•°å€¼  â”‚ â”‚ ç™¾åˆ†æ¯”  â”‚ â”‚ è¿›åº¦æ¡  â”‚ â”‚ ç­‰çº§å¾½ç« â”‚ â”‚ è¶‹åŠ¿ç®­å¤´â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ ä¸»æŒ‡æ ‡  â”‚ â”‚ å˜åŒ–ç‡  â”‚ â”‚ æ¨ªå‘/åœ†å½¢â”‚ â”‚ é¢œè‰²åˆ†çº§â”‚ â”‚ æ¶¨è·Œå¹…  â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                          2.0æ–°å¢ç»„ä»¶ç±»å‹                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    å®¶åº­å¯è§†åŒ–ç»„ä»¶ (FamilyÂ·ç¬¬13ç« )                     â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ æˆå‘˜å¤´åƒâ”‚ â”‚ æˆå‘˜å¯¹æ¯”â”‚ â”‚ è´¡çŒ®å æ¯”â”‚ â”‚ åä½œæ—¶é—´â”‚ â”‚ å®¶åº­æ’è¡Œâ”‚       â”‚   â”‚
â”‚   â”‚  â”‚ æ¶ˆè´¹å¡ç‰‡â”‚ â”‚ æŸ±çŠ¶å›¾  â”‚ â”‚ ç¯å½¢å›¾  â”‚ â”‚ çº¿å›¾    â”‚ â”‚ æ¦œå•   â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    ä½ç½®å¯è§†åŒ–ç»„ä»¶ (LocationÂ·ç¬¬14ç« )                   â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ åœ°ç†çƒ­åŠ›â”‚ â”‚ å•†åœˆåˆ†å¸ƒâ”‚ â”‚ è½¨è¿¹åœ°å›¾â”‚ â”‚ ä½ç½®æ ‡è®°â”‚ â”‚ åŒºåŸŸç»Ÿè®¡â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ åœ°å›¾    â”‚ â”‚ æ°”æ³¡å›¾  â”‚ â”‚ è·¯å¾„å›¾  â”‚ â”‚ èšåˆå›¾  â”‚ â”‚ æŸ±çŠ¶å›¾  â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    ä¹ æƒ¯å¯è§†åŒ–ç»„ä»¶ (HabitÂ·ç¬¬9ç« )                       â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ æ‰“å¡æ—¥å†â”‚ â”‚ è¿ç»­å¤©æ•°â”‚ â”‚ æˆå°±å‹‹ç« â”‚ â”‚ ä¹ æƒ¯é›·è¾¾â”‚ â”‚ è´¢åŠ¡å¥åº·â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ çƒ­åŠ›å›¾  â”‚ â”‚ è®¡æ•°å™¨  â”‚ â”‚ å¾½ç« å¢™  â”‚ â”‚ å¤šç»´å›¾  â”‚ â”‚ åˆ†æ•°ç¯  â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    è¯­éŸ³å¯è§†åŒ–ç»„ä»¶ (VoiceÂ·ç¬¬18ç« )                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ æ³¢å½¢å›¾  â”‚ â”‚ è¯†åˆ«ç»“æœâ”‚ â”‚ ç½®ä¿¡åº¦  â”‚ â”‚ å†å²è®°å½•â”‚ â”‚ å¿«æ·å…¥å£â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ å½•éŸ³çŠ¶æ€â”‚ â”‚ å®æ—¶å±•ç¤ºâ”‚ â”‚ è¿›åº¦æ¡  â”‚ â”‚ æ—¶é—´çº¿  â”‚ â”‚ æµ®åŠ¨æŒ‰é’®â”‚       â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚   è®¾è®¡è§„èŒƒï¼š                                                                â”‚
â”‚   â€¢ æ‰€æœ‰ç»„ä»¶å¿…é¡»æ”¯æŒç‚¹å‡»äº‹ä»¶å’Œè§¦è§‰åé¦ˆ                                      â”‚
â”‚   â€¢ å¯ç‚¹å‡»åŒºåŸŸéœ€æœ‰è§†è§‰æç¤ºï¼ˆé¢œè‰²å˜åŒ–/å›¾æ ‡/ä¸‹åˆ’çº¿ï¼‰                          â”‚
â”‚   â€¢ å›¾è¡¨éœ€æ”¯æŒæ‰‹åŠ¿æ“ä½œï¼ˆç¼©æ”¾/æ‹–åŠ¨/é•¿æŒ‰è¯¦æƒ…ï¼‰                                â”‚
â”‚   â€¢ ç»„ä»¶éœ€å“åº”æ·±è‰²æ¨¡å¼                                                     â”‚
â”‚   â€¢ åŠ è½½çŠ¶æ€éœ€æœ‰éª¨æ¶å±å ä½                                                 â”‚
â”‚                                                                             â”‚
â”‚   2.0æ–°å¢è§„èŒƒï¼š                                                             â”‚
â”‚   â€¢ æ‰€æœ‰ç»„ä»¶éœ€æ”¯æŒè¯­éŸ³æ’­æŠ¥ï¼ˆæ— éšœç¢Â·ç¬¬5ç« ï¼‰                                  â”‚
â”‚   â€¢ å®¶åº­ç»„ä»¶éœ€æ”¯æŒæˆå‘˜æƒé™æ§åˆ¶ï¼ˆç¬¬13ç« ï¼‰                                    â”‚
â”‚   â€¢ ä½ç½®ç»„ä»¶éœ€æ”¯æŒéšç§æ¨¡å¼ï¼ˆç¬¬22ç« ï¼‰                                        â”‚
â”‚   â€¢ è¯­éŸ³ç»„ä»¶éœ€æ”¯æŒå®æ—¶åé¦ˆåŠ¨ç”»                                              â”‚
â”‚   â€¢ ä¹ æƒ¯ç»„ä»¶éœ€æ”¯æŒåŠ¨æ€æ¿€åŠ±æ•ˆæœï¼ˆä¼™ä¼´åŒ–Â·ç¬¬4ç« ï¼‰                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2.0æ–°å¢ç»„ä»¶è¯¦ç»†è¯´æ˜**ï¼š

| ç»„ä»¶ç±»åˆ« | å…¸å‹ç»„ä»¶ | æ•°æ®æ¥æº | ä¸‹é’»æ”¯æŒ |
|---------|---------|---------|---------|
| **å®¶åº­å¯è§†åŒ–** | æˆå‘˜æ¶ˆè´¹å¯¹æ¯”æŸ±çŠ¶å›¾ | ç¬¬13ç« å®¶åº­è´¦æœ¬ | ç‚¹å‡»æˆå‘˜â†’æˆå‘˜è¯¦æƒ…é¡µ |
| **ä½ç½®å¯è§†åŒ–** | æ¶ˆè´¹åœ°ç†çƒ­åŠ›å›¾ | ç¬¬14ç« ä½ç½®æ™ºèƒ½ | ç‚¹å‡»åŒºåŸŸâ†’åŒºåŸŸæ¶ˆè´¹åˆ—è¡¨ |
| **ä¹ æƒ¯å¯è§†åŒ–** | è®°è´¦æ‰“å¡æ—¥å† | ç¬¬9ç« ä¹ æƒ¯åŸ¹å…» | ç‚¹å‡»æ—¥æœŸâ†’å½“æ—¥è®°è´¦è¯¦æƒ… |
| **è¯­éŸ³å¯è§†åŒ–** | è¯­éŸ³è¯†åˆ«æ³¢å½¢å›¾ | ç¬¬18ç« è¯­éŸ³äº¤äº’ | ç‚¹å‡»è®°å½•â†’è¯†åˆ«ç»“æœè¯¦æƒ… |

#### 12.2.2 å¯ä¸‹é’»é¥¼å›¾ç»„ä»¶

```dart
/// å¯ä¸‹é’»çš„é¥¼å›¾/ç¯å½¢å›¾ç»„ä»¶
class DrillDownPieChart extends StatefulWidget {
  final List<PieChartSegment> data;
  final String title;
  final String? centerText;           // ç¯å½¢å›¾ä¸­å¿ƒæ–‡å­—
  final double? centerValue;          // ç¯å½¢å›¾ä¸­å¿ƒæ•°å€¼
  final bool showLegend;              // æ˜¯å¦æ˜¾ç¤ºå›¾ä¾‹
  final Function(PieChartSegment segment)? onSegmentTap;
  final Function(PieChartSegment segment)? onSegmentLongPress;

  const DrillDownPieChart({
    required this.data,
    required this.title,
    this.centerText,
    this.centerValue,
    this.showLegend = true,
    this.onSegmentTap,
    this.onSegmentLongPress,
  });

  @override
  State<DrillDownPieChart> createState() => _DrillDownPieChartState();
}

class _DrillDownPieChartState extends State<DrillDownPieChart>
    with SingleTickerProviderStateMixin {
  int? _touchedIndex;
  late AnimationController _animationController;

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 300),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // æ ‡é¢˜æ 
        _buildTitleBar(),
        const SizedBox(height: 16),

        // å›¾è¡¨ä¸»ä½“
        AspectRatio(
          aspectRatio: 1.2,
          child: Stack(
            alignment: Alignment.center,
            children: [
              // é¥¼å›¾
              PieChart(
                PieChartData(
                  sections: _buildSections(),
                  pieTouchData: PieTouchData(
                    touchCallback: _handleTouch,
                    longPressDuration: const Duration(milliseconds: 500),
                  ),
                  centerSpaceRadius: widget.centerText != null ? 60 : 0,
                  sectionsSpace: 2,
                ),
              ),
              // ä¸­å¿ƒå†…å®¹ï¼ˆç¯å½¢å›¾ï¼‰
              if (widget.centerText != null)
                _buildCenterContent(),
            ],
          ),
        ),

        // å¯ç‚¹å‡»å›¾ä¾‹
        if (widget.showLegend) ...[
          const SizedBox(height: 16),
          _buildClickableLegend(),
        ],

        // ä¸‹é’»æç¤º
        _buildDrillDownHint(),
      ],
    );
  }

  Widget _buildTitleBar() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(widget.title, style: Theme.of(context).textTheme.titleMedium),
        Icon(Icons.touch_app, size: 16, color: Colors.grey),
      ],
    );
  }

  List<PieChartSectionData> _buildSections() {
    return widget.data.asMap().entries.map((entry) {
      final index = entry.key;
      final segment = entry.value;
      final isTouched = _touchedIndex == index;

      return PieChartSectionData(
        value: segment.value,
        color: segment.color,
        title: isTouched ? '${segment.percentage.toStringAsFixed(1)}%' : '',
        radius: isTouched ? 90 : 80,
        titleStyle: const TextStyle(
          color: Colors.white,
          fontSize: 14,
          fontWeight: FontWeight.bold,
        ),
        badgeWidget: isTouched ? _buildBadge(segment) : null,
        badgePositionPercentageOffset: 1.2,
      );
    }).toList();
  }

  Widget _buildBadge(PieChartSegment segment) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: segment.color,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: segment.color.withOpacity(0.4),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Text(
        'Â¥${segment.value.toStringAsFixed(0)}',
        style: const TextStyle(color: Colors.white, fontSize: 12),
      ),
    );
  }

  Widget _buildCenterContent() {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        if (widget.centerValue != null)
          Text(
            'Â¥${widget.centerValue!.toStringAsFixed(0)}',
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
        if (widget.centerText != null)
          Text(
            widget.centerText!,
            style: TextStyle(color: Colors.grey[600], fontSize: 12),
          ),
      ],
    );
  }

  Widget _buildClickableLegend() {
    return Wrap(
      spacing: 16,
      runSpacing: 8,
      children: widget.data.map((segment) {
        return InkWell(
          onTap: () {
            HapticFeedback.selectionClick();
            widget.onSegmentTap?.call(segment);
          },
          borderRadius: BorderRadius.circular(8),
          child: Padding(
            padding: const EdgeInsets.all(4),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 12,
                  height: 12,
                  decoration: BoxDecoration(
                    color: segment.color,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
                const SizedBox(width: 6),
                Text(segment.label),
                const SizedBox(width: 4),
                Icon(Icons.chevron_right, size: 14, color: Colors.grey),
              ],
            ),
          ),
        );
      }).toList(),
    );
  }

  Widget _buildDrillDownHint() {
    return Padding(
      padding: const EdgeInsets.only(top: 8),
      child: Text(
        'ğŸ’¡ ç‚¹å‡»åˆ†ç±»æŸ¥çœ‹è¯¦ç»†äº¤æ˜“',
        style: TextStyle(color: Colors.grey[500], fontSize: 12),
      ),
    );
  }

  void _handleTouch(FlTouchEvent event, PieTouchResponse? response) {
    if (event is FlTapUpEvent) {
      final index = response?.touchedSection?.touchedSectionIndex;
      if (index != null && index >= 0 && index < widget.data.length) {
        HapticFeedback.lightImpact();
        widget.onSegmentTap?.call(widget.data[index]);
      }
    } else if (event is FlLongPressStart) {
      final index = response?.touchedSection?.touchedSectionIndex;
      if (index != null && index >= 0 && index < widget.data.length) {
        HapticFeedback.mediumImpact();
        widget.onSegmentLongPress?.call(widget.data[index]);
      }
    } else {
      setState(() {
        _touchedIndex = response?.touchedSection?.touchedSectionIndex;
      });
    }
  }
}

/// é¥¼å›¾åˆ†æ®µæ•°æ®
class PieChartSegment {
  final String id;
  final String label;
  final double value;
  final double percentage;
  final Color color;
  final String? iconName;

  const PieChartSegment({
    required this.id,
    required this.label,
    required this.value,
    required this.percentage,
    required this.color,
    this.iconName,
  });
}
```

#### 12.2.3 å¯ä¸‹é’»è¶‹åŠ¿å›¾ç»„ä»¶

```dart
/// å¯ä¸‹é’»çš„è¶‹åŠ¿æŠ˜çº¿å›¾ç»„ä»¶
class DrillDownLineChart extends StatefulWidget {
  final List<TrendDataPoint> data;
  final String title;
  final String? subtitle;
  final bool showAverage;             // æ˜¾ç¤ºå¹³å‡çº¿
  final bool showBudgetLine;          // æ˜¾ç¤ºé¢„ç®—çº¿
  final double? budgetValue;
  final TimeGranularity granularity;  // æ—¶é—´ç²’åº¦
  final Function(TrendDataPoint point)? onPointTap;

  const DrillDownLineChart({
    required this.data,
    required this.title,
    this.subtitle,
    this.showAverage = false,
    this.showBudgetLine = false,
    this.budgetValue,
    this.granularity = TimeGranularity.day,
    this.onPointTap,
  });

  @override
  State<DrillDownLineChart> createState() => _DrillDownLineChartState();
}

class _DrillDownLineChartState extends State<DrillDownLineChart> {
  int? _selectedIndex;
  Offset? _tooltipPosition;

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // æ ‡é¢˜å’Œç²’åº¦åˆ‡æ¢
        _buildHeader(),
        const SizedBox(height: 16),

        // å›¾è¡¨ä¸»ä½“
        AspectRatio(
          aspectRatio: 1.6,
          child: Stack(
            children: [
              LineChart(_buildChartData()),
              if (_selectedIndex != null)
                _buildTooltip(),
            ],
          ),
        ),

        // ç»Ÿè®¡æ‘˜è¦
        const SizedBox(height: 16),
        _buildSummary(),

        // æ´å¯Ÿæç¤º
        _buildInsightHint(),
      ],
    );
  }

  Widget _buildHeader() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(widget.title, style: Theme.of(context).textTheme.titleMedium),
            if (widget.subtitle != null)
              Text(widget.subtitle!,
                style: TextStyle(color: Colors.grey[600], fontSize: 12)),
          ],
        ),
        // æ—¶é—´ç²’åº¦åˆ‡æ¢
        SegmentedButton<TimeGranularity>(
          segments: const [
            ButtonSegment(value: TimeGranularity.day, label: Text('æ—¥')),
            ButtonSegment(value: TimeGranularity.week, label: Text('å‘¨')),
            ButtonSegment(value: TimeGranularity.month, label: Text('æœˆ')),
          ],
          selected: {widget.granularity},
          onSelectionChanged: (Set<TimeGranularity> selection) {
            // é€šçŸ¥çˆ¶ç»„ä»¶åˆ‡æ¢ç²’åº¦
          },
        ),
      ],
    );
  }

  LineChartData _buildChartData() {
    final spots = widget.data.asMap().entries.map((entry) {
      return FlSpot(entry.key.toDouble(), entry.value.value);
    }).toList();

    final maxY = spots.map((s) => s.y).reduce(max) * 1.2;
    final avgValue = spots.map((s) => s.y).reduce((a, b) => a + b) / spots.length;

    return LineChartData(
      lineBarsData: [
        // ä¸»æ•°æ®çº¿
        LineChartBarData(
          spots: spots,
          isCurved: true,
          color: Theme.of(context).primaryColor,
          barWidth: 3,
          dotData: FlDotData(
            show: true,
            getDotPainter: (spot, percent, barData, index) {
              final isSelected = index == _selectedIndex;
              return FlDotCirclePainter(
                radius: isSelected ? 6 : 4,
                color: isSelected
                    ? Theme.of(context).primaryColor
                    : Colors.white,
                strokeWidth: isSelected ? 3 : 2,
                strokeColor: Theme.of(context).primaryColor,
              );
            },
          ),
          belowBarData: BarAreaData(
            show: true,
            color: Theme.of(context).primaryColor.withOpacity(0.1),
          ),
        ),
        // å¹³å‡çº¿
        if (widget.showAverage)
          LineChartBarData(
            spots: [
              FlSpot(0, avgValue),
              FlSpot(spots.length - 1, avgValue),
            ],
            isCurved: false,
            color: Colors.orange,
            barWidth: 1,
            dashArray: [5, 5],
            dotData: FlDotData(show: false),
          ),
        // é¢„ç®—çº¿
        if (widget.showBudgetLine && widget.budgetValue != null)
          LineChartBarData(
            spots: [
              FlSpot(0, widget.budgetValue!),
              FlSpot(spots.length - 1, widget.budgetValue!),
            ],
            isCurved: false,
            color: Colors.red,
            barWidth: 1,
            dashArray: [8, 4],
            dotData: FlDotData(show: false),
          ),
      ],
      lineTouchData: LineTouchData(
        touchCallback: (FlTouchEvent event, LineTouchResponse? response) {
          if (event is FlTapUpEvent) {
            final index = response?.lineBarSpots?.first.spotIndex;
            if (index != null && index < widget.data.length) {
              HapticFeedback.lightImpact();
              widget.onPointTap?.call(widget.data[index]);
            }
          } else if (response?.lineBarSpots != null) {
            setState(() {
              _selectedIndex = response!.lineBarSpots!.first.spotIndex;
            });
          }
        },
        handleBuiltInTouches: false,
        getTouchedSpotIndicator: (barData, spotIndexes) {
          return spotIndexes.map((index) {
            return TouchedSpotIndicatorData(
              FlLine(color: Colors.grey, strokeWidth: 1, dashArray: [3, 3]),
              FlDotData(show: false),
            );
          }).toList();
        },
      ),
      gridData: FlGridData(
        show: true,
        drawVerticalLine: false,
        horizontalInterval: maxY / 4,
        getDrawingHorizontalLine: (value) => FlLine(
          color: Colors.grey.withOpacity(0.2),
          strokeWidth: 1,
        ),
      ),
      titlesData: FlTitlesData(
        bottomTitles: AxisTitles(
          sideTitles: SideTitles(
            showTitles: true,
            interval: (widget.data.length / 5).ceilToDouble(),
            getTitlesWidget: (value, meta) {
              final index = value.toInt();
              if (index < 0 || index >= widget.data.length) return const SizedBox();
              return Text(
                widget.data[index].label,
                style: TextStyle(color: Colors.grey[600], fontSize: 10),
              );
            },
          ),
        ),
        leftTitles: AxisTitles(
          sideTitles: SideTitles(
            showTitles: true,
            reservedSize: 50,
            getTitlesWidget: (value, meta) {
              return Text(
                'Â¥${value.toInt()}',
                style: TextStyle(color: Colors.grey[600], fontSize: 10),
              );
            },
          ),
        ),
        topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
        rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
      ),
      minY: 0,
      maxY: maxY,
    );
  }

  Widget _buildTooltip() {
    if (_selectedIndex == null || _selectedIndex! >= widget.data.length) {
      return const SizedBox();
    }
    final point = widget.data[_selectedIndex!];
    return Positioned(
      top: 10,
      left: 10,
      child: Container(
        padding: const EdgeInsets.all(8),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(8),
          boxShadow: [BoxShadow(color: Colors.black12, blurRadius: 4)],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(point.fullLabel, style: const TextStyle(fontSize: 12)),
            Text('Â¥${point.value.toStringAsFixed(0)}',
              style: const TextStyle(fontWeight: FontWeight.bold)),
            if (point.changeRate != null)
              Text(
                '${point.changeRate! >= 0 ? '+' : ''}${(point.changeRate! * 100).toStringAsFixed(1)}%',
                style: TextStyle(
                  color: point.changeRate! >= 0 ? Colors.red : Colors.green,
                  fontSize: 11,
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildSummary() {
    final total = widget.data.map((d) => d.value).reduce((a, b) => a + b);
    final avg = total / widget.data.length;
    final maxVal = widget.data.map((d) => d.value).reduce(max);
    final minVal = widget.data.map((d) => d.value).reduce(min);

    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceAround,
      children: [
        _SummaryItem(label: 'æ€»è®¡', value: 'Â¥${total.toStringAsFixed(0)}'),
        _SummaryItem(label: 'æ—¥å‡', value: 'Â¥${avg.toStringAsFixed(0)}'),
        _SummaryItem(label: 'æœ€é«˜', value: 'Â¥${maxVal.toStringAsFixed(0)}'),
        _SummaryItem(label: 'æœ€ä½', value: 'Â¥${minVal.toStringAsFixed(0)}'),
      ],
    );
  }

  Widget _buildInsightHint() {
    // æ‰¾å‡ºå³°å€¼æ—¥æœŸ
    final maxPoint = widget.data.reduce((a, b) => a.value > b.value ? a : b);
    return Padding(
      padding: const EdgeInsets.only(top: 12),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: Colors.blue.withOpacity(0.05),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Row(
          children: [
            const Icon(Icons.lightbulb_outline, size: 16, color: Colors.blue),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                'ğŸ’¡ ${maxPoint.fullLabel}æ¶ˆè´¹æœ€é«˜(Â¥${maxPoint.value.toStringAsFixed(0)})ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…',
                style: TextStyle(color: Colors.grey[700], fontSize: 12),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// è¶‹åŠ¿æ•°æ®ç‚¹
class TrendDataPoint {
  final DateTime date;
  final String label;        // ç®€çŸ­æ ‡ç­¾å¦‚ "1æ—¥"
  final String fullLabel;    // å®Œæ•´æ ‡ç­¾å¦‚ "1æœˆ1æ—¥ å‘¨ä¸€"
  final double value;
  final double? changeRate;  // ç¯æ¯”å˜åŒ–ç‡
  final int transactionCount;

  const TrendDataPoint({
    required this.date,
    required this.label,
    required this.fullLabel,
    required this.value,
    this.changeRate,
    this.transactionCount = 0,
  });
}

/// æ—¶é—´ç²’åº¦
enum TimeGranularity { day, week, month, quarter, year }

/// æ‘˜è¦é¡¹ç»„ä»¶
class _SummaryItem extends StatelessWidget {
  final String label;
  final String value;

  const _SummaryItem({required this.label, required this.value});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text(value, style: const TextStyle(fontWeight: FontWeight.bold)),
        Text(label, style: TextStyle(color: Colors.grey[600], fontSize: 11)),
      ],
    );
  }
}
```

#### 12.2.4 æ¶ˆè´¹çƒ­åŠ›å›¾ç»„ä»¶

```dart
/// æ¶ˆè´¹çƒ­åŠ›å›¾ç»„ä»¶ - æŒ‰æ—¶æ®µ/æ˜ŸæœŸå±•ç¤ºæ¶ˆè´¹çƒ­åº¦
class ConsumptionHeatMap extends StatelessWidget {
  final List<List<double>> data;  // 7x4 çŸ©é˜µï¼ˆ7å¤© x 4æ—¶æ®µï¼‰
  final Function(int dayOfWeek, int timeSlot)? onCellTap;

  static const List<String> _dayLabels = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
  static const List<String> _timeLabels = ['0-6æ—¶', '6-12æ—¶', '12-18æ—¶', '18-24æ—¶'];

  const ConsumptionHeatMap({
    required this.data,
    this.onCellTap,
  });

  @override
  Widget build(BuildContext context) {
    final maxValue = data.expand((row) => row).reduce(max);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('ğŸ”¥ æ¶ˆè´¹çƒ­åŠ›å›¾', style: Theme.of(context).textTheme.titleMedium),
        const SizedBox(height: 12),

        // çƒ­åŠ›å›¾è¡¨æ ¼
        Table(
          children: [
            // è¡¨å¤´
            TableRow(
              children: [
                const SizedBox(width: 50, height: 30),
                ..._dayLabels.map((day) => Center(
                  child: Text(day, style: const TextStyle(fontSize: 10)),
                )),
              ],
            ),
            // æ•°æ®è¡Œ
            ...List.generate(4, (timeIndex) {
              return TableRow(
                children: [
                  Container(
                    height: 40,
                    alignment: Alignment.centerRight,
                    padding: const EdgeInsets.only(right: 8),
                    child: Text(_timeLabels[timeIndex],
                      style: const TextStyle(fontSize: 10)),
                  ),
                  ...List.generate(7, (dayIndex) {
                    final value = data[dayIndex][timeIndex];
                    final intensity = maxValue > 0 ? value / maxValue : 0;
                    return _buildCell(context, dayIndex, timeIndex, intensity, value);
                  }),
                ],
              );
            }),
          ],
        ),

        // è‰²é˜¶å›¾ä¾‹
        const SizedBox(height: 12),
        _buildLegend(),

        // æ´å¯Ÿ
        const SizedBox(height: 8),
        _buildInsight(context),
      ],
    );
  }

  Widget _buildCell(BuildContext context, int day, int time, double intensity, double value) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.selectionClick();
        onCellTap?.call(day, time);
      },
      child: Container(
        height: 40,
        margin: const EdgeInsets.all(2),
        decoration: BoxDecoration(
          color: _getHeatColor(intensity),
          borderRadius: BorderRadius.circular(4),
        ),
        child: intensity > 0.3
          ? Center(
              child: Text(
                'Â¥${value.toInt()}',
                style: TextStyle(
                  color: intensity > 0.6 ? Colors.white : Colors.black87,
                  fontSize: 8,
                ),
              ),
            )
          : null,
      ),
    );
  }

  Color _getHeatColor(double intensity) {
    if (intensity <= 0) return Colors.grey[100]!;
    if (intensity < 0.25) return Colors.green[100]!;
    if (intensity < 0.50) return Colors.green[300]!;
    if (intensity < 0.75) return Colors.orange[400]!;
    return Colors.red[500]!;
  }

  Widget _buildLegend() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        const Text('ä½ ', style: TextStyle(fontSize: 10)),
        ...List.generate(5, (i) {
          return Container(
            width: 20,
            height: 10,
            margin: const EdgeInsets.symmetric(horizontal: 1),
            color: _getHeatColor(i * 0.25),
          );
        }),
        const Text(' é«˜', style: TextStyle(fontSize: 10)),
      ],
    );
  }

  Widget _buildInsight(BuildContext context) {
    // æ‰¾å‡ºæœ€çƒ­æ—¶æ®µ
    int maxDay = 0, maxTime = 0;
    double maxVal = 0;
    for (int d = 0; d < 7; d++) {
      for (int t = 0; t < 4; t++) {
        if (data[d][t] > maxVal) {
          maxVal = data[d][t];
          maxDay = d;
          maxTime = t;
        }
      }
    }

    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: Colors.orange.withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Text(
        'ğŸ“Œ ${_dayLabels[maxDay]}${_timeLabels[maxTime]}æ˜¯æ‚¨æ¶ˆè´¹æœ€æ´»è·ƒçš„æ—¶æ®µï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…',
        style: TextStyle(color: Colors.grey[700], fontSize: 12),
      ),
    );
  }
}
```

### 12.3 å¤šç»´åº¦æ•°æ®ä¸‹é’»

#### 12.3.1 ä¸‹é’»ç»´åº¦çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®ä¸‹é’»ç»´åº¦çŸ©é˜µ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚  æ—¶é—´ç»´åº¦   â”‚  å¹´ â†’ å­£åº¦ â†’ æœˆ â†’ å‘¨ â†’ æ—¥ â†’ æ—¶æ®µ â†’ å•ç¬”äº¤æ˜“               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ 2025å¹´ â†’ Q1 â†’ 1æœˆ â†’ ç¬¬1å‘¨ â†’ 1æœˆ5æ—¥ â†’ 12:00-13:00 â†’ åˆé¤      â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚  åˆ†ç±»ç»´åº¦   â”‚  ä¸€çº§åˆ†ç±» â†’ äºŒçº§åˆ†ç±» â†’ å•†å®¶ â†’ å•ç¬”äº¤æ˜“                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ é¤é¥® â†’ å¤–å– â†’ ç¾å›¢å¤–å– â†’ åˆé¤è®¢å• Â¥35                         â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚  è´¦æˆ·ç»´åº¦   â”‚  è´¦æˆ·ç±»å‹ â†’ å…·ä½“è´¦æˆ· â†’ æ”¶æ”¯æ˜ç»† â†’ å•ç¬”äº¤æ˜“                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ å‚¨è“„å¡ â†’ å·¥å•†é“¶è¡Œ â†’ æ”¯å‡ºæ˜ç»† â†’ è½¬è´¦ Â¥1000                     â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚  é’±é¾„ç»´åº¦   â”‚  é’±é¾„ç­‰çº§ â†’ é’±é¾„èŒƒå›´ â†’ å¯¹åº”æ¶ˆè´¹ â†’ å•ç¬”äº¤æ˜“                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ é»„è‰²(14-30å¤©) â†’ 15-20å¤© â†’ æ¶ˆè´¹åˆ—è¡¨ â†’ è´­ç‰© Â¥200                â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚  é¢„ç®—ç»´åº¦   â”‚  é¢„ç®—æ€»è§ˆ â†’ å°é‡‘åº“ â†’ å·²ç”¨æ˜ç»† â†’ å•ç¬”äº¤æ˜“                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â””â”€â”€â†’ æœ¬æœˆé¢„ç®— â†’ é¤é¥®å°é‡‘åº“ â†’ å·²ç”¨Â¥2000 â†’ æ™šé¤ Â¥80                  â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                           2.0æ–°å¢ä¸‹é’»ç»´åº¦                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚ å®¶åº­æˆå‘˜(13)â”‚  å®¶åº­æ€»è§ˆ â†’ æˆå‘˜è§†å›¾ â†’ æˆå‘˜åˆ†ç±» â†’ æˆå‘˜äº¤æ˜“                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ å®¶åº­æ¶ˆè´¹ â†’ å°æ˜ â†’ å°æ˜é¤é¥® â†’ å°æ˜åˆé¤ Â¥35                     â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚ ä½ç½®ç»´åº¦(14)â”‚  å…¨å›½çƒ­åŠ› â†’ åŸå¸‚ â†’ åŒºåŸŸ â†’ å•†åœˆ â†’ å•†å®¶ â†’ å•ç¬”äº¤æ˜“           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ å…¨å›½ â†’ åŒ—äº¬ â†’ æœé˜³åŒº â†’ ä¸‰é‡Œå±¯ â†’ æ˜Ÿå·´å…‹ â†’ å’–å•¡ Â¥38            â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚ ä¹ æƒ¯ç»´åº¦(9) â”‚  ä¹ æƒ¯æ€»è§ˆ â†’ ä¹ æƒ¯ç±»å‹ â†’ æ‰“å¡è®°å½• â†’ å…³è”äº¤æ˜“                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”œâ”€â”€â†’ ä¹ æƒ¯æ¦‚è§ˆ â†’ è®°è´¦ä¹ æƒ¯ â†’ è¿ç»­30å¤© â†’ 1æœˆæ‰“å¡è¯¦æƒ…                   â”‚
â”‚          â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚   â”‚ è¯­éŸ³ç»´åº¦(18)â”‚  è¯­éŸ³å†å² â†’ è¯†åˆ«è®°å½• â†’ è§£æç»“æœ â†’ ç”Ÿæˆäº¤æ˜“                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â””â”€â”€â†’ è¯­éŸ³è®°å½• â†’ "åˆé¤35" â†’ è§£æï¼šé¤é¥®Â¥35 â†’ ç¡®è®¤çš„äº¤æ˜“              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2.0æ–°å¢ç»´åº¦è¯´æ˜**ï¼š

| ç»´åº¦ | æ¥æºç« èŠ‚ | ä¸‹é’»å±‚çº§ | ç‰¹ç‚¹ |
|------|---------|---------|------|
| **å®¶åº­æˆå‘˜** | ç¬¬13ç«  | å®¶åº­â†’æˆå‘˜â†’åˆ†ç±»â†’äº¤æ˜“ | æ”¯æŒæˆå‘˜å¯¹æ¯”è§†å›¾ |
| **ä½ç½®** | ç¬¬14ç«  | å…¨å›½â†’åŸå¸‚â†’åŒºåŸŸâ†’å•†å®¶â†’äº¤æ˜“ | çƒ­åŠ›å›¾å¯è§†åŒ– |
| **ä¹ æƒ¯** | ç¬¬9ç«  | ä¹ æƒ¯ç±»å‹â†’æ‰“å¡è®°å½•â†’å…³è”äº¤æ˜“ | è¿ç»­æ€§è¿½è¸ª |
| **è¯­éŸ³** | ç¬¬18ç«  | è¯­éŸ³è®°å½•â†’è§£æç»“æœâ†’ç”Ÿæˆäº¤æ˜“ | æº¯æºéªŒè¯ |

#### 12.3.2 ä¸‹é’»è·¯å¾„å®šä¹‰

```dart
/// ä¸‹é’»è·¯å¾„é…ç½®
class DrillDownPath {
  /// æ—¶é—´ç»´åº¦ä¸‹é’»è·¯å¾„
  static const timeHierarchy = [
    DrillLevel(name: 'year', displayName: 'å¹´åº¦', paramKey: 'year'),
    DrillLevel(name: 'quarter', displayName: 'å­£åº¦', paramKey: 'quarter'),
    DrillLevel(name: 'month', displayName: 'æœˆä»½', paramKey: 'month'),
    DrillLevel(name: 'week', displayName: 'å‘¨', paramKey: 'week'),
    DrillLevel(name: 'day', displayName: 'æ—¥', paramKey: 'date'),
    DrillLevel(name: 'timeSlot', displayName: 'æ—¶æ®µ', paramKey: 'timeSlot'),
    DrillLevel(name: 'transaction', displayName: 'äº¤æ˜“', paramKey: 'transactionId'),
  ];

  /// åˆ†ç±»ç»´åº¦ä¸‹é’»è·¯å¾„
  static const categoryHierarchy = [
    DrillLevel(name: 'rootCategory', displayName: 'ä¸€çº§åˆ†ç±»', paramKey: 'categoryId'),
    DrillLevel(name: 'subCategory', displayName: 'äºŒçº§åˆ†ç±»', paramKey: 'subCategoryId'),
    DrillLevel(name: 'merchant', displayName: 'å•†å®¶', paramKey: 'merchant'),
    DrillLevel(name: 'transaction', displayName: 'äº¤æ˜“', paramKey: 'transactionId'),
  ];

  /// è´¦æˆ·ç»´åº¦ä¸‹é’»è·¯å¾„
  static const accountHierarchy = [
    DrillLevel(name: 'accountType', displayName: 'è´¦æˆ·ç±»å‹', paramKey: 'accountType'),
    DrillLevel(name: 'account', displayName: 'å…·ä½“è´¦æˆ·', paramKey: 'accountId'),
    DrillLevel(name: 'transactionType', displayName: 'æ”¶æ”¯ç±»å‹', paramKey: 'type'),
    DrillLevel(name: 'transaction', displayName: 'äº¤æ˜“', paramKey: 'transactionId'),
  ];

  /// é’±é¾„ç»´åº¦ä¸‹é’»è·¯å¾„
  static const moneyAgeHierarchy = [
    DrillLevel(name: 'level', displayName: 'é’±é¾„ç­‰çº§', paramKey: 'moneyAgeLevel'),
    DrillLevel(name: 'range', displayName: 'é’±é¾„èŒƒå›´', paramKey: 'moneyAgeRange'),
    DrillLevel(name: 'transaction', displayName: 'äº¤æ˜“', paramKey: 'transactionId'),
  ];

  /// é¢„ç®—ç»´åº¦ä¸‹é’»è·¯å¾„
  static const budgetHierarchy = [
    DrillLevel(name: 'period', displayName: 'é¢„ç®—å‘¨æœŸ', paramKey: 'period'),
    DrillLevel(name: 'vault', displayName: 'å°é‡‘åº“', paramKey: 'vaultId'),
    DrillLevel(name: 'transaction', displayName: 'äº¤æ˜“', paramKey: 'transactionId'),
  ];
}

/// ä¸‹é’»å±‚çº§å®šä¹‰
class DrillLevel {
  final String name;
  final String displayName;
  final String paramKey;

  const DrillLevel({
    required this.name,
    required this.displayName,
    required this.paramKey,
  });
}
```

#### 12.3.3 ä¸‹é’»æœåŠ¡å®ç°

```dart
/// æ•°æ®ä¸‹é’»æœåŠ¡
class DrillDownService {
  final TransactionRepository _transactionRepo;
  final CategoryRepository _categoryRepo;
  final AccountRepository _accountRepo;
  final MoneyAgeService _moneyAgeService;

  /// æ—¶é—´ç»´åº¦ä¸‹é’»
  Future<DrillDownResult> drillDownByTime({
    required String currentLevel,
    required Map<String, dynamic> params,
  }) async {
    switch (currentLevel) {
      case 'year':
        return _getQuarterlyData(params['year'] as int);
      case 'quarter':
        return _getMonthlyData(params['year'] as int, params['quarter'] as int);
      case 'month':
        return _getWeeklyData(params['year'] as int, params['month'] as int);
      case 'week':
        return _getDailyData(params['weekStart'] as DateTime);
      case 'day':
        return _getTimeSlotData(params['date'] as DateTime);
      case 'timeSlot':
        return _getTransactionList(
          dateRange: DateRange(
            start: params['date'] as DateTime,
            end: (params['date'] as DateTime).add(Duration(hours: 6)),
          ),
          timeSlot: params['timeSlot'] as int,
        );
      default:
        throw ArgumentError('Unknown drill level: $currentLevel');
    }
  }

  /// åˆ†ç±»ç»´åº¦ä¸‹é’»
  Future<DrillDownResult> drillDownByCategory({
    required String currentLevel,
    required Map<String, dynamic> params,
    DateRange? dateRange,
  }) async {
    switch (currentLevel) {
      case 'rootCategory':
        return _getSubCategoryData(
          categoryId: params['categoryId'] as String,
          dateRange: dateRange,
        );
      case 'subCategory':
        return _getMerchantData(
          categoryId: params['subCategoryId'] as String,
          dateRange: dateRange,
        );
      case 'merchant':
        return _getTransactionList(
          merchant: params['merchant'] as String,
          dateRange: dateRange,
        );
      default:
        throw ArgumentError('Unknown drill level: $currentLevel');
    }
  }

  /// è·å–å­åˆ†ç±»æ•°æ®
  Future<DrillDownResult> _getSubCategoryData({
    required String categoryId,
    DateRange? dateRange,
  }) async {
    final transactions = await _transactionRepo.getByCategory(
      categoryId: categoryId,
      dateRange: dateRange,
    );

    // æŒ‰å­åˆ†ç±»èšåˆ
    final groupedBySubCategory = <String, List<Transaction>>{};
    for (final tx in transactions) {
      final subCategoryId = tx.subCategoryId ?? 'uncategorized';
      groupedBySubCategory.putIfAbsent(subCategoryId, () => []).add(tx);
    }

    final segments = <PieChartSegment>[];
    for (final entry in groupedBySubCategory.entries) {
      final subCategory = await _categoryRepo.getById(entry.key);
      final total = entry.value.fold(0.0, (sum, tx) => sum + tx.amount);
      segments.add(PieChartSegment(
        id: entry.key,
        label: subCategory?.name ?? 'æœªåˆ†ç±»',
        value: total,
        percentage: 0, // ç¨åè®¡ç®—
        color: subCategory?.color ?? Colors.grey,
      ));
    }

    // è®¡ç®—ç™¾åˆ†æ¯”
    final grandTotal = segments.fold(0.0, (sum, s) => sum + s.value);
    for (int i = 0; i < segments.length; i++) {
      segments[i] = PieChartSegment(
        id: segments[i].id,
        label: segments[i].label,
        value: segments[i].value,
        percentage: grandTotal > 0 ? segments[i].value / grandTotal * 100 : 0,
        color: segments[i].color,
      );
    }

    return DrillDownResult(
      level: 'subCategory',
      title: 'å­åˆ†ç±»æ„æˆ',
      chartType: ChartType.pie,
      segments: segments,
      totalValue: grandTotal,
      transactionCount: transactions.length,
      nextDrillLevel: 'merchant',
    );
  }

  /// è·å–äº¤æ˜“åˆ—è¡¨
  Future<DrillDownResult> _getTransactionList({
    String? categoryId,
    String? accountId,
    String? merchant,
    DateRange? dateRange,
    int? timeSlot,
  }) async {
    final transactions = await _transactionRepo.query(
      categoryId: categoryId,
      accountId: accountId,
      merchant: merchant,
      dateRange: dateRange,
    );

    // å¦‚æœæœ‰æ—¶æ®µç­›é€‰
    final filtered = timeSlot != null
        ? transactions.where((tx) {
            final hour = tx.date.hour;
            return hour >= timeSlot * 6 && hour < (timeSlot + 1) * 6;
          }).toList()
        : transactions;

    return DrillDownResult(
      level: 'transaction',
      title: 'äº¤æ˜“æ˜ç»†',
      chartType: ChartType.list,
      transactions: filtered,
      totalValue: filtered.fold(0.0, (sum, tx) => sum + tx.amount),
      transactionCount: filtered.length,
      nextDrillLevel: null, // å·²åˆ°æœ€åº•å±‚
    );
  }
}

/// ä¸‹é’»ç»“æœ
class DrillDownResult {
  final String level;
  final String title;
  final ChartType chartType;
  final List<PieChartSegment>? segments;
  final List<TrendDataPoint>? trendData;
  final List<Transaction>? transactions;
  final double totalValue;
  final int transactionCount;
  final String? nextDrillLevel;
  final String? insight; // è¯¥å±‚çº§çš„æ´å¯Ÿ

  const DrillDownResult({
    required this.level,
    required this.title,
    required this.chartType,
    this.segments,
    this.trendData,
    this.transactions,
    required this.totalValue,
    required this.transactionCount,
    this.nextDrillLevel,
    this.insight,
  });
}

/// å›¾è¡¨ç±»å‹
enum ChartType { pie, bar, line, heatmap, list }
```

### 12.4 æ•°æ®ç­›é€‰ä¸è¿‡æ»¤ç³»ç»Ÿ

#### 12.4.1 ç­›é€‰æ¡ä»¶æ¨¡å‹

```dart
/// ç»Ÿä¸€ç­›é€‰æ¡ä»¶æ¨¡å‹
class FilterCriteria {
  final DateRange? dateRange;
  final List<String>? categoryIds;
  final List<String>? accountIds;
  final TransactionType? transactionType;
  final MoneyAgeLevel? moneyAgeLevel;
  final String? vaultId;
  final AmountRange? amountRange;
  final String? keyword;
  final List<String>? tags;
  final String? merchant;

  const FilterCriteria({
    this.dateRange,
    this.categoryIds,
    this.accountIds,
    this.transactionType,
    this.moneyAgeLevel,
    this.vaultId,
    this.amountRange,
    this.keyword,
    this.tags,
    this.merchant,
  });

  /// ä»é¡µé¢å‚æ•°åˆ›å»º
  factory FilterCriteria.fromArguments(Map<String, dynamic>? args) {
    if (args == null) return const FilterCriteria();
    return FilterCriteria(
      dateRange: args['dateRange'] as DateRange?,
      categoryIds: args['categoryIds'] as List<String>?,
      accountIds: args['accountIds'] as List<String>?,
      transactionType: args['transactionType'] as TransactionType?,
      moneyAgeLevel: args['moneyAgeLevel'] as MoneyAgeLevel?,
      vaultId: args['vaultId'] as String?,
      amountRange: args['amountRange'] as AmountRange?,
      keyword: args['keyword'] as String?,
      tags: args['tags'] as List<String>?,
      merchant: args['merchant'] as String?,
    );
  }

  /// è½¬ä¸ºè·¯ç”±å‚æ•°
  Map<String, dynamic> toArguments() {
    return {
      if (dateRange != null) 'dateRange': dateRange,
      if (categoryIds != null) 'categoryIds': categoryIds,
      if (accountIds != null) 'accountIds': accountIds,
      if (transactionType != null) 'transactionType': transactionType,
      if (moneyAgeLevel != null) 'moneyAgeLevel': moneyAgeLevel,
      if (vaultId != null) 'vaultId': vaultId,
      if (amountRange != null) 'amountRange': amountRange,
      if (keyword != null) 'keyword': keyword,
      if (tags != null) 'tags': tags,
      if (merchant != null) 'merchant': merchant,
    };
  }

  /// åˆå¹¶æ–°æ¡ä»¶
  FilterCriteria merge(FilterCriteria other) {
    return FilterCriteria(
      dateRange: other.dateRange ?? dateRange,
      categoryIds: other.categoryIds ?? categoryIds,
      accountIds: other.accountIds ?? accountIds,
      transactionType: other.transactionType ?? transactionType,
      moneyAgeLevel: other.moneyAgeLevel ?? moneyAgeLevel,
      vaultId: other.vaultId ?? vaultId,
      amountRange: other.amountRange ?? amountRange,
      keyword: other.keyword ?? keyword,
      tags: other.tags ?? tags,
      merchant: other.merchant ?? merchant,
    );
  }

  /// æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶
  bool get hasFilters =>
      dateRange != null ||
      categoryIds != null ||
      accountIds != null ||
      transactionType != null ||
      moneyAgeLevel != null ||
      vaultId != null ||
      amountRange != null ||
      keyword != null ||
      tags != null ||
      merchant != null;

  /// è·å–ç­›é€‰æ¡ä»¶æ•°é‡ï¼ˆç”¨äºæ˜¾ç¤ºè§’æ ‡ï¼‰
  int get filterCount {
    int count = 0;
    if (dateRange != null) count++;
    if (categoryIds != null && categoryIds!.isNotEmpty) count++;
    if (accountIds != null && accountIds!.isNotEmpty) count++;
    if (transactionType != null) count++;
    if (moneyAgeLevel != null) count++;
    if (vaultId != null) count++;
    if (amountRange != null) count++;
    if (keyword != null && keyword!.isNotEmpty) count++;
    if (tags != null && tags!.isNotEmpty) count++;
    if (merchant != null) count++;
    return count;
  }
}

/// é‡‘é¢èŒƒå›´
class AmountRange {
  final double? min;
  final double? max;

  const AmountRange({this.min, this.max});
}
```

#### 12.4.2 è·¨é¡µé¢çŠ¶æ€ä¿æŒ

```dart
/// å…¨å±€ç­›é€‰çŠ¶æ€ç®¡ç†
final filterCriteriaProvider = StateNotifierProvider<FilterCriteriaNotifier, FilterCriteria>(
  (ref) => FilterCriteriaNotifier(),
);

class FilterCriteriaNotifier extends StateNotifier<FilterCriteria> {
  FilterCriteriaNotifier() : super(const FilterCriteria());

  /// æ›´æ–°ç­›é€‰æ¡ä»¶
  void updateFilter(FilterCriteria criteria) {
    state = state.merge(criteria);
  }

  /// è®¾ç½®æ—¶é—´èŒƒå›´
  void setDateRange(DateRange range) {
    state = FilterCriteria(
      dateRange: range,
      categoryIds: state.categoryIds,
      accountIds: state.accountIds,
      transactionType: state.transactionType,
      moneyAgeLevel: state.moneyAgeLevel,
      vaultId: state.vaultId,
      amountRange: state.amountRange,
      keyword: state.keyword,
      tags: state.tags,
      merchant: state.merchant,
    );
  }

  /// æ·»åŠ åˆ†ç±»ç­›é€‰
  void addCategoryFilter(String categoryId) {
    final current = state.categoryIds ?? [];
    if (!current.contains(categoryId)) {
      state = FilterCriteria(
        dateRange: state.dateRange,
        categoryIds: [...current, categoryId],
        accountIds: state.accountIds,
        transactionType: state.transactionType,
        moneyAgeLevel: state.moneyAgeLevel,
        vaultId: state.vaultId,
        amountRange: state.amountRange,
        keyword: state.keyword,
        tags: state.tags,
        merchant: state.merchant,
      );
    }
  }

  /// ç§»é™¤å•ä¸ªç­›é€‰æ¡ä»¶
  void removeFilter(String filterType) {
    switch (filterType) {
      case 'dateRange':
        state = FilterCriteria(
          categoryIds: state.categoryIds,
          accountIds: state.accountIds,
          transactionType: state.transactionType,
          moneyAgeLevel: state.moneyAgeLevel,
          vaultId: state.vaultId,
          amountRange: state.amountRange,
          keyword: state.keyword,
          tags: state.tags,
          merchant: state.merchant,
        );
        break;
      // ... å…¶ä»–ç­›é€‰ç±»å‹
    }
  }

  /// æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶
  void clearAll() {
    state = const FilterCriteria();
  }
}
```

### 12.5 è”åŠ¨å¯¼èˆªä¸çŠ¶æ€ç®¡ç†

#### 12.5.1 ä¸‹é’»æ ˆç®¡ç†

```dart
/// ä¸‹é’»å¯¼èˆªæ ˆ
final drillDownStackProvider = StateNotifierProvider<DrillDownStackNotifier, List<DrillDownLevel>>(
  (ref) => DrillDownStackNotifier(),
);

class DrillDownStackNotifier extends StateNotifier<List<DrillDownLevel>> {
  DrillDownStackNotifier() : super([]);

  /// è¿›å…¥ä¸‹ä¸€å±‚
  void push(DrillDownLevel level) {
    state = [...state, level];
    _saveToStorage();
  }

  /// è¿”å›ä¸Šä¸€å±‚
  DrillDownLevel? pop() {
    if (state.isEmpty) return null;
    final popped = state.last;
    state = state.sublist(0, state.length - 1);
    _saveToStorage();
    return popped;
  }

  /// è¿”å›åˆ°æŒ‡å®šå±‚çº§
  void popTo(int index) {
    if (index >= 0 && index < state.length) {
      state = state.sublist(0, index + 1);
      _saveToStorage();
    }
  }

  /// è¿”å›åˆ°é¦–é¡µ
  void popToRoot() {
    state = [];
    _saveToStorage();
  }

  /// æ›¿æ¢å½“å‰å±‚çº§
  void replaceCurrent(DrillDownLevel level) {
    if (state.isEmpty) {
      state = [level];
    } else {
      state = [...state.sublist(0, state.length - 1), level];
    }
    _saveToStorage();
  }

  /// è·å–å½“å‰å±‚çº§
  DrillDownLevel? get current => state.isEmpty ? null : state.last;

  /// è·å–çˆ¶å±‚çº§
  DrillDownLevel? get parent => state.length < 2 ? null : state[state.length - 2];

  /// è·å–å±‚çº§æ·±åº¦
  int get depth => state.length;

  /// æŒä¹…åŒ–åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç”¨äºæ¢å¤ï¼‰
  Future<void> _saveToStorage() async {
    // å®ç°æœ¬åœ°å­˜å‚¨é€»è¾‘
  }

  /// ä»æœ¬åœ°å­˜å‚¨æ¢å¤
  Future<void> restoreFromStorage() async {
    // å®ç°æ¢å¤é€»è¾‘
  }
}

/// ä¸‹é’»å±‚çº§ä¿¡æ¯ï¼ˆå¢å¼ºç‰ˆï¼‰
class DrillDownLevel {
  final String id;
  final String title;
  final String route;
  final String dimension;          // ä¸‹é’»ç»´åº¦ï¼štime/category/account/moneyAge/budget
  final int hierarchyLevel;        // åœ¨è¯¥ç»´åº¦çš„å±‚çº§æ·±åº¦
  final Map<String, dynamic> params;
  final FilterCriteria? inheritedFilters;  // ç»§æ‰¿çš„ç­›é€‰æ¡ä»¶
  final DateTime timestamp;

  DrillDownLevel({
    String? id,
    required this.title,
    required this.route,
    required this.dimension,
    required this.hierarchyLevel,
    this.params = const {},
    this.inheritedFilters,
    DateTime? timestamp,
  }) : id = id ?? _generateId(),
       timestamp = timestamp ?? DateTime.now();

  static String _generateId() => DateTime.now().millisecondsSinceEpoch.toString();

  /// è½¬ä¸ºè·¯ç”±å‚æ•°
  Map<String, dynamic> toRouteArguments() {
    return {
      ...params,
      '_drillLevel': id,
      '_dimension': dimension,
      '_hierarchyLevel': hierarchyLevel,
      if (inheritedFilters != null) ...inheritedFilters!.toArguments(),
    };
  }
}
```

#### 12.5.2 é¢åŒ…å±‘å¯¼èˆªç»„ä»¶

```dart
/// å¢å¼ºç‰ˆé¢åŒ…å±‘å¯¼èˆª
class EnhancedBreadcrumb extends ConsumerWidget {
  final bool showHome;
  final VoidCallback? onHomePressed;

  const EnhancedBreadcrumb({
    this.showHome = true,
    this.onHomePressed,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final stack = ref.watch(drillDownStackProvider);
    final filters = ref.watch(filterCriteriaProvider);

    if (stack.isEmpty && !filters.hasFilters) return const SizedBox.shrink();

    return Container(
      height: 48,
      padding: const EdgeInsets.symmetric(horizontal: 8),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surfaceVariant.withOpacity(0.5),
        border: Border(
          bottom: BorderSide(
            color: Theme.of(context).dividerColor.withOpacity(0.2),
          ),
        ),
      ),
      child: Row(
        children: [
          // é¦–é¡µæŒ‰é’®
          if (showHome)
            IconButton(
              icon: const Icon(Icons.home, size: 20),
              onPressed: () {
                ref.read(drillDownStackProvider.notifier).popToRoot();
                ref.read(filterCriteriaProvider.notifier).clearAll();
                onHomePressed?.call();
              },
              tooltip: 'è¿”å›é¦–é¡µ',
            ),

          // é¢åŒ…å±‘è·¯å¾„
          Expanded(
            child: ListView.separated(
              scrollDirection: Axis.horizontal,
              itemCount: stack.length,
              separatorBuilder: (_, __) => const Icon(
                Icons.chevron_right,
                size: 16,
                color: Colors.grey,
              ),
              itemBuilder: (context, index) {
                final level = stack[index];
                final isLast = index == stack.length - 1;

                return _buildBreadcrumbItem(
                  context,
                  ref,
                  level,
                  index,
                  isLast,
                );
              },
            ),
          ),

          // ç­›é€‰æ¡ä»¶æŒ‡ç¤ºå™¨
          if (filters.hasFilters)
            _buildFilterIndicator(context, ref, filters),

          // æ¸…é™¤æŒ‰é’®
          if (stack.isNotEmpty || filters.hasFilters)
            IconButton(
              icon: const Icon(Icons.close, size: 18),
              onPressed: () {
                ref.read(drillDownStackProvider.notifier).popToRoot();
                ref.read(filterCriteriaProvider.notifier).clearAll();
                Navigator.of(context).popUntil((route) => route.isFirst);
              },
              tooltip: 'æ¸…é™¤æ‰€æœ‰å¹¶è¿”å›',
            ),
        ],
      ),
    );
  }

  Widget _buildBreadcrumbItem(
    BuildContext context,
    WidgetRef ref,
    DrillDownLevel level,
    int index,
    bool isLast,
  ) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: isLast ? null : () => _navigateToLevel(context, ref, index),
        borderRadius: BorderRadius.circular(4),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              // ç»´åº¦å›¾æ ‡
              Icon(
                _getDimensionIcon(level.dimension),
                size: 14,
                color: isLast ? Colors.grey : Theme.of(context).primaryColor,
              ),
              const SizedBox(width: 4),
              // å±‚çº§åç§°
              Text(
                level.title,
                style: TextStyle(
                  color: isLast ? Colors.grey[700] : Theme.of(context).primaryColor,
                  fontWeight: isLast ? FontWeight.bold : FontWeight.normal,
                  fontSize: 13,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFilterIndicator(
    BuildContext context,
    WidgetRef ref,
    FilterCriteria filters,
  ) {
    return GestureDetector(
      onTap: () => _showFilterSheet(context, ref, filters),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
        margin: const EdgeInsets.only(right: 4),
        decoration: BoxDecoration(
          color: Theme.of(context).primaryColor.withOpacity(0.1),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.filter_list, size: 14, color: Theme.of(context).primaryColor),
            const SizedBox(width: 4),
            Text(
              '${filters.filterCount}',
              style: TextStyle(
                color: Theme.of(context).primaryColor,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _navigateToLevel(BuildContext context, WidgetRef ref, int index) {
    ref.read(drillDownStackProvider.notifier).popTo(index);
    Navigator.of(context).popUntil((route) {
      final level = ref.read(drillDownStackProvider)[index];
      return route.settings.name == level.route;
    });
  }

  void _showFilterSheet(BuildContext context, WidgetRef ref, FilterCriteria filters) {
    showModalBottomSheet(
      context: context,
      builder: (context) => FilterSummarySheet(filters: filters),
    );
  }

  IconData _getDimensionIcon(String dimension) {
    switch (dimension) {
      case 'time': return Icons.calendar_today;
      case 'category': return Icons.category;
      case 'account': return Icons.account_balance_wallet;
      case 'moneyAge': return Icons.timelapse;
      case 'budget': return Icons.savings;
      default: return Icons.data_usage;
    }
  }
}
```

### 12.6 å®æ—¶æ•°æ®è”åŠ¨

#### 12.6.1 æ•°æ®å˜æ›´ç›‘å¬

```dart
/// æ•°æ®å˜æ›´äº‹ä»¶
abstract class DataChangeEvent {
  final DateTime timestamp;
  final String source;

  const DataChangeEvent({required this.timestamp, required this.source});
}

class TransactionCreatedEvent extends DataChangeEvent {
  final Transaction transaction;
  TransactionCreatedEvent(this.transaction)
      : super(timestamp: DateTime.now(), source: 'transaction');
}

class TransactionUpdatedEvent extends DataChangeEvent {
  final Transaction oldTransaction;
  final Transaction newTransaction;
  TransactionUpdatedEvent(this.oldTransaction, this.newTransaction)
      : super(timestamp: DateTime.now(), source: 'transaction');
}

class TransactionDeletedEvent extends DataChangeEvent {
  final String transactionId;
  TransactionDeletedEvent(this.transactionId)
      : super(timestamp: DateTime.now(), source: 'transaction');
}

/// æ•°æ®å˜æ›´ç›‘å¬æœåŠ¡
class DataChangeNotifier extends ChangeNotifier {
  final List<DataChangeEvent> _pendingEvents = [];
  Timer? _debounceTimer;

  /// è§¦å‘å˜æ›´äº‹ä»¶
  void notify(DataChangeEvent event) {
    _pendingEvents.add(event);

    // é˜²æŠ–ï¼šåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šä¸ªäº‹ä»¶
    _debounceTimer?.cancel();
    _debounceTimer = Timer(const Duration(milliseconds: 300), () {
      _processPendingEvents();
    });
  }

  /// å¤„ç†å¾…å¤„ç†äº‹ä»¶
  void _processPendingEvents() {
    if (_pendingEvents.isEmpty) return;

    // åˆ†æéœ€è¦åˆ·æ–°çš„ç»„ä»¶
    final affectedComponents = _analyzeAffectedComponents(_pendingEvents);

    // å‘é€åˆ·æ–°é€šçŸ¥
    for (final component in affectedComponents) {
      _notifyComponent(component);
    }

    _pendingEvents.clear();
    notifyListeners();
  }

  Set<String> _analyzeAffectedComponents(List<DataChangeEvent> events) {
    final affected = <String>{};

    for (final event in events) {
      if (event is TransactionCreatedEvent ||
          event is TransactionUpdatedEvent ||
          event is TransactionDeletedEvent) {
        // äº¤æ˜“å˜æ›´å½±å“ï¼šä»ªè¡¨ç›˜ã€è¶‹åŠ¿å›¾ã€åˆ†ç±»ç»Ÿè®¡ã€é’±é¾„ã€é¢„ç®—
        affected.addAll([
          'dashboard',
          'trend_chart',
          'category_stats',
          'money_age',
          'budget_progress',
          'transaction_list',
        ]);
      }
    }

    return affected;
  }

  void _notifyComponent(String componentId) {
    // è§¦å‘ç‰¹å®šç»„ä»¶åˆ·æ–°
  }
}
```

#### 12.6.2 å¢é‡åˆ·æ–°ç­–ç•¥

```dart
/// å¢é‡åˆ·æ–°ç®¡ç†å™¨
class IncrementalRefreshManager {
  final Map<String, DateTime> _lastRefreshTime = {};
  final Map<String, dynamic> _cachedData = {};

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
  bool needsRefresh(String key, {Duration threshold = const Duration(minutes: 5)}) {
    final lastRefresh = _lastRefreshTime[key];
    if (lastRefresh == null) return true;
    return DateTime.now().difference(lastRefresh) > threshold;
  }

  /// è·å–ç¼“å­˜æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰
  T? getCached<T>(String key) {
    return _cachedData[key] as T?;
  }

  /// æ›´æ–°ç¼“å­˜
  void updateCache<T>(String key, T data) {
    _cachedData[key] = data;
    _lastRefreshTime[key] = DateTime.now();
  }

  /// ä½¿ç¼“å­˜å¤±æ•ˆ
  void invalidate(String key) {
    _cachedData.remove(key);
    _lastRefreshTime.remove(key);
  }

  /// ä½¿ç›¸å…³ç¼“å­˜å…¨éƒ¨å¤±æ•ˆ
  void invalidatePattern(String pattern) {
    final keysToRemove = _cachedData.keys.where((k) => k.contains(pattern)).toList();
    for (final key in keysToRemove) {
      invalidate(key);
    }
  }
}

/// Providerï¼šå¸¦ç¼“å­˜çš„æ•°æ®è·å–
final categoryStatsProvider = FutureProvider.family<CategoryStats, FilterCriteria>((ref, filters) async {
  final refreshManager = ref.watch(incrementalRefreshManagerProvider);
  final cacheKey = 'category_stats_${filters.hashCode}';

  // æ£€æŸ¥ç¼“å­˜
  final cached = refreshManager.getCached<CategoryStats>(cacheKey);
  if (cached != null && !refreshManager.needsRefresh(cacheKey)) {
    return cached;
  }

  // è·å–æ–°æ•°æ®
  final statsService = ref.watch(statsServiceProvider);
  final stats = await statsService.getCategoryStats(filters);

  // æ›´æ–°ç¼“å­˜
  refreshManager.updateCache(cacheKey, stats);

  return stats;
});
```

### 12.7 å¯è§†åŒ–äº¤äº’è®¾è®¡

#### 12.7.1 æ‰‹åŠ¿äº¤äº’è§„èŒƒ

| æ‰‹åŠ¿ | é€‚ç”¨ç»„ä»¶ | è¡Œä¸º | åé¦ˆ |
|------|----------|------|------|
| å•å‡» | æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´  | è¿›å…¥ä¸‹ä¸€å±‚/æŸ¥çœ‹è¯¦æƒ… | æ¶Ÿæ¼ªæ•ˆæœ + è½»å¾®è§¦è§‰åé¦ˆ |
| é•¿æŒ‰ | å›¾è¡¨æ•°æ®ç‚¹/åˆ—è¡¨é¡¹ | æ˜¾ç¤ºæ“ä½œèœå•/å¿«æ·æ“ä½œ | æ”¾å¤§ + ä¸­ç­‰è§¦è§‰åé¦ˆ |
| åŒå‡» | å›¾è¡¨åŒºåŸŸ | é‡ç½®ç¼©æ”¾/å›åˆ°é»˜è®¤è§†å›¾ | ç¼©æ”¾åŠ¨ç”» |
| æåˆ | è¶‹åŠ¿å›¾/çƒ­åŠ›å›¾ | ç¼©æ”¾æ—¶é—´èŒƒå›´ | å¹³æ»‘ç¼©æ”¾åŠ¨ç”» |
| æ‹–åŠ¨ | è¶‹åŠ¿å›¾ | å¹³ç§»æŸ¥çœ‹æ›´å¤šæ•°æ® | æƒ¯æ€§æ»šåŠ¨ |
| å³æ»‘ | é¡µé¢/åˆ—è¡¨é¡¹ | è¿”å›ä¸Šä¸€å±‚/åˆ é™¤ | æ»‘åŠ¨è·ŸéšåŠ¨ç”» |

**2.0æ–°å¢äº¤äº’æ–¹å¼**ï¼š

| äº¤äº’æ–¹å¼ | é€‚ç”¨åœºæ™¯ | è¡Œä¸º | æ¥æºç« èŠ‚ |
|---------|---------|------|---------|
| è¯­éŸ³æŸ¥è¯¢ | ä»»æ„å›¾è¡¨é¡µé¢ | "æŸ¥çœ‹é¤é¥®æ”¯å‡º" â†’ è·³è½¬é¤é¥®åˆ†ç±»è¯¦æƒ… | ç¬¬18ç«  |
| è¯­éŸ³ä¸‹é’» | ä»»æ„å›¾è¡¨é¡µé¢ | "çœ‹çœ‹ä¸Šä¸ªæœˆ" â†’ æ—¶é—´èŒƒå›´åˆ‡æ¢åˆ°ä¸Šæœˆ | ç¬¬18ç«  |
| è¯­éŸ³è¿”å› | ä»»æ„ä¸‹é’»é¡µé¢ | "è¿”å›é¦–é¡µ" â†’ æ¸…ç©ºä¸‹é’»æ ˆå›åˆ°é¦–é¡µ | ç¬¬18ç«  |
| å±å¹•é˜…è¯» | æ‰€æœ‰å›¾è¡¨ | å›¾è¡¨æ•°æ®è‡ªåŠ¨æœ—è¯»æè¿° | ç¬¬5ç«  |
| ç„¦ç‚¹å¯¼èˆª | æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´  | Tabé”®é¡ºåºå¯¼èˆªï¼ŒEnterç¡®è®¤ | ç¬¬5ç«  |
| æ”¾å¤§æ‰‹åŠ¿ | æ‰€æœ‰å›¾è¡¨ | ä¸‰æŒ‡åŒå‡»æ”¾å¤§å›¾è¡¨åŒºåŸŸ | ç¬¬5ç«  |

**è¯­éŸ³ä¸‹é’»æŒ‡ä»¤ç¤ºä¾‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è¯­éŸ³ä¸‹é’»æŒ‡ä»¤æ”¯æŒï¼ˆç¬¬18ç« é›†æˆï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  "æŸ¥çœ‹é¤é¥®æ”¯å‡º"      â†’  åˆ†ç±»ç»´åº¦ä¸‹é’»åˆ°é¤é¥®                                    â”‚
â”‚  "çœ‹çœ‹1æœˆä»½"         â†’  æ—¶é—´ç»´åº¦åˆ‡æ¢åˆ°1æœˆ                                     â”‚
â”‚  "å°æ˜èŠ±äº†å¤šå°‘"      â†’  å®¶åº­ç»´åº¦ä¸‹é’»åˆ°æˆå‘˜å°æ˜                                 â”‚
â”‚  "ä¸‰é‡Œå±¯æ¶ˆè´¹æƒ…å†µ"    â†’  ä½ç½®ç»´åº¦ä¸‹é’»åˆ°ä¸‰é‡Œå±¯å•†åœˆ                               â”‚
â”‚  "é¢„ç®—è¿˜å‰©å¤šå°‘"      â†’  é¢„ç®—ç»´åº¦å±•ç¤ºå½“å‰é¢„ç®—ä½™é¢                               â”‚
â”‚  "æœ€è¿‘çš„å¤§é¢æ”¯å‡º"    â†’  æ—¶é—´+é‡‘é¢å¤åˆç­›é€‰                                      â”‚
â”‚  "è¿”å›ä¸Šä¸€é¡µ"        â†’  ä¸‹é’»æ ˆpopä¸€å±‚                                         â”‚
â”‚  "å›åˆ°é¦–é¡µ"          â†’  æ¸…ç©ºä¸‹é’»æ ˆ                                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.7.2 åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

```dart
/// ä¸‹é’»è¿‡æ¸¡åŠ¨ç”»
class DrillDownTransition extends StatelessWidget {
  final Animation<double> animation;
  final Widget child;
  final TransitionType type;

  const DrillDownTransition({
    required this.animation,
    required this.child,
    this.type = TransitionType.zoomIn,
  });

  @override
  Widget build(BuildContext context) {
    switch (type) {
      case TransitionType.zoomIn:
        return ScaleTransition(
          scale: Tween<double>(begin: 0.8, end: 1.0).animate(
            CurvedAnimation(parent: animation, curve: Curves.easeOutCubic),
          ),
          child: FadeTransition(
            opacity: animation,
            child: child,
          ),
        );
      case TransitionType.slideUp:
        return SlideTransition(
          position: Tween<Offset>(
            begin: const Offset(0, 0.3),
            end: Offset.zero,
          ).animate(CurvedAnimation(parent: animation, curve: Curves.easeOutCubic)),
          child: FadeTransition(
            opacity: animation,
            child: child,
          ),
        );
      case TransitionType.slideRight:
        return SlideTransition(
          position: Tween<Offset>(
            begin: const Offset(1, 0),
            end: Offset.zero,
          ).animate(CurvedAnimation(parent: animation, curve: Curves.easeOutCubic)),
          child: child,
        );
      case TransitionType.fade:
        return FadeTransition(opacity: animation, child: child);
    }
  }
}

/// éª¨æ¶å±åŠ è½½å ä½
class ChartSkeleton extends StatelessWidget {
  final ChartType chartType;

  const ChartSkeleton({required this.chartType});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey[300]!,
      highlightColor: Colors.grey[100]!,
      child: _buildSkeleton(),
    );
  }

  Widget _buildSkeleton() {
    switch (chartType) {
      case ChartType.pie:
        return AspectRatio(
          aspectRatio: 1,
          child: Container(
            decoration: const BoxDecoration(
              color: Colors.white,
              shape: BoxShape.circle,
            ),
          ),
        );
      case ChartType.bar:
        return Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: List.generate(6, (i) => Container(
            width: 30,
            height: 50 + (i * 20).toDouble(),
            color: Colors.white,
          )),
        );
      case ChartType.line:
        return Container(height: 200, color: Colors.white);
      default:
        return Container(height: 200, color: Colors.white);
    }
  }
}
```

### 12.8 æ•°æ®å¯¼å‡ºä¸åˆ†äº«

#### 12.8.1 å›¾è¡¨æˆªå›¾ä¸åˆ†äº«

```dart
/// å›¾è¡¨å¯¼å‡ºæœåŠ¡
class ChartExportService {
  /// æˆªå–å›¾è¡¨ä¸ºå›¾ç‰‡
  Future<Uint8List?> captureChart(GlobalKey chartKey) async {
    try {
      final boundary = chartKey.currentContext?.findRenderObject() as RenderRepaintBoundary?;
      if (boundary == null) return null;

      final image = await boundary.toImage(pixelRatio: 3.0);
      final byteData = await image.toByteData(format: ImageByteFormat.png);
      return byteData?.buffer.asUint8List();
    } catch (e) {
      debugPrint('Chart capture failed: $e');
      return null;
    }
  }

  /// åˆ†äº«å›¾è¡¨
  Future<void> shareChart(GlobalKey chartKey, String title) async {
    final imageBytes = await captureChart(chartKey);
    if (imageBytes == null) return;

    final tempDir = await getTemporaryDirectory();
    final file = File('${tempDir.path}/chart_$title.png');
    await file.writeAsBytes(imageBytes);

    await Share.shareXFiles(
      [XFile(file.path)],
      text: 'æˆ‘çš„è´¢åŠ¡åˆ†æ - $title',
    );
  }

  /// ç”Ÿæˆå¯åˆ†äº«çš„æŠ¥å‘Š
  Future<File> generateReport({
    required String title,
    required List<GlobalKey> chartKeys,
    required Map<String, dynamic> summaryData,
  }) async {
    final pdf = pw.Document();

    // æ·»åŠ æ ‡é¢˜é¡µ
    pdf.addPage(pw.Page(
      build: (context) => pw.Center(
        child: pw.Column(
          mainAxisAlignment: pw.MainAxisAlignment.center,
          children: [
            pw.Text(title, style: pw.TextStyle(fontSize: 24, fontWeight: pw.FontWeight.bold)),
            pw.SizedBox(height: 20),
            pw.Text('ç”Ÿæˆæ—¥æœŸ: ${DateTime.now().toString().substring(0, 10)}'),
          ],
        ),
      ),
    ));

    // æ·»åŠ å›¾è¡¨é¡µ
    for (final key in chartKeys) {
      final imageBytes = await captureChart(key);
      if (imageBytes != null) {
        pdf.addPage(pw.Page(
          build: (context) => pw.Center(
            child: pw.Image(pw.MemoryImage(imageBytes)),
          ),
        ));
      }
    }

    // æ·»åŠ æ‘˜è¦æ•°æ®é¡µ
    pdf.addPage(pw.Page(
      build: (context) => pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Text('è´¢åŠ¡æ‘˜è¦', style: pw.TextStyle(fontSize: 18, fontWeight: pw.FontWeight.bold)),
          pw.SizedBox(height: 20),
          ...summaryData.entries.map((e) => pw.Row(
            mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
            children: [
              pw.Text(e.key),
              pw.Text(e.value.toString()),
            ],
          )),
        ],
      ),
    ));

    final outputDir = await getTemporaryDirectory();
    final file = File('${outputDir.path}/financial_report.pdf');
    await file.writeAsBytes(await pdf.save());

    return file;
  }
}
```

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šå¢é•¿å¯¼å‘çš„åˆ†äº«ç´ æè®¾è®¡è¯¦è§[ç¬¬29.1èŠ‚ äº§å“å†…ç½®å¢é•¿å¼•æ“](#291-äº§å“å†…ç½®å¢é•¿å¼•æ“)

### 12.9 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 12.9.1 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// æ•°æ®è”åŠ¨ - é’±é¾„ç³»ç»Ÿé›†æˆ
class MoneyAgeLinkageIntegration {
  /// ä»é’±é¾„å¡ç‰‡ä¸‹é’»
  static DrillDownLevel fromMoneyAgeCard(MoneyAge moneyAge) {
    return DrillDownLevel(
      title: 'é’±é¾„è¯¦æƒ…',
      route: '/money-age/detail',
      dimension: 'moneyAge',
      hierarchyLevel: 0,
      params: {
        'currentAge': moneyAge.days,
        'level': moneyAge.level.name,
      },
    );
  }

  /// ä»é’±é¾„ç­‰çº§ä¸‹é’»åˆ°å¯¹åº”æ¶ˆè´¹
  static DrillDownLevel fromMoneyAgeLevel(MoneyAgeLevel level) {
    return DrillDownLevel(
      title: level.displayName,
      route: '/transactions',
      dimension: 'moneyAge',
      hierarchyLevel: 1,
      inheritedFilters: FilterCriteria(moneyAgeLevel: level),
    );
  }

  /// é’±é¾„è¶‹åŠ¿å›¾ç‚¹å‡»ä¸‹é’»
  static DrillDownLevel fromTrendPoint(DateTime date, int moneyAge) {
    return DrillDownLevel(
      title: '${date.month}æœˆ${date.day}æ—¥æ¶ˆè´¹',
      route: '/transactions',
      dimension: 'moneyAge',
      hierarchyLevel: 2,
      inheritedFilters: FilterCriteria(
        dateRange: DateRange(
          start: date,
          end: date.add(const Duration(days: 1)),
        ),
      ),
    );
  }
}
```

#### 12.9.2 ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// æ•°æ®è”åŠ¨ - é¢„ç®—ç³»ç»Ÿé›†æˆ
class BudgetLinkageIntegration {
  /// ä»é¢„ç®—æ¦‚è§ˆå¡ç‰‡ä¸‹é’»
  static DrillDownLevel fromBudgetOverview(BudgetPeriod period) {
    return DrillDownLevel(
      title: 'é¢„ç®—æ‰§è¡Œ',
      route: '/budget/execution',
      dimension: 'budget',
      hierarchyLevel: 0,
      params: {'period': period.toIso8601String()},
    );
  }

  /// ä»å°é‡‘åº“ä¸‹é’»åˆ°å·²ç”¨æ˜ç»†
  static DrillDownLevel fromVaultDetail(BudgetVault vault) {
    return DrillDownLevel(
      title: vault.name,
      route: '/transactions',
      dimension: 'budget',
      hierarchyLevel: 1,
      inheritedFilters: FilterCriteria(vaultId: vault.id),
    );
  }

  /// é¢„ç®—è¿›åº¦æ¡ç‚¹å‡»ä¸‹é’»
  static DrillDownLevel fromProgressBar(String categoryId, DateRange period) {
    return DrillDownLevel(
      title: 'æ¶ˆè´¹æ˜ç»†',
      route: '/transactions',
      dimension: 'budget',
      hierarchyLevel: 2,
      inheritedFilters: FilterCriteria(
        categoryIds: [categoryId],
        dateRange: period,
      ),
    );
  }
}
```

#### 12.9.3 ä¸AIæ´å¯Ÿç³»ç»Ÿé›†æˆ

```dart
/// æ•°æ®è”åŠ¨ - AIæ´å¯Ÿç³»ç»Ÿé›†æˆ
class InsightLinkageIntegration {
  /// ä»æ´å¯Ÿå¡ç‰‡ä¸‹é’»åˆ°ç›¸å…³æ•°æ®
  static DrillDownLevel fromInsightCard(FinancialInsight insight) {
    switch (insight.type) {
      case InsightType.unusedSubscription:
        return DrillDownLevel(
          title: 'è®¢é˜…æ”¯å‡º',
          route: '/category/subscriptions',
          dimension: 'category',
          hierarchyLevel: 1,
          params: {'merchant': insight.relatedMerchant},
        );

      case InsightType.categoryOverspend:
        return DrillDownLevel(
          title: insight.categoryName ?? 'åˆ†ç±»è¯¦æƒ…',
          route: '/category/${insight.categoryId}',
          dimension: 'category',
          hierarchyLevel: 1,
          inheritedFilters: FilterCriteria(
            categoryIds: [insight.categoryId!],
            dateRange: insight.dateRange,
          ),
        );

      case InsightType.spendingAnomaly:
        return DrillDownLevel(
          title: 'å¼‚å¸¸æ¶ˆè´¹',
          route: '/transactions',
          dimension: 'time',
          hierarchyLevel: 2,
          inheritedFilters: FilterCriteria(
            dateRange: insight.dateRange,
            amountRange: AmountRange(min: insight.thresholdAmount),
          ),
        );

      default:
        return DrillDownLevel(
          title: 'ç›¸å…³æ•°æ®',
          route: '/transactions',
          dimension: 'time',
          hierarchyLevel: 0,
        );
    }
  }
}
```

#### 12.9.4 ä¸å®¶åº­è´¦æœ¬ç³»ç»Ÿé›†æˆï¼ˆç¬¬13ç« ï¼‰

```dart
/// æ•°æ®è”åŠ¨ - å®¶åº­è´¦æœ¬ç³»ç»Ÿé›†æˆ
class FamilyLinkageIntegration {
  /// ä»å®¶åº­æ¦‚è§ˆå¡ç‰‡ä¸‹é’»
  static DrillDownLevel fromFamilyOverview(Family family) {
    return DrillDownLevel(
      title: '${family.name}æ¶ˆè´¹',
      route: '/family/overview',
      dimension: 'family',
      hierarchyLevel: 0,
      params: {'familyId': family.id},
    );
  }

  /// ä»å®¶åº­æˆå‘˜å¡ç‰‡ä¸‹é’»
  static DrillDownLevel fromMemberCard(FamilyMember member) {
    return DrillDownLevel(
      title: '${member.nickname}çš„æ¶ˆè´¹',
      route: '/family/member/${member.id}',
      dimension: 'family',
      hierarchyLevel: 1,
      inheritedFilters: FilterCriteria(memberId: member.id),
    );
  }

  /// æˆå‘˜æ¶ˆè´¹å¯¹æ¯”å›¾ç‚¹å‡»ä¸‹é’»
  static DrillDownLevel fromMemberComparison(String memberId, String categoryId) {
    return DrillDownLevel(
      title: 'æ¶ˆè´¹æ˜ç»†',
      route: '/transactions',
      dimension: 'family',
      hierarchyLevel: 2,
      inheritedFilters: FilterCriteria(
        memberId: memberId,
        categoryIds: [categoryId],
      ),
    );
  }
}
```

#### 12.9.5 ä¸ä½ç½®æ™ºèƒ½ç³»ç»Ÿé›†æˆï¼ˆç¬¬14ç« ï¼‰

```dart
/// æ•°æ®è”åŠ¨ - ä½ç½®æ™ºèƒ½ç³»ç»Ÿé›†æˆ
class LocationLinkageIntegration {
  /// ä»æ¶ˆè´¹çƒ­åŠ›å›¾ä¸‹é’»
  static DrillDownLevel fromHeatmapRegion(GeoRegion region) {
    return DrillDownLevel(
      title: region.name,
      route: '/location/region',
      dimension: 'location',
      hierarchyLevel: 1,
      params: {
        'latitude': region.center.latitude,
        'longitude': region.center.longitude,
        'radius': region.radius,
      },
    );
  }

  /// ä»å•†åœˆæ¶ˆè´¹æ’è¡Œä¸‹é’»
  static DrillDownLevel fromBusinessDistrict(String districtName) {
    return DrillDownLevel(
      title: '$districtNameæ¶ˆè´¹',
      route: '/location/district',
      dimension: 'location',
      hierarchyLevel: 2,
      inheritedFilters: FilterCriteria(locationName: districtName),
    );
  }

  /// ä»ä½ç½®æ ‡è®°ä¸‹é’»åˆ°è¯¥åœ°ç‚¹æ¶ˆè´¹
  static DrillDownLevel fromLocationMarker(LatLng location, String merchantName) {
    return DrillDownLevel(
      title: merchantName,
      route: '/transactions',
      dimension: 'location',
      hierarchyLevel: 3,
      inheritedFilters: FilterCriteria(
        merchantName: merchantName,
        nearLocation: location,
      ),
    );
  }
}
```

#### 12.9.6 ä¸è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆï¼ˆç¬¬18ç« ï¼‰

```dart
/// æ•°æ®è”åŠ¨ - è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆ
class VoiceLinkageIntegration {
  /// è¯­éŸ³æ„å›¾è§£æä¸ºä¸‹é’»åŠ¨ä½œ
  static DrillDownLevel? fromVoiceIntent(VoiceIntent intent) {
    switch (intent.type) {
      case VoiceIntentType.queryCategorySpending:
        return DrillDownLevel(
          title: intent.categoryName ?? 'åˆ†ç±»æ¶ˆè´¹',
          route: '/category/${intent.categoryId}',
          dimension: 'category',
          hierarchyLevel: 1,
          inheritedFilters: FilterCriteria(
            categoryIds: intent.categoryId != null ? [intent.categoryId!] : null,
            dateRange: intent.dateRange,
          ),
        );

      case VoiceIntentType.queryMemberSpending:
        return DrillDownLevel(
          title: '${intent.memberName}çš„æ¶ˆè´¹',
          route: '/family/member/${intent.memberId}',
          dimension: 'family',
          hierarchyLevel: 1,
          inheritedFilters: FilterCriteria(memberId: intent.memberId),
        );

      case VoiceIntentType.queryLocationSpending:
        return DrillDownLevel(
          title: '${intent.locationName}æ¶ˆè´¹',
          route: '/location/district',
          dimension: 'location',
          hierarchyLevel: 2,
          inheritedFilters: FilterCriteria(locationName: intent.locationName),
        );

      case VoiceIntentType.queryBudgetStatus:
        return DrillDownLevel(
          title: 'é¢„ç®—æ‰§è¡Œ',
          route: '/budget/execution',
          dimension: 'budget',
          hierarchyLevel: 0,
        );

      case VoiceIntentType.navigateBack:
        return null; // è¿”å›æ“ä½œç”±DrillDownStackå¤„ç†

      default:
        return null;
    }
  }

  /// ä»è¯­éŸ³è®°å½•ä¸‹é’»åˆ°ç”Ÿæˆçš„äº¤æ˜“
  static DrillDownLevel fromVoiceRecord(VoiceRecord record) {
    return DrillDownLevel(
      title: 'è¯­éŸ³è®°å½•è¯¦æƒ…',
      route: '/voice/record/${record.id}',
      dimension: 'voice',
      hierarchyLevel: 0,
      params: {'recordId': record.id},
    );
  }
}
```

#### 12.9.7 ä¸è‡ªå­¦ä¹ ç³»ç»Ÿé›†æˆï¼ˆç¬¬17ç« ï¼‰

```dart
/// æ•°æ®è”åŠ¨ - è‡ªå­¦ä¹ ç³»ç»Ÿé›†æˆ
class LearningLinkageIntegration {
  /// ä¸ªæ€§åŒ–æ¨èçš„ä¸‹é’»å…¥å£
  static DrillDownLevel fromPersonalizedRecommendation(Recommendation rec) {
    return DrillDownLevel(
      title: rec.title,
      route: rec.targetRoute,
      dimension: rec.dimension,
      hierarchyLevel: 1,
      params: rec.params,
      // è‡ªå­¦ä¹ ç³»ç»Ÿé¢„æµ‹çš„ç”¨æˆ·æœ€å¯èƒ½æ„Ÿå…´è¶£çš„æ•°æ®
      aiPredictedInterest: true,
    );
  }

  /// ä»ç”¨æˆ·ç”»åƒä¸‹é’»åˆ°æ¶ˆè´¹æ¨¡å¼
  static DrillDownLevel fromUserProfile(UserProfile profile, String patternType) {
    return DrillDownLevel(
      title: 'æ¶ˆè´¹æ¨¡å¼: $patternType',
      route: '/profile/pattern',
      dimension: 'learning',
      hierarchyLevel: 1,
      params: {'patternType': patternType},
    );
  }
}
```

### 12.10 ç›®æ ‡è¾¾æˆæ£€æµ‹

æ ¹æ®ç¬¬1.4.2èŠ‚å®šä¹‰çš„æ ¸å¿ƒç›®æ ‡ï¼Œæ•°æ®è”åŠ¨åŠŸèƒ½éœ€è¦è¾¾æˆä»¥ä¸‹æ ‡å‡†ï¼š

| æ£€æµ‹é¡¹ | ç›®æ ‡å€¼ | æ£€æµ‹æ–¹æ³• |
|--------|--------|----------|
| ç”¨æˆ·çŸ¥æ™“ç‡ | â‰¥60% | é¦–æ¬¡ä¸‹é’»çš„ç”¨æˆ·å æ¯” |
| ä½¿ç”¨ç‡ | â‰¥70% | ä½¿ç”¨è¿‡ä¸‹é’»åŠŸèƒ½çš„ç”¨æˆ·å æ¯” |
| å¸¸è§„ä½¿ç”¨ç‡ | â‰¥40% | æ¯å‘¨ä½¿ç”¨ä¸‹é’»çš„ç”¨æˆ·å æ¯” |
| å¹³å‡ä¸‹é’»æ·±åº¦ | â‰¥2å±‚ | ç”¨æˆ·å¹³å‡ä¸‹é’»å±‚çº§æ•° |
| æ‰¾åˆ°ç›®æ ‡ä¿¡æ¯ç‡ | â‰¥85% | ä¸‹é’»åæ— è·³å‡ºè¿”å›çš„æ¯”ä¾‹ |
| æŸ¥æ‰¾æ•ˆç‡æå‡ | â‰¥50% | ä¸1.0ç‰ˆæœ¬å¯¹æ¯”æŸ¥æ‰¾æ—¶é—´ |
| æ»¡æ„åº¦è¯„åˆ† | â‰¥4.3/5.0 | åŠŸèƒ½CSATè¯„åˆ† |
| åŠŸèƒ½NPS | â‰¥40 | åŠŸèƒ½æ¨èå‡€å€¼ |

```dart
/// æ•°æ®è”åŠ¨ç›®æ ‡è¾¾æˆæ£€æµ‹
class DataLinkageGoalDetection {
  final AnalyticsService _analytics;

  Future<DataLinkageAchievementReport> checkAchievement() async {
    final awarenessRate = await _analytics.getDrillDownAwarenessRate();
    final trialRate = await _analytics.getDrillDownTrialRate();
    final regularUseRate = await _analytics.getDrillDownRegularUseRate();
    final avgDrillDepth = await _analytics.getAverageDrillDownDepth();
    final findSuccessRate = await _analytics.getDrillDownSuccessRate();

    return DataLinkageAchievementReport(
      awarenessRate: awarenessRate,
      awarenessTarget: 0.60,
      trialRate: trialRate,
      trialTarget: 0.70,
      regularUseRate: regularUseRate,
      regularUseTarget: 0.40,
      avgDrillDepth: avgDrillDepth,
      depthTarget: 2.0,
      findSuccessRate: findSuccessRate,
      successTarget: 0.85,
      overallAchieved: _calculateOverallAchievement(
        awarenessRate, trialRate, regularUseRate, avgDrillDepth, findSuccessRate
      ),
    );
  }

  bool _calculateOverallAchievement(
    double awareness, double trial, double regular, double depth, double success
  ) {
    // æ‰€æœ‰æŒ‡æ ‡è¾¾æ ‡æ‰ç®—æ•´ä½“è¾¾æˆ
    return awareness >= 0.60 &&
           trial >= 0.70 &&
           regular >= 0.40 &&
           depth >= 2.0 &&
           success >= 0.85;
  }
}

---


---

---



## 13. å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ

### 13.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« å®šä¹‰AIè®°è´¦åº”ç”¨çš„å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜åä½œç³»ç»Ÿï¼Œä¸ºå®¶åº­ç†è´¢è€…æä¾›å…±äº«è®°è´¦ã€é¢„ç®—åä½œã€æ”¯å‡ºè¿½è¸ªç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

#### 13.0.1 å®¶åº­è´¦æœ¬è®¾è®¡åŸåˆ™çŸ©é˜µ

| è®¾è®¡åŸåˆ™ | åœ¨å®¶åº­è´¦æœ¬ä¸­çš„ä½“ç° | å®ç°æ–¹å¼ |
|----------|-------------------|----------|
| **æ‡’äººè®¾è®¡** | ä¸€é”®é‚€è¯·å®¶äººï¼Œè‡ªåŠ¨åŒæ­¥ | äºŒç»´ç é‚€è¯·ï¼Œå®æ—¶æ•°æ®åŒæ­¥ |
| **ä¼™ä¼´åŒ–** | å®¶åº­æˆå‘˜äº’åŠ¨æ¿€åŠ± | æˆå‘˜è´¡çŒ®æ’è¡Œï¼Œå…±åŒç›®æ ‡è¾¾æˆåº†ç¥ |
| **éšç§ä¼˜å…ˆ** | ä¸ªäººéšç§ä¸å®¶åº­å…±äº«å¹³è¡¡ | çµæ´»çš„å¯è§æ€§æ§åˆ¶ï¼Œæ•æ„Ÿè´¦ç›®éšè— |
| **æ¸è¿›å¼** | ä»ä¸ªäººè´¦æœ¬å¹³æ»‘è¿‡æ¸¡åˆ°å®¶åº­ | ä¿ç•™ä¸ªäººè´¦æœ¬ï¼ŒæŒ‰éœ€å¼€å¯å…±äº« |
| **å¼€æ”¾é›†æˆ** | ä¸å…¶ä»–ç³»ç»Ÿæ— ç¼åä½œ | ç»Ÿä¸€çš„è´¦æœ¬åˆ‡æ¢ï¼Œé¢„ç®—/é’±é¾„è”åŠ¨ |

#### 13.0.2 è®¾è®¡ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¶åº­è´¦æœ¬ç³»ç»Ÿè®¾è®¡ç†å¿µ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   ğŸ¯ æ ¸å¿ƒç›®æ ‡ï¼šè®©å®¶åº­è´¢åŠ¡ç®¡ç†é€æ˜ã€åä½œã€é«˜æ•ˆ                                   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  è®¾è®¡ç†å¿µï¼šå…±äº«ä¸å¤±ç§å¯†ï¼Œåä½œä¸å¢è´Ÿæ‹…ï¼Œé€æ˜ä¿ƒè¿›æ²Ÿé€š                         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚   å››å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å¤šè´¦æœ¬ç®¡ç†   â”‚  â”‚  æˆå‘˜åä½œ    â”‚  â”‚  é¢„ç®—å…±äº«    â”‚  â”‚  æ”¯å‡ºè¿½è¸ª    â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚   â”‚ ä¸ªäºº/å®¶åº­/   â”‚  â”‚ é‚€è¯·æˆå‘˜ï¼Œ   â”‚  â”‚ å®¶åº­é¢„ç®—åˆ†é… â”‚  â”‚ è°èŠ±äº†å¤šå°‘   â”‚   â”‚
â”‚   â”‚ ä¸“é¡¹è´¦æœ¬     â”‚  â”‚ è§’è‰²æƒé™     â”‚  â”‚ AAåˆ¶åˆ†æ‘Š     â”‚  â”‚ åˆ†ç±»è´¡çŒ®     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.0.3 ä¸å…¶ä»–ç³»ç»Ÿçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¶åº­è´¦æœ¬ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„å…³ç³»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                        â”‚   13. å®¶åº­è´¦æœ¬ç³»ç»Ÿ       â”‚                           â”‚
â”‚                        â”‚      ï¼ˆæœ¬ç« ï¼‰            â”‚                           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                    â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚        â”‚                           â”‚                           â”‚             â”‚
â”‚        â–¼                           â–¼                           â–¼             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ 7.é’±é¾„   â”‚              â”‚ 8.é¢„ç®—   â”‚              â”‚ 9.ä¹ æƒ¯   â”‚          â”‚
â”‚   â”‚  ç³»ç»Ÿ    â”‚              â”‚  ç³»ç»Ÿ    â”‚              â”‚  åŸ¹å…»    â”‚          â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚
â”‚   â”‚ å®¶åº­é’±é¾„ â”‚              â”‚ å®¶åº­é¢„ç®— â”‚              â”‚ å®¶åº­ä¹ æƒ¯ â”‚          â”‚
â”‚   â”‚ æˆå‘˜è´¡çŒ® â”‚              â”‚ æˆå‘˜é…é¢ â”‚              â”‚ å…±åŒç›®æ ‡ â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                           â”‚                           â”‚             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â–¼                                         â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                        â”‚   12. æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–   â”‚                           â”‚
â”‚                        â”‚   - å®¶åº­æŠ¥è¡¨             â”‚                           â”‚
â”‚                        â”‚   - æˆå‘˜å¯¹æ¯”åˆ†æ         â”‚                           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                           2.0æ–°å¢åä½œæ¨¡å—                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚18.è¯­éŸ³   â”‚  â”‚17.è‡ªå­¦ä¹  â”‚  â”‚14.ä½ç½®   â”‚  â”‚10.AIè¯†åˆ« â”‚  â”‚28-29.å¢é•¿â”‚     â”‚
â”‚   â”‚  äº¤äº’    â”‚  â”‚  ç³»ç»Ÿ    â”‚  â”‚  æ™ºèƒ½    â”‚  â”‚  ç³»ç»Ÿ    â”‚  â”‚  ä½“ç³»    â”‚     â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚     â”‚
â”‚   â”‚"å®¶åº­æ”¯å‡ºâ”‚  â”‚å®¶åº­æ¶ˆè´¹  â”‚  â”‚å®¶åº­æˆå‘˜  â”‚  â”‚ç¥¨æ®åˆ†æ‘Š  â”‚  â”‚å®¶åº­è£‚å˜  â”‚     â”‚
â”‚   â”‚ å¤šå°‘"   â”‚  â”‚æ¨¡å¼å­¦ä¹   â”‚  â”‚ä½ç½®å…±äº«  â”‚  â”‚æ™ºèƒ½è¯†åˆ«  â”‚  â”‚é‚€è¯·æ¿€åŠ±  â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.1 è´¦æœ¬ä½“ç³»æ¶æ„

#### 13.1.1 è´¦æœ¬ç±»å‹å®šä¹‰

```dart
/// è´¦æœ¬ç±»å‹æšä¸¾
enum LedgerType {
  personal,    // ä¸ªäººè´¦æœ¬ï¼ˆé»˜è®¤ï¼Œç§æœ‰ï¼‰
  family,      // å®¶åº­è´¦æœ¬ï¼ˆå¤šæˆå‘˜å…±äº«ï¼‰
  couple,      // æƒ…ä¾£è´¦æœ¬ï¼ˆä¸¤äººå…±äº«ï¼‰
  group,       // ç¾¤ç»„è´¦æœ¬ï¼ˆå¤šäººAAï¼‰
  project,     // ä¸“é¡¹è´¦æœ¬ï¼ˆè£…ä¿®ã€æ—…è¡Œç­‰ï¼‰
}

/// è´¦æœ¬å®ä½“
class Ledger {
  final String id;
  final String name;
  final LedgerType type;
  final String ownerId;           // åˆ›å»ºè€…/æ‰€æœ‰è€…
  final String? iconEmoji;        // è´¦æœ¬å›¾æ ‡
  final String? coverColor;       // å°é¢é¢œè‰²
  final DateTime createdAt;
  final LedgerSettings settings;
  final List<LedgerMember> members;
  final LedgerStats stats;

  Ledger({
    required this.id,
    required this.name,
    required this.type,
    required this.ownerId,
    this.iconEmoji,
    this.coverColor,
    required this.createdAt,
    required this.settings,
    required this.members,
    required this.stats,
  });

  /// æ˜¯å¦ä¸ºå…±äº«è´¦æœ¬
  bool get isShared => type != LedgerType.personal;

  /// è·å–æˆå‘˜æ•°é‡
  int get memberCount => members.length;

  /// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™
  bool hasPermission(String userId, LedgerPermission permission) {
    final member = members.firstWhereOrNull((m) => m.userId == userId);
    if (member == null) return false;
    return member.role.hasPermission(permission);
  }
}

/// è´¦æœ¬è®¾ç½®
class LedgerSettings {
  final String defaultCurrency;       // é»˜è®¤è´§å¸
  final bool autoSyncEnabled;         // è‡ªåŠ¨åŒæ­¥
  final bool notifyOnNewTransaction;  // æ–°äº¤æ˜“é€šçŸ¥
  final bool notifyOnBudgetAlert;     // é¢„ç®—å‘Šè­¦é€šçŸ¥
  final VisibilityLevel defaultVisibility;  // é»˜è®¤å¯è§æ€§
  final bool allowMemberInvite;       // å…è®¸æˆå‘˜é‚€è¯·ä»–äºº
  final int? monthlyBudgetLimit;      // æœˆåº¦é¢„ç®—ä¸Šé™

  LedgerSettings({
    this.defaultCurrency = 'CNY',
    this.autoSyncEnabled = true,
    this.notifyOnNewTransaction = true,
    this.notifyOnBudgetAlert = true,
    this.defaultVisibility = VisibilityLevel.allMembers,
    this.allowMemberInvite = false,
    this.monthlyBudgetLimit,
  });
}

/// å¯è§æ€§çº§åˆ«
enum VisibilityLevel {
  private,      // ä»…è‡ªå·±å¯è§
  allMembers,   // æ‰€æœ‰æˆå‘˜å¯è§
  adminsOnly,   // ä»…ç®¡ç†å‘˜å¯è§
  custom,       // è‡ªå®šä¹‰å¯è§æˆå‘˜
}
```

#### 13.1.2 è´¦æœ¬ç®¡ç†æœåŠ¡

```dart
/// è´¦æœ¬ç®¡ç†æœåŠ¡
class LedgerService {
  final LedgerRepository _repository;
  final MemberService _memberService;
  final SyncService _syncService;
  final NotificationService _notificationService;

  // å½“å‰æ´»è·ƒè´¦æœ¬
  final ValueNotifier<Ledger?> currentLedger = ValueNotifier(null);

  // ç”¨æˆ·çš„æ‰€æœ‰è´¦æœ¬
  final ValueNotifier<List<Ledger>> userLedgers = ValueNotifier([]);

  LedgerService(
    this._repository,
    this._memberService,
    this._syncService,
    this._notificationService,
  );

  /// åˆ›å»ºè´¦æœ¬
  Future<Ledger> createLedger({
    required String name,
    required LedgerType type,
    String? iconEmoji,
    String? coverColor,
    LedgerSettings? settings,
  }) async {
    final userId = AuthService().currentUserId;

    final ledger = Ledger(
      id: generateUuid(),
      name: name,
      type: type,
      ownerId: userId,
      iconEmoji: iconEmoji ?? _getDefaultEmoji(type),
      coverColor: coverColor,
      createdAt: DateTime.now(),
      settings: settings ?? LedgerSettings(),
      members: [
        LedgerMember(
          userId: userId,
          role: MemberRole.owner,
          joinedAt: DateTime.now(),
        ),
      ],
      stats: LedgerStats.empty(),
    );

    await _repository.create(ledger);
    await _refreshUserLedgers();

    return ledger;
  }

  String _getDefaultEmoji(LedgerType type) {
    switch (type) {
      case LedgerType.personal: return 'ğŸ“”';
      case LedgerType.family: return 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦';
      case LedgerType.couple: return 'ğŸ’‘';
      case LedgerType.group: return 'ğŸ‘¥';
      case LedgerType.project: return 'ğŸ“‹';
    }
  }

  /// åˆ‡æ¢å½“å‰è´¦æœ¬
  Future<void> switchLedger(String ledgerId) async {
    final ledger = await _repository.getById(ledgerId);
    if (ledger == null) throw LedgerNotFoundException();

    // æ£€æŸ¥æƒé™
    final userId = AuthService().currentUserId;
    if (!ledger.members.any((m) => m.userId == userId)) {
      throw NoPermissionException();
    }

    currentLedger.value = ledger;
    await _syncService.syncLedgerData(ledgerId);

    // ä¿å­˜æœ€åä½¿ç”¨çš„è´¦æœ¬
    await PreferencesService().setLastLedgerId(ledgerId);
  }

  /// è·å–ç”¨æˆ·çš„æ‰€æœ‰è´¦æœ¬
  Future<List<Ledger>> getUserLedgers() async {
    final userId = AuthService().currentUserId;
    final ledgers = await _repository.getByUserId(userId);
    userLedgers.value = ledgers;
    return ledgers;
  }

  /// åˆ é™¤è´¦æœ¬
  Future<void> deleteLedger(String ledgerId) async {
    final ledger = await _repository.getById(ledgerId);
    if (ledger == null) return;

    final userId = AuthService().currentUserId;
    if (ledger.ownerId != userId) {
      throw NoPermissionException('åªæœ‰è´¦æœ¬æ‰€æœ‰è€…å¯ä»¥åˆ é™¤è´¦æœ¬');
    }

    // é€šçŸ¥æ‰€æœ‰æˆå‘˜
    for (final member in ledger.members) {
      if (member.userId != userId) {
        await _notificationService.send(
          member.userId,
          NotificationType.ledgerDeleted,
          {'ledgerName': ledger.name},
        );
      }
    }

    await _repository.delete(ledgerId);
    await _refreshUserLedgers();

    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è´¦æœ¬ï¼Œåˆ‡æ¢åˆ°ä¸ªäººè´¦æœ¬
    if (currentLedger.value?.id == ledgerId) {
      await _switchToPersonalLedger();
    }
  }

  Future<void> _switchToPersonalLedger() async {
    final ledgers = userLedgers.value;
    final personal = ledgers.firstWhereOrNull(
      (l) => l.type == LedgerType.personal
    );
    if (personal != null) {
      await switchLedger(personal.id);
    }
  }

  Future<void> _refreshUserLedgers() async {
    await getUserLedgers();
  }
}
```

### 13.2 æˆå‘˜ç®¡ç†ç³»ç»Ÿ

#### 13.2.1 æˆå‘˜è§’è‰²ä¸æƒé™

```dart
/// æˆå‘˜è§’è‰²
/// ã€æ‡’äººè®¾è®¡ã€‘ç®€åŒ–ä¸º3ç§å¸¸ç”¨è§’è‰²ï¼Œæ»¡è¶³99%åœºæ™¯
/// é«˜çº§æƒé™è‡ªå®šä¹‰ä»…åœ¨ã€Œè®¾ç½®-é«˜çº§ã€ä¸­æä¾›
enum MemberRole {
  owner,    // æ‰€æœ‰è€…ï¼šå…¨éƒ¨æƒé™ï¼ˆè´¦æœ¬åˆ›å»ºè€…è‡ªåŠ¨è·å¾—ï¼‰
  member,   // æˆå‘˜ï¼šè®°è´¦ã€æŸ¥çœ‹ã€ç¼–è¾‘è‡ªå·±çš„è´¦ç›®ï¼ˆé»˜è®¤è§’è‰²ï¼‰
  viewer,   // æŸ¥çœ‹è€…ï¼šä»…æŸ¥çœ‹ï¼ˆé€‚åˆå­©å­æˆ–ä¸´æ—¶æˆå‘˜ï¼‰
  // adminè§’è‰²å·²åˆå¹¶åˆ°ownerï¼Œå‡å°‘ç”¨æˆ·é€‰æ‹©å›°éš¾
}

/// ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘è§’è‰²å˜æ›´é€šçŸ¥æœåŠ¡
/// å‚è€ƒç¬¬4ç« "å®½å®¹"å’Œ"å°Šé‡ç”¨æˆ·"åŸåˆ™
class RoleChangeNotificationService {
  /// ç”Ÿæˆæ¸©å’Œçš„è§’è‰²å˜æ›´é€šçŸ¥ï¼ˆé¿å…è®©ç”¨æˆ·æ„Ÿåˆ°è¢«"é™çº§"ï¼‰
  static NotificationContent generateRoleChangeNotification({
    required MemberRole oldRole,
    required MemberRole newRole,
    required String ledgerName,
  }) {
    // è§’è‰²æå‡ - è¡¨è¾¾ä¿¡ä»»
    if (_getRoleLevel(newRole) > _getRoleLevel(oldRole)) {
      return NotificationContent(
        title: 'è´¦æœ¬æƒé™æ›´æ–°',
        body: 'ä½ åœ¨ã€Œ$ledgerNameã€çš„æƒé™æœ‰äº†æå‡ï¼Œæ„Ÿè°¢ä½ çš„ä»˜å‡ºï¼âœ¨',
        mood: CompanionMood.happy,
      );
    }

    // è§’è‰²è°ƒæ•´ - æ¸©å’Œè¡¨è¾¾ï¼Œä¸ä½¿ç”¨"é™çº§"ç­‰è´Ÿé¢è¯æ±‡
    return NotificationContent(
      title: 'è´¦æœ¬è®¾ç½®æœ‰å˜åŒ–',
      body: 'ã€Œ$ledgerNameã€çš„ç®¡ç†æ–¹å¼åšäº†è°ƒæ•´ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶é—®æˆ‘å“¦ ğŸ˜Š',
      mood: CompanionMood.gentle,
      // ä¸è¯¦ç»†è¯´æ˜æƒé™å‡å°‘ï¼Œé¿å…è´Ÿé¢æ„Ÿå—
    );
  }

  static int _getRoleLevel(MemberRole role) {
    switch (role) {
      case MemberRole.owner: return 3;
      case MemberRole.member: return 2;
      case MemberRole.viewer: return 1;
    }
  }
}

/// ã€æ‡’äººè®¾è®¡ã€‘é¢„è®¾è§’è‰²æ¨¡æ¿ - ä¸€é”®åº”ç”¨
class RolePresets {
  /// å®¶åº­è´¦æœ¬é»˜è®¤è§’è‰²åˆ†é…
  static const familyDefaults = {
    'spouse': MemberRole.member,      // é…å¶é»˜è®¤ä¸ºæˆå‘˜
    'parent': MemberRole.member,      // çˆ¶æ¯é»˜è®¤ä¸ºæˆå‘˜
    'child': MemberRole.viewer,       // å­©å­é»˜è®¤ä¸ºæŸ¥çœ‹è€…
  };

  /// æ™ºèƒ½è§’è‰²æ¨èï¼ˆåŸºäºé‚€è¯·å…³ç³»ï¼‰
  static MemberRole recommendRole(String relationship) {
    return familyDefaults[relationship] ?? MemberRole.member;
  }
}

/// ã€æ— éšœç¢è®¾è®¡ã€‘é‚€è¯·æ–¹å¼æœåŠ¡
/// å‚è€ƒç¬¬5ç« "å¯æ“ä½œ"åŸåˆ™ï¼Œä¸ºä¸åŒèƒ½åŠ›ç”¨æˆ·æä¾›å¤šç§é‚€è¯·æ–¹å¼
class AccessibleInviteService {
  /// é‚€è¯·æ–¹å¼æšä¸¾
  static const inviteMethods = [
    InviteMethod(
      id: 'qrcode',
      name: 'äºŒç»´ç é‚€è¯·',
      description: 'å±•ç¤ºäºŒç»´ç ä¾›å¯¹æ–¹æ‰«æ',
      accessibilityNote: 'éœ€è¦è§†è§‰èƒ½åŠ›',
    ),
    InviteMethod(
      id: 'link',
      name: 'å¤åˆ¶é‚€è¯·é“¾æ¥',
      description: 'å¤åˆ¶é“¾æ¥é€šè¿‡å…¶ä»–æ–¹å¼åˆ†äº«',
      accessibilityNote: 'é€‚åˆæ‰€æœ‰ç”¨æˆ·ï¼Œæ¨èæ–¹å¼',
      isRecommendedForAccessibility: true,
    ),
    InviteMethod(
      id: 'voice_code',
      name: 'è¯­éŸ³é‚€è¯·ç ',
      description: 'ç”Ÿæˆ6ä½æ•°å­—é‚€è¯·ç ï¼Œå¯å£è¿°ç»™å¯¹æ–¹',
      accessibilityNote: 'é€‚åˆè§†éšœç”¨æˆ·',
      isRecommendedForAccessibility: true,
    ),
    InviteMethod(
      id: 'contact',
      name: 'ä»é€šè®¯å½•é‚€è¯·',
      description: 'ç›´æ¥é€‰æ‹©è”ç³»äººå‘é€é‚€è¯·',
      accessibilityNote: 'éœ€è¦é€šè®¯å½•æƒé™',
    ),
  ];

  /// ç”Ÿæˆè¯­éŸ³é‚€è¯·ç ï¼ˆ6ä½æ•°å­—ï¼Œæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
  static Future<VoiceInviteCode> generateVoiceCode(String ledgerId) async {
    final code = _generateNumericCode(6);
    final expiry = DateTime.now().add(Duration(hours: 24));

    return VoiceInviteCode(
      code: code,
      ledgerId: ledgerId,
      expiresAt: expiry,
      // è¯­ä¹‰åŒ–æè¿°ï¼Œæ–¹ä¾¿å±å¹•é˜…è¯»å™¨æœ—è¯»
      semanticDescription: 'é‚€è¯·ç æ˜¯ ${code.split('').join(' ')}ï¼Œ'
          '24å°æ—¶å†…æœ‰æ•ˆã€‚è¯·å‘Šè¯‰å¯¹æ–¹åœ¨åŠ å…¥è´¦æœ¬æ—¶è¾“å…¥æ­¤é‚€è¯·ç ã€‚',
    );
  }

  static String _generateNumericCode(int length) {
    final random = Random();
    return List.generate(length, (_) => random.nextInt(10)).join();
  }
}

class InviteMethod {
  final String id;
  final String name;
  final String description;
  final String accessibilityNote;
  final bool isRecommendedForAccessibility;

  const InviteMethod({
    required this.id,
    required this.name,
    required this.description,
    required this.accessibilityNote,
    this.isRecommendedForAccessibility = false,
  });
}

class VoiceInviteCode {
  final String code;
  final String ledgerId;
  final DateTime expiresAt;
  final String semanticDescription;

  VoiceInviteCode({
    required this.code,
    required this.ledgerId,
    required this.expiresAt,
    required this.semanticDescription,
  });
}

/// æƒé™ç±»å‹
enum LedgerPermission {
  // è´¦æœ¬ç®¡ç†
  editLedgerSettings,     // ç¼–è¾‘è´¦æœ¬è®¾ç½®
  deleteLedger,           // åˆ é™¤è´¦æœ¬
  inviteMember,           // é‚€è¯·æˆå‘˜
  removeMember,           // ç§»é™¤æˆå‘˜
  changeMemberRole,       // ä¿®æ”¹æˆå‘˜è§’è‰²

  // äº¤æ˜“æ“ä½œ
  createTransaction,      // åˆ›å»ºäº¤æ˜“
  editOwnTransaction,     // ç¼–è¾‘è‡ªå·±çš„äº¤æ˜“
  editAnyTransaction,     // ç¼–è¾‘ä»»ä½•äº¤æ˜“
  deleteOwnTransaction,   // åˆ é™¤è‡ªå·±çš„äº¤æ˜“
  deleteAnyTransaction,   // åˆ é™¤ä»»ä½•äº¤æ˜“

  // é¢„ç®—æ“ä½œ
  viewBudget,             // æŸ¥çœ‹é¢„ç®—
  editBudget,             // ç¼–è¾‘é¢„ç®—

  // æ•°æ®æŸ¥çœ‹
  viewAllTransactions,    // æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“
  viewStatistics,         // æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
  exportData,             // å¯¼å‡ºæ•°æ®
}

/// è§’è‰²æƒé™æ˜ å°„
extension MemberRolePermissions on MemberRole {
  Set<LedgerPermission> get permissions {
    switch (this) {
      case MemberRole.owner:
        return LedgerPermission.values.toSet();

      case MemberRole.admin:
        return LedgerPermission.values.toSet()
          ..remove(LedgerPermission.deleteLedger);

      case MemberRole.member:
        return {
          LedgerPermission.createTransaction,
          LedgerPermission.editOwnTransaction,
          LedgerPermission.deleteOwnTransaction,
          LedgerPermission.viewBudget,
          LedgerPermission.viewAllTransactions,
          LedgerPermission.viewStatistics,
        };

      case MemberRole.viewer:
        return {
          LedgerPermission.viewAllTransactions,
          LedgerPermission.viewStatistics,
        };
    }
  }

  bool hasPermission(LedgerPermission permission) {
    return permissions.contains(permission);
  }
}

/// è´¦æœ¬æˆå‘˜
class LedgerMember {
  final String id;
  final String userId;
  final String? nickname;         // åœ¨è´¦æœ¬ä¸­çš„æ˜µç§°
  final String? avatarUrl;
  final MemberRole role;
  final DateTime joinedAt;
  final String? invitedBy;        // é‚€è¯·äººID
  final MemberSettings settings;  // ä¸ªäººè®¾ç½®

  LedgerMember({
    String? id,
    required this.userId,
    this.nickname,
    this.avatarUrl,
    required this.role,
    required this.joinedAt,
    this.invitedBy,
    MemberSettings? settings,
  }) : id = id ?? generateUuid(),
       settings = settings ?? MemberSettings();

  /// æ˜¾ç¤ºåç§°
  String get displayName => nickname ?? 'æˆå‘˜';
}

/// æˆå‘˜ä¸ªäººè®¾ç½®
class MemberSettings {
  final bool receiveNotifications;   // æ¥æ”¶é€šçŸ¥
  final bool showInRanking;          // æ˜¾ç¤ºåœ¨æ’è¡Œä¸­
  final VisibilityLevel defaultVisibility;  // é»˜è®¤å¯è§æ€§

  MemberSettings({
    this.receiveNotifications = true,
    this.showInRanking = true,
    this.defaultVisibility = VisibilityLevel.allMembers,
  });
}
```

#### 13.2.2 é‚€è¯·æœºåˆ¶

```dart
/// é‚€è¯·æœåŠ¡
class InvitationService {
  final InvitationRepository _repository;
  final LedgerService _ledgerService;
  final NotificationService _notificationService;

  /// åˆ›å»ºé‚€è¯·é“¾æ¥
  Future<Invitation> createInvitation({
    required String ledgerId,
    MemberRole role = MemberRole.member,
    Duration? expiresIn,
    int? maxUses,
  }) async {
    final ledger = await _ledgerService.getLedger(ledgerId);
    final userId = AuthService().currentUserId;

    // æ£€æŸ¥æƒé™
    if (!ledger.hasPermission(userId, LedgerPermission.inviteMember)) {
      throw NoPermissionException('æ— æƒé‚€è¯·æˆå‘˜');
    }

    final invitation = Invitation(
      id: generateUuid(),
      ledgerId: ledgerId,
      ledgerName: ledger.name,
      inviterId: userId,
      role: role,
      createdAt: DateTime.now(),
      expiresAt: expiresIn != null
          ? DateTime.now().add(expiresIn)
          : DateTime.now().add(const Duration(days: 7)),
      maxUses: maxUses,
      usedCount: 0,
      status: InvitationStatus.active,
    );

    await _repository.create(invitation);
    return invitation;
  }

  /// ç”Ÿæˆé‚€è¯·äºŒç»´ç æ•°æ®
  String generateQRCodeData(Invitation invitation) {
    return 'aibook://invite/${invitation.id}';
  }

  /// ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆ
  String generateShareText(Invitation invitation) {
    return 'é‚€è¯·ä½ åŠ å…¥ \${invitation.ledgerName} è´¦æœ¬\n\n'
        'ç‚¹å‡»é“¾æ¥åŠ å…¥ï¼šhttps://aibook.app/invite/\${invitation.id}\n\n'
        'æˆ–åœ¨AIè®°è´¦Appä¸­æ‰«æäºŒç»´ç åŠ å…¥';
  }

  /// æ¥å—é‚€è¯·
  Future<void> acceptInvitation(String invitationId) async {
    final invitation = await _repository.getById(invitationId);
    if (invitation == null) {
      throw InvitationNotFoundException();
    }

    // éªŒè¯é‚€è¯·æœ‰æ•ˆæ€§
    _validateInvitation(invitation);

    final userId = AuthService().currentUserId;

    // æ£€æŸ¥æ˜¯å¦å·²æ˜¯æˆå‘˜
    final ledger = await _ledgerService.getLedger(invitation.ledgerId);
    if (ledger.members.any((m) => m.userId == userId)) {
      throw AlreadyMemberException();
    }

    // æ·»åŠ æˆå‘˜
    final member = LedgerMember(
      userId: userId,
      role: invitation.role,
      joinedAt: DateTime.now(),
      invitedBy: invitation.inviterId,
    );

    await _ledgerService.addMember(invitation.ledgerId, member);

    // æ›´æ–°é‚€è¯·ä½¿ç”¨æ¬¡æ•°
    await _repository.incrementUsedCount(invitationId);

    // é€šçŸ¥é‚€è¯·äºº
    await _notificationService.send(
      invitation.inviterId,
      NotificationType.memberJoined,
      {
        'ledgerName': invitation.ledgerName,
        'memberName': AuthService().currentUser?.displayName,
      },
    );
  }

  void _validateInvitation(Invitation invitation) {
    if (invitation.status != InvitationStatus.active) {
      throw InvitationExpiredException();
    }

    if (invitation.expiresAt.isBefore(DateTime.now())) {
      throw InvitationExpiredException();
    }

    if (invitation.maxUses != null &&
        invitation.usedCount >= invitation.maxUses!) {
      throw InvitationExhaustedException();
    }
  }
}

/// é‚€è¯·å®ä½“
class Invitation {
  final String id;
  final String ledgerId;
  final String ledgerName;
  final String inviterId;
  final MemberRole role;
  final DateTime createdAt;
  final DateTime expiresAt;
  final int? maxUses;
  final int usedCount;
  final InvitationStatus status;

  Invitation({
    required this.id,
    required this.ledgerId,
    required this.ledgerName,
    required this.inviterId,
    required this.role,
    required this.createdAt,
    required this.expiresAt,
    this.maxUses,
    required this.usedCount,
    required this.status,
  });

  bool get isValid =>
      status == InvitationStatus.active &&
      expiresAt.isAfter(DateTime.now()) &&
      (maxUses == null || usedCount < maxUses!);
}

enum InvitationStatus {
  active,
  expired,
  revoked,
}
```

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šé‚€è¯·è£‚å˜ä¸å¢é•¿ä¼˜åŒ–è®¾è®¡è¯¦è§[ç¬¬29.4èŠ‚ ç¤¾äº¤è£‚å˜æœºåˆ¶è®¾è®¡](#294-ç¤¾äº¤è£‚å˜æœºåˆ¶è®¾è®¡)

### 13.3 å®¶åº­é¢„ç®—åä½œ

#### 13.3.1 å®¶åº­é¢„ç®—åˆ†é…æ¨¡å‹

```dart
/// å®¶åº­é¢„ç®—åˆ†é…ç­–ç•¥
/// ã€æ‡’äººè®¾è®¡ã€‘é»˜è®¤ä½¿ç”¨unifiedæ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼åœ¨ã€Œé«˜çº§è®¾ç½®ã€ä¸­
enum FamilyBudgetStrategy {
  unified,      // ç»Ÿä¸€é¢„ç®—ï¼šå®¶åº­å…±ç”¨ä¸€ä¸ªé¢„ç®—æ± ï¼ˆé»˜è®¤ï¼Œæœ€ç®€å•ï¼‰
  perMember,    // æˆå‘˜é…é¢ï¼šæ¯ä¸ªæˆå‘˜æœ‰ç‹¬ç«‹é…é¢ï¼ˆé«˜çº§ï¼‰
  perCategory,  // åˆ†ç±»è´Ÿè´£ï¼šä¸åŒæˆå‘˜è´Ÿè´£ä¸åŒåˆ†ç±»ï¼ˆé«˜çº§ï¼‰
  hybrid,       // æ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†ç»Ÿä¸€+éƒ¨åˆ†ç‹¬ç«‹ï¼ˆé«˜çº§ï¼‰
}

/// ã€æ‡’äººè®¾è®¡ã€‘æ™ºèƒ½é¢„ç®—åˆ†é…å»ºè®®æœåŠ¡
class SmartBudgetAllocationService {
  /// ä¸€é”®æ™ºèƒ½åˆ†é… - åŸºäºå†å²æ¶ˆè´¹è‡ªåŠ¨å»ºè®®
  Future<Map<String, double>> suggestMemberAllocations({
    required String ledgerId,
    required double totalBudget,
  }) async {
    final members = await _getMemberConsumptionHistory(ledgerId);
    final suggestions = <String, double>{};

    // åŸºäºè¿‡å»3ä¸ªæœˆæ¶ˆè´¹æ¯”ä¾‹è®¡ç®—å»ºè®®é…é¢
    final totalSpent = members.values.fold(0.0, (sum, m) => sum + m.avgMonthlySpent);

    for (final entry in members.entries) {
      final ratio = totalSpent > 0 ? entry.value.avgMonthlySpent / totalSpent : 1.0 / members.length;
      suggestions[entry.key] = (totalBudget * ratio).roundToDouble();
    }

    return suggestions;
  }

  /// ç”Ÿæˆåˆ†é…å»ºè®®è¯´æ˜
  String generateSuggestionExplanation(Map<String, double> suggestions) {
    return 'æ ¹æ®è¿‡å»3ä¸ªæœˆçš„æ¶ˆè´¹è®°å½•ï¼Œæˆ‘ä»¬å»ºè®®ï¼š\n' +
        suggestions.entries.map((e) => 'â€¢ ${e.key}: Â¥${e.value.toStringAsFixed(0)}').join('\n');
  }
}

/// å®¶åº­é¢„ç®—
class FamilyBudget {
  final String id;
  final String ledgerId;
  final String period;            // é¢„ç®—å‘¨æœŸ (2026-01)
  final FamilyBudgetStrategy strategy;
  final double totalBudget;       // æ€»é¢„ç®—
  final Map<String, MemberBudget> memberBudgets;  // æˆå‘˜é¢„ç®—
  final Map<String, CategoryBudget> categoryBudgets;  // åˆ†ç±»é¢„ç®—
  final FamilyBudgetRules rules;

  FamilyBudget({
    required this.id,
    required this.ledgerId,
    required this.period,
    required this.strategy,
    required this.totalBudget,
    required this.memberBudgets,
    required this.categoryBudgets,
    required this.rules,
  });

  /// è·å–æˆå‘˜å‰©ä½™é¢„ç®—
  double getMemberRemaining(String userId) {
    final memberBudget = memberBudgets[userId];
    if (memberBudget == null) return 0;
    return memberBudget.allocated - memberBudget.spent;
  }

  /// è·å–å®¶åº­æ€»ä½“å‰©ä½™
  double get totalRemaining {
    final totalSpent = memberBudgets.values
        .fold(0.0, (sum, m) => sum + m.spent);
    return totalBudget - totalSpent;
  }

  /// è·å–é¢„ç®—ä½¿ç”¨ç™¾åˆ†æ¯”
  double get usagePercentage {
    if (totalBudget == 0) return 0;
    return (totalBudget - totalRemaining) / totalBudget * 100;
  }
}

/// æˆå‘˜é¢„ç®—
class MemberBudget {
  final String memberId;
  final double allocated;         // åˆ†é…é¢åº¦
  final double spent;             // å·²ä½¿ç”¨
  final Map<String, double> categorySpent;  // å„åˆ†ç±»æ”¯å‡º

  MemberBudget({
    required this.memberId,
    required this.allocated,
    required this.spent,
    required this.categorySpent,
  });

  double get remaining => allocated - spent;
  double get usagePercentage => allocated > 0 ? spent / allocated * 100 : 0;
}

/// å®¶åº­é¢„ç®—è§„åˆ™
class FamilyBudgetRules {
  final bool allowOverspend;          // å…è®¸è¶…æ”¯
  final double? overspendLimit;       // è¶…æ”¯ä¸Šé™
  final bool requireApprovalForLarge; // å¤§é¢æ”¯å‡ºéœ€å®¡æ‰¹
  final double? largeExpenseThreshold;// å¤§é¢æ”¯å‡ºé˜ˆå€¼
  final bool notifyOnThreshold;       // è¾¾åˆ°é˜ˆå€¼æ—¶é€šçŸ¥
  final List<int> thresholdPercentages;  // é€šçŸ¥é˜ˆå€¼ [50, 80, 100]

  FamilyBudgetRules({
    this.allowOverspend = false,
    this.overspendLimit,
    this.requireApprovalForLarge = false,
    this.largeExpenseThreshold,
    this.notifyOnThreshold = true,
    this.thresholdPercentages = const [50, 80, 100],
  });
}
```

#### 13.3.2 å®¶åº­é¢„ç®—æœåŠ¡

```dart
/// å®¶åº­é¢„ç®—æœåŠ¡
class FamilyBudgetService {
  final FamilyBudgetRepository _repository;
  final LedgerService _ledgerService;
  final NotificationService _notificationService;

  /// åˆ›å»ºå®¶åº­é¢„ç®—
  Future<FamilyBudget> createBudget({
    required String ledgerId,
    required String period,
    required double totalBudget,
    required FamilyBudgetStrategy strategy,
    Map<String, double>? memberAllocations,
    Map<String, double>? categoryAllocations,
    FamilyBudgetRules? rules,
  }) async {
    final ledger = await _ledgerService.getLedger(ledgerId);

    // æ ¹æ®ç­–ç•¥åˆå§‹åŒ–æˆå‘˜é¢„ç®—
    final memberBudgets = <String, MemberBudget>{};

    switch (strategy) {
      case FamilyBudgetStrategy.unified:
        // ç»Ÿä¸€é¢„ç®—ï¼šæ‰€æœ‰æˆå‘˜å…±äº«
        for (final member in ledger.members) {
          memberBudgets[member.userId] = MemberBudget(
            memberId: member.userId,
            allocated: totalBudget,  // å…±äº«æ€»é¢
            spent: 0,
            categorySpent: {},
          );
        }
        break;

      case FamilyBudgetStrategy.perMember:
        // æˆå‘˜é…é¢ï¼šæŒ‰åˆ†é…æ¯”ä¾‹
        if (memberAllocations == null) {
          // å¹³å‡åˆ†é…
          final perMember = totalBudget / ledger.members.length;
          for (final member in ledger.members) {
            memberBudgets[member.userId] = MemberBudget(
              memberId: member.userId,
              allocated: perMember,
              spent: 0,
              categorySpent: {},
            );
          }
        } else {
          for (final entry in memberAllocations.entries) {
            memberBudgets[entry.key] = MemberBudget(
              memberId: entry.key,
              allocated: entry.value,
              spent: 0,
              categorySpent: {},
            );
          }
        }
        break;

      // ... å…¶ä»–ç­–ç•¥
    }

    final budget = FamilyBudget(
      id: generateUuid(),
      ledgerId: ledgerId,
      period: period,
      strategy: strategy,
      totalBudget: totalBudget,
      memberBudgets: memberBudgets,
      categoryBudgets: {},
      rules: rules ?? FamilyBudgetRules(),
    );

    await _repository.create(budget);

    // é€šçŸ¥æ‰€æœ‰æˆå‘˜
    await _notifyBudgetCreated(ledger, budget);

    return budget;
  }

  /// è®°å½•æ”¯å‡ºæ—¶æ›´æ–°é¢„ç®—
  Future<BudgetUpdateResult> recordExpense({
    required String ledgerId,
    required String memberId,
    required double amount,
    required String categoryId,
  }) async {
    final budget = await _repository.getCurrentBudget(ledgerId);
    if (budget == null) {
      return BudgetUpdateResult(success: true, alerts: []);
    }

    final memberBudget = budget.memberBudgets[memberId];
    if (memberBudget == null) {
      return BudgetUpdateResult(success: true, alerts: []);
    }

    // æ›´æ–°æ”¯å‡º
    final newSpent = memberBudget.spent + amount;
    final newCategorySpent = Map<String, double>.from(memberBudget.categorySpent);
    newCategorySpent[categoryId] = (newCategorySpent[categoryId] ?? 0) + amount;

    await _repository.updateMemberSpent(
      budget.id,
      memberId,
      newSpent,
      newCategorySpent,
    );

    // æ£€æŸ¥é¢„ç®—å‘Šè­¦
    final alerts = await _checkBudgetAlerts(budget, memberId, newSpent);

    return BudgetUpdateResult(
      success: true,
      alerts: alerts,
      newRemaining: memberBudget.allocated - newSpent,
    );
  }

  /// æ£€æŸ¥é¢„ç®—å‘Šè­¦
  Future<List<BudgetAlert>> _checkBudgetAlerts(
    FamilyBudget budget,
    String memberId,
    double newSpent,
  ) async {
    final alerts = <BudgetAlert>[];
    final memberBudget = budget.memberBudgets[memberId]!;
    final usagePercent = newSpent / memberBudget.allocated * 100;

    for (final threshold in budget.rules.thresholdPercentages) {
      final previousPercent = memberBudget.spent / memberBudget.allocated * 100;

      // åˆšåˆšè¶Šè¿‡é˜ˆå€¼
      if (previousPercent < threshold && usagePercent >= threshold) {
        final alert = BudgetAlert(
          type: threshold >= 100
              ? BudgetAlertType.exceeded
              : BudgetAlertType.threshold,
          threshold: threshold,
          currentUsage: usagePercent,
          memberId: memberId,
        );
        alerts.add(alert);

        // å‘é€é€šçŸ¥
        if (budget.rules.notifyOnThreshold) {
          await _notifyBudgetAlert(budget, memberId, alert);
        }
      }
    }

    return alerts;
  }

  Future<void> _notifyBudgetAlert(
    FamilyBudget budget,
    String memberId,
    BudgetAlert alert,
  ) async {
    final ledger = await _ledgerService.getLedger(budget.ledgerId);

    // é€šçŸ¥æ‰€æœ‰ç®¡ç†å‘˜
    for (final member in ledger.members) {
      if (member.role == MemberRole.owner ||
          member.role == MemberRole.admin) {
        await _notificationService.send(
          member.userId,
          NotificationType.budgetAlert,
          {
            'ledgerName': ledger.name,
            'alertType': alert.type.name,
            'threshold': alert.threshold,
            'currentUsage': alert.currentUsage.toStringAsFixed(1),
          },
        );
      }
    }
  }
}

/// é¢„ç®—æ›´æ–°ç»“æœ
class BudgetUpdateResult {
  final bool success;
  final List<BudgetAlert> alerts;
  final double? newRemaining;

  BudgetUpdateResult({
    required this.success,
    required this.alerts,
    this.newRemaining,
  });
}

/// é¢„ç®—å‘Šè­¦
class BudgetAlert {
  final BudgetAlertType type;
  final int threshold;
  final double currentUsage;
  final String memberId;

  BudgetAlert({
    required this.type,
    required this.threshold,
    required this.currentUsage,
    required this.memberId,
  });
}

enum BudgetAlertType {
  threshold,    // è¾¾åˆ°é˜ˆå€¼
  exceeded,     // è¶…æ”¯
  largeExpense, // å¤§é¢æ”¯å‡º
}
```

### 13.4 äº¤æ˜“åä½œä¸åˆ†æ‘Š

#### 13.4.1 äº¤æ˜“å¯è§æ€§æ§åˆ¶

```dart
/// å®¶åº­äº¤æ˜“æ‰©å±•
class FamilyTransaction extends Transaction {
  final String ledgerId;
  final VisibilityLevel visibility;
  final List<String>? visibleToMembers;  // è‡ªå®šä¹‰å¯è§æˆå‘˜
  final SplitInfo? splitInfo;            // åˆ†æ‘Šä¿¡æ¯

  FamilyTransaction({
    required super.id,
    required super.amount,
    required super.categoryId,
    required super.createdBy,
    required super.createdAt,
    required this.ledgerId,
    this.visibility = VisibilityLevel.allMembers,
    this.visibleToMembers,
    this.splitInfo,
    // ... å…¶ä»–å­—æ®µ
  });

  /// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯è§æ­¤äº¤æ˜“
  bool isVisibleTo(String userId, MemberRole userRole) {
    // åˆ›å»ºè€…æ€»æ˜¯å¯è§
    if (createdBy == userId) return true;

    // æ‰€æœ‰è€…å’Œç®¡ç†å‘˜å¯è§å…¨éƒ¨
    if (userRole == MemberRole.owner || userRole == MemberRole.admin) {
      return true;
    }

    switch (visibility) {
      case VisibilityLevel.private:
        return false;
      case VisibilityLevel.allMembers:
        return true;
      case VisibilityLevel.adminsOnly:
        return false;
      case VisibilityLevel.custom:
        return visibleToMembers?.contains(userId) ?? false;
    }
  }
}
```

#### 13.4.2 AAåˆ†æ‘Šç³»ç»Ÿ

```dart
/// åˆ†æ‘Šä¿¡æ¯
class SplitInfo {
  final SplitType type;
  final List<SplitParticipant> participants;
  final SplitStatus status;

  SplitInfo({
    required this.type,
    required this.participants,
    required this.status,
  });

  /// è·å–æ€»é‡‘é¢
  double get totalAmount =>
      participants.fold(0.0, (sum, p) => sum + p.amount);

  /// è·å–å·²ç»“ç®—é‡‘é¢
  double get settledAmount =>
      participants.where((p) => p.isSettled).fold(0.0, (sum, p) => sum + p.amount);

  /// æ˜¯å¦å…¨éƒ¨ç»“ç®—
  bool get isFullySettled =>
      participants.every((p) => p.isSettled || p.isPayer);
}

/// åˆ†æ‘Šç±»å‹
enum SplitType {
  equal,        // å¹³å‡åˆ†æ‘Š
  percentage,   // æŒ‰æ¯”ä¾‹åˆ†æ‘Š
  exact,        // ç²¾ç¡®é‡‘é¢
  shares,       // æŒ‰ä»½æ•°
}

/// åˆ†æ‘Šå‚ä¸è€…
class SplitParticipant {
  final String memberId;
  final String memberName;
  final double amount;        // åº”ä»˜é‡‘é¢
  final double? percentage;   // åˆ†æ‘Šæ¯”ä¾‹
  final int? shares;          // ä»½æ•°
  final bool isPayer;         // æ˜¯å¦ä¸ºä»˜æ¬¾äºº
  final bool isSettled;       // æ˜¯å¦å·²ç»“ç®—
  final DateTime? settledAt;

  SplitParticipant({
    required this.memberId,
    required this.memberName,
    required this.amount,
    this.percentage,
    this.shares,
    this.isPayer = false,
    this.isSettled = false,
    this.settledAt,
  });
}

enum SplitStatus {
  pending,      // å¾…ç¡®è®¤
  confirmed,    // å·²ç¡®è®¤
  settling,     // ç»“ç®—ä¸­
  settled,      // å·²ç»“ç®—
}

/// ã€æ‡’äººè®¾è®¡ã€‘åˆ†æ‘Šé»˜è®¤é…ç½®ä¸æ™ºèƒ½æ¨è
class SplitDefaults {
  /// é»˜è®¤ä½¿ç”¨å‡æ‘Š - æœ€ç®€å•ï¼Œä¸€é”®å®Œæˆ
  static const defaultSplitType = SplitType.equal;

  /// æ™ºèƒ½æ¨èåˆ†æ‘Šå‚ä¸è€…ï¼ˆåŸºäºå†å²è®°å½•ï¼‰
  static Future<List<String>> suggestParticipants({
    required String ledgerId,
    required String categoryId,
  }) async {
    final history = await _getRecentSplitHistory(ledgerId, categoryId);
    final frequency = <String, int>{};
    for (final split in history) {
      for (final p in split.participantIds) {
        frequency[p] = (frequency[p] ?? 0) + 1;
      }
    }
    final sorted = frequency.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    return sorted.take(3).map((e) => e.key).toList();
  }
}

/// åˆ†æ‘ŠæœåŠ¡
class SplitService {
  final TransactionRepository _transactionRepository;
  final NotificationService _notificationService;
  final LedgerService _ledgerService;

  /// åˆ›å»ºåˆ†æ‘Šäº¤æ˜“
  Future<FamilyTransaction> createSplitTransaction({
    required String ledgerId,
    required double totalAmount,
    required String categoryId,
    required String description,
    required SplitType splitType,
    required List<String> participantIds,
    String? payerId,
    Map<String, double>? exactAmounts,
    Map<String, int>? shares,
  }) async {
    final ledger = await _ledgerService.getLedger(ledgerId);
    final currentUserId = AuthService().currentUserId;
    final actualPayerId = payerId ?? currentUserId;

    // è®¡ç®—æ¯äººåº”ä»˜é‡‘é¢
    final participants = _calculateSplit(
      totalAmount: totalAmount,
      splitType: splitType,
      participantIds: participantIds,
      payerId: actualPayerId,
      ledger: ledger,
      exactAmounts: exactAmounts,
      shares: shares,
    );

    final transaction = FamilyTransaction(
      id: generateUuid(),
      amount: totalAmount,
      categoryId: categoryId,
      description: description,
      createdBy: currentUserId,
      createdAt: DateTime.now(),
      ledgerId: ledgerId,
      visibility: VisibilityLevel.allMembers,
      splitInfo: SplitInfo(
        type: splitType,
        participants: participants,
        status: SplitStatus.pending,
      ),
    );

    await _transactionRepository.create(transaction);

    // é€šçŸ¥å‚ä¸è€…
    for (final participant in participants) {
      if (!participant.isPayer) {
        await _notificationService.send(
          participant.memberId,
          NotificationType.splitRequest,
          {
            'amount': participant.amount,
            'description': description,
            'payerName': ledger.members
                .firstWhere((m) => m.userId == actualPayerId)
                .displayName,
          },
        );
      }
    }

    return transaction;
  }

  List<SplitParticipant> _calculateSplit({
    required double totalAmount,
    required SplitType splitType,
    required List<String> participantIds,
    required String payerId,
    required Ledger ledger,
    Map<String, double>? exactAmounts,
    Map<String, int>? shares,
  }) {
    final participants = <SplitParticipant>[];

    switch (splitType) {
      case SplitType.equal:
        final perPerson = totalAmount / participantIds.length;
        for (final id in participantIds) {
          final member = ledger.members.firstWhere((m) => m.userId == id);
          participants.add(SplitParticipant(
            memberId: id,
            memberName: member.displayName,
            amount: perPerson,
            percentage: 100 / participantIds.length,
            isPayer: id == payerId,
            isSettled: id == payerId,  // ä»˜æ¬¾äººè‡ªåŠ¨ç»“ç®—
          ));
        }
        break;

      case SplitType.exact:
        for (final id in participantIds) {
          final member = ledger.members.firstWhere((m) => m.userId == id);
          final amount = exactAmounts?[id] ?? 0;
          participants.add(SplitParticipant(
            memberId: id,
            memberName: member.displayName,
            amount: amount,
            isPayer: id == payerId,
            isSettled: id == payerId,
          ));
        }
        break;

      case SplitType.shares:
        final totalShares = shares?.values.fold(0, (a, b) => a + b) ?? participantIds.length;
        for (final id in participantIds) {
          final member = ledger.members.firstWhere((m) => m.userId == id);
          final memberShares = shares?[id] ?? 1;
          final amount = totalAmount * memberShares / totalShares;
          participants.add(SplitParticipant(
            memberId: id,
            memberName: member.displayName,
            amount: amount,
            shares: memberShares,
            isPayer: id == payerId,
            isSettled: id == payerId,
          ));
        }
        break;

      default:
        break;
    }

    return participants;
  }

  /// ç¡®è®¤åˆ†æ‘Šï¼ˆå‚ä¸è€…ç¡®è®¤è‡ªå·±çš„ä»½é¢ï¼‰
  Future<void> confirmSplit(String transactionId, String memberId) async {
    await _transactionRepository.updateSplitParticipantStatus(
      transactionId,
      memberId,
      isSettled: true,
      settledAt: DateTime.now(),
    );

    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ç»“ç®—
    final transaction = await _transactionRepository.getById(transactionId);
    if (transaction?.splitInfo?.isFullySettled ?? false) {
      await _transactionRepository.updateSplitStatus(
        transactionId,
        SplitStatus.settled,
      );
    }
  }
}
```

### 13.5 å®¶åº­ç»Ÿè®¡ä¸æŠ¥è¡¨

#### 13.5.1 å®¶åº­è´¢åŠ¡çœ‹æ¿

```dart
/// å®¶åº­è´¢åŠ¡çœ‹æ¿æ•°æ®
class FamilyDashboardData {
  final String ledgerId;
  final String period;
  final FamilySummary summary;
  final List<MemberContribution> memberContributions;
  final List<CategoryBreakdown> categoryBreakdown;
  final List<TrendPoint> spendingTrend;
  final List<BudgetStatus> budgetStatuses;
  final List<PendingSplit> pendingSplits;

  FamilyDashboardData({
    required this.ledgerId,
    required this.period,
    required this.summary,
    required this.memberContributions,
    required this.categoryBreakdown,
    required this.spendingTrend,
    required this.budgetStatuses,
    required this.pendingSplits,
  });
}

/// å®¶åº­æ±‡æ€»
class FamilySummary {
  final double totalIncome;
  final double totalExpense;
  final double netSavings;
  final double savingsRate;
  final int transactionCount;
  final double avgDailyExpense;

  FamilySummary({
    required this.totalIncome,
    required this.totalExpense,
    required this.netSavings,
    required this.savingsRate,
    required this.transactionCount,
    required this.avgDailyExpense,
  });
}

/// æˆå‘˜è´¡çŒ®
class MemberContribution {
  final String memberId;
  final String memberName;
  final String? avatarUrl;
  final double income;
  final double expense;
  final int transactionCount;
  final double contributionPercentage;  // æ”¯å‡ºå æ¯”
  final List<String> topCategories;     // ä¸»è¦æ”¯å‡ºåˆ†ç±»

  MemberContribution({
    required this.memberId,
    required this.memberName,
    this.avatarUrl,
    required this.income,
    required this.expense,
    required this.transactionCount,
    required this.contributionPercentage,
    required this.topCategories,
  });
}

/// å®¶åº­çœ‹æ¿æœåŠ¡
class FamilyDashboardService {
  final TransactionRepository _transactionRepository;
  final FamilyBudgetService _budgetService;
  final LedgerService _ledgerService;

  /// è·å–å®¶åº­çœ‹æ¿æ•°æ®
  Future<FamilyDashboardData> getDashboardData({
    required String ledgerId,
    required String period,
  }) async {
    final ledger = await _ledgerService.getLedger(ledgerId);
    final transactions = await _transactionRepository.getByLedgerAndPeriod(
      ledgerId,
      period,
    );

    // è®¡ç®—æ±‡æ€»
    final summary = _calculateSummary(transactions);

    // è®¡ç®—æˆå‘˜è´¡çŒ®
    final memberContributions = _calculateMemberContributions(
      transactions,
      ledger.members,
    );

    // åˆ†ç±»åˆ†å¸ƒ
    final categoryBreakdown = _calculateCategoryBreakdown(transactions);

    // æ”¯å‡ºè¶‹åŠ¿
    final spendingTrend = _calculateSpendingTrend(transactions, period);

    // é¢„ç®—çŠ¶æ€
    final budgetStatuses = await _getBudgetStatuses(ledgerId, period);

    // å¾…å¤„ç†åˆ†æ‘Š
    final pendingSplits = await _getPendingSplits(ledgerId);

    return FamilyDashboardData(
      ledgerId: ledgerId,
      period: period,
      summary: summary,
      memberContributions: memberContributions,
      categoryBreakdown: categoryBreakdown,
      spendingTrend: spendingTrend,
      budgetStatuses: budgetStatuses,
      pendingSplits: pendingSplits,
    );
  }

  FamilySummary _calculateSummary(List<FamilyTransaction> transactions) {
    double totalIncome = 0;
    double totalExpense = 0;

    for (final t in transactions) {
      if (t.type == TransactionType.income) {
        totalIncome += t.amount;
      } else {
        totalExpense += t.amount;
      }
    }

    final netSavings = totalIncome - totalExpense;
    final savingsRate = totalIncome > 0 ? netSavings / totalIncome * 100 : 0;

    // è®¡ç®—æ—¥å‡ï¼ˆå‡è®¾ä¸€ä¸ªæœˆ30å¤©ï¼‰
    final avgDailyExpense = totalExpense / 30;

    return FamilySummary(
      totalIncome: totalIncome,
      totalExpense: totalExpense,
      netSavings: netSavings,
      savingsRate: savingsRate,
      transactionCount: transactions.length,
      avgDailyExpense: avgDailyExpense,
    );
  }

  List<MemberContribution> _calculateMemberContributions(
    List<FamilyTransaction> transactions,
    List<LedgerMember> members,
  ) {
    final contributions = <String, MemberContribution>{};

    // åˆå§‹åŒ–æ‰€æœ‰æˆå‘˜
    for (final member in members) {
      contributions[member.userId] = MemberContribution(
        memberId: member.userId,
        memberName: member.displayName,
        avatarUrl: member.avatarUrl,
        income: 0,
        expense: 0,
        transactionCount: 0,
        contributionPercentage: 0,
        topCategories: [],
      );
    }

    // ç»Ÿè®¡å„æˆå‘˜æ•°æ®
    final memberCategorySpend = <String, Map<String, double>>{};

    for (final t in transactions) {
      final current = contributions[t.createdBy];
      if (current == null) continue;

      final categorySpend = memberCategorySpend[t.createdBy] ?? {};

      if (t.type == TransactionType.income) {
        contributions[t.createdBy] = MemberContribution(
          memberId: current.memberId,
          memberName: current.memberName,
          avatarUrl: current.avatarUrl,
          income: current.income + t.amount,
          expense: current.expense,
          transactionCount: current.transactionCount + 1,
          contributionPercentage: 0,
          topCategories: current.topCategories,
        );
      } else {
        categorySpend[t.categoryId] = (categorySpend[t.categoryId] ?? 0) + t.amount;
        memberCategorySpend[t.createdBy] = categorySpend;

        contributions[t.createdBy] = MemberContribution(
          memberId: current.memberId,
          memberName: current.memberName,
          avatarUrl: current.avatarUrl,
          income: current.income,
          expense: current.expense + t.amount,
          transactionCount: current.transactionCount + 1,
          contributionPercentage: 0,
          topCategories: current.topCategories,
        );
      }
    }

    // è®¡ç®—å æ¯”å’ŒTopåˆ†ç±»
    final totalExpense = contributions.values.fold(0.0, (sum, c) => sum + c.expense);

    return contributions.values.map((c) {
      final categorySpend = memberCategorySpend[c.memberId] ?? {};
      final sortedCategories = categorySpend.entries.toList()
        ..sort((a, b) => b.value.compareTo(a.value));
      final topCategories = sortedCategories.take(3).map((e) => e.key).toList();

      return MemberContribution(
        memberId: c.memberId,
        memberName: c.memberName,
        avatarUrl: c.avatarUrl,
        income: c.income,
        expense: c.expense,
        transactionCount: c.transactionCount,
        contributionPercentage: totalExpense > 0 ? c.expense / totalExpense * 100 : 0,
        topCategories: topCategories,
      );
    }).toList()
      ..sort((a, b) => b.expense.compareTo(a.expense));
  }

  // ... å…¶ä»–è¾…åŠ©æ–¹æ³•
}
```

### 13.6 å®¶åº­ç›®æ ‡ä¸æ¿€åŠ±

#### 13.6.1 å…±åŒå‚¨è“„ç›®æ ‡

```dart
/// å®¶åº­å‚¨è“„ç›®æ ‡
class FamilySavingsGoal {
  final String id;
  final String ledgerId;
  final String name;
  final String? emoji;
  final double targetAmount;
  final double currentAmount;
  final DateTime? deadline;
  final List<GoalContributor> contributors;
  final GoalStatus status;

  FamilySavingsGoal({
    required this.id,
    required this.ledgerId,
    required this.name,
    this.emoji,
    required this.targetAmount,
    required this.currentAmount,
    this.deadline,
    required this.contributors,
    required this.status,
  });

  double get progressPercentage =>
      targetAmount > 0 ? currentAmount / targetAmount * 100 : 0;

  int? get daysRemaining =>
      deadline?.difference(DateTime.now()).inDays;
}

/// ç›®æ ‡è´¡çŒ®è€…
class GoalContributor {
  final String memberId;
  final String memberName;
  final double contribution;
  final double percentage;

  GoalContributor({
    required this.memberId,
    required this.memberName,
    required this.contribution,
    required this.percentage,
  });
}

/// å®¶åº­ç›®æ ‡æœåŠ¡
class FamilyGoalService {
  final FamilyGoalRepository _repository;
  final NotificationService _notificationService;
  final LedgerService _ledgerService;

  /// åˆ›å»ºå®¶åº­ç›®æ ‡
  Future<FamilySavingsGoal> createGoal({
    required String ledgerId,
    required String name,
    required double targetAmount,
    String? emoji,
    DateTime? deadline,
  }) async {
    final goal = FamilySavingsGoal(
      id: generateUuid(),
      ledgerId: ledgerId,
      name: name,
      emoji: emoji ?? 'ğŸ¯',
      targetAmount: targetAmount,
      currentAmount: 0,
      deadline: deadline,
      contributors: [],
      status: GoalStatus.active,
    );

    await _repository.create(goal);

    // ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘é€šè¿‡å…¨å±€é€šçŸ¥æ§åˆ¶å™¨å‘é€ï¼Œé¿å…é€šçŸ¥è½°ç‚¸
    // å‚è€ƒç¬¬28.7èŠ‚ GlobalNotificationController
    final ledger = await _ledgerService.getLedger(ledgerId);
    for (final member in ledger.members) {
      // ä½¿ç”¨å…¨å±€æ§åˆ¶å™¨ï¼Œç¡®ä¿ä¸è¶…è¿‡æ¯æ—¥é€šçŸ¥ä¸Šé™
      await GlobalNotificationController.requestNotification(
        userId: member.userId,
        type: NotificationType.familyActivity,
        payload: {
          'subType': 'goalCreated',
          'goalName': name,
          'targetAmount': targetAmount,
          'message': '${AuthService().currentUserName}åˆ›å»ºäº†æ–°ç›®æ ‡ã€Œ$nameã€ï¼Œä¸€èµ·åŠªåŠ›å§ï¼',
        },
      );
    }

    return goal;
  }

  /// è´¡çŒ®é‡‘é¢
  Future<void> contribute({
    required String goalId,
    required double amount,
  }) async {
    final goal = await _repository.getById(goalId);
    if (goal == null) return;

    final userId = AuthService().currentUserId;
    await _repository.addContribution(goalId, userId, amount);

    // æ£€æŸ¥æ˜¯å¦è¾¾æˆç›®æ ‡
    final newAmount = goal.currentAmount + amount;
    if (newAmount >= goal.targetAmount) {
      await _celebrateGoalAchieved(goal);
    }
  }

  /// åº†ç¥ç›®æ ‡è¾¾æˆ
  Future<void> _celebrateGoalAchieved(FamilySavingsGoal goal) async {
    await _repository.updateStatus(goal.id, GoalStatus.achieved);

    final ledger = await _ledgerService.getLedger(goal.ledgerId);
    for (final member in ledger.members) {
      await _notificationService.send(
        member.userId,
        NotificationType.goalAchieved,
        {
          'goalName': goal.name,
          'targetAmount': goal.targetAmount,
          'emoji': goal.emoji,
        },
      );
    }
  }
}

enum GoalStatus {
  active,
  achieved,
  cancelled,
}
```

#### 13.6.2 å®¶åº­æ’è¡Œæ¦œä¸æ¿€åŠ±

```dart
/// ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘å®¶åº­è´¡çŒ®å±•ç¤ºï¼ˆéç«äº‰æ€§è®¾è®¡ï¼‰
/// è®¾è®¡åŸåˆ™ï¼šå±•ç¤ºå›¢é˜Ÿæˆå°±è€Œéä¸ªäººæ’åï¼Œé¿å…å®¶åº­æˆå‘˜é—´äº§ç”Ÿç„¦è™‘
/// å‚è€ƒç¬¬4ç« 4.6.1èŠ‚"ä¸å¯¹æ¯”ç”¨æˆ·ä¸ä»–äººçš„æ¶ˆè´¹"åŸåˆ™
class FamilyContributionDisplay {
  final String ledgerId;
  final String period;
  final FamilyTeamStats teamStats;              // å›¢é˜Ÿæ•´ä½“æ•°æ®
  final List<MemberContribution> contributions; // æˆå‘˜è´¡çŒ®ï¼ˆä¸æ’åï¼‰
  final List<AchievementBadge> recentAchievements;  // è¿‘æœŸæˆå°±
  final String encouragementMessage;            // ä¼™ä¼´åŒ–é¼“åŠ±è¯­

  FamilyContributionDisplay({
    required this.ledgerId,
    required this.period,
    required this.teamStats,
    required this.contributions,
    required this.recentAchievements,
    required this.encouragementMessage,
  });
}

/// å›¢é˜Ÿæ•´ä½“ç»Ÿè®¡ï¼ˆå¼ºè°ƒé›†ä½“æˆå°±ï¼‰
class FamilyTeamStats {
  final double totalSavings;        // å®¶åº­æ€»å‚¨è“„
  final int totalRecordDays;        // å®¶åº­ç´¯è®¡è®°è´¦å¤©æ•°
  final double budgetComplianceRate; // å®¶åº­é¢„ç®—è¾¾æˆç‡
  final int goalsAchieved;          // å·²è¾¾æˆç›®æ ‡æ•°

  FamilyTeamStats({
    required this.totalSavings,
    required this.totalRecordDays,
    required this.budgetComplianceRate,
    required this.goalsAchieved,
  });

  /// ç”Ÿæˆå›¢é˜Ÿé¼“åŠ±æ–‡æ¡ˆ
  String generateEncouragement() {
    if (budgetComplianceRate >= 0.9) {
      return 'å¤ªæ£’äº†ï¼å…¨å®¶ä¸€èµ·å®ˆä½äº†é¢„ç®— ğŸ‰';
    } else if (goalsAchieved > 0) {
      return 'æ­å–œï¼åˆä¸€ä¸ªå®¶åº­ç›®æ ‡è¾¾æˆäº† âœ¨';
    } else {
      return 'ä¸€å®¶äººé½å¿ƒååŠ›ï¼Œè´¢åŠ¡è¶Šæ¥è¶Šå¥åº· ğŸ’ª';
    }
  }
}

/// æˆå‘˜è´¡çŒ®å±•ç¤ºï¼ˆæ— æ’åï¼Œå¹³ç­‰å±•ç¤ºï¼‰
/// ã€æ— éšœç¢è®¾è®¡ã€‘å‚è€ƒç¬¬5ç« ï¼Œæ‰€æœ‰è§†è§‰å…ƒç´ éƒ½æœ‰è¯­ä¹‰æ ‡ç­¾
class MemberContribution {
  final String memberId;
  final String memberName;
  final String? avatarUrl;
  final double contributionValue;
  final String contributionLabel;   // å¦‚ "æœ¬æœˆè®°å½•äº†32ç¬”"
  final String? personalHighlight;  // ä¸ªäººäº®ç‚¹ï¼Œå¦‚ "è¿ç»­è®°è´¦7å¤©"
  final String appreciationNote;    // æ„Ÿè°¢è¯­ï¼Œå¦‚ "æ„Ÿè°¢ä½ çš„åšæŒï¼"

  MemberContribution({
    required this.memberId,
    required this.memberName,
    this.avatarUrl,
    required this.contributionValue,
    required this.contributionLabel,
    this.personalHighlight,
    required this.appreciationNote,
  });

  /// ã€æ— éšœç¢ã€‘å¤´åƒè¯­ä¹‰æ ‡ç­¾ï¼ˆä¾›å±å¹•é˜…è¯»å™¨ä½¿ç”¨ï¼‰
  String get avatarSemanticLabel => '$memberNameçš„å¤´åƒ';

  /// ã€æ— éšœç¢ã€‘å®Œæ•´è¯­ä¹‰æè¿°ï¼ˆä¾›å±å¹•é˜…è¯»å™¨æœ—è¯»ï¼‰
  String get fullSemanticDescription {
    final parts = <String>[memberName, contributionLabel];
    if (personalHighlight != null) {
      parts.add(personalHighlight!);
    }
    parts.add(appreciationNote);
    return parts.join('ï¼Œ');
  }
}

/// ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘è´¡çŒ®å±•ç¤ºæœåŠ¡
class FamilyContributionService {
  /// ç”Ÿæˆæˆå‘˜æ„Ÿè°¢è¯­ï¼ˆæ¯ä¸ªæˆå‘˜éƒ½æœ‰ç‹¬ç‰¹çš„æ­£é¢è¯„ä»·ï¼‰
  static String generateAppreciation(MemberStats stats) {
    if (stats.recordDays >= 20) {
      return 'è®°è´¦å°è¾¾äººï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼';
    } else if (stats.savingsContribution > 0) {
      return 'ä¸ºå®¶åº­å‚¨è“„è´¡çŒ®äº†åŠ›é‡ ğŸ’°';
    } else if (stats.isNewMember) {
      return 'æ¬¢è¿åŠ å…¥ï¼ä¸€èµ·åŠ æ²¹å§ ğŸŒŸ';
    } else {
      return 'æ„Ÿè°¢ä½ çš„å‚ä¸ï¼';
    }
  }

  /// ç”Ÿæˆä¸ªäººäº®ç‚¹ï¼ˆæ‰¾å‡ºæ¯ä¸ªäººçš„é—ªå…‰ç‚¹ï¼‰
  static String? findPersonalHighlight(MemberStats stats) {
    if (stats.streakDays >= 7) {
      return 'è¿ç»­è®°è´¦${stats.streakDays}å¤©';
    } else if (stats.budgetCompliance >= 0.95) {
      return 'é¢„ç®—æ§åˆ¶å¾ˆæ£’';
    } else if (stats.categoriesUsed >= 5) {
      return 'è®°è´¦å¾ˆç»†è‡´';
    }
    return null;
  }
}

/// æˆå°±å¾½ç« 
class AchievementBadge {
  final String id;
  final String name;
  final String description;
  final String emoji;
  final String memberId;
  final String memberName;
  final DateTime earnedAt;

  AchievementBadge({
    required this.id,
    required this.name,
    required this.description,
    required this.emoji,
    required this.memberId,
    required this.memberName,
    required this.earnedAt,
  });
}

/// å®¶åº­æ’è¡Œæ¦œæœåŠ¡
class FamilyLeaderboardService {
  final TransactionRepository _transactionRepository;
  final FamilyBudgetService _budgetService;

  /// è·å–å®¶åº­æ’è¡Œæ¦œ
  Future<FamilyLeaderboard> getLeaderboard({
    required String ledgerId,
    required String period,
  }) async {
    // å‚¨è“„æ’è¡Œ
    final savingsRanking = await _calculateSavingsRanking(ledgerId, period);

    // è®°è´¦å‹¤å¥‹åº¦æ’è¡Œ
    final recordingRanking = await _calculateRecordingRanking(ledgerId, period);

    // é¢„ç®—éµå®ˆåº¦æ’è¡Œ
    final budgetCompliance = await _calculateBudgetCompliance(ledgerId, period);

    // è¿‘æœŸæˆå°±
    final recentAchievements = await _getRecentAchievements(ledgerId);

    return FamilyLeaderboard(
      ledgerId: ledgerId,
      period: period,
      savingsRanking: savingsRanking,
      recordingRanking: recordingRanking,
      budgetCompliance: budgetCompliance,
      recentAchievements: recentAchievements,
    );
  }

  /// é¢„å®šä¹‰çš„å®¶åº­æˆå°±
  static const familyAchievements = [
    {'id': 'first_family_record', 'name': 'å®¶åº­é¦–è´¦', 'emoji': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§'},
    {'id': 'savings_champion', 'name': 'å‚¨è“„å† å†›', 'emoji': 'ğŸ†'},
    {'id': 'budget_master', 'name': 'é¢„ç®—è¾¾äºº', 'emoji': 'ğŸ“Š'},
    {'id': 'recording_streak_7', 'name': 'è¿ç»­è®°è´¦7å¤©', 'emoji': 'ğŸ”¥'},
    {'id': 'goal_contributor', 'name': 'ç›®æ ‡è´¡çŒ®è€…', 'emoji': 'ğŸ¯'},
    {'id': 'family_saver', 'name': 'å®¶åº­ç†è´¢å¸ˆ', 'emoji': 'ğŸ’°'},
  ];

  // ... è¾…åŠ©æ–¹æ³•å®ç°
}
```

### 13.7 æ•°æ®åŒæ­¥ä¸å†²çªå¤„ç†

#### 13.7.1 å®æ—¶åŒæ­¥æœºåˆ¶

```dart
/// å®¶åº­è´¦æœ¬åŒæ­¥æœåŠ¡
class FamilyLedgerSyncService {
  final WebSocketService _wsService;
  final LocalDatabase _localDb;
  final ConflictResolver _conflictResolver;

  final StreamController<SyncEvent> _syncEvents = StreamController.broadcast();
  Stream<SyncEvent> get syncEvents => _syncEvents.stream;

  /// å¯åŠ¨è´¦æœ¬åŒæ­¥
  Future<void> startSync(String ledgerId) async {
    // å»ºç«‹WebSocketè¿æ¥
    await _wsService.connect('/ledger/$ledgerId/sync');

    // ç›‘å¬è¿œç¨‹å˜æ›´
    _wsService.onMessage.listen((message) {
      _handleRemoteChange(message);
    });

    // ç›‘å¬æœ¬åœ°å˜æ›´
    _localDb.watchChanges(ledgerId).listen((change) {
      _pushLocalChange(ledgerId, change);
    });
  }

  /// å¤„ç†è¿œç¨‹å˜æ›´
  Future<void> _handleRemoteChange(SyncMessage message) async {
    switch (message.type) {
      case SyncMessageType.transactionCreated:
        await _handleTransactionCreated(message.data);
        break;
      case SyncMessageType.transactionUpdated:
        await _handleTransactionUpdated(message.data);
        break;
      case SyncMessageType.transactionDeleted:
        await _handleTransactionDeleted(message.data);
        break;
      case SyncMessageType.memberJoined:
        await _handleMemberJoined(message.data);
        break;
      case SyncMessageType.budgetUpdated:
        await _handleBudgetUpdated(message.data);
        break;
    }

    _syncEvents.add(SyncEvent(
      type: SyncEventType.remoteChange,
      message: message,
    ));
  }

  /// æ¨é€æœ¬åœ°å˜æ›´
  Future<void> _pushLocalChange(String ledgerId, LocalChange change) async {
    try {
      await _wsService.send(SyncMessage(
        type: _mapChangeType(change.type),
        data: change.data,
        timestamp: DateTime.now(),
        clientId: DeviceInfo.deviceId,
      ));
    } catch (e) {
      // ç¦»çº¿æ—¶æš‚å­˜å˜æ›´
      await _localDb.queuePendingSync(change);
    }
  }

  /// å¤„ç†å†²çª
  Future<void> _handleConflict(
    LocalChange local,
    SyncMessage remote,
  ) async {
    final resolution = await _conflictResolver.resolve(local, remote);

    switch (resolution.strategy) {
      case ConflictStrategy.keepLocal:
        await _pushLocalChange(local.ledgerId, local);
        break;
      case ConflictStrategy.keepRemote:
        await _localDb.applyRemoteChange(remote);
        break;
      case ConflictStrategy.merge:
        await _localDb.applyMergedChange(resolution.mergedData);
        await _pushLocalChange(local.ledgerId, LocalChange(
          type: local.type,
          data: resolution.mergedData,
        ));
        break;
      case ConflictStrategy.askUser:
        _syncEvents.add(SyncEvent(
          type: SyncEventType.conflictDetected,
          conflict: ConflictInfo(local: local, remote: remote),
        ));
        break;
    }
  }
}

/// å†²çªè§£å†³å™¨
class ConflictResolver {
  /// è§£å†³å†²çª
  Future<ConflictResolution> resolve(
    LocalChange local,
    SyncMessage remote,
  ) async {
    // æ—¶é—´æˆ³æ¯”è¾ƒï¼šåè€…ä¼˜å…ˆ
    if (remote.timestamp.isAfter(local.timestamp)) {
      return ConflictResolution(strategy: ConflictStrategy.keepRemote);
    }

    // å¦‚æœæ˜¯åŒä¸€ç”¨æˆ·çš„å˜æ›´ï¼Œä¿ç•™æœ¬åœ°
    if (remote.data['userId'] == AuthService().currentUserId) {
      return ConflictResolution(strategy: ConflictStrategy.keepLocal);
    }

    // å°è¯•è‡ªåŠ¨åˆå¹¶ï¼ˆå¦‚é‡‘é¢ä¿®æ”¹ï¼‰
    if (_canAutoMerge(local, remote)) {
      final merged = _autoMerge(local.data, remote.data);
      return ConflictResolution(
        strategy: ConflictStrategy.merge,
        mergedData: merged,
      );
    }

    // æ— æ³•è‡ªåŠ¨è§£å†³ï¼Œè¯¢é—®ç”¨æˆ·
    return ConflictResolution(strategy: ConflictStrategy.askUser);
  }

  bool _canAutoMerge(LocalChange local, SyncMessage remote) {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨åˆå¹¶
    // ä¾‹å¦‚ï¼šä¸åŒå­—æ®µçš„ä¿®æ”¹å¯ä»¥åˆå¹¶
    final localFields = local.data['modifiedFields'] as Set<String>?;
    final remoteFields = remote.data['modifiedFields'] as Set<String>?;

    if (localFields == null || remoteFields == null) return false;

    // å¦‚æœä¿®æ”¹çš„æ˜¯ä¸åŒå­—æ®µï¼Œå¯ä»¥åˆå¹¶
    return localFields.intersection(remoteFields).isEmpty;
  }

  Map<String, dynamic> _autoMerge(
    Map<String, dynamic> local,
    Map<String, dynamic> remote,
  ) {
    final merged = Map<String, dynamic>.from(remote);
    final localFields = local['modifiedFields'] as Set<String>;

    for (final field in localFields) {
      merged[field] = local[field];
    }

    return merged;
  }
}

enum ConflictStrategy {
  keepLocal,
  keepRemote,
  merge,
  askUser,
}

class ConflictResolution {
  final ConflictStrategy strategy;
  final Map<String, dynamic>? mergedData;

  ConflictResolution({
    required this.strategy,
    this.mergedData,
  });
}
```

### 13.8 éšç§ä¸å®‰å…¨

#### 13.8.1 å®¶åº­è´¦æœ¬éšç§è®¾è®¡

```dart
/// å®¶åº­éšç§è®¾ç½®
class FamilyPrivacySettings {
  final bool allowMembersToSeeEachOther;  // æˆå‘˜äº’ç›¸å¯è§
  final bool showMemberBalance;           // æ˜¾ç¤ºæˆå‘˜ä½™é¢
  final bool showMemberIncome;            // æ˜¾ç¤ºæˆå‘˜æ”¶å…¥
  final bool allowExportByMembers;        // å…è®¸æˆå‘˜å¯¼å‡ºæ•°æ®
  final List<String> hiddenCategories;    // å¯¹æ™®é€šæˆå‘˜éšè—çš„åˆ†ç±»

  FamilyPrivacySettings({
    this.allowMembersToSeeEachOther = true,
    this.showMemberBalance = false,
    this.showMemberIncome = false,
    this.allowExportByMembers = false,
    this.hiddenCategories = const [],
  });
}

/// æ•æ„Ÿäº¤æ˜“ä¿æŠ¤
class SensitiveTransactionGuard {
  /// æ£€æŸ¥äº¤æ˜“æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
  bool isSensitive(Transaction transaction) {
    // æ£€æŸ¥åˆ†ç±»
    if (_sensitiveCategories.contains(transaction.categoryId)) {
      return true;
    }

    // æ£€æŸ¥æè¿°ä¸­çš„æ•æ„Ÿè¯
    if (_containsSensitiveWords(transaction.description)) {
      return true;
    }

    // æ£€æŸ¥é‡‘é¢æ˜¯å¦å¼‚å¸¸å¤§
    if (transaction.amount > _largeAmountThreshold) {
      return true;
    }

    return false;
  }

  static const _sensitiveCategories = [
    'medical',      // åŒ»ç–—
    'gift_private', // ç§äººç¤¼ç‰©
    'investment',   // æŠ•èµ„
  ];

  static const _sensitiveWords = [
    'ç¤¼ç‰©', 'æƒŠå–œ', 'ç§˜å¯†', 'ç§äºº',
  ];

  static const _largeAmountThreshold = 10000.0;

  bool _containsSensitiveWords(String? text) {
    if (text == null) return false;
    return _sensitiveWords.any((word) => text.contains(word));
  }
}
```

### 13.9 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 13.9.0 æ— éšœç¢è®¾è®¡é›†æˆ

> ğŸ“ **å‚è€ƒç« èŠ‚**ï¼šæ— éšœç¢è®¾è®¡è§„èŒƒè¯¦è§[ç¬¬5ç«  æ— éšœç¢è®¾è®¡](#5-æ— éšœç¢è®¾è®¡)

å®¶åº­è´¦æœ¬æ¨¡å—çš„æ— éšœç¢å®ç°è¦ç‚¹ï¼š

| ç»„ä»¶ | æ— éšœç¢è¦æ±‚ | å®ç°æ–¹å¼ |
|------|-----------|---------|
| æˆå‘˜å¤´åƒ | æ›¿ä»£æ–‡æœ¬ | `avatarSemanticLabel` å±æ€§ |
| é‚€è¯·åŠŸèƒ½ | å¤šç§æ–¹å¼ | äºŒç»´ç +é“¾æ¥+è¯­éŸ³ç +é€šè®¯å½• |
| è´¡çŒ®å±•ç¤º | å±å¹•é˜…è¯»å™¨æ”¯æŒ | `fullSemanticDescription` |
| è§’è‰²åˆ‡æ¢ | æ¸…æ™°åé¦ˆ | è¯­ä¹‰åŒ–é€šçŸ¥æ¶ˆæ¯ |
| åˆ†æ‘Šè¯·æ±‚ | è§¦æ§ç›®æ ‡ | â‰¥48x48åƒç´ æŒ‰é’® |

```dart
/// ã€æ— éšœç¢ã€‘å®¶åº­è´¦æœ¬æ— éšœç¢é…ç½®
class FamilyLedgerAccessibilityConfig {
  /// ç¡®ä¿æ‰€æœ‰äº¤äº’å…ƒç´ ç¬¦åˆWCAG 2.1 AAæ ‡å‡†
  static const wcagLevel = WcagLevel.aa;

  /// æˆå‘˜åˆ—è¡¨é¡¹è¯­ä¹‰åŒ–
  static String getMemberItemSemantics(LedgerMember member) {
    return '${member.displayName}ï¼Œè§’è‰²ï¼š${member.role.localizedName}ï¼Œ'
           '${member.isOnline ? "åœ¨çº¿" : "ç¦»çº¿"}';
  }

  /// é‚€è¯·æŒ‰é’®è¯­ä¹‰åŒ–
  static const inviteButtonSemantics = 'é‚€è¯·æ–°æˆå‘˜åŠ å…¥è´¦æœ¬ï¼Œ'
      'æ”¯æŒäºŒç»´ç ã€é“¾æ¥ã€è¯­éŸ³ç ç­‰å¤šç§æ–¹å¼';
}
```

#### 13.9.1 ä¸å…¨å±€é€šçŸ¥æ§åˆ¶å™¨çš„å¯¹æ¥

> ğŸ“ **é‡è¦**ï¼šå®¶åº­è´¦æœ¬çš„æ‰€æœ‰é€šçŸ¥å¿…é¡»é€šè¿‡ç¬¬28.7èŠ‚çš„`GlobalNotificationController`å‘é€ï¼Œä»¥ç¡®ä¿ï¼š
> - ç”¨æˆ·æ¯æ—¥æ”¶åˆ°çš„é€šçŸ¥ä¸è¶…è¿‡8æ¡
> - ä½ä¼˜å…ˆçº§é€šçŸ¥ï¼ˆå¦‚å®¶åº­åŠ¨æ€ï¼‰æ¯å¤©æœ€å¤š3æ¡
> - é«˜ä¼˜å…ˆçº§é€šçŸ¥ï¼ˆå¦‚åˆ†æ‘Šè¯·æ±‚ï¼‰ä¼˜å…ˆå‘é€

```dart
/// ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘å®¶åº­è´¦æœ¬é€šçŸ¥é…ç½®
class FamilyLedgerNotificationConfig {
  /// å®¶åº­è´¦æœ¬ç›¸å…³é€šçŸ¥çš„ä¼˜å…ˆçº§é…ç½®
  static const notificationPriorities = {
    'splitRequest': NotificationPriority.high,     // åˆ†æ‘Šè¯·æ±‚ - é«˜ä¼˜å…ˆçº§
    'goalAchieved': NotificationPriority.medium,   // ç›®æ ‡è¾¾æˆ - ä¸­ä¼˜å…ˆçº§
    'memberJoined': NotificationPriority.medium,   // æˆå‘˜åŠ å…¥ - ä¸­ä¼˜å…ˆçº§
    'goalCreated': NotificationPriority.low,       // ç›®æ ‡åˆ›å»º - ä½ä¼˜å…ˆçº§
    'transactionAdded': NotificationPriority.low,  // æ–°äº¤æ˜“ - ä½ä¼˜å…ˆçº§
    'monthlyReport': NotificationPriority.low,     // æœˆåº¦æŠ¥å‘Š - ä½ä¼˜å…ˆçº§
  };

  /// å®¶åº­é€šçŸ¥çš„ä¼™ä¼´åŒ–æ–‡æ¡ˆæ¨¡æ¿
  static const companionMessages = {
    'memberJoined': '{memberName}åŠ å…¥äº†å®¶åº­è´¦æœ¬ï¼Œå¤§å®¶ä¸€èµ·æ¬¢è¿taå§ï¼ğŸ‰',
    'goalAchieved': 'å¤ªæ£’äº†ï¼å…¨å®¶ä¸€èµ·å®Œæˆäº†ã€Œ{goalName}ã€ç›®æ ‡ ğŸŠ',
    'splitRequest': '{memberName}å‘èµ·äº†ä¸€ç¬”åˆ†æ‘Šï¼Œè®°å¾—ç¡®è®¤å“¦~',
  };
}
```

#### 13.9.1 é›†æˆç‚¹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¶åº­è´¦æœ¬ç³»ç»Ÿé›†æˆç‚¹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚
â”‚  â”‚ å®¶åº­è´¦æœ¬ç³»ç»Ÿ â”‚                                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚         â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                          é›†æˆæ¥å£å±‚                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ è´¦æœ¬ä¸Šä¸‹æ–‡ â”‚ â”‚ æˆå‘˜ä¸Šä¸‹æ–‡â”‚ â”‚ æƒé™æ£€æŸ¥  â”‚ â”‚ æ•°æ®è¿‡æ»¤  â”‚ â”‚ é€šçŸ¥åˆ†å‘  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚           â”‚           â”‚           â”‚           â”‚                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                              æ ¸å¿ƒä¸šåŠ¡é›†æˆ                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚         â”‚           â”‚           â”‚           â”‚           â”‚                    â”‚
â”‚         â–¼           â–¼           â–¼           â–¼           â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  é’±é¾„ç³»ç»Ÿ â”‚ â”‚  é¢„ç®—ç³»ç»Ÿ â”‚ â”‚ ä¹ æƒ¯åŸ¹å…»  â”‚ â”‚ æ•°æ®å¯è§†åŒ–â”‚ â”‚ AIè¯†åˆ«   â”‚          â”‚
â”‚  â”‚  (ç¬¬7ç« ) â”‚ â”‚  (ç¬¬8ç« ) â”‚ â”‚ (ç¬¬9ç« )  â”‚ â”‚  (ç¬¬12ç« )â”‚ â”‚ (ç¬¬10ç« ) â”‚          â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚
â”‚  â”‚ å®¶åº­é’±é¾„  â”‚ â”‚ å®¶åº­é¢„ç®—  â”‚ â”‚ å…±åŒç›®æ ‡  â”‚ â”‚ æˆå‘˜å¯¹æ¯”  â”‚ â”‚ ç¥¨æ®åˆ†æ‘Š  â”‚          â”‚
â”‚  â”‚ ç»Ÿè®¡æ±‡æ€»  â”‚ â”‚ æˆå‘˜é…é¢  â”‚ â”‚ æ’è¡Œæ¦œ    â”‚ â”‚ å®¶åº­æŠ¥è¡¨  â”‚ â”‚ æ™ºèƒ½è¯†åˆ«  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                           2.0æ–°å¢æ¨¡å—é›†æˆ                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ è¯­éŸ³äº¤äº’  â”‚ â”‚ è‡ªå­¦ä¹    â”‚ â”‚ ä½ç½®æ™ºèƒ½  â”‚ â”‚ ä¼™ä¼´åŒ–   â”‚ â”‚ ç”¨æˆ·å¢é•¿  â”‚          â”‚
â”‚  â”‚ (ç¬¬18ç« ) â”‚ â”‚ (ç¬¬17ç« ) â”‚ â”‚ (ç¬¬14ç« ) â”‚ â”‚ (ç¬¬4ç« )  â”‚ â”‚(ç¬¬28-29ç« )â”‚          â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚
â”‚  â”‚"å®¶åº­æ¶ˆè´¹ â”‚ â”‚ å®¶åº­æ¶ˆè´¹  â”‚ â”‚ æˆå‘˜ä½ç½®  â”‚ â”‚ å®¶åº­äº’åŠ¨  â”‚ â”‚ å®¶åº­è£‚å˜  â”‚          â”‚
â”‚  â”‚ æŸ¥è¯¢"    â”‚ â”‚ æ¨¡å¼å­¦ä¹   â”‚ â”‚ å…±äº«æ¶ˆè´¹  â”‚ â”‚ é¼“åŠ±æ–‡æ¡ˆ  â”‚ â”‚ é‚€è¯·æ¿€åŠ±  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚  ğŸ’¡ å®¶åº­è´¦æœ¬ä½œä¸ºåä½œå…¥å£ï¼Œä¸æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å’Œ2.0æ–°å¢æ¨¡å—æ·±åº¦é›†æˆ                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 13.9.2 ä¸è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆï¼ˆç¬¬18ç« ï¼‰

```dart
/// å®¶åº­è´¦æœ¬è¯­éŸ³äº¤äº’æœåŠ¡
class FamilyLedgerVoiceService {
  final LedgerContext _ledgerContext;
  final VoiceIntentHandler _intentHandler;

  /// æ”¯æŒçš„å®¶åº­è´¦æœ¬è¯­éŸ³æ„å›¾
  static const supportedIntents = [
    VoiceIntent(
      pattern: '(å®¶åº­|å…¨å®¶)(è¿™ä¸ªæœˆ|æœ¬æœˆ)?(èŠ±äº†|æ¶ˆè´¹äº†|æ”¯å‡º)(å¤šå°‘|å‡ )(é’±)?',
      action: 'queryFamilyExpense',
      example: 'å®¶åº­è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘é’±',
    ),
    VoiceIntent(
      pattern: '(æŸ¥çœ‹|çœ‹çœ‹)?(.+)(èŠ±äº†|æ¶ˆè´¹äº†)(å¤šå°‘)?',
      action: 'queryMemberExpense',
      example: 'è€å…¬èŠ±äº†å¤šå°‘',
    ),
    VoiceIntent(
      pattern: '(ï¿½ï¿½ä¸€ç¬”|æ·»åŠ )(å®¶åº­|å…±åŒ)(æ”¯å‡º|æ¶ˆè´¹)',
      action: 'addFamilyTransaction',
      example: 'è®°ä¸€ç¬”å®¶åº­æ”¯å‡º',
    ),
    VoiceIntent(
      pattern: '(å‘èµ·|åˆ›å»º)(åˆ†æ‘Š|AA)',
      action: 'createSplit',
      example: 'å‘èµ·åˆ†æ‘Š',
    ),
    VoiceIntent(
      pattern: '(é‚€è¯·|æ·»åŠ )(.+)(åŠ å…¥|è¿›å…¥)è´¦æœ¬',
      action: 'inviteMember',
      example: 'é‚€è¯·å¦ˆå¦ˆåŠ å…¥è´¦æœ¬',
    ),
  ];

  /// å¤„ç†å®¶åº­æ¶ˆè´¹æŸ¥è¯¢
  Future<VoiceResponse> handleFamilyExpenseQuery(VoiceQuery query) async {
    final ledger = _ledgerContext.currentLedger;
    if (ledger == null || !ledger.isShared) {
      return VoiceResponse(
        text: 'æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºå®¶åº­è´¦æœ¬å“¦ï¼Œè¦ç°åœ¨åˆ›å»ºä¸€ä¸ªå—ï¼Ÿ',
        action: VoiceAction.askConfirmation,
      );
    }

    final stats = await _getFamilyStats(ledger.id, query.timeRange);
    return VoiceResponse(
      text: '${ledger.name}${query.timeRangeText}å…±æ”¯å‡º${stats.totalExpense.toStringAsFixed(0)}å…ƒï¼Œ'
            'å…¶ä¸­${stats.topSpender}æ¶ˆè´¹æœ€å¤šï¼ŒèŠ±äº†${stats.topSpenderAmount.toStringAsFixed(0)}å…ƒã€‚',
      data: stats,
    );
  }

  /// å¤„ç†æˆå‘˜æ¶ˆè´¹æŸ¥è¯¢
  Future<VoiceResponse> handleMemberExpenseQuery(
    String memberName,
    DateRange timeRange,
  ) async {
    final member = await _findMemberByName(memberName);
    if (member == null) {
      return VoiceResponse(
        text: 'æ²¡æœ‰æ‰¾åˆ°å«"$memberName"çš„å®¶åº­æˆå‘˜ï¼Œè¯·æ£€æŸ¥åå­—æ˜¯å¦æ­£ç¡®ã€‚',
      );
    }

    final stats = await _getMemberStats(member.id, timeRange);
    return VoiceResponse(
      text: '${member.displayName}${timeRange.description}æ¶ˆè´¹äº†${stats.totalExpense.toStringAsFixed(0)}å…ƒï¼Œ'
            'ä¸»è¦èŠ±åœ¨${stats.topCategory}ä¸Šã€‚',
      data: stats,
    );
  }
}
```

#### 13.9.3 ä¸è‡ªå­¦ä¹ ç³»ç»Ÿé›†æˆï¼ˆç¬¬17ç« ï¼‰

```dart
/// å®¶åº­æ¶ˆè´¹æ¨¡å¼å­¦ä¹ æœåŠ¡
class FamilyConsumptionLearningService {
  final SelfLearningFramework _learningFramework;

  /// å­¦ä¹ å®¶åº­æ¶ˆè´¹æ¨¡å¼
  Future<void> learnFamilyPatterns(String ledgerId) async {
    // å­¦ä¹ å®¶åº­æ•´ä½“æ¶ˆè´¹æ¨¡å¼
    await _learningFramework.learn(
      domain: 'family_consumption',
      context: {'ledgerId': ledgerId},
      features: [
        'weekly_pattern',      // å‘¨æ¶ˆè´¹æ¨¡å¼ï¼ˆå‘¨æœ«vså·¥ä½œæ—¥ï¼‰
        'member_contribution', // æˆå‘˜è´¡çŒ®æ¯”ä¾‹
        'category_preference', // å®¶åº­åˆ†ç±»åå¥½
        'split_frequency',     // åˆ†æ‘Šé¢‘ç‡
      ],
    );
  }

  /// è·å–å®¶åº­é¢„ç®—æ™ºèƒ½å»ºè®®
  Future<FamilyBudgetSuggestion> suggestFamilyBudget({
    required String ledgerId,
    required String period,
  }) async {
    final patterns = await _learningFramework.getPatterns(
      domain: 'family_consumption',
      context: {'ledgerId': ledgerId},
    );

    return FamilyBudgetSuggestion(
      totalBudget: patterns.predictedMonthlyExpense * 1.1, // é¢„ç•™10%å¼¹æ€§
      memberAllocations: patterns.memberContributionRatios,
      categoryAllocations: patterns.categoryPreferences,
      confidence: patterns.confidence,
      explanation: 'åŸºäºè¿‡å»${patterns.dataMonths}ä¸ªæœˆçš„å®¶åº­æ¶ˆè´¹æ•°æ®ï¼Œ'
                   'é¢„è®¡æœ¬æœˆæ”¯å‡º${patterns.predictedMonthlyExpense.toStringAsFixed(0)}å…ƒã€‚',
    );
  }

  /// å­¦ä¹ æˆå‘˜åˆ†æ‘Šåå¥½
  Future<SplitPreference> learnSplitPreference(String ledgerId) async {
    final history = await _getSplitHistory(ledgerId);
    return SplitPreference(
      preferredMethod: history.mostUsedMethod,      // æœ€å¸¸ç”¨åˆ†æ‘Šæ–¹å¼
      defaultRatios: history.averageRatios,         // é»˜è®¤åˆ†æ‘Šæ¯”ä¾‹
      frequentCategories: history.frequentCategories, // å¸¸åˆ†æ‘Šçš„åˆ†ç±»
    );
  }
}
```

#### 13.9.4 ä¸ä½ç½®æ™ºèƒ½ç³»ç»Ÿé›†æˆï¼ˆç¬¬14ç« ï¼‰

```dart
/// å®¶åº­ä½ç½®æ™ºèƒ½æœåŠ¡
class FamilyLocationService {
  final LocationService _locationService;
  final LedgerContext _ledgerContext;

  /// å®¶åº­æˆå‘˜ä½ç½®å…±äº«ï¼ˆéœ€è¦æˆå‘˜æˆæƒï¼‰
  Stream<List<MemberLocation>> watchFamilyLocations(String ledgerId) {
    return _locationService.watchMemberLocations(
      ledgerId: ledgerId,
      filter: (member) => member.locationSharingEnabled,
    );
  }

  /// æ™ºèƒ½åˆ†æ‘Šå»ºè®®ï¼ˆåŸºäºä½ç½®ï¼‰
  Future<SplitSuggestion> suggestSplitByLocation({
    required Transaction transaction,
  }) async {
    if (transaction.location == null) return SplitSuggestion.none();

    // æŸ¥æ‰¾åŒæ—¶åœ¨åœºçš„å®¶åº­æˆå‘˜
    final nearbyMembers = await _findNearbyMembers(
      location: transaction.location!,
      timeWindow: Duration(minutes: 30),
    );

    if (nearbyMembers.length <= 1) return SplitSuggestion.none();

    return SplitSuggestion(
      members: nearbyMembers,
      method: SplitMethod.equal,
      reason: 'æ£€æµ‹åˆ°${nearbyMembers.length}ä½å®¶åº­ï¿½ï¿½å‘˜åœ¨é™„è¿‘ï¼Œæ˜¯å¦åˆ†æ‘Šè¿™ç¬”æ¶ˆè´¹ï¼Ÿ',
      confidence: 0.8,
    );
  }

  /// å®¶åº­æ¶ˆè´¹åœ°ç‚¹çƒ­åŠ›å›¾
  Future<FamilyLocationHeatmap> getFamilyHeatmap({
    required String ledgerId,
    required DateRange timeRange,
  }) async {
    final transactions = await _getTransactionsWithLocation(ledgerId, timeRange);
    return FamilyLocationHeatmap.fromTransactions(
      transactions: transactions,
      groupBy: (tx) => tx.memberId, // æŒ‰æˆå‘˜åˆ†ç»„
    );
  }
}
```

#### 13.9.5 ä¸ç”¨æˆ·å¢é•¿ç³»ç»Ÿé›†æˆï¼ˆç¬¬28-29ç« ï¼‰

```dart
/// å®¶åº­è£‚å˜å¢é•¿æœåŠ¡
class FamilyGrowthService {
  final GrowthTracker _growthTracker;
  final InviteService _inviteService;

  /// å®¶åº­é‚€è¯·æ¿€åŠ±æœºåˆ¶
  static const inviteRewards = {
    1: InviteReward(points: 100, badge: 'family_starter'),
    3: InviteReward(points: 300, badge: 'family_builder'),
    5: InviteReward(points: 500, badge: 'family_master', premiumDays: 7),
  };

  /// å¤„ç†å®¶åº­é‚€è¯·æˆåŠŸ
  Future<void> onFamilyInviteSuccess({
    required String inviterId,
    required String inviteeId,
    required String ledgerId,
  }) async {
    // è®°å½•é‚€è¯·æˆåŠŸ
    await _growthTracker.trackEvent(
      event: 'family_invite_success',
      properties: {
        'inviter_id': inviterId,
        'invitee_id': inviteeId,
        'ledger_id': ledgerId,
      },
    );

    // å‘æ”¾é‚€è¯·å¥–åŠ±
    final inviteCount = await _inviteService.getInviteCount(inviterId);
    final reward = inviteRewards[inviteCount];
    if (reward != null) {
      await _grantReward(inviterId, reward);
    }

    // è§¦å‘ä¼™ä¼´åŒ–åº†ç¥
    await _triggerCompanionCelebration(inviterId, inviteeId);
  }

  /// ç”Ÿæˆå®¶åº­åˆ†äº«å¡ç‰‡
  Future<ShareCard> generateFamilyShareCard({
    required String ledgerId,
    required String period,
  }) async {
    final stats = await _getFamilyStats(ledgerId, period);
    return ShareCard(
      type: ShareCardType.familyReport,
      title: 'æˆ‘ä»¬å®¶çš„è´¢åŠ¡å¥åº·æŠ¥å‘Š',
      subtitle: '$period å®¶åº­æ¶ˆè´¹æ€»è§ˆ',
      stats: [
        StatItem('æ€»æ”¯å‡º', 'Â¥${stats.totalExpense.toStringAsFixed(0)}'),
        StatItem('äººå‡', 'Â¥${stats.perMemberExpense.toStringAsFixed(0)}'),
        StatItem('æœ€å¤§åˆ†ç±»', stats.topCategory),
      ],
      cta: 'ä¸€èµ·æ¥è®°è´¦å§ï¼',
      inviteCode: await _inviteService.generateCode(ledgerId),
    );
  }
}
```

#### 13.9.6 ç»Ÿä¸€è´¦æœ¬ä¸Šä¸‹æ–‡

```dart
/// è´¦æœ¬ä¸Šä¸‹æ–‡ - å…¨å±€å¯ç”¨ï¼Œç¡®å®šå½“å‰æ“ä½œçš„è´¦æœ¬å’Œæƒé™
class LedgerContext {
  static final LedgerContext _instance = LedgerContext._internal();
  factory LedgerContext() => _instance;
  LedgerContext._internal();

  final LedgerService _ledgerService = LedgerService();

  /// å½“å‰è´¦æœ¬
  Ledger? get currentLedger => _ledgerService.currentLedger.value;

  /// å½“å‰ç”¨æˆ·åœ¨å½“å‰è´¦æœ¬çš„è§’è‰²
  MemberRole? get currentUserRole {
    final userId = AuthService().currentUserId;
    return currentLedger?.members
        .firstWhereOrNull((m) => m.userId == userId)
        ?.role;
  }

  /// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
  bool hasPermission(LedgerPermission permission) {
    return currentUserRole?.hasPermission(permission) ?? false;
  }

  /// æ˜¯å¦ä¸ºå…±äº«è´¦æœ¬
  bool get isSharedLedger => currentLedger?.isShared ?? false;

  /// è·å–å½“å‰è´¦æœ¬çš„æ‰€æœ‰æˆå‘˜
  List<LedgerMember> get members => currentLedger?.members ?? [];

  /// ç›‘å¬è´¦æœ¬å˜åŒ–
  Stream<Ledger?> get ledgerChanges =>
      _ledgerService.currentLedger.asStream();
}

/// è´¦æœ¬æ„ŸçŸ¥çš„æœåŠ¡åŸºç±»
abstract class LedgerAwareService {
  LedgerContext get ledgerContext => LedgerContext();

  /// ç¡®ä¿æœ‰æƒé™æ‰§è¡Œæ“ä½œ
  void ensurePermission(LedgerPermission permission) {
    if (!ledgerContext.hasPermission(permission)) {
      throw NoPermissionException();
    }
  }

  /// è·å–å½“å‰è´¦æœ¬ID
  String get currentLedgerId {
    final ledger = ledgerContext.currentLedger;
    if (ledger == null) throw NoActiveLedgerException();
    return ledger.id;
  }
}
```

### 13.10 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// å®¶åº­è´¦æœ¬ç›®æ ‡æ£€æµ‹æœåŠ¡
class FamilyLedgerGoalChecker implements GoalChecker {
  final LedgerService _ledgerService;
  final FamilyBudgetService _budgetService;
  final FamilyGoalService _goalService;

  @override
  String get goalId => 'family_ledger_effectiveness';

  @override
  Future<GoalCheckResult> check() async {
    final checks = <GoalCheckItem>[];

    // æ£€æŸ¥1ï¼šå®¶åº­è´¦æœ¬åˆ›å»ºç‡
    final familyLedgers = await _ledgerService.getFamilyLedgers();
    checks.add(GoalCheckItem(
      name: 'å®¶åº­è´¦æœ¬æ•°',
      target: '>= 1',
      actual: '${familyLedgers.length}',
      passed: familyLedgers.isNotEmpty,
    ));

    // æ£€æŸ¥2ï¼šæˆå‘˜æ´»è·ƒåº¦
    for (final ledger in familyLedgers) {
      final activeMembers = await _getActiveMembers(ledger.id);
      checks.add(GoalCheckItem(
        name: '${ledger.name} æ´»è·ƒæˆå‘˜',
        target: '>= 2',
        actual: '$activeMembers',
        passed: activeMembers >= 2,
      ));
    }

    // æ£€æŸ¥3ï¼šé¢„ç®—éµå®ˆç‡
    final budgetCompliance = await _budgetService.getAverageCompliance();
    checks.add(GoalCheckItem(
      name: 'å®¶åº­é¢„ç®—éµå®ˆç‡',
      target: '>= 80%',
      actual: '${budgetCompliance.toStringAsFixed(1)}%',
      passed: budgetCompliance >= 80,
    ));

    // æ£€æŸ¥4ï¼šå…±åŒç›®æ ‡è¾¾æˆç‡
    final goalAchievementRate = await _goalService.getAchievementRate();
    checks.add(GoalCheckItem(
      name: 'å…±åŒç›®æ ‡è¾¾æˆç‡',
      target: '>= 70%',
      actual: '${goalAchievementRate.toStringAsFixed(1)}%',
      passed: goalAchievementRate >= 70,
    ));

    return GoalCheckResult(
      goalId: goalId,
      passed: checks.every((c) => c.passed),
      items: checks,
      checkedAt: DateTime.now(),
    );
  }

  Future<int> _getActiveMembers(String ledgerId) async {
    // ç»Ÿè®¡è¿‡å»30å¤©æœ‰è®°è´¦è¡Œä¸ºçš„æˆå‘˜æ•°
    // ...å®ç°ç•¥
    return 0;
  }
}
```



## 14. åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨

### 14.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥ä½ç½®æ™ºèƒ½åŒ–ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åœ°ç†ä½ç½®æ™ºèƒ½åŒ– - è®¾è®¡åŸåˆ™çŸ©é˜µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  éšç§ä¼˜å…ˆ    â”‚  â”‚  æœ¬åœ°å¤„ç†    â”‚  â”‚  æ™ºèƒ½å¢å¼º    â”‚  â”‚  åœºæ™¯æ„ŸçŸ¥    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æœ€å°åŒ–é‡‡é›†  â”‚  â”‚ ç¦»çº¿å¯ç”¨    â”‚  â”‚ POIåŒ¹é…     â”‚  â”‚ æ¶ˆè´¹åœºæ™¯    â”‚       â”‚
â”‚  â”‚ ç”¨æˆ·å¯æ§    â”‚  â”‚ æœ¬åœ°ç¼“å­˜    â”‚  â”‚ åŒºåŸŸåˆ†æ    â”‚  â”‚ è¡Œä¸ºç†è§£    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ç²¾å‡†é¢„ç®—    â”‚  â”‚  é’±é¾„ä¼˜åŒ–    â”‚  â”‚  çœé’±å»ºè®®    â”‚  â”‚  é£é™©é¢„è­¦    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æœ¬åœ°åŒ–ç±»ç›®  â”‚  â”‚ åœºæ™¯åˆ†ç¦»    â”‚  â”‚ é€šå‹¤ä¼˜åŒ–    â”‚  â”‚ å¼‚åœ°æ£€æµ‹    â”‚       â”‚
â”‚  â”‚ åŸå¸‚å·®å¼‚    â”‚  â”‚ å¼‚åœ°è¯†åˆ«    â”‚  â”‚ æœ¬åœ°ä¼˜æƒ     â”‚  â”‚ æµ·å¤–æ¶ˆè´¹    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  ä½ç½®æ™ºèƒ½åŒ–æ ¸å¿ƒç†å¿µï¼š                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "éšç§è‡³ä¸Šï¼Œæœ¬åœ°ä¼˜å…ˆï¼Œåœºæ™¯æ„ŸçŸ¥ï¼Œæ™ºèƒ½å¢å¼º"                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   éšç§è‡³ä¸Š â”€â”€â†’ æœ€å°åŒ–é‡‡é›†ï¼Œç”¨æˆ·å®Œå…¨å¯æ§ï¼Œè‡ªåŠ¨æ¸…ç†                      â”‚   â”‚
â”‚  â”‚   æœ¬åœ°ä¼˜å…ˆ â”€â”€â†’ ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨ï¼Œç¦»çº¿POIåŒ¹é…                       â”‚   â”‚
â”‚  â”‚   åœºæ™¯æ„ŸçŸ¥ â”€â”€â†’ æ™ºèƒ½è¯†åˆ«æ¶ˆè´¹åœºæ™¯ï¼ˆå•†åœˆ/é€šå‹¤/å®¶é™„è¿‘ï¼‰                    â”‚   â”‚
â”‚  â”‚   æ™ºèƒ½å¢å¼º â”€â”€â†’ ä½ç½®ä¿¡æ¯å¢å¼ºé¢„ç®—ã€é’±é¾„ã€çœé’±å»ºè®®                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.0.1 è®¾è®¡åŸåˆ™åœ¨ä½ç½®æ™ºèƒ½ä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | ä½ç½®åº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|---------|---------|---------|
| **éšç§ä¼˜å…ˆ** | æœ€å°åŒ–é‡‡é›† | ä»…éœ€è¦æ—¶è·å–ä½ç½®ï¼Œç²¾åº¦åˆ†çº§ï¼Œè‡ªåŠ¨æ¸…ç† | ç”¨æˆ·æŠ•è¯‰ç‡<0.1% |
| **æœ¬åœ°å¤„ç†** | ç¦»çº¿å¯ç”¨ | POIæœ¬åœ°ç¼“å­˜ï¼Œåœºæ™¯è¯†åˆ«æœ¬åœ°è¿è¡Œ | ç¦»çº¿è¯†åˆ«ç‡>80% |
| **æ™ºèƒ½å¢å¼º** | åœºæ™¯åˆ†æ | å•†åœˆ/é€šå‹¤/å®¶é™„è¿‘è‡ªåŠ¨è¯†åˆ« | åœºæ™¯å‡†ç¡®ç‡>90% |
| **ç²¾å‡†é¢„ç®—** | æœ¬åœ°åŒ–æ¨è | åŸå¸‚çº§åˆ«å·®å¼‚åŒ–ç±»ç›®å’Œé‡‘é¢ | é¢„ç®—åˆç†æ€§æå‡30% |
| **é’±é¾„ä¼˜åŒ–** | åœºæ™¯åˆ†ç¦» | å¼‚åœ°æ¶ˆè´¹ä¸å½±å“æœ¬åœ°é’±é¾„è¯„ä¼° | é’±é¾„å‡†ç¡®æ€§æå‡25% |
| **é£é™©é¢„è­¦** | å¼‚å¸¸æ£€æµ‹ | å¼‚åœ°/æµ·å¤–æ¶ˆè´¹å®æ—¶é¢„è­¦ | é£é™©è¯†åˆ«ç‡>95% |

#### 14.0.2 ä¸å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä½ç½®æ™ºèƒ½åŒ–ä¸å…¶ä»–æ¨¡å—çš„ååŒå…³ç³»                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   14. ä½ç½®æ™ºèƒ½åŒ–         â”‚                         â”‚
â”‚                        â”‚       ï¼ˆæœ¬ç« ï¼‰           â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                    â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â–¼                           â–¼                           â–¼           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ 7.é’±é¾„   â”‚              â”‚ 8.é¢„ç®—   â”‚              â”‚ 10.AI    â”‚        â”‚
â”‚   â”‚  ç³»ç»Ÿ    â”‚              â”‚  ç³»ç»Ÿ    â”‚              â”‚  è¯†åˆ«    â”‚        â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚        â”‚
â”‚   â”‚ åœºæ™¯åˆ†ç¦» â”‚              â”‚ æœ¬åœ°åŒ–   â”‚              â”‚ åœºæ™¯ä¸Šä¸‹ â”‚        â”‚
â”‚   â”‚ å¼‚åœ°è¯†åˆ« â”‚              â”‚ ç±»ç›®æ¨è â”‚              â”‚ æ–‡å¢å¼º   â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â–¼                                       â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   12. æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–   â”‚                         â”‚
â”‚                        â”‚   - ä½ç½®çƒ­åŠ›å›¾          â”‚                         â”‚
â”‚                        â”‚   - åŒºåŸŸæ¶ˆè´¹åˆ†æ        â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                           2.0æ–°å¢åä½œæ¨¡å—                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚18.è¯­éŸ³   â”‚  â”‚17.è‡ªå­¦ä¹  â”‚  â”‚13.å®¶åº­   â”‚  â”‚9.ä¹ æƒ¯    â”‚  â”‚21.å®‰å…¨   â”‚   â”‚
â”‚   â”‚  äº¤äº’    â”‚  â”‚  ç³»ç»Ÿ    â”‚  â”‚  è´¦æœ¬    â”‚  â”‚  åŸ¹å…»    â”‚  â”‚  éšç§    â”‚   â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚   â”‚"é™„è¿‘æœ‰  â”‚  â”‚ä½ç½®æ¶ˆè´¹  â”‚  â”‚æˆå‘˜ä½ç½®  â”‚  â”‚ä½ç½®æ‰“å¡  â”‚  â”‚ä½ç½®æ•°æ®  â”‚   â”‚
â”‚   â”‚ ä¼˜æƒ å—" â”‚  â”‚æ¨¡å¼å­¦ä¹   â”‚  â”‚å…±äº«åä½œ  â”‚  â”‚ä¹ æƒ¯å…»æˆ  â”‚  â”‚éšç§ä¿æŠ¤  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.0.3 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// ç¬¬14ç« è®¾è®¡ç›®æ ‡è¾¾æˆæ£€æµ‹
class Chapter14GoalChecker {
  /// æ£€æŸ¥ä½ç½®æ™ºèƒ½åŒ–è®¾è®¡ç›®æ ‡æ˜¯å¦è¾¾æˆ
  static Future<GoalCheckResult> checkGoals() async {
    final results = <GoalCheck>[];

    // 1. éšç§ä¿æŠ¤ç›®æ ‡
    results.add(GoalCheck(
      goal: 'ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨',
      checker: () => LocationPrivacyService.isEncryptionEnabled(),
      requirement: 'å¿…é¡»å¯ç”¨AES-256åŠ å¯†',
    ));

    // 2. ç¦»çº¿å¯ç”¨ç›®æ ‡
    results.add(GoalCheck(
      goal: 'ç¦»çº¿POIåŒ¹é…å¯ç”¨',
      checker: () => OfflinePoiService.hasLocalCache(),
      requirement: 'æœ¬åœ°ç¼“å­˜>1000ä¸ªå¸¸ç”¨POI',
    ));

    // 3. åœºæ™¯è¯†åˆ«å‡†ç¡®ç‡
    results.add(GoalCheck(
      goal: 'åœºæ™¯è¯†åˆ«å‡†ç¡®ç‡>90%',
      checker: () async {
        final stats = await LocationAnalytics.getAccuracyStats();
        return stats.sceneAccuracy >= 0.90;
      },
      requirement: 'å•†åœˆ/é€šå‹¤/å®¶é™„è¿‘è¯†åˆ«å‡†ç¡®',
    ));

    // 4. ä½ç½®é¢„ç®—åº”ç”¨
    results.add(GoalCheck(
      goal: 'æœ¬åœ°åŒ–é¢„ç®—æ¨è',
      checker: () => LocationBudgetService.hasCityLevelRecommendation(),
      requirement: 'æ”¯æŒåŸå¸‚çº§åˆ«å·®å¼‚åŒ–æ¨è',
    ));

    // 5. é’±é¾„å¢å¼ºåº”ç”¨
    results.add(GoalCheck(
      goal: 'ä½ç½®æ„ŸçŸ¥é’±é¾„è®¡ç®—',
      checker: () => MoneyAgeService.hasLocationAwareness(),
      requirement: 'å¼‚åœ°æ¶ˆè´¹åœºæ™¯åˆ†ç¦»',
    ));

    return GoalCheckResult(checks: results);
  }
}
```

### 14.1 åœ°ç†ä½ç½®æ™ºèƒ½åŒ–æ€»è§ˆ

#### 14.1.1 ç« èŠ‚å®šä½ä¸è®¾è®¡ç›®æ ‡

åœ°ç†ä½ç½®ä¿¡æ¯æ˜¯æå‡é›¶åŸºé¢„ç®—ç²¾å‡†åº¦ã€ä¼˜åŒ–é’±é¾„è®¡ç®—åˆç†æ€§ã€å¢å¼ºç†è´¢ä½“éªŒä¸ªæ€§åŒ–çš„å…³é”®èƒ½åŠ›ã€‚æœ¬ç« è¯¦ç»†è®¾è®¡åœ°ç†ä½ç½®åœ¨æ™ºèƒ½è®°è´¦ä¸­çš„åº”ç”¨æ–¹æ¡ˆã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¬¬14ç«  åœ°ç†ä½ç½®æ™ºèƒ½åŒ–åº”ç”¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€ç« èŠ‚å®šä½ã€‘                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚   ä½ç½®æ•°æ® â”€â”€â†’ åœºæ™¯åˆ†æ â”€â”€â†’ æ™ºèƒ½å†³ç­–                                     â”‚
â”‚      â”‚            â”‚            â”‚                                         â”‚
â”‚      â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”     â”‚                                         â”‚
â”‚      â”‚     â”‚  ç¬¬14ç« èŒè´£  â”‚     â”‚                                         â”‚
â”‚      â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚                                         â”‚
â”‚      â”‚     â”‚â€¢ ä½ç½®é‡‡é›†    â”‚     â”‚                                         â”‚
â”‚      â”‚     â”‚â€¢ åœºæ™¯è¯†åˆ«    â”‚     â”‚                                         â”‚
â”‚      â”‚     â”‚â€¢ åŒºåŸŸåˆ†æ    â”‚     â”‚                                         â”‚
â”‚      â”‚     â”‚â€¢ é’±é¾„å¢å¼º    â”‚     â”‚                                         â”‚
â”‚      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                                         â”‚
â”‚      â”‚                         â”‚                                         â”‚
â”‚      â–¼                         â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ ç¬¬10ç«   â”‚              â”‚ ç¬¬7ç«   â”‚                                      â”‚
â”‚  â”‚AIè¯†åˆ«  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚é’±é¾„ç³»ç»Ÿâ”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   åœºæ™¯ä¸Šä¸‹æ–‡  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                          â”‚
â”‚  ã€æ ¸å¿ƒä»·å€¼ã€‘                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  ç²¾å‡†é¢„ç®—        â”‚ â”‚  é’±é¾„ä¼˜åŒ–        â”‚ â”‚  ä¸ªæ€§å»ºè®®        â”‚            â”‚
â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚            â”‚
â”‚  â”‚ æœ¬åœ°åŒ–ç±»ç›®æ¨è   â”‚ â”‚ åˆ†ç¦»å¼‚åœ°æ¶ˆè´¹    â”‚ â”‚ ä½ç½®çœé’±å»ºè®®    â”‚            â”‚
â”‚  â”‚ åŸå¸‚çº§åˆ«å·®å¼‚    â”‚ â”‚ åœºæ™¯æƒé‡è°ƒæ•´    â”‚ â”‚ å›´æ é¢„ç®—æé†’    â”‚            â”‚
â”‚  â”‚ æ™ºèƒ½é‡‘é¢æµ‹ç®—    â”‚ â”‚ åˆšéœ€æ”¯å‡ºè¯†åˆ«    â”‚ â”‚ é£é™©æ™ºèƒ½é¢„è­¦    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â”‚  ã€éšç§ä¿æŠ¤åŸåˆ™ã€‘                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  âœ“ æœ€å°åŒ–é‡‡é›†ï¼šä»…åœ¨éœ€è¦æ—¶è·å–ä½ç½®                                        â”‚
â”‚  âœ“ æœ¬åœ°ä¼˜å…ˆï¼šä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨                                        â”‚
â”‚  âœ“ é€æ˜æˆæƒï¼šæ˜ç¡®å‘ŠçŸ¥ç”¨é€”ï¼Œç”¨æˆ·å¯æ§                                      â”‚
â”‚  âœ“ ç”Ÿå‘½å‘¨æœŸï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸè½¨è¿¹æ•°æ®                                        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.1.2 æ ¸å¿ƒèƒ½åŠ›æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä½ç½®æ™ºèƒ½åŒ–æ ¸å¿ƒèƒ½åŠ›                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                          â”‚   ç”¨æˆ·è®°è´¦è¡Œä¸º   â”‚                             â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â–¼              â–¼              â–¼                       â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚             â”‚ è¯­éŸ³è¾“å…¥  â”‚   â”‚ å›¾ç‰‡è¯†åˆ«  â”‚   â”‚ æ‰‹åŠ¨å½•å…¥  â”‚                  â”‚
â”‚             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                  â”‚              â”‚              â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                 â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ä½ç½®æ„ŸçŸ¥ä¸­é—´ä»¶                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ä½ç½®é‡‡é›†   â”‚  POIåŒ¹é…   â”‚  åœºæ™¯è¯†åˆ«   â”‚  éšç§ä¿æŠ¤è¿‡æ»¤      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                        â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â–¼                      â–¼                      â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  é¢„ç®—æ™ºèƒ½    â”‚       â”‚  é’±é¾„å¢å¼º   â”‚        â”‚  çœé’±å¼•æ“   â”‚          â”‚
â”‚   â”‚             â”‚       â”‚             â”‚        â”‚             â”‚          â”‚
â”‚   â”‚â€¢ æœ¬åœ°åŒ–ç±»ç›® â”‚       â”‚â€¢ åœºæ™¯åˆ†ç¦»   â”‚        â”‚â€¢ é€šå‹¤ä¼˜åŒ–   â”‚          â”‚
â”‚   â”‚â€¢ é‡‘é¢å»ºè®®   â”‚       â”‚â€¢ æƒé‡è°ƒæ•´   â”‚        â”‚â€¢ é¤é¥®å»ºè®®   â”‚          â”‚
â”‚   â”‚â€¢ å›´æ æé†’   â”‚       â”‚â€¢ å¼‚åœ°è¯†åˆ«   â”‚        â”‚â€¢ æœ¬åœ°ä¼˜æƒ    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.1.3 æ•°æ®æµä¸ç”Ÿå‘½å‘¨æœŸ

```dart
/// ä½ç½®æ™ºèƒ½åŒ–ç³»ç»Ÿæ•°æ®æµ
///
/// ä½ç½®é‡‡é›† â†’ éšç§è¿‡æ»¤ â†’ åœºæ™¯åˆ†æ â†’ ä¸šåŠ¡åº”ç”¨ â†’ æ•°æ®æ¸…ç†
///
/// å„é˜¶æ®µèŒè´£ï¼š
/// 1. ä½ç½®é‡‡é›†ï¼šGPS/ç½‘ç»œå®šä½ï¼Œè·å–åŸå§‹åæ ‡
/// 2. éšç§è¿‡æ»¤ï¼šè„±æ•å¤„ç†ï¼Œæ§åˆ¶ç²¾åº¦çº§åˆ«
/// 3. åœºæ™¯åˆ†æï¼šPOIåŒ¹é…ï¼ŒåŒºåŸŸç±»å‹è¯†åˆ«
/// 4. ä¸šåŠ¡åº”ç”¨ï¼šé¢„ç®—å»ºè®®ï¼Œé’±é¾„è®¡ç®—ï¼Œçœé’±æç¤º
/// 5. æ•°æ®æ¸…ç†ï¼šå®šæœŸåˆ é™¤è¿‡æœŸè½¨è¿¹æ•°æ®

class LocationDataLifecycle {
  /// æ•°æ®æµå¤„ç†é˜¶æ®µ
  static const dataFlowStages = [
    'acquisition',   // ä½ç½®é‡‡é›†
    'privacy',       // éšç§è¿‡æ»¤
    'analysis',      // åœºæ™¯åˆ†æ
    'application',   // ä¸šåŠ¡åº”ç”¨
    'cleanup',       // æ•°æ®æ¸…ç†
  ];

  /// å„é˜¶æ®µæ•°æ®ä¿ç•™ç­–ç•¥
  static const dataRetentionPolicy = {
    'rawCoordinates': Duration(hours: 24),      // åŸå§‹åæ ‡ä»…ä¿ç•™24å°æ—¶
    'sceneContext': Duration(days: 30),         // åœºæ™¯ä¸Šä¸‹æ–‡ä¿ç•™30å¤©
    'aggregatedStats': Duration(days: 365),     // èšåˆç»Ÿè®¡ä¿ç•™1å¹´
    'anonymizedPatterns': Duration(days: 365),  // åŒ¿ååŒ–æ¨¡å¼ä¿ç•™1å¹´
  };
}
```

### 14.2 ä½ç½®æœåŠ¡åˆ†å±‚æ¶æ„

#### 14.2.1 å››å±‚æœåŠ¡ç»“æ„

ä¸ºé¿å…ç±»å‘½åæ··ä¹±å’ŒèŒè´£é‡å ï¼Œä½ç½®ç›¸å…³æœåŠ¡é‡‡ç”¨ä»¥ä¸‹å±‚æ¬¡ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬1å±‚ï¼šåŸºç¡€ä½ç½®æœåŠ¡ï¼ˆåº•å±‚èƒ½åŠ›ï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationService (abstract)  â† ä½ç½®è·å–æŠ½è±¡æ¥å£               â”‚ â”‚
â”‚  â”‚      â”‚                                                       â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ PreciseLocationService   â† GPSé«˜ç²¾åº¦å®šä½å®ç°         â”‚ â”‚
â”‚  â”‚      â””â”€â”€ ApproximateLocationService â† ç½‘ç»œç²—ç•¥å®šä½å®ç°        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬2å±‚ï¼šä½ç½®æ•°æ®æœåŠ¡ï¼ˆæ•°æ®ç®¡ç†ï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  UserHomeLocationService    â† ç®¡ç†ç”¨æˆ·å¸¸é©»åœ°ç‚¹ï¼ˆå®¶ã€å…¬å¸ï¼‰    â”‚ â”‚
â”‚  â”‚  CityLocationService        â† ç®¡ç†ç”¨æˆ·æ‰€åœ¨åŸå¸‚ä¿¡æ¯            â”‚ â”‚
â”‚  â”‚  LocationHistoryService     â† ç®¡ç†ä½ç½®å†å²è®°å½•                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬3å±‚ï¼šä¸šåŠ¡åˆ†ææœåŠ¡ï¼ˆæ™ºèƒ½åˆ†æï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  CrossRegionSpendingService  â† å¼‚åœ°æ¶ˆè´¹æ£€æµ‹                   â”‚ â”‚
â”‚  â”‚  SpendingContextAnalyzer     â† æ¶ˆè´¹åœºæ™¯åˆ†æ                   â”‚ â”‚
â”‚  â”‚  GeofenceAlertService        â† åœ°ç†å›´æ æé†’                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â†“ ä¾èµ–                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¬¬4å±‚ï¼šé’±é¾„å¢å¼ºæœåŠ¡ï¼ˆåŠŸèƒ½æ•´åˆï¼‰                                â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  LocationAwareMoneyAgeService  â† æ•´åˆå¼‚åœ°æ¶ˆè´¹çš„é’±é¾„è®¡ç®—       â”‚ â”‚
â”‚  â”‚      ï¼ˆä½¿ç”¨ CrossRegionSpendingServiceï¼‰                      â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  PreciseMoneyAgeCalculator     â† ç²¾ç¡®ä½ç½®çš„é’±é¾„è®¡ç®—           â”‚ â”‚
â”‚  â”‚      ï¼ˆä½¿ç”¨ SpendingContextAnalyzerï¼‰                         â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  æ³¨æ„ï¼šè¿™ä¸¤ä¸ªæœåŠ¡æ˜¯äº’è¡¥å…³ç³»ï¼Œä¸æ˜¯é‡å¤ï¼š                        â”‚ â”‚
â”‚  â”‚  - LocationAware: åŸå¸‚çº§åˆ«ï¼ŒåŒºåˆ†æœ¬åœ°/å¼‚åœ°                     â”‚ â”‚
â”‚  â”‚  - Precise: è¡—é“çº§åˆ«ï¼Œåˆ†ææ¶ˆè´¹åœºæ™¯                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.2.2 åŸºç¡€æœåŠ¡å®šä¹‰

```dart
/// ä½ç½®æœåŠ¡æŠ½è±¡æ¥å£
abstract class LocationService {
  /// è·å–å½“å‰ä½ç½®
  Future<Position?> getCurrentPosition();

  /// æ£€æŸ¥æƒé™çŠ¶æ€
  Future<LocationPermissionResult> checkPermission();

  /// è¯·æ±‚æƒé™
  Future<LocationPermissionResult> requestPermission();

  /// å¼€å§‹ä½ç½®ç›‘å¬
  Stream<Position> startLocationStream();

  /// åœæ­¢ä½ç½®ç›‘å¬
  void stopLocationStream();
}

/// ç”¨æˆ·å¸¸é©»åœ°ç‚¹ç®¡ç†æœåŠ¡
class UserHomeLocationService {
  final PreciseLocationService _locationService;
  final SharedPreferences _prefs;

  static const String _homeKey = 'user_home_location';
  static const String _workKey = 'user_work_location';
  static const String _frequentKey = 'user_frequent_locations';

  /// è·å–ç”¨æˆ·å®¶åº­ä½ç½®
  Future<PreciseLocation?> getHomeLocation() async {
    final json = _prefs.getString(_homeKey);
    if (json == null) return null;
    return PreciseLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å®¶åº­ä½ç½®
  Future<void> setHomeLocation(PreciseLocation location) async {
    await _prefs.setString(_homeKey, jsonEncode(location.toJson()));
  }

  /// è·å–ç”¨æˆ·å·¥ä½œä½ç½®
  Future<PreciseLocation?> getWorkLocation() async {
    final json = _prefs.getString(_workKey);
    if (json == null) return null;
    return PreciseLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å·¥ä½œä½ç½®
  Future<void> setWorkLocation(PreciseLocation location) async {
    await _prefs.setString(_workKey, jsonEncode(location.toJson()));
  }

  /// é€šè¿‡å½“å‰ä½ç½®è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®å®¶åº­ä½ç½®
  /// ç­–ç•¥ï¼šæ™šä¸Š10ç‚¹åˆ°æ—©ä¸Š7ç‚¹å¤šæ¬¡å‡ºç°çš„ä½ç½®åˆ¤å®šä¸ºå®¶
  Future<bool> autoDetectHomeLocation() async {
    final history = await _getRecentNightLocations();
    if (history.isEmpty) return false;

    final clustered = _clusterLocations(history, radiusMeters: 200);
    if (clustered.isEmpty) return false;

    // é€‰æ‹©å‡ºç°æ¬¡æ•°æœ€å¤šçš„ä½ç½®ç°‡
    final mostFrequent = clustered.reduce((a, b) =>
      a.count > b.count ? a : b);

    if (mostFrequent.count >= 5) {  // è‡³å°‘5æ¬¡
      await setHomeLocation(mostFrequent.center);
      return true;
    }
    return false;
  }

  /// é€šè¿‡å½“å‰ä½ç½®è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®å·¥ä½œä½ç½®
  /// ç­–ç•¥ï¼šå·¥ä½œæ—¥ä¸Šåˆ9ç‚¹åˆ°ä¸‹åˆ6ç‚¹å¤šæ¬¡å‡ºç°çš„ä½ç½®åˆ¤å®šä¸ºå…¬å¸
  Future<bool> autoDetectWorkLocation() async {
    final history = await _getRecentWorkdayLocations();
    if (history.isEmpty) return false;

    final clustered = _clusterLocations(history, radiusMeters: 300);
    if (clustered.isEmpty) return false;

    final mostFrequent = clustered.reduce((a, b) =>
      a.count > b.count ? a : b);

    // æ’é™¤å®¶é™„è¿‘çš„ä½ç½®
    final home = await getHomeLocation();
    if (home != null && mostFrequent.center.distanceTo(home) < 500) {
      // å¦‚æœæœ€é¢‘ç¹çš„ä½ç½®åœ¨å®¶é™„è¿‘ï¼Œé€‰æ‹©æ¬¡é¢‘ç¹çš„
      clustered.remove(mostFrequent);
      if (clustered.isEmpty) return false;
      final secondFrequent = clustered.reduce((a, b) =>
        a.count > b.count ? a : b);
      if (secondFrequent.count >= 3) {
        await setWorkLocation(secondFrequent.center);
        return true;
      }
      return false;
    }

    if (mostFrequent.count >= 3) {  // è‡³å°‘3æ¬¡
      await setWorkLocation(mostFrequent.center);
      return true;
    }
    return false;
  }

  /// è·å–ç”¨æˆ·å¸¸å»çš„åœ°ç‚¹åˆ—è¡¨
  Future<List<FrequentLocation>> getFrequentLocations() async {
    final json = _prefs.getString(_frequentKey);
    if (json == null) return [];
    final list = jsonDecode(json) as List;
    return list.map((e) => FrequentLocation.fromJson(e)).toList();
  }

  /// ä½ç½®èšç±»ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆDBSCANï¼‰
  List<LocationCluster> _clusterLocations(
    List<PreciseLocation> locations, {
    required double radiusMeters,
  }) {
    // å®ç°ç•¥...
    return [];
  }
}

/// ä½ç½®èšç±»ç»“æœ
class LocationCluster {
  final PreciseLocation center;
  final int count;
  final List<PreciseLocation> members;

  const LocationCluster({
    required this.center,
    required this.count,
    required this.members,
  });
}

/// å¸¸å»åœ°ç‚¹
class FrequentLocation {
  final String id;
  final String name;           // ç”¨æˆ·å‘½åæˆ–è‡ªåŠ¨è¯†åˆ«çš„åç§°
  final PreciseLocation location;
  final int visitCount;        // è®¿é—®æ¬¡æ•°
  final DateTime lastVisit;    // æœ€è¿‘è®¿é—®
  final LocationType type;     // åœ°ç‚¹ç±»å‹

  const FrequentLocation({
    required this.id,
    required this.name,
    required this.location,
    required this.visitCount,
    required this.lastVisit,
    required this.type,
  });

  factory FrequentLocation.fromJson(Map<String, dynamic> json) {
    return FrequentLocation(
      id: json['id'],
      name: json['name'],
      location: PreciseLocation.fromJson(json['location']),
      visitCount: json['visitCount'],
      lastVisit: DateTime.parse(json['lastVisit']),
      type: LocationType.values.byName(json['type']),
    );
  }
}

/// åœ°ç‚¹ç±»å‹
enum LocationType {
  home,       // å®¶
  work,       // å…¬å¸
  gym,        // å¥èº«æˆ¿
  supermarket,// è¶…å¸‚
  restaurant, // å¸¸å»é¤å…
  hospital,   // åŒ»é™¢
  school,     // å­¦æ ¡
  other,      // å…¶ä»–
}

/// åŸå¸‚ä½ç½®æœåŠ¡
class CityLocationService {
  final PreciseLocationService _locationService;
  final SharedPreferences _prefs;

  static const String _homeCityKey = 'user_home_city';

  /// è·å–ç”¨æˆ·å¸¸é©»åŸå¸‚
  Future<CityLocation?> getHomeCity() async {
    final json = _prefs.getString(_homeCityKey);
    if (json == null) return null;
    return CityLocation.fromJson(jsonDecode(json));
  }

  /// è®¾ç½®ç”¨æˆ·å¸¸é©»åŸå¸‚
  Future<void> setHomeCity(CityLocation city) async {
    await _prefs.setString(_homeCityKey, jsonEncode(city.toJson()));
  }

  /// ä»ç²¾ç¡®ä½ç½®æå–åŸå¸‚ä¿¡æ¯
  CityLocation extractCityFromLocation(PreciseLocation location) {
    return CityLocation(
      country: location.country,
      province: location.province,
      city: location.city,
      tier: location.cityTier,
      isOverseas: location.isOverseas,
    );
  }

  /// è·å–å½“å‰æ‰€åœ¨åŸå¸‚
  Future<CityLocation?> getCurrentCity() async {
    final location = await _locationService.getCurrentLocation();
    if (location == null) return null;
    return extractCityFromLocation(location);
  }
}

/// åŸå¸‚ä½ç½®ä¿¡æ¯ï¼ˆè½»é‡çº§ï¼Œç”¨äºåŸå¸‚çº§åˆ«åˆ¤æ–­ï¼‰
class CityLocation {
  final String country;
  final String province;
  final String city;
  final CityTier tier;
  final bool isOverseas;

  const CityLocation({
    required this.country,
    required this.province,
    required this.city,
    required this.tier,
    required this.isOverseas,
  });

  factory CityLocation.fromJson(Map<String, dynamic> json) {
    return CityLocation(
      country: json['country'],
      province: json['province'],
      city: json['city'],
      tier: CityTier.values.byName(json['tier']),
      isOverseas: json['isOverseas'],
    );
  }

  Map<String, dynamic> toJson() => {
    'country': country,
    'province': province,
    'city': city,
    'tier': tier.name,
    'isOverseas': isOverseas,
  };
}
```

#### 14.2.3 æœåŠ¡ä¾èµ–æ³¨å…¥

```dart
/// ä½ç½®æœåŠ¡ä¾èµ–æ³¨å…¥é…ç½®
class LocationServiceLocator {
  static final _instance = LocationServiceLocator._();
  factory LocationServiceLocator() => _instance;
  LocationServiceLocator._();

  late final PreciseLocationService preciseLocation;
  late final UserHomeLocationService userHome;
  late final CityLocationService cityLocation;
  late final CrossRegionSpendingService crossRegion;
  late final SpendingContextAnalyzer spendingContext;
  late final LocationAwareMoneyAgeService locationAwareMoneyAge;

  Future<void> initialize(SharedPreferences prefs) async {
    // ç¬¬1å±‚ï¼šåŸºç¡€å®šä½æœåŠ¡
    preciseLocation = PreciseLocationService();

    // ç¬¬2å±‚ï¼šä½ç½®æ•°æ®æœåŠ¡
    userHome = UserHomeLocationService(
      _locationService: preciseLocation,
      _prefs: prefs,
    );
    cityLocation = CityLocationService(
      _locationService: preciseLocation,
      _prefs: prefs,
    );

    // ç¬¬3å±‚ï¼šä¸šåŠ¡åˆ†ææœåŠ¡
    crossRegion = CrossRegionSpendingService(
      _locationService: cityLocation,  // ä½¿ç”¨åŸå¸‚çº§åˆ«æœåŠ¡
      _prefs: prefs,
    );
    spendingContext = SpendingContextAnalyzer(
      _locationService: preciseLocation,  // ä½¿ç”¨ç²¾ç¡®ä½ç½®æœåŠ¡
      _homeService: userHome,
    );

    // ç¬¬4å±‚ï¼šé’±é¾„å¢å¼ºæœåŠ¡
    locationAwareMoneyAge = LocationAwareMoneyAgeService(
      _crossRegionService: crossRegion,
      _baseCalculator: MoneyAgeCalculator(),
    );
  }
}
```

### 14.3 éšç§ä¼˜å…ˆè®¾è®¡åŸåˆ™

#### 14.3.1 ä½ç½®æ•°æ®æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åœ°ç†ä½ç½®ä¿¡æ¯ä¸‰å¤§ä»·å€¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼ä¸€ï¼šç²¾å‡†åŒ¹é…æœ¬åœ°åŒ–æ¶ˆè´¹åœºæ™¯ï¼Œä¼˜åŒ–é›¶åŸºé¢„ç®—ç±»ç›®åˆ†é…            â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨ç”Ÿæˆæœ¬åœ°åŒ–é¢„ç®—ç±»ç›®ï¼ˆä¸€çº¿åŸå¸‚ä¾§é‡æˆ¿ç§Ÿ/é€šå‹¤ï¼Œä¸‰çº¿ä¾§é‡é¤é¥®ï¼‰â”‚  â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½æµ‹ç®—ç±»ç›®é¢„ç®—é‡‘é¢ï¼ˆåŸºäºå½“åœ°æ¶ˆè´¹æ°´å¹³ï¼‰                     â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨è¯†åˆ«è·¨åŒºåŸŸæ¶ˆè´¹çš„é¢„ç®—å½’å±ï¼ˆå‡ºå·®/æ—…æ¸¸ï¼‰                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼äºŒï¼šä¼˜åŒ–é’±é¾„è®¡ç®—çš„å‡†ç¡®æ€§ï¼Œé¿å…å¼‚å¸¸æ•°æ®å¹²æ‰°                  â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ åŒºåˆ†"ä¸´æ—¶å¤§é¢æ”¯å‡º"ä¸"æ—¥å¸¸æ¶ˆè´¹"                              â”‚  â”‚
â”‚  â”‚  â€¢ è¯†åˆ«"è¢«åŠ¨åˆšéœ€"ä¸"ä¸»åŠ¨æ¶ˆè´¹"ï¼Œä¼˜åŒ–é’±é¾„æƒé‡                   â”‚  â”‚
â”‚  â”‚  â€¢ å¼‚åœ°æ¶ˆè´¹å¯å•ç‹¬ç»Ÿè®¡ï¼Œä¸å¹²æ‰°æ—¥å¸¸é’±é¾„                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä»·å€¼ä¸‰ï¼šå¢å¼ºç”¨æˆ·ç²˜æ€§ä¸ç†è´¢å†³ç­–çš„å®ç”¨æ€§                          â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  â€¢ æä¾›æœ¬åœ°åŒ–çœé’±å»ºè®®ï¼ŒåŠ©åŠ›é’±é¾„æå‡                             â”‚  â”‚
â”‚  â”‚  â€¢ é€‚é…æœ¬åœ°åŒ–æ”¶å…¥ä¸æ”¿ç­–ï¼Œä¼˜åŒ–é¢„ç®—è§„åˆ’                           â”‚  â”‚
â”‚  â”‚  â€¢ è§„é¿è·¨åŒºåŸŸè´¢åŠ¡é£é™©ï¼ˆæ±‡ç‡ã€æ‰‹ç»­è´¹ï¼‰                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.3.2 ç²¾ç¡®ä½ç½®èƒ½åŠ›è¯´æ˜

ç²¾ç¡®çš„ç»çº¬åº¦ä¿¡æ¯èƒ½å¤Ÿå®ç°ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼š

| èƒ½åŠ› | ç²¾ç¡®ä½ç½®å®ç° | åº”ç”¨åœºæ™¯ |
|------|-------------|----------|
| **å•†æˆ·çº§åˆ«è¯†åˆ«** | é€šè¿‡ç»çº¬åº¦åŒ¹é…POIæ•°æ®åº“ | è‡ªåŠ¨è¯†åˆ«æ¶ˆè´¹å•†å®¶ï¼Œæ™ºèƒ½åˆ†ç±» |
| **æ¶ˆè´¹åœºæ™¯åˆ†æ** | åŒºåˆ†å•†åœˆ/ç¤¾åŒº/åŠå…¬åŒºæ¶ˆè´¹ | è¯†åˆ«å·¥ä½œæ—¥åˆé¤vså‘¨æœ«èšé¤ |
| **é€šå‹¤è·¯å¾„è¿½è¸ª** | è®°å½•æ¯æ—¥å‡ºè¡Œè½¨è¿¹ | ç²¾ç¡®è®¡ç®—äº¤é€šæˆæœ¬ï¼Œä¼˜åŒ–é€šå‹¤é¢„ç®— |
| **æ¶ˆè´¹çƒ­åŠ›å›¾** | æ ‡è®°é«˜é¢‘æ¶ˆè´¹åœ°ç‚¹ | å‘ç°æ¶ˆè´¹ä¹ æƒ¯ï¼Œæä¾›çœé’±è·¯çº¿å»ºè®® |
| **æ™ºèƒ½å›´æ æé†’** | è¿›å…¥ç‰¹å®šåŒºåŸŸè§¦å‘æé†’ | è´­ç‰©ä¸­å¿ƒé¢„ç®—æé†’ã€ä¼˜æƒ åˆ¸ä½¿ç”¨æé†’ |
| **è·¨åŒºåŸŸç²¾ç¡®åˆ¤æ–­** | ç²¾ç¡®åˆ°è¡—é“çº§åˆ«çš„å¼‚åœ°åˆ¤æ–­ | åŒºåˆ†"æœ¬åœ°"ä¸"å‡ºå·®/æ—…æ¸¸"æ¶ˆè´¹ |

#### 14.3.3 æ•°æ®é‡‡é›†ä¸éšç§ä¿æŠ¤ç­–ç•¥

| ç­–ç•¥ | å®ç°æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| **å®æ—¶é«˜ç²¾åº¦** | GPS + ç½‘ç»œå®šä½ | è®°è´¦æ—¶è·å–ç²¾ç¡®ä½ç½® |
| **åå°ä½åŠŸè€—** | æ˜¾è‘—ä½ç½®å˜åŒ–ç›‘å¬ | æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç¦»å¼€å¸¸é©»åŸå¸‚ |
| **æ˜ç¡®æˆæƒ** | é¦–æ¬¡ä½¿ç”¨å‰å¼¹çª—è¯´æ˜ç”¨é€” | ç”¨æˆ·å¯é€‰æ‹©æ‹’ç»ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ |
| **éšæ—¶å…³é—­** | è®¾ç½®ä¸­å¯ä¸€é”®å…³é—­ | å…³é—­åä»…å–æ¶ˆä½ç½®æ™ºèƒ½åŠŸèƒ½ |
| **æœ¬åœ°ä¼˜å…ˆ** | ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨ | å¯é€‰æ‹©æ˜¯å¦åŒæ­¥åˆ°äº‘ç«¯å¤‡ä»½ |

```dart
/// ç²¾ç¡®åœ°ç†ä½ç½®æœåŠ¡
class PreciseLocationService {
  static const String _permissionKey = 'location_permission_granted';

  /// ä½ç½®ç²¾åº¦çº§åˆ«ï¼ˆé«˜ç²¾åº¦å®šä½ï¼‰
  static const LocationAccuracy accuracy = LocationAccuracy.high;

  /// ä½ç½®é‡‡é›†é…ç½®
  static const LocationSettings locationSettings = LocationSettings(
    accuracy: LocationAccuracy.high,
    distanceFilter: 10, // ç§»åŠ¨10ç±³ä»¥ä¸Šæ‰æ›´æ–°
  );

  /// åå°ä½ç½®ç›‘å¬é…ç½®ï¼ˆä½åŠŸè€—ï¼‰
  static const LocationSettings backgroundSettings = LocationSettings(
    accuracy: LocationAccuracy.low,
    distanceFilter: 500, // ç§»åŠ¨500ç±³ä»¥ä¸Šæ‰æ›´æ–°
  );

  /// æ£€æŸ¥å¹¶è¯·æ±‚ç²¾ç¡®ä½ç½®æƒé™
  Future<LocationPermissionResult> requestPrecisePermission() async {
    // 1. æ£€æŸ¥åŸºç¡€ä½ç½®æƒé™
    final status = await Permission.location.status;

    if (status.isDenied) {
      final userAccepted = await _showPermissionExplanation();
      if (!userAccepted) {
        return LocationPermissionResult.denied;
      }
      final result = await Permission.location.request();
      if (!result.isGranted) {
        return LocationPermissionResult.denied;
      }
    }

    // 2. æ£€æŸ¥ç²¾ç¡®ä½ç½®æƒé™ï¼ˆAndroid 12+ï¼‰
    if (Platform.isAndroid) {
      final preciseStatus = await Permission.locationAlways.status;
      if (preciseStatus.isDenied) {
        // å¼•å¯¼ç”¨æˆ·å¼€å¯ç²¾ç¡®ä½ç½®
        await _showPreciseLocationExplanation();
        final result = await Permission.locationAlways.request();
        if (!result.isGranted) {
          return LocationPermissionResult.approximate; // ä»…æœ‰ç²—ç•¥ä½ç½®
        }
      }
    }

    // 3. æ£€æŸ¥åå°ä½ç½®æƒé™ï¼ˆç”¨äºè‡ªåŠ¨æ£€æµ‹å¼‚åœ°ï¼‰
    final alwaysStatus = await Permission.locationAlways.status;
    if (alwaysStatus.isDenied) {
      // åå°æƒé™å¯é€‰ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹å‡ºå·®/æ—…æ¸¸
      return LocationPermissionResult.foregroundOnly;
    }

    return LocationPermissionResult.full;
  }

  /// è·å–å½“å‰ç²¾ç¡®ä½ç½®
  Future<PreciseLocation?> getCurrentLocation() async {
    if (!await _hasPermission()) return null;

    try {
      final position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
        timeLimit: Duration(seconds: 10),
      );

      // åå‘åœ°ç†ç¼–ç è·å–è¯¦ç»†åœ°å€
      final placemarks = await placemarkFromCoordinates(
        position.latitude,
        position.longitude,
      );

      final place = placemarks.isNotEmpty ? placemarks.first : null;

      // æŸ¥è¯¢POIä¿¡æ¯ï¼ˆå•†æˆ·è¯†åˆ«ï¼‰
      final poi = await _queryNearbyPOI(position.latitude, position.longitude);

      return PreciseLocation(
        latitude: position.latitude,
        longitude: position.longitude,
        accuracy: position.accuracy,
        timestamp: DateTime.now(),
        // åœ°å€ä¿¡æ¯
        country: place?.country ?? '',
        countryCode: place?.isoCountryCode ?? 'CN',
        province: place?.administrativeArea ?? '',
        city: place?.locality ?? place?.subAdministrativeArea ?? '',
        district: place?.subLocality ?? '',
        street: place?.street ?? '',
        streetNumber: place?.subThoroughfare ?? '',
        fullAddress: _buildFullAddress(place),
        // åŸå¸‚çº§åˆ«
        cityTier: _getCityTier(place?.locality),
        // POIä¿¡æ¯
        nearbyPOI: poi,
        // åŒºåŸŸç±»å‹
        areaType: _detectAreaType(poi),
      );
    } catch (e) {
      return null;
    }
  }

  /// æŸ¥è¯¢é™„è¿‘POIï¼ˆå•†æˆ·è¯†åˆ«ï¼‰
  Future<NearbyPOI?> _queryNearbyPOI(double lat, double lng) async {
    // è°ƒç”¨é«˜å¾·/ç™¾åº¦åœ°å›¾POIæœç´¢API
    try {
      final response = await _poiService.searchNearby(
        latitude: lat,
        longitude: lng,
        radius: 50, // 50ç±³èŒƒå›´å†…
        types: ['é¤é¥®', 'è´­ç‰©', 'äº¤é€š', 'ç”Ÿæ´»æœåŠ¡', 'é‡‘è', 'å¨±ä¹'],
      );

      if (response.pois.isEmpty) return null;

      final nearest = response.pois.first;
      return NearbyPOI(
        name: nearest.name,
        type: nearest.type,
        category: _mapPOICategory(nearest.type),
        distance: nearest.distance,
        address: nearest.address,
        businessArea: nearest.businessArea,
      );
    } catch (e) {
      return null;
    }
  }

  /// æ£€æµ‹åŒºåŸŸç±»å‹ï¼ˆå•†åœˆ/åŠå…¬åŒº/ä½å®…åŒºï¼‰
  AreaType _detectAreaType(NearbyPOI? poi) {
    if (poi == null) return AreaType.unknown;

    // åŸºäºPOIç±»å‹å’Œå•†åœˆä¿¡æ¯åˆ¤æ–­
    if (poi.businessArea != null && poi.businessArea!.isNotEmpty) {
      return AreaType.commercial; // å•†åœˆ
    }

    switch (poi.category) {
      case POICategory.office:
        return AreaType.office;
      case POICategory.residential:
        return AreaType.residential;
      case POICategory.transportation:
        return AreaType.transportation;
      case POICategory.shopping:
      case POICategory.dining:
      case POICategory.entertainment:
        return AreaType.commercial;
      default:
        return AreaType.unknown;
    }
  }

  /// åˆ¤æ–­åŸå¸‚çº§åˆ«
  CityTier _getCityTier(String? city) {
    const tier1 = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³'];
    const newTier1 = ['æˆéƒ½', 'æ­å·', 'é‡åº†', 'è¥¿å®‰', 'è‹å·', 'æ­¦æ±‰', 'å—äº¬',
                      'å¤©æ´¥', 'éƒ‘å·', 'é•¿æ²™', 'ä¸œè', 'ä½›å±±', 'å®æ³¢', 'é’å²›', 'æ²ˆé˜³'];
    const tier2 = ['æ— é”¡', 'åˆè‚¥', 'æ˜†æ˜', 'å¤§è¿', 'å¦é—¨', 'æµå—', 'ç¦å·',
                   'æ¸©å·', 'å—å®', 'é•¿æ˜¥', 'æ³‰å·', 'çŸ³å®¶åº„', 'è´µé˜³', 'å—æ˜Œ', 'é‡‘å'];

    if (city == null) return CityTier.unknown;
    if (tier1.contains(city)) return CityTier.tier1;
    if (newTier1.contains(city)) return CityTier.newTier1;
    if (tier2.contains(city)) return CityTier.tier2;
    return CityTier.tier3;
  }
}

/// ç²¾ç¡®ä½ç½®ä¿¡æ¯
class PreciseLocation {
  // ç»çº¬åº¦
  final double latitude;
  final double longitude;
  final double accuracy;  // ç²¾åº¦ï¼ˆç±³ï¼‰
  final DateTime timestamp;

  // åœ°å€ä¿¡æ¯
  final String country;
  final String countryCode;
  final String province;
  final String city;
  final String district;  // åŒº/å¿
  final String street;
  final String streetNumber;
  final String fullAddress;

  // åŸå¸‚çº§åˆ«
  final CityTier cityTier;

  // POIä¿¡æ¯
  final NearbyPOI? nearbyPOI;

  // åŒºåŸŸç±»å‹
  final AreaType areaType;

  bool get isDomestic => countryCode == 'CN';
  bool get isOverseas => !isDomestic;

  /// è®¡ç®—ä¸å¦ä¸€ä½ç½®çš„è·ç¦»ï¼ˆç±³ï¼‰
  double distanceTo(PreciseLocation other) {
    return Geolocator.distanceBetween(
      latitude, longitude,
      other.latitude, other.longitude,
    );
  }

  /// æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
  bool isWithinRadius(PreciseLocation center, double radiusMeters) {
    return distanceTo(center) <= radiusMeters;
  }
}

/// é™„è¿‘POIä¿¡æ¯
class NearbyPOI {
  final String name;          // å•†æˆ·åç§°
  final String type;          // åŸå§‹ç±»å‹
  final POICategory category; // æ ‡å‡†åŒ–åˆ†ç±»
  final double distance;      // è·ç¦»ï¼ˆç±³ï¼‰
  final String? address;      // åœ°å€
  final String? businessArea; // å•†åœˆåç§°
}

/// POIåˆ†ç±»
enum POICategory {
  dining,         // é¤é¥®
  shopping,       // è´­ç‰©
  transportation, // äº¤é€š
  office,         // åŠå…¬
  residential,    // ä½å®…
  entertainment,  // å¨±ä¹
  finance,        // é‡‘è
  medical,        // åŒ»ç–—
  education,      // æ•™è‚²
  other,          // å…¶ä»–
}

/// åŒºåŸŸç±»å‹
enum AreaType {
  commercial,     // å•†åœˆ
  office,         // åŠå…¬åŒº
  residential,    // ä½å®…åŒº
  transportation, // äº¤é€šæ¢çº½
  unknown,
}

/// åŸå¸‚çº§åˆ«
enum CityTier {
  tier1,      // ä¸€çº¿åŸå¸‚
  newTier1,   // æ–°ä¸€çº¿åŸå¸‚
  tier2,      // äºŒçº¿åŸå¸‚
  tier3,      // ä¸‰å››çº¿åŸå¸‚
  unknown,
}

/// ä½ç½®æƒé™ç»“æœ
enum LocationPermissionResult {
  full,           // å®Œæ•´æƒé™ï¼ˆå‰å°+åå°+ç²¾ç¡®ï¼‰
  foregroundOnly, // ä»…å‰å°ç²¾ç¡®ä½ç½®
  approximate,    // ä»…ç²—ç•¥ä½ç½®
  denied,         // æ‹’ç»æˆæƒ
}
```

### 14.4 æ™ºèƒ½ä½ç½®è¯†åˆ«å¼•æ“

#### 14.4.1 ç²¾ç¡®å®šä½æœåŠ¡

ç²¾ç¡®å®šä½æœåŠ¡æ˜¯æ•´ä¸ªä½ç½®æ™ºèƒ½åŒ–ç³»ç»Ÿçš„åŸºç¡€ï¼Œæä¾›é«˜ç²¾åº¦GPSå®šä½ã€åå‘åœ°ç†ç¼–ç ã€POIè¯†åˆ«ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

```dart
/// ç²¾ç¡®ä½ç½®è¯†åˆ«å¼•æ“
/// èŒè´£ï¼šæä¾›é«˜ç²¾åº¦å®šä½ã€POIåŒ¹é…ã€åŒºåŸŸç±»å‹è¯†åˆ«
class PreciseLocationEngine {
  final GeolocatorService _geolocator;
  final POIMatchingService _poiMatcher;
  final AreaTypeDetector _areaDetector;
  final LocationCacheService _cache;

  /// è·å–å½“å‰å¢å¼ºä½ç½®ä¿¡æ¯
  Future<EnhancedLocation?> getEnhancedLocation() async {
    // 1. è·å–åŸå§‹ä½ç½®
    final position = await _geolocator.getCurrentPosition(
      accuracy: LocationAccuracy.high,
      timeout: Duration(seconds: 10),
    );
    if (position == null) return null;

    // 2. æ£€æŸ¥ç¼“å­˜ï¼ˆ100ç±³èŒƒå›´å†…10åˆ†é’Ÿå†…çš„ç»“æœå¯å¤ç”¨ï¼‰
    final cached = await _cache.getNearby(
      position.latitude,
      position.longitude,
      radiusMeters: 100,
      maxAge: Duration(minutes: 10),
    );
    if (cached != null) return cached;

    // 3. åå‘åœ°ç†ç¼–ç 
    final address = await _reverseGeocode(position);

    // 4. POIåŒ¹é…
    final poi = await _poiMatcher.findNearest(
      position.latitude,
      position.longitude,
      radius: 50,
    );

    // 5. åŒºåŸŸç±»å‹è¯†åˆ«
    final areaType = await _areaDetector.detect(position, poi);

    // 6. æ„å»ºå¢å¼ºä½ç½®
    final enhanced = EnhancedLocation(
      latitude: position.latitude,
      longitude: position.longitude,
      accuracy: position.accuracy,
      timestamp: DateTime.now(),
      address: address,
      poi: poi,
      areaType: areaType,
      cityTier: _getCityTier(address.city),
    );

    // 7. ç¼“å­˜ç»“æœ
    await _cache.save(enhanced);

    return enhanced;
  }
}

/// å¢å¼ºä½ç½®ä¿¡æ¯
class EnhancedLocation {
  final double latitude;
  final double longitude;
  final double accuracy;
  final DateTime timestamp;
  final Address address;
  final NearbyPOI? poi;
  final AreaType areaType;
  final CityTier cityTier;

  bool get isOverseas => address.countryCode != 'CN';

  /// è®¡ç®—ä¸å¦ä¸€ä½ç½®çš„è·ç¦»
  double distanceTo(EnhancedLocation other) {
    return Geolocator.distanceBetween(
      latitude, longitude,
      other.latitude, other.longitude,
    );
  }
}
```

#### 14.4.2 POIæ™ºèƒ½åŒ¹é…

```dart
/// POIåŒ¹é…æœåŠ¡
/// é€šè¿‡ä½ç½®åæ ‡è¯†åˆ«é™„è¿‘å•†æˆ·ï¼Œå®ç°æ¶ˆè´¹è‡ªåŠ¨åˆ†ç±»
class POIMatchingService {
  final POIDatabase _localDB;
  final AmapPOIAPI _amapAPI;
  final POICache _cache;

  /// æŸ¥æ‰¾æœ€è¿‘çš„POI
  Future<NearbyPOI?> findNearest(
    double lat,
    double lng, {
    int radius = 50,
    List<String>? types,
  }) async {
    // 1. ä¼˜å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
    final cached = await _cache.findNearby(lat, lng, radius);
    if (cached.isNotEmpty) {
      return _selectBestMatch(cached, lat, lng);
    }

    // 2. æŸ¥è¯¢æœ¬åœ°POIæ•°æ®åº“ï¼ˆç¦»çº¿å¯ç”¨ï¼‰
    final local = await _localDB.searchNearby(
      latitude: lat,
      longitude: lng,
      radius: radius,
      types: types ?? _defaultTypes,
    );
    if (local.isNotEmpty) {
      return _selectBestMatch(local, lat, lng);
    }

    // 3. åœ¨çº¿æŸ¥è¯¢ï¼ˆéœ€ç½‘ç»œï¼‰
    try {
      final remote = await _amapAPI.searchNearby(
        latitude: lat,
        longitude: lng,
        radius: radius,
        types: types ?? _defaultTypes,
      );

      // ç¼“å­˜ç»“æœ
      await _cache.saveAll(remote, lat, lng);

      return remote.isNotEmpty ? _selectBestMatch(remote, lat, lng) : null;
    } catch (e) {
      return null;
    }
  }

  /// é€‰æ‹©æœ€ä½³åŒ¹é…çš„POI
  NearbyPOI _selectBestMatch(List<NearbyPOI> pois, double lat, double lng) {
    // æŒ‰è·ç¦»å’Œç›¸å…³æ€§æ’åº
    pois.sort((a, b) {
      final distA = _calculateDistance(lat, lng, a.latitude, a.longitude);
      final distB = _calculateDistance(lat, lng, b.latitude, b.longitude);
      // ä¼˜å…ˆé€‰æ‹©æ¶ˆè´¹ç›¸å…³POI
      final relevanceA = _getRelevanceScore(a.category);
      final relevanceB = _getRelevanceScore(b.category);
      return (distA - relevanceA * 10).compareTo(distB - relevanceB * 10);
    });
    return pois.first;
  }

  static const _defaultTypes = ['é¤é¥®', 'è´­ç‰©', 'ç”Ÿæ´»æœåŠ¡', 'äº¤é€š', 'é‡‘è'];
}

/// é™„è¿‘POIä¿¡æ¯
class NearbyPOI {
  final String id;
  final String name;
  final double latitude;
  final double longitude;
  final String type;
  final POICategory category;
  final double distance;
  final String? address;
  final String? businessArea;

  /// æ ¹æ®POIæ¨æ–­æ¶ˆè´¹ç±»ç›®
  String get suggestedCategory {
    switch (category) {
      case POICategory.dining:
        return 'é¤é¥®';
      case POICategory.shopping:
        return 'è´­ç‰©';
      case POICategory.transportation:
        return 'äº¤é€š';
      case POICategory.entertainment:
        return 'å¨±ä¹';
      case POICategory.medical:
        return 'åŒ»ç–—';
      case POICategory.education:
        return 'æ•™è‚²';
      default:
        return 'å…¶ä»–';
    }
  }
}

/// POIåˆ†ç±»
enum POICategory {
  dining,         // é¤é¥®
  shopping,       // è´­ç‰©
  transportation, // äº¤é€š
  office,         // åŠå…¬
  residential,    // ä½å®…
  entertainment,  // å¨±ä¹
  finance,        // é‡‘è
  medical,        // åŒ»ç–—
  education,      // æ•™è‚²
  other,          // å…¶ä»–
}
```

#### 14.4.3 ç¦»çº¿å®šä½ä¸ç¼“å­˜ç­–ç•¥

```dart
/// ç¦»çº¿ä½ç½®æœåŠ¡
/// åœ¨æ— ç½‘ç»œæ—¶æä¾›é™çº§çš„ä½ç½®æœåŠ¡
class OfflineLocationService {
  final LocationCacheService _cache;
  final CityDatabase _cityDB;

  /// è·å–ç¦»çº¿ä½ç½®ï¼ˆé™çº§ç­–ç•¥ï¼‰
  Future<OfflineLocation?> getOfflineLocation() async {
    // 1. å°è¯•GPSå®šä½ï¼ˆç¦»çº¿å¯ç”¨ï¼‰
    try {
      final position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.medium,
        timeLimit: Duration(seconds: 5),
      );

      // 2. ä½¿ç”¨æœ¬åœ°åŸå¸‚æ•°æ®åº“åŒ¹é…åŸå¸‚
      final city = await _cityDB.findCityByCoordinates(
        position.latitude,
        position.longitude,
      );

      return OfflineLocation(
        latitude: position.latitude,
        longitude: position.longitude,
        city: city,
        source: LocationSource.gpsOffline,
      );
    } catch (e) {
      // GPSå¤±è´¥ï¼Œä½¿ç”¨æœ€è¿‘ç¼“å­˜ä½ç½®
    }

    // 3. ä½¿ç”¨æœ€è¿‘çš„ç¼“å­˜ä½ç½®
    final cached = await _cache.getLatest();
    if (cached != null) {
      return OfflineLocation(
        latitude: cached.latitude,
        longitude: cached.longitude,
        city: cached.address.city,
        source: LocationSource.cached,
        cacheAge: DateTime.now().difference(cached.timestamp),
      );
    }

    // 4. ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å¸¸é©»åŸå¸‚
    final homeCity = await _getHomeCitySetting();
    if (homeCity != null) {
      return OfflineLocation(
        city: homeCity,
        source: LocationSource.userSetting,
      );
    }

    return null;
  }
}

/// ç¦»çº¿ä½ç½®
class OfflineLocation {
  final double? latitude;
  final double? longitude;
  final String? city;
  final LocationSource source;
  final Duration? cacheAge;

  bool get hasCoordinates => latitude != null && longitude != null;
  bool get isCacheStale => cacheAge != null && cacheAge! > Duration(hours: 24);
}

enum LocationSource {
  gpsOnline,    // åœ¨çº¿GPS
  gpsOffline,   // ç¦»çº¿GPS
  cached,       // ç¼“å­˜ä½ç½®
  userSetting,  // ç”¨æˆ·è®¾ç½®
}
```

### 14.5 æœ¬åœ°åŒ–é¢„ç®—ç±»ç›®æ¨è

#### 14.5.1 åŸå¸‚çº§åˆ«å·®å¼‚åŒ–ç±»ç›®

```dart
/// æœ¬åœ°åŒ–é¢„ç®—ç±»ç›®æ¨èæœåŠ¡
class LocalizedBudgetCategoryService {
  /// æ ¹æ®åŸå¸‚çº§åˆ«æ¨èé»˜è®¤é¢„ç®—ç±»ç›®
  List<RecommendedCategory> getRecommendedCategories(CityLocation location) {
    final tier = location.tier;
    final isOverseas = location.isOverseas;

    if (isOverseas) {
      return _getOverseasCategories(location);
    }

    switch (tier) {
      case CityTier.tier1:
        return _getTier1Categories();
      case CityTier.newTier1:
        return _getNewTier1Categories();
      case CityTier.tier2:
        return _getTier2Categories();
      default:
        return _getTier3Categories();
    }
  }

  /// ä¸€çº¿åŸå¸‚æ¨èç±»ç›®ï¼ˆé«˜æˆ¿ç§Ÿã€é«˜é€šå‹¤æˆæœ¬ï¼‰
  List<RecommendedCategory> _getTier1Categories() {
    return [
      RecommendedCategory(
        name: 'æˆ¿ç§Ÿ/æˆ¿è´·',
        icon: Icons.home,
        suggestedPercentage: 0.30,  // æ”¶å…¥çš„30%
        priority: 1,
        description: 'ä¸€çº¿åŸå¸‚æˆ¿ç§Ÿå æ¯”é€šå¸¸è¾ƒé«˜',
      ),
      RecommendedCategory(
        name: 'é€šå‹¤äº¤é€š',
        icon: Icons.subway,
        suggestedPercentage: 0.08,
        priority: 2,
        description: 'åœ°é“/å…¬äº¤/ç½‘çº¦è½¦',
        subCategories: ['åœ°é“', 'å…¬äº¤', 'ç½‘çº¦è½¦', 'å…±äº«å•è½¦'],
      ),
      RecommendedCategory(
        name: 'é¤é¥®',
        icon: Icons.restaurant,
        suggestedPercentage: 0.15,
        priority: 3,
        description: 'å¤–å–å’Œå·¥ä½œé¤æˆæœ¬è¾ƒé«˜',
      ),
      RecommendedCategory(
        name: 'æ—¥ç”¨å“',
        icon: Icons.shopping_bag,
        suggestedPercentage: 0.05,
        priority: 4,
      ),
      RecommendedCategory(
        name: 'ç¤¾äº¤å¨±ä¹',
        icon: Icons.celebration,
        suggestedPercentage: 0.08,
        priority: 5,
      ),
      RecommendedCategory(
        name: 'å‚¨è“„/æŠ•èµ„',
        icon: Icons.savings,
        suggestedPercentage: 0.20,
        priority: 6,
        description: 'å»ºè®®ä¼˜å…ˆç§¯ç´¯åº”æ€¥é‡‘',
      ),
      RecommendedCategory(
        name: 'è‡ªæˆ‘æå‡',
        icon: Icons.school,
        suggestedPercentage: 0.05,
        priority: 7,
        description: 'åŸ¹è®­ã€ä¹¦ç±ã€è¯¾ç¨‹',
      ),
      RecommendedCategory(
        name: 'å…¶ä»–',
        icon: Icons.more_horiz,
        suggestedPercentage: 0.09,
        priority: 8,
      ),
    ];
  }

  /// ä¸‰å››çº¿åŸå¸‚æ¨èç±»ç›®ï¼ˆä½æˆ¿ç§Ÿã€é«˜é¤é¥®ç¤¾äº¤ï¼‰
  List<RecommendedCategory> _getTier3Categories() {
    return [
      RecommendedCategory(
        name: 'æˆ¿ç§Ÿ/æˆ¿è´·',
        icon: Icons.home,
        suggestedPercentage: 0.15,  // å æ¯”è¾ƒä½
        priority: 1,
      ),
      RecommendedCategory(
        name: 'é¤é¥®',
        icon: Icons.restaurant,
        suggestedPercentage: 0.20,  // å æ¯”è¾ƒé«˜
        priority: 2,
        description: 'å®¶å¸¸èœé¦†ã€æœ¬åœ°ç‰¹è‰²',
      ),
      RecommendedCategory(
        name: 'äº¤é€šå‡ºè¡Œ',
        icon: Icons.directions_car,
        suggestedPercentage: 0.10,
        priority: 3,
        description: 'ç§å®¶è½¦/ç”µåŠ¨è½¦ä¸ºä¸»',
        subCategories: ['åŠ æ²¹', 'åœè½¦', 'ä¿å…»', 'ç”µåŠ¨è½¦å……ç”µ'],
      ),
      RecommendedCategory(
        name: 'ä¼‘é—²å¨±ä¹',
        icon: Icons.sports_esports,
        suggestedPercentage: 0.12,  // æœ¬åœ°å¨±ä¹å æ¯”é«˜
        priority: 4,
        description: 'æœ¬åœ°ä¼‘é—²åœºæ‰€',
      ),
      RecommendedCategory(
        name: 'äººæƒ…å¾€æ¥',
        icon: Icons.card_giftcard,
        suggestedPercentage: 0.08,
        priority: 5,
        description: 'çº¢åŒ…ã€ç¤¼é‡‘ã€ç¤¼å“',
      ),
      RecommendedCategory(
        name: 'å‚¨è“„/æŠ•èµ„',
        icon: Icons.savings,
        suggestedPercentage: 0.25,  // ç”Ÿæ´»æˆæœ¬ä½ï¼Œå‚¨è“„ç©ºé—´å¤§
        priority: 6,
      ),
      RecommendedCategory(
        name: 'å…¶ä»–',
        icon: Icons.more_horiz,
        suggestedPercentage: 0.10,
        priority: 7,
      ),
    ];
  }

  /// æµ·å¤–ç”¨æˆ·ç‰¹æ®Šç±»ç›®
  List<RecommendedCategory> _getOverseasCategories(CityLocation location) {
    final base = _getTier1Categories();

    // æ·»åŠ æµ·å¤–ç‰¹æœ‰ç±»ç›®
    base.addAll([
      RecommendedCategory(
        name: 'ç¨è´¹',
        icon: Icons.receipt_long,
        suggestedPercentage: 0.05,
        priority: 9,
        description: 'æ¶ˆè´¹ç¨ã€æœåŠ¡è´¹ç­‰',
      ),
      RecommendedCategory(
        name: 'å°è´¹',
        icon: Icons.volunteer_activism,
        suggestedPercentage: 0.03,
        priority: 10,
        description: 'æœåŠ¡è¡Œä¸šå°è´¹',
      ),
      RecommendedCategory(
        name: 'æ±‡ç‡æŸå¤±',
        icon: Icons.currency_exchange,
        suggestedPercentage: 0.02,
        priority: 11,
        description: 'è·¨å¢ƒæ”¯ä»˜æ±‡ç‡å·®',
      ),
    ]);

    return base;
  }
}
```

#### 14.5.2 æœ¬åœ°åŒ–é¢„ç®—é‡‘é¢å»ºè®®

```dart
/// æœ¬åœ°åŒ–é¢„ç®—é‡‘é¢å»ºè®®æœåŠ¡
class LocalizedBudgetAmountService {
  /// åŸå¸‚æ¶ˆè´¹æ°´å¹³ç³»æ•°ï¼ˆä»¥å…¨å›½å¹³å‡ä¸º1.0ï¼‰
  static const Map<CityTier, double> costOfLivingIndex = {
    CityTier.tier1: 1.8,      // ä¸€çº¿åŸå¸‚æ¶ˆè´¹æ°´å¹³æ˜¯å…¨å›½1.8å€
    CityTier.newTier1: 1.4,   // æ–°ä¸€çº¿
    CityTier.tier2: 1.1,      // äºŒçº¿
    CityTier.tier3: 0.8,      // ä¸‰å››çº¿
    CityTier.unknown: 1.0,
  };

  /// å„ç±»ç›®çš„å…¨å›½å¹³å‡æœˆæ”¯å‡ºï¼ˆå…ƒï¼‰
  static const Map<String, double> nationalAverageSpending = {
    'æˆ¿ç§Ÿ/æˆ¿è´·': 2000,
    'é¤é¥®': 1500,
    'é€šå‹¤äº¤é€š': 400,
    'äº¤é€šå‡ºè¡Œ': 600,
    'æ—¥ç”¨å“': 300,
    'ç¤¾äº¤å¨±ä¹': 500,
    'ä¼‘é—²å¨±ä¹': 400,
    'äººæƒ…å¾€æ¥': 300,
    'è‡ªæˆ‘æå‡': 200,
  };

  /// è®¡ç®—æœ¬åœ°åŒ–é¢„ç®—å»ºè®®é‡‘é¢
  BudgetAmountSuggestion getSuggestedAmount({
    required String category,
    required CityLocation location,
    required double monthlyIncome,
  }) {
    final coefficient = costOfLivingIndex[location.tier] ?? 1.0;
    final nationalAvg = nationalAverageSpending[category] ?? 500;

    // åŸºäºåŸå¸‚ç³»æ•°çš„è°ƒæ•´é‡‘é¢
    final adjustedAmount = nationalAvg * coefficient;

    // åŸºäºæ”¶å…¥çš„æ¨èå æ¯”
    final percentageBasedAmount = _getPercentageBasedAmount(
      category, monthlyIncome, location.tier);

    // å–ä¸¤è€…çš„åŠ æƒå¹³å‡ï¼ˆåŸå¸‚ç³»æ•°æƒé‡60%ï¼Œæ”¶å…¥å æ¯”æƒé‡40%ï¼‰
    final suggestedAmount = adjustedAmount * 0.6 + percentageBasedAmount * 0.4;

    return BudgetAmountSuggestion(
      category: category,
      suggestedAmount: suggestedAmount.roundToDouble(),
      nationalAverage: nationalAvg,
      localAverage: adjustedAmount.roundToDouble(),
      reasoning: _generateReasoning(category, location, suggestedAmount),
      range: AmountRange(
        min: suggestedAmount * 0.7,
        max: suggestedAmount * 1.3,
      ),
    );
  }

  String _generateReasoning(String category, CityLocation location, double amount) {
    switch (category) {
      case 'æˆ¿ç§Ÿ/æˆ¿è´·':
        return '${location.city}çš„æˆ¿ç§Ÿæ°´å¹³çº¦ä¸ºå…¨å›½${(costOfLivingIndex[location.tier]! * 100).toInt()}%ï¼Œ'
               'å»ºè®®é¢„ç•™ Â¥${amount.toStringAsFixed(0)}/æœˆ';
      case 'é¤é¥®':
        return '${location.city}é¤é¥®äººå‡æ¶ˆè´¹çº¦ Â¥${(amount / 30).toStringAsFixed(0)}/å¤©';
      case 'é€šå‹¤äº¤é€š':
        return '${location.city}æ—¥å‡é€šå‹¤æˆæœ¬çº¦ Â¥${(amount / 22).toStringAsFixed(0)}';
      default:
        return 'åŸºäº${location.city}æ¶ˆè´¹æ°´å¹³æ¨è';
    }
  }
}

/// é¢„ç®—é‡‘é¢å»ºè®®
class BudgetAmountSuggestion {
  final String category;
  final double suggestedAmount;
  final double nationalAverage;
  final double localAverage;
  final String reasoning;
  final AmountRange range;
}
```

### 14.6 æ¶ˆè´¹åœºæ™¯åˆ†æä¸å¼‚åœ°è¯†åˆ«

#### 14.6.1 å¼‚åœ°æ¶ˆè´¹æ£€æµ‹ä¸æ ‡è®°

```dart
/// å¼‚åœ°æ¶ˆè´¹æ£€æµ‹æœåŠ¡
/// æ³¨æ„ï¼šä½¿ç”¨ CityLocationServiceï¼ˆåŸå¸‚çº§åˆ«ï¼‰ï¼Œä¸æ˜¯ PreciseLocationService
/// å‚è§ 11.0.1 ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„
class CrossRegionSpendingService {
  final CityLocationService _cityService;  // åŸå¸‚çº§åˆ«æœåŠ¡
  final SharedPreferences _prefs;

  /// ç”¨æˆ·å¸¸é©»åŸå¸‚
  CityLocation? _homeCity;

  /// æ£€æµ‹äº¤æ˜“æ˜¯å¦ä¸ºå¼‚åœ°æ¶ˆè´¹
  Future<CrossRegionStatus> detectCrossRegion(Transaction tx) async {
    final homeCity = await _getHomeCity();
    if (homeCity == null) return CrossRegionStatus.unknown;

    // ä»äº¤æ˜“ä¿¡æ¯æå–ä½ç½®ï¼ˆå•†æˆ·åœ°å€ã€æ¶ˆè´¹åœ°ç‚¹ï¼‰
    final txLocation = _extractLocationFromTransaction(tx);
    if (txLocation == null) return CrossRegionStatus.unknown;

    // åˆ¤æ–­æ˜¯å¦å¼‚åœ°
    if (txLocation.city == homeCity.city) {
      return CrossRegionStatus.local;
    }

    // åˆ¤æ–­å¼‚åœ°ç±»å‹
    if (txLocation.isOverseas) {
      return CrossRegionStatus.overseas;
    }

    if (txLocation.province != homeCity.province) {
      return CrossRegionStatus.crossProvince;
    }

    return CrossRegionStatus.crossCity;
  }

  /// ä¸ºå¼‚åœ°æ¶ˆè´¹æ¨èä¸´æ—¶é¢„ç®—ç±»ç›®
  List<TemporaryBudgetCategory> suggestTemporaryCategories(
    CrossRegionStatus status,
    CityLocation destination,
  ) {
    switch (status) {
      case CrossRegionStatus.crossProvince:
      case CrossRegionStatus.crossCity:
        return [
          TemporaryBudgetCategory(
            name: 'å‡ºå·®/æ—…æ¸¸é¤é¥®',
            icon: Icons.restaurant_menu,
            description: 'å¼‚åœ°é¤é¥®æ¶ˆè´¹',
            excludeFromDailyMoneyAge: true,  // ä¸è®¡å…¥æ—¥å¸¸é’±é¾„
          ),
          TemporaryBudgetCategory(
            name: 'ä½å®¿',
            icon: Icons.hotel,
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'äº¤é€šï¼ˆé•¿é€”ï¼‰',
            icon: Icons.flight,
            description: 'æœºç¥¨/ç«è½¦ç¥¨/é•¿é€”æ±½è½¦',
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'é—¨ç¥¨/æ™¯ç‚¹',
            icon: Icons.confirmation_number,
            excludeFromDailyMoneyAge: true,
          ),
        ];

      case CrossRegionStatus.overseas:
        return [
          ..._getDomesticTravelCategories(),
          TemporaryBudgetCategory(
            name: 'æ±‡ç‡å·®é¢',
            icon: Icons.currency_exchange,
            description: 'è·¨å¢ƒæ”¯ä»˜æ±‡ç‡æŸå¤±',
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'å°è´¹',
            icon: Icons.volunteer_activism,
            excludeFromDailyMoneyAge: true,
          ),
          TemporaryBudgetCategory(
            name: 'é€€ç¨å•†å“',
            icon: Icons.shopping_bag,
            description: 'å¯é€€ç¨çš„è´­ç‰©',
            excludeFromDailyMoneyAge: true,
          ),
        ];

      default:
        return [];
    }
  }
}

/// å¼‚åœ°æ¶ˆè´¹çŠ¶æ€
enum CrossRegionStatus {
  local,          // æœ¬åœ°æ¶ˆè´¹
  crossCity,      // è·¨å¸‚æ¶ˆè´¹ï¼ˆçœå†…ï¼‰
  crossProvince,  // è·¨çœæ¶ˆè´¹
  overseas,       // æµ·å¤–æ¶ˆè´¹
  unknown,        // æ— æ³•åˆ¤æ–­
}
```

### 14.7 ä½ç½®æ„ŸçŸ¥é’±é¾„è®¡ç®—

#### 14.7.1 é’±é¾„è®¡ç®—çš„ä½ç½®ä¼˜åŒ–

```dart
/// ä½ç½®æ„ŸçŸ¥çš„é’±é¾„è®¡ç®—æœåŠ¡
class LocationAwareMoneyAgeService {
  final CrossRegionSpendingService _crossRegionService;
  final MoneyAgeCalculator _baseCalculator;

  /// è®¡ç®—è€ƒè™‘ä½ç½®å› ç´ çš„é’±é¾„
  Future<EnhancedMoneyAge> calculateMoneyAge({
    required List<Transaction> transactions,
    required List<Income> incomes,
    bool separateTemporarySpending = true,
  }) async {
    // åˆ†ç¦»æ—¥å¸¸æ¶ˆè´¹å’Œä¸´æ—¶æ¶ˆè´¹
    final dailyTransactions = <Transaction>[];
    final temporaryTransactions = <Transaction>[];

    for (final tx in transactions) {
      final status = await _crossRegionService.detectCrossRegion(tx);

      if (status == CrossRegionStatus.local) {
        dailyTransactions.add(tx);
      } else if (separateTemporarySpending) {
        temporaryTransactions.add(tx);
      } else {
        dailyTransactions.add(tx);
      }
    }

    // è®¡ç®—æ—¥å¸¸é’±é¾„
    final dailyMoneyAge = _baseCalculator.calculate(
      dailyTransactions, incomes);

    // è®¡ç®—ä¸´æ—¶æ¶ˆè´¹é’±é¾„ï¼ˆå¦‚æœ‰ï¼‰
    MoneyAge? temporaryMoneyAge;
    if (temporaryTransactions.isNotEmpty) {
      temporaryMoneyAge = _baseCalculator.calculate(
        temporaryTransactions, incomes);
    }

    // è®¡ç®—ç»¼åˆé’±é¾„ï¼ˆåŠ æƒï¼‰
    final overallMoneyAge = _calculateWeightedMoneyAge(
      dailyMoneyAge: dailyMoneyAge,
      dailyWeight: 0.85,  // æ—¥å¸¸æ¶ˆè´¹æƒé‡85%
      temporaryMoneyAge: temporaryMoneyAge,
      temporaryWeight: 0.15,  // ä¸´æ—¶æ¶ˆè´¹æƒé‡15%
    );

    return EnhancedMoneyAge(
      overall: overallMoneyAge,
      daily: dailyMoneyAge,
      temporary: temporaryMoneyAge,
      dailyTransactionCount: dailyTransactions.length,
      temporaryTransactionCount: temporaryTransactions.length,
    );
  }

  /// è®¡ç®—åˆšéœ€æ”¯å‡ºå¯¹é’±é¾„çš„å½±å“æƒé‡
  double _calculateRigidSpendingWeight(Transaction tx, CityLocation location) {
    // åˆšéœ€æ”¯å‡ºï¼ˆæˆ¿ç§Ÿã€ç¤¾ä¿ç­‰ï¼‰æƒé‡é™ä½
    final rigidCategories = ['æˆ¿ç§Ÿ/æˆ¿è´·', 'ç¤¾ä¿', 'æ°´ç”µè´¹', 'ç‰©ä¸šè´¹', 'é€šè®¯è´¹'];

    if (rigidCategories.contains(tx.category)) {
      return 0.5;  // åˆšéœ€æƒé‡é™ä¸º0.5
    }

    return 1.0;  // å…¶ä»–æ¶ˆè´¹æƒé‡ä¸º1
  }
}

/// å¢å¼ºç‰ˆé’±é¾„ï¼ˆåŒºåˆ†æ—¥å¸¸/ä¸´æ—¶ï¼‰
class EnhancedMoneyAge {
  final MoneyAge overall;     // ç»¼åˆé’±é¾„
  final MoneyAge daily;       // æ—¥å¸¸æ¶ˆè´¹é’±é¾„
  final MoneyAge? temporary;  // ä¸´æ—¶æ¶ˆè´¹é’±é¾„ï¼ˆå‡ºå·®/æ—…æ¸¸ï¼‰
  final int dailyTransactionCount;
  final int temporaryTransactionCount;

  /// åˆ¤æ–­æ˜¯å¦æœ‰å¤§é‡ä¸´æ—¶æ¶ˆè´¹å½±å“é’±é¾„
  bool get hasTemporaryImpact =>
      temporary != null && temporaryTransactionCount > 5;

  /// è·å–é’±é¾„å¥åº·åº¦è¯„ä¼°
  MoneyAgeHealthAssessment getHealthAssessment() {
    // å¦‚æœæ—¥å¸¸é’±é¾„å¥åº·ä½†ç»¼åˆé’±é¾„è¾ƒä½ï¼Œè¯´æ˜æ˜¯ä¸´æ—¶æ¶ˆè´¹å½±å“
    if (daily.days >= 14 && overall.days < 14 && hasTemporaryImpact) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.temporarilyImpacted,
        message: 'æ—¥å¸¸èµ„é‡‘ç®¡ç†è‰¯å¥½ï¼Œè¿‘æœŸæœ‰å¤§é¢ä¸´æ—¶æ”¯å‡ºï¼Œé’±é¾„æš‚æ—¶ä¸‹é™å±æ­£å¸¸ç°è±¡',
        dailyStatus: _getStatusForDays(daily.days),
        suggestion: 'ä¸´æ—¶æ”¯å‡ºç»“æŸåï¼Œé’±é¾„ä¼šè‡ªç„¶æ¢å¤',
      );
    }

    return MoneyAgeHealthAssessment(
      status: _getStatusForDays(overall.days),
      message: overall.description,
    );
  }
}
```

#### 14.7.2 ç²¾ç¡®ä½ç½®å¢å¼ºé’±é¾„è®¡ç®—

åŸºäºGPSç²¾ç¡®ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´æ™ºèƒ½çš„é’±é¾„åˆ†æã€‚

**ä¸ LocationAwareMoneyAgeService çš„åŒºåˆ«**ï¼š
- `LocationAwareMoneyAgeService`ï¼šåŸå¸‚çº§åˆ«åˆ¤æ–­ï¼ŒåŒºåˆ†"æœ¬åœ°æ¶ˆè´¹"ä¸"å¼‚åœ°æ¶ˆè´¹"
- `SpendingContextAnalyzer`ï¼šè¡—é“çº§åˆ«åˆ†æï¼Œè¯†åˆ«"å®¶é™„è¿‘"ã€"å…¬å¸é™„è¿‘"ã€"é€šå‹¤è·¯ä¸Š"ç­‰ç²¾ç»†åœºæ™¯

ä¸¤è€…æ˜¯äº’è¡¥å…³ç³»ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨ï¼š
1. å…ˆç”¨ `LocationAwareMoneyAgeService` æ’é™¤å¼‚åœ°æ¶ˆè´¹
2. å†ç”¨ `SpendingContextAnalyzer` åˆ†ææœ¬åœ°æ¶ˆè´¹çš„å…·ä½“åœºæ™¯

```dart
/// æ¶ˆè´¹åœºæ™¯åˆ†ææœåŠ¡ï¼ˆç²¾ç¡®ä½ç½®çº§åˆ«ï¼‰
/// èŒè´£ï¼šåˆ†ææ¶ˆè´¹çš„åœ°ç†åœºæ™¯ï¼Œä¸ºé’±é¾„è®¡ç®—æä¾›ä½ç½®ç»´åº¦çš„æ•°æ®å¢å¼º
/// å‚è§ 11.0.1 ä½ç½®æœåŠ¡å±‚æ¬¡ç»“æ„
class SpendingContextAnalyzer {
  final PreciseLocationService _locationService;
  final UserHomeLocationService _homeService;
  final MoneyAgeCalculator _baseCalculator;  // ç”¨äºåˆ†åœºæ™¯é’±é¾„è®¡ç®—

  /// ç”¨æˆ·å¸¸é©»åœ°ç‚¹ï¼ˆå®¶ã€å…¬å¸ï¼‰
  PreciseLocation? _homeLocation;
  PreciseLocation? _workLocation;

  /// åˆå§‹åŒ–ç”¨æˆ·å¸¸é©»åœ°ç‚¹
  Future<void> initializeHomeLocations() async {
    _homeLocation = await _homeService.getHomeLocation();
    _workLocation = await _homeService.getWorkLocation();
  }

  /// åŸºäºç²¾ç¡®ä½ç½®çš„æ¶ˆè´¹åœºæ™¯åˆ†æ
  Future<SpendingContextAnalysis> analyzeSpendingContext(
    Transaction tx,
    PreciseLocation txLocation,
  ) async {
    // 1. è®¡ç®—ä¸å®¶çš„è·ç¦»
    double? distanceFromHome;
    if (_homeLocation != null) {
      distanceFromHome = txLocation.distanceTo(_homeLocation!);
    }

    // 2. è®¡ç®—ä¸å…¬å¸çš„è·ç¦»
    double? distanceFromWork;
    if (_workLocation != null) {
      distanceFromWork = txLocation.distanceTo(_workLocation!);
    }

    // 3. ç¡®å®šæ¶ˆè´¹åœºæ™¯
    final context = _determineSpendingContext(
      tx: tx,
      location: txLocation,
      distanceFromHome: distanceFromHome,
      distanceFromWork: distanceFromWork,
    );

    return SpendingContextAnalysis(
      transaction: tx,
      location: txLocation,
      context: context,
      distanceFromHome: distanceFromHome,
      distanceFromWork: distanceFromWork,
      isCommute: _isCommuteSpending(txLocation, tx.time),
      isBusinessTrip: await _detectBusinessTrip(txLocation, tx),
      isVacation: await _detectVacation(txLocation, tx),
    );
  }

  /// ç¡®å®šæ¶ˆè´¹åœºæ™¯
  SpendingContext _determineSpendingContext({
    required Transaction tx,
    required PreciseLocation location,
    double? distanceFromHome,
    double? distanceFromWork,
  }) {
    // å®¶é™„è¿‘æ¶ˆè´¹ï¼ˆ500ç±³èŒƒå›´å†…ï¼‰
    if (distanceFromHome != null && distanceFromHome < 500) {
      return SpendingContext.nearHome;
    }

    // å…¬å¸é™„è¿‘æ¶ˆè´¹ï¼ˆ300ç±³èŒƒå›´å†…ï¼‰
    if (distanceFromWork != null && distanceFromWork < 300) {
      return SpendingContext.nearWork;
    }

    // é€šå‹¤è·¯ä¸Šæ¶ˆè´¹
    if (_isOnCommutePath(location)) {
      return SpendingContext.commuting;
    }

    // å•†åœˆæ¶ˆè´¹
    if (location.areaType == AreaType.commercial) {
      return SpendingContext.commercial;
    }

    // è¿œè·ç¦»æ¶ˆè´¹ï¼ˆè¶…è¿‡50å…¬é‡Œï¼‰
    if (distanceFromHome != null && distanceFromHome > 50000) {
      return SpendingContext.travel;
    }

    return SpendingContext.other;
  }

  /// æ£€æµ‹æ˜¯å¦ä¸ºé€šå‹¤æ¶ˆè´¹
  bool _isCommuteSpending(PreciseLocation location, DateTime time) {
    // å·¥ä½œæ—¥æ—©æ™šé«˜å³°æ—¶æ®µ
    final weekday = time.weekday;
    final hour = time.hour;

    if (weekday >= 6) return false; // å‘¨æœ«éé€šå‹¤

    final isMorningRush = hour >= 7 && hour <= 9;
    final isEveningRush = hour >= 17 && hour <= 20;

    if (!isMorningRush && !isEveningRush) return false;

    // åœ¨é€šå‹¤è·¯å¾„ä¸Š
    return _isOnCommutePath(location);
  }

  /// æ£€æµ‹æ˜¯å¦åœ¨é€šå‹¤è·¯å¾„ä¸Š
  bool _isOnCommutePath(PreciseLocation location) {
    if (_homeLocation == null || _workLocation == null) return false;

    // è®¡ç®—ç‚¹åˆ°å®¶-å…¬å¸è¿çº¿çš„è·ç¦»
    final distToHome = location.distanceTo(_homeLocation!);
    final distToWork = location.distanceTo(_workLocation!);
    final homeToWork = _homeLocation!.distanceTo(_workLocation!);

    // å¦‚æœå½“å‰ä½ç½®åˆ°å®¶å’Œå…¬å¸çš„è·ç¦»ä¹‹å’Œæ¥è¿‘å®¶åˆ°å…¬å¸çš„è·ç¦»
    // è¯´æ˜åœ¨é€šå‹¤è·¯å¾„ä¸Šï¼ˆå…è®¸2å…¬é‡Œè¯¯å·®ï¼‰
    return (distToHome + distToWork - homeToWork).abs() < 2000;
  }

  /// æ£€æµ‹å‡ºå·®æ¶ˆè´¹
  Future<bool> _detectBusinessTrip(PreciseLocation location, Transaction tx) async {
    // å·¥ä½œæ—¥åœ¨å¼‚åœ°
    if (tx.time.weekday >= 6) return false;

    // è·ç¦»å®¶è¶…è¿‡100å…¬é‡Œ
    if (_homeLocation == null) return false;
    final distance = location.distanceTo(_homeLocation!);
    if (distance < 100000) return false;

    // æ¶ˆè´¹ç±»å‹ä¸ºå•†åŠ¡ç›¸å…³
    final businessCategories = ['äº¤é€š', 'ä½å®¿', 'é¤é¥®', 'é€šè®¯'];
    if (!businessCategories.contains(tx.category)) return false;

    // POIä¸ºå•†åŠ¡åŒºåŸŸ
    if (location.areaType == AreaType.office) return true;

    return true;
  }

  /// æ£€æµ‹æ—…æ¸¸æ¶ˆè´¹
  Future<bool> _detectVacation(PreciseLocation location, Transaction tx) async {
    // å‘¨æœ«æˆ–èŠ‚å‡æ—¥
    final isWeekend = tx.time.weekday >= 6;

    // è·ç¦»å®¶è¶…è¿‡30å…¬é‡Œ
    if (_homeLocation == null) return false;
    final distance = location.distanceTo(_homeLocation!);
    if (distance < 30000) return false;

    // æ¶ˆè´¹ç±»å‹ä¸ºæ—…æ¸¸ç›¸å…³
    final vacationCategories = ['äº¤é€š', 'ä½å®¿', 'é¤é¥®', 'å¨±ä¹', 'é—¨ç¥¨', 'è´­ç‰©'];
    if (!vacationCategories.contains(tx.category)) return false;

    // POIä¸ºæ—…æ¸¸/å¨±ä¹åŒºåŸŸ
    if (location.nearbyPOI?.category == POICategory.entertainment) return true;

    // å‘¨æœ«å¼‚åœ°æ¶ˆè´¹å¤§æ¦‚ç‡æ˜¯æ—…æ¸¸
    if (isWeekend && distance > 50000) return true;

    return false;
  }

  /// è®¡ç®—ç²¾ç¡®ä½ç½®å¢å¼ºçš„é’±é¾„
  Future<PreciseMoneyAge> calculatePreciseMoneyAge({
    required List<Transaction> transactions,
    required List<Income> incomes,
  }) async {
    // æŒ‰æ¶ˆè´¹åœºæ™¯åˆ†ç±»äº¤æ˜“
    final contextMap = <SpendingContext, List<Transaction>>{};
    final analysisResults = <SpendingContextAnalysis>[];

    for (final tx in transactions) {
      if (tx.location == null) {
        // æ— ä½ç½®ä¿¡æ¯çš„äº¤æ˜“å½’å…¥æ—¥å¸¸
        contextMap.putIfAbsent(SpendingContext.other, () => []).add(tx);
        continue;
      }

      final analysis = await analyzeSpendingContext(tx, tx.location!);
      analysisResults.add(analysis);
      contextMap.putIfAbsent(analysis.context, () => []).add(tx);
    }

    // åˆ†åœºæ™¯è®¡ç®—é’±é¾„
    final contextMoneyAges = <SpendingContext, MoneyAge>{};
    for (final entry in contextMap.entries) {
      contextMoneyAges[entry.key] = _baseCalculator.calculate(entry.value, incomes);
    }

    // è®¡ç®—æ—¥å¸¸æ¶ˆè´¹é’±é¾„ï¼ˆæ’é™¤å‡ºå·®å’Œæ—…æ¸¸ï¼‰
    final dailyTransactions = transactions.where((tx) {
      final analysis = analysisResults.firstWhere(
        (a) => a.transaction == tx,
        orElse: () => SpendingContextAnalysis.empty(tx),
      );
      return !analysis.isBusinessTrip && !analysis.isVacation;
    }).toList();

    final dailyMoneyAge = _baseCalculator.calculate(dailyTransactions, incomes);

    // è®¡ç®—ç»¼åˆé’±é¾„ï¼ˆåŠ æƒï¼‰
    final overallMoneyAge = _calculateWeightedMoneyAge(
      contextMoneyAges: contextMoneyAges,
      weights: {
        SpendingContext.nearHome: 1.0,      // å®¶é™„è¿‘æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.nearWork: 1.0,      // å…¬å¸é™„è¿‘æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.commuting: 1.0,     // é€šå‹¤æ¶ˆè´¹å…¨æƒé‡
        SpendingContext.commercial: 0.9,    // å•†åœˆæ¶ˆè´¹ç•¥é™æƒé‡
        SpendingContext.travel: 0.3,        // æ—…æ¸¸æ¶ˆè´¹ä½æƒé‡
        SpendingContext.other: 0.8,         // å…¶ä»–æ¶ˆè´¹ä¸­ç­‰æƒé‡
      },
    );

    return PreciseMoneyAge(
      overall: overallMoneyAge,
      daily: dailyMoneyAge,
      byContext: contextMoneyAges,
      analysisResults: analysisResults,
      insights: _generateLocationInsights(analysisResults),
    );
  }

  /// ç”Ÿæˆä½ç½®ç›¸å…³æ´å¯Ÿ
  List<LocationInsight> _generateLocationInsights(
    List<SpendingContextAnalysis> analyses,
  ) {
    final insights = <LocationInsight>[];

    // ç»Ÿè®¡å„åœºæ™¯æ¶ˆè´¹
    final contextStats = <SpendingContext, double>{};
    for (final a in analyses) {
      contextStats.update(
        a.context,
        (v) => v + a.transaction.amount,
        ifAbsent: () => a.transaction.amount,
      );
    }

    // å•†åœˆæ¶ˆè´¹å æ¯”åˆ†æ
    final totalSpending = contextStats.values.fold(0.0, (a, b) => a + b);
    final commercialSpending = contextStats[SpendingContext.commercial] ?? 0;
    if (commercialSpending / totalSpending > 0.4) {
      insights.add(LocationInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹å æ¯”è¾ƒé«˜',
        description: 'å•†åœˆæ¶ˆè´¹å æ€»æ”¯å‡ºçš„${(commercialSpending / totalSpending * 100).toStringAsFixed(0)}%ï¼Œ'
            'å»ºè®®æ§åˆ¶å†²åŠ¨æ¶ˆè´¹',
        suggestion: 'è®¾ç½®å•†åœˆæ¶ˆè´¹é¢„è­¦ï¼Œè¿›å…¥å•†åœˆæ—¶æé†’å½“æœˆé¢„ç®—',
        impact: commercialSpending * 0.2, // å‡è®¾å¯èŠ‚çœ20%
      ));
    }

    // é€šå‹¤æ¶ˆè´¹åˆ†æ
    final commuteSpending = contextStats[SpendingContext.commuting] ?? 0;
    if (commuteSpending > 500) {
      insights.add(LocationInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤è·¯ä¸Šæ¶ˆè´¹è¾ƒå¤š',
        description: 'æœ¬æœˆé€šå‹¤æ¶ˆè´¹Â¥${commuteSpending.toStringAsFixed(0)}ï¼Œ'
            'ä¸»è¦å‘ç”Ÿåœ¨æ—©æ™šé«˜å³°',
        suggestion: 'æå‰å‡†å¤‡æ—©é¤ã€è§„åˆ’å›ºå®šè·¯çº¿å¯å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
        impact: commuteSpending * 0.3,
      ));
    }

    // æ—…æ¸¸æ¶ˆè´¹å¯¹é’±é¾„çš„å½±å“
    final travelAnalyses = analyses.where((a) => a.isVacation).toList();
    if (travelAnalyses.length > 3) {
      final travelSpending = travelAnalyses.fold(0.0, (s, a) => s + a.transaction.amount);
      insights.add(LocationInsight(
        type: InsightType.info,
        title: 'æ—…æ¸¸æ¶ˆè´¹å·²å•ç‹¬è®¡ç®—',
        description: 'æœ¬æœˆ${travelAnalyses.length}ç¬”æ—…æ¸¸æ¶ˆè´¹å…±Â¥${travelSpending.toStringAsFixed(0)}ï¼Œ'
            'å·²ä»æ—¥å¸¸é’±é¾„è®¡ç®—ä¸­åˆ†ç¦»',
        suggestion: 'æ—¥å¸¸é’±é¾„ä¸å—æ—…æ¸¸æ¶ˆè´¹å½±å“ï¼Œå¯æ”¾å¿ƒå‡ºè¡Œ',
        impact: 0,
      ));
    }

    return insights;
  }
}

/// æ¶ˆè´¹åœºæ™¯
enum SpendingContext {
  nearHome,    // å®¶é™„è¿‘
  nearWork,    // å…¬å¸é™„è¿‘
  commuting,   // é€šå‹¤è·¯ä¸Š
  commercial,  // å•†åœˆ
  travel,      // æ—…è¡Œ/å‡ºå·®
  other,       // å…¶ä»–
}

/// æ¶ˆè´¹åœºæ™¯åˆ†æç»“æœ
class SpendingContextAnalysis {
  final Transaction transaction;
  final PreciseLocation? location;
  final SpendingContext context;
  final double? distanceFromHome;
  final double? distanceFromWork;
  final bool isCommute;
  final bool isBusinessTrip;
  final bool isVacation;

  static SpendingContextAnalysis empty(Transaction tx) {
    return SpendingContextAnalysis(
      transaction: tx,
      location: null,
      context: SpendingContext.other,
      isCommute: false,
      isBusinessTrip: false,
      isVacation: false,
    );
  }
}

/// ç²¾ç¡®ä½ç½®é’±é¾„
class PreciseMoneyAge {
  final MoneyAge overall;                           // ç»¼åˆé’±é¾„
  final MoneyAge daily;                             // æ—¥å¸¸æ¶ˆè´¹é’±é¾„
  final Map<SpendingContext, MoneyAge> byContext;  // åˆ†åœºæ™¯é’±é¾„
  final List<SpendingContextAnalysis> analysisResults;
  final List<LocationInsight> insights;

  /// è·å–é’±é¾„å¥åº·è¯„ä¼°
  MoneyAgeHealthAssessment getHealthAssessment() {
    // ä½¿ç”¨æ—¥å¸¸é’±é¾„è¿›è¡Œè¯„ä¼°ï¼ˆæ’é™¤æ—…æ¸¸/å‡ºå·®å½±å“ï¼‰
    final days = daily.days;

    if (days >= 30) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.excellent,
        message: 'èµ„é‡‘å‚¨å¤‡å……è¶³ï¼Œæ—¥å¸¸æ¶ˆè´¹è§„åˆ’åˆç†',
        dailyStatus: HealthStatus.excellent,
      );
    } else if (days >= 14) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.good,
        message: 'èµ„é‡‘çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒ',
        dailyStatus: HealthStatus.good,
      );
    } else if (days >= 7) {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.warning,
        message: 'èµ„é‡‘å‚¨å¤‡ç•¥ç´§ï¼Œå»ºè®®å‡å°‘éå¿…è¦æ”¯å‡º',
        dailyStatus: HealthStatus.warning,
        suggestion: 'å…³æ³¨æœ¬æœˆå•†åœˆæ¶ˆè´¹å’Œé€šå‹¤æ¶ˆè´¹',
      );
    } else {
      return MoneyAgeHealthAssessment(
        status: HealthStatus.critical,
        message: 'èµ„é‡‘å‚¨å¤‡ä¸è¶³ï¼Œè¯·æ§åˆ¶æ”¯å‡º',
        dailyStatus: HealthStatus.critical,
        suggestion: 'æš‚åœå•†åœˆæ¶ˆè´¹ï¼Œå‡å°‘å¤–å‡ºå°±é¤',
      );
    }
  }
}

/// ä½ç½®æ´å¯Ÿ
class LocationInsight {
  final InsightType type;
  final String title;
  final String description;
  final String suggestion;
  final double impact;  // æ½œåœ¨èŠ‚çœé‡‘é¢
}

enum InsightType { info, tip, warning, critical }
```

### 14.8 æœ¬åœ°åŒ–çœé’±å»ºè®®å¼•æ“

#### 14.8.1 åŸºäºä½ç½®çš„æ¶ˆè´¹ä¼˜åŒ–

```dart
/// æœ¬åœ°åŒ–çœé’±å»ºè®®æœåŠ¡
class LocalizedSavingTipsService {
  final PreciseLocationService _locationService;
  final TransactionRepository _txRepo;

  /// ç”Ÿæˆæœ¬åœ°åŒ–çœé’±å»ºè®®
  Future<List<LocalizedSavingTip>> generateTips() async {
    final location = await _locationService.getCurrentCity();
    if (location == null) return [];

    final recentTx = await _txRepo.getRecent(months: 3);
    final tips = <LocalizedSavingTip>[];

    // åˆ†æé€šå‹¤æ¶ˆè´¹
    tips.addAll(await _analyzeCommutingCost(recentTx, location));

    // åˆ†æé¤é¥®æ¶ˆè´¹
    tips.addAll(await _analyzeDiningCost(recentTx, location));

    // åˆ†æè´­ç‰©æ¶ˆè´¹
    tips.addAll(await _analyzeShoppingCost(recentTx, location));

    // åˆ†ææœ¬åœ°ä¼˜æƒ 
    tips.addAll(await _findLocalDiscounts(location));

    // æŒ‰èŠ‚çœé‡‘é¢æ’åº
    tips.sort((a, b) => b.monthlySaving.compareTo(a.monthlySaving));

    return tips;
  }

  /// åˆ†æé€šå‹¤æˆæœ¬å¹¶æä¾›æœ¬åœ°åŒ–å»ºè®®
  Future<List<LocalizedSavingTip>> _analyzeCommutingCost(
    List<Transaction> transactions,
    CityLocation location,
  ) async {
    final tips = <LocalizedSavingTip>[];

    // åˆ†æç½‘çº¦è½¦ä½¿ç”¨æƒ…å†µ
    final rideshareSpending = transactions
        .where((tx) => tx.category == 'ç½‘çº¦è½¦' || tx.description.contains('æ»´æ»´'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    if (rideshareSpending > 500) {
      // ä¸€çº¿åŸå¸‚æ¨èåœ°é“
      if (location.tier == CityTier.tier1 || location.tier == CityTier.newTier1) {
        tips.add(LocalizedSavingTip(
          title: 'é€šå‹¤ä¼˜åŒ–ï¼šåœ°é“æ›¿ä»£ç½‘çº¦è½¦',
          description: '${location.city}åœ°é“è¦†ç›–ç‡é«˜ï¼Œå·¥ä½œæ—¥é€šå‹¤æ”¹ç”¨åœ°é“æ›´ç»æµ',
          currentMonthlySpending: rideshareSpending,
          suggestedSpending: rideshareSpending * 0.3,
          monthlySaving: rideshareSpending * 0.7,
          moneyAgeImpact: (rideshareSpending * 0.7 / 600).round(), // å‡è®¾æ—¥å‡æ”¯å‡º600
          actionText: 'æŸ¥çœ‹${location.city}åœ°é“çº¿è·¯',
          localContext: '${location.city}åœ°é“æ—¥ç¥¨çº¦Â¥18ï¼Œè¿œä½äºå•æ¬¡ç½‘çº¦è½¦',
        ));
      }

      // ä¸‰å››çº¿åŸå¸‚æ¨èç”µåŠ¨è½¦
      if (location.tier == CityTier.tier3) {
        tips.add(LocalizedSavingTip(
          title: 'é€šå‹¤ä¼˜åŒ–ï¼šç”µåŠ¨è½¦å‡ºè¡Œ',
          description: '${location.city}å‡ºè¡Œè·ç¦»é€‚ä¸­ï¼Œç”µåŠ¨è½¦æ›´ç»æµç¯ä¿',
          currentMonthlySpending: rideshareSpending,
          suggestedSpending: 100, // ç”µåŠ¨è½¦æœˆå……ç”µè´¹
          monthlySaving: rideshareSpending - 100,
          moneyAgeImpact: ((rideshareSpending - 100) / 400).round(),
          actionText: 'äº†è§£æœ¬åœ°ç”µåŠ¨è½¦æ”¿ç­–',
        ));
      }
    }

    return tips;
  }

  /// åˆ†æé¤é¥®æˆæœ¬
  Future<List<LocalizedSavingTip>> _analyzeDiningCost(
    List<Transaction> transactions,
    CityLocation location,
  ) async {
    final tips = <LocalizedSavingTip>[];

    // åˆ†æå¤–å–æ¶ˆè´¹
    final deliverySpending = transactions
        .where((tx) => tx.description.contains('å¤–å–') ||
                       tx.description.contains('ç¾å›¢') ||
                       tx.description.contains('é¥¿äº†ä¹ˆ'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    // åˆ†æå¤–å–é…é€è´¹
    final deliveryFees = transactions
        .where((tx) => tx.description.contains('é…é€è´¹'))
        .fold(0.0, (sum, tx) => sum + tx.amount);

    if (deliveryFees > 100) {
      tips.add(LocalizedSavingTip(
        title: 'å¤–å–è‡ªå–çœé…é€è´¹',
        description: 'é™„è¿‘å•†å®¶è‡ªå–å¯çœé…é€è´¹',
        currentMonthlySpending: deliveryFees,
        suggestedSpending: 0,
        monthlySaving: deliveryFees,
        moneyAgeImpact: (deliveryFees / 600).round(),
        actionText: 'æŸ¥çœ‹é™„è¿‘è‡ªå–ä¼˜æƒ ',
        localContext: '${location.city}å¤–å–å‡ä»·çº¦Â¥30ï¼Œè‡ªå–é€šå¸¸è¿˜æœ‰æŠ˜æ‰£',
      ));
    }

    // ä¸€çº¿åŸå¸‚æ¨èå…¬å¸é£Ÿå ‚
    if (location.tier == CityTier.tier1 && deliverySpending > 1500) {
      tips.add(LocalizedSavingTip(
        title: 'åˆé¤é€‰æ‹©å…¬å¸é£Ÿå ‚/å‘¨è¾¹é£Ÿå ‚',
        description: 'å·¥ä½œæ—¥åˆé¤é€‰æ‹©é£Ÿå ‚ï¼Œæ¯”å¤–å–æ›´ç»æµå¥åº·',
        currentMonthlySpending: deliverySpending * 0.6, // å‡è®¾60%æ˜¯åˆé¤
        suggestedSpending: deliverySpending * 0.3,
        monthlySaving: deliverySpending * 0.3,
        moneyAgeImpact: (deliverySpending * 0.3 / 600).round(),
        actionText: 'æŸ¥çœ‹é™„è¿‘é£Ÿå ‚',
        localContext: '${location.city}å†™å­—æ¥¼é£Ÿå ‚å‡ä»·çº¦Â¥15-25ï¼Œå¤–å–å‡ä»·çº¦Â¥35-50',
      ));
    }

    return tips;
  }

  /// å‘ç°æœ¬åœ°ä¼˜æƒ æ´»åŠ¨
  Future<List<LocalizedSavingTip>> _findLocalDiscounts(
    CityLocation location,
  ) async {
    // TODO: æ¥å…¥æœ¬åœ°ä¼˜æƒ ä¿¡æ¯API
    // è¿™é‡Œæ¨¡æ‹Ÿä¸€äº›å¸¸è§çš„æœ¬åœ°ä¼˜æƒ 

    return [
      LocalizedSavingTip(
        title: '${location.city}ç”Ÿæ´»æ¶ˆè´¹åˆ¸',
        description: 'å…³æ³¨${location.city}æ¶ˆè´¹åˆ¸å‘æ”¾æ´»åŠ¨',
        monthlySaving: 200, // é¢„ä¼°
        moneyAgeImpact: 0,
        actionText: 'äº†è§£æ´»åŠ¨è¯¦æƒ…',
        localContext: 'æ”¿åºœæ¶ˆè´¹åˆ¸é€šå¸¸åœ¨èŠ‚å‡æ—¥å‘æ”¾',
        isPromotion: true,
      ),
    ];
  }
}

/// æœ¬åœ°åŒ–çœé’±å»ºè®®
class LocalizedSavingTip {
  final String title;
  final String description;
  final double currentMonthlySpending;
  final double suggestedSpending;
  final double monthlySaving;
  final int moneyAgeImpact;  // é¢„è®¡é’±é¾„æå‡å¤©æ•°
  final String? actionText;
  final String? localContext;
  final bool isPromotion;
}
```

#### 14.8.2 çœé’±å»ºè®®ä¸é’±é¾„å…³è”å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ æœ¬åœ°åŒ–çœé’±å»ºè®®ï¼ˆåŸºäº${city}æ¶ˆè´¹æ°´å¹³ï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸš‡ é€šå‹¤ä¼˜åŒ–ï¼šåœ°é“æ›¿ä»£ç½‘çº¦è½¦                                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰ç½‘çº¦è½¦æ¶ˆè´¹: Â¥680/æœˆ                                     â”‚   â”‚
â”‚  â”‚  å»ºè®®æ”¹ç”¨åœ°é“: Â¥200/æœˆ                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥480    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.8å¤©          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ ä¸Šæµ·åœ°é“æ—¥ç¥¨Â¥18ï¼Œè¦†ç›–ä¸»è¦å•†åœˆ                           â”‚   â”‚
â”‚  â”‚                                              [æŸ¥çœ‹åœ°é“çº¿è·¯]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ± åˆé¤ä¼˜åŒ–ï¼šå…¬å¸é£Ÿå ‚æ›¿ä»£å¤–å–                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰å·¥ä½œæ—¥åˆé¤: Â¥45/å¤© Ã— 22å¤© = Â¥990/æœˆ                    â”‚   â”‚
â”‚  â”‚  å»ºè®®é£Ÿå ‚å°±é¤: Â¥20/å¤© Ã— 22å¤© = Â¥440/æœˆ                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥550    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.9å¤©          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ ä¸Šæµ·å†™å­—æ¥¼é£Ÿå ‚å‡ä»·Â¥15-25ï¼Œæ¯”å¤–å–èŠ‚çœ40%+                â”‚   â”‚
â”‚  â”‚                                              [æŸ¥çœ‹é™„è¿‘é£Ÿå ‚]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ·ï¸ å¤–å–è‡ªå–çœé…é€è´¹                                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å½“å‰æœˆé…é€è´¹æ”¯å‡º: Â¥150                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ¯æœˆèŠ‚çœ Â¥150    â”‚    â±ï¸ é’±é¾„æå‡çº¦ 0.25å¤©         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ è‡ªå–é€šå¸¸è¿˜æœ‰é¢å¤–5-10%æŠ˜æ‰£                                â”‚   â”‚
â”‚  â”‚                                           [æŸ¥çœ‹è‡ªå–ä¼˜æƒ å•†å®¶]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚   ğŸ“Š ç»¼åˆæ‰§è¡Œé¢„è®¡ï¼šæ¯æœˆèŠ‚çœ Â¥1,180  â”‚  é’±é¾„æå‡çº¦ 2å¤©/æœˆ         â”‚
â”‚                                                                     â”‚
â”‚                                           [å¼€å§‹æ‰§è¡Œçœé’±è®¡åˆ’ â†’]     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.9 è·¨åŒºåŸŸè´¢åŠ¡é£é™©ç®¡ç†

#### 14.9.1 å¼‚åœ°/æµ·å¤–æ¶ˆè´¹é£é™©é¢„è­¦

```dart
/// è·¨åŒºåŸŸè´¢åŠ¡é£é™©æç¤ºæœåŠ¡
class CrossRegionRiskAlertService {
  /// åœ¨è®°è´¦æ—¶æ£€æµ‹å¹¶æç¤ºé£é™©
  Future<List<RiskAlert>> checkRisks(
    Transaction tx,
    CityLocation currentLocation,
    CityLocation homeLocation,
  ) async {
    final alerts = <RiskAlert>[];

    // æ£€æµ‹æµ·å¤–æ¶ˆè´¹
    if (currentLocation.isOverseas) {
      alerts.addAll(_checkOverseasRisks(tx, currentLocation));
    }

    // æ£€æµ‹è·¨åŸæ¶ˆè´¹
    if (currentLocation.city != homeLocation.city) {
      alerts.addAll(_checkCrossCityRisks(tx, currentLocation));
    }

    return alerts;
  }

  /// æµ·å¤–æ¶ˆè´¹é£é™©æ£€æµ‹
  List<RiskAlert> _checkOverseasRisks(Transaction tx, CityLocation location) {
    final alerts = <RiskAlert>[];

    // æ±‡ç‡é£é™©
    alerts.add(RiskAlert(
      type: RiskType.exchangeRate,
      title: 'æ±‡ç‡æé†’',
      description: 'è·¨å¢ƒæ”¯ä»˜å¯èƒ½äº§ç”Ÿ1-3%çš„æ±‡ç‡å·®',
      suggestion: 'å»ºè®®é¢„ç•™æ±‡ç‡æŸå¤±é¢„ç®—ï¼Œçº¦æ¶ˆè´¹é¢çš„2%',
      impact: tx.amount * 0.02,
    ));

    // å°è´¹æé†’ï¼ˆç¾å›½ç­‰å›½å®¶ï¼‰
    final tipCountries = ['US', 'CA', 'GB'];
    if (tipCountries.contains(location.countryCode)) {
      alerts.add(RiskAlert(
        type: RiskType.tip,
        title: 'å°è´¹æé†’',
        description: '${location.country}é¤é¥®æœåŠ¡é€šå¸¸éœ€è¦15-20%å°è´¹',
        suggestion: 'åœ¨é¤é¥®é¢„ç®—ä¸­é¢„ç•™å°è´¹',
        impact: tx.amount * 0.18,
      ));
    }

    // è·¨å¢ƒæ‰‹ç»­è´¹
    alerts.add(RiskAlert(
      type: RiskType.fee,
      title: 'è·¨å¢ƒæ‰‹ç»­è´¹',
      description: 'éƒ¨åˆ†é“¶è¡Œå¡è·¨å¢ƒæ¶ˆè´¹æ”¶å–1-2%æ‰‹ç»­è´¹',
      suggestion: 'æ¨èä½¿ç”¨å…æ‰‹ç»­è´¹çš„å…¨å¸ç§ä¿¡ç”¨å¡',
      impact: tx.amount * 0.015,
    ));

    return alerts;
  }

  /// è·¨åŸæ¶ˆè´¹é£é™©æ£€æµ‹
  List<RiskAlert> _checkCrossCityRisks(Transaction tx, CityLocation location) {
    final alerts = <RiskAlert>[];

    // é¢„ç®—å½’å±æé†’
    alerts.add(RiskAlert(
      type: RiskType.budgetAllocation,
      title: 'å¼‚åœ°æ¶ˆè´¹å½’ç±»',
      description: 'æ£€æµ‹åˆ°æ‚¨åœ¨${location.city}æ¶ˆè´¹',
      suggestion: 'å»ºè®®å½’å…¥"å‡ºå·®/æ—…æ¸¸"ä¸´æ—¶é¢„ç®—ï¼Œé¿å…å½±å“æ—¥å¸¸é¢„ç®—',
      actionLabel: 'ä½¿ç”¨ä¸´æ—¶é¢„ç®—',
    ));

    return alerts;
  }
}

/// é£é™©æç¤ºå¼¹çª—ç»„ä»¶
class RiskAlertDialog extends StatelessWidget {
  final List<RiskAlert> alerts;
  final Transaction transaction;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(Icons.info_outline, color: Colors.orange),
          SizedBox(width: 8),
          Text('æ¶ˆè´¹æé†’'),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // äº¤æ˜“ä¿¡æ¯
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(transaction.description),
                Text('Â¥${transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(fontWeight: FontWeight.bold)),
              ],
            ),
          ),
          SizedBox(height: 16),

          // é£é™©æç¤ºåˆ—è¡¨
          ...alerts.map((alert) => _buildAlertItem(alert)),

          // é¢„ä¼°é¢å¤–æˆæœ¬
          if (alerts.any((a) => a.impact > 0)) ...[
            Divider(),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text('é¢„ä¼°é¢å¤–æˆæœ¬:'),
                Text('Â¥${_totalImpact.toStringAsFixed(2)}',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: Colors.orange,
                  )),
              ],
            ),
          ],
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('çŸ¥é“äº†'),
        ),
        ElevatedButton(
          onPressed: () => _applyTemporaryBudget(context),
          child: Text('ä½¿ç”¨ä¸´æ—¶é¢„ç®—'),
        ),
      ],
    );
  }

  double get _totalImpact =>
      alerts.fold(0.0, (sum, a) => sum + a.impact);
}
```

### 14.10 ä½ç½®æƒé™ä¸è®¾ç½®ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  ä½ç½®æœåŠ¡è®¾ç½®                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ ç²¾ç¡®ä½ç½®æœåŠ¡                                   [å¼€å¯] âœ“  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å¼€å¯åå¯è·å¾—ï¼š                                              â”‚   â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½æ¶ˆè´¹åœºæ™¯è¯†åˆ«ï¼ˆå®¶/å…¬å¸/å•†åœˆ/æ—…è¡Œï¼‰                     â”‚   â”‚
â”‚  â”‚  â€¢ ç²¾ç¡®ä½ç½®é’±é¾„åˆ†æï¼ˆåŒºåˆ†æ—¥å¸¸/å‡ºå·®/æ—…æ¸¸ï¼‰                    â”‚   â”‚
â”‚  â”‚  â€¢ åœ°ç†å›´æ é¢„ç®—æé†’ï¼ˆè¿›å…¥å•†åœˆè‡ªåŠ¨æé†’ï¼‰                      â”‚   â”‚
â”‚  â”‚  â€¢ POIå•†æˆ·è‡ªåŠ¨åŒ¹é…ï¼ˆç²¾å‡†åˆ†ç±»æ¶ˆè´¹ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ é€šå‹¤æ¶ˆè´¹è¿½è¸ªä¸ä¼˜åŒ–å»ºè®®                                    â”‚   â”‚
â”‚  â”‚  â€¢ æœ¬åœ°åŒ–çœé’±æ¨èï¼ˆåŸºäºç²¾ç¡®ä½ç½®ï¼‰                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ  å¸¸é©»åœ°ç‚¹è®¾ç½®                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  å®¶åº­ä½ç½®: ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºxxxè·¯         [è‡ªåŠ¨æ£€æµ‹] [æ‰‹åŠ¨è®¾ç½®]  â”‚   â”‚
â”‚  â”‚  å…¬å¸ä½ç½®: ä¸Šæµ·å¸‚é»„æµ¦åŒºxxxå¹¿åœº         [è‡ªåŠ¨æ£€æµ‹] [æ‰‹åŠ¨è®¾ç½®]  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è®¾ç½®åå¯æ™ºèƒ½è¯†åˆ«é€šå‹¤æ¶ˆè´¹ã€å®¶é™„è¿‘æ¶ˆè´¹ç­‰åœºæ™¯              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¯ åœ°ç†å›´æ é¢„ç®—æé†’                              [å¼€å¯] âœ“   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  å•†åœˆæé†’                                   [å¼€å¯]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  è¿›å…¥å•†åœˆæ—¶æé†’å½“æœˆè´­ç‰©é¢„ç®—                          â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  é¤é¥®åŒºæé†’                                 [å¼€å¯]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  åœ¨é¤é¥®é›†ä¸­åŒºåŸŸæé†’é¤é¥®é¢„ç®—                          â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  è‡ªå®šä¹‰å›´æ                                  [æ·»åŠ ]   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  è®¾ç½®ç‰¹å®šåŒºåŸŸçš„é¢„ç®—æé†’                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ” æ•°æ®å®‰å…¨ä¿éšœ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  âœ“ ä½ç½®æ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨ï¼ˆAES-256ï¼‰                          â”‚   â”‚
â”‚  â”‚  âœ“ ä»…ç”¨äºæ™ºèƒ½è®°è´¦åŠŸèƒ½                                       â”‚   â”‚
â”‚  â”‚  âœ“ ä¸ä¸Šä¼ åŸå§‹åæ ‡åˆ°äº‘ç«¯                                     â”‚   â”‚
â”‚  â”‚  âœ“ 30å¤©è‡ªåŠ¨æ¸…ç†å†å²è½¨è¿¹                                     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  [æŸ¥çœ‹æ•°æ®ä½¿ç”¨è¯¦æƒ…]              [ç«‹å³æ¸…é™¤æ‰€æœ‰ä½ç½®æ•°æ®]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æ™ºèƒ½åˆ†ææˆæ•ˆ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åœºæ™¯è¯†åˆ«å‡†ç¡®ç‡: 94.2%                                       â”‚   â”‚
â”‚  â”‚  å•†åœˆæ¶ˆè´¹æé†’è§¦å‘: 23 æ¬¡                                     â”‚   â”‚
â”‚  â”‚  æ—…æ¸¸æ¶ˆè´¹è‡ªåŠ¨åˆ†ç¦»: 8 æ¬¡                                      â”‚   â”‚
â”‚  â”‚  é¢„ä¼°å¸®æ‚¨èŠ‚çœ: Â¥3,680                                        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  æœ¬æœˆä½ç½®åˆ†æ                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ å®¶é™„è¿‘   45%   Â¥2,340                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ å…¬å¸é™„è¿‘ 32%   Â¥1,890                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ å•†åœˆ     15%   Â¥1,200                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ å…¶ä»–      8%   Â¥560                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.11 ä½ç½®æ™ºèƒ½åœ¨é›¶åŸºé¢„ç®—ä¸­çš„åº”ç”¨

é›¶åŸºé¢„ç®—çš„æ ¸å¿ƒç†å¿µæ˜¯"æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„"ï¼Œç²¾ç¡®ä½ç½®å¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´æ™ºèƒ½åœ°åˆ†é…å’Œç®¡ç†é¢„ç®—ã€‚

#### 14.11.1 åŸºäºä½ç½®çš„æ™ºèƒ½é¢„ç®—åˆ†é…

```dart
/// ä½ç½®æ„ŸçŸ¥çš„é›¶åŸºé¢„ç®—æœåŠ¡
class LocationAwareZeroBudgetService {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final TransactionRepository _txRepo;
  final UserHomeLocationService _homeService;

  /// åŸºäºç”¨æˆ·ä½ç½®æ¨¡å¼åˆ†æé¢„ç®—åˆ†é…å»ºè®®
  Future<LocationBasedBudgetSuggestion> suggestBudgetAllocation({
    required double monthlyIncome,
    required List<Transaction> historicalTransactions,
  }) async {
    // åˆ†æå†å²æ¶ˆè´¹çš„ä½ç½®æ¨¡å¼
    final locationPattern = await _analyzeLocationPattern(historicalTransactions);

    // åŸºäºä½ç½®æ¨¡å¼ç”Ÿæˆé¢„ç®—å»ºè®®
    return LocationBasedBudgetSuggestion(
      income: monthlyIncome,
      allocations: _generateLocationBasedAllocations(monthlyIncome, locationPattern),
      insights: _generateAllocationInsights(locationPattern),
    );
  }

  /// åˆ†æå†å²æ¶ˆè´¹çš„ä½ç½®æ¨¡å¼
  Future<LocationPattern> _analyzeLocationPattern(
    List<Transaction> transactions,
  ) async {
    final home = await _homeService.getHomeLocation();
    final work = await _homeService.getWorkLocation();

    // ç»Ÿè®¡å„ä½ç½®çš„æ¶ˆè´¹æƒ…å†µ
    double nearHomeSpending = 0;
    double nearWorkSpending = 0;
    double commuteSpending = 0;
    double commercialSpending = 0;
    double travelSpending = 0;

    final categoryByLocation = <SpendingContext, Map<String, double>>{};

    for (final tx in transactions) {
      if (tx.location == null) continue;

      final context = _determineContext(tx.location!, home, work);

      switch (context) {
        case SpendingContext.nearHome:
          nearHomeSpending += tx.amount;
          break;
        case SpendingContext.nearWork:
          nearWorkSpending += tx.amount;
          break;
        case SpendingContext.commuting:
          commuteSpending += tx.amount;
          break;
        case SpendingContext.commercial:
          commercialSpending += tx.amount;
          break;
        case SpendingContext.travel:
          travelSpending += tx.amount;
          break;
        default:
          break;
      }

      // ç»Ÿè®¡å„ä½ç½®çš„æ¶ˆè´¹ç±»ç›®
      categoryByLocation.putIfAbsent(context, () => {});
      categoryByLocation[context]!.update(
        tx.category,
        (v) => v + tx.amount,
        ifAbsent: () => tx.amount,
      );
    }

    return LocationPattern(
      nearHomeSpending: nearHomeSpending,
      nearWorkSpending: nearWorkSpending,
      commuteSpending: commuteSpending,
      commercialSpending: commercialSpending,
      travelSpending: travelSpending,
      categoryByLocation: categoryByLocation,
      totalSpending: transactions.fold(0.0, (s, tx) => s + tx.amount),
    );
  }

  /// åŸºäºä½ç½®æ¨¡å¼ç”Ÿæˆé¢„ç®—åˆ†é…
  List<LocationBudgetAllocation> _generateLocationBasedAllocations(
    double income,
    LocationPattern pattern,
  ) {
    final total = pattern.totalSpending;
    if (total == 0) return [];

    final allocations = <LocationBudgetAllocation>[];

    // 1. å®¶é™„è¿‘é¢„ç®—ï¼ˆæ—¥ç”¨å“ã€ç¤¾åŒºæ¶ˆè´¹ï¼‰
    final homeRatio = pattern.nearHomeSpending / total;
    if (homeRatio > 0.1) {
      allocations.add(LocationBudgetAllocation(
        name: 'å®¶é™„è¿‘æ¶ˆè´¹',
        context: SpendingContext.nearHome,
        amount: income * homeRatio * 0.95, // ç•¥å¾®æ”¶ç´§
        percentage: homeRatio * 0.95,
        categories: pattern.categoryByLocation[SpendingContext.nearHome] ?? {},
        description: 'ç¤¾åŒºè¶…å¸‚ã€ä¾¿åˆ©åº—ã€å‘¨è¾¹é¤é¥®',
        icon: Icons.home,
      ));
    }

    // 2. å·¥ä½œåŒºé¢„ç®—ï¼ˆåˆé¤ã€å·¥ä½œç›¸å…³ï¼‰
    final workRatio = pattern.nearWorkSpending / total;
    if (workRatio > 0.1) {
      allocations.add(LocationBudgetAllocation(
        name: 'å·¥ä½œåŒºæ¶ˆè´¹',
        context: SpendingContext.nearWork,
        amount: income * workRatio * 0.90, // å¯ä¼˜åŒ–ç©ºé—´è¾ƒå¤§
        percentage: workRatio * 0.90,
        categories: pattern.categoryByLocation[SpendingContext.nearWork] ?? {},
        description: 'å·¥ä½œåˆé¤ã€å’–å•¡ã€åŠå…¬ç”¨å“',
        icon: Icons.business,
        optimizationTip: 'è€ƒè™‘è‡ªå¸¦åˆé¤ï¼Œæ¯æœˆå¯çœÂ¥${(income * workRatio * 0.1).toStringAsFixed(0)}',
      ));
    }

    // 3. é€šå‹¤é¢„ç®—
    final commuteRatio = pattern.commuteSpending / total;
    if (commuteRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'é€šå‹¤æ¶ˆè´¹',
        context: SpendingContext.commuting,
        amount: income * commuteRatio * 0.85, // å¯ä¼˜åŒ–ç©ºé—´å¤§
        percentage: commuteRatio * 0.85,
        categories: pattern.categoryByLocation[SpendingContext.commuting] ?? {},
        description: 'äº¤é€šè´¹ã€æ—©é¤ã€è·¯ä¸Šé›¶é£Ÿ',
        icon: Icons.commute,
        optimizationTip: 'å›ºå®šé€šå‹¤è·¯çº¿å¯å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
      ));
    }

    // 4. å•†åœˆå¨±ä¹é¢„ç®—ï¼ˆä¸¥æ ¼æ§åˆ¶ï¼‰
    final commercialRatio = pattern.commercialSpending / total;
    if (commercialRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'å•†åœˆå¨±ä¹',
        context: SpendingContext.commercial,
        amount: income * commercialRatio * 0.80, // è¾ƒå¤§æ”¶ç´§
        percentage: commercialRatio * 0.80,
        categories: pattern.categoryByLocation[SpendingContext.commercial] ?? {},
        description: 'è´­ç‰©ã€é¤é¥®ã€å¨±ä¹',
        icon: Icons.shopping_bag,
        optimizationTip: 'å•†åœˆæ¶ˆè´¹å†²åŠ¨æ€§å¼ºï¼Œå»ºè®®è®¾ç½®æ¶ˆè´¹é™é¢',
        requiresApproval: true, // è¶…æ”¯éœ€å®¡æ‰¹
      ));
    }

    // 5. æ—…è¡Œ/å‡ºå·®é¢„ç®—ï¼ˆå•ç‹¬è®¡åˆ’ï¼‰
    final travelRatio = pattern.travelSpending / total;
    if (travelRatio > 0.05) {
      allocations.add(LocationBudgetAllocation(
        name: 'æ—…è¡Œ/å‡ºå·®',
        context: SpendingContext.travel,
        amount: income * travelRatio, // ä¿æŒåŸæ¯”ä¾‹
        percentage: travelRatio,
        categories: pattern.categoryByLocation[SpendingContext.travel] ?? {},
        description: 'å¼‚åœ°äº¤é€šã€ä½å®¿ã€é¤é¥®',
        icon: Icons.flight,
        isSeparateBudget: true, // ç‹¬ç«‹é¢„ç®—
      ));
    }

    // 6. å‚¨è“„é¢„ç®—
    final savingsAmount = income * 0.20; // å»ºè®®20%å‚¨è“„
    allocations.add(LocationBudgetAllocation(
      name: 'å‚¨è“„/æŠ•èµ„',
      context: SpendingContext.other,
      amount: savingsAmount,
      percentage: 0.20,
      categories: {},
      description: 'åº”æ€¥é‡‘ã€æŠ•èµ„ã€é•¿æœŸç›®æ ‡',
      icon: Icons.savings,
      priority: 1, // æœ€é«˜ä¼˜å…ˆçº§
    ));

    return allocations;
  }

  /// ç”Ÿæˆé¢„ç®—åˆ†é…æ´å¯Ÿ
  List<BudgetInsight> _generateAllocationInsights(LocationPattern pattern) {
    final insights = <BudgetInsight>[];
    final total = pattern.totalSpending;

    // å•†åœˆæ¶ˆè´¹æ¯”ä¾‹è¿‡é«˜
    if (pattern.commercialSpending / total > 0.3) {
      insights.add(BudgetInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹å æ¯”è¿‡é«˜',
        description: 'å•†åœˆæ¶ˆè´¹å æ€»æ”¯å‡º${(pattern.commercialSpending / total * 100).toStringAsFixed(0)}%ï¼Œ'
            'å»ºè®®æ§åˆ¶åœ¨20%ä»¥å†…',
        suggestion: 'å¯ç”¨å•†åœˆåœ°ç†å›´æ æé†’ï¼Œè¿›å…¥å•†åœˆå‰æŸ¥çœ‹é¢„ç®—',
        potentialSaving: pattern.commercialSpending * 0.3,
      ));
    }

    // é€šå‹¤æ¶ˆè´¹å¯ä¼˜åŒ–
    if (pattern.commuteSpending / total > 0.1) {
      insights.add(BudgetInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤æ¶ˆè´¹æœ‰ä¼˜åŒ–ç©ºé—´',
        description: 'é€šå‹¤è·¯ä¸Šæ¶ˆè´¹Â¥${pattern.commuteSpending.toStringAsFixed(0)}ï¼Œ'
            'å¤šä¸ºä¸´æ—¶æ¶ˆè´¹',
        suggestion: 'æå‰è§„åˆ’å‡ºè¡Œè·¯çº¿ï¼Œå›ºå®šæ—©é¤åœ°ç‚¹æˆ–è‡ªå¸¦',
        potentialSaving: pattern.commuteSpending * 0.4,
      ));
    }

    // å®¶é™„è¿‘æ¶ˆè´¹ç¨³å®š
    if (pattern.nearHomeSpending / total > 0.3) {
      insights.add(BudgetInsight(
        type: InsightType.info,
        title: 'å®¶é™„è¿‘æ¶ˆè´¹ä¹ æƒ¯ç¨³å®š',
        description: 'å®¶é™„è¿‘æ¶ˆè´¹å ${(pattern.nearHomeSpending / total * 100).toStringAsFixed(0)}%ï¼Œ'
            'æ¶ˆè´¹è¡Œä¸ºè¾ƒä¸ºè§„å¾‹',
        suggestion: 'å¯è€ƒè™‘åŠç†ç¤¾åŒºå•†å®¶ä¼šå‘˜å¡è·å–ä¼˜æƒ ',
      ));
    }

    return insights;
  }
}

/// ä½ç½®æ¨¡å¼åˆ†æç»“æœ
class LocationPattern {
  final double nearHomeSpending;
  final double nearWorkSpending;
  final double commuteSpending;
  final double commercialSpending;
  final double travelSpending;
  final Map<SpendingContext, Map<String, double>> categoryByLocation;
  final double totalSpending;
}

/// åŸºäºä½ç½®çš„é¢„ç®—åˆ†é…
class LocationBudgetAllocation {
  final String name;
  final SpendingContext context;
  final double amount;
  final double percentage;
  final Map<String, double> categories;
  final String description;
  final IconData icon;
  final String? optimizationTip;
  final bool requiresApproval;
  final bool isSeparateBudget;
  final int priority;

  LocationBudgetAllocation({
    required this.name,
    required this.context,
    required this.amount,
    required this.percentage,
    required this.categories,
    required this.description,
    required this.icon,
    this.optimizationTip,
    this.requiresApproval = false,
    this.isSeparateBudget = false,
    this.priority = 10,
  });
}

/// ä½ç½®é¢„ç®—å»ºè®®
class LocationBasedBudgetSuggestion {
  final double income;
  final List<LocationBudgetAllocation> allocations;
  final List<BudgetInsight> insights;

  double get totalAllocated =>
      allocations.fold(0.0, (sum, a) => sum + a.amount);

  double get remainingToAllocate => income - totalAllocated;
}
```

#### 14.11.2 åœ°ç†å›´æ é¢„ç®—æé†’

```dart
/// åœ°ç†å›´æ é¢„ç®—æé†’æœåŠ¡
class GeofenceBudgetAlertService {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final NotificationService _notificationService;

  // å·²æ³¨å†Œçš„åœ°ç†å›´æ 
  final List<BudgetGeofence> _activeGeofences = [];

  /// åˆå§‹åŒ–é»˜è®¤åœ°ç†å›´æ 
  Future<void> initializeDefaultGeofences() async {
    // 1. å•†åœˆå›´æ 
    final commercialAreas = await _locationService.getNearbyCommercialAreas();
    for (final area in commercialAreas) {
      _activeGeofences.add(BudgetGeofence(
        id: 'commercial_${area.id}',
        name: area.name,
        center: area.center,
        radius: area.radius,
        type: GeofenceType.commercial,
        categories: ['è´­ç‰©', 'å¨±ä¹', 'é¤é¥®'],
        alertMessage: 'æ‚¨å·²è¿›å…¥${area.name}å•†åœˆï¼Œæœ¬æœˆè´­ç‰©é¢„ç®—è¿˜å‰©Â¥{remaining}',
      ));
    }

    // 2. è‡ªåŠ¨æ£€æµ‹å¸¸å»çš„é«˜æ¶ˆè´¹åŒºåŸŸ
    final highSpendingAreas = await _detectHighSpendingAreas();
    for (final area in highSpendingAreas) {
      _activeGeofences.add(BudgetGeofence(
        id: 'high_spending_${area.hashCode}',
        name: 'é«˜æ¶ˆè´¹åŒºåŸŸ',
        center: area.center,
        radius: 500,
        type: GeofenceType.custom,
        categories: area.topCategories,
        alertMessage: 'è¿™ä¸ªåŒºåŸŸæ‚¨æœˆå‡æ¶ˆè´¹Â¥${area.averageSpending.toStringAsFixed(0)}ï¼Œ'
            'è¯·æ³¨æ„æ§åˆ¶æ”¯å‡º',
      ));
    }
  }

  /// å¯åŠ¨ä½ç½®ç›‘å¬
  void startMonitoring() {
    _locationService.startLocationUpdates(
      interval: Duration(minutes: 5),
      onLocationUpdate: _checkGeofences,
    );
  }

  /// æ£€æŸ¥æ˜¯å¦è¿›å…¥å›´æ 
  Future<void> _checkGeofences(PreciseLocation location) async {
    for (final fence in _activeGeofences) {
      final distance = location.distanceTo(fence.center);

      if (distance <= fence.radius) {
        // è¿›å…¥å›´æ 
        if (!fence.isInside) {
          fence.isInside = true;
          await _onEnterGeofence(fence, location);
        }
      } else {
        // ç¦»å¼€å›´æ 
        if (fence.isInside) {
          fence.isInside = false;
          await _onExitGeofence(fence);
        }
      }
    }
  }

  /// è¿›å…¥å›´æ æ—¶è§¦å‘
  Future<void> _onEnterGeofence(BudgetGeofence fence, PreciseLocation location) async {
    // è·å–ç›¸å…³é¢„ç®—å‰©ä½™
    double remaining = 0;
    for (final category in fence.categories) {
      final budget = await _budgetRepo.getBudget(category);
      if (budget != null) {
        remaining += budget.remaining;
      }
    }

    // æ„å»ºæé†’æ¶ˆæ¯
    final message = fence.alertMessage.replaceAll('{remaining}', remaining.toStringAsFixed(0));

    // å‘é€é€šçŸ¥
    await _notificationService.showBudgetAlert(
      title: 'ğŸ’° é¢„ç®—æé†’',
      body: message,
      payload: BudgetAlertPayload(
        geofenceId: fence.id,
        location: location,
        categories: fence.categories,
        remainingBudget: remaining,
      ),
    );

    // æ ¹æ®é¢„ç®—å‰©ä½™æƒ…å†µè°ƒæ•´æé†’å¼ºåº¦
    if (remaining < 100) {
      await _notificationService.showUrgentAlert(
        title: 'âš ï¸ é¢„ç®—ç´§å¼ ',
        body: '${fence.categories.join("ã€")}é¢„ç®—ä»…å‰©Â¥${remaining.toStringAsFixed(0)}ï¼Œ'
            'å»ºè®®è°¨æ…æ¶ˆè´¹',
      );
    }
  }

  /// ç¦»å¼€å›´æ æ—¶è§¦å‘
  Future<void> _onExitGeofence(BudgetGeofence fence) async {
    // å¯é€‰ï¼šè®°å½•åœ¨è¯¥åŒºåŸŸçš„æ¶ˆè´¹æƒ…å†µ
  }

  /// æ£€æµ‹é«˜æ¶ˆè´¹åŒºåŸŸ
  Future<List<HighSpendingArea>> _detectHighSpendingAreas() async {
    final transactions = await _txRepo.getRecentWithLocation(months: 3);

    // æŒ‰ä½ç½®èšç±»
    final clusters = _clusterByLocation(transactions);

    // æ‰¾å‡ºå¹³å‡æ¶ˆè´¹é«˜çš„åŒºåŸŸ
    return clusters
        .where((c) => c.averageSpending > 200) // å•æ¬¡æ¶ˆè´¹è¶…è¿‡200
        .where((c) => c.transactionCount > 5)   // è‡³å°‘5æ¬¡æ¶ˆè´¹
        .toList();
  }

  /// æŒ‰ä½ç½®èšç±»äº¤æ˜“
  List<LocationCluster> _clusterByLocation(List<Transaction> transactions) {
    // ä½¿ç”¨DBSCANç®—æ³•è¿›è¡Œä½ç½®èšç±»
    final clusters = <LocationCluster>[];

    for (final tx in transactions) {
      if (tx.location == null) continue;

      // æŸ¥æ‰¾æœ€è¿‘çš„èšç±»ï¼ˆ100ç±³èŒƒå›´å†…ï¼‰
      LocationCluster? nearestCluster;
      double minDistance = double.infinity;

      for (final cluster in clusters) {
        final distance = tx.location!.distanceTo(cluster.center);
        if (distance < 100 && distance < minDistance) {
          nearestCluster = cluster;
          minDistance = distance;
        }
      }

      if (nearestCluster != null) {
        nearestCluster.addTransaction(tx);
      } else {
        clusters.add(LocationCluster(
          center: tx.location!,
          transactions: [tx],
        ));
      }
    }

    return clusters;
  }
}

/// é¢„ç®—åœ°ç†å›´æ 
class BudgetGeofence {
  final String id;
  final String name;
  final PreciseLocation center;
  final double radius; // ç±³
  final GeofenceType type;
  final List<String> categories;
  final String alertMessage;
  bool isInside = false;
}

enum GeofenceType { commercial, restaurant, custom }

/// ä½ç½®èšç±»
class LocationCluster {
  PreciseLocation center;
  final List<Transaction> transactions;

  LocationCluster({required this.center, required this.transactions});

  void addTransaction(Transaction tx) {
    transactions.add(tx);
    // æ›´æ–°èšç±»ä¸­å¿ƒ
    _updateCenter();
  }

  void _updateCenter() {
    final avgLat = transactions.map((t) => t.location!.latitude).reduce((a, b) => a + b) / transactions.length;
    final avgLng = transactions.map((t) => t.location!.longitude).reduce((a, b) => a + b) / transactions.length;
    // ä½¿ç”¨å¹³å‡ä½ç½®ä½œä¸ºæ–°ä¸­å¿ƒ
    center = PreciseLocation(latitude: avgLat, longitude: avgLng, accuracy: 50, timestamp: DateTime.now());
  }

  double get averageSpending =>
      transactions.fold(0.0, (sum, tx) => sum + tx.amount) / transactions.length;

  int get transactionCount => transactions.length;

  List<String> get topCategories {
    final categoryCount = <String, int>{};
    for (final tx in transactions) {
      categoryCount.update(tx.category, (v) => v + 1, ifAbsent: () => 1);
    }
    return categoryCount.entries
        .sorted((a, b) => b.value.compareTo(a.value))
        .take(3)
        .map((e) => e.key)
        .toList();
  }
}

/// é«˜æ¶ˆè´¹åŒºåŸŸ
class HighSpendingArea {
  final PreciseLocation center;
  final double averageSpending;
  final int transactionCount;
  final List<String> topCategories;
}
```

#### 14.11.3 ä½ç½®æ™ºèƒ½é¢„ç®—æ‰§è¡Œç›‘æ§

```dart
/// ä½ç½®æ™ºèƒ½é¢„ç®—æ‰§è¡Œç›‘æ§
class LocationBudgetExecutionMonitor {
  final PreciseLocationService _locationService;
  final BudgetRepository _budgetRepo;
  final TransactionRepository _txRepo;

  /// è®°è´¦æ—¶è‡ªåŠ¨å…³è”ä½ç½®é¢„ç®—
  Future<BudgetMatchResult> matchTransactionToBudget(
    Transaction tx,
    PreciseLocation location,
  ) async {
    // 1. ç¡®å®šæ¶ˆè´¹åœºæ™¯
    final context = await _determineSpendingContext(location);

    // 2. æŸ¥æ‰¾å¯¹åº”çš„ä½ç½®é¢„ç®—
    final locationBudget = await _budgetRepo.getLocationBudget(context);

    // 3. æŸ¥æ‰¾ç±»ç›®é¢„ç®—
    final categoryBudget = await _budgetRepo.getCategoryBudget(tx.category);

    // 4. å†³å®šä½¿ç”¨å“ªä¸ªé¢„ç®—
    if (locationBudget != null && categoryBudget != null) {
      // ä¸¤è€…éƒ½æœ‰ï¼Œä½¿ç”¨æ›´å…·ä½“çš„ï¼ˆä½ç½®+ç±»ç›®äº¤å‰ï¼‰
      return BudgetMatchResult(
        primaryBudget: locationBudget,
        secondaryBudget: categoryBudget,
        matchType: BudgetMatchType.locationAndCategory,
        suggestion: _generateExecutionSuggestion(tx, locationBudget, categoryBudget),
      );
    } else if (locationBudget != null) {
      return BudgetMatchResult(
        primaryBudget: locationBudget,
        matchType: BudgetMatchType.locationOnly,
      );
    } else if (categoryBudget != null) {
      return BudgetMatchResult(
        primaryBudget: categoryBudget,
        matchType: BudgetMatchType.categoryOnly,
      );
    }

    return BudgetMatchResult(matchType: BudgetMatchType.none);
  }

  /// ç”Ÿæˆæ‰§è¡Œå»ºè®®
  String _generateExecutionSuggestion(
    Transaction tx,
    Budget locationBudget,
    Budget categoryBudget,
  ) {
    final locationUsage = locationBudget.used / locationBudget.total;
    final categoryUsage = categoryBudget.used / categoryBudget.total;

    if (locationUsage > 0.9 && categoryUsage > 0.9) {
      return 'âš ï¸ è¯¥åŒºåŸŸå’Œç±»ç›®é¢„ç®—å‡æ¥è¿‘ä¸Šé™ï¼Œå»ºè®®æš‚ç¼“æ¶ˆè´¹';
    } else if (locationUsage > 0.9) {
      return 'ğŸ’¡ è¯¥åŒºåŸŸé¢„ç®—æ¥è¿‘ä¸Šé™ï¼Œä½†${tx.category}é¢„ç®—å……è¶³ï¼Œå¯è€ƒè™‘è°ƒæ•´';
    } else if (categoryUsage > 0.9) {
      return 'ğŸ’¡ ${tx.category}é¢„ç®—æ¥è¿‘ä¸Šé™ï¼Œè¯¥åŒºåŸŸæ•´ä½“é¢„ç®—å……è¶³';
    }

    return '';
  }

  /// ç”Ÿæˆä½ç½®ç»´åº¦çš„é¢„ç®—æ‰§è¡ŒæŠ¥å‘Š
  Future<LocationBudgetReport> generateLocationReport() async {
    final transactions = await _txRepo.getRecentWithLocation(months: 1);
    final budgets = await _budgetRepo.getAllLocationBudgets();

    final contextExecutions = <SpendingContext, BudgetExecution>{};

    // æŒ‰åœºæ™¯ç»Ÿè®¡æ‰§è¡Œæƒ…å†µ
    for (final tx in transactions) {
      if (tx.location == null) continue;

      final context = await _determineSpendingContext(tx.location!);
      final budget = budgets.firstWhere(
        (b) => b.context == context,
        orElse: () => Budget.empty(),
      );

      contextExecutions.update(
        context,
        (e) => e.addTransaction(tx),
        ifAbsent: () => BudgetExecution(budget: budget, transactions: [tx]),
      );
    }

    // ç”ŸæˆæŠ¥å‘Š
    return LocationBudgetReport(
      period: DateTime.now(),
      executions: contextExecutions,
      overBudgetContexts: contextExecutions.entries
          .where((e) => e.value.isOverBudget)
          .map((e) => e.key)
          .toList(),
      underUtilizedContexts: contextExecutions.entries
          .where((e) => e.value.utilizationRate < 0.5)
          .map((e) => e.key)
          .toList(),
      insights: _generateReportInsights(contextExecutions),
    );
  }

  /// ç”ŸæˆæŠ¥å‘Šæ´å¯Ÿ
  List<ReportInsight> _generateReportInsights(
    Map<SpendingContext, BudgetExecution> executions,
  ) {
    final insights = <ReportInsight>[];

    // æ£€æŸ¥å•†åœˆæ¶ˆè´¹
    final commercial = executions[SpendingContext.commercial];
    if (commercial != null && commercial.isOverBudget) {
      insights.add(ReportInsight(
        type: InsightType.warning,
        title: 'å•†åœˆæ¶ˆè´¹è¶…æ”¯',
        description: 'æœ¬æœˆå•†åœˆæ¶ˆè´¹è¶…å‡ºé¢„ç®—Â¥${commercial.overBudgetAmount.toStringAsFixed(0)}',
        suggestion: 'ä¸‹æœˆå»ºè®®å¯ç”¨æ›´ä¸¥æ ¼çš„å•†åœˆå›´æ æé†’',
        actionText: 'è°ƒæ•´å•†åœˆé¢„ç®—',
      ));
    }

    // æ£€æŸ¥é€šå‹¤æ¶ˆè´¹
    final commute = executions[SpendingContext.commuting];
    if (commute != null && commute.averageTransaction > 50) {
      insights.add(ReportInsight(
        type: InsightType.tip,
        title: 'é€šå‹¤æ¶ˆè´¹åé«˜',
        description: 'é€šå‹¤å•æ¬¡å¹³å‡æ¶ˆè´¹Â¥${commute.averageTransaction.toStringAsFixed(0)}',
        suggestion: 'è€ƒè™‘åŠç†äº¤é€šæœˆå¡æˆ–å‡å°‘ä¸´æ—¶æ¶ˆè´¹',
      ));
    }

    // è¡¨æ‰¬å®¶é™„è¿‘æ¶ˆè´¹æ§åˆ¶è‰¯å¥½
    final nearHome = executions[SpendingContext.nearHome];
    if (nearHome != null && nearHome.utilizationRate.between(0.7, 0.9)) {
      insights.add(ReportInsight(
        type: InsightType.praise,
        title: 'å®¶é™„è¿‘æ¶ˆè´¹æ§åˆ¶è‰¯å¥½',
        description: 'é¢„ç®—ä½¿ç”¨ç‡${(nearHome.utilizationRate * 100).toStringAsFixed(0)}%ï¼Œ'
            'éå¸¸åˆç†',
      ));
    }

    return insights;
  }
}

/// é¢„ç®—æ‰§è¡Œæƒ…å†µ
class BudgetExecution {
  final Budget budget;
  final List<Transaction> transactions;

  BudgetExecution({required this.budget, required this.transactions});

  BudgetExecution addTransaction(Transaction tx) {
    return BudgetExecution(
      budget: budget,
      transactions: [...transactions, tx],
    );
  }

  double get totalSpending =>
      transactions.fold(0.0, (sum, tx) => sum + tx.amount);

  bool get isOverBudget => totalSpending > budget.total;

  double get overBudgetAmount =>
      isOverBudget ? totalSpending - budget.total : 0;

  double get utilizationRate =>
      budget.total > 0 ? totalSpending / budget.total : 0;

  double get averageTransaction =>
      transactions.isNotEmpty ? totalSpending / transactions.length : 0;
}

/// ä½ç½®é¢„ç®—æŠ¥å‘Š
class LocationBudgetReport {
  final DateTime period;
  final Map<SpendingContext, BudgetExecution> executions;
  final List<SpendingContext> overBudgetContexts;
  final List<SpendingContext> underUtilizedContexts;
  final List<ReportInsight> insights;

  bool get hasOverBudget => overBudgetContexts.isNotEmpty;

  double get totalOverBudget => executions.values
      .where((e) => e.isOverBudget)
      .fold(0.0, (sum, e) => sum + e.overBudgetAmount);
}

/// æŠ¥å‘Šæ´å¯Ÿ
class ReportInsight {
  final InsightType type;
  final String title;
  final String description;
  final String? suggestion;
  final String? actionText;
}
```

---



# ç¬¬å››éƒ¨åˆ†ï¼šæŠ€æœ¯æ¶æ„ä¸å®ç°

---

### 14.12 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 14.12.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

ä½ç½®æ™ºèƒ½åŒ–ç³»ç»Ÿä¸å…¶ä»–2.0æ¨¡å—çš„é›†æˆé‡‡ç”¨äº‹ä»¶é©±åŠ¨å’ŒæœåŠ¡æ³¨å…¥ä¸¤ç§æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä½ç½®æ™ºèƒ½åŒ–é›†æˆå…¨æ™¯å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        ä½ç½®æ™ºèƒ½åŒ–æ ¸å¿ƒ                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ ä½ç½®é‡‡é›†  â”‚  â”‚ POIåŒ¹é…   â”‚  â”‚ åœºæ™¯è¯†åˆ«  â”‚  â”‚ éšç§è¿‡æ»¤  â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡    â”‚     â”‚  æ™ºèƒ½å¢å¼º    â”‚     â”‚  2.0æ–°å¢    â”‚                 â”‚
â”‚  â”‚  ç³»ç»Ÿé›†æˆ    â”‚     â”‚  ç³»ç»Ÿé›†æˆ    â”‚     â”‚  æ¨¡å—é›†æˆ    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ ç¬¬7ç« é’±é¾„ â”‚     â”‚ â€¢ ç¬¬10ç« AI  â”‚     â”‚ â€¢ ç¬¬13ç« å®¶åº­â”‚                 â”‚
â”‚  â”‚ â€¢ ç¬¬8ç« é¢„ç®— â”‚     â”‚ â€¢ ç¬¬16ç« æ™ºèƒ½â”‚     â”‚ â€¢ ç¬¬17ç« è‡ªå­¦â”‚                 â”‚
â”‚  â”‚ â€¢ ç¬¬12ç« å¯è§†â”‚     â”‚ â€¢ ç¬¬19ç« æ€§èƒ½â”‚     â”‚ â€¢ ç¬¬18ç« è¯­éŸ³â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 14.12.2 è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆ

```dart
/// ä½ç½®æ™ºèƒ½ä¸è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆ
class LocationVoiceService {
  final LocationIntelligenceService _locationService;
  final VoiceRecognitionService _voiceService;

  /// ä½ç½®æ„ŸçŸ¥è¯­éŸ³å‘½ä»¤å¤„ç†
  Future<VoiceCommandResult> processLocationAwareCommand(
    String voiceInput,
  ) async {
    // è·å–å½“å‰ä½ç½®ä¸Šä¸‹æ–‡
    final locationContext = await _locationService.getCurrentContext();

    // ä½ç½®ç›¸å…³è¯­éŸ³å‘½ä»¤è¯†åˆ«
    final patterns = [
      LocationVoicePattern(
        pattern: r'é™„è¿‘æœ‰(ä»€ä¹ˆ|å•¥)ä¼˜æƒ ',
        handler: () => _handleNearbyDeals(locationContext),
      ),
      LocationVoicePattern(
        pattern: r'è¿™é‡Œ(æ¶ˆè´¹|èŠ±äº†)å¤šå°‘',
        handler: () => _handleLocationSpending(locationContext),
      ),
      LocationVoicePattern(
        pattern: r'(è®¾ç½®|æ·»åŠ ).*åœ°ç‚¹æé†’',
        handler: () => _handleGeofenceReminder(voiceInput, locationContext),
      ),
      LocationVoicePattern(
        pattern: r'åˆ°(å…¬å¸|å®¶)(äº†|é™„è¿‘)',
        handler: () => _handleLocationArrival(locationContext),
      ),
    ];

    for (final pattern in patterns) {
      if (RegExp(pattern.pattern).hasMatch(voiceInput)) {
        return await pattern.handler();
      }
    }

    // é»˜è®¤å¤„ç†ï¼šæ·»åŠ ä½ç½®ä¸Šä¸‹æ–‡å¢å¼º
    return VoiceCommandResult(
      success: true,
      locationContext: locationContext,
      suggestion: _generateLocationSuggestion(locationContext),
    );
  }

  /// å¤„ç†é™„è¿‘ä¼˜æƒ æŸ¥è¯¢
  Future<VoiceCommandResult> _handleNearbyDeals(
    LocationContext context,
  ) async {
    final deals = await _locationService.getNearbyDeals(
      context.coordinates,
      radiusMeters: 500,
    );

    if (deals.isEmpty) {
      return VoiceCommandResult(
        success: true,
        response: 'é™„è¿‘æš‚æ— å‘ç°ä¼˜æƒ æ´»åŠ¨',
      );
    }

    return VoiceCommandResult(
      success: true,
      response: 'å‘ç°${deals.length}ä¸ªé™„è¿‘ä¼˜æƒ ï¼š${deals.first.description}',
      data: deals,
    );
  }

  /// å¤„ç†ä½ç½®æ¶ˆè´¹æŸ¥è¯¢
  Future<VoiceCommandResult> _handleLocationSpending(
    LocationContext context,
  ) async {
    final spending = await _locationService.getLocationSpending(
      context: context.sceneType,
      period: SpendingPeriod.thisMonth,
    );

    return VoiceCommandResult(
      success: true,
      response: 'æœ¬æœˆåœ¨${context.sceneName}æ¶ˆè´¹äº†${spending.total.toStringAsFixed(0)}å…ƒ',
      data: spending,
    );
  }
}
```

#### 14.12.3 è‡ªå­¦ä¹ ç³»ç»Ÿé›†æˆ

```dart
/// ä½ç½®æ™ºèƒ½ä¸è‡ªå­¦ä¹ ç³»ç»Ÿé›†æˆ
class LocationLearningService {
  final LocationIntelligenceService _locationService;
  final SelfLearningService _learningService;

  /// å­¦ä¹ ç”¨æˆ·ä½ç½®æ¶ˆè´¹æ¨¡å¼
  Future<void> learnLocationPatterns(Transaction tx) async {
    if (tx.location == null) return;

    final context = await _locationService.analyzeLocation(tx.location!);

    // 1. å­¦ä¹ åœºæ™¯-ç±»ç›®å…³è”
    await _learningService.recordPattern(
      PatternType.locationCategory,
      features: {
        'scene_type': context.sceneType.name,
        'category': tx.category,
        'amount_range': _getAmountRange(tx.amount),
        'time_of_day': _getTimeOfDay(tx.date),
      },
    );

    // 2. å­¦ä¹ ä½ç½®-é‡‘é¢æ¨¡å¼
    await _learningService.recordPattern(
      PatternType.locationAmount,
      features: {
        'poi_type': context.poiType,
        'average_amount': tx.amount,
        'frequency': 1,
      },
    );

    // 3. å­¦ä¹ ç§»åŠ¨æ¨¡å¼ï¼ˆé€šå‹¤è¯†åˆ«ï¼‰
    if (await _isCommuteTime()) {
      await _learningService.recordPattern(
        PatternType.commuteRoute,
        features: {
          'from': context.previousScene?.name,
          'to': context.sceneType.name,
          'duration': context.travelDuration?.inMinutes,
        },
      );
    }
  }

  /// åŸºäºå­¦ä¹ ç»“æœæä¾›ä½ç½®å»ºè®®
  Future<LocationSuggestion> getLearnedSuggestion(
    LocationContext context,
  ) async {
    // è·å–è¯¥åœºæ™¯çš„å†å²æ¨¡å¼
    final patterns = await _learningService.getPatterns(
      type: PatternType.locationCategory,
      filter: {'scene_type': context.sceneType.name},
    );

    if (patterns.isEmpty) {
      return LocationSuggestion.none();
    }

    // æ‰¾å‡ºæœ€å¸¸è§çš„ç±»ç›®
    final topCategory = patterns
        .groupBy((p) => p.features['category'])
        .entries
        .reduce((a, b) => a.value.length > b.value.length ? a : b)
        .key;

    // è®¡ç®—å¹³å‡é‡‘é¢
    final avgAmount = patterns
        .map((p) => p.features['amount_range'] as double)
        .average;

    return LocationSuggestion(
      suggestedCategory: topCategory,
      suggestedAmount: avgAmount,
      confidence: patterns.length / 10.0, // åŸºäºæ ·æœ¬æ•°çš„ç½®ä¿¡åº¦
      reason: 'åŸºäºæ‚¨åœ¨${context.sceneName}çš„${patterns.length}æ¬¡æ¶ˆè´¹è®°å½•',
    );
  }
}
```

#### 14.12.4 å®¶åº­è´¦æœ¬ç³»ç»Ÿé›†æˆ

```dart
/// ä½ç½®æ™ºèƒ½ä¸å®¶åº­è´¦æœ¬ç³»ç»Ÿé›†æˆ
class FamilyLocationService {
  final LocationIntelligenceService _locationService;
  final FamilyLedgerService _familyService;

  /// å®¶åº­æˆå‘˜ä½ç½®å…±äº«ï¼ˆéœ€æˆæƒï¼‰
  Future<FamilyLocationStatus> getFamilyLocationStatus() async {
    final familyId = await _familyService.getCurrentFamilyId();
    if (familyId == null) return FamilyLocationStatus.notInFamily();

    final members = await _familyService.getFamilyMembers(familyId);
    final locationStatus = <MemberLocationStatus>[];

    for (final member in members) {
      if (!member.hasLocationPermission) continue;

      final location = await _locationService.getMemberLocation(member.id);
      if (location != null) {
        locationStatus.add(MemberLocationStatus(
          memberId: member.id,
          memberName: member.name,
          lastLocation: location,
          lastUpdateTime: location.timestamp,
          nearbyDeals: await _locationService.getNearbyDeals(
            location.coordinates,
            radiusMeters: 200,
          ),
        ));
      }
    }

    return FamilyLocationStatus(
      familyId: familyId,
      memberStatuses: locationStatus,
    );
  }

  /// å®¶åº­æˆå‘˜æ¶ˆè´¹ä½ç½®çƒ­åŠ›å›¾
  Future<FamilyLocationHeatmap> generateFamilyHeatmap({
    required DateRange period,
    List<String>? memberIds,
  }) async {
    final familyId = await _familyService.getCurrentFamilyId();
    if (familyId == null) throw Exception('Not in family');

    final transactions = await _familyService.getFamilyTransactions(
      familyId: familyId,
      period: period,
      memberIds: memberIds,
    );

    // æŒ‰ä½ç½®èšåˆ
    final locationClusters = <LocationCluster>[];
    for (final tx in transactions.where((t) => t.location != null)) {
      final cluster = locationClusters.firstWhere(
        (c) => c.containsLocation(tx.location!),
        orElse: () {
          final newCluster = LocationCluster(center: tx.location!);
          locationClusters.add(newCluster);
          return newCluster;
        },
      );
      cluster.addTransaction(tx);
    }

    return FamilyLocationHeatmap(
      clusters: locationClusters,
      topSpendingLocations: locationClusters
          .sorted((a, b) => b.totalAmount.compareTo(a.totalAmount))
          .take(5)
          .toList(),
      memberBreakdown: _calculateMemberBreakdown(locationClusters),
    );
  }

  /// åŸºäºä½ç½®çš„å®¶åº­æ¶ˆè´¹æé†’
  Future<void> setupFamilyLocationReminders() async {
    final familyId = await _familyService.getCurrentFamilyId();
    if (familyId == null) return;

    // è®¾ç½®å®¶åº­å…±äº«åœ°ç‚¹å›´æ 
    final sharedLocations = await _familyService.getSharedLocations(familyId);

    for (final location in sharedLocations) {
      await _locationService.setupGeofence(
        id: 'family_${familyId}_${location.id}',
        center: location.coordinates,
        radiusMeters: location.radius,
        onEnter: (memberId) async {
          // é€šçŸ¥å…¶ä»–å®¶åº­æˆå‘˜
          await _familyService.notifyMembers(
            familyId: familyId,
            excludeMemberId: memberId,
            message: '${await _getMemberName(memberId)}åˆ°è¾¾${location.name}',
          );

          // æ˜¾ç¤ºè¯¥åœ°ç‚¹çš„å®¶åº­é¢„ç®—æƒ…å†µ
          final budget = await _familyService.getLocationBudget(
            familyId: familyId,
            locationId: location.id,
          );
          if (budget != null && budget.remainingPercentage < 0.3) {
            await _showBudgetWarning(location, budget);
          }
        },
      );
    }
  }
}
```

#### 14.12.5 ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ

```dart
/// ä½ç½®æ™ºèƒ½ä¸ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ
class LocationHabitService {
  final LocationIntelligenceService _locationService;
  final HabitService _habitService;

  /// åŸºäºä½ç½®çš„ä¹ æƒ¯æ‰“å¡
  Future<HabitCheckInResult> locationBasedCheckIn(
    String habitId,
  ) async {
    final habit = await _habitService.getHabit(habitId);
    if (habit == null) throw Exception('Habit not found');

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½ç½®éªŒè¯
    if (habit.requiresLocationVerification) {
      final currentLocation = await _locationService.getCurrentLocation();
      if (currentLocation == null) {
        return HabitCheckInResult.failed('æ— æ³•è·å–å½“å‰ä½ç½®');
      }

      // éªŒè¯æ˜¯å¦åœ¨æŒ‡å®šä½ç½®é™„è¿‘
      final distance = _locationService.calculateDistance(
        currentLocation,
        habit.targetLocation!,
      );

      if (distance > habit.locationRadiusMeters) {
        return HabitCheckInResult.failed(
          'æ‚¨å½“å‰ä¸åœ¨ç›®æ ‡ä½ç½®é™„è¿‘ï¼ˆè·ç¦»${distance.toStringAsFixed(0)}ç±³ï¼‰',
        );
      }
    }

    // æ‰§è¡Œæ‰“å¡
    final result = await _habitService.checkIn(habitId);

    // è®°å½•ä½ç½®æ‰“å¡æ•°æ®
    if (result.success) {
      await _locationService.recordHabitLocation(
        habitId: habitId,
        location: await _locationService.getCurrentLocation(),
        timestamp: DateTime.now(),
      );
    }

    return result;
  }

  /// åˆ›å»ºä½ç½®è§¦å‘çš„ä¹ æƒ¯æé†’
  Future<void> setupLocationHabitReminder(
    String habitId,
    LocationTrigger trigger,
  ) async {
    final habit = await _habitService.getHabit(habitId);
    if (habit == null) return;

    await _locationService.setupGeofence(
      id: 'habit_$habitId',
      center: trigger.location,
      radiusMeters: trigger.radiusMeters,
      onEnter: (_) async {
        // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
        final todayStatus = await _habitService.getTodayStatus(habitId);
        if (!todayStatus.isCompleted) {
          await _showHabitReminder(habit, trigger);
        }
      },
    );
  }

  /// ä½ç½®æ¶ˆè´¹ä¹ æƒ¯åˆ†æ
  Future<LocationHabitAnalysis> analyzeLocationHabits() async {
    final transactions = await _locationService.getRecentTransactionsWithLocation(
      days: 30,
    );

    // åˆ†æé‡å¤ä½ç½®æ¶ˆè´¹æ¨¡å¼
    final locationPatterns = <String, LocationPattern>{};

    for (final tx in transactions) {
      final key = '${tx.location!.poiId}_${tx.category}';
      locationPatterns.update(
        key,
        (p) => p.addTransaction(tx),
        ifAbsent: () => LocationPattern(
          poiId: tx.location!.poiId,
          poiName: tx.location!.poiName,
          category: tx.category,
          transactions: [tx],
        ),
      );
    }

    // è¯†åˆ«é«˜é¢‘ä½ç½®æ¶ˆè´¹ï¼ˆå¯èƒ½éœ€è¦åŸ¹å…»æ§åˆ¶ä¹ æƒ¯ï¼‰
    final frequentPatterns = locationPatterns.values
        .where((p) => p.frequency >= 5) // æœˆå†…5æ¬¡ä»¥ä¸Š
        .toList();

    return LocationHabitAnalysis(
      patterns: frequentPatterns,
      suggestedHabits: _generateHabitSuggestions(frequentPatterns),
      potentialSavings: _calculatePotentialSavings(frequentPatterns),
    );
  }

  /// ç”Ÿæˆä¹ æƒ¯å»ºè®®
  List<HabitSuggestion> _generateHabitSuggestions(
    List<LocationPattern> patterns,
  ) {
    final suggestions = <HabitSuggestion>[];

    for (final pattern in patterns) {
      if (pattern.averageAmount > 50 && pattern.frequency >= 10) {
        // é«˜é¢‘é«˜é¢æ¶ˆè´¹ï¼Œå»ºè®®æ§åˆ¶
        suggestions.add(HabitSuggestion(
          type: HabitType.spendingLimit,
          title: 'æ§åˆ¶${pattern.poiName}æ¶ˆè´¹',
          description: 'æ‚¨æœ¬æœˆåœ¨${pattern.poiName}æ¶ˆè´¹${pattern.frequency}æ¬¡ï¼Œ'
              'å¹³å‡æ¯æ¬¡Â¥${pattern.averageAmount.toStringAsFixed(0)}',
          suggestedGoal: 'æ¯å‘¨æœ€å¤šæ¶ˆè´¹${(pattern.frequency / 4).ceil()}æ¬¡',
          potentialSaving: pattern.totalAmount * 0.3,
        ));
      }
    }

    return suggestions;
  }
}
```

#### 14.12.6 å®‰å…¨éšç§ç³»ç»Ÿé›†æˆ

```dart
/// ä½ç½®æ™ºèƒ½ä¸å®‰å…¨éšç§ç³»ç»Ÿé›†æˆ
class LocationPrivacyService {
  final LocationIntelligenceService _locationService;
  final PrivacyService _privacyService;

  /// ä½ç½®æ•°æ®éšç§é…ç½®
  static const locationPrivacyConfig = LocationPrivacyConfig(
    // æ•°æ®é‡‡é›†
    minAccuracyLevel: LocationAccuracy.approximate, // é»˜è®¤ä½¿ç”¨ç²—ç•¥å®šä½
    maxRetentionDays: 30, // æœ€é•¿ä¿ç•™30å¤©
    autoCleanupEnabled: true,

    // æ•°æ®å­˜å‚¨
    encryptionEnabled: true,
    encryptionAlgorithm: 'AES-256-GCM',
    localStorageOnly: true, // é»˜è®¤ä»…æœ¬åœ°å­˜å‚¨

    // æ•°æ®å…±äº«
    requireExplicitConsent: true,
    shareWithFamily: false, // é»˜è®¤ä¸å…±äº«ç»™å®¶åº­
    shareWithServer: false, // é»˜è®¤ä¸ä¸Šä¼ æœåŠ¡å™¨
  );

  /// æ£€æŸ¥ä½ç½®æƒé™å’Œéšç§è®¾ï¿½ï¿½ï¿½
  Future<LocationPrivacyStatus> checkPrivacyStatus() async {
    final systemPermission = await _locationService.checkPermission();
    final privacySettings = await _privacyService.getLocationSettings();

    return LocationPrivacyStatus(
      systemPermissionGranted: systemPermission.isGranted,
      preciseLocationAllowed: privacySettings.allowPreciseLocation,
      backgroundLocationAllowed: privacySettings.allowBackgroundLocation,
      dataRetentionDays: privacySettings.dataRetentionDays,
      familySharingEnabled: privacySettings.shareFamilyLocation,
      serverUploadEnabled: privacySettings.uploadToServer,
      lastCleanupTime: privacySettings.lastDataCleanup,
    );
  }

  /// æ‰§è¡Œä½ç½®æ•°æ®æ¸…ç†
  Future<CleanupResult> cleanupLocationData({
    int? olderThanDays,
    bool includePoiCache = false,
  }) async {
    final retentionDays = olderThanDays ??
        locationPrivacyConfig.maxRetentionDays;

    final cutoffDate = DateTime.now().subtract(
      Duration(days: retentionDays),
    );

    // æ¸…ç†åŸå§‹åæ ‡æ•°æ®
    final coordsDeleted = await _locationService.deleteCoordinatesOlderThan(
      cutoffDate,
    );

    // æ¸…ç†åœºæ™¯è®°å½•
    final scenesDeleted = await _locationService.deleteSceneRecordsOlderThan(
      cutoffDate,
    );

    // å¯é€‰ï¼šæ¸…ç†POIç¼“å­˜
    int poiCacheCleared = 0;
    if (includePoiCache) {
      poiCacheCleared = await _locationService.clearPoiCache();
    }

    // è®°å½•æ¸…ç†æ—¥å¿—
    await _privacyService.logDataCleanup(
      type: 'location_data',
      itemsDeleted: coordsDeleted + scenesDeleted + poiCacheCleared,
      timestamp: DateTime.now(),
    );

    return CleanupResult(
      coordinatesDeleted: coordsDeleted,
      sceneRecordsDeleted: scenesDeleted,
      poiCacheCleared: poiCacheCleared,
      totalDeleted: coordsDeleted + scenesDeleted + poiCacheCleared,
    );
  }

  /// å¯¼å‡ºç”¨æˆ·ä½ç½®æ•°æ®ï¼ˆGDPRåˆè§„ï¼‰
  Future<LocationDataExport> exportUserLocationData() async {
    final userId = await _privacyService.getCurrentUserId();

    return LocationDataExport(
      userId: userId,
      exportDate: DateTime.now(),
      coordinateHistory: await _locationService.getAllCoordinates(userId),
      sceneHistory: await _locationService.getAllSceneRecords(userId),
      geofences: await _locationService.getUserGeofences(userId),
      privacySettings: await _privacyService.getLocationSettings(),
    );
  }

  /// åˆ é™¤æ‰€æœ‰ç”¨æˆ·ä½ç½®æ•°æ®ï¼ˆè´¦æˆ·æ³¨é”€æ—¶ï¼‰
  Future<void> deleteAllUserLocationData() async {
    final userId = await _privacyService.getCurrentUserId();

    // åˆ é™¤æ‰€æœ‰ä½ç½®æ•°æ®
    await _locationService.deleteAllUserData(userId);

    // åˆ é™¤åœ°ç†å›´æ 
    await _locationService.removeAllGeofences(userId);

    // æ¸…é™¤POIåå¥½
    await _locationService.clearPoiPreferences(userId);

    // è®°å½•åˆ é™¤æ“ä½œ
    await _privacyService.logDataDeletion(
      type: 'all_location_data',
      userId: userId,
      timestamp: DateTime.now(),
    );
  }
}
```

---



## 15. æŠ€æœ¯æ¶æ„è®¾è®¡

### 15.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥æŠ€æœ¯æ¶æ„ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ€æœ¯æ¶æ„è®¾è®¡ - è®¾è®¡åŸåˆ™çŸ©é˜µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  åˆ†å±‚å•ä¸€    â”‚  â”‚  æ•°æ®ä¸€è‡´    â”‚  â”‚  æ¶æ„æç®€    â”‚  â”‚  æ°´å¹³æ‰©å±•    â”‚       â”‚
â”‚  â”‚  èŒè´£       â”‚  â”‚  æ€§          â”‚  â”‚  è®¾è®¡       â”‚  â”‚  æ€§          â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æ¯å±‚èŒè´£    â”‚  â”‚ ç¦»çº¿ä¼˜å…ˆ    â”‚  â”‚ æœ€å°‘ä¾èµ–    â”‚  â”‚ æ— çŠ¶æ€æœåŠ¡  â”‚       â”‚
â”‚  â”‚ è¾¹ç•Œæ¸…æ™°    â”‚  â”‚ æœ€ç»ˆä¸€è‡´    â”‚  â”‚ ç»„ä»¶è§£è€¦    â”‚  â”‚ å¼¹æ€§ä¼¸ç¼©    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ€§èƒ½ä¼˜åŒ–    â”‚  â”‚  å¯è§‚æµ‹æ€§    â”‚  â”‚  å®‰å…¨ä¼˜å…ˆ    â”‚  â”‚  å®¹é”™è®¾è®¡    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æœ¬åœ°ç¼“å­˜    â”‚  â”‚ å…¨é“¾è·¯è¿½è¸ª  â”‚  â”‚ ç«¯åˆ°ç«¯åŠ å¯†  â”‚  â”‚ ç†”æ–­é™çº§    â”‚       â”‚
â”‚  â”‚ æ‡’åŠ è½½      â”‚  â”‚ æŒ‡æ ‡ç›‘æ§    â”‚  â”‚ æœ€å°æƒé™    â”‚  â”‚ ä¼˜é›…é™çº§    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  æŠ€æœ¯æ¶æ„æ ¸å¿ƒç†å¿µï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "ç¦»çº¿ä¼˜å…ˆï¼Œæœ¬åœ°ä¸ºç‹ï¼Œäº‘ç«¯å¢å¼ºï¼Œå®‰å…¨è‡³ä¸Š"                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   ç¦»çº¿ä¼˜å…ˆ â”€â”€â†’ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ç¦»çº¿å¯ç”¨                                  â”‚   â”‚
â”‚  â”‚   æœ¬åœ°ä¸ºç‹ â”€â”€â†’ æœ¬åœ°æ•°æ®åº“ä¸ºä¸»ï¼ŒæœåŠ¡ç«¯ä¸ºå¤‡ä»½åŒæ­¥                       â”‚   â”‚
â”‚  â”‚   äº‘ç«¯å¢å¼º â”€â”€â†’ AIè¯†åˆ«ã€è·¨è®¾å¤‡åŒæ­¥ç­‰å¢å€¼åŠŸèƒ½ä¾èµ–äº‘ç«¯                   â”‚   â”‚
â”‚  â”‚   å®‰å…¨è‡³ä¸Š â”€â”€â†’ è´¢åŠ¡æ•°æ®å…¨ç¨‹åŠ å¯†ï¼Œéšç§ä¿æŠ¤ç¬¬ä¸€                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 15.0.1 è®¾è®¡åŸåˆ™åœ¨æŠ€æœ¯æ¶æ„ä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | æ¶æ„åº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|---------|---------|---------|
| **å•ä¸€èŒè´£** | åˆ†å±‚æ¶æ„ | è¡¨ç°å±‚/çŠ¶æ€å±‚/é¢†åŸŸå±‚/æ•°æ®å±‚åˆ†ç¦» | æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯• |
| **æ•°æ®ä¸€è‡´æ€§** | ç¦»çº¿åŒæ­¥ | CRDTå†²çªè§£å†³ã€ç‰ˆæœ¬å‘é‡ã€æœ€ç»ˆä¸€è‡´ | åŒæ­¥æˆåŠŸç‡>99.9% |
| **æç®€è®¾è®¡** | æœ€å°‘ä¾èµ– | æ ¸å¿ƒåŠŸèƒ½é›¶å¤–éƒ¨ä¾èµ– | å†·å¯åŠ¨<2ç§’ |
| **å¯æ‰©å±•æ€§** | æ’ä»¶æ¶æ„ | Provideræ³¨å…¥ã€æœåŠ¡å‘ç°ã€æ¨¡å—çƒ­æ’æ‹” | æ–°åŠŸèƒ½<1å¤©é›†æˆ |
| **æ€§èƒ½ä¼˜åŒ–** | å¤šçº§ç¼“å­˜ | å†…å­˜â†’æœ¬åœ°DBâ†’è¿œç¨‹API | é¦–å±<500ms |
| **å¯è§‚æµ‹æ€§** | å…¨é“¾è·¯è¿½è¸ª | TraceIDè´¯ç©¿ã€ç»“æ„åŒ–æ—¥å¿—ã€æŒ‡æ ‡åŸ‹ç‚¹ | é—®é¢˜å®šä½<5åˆ†é’Ÿ |

#### 15.0.2 ä¸å…¶ä»–2.0æ¨¡å—çš„æŠ€æœ¯æ”¯æ’‘å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æŠ€æœ¯æ¶æ„æ”¯æ’‘å…¨æ™¯å›¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                        â”‚   æŠ€æœ¯æ¶æ„å±‚     â”‚                                 â”‚
â”‚                        â”‚  Infrastructure â”‚                                 â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                 â”‚                                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚           â”‚                     â”‚                     â”‚                    â”‚
â”‚           â–¼                     â–¼                     â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    æ•°æ®å­˜å‚¨      â”‚  â”‚    ç½‘ç»œé€šä¿¡      â”‚  â”‚    å®‰å…¨æœåŠ¡      â”‚            â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚            â”‚
â”‚  â”‚ â€¢ sqfliteæœ¬åœ°   â”‚  â”‚ â€¢ Dio HTTP     â”‚  â”‚ â€¢ ç«¯åˆ°ç«¯åŠ å¯†    â”‚            â”‚
â”‚  â”‚ â€¢ PostgreSQL   â”‚  â”‚ â€¢ WebSocket    â”‚  â”‚ â€¢ JWTè®¤è¯      â”‚            â”‚
â”‚  â”‚ â€¢ Redisç¼“å­˜    â”‚  â”‚ â€¢ gRPC         â”‚  â”‚ â€¢ ç”Ÿç‰©è¯†åˆ«      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                     â”‚                     â”‚                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                 â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                       ä¸šåŠ¡æ¨¡å—æ”¯æ’‘                            â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚                                                              â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚           â”‚
â”‚  â”‚  â”‚ é’±é¾„ç³»ç»Ÿ  â”‚ â”‚ é¢„ç®—ç³»ç»Ÿ  â”‚ â”‚ åŒæ­¥ç³»ç»Ÿ  â”‚ â”‚ AIæ™ºèƒ½åŒ–  â”‚        â”‚           â”‚
â”‚  â”‚  â”‚          â”‚ â”‚          â”‚ â”‚          â”‚ â”‚          â”‚        â”‚           â”‚
â”‚  â”‚  â”‚ èµ„æºæ± è¡¨  â”‚ â”‚ å°é‡‘åº“è¡¨  â”‚ â”‚ ç¦»çº¿é˜Ÿåˆ—  â”‚ â”‚ APIè°ƒç”¨   â”‚        â”‚           â”‚
â”‚  â”‚  â”‚ FIFOè®¡ç®— â”‚ â”‚ å‘¨æœŸé‡ç½®  â”‚ â”‚ å†²çªè§£å†³  â”‚ â”‚ æ¨¡å‹æ¨ç†  â”‚        â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚           â”‚
â”‚  â”‚                                                              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.1 æ•´ä½“æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æŠ€æœ¯æ¶æ„å…¨æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   å®¢æˆ·ç«¯å±‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Flutter 3.x + Dart 3.x                                â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ UI: Material Design 3                             â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ çŠ¶æ€ç®¡ç†: Riverpod 3.x                            â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ æ•°æ®åº“: sqflite + drift                           â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ç½‘ç»œ: Dio + Retrofit                              â”‚      â”‚
â”‚   â”‚  â””â”€â”€ å›¾è¡¨: fl_chart                                    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚   æœåŠ¡ç«¯å±‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Python + FastAPI                                      â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ORM: SQLAlchemy 2.x                               â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ æ•°æ®åº“: PostgreSQL                                â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ç¼“å­˜: Redis                                       â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ ä»»åŠ¡é˜Ÿåˆ—: Celery                                  â”‚      â”‚
â”‚   â”‚  â””â”€â”€ AIæœåŠ¡: é˜¿é‡Œäº‘é€šä¹‰åƒé—® / æ™ºè°±AI                   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚   åŸºç¡€è®¾æ–½å±‚                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  â”œâ”€â”€ äº‘æœåŠ¡: é˜¿é‡Œäº‘ / è…¾è®¯äº‘                           â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ å®¹å™¨: Docker + Kubernetes                         â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ CI/CD: GitHub Actions                             â”‚      â”‚
â”‚   â”‚  â””â”€â”€ ç›‘æ§: Prometheus + Grafana                        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 15.2 å®¢æˆ·ç«¯æ¶æ„

#### 15.2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Flutter å®¢æˆ·ç«¯æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   è¡¨ç°å±‚ (Presentation)                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Pages          â”‚  Widgets         â”‚  Dialogs          â”‚      â”‚
â”‚   â”‚  (50+ é¡µé¢)     â”‚  (å¯å¤ç”¨ç»„ä»¶)    â”‚  (å¼¹çª—/åº•éƒ¨è¡¨)    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   çŠ¶æ€å±‚ (State)              â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Providers (Riverpod)                                  â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ StateNotifier: ä¸šåŠ¡çŠ¶æ€ç®¡ç†                       â”‚      â”‚
â”‚   â”‚  â”œâ”€â”€ FutureProvider: å¼‚æ­¥æ•°æ®åŠ è½½                      â”‚      â”‚
â”‚   â”‚  â””â”€â”€ StreamProvider: å®æ—¶æ•°æ®ç›‘å¬                      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   é¢†åŸŸå±‚ (Domain)             â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Services           â”‚  Models          â”‚  Repositories  â”‚      â”‚
â”‚   â”‚  (ä¸šåŠ¡æœåŠ¡)         â”‚  (æ•°æ®æ¨¡å‹)      â”‚  (æ•°æ®ä»“åº“)    â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                               â”‚                                    â”‚
â”‚   æ•°æ®å±‚ (Data)               â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LocalDB (sqflite)  â”‚  RemoteAPI (Dio) â”‚  Cache        â”‚      â”‚
â”‚   â”‚  æœ¬åœ°æ•°æ®åº“          â”‚  è¿œç¨‹API         â”‚  å†…å­˜ç¼“å­˜     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 15.2.2 Provider æ¶æ„æ¨¡å¼

```dart
/// åŸºç¡€ CRUD Provider
abstract class CrudNotifier<T, ID> extends StateNotifier<AsyncValue<List<T>>> {
  final Repository<T, ID> repository;

  CrudNotifier(this.repository) : super(const AsyncValue.loading()) {
    _init();
  }

  Future<void> _init() async {
    try {
      final items = await repository.getAll();
      state = AsyncValue.data(items);
    } catch (e, st) {
      state = AsyncValue.error(e, st);
    }
  }

  Future<void> create(T item) async {
    final previous = state;
    try {
      final created = await repository.create(item);
      state = AsyncValue.data([...state.value ?? [], created]);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  Future<void> update(T item, ID id) async {
    // ä¹è§‚æ›´æ–°
    final previous = state;
    try {
      state = AsyncValue.data(
        state.value?.map((i) => _getId(i) == id ? item : i).toList() ?? []
      );
      await repository.update(item);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  Future<void> delete(ID id) async {
    final previous = state;
    try {
      state = AsyncValue.data(
        state.value?.where((i) => _getId(i) != id).toList() ?? []
      );
      await repository.delete(id);
    } catch (e, st) {
      state = previous;
      rethrow;
    }
  }

  ID _getId(T item);
}

/// äº¤æ˜“ Provider ç¤ºä¾‹
class TransactionNotifier extends CrudNotifier<Transaction, String> {
  final OfflineQueueService offlineQueue;
  final AutoSyncService autoSync;

  TransactionNotifier({
    required TransactionRepository repository,
    required this.offlineQueue,
    required this.autoSync,
  }) : super(repository);

  @override
  String _getId(Transaction item) => item.id;

  @override
  Future<void> create(Transaction item) async {
    // ç«‹å³æœ¬åœ°ä¿å­˜
    await super.create(item);

    // åŠ å…¥åŒæ­¥é˜Ÿåˆ—
    offlineQueue.enqueue(SyncOperation.create(item));

    // è§¦å‘åŒæ­¥
    autoSync.triggerSync();
  }
}
```

### 15.3 ç¦»çº¿ä¼˜å…ˆæ¶æ„

```dart
/// ç¦»çº¿é˜Ÿåˆ—æœåŠ¡
class OfflineQueueService {
  final Database _db;
  final ConnectivityService _connectivity;

  /// å…¥é˜Ÿæ“ä½œ
  Future<void> enqueue(SyncOperation operation) async {
    await _db.insert('sync_queue', {
      'id': operation.id,
      'type': operation.type.name,
      'entity_type': operation.entityType,
      'entity_id': operation.entityId,
      'payload': jsonEncode(operation.payload),
      'created_at': DateTime.now().toIso8601String(),
      'retry_count': 0,
      'status': 'pending',
    });
  }

  /// å¤„ç†é˜Ÿåˆ—
  Future<void> processQueue() async {
    if (!await _connectivity.isConnected) return;

    final pending = await _db.query('sync_queue',
      where: 'status = ?',
      whereArgs: ['pending'],
      orderBy: 'created_at ASC',
    );

    for (final item in pending) {
      try {
        await _processOperation(SyncOperation.fromMap(item));
        await _markCompleted(item['id']);
      } catch (e) {
        await _handleError(item, e);
      }
    }
  }

  /// å¤„ç†é”™è¯¯ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  Future<void> _handleError(Map<String, dynamic> item, dynamic error) async {
    final retryCount = item['retry_count'] as int;

    if (retryCount >= 5) {
      await _markFailed(item['id'], error.toString());
    } else {
      // æŒ‡æ•°é€€é¿
      final delaySeconds = pow(2, retryCount).toInt();
      await _db.update('sync_queue', {
        'retry_count': retryCount + 1,
        'next_retry': DateTime.now().add(Duration(seconds: delaySeconds)).toIso8601String(),
        'last_error': error.toString(),
      }, where: 'id = ?', whereArgs: [item['id']]);
    }
  }
}

/// è‡ªåŠ¨åŒæ­¥æœåŠ¡
class AutoSyncService {
  final OfflineQueueService _queue;
  final ConnectivityService _connectivity;
  Timer? _timer;

  /// å¯åŠ¨è‡ªåŠ¨åŒæ­¥
  void start() {
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    _connectivity.onConnectivityChanged.listen((connected) {
      if (connected) {
        triggerSync();
      }
    });

    // å®šæ—¶åŒæ­¥
    _timer = Timer.periodic(Duration(minutes: 5), (_) => triggerSync());
  }

  /// è§¦å‘åŒæ­¥
  Future<void> triggerSync() async {
    try {
      await _queue.processQueue();
    } catch (e) {
      // é™é»˜å¤„ç†é”™è¯¯
      debugPrint('Sync failed: $e');
    }
  }

  /// åœæ­¢åŒæ­¥
  void stop() {
    _timer?.cancel();
    _timer = null;
  }
}
```

### 15.4 æ•°æ®åº“è®¾è®¡

#### 15.4.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'cash', 'bank', 'credit', 'investment'
  balance REAL DEFAULT 0,
  currency TEXT DEFAULT 'CNY',
  icon TEXT,
  color TEXT,
  is_archived INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced'
);

-- åˆ†ç±»è¡¨
CREATE TABLE categories (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'income', 'expense'
  icon TEXT,
  color TEXT,
  parent_id TEXT,
  sort_order INTEGER DEFAULT 0,
  is_system INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (parent_id) REFERENCES categories(id)
);

-- äº¤æ˜“è¡¨
CREATE TABLE transactions (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,  -- 'income', 'expense', 'transfer'
  amount REAL NOT NULL,
  account_id TEXT NOT NULL,
  category_id TEXT,
  to_account_id TEXT,  -- è½¬è´¦ç›®æ ‡è´¦æˆ·
  description TEXT,
  date TEXT NOT NULL,
  vault_id TEXT,  -- å…³è”çš„å°é‡‘åº“
  tags TEXT,  -- JSONæ•°ç»„
  attachments TEXT,  -- JSONæ•°ç»„
  location TEXT,
  is_recurring INTEGER DEFAULT 0,
  recurring_id TEXT,
  source_type TEXT,  -- 'manual', 'voice', 'image', 'import'
  source_file_id TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced',
  FOREIGN KEY (account_id) REFERENCES accounts(id),
  FOREIGN KEY (category_id) REFERENCES categories(id),
  FOREIGN KEY (to_account_id) REFERENCES accounts(id),
  FOREIGN KEY (vault_id) REFERENCES budget_vaults(id)
);

-- å°é‡‘åº“è¡¨
CREATE TABLE budget_vaults (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  icon TEXT,
  color TEXT,
  type TEXT NOT NULL,  -- 'fixed', 'flexible', 'savings', 'debt'
  target_amount REAL DEFAULT 0,
  allocated_amount REAL DEFAULT 0,
  spent_amount REAL DEFAULT 0,
  period TEXT,  -- 'monthly', 'weekly', 'yearly'
  due_date TEXT,
  is_recurring INTEGER DEFAULT 0,
  recurrence_rule TEXT,  -- JSON
  sort_order INTEGER DEFAULT 0,
  is_archived INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status TEXT DEFAULT 'synced'
);

-- èµ„æºæ± è¡¨ï¼ˆé’±é¾„è®¡ç®—ï¼‰
CREATE TABLE resource_pools (
  id TEXT PRIMARY KEY,
  income_transaction_id TEXT NOT NULL,
  original_amount REAL NOT NULL,
  remaining_amount REAL NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (income_transaction_id) REFERENCES transactions(id)
);

-- èµ„æºæ¶ˆè€—è®°å½•è¡¨
CREATE TABLE resource_consumptions (
  id TEXT PRIMARY KEY,
  pool_id TEXT NOT NULL,
  transaction_id TEXT NOT NULL,
  amount REAL NOT NULL,
  age_at_consumption INTEGER NOT NULL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (pool_id) REFERENCES resource_pools(id),
  FOREIGN KEY (transaction_id) REFERENCES transactions(id)
);

-- åŒæ­¥é˜Ÿåˆ—è¡¨
CREATE TABLE sync_queue (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,  -- 'create', 'update', 'delete'
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  payload TEXT,
  status TEXT DEFAULT 'pending',
  retry_count INTEGER DEFAULT 0,
  next_retry TEXT,
  last_error TEXT,
  created_at TEXT NOT NULL,
  completed_at TEXT
);
```

### 15.5 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 15.5.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ€æœ¯æ¶æ„ - ç³»ç»Ÿé›†æˆå…¨æ™¯                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                        â”‚     æŠ€æœ¯åŸºç¡€è®¾æ–½      â”‚                             â”‚
â”‚                        â”‚   Infrastructure     â”‚                             â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚             â”‚           â”‚           â”‚             â”‚              â”‚
â”‚         â–¼             â–¼           â–¼           â–¼             â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é’±é¾„ç³»ç»Ÿ   â”‚ â”‚  é¢„ç®—ç³»ç»Ÿ   â”‚ â”‚  åŒæ­¥ç³»ç»Ÿ   â”‚ â”‚  æŠ¥è¡¨ç³»ç»Ÿ   â”‚ â”‚ AIç³»ç»Ÿ   â”‚ â”‚
â”‚  â”‚  (ç¬¬7ç« )   â”‚ â”‚  (ç¬¬8ç« )   â”‚ â”‚  (ç¬¬16ç« )  â”‚ â”‚  (ç¬¬12ç« )  â”‚ â”‚ (ç¬¬10ç« ) â”‚ â”‚
â”‚  â”‚ èµ„æºæ± å­˜å‚¨  â”‚ â”‚ å°é‡‘åº“å­˜å‚¨  â”‚ â”‚ é˜Ÿåˆ—å¤„ç†   â”‚ â”‚ èšåˆè®¡ç®—   â”‚ â”‚ APIè°ƒç”¨  â”‚ â”‚
â”‚  â”‚ FIFOç®—æ³•   â”‚ â”‚ å‘¨æœŸè°ƒåº¦   â”‚ â”‚ å†²çªè§£å†³   â”‚ â”‚ ç¼“å­˜ç­–ç•¥   â”‚ â”‚ æ¨¡å‹æ¨ç† â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                              2.0æ–°å¢æŠ€æœ¯æ”¯æ’‘                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚å®¶åº­è´¦æœ¬  â”‚ â”‚è¯­éŸ³äº¤äº’  â”‚ â”‚è‡ªå­¦ä¹ ç³»ç»Ÿâ”‚ â”‚ä½ç½®æ™ºèƒ½  â”‚ â”‚å¯¼å…¥å¯¼å‡º  â”‚        â”‚
â”‚  â”‚ (13ç« )  â”‚ â”‚ (18ç« )  â”‚ â”‚ (17ç« )  â”‚ â”‚ (14ç« )  â”‚ â”‚ (11ç« )  â”‚        â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚        â”‚
â”‚  â”‚åä½œé”   â”‚ â”‚è¯­éŸ³æµ   â”‚ â”‚æ¨¡å‹å­˜å‚¨ â”‚ â”‚åœ°ç†ç´¢å¼• â”‚ â”‚æ‰¹é‡å¤„ç† â”‚        â”‚
â”‚  â”‚æƒé™æ§åˆ¶ â”‚ â”‚TTSæœåŠ¡  â”‚ â”‚å¢é‡å­¦ä¹  â”‚ â”‚å›´æ è®¡ç®— â”‚ â”‚å¤§æ–‡ä»¶æµ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚             â”‚           â”‚           â”‚             â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                   â”‚                                        â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                        â”‚    æ ¸å¿ƒæŠ€æœ¯æœåŠ¡      â”‚                             â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                         â”‚                         â”‚              â”‚
â”‚         â–¼                         â–¼                         â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚    æ•°æ®å±‚       â”‚    â”‚    å®‰å…¨å±‚       â”‚    â”‚    ç›‘æ§å±‚       â”‚           â”‚
â”‚  â”‚                â”‚    â”‚                â”‚    â”‚                â”‚           â”‚
â”‚  â”‚ â€¢ æœ¬åœ°æ•°æ®åº“   â”‚    â”‚ â€¢ åŠ å¯†æœåŠ¡     â”‚    â”‚ â€¢ æ—¥å¿—æ”¶é›†     â”‚           â”‚
â”‚  â”‚ â€¢ è¿œç¨‹æ•°æ®åº“   â”‚    â”‚ â€¢ è®¤è¯æˆæƒ     â”‚    â”‚ â€¢ æŒ‡æ ‡é‡‡é›†     â”‚           â”‚
â”‚  â”‚ â€¢ ç¼“å­˜ç³»ç»Ÿ     â”‚    â”‚ â€¢ éšç§ä¿æŠ¤     â”‚    â”‚ â€¢ é“¾è·¯è¿½è¸ª     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 15.5.1 é›†æˆè§¦å‘ç‚¹

| ä¸šåŠ¡ç³»ç»Ÿ | æŠ€æœ¯æ”¯æ’‘éœ€æ±‚ | æŠ€æœ¯æ–¹æ¡ˆ | æ€§èƒ½è¦æ±‚ |
|---------|-------------|---------|---------|
| **é’±é¾„ç³»ç»Ÿ** | èµ„æºæ± FIFOè®¡ç®— | ç´¢å¼•ä¼˜åŒ–+æ‰¹é‡å¤„ç† | è®¡ç®—<100ms |
| **é¢„ç®—ç³»ç»Ÿ** | å‘¨æœŸè‡ªåŠ¨é‡ç½® | å®šæ—¶ä»»åŠ¡+äº‹åŠ¡ä¿è¯ | å‡†æ—¶è§¦å‘100% |
| **åŒæ­¥ç³»ç»Ÿ** | ç¦»çº¿é˜Ÿåˆ—å¤„ç† | SQLiteé˜Ÿåˆ—+æŒ‡æ•°é€€é¿ | åŒæ­¥å»¶è¿Ÿ<30s |
| **æŠ¥è¡¨ç³»ç»Ÿ** | å¤§é‡æ•°æ®èšåˆ | é¢„èšåˆ+å¢é‡æ›´æ–° | é¦–å±<1s |
| **AIç³»ç»Ÿ** | å¤§æ¨¡å‹APIè°ƒç”¨ | é‡è¯•+é™çº§+ç¼“å­˜ | å“åº”<5s |
| **è¯­éŸ³è®°è´¦** | å®æ—¶è¯­éŸ³è¯†åˆ« | æµå¼å¤„ç†+æœ¬åœ°ç¼“å­˜ | è¯†åˆ«<2s |
| **ä¼™ä¼´åŒ–** | åŠ¨æ€æ–‡æ¡ˆç”Ÿæˆ | LLMé¢„ç”Ÿæˆ+æ¨¡æ¿é™çº§ | å±•ç¤º<100ms |

#### 15.5.2 é’±é¾„ç³»ç»ŸæŠ€æœ¯æ”¯æ’‘

```dart
/// é’±é¾„è®¡ç®—æŠ€æœ¯å®ç°
class MoneyAgeInfrastructure {
  final Database _db;
  final CacheService _cache;

  /// èµ„æºæ± è¡¨ç´¢å¼•ä¼˜åŒ–
  static const String createResourcePoolIndex = '''
    CREATE INDEX IF NOT EXISTS idx_resource_pools_remaining
    ON resource_pools(remaining_amount) WHERE remaining_amount > 0;

    CREATE INDEX IF NOT EXISTS idx_resource_pools_created
    ON resource_pools(created_at);

    CREATE INDEX IF NOT EXISTS idx_consumptions_pool
    ON resource_consumptions(pool_id, created_at);
  ''';

  /// FIFOæ¶ˆè´¹æ‰¹é‡å¤„ç†
  Future<List<ResourceConsumption>> consumeFromPools({
    required double amount,
    required String transactionId,
    required DateTime consumptionDate,
  }) async {
    final consumptions = <ResourceConsumption>[];
    var remaining = amount;

    await _db.transaction((txn) async {
      final pools = await txn.query(
        'resource_pools',
        where: 'remaining_amount > 0',
        orderBy: 'created_at ASC',
      );

      for (final pool in pools) {
        if (remaining <= 0) break;

        final poolRemaining = pool['remaining_amount'] as double;
        final consumeAmount = min(remaining, poolRemaining);
        final poolCreatedAt = DateTime.parse(pool['created_at'] as String);
        final ageAtConsumption = consumptionDate.difference(poolCreatedAt).inDays;

        final consumption = ResourceConsumption(
          id: Uuid().v4(),
          poolId: pool['id'] as String,
          transactionId: transactionId,
          amount: consumeAmount,
          ageAtConsumption: ageAtConsumption,
          createdAt: consumptionDate,
        );
        consumptions.add(consumption);

        await txn.update(
          'resource_pools',
          {'remaining_amount': poolRemaining - consumeAmount},
          where: 'id = ?',
          whereArgs: [pool['id']],
        );

        await txn.insert('resource_consumptions', consumption.toMap());
        remaining -= consumeAmount;
      }
    });

    await _cache.delete('money_age_current');
    return consumptions;
  }

  /// é’±é¾„è®¡ç®—ç¼“å­˜ç­–ç•¥
  Future<MoneyAgeResult> calculateMoneyAge({bool forceRefresh = false}) async {
    const cacheKey = 'money_age_current';
    if (!forceRefresh) {
      final cached = await _cache.get<MoneyAgeResult>(cacheKey);
      if (cached != null) return cached;
    }
    final result = await _doCalculateMoneyAge();
    await _cache.set(cacheKey, result, duration: Duration(minutes: 5));
    return result;
  }
}
```

#### 15.5.3 åŒæ­¥ç³»ç»ŸæŠ€æœ¯æ”¯æ’‘

```dart
/// åŒæ­¥ç³»ç»ŸæŠ€æœ¯å®ç°
class SyncInfrastructure {
  final Database _db;
  final HttpClient _http;

  /// å†²çªè§£å†³ç­–ç•¥ï¼ˆå‘é‡æ—¶é’Ÿï¼‰
  Future<SyncResult> resolveConflict({
    required SyncOperation local,
    required SyncOperation remote,
  }) async {
    final localVector = VectorClock.fromJson(local.vectorClock);
    final remoteVector = VectorClock.fromJson(remote.vectorClock);

    if (localVector.happensBefore(remoteVector)) {
      return SyncResult.acceptRemote(remote);
    } else if (remoteVector.happensBefore(localVector)) {
      return SyncResult.keepLocal(local);
    } else {
      return _mergeConflict(local, remote);
    }
  }

  /// å¢é‡åŒæ­¥å®ç°
  Future<void> incrementalSync() async {
    final lastSyncTime = await _getLastSyncTime();
    final localChanges = await _db.query(
      'sync_queue',
      where: 'created_at > ? AND status = ?',
      whereArgs: [lastSyncTime.toIso8601String(), 'pending'],
      orderBy: 'created_at ASC',
    );
    final remoteChanges = await _http.get(
      '/api/sync/changes',
      queryParameters: {'since': lastSyncTime.toIso8601String()},
    );
    final mergedChanges = await _mergeChanges(localChanges, remoteChanges);
    await _applyChanges(mergedChanges);
    await _updateLastSyncTime(DateTime.now());
  }
}

/// å‘é‡æ—¶é’Ÿå®ç°
class VectorClock {
  final Map<String, int> _clock;
  VectorClock(this._clock);

  bool happensBefore(VectorClock other) {
    for (final entry in _clock.entries) {
      if (entry.value > (other._clock[entry.key] ?? 0)) return false;
    }
    return _clock.entries.any((e) => (other._clock[e.key] ?? 0) > e.value);
  }

  VectorClock merge(VectorClock other) {
    final merged = Map<String, int>.from(_clock);
    for (final entry in other._clock.entries) {
      merged[entry.key] = max(merged[entry.key] ?? 0, entry.value);
    }
    return VectorClock(merged);
  }
}
```

#### 15.5.4 AIç³»ç»ŸæŠ€æœ¯æ”¯æ’‘

```dart
/// AIç³»ç»ŸæŠ€æœ¯å®ç°
class AIInfrastructure {
  final HttpClient _http;
  final CacheService _cache;
  final CircuitBreaker _circuitBreaker;

  /// AI APIè°ƒç”¨ï¼ˆå¸¦é‡è¯•å’Œé™çº§ï¼‰
  Future<AIResponse> callAI({
    required String prompt,
    required AIModel model,
    int maxRetries = 3,
  }) async {
    if (_circuitBreaker.isOpen) {
      return _getFallbackResponse(prompt);
    }

    final cacheKey = _generateCacheKey(prompt);
    final cached = await _cache.get<AIResponse>(cacheKey);
    if (cached != null) return cached;

    for (var attempt = 0; attempt < maxRetries; attempt++) {
      try {
        final response = await _http.post(
          model.endpoint,
          data: {'model': model.name, 'messages': [{'role': 'user', 'content': prompt}]},
          timeout: Duration(seconds: 30),
        );
        final aiResponse = AIResponse.fromJson(response.data);
        _circuitBreaker.recordSuccess();
        await _cache.set(cacheKey, aiResponse, duration: Duration(hours: 24));
        return aiResponse;
      } catch (e) {
        if (attempt == maxRetries - 1) {
          _circuitBreaker.recordFailure();
          return _getFallbackResponse(prompt);
        }
        await Future.delayed(Duration(seconds: pow(2, attempt).toInt()));
      }
    }
    return _getFallbackResponse(prompt);
  }
}

/// ç†”æ–­å™¨å®ç°
class CircuitBreaker {
  int _failureCount = 0;
  DateTime? _lastFailure;
  CircuitState _state = CircuitState.closed;

  static const int failureThreshold = 5;
  static const Duration resetTimeout = Duration(minutes: 1);

  bool get isOpen => _state == CircuitState.open;

  void recordSuccess() { _failureCount = 0; _state = CircuitState.closed; }

  void recordFailure() {
    _failureCount++;
    _lastFailure = DateTime.now();
    if (_failureCount >= failureThreshold) _state = CircuitState.open;
  }
}
```

#### 15.5.5 å®‰å…¨ä¸ç›‘æ§æŠ€æœ¯æ”¯æ’‘

```dart
/// å®‰å…¨ä¸ç›‘æ§æŠ€æœ¯å®ç°
class SecurityAndMonitoringInfrastructure {
  final EncryptionService _encryption;
  final LoggingService _logging;
  final MetricsService _metrics;

  /// ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆAES-256-GCMï¼‰
  Future<String> encryptSensitiveData(String data) async {
    final key = await _getOrCreateEncryptionKey();
    final iv = _generateSecureIV();
    final encrypted = await _encryption.encrypt(
      data: data, key: key, iv: iv,
      algorithm: EncryptionAlgorithm.aes256Gcm,
    );
    return base64Encode(iv + encrypted);
  }

  /// ç»“æ„åŒ–æ—¥å¿—
  void logEvent({
    required String event,
    required LogLevel level,
    Map<String, dynamic>? context,
    String? traceId,
  }) {
    _logging.log(LogEntry(
      event: event,
      level: level,
      timestamp: DateTime.now(),
      traceId: traceId ?? _getCurrentTraceId(),
      context: {'app_version': AppInfo.version, ...?context},
    ));
  }

  /// æŒ‡æ ‡åŸ‹ç‚¹
  void recordMetric({required String name, required double value, Map<String, String>? tags}) {
    _metrics.record(Metric(
      name: name,
      value: value,
      timestamp: DateTime.now(),
      tags: {'env': AppConfig.environment, ...?tags},
    ));
  }
}

/// æ€§èƒ½ç›‘æ§ä»ªè¡¨ç›˜
class PerformanceMetrics {
  static Future<DashboardData> collectMetrics() async {
    return DashboardData(
      coldStartTime: await _measureColdStartTime(),
      firstScreenTime: await _measureFirstScreenTime(),
      memoryUsage: await _getMemoryUsage(),
      avgQueryTime: await _getAvgQueryTime(),
      cacheHitRate: await _getCacheHitRate(),
      apiSuccessRate: await _getApiSuccessRate(),
      syncSuccessRate: await _getSyncSuccessRate(),
    );
  }
}
```

---


---

## 16. æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ

æœ¬ç« è¯¦ç»†è¯´æ˜ç³»ç»Ÿä¸­å„é¡¹æ™ºèƒ½åŒ–åŠŸèƒ½çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æŠ€æœ¯æ ˆï¼ˆå¤§æ¨¡å‹/è§„åˆ™å¼•æ“/æœºå™¨å­¦ä¹ ï¼‰ã€ç®—æ³•é€‰æ‹©ã€ä»¥åŠæ··åˆç­–ç•¥è®¾è®¡ã€‚

### 16.0 è®¾è®¡åŸåˆ™å›é¡¾

#### 16.0.1 æ™ºèƒ½åŒ–ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ - è®¾è®¡åŸåˆ™åº”ç”¨çŸ©é˜µ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å•ä¸€èŒè´£   â”‚    â”‚ æ•°æ®ä¸€è‡´æ€§  â”‚    â”‚  æç®€è®¾è®¡   â”‚    â”‚  å¯æ‰©å±•æ€§   â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ åˆ†ç±»æœåŠ¡    â”‚    â”‚ åˆ†ç±»ç»“æœ    â”‚    â”‚ å››å±‚é€’è¿›    â”‚    â”‚ æ’ä»¶å¼     â”‚      â”‚
â”‚  â”‚ é¢„æµ‹æœåŠ¡    â”‚    â”‚ å¯è¿½æº¯      â”‚    â”‚ ç­–ç•¥ä¼˜å…ˆ    â”‚    â”‚ æ¨¡å‹æ³¨å†Œ   â”‚      â”‚
â”‚  â”‚ æ£€æµ‹æœåŠ¡    â”‚    â”‚ ç½®ä¿¡åº¦æ ‡æ³¨  â”‚    â”‚ æˆæœ¬æ§åˆ¶    â”‚    â”‚ ç­–ç•¥å¯é…   â”‚      â”‚
â”‚  â”‚ å¯¹è¯æœåŠ¡    â”‚    â”‚ åé¦ˆä¿®æ­£    â”‚    â”‚ æ¸è¿›å¢å¼º    â”‚    â”‚ èƒ½åŠ›å¯æ’   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                     æ™ºèƒ½åŒ–ç­–ç•¥åè°ƒå±‚                              â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚           â”‚
â”‚  â”‚  â”‚  è§„åˆ™å¼•æ“(0æˆæœ¬) â†’ æœ¬åœ°ML(ä½å»¶è¿Ÿ) â†’ å¤§æ¨¡å‹(é«˜è´¨é‡)       â”‚   â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚                                                      â”‚                â”‚
â”‚         â–¼                                                      â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æ€§èƒ½ä¼˜åŒ–   â”‚                                        â”‚  å¯è§‚æµ‹æ€§   â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ ç»“æœç¼“å­˜    â”‚                                        â”‚ è°ƒç”¨è®¡æ•°    â”‚        â”‚
â”‚  â”‚ æ‰¹é‡å¤„ç†    â”‚                                        â”‚ æˆæœ¬è¿½è¸ª    â”‚        â”‚
â”‚  â”‚ é™çº§ç­–ç•¥    â”‚                                        â”‚ å‡†ç¡®ç‡ç»Ÿè®¡  â”‚        â”‚
â”‚  â”‚ æ‡’åŠ è½½æ¨¡å‹  â”‚                                        â”‚ å»¶è¿Ÿç›‘æ§    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 16.0.2 è®¾è®¡ç†å¿µ

| è®¾è®¡ç»´åº¦ | åœ¨æ™ºèƒ½åŒ–ç³»ç»Ÿçš„ä½“ç° | å…·ä½“å®ç° |
|---------|------------------|---------|
| **å•ä¸€èŒè´£** | æ¯ç§æ™ºèƒ½èƒ½åŠ›ç‹¬ç«‹ä¸ºæœåŠ¡ | SmartCategoryServiceã€PredictionServiceã€AnomalyDetectionServiceã€DialogServiceå„å¸å…¶èŒ |
| **æ•°æ®ä¸€è‡´æ€§** | AIç»“æœå¯è¿½æº¯å¯ä¿®æ­£ | è®°å½•ç½®ä¿¡åº¦ã€å†³ç­–ä¾æ®ã€ç”¨æˆ·åé¦ˆï¼›æ”¯æŒæ‰‹åŠ¨ä¿®æ­£è¦†ç›–AIç»“æœ |
| **æç®€è®¾è®¡** | è§„åˆ™ä¼˜å…ˆã€AIå…œåº• | èƒ½ç”¨è§„åˆ™è§£å†³ä¸ç”¨MLï¼Œèƒ½ç”¨æœ¬åœ°MLä¸è°ƒAPIï¼›å››å±‚é€’è¿›ç­–ç•¥ |
| **å¯æ‰©å±•æ€§** | æ¨¡å‹ä¸ç­–ç•¥å¯æ’æ‹” | æ–°å¢å¤§æ¨¡å‹åªéœ€å®ç°æ¥å£æ³¨å†Œï¼›ç­–ç•¥æƒé‡å¯é…ç½®è°ƒæ•´ |
| **æ€§èƒ½ä¼˜åŒ–** | å¤šçº§ç¼“å­˜ä¸é™çº§ | åˆ†ç±»ç»“æœç¼“å­˜ã€å•†å®¶æ˜ å°„ç¼“å­˜ï¼›APIè¶…æ—¶è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ç­–ç•¥ |
| **å¯è§‚æµ‹æ€§** | å…¨é“¾è·¯æˆæœ¬è¿½è¸ª | APIè°ƒç”¨è®¡æ•°ã€Tokenæ¶ˆè€—ç»Ÿè®¡ã€å‡†ç¡®ç‡åé¦ˆã€æ¯æ—¥æˆæœ¬æŠ¥è¡¨ |

#### 16.0.3 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ - ç³»ç»ŸååŒå…¨æ™¯å›¾                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚    æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ      â”‚                              â”‚
â”‚                          â”‚    (èƒ½åŠ›æä¾›æ–¹)        â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                      â”‚                                          â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚        â”‚               â”‚             â”‚             â”‚               â”‚            â”‚
â”‚        â–¼               â–¼             â–¼             â–¼               â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ äº¤æ˜“ç³»ç»Ÿ â”‚   â”‚ é¢„ç®—ç³»ç»Ÿ â”‚  â”‚ é’±é¾„ç³»ç»Ÿ â”‚  â”‚ ä¹ æƒ¯åŸ¹å…» â”‚   â”‚ æ•°æ®å¯¼å…¥ â”‚        â”‚
â”‚  â”‚          â”‚   â”‚          â”‚  â”‚          â”‚  â”‚          â”‚   â”‚          â”‚        â”‚
â”‚  â”‚ æ™ºèƒ½åˆ†ç±» â”‚   â”‚ æ™ºèƒ½å»ºè®® â”‚  â”‚ èµ„é‡‘é¢„æµ‹ â”‚  â”‚ è¡Œä¸ºé¢„æµ‹ â”‚   â”‚ æ™ºèƒ½è§£æ â”‚        â”‚
â”‚  â”‚ å¼‚å¸¸æ£€æµ‹ â”‚   â”‚ è¶…æ”¯é¢„è­¦ â”‚  â”‚ è¶‹åŠ¿åˆ†æ â”‚  â”‚ é¼“åŠ±æ—¶æœº â”‚   â”‚ åˆ†ç±»å»ºè®® â”‚        â”‚
â”‚  â”‚ è¯­éŸ³è®°è´¦ â”‚   â”‚ ä¼˜åŒ–åˆ†é… â”‚  â”‚ ç»“æ„æ´å¯Ÿ â”‚  â”‚ æŒ‘æˆ˜æ¨è â”‚   â”‚ å»é‡è¯†åˆ« â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚               â”‚             â”‚             â”‚               â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                     â”‚        åé¦ˆå­¦ä¹ å¾ªç¯            â”‚                          â”‚
â”‚                     â”‚  ç”¨æˆ·ä¿®æ­£ â†’ è§„åˆ™æ›´æ–° â†’ ç²¾åº¦æå‡ â”‚                          â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                         æ™ºèƒ½åŒ–èƒ½åŠ›è¾“å‡ºæ¸…å•                           â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ åˆ†ç±»æ™ºèƒ½         â”‚ é¢„æµ‹æ™ºèƒ½         â”‚ äº¤äº’æ™ºèƒ½                      â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ â€¢ å•†å®¶â†’åˆ†ç±»æ˜ å°„  â”‚ â€¢ æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹   â”‚ â€¢ è‡ªç„¶è¯­è¨€æœç´¢               â”‚       â”‚
â”‚  â”‚ â€¢ å…³é”®è¯è¯†åˆ«     â”‚ â€¢ é¢„ç®—å»ºè®®ç”Ÿæˆ   â”‚ â€¢ å¯¹è¯å¼è®°è´¦                 â”‚       â”‚
â”‚  â”‚ â€¢ æœ¬åœ°MLåˆ†ç±»     â”‚ â€¢ å¼‚å¸¸æ¶ˆè´¹æ£€æµ‹   â”‚ â€¢ è¯­éŸ³è¯†åˆ«è§£æ               â”‚       â”‚
â”‚  â”‚ â€¢ å¤§æ¨¡å‹å…œåº•     â”‚ â€¢ èµ„é‡‘æµå‘åˆ†æ   â”‚ â€¢ å›¾ç‰‡è´¦å•è¯†åˆ«               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.1 æ™ºèƒ½åŒ–æŠ€æœ¯æ ˆæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½åŒ–æŠ€æœ¯æ ˆåˆ†å±‚æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  åº”ç”¨å±‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  æ™ºèƒ½åˆ†ç±»  â”‚  æ™ºèƒ½é¢„ç®—  â”‚  è¶‹åŠ¿é¢„æµ‹  â”‚  è‡ªç„¶è¯­è¨€  â”‚  å¯¹è¯åŠ©æ‰‹ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                         â”‚
â”‚  ç­–ç•¥å±‚ (æ··åˆç­–ç•¥è°ƒåº¦)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  è§„åˆ™ä¼˜å…ˆ â†’ æœ¬åœ°ML â†’ å¤§æ¨¡å‹å…œåº•                               â”‚     â”‚
â”‚  â”‚  ç½®ä¿¡åº¦è¯„ä¼° â†’ æˆæœ¬æ§åˆ¶ â†’ ç»“æœèåˆ                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                         â”‚
â”‚  èƒ½åŠ›å±‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  è§„åˆ™å¼•æ“  â”‚  â”‚  æœ¬åœ°ML    â”‚  â”‚  ç»Ÿè®¡åˆ†æ  â”‚  â”‚  å¤§æ¨¡å‹API â”‚      â”‚
â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚      â”‚
â”‚  â”‚ â€¢ å…³é”®è¯è¡¨ â”‚  â”‚ â€¢ TFLite   â”‚  â”‚ â€¢ æ—¶é—´åºåˆ— â”‚  â”‚ â€¢ é€šä¹‰åƒé—® â”‚      â”‚
â”‚  â”‚ â€¢ æ­£åˆ™åŒ¹é… â”‚  â”‚ â€¢ åˆ†ç±»å™¨   â”‚  â”‚ â€¢ èšç±»åˆ†æ â”‚  â”‚ â€¢ æ™ºè°±AI   â”‚      â”‚
â”‚  â”‚ â€¢ å†³ç­–æ ‘   â”‚  â”‚ â€¢ å¼‚å¸¸æ£€æµ‹ â”‚  â”‚ â€¢ å›å½’é¢„æµ‹ â”‚  â”‚ â€¢ Claude   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.2 æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ

#### 16.2.1 å¤šå±‚ç­–ç•¥æ¶æ„

æ™ºèƒ½åˆ†ç±»é‡‡ç”¨**å››å±‚é€’è¿›ç­–ç•¥**ï¼Œè§„åˆ™ä¼˜å…ˆã€AIå…œåº•ï¼Œåœ¨å‡†ç¡®æ€§å’Œæˆæœ¬é—´å–å¾—å¹³è¡¡ï¼š

```dart
/// æ™ºèƒ½åˆ†ç±»æœåŠ¡ - å››å±‚æ··åˆç­–ç•¥
class SmartCategoryService {
  final CategoryRepository _categoryRepo;
  final TransactionRepository _transactionRepo;
  final LLMService _llmService;
  final LocalMLService _localML;

  /// å…³é”®è¯æ˜ å°„è¡¨ï¼ˆè§„åˆ™å¼•æ“ - ç¬¬äºŒå±‚ï¼‰
  static const Map<String, List<String>> _keywordMap = {
    'é¤é¥®': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'å¤–å–', 'ç¾å›¢', 'é¥¿äº†ä¹ˆ', 'å ‚é£Ÿ', 'ç«é”…', 'çƒ§çƒ¤', 'å¥¶èŒ¶', 'å’–å•¡'],
    'äº¤é€š': ['æ‰“è½¦', 'æ»´æ»´', 'åœ°é“', 'å…¬äº¤', 'åŠ æ²¹', 'åœè½¦', 'é«˜é“', 'æœºç¥¨', 'é«˜é€Ÿè´¹'],
    'è´­ç‰©': ['æ·˜å®', 'äº¬ä¸œ', 'æ‹¼å¤šå¤š', 'è¶…å¸‚', 'å•†åœº', 'å¤©çŒ«', 'è‹å®'],
    'å±…ä½': ['æˆ¿ç§Ÿ', 'æ°´è´¹', 'ç”µè´¹', 'ç‡ƒæ°”', 'ç‰©ä¸š', 'æš–æ°”'],
    'å¨±ä¹': ['ç”µå½±', 'æ¸¸æˆ', 'KTV', 'æ¼”å‡º', 'æ—…æ¸¸', 'é—¨ç¥¨'],
    'åŒ»ç–—': ['åŒ»é™¢', 'è¯åº—', 'æŒ‚å·', 'ä½“æ£€', 'çœ‹ç—…'],
    'æ•™è‚²': ['å­¦è´¹', 'åŸ¹è®­', 'è¯¾ç¨‹', 'ä¹¦ç±', 'è€ƒè¯•'],
  };

  /// æ¨èåˆ†ç±»ï¼ˆå››å±‚ç­–ç•¥ï¼‰
  Future<List<CategorySuggestion>> suggestCategories({
    required String description,
    required double amount,
    String? merchant,
    DateTime? date,
  }) async {
    final suggestions = <CategorySuggestion>[];

    // ========== ç¬¬ä¸€å±‚ï¼šå•†å®¶å†å²åŒ¹é…ï¼ˆç½®ä¿¡åº¦æœ€é«˜ï¼‰ ==========
    // æŠ€æœ¯ï¼šæ•°æ®åº“æŸ¥è¯¢ + ç»Ÿè®¡åˆ†æ
    // ä¼˜ç‚¹ï¼šåŸºäºç”¨æˆ·è‡ªå·±çš„ä¹ æƒ¯ï¼Œæœ€å‡†ç¡®
    if (merchant != null && merchant.isNotEmpty) {
      final history = await _transactionRepo.findByMerchant(merchant, limit: 20);
      if (history.length >= 3) {  // è‡³å°‘3æ¡å†å²è®°å½•æ‰æœ‰ç»Ÿè®¡æ„ä¹‰
        final categoryVotes = <String, int>{};
        for (final tx in history) {
          if (tx.categoryId != null) {
            categoryVotes[tx.categoryId!] = (categoryVotes[tx.categoryId!] ?? 0) + 1;
          }
        }
        if (categoryVotes.isNotEmpty) {
          final topEntry = categoryVotes.entries.reduce((a, b) => a.value > b.value ? a : b);
          final frequency = topEntry.value / history.length;

          if (frequency >= 0.6) {  // 60%ä»¥ä¸Šçš„ä¸€è‡´æ€§æ‰æ¨è
            final category = await _categoryRepo.getById(topEntry.key);
            if (category != null) {
              suggestions.add(CategorySuggestion(
                category: category,
                confidence: 0.85 + frequency * 0.1,  // 0.85-0.95
                reason: 'åœ¨"$merchant"çš„æ¶ˆè´¹é€šå¸¸è®°ä¸º${category.name}',
                source: SuggestionSource.merchantHistory,
              ));
            }
          }
        }
      }
    }

    // ========== ç¬¬äºŒå±‚ï¼šå…³é”®è¯è§„åˆ™åŒ¹é… ==========
    // æŠ€æœ¯ï¼šæ­£åˆ™è¡¨è¾¾å¼ + å…³é”®è¯è¡¨
    // ä¼˜ç‚¹ï¼šå¿«é€Ÿã€å¯è§£é‡Šã€æ— æˆæœ¬
    final keywordMatch = _matchByKeywords(description);
    if (keywordMatch != null) {
      final category = await _categoryRepo.findByName(keywordMatch.categoryName);
      if (category != null) {
        // æ£€æŸ¥æ˜¯å¦ä¸ç¬¬ä¸€å±‚ç»“æœå†²çª
        final isDuplicate = suggestions.any((s) => s.category.id == category.id);
        if (!isDuplicate) {
          suggestions.add(CategorySuggestion(
            category: category,
            confidence: 0.75,
            reason: 'åŒ…å«å…³é”®è¯"${keywordMatch.matchedKeyword}"',
            source: SuggestionSource.keywordMatch,
          ));
        }
      }
    }

    // ========== ç¬¬ä¸‰å±‚ï¼šæœ¬åœ°MLæ¨¡å‹ ==========
    // æŠ€æœ¯ï¼šTensorFlow Lite æ–‡æœ¬åˆ†ç±»å™¨
    // ä¼˜ç‚¹ï¼šç¦»çº¿å¯ç”¨ã€é€Ÿåº¦å¿«ã€æ— APIæˆæœ¬
    try {
      final mlResult = await _localML.classifyTransaction(
        description: description,
        amount: amount,
        dayOfWeek: date?.weekday,
        hourOfDay: date?.hour,
      );

      if (mlResult.confidence > 0.6) {
        final category = await _categoryRepo.getById(mlResult.categoryId);
        if (category != null) {
          final isDuplicate = suggestions.any((s) => s.category.id == category.id);
          if (!isDuplicate) {
            suggestions.add(CategorySuggestion(
              category: category,
              confidence: mlResult.confidence * 0.85,  // ç¨å¾®é™ä½ç½®ä¿¡åº¦
              reason: 'æœ¬åœ°AIåˆ†æ',
              source: SuggestionSource.localML,
            ));
          }
        }
      }
    } catch (e) {
      // æœ¬åœ°MLå¤±è´¥æ—¶é™é»˜å¤„ç†
      debugPrint('Local ML classification failed: $e');
    }

    // ========== ç¬¬å››å±‚ï¼šå¤§æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆå…œåº•ï¼‰ ==========
    // æŠ€æœ¯ï¼šé€šä¹‰åƒé—® / æ™ºè°±AI API
    // ä¼˜ç‚¹ï¼šç†è§£å¤æ‚è¯­ä¹‰ã€å¤„ç†æ–°åœºæ™¯
    // è§¦å‘æ¡ä»¶ï¼šå‰é¢å±‚çº§ç½®ä¿¡åº¦ä¸å¤Ÿé«˜
    final maxConfidence = suggestions.isEmpty ? 0.0 :
        suggestions.map((s) => s.confidence).reduce(max);

    if (maxConfidence < 0.75) {
      try {
        final llmResult = await _llmService.classifyExpense(
          description: description,
          amount: amount,
          merchant: merchant,
          availableCategories: await _categoryRepo.getAllExpenseCategories(),
        );

        if (llmResult != null && llmResult.confidence > 0.5) {
          final isDuplicate = suggestions.any((s) => s.category.id == llmResult.category.id);
          if (!isDuplicate) {
            suggestions.add(CategorySuggestion(
              category: llmResult.category,
              confidence: llmResult.confidence,
              reason: llmResult.explanation,
              source: SuggestionSource.llmAnalysis,
            ));
          }
        }
      } catch (e) {
        debugPrint('LLM classification failed: $e');
      }
    }

    // å»é‡å¹¶æŒ‰ç½®ä¿¡åº¦æ’åº
    return _deduplicateAndSort(suggestions);
  }

  /// å…³é”®è¯åŒ¹é…ï¼ˆæ­£åˆ™æ”¯æŒï¼‰
  KeywordMatchResult? _matchByKeywords(String description) {
    final lowerDesc = description.toLowerCase();

    for (final entry in _keywordMap.entries) {
      for (final keyword in entry.value) {
        // æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å…³é”®è¯
        final pattern = RegExp(keyword, caseSensitive: false);
        if (pattern.hasMatch(lowerDesc)) {
          return KeywordMatchResult(
            categoryName: entry.key,
            matchedKeyword: keyword,
          );
        }
      }
    }
    return null;
  }
}

/// å»ºè®®æ¥æºæšä¸¾
enum SuggestionSource {
  merchantHistory,  // å•†å®¶å†å²
  keywordMatch,     // å…³é”®è¯åŒ¹é…
  localML,          // æœ¬åœ°MLæ¨¡å‹
  llmAnalysis,      // å¤§æ¨¡å‹åˆ†æ
  amountPattern,    // é‡‘é¢æ¨¡å¼
  timePattern,      // æ—¶é—´æ¨¡å¼
}
```

#### 16.2.2 æœ¬åœ°MLæ¨¡å‹è®­ç»ƒ

```python
# æœ¬åœ°åˆ†ç±»æ¨¡å‹è®­ç»ƒè„šæœ¬ï¼ˆç¦»çº¿è¿è¡Œï¼‰
import tensorflow as tf
from sklearn.model_selection import train_test_split

class TransactionClassifierTrainer:
    """äº¤æ˜“åˆ†ç±»å™¨è®­ç»ƒ"""

    def __init__(self, categories: List[str]):
        self.categories = categories
        self.tokenizer = tf.keras.preprocessing.text.Tokenizer(num_words=5000)

    def prepare_data(self, transactions: List[Dict]) -> Tuple:
        """å‡†å¤‡è®­ç»ƒæ•°æ®"""
        texts = [t['description'] for t in transactions]
        labels = [self.categories.index(t['category']) for t in transactions]

        # æ–‡æœ¬å‘é‡åŒ–
        self.tokenizer.fit_on_texts(texts)
        sequences = self.tokenizer.texts_to_sequences(texts)
        padded = tf.keras.preprocessing.sequence.pad_sequences(sequences, maxlen=50)

        return train_test_split(padded, labels, test_size=0.2)

    def build_model(self) -> tf.keras.Model:
        """æ„å»ºè½»é‡çº§åˆ†ç±»æ¨¡å‹"""
        model = tf.keras.Sequential([
            tf.keras.layers.Embedding(5000, 64, input_length=50),
            tf.keras.layers.GlobalAveragePooling1D(),
            tf.keras.layers.Dense(64, activation='relu'),
            tf.keras.layers.Dropout(0.3),
            tf.keras.layers.Dense(len(self.categories), activation='softmax')
        ])

        model.compile(
            optimizer='adam',
            loss='sparse_categorical_crossentropy',
            metrics=['accuracy']
        )
        return model

    def export_to_tflite(self, model: tf.keras.Model, path: str):
        """å¯¼å‡ºä¸ºTFLiteæ ¼å¼ï¼ˆç”¨äºç§»åŠ¨ç«¯ï¼‰"""
        converter = tf.lite.TFLiteConverter.from_keras_model(model)
        converter.optimizations = [tf.lite.Optimize.DEFAULT]
        tflite_model = converter.convert()

        with open(path, 'wb') as f:
            f.write(tflite_model)
```

#### 16.2.3 å¤§æ¨¡å‹åˆ†ç±»è°ƒç”¨

```dart
/// å¤§æ¨¡å‹åˆ†ç±»æœåŠ¡
class LLMService {
  final QwenService _qwenService;

  /// ä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œåˆ†ç±»
  Future<LLMClassificationResult?> classifyExpense({
    required String description,
    required double amount,
    String? merchant,
    required List<Category> availableCategories,
  }) async {
    // æ„å»ºåˆ†ç±»é€‰é¡¹ï¼ˆå¸¦IDä¾¿äºè§£æï¼‰
    final categoryOptions = availableCategories
        .map((c) => '{"id":"${c.id}","name":"${c.name}"}')
        .join(', ');

    final prompt = '''
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°è´¦åˆ†ç±»åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹æ¶ˆè´¹è®°å½•ï¼Œä»ç»™å®šçš„åˆ†ç±»ä¸­é€‰æ‹©æœ€åˆé€‚çš„ä¸€ä¸ªã€‚

ã€æ¶ˆè´¹ä¿¡æ¯ã€‘
- æè¿°: $description
- é‡‘é¢: Â¥$amount
${merchant != null ? '- å•†å®¶: $merchant' : ''}

ã€å¯é€‰åˆ†ç±»ã€‘
[$categoryOptions]

ã€è¦æ±‚ã€‘
1. åªèƒ½ä»ä¸Šè¿°åˆ†ç±»ä¸­é€‰æ‹©
2. å¦‚æœæ— æ³•ç¡®å®šï¼Œé€‰æ‹©æœ€å¯èƒ½çš„å¹¶é™ä½ç½®ä¿¡åº¦
3. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—

ã€è¿”å›æ ¼å¼ã€‘
{
  "category_id": "é€‰æ‹©çš„åˆ†ç±»ID",
  "confidence": 0åˆ°1ä¹‹é—´çš„æ•°å­—,
  "explanation": "10å­—ä»¥å†…çš„ç†ç”±"
}
''';

    try {
      final response = await _qwenService.chat(prompt);
      final json = jsonDecode(_extractJson(response));

      final categoryId = json['category_id'] as String;
      final category = availableCategories.firstWhere(
        (c) => c.id == categoryId,
        orElse: () => throw FormatException('Invalid category ID'),
      );

      return LLMClassificationResult(
        category: category,
        confidence: (json['confidence'] as num).toDouble().clamp(0.0, 1.0),
        explanation: json['explanation'] as String? ?? 'AIåˆ†æ',
      );
    } catch (e) {
      debugPrint('LLM classify error: $e');
      return null;
    }
  }

  /// ä»å“åº”ä¸­æå–JSON
  String _extractJson(String response) {
    // å¤„ç†markdownä»£ç å—
    final jsonMatch = RegExp(r'\{[\s\S]*\}').firstMatch(response);
    return jsonMatch?.group(0) ?? response;
  }
}
```

#### 16.2.4 åé¦ˆå­¦ä¹ é—­ç¯ç³»ç»Ÿ

åé¦ˆå­¦ä¹ æ˜¯æ™ºèƒ½åˆ†ç±»ç³»ç»ŸæŒç»­ä¼˜åŒ–çš„æ ¸å¿ƒæœºåˆ¶ï¼Œé€šè¿‡"ç”¨æˆ·ä¿®æ­£â†’è§„åˆ™æ²‰æ·€â†’ç²¾åº¦æå‡â†’æˆæœ¬é™ä½"çš„é—­ç¯å®ç°è‡ªæˆ‘è¿›åŒ–ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åé¦ˆå­¦ä¹ é—­ç¯æ¶æ„                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                           ç”¨æˆ·äº¤äº’å±‚                                      â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   ç”¨æˆ·è®°è´¦ â”€â”€â†’ AIæ¨èåˆ†ç±» â”€â”€â†’ ç”¨æˆ·ç¡®è®¤/ä¿®æ­£ â”€â”€â†’ äº¤æ˜“ä¿å­˜                  â”‚   â”‚
â”‚   â”‚                    â”‚              â”‚                                       â”‚   â”‚
â”‚   â”‚                    â”‚              â–¼                                       â”‚   â”‚
â”‚   â”‚                    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚   â”‚                    â”‚      â”‚ åé¦ˆé‡‡é›†å™¨    â”‚                               â”‚   â”‚
â”‚   â”‚                    â”‚      â”‚ FeedbackCollector                            â”‚   â”‚
â”‚   â”‚                    â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚             â”‚                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    â”‚    åé¦ˆå¤„ç†å±‚â”‚                                        â”‚   â”‚
â”‚   â”‚                    â”‚             â–¼                                        â”‚   â”‚
â”‚   â”‚                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚   â”‚                    â”‚    â”‚   åé¦ˆå­˜å‚¨åº“      â”‚                              â”‚   â”‚
â”‚   â”‚                    â”‚    â”‚ feedback_records â”‚                              â”‚   â”‚
â”‚   â”‚                    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚   â”‚                    â”‚             â”‚                                        â”‚   â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚   â”‚         â”‚                        â”‚                     â”‚                  â”‚   â”‚
â”‚   â”‚         â–¼                        â–¼                     â–¼                  â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚   â”‚  â”‚ æ¨¡å¼åˆ†æå™¨   â”‚        â”‚ è§„åˆ™ç”Ÿæˆå™¨   â”‚        â”‚ ç²¾åº¦ç›‘æ§å™¨   â”‚           â”‚   â”‚
â”‚   â”‚  â”‚ PatternAnalyzer      â”‚ RuleGeneratorâ”‚        â”‚ AccuracyMonitor        â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚   â”‚         â”‚                      â”‚                      â”‚                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                      â”‚                      â”‚                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚         â”‚              å­¦ä¹ æ‰§è¡Œå±‚                      â”‚                  â”‚   â”‚
â”‚   â”‚         â–¼                      â–¼                      â–¼                  â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚   â”‚  â”‚ å•†å®¶æ˜ å°„è¡¨   â”‚        â”‚ å…³é”®è¯è§„åˆ™åº“ â”‚        â”‚ æœ¬åœ°MLæ¨¡å‹   â”‚           â”‚   â”‚
â”‚   â”‚  â”‚ merchant_   â”‚        â”‚ keyword_    â”‚        â”‚ category_   â”‚           â”‚   â”‚
â”‚   â”‚  â”‚ category_mapâ”‚        â”‚ rules       â”‚        â”‚ classifier  â”‚           â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚   â”‚         â”‚                      â”‚                      â”‚                  â”‚   â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚   â”‚                                â”‚                                          â”‚   â”‚
â”‚   â”‚                                â–¼                                          â”‚   â”‚
â”‚   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚   â”‚                    â”‚   æ™ºèƒ½åˆ†ç±»æœåŠ¡æ›´æ–°     â”‚                              â”‚   â”‚
â”‚   â”‚                    â”‚ SmartCategoryService  â”‚                              â”‚   â”‚
â”‚   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚   â”‚                                â”‚                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                             â”‚
â”‚                                    â–¼                                             â”‚
â”‚                         ä¸‹ä¸€æ¬¡ç”¨æˆ·è®°è´¦æ—¶ç”Ÿæ•ˆ                                       â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 16.2.4.1 åé¦ˆæ•°æ®å­˜å‚¨è®¾è®¡

```sql
-- åé¦ˆè®°å½•è¡¨
CREATE TABLE feedback_records (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    transaction_id TEXT NOT NULL,
    feedback_type TEXT NOT NULL,  -- 'category_correction', 'amount_correction', 'merchant_correction', 'rejected'

    -- åŸå§‹AIæ¨è
    original_category_id TEXT,
    original_confidence REAL,
    original_source TEXT,  -- 'merchant_history', 'keyword', 'local_ml', 'llm'

    -- ç”¨æˆ·ä¿®æ­£åçš„å€¼
    corrected_category_id TEXT,

    -- ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨äºæ¨¡å¼å­¦ä¹ ï¼‰
    merchant_name TEXT,
    description TEXT,
    amount REAL,
    transaction_date TEXT,
    day_of_week INTEGER,
    hour_of_day INTEGER,

    -- å¤„ç†çŠ¶æ€
    is_processed INTEGER DEFAULT 0,
    processed_at TEXT,
    learning_action TEXT,  -- 'rule_added', 'mapping_updated', 'model_retrained', 'ignored'

    created_at TEXT NOT NULL DEFAULT (datetime('now')),

    FOREIGN KEY (transaction_id) REFERENCES transactions(id)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_feedback_unprocessed ON feedback_records(is_processed, created_at)
    WHERE is_processed = 0;
CREATE INDEX idx_feedback_merchant ON feedback_records(merchant_name, corrected_category_id);
CREATE INDEX idx_feedback_type ON feedback_records(feedback_type, created_at);

-- å•†å®¶åˆ†ç±»æ˜ å°„è¡¨ï¼ˆå­¦ä¹ ç»“æœï¼‰
CREATE TABLE merchant_category_mappings (
    id TEXT PRIMARY KEY,
    merchant_name TEXT NOT NULL,
    merchant_name_normalized TEXT NOT NULL,  -- æ ‡å‡†åŒ–åçš„å•†å®¶å
    category_id TEXT NOT NULL,

    -- ç½®ä¿¡åº¦ä¸æ¥æº
    confidence REAL NOT NULL DEFAULT 0.5,
    source TEXT NOT NULL,  -- 'user_correction', 'frequency_analysis', 'manual'

    -- ç»Ÿè®¡ä¿¡æ¯
    match_count INTEGER DEFAULT 1,
    correct_count INTEGER DEFAULT 1,
    last_used_at TEXT,

    -- ç‰ˆæœ¬æ§åˆ¶ï¼ˆç”¨äºA/Bæµ‹è¯•ï¼‰
    version INTEGER DEFAULT 1,
    is_active INTEGER DEFAULT 1,

    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),

    UNIQUE(merchant_name_normalized, category_id)
);

CREATE INDEX idx_merchant_mapping_lookup ON merchant_category_mappings(merchant_name_normalized, is_active);

-- å…³é”®è¯è§„åˆ™è¡¨ï¼ˆå­¦ä¹ ç»“æœï¼‰
CREATE TABLE learned_keyword_rules (
    id TEXT PRIMARY KEY,
    keyword TEXT NOT NULL,
    keyword_type TEXT NOT NULL,  -- 'exact', 'prefix', 'suffix', 'contains', 'regex'
    category_id TEXT NOT NULL,

    -- è§„åˆ™å±æ€§
    priority INTEGER DEFAULT 50,  -- 0-100ï¼Œæ•°å€¼è¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜
    confidence REAL NOT NULL DEFAULT 0.7,

    -- å­¦ä¹ æ¥æº
    source TEXT NOT NULL,  -- 'pattern_analysis', 'user_defined', 'imported'
    learned_from_count INTEGER DEFAULT 1,  -- ä»å¤šå°‘æ¡åé¦ˆä¸­å­¦ä¹ å¾—åˆ°

    -- éªŒè¯çŠ¶æ€ï¼ˆA/Bæµ‹è¯•ï¼‰
    status TEXT DEFAULT 'candidate',  -- 'candidate', 'validated', 'promoted', 'deprecated'
    validation_accuracy REAL,
    validation_sample_count INTEGER,

    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),

    UNIQUE(keyword, keyword_type, category_id)
);

-- åˆ†ç±»å‡†ç¡®ç‡ç»Ÿè®¡è¡¨ï¼ˆæŒ‰å¤©èšåˆï¼‰
CREATE TABLE classification_accuracy_stats (
    id TEXT PRIMARY KEY,
    stat_date TEXT NOT NULL,
    source TEXT NOT NULL,  -- 'merchant_history', 'keyword', 'local_ml', 'llm', 'overall'

    -- ç»Ÿè®¡æŒ‡æ ‡
    total_predictions INTEGER DEFAULT 0,
    correct_predictions INTEGER DEFAULT 0,
    user_corrections INTEGER DEFAULT 0,

    -- è®¡ç®—å­—æ®µ
    accuracy_rate REAL GENERATED ALWAYS AS (
        CASE WHEN total_predictions > 0
             THEN CAST(correct_predictions AS REAL) / total_predictions
             ELSE 0 END
    ) STORED,

    -- æˆæœ¬ç»Ÿè®¡ï¼ˆé’ˆå¯¹LLMï¼‰
    api_calls INTEGER DEFAULT 0,
    tokens_used INTEGER DEFAULT 0,
    estimated_cost_cents INTEGER DEFAULT 0,

    created_at TEXT NOT NULL DEFAULT (datetime('now')),

    UNIQUE(stat_date, source)
);

CREATE INDEX idx_accuracy_stats_date ON classification_accuracy_stats(stat_date DESC, source);
```

##### 16.2.4.2 åé¦ˆé‡‡é›†æœåŠ¡

```dart
/// åé¦ˆé‡‡é›†æœåŠ¡
class FeedbackCollectorService {
  final FeedbackRepository _feedbackRepo;
  final AccuracyStatsService _statsService;

  /// è®°å½•ç”¨æˆ·å¯¹åˆ†ç±»çš„ä¿®æ­£
  Future<void> recordCategoryCorrection({
    required Transaction transaction,
    required CategorySuggestion originalSuggestion,
    required String correctedCategoryId,
  }) async {
    // 1. ä¿å­˜åé¦ˆè®°å½•
    final feedback = FeedbackRecord(
      id: Uuid().v4(),
      userId: transaction.userId,
      transactionId: transaction.id,
      feedbackType: FeedbackType.categoryCorrection,
      originalCategoryId: originalSuggestion.category.id,
      originalConfidence: originalSuggestion.confidence,
      originalSource: originalSuggestion.source.name,
      correctedCategoryId: correctedCategoryId,
      merchantName: transaction.merchant,
      description: transaction.description,
      amount: transaction.amount,
      transactionDate: transaction.date,
      dayOfWeek: transaction.date.weekday,
      hourOfDay: transaction.date.hour,
      createdAt: DateTime.now(),
    );

    await _feedbackRepo.save(feedback);

    // 2. æ›´æ–°å‡†ç¡®ç‡ç»Ÿè®¡
    final wasCorrect = originalSuggestion.category.id == correctedCategoryId;
    await _statsService.recordPrediction(
      source: originalSuggestion.source,
      wasCorrect: wasCorrect,
    );

    // 3. è§¦å‘å®æ—¶å­¦ä¹ ï¼ˆå•†å®¶æ˜ å°„å¯ç«‹å³æ›´æ–°ï¼‰
    if (transaction.merchant != null && transaction.merchant!.isNotEmpty) {
      await _triggerImmediateLearning(
        merchantName: transaction.merchant!,
        categoryId: correctedCategoryId,
      );
    }

    // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ‰¹é‡å­¦ä¹ 
    await _checkBatchLearningTrigger();
  }

  /// è®°å½•ç”¨æˆ·ç¡®è®¤AIæ¨èï¼ˆæ­£å‘åé¦ˆï¼‰
  Future<void> recordConfirmation({
    required Transaction transaction,
    required CategorySuggestion acceptedSuggestion,
  }) async {
    // æ­£å‘åé¦ˆä¹Ÿè¦è®°å½•ï¼Œç”¨äºç½®ä¿¡åº¦è°ƒæ•´
    await _statsService.recordPrediction(
      source: acceptedSuggestion.source,
      wasCorrect: true,
    );

    // å¢å¼ºå•†å®¶æ˜ å°„çš„ç½®ä¿¡åº¦
    if (transaction.merchant != null) {
      await _reinforceMerchantMapping(
        merchantName: transaction.merchant!,
        categoryId: acceptedSuggestion.category.id,
      );
    }
  }

  /// ç«‹å³æ›´æ–°å•†å®¶æ˜ å°„ï¼ˆç”¨æˆ·ä¿®æ­£åå³æ—¶ç”Ÿæ•ˆï¼‰
  Future<void> _triggerImmediateLearning({
    required String merchantName,
    required String categoryId,
  }) async {
    final normalizedName = _normalizeMerchantName(merchantName);

    await _feedbackRepo.upsertMerchantMapping(
      merchantName: merchantName,
      merchantNameNormalized: normalizedName,
      categoryId: categoryId,
      source: 'user_correction',
      confidence: 0.9,  // ç”¨æˆ·ä¿®æ­£çš„ç½®ä¿¡åº¦æœ€é«˜
    );
  }

  /// å¼ºåŒ–å·²æœ‰çš„å•†å®¶æ˜ å°„
  Future<void> _reinforceMerchantMapping({
    required String merchantName,
    required String categoryId,
  }) async {
    final normalizedName = _normalizeMerchantName(merchantName);

    await _feedbackRepo.incrementMappingConfidence(
      merchantNameNormalized: normalizedName,
      categoryId: categoryId,
      incrementBy: 0.02,  // æ¯æ¬¡ç¡®è®¤å¢åŠ 2%ç½®ä¿¡åº¦
      maxConfidence: 0.98,
    );
  }

  /// å•†å®¶åç§°æ ‡å‡†åŒ–
  String _normalizeMerchantName(String name) {
    return name
        .toLowerCase()
        .replaceAll(RegExp(r'\s+'), '')  // ç§»é™¤ç©ºæ ¼
        .replaceAll(RegExp(r'[ï¼ˆ(].*?[)ï¼‰]'), '')  // ç§»é™¤æ‹¬å·å†…å®¹
        .replaceAll(RegExp(r'åº—$|é—¨åº—$|æ——èˆ°åº—$'), '');  // ç§»é™¤å¸¸è§åç¼€
  }

  /// æ£€æŸ¥æ˜¯å¦è§¦å‘æ‰¹é‡å­¦ä¹ 
  Future<void> _checkBatchLearningTrigger() async {
    final unprocessedCount = await _feedbackRepo.getUnprocessedCount();

    // æ¡ä»¶è§¦å‘æ‰¹é‡å­¦ä¹ 
    if (unprocessedCount >= 50) {
      // å¼‚æ­¥è§¦å‘ï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
      unawaited(_triggerBatchLearning());
    }
  }
}
```

##### 16.2.4.3 æ¨¡å¼åˆ†æä¸è§„åˆ™ç”Ÿæˆ

```dart
/// æ¨¡å¼åˆ†ææœåŠ¡
class PatternAnalysisService {
  final FeedbackRepository _feedbackRepo;
  final LearnedRuleRepository _ruleRepo;

  /// åˆ†æåé¦ˆæ•°æ®ï¼Œå‘ç°å¯æ²‰æ·€çš„è§„åˆ™
  Future<List<CandidateRule>> analyzePatterns() async {
    final feedbacks = await _feedbackRepo.getUnprocessedFeedbacks(limit: 200);
    final candidates = <CandidateRule>[];

    // 1. åˆ†æå•†å®¶â†’åˆ†ç±»æ¨¡å¼
    candidates.addAll(await _analyzeMerchantPatterns(feedbacks));

    // 2. åˆ†æå…³é”®è¯â†’åˆ†ç±»æ¨¡å¼
    candidates.addAll(await _analyzeKeywordPatterns(feedbacks));

    // 3. åˆ†æé‡‘é¢åŒºé—´â†’åˆ†ç±»æ¨¡å¼
    candidates.addAll(await _analyzeAmountPatterns(feedbacks));

    // 4. åˆ†ææ—¶é—´â†’åˆ†ç±»æ¨¡å¼
    candidates.addAll(await _analyzeTimePatterns(feedbacks));

    return candidates;
  }

  /// åˆ†æå…³é”®è¯æ¨¡å¼
  Future<List<CandidateRule>> _analyzeKeywordPatterns(
    List<FeedbackRecord> feedbacks,
  ) async {
    final candidates = <CandidateRule>[];

    // æŒ‰ä¿®æ­£åçš„åˆ†ç±»åˆ†ç»„
    final groupedByCategory = <String, List<FeedbackRecord>>{};
    for (final fb in feedbacks) {
      if (fb.correctedCategoryId != null) {
        groupedByCategory
            .putIfAbsent(fb.correctedCategoryId!, () => [])
            .add(fb);
      }
    }

    for (final entry in groupedByCategory.entries) {
      final categoryId = entry.key;
      final categoryFeedbacks = entry.value;

      if (categoryFeedbacks.length < 5) continue;  // æ ·æœ¬å¤ªå°‘

      // æå–æ‰€æœ‰æè¿°ä¸­çš„è¯æ±‡
      final wordFrequency = <String, int>{};
      for (final fb in categoryFeedbacks) {
        final words = _extractWords(fb.description ?? '');
        for (final word in words) {
          wordFrequency[word] = (wordFrequency[word] ?? 0) + 1;
        }
      }

      // æ‰¾å‡ºé«˜é¢‘è¯ï¼ˆå‡ºç°åœ¨>60%çš„æ ·æœ¬ä¸­ï¼‰
      final threshold = (categoryFeedbacks.length * 0.6).ceil();
      for (final entry in wordFrequency.entries) {
        if (entry.value >= threshold && entry.key.length >= 2) {
          // éªŒè¯è¿™ä¸ªè¯ä¸ä¼šå¯¼è‡´è¯¯åˆ†ç±»
          final falsePositiveRate = await _checkFalsePositiveRate(
            keyword: entry.key,
            targetCategoryId: categoryId,
          );

          if (falsePositiveRate < 0.1) {  // è¯¯åˆ¤ç‡<10%æ‰é‡‡çº³
            candidates.add(CandidateRule(
              type: RuleType.keyword,
              keyword: entry.key,
              keywordType: 'contains',
              categoryId: categoryId,
              confidence: 1 - falsePositiveRate,
              sampleCount: entry.value,
              source: 'pattern_analysis',
            ));
          }
        }
      }
    }

    return candidates;
  }

  /// æå–å…³é”®è¯
  List<String> _extractWords(String text) {
    // ä¸­æ–‡åˆ†è¯ï¼ˆç®€å•å®ç°ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨jiebaç­‰ï¼‰
    final words = <String>[];

    // æå–2-4å­—çš„ä¸­æ–‡è¯ç»„
    final chinesePattern = RegExp(r'[\u4e00-\u9fa5]{2,4}');
    words.addAll(chinesePattern.allMatches(text).map((m) => m.group(0)!));

    // æå–è‹±æ–‡å•è¯
    final englishPattern = RegExp(r'[a-zA-Z]{3,}');
    words.addAll(englishPattern.allMatches(text).map((m) => m.group(0)!.toLowerCase()));

    return words;
  }

  /// æ£€æŸ¥å…³é”®è¯çš„è¯¯åˆ¤ç‡
  Future<double> _checkFalsePositiveRate({
    required String keyword,
    required String targetCategoryId,
  }) async {
    // æŸ¥è¯¢å†å²äº¤æ˜“ä¸­åŒ…å«è¯¥å…³é”®è¯çš„è®°å½•
    final matchingTransactions = await _feedbackRepo.findTransactionsWithKeyword(
      keyword: keyword,
      limit: 100,
    );

    if (matchingTransactions.isEmpty) return 0.0;

    // è®¡ç®—è¢«åˆ†åˆ°å…¶ä»–åˆ†ç±»çš„æ¯”ä¾‹
    final falsePositives = matchingTransactions
        .where((t) => t.categoryId != targetCategoryId)
        .length;

    return falsePositives / matchingTransactions.length;
  }
}

/// è§„åˆ™ç”Ÿæˆå™¨
class RuleGeneratorService {
  final LearnedRuleRepository _ruleRepo;
  final RuleValidationService _validationService;

  /// å°†å€™é€‰è§„åˆ™æå‡ä¸ºæ­£å¼è§„åˆ™
  Future<void> promoteRules(List<CandidateRule> candidates) async {
    for (final candidate in candidates) {
      // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè§„åˆ™
      final existing = await _ruleRepo.findSimilarRule(candidate);
      if (existing != null) {
        // æ›´æ–°ç½®ä¿¡åº¦
        await _ruleRepo.updateConfidence(
          ruleId: existing.id,
          newConfidence: (existing.confidence + candidate.confidence) / 2,
          incrementSampleCount: candidate.sampleCount,
        );
        continue;
      }

      // 2. åˆ›å»ºå€™é€‰è§„åˆ™
      final rule = LearnedKeywordRule(
        id: Uuid().v4(),
        keyword: candidate.keyword!,
        keywordType: candidate.keywordType!,
        categoryId: candidate.categoryId,
        priority: _calculatePriority(candidate),
        confidence: candidate.confidence,
        source: candidate.source,
        learnedFromCount: candidate.sampleCount,
        status: RuleStatus.candidate,
        createdAt: DateTime.now(),
      );

      await _ruleRepo.save(rule);

      // 3. å¯åŠ¨A/BéªŒè¯
      await _validationService.startValidation(rule);
    }
  }

  int _calculatePriority(CandidateRule candidate) {
    // åŸºäºç½®ä¿¡åº¦å’Œæ ·æœ¬é‡è®¡ç®—ä¼˜å…ˆçº§
    final confidenceScore = (candidate.confidence * 50).round();
    final sampleScore = min(candidate.sampleCount, 50);
    return confidenceScore + sampleScore;
  }
}
```

##### 16.2.4.4 å¢é‡å­¦ä¹ è°ƒåº¦å™¨

```dart
/// å¢é‡å­¦ä¹ è°ƒåº¦å™¨
class IncrementalLearningScheduler {
  final PatternAnalysisService _patternService;
  final RuleGeneratorService _ruleGenerator;
  final LocalMLTrainer _mlTrainer;
  final FeedbackRepository _feedbackRepo;

  Timer? _scheduledTask;
  bool _isRunning = false;

  /// å¯åŠ¨è°ƒåº¦å™¨
  void start() {
    // å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    _scheduledTask = Timer.periodic(Duration(hours: 1), (_) {
      _runIfNeeded();
    });

    // åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ä¸€æ¬¡
    _runIfNeeded();
  }

  void stop() {
    _scheduledTask?.cancel();
    _scheduledTask = null;
  }

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦è¿è¡Œå­¦ä¹ ä»»åŠ¡
  Future<void> _runIfNeeded() async {
    if (_isRunning) return;

    final unprocessedCount = await _feedbackRepo.getUnprocessedCount();

    // è§¦å‘æ¡ä»¶ï¼šç§¯ç´¯è¶³å¤Ÿæ ·æœ¬
    if (unprocessedCount >= 30) {
      await _runLearningCycle();
    }
  }

  /// æ‰‹åŠ¨è§¦å‘å­¦ä¹ ï¼ˆç”¨äºæµ‹è¯•æˆ–ç®¡ç†åå°ï¼‰
  Future<LearningResult> triggerManually() async {
    return await _runLearningCycle();
  }

  /// æ‰§è¡Œä¸€è½®å­¦ä¹ 
  Future<LearningResult> _runLearningCycle() async {
    _isRunning = true;
    final result = LearningResult();

    try {
      // 1. æ¨¡å¼åˆ†æ
      final candidates = await _patternService.analyzePatterns();
      result.candidateRulesFound = candidates.length;

      // 2. è§„åˆ™ç”Ÿæˆ
      final validCandidates = candidates.where((c) =>
        c.confidence >= 0.7 && c.sampleCount >= 5
      ).toList();
      await _ruleGenerator.promoteRules(validCandidates);
      result.rulesPromoted = validCandidates.length;

      // 3. æœ¬åœ°MLæ¨¡å‹å¢é‡è®­ç»ƒï¼ˆå¦‚æœæ ·æœ¬è¶³å¤Ÿï¼‰
      final mlTrainingData = await _prepareMlTrainingData();
      if (mlTrainingData.length >= 100) {
        await _mlTrainer.incrementalTrain(mlTrainingData);
        result.mlModelUpdated = true;
      }

      // 4. æ ‡è®°åé¦ˆä¸ºå·²å¤„ç†
      await _feedbackRepo.markAsProcessed(
        beforeDate: DateTime.now().subtract(Duration(hours: 1)),
      );

      result.success = true;
    } catch (e) {
      result.success = false;
      result.error = e.toString();
      debugPrint('Learning cycle failed: $e');
    } finally {
      _isRunning = false;
    }

    // è®°å½•å­¦ä¹ ç»“æœ
    await _logLearningResult(result);

    return result;
  }

  Future<List<TrainingSample>> _prepareMlTrainingData() async {
    final feedbacks = await _feedbackRepo.getProcessedFeedbacks(
      days: 30,
      limit: 1000,
    );

    return feedbacks.map((fb) => TrainingSample(
      text: '${fb.merchantName ?? ''} ${fb.description ?? ''}',
      categoryId: fb.correctedCategoryId!,
      amount: fb.amount,
      dayOfWeek: fb.dayOfWeek,
      hourOfDay: fb.hourOfDay,
    )).toList();
  }
}

/// å­¦ä¹ ç»“æœ
class LearningResult {
  bool success = false;
  int candidateRulesFound = 0;
  int rulesPromoted = 0;
  bool mlModelUpdated = false;
  String? error;

  Map<String, dynamic> toJson() => {
    'success': success,
    'candidate_rules_found': candidateRulesFound,
    'rules_promoted': rulesPromoted,
    'ml_model_updated': mlModelUpdated,
    'error': error,
    'timestamp': DateTime.now().toIso8601String(),
  };
}
```

##### 16.2.4.5 å‡†ç¡®ç‡ç›‘æ§ä¸å‘Šè­¦

```dart
/// åˆ†ç±»å‡†ç¡®ç‡ç›‘æ§æœåŠ¡
class AccuracyMonitorService {
  final AccuracyStatsRepository _statsRepo;
  final AlertService _alertService;
  final ObservabilityService _observability;

  /// å‡†ç¡®ç‡é˜ˆå€¼é…ç½®
  static const accuracyThresholds = {
    'merchant_history': 0.90,  // å•†å®¶å†å²åŒ¹é…åº”>90%
    'keyword': 0.80,           // å…³é”®è¯åŒ¹é…åº”>80%
    'local_ml': 0.70,          // æœ¬åœ°MLåº”>70%
    'llm': 0.85,               // å¤§æ¨¡å‹åº”>85%
    'overall': 0.80,           // æ€»ä½“åº”>80%
  };

  /// è®°å½•ä¸€æ¬¡é¢„æµ‹ç»“æœ
  Future<void> recordPrediction({
    required SuggestionSource source,
    required bool wasCorrect,
  }) async {
    final today = DateTime.now().toIso8601String().substring(0, 10);

    await _statsRepo.incrementStats(
      date: today,
      source: source.name,
      totalPredictions: 1,
      correctPredictions: wasCorrect ? 1 : 0,
      userCorrections: wasCorrect ? 0 : 1,
    );

    // å®æ—¶æŒ‡æ ‡ä¸ŠæŠ¥
    _observability.metrics.recordClassification(
      source: source.name,
      wasCorrect: wasCorrect,
    );
  }

  /// æ£€æŸ¥å‡†ç¡®ç‡å¹¶è§¦å‘å‘Šè­¦
  Future<void> checkAndAlert() async {
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final stats = await _statsRepo.getStatsForDate(today);

    for (final stat in stats) {
      final threshold = accuracyThresholds[stat.source] ?? 0.75;

      // æ ·æœ¬æ•°è¶³å¤Ÿæ—¶æ‰åˆ¤æ–­
      if (stat.totalPredictions >= 20 && stat.accuracyRate < threshold) {
        await _triggerAccuracyAlert(stat, threshold);
      }
    }
  }

  Future<void> _triggerAccuracyAlert(AccuracyStat stat, double threshold) async {
    final alert = Alert(
      type: AlertType.accuracyDrop,
      severity: stat.accuracyRate < threshold * 0.8
          ? AlertSeverity.critical
          : AlertSeverity.warning,
      title: 'åˆ†ç±»å‡†ç¡®ç‡ä¸‹é™',
      message: '${_getSourceDisplayName(stat.source)}å‡†ç¡®ç‡é™è‡³'
          '${(stat.accuracyRate * 100).toStringAsFixed(1)}%ï¼Œ'
          'ä½äºé˜ˆå€¼${(threshold * 100).toStringAsFixed(0)}%',
      context: {
        'source': stat.source,
        'accuracy_rate': stat.accuracyRate,
        'threshold': threshold,
        'total_predictions': stat.totalPredictions,
        'user_corrections': stat.userCorrections,
        'date': stat.statDate,
      },
    );

    await _alertService.send(alert);

    // è®°å½•åˆ°å¯è§‚æµ‹æ€§ç³»ç»Ÿ
    _observability.logger.warning(
      'Classification accuracy below threshold',
      context: alert.context,
    );
  }

  String _getSourceDisplayName(String source) {
    const names = {
      'merchant_history': 'å•†å®¶å†å²åŒ¹é…',
      'keyword': 'å…³é”®è¯è§„åˆ™',
      'local_ml': 'æœ¬åœ°MLæ¨¡å‹',
      'llm': 'å¤§æ¨¡å‹åˆ†ç±»',
      'overall': 'æ•´ä½“åˆ†ç±»',
    };
    return names[source] ?? source;
  }

  /// ç”Ÿæˆå‡†ç¡®ç‡æŠ¥å‘Š
  Future<AccuracyReport> generateReport({
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    final stats = await _statsRepo.getStatsForRange(startDate, endDate);

    // æŒ‰æ¥æºåˆ†ç»„ç»Ÿè®¡
    final bySource = <String, SourceAccuracySummary>{};
    for (final stat in stats) {
      bySource.putIfAbsent(stat.source, () => SourceAccuracySummary(stat.source));
      bySource[stat.source]!.addStat(stat);
    }

    // è®¡ç®—è¶‹åŠ¿
    final trend = _calculateTrend(stats);

    return AccuracyReport(
      startDate: startDate,
      endDate: endDate,
      sourcesSummary: bySource.values.toList(),
      overallAccuracy: _calculateOverallAccuracy(stats),
      trend: trend,
      recommendations: _generateRecommendations(bySource),
    );
  }

  List<String> _generateRecommendations(Map<String, SourceAccuracySummary> bySource) {
    final recommendations = <String>[];

    for (final entry in bySource.entries) {
      final summary = entry.value;
      if (summary.avgAccuracy < accuracyThresholds[entry.key]!) {
        switch (entry.key) {
          case 'keyword':
            recommendations.add('å…³é”®è¯è§„åˆ™å‡†ç¡®ç‡åä½ï¼Œå»ºè®®å®¡æŸ¥å¹¶ä¼˜åŒ–ç°æœ‰è§„åˆ™');
            break;
          case 'local_ml':
            recommendations.add('æœ¬åœ°MLæ¨¡å‹å‡†ç¡®ç‡åä½ï¼Œå»ºè®®è§¦å‘æ¨¡å‹é‡è®­ç»ƒ');
            break;
          case 'llm':
            recommendations.add('å¤§æ¨¡å‹åˆ†ç±»å‡†ç¡®ç‡åä½ï¼Œå»ºè®®æ£€æŸ¥Promptæˆ–è€ƒè™‘æ›´æ¢æ¨¡å‹');
            break;
        }
      }
    }

    return recommendations;
  }
}
```

##### 16.2.4.6 A/Bæµ‹è¯•ä¸è§„åˆ™éªŒè¯

```dart
/// è§„åˆ™éªŒè¯æœåŠ¡ï¼ˆA/Bæµ‹è¯•ï¼‰
class RuleValidationService {
  final LearnedRuleRepository _ruleRepo;
  final TransactionRepository _transactionRepo;

  /// éªŒè¯é…ç½®
  static const validationConfig = {
    'min_sample_size': 30,      // æœ€å°éªŒè¯æ ·æœ¬æ•°
    'min_accuracy': 0.75,       // æœ€ä½å‡†ç¡®ç‡è¦æ±‚
    'validation_period_days': 7, // éªŒè¯å‘¨æœŸï¼ˆå¤©ï¼‰
  };

  /// å¯åŠ¨è§„åˆ™éªŒè¯
  Future<void> startValidation(LearnedKeywordRule rule) async {
    // è®¾ç½®ä¸ºå€™é€‰çŠ¶æ€ï¼Œå¼€å§‹æ”¶é›†éªŒè¯æ•°æ®
    await _ruleRepo.updateStatus(
      ruleId: rule.id,
      status: RuleStatus.candidate,
    );

    // è§„åˆ™è¿›å…¥ç°åº¦ï¼Œåªå¯¹éƒ¨åˆ†æµé‡ç”Ÿæ•ˆ
    await _ruleRepo.setValidationGroup(
      ruleId: rule.id,
      groupPercentage: 10,  // 10%æµé‡éªŒè¯
    );
  }

  /// è¯„ä¼°è§„åˆ™æ•ˆæœ
  Future<ValidationResult> evaluateRule(String ruleId) async {
    final rule = await _ruleRepo.getById(ruleId);
    if (rule == null) {
      return ValidationResult.notFound();
    }

    // è·å–éªŒè¯æœŸé—´çš„é¢„æµ‹ç»“æœ
    final predictions = await _ruleRepo.getValidationPredictions(
      ruleId: ruleId,
      since: DateTime.now().subtract(
        Duration(days: validationConfig['validation_period_days'] as int),
      ),
    );

    if (predictions.length < validationConfig['min_sample_size']!) {
      return ValidationResult.insufficientSamples(
        current: predictions.length,
        required: validationConfig['min_sample_size'] as int,
      );
    }

    // è®¡ç®—å‡†ç¡®ç‡
    final correctCount = predictions.where((p) => p.wasCorrect).length;
    final accuracy = correctCount / predictions.length;

    // ä¸å¯¹ç…§ç»„æ¯”è¾ƒ
    final controlAccuracy = await _getControlGroupAccuracy(rule);
    final improvement = accuracy - controlAccuracy;

    return ValidationResult(
      ruleId: ruleId,
      sampleSize: predictions.length,
      accuracy: accuracy,
      controlAccuracy: controlAccuracy,
      improvement: improvement,
      isPassing: accuracy >= validationConfig['min_accuracy']! && improvement > 0,
    );
  }

  /// æ¨å¹¿æˆ–åºŸå¼ƒè§„åˆ™
  Future<void> finalizeValidation(String ruleId) async {
    final result = await evaluateRule(ruleId);

    if (result.isPassing) {
      // éªŒè¯é€šè¿‡ï¼Œæ¨å¹¿ä¸ºæ­£å¼è§„åˆ™
      await _ruleRepo.updateStatus(
        ruleId: ruleId,
        status: RuleStatus.promoted,
      );
      await _ruleRepo.setValidationGroup(
        ruleId: ruleId,
        groupPercentage: 100,  // å…¨é‡ç”Ÿæ•ˆ
      );

      debugPrint('Rule $ruleId promoted: accuracy=${result.accuracy}');
    } else {
      // éªŒè¯å¤±è´¥ï¼ŒåºŸå¼ƒè§„åˆ™
      await _ruleRepo.updateStatus(
        ruleId: ruleId,
        status: RuleStatus.deprecated,
      );
      await _ruleRepo.setValidationGroup(
        ruleId: ruleId,
        groupPercentage: 0,
      );

      debugPrint('Rule $ruleId deprecated: accuracy=${result.accuracy}');
    }
  }

  /// å®šæœŸæ£€æŸ¥æ‰€æœ‰å€™é€‰è§„åˆ™
  Future<void> checkAllCandidates() async {
    final candidates = await _ruleRepo.getCandidateRules();

    for (final rule in candidates) {
      // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾éªŒè¯æœŸé™
      final validationDays = DateTime.now().difference(rule.createdAt).inDays;
      if (validationDays >= validationConfig['validation_period_days']!) {
        await finalizeValidation(rule.id);
      }
    }
  }
}

/// éªŒè¯ç»“æœ
class ValidationResult {
  final String? ruleId;
  final int sampleSize;
  final double accuracy;
  final double controlAccuracy;
  final double improvement;
  final bool isPassing;
  final String? message;

  ValidationResult({
    this.ruleId,
    this.sampleSize = 0,
    this.accuracy = 0,
    this.controlAccuracy = 0,
    this.improvement = 0,
    this.isPassing = false,
    this.message,
  });

  factory ValidationResult.notFound() => ValidationResult(
    message: 'Rule not found',
  );

  factory ValidationResult.insufficientSamples({
    required int current,
    required int required,
  }) => ValidationResult(
    sampleSize: current,
    message: 'Insufficient samples: $current/$required',
  );
}
```

##### 16.2.4.7 åé¦ˆå­¦ä¹ æ•ˆæœåº¦é‡

```dart
/// åé¦ˆå­¦ä¹ æ•ˆæœåº¦é‡æœåŠ¡
class LearningEffectivenessMetrics {
  final AccuracyStatsRepository _statsRepo;
  final LearnedRuleRepository _ruleRepo;
  final FeedbackRepository _feedbackRepo;

  /// è®¡ç®—å­¦ä¹ ç³»ç»Ÿçš„å…³é”®æŒ‡æ ‡
  Future<LearningMetrics> calculateMetrics({
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    return LearningMetrics(
      // 1. å‡†ç¡®ç‡æå‡å¹…åº¦
      accuracyImprovement: await _calculateAccuracyImprovement(startDate, endDate),

      // 2. è§„åˆ™æ²‰æ·€ç‡
      rulePromotionRate: await _calculateRulePromotionRate(startDate, endDate),

      // 3. ç”¨æˆ·ä¿®æ­£ç‡å˜åŒ–
      correctionRateChange: await _calculateCorrectionRateChange(startDate, endDate),

      // 4. LLMè°ƒç”¨èŠ‚çœæ¯”ä¾‹
      llmCallSavingsRate: await _calculateLlmSavings(startDate, endDate),

      // 5. å­¦ä¹ å“åº”æ—¶é—´
      learningLatency: await _calculateLearningLatency(startDate, endDate),
    );
  }

  Future<double> _calculateAccuracyImprovement(DateTime start, DateTime end) async {
    final periodDays = end.difference(start).inDays;
    final midPoint = start.add(Duration(days: periodDays ~/ 2));

    final firstHalfAccuracy = await _statsRepo.getAverageAccuracy(start, midPoint);
    final secondHalfAccuracy = await _statsRepo.getAverageAccuracy(midPoint, end);

    return secondHalfAccuracy - firstHalfAccuracy;
  }

  Future<double> _calculateRulePromotionRate(DateTime start, DateTime end) async {
    final totalCandidates = await _ruleRepo.countRulesCreatedInPeriod(start, end);
    final promotedRules = await _ruleRepo.countPromotedRulesInPeriod(start, end);

    return totalCandidates > 0 ? promotedRules / totalCandidates : 0;
  }

  Future<double> _calculateLlmSavings(DateTime start, DateTime end) async {
    // è®¡ç®—å› ä¸ºè§„åˆ™åŒ¹é…è€Œé¿å…çš„LLMè°ƒç”¨
    final totalPredictions = await _statsRepo.getTotalPredictions(start, end);
    final llmCalls = await _statsRepo.getLlmCalls(start, end);

    // å¦‚æœæ²¡æœ‰è§„åˆ™åŒ¹é…ï¼Œæ‰€æœ‰é¢„æµ‹éƒ½ä¼šè°ƒç”¨LLM
    // å®é™…èŠ‚çœ = 1 - (å®é™…LLMè°ƒç”¨ / æ€»é¢„æµ‹æ•°)
    return totalPredictions > 0 ? 1 - (llmCalls / totalPredictions) : 0;
  }
}

/// å­¦ä¹ æ•ˆæœæŒ‡æ ‡
class LearningMetrics {
  final double accuracyImprovement;     // å‡†ç¡®ç‡æå‡ï¼ˆå¦‚0.05è¡¨ç¤ºæå‡5%ï¼‰
  final double rulePromotionRate;       // è§„åˆ™é€šè¿‡éªŒè¯çš„æ¯”ä¾‹
  final double correctionRateChange;    // ç”¨æˆ·ä¿®æ­£ç‡å˜åŒ–
  final double llmCallSavingsRate;      // LLMè°ƒç”¨èŠ‚çœæ¯”ä¾‹
  final Duration learningLatency;       // ä»åé¦ˆåˆ°è§„åˆ™ç”Ÿæ•ˆçš„å¹³å‡æ—¶é—´

  LearningMetrics({
    required this.accuracyImprovement,
    required this.rulePromotionRate,
    required this.correctionRateChange,
    required this.llmCallSavingsRate,
    required this.learningLatency,
  });

  /// ç”Ÿæˆå­¦ä¹ æ•ˆæœæŠ¥å‘Š
  String generateReport() {
    return '''
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    åé¦ˆå­¦ä¹ æ•ˆæœæŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ˆ å‡†ç¡®ç‡æå‡: ${(accuracyImprovement * 100).toStringAsFixed(2)}%
   ${accuracyImprovement > 0 ? 'âœ… å­¦ä¹ ç³»ç»Ÿæ­£åœ¨æŒç»­ä¼˜åŒ–åˆ†ç±»å‡†ç¡®ç‡' : 'âš ï¸ å‡†ç¡®ç‡æœªè§æ˜æ˜¾æå‡ï¼Œéœ€è¦æ£€æŸ¥å­¦ä¹ ç­–ç•¥'}

ğŸ“‹ è§„åˆ™éªŒè¯é€šè¿‡ç‡: ${(rulePromotionRate * 100).toStringAsFixed(1)}%
   å…±æœ‰ ${(rulePromotionRate * 100).toStringAsFixed(0)}% çš„å€™é€‰è§„åˆ™é€šè¿‡A/BéªŒè¯

ğŸ‘¤ ç”¨æˆ·ä¿®æ­£ç‡å˜åŒ–: ${(correctionRateChange * 100).toStringAsFixed(2)}%
   ${correctionRateChange < 0 ? 'âœ… ç”¨æˆ·ä¿®æ­£æ¬¡æ•°å‡å°‘ï¼ŒAIæ¨èæ›´å‡†ç¡®' : 'âš ï¸ ç”¨æˆ·ä¿®æ­£æ¬¡æ•°å¢åŠ ï¼Œéœ€è¦å…³æ³¨'}

ğŸ’° LLMè°ƒç”¨èŠ‚çœ: ${(llmCallSavingsRate * 100).toStringAsFixed(1)}%
   è§„åˆ™åŒ¹é…æˆåŠŸé¿å…äº† ${(llmCallSavingsRate * 100).toStringAsFixed(0)}% çš„LLM APIè°ƒç”¨

â±ï¸ å­¦ä¹ å“åº”æ—¶é—´: ${learningLatency.inMinutes} åˆ†é’Ÿ
   ä»ç”¨æˆ·åé¦ˆåˆ°è§„åˆ™ç”Ÿæ•ˆçš„å¹³å‡æ—¶é—´

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''';
  }
}
```

##### 16.2.4.8 å¤šç”¨æˆ·ååŒåˆ†ç±»å­¦ä¹ 

åŸºäºç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶ï¼ˆ15.12.1.1.8ï¼‰ï¼Œå®ç°åˆ†ç±»çŸ¥è¯†çš„ç¾¤ä½“å…±äº«ã€‚

###### 16.2.4.8.1 ååŒå­¦ä¹ æ¶æ„

```dart
/// åˆ†ç±»ååŒå­¦ä¹ æœåŠ¡
class CategoryCollaborativeLearningService {
  final PrivacyPreservingReporter _reporter;
  final GlobalCategoryRuleRepository _globalRepo;

  /// ä¸ŠæŠ¥æœ¬åœ°å­¦ä¹ åˆ°çš„åˆ†ç±»è§„åˆ™ï¼ˆéšç§ä¿æŠ¤ï¼‰
  Future<void> reportLearnedRule(CategoryRule rule) async {
    // è„±æ•å¤„ç†ï¼šåªä¸ŠæŠ¥æ¨¡å¼ï¼Œä¸ä¸ŠæŠ¥å…·ä½“å•†å®¶å
    final sanitizedRule = SanitizedCategoryRule(
      // å•†å®¶æ¨¡å¼ï¼ˆå¦‚ï¼š"*å’–å•¡*" è€Œé "æ˜Ÿå·´å…‹å’–å•¡"ï¼‰
      merchantPattern: _abstractMerchantPattern(rule.merchantName),
      // å…³é”®è¯åˆ—è¡¨
      keywords: rule.keywords,
      // ç›®æ ‡åˆ†ç±»
      categoryName: rule.category.name,
      // æœ¬åœ°ç½®ä¿¡åº¦
      localConfidence: rule.confidence,
      // æœ¬åœ°å‘½ä¸­é¢‘æ¬¡
      localFrequency: rule.frequency,
      // ç”¨æˆ·å“ˆå¸Œ
      userHash: _hashUserId(_currentUserId),
    );

    // å·®åˆ†éšç§å™ªå£°
    final noisyRule = _addDifferentialPrivacyNoise(sanitizedRule);
    await _reporter.report(noisyRule);
  }

  /// æŠ½è±¡å•†å®¶æ¨¡å¼ï¼ˆä¿æŠ¤éšç§ï¼‰
  String _abstractMerchantPattern(String? merchant) {
    if (merchant == null) return '*';

    // æå–é€šç”¨æ¨¡å¼
    // "æ˜Ÿå·´å…‹å’–å•¡(äººæ°‘å¹¿åœºåº—)" â†’ "*å’–å•¡*"
    // "ç¾å›¢å¤–å–-éº¦å½“åŠ³" â†’ "*å¤–å–*"
    final patterns = [
      RegExp(r'å’–å•¡'), RegExp(r'å¤–å–'), RegExp(r'è¶…å¸‚'),
      RegExp(r'é¤å…'), RegExp(r'é…’åº—'), RegExp(r'åŒ»é™¢'),
    ];

    for (final pattern in patterns) {
      if (pattern.hasMatch(merchant)) {
        return '*${pattern.pattern}*';
      }
    }
    return '*';  // æ— æ³•æŠ½è±¡åˆ™è¿”å›é€šé…ç¬¦
  }
}

/// å…¨å±€åˆ†ç±»è§„åˆ™èšåˆ
class GlobalCategoryRuleAggregator {

  /// èšåˆè§„åˆ™é˜ˆå€¼
  static const int minUserCount = 10;        // è‡³å°‘10ä¸ªç”¨æˆ·
  static const int minTotalFrequency = 50;   // è‡³å°‘50æ¬¡å‘½ä¸­
  static const double minConfidence = 0.85;  // æœ€ä½ç½®ä¿¡åº¦

  /// èšåˆæ¥è‡ªå¤šç”¨æˆ·çš„åˆ†ç±»è§„åˆ™
  Future<List<GlobalCategoryRule>> aggregate() async {
    final allRules = await _db.getAllReportedCategoryRules();
    final globalRules = <GlobalCategoryRule>[];

    // æŒ‰ (å•†å®¶æ¨¡å¼ + åˆ†ç±») åˆ†ç»„
    final grouped = _groupByPatternAndCategory(allRules);

    for (final entry in grouped.entries) {
      final stats = _calculateStats(entry.value);

      if (stats.uniqueUserCount >= minUserCount &&
          stats.totalFrequency >= minTotalFrequency &&
          stats.weightedConfidence >= minConfidence) {
        globalRules.add(GlobalCategoryRule(
          merchantPattern: entry.key.pattern,
          keywords: _mergeKeywords(entry.value),
          categoryName: entry.key.category,
          globalConfidence: stats.weightedConfidence,
          userCount: stats.uniqueUserCount,
          totalFrequency: stats.totalFrequency,
        ));
      }
    }

    return globalRules;
  }
}
```

###### 16.2.4.8.2 æ–°ç”¨æˆ·åˆ†ç±»å†·å¯åŠ¨

```dart
/// åˆ†ç±»å†·å¯åŠ¨æœåŠ¡
class CategoryColdStartService {

  /// ä¸ºæ–°ç”¨æˆ·åˆå§‹åŒ–åˆ†ç±»è§„åˆ™
  Future<void> initializeNewUser(String userId) async {
    // 1. åŠ è½½å…¨å±€çƒ­é—¨è§„åˆ™ï¼ˆTop 100ï¼‰
    final hotRules = await _globalRepo.getHotCategoryRules(limit: 100);

    // 2. åŠ è½½åœ°åŸŸç›¸å…³è§„åˆ™
    final regionRules = await _getRegionSpecificRules(userId);

    // 3. åˆå§‹åŒ–ç”¨æˆ·è§„åˆ™ç¼“å­˜
    await _userRuleCache.initialize(userId, [
      ...hotRules,
      ...regionRules,
    ]);

    // æ–°ç”¨æˆ·é¦–æ¬¡åˆ†ç±»å‡†ç¡®ç‡é¢„æœŸï¼š70%+ (vs æ— è§„åˆ™æ—¶50%)
  }

  /// è·å–åœ°åŸŸç›¸å…³è§„åˆ™
  Future<List<GlobalCategoryRule>> _getRegionSpecificRules(String userId) async {
    // ä¸åŒåœ°åŸŸæœ‰ä¸åŒçš„å•†å®¶å’Œæ¶ˆè´¹ä¹ æƒ¯
    // å¦‚ï¼šä¸Šæµ·çš„"å…¨å®¶"ã€åŒ—äº¬çš„"ç‰©ç¾"
    final userRegion = await _getUserRegion(userId);
    return await _globalRepo.getRulesByRegion(userRegion, limit: 50);
  }
}
```

###### 16.2.4.8.3 ååŒå­¦ä¹ æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | æ— ååŒå­¦ä¹  | æœ‰ååŒå­¦ä¹  | æå‡ |
|------|------------|------------|------|
| æ–°ç”¨æˆ·é¦–æ¬¡å‡†ç¡®ç‡ | 50% | 75% | +50% |
| å†·å¯åŠ¨å‘¨æœŸ | 2å‘¨ | å³æ—¶ | -100% |
| é•¿å°¾å•†å®¶è¦†ç›–ç‡ | 30% | 70% | +133% |
| LLMè°ƒç”¨æ¯”ä¾‹ | 40% | 20% | -50% |

### 16.3 æ™ºèƒ½é¢„ç®—å»ºè®®

#### 16.3.1 é¢„ç®—å»ºè®®ç®—æ³•

```dart
/// æ™ºèƒ½é¢„ç®—å»ºè®®æœåŠ¡
class SmartBudgetService {
  final TransactionRepository _transactionRepo;
  final BudgetRepository _budgetRepo;

  /// ç”Ÿæˆé¢„ç®—å»ºè®®ï¼ˆçº¯è§„åˆ™+ç»Ÿè®¡ç®—æ³•ï¼‰
  Future<List<BudgetSuggestion>> generateBudgetSuggestions() async {
    final suggestions = <BudgetSuggestion>[];

    // è·å–æœ€è¿‘3ä¸ªæœˆçš„æ¶ˆè´¹æ•°æ®
    final threeMonthsAgo = DateTime.now().subtract(Duration(days: 90));
    final transactions = await _transactionRepo.getExpensesSince(threeMonthsAgo);

    // æŒ‰åˆ†ç±»èšåˆç»Ÿè®¡
    final categoryStats = <String, CategorySpendingStats>{};

    for (final tx in transactions) {
      if (tx.categoryId == null) continue;

      final stats = categoryStats.putIfAbsent(
        tx.categoryId!,
        () => CategorySpendingStats(),
      );
      stats.amounts.add(tx.amount);
      stats.dates.add(tx.date);
    }

    // ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆå»ºè®®
    for (final entry in categoryStats.entries) {
      final categoryId = entry.key;
      final stats = entry.value;

      if (stats.amounts.length < 3) continue;  // æ•°æ®ä¸è¶³è·³è¿‡

      // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
      final median = _calculateMedian(stats.amounts);
      final p75 = _calculatePercentile(stats.amounts, 75);
      final monthlyAverage = stats.totalAmount / 3;
      final volatility = _calculateVolatility(stats.amounts);

      // æ£€æµ‹å­£èŠ‚æ€§ï¼ˆå¦‚æœæ˜¯å½“å‰å­£èŠ‚çš„æ¶ˆè´¹é«˜å³°ï¼‰
      final seasonalFactor = _detectSeasonality(stats.dates);

      // è®¡ç®—å»ºè®®é¢„ç®—
      double suggestedBudget;
      String reason;

      if (volatility < 0.2) {
        // æ¶ˆè´¹ç¨³å®šï¼šä½¿ç”¨ä¸­ä½æ•° + 10%ç¼“å†²
        suggestedBudget = median * 1.1;
        reason = 'æ‚¨çš„${categoryId}æ¶ˆè´¹è¾ƒç¨³å®šï¼Œå»ºè®®é¢„ç®—ç•¥é«˜äºä¸­ä½æ•°';
      } else if (volatility < 0.5) {
        // æ¶ˆè´¹æœ‰æ³¢åŠ¨ï¼šä½¿ç”¨75åˆ†ä½æ•°
        suggestedBudget = p75;
        reason = '${categoryId}æ¶ˆè´¹æœ‰ä¸€å®šæ³¢åŠ¨ï¼Œå»ºè®®ä½¿ç”¨å†å²75%åˆ†ä½æ•°';
      } else {
        // æ¶ˆè´¹æ³¢åŠ¨å¤§ï¼šä½¿ç”¨æœˆå‡å€¼ + 20%ç¼“å†²
        suggestedBudget = monthlyAverage * 1.2;
        reason = '${categoryId}æ¶ˆè´¹æ³¢åŠ¨è¾ƒå¤§ï¼Œå»ºè®®é¢„ç•™æ›´å¤šç¼“å†²';
      }

      // åº”ç”¨å­£èŠ‚æ€§è°ƒæ•´
      suggestedBudget *= seasonalFactor;

      suggestions.add(BudgetSuggestion(
        categoryId: categoryId,
        suggestedAmount: suggestedBudget.roundToDouble(),
        historicalMedian: median,
        historicalP75: p75,
        volatility: volatility,
        reason: reason,
        confidence: _calculateConfidence(stats.amounts.length, volatility),
      ));
    }

    return suggestions..sort((a, b) => b.suggestedAmount.compareTo(a.suggestedAmount));
  }

  /// è®¡ç®—ä¸­ä½æ•°
  double _calculateMedian(List<double> values) {
    final sorted = List<double>.from(values)..sort();
    final mid = sorted.length ~/ 2;
    return sorted.length.isOdd ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
  }

  /// è®¡ç®—åˆ†ä½æ•°
  double _calculatePercentile(List<double> values, int percentile) {
    final sorted = List<double>.from(values)..sort();
    final index = (percentile / 100 * sorted.length).floor();
    return sorted[index.clamp(0, sorted.length - 1)];
  }

  /// è®¡ç®—æ³¢åŠ¨ç‡ï¼ˆå˜å¼‚ç³»æ•°ï¼‰
  double _calculateVolatility(List<double> values) {
    final mean = values.reduce((a, b) => a + b) / values.length;
    final variance = values.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / values.length;
    return sqrt(variance) / mean;
  }

  /// æ£€æµ‹å­£èŠ‚æ€§å› å­
  double _detectSeasonality(List<DateTime> dates) {
    final currentMonth = DateTime.now().month;

    // ç®€å•çš„å­£èŠ‚æ€§æ£€æµ‹ï¼šæŸ¥çœ‹å†å²åŒæœŸæ•°æ®
    final sameSeasonCount = dates.where((d) {
      final monthDiff = (d.month - currentMonth).abs();
      return monthDiff <= 1 || monthDiff >= 11;  // åŒå­£èŠ‚
    }).length;

    if (sameSeasonCount > dates.length * 0.6) {
      return 1.0;  // æ•°æ®ä¸»è¦æ¥è‡ªåŒå­£èŠ‚ï¼Œä¸è°ƒæ•´
    }

    // æ ¹æ®æœˆä»½ç‰¹å¾è°ƒæ•´ï¼ˆå¦‚12æœˆæ¶ˆè´¹é€šå¸¸è¾ƒé«˜ï¼‰
    if (currentMonth == 12 || currentMonth == 1 || currentMonth == 2) {
      return 1.15;  // å¹´æœ«å¹´åˆæ¶ˆè´¹é«˜å³°
    } else if (currentMonth == 11) {
      return 1.2;  // åŒ11è´­ç‰©èŠ‚
    } else if (currentMonth == 6 || currentMonth == 7) {
      return 1.1;  // 618è´­ç‰©èŠ‚+æš‘æœŸ
    }

    return 1.0;
  }

  /// è®¡ç®—ç½®ä¿¡åº¦
  double _calculateConfidence(int sampleSize, double volatility) {
    // æ ·æœ¬é‡è¶Šå¤§ã€æ³¢åŠ¨è¶Šå°ï¼Œç½®ä¿¡åº¦è¶Šé«˜
    final sizeFactor = min(1.0, sampleSize / 30);
    final volatilityFactor = max(0.3, 1 - volatility);
    return (sizeFactor * 0.6 + volatilityFactor * 0.4).clamp(0.3, 0.95);
  }
}

/// åˆ†ç±»æ¶ˆè´¹ç»Ÿè®¡
class CategorySpendingStats {
  final List<double> amounts = [];
  final List<DateTime> dates = [];

  double get totalAmount => amounts.fold(0.0, (a, b) => a + b);
}
```

#### 16.3.2 é¢„ç®—å»ºè®®è‡ªå­¦ä¹ ç³»ç»Ÿ

> **ğŸ“š æ¨¡å—åŒ–è®¾è®¡è¯´æ˜**
>
> é¢„ç®—å»ºè®®çš„è‡ªå­¦ä¹ èƒ½åŠ›åŸºäº**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**æä¾›çš„ç»Ÿä¸€æ¡†æ¶å®ç°ã€‚
> å…·ä½“å®ç°è¯·å‚è§16.3.2èŠ‚ï¼ˆé¢„ç®—å»ºè®®å­¦ä¹ é€‚é…å™¨ï¼‰ã€‚

##### 16.3.2.1 å­¦ä¹ ç›®æ ‡ä¸æ•°æ®é‡‡é›†

```dart
/// é¢„ç®—å­¦ä¹ æ ·æœ¬
class BudgetLearningSample extends LearningSample<BudgetContext, BudgetSuggestion> {
  final double suggestedAmount;     // å»ºè®®é‡‘é¢
  final double? acceptedAmount;     // ç”¨æˆ·é‡‡çº³é‡‘é¢
  final BudgetAdjustType adjustType; // è°ƒæ•´ç±»å‹

  @override
  double get qualityScore {
    var score = 0.0;
    // ç”¨æˆ·å®Œå…¨é‡‡çº³
    if (acceptedAmount == suggestedAmount) score += 0.5;
    // ç”¨æˆ·è°ƒæ•´åé‡‡çº³ï¼ˆä¹Ÿæ˜¯æœ‰ä»·å€¼çš„åé¦ˆï¼‰
    if (acceptedAmount != null && acceptedAmount != suggestedAmount) score += 0.4;
    // é«˜ç½®ä¿¡åº¦å»ºè®®
    if (confidence > 0.8) score += 0.2;
    return score.clamp(0.0, 1.0);
  }
}

enum BudgetAdjustType {
  accepted,      // å®Œå…¨é‡‡çº³
  adjusted,      // è°ƒæ•´åé‡‡çº³
  rejected,      // æ‹’ç»
  ignored,       // å¿½ç•¥
}

/// é¢„ç®—å­¦ä¹ æ•°æ®é‡‡é›†
class BudgetLearningCollector {

  /// é‡‡é›†ç”¨æˆ·å¯¹é¢„ç®—å»ºè®®çš„åé¦ˆ
  Future<void> collectFeedback({
    required String suggestionId,
    required double suggestedAmount,
    required double? acceptedAmount,
    required BudgetAdjustType adjustType,
  }) async {
    final sample = BudgetLearningSample(
      id: _generateId(),
      input: await _getCurrentBudgetContext(),
      predictedOutput: BudgetSuggestion(amount: suggestedAmount),
      actualOutput: acceptedAmount != null
          ? BudgetSuggestion(amount: acceptedAmount) : null,
      confidence: _lastPredictionConfidence,
      label: _mapAdjustTypeToLabel(adjustType),
      timestamp: DateTime.now(),
      userId: _currentUserId,
      suggestedAmount: suggestedAmount,
      acceptedAmount: acceptedAmount,
      adjustType: adjustType,
    );

    await _sampleStore.insert(sample);

    // è§¦å‘å¢é‡å­¦ä¹ 
    if (sample.qualityScore >= 0.6) {
      await _learningService.incrementalLearn(sample);
    }
  }
}
```

##### 16.3.2.2 ä¸ªæ€§åŒ–é¢„ç®—æ¨¡å‹

```dart
/// ä¸ªæ€§åŒ–é¢„ç®—å­¦ä¹ æœåŠ¡
class PersonalizedBudgetLearningService {

  /// å­¦ä¹ ç”¨æˆ·é¢„ç®—åå¥½
  Future<UserBudgetPreferences> learnPreferences(String userId) async {
    final samples = await _sampleStore.getUserSamples(userId);

    return UserBudgetPreferences(
      // ç”¨æˆ·å€¾å‘äºæ¥å—çš„é¢„ç®—æ¯”ä¾‹ï¼ˆç›¸å¯¹äºå»ºè®®å€¼ï¼‰
      acceptanceRatio: _calculateAcceptanceRatio(samples),
      // å„åˆ†ç±»çš„é¢„ç®—å¼¹æ€§ï¼ˆç”¨æˆ·è°ƒæ•´å¹…åº¦ï¼‰
      categoryElasticity: _calculateCategoryElasticity(samples),
      // ç”¨æˆ·å¯¹é¢„ç®—ç´§å¼ åº¦çš„å®¹å¿åº¦
      tightnessPreference: _calculateTightnessPreference(samples),
      // å­£èŠ‚æ€§è°ƒæ•´åå¥½
      seasonalAdjustments: _calculateSeasonalAdjustments(samples),
    );
  }

  /// è®¡ç®—æ¥å—æ¯”ä¾‹
  double _calculateAcceptanceRatio(List<BudgetLearningSample> samples) {
    final acceptedSamples = samples.where((s) =>
      s.adjustType == BudgetAdjustType.accepted ||
      s.adjustType == BudgetAdjustType.adjusted
    ).toList();

    if (acceptedSamples.isEmpty) return 1.0;

    final ratios = acceptedSamples
        .where((s) => s.acceptedAmount != null)
        .map((s) => s.acceptedAmount! / s.suggestedAmount);

    return ratios.isEmpty ? 1.0 : ratios.average;
  }

  /// åº”ç”¨ä¸ªæ€§åŒ–è°ƒæ•´
  Future<BudgetSuggestion> applyPersonalization(
    BudgetSuggestion baseSuggestion,
    String userId,
  ) async {
    final prefs = await learnPreferences(userId);

    // æ ¹æ®ç”¨æˆ·å†å²åå¥½è°ƒæ•´å»ºè®®
    final adjustedAmount = baseSuggestion.amount * prefs.acceptanceRatio;

    // åº”ç”¨åˆ†ç±»å¼¹æ€§
    final categoryAdjust = prefs.categoryElasticity[baseSuggestion.categoryId] ?? 1.0;
    final finalAmount = adjustedAmount * categoryAdjust;

    return baseSuggestion.copyWith(
      amount: finalAmount,
      confidence: baseSuggestion.confidence * 1.1,  // ä¸ªæ€§åŒ–æå‡ç½®ä¿¡åº¦
      reason: '${baseSuggestion.reason}ï¼ˆå·²æ ¹æ®æ‚¨çš„ä¹ æƒ¯è°ƒæ•´ï¼‰',
    );
  }
}
```

##### 16.3.2.3 å¤šç”¨æˆ·ååŒé¢„ç®—å­¦ä¹ 

```dart
/// é¢„ç®—ååŒå­¦ä¹ æœåŠ¡
class BudgetCollaborativeLearningService {

  /// ä¸ŠæŠ¥é¢„ç®—æ¨¡å¼ï¼ˆéšç§ä¿æŠ¤ï¼‰
  Future<void> reportBudgetPattern(BudgetLearningSample sample) async {
    // åªä¸ŠæŠ¥ç›¸å¯¹æ¯”ä¾‹ï¼Œä¸ä¸ŠæŠ¥ç»å¯¹é‡‘é¢
    final pattern = SanitizedBudgetPattern(
      // åˆ†ç±»
      categoryName: sample.input.categoryName,
      // æ”¶å…¥åŒºé—´ï¼ˆè„±æ•ï¼‰
      incomeRange: _getIncomeRange(sample.input.monthlyIncome),
      // å»ºè®®/å®é™…æ¯”ä¾‹
      acceptanceRatio: sample.acceptedAmount != null
          ? sample.acceptedAmount! / sample.suggestedAmount : null,
      // è°ƒæ•´ç±»å‹
      adjustType: sample.adjustType,
      // ç”¨æˆ·å“ˆå¸Œ
      userHash: _hashUserId(sample.userId),
    );

    await _reporter.report(pattern);
  }

  /// æ”¶å…¥åŒºé—´è„±æ•
  String _getIncomeRange(double income) {
    if (income < 5000) return '0-5k';
    if (income < 10000) return '5k-10k';
    if (income < 20000) return '10k-20k';
    if (income < 50000) return '20k-50k';
    return '50k+';
  }
}

/// å…¨å±€é¢„ç®—æ´å¯Ÿèšåˆ
class GlobalBudgetInsightsAggregator {

  /// èšåˆç¾¤ä½“é¢„ç®—åå¥½
  Future<GlobalBudgetInsights> aggregate() async {
    final patterns = await _db.getAllBudgetPatterns();

    return GlobalBudgetInsights(
      // å„æ”¶å…¥åŒºé—´çš„å¹³å‡é¢„ç®—åˆ†é…æ¯”ä¾‹
      incomeRangeBudgetRatios: _aggregateByIncomeRange(patterns),
      // å„åˆ†ç±»çš„ç¾¤ä½“å¹³å‡è°ƒæ•´å¹…åº¦
      categoryAdjustmentTrends: _aggregateByCategoryTrends(patterns),
      // å­£èŠ‚æ€§é¢„ç®—å˜åŒ–è¶‹åŠ¿
      seasonalTrends: _aggregateSeasonalTrends(patterns),
    );
  }

  /// ä¸ºæ–°ç”¨æˆ·æä¾›å‚è€ƒé¢„ç®—
  Future<Map<String, double>> getReferenceBudget({
    required double monthlyIncome,
    required String region,
  }) async {
    final incomeRange = _getIncomeRange(monthlyIncome);
    final insights = await aggregate();

    // åŸºäºç¾¤ä½“æ•°æ®æ¨èå„åˆ†ç±»é¢„ç®—æ¯”ä¾‹
    final ratios = insights.incomeRangeBudgetRatios[incomeRange] ?? {};

    return ratios.map((category, ratio) =>
      MapEntry(category, monthlyIncome * ratio));
  }
}
```

##### 16.3.2.4 é¢„ç®—å­¦ä¹ æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | åŸºçº¿ | è‡ªå­¦ä¹ å | +ååŒå­¦ä¹  |
|------|------|----------|-----------|
| å»ºè®®é‡‡çº³ç‡ | 40% | 60% | 75% |
| å¹³å‡è°ƒæ•´å¹…åº¦ | 30% | 15% | 10% |
| æ–°ç”¨æˆ·é¦–æ¬¡å‡†ç¡®ç‡ | 35% | 35% | 55% |

### 16.4 æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹

#### 16.4.1 æ—¶é—´åºåˆ—é¢„æµ‹

```dart
/// æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹æœåŠ¡
class TrendPredictionService {
  final TransactionRepository _transactionRepo;

  /// é¢„æµ‹ä¸‹æœˆæ¶ˆè´¹ï¼ˆä½¿ç”¨ç®€å•ç§»åŠ¨å¹³å‡ + å­£èŠ‚æ€§è°ƒæ•´ï¼‰
  Future<MonthlyPrediction> predictNextMonth() async {
    // è·å–è¿‡å»12ä¸ªæœˆçš„æœˆåº¦æ¶ˆè´¹
    final monthlyData = await _getMonthlySpending(months: 12);

    if (monthlyData.length < 3) {
      return MonthlyPrediction(
        predictedAmount: 0,
        confidence: 0,
        method: 'insufficient_data',
      );
    }

    // æ–¹æ³•1: ç®€å•ç§»åŠ¨å¹³å‡ï¼ˆSMAï¼‰
    final sma3 = _calculateSMA(monthlyData, 3);

    // æ–¹æ³•2: åŠ æƒç§»åŠ¨å¹³å‡ï¼ˆWMAï¼‰- æœ€è¿‘çš„æƒé‡æ›´é«˜
    final wma3 = _calculateWMA(monthlyData, [0.5, 0.33, 0.17]);

    // æ–¹æ³•3: å­£èŠ‚æ€§è°ƒæ•´
    final seasonalFactor = _getSeasonalFactor(DateTime.now().month + 1);

    // ç»¼åˆé¢„æµ‹
    final predicted = (sma3 * 0.4 + wma3 * 0.6) * seasonalFactor;

    // è®¡ç®—ç½®ä¿¡åŒºé—´
    final stdDev = _calculateStdDev(monthlyData);
    final lowerBound = predicted - 1.96 * stdDev;
    final upperBound = predicted + 1.96 * stdDev;

    return MonthlyPrediction(
      predictedAmount: predicted,
      lowerBound: lowerBound,
      upperBound: upperBound,
      confidence: _calculatePredictionConfidence(monthlyData),
      method: 'wma_seasonal',
      breakdown: await _predictByCategory(),
    );
  }

  /// è®¡ç®—ç®€å•ç§»åŠ¨å¹³å‡
  double _calculateSMA(List<double> data, int period) {
    if (data.length < period) return data.last;
    final recent = data.sublist(data.length - period);
    return recent.reduce((a, b) => a + b) / period;
  }

  /// è®¡ç®—åŠ æƒç§»åŠ¨å¹³å‡
  double _calculateWMA(List<double> data, List<double> weights) {
    final period = weights.length;
    if (data.length < period) return data.last;

    final recent = data.sublist(data.length - period);
    double sum = 0;
    for (int i = 0; i < period; i++) {
      sum += recent[i] * weights[period - 1 - i];
    }
    return sum;
  }

  /// å­£èŠ‚æ€§å› å­
  double _getSeasonalFactor(int month) {
    // åŸºäºå†å²æ•°æ®è®¡ç®—çš„æœˆåº¦å› å­ï¼ˆç¤ºä¾‹å€¼ï¼‰
    const factors = {
      1: 1.15,  // æ˜¥èŠ‚
      2: 1.10,  // æ˜¥èŠ‚
      3: 0.95,
      4: 0.95,
      5: 1.00,
      6: 1.10,  // 618
      7: 1.05,
      8: 1.00,
      9: 0.95,
      10: 1.05, // å›½åº†
      11: 1.20, // åŒ11
      12: 1.10, // å¹´æœ«
    };
    return factors[month] ?? 1.0;
  }
}
```

### 16.5 æ™ºèƒ½å¼‚å¸¸æ£€æµ‹

#### 16.5.1 äº¤æ˜“å¼‚å¸¸æ£€æµ‹

```dart
/// äº¤æ˜“å¼‚å¸¸æ£€æµ‹æœåŠ¡
class AnomalyDetectionService {
  final TransactionRepository _transactionRepo;

  /// æ£€æµ‹å¼‚å¸¸äº¤æ˜“
  Future<List<AnomalyAlert>> detectAnomalies(Transaction newTx) async {
    final alerts = <AnomalyAlert>[];

    // ===== æ£€æµ‹1: é‡‘é¢å¼‚å¸¸ï¼ˆåŸºäºåˆ†ç±»å†å²ï¼‰=====
    final categoryHistory = await _transactionRepo.getByCategory(
      newTx.categoryId!,
      limit: 50,
    );

    if (categoryHistory.length >= 10) {
      final amounts = categoryHistory.map((t) => t.amount).toList();
      final mean = amounts.reduce((a, b) => a + b) / amounts.length;
      final stdDev = _calculateStdDev(amounts);

      // 3ÏƒåŸåˆ™ï¼šè¶…è¿‡3ä¸ªæ ‡å‡†å·®è§†ä¸ºå¼‚å¸¸
      if ((newTx.amount - mean).abs() > 3 * stdDev) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualAmount,
          severity: AnomalySeverity.high,
          message: 'æ­¤ç¬”${newTx.categoryName}æ¶ˆè´¹é‡‘é¢(Â¥${newTx.amount})æ˜¾è‘—é«˜äºå¹³å‡æ°´å¹³(Â¥${mean.toStringAsFixed(0)})',
          suggestion: 'è¯·ç¡®è®¤é‡‘é¢æ˜¯å¦æ­£ç¡®',
        ));
      } else if ((newTx.amount - mean).abs() > 2 * stdDev) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualAmount,
          severity: AnomalySeverity.medium,
          message: 'æ­¤ç¬”æ¶ˆè´¹é‡‘é¢è¾ƒé«˜',
          suggestion: null,
        ));
      }
    }

    // ===== æ£€æµ‹2: æ—¶é—´å¼‚å¸¸ =====
    final hour = newTx.date.hour;
    if (hour >= 0 && hour < 6) {
      // å‡Œæ™¨æ¶ˆè´¹
      final lateNightHistory = categoryHistory.where((t) {
        final h = t.date.hour;
        return h >= 0 && h < 6;
      }).length;

      if (lateNightHistory < categoryHistory.length * 0.1) {
        alerts.add(AnomalyAlert(
          type: AnomalyType.unusualTime,
          severity: AnomalySeverity.low,
          message: 'å‡Œæ™¨æ¶ˆè´¹è®°å½•',
          suggestion: null,
        ));
      }
    }

    // ===== æ£€æµ‹3: é¢‘ç‡å¼‚å¸¸ =====
    final todayCount = await _transactionRepo.countToday(newTx.categoryId!);
    final avgDailyCount = categoryHistory.length / 30;  // å‡è®¾30å¤©å†å²

    if (todayCount > avgDailyCount * 3 && todayCount > 3) {
      alerts.add(AnomalyAlert(
        type: AnomalyType.unusualFrequency,
        severity: AnomalySeverity.medium,
        message: 'ä»Šæ—¥${newTx.categoryName}æ¶ˆè´¹æ¬¡æ•°($todayCountæ¬¡)æ˜æ˜¾å¤šäºå¹³å¸¸',
        suggestion: 'æ˜¯å¦æœ‰é‡å¤è®°å½•?',
      ));
    }

    // ===== æ£€æµ‹4: é‡å¤äº¤æ˜“å«Œç–‘ =====
    final duplicateSuspects = await _findPotentialDuplicates(newTx);
    if (duplicateSuspects.isNotEmpty) {
      alerts.add(AnomalyAlert(
        type: AnomalyType.potentialDuplicate,
        severity: AnomalySeverity.high,
        message: 'å‘ç°${duplicateSuspects.length}ç¬”ç›¸ä¼¼äº¤æ˜“',
        suggestion: 'ç‚¹å‡»æŸ¥çœ‹æ˜¯å¦é‡å¤',
        relatedTransactions: duplicateSuspects,
      ));
    }

    return alerts;
  }

  /// æŸ¥æ‰¾æ½œåœ¨é‡å¤äº¤æ˜“
  Future<List<Transaction>> _findPotentialDuplicates(Transaction tx) async {
    // æŸ¥æ‰¾åŒä¸€å¤©ã€ç›¸åŒé‡‘é¢çš„äº¤æ˜“
    final sameDaySameAmount = await _transactionRepo.findByDateAndAmount(
      date: tx.date,
      amount: tx.amount,
      excludeId: tx.id,
    );

    // ä½¿ç”¨æè¿°ç›¸ä¼¼åº¦è¿‡æ»¤
    return sameDaySameAmount.where((t) {
      final similarity = _stringSimilarity(t.description ?? '', tx.description ?? '');
      return similarity > 0.6;
    }).toList();
  }

  /// å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ï¼ˆJaccardç›¸ä¼¼åº¦ï¼‰
  double _stringSimilarity(String a, String b) {
    if (a.isEmpty && b.isEmpty) return 1.0;
    if (a.isEmpty || b.isEmpty) return 0.0;

    final setA = a.split('').toSet();
    final setB = b.split('').toSet();
    final intersection = setA.intersection(setB).length;
    final union = setA.union(setB).length;

    return intersection / union;
  }
}

/// å¼‚å¸¸ç±»å‹
enum AnomalyType {
  unusualAmount,      // é‡‘é¢å¼‚å¸¸
  unusualTime,        // æ—¶é—´å¼‚å¸¸
  unusualFrequency,   // é¢‘ç‡å¼‚å¸¸
  potentialDuplicate, // æ½œåœ¨é‡å¤
  unusualCategory,    // åˆ†ç±»å¼‚å¸¸
}
```

#### 16.5.2 å¼‚å¸¸æ£€æµ‹è‡ªå­¦ä¹ ç³»ç»Ÿ

> **ğŸ“š æ¨¡å—åŒ–è®¾è®¡è¯´æ˜**
>
> å¼‚å¸¸æ£€æµ‹çš„è‡ªå­¦ä¹ èƒ½åŠ›åŸºäº**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**æä¾›çš„ç»Ÿä¸€æ¡†æ¶å®ç°ã€‚
> å…·ä½“å®ç°è¯·å‚è§16.3.3èŠ‚ï¼ˆå¼‚å¸¸æ£€æµ‹å­¦ä¹ é€‚é…å™¨ï¼‰ã€‚

##### 16.5.2.1 ä¸ªæ€§åŒ–å¼‚å¸¸é˜ˆå€¼å­¦ä¹ 

```dart
/// å¼‚å¸¸æ£€æµ‹å­¦ä¹ æœåŠ¡
class AnomalyLearningService extends BaseLearningService<
    Transaction, AnomalyResult, AnomalyLearningSample> {

  /// å­¦ä¹ ç”¨æˆ·çš„å¼‚å¸¸åˆ¤å®šåå¥½
  Future<UserAnomalyPreferences> learnAnomalyPreferences(String userId) async {
    final samples = await _sampleStore.getUserSamples(userId);

    // åˆ†æç”¨æˆ·å¯¹å¼‚å¸¸æé†’çš„åé¦ˆ
    final confirmedAnomalies = samples.where((s) =>
      s.label == SampleLabel.confirmedPositive).toList();
    final dismissedAnomalies = samples.where((s) =>
      s.label == SampleLabel.negative).toList();

    return UserAnomalyPreferences(
      // å„åˆ†ç±»çš„ä¸ªæ€§åŒ–Z-Scoreé˜ˆå€¼
      categoryThresholds: _calculateCategoryThresholds(
        confirmedAnomalies, dismissedAnomalies),
      // ç”¨æˆ·å¯¹å¤§é¢æ¶ˆè´¹çš„æ•æ„Ÿåº¦
      amountSensitivity: _calculateAmountSensitivity(samples),
      // ç”¨æˆ·å¯¹å¼‚åœ°æ¶ˆè´¹çš„æ•æ„Ÿåº¦
      locationSensitivity: _calculateLocationSensitivity(samples),
      // ç”¨æˆ·å¯¹é«˜é¢‘æ¶ˆè´¹çš„æ•æ„Ÿåº¦
      frequencySensitivity: _calculateFrequencySensitivity(samples),
    );
  }

  /// è®¡ç®—å„åˆ†ç±»çš„ä¸ªæ€§åŒ–é˜ˆå€¼
  Map<String, double> _calculateCategoryThresholds(
    List<AnomalyLearningSample> confirmed,
    List<AnomalyLearningSample> dismissed,
  ) {
    final thresholds = <String, double>{};

    // å¯¹äºç”¨æˆ·ç»å¸¸å¿½ç•¥çš„åˆ†ç±»ï¼Œæé«˜é˜ˆå€¼
    for (final sample in dismissed) {
      final category = sample.input.categoryId;
      if (category != null) {
        thresholds[category] = (thresholds[category] ?? 2.0) * 1.1;
      }
    }

    // å¯¹äºç”¨æˆ·ç¡®è®¤çš„å¼‚å¸¸ï¼Œé™ä½é˜ˆå€¼ï¼ˆæ›´æ•æ„Ÿï¼‰
    for (final sample in confirmed) {
      final category = sample.input.categoryId;
      if (category != null) {
        thresholds[category] = (thresholds[category] ?? 2.0) * 0.95;
      }
    }

    return thresholds;
  }

  @override
  Future<void> updatePersonalizedModel(AnomalyLearningSample sample) async {
    final prefs = await learnAnomalyPreferences(sample.userId);
    await _preferencesStore.save(sample.userId, prefs);
  }
}

/// ç”¨æˆ·å¼‚å¸¸åå¥½
class UserAnomalyPreferences {
  final Map<String, double> categoryThresholds;  // é»˜è®¤2.0
  final double amountSensitivity;     // 0-1, é»˜è®¤0.5
  final double locationSensitivity;   // 0-1, é»˜è®¤0.5
  final double frequencySensitivity;  // 0-1, é»˜è®¤0.5

  /// åº”ç”¨ä¸ªæ€§åŒ–é˜ˆå€¼åˆ¤å®šå¼‚å¸¸
  bool isAnomaly(Transaction tx, double zScore) {
    final threshold = categoryThresholds[tx.categoryId] ?? 2.0;
    return zScore > threshold;
  }
}
```

##### 16.5.2.2 å¼‚å¸¸æ¨¡å¼å­¦ä¹ 

```dart
/// å¼‚å¸¸æ¨¡å¼æŒ–æ˜æœåŠ¡
class AnomalyPatternMiningService {

  /// ä»ç¡®è®¤çš„å¼‚å¸¸ä¸­å­¦ä¹ æ¨¡å¼
  Future<List<AnomalyPattern>> minePatterns() async {
    final confirmedAnomalies = await _sampleStore.getConfirmedAnomalies();

    final patterns = <AnomalyPattern>[];

    // 1. é‡‘é¢å¼‚å¸¸æ¨¡å¼
    patterns.addAll(_mineAmountPatterns(confirmedAnomalies));

    // 2. æ—¶é—´å¼‚å¸¸æ¨¡å¼ï¼ˆå¦‚å‡Œæ™¨æ¶ˆè´¹ï¼‰
    patterns.addAll(_mineTimePatterns(confirmedAnomalies));

    // 3. é¢‘ç‡å¼‚å¸¸æ¨¡å¼ï¼ˆå¦‚åŒä¸€å•†å®¶è¿ç»­æ¶ˆè´¹ï¼‰
    patterns.addAll(_mineFrequencyPatterns(confirmedAnomalies));

    // 4. ç»„åˆå¼‚å¸¸æ¨¡å¼
    patterns.addAll(_mineCombinedPatterns(confirmedAnomalies));

    return patterns;
  }

  /// æŒ–æ˜é‡‘é¢å¼‚å¸¸æ¨¡å¼
  List<AnomalyPattern> _mineAmountPatterns(List<AnomalyLearningSample> samples) {
    final patterns = <AnomalyPattern>[];

    // æŒ‰åˆ†ç±»åˆ†ç»„ï¼Œæ‰¾å‡ºå„åˆ†ç±»çš„å¼‚å¸¸é‡‘é¢ç‰¹å¾
    final byCategory = _groupByCategory(samples);

    for (final entry in byCategory.entries) {
      final amounts = entry.value.map((s) => s.input.amount).toList();
      if (amounts.length >= 5) {
        final percentile90 = _calculatePercentile(amounts, 0.9);
        patterns.add(AnomalyPattern(
          type: AnomalyPatternType.amount,
          category: entry.key,
          condition: 'amount > $percentile90',
          confidence: 0.8,
        ));
      }
    }

    return patterns;
  }
}
```

##### 16.5.2.3 å¤šç”¨æˆ·ååŒå¼‚å¸¸æ£€æµ‹

```dart
/// å¼‚å¸¸æ£€æµ‹ååŒå­¦ä¹ æœåŠ¡
class AnomalyCollaborativeLearningService {

  /// ä¸ŠæŠ¥å¼‚å¸¸æ¨¡å¼ï¼ˆéšç§ä¿æŠ¤ï¼‰
  Future<void> reportAnomalyPattern(AnomalyPattern pattern) async {
    // åªä¸ŠæŠ¥æ¨¡å¼ç‰¹å¾ï¼Œä¸ä¸ŠæŠ¥å…·ä½“é‡‘é¢
    final sanitizedPattern = SanitizedAnomalyPattern(
      type: pattern.type,
      category: pattern.category,
      // ç›¸å¯¹é˜ˆå€¼è€Œéç»å¯¹å€¼
      relativeThreshold: pattern.relativeThreshold,
      userHash: _hashUserId(_currentUserId),
    );

    await _reporter.report(sanitizedPattern);
  }
}

/// å…¨å±€å¼‚å¸¸æ¨¡å¼èšåˆ
class GlobalAnomalyPatternAggregator {

  /// å‘ç°ç¾¤ä½“çº§å¼‚å¸¸æ¨¡å¼
  Future<List<GlobalAnomalyPattern>> discoverGlobalPatterns() async {
    final patterns = await _db.getAllAnomalyPatterns();

    // èšåˆå‘ç°è·¨ç”¨æˆ·çš„å…±åŒå¼‚å¸¸æ¨¡å¼
    return [
      // å¦‚ï¼šå¤§å¤šæ•°ç”¨æˆ·è®¤ä¸ºé¤é¥®å•ç¬”è¶…è¿‡æœˆå‡5å€æ˜¯å¼‚å¸¸
      // å¦‚ï¼šå‡Œæ™¨2-5ç‚¹çš„æ¶ˆè´¹æ™®éè¢«æ ‡è®°ä¸ºå¼‚å¸¸
      // å¦‚ï¼šåŒä¸€å•†å®¶1å°æ—¶å†…3æ¬¡ä»¥ä¸Šæ¶ˆè´¹è¢«æ ‡è®°ä¸ºå¼‚å¸¸
    ];
  }

  /// æ–°å‹è¯ˆéª—/ç›—åˆ·æ¨¡å¼é¢„è­¦
  Future<List<FraudAlert>> detectEmergingFraudPatterns() async {
    // å½“å¤šä¸ªç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…æŠ¥å‘Šç›¸ä¼¼çš„å¼‚å¸¸æ¨¡å¼æ—¶
    // å¯èƒ½æ˜¯æ–°å‹è¯ˆéª—æ‰‹æ®µï¼Œéœ€è¦å…¨å±€é¢„è­¦
    final recentPatterns = await _db.getRecentAnomalyPatterns(hours: 24);

    final clusters = _clusterSimilarPatterns(recentPatterns);

    return clusters
        .where((c) => c.userCount >= 10 && c.similarity >= 0.8)
        .map((c) => FraudAlert(
          pattern: c.representativePattern,
          affectedUsers: c.userCount,
          confidence: c.similarity,
          firstDetected: c.earliestTimestamp,
        ))
        .toList();
  }
}
```

##### 16.5.2.4 å¼‚å¸¸æ£€æµ‹å­¦ä¹ æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | åŸºçº¿ | è‡ªå­¦ä¹ å | +ååŒå­¦ä¹  |
|------|------|----------|-----------|
| è¯¯æŠ¥ç‡ | 30% | 15% | 10% |
| æ¼æŠ¥ç‡ | 20% | 12% | 8% |
| ç”¨æˆ·æ»¡æ„åº¦ | 60% | 80% | 90% |
| æ–°å‹è¯ˆéª—å‘ç° | - | - | <24h |

### 16.6 è‡ªç„¶è¯­è¨€æœç´¢

#### 16.6.1 æ„å›¾è¯†åˆ«ä¸æŸ¥è¯¢è½¬æ¢

```dart
/// è‡ªç„¶è¯­è¨€æœç´¢æœåŠ¡
class NaturalLanguageSearchService {
  final LLMService _llmService;
  final TransactionRepository _transactionRepo;

  /// å¤„ç†è‡ªç„¶è¯­è¨€æŸ¥è¯¢
  Future<SearchResult> search(String query) async {
    // ç¬¬ä¸€æ­¥ï¼šæ„å›¾è¯†åˆ«ï¼ˆæœ¬åœ°è§„åˆ™ä¼˜å…ˆï¼‰
    final intent = _parseQueryIntent(query);

    if (intent != null) {
      // æœ¬åœ°è§„åˆ™èƒ½å¤„ç†
      return await _executeLocalQuery(intent);
    }

    // ç¬¬äºŒæ­¥ï¼šå¤§æ¨¡å‹ç†è§£å¤æ‚æŸ¥è¯¢
    return await _executeLLMQuery(query);
  }

  /// æœ¬åœ°è§„åˆ™è§£ææ„å›¾
  QueryIntent? _parseQueryIntent(String query) {
    // æ—¶é—´æ¨¡å¼åŒ¹é…
    final timePatterns = {
      RegExp(r'ä¸Šä¸ª?æœˆ'): () => _getLastMonth(),
      RegExp(r'è¿™ä¸ª?æœˆ|æœ¬æœˆ'): () => _getCurrentMonth(),
      RegExp(r'ä¸Šå‘¨'): () => _getLastWeek(),
      RegExp(r'ä»Šå¤©'): () => _getToday(),
      RegExp(r'æ˜¨å¤©'): () => _getYesterday(),
      RegExp(r'(\d+)æœˆ'): (Match m) => _getMonth(int.parse(m.group(1)!)),
    };

    DateRange? dateRange;
    for (final entry in timePatterns.entries) {
      final match = entry.key.firstMatch(query);
      if (match != null) {
        dateRange = entry.value is Function()
            ? (entry.value as Function())()
            : (entry.value as Function(Match))(match);
        break;
      }
    }

    // åˆ†ç±»æ¨¡å¼åŒ¹é…
    String? category;
    final categoryKeywords = ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹', 'å±…ä½', 'åŒ»ç–—', 'æ•™è‚²'];
    for (final kw in categoryKeywords) {
      if (query.contains(kw)) {
        category = kw;
        break;
      }
    }

    // é‡‘é¢æŸ¥è¯¢æ¨¡å¼
    final amountMatch = RegExp(r'èŠ±äº†?å¤šå°‘|æ¶ˆè´¹äº†?å¤šå°‘|æ€»å…±|åˆè®¡').hasMatch(query);

    // ç»Ÿè®¡æŸ¥è¯¢æ¨¡å¼
    final statsMatch = RegExp(r'æœ€å¤š|æœ€å°‘|å¹³å‡|è¶‹åŠ¿').hasMatch(query);

    if (dateRange != null || category != null) {
      return QueryIntent(
        type: amountMatch ? QueryType.sum : (statsMatch ? QueryType.stats : QueryType.list),
        dateRange: dateRange,
        category: category,
        originalQuery: query,
      );
    }

    return null;  // æ— æ³•æœ¬åœ°è§£æ
  }

  /// æ‰§è¡Œæœ¬åœ°æŸ¥è¯¢
  Future<SearchResult> _executeLocalQuery(QueryIntent intent) async {
    switch (intent.type) {
      case QueryType.sum:
        final total = await _transactionRepo.sumByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
        );
        return SearchResult(
          answer: '${intent.category ?? ''}æ¶ˆè´¹å…± Â¥${total.toStringAsFixed(2)}',
          type: ResultType.answer,
          data: {'total': total},
        );

      case QueryType.list:
        final transactions = await _transactionRepo.findByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
          limit: 50,
        );
        return SearchResult(
          answer: 'æ‰¾åˆ° ${transactions.length} æ¡è®°å½•',
          type: ResultType.list,
          data: {'transactions': transactions},
        );

      case QueryType.stats:
        final stats = await _transactionRepo.getStatsByFilter(
          dateRange: intent.dateRange,
          categoryName: intent.category,
        );
        return SearchResult(
          answer: _formatStats(stats),
          type: ResultType.stats,
          data: stats,
        );
    }
  }

  /// ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†å¤æ‚æŸ¥è¯¢
  Future<SearchResult> _executeLLMQuery(String query) async {
    final prompt = '''
ä½ æ˜¯ä¸€ä¸ªè®°è´¦æŸ¥è¯¢åŠ©æ‰‹ã€‚ç”¨æˆ·é—®äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¯·åˆ†æç”¨æˆ·æ„å›¾å¹¶è¿”å›ç»“æ„åŒ–çš„æŸ¥è¯¢æ¡ä»¶ã€‚

ç”¨æˆ·é—®é¢˜ï¼š$query

è¯·è¿”å›JSONæ ¼å¼ï¼š
{
  "intent": "sum|list|compare|trend",
  "date_range": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"} æˆ– null,
  "category": "åˆ†ç±»å" æˆ– null,
  "merchant": "å•†å®¶å" æˆ– null,
  "amount_filter": {"min": æ•°å­—, "max": æ•°å­—} æˆ– null,
  "sort": "amount|date" æˆ– null,
  "natural_answer_template": "ç”¨äºå›ç­”ç”¨æˆ·çš„æ¨¡æ¿ï¼Œç”¨{result}ä½œä¸ºå ä½ç¬¦"
}
''';

    try {
      final response = await _llmService.chat(prompt);
      final json = jsonDecode(_extractJson(response));

      // æ‰§è¡Œè§£æå‡ºçš„æŸ¥è¯¢
      return await _executeStructuredQuery(json, query);
    } catch (e) {
      // é™çº§ä¸ºå…¨æ–‡æœç´¢
      return await _fallbackSearch(query);
    }
  }
}
```

#### 16.6.2 æœç´¢è‡ªå­¦ä¹ ç³»ç»Ÿ

> **ğŸ“š æ¨¡å—åŒ–è®¾è®¡è¯´æ˜**
>
> æœç´¢çš„è‡ªå­¦ä¹ èƒ½åŠ›åŸºäº**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**æä¾›çš„ç»Ÿä¸€æ¡†æ¶å®ç°ã€‚

##### 16.6.2.1 æœç´¢æ„å›¾å­¦ä¹ 

```dart
/// æœç´¢å­¦ä¹ æœåŠ¡
class SearchLearningService extends BaseLearningService<
    String, SearchIntent, SearchLearningSample> {

  /// å­¦ä¹ ç”¨æˆ·æœç´¢ä¹ æƒ¯
  Future<UserSearchPreferences> learnSearchPreferences(String userId) async {
    final samples = await _sampleStore.getUserSamples(userId);

    return UserSearchPreferences(
      // ç”¨æˆ·å¸¸ç”¨æœç´¢è¯ â†’ æ„å›¾æ˜ å°„
      queryIntentMappings: _buildQueryIntentMappings(samples),
      // ç”¨æˆ·åå¥½çš„æ—¶é—´èŒƒå›´
      preferredTimeRange: _inferPreferredTimeRange(samples),
      // ç”¨æˆ·åå¥½çš„æ’åºæ–¹å¼
      preferredSorting: _inferPreferredSorting(samples),
      // ç”¨æˆ·çš„åŒä¹‰è¯ä¹ æƒ¯
      synonymMappings: _buildSynonymMappings(samples),
    );
  }

  /// æ„å»ºæŸ¥è¯¢-æ„å›¾æ˜ å°„
  Map<String, SearchIntent> _buildQueryIntentMappings(
    List<SearchLearningSample> samples,
  ) {
    final mappings = <String, Map<SearchIntent, int>>{};

    for (final sample in samples) {
      if (sample.clickedResult != null) {
        final query = sample.input.toLowerCase();
        mappings[query] ??= {};
        final intent = sample.clickedResult!.intent;
        mappings[query]![intent] = (mappings[query]![intent] ?? 0) + 1;
      }
    }

    // é€‰æ‹©æ¯ä¸ªæŸ¥è¯¢æœ€å¸¸ç‚¹å‡»çš„æ„å›¾
    return mappings.map((query, votes) {
      final topIntent = votes.entries
          .reduce((a, b) => a.value > b.value ? a : b)
          .key;
      return MapEntry(query, topIntent);
    });
  }

  @override
  Future<PredictionResult<SearchIntent>> fallbackPredict(String input) async {
    // LLMç†è§£å¤æ‚æŸ¥è¯¢
    return await _llmService.parseSearchIntent(input);
  }
}

/// æœç´¢æ„å›¾é¢„æµ‹å¢å¼º
class EnhancedSearchIntentPredictor {

  Future<SearchIntent> predict(String query, String userId) async {
    final prefs = await _learningService.learnSearchPreferences(userId);

    // 1. æ£€æŸ¥ä¸ªæ€§åŒ–æ˜ å°„
    final personalIntent = prefs.queryIntentMappings[query.toLowerCase()];
    if (personalIntent != null) {
      return personalIntent.copyWith(
        confidence: 0.95,
        source: IntentSource.learned,
      );
    }

    // 2. åŒä¹‰è¯æ›¿æ¢åå†æŸ¥
    final normalizedQuery = _applySynonyms(query, prefs.synonymMappings);
    final synonymIntent = prefs.queryIntentMappings[normalizedQuery];
    if (synonymIntent != null) {
      return synonymIntent.copyWith(
        confidence: 0.9,
        source: IntentSource.learned,
      );
    }

    // 3. è§„åˆ™åŒ¹é… â†’ LLMå…œåº•
    return await _baseLearningService.predict(query);
  }
}
```

##### 16.6.2.2 å¤šç”¨æˆ·ååŒæœç´¢å­¦ä¹ 

```dart
/// æœç´¢ååŒå­¦ä¹ æœåŠ¡
class SearchCollaborativeLearningService {

  /// ä¸ŠæŠ¥æœç´¢æ¨¡å¼
  Future<void> reportSearchPattern(SearchLearningSample sample) async {
    if (sample.clickedResult == null) return;

    final pattern = SanitizedSearchPattern(
      // æŸ¥è¯¢è¯ï¼ˆå·²è„±æ•ï¼Œç§»é™¤å…·ä½“é‡‘é¢/æ—¥æœŸï¼‰
      normalizedQuery: _normalizeQuery(sample.input),
      // ç‚¹å‡»çš„æ„å›¾ç±»å‹
      clickedIntent: sample.clickedResult!.intent,
      // ç‚¹å‡»ä½ç½®
      clickPosition: sample.clickPosition,
      userHash: _hashUserId(sample.userId),
    );

    await _reporter.report(pattern);
  }

  /// æŸ¥è¯¢è„±æ•
  String _normalizeQuery(String query) {
    // "ä¸Šä¸ªæœˆå’–å•¡èŠ±äº†å¤šå°‘" â†’ "{time}å’–å•¡èŠ±äº†å¤šå°‘"
    // "1æœˆ15æ—¥ä¹°ä¹¦" â†’ "{date}ä¹°ä¹¦"
    return query
        .replaceAll(RegExp(r'\d+æœˆ\d+æ—¥?'), '{date}')
        .replaceAll(RegExp(r'ä¸Šä¸ª?æœˆ|è¿™ä¸ª?æœˆ|æœ¬æœˆ'), '{time}')
        .replaceAll(RegExp(r'\d+(\.\d+)?å…ƒ?'), '{amount}');
  }
}

/// å…¨å±€æœç´¢æ„å›¾èšåˆ
class GlobalSearchIntentAggregator {

  /// å‘ç°çƒ­é—¨æŸ¥è¯¢æ¨¡å¼
  Future<List<HotSearchPattern>> discoverHotPatterns() async {
    final patterns = await _db.getAllSearchPatterns();

    // èšåˆé«˜é¢‘æŸ¥è¯¢æ¨¡å¼
    final grouped = _groupByNormalizedQuery(patterns);

    return grouped.entries
        .where((e) => e.value.length >= 20)  // è‡³å°‘20æ¬¡
        .map((e) => HotSearchPattern(
          queryPattern: e.key,
          dominantIntent: _getMostClickedIntent(e.value),
          frequency: e.value.length,
        ))
        .toList();
  }

  /// ä¸ºæ–°ç”¨æˆ·é¢„åŠ è½½çƒ­é—¨æœç´¢æ˜ å°„
  Future<Map<String, SearchIntent>> getHotSearchMappings() async {
    final hotPatterns = await discoverHotPatterns();
    return Map.fromEntries(
      hotPatterns.map((p) => MapEntry(p.queryPattern, p.dominantIntent))
    );
  }
}
```

##### 16.6.2.3 æœç´¢å­¦ä¹ æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | åŸºçº¿ | è‡ªå­¦ä¹ å | +ååŒå­¦ä¹  |
|------|------|----------|-----------|
| é¦–æ¬¡ç‚¹å‡»ç‡ | 50% | 70% | 80% |
| å¹³å‡æœç´¢æ¬¡æ•° | 2.5æ¬¡ | 1.5æ¬¡ | 1.2æ¬¡ |
| æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ | 65% | 85% | 92% |

### 16.7 å¯¹è¯å¼è®°è´¦åŠ©æ‰‹

#### 16.7.1 å¤šè½®å¯¹è¯ç®¡ç†

```dart
/// å¯¹è¯å¼è®°è´¦åŠ©æ‰‹
class ConversationalAssistant {
  final List<DialogTurn> _history = [];
  Transaction? _pendingTransaction;
  ConversationState _state = ConversationState.idle;

  /// å¤„ç†ç”¨æˆ·è¾“å…¥
  Future<AssistantResponse> processInput(String input) async {
    _history.add(DialogTurn(role: 'user', content: input));

    switch (_state) {
      case ConversationState.idle:
        return await _handleNewInput(input);

      case ConversationState.waitingAmount:
        return await _handleAmountInput(input);

      case ConversationState.waitingCategory:
        return await _handleCategoryInput(input);

      case ConversationState.waitingConfirmation:
        return await _handleConfirmation(input);
    }
  }

  /// å¤„ç†æ–°è¾“å…¥
  Future<AssistantResponse> _handleNewInput(String input) async {
    // è§£æç”¨æˆ·æ„å›¾
    final intent = await _parseIntent(input);

    switch (intent.type) {
      case IntentType.addExpense:
        return await _startAddExpense(intent);

      case IntentType.query:
        return await _handleQuery(intent);

      case IntentType.report:
        return await _generateReport(intent);

      case IntentType.unknown:
        return AssistantResponse(
          message: 'æˆ‘å¯ä»¥å¸®æ‚¨è®°è´¦ã€æŸ¥è¯¢æ¶ˆè´¹ã€ç”ŸæˆæŠ¥å‘Šã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ',
          suggestions: ['è®°ä¸€ç¬”æ¶ˆè´¹', 'æŸ¥çœ‹æœ¬æœˆæ¶ˆè´¹', 'ç”Ÿæˆæœˆåº¦æŠ¥å‘Š'],
        );
    }
  }

  /// å¼€å§‹æ·»åŠ æ¶ˆè´¹
  Future<AssistantResponse> _startAddExpense(ParsedIntent intent) async {
    _pendingTransaction = Transaction(
      id: generateId(),
      type: TransactionType.expense,
      amount: intent.amount ?? 0,
      description: intent.description,
      categoryId: intent.categoryId,
      date: intent.date ?? DateTime.now(),
    );

    // æ£€æŸ¥ç¼ºå¤±çš„å¿…è¦å­—æ®µ
    if (_pendingTransaction!.amount == 0) {
      _state = ConversationState.waitingAmount;
      return AssistantResponse(
        message: 'å¥½çš„ï¼Œè¿™ç¬”æ¶ˆè´¹æ˜¯å¤šå°‘é’±ï¼Ÿ',
        expectingType: ExpectingType.amount,
      );
    }

    if (_pendingTransaction!.categoryId == null) {
      _state = ConversationState.waitingCategory;
      final suggestions = await _suggestCategories(_pendingTransaction!);
      return AssistantResponse(
        message: 'è¯·é€‰æ‹©åˆ†ç±»ï¼š',
        suggestions: suggestions.map((s) => s.category.name).toList(),
        expectingType: ExpectingType.category,
      );
    }

    // æ‰€æœ‰ä¿¡æ¯é½å…¨ï¼Œè¯·æ±‚ç¡®è®¤
    return _requestConfirmation();
  }

  /// è¯·æ±‚ç¡®è®¤
  AssistantResponse _requestConfirmation() {
    _state = ConversationState.waitingConfirmation;
    final tx = _pendingTransaction!;

    return AssistantResponse(
      message: '''
ç¡®è®¤è®°å½•ä»¥ä¸‹æ¶ˆè´¹ï¼Ÿ
- é‡‘é¢: Â¥${tx.amount}
- åˆ†ç±»: ${tx.categoryName}
- æè¿°: ${tx.description ?? 'æ— '}
- æ—¥æœŸ: ${tx.date.format('yyyy-MM-dd')}
''',
      suggestions: ['ç¡®è®¤', 'ä¿®æ”¹é‡‘é¢', 'ä¿®æ”¹åˆ†ç±»', 'å–æ¶ˆ'],
      expectingType: ExpectingType.confirmation,
    );
  }

  /// å¤„ç†ç¡®è®¤
  Future<AssistantResponse> _handleConfirmation(String input) async {
    if (input.contains('ç¡®è®¤') || input.contains('æ˜¯') || input.contains('å¯¹')) {
      // ä¿å­˜äº¤æ˜“
      await _saveTransaction(_pendingTransaction!);
      _reset();

      return AssistantResponse(
        message: 'å·²è®°å½•ï¼è¿˜æœ‰å…¶ä»–éœ€è¦è®°å½•çš„å—ï¼Ÿ',
        suggestions: ['ç»§ç»­è®°è´¦', 'æŸ¥çœ‹ä»Šæ—¥æ¶ˆè´¹', 'ä¸ç”¨äº†'],
      );
    } else if (input.contains('å–æ¶ˆ')) {
      _reset();
      return AssistantResponse(message: 'å·²å–æ¶ˆã€‚');
    } else if (input.contains('ä¿®æ”¹é‡‘é¢')) {
      _state = ConversationState.waitingAmount;
      return AssistantResponse(message: 'è¯·è¾“å…¥æ–°çš„é‡‘é¢ï¼š');
    } else if (input.contains('ä¿®æ”¹åˆ†ç±»')) {
      _state = ConversationState.waitingCategory;
      return AssistantResponse(message: 'è¯·é€‰æ‹©æ–°çš„åˆ†ç±»ï¼š');
    }

    return AssistantResponse(message: 'è¯·å›å¤"ç¡®è®¤"æˆ–"å–æ¶ˆ"');
  }

  void _reset() {
    _pendingTransaction = null;
    _state = ConversationState.idle;
  }
}

/// å¯¹è¯çŠ¶æ€
enum ConversationState {
  idle,                 // ç©ºé—²
  waitingAmount,        // ç­‰å¾…é‡‘é¢
  waitingCategory,      // ç­‰å¾…åˆ†ç±»
  waitingConfirmation,  // ç­‰å¾…ç¡®è®¤
}
```

#### 16.7.2 å¯¹è¯åŠ©æ‰‹è‡ªå­¦ä¹ ç³»ç»Ÿ

> **ğŸ“š æ¨¡å—åŒ–è®¾è®¡è¯´æ˜**
>
> å¯¹è¯åŠ©æ‰‹çš„è‡ªå­¦ä¹ èƒ½åŠ›åŸºäº**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**æä¾›çš„ç»Ÿä¸€æ¡†æ¶å®ç°ã€‚

##### 16.7.2.1 å¯¹è¯æ„å›¾å­¦ä¹ 

```dart
/// å¯¹è¯å­¦ä¹ æœåŠ¡
class DialogueLearningService extends BaseLearningService<
    DialogueContext, DialogueIntent, DialogueLearningSample> {

  /// å­¦ä¹ å¯¹è¯æ¨¡å¼
  Future<UserDialoguePreferences> learnDialoguePreferences(String userId) async {
    final samples = await _sampleStore.getUserSamples(userId);

    return UserDialoguePreferences(
      // ç”¨æˆ·å¸¸ç”¨çš„å¯¹è¯å¼€åœºç™½ â†’ æ„å›¾
      greetingIntentMappings: _buildGreetingMappings(samples),
      // ç”¨æˆ·çš„è¡¨è¾¾ç®€æ´åº¦åå¥½
      verbosityLevel: _calculateVerbosityLevel(samples),
      // ç”¨æˆ·åå¥½çš„ç¡®è®¤æ–¹å¼
      confirmationStyle: _inferConfirmationStyle(samples),
      // å¤šè½®å¯¹è¯çš„å¹³å‡è½®æ•°
      averageTurns: _calculateAverageTurns(samples),
    );
  }

  /// å­¦ä¹ ç”¨æˆ·çš„è¡¨è¾¾ä¹ æƒ¯
  Map<String, DialogueIntent> _buildGreetingMappings(
    List<DialogueLearningSample> samples,
  ) {
    // å­¦ä¹ ç”¨æˆ·å¦‚ä½•å¼€å§‹å¯¹è¯
    // "å¸®æˆ‘è®°ä¸€ç¬”" â†’ è®°è´¦æ„å›¾
    // "æŸ¥ä¸€ä¸‹" â†’ æŸ¥è¯¢æ„å›¾
    // "çœ‹çœ‹" â†’ æµè§ˆæ„å›¾
    final mappings = <String, DialogueIntent>{};

    for (final sample in samples) {
      if (sample.isFirstTurn && sample.taskCompleted) {
        final opening = _extractOpening(sample.input.userMessage);
        mappings[opening] = sample.actualOutput ?? sample.predictedOutput;
      }
    }

    return mappings;
  }
}

/// å¯¹è¯ä»»åŠ¡å®Œæˆç‡å­¦ä¹ 
class DialogueCompletionLearner {

  /// åˆ†æå¯¹è¯å¤±è´¥åŸå› 
  Future<DialogueFailureAnalysis> analyzeFailures(String userId) async {
    final failedSamples = await _sampleStore.getFailedDialogues(userId);

    return DialogueFailureAnalysis(
      // å¸¸è§å¤±è´¥ç‚¹
      commonFailurePoints: _identifyFailurePoints(failedSamples),
      // ç”¨æˆ·æ”¾å¼ƒçš„å…¸å‹è½®æ•°
      abandonmentTurn: _calculateAbandonmentTurn(failedSamples),
      // å¯¼è‡´å¤±è´¥çš„æ„å›¾ç±»å‹
      problematicIntents: _identifyProblematicIntents(failedSamples),
    );
  }

  /// ä¼˜åŒ–å¯¹è¯ç­–ç•¥
  Future<void> optimizeDialogueStrategy(String userId) async {
    final analysis = await analyzeFailures(userId);

    // é’ˆå¯¹å¤±è´¥ç‚¹è°ƒæ•´å¯¹è¯ç­–ç•¥
    for (final failurePoint in analysis.commonFailurePoints) {
      await _adjustStrategy(userId, failurePoint);
    }
  }
}
```

##### 16.7.2.2 å¤šç”¨æˆ·ååŒå¯¹è¯å­¦ä¹ 

```dart
/// å¯¹è¯ååŒå­¦ä¹ æœåŠ¡
class DialogueCollaborativeLearningService {

  /// ä¸ŠæŠ¥æˆåŠŸçš„å¯¹è¯æ¨¡å¼
  Future<void> reportSuccessfulDialogue(DialogueLearningSample sample) async {
    if (!sample.taskCompleted) return;

    final pattern = SanitizedDialoguePattern(
      // å¯¹è¯è½®æ•°
      turns: sample.dialogueTurns,
      // æ„å›¾åºåˆ—
      intentSequence: sample.intentSequence,
      // ä»»åŠ¡ç±»å‹
      taskType: sample.taskType,
      // æˆåŠŸæ ‡è®°
      success: true,
      userHash: _hashUserId(sample.userId),
    );

    await _reporter.report(pattern);
  }
}

/// å…¨å±€å¯¹è¯æ¨¡å¼èšåˆ
class GlobalDialoguePatternAggregator {

  /// å‘ç°æœ€ä½³å¯¹è¯è·¯å¾„
  Future<List<OptimalDialoguePath>> discoverOptimalPaths() async {
    final patterns = await _db.getSuccessfulDialoguePatterns();

    // æŒ‰ä»»åŠ¡ç±»å‹åˆ†ç»„ï¼Œæ‰¾å‡ºæˆåŠŸç‡æœ€é«˜çš„å¯¹è¯è·¯å¾„
    final byTask = _groupByTaskType(patterns);

    return byTask.entries.map((e) {
      final successPatterns = e.value.where((p) => p.success).toList();
      final optimalSequence = _findMostCommonSequence(successPatterns);

      return OptimalDialoguePath(
        taskType: e.key,
        intentSequence: optimalSequence,
        averageTurns: _calculateAverageTurns(successPatterns),
        successRate: successPatterns.length / e.value.length,
      );
    }).toList();
  }
}
```

##### 16.7.2.3 å¯¹è¯å­¦ä¹ æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | åŸºçº¿ | è‡ªå­¦ä¹ å | +ååŒå­¦ä¹  |
|------|------|----------|-----------|
| ä»»åŠ¡å®Œæˆç‡ | 60% | 75% | 85% |
| å¹³å‡å¯¹è¯è½®æ•° | 4è½® | 3è½® | 2.5è½® |
| ç”¨æˆ·æ»¡æ„åº¦ | 65% | 80% | 88% |

### 16.8 æ™ºèƒ½èµ„é‡‘åˆ†é…

#### 16.8.1 å°é‡‘åº“è‡ªåŠ¨åˆ†é…ç®—æ³•

```dart
/// æ™ºèƒ½èµ„é‡‘åˆ†é…æœåŠ¡
class SmartAllocationService {
  final VaultRepository _vaultRepository;
  final TransactionRepository _transactionRepo;

  /// ç”Ÿæˆåˆ†é…å»ºè®®ï¼ˆè§„åˆ™å¼•æ“ï¼‰
  Future<List<AllocationSuggestion>> generateSuggestions() async {
    final unallocated = await getUnallocatedAmount();
    if (unallocated <= 0) return [];

    final vaults = await _vaultRepository.getActiveVaults();
    final suggestions = <AllocationSuggestion>[];
    var remaining = unallocated;

    // ========== ä¼˜å…ˆçº§1: å›ºå®šæ”¯å‡ºï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.fixed)) {
      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'å›ºå®šæ”¯å‡ºéœ€ä¼˜å…ˆä¿éšœ',
          priority: 1,
          isRequired: true,
        ));
        remaining -= allocate;
      }
    }

    // ========== ä¼˜å…ˆçº§2: å€ºåŠ¡è¿˜æ¬¾ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.debt)) {
      if (remaining <= 0) break;

      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'æŒ‰æ—¶è¿˜æ¬¾é¿å…åˆ©æ¯å’Œä¿¡ç”¨å½±å“',
          priority: 2,
          isRequired: true,
        ));
        remaining -= allocate;
      }
    }

    // ========== ä¼˜å…ˆçº§3: åº”æ€¥å‚¨è“„ï¼ˆè‡³å°‘åˆ†é…20%ï¼‰ ==========
    final emergencyVault = vaults.firstWhereOrNull(
      (v) => v.type == VaultType.savings && v.name.contains('åº”æ€¥'),
    );
    if (emergencyVault != null && remaining > 0) {
      final emergencyAlloc = min(
        emergencyVault.targetAmount - emergencyVault.allocatedAmount,
        remaining * 0.2,  // è‡³å°‘åˆ†é…å‰©ä½™çš„20%
      );
      if (emergencyAlloc > 0) {
        suggestions.add(AllocationSuggestion(
          vaultId: emergencyVault.id,
          vaultName: emergencyVault.name,
          suggestedAmount: emergencyAlloc,
          reason: 'åº”æ€¥å‚¨è“„æ˜¯è´¢åŠ¡å®‰å…¨çš„åŸºç¡€',
          priority: 3,
          isRequired: false,
        ));
        remaining -= emergencyAlloc;
      }
    }

    // ========== ä¼˜å…ˆçº§4: å‚¨è“„ç›®æ ‡ï¼ˆæŒ‰å®Œæˆåº¦å’Œæˆªæ­¢æ—¥æœŸæ’åºï¼‰ ==========
    final savingsVaults = vaults
        .where((v) => v.type == VaultType.savings && v.id != emergencyVault?.id)
        .toList()
      ..sort((a, b) {
        // ä¼˜å…ˆå¡«å……æ¥è¿‘æˆªæ­¢æ—¥æœŸçš„
        if (a.dueDate != null && b.dueDate != null) {
          return a.dueDate!.compareTo(b.dueDate!);
        }
        // å…¶æ¬¡æŒ‰å®Œæˆåº¦å‡åºï¼ˆå®Œæˆåº¦ä½çš„ä¼˜å…ˆï¼‰
        return a.progress.compareTo(b.progress);
      });

    for (final vault in savingsVaults) {
      if (remaining <= 0) break;

      final needed = vault.targetAmount - vault.allocatedAmount;
      if (needed > 0) {
        // æ ¹æ®ç´§è¿«ç¨‹åº¦å†³å®šåˆ†é…æ¯”ä¾‹
        double ratio = 0.15;  // é»˜è®¤åˆ†é…å‰©ä½™çš„15%
        if (vault.dueDate != null) {
          final daysLeft = vault.dueDate!.difference(DateTime.now()).inDays;
          if (daysLeft < 30) ratio = 0.3;
          else if (daysLeft < 90) ratio = 0.2;
        }

        final allocate = min(needed, remaining * ratio);
        if (allocate > 0) {
          suggestions.add(AllocationSuggestion(
            vaultId: vault.id,
            vaultName: vault.name,
            suggestedAmount: allocate,
            reason: _getSavingsReason(vault),
            priority: 4,
            isRequired: false,
          ));
          remaining -= allocate;
        }
      }
    }

    // ========== ä¼˜å…ˆçº§5: å¼¹æ€§æ”¯å‡ºï¼ˆåŸºäºå†å²ä½¿ç”¨ç‡ï¼‰ ==========
    for (final vault in vaults.where((v) => v.type == VaultType.flexible)) {
      if (remaining <= 0) break;

      final historicalUsage = await _getHistoricalUsageRate(vault.id);
      final suggested = vault.targetAmount * historicalUsage;
      final needed = max(0, suggested - vault.allocatedAmount);

      if (needed > 0) {
        final allocate = min(needed, remaining);
        suggestions.add(AllocationSuggestion(
          vaultId: vault.id,
          vaultName: vault.name,
          suggestedAmount: allocate,
          reason: 'åŸºäºå†å²ä½¿ç”¨ç‡å»ºè®®',
          priority: 5,
          isRequired: false,
        ));
        remaining -= allocate;
      }
    }

    return suggestions;
  }

  /// è·å–å‚¨è“„åŸå› 
  String _getSavingsReason(BudgetVault vault) {
    if (vault.dueDate != null) {
      final daysLeft = vault.dueDate!.difference(DateTime.now()).inDays;
      if (daysLeft < 30) return 'ç›®æ ‡æ—¥æœŸä¸´è¿‘ï¼Œè¿˜å·®${(vault.targetAmount - vault.allocatedAmount).toStringAsFixed(0)}å…ƒ';
      return 'è·ç¦»ç›®æ ‡è¿˜æœ‰$daysLeftå¤©';
    }
    return 'å‚¨è“„è¿›åº¦${(vault.progress * 100).toStringAsFixed(0)}%';
  }

  /// è·å–å†å²ä½¿ç”¨ç‡
  Future<double> _getHistoricalUsageRate(String vaultId) async {
    // æŸ¥è¯¢è¿‡å»3ä¸ªæœˆè¯¥å°é‡‘åº“çš„ä½¿ç”¨æƒ…å†µ
    final history = await _vaultRepository.getHistoricalUsage(vaultId, months: 3);
    if (history.isEmpty) return 0.8;  // é»˜è®¤80%

    final avgUsage = history.map((h) => h.usageRate).reduce((a, b) => a + b) / history.length;
    return avgUsage.clamp(0.5, 1.0);
  }
}
```

### 16.9 æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½åŒ–æŠ€æœ¯é€‰æ‹©å†³ç­–æ ‘                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  éœ€æ±‚åœºæ™¯                                                              â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ è§„åˆ™æ˜ç¡®ã€é€»è¾‘å›ºå®šï¼Ÿ                                           â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ æ˜¯ â†’ ã€è§„åˆ™å¼•æ“ã€‘                                      â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šåˆ†è´¦è§„åˆ™ã€é¢„ç®—åˆ†é…ã€å¼‚å¸¸é˜ˆå€¼                â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¦ â†“                                                   â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ éœ€è¦ç¦»çº¿è¿è¡Œï¼Ÿ                                                 â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ æ˜¯ â†’ ã€æœ¬åœ°ML/è§„åˆ™ã€‘                                   â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šæœ¬åœ°åˆ†ç±»ã€ç®€å•é¢„æµ‹                          â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¦ â†“                                                   â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ æ¶‰åŠè‡ªç„¶è¯­è¨€ç†è§£ï¼Ÿ                                             â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ ç®€å•æ¨¡å¼ â†’ ã€æ­£åˆ™+å…³é”®è¯ã€‘                             â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šæ—¶é—´è§£æã€é‡‘é¢æå–                          â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¤æ‚è¯­ä¹‰ â†’ ã€å¤§æ¨¡å‹APIã€‘                               â”‚
â”‚      â”‚               ä¾‹å¦‚ï¼šå¯¹è¯ç†è§£ã€æŠ¥å‘Šç”Ÿæˆ                          â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€ æ¶‰åŠæ•°å€¼é¢„æµ‹ï¼Ÿ                                                 â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â”œâ”€ ç®€å•è¶‹åŠ¿ â†’ ã€ç»Ÿè®¡æ–¹æ³•ã€‘                                â”‚
â”‚      â”‚       â”‚       ä¾‹å¦‚ï¼šç§»åŠ¨å¹³å‡ã€å›å½’                              â”‚
â”‚      â”‚       â”‚                                                         â”‚
â”‚      â”‚       â””â”€ å¤æ‚æ¨¡å¼ â†’ ã€æ—¶é—´åºåˆ—æ¨¡å‹ã€‘                            â”‚
â”‚      â”‚               ä¾‹å¦‚ï¼šProphetã€ARIMA                              â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â””â”€ æ¶‰åŠåˆ†ç±»/èšç±»ï¼Ÿ                                                â”‚
â”‚              â”‚                                                         â”‚
â”‚              â”œâ”€ æœ‰å†å²æ•°æ® â†’ ã€æœ¬åœ°MLã€‘                                â”‚
â”‚              â”‚       ä¾‹å¦‚ï¼šäº¤æ˜“åˆ†ç±»å™¨ã€å¼‚å¸¸æ£€æµ‹                        â”‚
â”‚              â”‚                                                         â”‚
â”‚              â””â”€ å†·å¯åŠ¨/å¤æ‚ â†’ ã€å¤§æ¨¡å‹ã€‘                               â”‚
â”‚                      ä¾‹å¦‚ï¼šé¦–æ¬¡åˆ†ç±»ã€è¯­ä¹‰ç†è§£                          â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 16.10 æˆæœ¬ä¸æ€§èƒ½ä¼˜åŒ–

#### 16.10.1 å¤§æ¨¡å‹è°ƒç”¨ä¼˜åŒ–ç­–ç•¥

```dart
/// å¤§æ¨¡å‹è°ƒç”¨ç®¡ç†å™¨
class LLMCallManager {
  final Cache _cache;
  final RateLimiter _rateLimiter;
  int _dailyCallCount = 0;
  static const int _dailyLimit = 1000;  // æ¯æ—¥é™é¢

  /// æ™ºèƒ½è°ƒç”¨ï¼ˆå¸¦ç¼“å­˜å’Œé™çº§ï¼‰
  Future<String?> smartCall({
    required String prompt,
    required String cacheKey,
    Duration cacheDuration = const Duration(hours: 24),
    bool allowCache = true,
  }) async {
    // 1. æ£€æŸ¥ç¼“å­˜
    if (allowCache) {
      final cached = await _cache.get(cacheKey);
      if (cached != null) return cached;
    }

    // 2. æ£€æŸ¥é™é¢
    if (_dailyCallCount >= _dailyLimit) {
      debugPrint('Daily LLM limit reached, falling back to local');
      return null;  // è¿”å›nullè®©è°ƒç”¨æ–¹é™çº§å¤„ç†
    }

    // 3. æ£€æŸ¥é¢‘ç‡é™åˆ¶
    if (!await _rateLimiter.tryAcquire()) {
      await Future.delayed(Duration(milliseconds: 100));
      if (!await _rateLimiter.tryAcquire()) {
        return null;
      }
    }

    // 4. å®é™…è°ƒç”¨
    try {
      final result = await _qwenService.chat(prompt);
      _dailyCallCount++;

      // 5. ç¼“å­˜ç»“æœ
      if (allowCache && result.isNotEmpty) {
        await _cache.set(cacheKey, result, cacheDuration);
      }

      return result;
    } catch (e) {
      debugPrint('LLM call failed: $e');
      return null;
    }
  }

  /// æ‰¹é‡è°ƒç”¨ä¼˜åŒ–
  Future<List<String?>> batchCall(List<String> prompts) async {
    // åˆå¹¶å¤šä¸ªç®€å•è¯·æ±‚ä¸ºä¸€ä¸ª
    if (prompts.length <= 3) {
      return Future.wait(prompts.map((p) => smartCall(
        prompt: p,
        cacheKey: p.hashCode.toString(),
      )));
    }

    // å¤§é‡è¯·æ±‚æ—¶åˆå¹¶
    final combinedPrompt = '''
è¯·ä¾æ¬¡å›ç­”ä»¥ä¸‹${prompts.length}ä¸ªé—®é¢˜ï¼Œç”¨JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š
${prompts.asMap().entries.map((e) => '${e.key + 1}. ${e.value}').join('\n')}
''';

    final result = await smartCall(
      prompt: combinedPrompt,
      cacheKey: prompts.join('').hashCode.toString(),
    );

    if (result == null) return List.filled(prompts.length, null);

    try {
      final answers = jsonDecode(result) as List;
      return answers.map((a) => a.toString()).toList();
    } catch (e) {
      return List.filled(prompts.length, null);
    }
  }
}
```

#### 16.10.2 æˆæœ¬ç›‘æ§

```dart
/// AIæˆæœ¬ç›‘æ§æœåŠ¡
class AICostMonitor {
  final Map<String, int> _callCounts = {};
  final Map<String, int> _tokenUsage = {};

  /// è®°å½•è°ƒç”¨
  void recordCall(String service, int tokens) {
    _callCounts[service] = (_callCounts[service] ?? 0) + 1;
    _tokenUsage[service] = (_tokenUsage[service] ?? 0) + tokens;
  }

  /// è·å–æ—¥æŠ¥
  CostReport getDailyReport() {
    return CostReport(
      date: DateTime.now(),
      callsByService: Map.from(_callCounts),
      tokensByService: Map.from(_tokenUsage),
      estimatedCost: _calculateCost(),
    );
  }

  double _calculateCost() {
    // æŒ‰æœåŠ¡è®¡ç®—æˆæœ¬ï¼ˆç¤ºä¾‹ä»·æ ¼ï¼‰
    double cost = 0;

    // é€šä¹‰åƒé—®ï¼šçº¦0.008å…ƒ/åƒtokens
    cost += (_tokenUsage['qwen'] ?? 0) / 1000 * 0.008;

    // æ™ºè°±AIï¼šçº¦0.005å…ƒ/åƒtokens
    cost += (_tokenUsage['zhipu'] ?? 0) / 1000 * 0.005;

    return cost;
  }
}
```

### 16.11 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 16.11.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ - ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚   æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ       â”‚                              â”‚
â”‚                          â”‚  SmartAIService       â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                      â”‚                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚             â”‚           â”‚               â”‚           â”‚             â”‚       â”‚
â”‚    â–¼             â–¼           â–¼               â–¼           â–¼             â–¼       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚äº¤æ˜“ç³»ç»Ÿâ”‚  â”‚é¢„ç®—ç³»ç»Ÿâ”‚  â”‚é›¶åŸºé¢„ç®—   â”‚  â”‚ é’±é¾„ç³»ç»Ÿ  â”‚  â”‚ä¹ æƒ¯åŸ¹å…»â”‚  â”‚æ•°æ®å¯¼å…¥   â”‚  â”‚
â”‚ â”‚ (6ç« ) â”‚  â”‚ (8ç« ) â”‚  â”‚  (8ç« )   â”‚  â”‚  (7ç« )   â”‚  â”‚ (9ç« ) â”‚  â”‚  (11ç« )  â”‚  â”‚
â”‚ â”‚æ™ºèƒ½åˆ†ç±»â”‚  â”‚é¢„ç®—å»ºè®®â”‚  â”‚æ™ºèƒ½åˆ†é…   â”‚  â”‚è¶‹åŠ¿é¢„æµ‹   â”‚  â”‚è¡Œä¸ºé¢„æµ‹â”‚  â”‚æ™ºèƒ½è§£æ   â”‚  â”‚
â”‚ â”‚å¼‚å¸¸æ£€æµ‹â”‚  â”‚è¶…æ”¯é¢„è­¦â”‚  â”‚ä¼˜åŒ–å»ºè®®   â”‚  â”‚ç»“æ„æ´å¯Ÿ   â”‚  â”‚æ—¶æœºæ¨èâ”‚  â”‚åˆ†ç±»å»ºè®®   â”‚  â”‚
â”‚ â”‚è¯­éŸ³è®°è´¦â”‚  â”‚å‘¨æœŸåˆ†æâ”‚  â”‚åœºæ™¯è¯†åˆ«   â”‚  â”‚å¼‚å¸¸æ£€æµ‹   â”‚  â”‚é¼“åŠ±ç”Ÿæˆâ”‚  â”‚å»é‡è¯†åˆ«   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                              2.0æ–°å¢AIé›†æˆ                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ å®¶åº­è´¦æœ¬  â”‚  â”‚ è¯­éŸ³äº¤äº’  â”‚  â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ â”‚  â”‚ ä½ç½®æ™ºèƒ½  â”‚  â”‚ ä¼™ä¼´åŒ–    â”‚     â”‚
â”‚ â”‚  (13ç« )  â”‚  â”‚  (18ç« )  â”‚  â”‚  (17ç« )  â”‚  â”‚  (14ç« )  â”‚  â”‚  (4ç« )   â”‚     â”‚
â”‚ â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚     â”‚
â”‚ â”‚ å®¶åº­æ¶ˆè´¹  â”‚  â”‚ æ„å›¾ç†è§£  â”‚  â”‚ ä¸ªæ€§åŒ–æ¨¡å‹ â”‚  â”‚ åœºæ™¯è¯†åˆ«  â”‚  â”‚ æƒ…æ„Ÿåˆ†æ  â”‚     â”‚
â”‚ â”‚ æ¨¡å¼åˆ†æ  â”‚  â”‚ å¤šè½®å¯¹è¯  â”‚  â”‚ ååŒå­¦ä¹   â”‚  â”‚ POIåˆ†ç±»  â”‚  â”‚ æ–‡æ¡ˆç”Ÿæˆ  â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚             åé¦ˆå­¦ä¹ å¼•æ“                      â”‚                   â”‚
â”‚              â”‚  ç”¨æˆ·ä¿®æ­£ â†’ è§„åˆ™æ²‰æ·€ â†’ ç²¾åº¦æå‡ â†’ æˆæœ¬é™ä½   â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 16.11.1 é›†æˆè§¦å‘ç‚¹

| é›†æˆæ¨¡å— | è§¦å‘åœºæ™¯ | æ™ºèƒ½èƒ½åŠ› | è¾“å‡ºç»“æœ |
|---------|---------|---------|---------|
| **äº¤æ˜“ç³»ç»Ÿ** | æ–°å»ºäº¤æ˜“ã€è¯­éŸ³è®°è´¦ | æ™ºèƒ½åˆ†ç±»ã€å®ä½“æå– | åˆ†ç±»å»ºè®®ã€é‡‘é¢/å•†å®¶/æ—¶é—´ |
| **äº¤æ˜“ç³»ç»Ÿ** | äº¤æ˜“ä¿å­˜å | å¼‚å¸¸æ£€æµ‹ | å¼‚å¸¸æ ‡è®°ã€å¼‚å¸¸åŸå›  |
| **é¢„ç®—ç³»ç»Ÿ** | æœˆåˆé¢„ç®—è§„åˆ’ | æ™ºèƒ½é¢„ç®—å»ºè®® | å„åˆ†ç±»å»ºè®®é‡‘é¢ |
| **é¢„ç®—ç³»ç»Ÿ** | é¢„ç®—å³å°†è¶…æ”¯ | è‡ªç„¶è¯­è¨€ç”Ÿæˆ | ä¸ªæ€§åŒ–é¢„è­¦æ–‡æ¡ˆ |
| **é›¶åŸºé¢„ç®—** | æ”¶å…¥åˆ†é… | æ™ºèƒ½åˆ†é…å»ºè®® | å„å°é‡‘åº“å»ºè®®æ¯”ä¾‹ |
| **é’±é¾„ç³»ç»Ÿ** | å‘¨æœŸç»“ç®— | è¶‹åŠ¿é¢„æµ‹ | ä¸‹æœˆæ¶ˆè´¹é¢„æµ‹ |
| **é’±é¾„ç³»ç»Ÿ** | èµ„é‡‘ç»“æ„åˆ†æ | æ´å¯Ÿç”Ÿæˆ | ç»“æ„å¥åº·åº¦è¯„ä¼° |
| **ä¹ æƒ¯åŸ¹å…»** | è¡Œä¸ºè®°å½• | è¡Œä¸ºé¢„æµ‹ | åšæŒæ¦‚ç‡ã€æœ€ä½³æ—¶æœº |
| **ä¹ æƒ¯åŸ¹å…»** | é¼“åŠ±æ—¶æœº | æ–‡æ¡ˆç”Ÿæˆ | ä¸ªæ€§åŒ–é¼“åŠ±è¯­ |
| **æ•°æ®å¯¼å…¥** | è´¦å•å¯¼å…¥ | æ™ºèƒ½è§£æã€åˆ†ç±» | ç»“æ„åŒ–äº¤æ˜“æ•°æ® |
| **æ•°æ®å¯¼å…¥** | æ‰¹é‡å¯¼å…¥ | å»é‡è¯†åˆ« | é‡å¤äº¤æ˜“æ ‡è®° |

#### 16.11.2 ä¸äº¤æ˜“ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½åˆ†ç±»ä¸äº¤æ˜“ç³»ç»Ÿé›†æˆ
class TransactionAIIntegration {
  final SmartCategoryService _categoryService;
  final AnomalyDetectionService _anomalyService;
  final TransactionRepository _transactionRepo;

  /// äº¤æ˜“åˆ›å»ºæ—¶çš„æ™ºèƒ½å¤„ç†
  Future<TransactionWithAI> processNewTransaction(
    TransactionInput input,
  ) async {
    // 1. æ™ºèƒ½åˆ†ç±»ï¼ˆå››å±‚ç­–ç•¥ï¼‰
    final categoryResult = await _categoryService.classifyTransaction(
      description: input.description,
      merchantName: input.merchantName,
      amount: input.amount,
    );

    // 2. å¼‚å¸¸æ£€æµ‹
    final anomalyResult = await _anomalyService.detectAnomaly(
      categoryId: categoryResult.categoryId,
      amount: input.amount,
      timestamp: input.timestamp,
    );

    // 3. æ„å»ºå¸¦AIæ ‡æ³¨çš„äº¤æ˜“
    return TransactionWithAI(
      transaction: input.toTransaction(
        categoryId: categoryResult.categoryId,
      ),
      aiMetadata: AIMetadata(
        classificationSource: categoryResult.source, // å•†å®¶æ˜ å°„/å…³é”®è¯/ML/LLM
        classificationConfidence: categoryResult.confidence,
        isAnomaly: anomalyResult.isAnomaly,
        anomalyReason: anomalyResult.reason,
        anomalyScore: anomalyResult.score,
      ),
    );
  }

  /// ç”¨æˆ·ä¿®æ­£åˆ†ç±»æ—¶çš„åé¦ˆå­¦ä¹ 
  Future<void> onUserCorrection({
    required String transactionId,
    required String merchantName,
    required String description,
    required String originalCategoryId,
    required String correctedCategoryId,
  }) async {
    // è®°å½•ä¿®æ­£ï¼Œæ›´æ–°å•†å®¶æ˜ å°„è§„åˆ™
    await _categoryService.learnFromCorrection(
      merchantName: merchantName,
      description: description,
      fromCategory: originalCategoryId,
      toCategory: correctedCategoryId,
    );

    // ç»Ÿè®¡å‡†ç¡®ç‡
    await _logClassificationFeedback(
      source: 'user_correction',
      wasCorrect: false,
      originalCategory: originalCategoryId,
      correctCategory: correctedCategoryId,
    );
  }
}
```

#### 16.11.3 ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½é¢„ç®—ä¸é¢„ç®—ç³»ç»Ÿé›†æˆ
class BudgetAIIntegration {
  final SmartBudgetService _budgetAI;
  final PredictionService _predictionService;
  final NotificationService _notificationService;

  /// ç”Ÿæˆæœˆåº¦æ™ºèƒ½é¢„ç®—å»ºè®®
  Future<BudgetSuggestions> generateMonthlySuggestions({
    required String userId,
    required int year,
    required int month,
  }) async {
    // 1. è·å–å†å²æ¶ˆè´¹æ•°æ®
    final history = await _getHistoricalSpending(userId, months: 6);

    // 2. é¢„æµ‹ä¸‹æœˆæ¶ˆè´¹è¶‹åŠ¿
    final predictions = await _predictionService.predictMonthlySpending(
      history: history,
      targetMonth: DateTime(year, month),
    );

    // 3. ç”Ÿæˆé¢„ç®—å»ºè®®
    final suggestions = await _budgetAI.generateSuggestions(
      historicalData: history,
      predictions: predictions,
      userPreferences: await _getUserBudgetPreferences(userId),
    );

    return suggestions;
  }

  /// é¢„ç®—é¢„è­¦çš„æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆ
  Future<String> generateBudgetWarningMessage({
    required BudgetStatus status,
    required String categoryName,
    required double usageRate,
    required double remainingAmount,
    required int remainingDays,
  }) async {
    // æ ¹æ®æƒ…å†µç”Ÿæˆä¸ªæ€§åŒ–é¢„è­¦
    if (usageRate > 0.9) {
      return await _generateUrgentWarning(
        categoryName: categoryName,
        remainingAmount: remainingAmount,
        remainingDays: remainingDays,
      );
    } else if (usageRate > 0.7) {
      return await _generateCautionWarning(
        categoryName: categoryName,
        usageRate: usageRate,
        dailyBudget: remainingAmount / remainingDays,
      );
    }

    return '${categoryName}é¢„ç®—ä½¿ç”¨æ­£å¸¸ï¼Œç»§ç»­ä¿æŒï¼';
  }

  Future<String> _generateUrgentWarning({
    required String categoryName,
    required double remainingAmount,
    required int remainingDays,
  }) async {
    final dailyLimit = remainingAmount / remainingDays;
    return 'âš ï¸ ${categoryName}é¢„ç®—å‘Šæ€¥ï¼å‰©ä½™Â¥${remainingAmount.toStringAsFixed(0)}ï¼Œ'
           'æ¥ä¸‹æ¥$remainingDayså¤©æ¯å¤©æ§åˆ¶åœ¨Â¥${dailyLimit.toStringAsFixed(0)}ä»¥å†…';
  }
}
```

#### 16.11.4 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½åˆ†æä¸é’±é¾„ç³»ç»Ÿé›†æˆ
class MoneyAgeAIIntegration {
  final PredictionService _predictionService;
  final InsightGeneratorService _insightService;

  /// ç”Ÿæˆé’±é¾„è¶‹åŠ¿é¢„æµ‹
  Future<MoneyAgeForecast> forecastMoneyAge({
    required List<MoneyAgeSnapshot> historicalSnapshots,
    required int forecastDays,
  }) async {
    // åŸºäºå†å²é’±é¾„å˜åŒ–é¢„æµ‹æœªæ¥è¶‹åŠ¿
    final avgAges = historicalSnapshots.map((s) => s.averageAge).toList();
    final predictions = await _predictionService.predictTimeSeries(
      data: avgAges,
      forecastPoints: forecastDays,
    );

    return MoneyAgeForecast(
      predictedAges: predictions,
      trend: _analyzeTrend(predictions),
      healthIndicator: _calculateHealthIndicator(predictions),
    );
  }

  /// ç”Ÿæˆèµ„é‡‘ç»“æ„æ´å¯Ÿ
  Future<List<MoneyAgeInsight>> generateStructureInsights({
    required MoneyAgeStructure currentStructure,
    required MoneyAgeStructure previousStructure,
  }) async {
    final insights = <MoneyAgeInsight>[];

    // 1. æ–°é²œèµ„é‡‘å æ¯”åˆ†æ
    final freshRatio = currentStructure.freshMoneyRatio;
    final previousFreshRatio = previousStructure.freshMoneyRatio;

    if (freshRatio < 0.3 && previousFreshRatio >= 0.3) {
      insights.add(MoneyAgeInsight(
        type: InsightType.warning,
        title: 'æ–°é²œèµ„é‡‘å æ¯”ä¸‹é™',
        description: 'æœ¬æœˆæ–°èµ„é‡‘å æ¯”é™è‡³${(freshRatio * 100).toStringAsFixed(1)}%ï¼Œ'
                     'å»ºè®®æ£€æŸ¥æ”¶æ”¯å¹³è¡¡',
        actionSuggestion: 'è€ƒè™‘å¢åŠ å‚¨è“„æˆ–å‡å°‘éå¿…è¦æ”¯å‡º',
      ));
    }

    // 2. é™ˆæ—§èµ„é‡‘å æ¯”åˆ†æ
    if (currentStructure.oldMoneyRatio > 0.4) {
      insights.add(MoneyAgeInsight(
        type: InsightType.positive,
        title: 'é•¿æœŸèµ„é‡‘å‚¨å¤‡å¥åº·',
        description: 'è¶…è¿‡40%çš„èµ„é‡‘å·²æŒæœ‰30å¤©ä»¥ä¸Šï¼Œè´¢åŠ¡ç¨³å®šæ€§è‰¯å¥½',
        actionSuggestion: 'å¯è€ƒè™‘å°†éƒ¨åˆ†èµ„é‡‘è½¬ä¸ºå®šæœŸå‚¨è“„è·å–æ›´é«˜æ”¶ç›Š',
      ));
    }

    // 3. èµ„é‡‘å‘¨è½¬é€Ÿåº¦åˆ†æ
    final turnoverRate = _calculateTurnoverRate(currentStructure);
    if (turnoverRate > 0.8) {
      insights.add(MoneyAgeInsight(
        type: InsightType.warning,
        title: 'èµ„é‡‘å‘¨è½¬è¿‡å¿«',
        description: 'èµ„é‡‘å¹³å‡åœç•™æ—¶é—´è¾ƒçŸ­ï¼Œå¯èƒ½å­˜åœ¨æœˆå…‰é£é™©',
        actionSuggestion: 'å»ºè®®è®¾ç½®è‡ªåŠ¨å‚¨è“„ï¼Œæ¯æœˆå›ºå®šå­˜å…¥ä¸€å®šé‡‘é¢',
      ));
    }

    return insights;
  }

  MoneyAgeTrend _analyzeTrend(List<double> predictions) {
    if (predictions.length < 2) return MoneyAgeTrend.stable;

    final slope = (predictions.last - predictions.first) / predictions.length;
    if (slope > 1) return MoneyAgeTrend.increasing;
    if (slope < -1) return MoneyAgeTrend.decreasing;
    return MoneyAgeTrend.stable;
  }
}
```

#### 16.11.5 ä¸ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½åŒ–ä¸ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿé›†æˆ
class HabitAIIntegration {
  final PredictionService _predictionService;
  final LLMService _llmService;

  /// é¢„æµ‹ä¹ æƒ¯åšæŒæ¦‚ç‡
  Future<HabitPrediction> predictHabitSuccess({
    required Habit habit,
    required List<HabitLog> recentLogs,
  }) async {
    // åˆ†æå†å²å®Œæˆæ¨¡å¼
    final completionPattern = _analyzeCompletionPattern(recentLogs);

    // åŸºäºæ¨¡å¼é¢„æµ‹
    final prediction = await _predictionService.predictBinaryOutcome(
      features: {
        'streak_days': habit.currentStreak,
        'completion_rate': completionPattern.overallRate,
        'weekday_rate': completionPattern.weekdayRate,
        'weekend_rate': completionPattern.weekendRate,
        'recent_trend': completionPattern.recentTrend,
      },
    );

    return HabitPrediction(
      successProbability: prediction.probability,
      bestTimeSlot: _findBestTimeSlot(recentLogs),
      riskFactors: _identifyRiskFactors(completionPattern),
      suggestions: await _generateSuggestions(habit, completionPattern),
    );
  }

  /// ç”Ÿæˆä¸ªæ€§åŒ–é¼“åŠ±è¯­
  Future<String> generateEncouragement({
    required Habit habit,
    required int currentStreak,
    required EncouragementContext context,
  }) async {
    // æ ¹æ®ä¸Šä¸‹æ–‡é€‰æ‹©é¼“åŠ±ç­–ç•¥
    switch (context) {
      case EncouragementContext.streakMilestone:
        return _generateMilestoneMessage(habit.name, currentStreak);

      case EncouragementContext.almostGiveUp:
        return _generateMotivationalMessage(habit.name, currentStreak);

      case EncouragementContext.dailyReminder:
        return _generateReminderMessage(habit.name);

      case EncouragementContext.recovery:
        return _generateRecoveryMessage(habit.name);
    }
  }

  String _generateMilestoneMessage(String habitName, int streak) {
    final milestones = {
      7: 'ğŸ‰ å¤ªæ£’äº†ï¼$habitNameå·²åšæŒä¸€å‘¨ï¼Œå…»æˆä¹ æƒ¯çš„å…³é”®æœŸå·²è¿‡ï¼',
      21: 'ğŸ† äº†ä¸èµ·ï¼$habitNameåšæŒ21å¤©ï¼Œä¹ æƒ¯å·²åˆæ­¥å½¢æˆï¼',
      30: 'ğŸŒŸ ä¸€ä¸ªæœˆçš„åšæŒï¼$habitNameå·²æˆä¸ºä½ ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼',
      66: 'ğŸ’ 66å¤©ï¼$habitNameå·²ç»æˆä¸ºä½ çš„æœ¬èƒ½ååº”ï¼',
      100: 'ğŸ‘‘ 100å¤©å¤§æ»¡è´¯ï¼$habitNameçš„åšæŒè®©ä½ ä¸ä¼—ä¸åŒï¼',
    };

    // æ‰¾åˆ°æœ€è¿‘çš„é‡Œç¨‹ç¢‘
    for (final entry in milestones.entries) {
      if (streak == entry.key) {
        return entry.value;
      }
    }

    return 'ç»§ç»­ä¿æŒ$habitNameï¼Œç¬¬$streakå¤©æ‰“å¡æˆåŠŸï¼';
  }

  TimeSlot _findBestTimeSlot(List<HabitLog> logs) {
    // åˆ†æå†å²å®Œæˆæ—¶é—´åˆ†å¸ƒ
    final hourCounts = <int, int>{};
    for (final log in logs.where((l) => l.completed)) {
      final hour = log.completedAt?.hour ?? 0;
      hourCounts[hour] = (hourCounts[hour] ?? 0) + 1;
    }

    // æ‰¾å‡ºæœ€é«˜é¢‘çš„æ—¶é—´æ®µ
    final bestHour = hourCounts.entries
        .reduce((a, b) => a.value > b.value ? a : b)
        .key;

    return TimeSlot.fromHour(bestHour);
  }
}
```

#### 16.11.6 ä¸æ•°æ®å¯¼å…¥ç³»ç»Ÿé›†æˆ

```dart
/// æ™ºèƒ½è§£æä¸æ•°æ®å¯¼å…¥ç³»ç»Ÿé›†æˆ
class ImportAIIntegration {
  final SmartCategoryService _categoryService;
  final LLMService _llmService;
  final DuplicateDetectionService _duplicateService;

  /// æ™ºèƒ½è§£æå¯¼å…¥çš„è´¦å•
  Future<List<ParsedTransaction>> parseImportedBill({
    required String rawContent,
    required String sourceType, // 'wechat', 'alipay', 'bank', 'unknown'
  }) async {
    // 1. å°è¯•ç»“æ„åŒ–è§£æ
    List<ParsedTransaction>? structured;
    if (sourceType != 'unknown') {
      structured = await _tryStructuredParse(rawContent, sourceType);
    }

    // 2. ç»“æ„åŒ–å¤±è´¥åˆ™ä½¿ç”¨AIè§£æ
    if (structured == null || structured.isEmpty) {
      structured = await _aiParseBill(rawContent);
    }

    // 3. ä¸ºæ¯ç¬”äº¤æ˜“æ·»åŠ æ™ºèƒ½åˆ†ç±»
    final withCategories = <ParsedTransaction>[];
    for (final tx in structured) {
      final category = await _categoryService.classifyTransaction(
        description: tx.description,
        merchantName: tx.merchantName,
        amount: tx.amount,
      );

      withCategories.add(tx.copyWith(
        suggestedCategoryId: category.categoryId,
        categoryConfidence: category.confidence,
      ));
    }

    return withCategories;
  }

  /// æ‰¹é‡å¯¼å…¥æ—¶çš„æ™ºèƒ½å»é‡
  Future<DuplicateCheckResult> checkDuplicates({
    required List<ParsedTransaction> newTransactions,
    required String userId,
  }) async {
    final result = DuplicateCheckResult();

    for (final tx in newTransactions) {
      // å¤šå› å­å»é‡æ£€æµ‹
      final duplicateScore = await _duplicateService.calculateDuplicateScore(
        userId: userId,
        amount: tx.amount,
        timestamp: tx.timestamp,
        description: tx.description,
        merchantName: tx.merchantName,
      );

      if (duplicateScore > 0.9) {
        result.definitelyDuplicates.add(tx);
      } else if (duplicateScore > 0.7) {
        result.possibleDuplicates.add(DuplicateCandidate(
          transaction: tx,
          score: duplicateScore,
          matchedWith: await _findMatchingTransaction(tx, userId),
        ));
      } else {
        result.uniqueTransactions.add(tx);
      }
    }

    return result;
  }

  Future<List<ParsedTransaction>> _aiParseBill(String rawContent) async {
    final prompt = '''
è¯·è§£æä»¥ä¸‹è´¦å•å†…å®¹ï¼Œæå–æ‰€æœ‰äº¤æ˜“è®°å½•ã€‚
å¯¹äºæ¯ç¬”äº¤æ˜“ï¼Œè¯·æå–ï¼š
- æ—¥æœŸæ—¶é—´
- é‡‘é¢ï¼ˆæ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ”¯å‡ºï¼‰
- å•†å®¶/æ¥æº
- æè¿°/å¤‡æ³¨

è´¦å•å†…å®¹ï¼š
$rawContent

è¯·ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ï¼šdate, amount, merchant, description
''';

    final response = await _llmService.complete(prompt);
    return _parseAIResponse(response);
  }
}
```

#### 16.11.7 æ™ºèƒ½èƒ½åŠ›ç»Ÿä¸€è°ƒåº¦

```dart
/// æ™ºèƒ½èƒ½åŠ›ç»Ÿä¸€è°ƒåº¦æœåŠ¡
/// è´Ÿè´£åè°ƒå„ç³»ç»Ÿå¯¹æ™ºèƒ½èƒ½åŠ›çš„è°ƒç”¨ï¼Œå®ç°æˆæœ¬æ§åˆ¶å’Œè´Ÿè½½å‡è¡¡
class SmartAICoordinator {
  final Map<String, AICapabilityService> _services;
  final CostTracker _costTracker;
  final RateLimiter _rateLimiter;

  /// æ‰§è¡Œæ™ºèƒ½ä»»åŠ¡ï¼ˆå¸¦æˆæœ¬æ§åˆ¶ï¼‰
  Future<T> executeWithCostControl<T>({
    required String taskType,
    required Future<T> Function() task,
    required double maxCost,
    required T Function() fallback,
  }) async {
    // æ£€æŸ¥ä»Šæ—¥æˆæœ¬æ˜¯å¦å·²è¶…é™
    final todayCost = await _costTracker.getTodayCost();
    if (todayCost >= maxCost) {
      return fallback();
    }

    // æ£€æŸ¥é€Ÿç‡é™åˆ¶
    if (!await _rateLimiter.tryAcquire(taskType)) {
      return fallback();
    }

    try {
      final startTime = DateTime.now();
      final result = await task();
      final endTime = DateTime.now();

      // è®°å½•è°ƒç”¨
      await _costTracker.recordCall(
        taskType: taskType,
        duration: endTime.difference(startTime),
        success: true,
      );

      return result;
    } catch (e) {
      // å¤±è´¥æ—¶é™çº§
      await _costTracker.recordCall(
        taskType: taskType,
        duration: Duration.zero,
        success: false,
        error: e.toString(),
      );
      return fallback();
    }
  }

  /// è·å–æ™ºèƒ½èƒ½åŠ›å¥åº·çŠ¶æ€
  Future<AIHealthStatus> getHealthStatus() async {
    final services = <String, ServiceHealth>{};

    for (final entry in _services.entries) {
      final health = await entry.value.healthCheck();
      services[entry.key] = health;
    }

    return AIHealthStatus(
      overallStatus: _calculateOverallStatus(services),
      serviceStatus: services,
      todayCost: await _costTracker.getTodayCost(),
      todayCallCount: await _costTracker.getTodayCallCount(),
      errorRate: await _costTracker.getRecentErrorRate(),
    );
  }

  HealthLevel _calculateOverallStatus(Map<String, ServiceHealth> services) {
    final healthyCount = services.values
        .where((h) => h.level == HealthLevel.healthy)
        .length;

    if (healthyCount == services.length) return HealthLevel.healthy;
    if (healthyCount >= services.length / 2) return HealthLevel.degraded;
    return HealthLevel.unhealthy;
  }
}

/// æ™ºèƒ½èƒ½åŠ›å¥åº·çŠ¶æ€
class AIHealthStatus {
  final HealthLevel overallStatus;
  final Map<String, ServiceHealth> serviceStatus;
  final double todayCost;
  final int todayCallCount;
  final double errorRate;

  AIHealthStatus({
    required this.overallStatus,
    required this.serviceStatus,
    required this.todayCost,
    required this.todayCallCount,
    required this.errorRate,
  });

  Map<String, dynamic> toJson() => {
    'overall': overallStatus.name,
    'services': serviceStatus.map((k, v) => MapEntry(k, v.toJson())),
    'cost': {'today': todayCost, 'unit': 'CNY'},
    'calls': todayCallCount,
    'errorRate': '${(errorRate * 100).toStringAsFixed(2)}%',
  };
}
```

---


---

---

### 16.12 æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ

> **ğŸ“š é‡è¦è¯´æ˜**
>
> æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿå·²æŠ½å–ä¸ºç‹¬ç«‹çš„**ç¬¬17ç« **ï¼Œä½œä¸ºç‹¬ç«‹æ¨¡å—è®¾è®¡ã€‚
> è¯·å‚é˜…ç¬¬17ç« è·å–å®Œæ•´çš„è¯­éŸ³äº¤äº’ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆã€‚

æœ¬èŠ‚å†…å®¹åŒ…æ‹¬ï¼š
- 17.0 ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾
- 17.1 æ„å›¾è¯†åˆ«å¼•æ“ï¼ˆå«è‡ªå­¦ä¹ æ¨¡å‹ï¼‰
- 17.2 è¯­éŸ³è®°è´¦æ¨¡å—
- 17.3 æ™ºèƒ½è¯­éŸ³é…ç½®æ¨¡å—
- 17.4 æ™ºèƒ½è¯­éŸ³å¯¼èˆªæ¨¡å—
- 17.5 æ™ºèƒ½è¯­éŸ³æŸ¥è¯¢æ¨¡å—
- 17.6 è¯­éŸ³äº¤äº’ä¼šè¯ç®¡ç†
- 17.7 è¯­éŸ³äº¤äº’ç•Œé¢è®¾è®¡
- 17.8 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ
- 17.9 ç›®æ ‡è¾¾æˆæ£€æµ‹
- 17.10 æ™ºèƒ½è¯­éŸ³åé¦ˆä¸å®¢æœç³»ç»Ÿ

## 17. è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ

### 17.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« å®šä¹‰AIè®°è´¦åº”ç”¨çš„è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿæ¶æ„ã€‚è¯¥ç³»ç»Ÿä½œä¸º**ç‹¬ç«‹æ¨¡å—**è®¾è®¡ï¼Œä¸ºå…¶ä»–æ™ºèƒ½æ¨¡å—æä¾›ç»Ÿä¸€çš„å­¦ä¹ èƒ½åŠ›æ”¯æŒã€‚

#### 17.0.1 è‡ªå­¦ä¹ ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ

| è®¾è®¡åŸåˆ™ | åœ¨è‡ªå­¦ä¹ ç³»ç»Ÿä¸­çš„ä½“ç° | å®ç°æ–¹å¼ |
|----------|----------------------|----------|
| **æ‡’äººè®¾è®¡** | é›¶é…ç½®è‡ªåŠ¨å­¦ä¹  | ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œï¼Œç³»ç»Ÿè‡ªåŠ¨ä»ä½¿ç”¨è¡Œä¸ºä¸­å­¦ä¹  |
| **ä¼™ä¼´åŒ–** | å­¦ä¹ è¿‡ç¨‹é€æ˜å¯è§ | é€šè¿‡"æˆ‘åœ¨å­¦ä¹ æ‚¨çš„ä¹ æƒ¯"ç­‰å‹å¥½æç¤ºå¢å¼ºä¿¡ä»» |
| **æ¸è¿›å¼** | é€æ­¥æå‡å‡†ç¡®ç‡ | ä»è§„åˆ™åŒ¹é…â†’æœ¬åœ°MLâ†’ååŒå­¦ä¹ ï¼Œèƒ½åŠ›é€æ­¥å¢å¼º |
| **éšç§ä¼˜å…ˆ** | æœ¬åœ°å­¦ä¹ ä¸ºä¸» | æ•æ„Ÿæ•°æ®æœ¬åœ°å¤„ç†ï¼Œä»…åŒæ­¥è„±æ•çš„æ¨¡å¼ç‰¹å¾ |
| **å¼€æ”¾é›†æˆ** | ç»Ÿä¸€æ¡†æ¶æ¥å£ | æ‰€æœ‰æ™ºèƒ½æ¨¡å—é€šè¿‡ç»Ÿä¸€æ¥å£æ¥å…¥å­¦ä¹ èƒ½åŠ› |

#### 17.0.2 è®¾è®¡ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è‡ªå­¦ä¹ ç³»ç»Ÿè®¾è®¡ç†å¿µ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   ğŸ¯ æ ¸å¿ƒç›®æ ‡ï¼šè®©åº”ç”¨è¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨è¶Šæ™ºèƒ½                                    â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  è®¾è®¡ç†å¿µï¼šä½è€¦åˆã€é«˜å¤ç”¨ã€éšç§ä¼˜å…ˆã€é€æ˜å¯æ§                              â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚   å››å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ä¸ªä½“å­¦ä¹     â”‚  â”‚  ååŒå­¦ä¹     â”‚  â”‚  è¿ç§»å­¦ä¹     â”‚  â”‚  å¢é‡å­¦ä¹     â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚   â”‚ ä»ç”¨æˆ·è¡Œä¸ºä¸­ â”‚  â”‚ ä»ç¾¤ä½“æ™ºæ…§ä¸­ â”‚  â”‚ å°†å­¦ä¹ æˆæœ   â”‚  â”‚ æŒç»­åœ¨çº¿     â”‚   â”‚
â”‚   â”‚ å­¦ä¹ ä¸ªæ€§åŒ–   â”‚  â”‚ æç‚¼é€šç”¨è§„åˆ™ â”‚  â”‚ è·¨æ¨¡å—å¤ç”¨   â”‚  â”‚ æ¨¡å‹æ›´æ–°     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 17.0.3 ä¸å…¶ä»–ç³»ç»Ÿçš„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è‡ªå­¦ä¹ ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„å…³ç³»                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                        â”‚   17. è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹    â”‚                           â”‚
â”‚                        â”‚      ç³»ç»Ÿï¼ˆæœ¬ç« ï¼‰        â”‚                           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                    â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚                     â”‚                     â”‚                   â”‚
â”‚              â–¼                     â–¼                     â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  è°ƒç”¨å­¦ä¹ æ¥å£     â”‚  â”‚  è°ƒç”¨å­¦ä¹ æ¥å£     â”‚  â”‚  è°ƒç”¨å­¦ä¹ æ¥å£     â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚              â”‚                     â”‚                     â”‚                   â”‚
â”‚              â–¼                     â–¼                     â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ 16. æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ â”‚  â”‚ 18. è¯­éŸ³äº¤äº’ç³»ç»Ÿ â”‚  â”‚  10. AIè¯†åˆ«ç³»ç»Ÿ  â”‚          â”‚
â”‚   â”‚   - åˆ†ç±»å­¦ä¹       â”‚  â”‚   - æ„å›¾è¯†åˆ«å­¦ä¹   â”‚  â”‚   - å›¾åƒè¯†åˆ«å­¦ä¹   â”‚          â”‚
â”‚   â”‚   - è§„åˆ™æ²‰æ·€      â”‚  â”‚   - è¯­éŸ³ä¹ æƒ¯å­¦ä¹   â”‚  â”‚   - æ–‡å­—è¯†åˆ«å­¦ä¹   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  8. é¢„ç®—ç³»ç»Ÿ      â”‚  â”‚  7. é’±é¾„ç³»ç»Ÿ      â”‚  â”‚  9. ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ  â”‚          â”‚
â”‚   â”‚   - é¢„ç®—å»ºè®®å­¦ä¹   â”‚  â”‚   - èµ„é‡‘æµå‘å­¦ä¹   â”‚  â”‚   - è¡Œä¸ºæ¨¡å¼å­¦ä¹   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚   æ¥å…¥æ–¹å¼ï¼šå„æ¨¡å—é€šè¿‡ SelfLearningAdapter æ¥å…¥ç»Ÿä¸€å­¦ä¹ æ¡†æ¶                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 17.1 ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶

ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶æ˜¯ä¸€ä¸ª**å¯å¤ç”¨çš„åŸºç¡€è®¾æ–½å±‚**ï¼Œä¸ºæ‰€æœ‰æ™ºèƒ½æ¨¡å—æä¾›ä¸€è‡´çš„å­¦ä¹ èƒ½åŠ›ã€‚

#### 17.1.1 æ¡†æ¶æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        åº”ç”¨å±‚ï¼ˆå„æ™ºèƒ½æ¨¡å—ï¼‰                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚  â”‚  â”‚æ™ºèƒ½åˆ†ç±» â”‚ â”‚é¢„ç®—å»ºè®® â”‚ â”‚å¼‚å¸¸æ£€æµ‹ â”‚ â”‚è¯­éŸ³æ„å›¾ â”‚ â”‚è‡ªç„¶è¯­è¨€ â”‚           â”‚ â”‚
â”‚  â”‚  â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚ Adapter â”‚           â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚          â”‚          â”‚          â”‚          â”‚                       â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        ç»Ÿä¸€å­¦ä¹ æ¥å£å±‚                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  ISelfLearningModule<T extends LearningData, R extends LearnedRule> â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  â”‚  + collectSample(data: T): Future<void>                           â”‚   â”‚
â”‚  â”‚  â”‚  + train(): Future<void>                                          â”‚   â”‚
â”‚  â”‚  â”‚  + predict(input: dynamic): Future<R?>                            â”‚   â”‚
â”‚  â”‚  â”‚  + getMetrics(): Future<LearningMetrics>                          â”‚   â”‚
â”‚  â”‚  â”‚  + exportModel(): Future<ModelData>                               â”‚   â”‚
â”‚  â”‚  â”‚  + importModel(data: ModelData): Future<void>                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        æ ¸å¿ƒå­¦ä¹ å¼•æ“å±‚                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  æ ·æœ¬é‡‡é›†å™¨     â”‚ â”‚  æ¨¡å‹è®­ç»ƒå™¨     â”‚ â”‚  è§„åˆ™ç”Ÿæˆå™¨     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ SampleCollector â”‚ â”‚ ModelTrainer   â”‚ â”‚ RuleGenerator  â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  æ•ˆæœè¯„ä¼°å™¨     â”‚ â”‚  ç‰ˆæœ¬ç®¡ç†å™¨     â”‚ â”‚  è°ƒåº¦å™¨        â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ EffectEvaluator â”‚ â”‚ VersionManager â”‚ â”‚ Scheduler      â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        æ•°æ®å­˜å‚¨å±‚                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  æ ·æœ¬æ•°æ®åº“     â”‚ â”‚  æ¨¡å‹å­˜å‚¨       â”‚ â”‚  è§„åˆ™å­˜å‚¨       â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ SampleDB       â”‚ â”‚ ModelStorage   â”‚ â”‚ RuleStorage    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 17.1.2 æ ¸å¿ƒæŠ½è±¡ç±»è®¾è®¡

```dart
/// å­¦ä¹ æ•°æ®åŸºç±» - æ‰€æœ‰å­¦ä¹ æ ·æœ¬çš„æŠ½è±¡
abstract class LearningData {
  final String id;
  final DateTime timestamp;
  final String userId;
  final Map<String, dynamic> features;  // ç‰¹å¾å‘é‡
  final dynamic label;  // æ ‡ç­¾ï¼ˆç”¨æˆ·è¡Œä¸ºç»“æœï¼‰
  final LearningDataSource source;  // æ•°æ®æ¥æº

  LearningData({
    required this.id,
    required this.timestamp,
    required this.userId,
    required this.features,
    this.label,
    required this.source,
  });

  /// è½¬æ¢ä¸ºå¯å­˜å‚¨æ ¼å¼
  Map<String, dynamic> toStorable();

  /// è„±æ•å¤„ç†ï¼ˆç”¨äºååŒå­¦ä¹ ï¼‰
  LearningData anonymize();
}

/// å­¦ä¹ æ•°æ®æ¥æºæšä¸¾
enum LearningDataSource {
  userExplicitFeedback,   // ç”¨æˆ·æ˜ç¡®åé¦ˆï¼ˆå¦‚ä¿®æ­£åˆ†ç±»ï¼‰
  userImplicitBehavior,   // ç”¨æˆ·éšå¼è¡Œä¸ºï¼ˆå¦‚æ¥å—å»ºè®®ï¼‰
  systemInference,        // ç³»ç»Ÿæ¨æ–­
  collaborativeSync,      // ååŒå­¦ä¹ åŒæ­¥
}

/// å­¦ä¹ è§„åˆ™åŸºç±» - æ‰€æœ‰å­¦ä¹ æˆæœçš„æŠ½è±¡
abstract class LearnedRule {
  final String ruleId;
  final String moduleId;  // æ‰€å±æ¨¡å—æ ‡è¯†
  final int priority;     // è§„åˆ™ä¼˜å…ˆçº§
  final double confidence;  // ç½®ä¿¡åº¦
  final DateTime createdAt;
  final DateTime lastUsedAt;
  final int hitCount;  // å‘½ä¸­æ¬¡æ•°
  final RuleSource source;  // è§„åˆ™æ¥æº

  LearnedRule({
    required this.ruleId,
    required this.moduleId,
    required this.priority,
    required this.confidence,
    required this.createdAt,
    required this.lastUsedAt,
    this.hitCount = 0,
    required this.source,
  });

  /// åˆ¤æ–­è§„åˆ™æ˜¯å¦åŒ¹é…è¾“å…¥
  bool matches(dynamic input);

  /// åº”ç”¨è§„åˆ™è¿”å›ç»“æœ
  dynamic apply(dynamic input);

  /// æ›´æ–°è§„åˆ™ç»Ÿè®¡
  void recordHit();
}

/// è§„åˆ™æ¥æºæšä¸¾
enum RuleSource {
  userLearned,       // ä»ç”¨æˆ·è¡Œä¸ºå­¦ä¹ 
  collaborative,     // ååŒå­¦ä¹ è·å–
  systemDefault,     // ç³»ç»Ÿé»˜è®¤è§„åˆ™
  adminConfigured,   // ç®¡ç†å‘˜é…ç½®
}

/// å­¦ä¹ æ•ˆæœæŒ‡æ ‡
class LearningMetrics {
  final String moduleId;
  final DateTime measureTime;
  final int totalSamples;
  final int totalRules;
  final double accuracy;  // å‡†ç¡®ç‡
  final double precision; // ç²¾ç¡®ç‡
  final double recall;    // å¬å›ç‡
  final double f1Score;   // F1åˆ†æ•°
  final double avgResponseTime;  // å¹³å‡å“åº”æ—¶é—´
  final Map<String, dynamic> customMetrics;  // æ¨¡å—è‡ªå®šä¹‰æŒ‡æ ‡

  LearningMetrics({
    required this.moduleId,
    required this.measureTime,
    required this.totalSamples,
    required this.totalRules,
    required this.accuracy,
    required this.precision,
    required this.recall,
    required this.f1Score,
    required this.avgResponseTime,
    this.customMetrics = const {},
  });
}

/// ç»Ÿä¸€è‡ªå­¦ä¹ æ¨¡å—æ¥å£
abstract class ISelfLearningModule<T extends LearningData, R extends LearnedRule> {
  /// æ¨¡å—æ ‡è¯†
  String get moduleId;

  /// æ¨¡å—åç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  String get moduleName;

  /// é‡‡é›†å­¦ä¹ æ ·æœ¬
  Future<void> collectSample(T data);

  /// æ‰¹é‡é‡‡é›†æ ·æœ¬
  Future<void> collectSamples(List<T> dataList);

  /// è§¦å‘æ¨¡å‹è®­ç»ƒ
  Future<TrainingResult> train({bool incremental = true});

  /// ä½¿ç”¨å­¦ä¹ æˆæœè¿›è¡Œé¢„æµ‹
  Future<PredictionResult<R>> predict(dynamic input);

  /// è·å–å­¦ä¹ æ•ˆæœæŒ‡æ ‡
  Future<LearningMetrics> getMetrics();

  /// è·å–æ‰€æœ‰å·²å­¦ä¹ è§„åˆ™
  Future<List<R>> getRules({RuleSource? source, int? limit});

  /// å¯¼å‡ºæ¨¡å‹ï¼ˆç”¨äºå¤‡ä»½æˆ–è¿ç§»ï¼‰
  Future<ModelExportData> exportModel();

  /// å¯¼å…¥æ¨¡å‹
  Future<void> importModel(ModelExportData data);

  /// æ¸…é™¤å­¦ä¹ æ•°æ®
  Future<void> clearData({bool keepRules = true});

  /// è·å–å­¦ä¹ çŠ¶æ€
  Future<LearningStatus> getStatus();
}

/// è®­ç»ƒç»“æœ
class TrainingResult {
  final bool success;
  final int samplesUsed;
  final int rulesGenerated;
  final Duration trainingTime;
  final LearningMetrics? newMetrics;
  final String? errorMessage;

  TrainingResult({
    required this.success,
    required this.samplesUsed,
    required this.rulesGenerated,
    required this.trainingTime,
    this.newMetrics,
    this.errorMessage,
  });
}

/// é¢„æµ‹ç»“æœ
class PredictionResult<R extends LearnedRule> {
  final bool matched;
  final R? matchedRule;
  final dynamic result;
  final double confidence;
  final PredictionSource source;

  PredictionResult({
    required this.matched,
    this.matchedRule,
    this.result,
    required this.confidence,
    required this.source,
  });
}

/// é¢„æµ‹æ¥æº
enum PredictionSource {
  learnedRule,       // å­¦ä¹ è§„åˆ™å‘½ä¸­
  defaultRule,       // é»˜è®¤è§„åˆ™å‘½ä¸­
  modelInference,    // æ¨¡å‹æ¨ç†
  fallback,          // å…œåº•ç­–ç•¥
}

/// å­¦ä¹ çŠ¶æ€
class LearningStatus {
  final String moduleId;
  final bool isEnabled;
  final DateTime? lastTrainingTime;
  final DateTime? nextScheduledTraining;
  final int pendingSamples;
  final LearningStage stage;

  LearningStatus({
    required this.moduleId,
    required this.isEnabled,
    this.lastTrainingTime,
    this.nextScheduledTraining,
    required this.pendingSamples,
    required this.stage,
  });
}

/// å­¦ä¹ é˜¶æ®µ
enum LearningStage {
  coldStart,        // å†·å¯åŠ¨ï¼ˆæ ·æœ¬ä¸è¶³ï¼‰
  collecting,       // æ ·æœ¬æ”¶é›†ä¸­
  training,         // è®­ç»ƒä¸­
  active,           // æ­£å¸¸è¿è¡Œ
  degraded,         // é™çº§è¿è¡Œï¼ˆæ•ˆæœä¸‹é™ï¼‰
}
```

#### 17.1.3 è‡ªå­¦ä¹ æœåŠ¡å®ç°

```dart
/// ç»Ÿä¸€è‡ªå­¦ä¹ æœåŠ¡ - ç®¡ç†æ‰€æœ‰æ¨¡å—çš„å­¦ä¹ èƒ½åŠ›
class UnifiedSelfLearningService {
  static final UnifiedSelfLearningService _instance =
      UnifiedSelfLearningService._internal();
  factory UnifiedSelfLearningService() => _instance;
  UnifiedSelfLearningService._internal();

  final Map<String, ISelfLearningModule> _modules = {};
  final SampleDatabase _sampleDb = SampleDatabase();
  final ModelStorage _modelStorage = ModelStorage();
  final LearningScheduler _scheduler = LearningScheduler();
  final LearningMetricsCollector _metricsCollector = LearningMetricsCollector();

  /// æ³¨å†Œå­¦ä¹ æ¨¡å—
  void registerModule(ISelfLearningModule module) {
    _modules[module.moduleId] = module;
    _scheduler.scheduleModule(module.moduleId);
    print('ğŸ“š å·²æ³¨å†Œå­¦ä¹ æ¨¡å—: ${module.moduleName}');
  }

  /// å–æ¶ˆæ³¨å†Œæ¨¡å—
  void unregisterModule(String moduleId) {
    _modules.remove(moduleId);
    _scheduler.unscheduleModule(moduleId);
  }

  /// è·å–æ¨¡å—
  ISelfLearningModule? getModule(String moduleId) => _modules[moduleId];

  /// è·å–æ‰€æœ‰æ¨¡å—çŠ¶æ€
  Future<Map<String, LearningStatus>> getAllModuleStatus() async {
    final statuses = <String, LearningStatus>{};
    for (final entry in _modules.entries) {
      statuses[entry.key] = await entry.value.getStatus();
    }
    return statuses;
  }

  /// è§¦å‘å…¨å±€è®­ç»ƒ
  Future<Map<String, TrainingResult>> trainAllModules() async {
    final results = <String, TrainingResult>{};
    for (final entry in _modules.entries) {
      try {
        results[entry.key] = await entry.value.train();
      } catch (e) {
        results[entry.key] = TrainingResult(
          success: false,
          samplesUsed: 0,
          rulesGenerated: 0,
          trainingTime: Duration.zero,
          errorMessage: e.toString(),
        );
      }
    }
    return results;
  }

  /// è·å–æ•´ä½“å­¦ä¹ æ•ˆæœæŠ¥å‘Š
  Future<LearningEffectReport> getOverallReport() async {
    final moduleMetrics = <String, LearningMetrics>{};
    for (final entry in _modules.entries) {
      moduleMetrics[entry.key] = await entry.value.getMetrics();
    }

    return LearningEffectReport(
      generatedAt: DateTime.now(),
      moduleMetrics: moduleMetrics,
      overallAccuracy: _calculateOverallAccuracy(moduleMetrics),
      totalRules: moduleMetrics.values.fold(0, (sum, m) => sum + m.totalRules),
      totalSamples: moduleMetrics.values.fold(0, (sum, m) => sum + m.totalSamples),
    );
  }

  double _calculateOverallAccuracy(Map<String, LearningMetrics> metrics) {
    if (metrics.isEmpty) return 0.0;
    final total = metrics.values.fold(0.0, (sum, m) => sum + m.accuracy);
    return total / metrics.length;
  }

  /// å¯¼å‡ºæ‰€æœ‰æ¨¡å—çš„æ¨¡å‹
  Future<FullModelExport> exportAllModels() async {
    final exports = <String, ModelExportData>{};
    for (final entry in _modules.entries) {
      exports[entry.key] = await entry.value.exportModel();
    }
    return FullModelExport(
      exportedAt: DateTime.now(),
      version: '2.0',
      modules: exports,
    );
  }

  /// å¯¼å…¥æ¨¡å‹
  Future<void> importAllModels(FullModelExport export) async {
    for (final entry in export.modules.entries) {
      final module = _modules[entry.key];
      if (module != null) {
        await module.importModel(entry.value);
      }
    }
  }
}

/// å­¦ä¹ æ•ˆæœæŠ¥å‘Š
class LearningEffectReport {
  final DateTime generatedAt;
  final Map<String, LearningMetrics> moduleMetrics;
  final double overallAccuracy;
  final int totalRules;
  final int totalSamples;

  LearningEffectReport({
    required this.generatedAt,
    required this.moduleMetrics,
    required this.overallAccuracy,
    required this.totalRules,
    required this.totalSamples,
  });
}

/// å®Œæ•´æ¨¡å‹å¯¼å‡º
class FullModelExport {
  final DateTime exportedAt;
  final String version;
  final Map<String, ModelExportData> modules;

  FullModelExport({
    required this.exportedAt,
    required this.version,
    required this.modules,
  });
}
```

#### 17.1.4 å­¦ä¹ è°ƒåº¦å™¨

```dart
/// å­¦ä¹ è°ƒåº¦å™¨ - ç®¡ç†å„æ¨¡å—çš„è®­ç»ƒæ—¶æœº
class LearningScheduler {
  final Map<String, ScheduleConfig> _schedules = {};
  Timer? _schedulerTimer;

  /// è°ƒåº¦é…ç½®
  void scheduleModule(String moduleId, {
    Duration interval = const Duration(hours: 24),
    TimeOfDay? preferredTime,
    int minSamplesForTraining = 10,
  }) {
    _schedules[moduleId] = ScheduleConfig(
      moduleId: moduleId,
      interval: interval,
      preferredTime: preferredTime ?? const TimeOfDay(hour: 3, minute: 0), // é»˜è®¤å‡Œæ™¨3ç‚¹
      minSamplesForTraining: minSamplesForTraining,
    );
    _ensureSchedulerRunning();
  }

  void unscheduleModule(String moduleId) {
    _schedules.remove(moduleId);
  }

  void _ensureSchedulerRunning() {
    _schedulerTimer?.cancel();
    _schedulerTimer = Timer.periodic(
      const Duration(minutes: 30),
      (_) => _checkAndTriggerTraining(),
    );
  }

  Future<void> _checkAndTriggerTraining() async {
    final learningService = UnifiedSelfLearningService();
    final now = DateTime.now();

    for (final config in _schedules.values) {
      final module = learningService.getModule(config.moduleId);
      if (module == null) continue;

      final status = await module.getStatus();

      // æ£€æŸ¥æ˜¯å¦æ»¡è¶³è®­ç»ƒæ¡ä»¶
      if (status.pendingSamples >= config.minSamplesForTraining) {
        final lastTraining = status.lastTrainingTime;
        if (lastTraining == null ||
            now.difference(lastTraining) >= config.interval) {
          // è§¦å‘è®­ç»ƒ
          await module.train(incremental: true);
        }
      }
    }
  }

  /// ç«‹å³è§¦å‘æŒ‡å®šæ¨¡å—è®­ç»ƒ
  Future<TrainingResult?> triggerImmediateTraining(String moduleId) async {
    final module = UnifiedSelfLearningService().getModule(moduleId);
    return module?.train(incremental: false);
  }
}

/// è°ƒåº¦é…ç½®
class ScheduleConfig {
  final String moduleId;
  final Duration interval;
  final TimeOfDay preferredTime;
  final int minSamplesForTraining;

  ScheduleConfig({
    required this.moduleId,
    required this.interval,
    required this.preferredTime,
    required this.minSamplesForTraining,
  });
}
```

### 17.2 å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿ

ååŒå­¦ä¹ ç³»ç»Ÿå®ç°è·¨ç”¨æˆ·çš„çŸ¥è¯†å…±äº«ï¼ŒåŒæ—¶ä¿æŠ¤ç”¨æˆ·éšç§ã€‚

#### 17.2.1 ååŒå­¦ä¹ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤šç”¨æˆ·ååŒå­¦ä¹ æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              äº‘ç«¯èšåˆå±‚                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                      è§„åˆ™èšåˆå¼•æ“                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ æ¨¡å¼èšç±»  â”‚â†’â”‚ ç½®ä¿¡åº¦   â”‚â†’â”‚ éªŒè¯æµ‹è¯•  â”‚â†’â”‚ è§„åˆ™å‘å¸ƒ  â”‚          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Clusteringâ”‚  â”‚ Scoring  â”‚  â”‚ Validationâ”‚  â”‚ Publishingâ”‚          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                              â†‘ è„±æ•æ•°æ®                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   ç”¨æˆ·A     â”‚     ç”¨æˆ·B          ç”¨æˆ·C                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚ æœ¬åœ°å­¦ä¹   â”‚  â”‚ è„±æ•ä¸ŠæŠ¥  â”‚â”‚â”‚ æœ¬åœ°å­¦ä¹   â”‚  â”‚ æœ¬åœ°å­¦ä¹   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚ å¼•æ“      â”‚  â”‚ æ¨¡å—      â”‚â”‚â”‚ å¼•æ“      â”‚  â”‚ å¼•æ“      â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚       â†“              â†‘     â”‚      â†“              â†“                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚ â”‚
â”‚  â”‚  â”‚ ååŒè§„åˆ™ä¸‹è½½&èåˆ     â”‚  â”‚â”‚ ååŒè§„åˆ™ä¸‹è½½&èåˆ     â”‚                    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 17.2.2 éšç§ä¿æŠ¤è®¾è®¡

```dart
/// ååŒå­¦ä¹ æ•°æ®è„±æ•æœåŠ¡
class CollaborativeLearningAnonymizer {
  /// è„±æ•é…ç½®
  static const _anonymizationConfig = {
    'merchant_name': AnonymizeStrategy.hash,
    'amount': AnonymizeStrategy.range,
    'description': AnonymizeStrategy.remove,
    'user_id': AnonymizeStrategy.pseudonymize,
  };

  /// è„±æ•å­¦ä¹ æ ·æœ¬
  static Map<String, dynamic> anonymize(Map<String, dynamic> sample) {
    final result = <String, dynamic>{};

    for (final entry in sample.entries) {
      final strategy = _anonymizationConfig[entry.key] ?? AnonymizeStrategy.keep;
      result[entry.key] = _applyStrategy(entry.value, strategy);
    }

    return result;
  }

  static dynamic _applyStrategy(dynamic value, AnonymizeStrategy strategy) {
    switch (strategy) {
      case AnonymizeStrategy.hash:
        return _hashValue(value.toString());
      case AnonymizeStrategy.range:
        return _toRange(value as num);
      case AnonymizeStrategy.remove:
        return null;
      case AnonymizeStrategy.pseudonymize:
        return _pseudonymize(value.toString());
      case AnonymizeStrategy.keep:
        return value;
    }
  }

  static String _hashValue(String value) {
    // ä½¿ç”¨SHA256å“ˆå¸Œï¼Œä¿ç•™æ¨¡å¼åŒ¹é…èƒ½åŠ›
    final bytes = utf8.encode(value);
    final digest = sha256.convert(bytes);
    return digest.toString().substring(0, 16);
  }

  static String _toRange(num amount) {
    // é‡‘é¢è½¬æ¢ä¸ºèŒƒå›´åŒºé—´
    if (amount < 10) return 'tiny';      // <10
    if (amount < 50) return 'small';     // 10-50
    if (amount < 100) return 'medium';   // 50-100
    if (amount < 500) return 'large';    // 100-500
    if (amount < 1000) return 'xlarge';  // 500-1000
    return 'huge';                       // >1000
  }

  static String _pseudonymize(String userId) {
    // ç”¨æˆ·IDä¼ªåŒ¿ååŒ–ï¼ŒåŒä¸€ç”¨æˆ·ä¿æŒä¸€è‡´æ€§
    return 'user_${_hashValue(userId).substring(0, 8)}';
  }
}

/// è„±æ•ç­–ç•¥
enum AnonymizeStrategy {
  hash,         // å“ˆå¸Œå¤„ç†
  range,        // è½¬æ¢ä¸ºèŒƒå›´
  remove,       // å®Œå…¨ç§»é™¤
  pseudonymize, // ä¼ªåŒ¿ååŒ–
  keep,         // ä¿æŒåŸæ ·
}
```

#### 17.2.3 ååŒå­¦ä¹ æœåŠ¡

```dart
/// ååŒå­¦ä¹ æœåŠ¡
class CollaborativeLearningService {
  final ApiClient _apiClient;
  final LocalRuleStorage _ruleStorage;
  final _syncInterval = const Duration(hours: 6);
  Timer? _syncTimer;

  CollaborativeLearningService(this._apiClient, this._ruleStorage);

  /// å¯åŠ¨ååŒå­¦ä¹ 
  void start() {
    _syncTimer?.cancel();
    _syncTimer = Timer.periodic(_syncInterval, (_) => _syncWithCloud());
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    _syncWithCloud();
  }

  /// åœæ­¢ååŒå­¦ä¹ 
  void stop() {
    _syncTimer?.cancel();
    _syncTimer = null;
  }

  /// ä¸äº‘ç«¯åŒæ­¥
  Future<void> _syncWithCloud() async {
    try {
      // 1. ä¸ŠæŠ¥æœ¬åœ°è„±æ•æ•°æ®
      await _uploadAnonymizedPatterns();

      // 2. ä¸‹è½½ååŒè§„åˆ™
      final collaborativeRules = await _downloadCollaborativeRules();

      // 3. èåˆåˆ°æœ¬åœ°
      await _mergeCollaborativeRules(collaborativeRules);

    } catch (e) {
      print('ååŒå­¦ä¹ åŒæ­¥å¤±è´¥: $e');
    }
  }

  /// ä¸ŠæŠ¥è„±æ•æ¨¡å¼
  Future<void> _uploadAnonymizedPatterns() async {
    final learningService = UnifiedSelfLearningService();
    final allStatus = await learningService.getAllModuleStatus();

    for (final entry in allStatus.entries) {
      final module = learningService.getModule(entry.key);
      if (module == null) continue;

      // è·å–æœ¬åœ°è§„åˆ™å¹¶è„±æ•
      final rules = await module.getRules(source: RuleSource.userLearned);
      final anonymizedRules = rules.map((r) => _anonymizeRule(r)).toList();

      // ä¸ŠæŠ¥åˆ°äº‘ç«¯
      await _apiClient.post('/collaborative/patterns/${entry.key}', {
        'patterns': anonymizedRules,
        'device_fingerprint': await _getDeviceFingerprint(),
      });
    }
  }

  Map<String, dynamic> _anonymizeRule(LearnedRule rule) {
    // è§„åˆ™è„±æ•å¤„ç†
    return {
      'pattern_hash': _hashPattern(rule),
      'confidence': rule.confidence,
      'hit_count': rule.hitCount,
      // ä¸åŒ…å«ä»»ä½•å¯è¯†åˆ«ç”¨æˆ·çš„ä¿¡æ¯
    };
  }

  /// ä¸‹è½½ååŒè§„åˆ™
  Future<List<CollaborativeRule>> _downloadCollaborativeRules() async {
    final response = await _apiClient.get('/collaborative/rules');
    return (response['rules'] as List)
        .map((r) => CollaborativeRule.fromJson(r))
        .toList();
  }

  /// èåˆååŒè§„åˆ™
  Future<void> _mergeCollaborativeRules(List<CollaborativeRule> rules) async {
    for (final rule in rules) {
      // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰æ›´ä¼˜è§„åˆ™
      final localRules = await _ruleStorage.getRulesForModule(rule.moduleId);
      final existingRule = localRules.firstWhereOrNull(
        (r) => r.patternHash == rule.patternHash
      );

      if (existingRule == null) {
        // æ–°è§„åˆ™ï¼Œç›´æ¥æ·»åŠ 
        await _ruleStorage.addCollaborativeRule(rule);
      } else if (rule.globalConfidence > existingRule.confidence * 1.2) {
        // ååŒè§„åˆ™ç½®ä¿¡åº¦æ˜¾è‘—æ›´é«˜ï¼Œæ›´æ–°
        await _ruleStorage.updateRuleConfidence(
          existingRule.ruleId,
          rule.globalConfidence
        );
      }
    }
  }

  String _hashPattern(LearnedRule rule) {
    // ç”Ÿæˆè§„åˆ™çš„ç‰¹å¾å“ˆå¸Œ
    final features = rule.toStorable();
    features.remove('ruleId');
    features.remove('userId');
    return sha256.convert(utf8.encode(jsonEncode(features))).toString();
  }

  Future<String> _getDeviceFingerprint() async {
    // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ç”¨äºå»é‡
    final deviceInfo = await DeviceInfoPlugin().deviceInfo;
    return sha256.convert(utf8.encode(deviceInfo.toString())).toString();
  }
}

/// ååŒè§„åˆ™
class CollaborativeRule {
  final String moduleId;
  final String patternHash;
  final double globalConfidence;
  final int globalHitCount;
  final int contributorCount;
  final DateTime publishedAt;

  CollaborativeRule({
    required this.moduleId,
    required this.patternHash,
    required this.globalConfidence,
    required this.globalHitCount,
    required this.contributorCount,
    required this.publishedAt,
  });

  factory CollaborativeRule.fromJson(Map<String, dynamic> json) {
    return CollaborativeRule(
      moduleId: json['module_id'],
      patternHash: json['pattern_hash'],
      globalConfidence: json['global_confidence'],
      globalHitCount: json['global_hit_count'],
      contributorCount: json['contributor_count'],
      publishedAt: DateTime.parse(json['published_at']),
    );
  }
}
```

#### 17.2.4 æ–°ç”¨æˆ·å†·å¯åŠ¨åŠ é€Ÿ

```dart
/// å†·å¯åŠ¨åŠ é€ŸæœåŠ¡
class ColdStartAccelerator {
  final CollaborativeLearningService _collaborativeService;
  final UserProfileService _profileService;

  ColdStartAccelerator(this._collaborativeService, this._profileService);

  /// ä¸ºæ–°ç”¨æˆ·åˆå§‹åŒ–å­¦ä¹ è§„åˆ™
  Future<ColdStartResult> initializeForNewUser(String userId) async {
    // 1. è·å–ç”¨æˆ·ç”»åƒ
    final profile = await _profileService.getProfile(userId);

    // 2. æ ¹æ®ç”»åƒé€‰æ‹©é€‚åˆçš„ååŒè§„åˆ™é›†
    final ruleSet = await _selectRuleSet(profile);

    // 3. å¯¼å…¥è§„åˆ™
    await _importRuleSet(userId, ruleSet);

    return ColdStartResult(
      rulesImported: ruleSet.rules.length,
      expectedAccuracy: ruleSet.expectedAccuracy,
      warmUpDays: ruleSet.warmUpDays,
    );
  }

  Future<CollaborativeRuleSet> _selectRuleSet(UserProfile profile) async {
    // æ ¹æ®ç”¨æˆ·ç‰¹å¾é€‰æ‹©è§„åˆ™é›†
    final features = {
      'age_group': profile.ageGroup,
      'city_tier': profile.cityTier,
      'income_level': profile.estimatedIncomeLevel,
    };

    return await _collaborativeService.fetchRuleSetForProfile(features);
  }

  Future<void> _importRuleSet(String userId, CollaborativeRuleSet ruleSet) async {
    final learningService = UnifiedSelfLearningService();

    for (final moduleRules in ruleSet.rulesByModule.entries) {
      final module = learningService.getModule(moduleRules.key);
      if (module == null) continue;

      await module.importModel(ModelExportData(
        rules: moduleRules.value,
        source: 'cold_start',
        confidence: 0.6, // å†·å¯åŠ¨è§„åˆ™åˆå§‹ç½®ä¿¡åº¦è¾ƒä½
      ));
    }
  }
}

/// å†·å¯åŠ¨ç»“æœ
class ColdStartResult {
  final int rulesImported;
  final double expectedAccuracy;
  final int warmUpDays;

  ColdStartResult({
    required this.rulesImported,
    required this.expectedAccuracy,
    required this.warmUpDays,
  });
}
```

### 17.3 å„æ¨¡å—å­¦ä¹ é€‚é…å™¨

#### 17.3.1 æ™ºèƒ½åˆ†ç±»å­¦ä¹ é€‚é…å™¨

```dart
/// æ™ºèƒ½åˆ†ç±»å­¦ä¹ é€‚é…å™¨
class CategoryLearningAdapter extends ISelfLearningModule<CategoryLearningData, CategoryRule> {
  @override
  String get moduleId => 'smart_category';

  @override
  String get moduleName => 'æ™ºèƒ½åˆ†ç±»';

  final CategoryRuleStorage _ruleStorage;
  final CategorySampleDb _sampleDb;
  final LocalMLModel _localModel;

  CategoryLearningAdapter(this._ruleStorage, this._sampleDb, this._localModel);

  @override
  Future<void> collectSample(CategoryLearningData data) async {
    // æ”¶é›†ç”¨æˆ·åˆ†ç±»ä¿®æ­£æ ·æœ¬
    await _sampleDb.insert(data);
  }

  @override
  Future<TrainingResult> train({bool incremental = true}) async {
    final startTime = DateTime.now();

    // è·å–å¾…è®­ç»ƒæ ·æœ¬
    final samples = await _sampleDb.getPendingSamples();
    if (samples.isEmpty) {
      return TrainingResult(
        success: true,
        samplesUsed: 0,
        rulesGenerated: 0,
        trainingTime: Duration.zero,
      );
    }

    // è§„åˆ™æå–
    final newRules = _extractRules(samples);

    // å­˜å‚¨è§„åˆ™
    for (final rule in newRules) {
      await _ruleStorage.upsertRule(rule);
    }

    // æ›´æ–°æœ¬åœ°MLæ¨¡å‹
    if (samples.length >= 50) {
      await _localModel.retrain(samples);
    }

    // æ ‡è®°æ ·æœ¬å·²å¤„ç†
    await _sampleDb.markAsProcessed(samples.map((s) => s.id).toList());

    return TrainingResult(
      success: true,
      samplesUsed: samples.length,
      rulesGenerated: newRules.length,
      trainingTime: DateTime.now().difference(startTime),
      newMetrics: await getMetrics(),
    );
  }

  List<CategoryRule> _extractRules(List<CategoryLearningData> samples) {
    final rules = <CategoryRule>[];

    // æŒ‰å•†å®¶åç§°èšç±»
    final merchantGroups = groupBy(samples, (s) => s.merchantName);
    for (final entry in merchantGroups.entries) {
      if (entry.value.length >= 3) {
        // åŒä¸€å•†å®¶å‡ºç°3æ¬¡ä»¥ä¸Šï¼Œæå–è§„åˆ™
        final mostFrequentCategory = _getMostFrequent(
          entry.value.map((s) => s.userCorrectedCategory).toList()
        );

        if (mostFrequentCategory != null) {
          rules.add(CategoryRule(
            ruleId: 'merchant_${entry.key.hashCode}',
            merchantPattern: entry.key,
            categoryId: mostFrequentCategory,
            confidence: entry.value.length / samples.length,
            source: RuleSource.userLearned,
          ));
        }
      }
    }

    // æŒ‰é‡‘é¢èŒƒå›´+å…³é”®è¯èšç±»
    // ... æ›´å¤šè§„åˆ™æå–é€»è¾‘

    return rules;
  }

  @override
  Future<PredictionResult<CategoryRule>> predict(dynamic input) async {
    final transaction = input as TransactionInput;

    // 1. æŸ¥æ‰¾åŒ¹é…çš„ç”¨æˆ·è§„åˆ™
    final userRules = await _ruleStorage.getRules(source: RuleSource.userLearned);
    for (final rule in userRules) {
      if (rule.matches(transaction)) {
        return PredictionResult(
          matched: true,
          matchedRule: rule,
          result: rule.categoryId,
          confidence: rule.confidence,
          source: PredictionSource.learnedRule,
        );
      }
    }

    // 2. æŸ¥æ‰¾ååŒè§„åˆ™
    final collaborativeRules = await _ruleStorage.getRules(source: RuleSource.collaborative);
    for (final rule in collaborativeRules) {
      if (rule.matches(transaction)) {
        return PredictionResult(
          matched: true,
          matchedRule: rule,
          result: rule.categoryId,
          confidence: rule.confidence * 0.8, // ååŒè§„åˆ™ç½®ä¿¡åº¦ç•¥ä½
          source: PredictionSource.learnedRule,
        );
      }
    }

    // 3. ä½¿ç”¨æœ¬åœ°MLæ¨¡å‹
    final mlResult = await _localModel.predict(transaction);
    if (mlResult.confidence > 0.7) {
      return PredictionResult(
        matched: true,
        result: mlResult.categoryId,
        confidence: mlResult.confidence,
        source: PredictionSource.modelInference,
      );
    }

    // 4. è¿”å›æœªåŒ¹é…
    return PredictionResult(
      matched: false,
      confidence: 0,
      source: PredictionSource.fallback,
    );
  }

  @override
  Future<LearningMetrics> getMetrics() async {
    final rules = await _ruleStorage.getAllRules();
    final recentPredictions = await _getPredictionHistory(days: 7);

    final correctPredictions = recentPredictions
        .where((p) => p.wasCorrect)
        .length;

    return LearningMetrics(
      moduleId: moduleId,
      measureTime: DateTime.now(),
      totalSamples: await _sampleDb.getTotalCount(),
      totalRules: rules.length,
      accuracy: recentPredictions.isEmpty
          ? 0
          : correctPredictions / recentPredictions.length,
      precision: _calculatePrecision(recentPredictions),
      recall: _calculateRecall(recentPredictions),
      f1Score: _calculateF1(recentPredictions),
      avgResponseTime: _calculateAvgResponseTime(recentPredictions),
    );
  }

  // ... å…¶ä»–æ¥å£å®ç°
}

/// åˆ†ç±»å­¦ä¹ æ•°æ®
class CategoryLearningData extends LearningData {
  final String merchantName;
  final double amount;
  final String? originalCategory;
  final String userCorrectedCategory;

  CategoryLearningData({
    required super.id,
    required super.timestamp,
    required super.userId,
    required this.merchantName,
    required this.amount,
    this.originalCategory,
    required this.userCorrectedCategory,
  }) : super(
    features: {
      'merchant': merchantName,
      'amount': amount,
    },
    label: userCorrectedCategory,
    source: LearningDataSource.userExplicitFeedback,
  );

  @override
  Map<String, dynamic> toStorable() => {
    'id': id,
    'timestamp': timestamp.toIso8601String(),
    'user_id': userId,
    'merchant_name': merchantName,
    'amount': amount,
    'original_category': originalCategory,
    'user_corrected_category': userCorrectedCategory,
  };

  @override
  LearningData anonymize() => CategoryLearningData(
    id: id,
    timestamp: timestamp,
    userId: CollaborativeLearningAnonymizer.anonymize({'user_id': userId})['user_id'],
    merchantName: CollaborativeLearningAnonymizer.anonymize({'merchant_name': merchantName})['merchant_name'],
    amount: amount,
    originalCategory: originalCategory,
    userCorrectedCategory: userCorrectedCategory,
  );
}

/// åˆ†ç±»è§„åˆ™
class CategoryRule extends LearnedRule {
  final String merchantPattern;
  final String categoryId;

  CategoryRule({
    required super.ruleId,
    required this.merchantPattern,
    required this.categoryId,
    required super.confidence,
    required super.source,
  }) : super(
    moduleId: 'smart_category',
    priority: source == RuleSource.userLearned ? 100 : 50,
    createdAt: DateTime.now(),
    lastUsedAt: DateTime.now(),
  );

  @override
  bool matches(dynamic input) {
    final transaction = input as TransactionInput;
    return transaction.merchantName.contains(merchantPattern);
  }

  @override
  dynamic apply(dynamic input) => categoryId;
}
```

#### 17.3.2 é¢„ç®—å»ºè®®å­¦ä¹ é€‚é…å™¨

```dart
/// é¢„ç®—å»ºè®®å­¦ä¹ é€‚é…å™¨
class BudgetLearningAdapter extends ISelfLearningModule<BudgetLearningData, BudgetRule> {
  @override
  String get moduleId => 'budget_suggestion';

  @override
  String get moduleName => 'é¢„ç®—å»ºè®®';

  // ... ç±»ä¼¼å®ç°ï¼Œé’ˆå¯¹é¢„ç®—åœºæ™¯å®šåˆ¶
}
```

#### 17.3.3 å¼‚å¸¸æ£€æµ‹å­¦ä¹ é€‚é…å™¨

```dart
/// å¼‚å¸¸æ£€æµ‹å­¦ä¹ é€‚é…å™¨
class AnomalyLearningAdapter extends ISelfLearningModule<AnomalyLearningData, AnomalyRule> {
  @override
  String get moduleId => 'anomaly_detection';

  @override
  String get moduleName => 'å¼‚å¸¸æ£€æµ‹';

  // ... ç±»ä¼¼å®ç°ï¼Œé’ˆå¯¹å¼‚å¸¸æ£€æµ‹åœºæ™¯å®šåˆ¶
}
```

#### 17.3.4 æ„å›¾è¯†åˆ«å­¦ä¹ é€‚é…å™¨

```dart
/// æ„å›¾è¯†åˆ«å­¦ä¹ é€‚é…å™¨
class IntentLearningAdapter extends ISelfLearningModule<IntentLearningData, IntentRule> {
  @override
  String get moduleId => 'voice_intent';

  @override
  String get moduleName => 'è¯­éŸ³æ„å›¾è¯†åˆ«';

  // ... ç±»ä¼¼å®ç°ï¼Œé’ˆå¯¹è¯­éŸ³æ„å›¾åœºæ™¯å®šåˆ¶
  // è¯¦è§ç¬¬17ç« è¯­éŸ³äº¤äº’ç³»ç»Ÿ
}
```

### 17.4 å­¦ä¹ æ•ˆæœç›‘æ§ä¸æŠ¥å‘Š

#### 17.4.1 å­¦ä¹ æ•ˆæœä»ªè¡¨ç›˜

```dart
/// å­¦ä¹ æ•ˆæœä»ªè¡¨ç›˜æ•°æ®
class LearningDashboardData {
  final DateTime generatedAt;
  final OverallLearningStats overall;
  final List<ModuleLearningStats> modules;
  final List<LearningTrendPoint> accuracyTrend;
  final List<TopLearnedRule> topRules;

  LearningDashboardData({
    required this.generatedAt,
    required this.overall,
    required this.modules,
    required this.accuracyTrend,
    required this.topRules,
  });
}

/// æ•´ä½“å­¦ä¹ ç»Ÿè®¡
class OverallLearningStats {
  final int totalRules;
  final int totalSamples;
  final double overallAccuracy;
  final double accuracyImprovement;  // ç›¸æ¯”åˆå§‹çŠ¶æ€çš„æå‡
  final int daysActive;

  OverallLearningStats({
    required this.totalRules,
    required this.totalSamples,
    required this.overallAccuracy,
    required this.accuracyImprovement,
    required this.daysActive,
  });
}

/// æ¨¡å—å­¦ä¹ ç»Ÿè®¡
class ModuleLearningStats {
  final String moduleId;
  final String moduleName;
  final LearningStage stage;
  final int ruleCount;
  final double accuracy;
  final double weeklyImprovement;

  ModuleLearningStats({
    required this.moduleId,
    required this.moduleName,
    required this.stage,
    required this.ruleCount,
    required this.accuracy,
    required this.weeklyImprovement,
  });
}

/// å­¦ä¹ æ•ˆæœä»ªè¡¨ç›˜æœåŠ¡
class LearningDashboardService {
  final UnifiedSelfLearningService _learningService;
  final LearningMetricsStorage _metricsStorage;

  LearningDashboardService(this._learningService, this._metricsStorage);

  Future<LearningDashboardData> getDashboardData() async {
    final report = await _learningService.getOverallReport();
    final historicalMetrics = await _metricsStorage.getHistoricalMetrics(days: 30);

    return LearningDashboardData(
      generatedAt: DateTime.now(),
      overall: _buildOverallStats(report, historicalMetrics),
      modules: await _buildModuleStats(report),
      accuracyTrend: _buildAccuracyTrend(historicalMetrics),
      topRules: await _getTopRules(),
    );
  }

  OverallLearningStats _buildOverallStats(
    LearningEffectReport report,
    List<HistoricalMetrics> history,
  ) {
    final initialAccuracy = history.isNotEmpty ? history.first.accuracy : 0.0;

    return OverallLearningStats(
      totalRules: report.totalRules,
      totalSamples: report.totalSamples,
      overallAccuracy: report.overallAccuracy,
      accuracyImprovement: report.overallAccuracy - initialAccuracy,
      daysActive: history.length,
    );
  }

  Future<List<ModuleLearningStats>> _buildModuleStats(LearningEffectReport report) async {
    final stats = <ModuleLearningStats>[];

    for (final entry in report.moduleMetrics.entries) {
      final module = _learningService.getModule(entry.key);
      if (module == null) continue;

      final status = await module.getStatus();
      final weeklyMetrics = await _metricsStorage.getModuleMetrics(
        entry.key,
        days: 7,
      );

      final weeklyImprovement = weeklyMetrics.length >= 2
          ? weeklyMetrics.last.accuracy - weeklyMetrics.first.accuracy
          : 0.0;

      stats.add(ModuleLearningStats(
        moduleId: entry.key,
        moduleName: module.moduleName,
        stage: status.stage,
        ruleCount: entry.value.totalRules,
        accuracy: entry.value.accuracy,
        weeklyImprovement: weeklyImprovement,
      ));
    }

    return stats;
  }

  List<LearningTrendPoint> _buildAccuracyTrend(List<HistoricalMetrics> history) {
    return history.map((h) => LearningTrendPoint(
      date: h.date,
      accuracy: h.accuracy,
    )).toList();
  }

  Future<List<TopLearnedRule>> _getTopRules() async {
    // è·å–å‘½ä¸­ç‡æœ€é«˜çš„è§„åˆ™
    final allRules = <LearnedRule>[];
    final allStatus = await _learningService.getAllModuleStatus();

    for (final moduleId in allStatus.keys) {
      final module = _learningService.getModule(moduleId);
      if (module == null) continue;

      final rules = await module.getRules(limit: 10);
      allRules.addAll(rules);
    }

    // æŒ‰å‘½ä¸­æ¬¡æ•°æ’åº
    allRules.sort((a, b) => b.hitCount.compareTo(a.hitCount));

    return allRules.take(10).map((r) => TopLearnedRule(
      moduleId: r.moduleId,
      ruleId: r.ruleId,
      hitCount: r.hitCount,
      confidence: r.confidence,
    )).toList();
  }
}
```

### 17.5 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 17.5.1 é›†æˆæ¥å£å®šä¹‰

```dart
/// è‡ªå­¦ä¹ ç³»ç»Ÿå¯¹å¤–æš´éœ²çš„ç»Ÿä¸€æ¥å£
abstract class SelfLearningFacade {
  /// è®°å½•ç”¨æˆ·åé¦ˆ
  Future<void> recordFeedback(FeedbackType type, Map<String, dynamic> data);

  /// è·å–å­¦ä¹ å»ºè®®
  Future<LearningSuggestion?> getSuggestion(String context, Map<String, dynamic> input);

  /// è·å–å­¦ä¹ çŠ¶æ€æ‘˜è¦
  Future<LearningSummary> getSummary();

  /// æ‰‹åŠ¨è§¦å‘è®­ç»ƒ
  Future<void> triggerTraining(String? moduleId);
}

/// åé¦ˆç±»å‹
enum FeedbackType {
  categoryCorrection,     // åˆ†ç±»ä¿®æ­£
  budgetAdjustment,       // é¢„ç®—è°ƒæ•´
  anomalyDismiss,         // å¼‚å¸¸æ¶ˆé™¤
  intentCorrection,       // æ„å›¾ä¿®æ­£
  searchRefinement,       // æœç´¢ä¼˜åŒ–
}

/// è‡ªå­¦ä¹ ç³»ç»Ÿé—¨é¢å®ç°
class SelfLearningFacadeImpl implements SelfLearningFacade {
  final UnifiedSelfLearningService _service;

  SelfLearningFacadeImpl(this._service);

  @override
  Future<void> recordFeedback(FeedbackType type, Map<String, dynamic> data) async {
    final moduleId = _getModuleIdForFeedback(type);
    final module = _service.getModule(moduleId);

    if (module != null) {
      final learningData = _convertToLearningData(type, data);
      await module.collectSample(learningData);
    }
  }

  String _getModuleIdForFeedback(FeedbackType type) {
    switch (type) {
      case FeedbackType.categoryCorrection:
        return 'smart_category';
      case FeedbackType.budgetAdjustment:
        return 'budget_suggestion';
      case FeedbackType.anomalyDismiss:
        return 'anomaly_detection';
      case FeedbackType.intentCorrection:
        return 'voice_intent';
      case FeedbackType.searchRefinement:
        return 'natural_language_search';
    }
  }

  // ... å…¶ä»–å®ç°
}
```

#### 17.5.2 å„ç³»ç»Ÿé›†æˆç¤ºä¾‹

```dart
/// æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿé›†æˆç¤ºä¾‹
class SmartCategoryService {
  final SelfLearningFacade _learningFacade;

  SmartCategoryService(this._learningFacade);

  /// ç”¨æˆ·ä¿®æ­£åˆ†ç±»æ—¶è°ƒç”¨
  Future<void> onUserCorrectedCategory(
    Transaction transaction,
    String newCategoryId,
  ) async {
    // è®°å½•åˆ°è‡ªå­¦ä¹ ç³»ç»Ÿ
    await _learningFacade.recordFeedback(
      FeedbackType.categoryCorrection,
      {
        'transaction_id': transaction.id,
        'merchant_name': transaction.merchantName,
        'amount': transaction.amount,
        'original_category': transaction.categoryId,
        'corrected_category': newCategoryId,
      },
    );
  }
}

/// è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆç¤ºä¾‹
class VoiceInteractionService {
  final SelfLearningFacade _learningFacade;

  VoiceInteractionService(this._learningFacade);

  /// ç”¨æˆ·ä¿®æ­£æ„å›¾æ—¶è°ƒç”¨
  Future<void> onUserCorrectedIntent(
    String voiceText,
    VoiceIntentType originalIntent,
    VoiceIntentType correctedIntent,
  ) async {
    await _learningFacade.recordFeedback(
      FeedbackType.intentCorrection,
      {
        'voice_text': voiceText,
        'original_intent': originalIntent.name,
        'corrected_intent': correctedIntent.name,
      },
    );
  }
}
```

### 17.6 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// è‡ªå­¦ä¹ ç³»ç»Ÿç›®æ ‡æ£€æµ‹æœåŠ¡
class SelfLearningGoalChecker implements GoalChecker {
  final UnifiedSelfLearningService _service;

  @override
  String get goalId => 'self_learning_effectiveness';

  @override
  Future<GoalCheckResult> check() async {
    final report = await _service.getOverallReport();
    final checks = <GoalCheckItem>[];

    // æ£€æŸ¥æ•´ä½“å‡†ç¡®ç‡
    checks.add(GoalCheckItem(
      name: 'æ•´ä½“å­¦ä¹ å‡†ç¡®ç‡',
      target: '>= 80%',
      actual: '${(report.overallAccuracy * 100).toStringAsFixed(1)}%',
      passed: report.overallAccuracy >= 0.8,
    ));

    // æ£€æŸ¥è§„åˆ™ç”Ÿæˆæ•°é‡
    checks.add(GoalCheckItem(
      name: 'å·²å­¦ä¹ è§„åˆ™æ•°',
      target: '>= 50',
      actual: '${report.totalRules}',
      passed: report.totalRules >= 50,
    ));

    // æ£€æŸ¥å„æ¨¡å—çŠ¶æ€
    for (final entry in report.moduleMetrics.entries) {
      checks.add(GoalCheckItem(
        name: '${entry.key}æ¨¡å—å‡†ç¡®ç‡',
        target: '>= 75%',
        actual: '${(entry.value.accuracy * 100).toStringAsFixed(1)}%',
        passed: entry.value.accuracy >= 0.75,
      ));
    }

    return GoalCheckResult(
      goalId: goalId,
      passed: checks.every((c) => c.passed),
      items: checks,
      checkedAt: DateTime.now(),
    );
  }
}
```



## 18. æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ

### 18.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« å®šä¹‰AIè®°è´¦åº”ç”¨çš„æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿæ¶æ„ã€‚è¯¥ç³»ç»Ÿä½œä¸º**ç‹¬ç«‹æ¨¡å—**è®¾è®¡ï¼Œæä¾›å…¨é¢çš„è¯­éŸ³äº¤äº’èƒ½åŠ›ã€‚

#### 18.0.0 æ™ºèƒ½è¯­éŸ³ç³»ç»Ÿè®¾è®¡åŸåˆ™çŸ©é˜µ

| è®¾è®¡åŸåˆ™ | åœ¨è¯­éŸ³ç³»ç»Ÿä¸­çš„ä½“ç° | å®ç°æ–¹å¼ |
|----------|-------------------|----------|
| **æ‡’äººè®¾è®¡** | è¯­éŸ³ä¼˜å…ˆï¼Œä¸€å¥è¯å®Œæˆæ“ä½œ | æ”¯æŒå¤æ‚è¯­éŸ³æŒ‡ä»¤ä¸€æ¬¡æ€§è§£ææ‰§è¡Œ |
| **ä¼™ä¼´åŒ–** | æ‹ŸäººåŒ–è¯­éŸ³åé¦ˆ | é‡‡ç”¨å‹å¥½ã€å¹½é»˜çš„è¯­éŸ³å›å¤é£æ ¼ |
| **æ¸è¿›å¼** | è¯­éŸ³èƒ½åŠ›é€æ­¥è§£é” | ä»åŸºç¡€è®°è´¦åˆ°é«˜çº§æŸ¥è¯¢é€æ­¥å¼•å¯¼ |
| **å®¹é”™æ€§** | æ¨¡ç³ŠåŒ¹é…ä¸ç¡®è®¤ | æ™ºèƒ½ç†è§£æ¨¡ç³Šè¡¨è¿°ï¼Œå…³é”®æ“ä½œäºŒæ¬¡ç¡®è®¤ |
| **å¼€æ”¾é›†æˆ** | ç»Ÿä¸€è¯­éŸ³æ¥å£ | æ‰€æœ‰åŠŸèƒ½æ¨¡å—é€šè¿‡ç»Ÿä¸€è¯­éŸ³æ¥å£æ¥å…¥ |

#### 18.0.0.1 ä¸å…¶ä»–ç³»ç»Ÿçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„å…³ç³»                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                        â”‚   17. æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ   â”‚                           â”‚
â”‚                        â”‚      ï¼ˆæœ¬ç« ï¼‰            â”‚                           â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                    â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚                     â”‚                     â”‚                   â”‚
â”‚              â–¼                     â–¼                     â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  è°ƒç”¨è‡ªå­¦ä¹ æ¥å£   â”‚  â”‚  è°ƒç”¨æ™ºèƒ½åˆ†ç±»     â”‚  â”‚  è°ƒç”¨æ•°æ®æŸ¥è¯¢     â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚              â”‚                     â”‚                     â”‚                   â”‚
â”‚              â–¼                     â–¼                     â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ 17. è‡ªå­¦ä¹ ç³»ç»Ÿ   â”‚  â”‚ 16. æ™ºèƒ½åŒ–æ–¹æ¡ˆ   â”‚  â”‚  12. æ•°æ®å¯è§†åŒ–  â”‚          â”‚
â”‚   â”‚   - æ„å›¾å­¦ä¹       â”‚  â”‚   - æ™ºèƒ½åˆ†ç±»      â”‚  â”‚   - å›¾è¡¨æ•°æ®      â”‚          â”‚
â”‚   â”‚   - è¯­éŸ³ä¹ æƒ¯      â”‚  â”‚   - é¢„ç®—å»ºè®®      â”‚  â”‚   - æŠ¥è¡¨ç”Ÿæˆ      â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚   æ¥å…¥æ–¹å¼ï¼šå„åŠŸèƒ½é€šè¿‡ VoiceCommandHandler ç»Ÿä¸€æ¥å…¥è¯­éŸ³èƒ½åŠ›                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ğŸ“š æ¨¡å—åŒ–è®¾è®¡è¯´æ˜**
>
> æœ¬ç« è¯­éŸ³ç³»ç»Ÿçš„è‡ªå­¦ä¹ èƒ½åŠ›åŸºäº**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**æä¾›çš„ç»Ÿä¸€æ¡†æ¶ã€‚
> æ„å›¾è¯†åˆ«å­¦ä¹ è¯¦è§16.3.4èŠ‚ï¼ˆæ„å›¾è¯†åˆ«å­¦ä¹ é€‚é…å™¨ï¼‰ã€‚


æœ¬èŠ‚å°†å¯¹è¯å¼è®°è´¦åŠŸèƒ½ä»15.7ç‹¬ç«‹å‡ºæ¥ï¼Œå¹¶æ‰©å±•ä¸ºå®Œæ•´çš„æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿï¼Œæ”¯æŒè¯­éŸ³è®°è´¦ã€è¯­éŸ³é…ç½®ã€è¯­éŸ³å¯¼èˆªå’Œè¯­éŸ³æŸ¥è¯¢å››å¤§æ ¸å¿ƒèƒ½åŠ›ã€‚

### 18.0 ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»Ÿ - æ¶æ„å…¨æ™¯å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                              â”‚   è¯­éŸ³è¾“å…¥å±‚       â”‚                              â”‚
â”‚                              â”‚  VoiceInputLayer  â”‚                              â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                        â”‚                                         â”‚
â”‚                                        â–¼                                         â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                        â”‚      è¯­éŸ³è¯†åˆ«æœåŠ¡(ASR)         â”‚                        â”‚
â”‚                        â”‚   æ”¯æŒï¼šè®¯é£/é˜¿é‡Œäº‘/æœ¬åœ°è¯†åˆ«    â”‚                        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                        â”‚                                         â”‚
â”‚                                        â–¼                                         â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                        â”‚      æ„å›¾è¯†åˆ«å¼•æ“              â”‚                        â”‚
â”‚                        â”‚   IntentRecognitionEngine     â”‚                        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                        â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚              â”‚               â”‚               â”‚              â”‚         â”‚
â”‚         â–¼              â–¼               â–¼               â–¼              â–¼         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ è¯­éŸ³è®°è´¦ â”‚  â”‚ è¯­éŸ³é…ç½® â”‚   â”‚ è¯­éŸ³å¯¼èˆª â”‚   â”‚ è¯­éŸ³æŸ¥è¯¢ â”‚   â”‚ é—²èŠå¯¹è¯ â”‚      â”‚
â”‚   â”‚          â”‚  â”‚          â”‚   â”‚          â”‚   â”‚          â”‚   â”‚          â”‚      â”‚
â”‚   â”‚ è®°ä¸€ç¬”   â”‚  â”‚ æ”¹è®¾ç½®   â”‚   â”‚ æ‰“å¼€é¡µé¢ â”‚   â”‚ é—®æ•°æ®   â”‚   â”‚ æ—¥å¸¸äº¤æµ â”‚      â”‚
â”‚   â”‚ å¤šç¬”è®°è´¦ â”‚  â”‚ è°ƒå‚æ•°   â”‚   â”‚ æ‰¾åŠŸèƒ½   â”‚   â”‚ çœ‹æŠ¥è¡¨   â”‚   â”‚ å¸®åŠ©å¼•å¯¼ â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚             â”‚              â”‚              â”‚              â”‚             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                        â”‚      å“åº”ç”Ÿæˆä¸æ‰§è¡Œ            â”‚                        â”‚
â”‚                        â”‚   ResponseGenerator           â”‚                        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ                                     â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è¯­éŸ³è®°è´¦     â”‚ è¯­éŸ³é…ç½®     â”‚ è¯­éŸ³å¯¼èˆª     â”‚ è¯­éŸ³æŸ¥è¯¢                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ å•ç¬”è®°è´¦     â”‚ é¢„ç®—è®¾ç½®     â”‚ é¡µé¢è·³è½¬     â”‚ æ¶ˆè´¹ç»Ÿè®¡                 â”‚   â”‚
â”‚  â”‚ å¤šç¬”æ‰¹é‡     â”‚ åˆ†ç±»ç®¡ç†     â”‚ åŠŸèƒ½æœç´¢     â”‚ é¢„ç®—æŸ¥è¯¢                 â”‚   â”‚
â”‚  â”‚ æ¨¡æ¿è°ƒç”¨     â”‚ è´¦æˆ·é…ç½®     â”‚ å¿«æ·æ“ä½œ     â”‚ é’±é¾„åˆ†æ                 â”‚   â”‚
â”‚  â”‚ æ™ºèƒ½è¡¥å…¨     â”‚ æé†’è®¾ç½®     â”‚ æ·±åº¦é“¾æ¥     â”‚ è¶‹åŠ¿é¢„æµ‹                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18.0.1 è¯­éŸ³é…ç½®é€‚é…æ€§åˆ†æ

åŸºäº1.xç‰ˆæœ¬200+é…ç½®é¡¹çš„å…¨é¢åˆ†æï¼Œå°†é…ç½®é¡¹æŒ‰è¯­éŸ³æ“ä½œé€‚é…æ€§åˆ†ä¸ºä¸‰ç±»ï¼š

##### é€‚é…æ€§è¯„ä¼°æ ‡å‡†

| è¯„ä¼°ç»´åº¦ | é«˜é€‚é… | ä¸­é€‚é… | ä¸é€‚é… |
|---------|-------|-------|-------|
| **è¡¨è¾¾è‡ªç„¶åº¦** | ä¸€å¥è¯å¯æè¿°æ¸…æ¥š | éœ€è¦è¡¥å……è¯´æ˜ | éš¾ä»¥å£å¤´è¡¨è¾¾ |
| **å‚æ•°å¤æ‚åº¦** | å•ä¸€æ•°å€¼/é€‰é¡¹ | 2-3ä¸ªå‚æ•° | å¤šå‚æ•°/å¤æ‚ç»“æ„ |
| **æ“ä½œé¢‘ç‡** | æ—¥å¸¸é«˜é¢‘ä½¿ç”¨ | å¶å°”ä½¿ç”¨ | ä¸€æ¬¡æ€§è®¾ç½® |
| **é”™è¯¯æˆæœ¬** | æ˜“æ’¤é”€/å½±å“å° | éœ€ç¡®è®¤ | ä¸å¯é€†/å½±å“å¤§ |
| **æ­§ä¹‰é£é™©** | è¡¨è¾¾æ˜ç¡®æ— æ­§ä¹‰ | å¯èƒ½æœ‰æ­§ä¹‰ | é«˜æ­§ä¹‰é£é™© |

##### ä¸€ã€é«˜åº¦é€‚é…è¯­éŸ³é…ç½®ï¼ˆæ¨èä¼˜å…ˆæ”¯æŒï¼‰

| é…ç½®ç±»åˆ« | é…ç½®é¡¹ | é€‚é…ç†ç”± | è¯­éŸ³ç¤ºä¾‹ |
|---------|-------|---------|---------|
| **é¢„ç®—è®¾ç½®** | å„åˆ†ç±»é¢„ç®—é‡‘é¢ | å•ä¸€æ•°å€¼ï¼Œè¡¨è¾¾è‡ªç„¶ | "é¤é¥®é¢„ç®—æ”¹æˆ2000" |
| | æ€»æœˆåº¦é¢„ç®— | å•ä¸€æ•°å€¼ | "æœ¬æœˆé¢„ç®—è®¾ä¸º8000" |
| | é¢„ç®—é¢„è­¦é˜ˆå€¼ | å•ä¸€ç™¾åˆ†æ¯” | "é¢„ç®—ç”¨åˆ°80%æ—¶æé†’" |
| | é¢„ç®—ç»“è½¬å¼€å…³ | å¼€å…³æ“ä½œ | "å¼€å¯é¢„ç®—ç»“è½¬" |
| **è´¦æˆ·ç®¡ç†** | é»˜è®¤è´¦æˆ·åˆ‡æ¢ | å•ä¸€é€‰æ‹© | "æŠŠå¾®ä¿¡è®¾ä¸ºé»˜è®¤è´¦æˆ·" |
| | è´¦æˆ·ä½™é¢æ ¡æ­£ | å•ä¸€æ•°å€¼ | "æ ¡æ­£æ”¯ä»˜å®ä½™é¢ä¸º1500" |
| **è´¦æœ¬ç®¡ç†** | åˆ‡æ¢å½“å‰è´¦æœ¬ | å•ä¸€é€‰æ‹© | "åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬" |
| | è®¾ä¸ºé»˜è®¤è´¦æœ¬ | å•ä¸€é€‰æ‹© | "æŠŠä¸ªäººè´¦æœ¬è®¾ä¸ºé»˜è®¤" |
| **æé†’è®¾ç½®** | è®°è´¦æé†’æ—¶é—´ | å•ä¸€æ—¶é—´ | "æ¯å¤©æ™šä¸Š8ç‚¹æé†’è®°è´¦" |
| | æé†’å¼€å…³ | å¼€å…³æ“ä½œ | "å…³é—­è®°è´¦æé†’" |
| | è¿˜æ¬¾æé†’æå‰å¤©æ•° | å•ä¸€æ•°å€¼ | "è¿˜æ¬¾æå‰3å¤©æé†’" |
| **å¤–è§‚è®¾ç½®** | æ·±è‰²/æµ…è‰²æ¨¡å¼ | äºŒé€‰ä¸€ | "åˆ‡æ¢æ·±è‰²æ¨¡å¼" |
| | ä¸»é¢˜è‰²åˆ‡æ¢ | æœ‰é™é€‰é¡¹ | "æ¢æˆç»¿è‰²ä¸»é¢˜" |
| **å›½é™…åŒ–** | è¯­è¨€åˆ‡æ¢ | æœ‰é™é€‰é¡¹(5ç§) | "åˆ‡æ¢åˆ°è‹±æ–‡" |
| | è´§å¸åˆ‡æ¢ | æœ‰é™é€‰é¡¹(8ç§) | "é»˜è®¤è´§å¸æ”¹æˆç¾å…ƒ" |
| **AIè®¾ç½®** | æ™ºèƒ½åˆ†ç±»å¼€å…³ | å¼€å…³æ“ä½œ | "å…³é—­æ™ºèƒ½åˆ†ç±»" |
| | è¯­éŸ³æ’­æŠ¥å¼€å…³ | å¼€å…³æ“ä½œ | "å¼€å¯è¯­éŸ³æ’­æŠ¥" |
| | é‡å¤æ£€æµ‹å¼€å…³ | å¼€å…³æ“ä½œ | "å¼€å¯é‡å¤æ£€æµ‹" |
| **åŒæ­¥è®¾ç½®** | è‡ªåŠ¨åŒæ­¥å¼€å…³ | å¼€å…³æ“ä½œ | "å¼€å¯è‡ªåŠ¨åŒæ­¥" |
| | WiFiåŒæ­¥é™åˆ¶ | å¼€å…³æ“ä½œ | "åªåœ¨WiFiä¸‹åŒæ­¥" |
| **éšç§è®¾ç½®** | éšç§æ¨¡å¼å¼€å…³ | å¼€å…³æ“ä½œ | "å¼€å¯éšç§æ¨¡å¼" |
| | é‡‘é¢æ¨¡ç³Šæ˜¾ç¤º | å¼€å…³æ“ä½œ | "éšè—é‡‘é¢" |

**ç»Ÿè®¡ï¼šçº¦60é¡¹ï¼ˆ30%ï¼‰ï¼Œå»ºè®®å…¨éƒ¨æ”¯æŒè¯­éŸ³é…ç½®**

##### äºŒã€ä¸­åº¦é€‚é…è¯­éŸ³é…ç½®ï¼ˆéœ€è®¾è®¡å¤šè½®å¯¹è¯ï¼‰

| é…ç½®ç±»åˆ« | é…ç½®é¡¹ | é™åˆ¶å› ç´  | å»ºè®®æ–¹æ¡ˆ |
|---------|-------|---------|---------|
| **é¢„ç®—è®¾ç½®** | é¢„ç®—å‘¨æœŸ(å‘¨/æœˆ/å¹´) | éœ€é€‰æ‹©å‘¨æœŸç±»å‹ | å¤šè½®ç¡®è®¤ï¼š"é¢„ç®—å‘¨æœŸæ”¹æˆæŒ‰å‘¨ï¼Ÿ" |
| | é¢„ç®—èµ·å§‹æ—¥ | éœ€æŒ‡å®šæ—¥æœŸ | è¿½é—®ï¼š"ä»æ¯æœˆå‡ å·å¼€å§‹ï¼Ÿ" |
| | é›¶åŸºé¢„ç®—å¼€å…³ | æ¦‚å¿µè¾ƒä¸“ä¸š | å…ˆè§£é‡Šå†ç¡®è®¤ |
| **è´¦æˆ·ç®¡ç†** | æ·»åŠ é“¶è¡Œå¡è´¦æˆ· | éœ€å¤šä¸ªå‚æ•° | åˆ†æ­¥å¼•å¯¼ï¼šåç§°â†’åˆå§‹ä½™é¢ |
| | ä¿¡ç”¨å¡è´¦å•æ—¥ | éœ€æŒ‡å®šæ—¥æœŸ | "è´¦å•æ—¥æ”¹æˆå‡ å·ï¼Ÿ" |
| | ä¿¡ç”¨å¡è¿˜æ¬¾æ—¥ | éœ€æŒ‡å®šæ—¥æœŸ | "è¿˜æ¬¾æ—¥æ”¹æˆå‡ å·ï¼Ÿ" |
| | ä¿¡ç”¨é¢åº¦ | éœ€æŒ‡å®šé‡‘é¢ | "é¢åº¦æ˜¯å¤šå°‘ï¼Ÿ" |
| **è´¦æœ¬ç®¡ç†** | åˆ›å»ºæ–°è´¦æœ¬ | éœ€æŒ‡å®šåç§° | "è´¦æœ¬å«ä»€ä¹ˆåå­—ï¼Ÿ" |
| | é‚€è¯·æˆå‘˜ | éœ€ç”Ÿæˆé“¾æ¥ | è¯­éŸ³è§¦å‘åæ˜¾ç¤ºäºŒç»´ç  |
| **åˆ†ç±»ç®¡ç†** | æ·»åŠ åˆ†ç±» | éœ€æŒ‡å®šåç§° | "åˆ†ç±»å«ä»€ä¹ˆï¼Ÿ" |
| | æ·»åŠ å­åˆ†ç±» | éœ€æŒ‡å®šçˆ¶åˆ†ç±»+åç§° | "æ·»åŠ åˆ°å“ªä¸ªåˆ†ç±»ä¸‹ï¼Ÿ" |
| **å‚¨è“„ç›®æ ‡** | åˆ›å»ºå‚¨è“„ç›®æ ‡ | éœ€åç§°+é‡‘é¢+æ—¥æœŸ | åˆ†æ­¥å¼•å¯¼åˆ›å»º |
| | è°ƒæ•´ç›®æ ‡é‡‘é¢ | éœ€æŒ‡å®šç›®æ ‡+é‡‘é¢ | "å“ªä¸ªç›®æ ‡ï¼Ÿæ”¹æˆå¤šå°‘ï¼Ÿ" |
| **å€ºåŠ¡ç®¡ç†** | æ·»åŠ å€ºåŠ¡ | éœ€é‡‘é¢+åˆ©ç‡ | åˆ†æ­¥å¼•å¯¼ |
| **æ¨¡æ¿è®¾ç½®** | åˆ›å»ºæ¨¡æ¿ | éœ€åŸºäºç°æœ‰äº¤æ˜“ | "æŠŠåˆšæ‰é‚£ç¬”å­˜ä¸ºæ¨¡æ¿" |
| **å®šæ—¶è®°è´¦** | åˆ›å»ºå®šæ—¶è®°è´¦ | éœ€é¢‘ç‡+é‡‘é¢+åˆ†ç±» | åˆ†æ­¥å¼•å¯¼ |
| **å¤‡ä»½è®¾ç½®** | å¤‡ä»½é¢‘ç‡è®¾ç½® | æœ‰é™é€‰é¡¹ | "æ¯å¤©/æ¯å‘¨/æ¯æœˆå¤‡ä»½ï¼Ÿ" |
| | å¤‡ä»½ä¿ç•™æ•°é‡ | éœ€æŒ‡å®šæ•°é‡ | "ä¿ç•™å‡ ä»½å¤‡ä»½ï¼Ÿ" |

**ç»Ÿè®¡ï¼šçº¦50é¡¹ï¼ˆ25%ï¼‰ï¼Œå»ºè®®é€šè¿‡å¤šè½®å¯¹è¯æ”¯æŒ**

##### ä¸‰ã€ä¸é€‚é…è¯­éŸ³é…ç½®ï¼ˆä¿æŒå›¾å½¢ç•Œé¢ï¼‰

| é…ç½®ç±»åˆ« | é…ç½®é¡¹ | ä¸é€‚é…ç†ç”± | å»ºè®®æ–¹æ¡ˆ |
|---------|-------|----------|---------|
| **è´¦æˆ·ç®¡ç†** | è´¦æˆ·å›¾æ ‡é€‰æ‹© | éœ€è§†è§‰æµè§ˆé€‰æ‹© | è¯­éŸ³æ‰“å¼€é¡µé¢ï¼Œæ‰‹åŠ¨é€‰æ‹© |
| | è´¦æˆ·é¢œè‰²è®¾ç½® | é¢œè‰²éš¾ä»¥å£å¤´æè¿° | åŒä¸Š |
| | è´¦æˆ·æ’åºè°ƒæ•´ | éœ€æ‹–æ‹½äº¤äº’ | åŒä¸Š |
| **åˆ†ç±»ç®¡ç†** | åˆ†ç±»å›¾æ ‡è®¾ç½® | éœ€è§†è§‰é€‰æ‹© | è¯­éŸ³æ‰“å¼€é¡µé¢ |
| | åˆ†ç±»é¢œè‰²è®¾ç½® | é¢œè‰²éš¾ä»¥æè¿° | åŒä¸Š |
| | åˆ†ç±»æ’åºè°ƒæ•´ | éœ€æ‹–æ‹½äº¤äº’ | åŒä¸Š |
| | æ ‡ç­¾é¢œè‰²è®¾ç½® | é¢œè‰²éš¾ä»¥æè¿° | åŒä¸Š |
| **é¦–é¡µå¸ƒå±€** | å¡ç‰‡æ’åºè°ƒæ•´ | éœ€æ‹–æ‹½äº¤äº’ | è¯­éŸ³æ‰“å¼€è®¾ç½®é¡µ |
| | å¡ç‰‡æ˜¾ç¤º/éšè— | å¤šä¸ªé€‰é¡¹ç»„åˆ | å¯æ”¯æŒå•ä¸ªï¼š"éšè—é¢„ç®—å¡ç‰‡" |
| | åº•éƒ¨å¯¼èˆªé…ç½® | å¤šé€‰é¡¹ç»„åˆ | è¯­éŸ³æ‰“å¼€è®¾ç½®é¡µ |
| **å¤–è§‚è®¾ç½®** | è‡ªå®šä¹‰ä¸»é¢˜è‰² | éœ€é¢œè‰²é€‰æ‹©å™¨ | è¯­éŸ³æ‰“å¼€è®¾ç½®é¡µ |
| | å­—ä½“å¤§å°è°ƒæ•´ | éœ€å®æ—¶é¢„è§ˆ | è¯­éŸ³æ‰“å¼€è®¾ç½®é¡µ |
| **å®‰å…¨è®¾ç½®** | PINç è®¾ç½® | éœ€é”®ç›˜è¾“å…¥ | è¯­éŸ³æ‰“å¼€åæ‰‹åŠ¨è¾“å…¥ |
| | æŒ‡çº¹/é¢å®¹å½•å…¥ | éœ€ç”Ÿç‰©ç‰¹å¾é‡‡é›† | è¯­éŸ³æ‰“å¼€åç³»ç»Ÿå¼•å¯¼ |
| | è‡ªåŠ¨é”å®šæ—¶é—´ | å¤šé€‰é¡¹ï¼Œä¸å¸¸ç”¨ | è¯­éŸ³æ‰“å¼€è®¾ç½®é¡µ |
| **ç½‘ç»œè®¾ç½®** | è¿æ¥è¶…æ—¶æ—¶é—´ | æŠ€æœ¯å‚æ•°ï¼Œä¸å¸¸ç”¨ | ä¿æŒå›¾å½¢ç•Œé¢ |
| | æ¥æ”¶è¶…æ—¶æ—¶é—´ | æŠ€æœ¯å‚æ•° | åŒä¸Š |
| | é‡è¯•æ¬¡æ•° | æŠ€æœ¯å‚æ•° | åŒä¸Š |
| | ä»£ç†è®¾ç½® | éœ€è¾“å…¥åœ°å€ç«¯å£ | åŒä¸Š |
| **æ•°æ®è®¾ç½®** | æ•°æ®ä¿ç•™æœŸé™ | ä¸“ä¸šè®¾ç½®ï¼Œä¸å¸¸ç”¨ | ä¿æŒå›¾å½¢ç•Œé¢ |
| | å›¾ç‰‡è´¨é‡è®¾ç½® | éœ€é¢„è§ˆå¯¹æ¯” | åŒä¸Š |
| | å¯¼å‡ºæ ¼å¼é€‰æ‹© | å¤šé€‰é¡¹ï¼Œä¸å¸¸ç”¨ | åŒä¸Š |
| **æˆå‘˜æƒé™** | è¯¦ç»†æƒé™é…ç½® | å¤šç»´åº¦ç»„åˆ | è¯­éŸ³æ‰“å¼€é¡µé¢ |
| **å•†æˆ·ç»‘å®š** | å•†æˆ·â†’åˆ†ç±»ç»‘å®š | éœ€é€‰æ‹©å•†æˆ·å’Œåˆ†ç±» | è¯­éŸ³è§¦å‘ï¼Œåˆ—è¡¨é€‰æ‹© |
| | å•†æˆ·â†’è´¦æˆ·ç»‘å®š | éœ€é€‰æ‹©å•†æˆ·å’Œè´¦æˆ· | åŒä¸Š |

**ç»Ÿè®¡ï¼šçº¦90é¡¹ï¼ˆ45%ï¼‰ï¼Œå»ºè®®ä¿æŒå›¾å½¢ç•Œé¢æˆ–è¯­éŸ³å¯¼èˆªåˆ°è®¾ç½®é¡µ**

##### è¯­éŸ³é…ç½®è®¾è®¡å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯­éŸ³é…ç½®æœ€ä¼˜å®ç°ç­–ç•¥                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚   é«˜é€‚é…é…ç½®     â”‚  ç›´æ¥æ‰§è¡Œ                                                  â”‚
â”‚  â”‚   (60é¡¹/30%)    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚  â”‚                 â”‚  "é¤é¥®é¢„ç®—æ”¹æˆ2000" â†’ ç›´æ¥ä¿®æ”¹ â†’ è¯­éŸ³ç¡®è®¤                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚   ä¸­é€‚é…é…ç½®     â”‚  å¤šè½®å¯¹è¯                                                  â”‚
â”‚  â”‚   (50é¡¹/25%)    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚  â”‚                 â”‚  "åˆ›å»ºå‚¨è“„ç›®æ ‡" â†’ "ç›®æ ‡åç§°ï¼Ÿ" â†’ "ç›®æ ‡é‡‘é¢ï¼Ÿ" â†’ "æˆªæ­¢æ—¥æœŸï¼Ÿ" â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚   ä¸é€‚é…é…ç½®     â”‚  è¯­éŸ³å¯¼èˆª                                                  â”‚
â”‚  â”‚   (90é¡¹/45%)    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚  â”‚                 â”‚  "è®¾ç½®è´¦æˆ·å›¾æ ‡" â†’ "å¥½çš„ï¼Œå·²æ‰“å¼€è´¦æˆ·è®¾ç½®é¡µé¢ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©"     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 18.0.2 è¯­éŸ³æ“ä½œé€‚é…æ€§åˆ†æ

åŸºäº1.xç‰ˆæœ¬åŠŸèƒ½ï¼Œå¯¹æ‰€æœ‰å¯æ‰§è¡Œæ“ä½œæŒ‰è¯­éŸ³é€‚é…æ€§åˆ†ç±»ï¼š

##### ä¸€ã€é«˜åº¦é€‚é…è¯­éŸ³æ“ä½œï¼ˆæ¨èä¼˜å…ˆæ”¯æŒï¼‰

| æ“ä½œç±»åˆ« | æ“ä½œé¡¹ | é€‚é…ç†ç”± | è¯­éŸ³ç¤ºä¾‹ |
|---------|-------|---------|---------|
| **è®°è´¦æ“ä½œ** | è¯­éŸ³è®°è´¦ | æ ¸å¿ƒåœºæ™¯ï¼Œè‡ªç„¶è¡¨è¾¾ | "èŠ±äº†35åƒåˆé¥­" |
| | å¿«é€Ÿè®°è´¦ | é«˜é¢‘æ“ä½œ | "è®°ä¸€ç¬”æ”¯å‡º" |
| | æ‰¹é‡è®°è´¦ | æ•ˆç‡æå‡æ˜æ˜¾ | "æ—©é¤15ï¼Œåˆé¤28ï¼Œæ™šé¤45" |
| **æ’¤é”€æ“ä½œ** | æ’¤é”€ä¸Šæ¬¡æ“ä½œ | å³æ—¶çº é”™ï¼Œè¡¨è¾¾ç®€å• | "æ’¤é”€" |
| | åˆ é™¤æœ€åä¸€ç¬” | é«˜é¢‘çº é”™éœ€æ±‚ | "åˆ é™¤åˆšæ‰é‚£ç¬”" |
| **åˆ‡æ¢æ“ä½œ** | åˆ‡æ¢æ·±è‰²æ¨¡å¼ | ç®€å•å¼€å…³ | "åˆ‡æ¢æ·±è‰²æ¨¡å¼" |
| | åˆ‡æ¢è¯­è¨€ | æœ‰é™é€‰é¡¹ | "åˆ‡æ¢è‹±æ–‡" |
| | åˆ‡æ¢è´§å¸ | æœ‰é™é€‰é¡¹ | "åˆ‡æ¢ç¾å…ƒ" |
| | åˆ‡æ¢è´¦æœ¬ | æœ‰é™é€‰é¡¹ | "åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬" |
| **å¼€å…³æ“ä½œ** | å¼€å¯/å…³é—­è‡ªåŠ¨åŒæ­¥ | ç®€å•å¼€å…³ | "å¼€å¯è‡ªåŠ¨åŒæ­¥" |
| | å¼€å¯/å…³é—­éšç§æ¨¡å¼ | ç®€å•å¼€å…³ | "éšè—é‡‘é¢" |
| | å¼€å¯/å…³é—­æ™ºèƒ½åˆ†ç±» | ç®€å•å¼€å…³ | "å…³é—­æ™ºèƒ½åˆ†ç±»" |
| **æ•°æ®æ“ä½œ** | ç«‹å³åŒæ­¥ | å•ä¸€æ“ä½œ | "åŒæ­¥æ•°æ®" |
| | ç«‹å³å¤‡ä»½ | å•ä¸€æ“ä½œ | "å¤‡ä»½æ•°æ®" |
| | åˆ·æ–°æ•°æ® | å•ä¸€æ“ä½œ | "åˆ·æ–°" |
| **å¿«æ·æ“ä½œ** | è¿”å›é¦–é¡µ | é«˜é¢‘å¯¼èˆª | "å›åˆ°é¦–é¡µ" |
| | æ‰“å¼€æ‰«ç  | å¿«æ·å…¥å£ | "æ‰«ä¸€æ‰«" |
| | æ‰“å¼€ç›¸æœº | å¿«æ·å…¥å£ | "æ‹ç…§è®°è´¦" |
| **ä¹ æƒ¯æ“ä½œ** | è®°è´¦æ‰“å¡ | å•ä¸€æ“ä½œ | "æ‰“å¡" |
| **æŸ¥è¯¢æ“ä½œ** | æŸ¥è¯¢æœ¬æœˆæ¶ˆè´¹ | è‡ªç„¶è¡¨è¾¾ | "è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘" |
| | æŸ¥è¯¢é¢„ç®—å‰©ä½™ | è‡ªç„¶è¡¨è¾¾ | "é¤é¥®é¢„ç®—è¿˜å‰©å¤šå°‘" |
| | æŸ¥è¯¢è´¦æˆ·ä½™é¢ | è‡ªç„¶è¡¨è¾¾ | "å¾®ä¿¡è¿˜æœ‰å¤šå°‘é’±" |
| **ç³»ç»Ÿæ“ä½œ** | æ£€æŸ¥æ›´æ–° | å•ä¸€æ“ä½œ | "æ£€æŸ¥æ›´æ–°" |

**ç»Ÿè®¡ï¼šçº¦35é¡¹ï¼Œå»ºè®®å…¨éƒ¨æ”¯æŒç›´æ¥è¯­éŸ³æ“ä½œ**

##### äºŒã€ä¸­åº¦é€‚é…è¯­éŸ³æ“ä½œï¼ˆéœ€ç¡®è®¤æˆ–å¼•å¯¼ï¼‰

| æ“ä½œç±»åˆ« | æ“ä½œé¡¹ | é™åˆ¶å› ç´  | å»ºè®®æ–¹æ¡ˆ |
|---------|-------|---------|---------|
| **è®°è´¦æ“ä½œ** | ä¿®æ”¹æœ€åä¸€ç¬” | éœ€å±•ç¤ºè¯¦æƒ… | è¯­éŸ³è§¦å‘â†’å±•ç¤ºè¯¦æƒ…â†’æ‰‹åŠ¨ä¿®æ”¹ |
| | å¤åˆ¶ä¸ºæ¨¡æ¿ | éœ€é€‰æ‹©å“ªç¬” | "æŠŠåˆšæ‰é‚£ç¬”å­˜ä¸ºæ¨¡æ¿ï¼Ÿ" |
| **é¢„ç®—æ“ä½œ** | è°ƒæ•´æŸåˆ†ç±»é¢„ç®— | éœ€æŒ‡å®šåˆ†ç±»å’Œé‡‘é¢ | å¤šè½®å¯¹è¯ |
| | é‡ç½®æœ¬æœˆé¢„ç®— | å½±å“è¾ƒå¤§ | éœ€äºŒæ¬¡ç¡®è®¤ |
| | é¢„ç®—ç»“è½¬ | éœ€ç¡®è®¤ | "ç¡®å®šè¦ç»“è½¬é¢„ç®—å—ï¼Ÿ" |
| **è´¦æˆ·æ“ä½œ** | æ ¡æ­£è´¦æˆ·ä½™é¢ | éœ€æŒ‡å®šè´¦æˆ·å’Œé‡‘é¢ | å¤šè½®å¯¹è¯ |
| | åˆ‡æ¢é»˜è®¤è´¦æˆ· | éœ€æŒ‡å®šè´¦æˆ· | "åˆ‡æ¢åˆ°å“ªä¸ªè´¦æˆ·ï¼Ÿ" |
| **æ•°æ®æ“ä½œ** | å¯¼å‡ºæœ¬æœˆæ•°æ® | éœ€ç¡®è®¤æ ¼å¼ | "å¯¼å‡ºä¸ºExcelè¿˜æ˜¯CSVï¼Ÿ" |
| | å¯¼å‡ºæœ¬å¹´æ•°æ® | æ•°æ®é‡å¤§ | æç¤ºå¤„ç†æ—¶é—´ |
| | æ¸…é™¤ç¼“å­˜ | éœ€ç¡®è®¤ | "ç¡®å®šæ¸…é™¤ç¼“å­˜å—ï¼Ÿ" |
| **åˆ†äº«æ“ä½œ** | åˆ†äº«æœˆåº¦æŠ¥å‘Š | éœ€é€‰æ‹©åˆ†äº«æ–¹å¼ | è¯­éŸ³è§¦å‘â†’å±•ç¤ºåˆ†äº«èœå• |
| | åˆ†äº«å¹´åº¦æŠ¥å‘Š | éœ€é€‰æ‹©åˆ†äº«æ–¹å¼ | åŒä¸Š |
| | é‚€è¯·å¥½å‹ | éœ€ç”Ÿæˆé“¾æ¥ | è¯­éŸ³è§¦å‘â†’å±•ç¤ºäºŒç»´ç  |
| **ç›®æ ‡æ“ä½œ** | å‘ç›®æ ‡å­˜å…¥ | éœ€æŒ‡å®šç›®æ ‡å’Œé‡‘é¢ | å¤šè½®å¯¹è¯ |
| **æé†’æ“ä½œ** | è®¾ç½®æé†’ | éœ€æŒ‡å®šæ—¶é—´ | å¤šè½®å¯¹è¯ |

**ç»Ÿè®¡ï¼šçº¦20é¡¹ï¼Œå»ºè®®é€šè¿‡ç¡®è®¤æˆ–å¤šè½®å¯¹è¯æ”¯æŒ**

##### ä¸‰ã€ä¸é€‚é…è¯­éŸ³æ“ä½œï¼ˆä¿æŒå›¾å½¢ç•Œé¢ï¼‰

| æ“ä½œç±»åˆ« | æ“ä½œé¡¹ | ä¸é€‚é…ç†ç”± | å»ºè®®æ–¹æ¡ˆ |
|---------|-------|----------|---------|
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡åˆ é™¤äº¤æ˜“ | éœ€å¤šé€‰ï¼Œé£é™©é«˜ | è¯­éŸ³æ‰“å¼€é¡µé¢ï¼Œæ‰‹åŠ¨æ“ä½œ |
| | æ‰¹é‡ä¿®æ”¹åˆ†ç±» | éœ€å¤šé€‰ | åŒä¸Š |
| | æ‰¹é‡å¯¼å…¥æ•°æ® | éœ€æ–‡ä»¶é€‰æ‹© | åŒä¸Š |
| **ç¼–è¾‘æ“ä½œ** | ç¼–è¾‘äº¤æ˜“è¯¦æƒ… | å¤šå­—æ®µä¿®æ”¹ | è¯­éŸ³æ‰“å¼€ç¼–è¾‘é¡µ |
| | ç¼–è¾‘è´¦æˆ·ä¿¡æ¯ | å¤šå­—æ®µ | åŒä¸Š |
| | ç¼–è¾‘åˆ†ç±»ä¿¡æ¯ | éœ€å›¾æ ‡é¢œè‰²é€‰æ‹© | åŒä¸Š |
| **æ’åºæ“ä½œ** | è´¦æˆ·æ’åº | éœ€æ‹–æ‹½ | ä¿æŒå›¾å½¢ç•Œé¢ |
| | åˆ†ç±»æ’åº | éœ€æ‹–æ‹½ | åŒä¸Š |
| | å¡ç‰‡æ’åº | éœ€æ‹–æ‹½ | åŒä¸Š |
| **é«˜é£é™©æ“ä½œ** | å¯¼å‡ºå…¨éƒ¨æ•°æ® | æ•°æ®é‡å¤§ï¼Œè€—æ—¶ | å»ºè®®å›¾å½¢ç•Œé¢æ“ä½œ |
| | æ¸…ç©ºå›æ”¶ç«™ | ä¸å¯é€† | å¿…é¡»å›¾å½¢ç•Œé¢+å¤šæ¬¡ç¡®è®¤ |
| | é€€å‡ºç™»å½• | éœ€ç¡®è®¤ | å¯è¯­éŸ³è§¦å‘ï¼Œå›¾å½¢ç¡®è®¤ |
| | æ³¨é”€è´¦å· | é«˜é£é™©ä¸å¯é€† | å¿…é¡»å›¾å½¢ç•Œé¢+éªŒè¯ |
| **å¤æ‚æŸ¥è¯¢** | è‡ªå®šä¹‰æŠ¥è¡¨ | éœ€å¤šæ¡ä»¶ç»„åˆ | è¯­éŸ³æ‰“å¼€é¡µé¢ |
| | å¤šç»´åº¦ç­›é€‰ | éœ€å¤šé€‰é¡¹ç»„åˆ | è¯­éŸ³æ‰“å¼€ç­›é€‰é¡µ |
| | æ—¶é—´èŒƒå›´é€‰æ‹© | éœ€æ—¥æœŸé€‰æ‹©å™¨ | è¯­éŸ³+ç®€å•è¡¨è¾¾("æœ¬æœˆ"/"ä¸Šå‘¨") |
| **æƒé™æ“ä½œ** | æˆå‘˜æƒé™è®¾ç½® | å¤šç»´åº¦é…ç½® | è¯­éŸ³æ‰“å¼€é¡µé¢ |
| | å®¡æ‰¹è®¾ç½® | å¤æ‚è§„åˆ™ | åŒä¸Š |
| **å¯¼å…¥æ“ä½œ** | æ™ºèƒ½è´¦å•å¯¼å…¥ | éœ€æ–‡ä»¶é€‰æ‹©+é¢„è§ˆ | è¯­éŸ³æ‰“å¼€é¡µé¢ |
| | æ•°æ®æ¢å¤ | éœ€é€‰æ‹©å¤‡ä»½ç‰ˆæœ¬ | åŒä¸Š |

**ç»Ÿè®¡ï¼šçº¦25é¡¹ï¼Œå»ºè®®ä¿æŒå›¾å½¢ç•Œé¢æˆ–è¯­éŸ³å¯¼èˆª**

##### è¯­éŸ³æ“ä½œè®¾è®¡å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯­éŸ³æ“ä½œæœ€ä¼˜å®ç°ç­–ç•¥                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  æ‰§è¡Œç­–ç•¥å†³ç­–æ ‘ï¼š                                                                â”‚
â”‚                                                                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                        â”‚  è¯­éŸ³æŒ‡ä»¤è¾“å…¥  â”‚                                        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                               â”‚                                                 â”‚
â”‚                               â–¼                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                    â”‚  æ˜¯å¦ä¸ºé«˜é€‚é…æ“ä½œï¼Ÿ   â”‚                                     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                      æ˜¯ â”‚           â”‚ å¦                                       â”‚
â”‚                         â–¼           â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚  ç›´æ¥æ‰§è¡Œ     â”‚  â”‚  æ˜¯å¦ä¸ºä¸­é€‚é…æ“ä½œï¼Ÿ â”‚                           â”‚
â”‚              â”‚  +è¯­éŸ³åé¦ˆ    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      æ˜¯ â”‚       â”‚ å¦                            â”‚
â”‚                                       â–¼       â–¼                                â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                          â”‚  éœ€è¦ç¡®è®¤ï¼Ÿ    â”‚  â”‚  å¯¼èˆªåˆ°é¡µé¢   â”‚                   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  +è¯­éŸ³æç¤º    â”‚                   â”‚
â”‚                            æ˜¯ â”‚   â”‚ å¦     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                               â–¼   â–¼                                            â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                   â”‚ è¯­éŸ³ç¡®è®¤  â”‚ â”‚ å¤šè½®å¯¹è¯  â”‚                                   â”‚
â”‚                   â”‚ åæ‰§è¡Œ   â”‚ â”‚ è¡¥å…¨å‚æ•°  â”‚                                   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### æ“ä½œé£é™©ç­‰çº§ä¸ç¡®è®¤ç­–ç•¥

| é£é™©ç­‰çº§ | æ“ä½œç¤ºä¾‹ | ç¡®è®¤ç­–ç•¥ | å¯æ’¤é”€ |
|---------|---------|---------|-------|
| **ä½é£é™©** | åˆ‡æ¢ä¸»é¢˜ã€åˆ·æ–°ã€æ‰“å¡ | ç›´æ¥æ‰§è¡Œ | æ˜¯ |
| **ä¸­é£é™©** | åˆ é™¤æœ€åä¸€ç¬”ã€æ¸…ç¼“å­˜ | è¯­éŸ³äºŒæ¬¡ç¡®è®¤ | æ˜¯ |
| **é«˜é£é™©** | å¯¼å‡ºå…¨éƒ¨æ•°æ®ã€é‡ç½®é¢„ç®— | è¯­éŸ³ç¡®è®¤+æŒ‰é’®ç¡®è®¤ | éƒ¨åˆ† |
| **æé«˜é£é™©** | æ¸…ç©ºå›æ”¶ç«™ã€æ³¨é”€è´¦å· | å¿…é¡»å›¾å½¢ç•Œé¢+å¯†ç éªŒè¯ | å¦ |

---

### 18.0.3 å®ç°ä¼˜å…ˆçº§å»ºè®®

##### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆMVPå¿…é¡»ï¼‰

| ç±»å‹ | æ•°é‡ | å†…å®¹ |
|-----|------|-----|
| è¯­éŸ³é…ç½® | 30é¡¹ | é¢„ç®—é‡‘é¢ã€å¼€å…³ç±»é…ç½®ã€è¯­è¨€è´§å¸åˆ‡æ¢ |
| è¯­éŸ³æ“ä½œ | 20é¡¹ | è®°è´¦ã€æ’¤é”€ã€åˆ‡æ¢ã€åŒæ­¥ã€æŸ¥è¯¢ |

##### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆä½“éªŒå¢å¼ºï¼‰

| ç±»å‹ | æ•°é‡ | å†…å®¹ |
|-----|------|-----|
| è¯­éŸ³é…ç½® | 30é¡¹ | æé†’è®¾ç½®ã€è´¦æˆ·ç®¡ç†ã€ç›®æ ‡è®¾ç½® |
| è¯­éŸ³æ“ä½œ | 15é¡¹ | åˆ†äº«ã€å¯¼å‡ºã€å¤æ‚æŸ¥è¯¢ |

##### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆå®Œæ•´è¦†ç›–ï¼‰

| ç±»å‹ | æ•°é‡ | å†…å®¹ |
|-----|------|-----|
| è¯­éŸ³é…ç½® | 50é¡¹ | ä¸­é€‚é…é…ç½®çš„å¤šè½®å¯¹è¯æ”¯æŒ |
| è¯­éŸ³æ“ä½œ | 20é¡¹ | éœ€ç¡®è®¤çš„ä¸­ç­‰é£é™©æ“ä½œ |

##### ä¸å»ºè®®æ”¯æŒï¼ˆä¿æŒå›¾å½¢ç•Œé¢ï¼‰

| ç±»å‹ | æ•°é‡ | åŸå›  |
|-----|------|-----|
| è§†è§‰é€‰æ‹©ç±» | 40é¡¹ | å›¾æ ‡ã€é¢œè‰²ã€æ’åºç­‰éœ€è§†è§‰åé¦ˆ |
| é«˜é£é™©ç±» | 10é¡¹ | æ³¨é”€ã€æ¸…ç©ºç­‰ä¸å¯é€†æ“ä½œ |
| å¤æ‚é…ç½®ç±» | 40é¡¹ | å¤šå‚æ•°ã€æŠ€æœ¯æ€§é…ç½® |

### 18.0.4 åŸå‹é¡µé¢æ¸…å•ä¸è¯­éŸ³å¯¼èˆªé€‚é…æ€§åˆ†æ

åŸºäº2.0ç‰ˆæœ¬å®Œæ•´é«˜ä¿çœŸåŸå‹ï¼ˆ119é¡µé¢ï¼‰ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç±»å¹¶åˆ†æè¯­éŸ³å¯¼èˆªé€‚é…æ€§ã€‚

##### åŸå‹é¡µé¢ç»Ÿè®¡

| æ¨¡å— | é¡µé¢æ•°é‡ | ä¸»è¦åŠŸèƒ½ |
|-----|---------|---------|
| æ ¸å¿ƒé¡µé¢ | 5ä¸ª | ä»ªè¡¨ç›˜ã€è¶‹åŠ¿ã€å¿«é€Ÿè®°è´¦ã€é¢„ç®—ã€ä¸ªäººä¸­å¿ƒ |
| é’±é¾„åˆ†æ | 8ä¸ª | é’±é¾„è¯¦æƒ…ã€è¶‹åŠ¿ã€å½±å“å› ç´ ã€FIFOèµ„æºæ± ç­‰ |
| å°é‡‘åº“ | 9ä¸ª | æ¦‚è§ˆã€è¯¦æƒ…ã€èµ„é‡‘åˆ†é…ã€åˆ›å»ºã€é›¶åŸºé¢„ç®—ç­‰ |
| è´¦æˆ·äº¤æ˜“ | 5ä¸ª | è´¦æˆ·åˆ—è¡¨ã€äº¤æ˜“åˆ—è¡¨ã€äº¤æ˜“è¯¦æƒ…ã€å€ºåŠ¡ç®¡ç†ç­‰ |
| å¯¼å…¥å¯¼å‡º | 15ä¸ª | å¯¼å…¥è´¦å•ã€å»é‡æ£€æµ‹ã€æ ¼å¼æ£€æµ‹ã€å­—æ®µæ˜ å°„ç­‰ |
| è¯­éŸ³è¯†åˆ« | 12ä¸ª | è¯­éŸ³è®°è´¦ã€å›¾ç‰‡OCRã€å¯¹è¯å†å²ã€AAåˆ†æ‘Šç­‰ |
| åˆ†ææŠ¥å‘Š | 10ä¸ª | æœˆæŠ¥ã€å¹´æŠ¥ã€æ´å¯Ÿã€é¥¼å›¾ä¸‹é’»ã€çƒ­åŠ›å›¾ç­‰ |
| ç³»ç»Ÿè®¾ç½® | 25ä¸ª | è®¾ç½®ã€ä¸»é¢˜ã€è¯­è¨€ã€è´§å¸ã€ä½ç½®ã€å®‰å…¨ç­‰ |
| æ•°æ®è”åŠ¨ | 5ä¸ª | åˆ†ç±»è¯¦æƒ…ã€æœç´¢ã€é«˜çº§ç­›é€‰ã€æ—¶é—´å¯¹æ¯”ç­‰ |
| ä¹ æƒ¯åŸ¹å…» | 7ä¸ª | è´¢åŠ¡å¥åº·ã€è®¢é˜…æµªè´¹ã€æ‹¿é“å› å­ã€åº”æ€¥é‡‘ç­‰ |
| å¼‚å¸¸å¤„ç† | 6ä¸ª | ç½‘ç»œé”™è¯¯ã€åŒæ­¥å†²çªã€å®Œæ•´æ€§æ£€æŸ¥ç­‰ |
| ç³»ç»Ÿç›‘æ§ | 6ä¸ª | æ€§èƒ½ç›‘æ§ã€ç³»ç»Ÿæ—¥å¿—ã€å‘Šè­¦å†å²ã€AIç›‘æ§ç­‰ |
| è´¦å•æé†’ | 6ä¸ª | è´¦å•åˆ—è¡¨ã€æ·»åŠ è´¦å•ã€ä¿¡ç”¨å¡æé†’ã€æ—¥å†ç­‰ |
| AIæ™ºèƒ½ä¸­å¿ƒ | 10ä¸ª | æ™ºèƒ½åˆ†ç±»ã€è¶‹åŠ¿é¢„æµ‹ã€å¼‚å¸¸æ£€æµ‹ã€å¯¹è¯åŠ©æ‰‹ç­‰ |
| **åˆè®¡** | **119ä¸ª** | |

---

##### ä¸€ã€æ ¸å¿ƒé¡µé¢ï¼ˆ5ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 1.01 | ä»ªè¡¨ç›˜ Dashboard | âœ… é«˜ | é«˜é¢‘å…¥å£ï¼Œè¡¨è¾¾ç®€å• | "æ‰“å¼€é¦–é¡µ"ã€"å›åˆ°ä¸»é¡µ" |
| 1.02 | è¶‹åŠ¿åˆ†æ Trends | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "çœ‹çœ‹è¶‹åŠ¿"ã€"æ‰“å¼€è¶‹åŠ¿åˆ†æ" |
| 1.03 | å¿«é€Ÿè®°è´¦ Quick Add | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "è®°ä¸€ç¬”"ã€"å¿«é€Ÿè®°è´¦" |
| 1.04 | é¢„ç®—ä¸­å¿ƒ Budget | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "æ‰“å¼€é¢„ç®—"ã€"çœ‹çœ‹é¢„ç®—" |
| 1.05 | ä¸ªäººä¸­å¿ƒ Profile | âœ… é«˜ | å¸¸ç”¨å…¥å£ | "æ‰“å¼€æˆ‘çš„"ã€"ä¸ªäººä¸­å¿ƒ" |

**å°ç»“ï¼š5/5 é«˜é€‚é…ï¼ˆ100%ï¼‰**

---

##### äºŒã€é’±é¾„åˆ†æï¼ˆ8ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 2.01 | é’±é¾„è¯¦æƒ… | âœ… é«˜ | æ ¸å¿ƒ2.0åŠŸèƒ½ | "çœ‹çœ‹é’±é¾„"ã€"æ‰“å¼€é’±é¾„" |
| 2.02 | é’±é¾„å‡çº§å¼•å¯¼ | âš ï¸ ä¸­ | å¼•å¯¼é¡µï¼Œå¶å°”ä½¿ç”¨ | "æ€ä¹ˆæå‡é’±é¾„" |
| 2.03 | é’±é¾„å†å²è¶‹åŠ¿ | âœ… é«˜ | æ•°æ®æŸ¥çœ‹ | "é’±é¾„è¶‹åŠ¿"ã€"é’±é¾„å†å²" |
| 2.04 | å½±å“å› ç´ åˆ†æ | âš ï¸ ä¸­ | åˆ†æé¡µé¢ | "ä»€ä¹ˆå½±å“äº†é’±é¾„" |
| 2.05 | é’±é¾„é˜¶æ®µè¿›åº¦ | âš ï¸ ä¸­ | è¯¦æƒ…é¡µ | "é’±é¾„è¿›åº¦" |
| 2.06 | å•ç¬”äº¤æ˜“é’±é¾„ | âŒ ä½ | éœ€å…ˆé€‰æ‹©äº¤æ˜“ | è¯­éŸ³æ‰“å¼€äº¤æ˜“è¯¦æƒ…åæ‰‹åŠ¨æŸ¥çœ‹ |
| 2.07 | FIFOèµ„æºæ±  | âŒ ä½ | ä¸“ä¸šé¡µé¢ï¼Œä¸å¸¸ç”¨ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 2.08 | é’±é¾„é¢„ç®—è”åŠ¨ | âš ï¸ ä¸­ | å…³è”é¡µé¢ | "é’±é¾„å’Œé¢„ç®—å…³ç³»" |

**å°ç»“ï¼š2é«˜/4ä¸­/2ä½**

---

##### ä¸‰ã€å°é‡‘åº“ï¼ˆ9ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 3.01 | å°é‡‘åº“æ¦‚è§ˆ | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½å…¥å£ | "æ‰“å¼€å°é‡‘åº“"ã€"çœ‹çœ‹å°é‡‘åº“" |
| 3.02 | å°é‡‘åº“è¯¦æƒ… | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "XXå°é‡‘åº“è¯¦æƒ…" |
| 3.03 | èµ„é‡‘åˆ†é… | âš ï¸ ä¸­ | éœ€è¦æ“ä½œ | "åˆ†é…èµ„é‡‘" |
| 3.04 | åˆ›å»ºå°é‡‘åº“ | âš ï¸ ä¸­ | å¤šè½®å¯¹è¯ | "åˆ›å»ºä¸€ä¸ªæ—…æ¸¸å°é‡‘åº“" |
| 3.05 | æ™ºèƒ½åˆ†é…å»ºè®® | âœ… é«˜ | å»ºè®®æŸ¥çœ‹ | "æ™ºèƒ½åˆ†é…å»ºè®®" |
| 3.06 | çŠ¶æ€è­¦å‘Š | âš ï¸ ä¸­ | ç³»ç»Ÿè§¦å‘ä¸ºä¸» | "å°é‡‘åº“æœ‰ä»€ä¹ˆè­¦å‘Š" |
| 3.07 | é¢„ç®—é’±é¾„è”åŠ¨ | âš ï¸ ä¸­ | å…³è”é¡µé¢ | "é¢„ç®—å’Œé’±é¾„è”åŠ¨" |
| 3.08 | æ¶ˆè´¹æ‹¦æˆª | âŒ ä½ | ç³»ç»Ÿå¼¹çª—ï¼Œéä¸»åŠ¨æ‰“å¼€ | ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ |
| 3.09 | é›¶åŸºé¢„ç®—åˆ†é… | âš ï¸ ä¸­ | é¢„ç®—å·¥å…· | "é›¶åŸºé¢„ç®—" |

**å°ç»“ï¼š3é«˜/5ä¸­/1ä½**

---

##### å››ã€è´¦æˆ·äº¤æ˜“ï¼ˆ5ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 4.01 | è´¦æˆ·åˆ—è¡¨ | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "æ‰“å¼€è´¦æˆ·"ã€"çœ‹çœ‹è´¦æˆ·" |
| 4.02 | äº¤æ˜“åˆ—è¡¨ | âœ… é«˜ | æ ¸å¿ƒæŸ¥çœ‹ | "çœ‹çœ‹è´¦å•"ã€"äº¤æ˜“è®°å½•" |
| 4.03 | äº¤æ˜“è¯¦æƒ… | âš ï¸ ä¸­ | éœ€å…ˆé€‰æ‹©äº¤æ˜“ | "åˆšæ‰é‚£ç¬”è¯¦æƒ…" |
| 4.04 | æ‰‹åŠ¨è®°è´¦è¯¦æƒ… | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "æ‰‹åŠ¨è®°è´¦" |
| 4.05 | å€ºåŠ¡ç®¡ç† | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "å€ºåŠ¡ç®¡ç†"ã€"çœ‹çœ‹æ¬ æ¬¾" |

**å°ç»“ï¼š4é«˜/1ä¸­**

---

##### äº”ã€å¯¼å…¥å¯¼å‡ºï¼ˆ15ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 5.01 | å¯¼å…¥è´¦å• | âš ï¸ ä¸­ | éœ€æ–‡ä»¶é€‰æ‹© | "å¯¼å…¥è´¦å•" |
| 5.02 | å»é‡æ£€æµ‹ | âŒ ä½ | æµç¨‹ä¸­é—´é¡µ | å¯¼å…¥æµç¨‹è‡ªåŠ¨è¿›å…¥ |
| 5.03 | äº¤æ˜“å¯¹æ¯” | âŒ ä½ | éœ€é€‰æ‹©äº¤æ˜“ | å»é‡æµç¨‹ä¸­ä½¿ç”¨ |
| 5.04 | å¯¼å‡ºè´¦å• | âš ï¸ ä¸­ | å¸¸ç”¨åŠŸèƒ½ | "å¯¼å‡ºè´¦å•"ã€"å¯¼å‡ºæœ¬æœˆæ•°æ®" |
| 5.05 | PDFå¯¼å‡ºé¢„è§ˆ | âŒ ä½ | å¯¼å‡ºæµç¨‹é¡µ | å¯¼å‡ºæ—¶è‡ªåŠ¨è¿›å…¥ |
| 5.06 | é“¶è¡Œè´¦å•å¯¼å…¥ | âš ï¸ ä¸­ | éœ€æ–‡ä»¶æ“ä½œ | "å¯¼å…¥é“¶è¡Œè´¦å•" |
| 5.07 | æ‰¹é‡ç¼–è¾‘ | âŒ ä½ | éœ€å¤šé€‰æ“ä½œ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 5.08 | å¯¼å…¥å†å² | âš ï¸ ä¸­ | æŸ¥çœ‹è®°å½• | "å¯¼å…¥å†å²" |
| 5.09 | æ™ºèƒ½æ ¼å¼æ£€æµ‹ | âŒ ä½ | æµç¨‹è‡ªåŠ¨é¡µ | å¯¼å…¥æ—¶è‡ªåŠ¨è¿›å…¥ |
| 5.10 | å­—æ®µæ˜ å°„é…ç½® | âŒ ä½ | å¤æ‚é…ç½® | ä¿æŒå›¾å½¢ç•Œé¢ |
| 5.11 | ä¸‰å±‚å»é‡è¯¦æƒ… | âŒ ä½ | æŠ€æœ¯è¯¦æƒ…é¡µ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 5.12 | å¯¼å…¥é¢„è§ˆç¡®è®¤ | âŒ ä½ | æµç¨‹ç¡®è®¤é¡µ | å¯¼å…¥æ—¶è‡ªåŠ¨è¿›å…¥ |
| 5.13 | å¯¼å…¥è¿›åº¦ | âŒ ä½ | è¿›åº¦å±•ç¤º | ç³»ç»Ÿè‡ªåŠ¨å±•ç¤º |
| 5.14 | å¯¼å‡ºé«˜çº§é…ç½® | âŒ ä½ | å¤æ‚é…ç½® | ä¿æŒå›¾å½¢ç•Œé¢ |
| 5.15 | å¯¼å…¥æˆåŠŸ | âŒ ä½ | ç»“æœé¡µ | ç³»ç»Ÿè‡ªåŠ¨å±•ç¤º |

**å°ç»“ï¼š0é«˜/4ä¸­/11ä½**

---

##### å…­ã€è¯­éŸ³è¯†åˆ«ï¼ˆ12ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 6.01 | å‡†å¤‡å½•éŸ³ | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "è¯­éŸ³è®°è´¦" |
| 6.02 | å½•éŸ³ä¸­ | âœ… é«˜ | è¯­éŸ³è§¦å‘ | è‡ªç„¶è¯­éŸ³è¾“å…¥ |
| 6.03 | è¯†åˆ«ç»“æœ | âœ… é«˜ | è¯­éŸ³ç¡®è®¤ | "ç¡®è®¤"ã€"å–æ¶ˆ" |
| 6.04 | å¤šæ¡äº¤æ˜“è¯†åˆ« | âœ… é«˜ | æ‰¹é‡ç¡®è®¤ | "éƒ½è®°ä¸Š" |
| 6.05 | å›¾ç‰‡OCRè¯†åˆ« | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "æ‹ç…§è®°è´¦" |
| 6.06 | å¯¹è¯å†å² | âš ï¸ ä¸­ | æŸ¥çœ‹è®°å½• | "å¯¹è¯å†å²" |
| 6.07 | å°ç¥¨å•†å“æ˜ç»† | âŒ ä½ | è¯†åˆ«è¯¦æƒ… | è¯†åˆ«åè‡ªåŠ¨å±•ç¤º |
| 6.08 | æ”¯ä»˜æˆªå›¾è¯†åˆ« | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "è¯†åˆ«æˆªå›¾" |
| 6.09 | AAåˆ¶åˆ†æ‘Šç¡®è®¤ | âš ï¸ ä¸­ | éœ€é€‰æ‹©æˆå‘˜ | "AAåˆ†æ‘Š" |
| 6.10 | ä½ç½®ä¿¡åº¦ç¡®è®¤ | âš ï¸ ä¸­ | ç³»ç»Ÿè§¦å‘ | è¯­éŸ³"ç¡®è®¤"æˆ–"ä¿®æ”¹" |
| 6.11 | ç¦»çº¿æ¨¡å¼æç¤º | âŒ ä½ | ç³»ç»Ÿæç¤º | ç³»ç»Ÿè‡ªåŠ¨å±•ç¤º |
| 6.12 | è¿ç»­å¯¹è¯è®°è´¦ | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | è¿ç»­è¯­éŸ³è¾“å…¥ |

**å°ç»“ï¼š7é«˜/3ä¸­/2ä½**

---

##### ä¸ƒã€åˆ†ææŠ¥å‘Šï¼ˆ10ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 7.01 | æœˆåº¦æŠ¥å‘Š | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "æœˆåº¦æŠ¥å‘Š"ã€"æœ¬æœˆæŠ¥å‘Š" |
| 7.02 | æ´å¯Ÿåˆ†æ | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "æ¶ˆè´¹æ´å¯Ÿ"ã€"åˆ†æ" |
| 7.03 | å¹´åº¦æ€»ç»“ | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "å¹´åº¦æŠ¥å‘Š"ã€"å¹´åº¦æ€»ç»“" |
| 7.04 | é¢„ç®—æŠ¥å‘Š | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "é¢„ç®—æŠ¥å‘Š" |
| 7.05 | åˆ†ç±»é¥¼å›¾ä¸‹é’» | âš ï¸ ä¸­ | ç‚¹å‡»è§¦å‘ | "é¤é¥®èŠ±äº†å¤šå°‘" |
| 7.06 | è¶‹åŠ¿å›¾ä¸‹é’» | âš ï¸ ä¸­ | ç‚¹å‡»è§¦å‘ | "ä¸Šæœˆå¯¹æ¯”" |
| 7.07 | æ¶ˆè´¹çƒ­åŠ›å›¾ | âš ï¸ ä¸­ | æŸ¥çœ‹åˆ†æ | "æ¶ˆè´¹çƒ­åŠ›å›¾" |
| 7.08 | ä¸‹é’»å¯¼èˆª | âŒ ä½ | å¯¼èˆªä¸­é—´é¡µ | ç‚¹å‡»è§¦å‘ |
| 7.09 | æ•°æ®ç­›é€‰ | âš ï¸ ä¸­ | éœ€å¤šé€‰ | "ç­›é€‰é¤é¥®" |
| 7.10 | å›¾è¡¨åˆ†äº« | âš ï¸ ä¸­ | éœ€é€‰æ‹©æ–¹å¼ | "åˆ†äº«æŠ¥å‘Š" |

**å°ç»“ï¼š4é«˜/5ä¸­/1ä½**

---

##### å…«ã€ç³»ç»Ÿè®¾ç½®ï¼ˆ25ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 8.01 | ç³»ç»Ÿè®¾ç½® | âœ… é«˜ | å…¥å£é¡µé¢ | "æ‰“å¼€è®¾ç½®" |
| 8.02 | ä¸»é¢˜è®¾ç½® | âœ… é«˜ | å¸¸ç”¨è®¾ç½® | "ä¸»é¢˜è®¾ç½®"ã€"æ¢ä¸»é¢˜" |
| 8.03 | è¯­è¨€è®¾ç½® | âœ… é«˜ | å¸¸ç”¨è®¾ç½® | "è¯­è¨€è®¾ç½®"ã€"æ¢è¯­è¨€" |
| 8.04 | è´§å¸è®¾ç½® | âœ… é«˜ | å¸¸ç”¨è®¾ç½® | "è´§å¸è®¾ç½®" |
| 8.05 | åŒºåŸŸè®¾ç½® | âš ï¸ ä¸­ | å¶å°”ä½¿ç”¨ | "åŒºåŸŸè®¾ç½®" |
| 8.06 | AIè¯­è¨€è®¾ç½® | âš ï¸ ä¸­ | å¶å°”ä½¿ç”¨ | "AIè¯­è¨€è®¾ç½®" |
| 8.07 | é€šçŸ¥è®¾ç½® | âœ… é«˜ | å¸¸ç”¨è®¾ç½® | "é€šçŸ¥è®¾ç½®" |
| 8.08 | æ•°æ®åŒæ­¥ | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "åŒæ­¥è®¾ç½®"ã€"æ•°æ®åŒæ­¥" |
| 8.09 | åˆ†ç±»ç®¡ç† | âœ… é«˜ | å¸¸ç”¨ç®¡ç† | "åˆ†ç±»ç®¡ç†" |
| 8.10 | è´¦æˆ·ç®¡ç† | âœ… é«˜ | å¸¸ç”¨ç®¡ç† | "è´¦æˆ·ç®¡ç†" |
| 8.11 | ä¼šå‘˜æœåŠ¡ | âš ï¸ ä¸­ | å¶å°”æŸ¥çœ‹ | "ä¼šå‘˜æœåŠ¡"ã€"å‡çº§ä¼šå‘˜" |
| 8.12 | å…³äºåº”ç”¨ | âš ï¸ ä¸­ | å¶å°”æŸ¥çœ‹ | "å…³äº"ã€"ç‰ˆæœ¬" |
| 8.13 | å®‰å…¨è®¾ç½® | âœ… é«˜ | å…¥å£é¡µé¢ | "å®‰å…¨è®¾ç½®" |
| 8.14 | ä½ç½®æœåŠ¡è®¾ç½® | âš ï¸ ä¸­ | éšç§æ•æ„Ÿ | "ä½ç½®è®¾ç½®" |
| 8.15 | å¸¸é©»åœ°ç‚¹è®¾ç½® | âŒ ä½ | éœ€åœ°å›¾æ“ä½œ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 8.16 | åœ°ç†å›´æ ç®¡ç† | âŒ ä½ | éœ€åœ°å›¾æ“ä½œ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 8.17 | ä½ç½®åˆ†ææŠ¥å‘Š | âš ï¸ ä¸­ | æŸ¥çœ‹åˆ†æ | "ä½ç½®åˆ†æ" |
| 8.18 | å¼‚åœ°æ¶ˆè´¹è®°å½• | âš ï¸ ä¸­ | æŸ¥çœ‹è®°å½• | "å¼‚åœ°æ¶ˆè´¹" |
| 8.19 | ä½ç½®çœé’±å»ºè®® | âš ï¸ ä¸­ | æŸ¥çœ‹å»ºè®® | "çœé’±å»ºè®®" |
| 8.20 | åº”ç”¨é”è®¾ç½® | âš ï¸ ä¸­ | å®‰å…¨è®¾ç½® | "åº”ç”¨é”è®¾ç½®" |
| 8.21 | PINç è®¾ç½® | âŒ ä½ | éœ€é”®ç›˜è¾“å…¥ | è¯­éŸ³æ‰“å¼€åæ‰‹åŠ¨è¾“å…¥ |
| 8.22 | éšç§æ¨¡å¼è®¾ç½® | âœ… é«˜ | å¼€å…³æ“ä½œ | "éšç§æ¨¡å¼è®¾ç½®" |
| 8.23 | å¤‡ä»½ç®¡ç† | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "å¤‡ä»½ç®¡ç†" |
| 8.24 | å®‰å…¨å®¡è®¡æ—¥å¿— | âš ï¸ ä¸­ | æŸ¥çœ‹æ—¥å¿— | "å®‰å…¨æ—¥å¿—" |
| 8.25 | æ•°æ®ç®¡ç† | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "æ•°æ®ç®¡ç†" |

**å°ç»“ï¼š12é«˜/10ä¸­/3ä½**

---

##### ä¹ã€æ•°æ®è”åŠ¨ï¼ˆ5ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 9.01 | åˆ†ç±»è¯¦æƒ… | âš ï¸ ä¸­ | éœ€æŒ‡å®šåˆ†ç±» | "é¤é¥®è¯¦æƒ…" |
| 9.02 | æœç´¢ç»“æœ | âœ… é«˜ | æœç´¢åŠŸèƒ½ | "æœç´¢XX" |
| 9.03 | é«˜çº§ç­›é€‰ | âš ï¸ ä¸­ | å¤šæ¡ä»¶ç»„åˆ | "ç­›é€‰" |
| 9.04 | æ—¶é—´å¯¹æ¯” | âš ï¸ ä¸­ | éœ€é€‰æ—¶é—´ | "æœ¬æœˆå’Œä¸Šæœˆå¯¹æ¯”" |
| 9.05 | æ ‡ç­¾ç­›é€‰ | âš ï¸ ä¸­ | éœ€é€‰æ ‡ç­¾ | "æŒ‰æ ‡ç­¾ç­›é€‰" |

**å°ç»“ï¼š1é«˜/4ä¸­**

---

##### åã€ä¹ æƒ¯åŸ¹å…»ï¼ˆ7ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 10.01 | è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜ | âœ… é«˜ | æ ¸å¿ƒåŠŸèƒ½ | "è´¢åŠ¡å¥åº·"ã€"å¥åº·åº¦" |
| 10.02 | è®¢é˜…æµªè´¹è¯†åˆ« | âœ… é«˜ | æŸ¥çœ‹åˆ†æ | "è®¢é˜…åˆ†æ"ã€"æœ‰ä»€ä¹ˆæµªè´¹" |
| 10.03 | æ‹¿é“å› å­åˆ†æ | âœ… é«˜ | æŸ¥çœ‹åˆ†æ | "æ‹¿é“å› å­"ã€"å°é¢æ¶ˆè´¹" |
| 10.04 | å†²åŠ¨æ¶ˆè´¹ç¡®è®¤ | âŒ ä½ | ç³»ç»Ÿå¼¹çª— | ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ |
| 10.05 | åº”æ€¥é‡‘ç›®æ ‡ | âœ… é«˜ | ç›®æ ‡æŸ¥çœ‹ | "åº”æ€¥é‡‘"ã€"åº”æ€¥é‡‘è¿›åº¦" |
| 10.06 | é’±é¾„è¿›é˜¶ | âš ï¸ ä¸­ | å¼•å¯¼é¡µ | "æ€ä¹ˆæå‡é’±é¾„" |
| 10.07 | è¿ç»­æ‰“å¡ | âœ… é«˜ | å¸¸ç”¨åŠŸèƒ½ | "æ‰“å¡"ã€"çœ‹çœ‹æ‰“å¡" |

**å°ç»“ï¼š5é«˜/1ä¸­/1ä½**

---

##### åä¸€ã€å¼‚å¸¸å¤„ç†ï¼ˆ6ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 11.01 | ç½‘ç»œé”™è¯¯é¡µé¢ | âŒ ä½ | ç³»ç»Ÿè§¦å‘ | ç³»ç»Ÿè‡ªåŠ¨å±•ç¤º |
| 11.02 | åŒæ­¥å†²çªè§£å†³ | âŒ ä½ | éœ€é€‰æ‹©æ“ä½œ | å»ºè®®å›¾å½¢ç•Œé¢ |
| 11.03 | æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ | âš ï¸ ä¸­ | æŸ¥çœ‹çŠ¶æ€ | "æ•°æ®æ£€æŸ¥" |
| 11.04 | ç¦»çº¿æ“ä½œé˜Ÿåˆ— | âš ï¸ ä¸­ | æŸ¥çœ‹é˜Ÿåˆ— | "ç¦»çº¿é˜Ÿåˆ—" |
| 11.05 | é”™è¯¯å¯¹è¯æ¡† | âŒ ä½ | ç³»ç»Ÿå¼¹çª— | ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ |
| 11.06 | é‡è¯•çŠ¶æ€æç¤º | âŒ ä½ | ç³»ç»Ÿæç¤º | ç³»ç»Ÿè‡ªåŠ¨å±•ç¤º |

**å°ç»“ï¼š0é«˜/2ä¸­/4ä½**

---

##### åäºŒã€ç³»ç»Ÿç›‘æ§ï¼ˆ6ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 12.01 | åº”ç”¨å¥åº·çŠ¶æ€ | âš ï¸ ä¸­ | æŸ¥çœ‹çŠ¶æ€ | "åº”ç”¨çŠ¶æ€" |
| 12.02 | æ€§èƒ½ç›‘æ§ | âš ï¸ ä¸­ | æŠ€æœ¯é¡µé¢ | "æ€§èƒ½ç›‘æ§" |
| 12.03 | ç³»ç»Ÿæ—¥å¿— | âŒ ä½ | æŠ€æœ¯é¡µé¢ | ä¿æŒå›¾å½¢ç•Œé¢ |
| 12.04 | å‘Šè­¦å†å² | âš ï¸ ä¸­ | æŸ¥çœ‹è®°å½• | "å‘Šè­¦å†å²" |
| 12.05 | AIæœåŠ¡ç›‘æ§ | âš ï¸ ä¸­ | æŠ€æœ¯é¡µé¢ | "AIçŠ¶æ€" |
| 12.06 | è¯Šæ–­æŠ¥å‘Š | âš ï¸ ä¸­ | æŸ¥çœ‹æŠ¥å‘Š | "è¯Šæ–­æŠ¥å‘Š" |

**å°ç»“ï¼š0é«˜/5ä¸­/1ä½**

---

##### åä¸‰ã€è´¦å•æé†’ï¼ˆ6ä¸ªï¼‰

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 13.01 | è´¦å•æé†’åˆ—è¡¨ | âœ… é«˜ | å¸¸ç”¨å…¥å£ | "è´¦å•æé†’"ã€"å®šæœŸè´¦å•" |
| 13.02 | æ·»åŠ å®šæœŸè´¦å• | âš ï¸ ä¸­ | å¤šè½®å¯¹è¯ | "æ·»åŠ è´¦å•æé†’" |
| 13.03 | ä¿¡ç”¨å¡è¿˜æ¬¾æé†’ | âœ… é«˜ | å¸¸ç”¨æŸ¥çœ‹ | "ä¿¡ç”¨å¡æé†’" |
| 13.04 | åˆ°æœŸé€šçŸ¥è¯¦æƒ… | âš ï¸ ä¸­ | ç³»ç»Ÿæ¨é€ | "è´¦å•è¯¦æƒ…" |
| 13.05 | æ™ºèƒ½è´¦å•å»ºè®® | âœ… é«˜ | å»ºè®®æŸ¥çœ‹ | "è´¦å•å»ºè®®" |
| 13.06 | è´¦å•æ—¥å†è§†å›¾ | âš ï¸ ä¸­ | å¯è§†åŒ– | "è´¦å•æ—¥å†" |

**å°ç»“ï¼š3é«˜/3ä¸­**

---

##### åå››ã€AIæ™ºèƒ½ä¸­å¿ƒï¼ˆ10ä¸ªï¼‰ã€æ–°å¢ã€‘

| åºå· | é¡µé¢åç§° | è¯­éŸ³é€‚é… | é€‚é…ç†ç”± | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ |
|-----|---------|---------|---------|-------------|
| 14.01 | æ™ºèƒ½åˆ†ç±»ä¸­å¿ƒ | âœ… é«˜ | AIæ ¸å¿ƒåŠŸèƒ½ | "æ™ºèƒ½åˆ†ç±»"ã€"åˆ†ç±»è®¾ç½®" |
| 14.02 | åˆ†ç±»åé¦ˆå­¦ä¹  | âš ï¸ ä¸­ | æŸ¥çœ‹å­¦ä¹ çŠ¶æ€ | "åˆ†ç±»å­¦ä¹ è®°å½•" |
| 14.03 | æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹ | âœ… é«˜ | AIé¢„æµ‹åŠŸèƒ½ | "é¢„æµ‹æ¶ˆè´¹"ã€"æ¶ˆè´¹é¢„æµ‹" |
| 14.04 | å¼‚å¸¸æ£€æµ‹è®¾ç½® | âš ï¸ ä¸­ | é…ç½®é¡µé¢ | "å¼‚å¸¸æ£€æµ‹è®¾ç½®" |
| 14.05 | å¼‚å¸¸äº¤æ˜“è¯¦æƒ… | âš ï¸ ä¸­ | æŸ¥çœ‹è¯¦æƒ… | "å¼‚å¸¸äº¤æ˜“" |
| 14.06 | è‡ªç„¶è¯­è¨€æœç´¢ | âœ… é«˜ | AIæ ¸å¿ƒåŠŸèƒ½ | "æ™ºèƒ½æœç´¢"ã€"æœç´¢XX" |
| 14.07 | å¯¹è¯åŠ©æ‰‹è®¾ç½® | âš ï¸ ä¸­ | é…ç½®é¡µé¢ | "å¯¹è¯åŠ©æ‰‹è®¾ç½®" |
| 14.08 | è¯­éŸ³é…ç½®ä¸­å¿ƒ | âœ… é«˜ | è¯­éŸ³æ ¸å¿ƒ | "è¯­éŸ³è®¾ç½®"ã€"è¯­éŸ³é…ç½®" |
| 14.09 | AIæˆæœ¬ç›‘æ§ | âš ï¸ ä¸­ | æŠ€æœ¯ç›‘æ§ | "AIæˆæœ¬" |
| 14.10 | æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š | âœ… é«˜ | å­¦ä¹ æ•ˆæœ | "å­¦ä¹ æŠ¥å‘Š"ã€"AIå­¦ä¹ æ•ˆæœ" |

**å°ç»“ï¼š5é«˜/5ä¸­**

---

##### è¯­éŸ³é€‚é…æ€»ç»“

| é€‚é…ç­‰çº§ | é¡µé¢æ•°é‡ | å æ¯” | è¯´æ˜ |
|---------|---------|-----|------|
| âœ… é«˜é€‚é… | 51ä¸ª | 43% | è¯­éŸ³å¯ç›´æ¥å®Œæˆï¼Œä¼˜å…ˆå®ç° |
| âš ï¸ ä¸­é€‚é… | 43ä¸ª | 36% | éœ€é…åˆGUIæˆ–å¤šè½®å¯¹è¯ |
| âŒ ä½é€‚é… | 25ä¸ª | 21% | ä¿æŒå›¾å½¢ç•Œé¢ä¸ºä¸» |

**å®æ–½å»ºè®®ï¼š**
1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå®ç°51ä¸ªé«˜é€‚é…é¡µé¢çš„è¯­éŸ³å¯¼èˆª
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šä¼˜åŒ–43ä¸ªä¸­é€‚é…é¡µé¢ï¼Œå¢åŠ è¯­éŸ³è¾…åŠ©
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šä¸ºä½é€‚é…é¡µé¢æä¾›è¯­éŸ³å¿«æ·å…¥å£


### 18.1 æ„å›¾è¯†åˆ«å¼•æ“

```dart
/// è¯­éŸ³æ„å›¾ç±»å‹æšä¸¾ - å®Œæ•´ç‰ˆï¼ˆè¦†ç›–200+é…ç½®é¡¹ã€48é¡µé¢ã€60+ç›´æ¥æ“ä½œï¼‰
enum VoiceIntentType {
  // ==================== è®°è´¦ç›¸å…³ï¼ˆ5ç±»ï¼‰ ====================
  addExpense,           // æ·»åŠ æ”¯å‡ºï¼šè®°ä¸€ç¬”ã€èŠ±äº†ã€ä¹°äº†
  addIncome,            // æ·»åŠ æ”¶å…¥ï¼šæ”¶åˆ°ã€å…¥è´¦ã€å·¥èµ„åˆ°äº†
  addTransfer,          // è½¬è´¦ï¼šä»...è½¬åˆ°...
  batchRecord,          // æ‰¹é‡è®°è´¦ï¼šè®°å¤šç¬”ã€è¿ç»­è®°è´¦
  useTemplate,          // ä½¿ç”¨æ¨¡æ¿ï¼šæŒ‰æ¨¡æ¿è®°ã€å¸¸ç”¨è®°è´¦

  // ==================== é…ç½®ç›¸å…³ï¼ˆ13å¤§ç±»ï¼‰ ====================
  // ä¸€ã€é¢„ç®—é…ç½®
  setBudget,            // è®¾ç½®é¢„ç®—ï¼šæŠŠé¤é¥®é¢„ç®—æ”¹æˆ2000
  setBudgetAlert,       // é¢„ç®—é¢„è­¦ï¼šé¢„ç®—ç”¨åˆ°80%æ—¶æé†’æˆ‘
  setBudgetCycle,       // é¢„ç®—å‘¨æœŸï¼šé¢„ç®—å‘¨æœŸæ”¹æˆæŒ‰å‘¨
  setBudgetRollover,    // é¢„ç®—ç»“è½¬ï¼šå¼€å¯é¢„ç®—ç»“è½¬

  // äºŒã€è´¦æˆ·é…ç½®
  setAccount,           // è´¦æˆ·è®¾ç½®ï¼šæŠŠå¾®ä¿¡è®¾ä¸ºé»˜è®¤è´¦æˆ·
  setCreditCard,        // ä¿¡ç”¨å¡è®¾ç½®ï¼šä¿¡ç”¨å¡è´¦å•æ—¥æ”¹æˆ5å·
  setInvestment,        // æŠ•èµ„è´¦æˆ·ï¼šæ·»åŠ æŠ•èµ„è´¦æˆ·

  // ä¸‰ã€è´¦æœ¬ä¸æˆå‘˜é…ç½®
  setLedger,            // è´¦æœ¬ç®¡ç†ï¼šåˆ›å»ºå®¶åº­è´¦æœ¬ã€åˆ‡æ¢è´¦æœ¬
  setMember,            // æˆå‘˜ç®¡ç†ï¼šé‚€è¯·è€å©†åŠ å…¥è´¦æœ¬
  setPermission,        // æƒé™è®¾ç½®ï¼šç»™XXç¼–è¾‘æƒé™

  // å››ã€åˆ†ç±»é…ç½®
  setCategory,          // åˆ†ç±»è®¾ç½®ï¼šæ·»åŠ å® ç‰©åˆ†ç±»
  setSubCategory,       // å­åˆ†ç±»ï¼šç»™é¤é¥®æ·»åŠ å¤–å–å­åˆ†ç±»
  setTag,               // æ ‡ç­¾ç®¡ç†ï¼šåˆ›å»ºæ ‡ç­¾

  // äº”ã€ç›®æ ‡ä¸å€ºåŠ¡é…ç½®
  setSavingsGoal,       // å‚¨è“„ç›®æ ‡ï¼šåˆ›å»ºä¹°è½¦ç›®æ ‡15ä¸‡
  setExpenseTarget,     // å¼€æ”¯ç›®æ ‡ï¼šè®¾ç½®æœˆåº¦é™é¢
  setDebt,              // å€ºåŠ¡ç®¡ç†ï¼šæ·»åŠ æˆ¿è´·120ä¸‡

  // å…­ã€æé†’é…ç½®
  setReminder,          // æé†’è®¾ç½®ï¼šæ¯å¤©8ç‚¹æé†’è®°è´¦
  setBillReminder,      // è´¦å•æé†’ï¼šä¿¡ç”¨å¡è¿˜æ¬¾æå‰3å¤©æé†’
  setSubscription,      // è®¢é˜…æé†’ï¼šæ·»åŠ Netflixç»­è´¹æé†’

  // ä¸ƒã€æ¨¡æ¿ä¸å®šæ—¶é…ç½®
  setTemplate,          // æ¨¡æ¿ç®¡ç†ï¼šæŠŠåˆšæ‰é‚£ç¬”ä¿å­˜ä¸ºæ¨¡æ¿
  setRecurring,         // å®šæ—¶è®°è´¦ï¼šæ¯æœˆ15å·è‡ªåŠ¨è®°æˆ¿ç§Ÿ

  // å…«ã€å¤–è§‚ä¸æ˜¾ç¤ºé…ç½®
  setTheme,             // ä¸»é¢˜è®¾ç½®ï¼šåˆ‡æ¢æ·±è‰²æ¨¡å¼ã€æ¢æˆç»¿è‰²ä¸»é¢˜
  setHomeLayout,        // é¦–é¡µå¸ƒå±€ï¼šéšè—é¢„ç®—å¡ç‰‡
  setDisplay,           // æ˜¾ç¤ºåå¥½ï¼šé‡‘é¢æ˜¾ç¤ºä¸¤ä½å°æ•°

  // ä¹ã€å›½é™…åŒ–é…ç½®
  setLanguage,          // è¯­è¨€è®¾ç½®ï¼šåˆ‡æ¢åˆ°è‹±æ–‡
  setCurrency,          // è´§å¸è®¾ç½®ï¼šé»˜è®¤è´§å¸æ”¹æˆç¾å…ƒ
  setDateFormat,        // æ—¥æœŸæ ¼å¼ï¼šæ—¥æœŸæ ¼å¼æ”¹æˆå¹´æœˆæ—¥

  // åã€AIä¸æ™ºèƒ½é…ç½®
  setAI,                // AIè®¾ç½®ï¼šå…³é—­æ™ºèƒ½åˆ†ç±»
  setVoice,             // è¯­éŸ³è®¾ç½®ï¼šå¼€å¯è¯­éŸ³æ’­æŠ¥
  setRecognition,       // è¯†åˆ«è®¾ç½®ï¼šé‡å¤æ£€æµ‹æ—¶é—´æ”¹æˆ30åˆ†é’Ÿ

  // åä¸€ã€æ•°æ®ä¸åŒæ­¥é…ç½®
  setSync,              // åŒæ­¥è®¾ç½®ï¼šå¼€å¯è‡ªåŠ¨åŒæ­¥ã€åªåœ¨WiFiä¸‹åŒæ­¥
  setBackup,            // å¤‡ä»½è®¾ç½®ï¼šè®¾ç½®æ¯å¤©è‡ªåŠ¨å¤‡ä»½
  setStorage,           // å­˜å‚¨è®¾ç½®ï¼šæ¥æºæ•°æ®ä¿ç•™30å¤©

  // åäºŒã€å®‰å…¨ä¸éšç§é…ç½®
  setSecurity,          // å®‰å…¨è®¾ç½®ï¼šå¼€å¯åº”ç”¨é”ã€æŒ‡çº¹è§£é”
  setPrivacy,           // éšç§è®¾ç½®ï¼šå¼€å¯éšç§æ¨¡å¼

  // åä¸‰ã€ç½‘ç»œä¸æ›´æ–°é…ç½®
  setNetwork,           // ç½‘ç»œè®¾ç½®ï¼šè¿æ¥è¶…æ—¶æ”¹æˆ60ç§’
  setUpdate,            // æ›´æ–°è®¾ç½®ï¼šå¼€å¯è‡ªåŠ¨æ›´æ–°

  // ==================== å¯¼èˆªç›¸å…³ï¼ˆé¡µé¢å¯¼èˆªï¼‰ ====================
  navigateTo,           // é¡µé¢å¯¼èˆªï¼šæ‰“å¼€é¢„ç®—ç®¡ç†ã€å»ä¿¡ç”¨å¡é¡µé¢
  navigateToBookkeeping,// è®°è´¦å¯¼èˆªï¼šæ‰“å¼€å¿«é€Ÿè®°è´¦ã€è¯­éŸ³è®°è´¦
  navigateToLedger,     // è´¦æœ¬å¯¼èˆªï¼šæ‰“å¼€è´¦æœ¬ç®¡ç†ã€æˆå‘˜ç®¡ç†
  navigateToAccount,    // è´¦æˆ·å¯¼èˆªï¼šæ‰“å¼€è´¦æˆ·ç®¡ç†ã€ä¿¡ç”¨å¡
  navigateToBudget,     // é¢„ç®—å¯¼èˆªï¼šæ‰“å¼€é¢„ç®—ã€å‚¨è“„ç›®æ ‡ã€å€ºåŠ¡
  navigateToStats,      // ç»Ÿè®¡å¯¼èˆªï¼šæ‰“å¼€å¹´åº¦æŠ¥å‘Šã€èµ„äº§æ€»è§ˆ
  navigateToData,       // æ•°æ®å¯¼èˆªï¼šæ‰“å¼€å¯¼å…¥å¯¼å‡ºã€å¤‡ä»½
  navigateToSettings,   // è®¾ç½®å¯¼èˆªï¼šæ‰“å¼€è®¾ç½®ã€è¯­è¨€ã€è´§å¸
  navigateToUser,       // ç”¨æˆ·å¯¼èˆªï¼šæ‰“å¼€ç™»å½•ã€å…³äºã€å¸®åŠ©
  navigateToAI,         // AIå¯¼èˆªï¼šæ‰“å¼€æ™ºèƒ½ä¸­å¿ƒã€AIè®¾ç½®
  navigateToBillReminder,// è´¦å•æé†’å¯¼èˆªï¼šæ‰“å¼€è´¦å•æé†’ã€ä¿¡ç”¨å¡æé†’
  navigateToMonitor,    // ç›‘æ§å¯¼èˆªï¼šæ‰“å¼€ç³»ç»Ÿç›‘æ§ã€æ€§èƒ½ç›‘æ§
  searchFunction,       // åŠŸèƒ½æœç´¢ï¼šæ‰¾åŠŸèƒ½ã€å“ªé‡Œå¯ä»¥

  // ==================== AIæ™ºèƒ½ä¸­å¿ƒç›¸å…³ ====================
  // æ™ºèƒ½åˆ†ç±»
  openSmartCategory,    // æ‰“å¼€æ™ºèƒ½åˆ†ç±»ä¸­å¿ƒ
  viewCategoryLearning, // æŸ¥çœ‹åˆ†ç±»å­¦ä¹ è®°å½•
  trainCategory,        // é‡æ–°è®­ç»ƒåˆ†ç±»æ¨¡å‹

  // è¶‹åŠ¿é¢„æµ‹
  viewTrendPrediction,  // æŸ¥çœ‹æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹
  predictNextMonth,     // é¢„æµ‹ä¸‹æœˆæ¶ˆè´¹

  // å¼‚å¸¸æ£€æµ‹
  openAnomalySettings,  // æ‰“å¼€å¼‚å¸¸æ£€æµ‹è®¾ç½®
  viewAnomalyTransactions,// æŸ¥çœ‹å¼‚å¸¸äº¤æ˜“
  enableAnomalyDetection, // å¼€å¯å¼‚å¸¸æ£€æµ‹
  disableAnomalyDetection,// å…³é—­å¼‚å¸¸æ£€æµ‹

  // è‡ªç„¶è¯­è¨€æœç´¢
  smartSearch,          // æ™ºèƒ½æœç´¢ï¼šç”¨è‡ªç„¶è¯­è¨€æœç´¢
  searchByDescription,  // æŒ‰æè¿°æœç´¢

  // å¯¹è¯åŠ©æ‰‹
  openDialogSettings,   // æ‰“å¼€å¯¹è¯åŠ©æ‰‹è®¾ç½®
  viewDialogHistory,    // æŸ¥çœ‹å¯¹è¯å†å²

  // è¯­éŸ³é…ç½®
  openVoiceConfig,      // æ‰“å¼€è¯­éŸ³é…ç½®ä¸­å¿ƒ
  setWakeWord,          // è®¾ç½®å”¤é†’è¯
  setVoiceLanguage,     // è®¾ç½®è¯­éŸ³è¯­è¨€

  // AIæˆæœ¬ç›‘æ§
  viewAICost,           // æŸ¥çœ‹AIæˆæœ¬
  viewAIUsage,          // æŸ¥çœ‹AIä½¿ç”¨é‡

  // å­¦ä¹ æŠ¥å‘Š
  viewLearningReport,   // æŸ¥çœ‹æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š
  viewAccuracyTrend,    // æŸ¥çœ‹å‡†ç¡®ç‡è¶‹åŠ¿


  // ==================== ç›´æ¥æ“ä½œï¼ˆæ— éœ€è¿›å…¥é¡µé¢ï¼‰ ====================
  // è®°è´¦æ“ä½œ
  deleteLastTransaction,// åˆ é™¤æœ€åä¸€ç¬”
  undoOperation,        // æ’¤é”€æ“ä½œ
  editLastTransaction,  // ä¿®æ”¹åˆšæ‰é‚£ç¬”
  copyAsTemplate,       // å¤åˆ¶ä¸ºæ¨¡æ¿

  // è´¦æœ¬åˆ‡æ¢
  switchLedger,         // åˆ‡æ¢è´¦æœ¬
  switchToPersonal,     // åˆ‡æ¢åˆ°ä¸ªäººè´¦æœ¬
  switchToFamily,       // åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬

  // è´¦æˆ·æ“ä½œ
  switchDefaultAccount, // åˆ‡æ¢é»˜è®¤è´¦æˆ·
  correctBalance,       // æ ¡æ­£ä½™é¢
  viewBalance,          // æŸ¥çœ‹ä½™é¢

  // é¢„ç®—æ“ä½œ
  resetBudget,          // é‡ç½®é¢„ç®—
  rolloverBudget,       // é¢„ç®—ç»“è½¬

  // ä¸»é¢˜åˆ‡æ¢
  toggleDarkMode,       // åˆ‡æ¢æ·±è‰²æ¨¡å¼
  enableDarkMode,       // å¼€å¯æ·±è‰²æ¨¡å¼
  disableDarkMode,      // å…³é—­æ·±è‰²æ¨¡å¼
  setThemeBlue,         // è“è‰²ä¸»é¢˜
  setThemeGreen,        // ç»¿è‰²ä¸»é¢˜
  setThemeRed,          // çº¢è‰²ä¸»é¢˜
  setThemePurple,       // ç´«è‰²ä¸»é¢˜
  setThemeOrange,       // æ©™è‰²ä¸»é¢˜

  // è¯­è¨€åˆ‡æ¢
  setLanguageZhCN,      // åˆ‡æ¢ä¸­æ–‡
  setLanguageEnUS,      // åˆ‡æ¢è‹±æ–‡
  setLanguageJaJP,      // åˆ‡æ¢æ—¥æ–‡
  setLanguageZhTW,      // åˆ‡æ¢ç¹ä½“

  // è´§å¸åˆ‡æ¢
  setCurrencyCNY,       // åˆ‡æ¢äººæ°‘å¸
  setCurrencyUSD,       // åˆ‡æ¢ç¾å…ƒ
  setCurrencyEUR,       // åˆ‡æ¢æ¬§å…ƒ
  setCurrencyJPY,       // åˆ‡æ¢æ—¥å…ƒ

  // å¼€å…³æ“ä½œ
  enableAutoSync,       // å¼€å¯è‡ªåŠ¨åŒæ­¥
  disableAutoSync,      // å…³é—­è‡ªåŠ¨åŒæ­¥
  enablePrivacyMode,    // å¼€å¯éšç§æ¨¡å¼
  disablePrivacyMode,   // å…³é—­éšç§æ¨¡å¼
  enableAppLock,        // å¼€å¯åº”ç”¨é”
  disableAppLock,       // å…³é—­åº”ç”¨é”
  enableVoiceRecognition,   // å¼€å¯è¯­éŸ³è¯†åˆ«
  disableVoiceRecognition,  // å…³é—­è¯­éŸ³è¯†åˆ«
  enableImageRecognition,   // å¼€å¯å›¾ç‰‡è¯†åˆ«
  disableImageRecognition,  // å…³é—­å›¾ç‰‡è¯†åˆ«
  enableSmartCategory,      // å¼€å¯æ™ºèƒ½åˆ†ç±»
  disableSmartCategory,     // å…³é—­æ™ºèƒ½åˆ†ç±»
  enableDuplicateDetection, // å¼€å¯é‡å¤æ£€æµ‹
  disableDuplicateDetection,// å…³é—­é‡å¤æ£€æµ‹
  enableBookkeepingReminder,// å¼€å¯è®°è´¦æé†’
  disableBookkeepingReminder,// å…³é—­è®°è´¦æé†’
  enableBudgetReminder,     // å¼€å¯é¢„ç®—æé†’
  disableBudgetReminder,    // å…³é—­é¢„ç®—æé†’
  enableOfflineMode,        // å¼€å¯ç¦»çº¿æ¨¡å¼
  disableOfflineMode,       // å…³é—­ç¦»çº¿æ¨¡å¼

  // æ•°æ®æ“ä½œ
  backupNow,            // ç«‹å³å¤‡ä»½
  syncNow,              // ç«‹å³åŒæ­¥
  forceRefresh,         // å¼ºåˆ¶åˆ·æ–°
  refresh,              // åˆ·æ–°
  clearCache,           // æ¸…é™¤ç¼“å­˜
  emptyTrash,           // æ¸…ç©ºå›æ”¶ç«™
  exportMonthData,      // å¯¼å‡ºæœ¬æœˆæ•°æ®
  exportYearData,       // å¯¼å‡ºæœ¬å¹´æ•°æ®
  exportAllData,        // å¯¼å‡ºå…¨éƒ¨æ•°æ®

  // å¿«æ·æ“ä½œ
  openCamera,           // æ‰“å¼€ç›¸æœº
  openScanner,          // æ‰«ä¸€æ‰«
  goHome,               // è¿”å›é¦–é¡µ

  // ä¹ æƒ¯æ“ä½œ
  habitCheckIn,         // æ‰“å¡
  viewCheckInHistory,   // æŸ¥çœ‹æ‰“å¡è®°å½•

  // åˆ†äº«æ“ä½œ
  shareMonthlyReport,   // åˆ†äº«æœˆæŠ¥
  shareAnnualReport,    // åˆ†äº«å¹´æŠ¥
  shareTransaction,     // åˆ†äº«è´¦å•
  inviteFriend,         // é‚€è¯·å¥½å‹

  // ç³»ç»Ÿæ“ä½œ
  checkUpdate,          // æ£€æŸ¥æ›´æ–°
  openFeedback,         // æäº¤åé¦ˆ
  contactSupport,       // è”ç³»å®¢æœ
  logout,               // é€€å‡ºç™»å½•
  deleteAccount,        // æ³¨é”€è´¦å·

  // ==================== æŸ¥è¯¢ç›¸å…³ ====================
  queryExpense,         // æŸ¥è¯¢æ¶ˆè´¹ï¼šèŠ±äº†å¤šå°‘ã€æ¶ˆè´¹æƒ…å†µ
  queryIncome,          // æŸ¥è¯¢æ”¶å…¥ï¼šæ”¶å…¥å¤šå°‘ã€èµšäº†å¤šå°‘
  queryBudget,          // æŸ¥è¯¢é¢„ç®—ï¼šé¢„ç®—è¿˜å‰©ã€è¶…æ”¯æ²¡
  queryMoneyAge,        // æŸ¥è¯¢é’±é¾„ï¼šèµ„é‡‘å¹´é¾„ã€æŒæœ‰å¤šä¹…
  queryTrend,           // æŸ¥è¯¢è¶‹åŠ¿ï¼šè¶‹åŠ¿å¦‚ä½•ã€å˜åŒ–
  queryReport,          // æŸ¥è¯¢æŠ¥å‘Šï¼šæœˆæŠ¥ã€å¹´æŠ¥ã€åˆ†æ
  queryBalance,         // æŸ¥è¯¢ä½™é¢ï¼šè¿˜å‰©å¤šå°‘ã€è´¦æˆ·ä½™é¢
  queryStats,           // æŸ¥è¯¢ç»Ÿè®¡ï¼šæœ¬æœˆç»Ÿè®¡ã€åˆ†ç±»å æ¯”
  queryGoal,            // æŸ¥è¯¢ç›®æ ‡ï¼šç›®æ ‡è¿›åº¦ã€è¿˜å·®å¤šå°‘
  queryDebt,            // æŸ¥è¯¢å€ºåŠ¡ï¼šè¿˜æ¬¾è¿›åº¦ã€å‰©ä½™æœ¬é‡‘

  // ==================== å…¶ä»– ====================
  chat,                 // é—²èŠå¯¹è¯
  help,                 // å¸®åŠ©å¼•å¯¼
  cancel,               // å–æ¶ˆæ“ä½œ
  confirm,              // ç¡®è®¤æ“ä½œ
  feedback,             // åé¦ˆé—®é¢˜
  unknown,              // æœªè¯†åˆ«æ„å›¾
}

/// æ„å›¾è¯†åˆ«å¼•æ“ - åŒå±‚ç­–ç•¥ï¼šè§„åˆ™ä¼˜å…ˆ + LLMå…œåº•
class IntentRecognitionEngine {
  final LLMService _llmService;
  final RuleBasedMatcher _ruleMatcher;

  /// ========== æ„å›¾è¯†åˆ«è§„åˆ™åº“ï¼ˆä¼˜å…ˆåŒ¹é…ï¼Œé›¶æˆæœ¬ï¼‰ ==========
  /// è¦†ç›–æ‰€æœ‰å¸¸è§è¯­éŸ³æŒ‡ä»¤æ¨¡å¼

  static const Map<VoiceIntentType, List<String>> _intentPatterns = {

    // ==================== è®°è´¦æ„å›¾ ====================
    VoiceIntentType.addExpense: [
      r'(è®°ä¸€ç¬”|è®°è´¦|èŠ±äº†|ä¹°äº†|æ”¯å‡º|æ¶ˆè´¹äº†|ä»˜äº†|èŠ±è´¹)',
      r'(åƒé¥­|æ‰“è½¦|è´­ç‰©|ä¹°èœ|ç¼´è´¹).*([\d\.]+)',
      r'[\d\.]+.*(å…ƒ|å—|å—é’±).*(é¤é¥®|äº¤é€š|è´­ç‰©)',
    ],
    VoiceIntentType.addIncome: [
      r'(æ”¶åˆ°|å…¥è´¦|æ”¶å…¥|å·¥èµ„|å¥–é‡‘|åˆ°è´¦|å‘å·¥èµ„)',
      r'(æ”¶æ¬¾|è½¬å…¥|è¿›è´¦).*([\d\.]+)',
    ],
    VoiceIntentType.addTransfer: [
      r'(ä»|æŠŠ).*(è½¬|è½¬åˆ°|è½¬å…¥|åˆ’).*(åˆ°|ç»™)',
      r'(è½¬è´¦).*([\d\.]+)',
    ],
    VoiceIntentType.batchRecord: [
      r'(è®°å¤šç¬”|æ‰¹é‡è®°|è¿ç»­è®°|ä¸€èµ·è®°)',
      r'(æ—©é¤|åˆé¤|æ™šé¤).*(,|ï¼Œ).*([\d\.]+)',
    ],
    VoiceIntentType.useTemplate: [
      r'(æŒ‰æ¨¡æ¿|ç”¨æ¨¡æ¿|æ¨¡æ¿è®°è´¦|å¸¸ç”¨è®°è´¦)',
      r'(æŒ‰ç…§|ä½¿ç”¨).*(æ¨¡æ¿)',
    ],

    // ==================== é¢„ç®—é…ç½®æ„å›¾ ====================
    VoiceIntentType.setBudget: [
      r'(è®¾ç½®|ä¿®æ”¹|è°ƒæ•´|æŠŠ).*(é¢„ç®—).*(æ”¹æˆ|è®¾ä¸º|è°ƒåˆ°|è®¾ç½®æˆ)',
      r'(é¤é¥®|äº¤é€š|è´­ç‰©|å¨±ä¹|å±…ä½|åŒ»ç–—|æ•™è‚²|é€šè®¯|æœé¥°|ç¾å¦†|æ•°ç ).*(é¢„ç®—)',
      r'(æœˆåº¦|æ€»|æœ¬æœˆ).*(é¢„ç®—).*([\d\.]+)',
    ],
    VoiceIntentType.setBudgetAlert: [
      r'(é¢„ç®—).*(é¢„è­¦|æé†’|è­¦å‘Š).*([\d]+%?)',
      r'(ç”¨åˆ°|è¶…è¿‡|è¾¾åˆ°).*([\d]+%).*(æé†’)',
    ],
    VoiceIntentType.setBudgetCycle: [
      r'(é¢„ç®—).*(å‘¨æœŸ|èµ·å§‹|å¼€å§‹)',
      r'(æŒ‰å‘¨|æŒ‰æœˆ|æŒ‰å¹´).*(é¢„ç®—)',
    ],
    VoiceIntentType.setBudgetRollover: [
      r'(å¼€å¯|å…³é—­|å¯ç”¨|ç¦ç”¨).*(é¢„ç®—).*(ç»“è½¬)',
      r'(é¢„ç®—).*(ç»“è½¬).*(å¼€|å…³)',
    ],

    // ==================== è´¦æˆ·é…ç½®æ„å›¾ ====================
    VoiceIntentType.setAccount: [
      r'(è®¾ä¸º|è®¾ç½®|æ”¹æˆ|åˆ‡æ¢).*(é»˜è®¤è´¦æˆ·)',
      r'(æ·»åŠ |æ–°å¢|åˆ›å»º).*(è´¦æˆ·|é“¶è¡Œå¡|å‚¨è“„å¡)',
      r'(å¾®ä¿¡|æ”¯ä»˜å®|ç°é‡‘|é“¶è¡Œå¡).*(è®¾ä¸º|ä½œä¸º).*(é»˜è®¤)',
      r'(æ ¡æ­£|è°ƒæ•´).*(ä½™é¢)',
    ],
    VoiceIntentType.setCreditCard: [
      r'(æ·»åŠ |æ–°å¢).*(ä¿¡ç”¨å¡)',
      r'(ä¿¡ç”¨å¡).*(è´¦å•æ—¥|è¿˜æ¬¾æ—¥).*(æ”¹æˆ|è®¾ä¸º|[\d]+å·)',
      r'(é¢åº¦|ä¿¡ç”¨é¢åº¦).*(è®¾ä¸º|æ”¹æˆ|[\d]+)',
    ],

    // ==================== è´¦æœ¬ä¸æˆå‘˜æ„å›¾ ====================
    VoiceIntentType.setLedger: [
      r'(åˆ›å»º|æ–°å»º|æ·»åŠ ).*(è´¦æœ¬)',
      r'(åˆ‡æ¢|æ‰“å¼€|è¿›å…¥).*(è´¦æœ¬)',
      r'(è®¾ä¸º|è®¾ç½®).*(é»˜è®¤è´¦æœ¬)',
    ],
    VoiceIntentType.setMember: [
      r'(é‚€è¯·|æ·»åŠ ).*(æˆå‘˜|å®¶äºº|æœ‹å‹)',
      r'(ç§»é™¤|åˆ é™¤).*(æˆå‘˜)',
    ],

    // ==================== åˆ†ç±»é…ç½®æ„å›¾ ====================
    VoiceIntentType.setCategory: [
      r'(æ·»åŠ |æ–°å¢|åˆ›å»º|åˆ é™¤|ä¿®æ”¹).*(åˆ†ç±»|ç±»åˆ«)',
      r'(åˆ†ç±»).*(æ·»åŠ |åˆ é™¤|æ”¹å)',
    ],
    VoiceIntentType.setSubCategory: [
      r'(ç»™|åœ¨).*(æ·»åŠ |æ–°å¢).*(å­åˆ†ç±»)',
      r'(æ·»åŠ ).*(å­åˆ†ç±»).*(åˆ°|ç»™)',
    ],
    VoiceIntentType.setTag: [
      r'(åˆ›å»º|æ·»åŠ |åˆ é™¤).*(æ ‡ç­¾)',
    ],

    // ==================== ç›®æ ‡ä¸å€ºåŠ¡æ„å›¾ ====================
    VoiceIntentType.setSavingsGoal: [
      r'(åˆ›å»º|è®¾ç½®|æ·»åŠ ).*(å‚¨è“„ç›®æ ‡|æ”’é’±ç›®æ ‡|å­˜é’±ç›®æ ‡)',
      r'(ç›®æ ‡).*(é‡‘é¢|æ—¥æœŸ|æˆªæ­¢)',
      r'(è‡ªåŠ¨å­˜å…¥|æ¯æœˆå­˜å…¥)',
    ],
    VoiceIntentType.setExpenseTarget: [
      r'(åˆ›å»º|è®¾ç½®).*(å¼€æ”¯ç›®æ ‡|æ¶ˆè´¹ç›®æ ‡|èŠ±é’±ç›®æ ‡)',
      r'(æœˆåº¦é™é¢|æ¯æœˆé™é¢)',
    ],
    VoiceIntentType.setDebt: [
      r'(æ·»åŠ |è®°å½•).*(å€ºåŠ¡|æ¬ æ¬¾|è´·æ¬¾|æˆ¿è´·|è½¦è´·)',
      r'(åˆ©ç‡|è¿˜æ¬¾).*(è®¾ç½®|è°ƒæ•´)',
    ],

    // ==================== æé†’é…ç½®æ„å›¾ ====================
    VoiceIntentType.setReminder: [
      r'(è®¾ç½®|æ·»åŠ |å–æ¶ˆ|å…³é—­).*(æé†’|é€šçŸ¥)',
      r'(æ¯å¤©|æ¯å‘¨|æ¯æœˆ).*([\d]+ç‚¹).*(æé†’)',
      r'(æé†’æˆ‘|é€šçŸ¥æˆ‘)',
    ],
    VoiceIntentType.setBillReminder: [
      r'(ä¿¡ç”¨å¡|è¿˜æ¬¾).*(æé†’)',
      r'(æå‰).*([\d]+å¤©).*(æé†’)',
    ],

    // ==================== æ¨¡æ¿ä¸å®šæ—¶æ„å›¾ ====================
    VoiceIntentType.setTemplate: [
      r'(ä¿å­˜|åˆ›å»º|åˆ é™¤).*(æ¨¡æ¿)',
      r'(åˆšæ‰|è¿™ç¬”).*(ä¿å­˜ä¸º|å­˜ä¸º).*(æ¨¡æ¿)',
    ],
    VoiceIntentType.setRecurring: [
      r'(æ¯æœˆ|æ¯å‘¨|æ¯å¤©).*([\d]+å·?).*(è‡ªåŠ¨|å®šæ—¶).*(è®°)',
      r'(å®šæ—¶è®°è´¦|å‘¨æœŸè®°è´¦|è‡ªåŠ¨è®°è´¦)',
    ],

    // ==================== å¤–è§‚é…ç½®æ„å›¾ ====================
    VoiceIntentType.setTheme: [
      r'(åˆ‡æ¢|æ¢æˆ|æ”¹æˆ).*(æ·±è‰²|æµ…è‰²|æš—è‰²|äº®è‰²).*(æ¨¡å¼)?',
      r'(ä¸»é¢˜).*(æ”¹æˆ|æ¢æˆ|åˆ‡æ¢).*(è“è‰²|ç»¿è‰²|çº¢è‰²|ç´«è‰²|æ©™è‰²)',
    ],
    VoiceIntentType.setHomeLayout: [
      r'(éšè—|æ˜¾ç¤º|è°ƒæ•´).*(å¡ç‰‡|é¦–é¡µ)',
      r'(é¦–é¡µ).*(å¸ƒå±€|æ’åº)',
    ],

    // ==================== å›½é™…åŒ–é…ç½®æ„å›¾ ====================
    VoiceIntentType.setLanguage: [
      r'(åˆ‡æ¢|æ”¹æˆ|æ¢æˆ).*(ä¸­æ–‡|è‹±æ–‡|æ—¥æ–‡|éŸ©æ–‡|ç¹ä½“)',
      r'(è¯­è¨€).*(è®¾ç½®|åˆ‡æ¢|æ”¹æˆ)',
    ],
    VoiceIntentType.setCurrency: [
      r'(åˆ‡æ¢|æ”¹æˆ).*(äººæ°‘å¸|ç¾å…ƒ|æ¬§å…ƒ|æ—¥å…ƒ|æ¸¯å¸|è‹±é•‘)',
      r'(è´§å¸|é»˜è®¤è´§å¸).*(è®¾ç½®|åˆ‡æ¢|æ”¹æˆ)',
    ],

    // ==================== AIé…ç½®æ„å›¾ ====================
    VoiceIntentType.setAI: [
      r'(å¼€å¯|å…³é—­|å¯ç”¨|ç¦ç”¨).*(æ™ºèƒ½åˆ†ç±»|AIåˆ†ç±»)',
      r'(æ™ºèƒ½å»ºè®®|æ¶ˆè´¹æ´å¯Ÿ).*(å¼€|å…³)',
    ],
    VoiceIntentType.setVoice: [
      r'(å¼€å¯|å…³é—­).*(è¯­éŸ³æ’­æŠ¥|è¯­éŸ³è¯†åˆ«)',
      r'(è¯­éŸ³).*(å”¤é†’è¯|è¯­è¨€)',
    ],
    VoiceIntentType.setRecognition: [
      r'(é‡å¤æ£€æµ‹).*(æ—¶é—´|æ—¶é—´çª—å£)',
      r'(é‡‘é¢å®¹å·®).*(è®¾ç½®|æ”¹æˆ)',
    ],

    // ==================== åŒæ­¥ä¸å¤‡ä»½æ„å›¾ ====================
    VoiceIntentType.setSync: [
      r'(å¼€å¯|å…³é—­).*(è‡ªåŠ¨åŒæ­¥|äº‘åŒæ­¥)',
      r'(åªåœ¨|ä»…åœ¨).*(WiFi).*(åŒæ­¥)',
    ],
    VoiceIntentType.setBackup: [
      r'(è®¾ç½®|å¼€å¯|å…³é—­).*(è‡ªåŠ¨å¤‡ä»½)',
      r'(å¤‡ä»½).*(é¢‘ç‡|ä¿ç•™)',
    ],

    // ==================== å®‰å…¨é…ç½®æ„å›¾ ====================
    VoiceIntentType.setSecurity: [
      r'(å¼€å¯|å…³é—­).*(åº”ç”¨é”|æŒ‡çº¹|é¢å®¹|PIN)',
      r'(è‡ªåŠ¨é”å®š).*(æ—¶é—´)',
    ],
    VoiceIntentType.setPrivacy: [
      r'(å¼€å¯|å…³é—­).*(éšç§æ¨¡å¼|æˆªå›¾ä¿æŠ¤)',
      r'(é‡‘é¢).*(æ¨¡ç³Š|éšè—)',
    ],

    // ==================== é¡µé¢å¯¼èˆªæ„å›¾ ====================
    VoiceIntentType.navigateTo: [
      r'(æ‰“å¼€|å»|è¿›å…¥|è·³è½¬|çœ‹çœ‹|æŸ¥çœ‹).*(é¡µé¢|åŠŸèƒ½)',
    ],
    VoiceIntentType.navigateToBookkeeping: [
      r'(æ‰“å¼€|å»).*(è®°è´¦|å¿«é€Ÿè®°è´¦|è¯­éŸ³è®°è´¦|å›¾ç‰‡è®°è´¦|æ‹ç…§è®°è´¦)',
      r'(æˆ‘è¦|æˆ‘æƒ³).*(è®°ä¸€ç¬”|è®°è´¦)',
    ],
    VoiceIntentType.navigateToLedger: [
      r'(æ‰“å¼€|å»|è¿›å…¥).*(è´¦æœ¬|æˆå‘˜|é‚€è¯·)',
    ],
    VoiceIntentType.navigateToAccount: [
      r'(æ‰“å¼€|å»|æŸ¥çœ‹).*(è´¦æˆ·|ä¿¡ç”¨å¡|æŠ•èµ„)',
    ],
    VoiceIntentType.navigateToBudget: [
      r'(æ‰“å¼€|å»|æŸ¥çœ‹).*(é¢„ç®—|å‚¨è“„ç›®æ ‡|å¼€æ”¯ç›®æ ‡|å€ºåŠ¡|è¿˜æ¬¾)',
    ],
    VoiceIntentType.navigateToStats: [
      r'(æ‰“å¼€|å»|æŸ¥çœ‹).*(ç»Ÿè®¡|æŠ¥è¡¨|å¹´åº¦æŠ¥å‘Š|æœˆæŠ¥|èµ„äº§|è¶‹åŠ¿)',
    ],
    VoiceIntentType.navigateToData: [
      r'(æ‰“å¼€|å»).*(å¯¼å…¥|å¯¼å‡º|å¤‡ä»½|æ¢å¤|æ™ºèƒ½å¯¼å…¥)',
    ],
    VoiceIntentType.navigateToSettings: [
      r'(æ‰“å¼€|å»|è¿›å…¥).*(è®¾ç½®|è¯­è¨€è®¾ç½®|è´§å¸è®¾ç½®|ä¸»é¢˜è®¾ç½®)',
    ],
    VoiceIntentType.navigateToUser: [
      r'(æ‰“å¼€|å»).*(ç™»å½•|æ³¨å†Œ|å…³äº|å¸®åŠ©|ç”¨æˆ·åè®®)',
    ],
    VoiceIntentType.searchFunction: [
      r'(æ€ä¹ˆ|å¦‚ä½•|å“ªé‡Œ).*(è®¾ç½®|ä¿®æ”¹|æŸ¥çœ‹|å¯¼å‡º)',
      r'(æ‰¾|æœç´¢).*(åŠŸèƒ½|é¡µé¢)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - è®°è´¦ ====================
    VoiceIntentType.deleteLastTransaction: [
      r'(åˆ é™¤|åˆ æ‰).*(æœ€åä¸€ç¬”|åˆšæ‰é‚£ç¬”|ä¸Šä¸€ç¬”)',
    ],
    VoiceIntentType.undoOperation: [
      r'(æ’¤é”€|æ’¤å›|å–æ¶ˆ).*(ä¸Šæ¬¡|åˆšæ‰)?(æ“ä½œ)?',
    ],
    VoiceIntentType.editLastTransaction: [
      r'(ä¿®æ”¹|ç¼–è¾‘).*(åˆšæ‰|æœ€å|ä¸Šä¸€ç¬”)',
    ],
    VoiceIntentType.copyAsTemplate: [
      r'(å¤åˆ¶|ä¿å­˜).*(ä¸º|æˆ).*(æ¨¡æ¿)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - è´¦æœ¬åˆ‡æ¢ ====================
    VoiceIntentType.switchLedger: [
      r'(åˆ‡æ¢|æ¢åˆ°|æ‰“å¼€).*(è´¦æœ¬)',
    ],
    VoiceIntentType.switchToPersonal: [
      r'(åˆ‡æ¢|æ¢åˆ°).*(ä¸ªäºº|æˆ‘çš„).*(è´¦æœ¬)',
    ],
    VoiceIntentType.switchToFamily: [
      r'(åˆ‡æ¢|æ¢åˆ°).*(å®¶åº­|å…±äº«).*(è´¦æœ¬)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - ä¸»é¢˜ ====================
    VoiceIntentType.toggleDarkMode: [
      r'(åˆ‡æ¢).*(æ·±è‰²|æš—è‰²).*(æ¨¡å¼)',
    ],
    VoiceIntentType.enableDarkMode: [
      r'(å¼€å¯|æ‰“å¼€|å¯ç”¨).*(æ·±è‰²|æš—è‰²).*(æ¨¡å¼)',
    ],
    VoiceIntentType.disableDarkMode: [
      r'(å…³é—­|å…³æ‰|ç¦ç”¨).*(æ·±è‰²|æš—è‰²).*(æ¨¡å¼)',
      r'(åˆ‡æ¢|æ¢æˆ).*(æµ…è‰²|äº®è‰²).*(æ¨¡å¼)',
    ],
    VoiceIntentType.setThemeBlue: [
      r'(åˆ‡æ¢|æ¢æˆ).*(è“è‰²).*(ä¸»é¢˜)',
    ],
    VoiceIntentType.setThemeGreen: [
      r'(åˆ‡æ¢|æ¢æˆ).*(ç»¿è‰²).*(ä¸»é¢˜)',
    ],
    VoiceIntentType.setThemeRed: [
      r'(åˆ‡æ¢|æ¢æˆ).*(çº¢è‰²).*(ä¸»é¢˜)',
    ],
    VoiceIntentType.setThemePurple: [
      r'(åˆ‡æ¢|æ¢æˆ).*(ç´«è‰²).*(ä¸»é¢˜)',
    ],
    VoiceIntentType.setThemeOrange: [
      r'(åˆ‡æ¢|æ¢æˆ).*(æ©™è‰²).*(ä¸»é¢˜)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - è¯­è¨€ ====================
    VoiceIntentType.setLanguageZhCN: [
      r'(åˆ‡æ¢|æ¢æˆ).*(ä¸­æ–‡|ç®€ä½“)',
    ],
    VoiceIntentType.setLanguageEnUS: [
      r'(åˆ‡æ¢|æ¢æˆ).*(è‹±æ–‡|è‹±è¯­)',
    ],
    VoiceIntentType.setLanguageJaJP: [
      r'(åˆ‡æ¢|æ¢æˆ).*(æ—¥æ–‡|æ—¥è¯­)',
    ],
    VoiceIntentType.setLanguageZhTW: [
      r'(åˆ‡æ¢|æ¢æˆ).*(ç¹ä½“)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - è´§å¸ ====================
    VoiceIntentType.setCurrencyCNY: [
      r'(åˆ‡æ¢|æ¢æˆ).*(äººæ°‘å¸|CNY|å…ƒ)',
    ],
    VoiceIntentType.setCurrencyUSD: [
      r'(åˆ‡æ¢|æ¢æˆ).*(ç¾å…ƒ|ç¾é‡‘|USD)',
    ],
    VoiceIntentType.setCurrencyEUR: [
      r'(åˆ‡æ¢|æ¢æˆ).*(æ¬§å…ƒ|EUR)',
    ],
    VoiceIntentType.setCurrencyJPY: [
      r'(åˆ‡æ¢|æ¢æˆ).*(æ—¥å…ƒ|æ—¥å¸|JPY)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - å¼€å…³ ====================
    VoiceIntentType.enableAutoSync: [
      r'(å¼€å¯|æ‰“å¼€|å¯ç”¨).*(è‡ªåŠ¨åŒæ­¥)',
    ],
    VoiceIntentType.disableAutoSync: [
      r'(å…³é—­|å…³æ‰|ç¦ç”¨).*(è‡ªåŠ¨åŒæ­¥)',
    ],
    VoiceIntentType.enablePrivacyMode: [
      r'(å¼€å¯|æ‰“å¼€).*(éšç§æ¨¡å¼)',
      r'(éšè—|é®ä½).*(é‡‘é¢)',
    ],
    VoiceIntentType.disablePrivacyMode: [
      r'(å…³é—­|å…³æ‰).*(éšç§æ¨¡å¼)',
      r'(æ˜¾ç¤º|å±•ç¤º).*(é‡‘é¢)',
    ],
    VoiceIntentType.enableAppLock: [
      r'(å¼€å¯|æ‰“å¼€).*(åº”ç”¨é”)',
    ],
    VoiceIntentType.disableAppLock: [
      r'(å…³é—­|å…³æ‰).*(åº”ç”¨é”)',
    ],
    VoiceIntentType.enableSmartCategory: [
      r'(å¼€å¯|æ‰“å¼€).*(æ™ºèƒ½åˆ†ç±»)',
    ],
    VoiceIntentType.disableSmartCategory: [
      r'(å…³é—­|å…³æ‰).*(æ™ºèƒ½åˆ†ç±»)',
    ],
    VoiceIntentType.enableBookkeepingReminder: [
      r'(å¼€å¯|æ‰“å¼€).*(è®°è´¦æé†’)',
    ],
    VoiceIntentType.disableBookkeepingReminder: [
      r'(å…³é—­|å…³æ‰).*(è®°è´¦æé†’)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - æ•°æ® ====================
    VoiceIntentType.backupNow: [
      r'(ç«‹å³|é©¬ä¸Š|ç°åœ¨).*(å¤‡ä»½)',
      r'(å¤‡ä»½).*(æ•°æ®)',
    ],
    VoiceIntentType.syncNow: [
      r'(ç«‹å³|é©¬ä¸Š|ç°åœ¨).*(åŒæ­¥)',
      r'(åŒæ­¥).*(æ•°æ®)',
    ],
    VoiceIntentType.refresh: [
      r'(åˆ·æ–°).*(æ•°æ®)?',
    ],
    VoiceIntentType.forceRefresh: [
      r'(å¼ºåˆ¶|å¼ºè¡Œ).*(åˆ·æ–°)',
    ],
    VoiceIntentType.clearCache: [
      r'(æ¸…é™¤|æ¸…ç†|æ¸…ç©º).*(ç¼“å­˜)',
    ],
    VoiceIntentType.emptyTrash: [
      r'(æ¸…ç©º|æ¸…ç†).*(å›æ”¶ç«™)',
    ],
    VoiceIntentType.exportMonthData: [
      r'(å¯¼å‡º).*(æœ¬æœˆ|è¿™ä¸ªæœˆ).*(æ•°æ®)',
    ],
    VoiceIntentType.exportYearData: [
      r'(å¯¼å‡º).*(æœ¬å¹´|ä»Šå¹´|å…¨å¹´).*(æ•°æ®)',
    ],
    VoiceIntentType.exportAllData: [
      r'(å¯¼å‡º).*(å…¨éƒ¨|æ‰€æœ‰).*(æ•°æ®)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - å¿«æ· ====================
    VoiceIntentType.openCamera: [
      r'(æ‰“å¼€|å¼€å¯).*(ç›¸æœº|æ‘„åƒå¤´)',
    ],
    VoiceIntentType.openScanner: [
      r'(æ‰«ä¸€æ‰«|æ‰«ç |å¼€å§‹æ‰«ç )',
    ],
    VoiceIntentType.goHome: [
      r'(è¿”å›|å›åˆ°|å»).*(é¦–é¡µ|ä¸»é¡µ)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - ä¹ æƒ¯ ====================
    VoiceIntentType.habitCheckIn: [
      r'(æ‰“å¡|è®°è´¦æ‰“å¡|ä»Šå¤©æ‰“å¡)',
    ],
    VoiceIntentType.viewCheckInHistory: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(æ‰“å¡|æ‰“å¡è®°å½•)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - åˆ†äº« ====================
    VoiceIntentType.shareMonthlyReport: [
      r'(åˆ†äº«).*(æœˆæŠ¥|æœˆåº¦æŠ¥å‘Š)',
    ],
    VoiceIntentType.shareAnnualReport: [
      r'(åˆ†äº«).*(å¹´æŠ¥|å¹´åº¦æŠ¥å‘Š)',
    ],
    VoiceIntentType.shareTransaction: [
      r'(åˆ†äº«).*(è´¦å•|è¿™ç¬”)',
    ],
    VoiceIntentType.inviteFriend: [
      r'(é‚€è¯·).*(å¥½å‹|æœ‹å‹)',
    ],

    // ==================== ç›´æ¥æ“ä½œæ„å›¾ - ç³»ç»Ÿ ====================
    VoiceIntentType.checkUpdate: [
      r'(æ£€æŸ¥|æŸ¥çœ‹).*(æ›´æ–°)',
    ],
    VoiceIntentType.openFeedback: [
      r'(æäº¤|å‘é€).*(åé¦ˆ|å»ºè®®)',
    ],
    VoiceIntentType.contactSupport: [
      r'(è”ç³»|æ‰¾).*(å®¢æœ)',
    ],
    VoiceIntentType.logout: [
      r'(é€€å‡º|æ³¨é”€).*(ç™»å½•)',
    ],
    VoiceIntentType.deleteAccount: [
      r'(æ³¨é”€|åˆ é™¤).*(è´¦å·|è´¦æˆ·)',
    ],


    // ==================== AIæ™ºèƒ½ä¸­å¿ƒæ„å›¾ ====================
    VoiceIntentType.navigateToAI: [
      r'(æ‰“å¼€|è¿›å…¥).*(æ™ºèƒ½ä¸­å¿ƒ|AIä¸­å¿ƒ|AIè®¾ç½®)',
      r'(æ™ºèƒ½|AI).*(ä¸­å¿ƒ|è®¾ç½®)',
    ],
    VoiceIntentType.navigateToBillReminder: [
      r'(æ‰“å¼€|è¿›å…¥).*(è´¦å•æé†’|å®šæœŸè´¦å•)',
      r'(ä¿¡ç”¨å¡|è´¦å•).*(æé†’|åˆ°æœŸ)',
    ],
    VoiceIntentType.navigateToMonitor: [
      r'(æ‰“å¼€|è¿›å…¥).*(ç³»ç»Ÿç›‘æ§|æ€§èƒ½ç›‘æ§|åº”ç”¨çŠ¶æ€)',
      r'(ç›‘æ§|å¥åº·).*(çŠ¶æ€|æŠ¥å‘Š)',
    ],
    VoiceIntentType.openSmartCategory: [
      r'(æ‰“å¼€|è¿›å…¥).*(æ™ºèƒ½åˆ†ç±»|åˆ†ç±»ä¸­å¿ƒ)',
      r'(æ™ºèƒ½åˆ†ç±»).*(è®¾ç½®|é…ç½®)',
    ],
    VoiceIntentType.viewCategoryLearning: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(åˆ†ç±»å­¦ä¹ |å­¦ä¹ è®°å½•)',
      r'(åˆ†ç±»).*(å­¦ä¹ |è®­ç»ƒ).*(è®°å½•|å†å²)',
    ],
    VoiceIntentType.trainCategory: [
      r'(é‡æ–°|å†æ¬¡).*(è®­ç»ƒ|å­¦ä¹ ).*(åˆ†ç±»)',
      r'(åˆ†ç±»).*(æ¨¡å‹).*(è®­ç»ƒ|æ›´æ–°)',
    ],
    VoiceIntentType.viewTrendPrediction: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(è¶‹åŠ¿é¢„æµ‹|æ¶ˆè´¹é¢„æµ‹)',
      r'(é¢„æµ‹).*(æ¶ˆè´¹|æ”¯å‡º)',
    ],
    VoiceIntentType.predictNextMonth: [
      r'(é¢„æµ‹).*(ä¸‹ä¸ªæœˆ|ä¸‹æœˆ).*(æ¶ˆè´¹|æ”¯å‡º)',
      r'(ä¸‹ä¸ªæœˆ|ä¸‹æœˆ).*(é¢„è®¡|å¤§æ¦‚).*(èŠ±å¤šå°‘|æ¶ˆè´¹)',
    ],
    VoiceIntentType.openAnomalySettings: [
      r'(æ‰“å¼€|è¿›å…¥).*(å¼‚å¸¸æ£€æµ‹|å¼‚å¸¸è®¾ç½®)',
      r'(å¼‚å¸¸).*(æ£€æµ‹|äº¤æ˜“).*(è®¾ç½®|é…ç½®)',
    ],
    VoiceIntentType.viewAnomalyTransactions: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(å¼‚å¸¸äº¤æ˜“|å¯ç–‘äº¤æ˜“)',
      r'(æœ‰æ²¡æœ‰|æ˜¯å¦æœ‰).*(å¼‚å¸¸|å¯ç–‘).*(äº¤æ˜“)',
    ],
    VoiceIntentType.enableAnomalyDetection: [
      r'(å¼€å¯|æ‰“å¼€).*(å¼‚å¸¸æ£€æµ‹)',
    ],
    VoiceIntentType.disableAnomalyDetection: [
      r'(å…³é—­|å…³æ‰).*(å¼‚å¸¸æ£€æµ‹)',
    ],
    VoiceIntentType.smartSearch: [
      r'(æ™ºèƒ½æœç´¢|è‡ªç„¶è¯­è¨€æœç´¢)',
      r'(å¸®æˆ‘æ‰¾|æœç´¢).*(äº¤æ˜“|è´¦å•|æ¶ˆè´¹)',
    ],
    VoiceIntentType.searchByDescription: [
      r'(æŒ‰æè¿°|æ ¹æ®æè¿°).*(æœç´¢|æŸ¥æ‰¾)',
    ],
    VoiceIntentType.openDialogSettings: [
      r'(æ‰“å¼€|è¿›å…¥).*(å¯¹è¯åŠ©æ‰‹|å¯¹è¯è®¾ç½®)',
      r'(å¯¹è¯).*(åŠ©æ‰‹|è®¾ç½®|é…ç½®)',
    ],
    VoiceIntentType.viewDialogHistory: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(å¯¹è¯å†å²|å¯¹è¯è®°å½•)',
    ],
    VoiceIntentType.openVoiceConfig: [
      r'(æ‰“å¼€|è¿›å…¥).*(è¯­éŸ³é…ç½®|è¯­éŸ³è®¾ç½®)',
      r'(è¯­éŸ³).*(é…ç½®|è®¾ç½®)',
    ],
    VoiceIntentType.setWakeWord: [
      r'(è®¾ç½®|æ›´æ”¹).*(å”¤é†’è¯)',
    ],
    VoiceIntentType.setVoiceLanguage: [
      r'(è®¾ç½®|æ›´æ”¹).*(è¯­éŸ³è¯­è¨€|è¯†åˆ«è¯­è¨€)',
    ],
    VoiceIntentType.viewAICost: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(AIæˆæœ¬|AIè´¹ç”¨)',
      r'(AI).*(èŠ±äº†|æ¶ˆè€—).*(å¤šå°‘)',
    ],
    VoiceIntentType.viewAIUsage: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(AIä½¿ç”¨|AIç”¨é‡)',
      r'(AI).*(è°ƒç”¨|ä½¿ç”¨).*(æ¬¡æ•°|æƒ…å†µ)',
    ],
    VoiceIntentType.viewLearningReport: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(å­¦ä¹ æŠ¥å‘Š|æ™ºèƒ½å­¦ä¹ )',
      r'(AI).*(å­¦ä¹ |è®­ç»ƒ).*(æ•ˆæœ|æŠ¥å‘Š)',
    ],
    VoiceIntentType.viewAccuracyTrend: [
      r'(æŸ¥çœ‹|çœ‹çœ‹).*(å‡†ç¡®ç‡|è¯†åˆ«ç‡)',
      r'(åˆ†ç±»|è¯†åˆ«).*(å‡†ç¡®ç‡|è¶‹åŠ¿)',
    ],

    // ==================== æŸ¥è¯¢æ„å›¾ ====================
    VoiceIntentType.queryExpense: [
      r'(è¿™ä¸ªæœˆ|ä»Šå¤©|ä¸Šå‘¨|æœ¬å‘¨|æ˜¨å¤©).*(èŠ±äº†|æ¶ˆè´¹|æ”¯å‡º)',
      r'(èŠ±äº†å¤šå°‘|æ¶ˆè´¹æƒ…å†µ|æ”¯å‡ºç»Ÿè®¡)',
      r'(é¤é¥®|äº¤é€š|è´­ç‰©).*(èŠ±äº†|æ¶ˆè´¹)',
    ],
    VoiceIntentType.queryIncome: [
      r'(è¿™ä¸ªæœˆ|ä»Šå¤©|ä¸Šå‘¨).*(æ”¶å…¥|å…¥è´¦|èµšäº†)',
      r'(æ”¶å…¥å¤šå°‘|èµšäº†å¤šå°‘)',
    ],
    VoiceIntentType.queryBudget: [
      r'(é¢„ç®—).*(è¿˜å‰©|å‰©ä½™|è¶…æ”¯|å¤Ÿä¸å¤Ÿ)',
      r'(.*é¢„ç®—).*(æƒ…å†µ|å¤šå°‘)',
    ],
    VoiceIntentType.queryMoneyAge: [
      r'(é’±é¾„|èµ„é‡‘å¹´é¾„|æŒæœ‰å¤šä¹…|å­˜äº†å¤šä¹…)',
      r'(èµ„é‡‘).*(ç»“æ„|åˆ†å¸ƒ|å¥åº·)',
    ],
    VoiceIntentType.queryTrend: [
      r'(è¶‹åŠ¿|å˜åŒ–|å¯¹æ¯”|ç¯æ¯”|åŒæ¯”)',
    ],
    VoiceIntentType.queryBalance: [
      r'(è¿˜å‰©|ä½™é¢|è´¦æˆ·).*(å¤šå°‘|æƒ…å†µ)',
    ],
    VoiceIntentType.queryStats: [
      r'(æœ¬æœˆ|è¿™ä¸ªæœˆ).*(ç»Ÿè®¡|åˆ†æ)',
      r'(åˆ†ç±»).*(å æ¯”|æ¯”ä¾‹)',
    ],
    VoiceIntentType.queryGoal: [
      r'(ç›®æ ‡).*(è¿›åº¦|å®Œæˆ|è¿˜å·®)',
      r'(å‚¨è“„|æ”’é’±).*(è¿›åº¦)',
    ],
    VoiceIntentType.queryDebt: [
      r'(å€ºåŠ¡|æ¬ æ¬¾|è´·æ¬¾).*(è¿›åº¦|å‰©ä½™|è¿˜æ¬ )',
    ],

    // ==================== åé¦ˆæ„å›¾ ====================
    VoiceIntentType.feedback: [
      r'(åé¦ˆ|å»ºè®®|é—®é¢˜|æŠ•è¯‰)',
      r'(æˆ‘è¦|æˆ‘æƒ³).*(åé¦ˆ|åæ§½)',
    ],

    // ==================== å¸®åŠ©æ„å›¾ ====================
    VoiceIntentType.help: [
      r'(å¸®åŠ©|æ€ä¹ˆç”¨|ä½¿ç”¨è¯´æ˜)',
      r'(æ•™æˆ‘|å‘Šè¯‰æˆ‘).*(æ€ä¹ˆ|å¦‚ä½•)',
    ],

    // ==================== å–æ¶ˆ/ç¡®è®¤ ====================
    VoiceIntentType.cancel: [
      r'(å–æ¶ˆ|ç®—äº†|ä¸è¦äº†|ä¸ç”¨äº†)',
    ],
    VoiceIntentType.confirm: [
      r'(ç¡®è®¤|ç¡®å®š|æ˜¯çš„|å¥½çš„|å¯ä»¥|æ²¡é—®é¢˜)',
    ],
  };

  /// è¯†åˆ«ç”¨æˆ·æ„å›¾
  Future<VoiceIntent> recognizeIntent(String voiceText) async {
    // ===== ç¬¬ä¸€å±‚ï¼šè§„åˆ™åŒ¹é…ï¼ˆå¿«é€Ÿã€ç¡®å®šæ€§é«˜ã€é›¶æˆæœ¬ï¼‰ =====
    final ruleResult = _ruleMatcher.match(voiceText, _intentPatterns);
    if (ruleResult != null && ruleResult.confidence > 0.8) {
      return VoiceIntent(
        type: ruleResult.intentType,
        confidence: ruleResult.confidence,
        entities: ruleResult.entities,
        source: IntentSource.rule,
        rawText: voiceText,
      );
    }

    // ===== ç¬¬äºŒå±‚ï¼šå¤§æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆå¤„ç†å¤æ‚è¡¨è¾¾ï¼‰ =====
    try {
      final llmResult = await _llmService.recognizeVoiceIntent(
        text: voiceText,
        availableIntents: VoiceIntentType.values.map((e) => e.name).toList(),
        intentDescriptions: _getIntentDescriptions(),
      );

      if (llmResult.confidence > 0.6) {
        return VoiceIntent(
          type: _parseIntentType(llmResult.intentName),
          confidence: llmResult.confidence,
          entities: llmResult.entities,
          source: IntentSource.llm,
          rawText: voiceText,
        );
      }
    } catch (e) {
      debugPrint('LLM intent recognition failed: $e');
    }

    // ===== å…œåº•ï¼šè¿”å›æœªçŸ¥æ„å›¾ =====
    return VoiceIntent(
      type: VoiceIntentType.unknown,
      confidence: 0.0,
      entities: {},
      source: IntentSource.fallback,
      rawText: voiceText,
    );
  }

  /// è·å–æ„å›¾æè¿°ï¼ˆç”¨äºLLMç†è§£ï¼‰
  Map<String, String> _getIntentDescriptions() {
    return {
      'addExpense': 'è®°å½•ä¸€ç¬”æ”¯å‡º/æ¶ˆè´¹',
      'addIncome': 'è®°å½•ä¸€ç¬”æ”¶å…¥',
      'setBudget': 'è®¾ç½®æˆ–ä¿®æ”¹é¢„ç®—é‡‘é¢',
      'navigateTo': 'æ‰“å¼€æŸä¸ªé¡µé¢æˆ–åŠŸèƒ½',
      'toggleDarkMode': 'åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼',
      'setLanguageZhCN': 'åˆ‡æ¢åˆ°ä¸­æ–‡',
      'setLanguageEnUS': 'åˆ‡æ¢åˆ°è‹±æ–‡',
      'enableAutoSync': 'å¼€å¯è‡ªåŠ¨åŒæ­¥',
      'disableAutoSync': 'å…³é—­è‡ªåŠ¨åŒæ­¥',
      'backupNow': 'ç«‹å³å¤‡ä»½æ•°æ®',
      'syncNow': 'ç«‹å³åŒæ­¥æ•°æ®',
      'habitCheckIn': 'è®°è´¦æ‰“å¡',
      'queryExpense': 'æŸ¥è¯¢æ¶ˆè´¹/æ”¯å‡ºæƒ…å†µ',
      'queryBudget': 'æŸ¥è¯¢é¢„ç®—å‰©ä½™æƒ…å†µ',
      'feedback': 'ç”¨æˆ·æƒ³è¦åé¦ˆé—®é¢˜æˆ–å»ºè®®',
      // ... å…¶ä»–æ„å›¾æè¿°
    };
  }
}

/// è¯­éŸ³æ„å›¾æ•°æ®ç±»
class VoiceIntent {
  final VoiceIntentType type;
  final double confidence;
  final Map<String, dynamic> entities;  // æå–çš„å®ä½“ï¼šé‡‘é¢ã€åˆ†ç±»ã€æ—¥æœŸç­‰
  final IntentSource source;
  final String rawText;

  VoiceIntent({
    required this.type,
    required this.confidence,
    required this.entities,
    required this.source,
    required this.rawText,
  });

  /// æ˜¯å¦ä¸ºç›´æ¥æ“ä½œæ„å›¾ï¼ˆæ— éœ€è¿›å…¥é¡µé¢å³å¯æ‰§è¡Œï¼‰
  bool get isDirectAction => _directActionIntents.contains(type);

  /// æ˜¯å¦ä¸ºå¯¼èˆªæ„å›¾
  bool get isNavigation => type.name.startsWith('navigateTo');

  /// æ˜¯å¦ä¸ºé…ç½®æ„å›¾
  bool get isConfiguration => type.name.startsWith('set');

  /// æ˜¯å¦ä¸ºæŸ¥è¯¢æ„å›¾
  bool get isQuery => type.name.startsWith('query');

  /// æ˜¯å¦éœ€è¦ç¡®è®¤
  bool get needsConfirmation => _confirmationRequiredIntents.contains(type);

  static const Set<VoiceIntentType> _directActionIntents = {
    VoiceIntentType.deleteLastTransaction,
    VoiceIntentType.undoOperation,
    VoiceIntentType.toggleDarkMode,
    VoiceIntentType.enableDarkMode,
    VoiceIntentType.disableDarkMode,
    VoiceIntentType.setThemeBlue,
    VoiceIntentType.setThemeGreen,
    VoiceIntentType.setThemeRed,
    VoiceIntentType.setThemePurple,
    VoiceIntentType.setThemeOrange,
    VoiceIntentType.setLanguageZhCN,
    VoiceIntentType.setLanguageEnUS,
    VoiceIntentType.setLanguageJaJP,
    VoiceIntentType.setLanguageZhTW,
    VoiceIntentType.setCurrencyCNY,
    VoiceIntentType.setCurrencyUSD,
    VoiceIntentType.setCurrencyEUR,
    VoiceIntentType.setCurrencyJPY,
    VoiceIntentType.enableAutoSync,
    VoiceIntentType.disableAutoSync,
    VoiceIntentType.enablePrivacyMode,
    VoiceIntentType.disablePrivacyMode,
    VoiceIntentType.backupNow,
    VoiceIntentType.syncNow,
    VoiceIntentType.refresh,
    VoiceIntentType.habitCheckIn,
    VoiceIntentType.openCamera,
    VoiceIntentType.openScanner,
    VoiceIntentType.goHome,
  };

  static const Set<VoiceIntentType> _confirmationRequiredIntents = {
    VoiceIntentType.deleteLastTransaction,
    VoiceIntentType.emptyTrash,
    VoiceIntentType.logout,
    VoiceIntentType.deleteAccount,
    VoiceIntentType.resetBudget,
    VoiceIntentType.exportAllData,
    VoiceIntentType.enableAppLock,
    VoiceIntentType.disableAppLock,
  };
}

enum IntentSource { rule, llm, fallback, learne

### 18.1.1 æ„å›¾è¯†åˆ«è‡ªå­¦ä¹ æ¨¡å‹

é€šè¿‡æŒç»­ç§¯ç´¯ç”¨æˆ·äº¤äº’æ•°æ®ï¼Œæ„å»ºä¸ªæ€§åŒ–æ„å›¾è¯†åˆ«æ¨¡å‹ï¼Œä¸æ–­æå‡è¯†åˆ«å‡†ç¡®ç‡ã€‚

#### 18.1.1.1 è‡ªå­¦ä¹ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ„å›¾è¯†åˆ«è‡ªå­¦ä¹ ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æ•°æ®é‡‡é›†å±‚                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ è¯­éŸ³è¾“å…¥    â”‚  â”‚ è¯†åˆ«ç»“æœ    â”‚  â”‚ ç”¨æˆ·åé¦ˆ    â”‚  â”‚ è¡Œä¸ºè½¨è¿¹    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ åŸå§‹æ–‡æœ¬  â”‚  â”‚ â€¢ æ„å›¾ç±»å‹  â”‚  â”‚ â€¢ ç¡®è®¤/ä¿®æ”¹ â”‚  â”‚ â€¢ ç‚¹å‡»æ“ä½œ  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ è¯­éŸ³ç‰¹å¾  â”‚  â”‚ â€¢ ç½®ä¿¡åº¦    â”‚  â”‚ â€¢ å–æ¶ˆ/é‡è¯´ â”‚  â”‚ â€¢ åœç•™æ—¶é—´  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ä¸Šä¸‹æ–‡    â”‚  â”‚ â€¢ è¯†åˆ«æº    â”‚  â”‚ â€¢ è¯„åˆ†åé¦ˆ  â”‚  â”‚ â€¢ æœ€ç»ˆé€‰æ‹©  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æ ·æœ¬æ ‡æ³¨å±‚                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚  â”‚    è‡ªåŠ¨æ ‡æ³¨å¼•æ“        â”‚  â”‚    äººå·¥æ ¡æ­£é€šé“        â”‚                   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ç”¨æˆ·ç¡®è®¤ â†’ æ­£æ ·æœ¬   â”‚  â”‚  â€¢ ç”¨æˆ·ä¿®æ”¹ â†’ æ ¡æ­£æ ·æœ¬ â”‚                   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ‰§è¡ŒæˆåŠŸ â†’ æ­£æ ·æœ¬   â”‚  â”‚  â€¢ ç”¨æˆ·å–æ¶ˆ â†’ è´Ÿæ ·æœ¬   â”‚                   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ é«˜ç½®ä¿¡åº¦ â†’ å¼±æ­£æ ·æœ¬ â”‚  â”‚  â€¢ é‡æ–°è¾“å…¥ â†’ å‚è€ƒæ ·æœ¬ â”‚                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æ¨¡å‹è®­ç»ƒå±‚                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ è§„åˆ™æŒ–æ˜    â”‚  â”‚ æ¨¡å¼å­¦ä¹     â”‚  â”‚ ä¸ªæ€§åŒ–é€‚é…  â”‚  â”‚ åœ¨çº¿æ›´æ–°    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ é«˜é¢‘æ¨¡å¼  â”‚  â”‚ â€¢ è¡¨è¾¾ä¹ æƒ¯  â”‚  â”‚ â€¢ ç”¨æˆ·åå¥½  â”‚  â”‚ â€¢ å¢é‡å­¦ä¹   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ–°è¡¨è¾¾    â”‚  â”‚ â€¢ è¯æ±‡æ‰©å±•  â”‚  â”‚ â€¢ åœºæ™¯ä¸Šä¸‹æ–‡â”‚  â”‚ â€¢ å®æ—¶åé¦ˆ  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ è§„åˆ™ç”Ÿæˆ  â”‚  â”‚ â€¢ åŒä¹‰æ˜ å°„  â”‚  â”‚ â€¢ æ—¶é—´è§„å¾‹  â”‚  â”‚ â€¢ A/Bæµ‹è¯•   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æ¨¡å‹åº”ç”¨å±‚                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚              å¤šçº§è¯†åˆ«ç­–ç•¥ï¼ˆå¸¦è‡ªå­¦ä¹ å¢å¼ºï¼‰                         â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  Level 1: ç”¨æˆ·ä¸ªæ€§åŒ–è§„åˆ™ï¼ˆè‡ªå­¦ä¹ ç”Ÿæˆï¼‰â†’ æœ€é«˜ä¼˜å…ˆçº§             â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  Level 2: å…¨å±€è§„åˆ™åŒ¹é…ï¼ˆåŸºç¡€è§„åˆ™åº“ï¼‰                            â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  Level 3: ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆå­¦ä¹ åˆ°çš„è¡¨è¾¾æ¨¡å¼ï¼‰                        â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  Level 4: LLM å…œåº•ï¼ˆå¸¦ä¸ªæ€§åŒ– Prompt å¢å¼ºï¼‰                      â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 18.1.1.2 æ•°æ®é‡‡é›†ä¸æ ·æœ¬æ„å»º

```dart
/// æ„å›¾è¯†åˆ«å­¦ä¹ æ ·æœ¬
class IntentLearningSample {
  final String id;
  final String rawInput;              // åŸå§‹è¾“å…¥æ–‡æœ¬
  final String normalizedInput;       // æ ‡å‡†åŒ–åçš„æ–‡æœ¬
  final VoiceIntentType predictedIntent;  // ç³»ç»Ÿé¢„æµ‹çš„æ„å›¾
  final VoiceIntentType? actualIntent;    // å®é™…æ„å›¾ï¼ˆç”¨æˆ·ç¡®è®¤/ä¿®æ”¹åï¼‰
  final double confidence;            // é¢„æµ‹ç½®ä¿¡åº¦
  final IntentSource source;          // è¯†åˆ«æ¥æº
  final SampleLabel label;            // æ ·æœ¬æ ‡ç­¾
  final Map<String, dynamic> context; // ä¸Šä¸‹æ–‡ä¿¡æ¯
  final DateTime timestamp;
  final String userId;

  /// æ ·æœ¬è´¨é‡è¯„åˆ†ï¼ˆ0-1ï¼‰
  double get qualityScore {
    var score = 0.0;
    // ç”¨æˆ·æ˜ç¡®ç¡®è®¤çš„æ ·æœ¬è´¨é‡æœ€é«˜
    if (label == SampleLabel.confirmedPositive) score += 0.5;
    // ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹æä¾›çš„æ ·æœ¬æ¬¡ä¹‹
    if (label == SampleLabel.corrected) score += 0.4;
    // é«˜ç½®ä¿¡åº¦æ ·æœ¬
    if (confidence > 0.9) score += 0.2;
    // æœ‰å®Œæ•´ä¸Šä¸‹æ–‡
    if (context.isNotEmpty) score += 0.1;
    // æœ€è¿‘çš„æ ·æœ¬æƒé‡æ›´é«˜
    final daysSince = DateTime.now().difference(timestamp).inDays;
    score *= (1 - daysSince / 365).clamp(0.5, 1.0);
    return score.clamp(0.0, 1.0);
  }
}

/// æ ·æœ¬æ ‡ç­¾ç±»å‹
enum SampleLabel {
  confirmedPositive,  // ç”¨æˆ·ç¡®è®¤çš„æ­£æ ·æœ¬
  corrected,          // ç”¨æˆ·ä¿®æ”¹åçš„æ ¡æ­£æ ·æœ¬
  implicitPositive,   // éšå¼æ­£æ ·æœ¬ï¼ˆæ‰§è¡ŒæˆåŠŸæ— æŠ•è¯‰ï¼‰
  weakPositive,       // å¼±æ­£æ ·æœ¬ï¼ˆé«˜ç½®ä¿¡åº¦æœªç¡®è®¤ï¼‰
  negative,           // è´Ÿæ ·æœ¬ï¼ˆç”¨æˆ·å–æ¶ˆ/æ‹’ç»ï¼‰
  ambiguous,          // æ­§ä¹‰æ ·æœ¬ï¼ˆéœ€äººå·¥å®¡æ ¸ï¼‰
}

/// æ•°æ®é‡‡é›†æœåŠ¡
class IntentDataCollector {
  final DatabaseService _db;
  final AnalyticsService _analytics;

  /// é‡‡é›†è¯†åˆ«ç»“æœ
  Future<void> collectRecognitionResult({
    required String rawInput,
    required VoiceIntentType predictedIntent,
    required double confidence,
    required IntentSource source,
    required Map<String, dynamic> context,
  }) async {
    final sample = IntentLearningSample(
      id: _generateId(),
      rawInput: rawInput,
      normalizedInput: _normalize(rawInput),
      predictedIntent: predictedIntent,
      actualIntent: null,  // å¾…ç”¨æˆ·åé¦ˆåæ›´æ–°
      confidence: confidence,
      source: source,
      label: SampleLabel.weakPositive,
      context: context,
      timestamp: DateTime.now(),
      userId: _currentUserId,
    );
    await _db.insertLearningSample(sample);
  }

  /// é‡‡é›†ç”¨æˆ·åé¦ˆ
  Future<void> collectUserFeedback({
    required String sampleId,
    required UserFeedbackType feedbackType,
    VoiceIntentType? correctedIntent,
  }) async {
    final sample = await _db.getLearningSample(sampleId);
    if (sample == null) return;

    final updatedSample = sample.copyWith(
      actualIntent: correctedIntent ?? sample.predictedIntent,
      label: _mapFeedbackToLabel(feedbackType, sample),
    );
    await _db.updateLearningSample(updatedSample);

    // è§¦å‘å¢é‡å­¦ä¹ 
    if (updatedSample.qualityScore > 0.7) {
      await _triggerIncrementalLearning(updatedSample);
    }
  }
}

enum UserFeedbackType { confirm, modify, cancel, retry, executeSuccess }
```

#### 18.1.1.3 è‡ªå­¦ä¹ æ¨¡å‹è®­ç»ƒ

```dart
/// æ„å›¾è¯†åˆ«è‡ªå­¦ä¹ æœåŠ¡
class IntentLearningService {
  final DatabaseService _db;
  final RuleEngine _ruleEngine;
  final PatternMatcher _patternMatcher;

  /// ä»é«˜è´¨é‡æ ·æœ¬ä¸­æŒ–æ˜æ–°è§„åˆ™
  Future<List<LearnedRule>> mineRulesFromSamples() async {
    final samples = await _db.getHighQualitySamples(
      minQualityScore: 0.8,
      minCount: 5,  // è‡³å°‘5ä¸ªç›¸ä¼¼æ ·æœ¬æ‰ç”Ÿæˆè§„åˆ™
    );

    final rules = <LearnedRule>[];
    final groupedByIntent = _groupByIntent(samples);

    for (final entry in groupedByIntent.entries) {
      final intent = entry.key;
      final intentSamples = entry.value;

      // æå–é«˜é¢‘æ¨¡å¼
      final patterns = _extractPatterns(intentSamples);

      for (final pattern in patterns) {
        if (pattern.frequency >= 3 && pattern.confidence >= 0.9) {
          rules.add(LearnedRule(
            id: _generateRuleId(),
            pattern: pattern.regex,
            intent: intent,
            confidence: pattern.confidence,
            frequency: pattern.frequency,
            examples: pattern.examples.take(5).toList(),
            createdAt: DateTime.now(),
            source: RuleSource.learned,
          ));
        }
      }
    }
    return rules;
  }

  /// æ„å»ºç”¨æˆ·ä¸ªæ€§åŒ–æ„å›¾æ¨¡å‹
  Future<PersonalizedIntentModel> buildPersonalizedModel(String userId) async {
    final userSamples = await _db.getUserSamples(userId);

    return PersonalizedIntentModel(
      userId: userId,
      expressionHabits: _analyzeExpressionHabits(userSamples),
      intentFrequency: _analyzeIntentFrequency(userSamples),
      contextPreferences: _analyzeContextPreferences(userSamples),
      timePatterns: _analyzeTimePatterns(userSamples),
      learnedRules: await _getUserLearnedRules(userId),
      lastUpdated: DateTime.now(),
    );
  }

  /// å¢é‡æ›´æ–°æ¨¡å‹
  Future<void> incrementalUpdate(IntentLearningSample newSample) async {
    // 1. æ›´æ–°ç”¨æˆ·ä¸ªæ€§åŒ–æ¨¡å‹
    await _updatePersonalizedModel(newSample);

    // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ–°è§„åˆ™
    final similarSamples = await _db.findSimilarSamples(
      newSample.normalizedInput,
      limit: 10,
    );

    if (similarSamples.length >= 3) {
      final newRule = _tryGenerateRule(newSample, similarSamples);
      if (newRule != null) {
        await _ruleEngine.addLearnedRule(newRule);
      }
    }

    // 3. æ›´æ–°ç›¸ä¼¼åº¦ç´¢å¼•
    await _patternMatcher.updateIndex(newSample);
  }
}

/// å­¦ä¹ åˆ°çš„è§„åˆ™
class LearnedRule {
  final String id;
  final String pattern;          // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
  final VoiceIntentType intent;  // ç›®æ ‡æ„å›¾
  final double confidence;       // ç½®ä¿¡åº¦
  final int frequency;           // å‡ºç°é¢‘æ¬¡
  final List<String> examples;   // ç¤ºä¾‹
  final DateTime createdAt;
  final RuleSource source;

  bool get isReliable => confidence >= 0.9 && frequency >= 5;
}

enum RuleSource { builtin, learned, userCustom }

/// ç”¨æˆ·ä¸ªæ€§åŒ–æ„å›¾æ¨¡å‹
class PersonalizedIntentModel {
  final String userId;
  final ExpressionHabits expressionHabits;
  final Map<VoiceIntentType, double> intentFrequency;
  final Map<String, dynamic> contextPreferences;
  final TimePatterns timePatterns;
  final List<LearnedRule> learnedRules;
  final DateTime lastUpdated;

  /// è·å–æ„å›¾å…ˆéªŒæ¦‚ç‡
  double getIntentPrior(VoiceIntentType intent) {
    return intentFrequency[intent] ?? 0.01;
  }

  /// æ ¹æ®æ—¶é—´è°ƒæ•´æ„å›¾æ¦‚ç‡ï¼ˆè´å¶æ–¯ï¼‰
  double adjustByTime(VoiceIntentType intent, DateTime time) {
    final hourProbability = timePatterns.getHourProbability(intent, time.hour);
    final dayProbability = timePatterns.getDayProbability(intent, time.weekday);
    return hourProbability * dayProbability;
  }
}
```

#### 18.1.1.4 å¢å¼ºçš„æ„å›¾è¯†åˆ«æµç¨‹

```dart
/// å¸¦è‡ªå­¦ä¹ å¢å¼ºçš„æ„å›¾è¯†åˆ«æœåŠ¡
class EnhancedIntentRecognitionService {
  final RuleEngine _ruleEngine;
  final IntentLearningService _learningService;
  final LLMService _llmService;
  final IntentDataCollector _dataCollector;

  /// è¯†åˆ«æ„å›¾ï¼ˆå››çº§ç­–ç•¥ + è‡ªå­¦ä¹ å¢å¼ºï¼‰
  Future<IntentRecognitionResult> recognizeIntent(
    String input, {
    Map<String, dynamic>? context,
  }) async {
    final normalizedInput = _normalize(input);
    final userId = _getCurrentUserId();

    // è·å–ç”¨æˆ·ä¸ªæ€§åŒ–æ¨¡å‹
    final personalModel = await _learningService.getPersonalizedModel(userId);

    // Level 1: ç”¨æˆ·ä¸ªæ€§åŒ–è§„åˆ™ï¼ˆè‡ªå­¦ä¹ ç”Ÿæˆï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    final personalResult = await _matchPersonalRules(normalizedInput, personalModel);
    if (personalResult != null && personalResult.confidence >= 0.95) {
      await _collectSample(input, personalResult, IntentSource.learned);
      return personalResult;
    }

    // Level 2: å…¨å±€è§„åˆ™åŒ¹é…
    final ruleResult = await _ruleEngine.match(normalizedInput);
    if (ruleResult != null && ruleResult.confidence >= 0.9) {
      final adjustedConfidence = _adjustWithPrior(
        ruleResult.confidence, ruleResult.intent, personalModel);
      await _collectSample(input, ruleResult, IntentSource.rule);
      return ruleResult.copyWith(confidence: adjustedConfidence);
    }

    // Level 3: ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆåŸºäºå­¦ä¹ åˆ°çš„è¡¨è¾¾æ¨¡å¼ï¼‰
    final similarResult = await _matchSimilarPatterns(normalizedInput, personalModel);
    if (similarResult != null && similarResult.confidence >= 0.85) {
      await _collectSample(input, similarResult, IntentSource.learned);
      return similarResult;
    }

    // Level 4: LLM å…œåº•ï¼ˆå¸¦ä¸ªæ€§åŒ– Prompt å¢å¼ºï¼‰
    final llmResult = await _llmRecognize(input,
      personalModel: personalModel, context: context);
    await _collectSample(input, llmResult, IntentSource.llm);
    return llmResult;
  }

  /// æ„å»ºä¸ªæ€§åŒ– Prompt
  String _buildPersonalizedPrompt(
    String input,
    PersonalizedIntentModel? model,
    Map<String, dynamic>? context,
  ) {
    final buffer = StringBuffer();
    buffer.writeln('è¯·è¯†åˆ«ä»¥ä¸‹è¯­éŸ³è¾“å…¥çš„æ„å›¾ï¼š');
    buffer.writeln('è¾“å…¥ï¼š"$input"');

    if (model != null) {
      buffer.writeln('\nç”¨æˆ·ä¹ æƒ¯å‚è€ƒï¼š');
      // é«˜é¢‘æ„å›¾
      final topIntents = model.intentFrequency.entries.toList()
        ..sort((a, b) => b.value.compareTo(a.value));
      buffer.writeln('- å¸¸ç”¨æ„å›¾ï¼š${topIntents.take(5).map((e) => e.key.name).join('ã€')}');
      // åŒä¹‰è¯æ˜ å°„
      if (model.expressionHabits.synonymMappings.isNotEmpty) {
        buffer.writeln('- ç”¨æˆ·åŒä¹‰è¯ï¼š');
        for (final entry in model.expressionHabits.synonymMappings.entries.take(5)) {
          buffer.writeln('  "${entry.key}" â†’ "${entry.value}"');
        }
      }
    }
    return buffer.toString();
  }

  /// åº”ç”¨å…ˆéªŒæ¦‚ç‡è°ƒæ•´ç½®ä¿¡åº¦ï¼ˆè´å¶æ–¯ï¼‰
  double _adjustWithPrior(double confidence, VoiceIntentType intent,
      PersonalizedIntentModel? model) {
    if (model == null) return confidence;
    final prior = model.getIntentPrior(intent);
    final timeAdjust = model.adjustByTime(intent, DateTime.now());
    return (confidence * prior * timeAdjust).clamp(0.0, 1.0);
  }
}
```

#### 18.1.1.5 å­¦ä¹ æ•ˆæœè¯„ä¼°ä¸ç›‘æ§

```dart
/// è‡ªå­¦ä¹ æ•ˆæœè¯„ä¼°æœåŠ¡
class LearningEvaluationService {
  /// è¯„ä¼°æŒ‡æ ‡
  Future<LearningMetrics> evaluateLearningEffect() async {
    return LearningMetrics(
      overallAccuracy: await _calculateOverallAccuracy(),
      intentAccuracy: await _calculateIntentAccuracy(),
      learnedRuleContribution: await _calculateLearnedRuleContribution(),
      userSatisfaction: await _calculateUserSatisfaction(),
      latencyTrend: await _analyzeLatencyTrend(),
      ruleCoverageTrend: await _analyzeRuleCoverageTrend(),
    );
  }

  /// ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š
  Future<LearningReport> generateLearningReport() async {
    final metrics = await evaluateLearningEffect();
    return LearningReport(
      period: DateRange.last30Days(),
      metrics: metrics,
      improvements: await _identifyImprovements(),
      recommendations: await _generateRecommendations(metrics),
      newRulesCount: await _countNewRules(days: 30),
      topLearnedPatterns: await _getTopLearnedPatterns(limit: 10),
    );
  }
}

/// å­¦ä¹ æŒ‡æ ‡
class LearningMetrics {
  double overallAccuracy;           // æ•´ä½“å‡†ç¡®ç‡
  Map<VoiceIntentType, double> intentAccuracy;  // å„æ„å›¾å‡†ç¡®ç‡
  double learnedRuleContribution;   // è‡ªå­¦ä¹ è§„åˆ™è´¡çŒ®ç‡
  double userSatisfaction;          // ç”¨æˆ·æ»¡æ„åº¦
  List<double> latencyTrend;        // å»¶è¿Ÿè¶‹åŠ¿
  List<double> ruleCoverageTrend;   // è§„åˆ™è¦†ç›–ç‡è¶‹åŠ¿

  /// æ˜¯å¦éœ€è¦ä¼˜åŒ–
  bool get needsOptimization =>
      overallAccuracy < 0.85 ||
      userSatisfaction < 0.8 ||
      learnedRuleContribution < 0.1;
}
```

#### 18.1.1.6 è‡ªå­¦ä¹ æ•ˆæœé¢„æœŸ

| é˜¶æ®µ | æ—¶é—´å‘¨æœŸ | é¢„æœŸæ•ˆæœ | å…³é”®æŒ‡æ ‡ |
|------|----------|----------|----------|
| **å†·å¯åŠ¨æœŸ** | 0-2å‘¨ | ç§¯ç´¯åŸºç¡€æ ·æœ¬ | æ ·æœ¬æ•° > 100 |
| **åˆæ­¥å­¦ä¹ æœŸ** | 2-4å‘¨ | ç”Ÿæˆé¦–æ‰¹ä¸ªæ€§åŒ–è§„åˆ™ | è§„åˆ™æ•° > 10, å‡†ç¡®ç‡æå‡ 5% |
| **å¿«é€Ÿæå‡æœŸ** | 1-3æœˆ | ä¸ªæ€§åŒ–æ¨¡å‹æˆç†Ÿ | å‡†ç¡®ç‡ > 90%, è§„åˆ™è´¡çŒ®ç‡ > 20% |
| **ç¨³å®šä¼˜åŒ–æœŸ** | 3æœˆ+ | æŒç»­å¾®è°ƒä¼˜åŒ– | å‡†ç¡®ç‡ > 95%, æ»¡æ„åº¦ > 90% |

**æ ¸å¿ƒä¼˜åŒ–ç›®æ ‡**ï¼š
- æ•´ä½“è¯†åˆ«å‡†ç¡®ç‡ï¼š85% â†’ 95%+
- è§„åˆ™åŒ¹é…è¦†ç›–ç‡ï¼š60% â†’ 80%+
- LLM å…œåº•æ¯”ä¾‹ï¼š40% â†’ 15%ï¼ˆèŠ‚çœæˆæœ¬ï¼‰
- å¹³å‡è¯†åˆ«å»¶è¿Ÿï¼š500ms â†’ 200msï¼ˆè§„åˆ™å‘½ä¸­æ›´å¿«ï¼‰
- ç”¨æˆ·ä¿®æ”¹ç‡ï¼š15% â†’ 5%ï¼ˆå‡å°‘çº é”™æˆæœ¬ï¼‰
#### 18.1.1.7 å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿ

å½“ç”¨æˆ·é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ç¾¤ä½“æ™ºæ…§è¿›è¡ŒååŒå­¦ä¹ ï¼Œåœ¨ä¿æŠ¤éšç§çš„å‰æä¸‹å…±äº«å­¦ä¹ æˆæœã€‚

##### 18.1.1.7.1 ååŒå­¦ä¹ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ç«¯ä¾§ï¼ˆä¸ªäººè®¾å¤‡ï¼‰                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  ç”¨æˆ· A     â”‚  â”‚  ç”¨æˆ· B     â”‚  â”‚  ç”¨æˆ· C     â”‚  â”‚  ç”¨æˆ· N     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                â”‚            â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚                          ä¸Šä¼ è„±æ•æ¨¡å¼/è§„åˆ™                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         äº‘ç«¯ï¼ˆååŒå­¦ä¹ æœåŠ¡ï¼‰                               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                      æ¨¡å¼èšåˆå¼•æ“                                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è§„åˆ™æŠ•ç¥¨èšåˆï¼šç›¸åŒæ¨¡å¼è¢«å¤šç”¨æˆ·å­¦ä¹  â†’ æå‡ä¸ºå…¨å±€è§„åˆ™            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ç½®ä¿¡åº¦åŠ æƒï¼šç”¨æˆ·è´¨é‡è¯„åˆ† Ã— è§„åˆ™ç½®ä¿¡åº¦ â†’ èšåˆæƒé‡               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å†²çªæ¶ˆè§£ï¼šä¸åŒç”¨æˆ·å­¦ä¹ åˆ°çŸ›ç›¾è§„åˆ™ â†’ å¤šæ•°æŠ•ç¥¨ / ç½®ä¿¡åº¦ä¼˜å…ˆ        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ–°è¡¨è¾¾å‘ç°ï¼šä½é¢‘ä½†é«˜è´¨é‡çš„æ–°è¡¨è¾¾ â†’ å€™é€‰å…¨å±€è§„åˆ™                 â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                      å…¨å±€æ¨¡å‹ä»“åº“                                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ åŸºç¡€è§„åˆ™åº“  â”‚  â”‚ ç¾¤ä½“å­¦ä¹ åº“  â”‚  â”‚ çƒ­é—¨è¡¨è¾¾åº“  â”‚              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (å†…ç½®1000+) â”‚  â”‚ (èšåˆè§„åˆ™)  â”‚  â”‚ (é«˜é¢‘æ¨¡å¼)  â”‚              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚                          ä¸‹å‘å…¨å±€æ¨¡å‹æ›´æ–°                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ç«¯ä¾§ï¼ˆæ¨¡å‹èåˆï¼‰                                   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚            æœ€ç»ˆè¯†åˆ«æ¨¡å‹ = å…¨å±€æ¨¡å‹ + ä¸ªæ€§åŒ–æ¨¡å‹                   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  ä¼˜å…ˆçº§ï¼šä¸ªæ€§åŒ–è§„åˆ™ > ç¾¤ä½“å­¦ä¹ è§„åˆ™ > åŸºç¡€è§„åˆ™ > LLMå…œåº•          â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 18.1.1.7.2 éšç§ä¿æŠ¤è®¾è®¡

```dart
/// éšç§ä¿æŠ¤çš„æ¨¡å¼ä¸ŠæŠ¥
class PrivacyPreservingPatternReporter {

  /// ä¸ŠæŠ¥å­¦ä¹ åˆ°çš„æ¨¡å¼ï¼ˆéåŸå§‹æ•°æ®ï¼‰
  Future<void> reportLearnedPattern(LearnedRule rule) async {
    // 1. è„±æ•å¤„ç†ï¼šåªä¸ŠæŠ¥æ¨¡å¼ï¼Œä¸ä¸ŠæŠ¥åŸå§‹æ ·æœ¬
    final sanitizedPattern = SanitizedPattern(
      // æ¨¡å¼æ¨¡æ¿ï¼ˆå¦‚ï¼š"æŠŠ{category}é¢„ç®—æ”¹æˆ{amount}"ï¼‰
      template: rule.pattern,
      // æ„å›¾ç±»å‹
      intent: rule.intent,
      // æœ¬åœ°ç½®ä¿¡åº¦
      localConfidence: rule.confidence,
      // æœ¬åœ°å‘½ä¸­é¢‘æ¬¡
      localFrequency: rule.frequency,
      // ç”¨æˆ·IDå“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰
      userHash: _hashUserId(_currentUserId),
      // è®¾å¤‡æŒ‡çº¹ï¼ˆç”¨äºå»é‡ï¼‰
      deviceFingerprint: _getDeviceFingerprint(),
    );

    // 2. å·®åˆ†éšç§ï¼šæ·»åŠ å™ªå£°
    final noisyPattern = _addDifferentialPrivacyNoise(sanitizedPattern);

    // 3. ä¸ŠæŠ¥åˆ°äº‘ç«¯
    await _cloudService.reportPattern(noisyPattern);
  }

  /// å·®åˆ†éšç§å™ªå£°æ·»åŠ 
  SanitizedPattern _addDifferentialPrivacyNoise(SanitizedPattern pattern) {
    // å¯¹é¢‘æ¬¡æ·»åŠ æ‹‰æ™®æ‹‰æ–¯å™ªå£°
    final noisyFrequency = pattern.localFrequency +
        _laplacianNoise(sensitivity: 1.0, epsilon: 0.5);

    // å¯¹ç½®ä¿¡åº¦æ·»åŠ é«˜æ–¯å™ªå£°
    final noisyConfidence = (pattern.localConfidence +
        _gaussianNoise(sigma: 0.05)).clamp(0.0, 1.0);

    return pattern.copyWith(
      localFrequency: noisyFrequency.round().clamp(1, 1000),
      localConfidence: noisyConfidence,
    );
  }
}

/// è„±æ•åçš„æ¨¡å¼ç»“æ„
class SanitizedPattern {
  final String template;        // æ¨¡å¼æ¨¡æ¿ï¼ˆæ— å…·ä½“æ•°å€¼/åç§°ï¼‰
  final VoiceIntentType intent; // æ„å›¾ç±»å‹
  final double localConfidence; // æœ¬åœ°ç½®ä¿¡åº¦ï¼ˆåŠ å™ªåï¼‰
  final int localFrequency;     // æœ¬åœ°é¢‘æ¬¡ï¼ˆåŠ å™ªåï¼‰
  final String userHash;        // ç”¨æˆ·å“ˆå¸Œ
  final String deviceFingerprint;
}
```

##### 18.1.1.7.3 ç¾¤ä½“è§„åˆ™èšåˆ

```dart
/// äº‘ç«¯è§„åˆ™èšåˆæœåŠ¡
class GlobalPatternAggregationService {

  /// èšåˆæ¥è‡ªå¤šç”¨æˆ·çš„æ¨¡å¼
  Future<List<GlobalRule>> aggregatePatterns() async {
    final allPatterns = await _db.getAllReportedPatterns();
    final globalRules = <GlobalRule>[];

    // æŒ‰æ¨¡å¼æ¨¡æ¿åˆ†ç»„
    final groupedByTemplate = _groupByTemplate(allPatterns);

    for (final entry in groupedByTemplate.entries) {
      final template = entry.key;
      final patterns = entry.value;

      // è®¡ç®—èšåˆæŒ‡æ ‡
      final stats = _calculateAggregationStats(patterns);

      // åˆ¤æ–­æ˜¯å¦è¾¾åˆ°å…¨å±€è§„åˆ™æ ‡å‡†
      if (_meetsGlobalRuleThreshold(stats)) {
        globalRules.add(GlobalRule(
          id: _generateRuleId(),
          template: template,
          intent: _resolveIntent(patterns),  // æŠ•ç¥¨å†³å®šæ„å›¾
          globalConfidence: stats.weightedConfidence,
          userCount: stats.uniqueUserCount,
          totalFrequency: stats.totalFrequency,
          createdAt: DateTime.now(),
          source: RuleSource.crowdLearned,
        ));
      }
    }

    return globalRules;
  }

  /// è®¡ç®—èšåˆç»Ÿè®¡
  AggregationStats _calculateAggregationStats(List<SanitizedPattern> patterns) {
    // å»é‡ç”¨æˆ·æ•°
    final uniqueUsers = patterns.map((p) => p.userHash).toSet().length;

    // æ€»é¢‘æ¬¡
    final totalFrequency = patterns.fold<int>(
      0, (sum, p) => sum + p.localFrequency);

    // åŠ æƒç½®ä¿¡åº¦ï¼ˆç”¨æˆ·è´¨é‡è¯„åˆ† Ã— æœ¬åœ°ç½®ä¿¡åº¦ï¼‰
    var weightedSum = 0.0;
    var weightTotal = 0.0;
    for (final pattern in patterns) {
      final userQuality = _getUserQualityScore(pattern.userHash);
      weightedSum += pattern.localConfidence * userQuality;
      weightTotal += userQuality;
    }
    final weightedConfidence = weightTotal > 0 ? weightedSum / weightTotal : 0.0;

    return AggregationStats(
      uniqueUserCount: uniqueUsers,
      totalFrequency: totalFrequency,
      weightedConfidence: weightedConfidence,
      patternCount: patterns.length,
    );
  }

  /// åˆ¤æ–­æ˜¯å¦æ»¡è¶³å…¨å±€è§„åˆ™é˜ˆå€¼
  bool _meetsGlobalRuleThreshold(AggregationStats stats) {
    return stats.uniqueUserCount >= 10 &&      // è‡³å°‘10ä¸ªä¸åŒç”¨æˆ·
           stats.totalFrequency >= 50 &&        // è‡³å°‘50æ¬¡å‘½ä¸­
           stats.weightedConfidence >= 0.85;    // åŠ æƒç½®ä¿¡åº¦ >= 85%
  }

  /// æŠ•ç¥¨å†³å®šæ„å›¾ï¼ˆå¤„ç†å†²çªï¼‰
  VoiceIntentType _resolveIntent(List<SanitizedPattern> patterns) {
    final votes = <VoiceIntentType, double>{};

    for (final pattern in patterns) {
      final userQuality = _getUserQualityScore(pattern.userHash);
      final weight = pattern.localConfidence * userQuality * pattern.localFrequency;
      votes[pattern.intent] = (votes[pattern.intent] ?? 0) + weight;
    }

    // è¿”å›å¾—ç¥¨æœ€é«˜çš„æ„å›¾
    return votes.entries
        .reduce((a, b) => a.value > b.value ? a : b)
        .key;
  }
}

/// å…¨å±€è§„åˆ™
class GlobalRule {
  final String id;
  final String template;
  final VoiceIntentType intent;
  final double globalConfidence;
  final int userCount;           // è´¡çŒ®ç”¨æˆ·æ•°
  final int totalFrequency;      // å…¨å±€æ€»å‘½ä¸­æ•°
  final DateTime createdAt;
  final RuleSource source;

  /// å…¨å±€è§„åˆ™è´¨é‡è¯„åˆ†
  double get qualityScore {
    final userScore = (userCount / 100).clamp(0.0, 1.0);
    final frequencyScore = (totalFrequency / 1000).clamp(0.0, 1.0);
    return globalConfidence * 0.5 + userScore * 0.3 + frequencyScore * 0.2;
  }
}
```

##### 18.1.1.7.4 æ–°ç”¨æˆ·å†·å¯åŠ¨åŠ é€Ÿ

```dart
/// æ–°ç”¨æˆ·å†·å¯åŠ¨æœåŠ¡
class ColdStartAccelerationService {
  final GlobalModelRepository _globalRepo;
  final UserProfileService _profileService;

  /// ä¸ºæ–°ç”¨æˆ·åˆå§‹åŒ–æ¨¡å‹
  Future<PersonalizedIntentModel> initializeNewUserModel(String userId) async {
    // 1. è·å–å…¨å±€çƒ­é—¨è§„åˆ™
    final hotRules = await _globalRepo.getHotRules(limit: 100);

    // 2. è·å–ç”¨æˆ·ç”»åƒç›¸ä¼¼ç¾¤ä½“çš„è§„åˆ™
    final userProfile = await _profileService.getProfile(userId);
    final similarGroupRules = await _getSimilarGroupRules(userProfile);

    // 3. æ„å»ºåˆå§‹åŒ–æ¨¡å‹
    return PersonalizedIntentModel(
      userId: userId,
      expressionHabits: ExpressionHabits.defaults(),
      intentFrequency: _getDefaultIntentFrequency(),
      contextPreferences: {},
      timePatterns: TimePatterns.defaults(),
      learnedRules: [],  // ä¸ªäººè§„åˆ™ä¸ºç©º
      inheritedRules: [...hotRules, ...similarGroupRules],  // ç»§æ‰¿å…¨å±€è§„åˆ™
      lastUpdated: DateTime.now(),
    );
  }

  /// è·å–ç›¸ä¼¼ç”¨æˆ·ç¾¤ä½“çš„è§„åˆ™
  Future<List<GlobalRule>> _getSimilarGroupRules(UserProfile profile) async {
    // åŸºäºç”¨æˆ·ç‰¹å¾åŒ¹é…ç›¸ä¼¼ç¾¤ä½“
    final similarityFactors = {
      'age_group': profile.ageGroup,        // å¹´é¾„æ®µ
      'profession': profile.profession,      // èŒä¸š
      'usage_frequency': profile.usageFrequency,  // ä½¿ç”¨é¢‘ç‡
      'primary_intent': profile.primaryIntent,    // ä¸»è¦ä½¿ç”¨åœºæ™¯
    };

    return await _globalRepo.getRulesBySimilarity(
      factors: similarityFactors,
      limit: 50,
    );
  }
}

/// ç”¨æˆ·ç”»åƒ
class UserProfile {
  final String ageGroup;        // å¹´é¾„æ®µï¼š18-25, 26-35, 36-45, 46+
  final String profession;      // èŒä¸šç±»å‹ï¼šstudent, employee, business, freelance
  final String usageFrequency;  // ä½¿ç”¨é¢‘ç‡ï¼šdaily, weekly, occasional
  final String primaryIntent;   // ä¸»è¦æ„å›¾ï¼šbookkeeping, budgeting, investing
}
```

##### 18.1.1.7.5 A/B æµ‹è¯•ä¸æ¸è¿›å¼å‘å¸ƒ

```dart
/// å…¨å±€è§„åˆ™å‘å¸ƒæœåŠ¡
class GlobalRuleReleaseService {

  /// æ¸è¿›å¼å‘å¸ƒæ–°è§„åˆ™
  Future<void> releaseRule(GlobalRule rule) async {
    // é˜¶æ®µ1ï¼šå†…éƒ¨æµ‹è¯•ï¼ˆ1%ç”¨æˆ·ï¼‰
    await _releaseToGroup(
      rule: rule,
      targetPercentage: 1,
      group: ReleaseGroup.internal,
      duration: Duration(days: 3),
    );

    // é˜¶æ®µ2ï¼šç°åº¦å‘å¸ƒï¼ˆ10%ç”¨æˆ·ï¼‰
    final internalMetrics = await _evaluateRulePerformance(rule);
    if (internalMetrics.successRate >= 0.9) {
      await _releaseToGroup(
        rule: rule,
        targetPercentage: 10,
        group: ReleaseGroup.beta,
        duration: Duration(days: 7),
      );
    }

    // é˜¶æ®µ3ï¼šå…¨é‡å‘å¸ƒ
    final betaMetrics = await _evaluateRulePerformance(rule);
    if (betaMetrics.successRate >= 0.85 && betaMetrics.userSatisfaction >= 0.8) {
      await _releaseToGroup(
        rule: rule,
        targetPercentage: 100,
        group: ReleaseGroup.production,
      );
    } else {
      // å›æ»š
      await _rollbackRule(rule);
    }
  }

  /// è¯„ä¼°è§„åˆ™æ€§èƒ½
  Future<RuleMetrics> _evaluateRulePerformance(GlobalRule rule) async {
    final samples = await _db.getSamplesForRule(rule.id);

    return RuleMetrics(
      matchCount: samples.length,
      successRate: _calculateSuccessRate(samples),
      userSatisfaction: _calculateSatisfaction(samples),
      averageLatency: _calculateAverageLatency(samples),
    );
  }
}

/// A/B æµ‹è¯•æœåŠ¡
class ABTestService {

  /// åˆ›å»ºè§„åˆ™å¯¹æ¯”å®éªŒ
  Future<ABTest> createRuleTest({
    required GlobalRule controlRule,
    required GlobalRule treatmentRule,
    required double trafficPercentage,
  }) async {
    return ABTest(
      id: _generateTestId(),
      controlRule: controlRule,
      treatmentRule: treatmentRule,
      trafficPercentage: trafficPercentage,
      startTime: DateTime.now(),
      status: ABTestStatus.running,
      metrics: ABTestMetrics.empty(),
    );
  }

  /// åˆ†æå®éªŒç»“æœ
  Future<ABTestResult> analyzeTest(String testId) async {
    final test = await _db.getTest(testId);
    final controlSamples = await _getSamplesForVariant(testId, 'control');
    final treatmentSamples = await _getSamplesForVariant(testId, 'treatment');

    final controlMetrics = _calculateMetrics(controlSamples);
    final treatmentMetrics = _calculateMetrics(treatmentSamples);

    // ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ
    final significance = _calculateStatisticalSignificance(
      controlMetrics, treatmentMetrics);

    return ABTestResult(
      testId: testId,
      controlMetrics: controlMetrics,
      treatmentMetrics: treatmentMetrics,
      winner: significance.pValue < 0.05
          ? (treatmentMetrics.successRate > controlMetrics.successRate
              ? 'treatment' : 'control')
          : 'inconclusive',
      significance: significance,
    );
  }
}
```

##### 18.1.1.7.6 ååŒå­¦ä¹ æ•ˆæœé¢„æœŸ

| ç”¨æˆ·è§„æ¨¡ | ä¼˜åŒ–æ•ˆæœ | å…³é”®æŒ‡æ ‡ |
|----------|----------|----------|
| **100-1K** | åˆæ­¥ç¾¤ä½“æ•ˆåº” | æ–°ç”¨æˆ·å†·å¯åŠ¨æ—¶é—´ -50%ï¼Œè§„åˆ™è¦†ç›–ç‡ +10% |
| **1K-10K** | æ˜¾è‘—ç¾¤ä½“æ™ºæ…§ | å…¨å±€è§„åˆ™åº“ +200æ¡ï¼Œå‡†ç¡®ç‡ +5%ï¼ŒLLMè°ƒç”¨ -20% |
| **10K-100K** | é•¿å°¾è¡¨è¾¾è¦†ç›– | è¦†ç›–95%+å¸¸è§è¡¨è¾¾ï¼Œåœ°åŸŸ/æ–¹è¨€é€‚é… |
| **100K+** | å®æ—¶ç¾¤ä½“å­¦ä¹  | æ–°è¡¨è¾¾å‘ç° <24hï¼Œè§„åˆ™è‡ªåŠ¨è¿­ä»£ |

**ååŒå­¦ä¹ æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸš€ æ–°ç”¨æˆ·å†·å¯åŠ¨ï¼šä»2å‘¨ç¼©çŸ­åˆ°å³æ—¶å¯ç”¨ï¼ˆç»§æ‰¿ç¾¤ä½“è§„åˆ™ï¼‰
- ğŸ“ˆ é•¿å°¾è¡¨è¾¾è¦†ç›–ï¼šå•ç”¨æˆ·éš¾ä»¥å­¦åˆ°çš„ä½é¢‘è¡¨è¾¾ï¼Œç¾¤ä½“å¯è¦†ç›–
- ğŸ’° æˆæœ¬ä¼˜åŒ–ï¼šç¾¤ä½“è§„åˆ™å‘½ä¸­ç‡æå‡ â†’ LLMè°ƒç”¨è¿›ä¸€æ­¥é™ä½
- ğŸ”„ å®æ—¶è¿­ä»£ï¼šæ–°è¡¨è¾¾å¿«é€Ÿä¼ æ’­åˆ°å…¨ä½“ç”¨æˆ·
#### 18.1.1.8 ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶ï¼ˆå¯å¤ç”¨ï¼‰

> **ğŸ“š é‡è¦è¯´æ˜**
>
> ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶å·²æŠ½å–ä¸ºç‹¬ç«‹çš„**ç¬¬17ç«  è‡ªå­¦ä¹ ä¸ååŒå­¦ä¹ ç³»ç»Ÿ**ã€‚
> ä»¥ä¸‹å†…å®¹ä¿ç•™ä½œä¸ºå†å²å‚è€ƒï¼Œå®Œæ•´çš„æ¡†æ¶è®¾è®¡è¯·å‚è§ç¬¬16ç« ã€‚

å°†è‡ªå­¦ä¹ èƒ½åŠ›æŠ½è±¡ä¸ºç»Ÿä¸€æ¡†æ¶ï¼Œä¾›ç³»ç»Ÿå…¶ä»–æ™ºèƒ½æ¨¡å—å¤ç”¨ï¼Œé¿å…é‡å¤å»ºè®¾ã€‚

##### 18.1.1.8.1 å¯å¤ç”¨æ¨¡å—åˆ†æ

| æ¨¡å— | å­¦ä¹ ç›®æ ‡ | è¾“å…¥æ•°æ® | åé¦ˆä¿¡å· | å¤ç”¨ä»·å€¼ |
|------|----------|----------|----------|----------|
| **15.2 æ™ºèƒ½åˆ†ç±»** | äº¤æ˜“â†’åˆ†ç±»æ˜ å°„ | å•†å®¶ã€æè¿°ã€é‡‘é¢ | ç”¨æˆ·ä¿®æ”¹åˆ†ç±» | â­â­â­â­â­ æœ€é«˜é¢‘ |
| **15.3 é¢„ç®—å»ºè®®** | é¢„ç®—é¢åº¦æ¨è | å†å²æ¶ˆè´¹ã€æ”¶å…¥ | ç”¨æˆ·é‡‡çº³/è°ƒæ•´ | â­â­â­â­ |
| **15.5 å¼‚å¸¸æ£€æµ‹** | å¼‚å¸¸åˆ¤å®šé˜ˆå€¼ | äº¤æ˜“ç‰¹å¾ | ç”¨æˆ·ç¡®è®¤/å¿½ç•¥ | â­â­â­â­ |
| **15.6 è‡ªç„¶è¯­è¨€æœç´¢** | æŸ¥è¯¢â†’æ„å›¾æ˜ å°„ | æœç´¢è¯ | ç‚¹å‡»ç»“æœ | â­â­â­â­ |
| **15.7 å¯¹è¯åŠ©æ‰‹** | å¯¹è¯æ„å›¾ç†è§£ | å¯¹è¯æ–‡æœ¬ | ä»»åŠ¡å®Œæˆç‡ | â­â­â­â­ |
| **15.8 èµ„é‡‘åˆ†é…** | åˆ†é…æ¯”ä¾‹å»ºè®® | æ”¶æ”¯ç»“æ„ | ç”¨æˆ·è°ƒæ•´ | â­â­â­ |
| **15.12 è¯­éŸ³äº¤äº’** | è¯­éŸ³â†’æ„å›¾æ˜ å°„ | è¯­éŸ³æ–‡æœ¬ | ç”¨æˆ·ç¡®è®¤/ä¿®æ”¹ | â­â­â­â­â­ å·²å®ç° |

##### 18.1.1.8.2 ç»Ÿä¸€å­¦ä¹ æ¡†æ¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç»Ÿä¸€è‡ªå­¦ä¹ æ¡†æ¶ (Unified Learning Framework)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æŠ½è±¡å­¦ä¹ æ¥å£å±‚                                     â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  interface ILearnable<TInput, TOutput, TFeedback> {                     â”‚   â”‚
â”‚  â”‚    Future<TOutput> predict(TInput input);           // é¢„æµ‹              â”‚   â”‚
â”‚  â”‚    Future<void> collectFeedback(TFeedback feedback); // é‡‡é›†åé¦ˆ         â”‚   â”‚
â”‚  â”‚    Future<void> learn();                             // è§¦å‘å­¦ä¹          â”‚   â”‚
â”‚  â”‚    Future<LearningMetrics> evaluate();               // è¯„ä¼°æ•ˆæœ         â”‚   â”‚
â”‚  â”‚  }                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         æ ¸å¿ƒç»„ä»¶å±‚ï¼ˆå¯æ’æ‹”ï¼‰                               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ SampleStore â”‚  â”‚ RuleEngine  â”‚  â”‚PatternMiner â”‚  â”‚ModelTrainer â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  æ ·æœ¬å­˜å‚¨   â”‚  â”‚  è§„åˆ™å¼•æ“   â”‚  â”‚  æ¨¡å¼æŒ–æ˜   â”‚  â”‚  æ¨¡å‹è®­ç»ƒ   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ é‡‡é›†      â”‚  â”‚ â€¢ åŒ¹é…      â”‚  â”‚ â€¢ èšç±»      â”‚  â”‚ â€¢ å¢é‡æ›´æ–°  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ ‡æ³¨      â”‚  â”‚ â€¢ ä¼˜å…ˆçº§    â”‚  â”‚ â€¢ æ¨¡æ¿æå–  â”‚  â”‚ â€¢ æ‰¹é‡è®­ç»ƒ  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ è´¨é‡è¯„åˆ†  â”‚  â”‚ â€¢ å†²çªè§£å†³  â”‚  â”‚ â€¢ åŒä¹‰å‘ç°  â”‚  â”‚ â€¢ éªŒè¯è¯„ä¼°  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¸šåŠ¡é€‚é…å±‚ï¼ˆå„æ¨¡å—å®ç°ï¼‰                           â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ åˆ†ç±»å­¦ä¹   â”‚ â”‚ é¢„ç®—å­¦ä¹   â”‚ â”‚ å¼‚å¸¸å­¦ä¹   â”‚ â”‚ æœç´¢å­¦ä¹   â”‚ â”‚ è¯­éŸ³å­¦ä¹   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Adapter   â”‚ â”‚ Adapter   â”‚ â”‚ Adapter   â”‚ â”‚ Adapter   â”‚ â”‚ Adapter   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 18.1.1.8.3 æ ¸å¿ƒæŠ½è±¡ç±»è®¾è®¡

```dart
/// ç»Ÿä¸€å­¦ä¹ æ ·æœ¬åŸºç±»
abstract class LearningSample<TInput, TOutput> {
  final String id;
  final TInput input;                 // è¾“å…¥æ•°æ®
  final TOutput predictedOutput;      // é¢„æµ‹è¾“å‡º
  final TOutput? actualOutput;        // å®é™…è¾“å‡ºï¼ˆç”¨æˆ·åé¦ˆåï¼‰
  final double confidence;            // é¢„æµ‹ç½®ä¿¡åº¦
  final SampleLabel label;            // æ ·æœ¬æ ‡ç­¾
  final DateTime timestamp;
  final String userId;
  final Map<String, dynamic> metadata;

  /// æ ·æœ¬è´¨é‡è¯„åˆ†ï¼ˆå­ç±»å¯è¦†ç›–ï¼‰
  double get qualityScore;

  /// æ˜¯å¦ä¸ºæœ‰æ•ˆè®­ç»ƒæ ·æœ¬
  bool get isValidForTraining =>
      label != SampleLabel.ambiguous &&
      qualityScore >= 0.6;
}

/// ç»Ÿä¸€è§„åˆ™åŸºç±»
abstract class LearnedRule<TInput, TOutput> {
  final String id;
  final String pattern;               // åŒ¹é…æ¨¡å¼
  final TOutput output;               // è¾“å‡ºç»“æœ
  final double confidence;            // ç½®ä¿¡åº¦
  final int frequency;                // å‘½ä¸­é¢‘æ¬¡
  final RuleSource source;            // è§„åˆ™æ¥æº
  final DateTime createdAt;
  final List<String> examples;        // ç¤ºä¾‹

  /// è§„åˆ™æ˜¯å¦å¯é 
  bool get isReliable => confidence >= 0.9 && frequency >= 5;

  /// å°è¯•åŒ¹é…è¾“å…¥
  MatchResult<TOutput>? tryMatch(TInput input);
}

/// ç»Ÿä¸€å­¦ä¹ æœåŠ¡åŸºç±»
abstract class BaseLearningService<TInput, TOutput, TSample extends LearningSample<TInput, TOutput>> {
  final SampleStore<TSample> sampleStore;
  final RuleEngine<TInput, TOutput> ruleEngine;
  final PatternMiner<TSample> patternMiner;

  /// é¢„æµ‹ï¼ˆå¤šçº§ç­–ç•¥ï¼‰
  Future<PredictionResult<TOutput>> predict(TInput input) async {
    // Level 1: ç”¨æˆ·ä¸ªæ€§åŒ–è§„åˆ™
    final personalResult = await _matchPersonalRules(input);
    if (personalResult != null && personalResult.confidence >= 0.95) {
      return personalResult;
    }

    // Level 2: å…¨å±€è§„åˆ™
    final ruleResult = await ruleEngine.match(input);
    if (ruleResult != null && ruleResult.confidence >= 0.9) {
      return ruleResult;
    }

    // Level 3: ç›¸ä¼¼æ ·æœ¬åŒ¹é…
    final similarResult = await _matchSimilarSamples(input);
    if (similarResult != null && similarResult.confidence >= 0.85) {
      return similarResult;
    }

    // Level 4: å­ç±»å®ç°çš„å…œåº•ç­–ç•¥ï¼ˆå¦‚LLMï¼‰
    return await fallbackPredict(input);
  }

  /// å…œåº•é¢„æµ‹ï¼ˆå­ç±»å®ç°ï¼‰
  Future<PredictionResult<TOutput>> fallbackPredict(TInput input);

  /// é‡‡é›†åé¦ˆ
  Future<void> collectFeedback({
    required String sampleId,
    required FeedbackType feedbackType,
    TOutput? correctedOutput,
  }) async {
    final sample = await sampleStore.get(sampleId);
    if (sample == null) return;

    final updatedSample = updateSampleWithFeedback(sample, feedbackType, correctedOutput);
    await sampleStore.update(updatedSample);

    // è§¦å‘å¢é‡å­¦ä¹ 
    if (updatedSample.qualityScore >= 0.7) {
      await incrementalLearn(updatedSample);
    }
  }

  /// æ›´æ–°æ ·æœ¬ï¼ˆå­ç±»å¯è¦†ç›–ï¼‰
  TSample updateSampleWithFeedback(TSample sample, FeedbackType type, TOutput? corrected);

  /// å¢é‡å­¦ä¹ 
  Future<void> incrementalLearn(TSample sample) async {
    // 1. å°è¯•ç”Ÿæˆæ–°è§„åˆ™
    final similarSamples = await sampleStore.findSimilar(sample, limit: 10);
    if (similarSamples.length >= 3) {
      final newRule = await patternMiner.tryGenerateRule(sample, similarSamples);
      if (newRule != null) {
        await ruleEngine.addRule(newRule);
      }
    }

    // 2. æ›´æ–°ä¸ªæ€§åŒ–æ¨¡å‹
    await updatePersonalizedModel(sample);
  }

  /// æ›´æ–°ä¸ªæ€§åŒ–æ¨¡å‹ï¼ˆå­ç±»å®ç°ï¼‰
  Future<void> updatePersonalizedModel(TSample sample);

  /// è¯„ä¼°å­¦ä¹ æ•ˆæœ
  Future<LearningMetrics> evaluate() async {
    final recentSamples = await sampleStore.getRecent(days: 30);
    return LearningMetrics(
      accuracy: _calculateAccuracy(recentSamples),
      ruleContribution: _calculateRuleContribution(recentSamples),
      userSatisfaction: _calculateSatisfaction(recentSamples),
    );
  }
}
```

##### 18.1.1.8.4 æ™ºèƒ½åˆ†ç±»æ¨¡å—é€‚é…ç¤ºä¾‹

```dart
/// åˆ†ç±»å­¦ä¹ æ ·æœ¬
class CategoryLearningSample extends LearningSample<TransactionInput, Category> {
  final String? merchantName;
  final List<String> keywords;

  @override
  double get qualityScore {
    var score = 0.0;
    if (label == SampleLabel.confirmedPositive) score += 0.5;
    if (label == SampleLabel.corrected) score += 0.4;
    if (confidence > 0.9) score += 0.2;
    if (merchantName != null) score += 0.1;  // æœ‰å•†å®¶ä¿¡æ¯æ›´æœ‰ä»·å€¼
    return score.clamp(0.0, 1.0);
  }
}

/// åˆ†ç±»å­¦ä¹ æœåŠ¡
class CategoryLearningService extends BaseLearningService<
    TransactionInput, Category, CategoryLearningSample> {

  final LLMService _llmService;

  @override
  Future<PredictionResult<Category>> fallbackPredict(TransactionInput input) async {
    // LLMå…œåº•åˆ†ç±»
    final result = await _llmService.classifyTransaction(input);
    return PredictionResult(
      output: result.category,
      confidence: result.confidence,
      source: PredictionSource.llm,
    );
  }

  @override
  Future<void> updatePersonalizedModel(CategoryLearningSample sample) async {
    // æ›´æ–°å•†å®¶-åˆ†ç±»æ˜ å°„ç¼“å­˜
    if (sample.merchantName != null && sample.actualOutput != null) {
      await _updateMerchantCategoryCache(
        sample.merchantName!,
        sample.actualOutput!,
      );
    }

    // æ›´æ–°å…³é”®è¯æƒé‡
    for (final keyword in sample.keywords) {
      await _updateKeywordWeight(keyword, sample.actualOutput!);
    }
  }
}

/// åˆ†ç±»å­¦ä¹ è§„åˆ™
class CategoryRule extends LearnedRule<TransactionInput, Category> {

  final List<String> keywords;        // è§¦å‘å…³é”®è¯
  final String? merchantPattern;      // å•†å®¶åŒ¹é…æ¨¡å¼

  @override
  MatchResult<Category>? tryMatch(TransactionInput input) {
    // å•†å®¶ç²¾ç¡®åŒ¹é…
    if (merchantPattern != null &&
        input.merchant?.contains(merchantPattern) == true) {
      return MatchResult(output: output, confidence: confidence);
    }

    // å…³é”®è¯åŒ¹é…
    final matchedKeywords = keywords.where(
      (k) => input.description.contains(k)
    ).length;

    if (matchedKeywords > 0) {
      final matchConfidence = confidence * (matchedKeywords / keywords.length);
      return MatchResult(output: output, confidence: matchConfidence);
    }

    return null;
  }
}
```

##### 18.1.1.8.5 å¼‚å¸¸æ£€æµ‹æ¨¡å—é€‚é…ç¤ºä¾‹

```dart
/// å¼‚å¸¸æ£€æµ‹å­¦ä¹ æ ·æœ¬
class AnomalyLearningSample extends LearningSample<Transaction, AnomalyType> {
  final double zScore;           // ç»Ÿè®¡å¼‚å¸¸åˆ†æ•°
  final List<String> features;   // è§¦å‘ç‰¹å¾

  @override
  double get qualityScore {
    var score = 0.0;
    // ç”¨æˆ·æ˜ç¡®ç¡®è®¤æ˜¯/ä¸æ˜¯å¼‚å¸¸
    if (label == SampleLabel.confirmedPositive) score += 0.5;
    if (label == SampleLabel.negative) score += 0.4;  // ç”¨æˆ·è¯´ä¸æ˜¯å¼‚å¸¸ä¹Ÿå¾ˆé‡è¦
    if (zScore > 3) score += 0.2;  // ç»Ÿè®¡æ˜¾è‘—çš„æ ·æœ¬æ›´æœ‰ä»·å€¼
    return score.clamp(0.0, 1.0);
  }
}

/// å¼‚å¸¸æ£€æµ‹å­¦ä¹ æœåŠ¡
class AnomalyLearningService extends BaseLearningService<
    Transaction, AnomalyType, AnomalyLearningSample> {

  @override
  Future<PredictionResult<AnomalyType>> fallbackPredict(Transaction input) async {
    // ç»Ÿè®¡æ¨¡å‹å…œåº•
    final zScore = await _calculateZScore(input);
    final anomalyType = _classifyByZScore(zScore);

    return PredictionResult(
      output: anomalyType,
      confidence: _zScoreToConfidence(zScore),
      source: PredictionSource.statistical,
    );
  }

  @override
  Future<void> updatePersonalizedModel(AnomalyLearningSample sample) async {
    // ç”¨æˆ·è¯´ä¸æ˜¯å¼‚å¸¸ â†’ è°ƒæ•´è¯¥ç”¨æˆ·çš„å¼‚å¸¸é˜ˆå€¼
    if (sample.label == SampleLabel.negative) {
      await _adjustUserAnomalyThreshold(
        sample.userId,
        sample.input.amount,
        sample.input.categoryId,
      );
    }

    // ç”¨æˆ·ç¡®è®¤æ˜¯å¼‚å¸¸ â†’ å­¦ä¹ æ–°çš„å¼‚å¸¸æ¨¡å¼
    if (sample.label == SampleLabel.confirmedPositive) {
      await _learnAnomalyPattern(sample);
    }
  }

  /// è°ƒæ•´ç”¨æˆ·å¼‚å¸¸é˜ˆå€¼
  Future<void> _adjustUserAnomalyThreshold(
    String userId,
    double amount,
    String? categoryId,
  ) async {
    // å¦‚æœç”¨æˆ·ç»å¸¸å¿½ç•¥æŸç±»é‡‘é¢çš„å¼‚å¸¸æé†’ï¼Œæé«˜è¯¥ç±»åˆ«çš„é˜ˆå€¼
    final userThresholds = await _getUserThresholds(userId);

    if (categoryId != null) {
      final currentThreshold = userThresholds[categoryId] ?? 3.0;
      // æ¸è¿›å¼è°ƒæ•´
      userThresholds[categoryId] = currentThreshold * 1.1;
      await _saveUserThresholds(userId, userThresholds);
    }
  }
}
```

##### 18.1.1.8.6 è‡ªç„¶è¯­è¨€æœç´¢é€‚é…ç¤ºä¾‹

```dart
/// æœç´¢å­¦ä¹ æ ·æœ¬
class SearchLearningSample extends LearningSample<String, SearchIntent> {
  final List<SearchResult> returnedResults;  // è¿”å›çš„ç»“æœ
  final SearchResult? clickedResult;         // ç”¨æˆ·ç‚¹å‡»çš„ç»“æœ
  final int clickPosition;                   // ç‚¹å‡»ä½ç½®

  @override
  double get qualityScore {
    var score = 0.0;
    // ç”¨æˆ·æœ‰ç‚¹å‡»è¡Œä¸º
    if (clickedResult != null) score += 0.4;
    // ç‚¹å‡»ä½ç½®é å‰è¯´æ˜é¢„æµ‹å‡†ç¡®
    if (clickPosition <= 3) score += 0.3;
    // æœ‰æ˜ç¡®çš„æ„å›¾ä¿®æ”¹
    if (label == SampleLabel.corrected) score += 0.3;
    return score.clamp(0.0, 1.0);
  }
}

/// æœç´¢å­¦ä¹ æœåŠ¡
class SearchLearningService extends BaseLearningService<
    String, SearchIntent, SearchLearningSample> {

  @override
  Future<PredictionResult<SearchIntent>> fallbackPredict(String input) async {
    // LLM æ„å›¾è¯†åˆ«
    final result = await _llmService.parseSearchIntent(input);
    return PredictionResult(
      output: result.intent,
      confidence: result.confidence,
      source: PredictionSource.llm,
    );
  }

  @override
  Future<void> updatePersonalizedModel(SearchLearningSample sample) async {
    // å­¦ä¹ ç”¨æˆ·æœç´¢ä¹ æƒ¯
    // å¦‚ï¼šç”¨æˆ·æœ"å’–å•¡"æ€»æ˜¯æƒ³çœ‹æœ¬æœˆæ¶ˆè´¹ â†’ å»ºç«‹å…³è”
    if (sample.clickedResult != null) {
      await _learnSearchPattern(
        query: sample.input,
        selectedIntent: sample.clickedResult!.intent,
        selectedFilters: sample.clickedResult!.filters,
      );
    }
  }
}
```

##### 18.1.1.8.7 æ¡†æ¶å¤ç”¨æ•ˆç›Šåˆ†æ

| å¤ç”¨ç»„ä»¶ | ä»£ç å¤ç”¨ç‡ | å¼€å‘èŠ‚çœ | ç»´æŠ¤æˆæœ¬é™ä½ |
|----------|------------|----------|--------------|
| æ ·æœ¬å­˜å‚¨ | 90% | 3äººå¤© | ç»Ÿä¸€Schema |
| è§„åˆ™å¼•æ“ | 85% | 5äººå¤© | ç»Ÿä¸€ä¼˜å…ˆçº§ç­–ç•¥ |
| æ¨¡å¼æŒ–æ˜ | 80% | 4äººå¤© | å…±äº«ç®—æ³•åº“ |
| å¢é‡å­¦ä¹  | 85% | 4äººå¤© | ç»Ÿä¸€è§¦å‘æœºåˆ¶ |
| æ•ˆæœè¯„ä¼° | 95% | 2äººå¤© | ç»Ÿä¸€æŒ‡æ ‡ä½“ç³» |
| ååŒå­¦ä¹  | 70% | 6äººå¤© | å…±äº«èšåˆæœåŠ¡ |
| **æ€»è®¡** | **~85%** | **~24äººå¤©** | **å•ä¸€ä»£ç åº“** |

**å„æ¨¡å—è‡ªå­¦ä¹ èƒ½åŠ›å»ºè®¾è·¯å¾„**ï¼š

```
Phase 1 (2å‘¨)ï¼šè¯­éŸ³æ„å›¾è‡ªå­¦ä¹ ï¼ˆå·²å®Œæˆï¼‰
    â†“
Phase 2 (1å‘¨)ï¼šæŠ½è±¡ç»Ÿä¸€æ¡†æ¶
    â†“
Phase 3 (1å‘¨)ï¼šæ™ºèƒ½åˆ†ç±»é€‚é…
    â†“
Phase 4 (1å‘¨)ï¼šå¼‚å¸¸æ£€æµ‹é€‚é…
    â†“
Phase 5 (1å‘¨)ï¼šæœç´¢/å¯¹è¯é€‚é…
    â†“
Phase 6 (2å‘¨)ï¼šååŒå­¦ä¹ ç»Ÿä¸€æ¥å…¥
```
### 18.1.2 "å…¶ä»–"ç±»åˆ«æ„å›¾æ™ºèƒ½å¤„ç†

åœ¨è¯­éŸ³æ„å›¾è¯†åˆ«ä¸­ï¼Œ"å…¶ä»–"ç±»åˆ«å¾€å¾€åŒ…å«ä¸°å¯Œçš„ç”¨æˆ·éœ€æ±‚ï¼Œéœ€è¦æ™ºèƒ½åŒ–å¤„ç†è€Œéç®€å•å¿½ç•¥ã€‚

#### 18.1.2.1 å…¶ä»–æ„å›¾åˆ†ç±»ä½“ç³»

```dart
/// å…¶ä»–æ„å›¾ç»†åˆ†ç±»å‹
enum OtherIntentType {
  helpGuidance,        // å¸®åŠ©å¼•å¯¼ï¼šå¦‚ä½•ä½¿ç”¨æŸåŠŸèƒ½
  feedback,            // åé¦ˆé—®é¢˜ï¼šæŠ¥å‘Šbugã€å»ºè®®æ”¹è¿›
  featureInquiry,      // åŠŸèƒ½å’¨è¯¢ï¼šè¯¢é—®æ˜¯å¦æ”¯æŒæŸåŠŸèƒ½
  dataInterpretation,  // æ•°æ®è§£è¯»ï¼šè¯·æ±‚è§£é‡Šç»Ÿè®¡æ•°æ®
  emotionalExpression, // æƒ…æ„Ÿè¡¨è¾¾ï¼šæŠ±æ€¨ã€èµç¾ã€åæ§½
  casualChat,          // é—²èŠäº’åŠ¨ï¼šæ—¥å¸¸é—®å€™ã€é—²èŠ
  confirmation,        // ç¡®è®¤æ¾„æ¸…ï¼šå¯¹ä¸Šä¸€æ­¥æ“ä½œçš„ç¡®è®¤
  contextSupplement,   // ä¸Šä¸‹æ–‡è¡¥å……ï¼šè¡¥å……ä¹‹å‰çš„ä¿¡æ¯
  ambiguous,           // æ¨¡ç³Šæ„å›¾ï¼šæ— æ³•æ˜ç¡®åˆ†ç±»
  outOfScope,          // è¶…å‡ºèŒƒå›´ï¼šå®Œå…¨ä¸ç›¸å…³çš„è¯·æ±‚
}

/// å…¶ä»–æ„å›¾å¤„ç†æœåŠ¡
class OtherIntentHandlingService {
  final IntelligentHelpService _helpService;
  final FeedbackCollectionService _feedbackService;
  final DataInterpretationService _dataService;
  final EmotionalCompanionService _emotionalService;
  final AmbiguousIntentClarifier _clarifier;

  /// å¤„ç†å…¶ä»–ç±»åˆ«æ„å›¾
  Future<OtherIntentResult> handleOtherIntent({
    required String userInput,
    required VoiceContext context,
  }) async {
    // 1. ç»†åˆ†ç±»å‹è¯†åˆ«
    final subType = await _classifyOtherIntent(userInput, context);

    // 2. æ ¹æ®ç±»å‹åˆ†å‘å¤„ç†
    switch (subType) {
      case OtherIntentType.helpGuidance:
        return await _helpService.provideGuidance(userInput, context);

      case OtherIntentType.feedback:
        return await _feedbackService.collectFeedback(userInput, context);

      case OtherIntentType.featureInquiry:
        return await _handleFeatureInquiry(userInput);

      case OtherIntentType.dataInterpretation:
        return await _dataService.interpretData(userInput, context);

      case OtherIntentType.emotionalExpression:
        return await _emotionalService.respondToEmotion(userInput, context);

      case OtherIntentType.casualChat:
        return await _handleCasualChat(userInput, context);

      case OtherIntentType.confirmation:
        return await _handleConfirmation(userInput, context);

      case OtherIntentType.contextSupplement:
        return await _handleContextSupplement(userInput, context);

      case OtherIntentType.ambiguous:
        return await _clarifier.clarifyIntent(userInput, context);

      case OtherIntentType.outOfScope:
        return await _handleOutOfScope(userInput);
    }
  }

  /// ç»†åˆ†ç±»å‹è¯†åˆ«
  Future<OtherIntentType> _classifyOtherIntent(
    String input,
    VoiceContext context,
  ) async {
    // è§„åˆ™ä¼˜å…ˆåŒ¹é…
    final ruleResult = _matchByRules(input);
    if (ruleResult != null) return ruleResult;

    // ä¸Šä¸‹æ–‡æ¨æ–­
    final contextResult = _inferFromContext(input, context);
    if (contextResult != null) return contextResult;

    // LLM åˆ†ç±»
    return await _classifyByLLM(input, context);
  }

  /// è§„åˆ™åŒ¹é…
  OtherIntentType? _matchByRules(String input) {
    final lowerInput = input.toLowerCase();

    // å¸®åŠ©å¼•å¯¼å…³é”®è¯
    if (_matchPatterns(lowerInput, [
      r'æ€ä¹ˆ(ç”¨|ä½¿ç”¨|æ“ä½œ)',
      r'å¦‚ä½•.*(è®°è´¦|è®¾ç½®|æ·»åŠ )',
      r'æ•™æˆ‘.*',
      r'.*åœ¨å“ªé‡Œ',
      r'æ€æ ·æ‰èƒ½.*',
    ])) {
      return OtherIntentType.helpGuidance;
    }

    // åé¦ˆé—®é¢˜å…³é”®è¯
    if (_matchPatterns(lowerInput, [
      r'(bug|é—®é¢˜|é”™è¯¯|æ•…éšœ)',
      r'ä¸èƒ½(ç”¨|å·¥ä½œ)',
      r'å»ºè®®.*',
      r'å¸Œæœ›.*(å¢åŠ |æ”¹è¿›)',
      r'åé¦ˆ.*',
    ])) {
      return OtherIntentType.feedback;
    }

    // åŠŸèƒ½å’¨è¯¢å…³é”®è¯
    if (_matchPatterns(lowerInput, [
      r'(èƒ½ä¸èƒ½|å¯ä»¥|æ”¯æŒ).*(åš|å®ç°)',
      r'æœ‰æ²¡æœ‰.*åŠŸèƒ½',
      r'æ˜¯å¦æ”¯æŒ.*',
    ])) {
      return OtherIntentType.featureInquiry;
    }

    // æ•°æ®è§£è¯»å…³é”®è¯
    if (_matchPatterns(lowerInput, [
      r'(ä¸ºä»€ä¹ˆ|æ€ä¹ˆ).*(è¿™ä¹ˆå¤š|è¿™ä¹ˆå°‘|å¢åŠ |å‡å°‘)',
      r'.*æ˜¯ä»€ä¹ˆæ„æ€',
      r'å¸®æˆ‘(åˆ†æ|è§£è¯»|çœ‹çœ‹)',
      r'è¿™ä¸ªæ•°æ®.*',
    ])) {
      return OtherIntentType.dataInterpretation;
    }

    // æƒ…æ„Ÿè¡¨è¾¾å…³é”®è¯
    if (_matchPatterns(lowerInput, [
      r'(å¤ªæ£’äº†|çœŸå¥½|è°¢è°¢|æ„Ÿè°¢)',
      r'(çƒ¦æ­»äº†|å¥½çƒ¦|è®¨åŒ)',
      r'(å“­äº†|ç©·äº†|ç ´äº§äº†)',
      r'åˆè¶…æ”¯äº†',
    ])) {
      return OtherIntentType.emotionalExpression;
    }

    return null;
  }
}
```

#### 18.1.2.2 æ™ºèƒ½å¸®åŠ©å¼•å¯¼

```dart
/// æ™ºèƒ½å¸®åŠ©æœåŠ¡
class IntelligentHelpService {
  final HelpKnowledgeBase _knowledgeBase;
  final ContextualHelpGenerator _helpGenerator;
  final UserBehaviorAnalyzer _behaviorAnalyzer;

  /// æä¾›æ™ºèƒ½å¸®åŠ©
  Future<OtherIntentResult> provideGuidance(
    String query,
    VoiceContext context,
  ) async {
    // 1. ç†è§£ç”¨æˆ·é—®é¢˜
    final helpIntent = await _parseHelpIntent(query);

    // 2. æŸ¥æ‰¾ç›¸å…³å¸®åŠ©å†…å®¹
    final helpArticles = await _knowledgeBase.search(
      query: helpIntent.topic,
      userLevel: await _behaviorAnalyzer.getUserProficiency(),
    );

    // 3. æ ¹æ®ç”¨æˆ·æ°´å¹³ç”Ÿæˆä¸ªæ€§åŒ–å›å¤
    final response = await _helpGenerator.generateResponse(
      question: query,
      articles: helpArticles,
      userContext: context,
      style: _determineResponseStyle(context),
    );

    // 4. æä¾›æ“ä½œå¼•å¯¼
    if (response.hasActionableSteps) {
      return OtherIntentResult.guidedAction(
        message: response.text,
        steps: response.steps,
        quickActions: response.quickActions,
        relatedTopics: response.relatedTopics,
      );
    }

    return OtherIntentResult.informational(
      message: response.text,
      learnMore: helpArticles.map((a) => a.title).toList(),
    );
  }

  /// ç¡®å®šå›å¤é£æ ¼
  HelpResponseStyle _determineResponseStyle(VoiceContext context) {
    // æ–°ç”¨æˆ·ï¼šè¯¦ç»†æ­¥éª¤
    if (context.user.isNewUser) {
      return HelpResponseStyle.detailed;
    }
    // é‡å¤é—®é¢˜ï¼šç®€æ´å›ç­” + ç›¸å…³é“¾æ¥
    if (context.hasAskedBefore) {
      return HelpResponseStyle.concise;
    }
    // é»˜è®¤ï¼šå¹³è¡¡æ¨¡å¼
    return HelpResponseStyle.balanced;
  }
}

/// å¸®åŠ©çŸ¥è¯†åº“
class HelpKnowledgeBase {
  final Map<String, List<HelpArticle>> _categoryIndex;
  final SemanticSearchEngine _semanticSearch;

  /// åŠŸèƒ½å¸®åŠ©æ˜ å°„
  static const Map<String, HelpTopic> featureHelpMap = {
    'è¯­éŸ³è®°è´¦': HelpTopic(
      title: 'è¯­éŸ³è®°è´¦ä½¿ç”¨æŒ‡å—',
      shortAnswer: 'æ‚¨å¯ä»¥ç›´æ¥è¯´"èŠ±äº†50å…ƒåƒé¥­"æ¥å¿«é€Ÿè®°è´¦',
      steps: [
        'ç‚¹å‡»é¦–é¡µçš„éº¦å…‹é£æŒ‰é’®',
        'è¯´å‡ºæ‚¨çš„æ¶ˆè´¹ï¼Œå¦‚"åˆé¤èŠ±äº†30å…ƒ"',
        'ç¡®è®¤è¯†åˆ«ç»“æœåç‚¹å‡»ä¿å­˜',
      ],
      tips: ['å¯ä»¥è¯´å¤šç¬”è´¦ç›®ï¼Œå¦‚"æ—©é¤10å…ƒï¼Œåˆé¤25å…ƒ"'],
      relatedFeatures: ['æ‹ç…§è®°è´¦', 'æ¨¡æ¿è®°è´¦'],
    ),
    'é¢„ç®—è®¾ç½®': HelpTopic(
      title: 'å¦‚ä½•è®¾ç½®é¢„ç®—',
      shortAnswer: 'åœ¨"æˆ‘çš„"é¡µé¢æ‰¾åˆ°"é¢„ç®—ç®¡ç†"ï¼Œç‚¹å‡»æ·»åŠ é¢„ç®—',
      steps: [
        'è¿›å…¥"æˆ‘çš„"é¡µé¢',
        'ç‚¹å‡»"é¢„ç®—ç®¡ç†"',
        'é€‰æ‹©"æ·»åŠ é¢„ç®—"',
        'è®¾ç½®ç±»åˆ«ã€é‡‘é¢å’Œå‘¨æœŸ',
      ],
      tips: ['å»ºè®®å…ˆä»å¤§ç±»é¢„ç®—å¼€å§‹ï¼Œé€æ­¥ç»†åŒ–'],
      relatedFeatures: ['å°é‡‘åº“', 'è¶…æ”¯æé†’'],
    ),
    // ... æ›´å¤šåŠŸèƒ½å¸®åŠ©
  };

  /// æœç´¢å¸®åŠ©å†…å®¹
  Future<List<HelpArticle>> search({
    required String query,
    required UserProficiency userLevel,
  }) async {
    // 1. å…³é”®è¯åŒ¹é…
    final keywordResults = _matchByKeywords(query);

    // 2. è¯­ä¹‰æœç´¢
    final semanticResults = await _semanticSearch.search(query);

    // 3. åˆå¹¶å»é‡ï¼Œæ ¹æ®ç”¨æˆ·æ°´å¹³æ’åº
    return _mergeAndRank(
      keywordResults,
      semanticResults,
      userLevel,
    );
  }
}
```

#### 18.1.2.3 æ™ºèƒ½æ•°æ®è§£è¯»

```dart
/// æ™ºèƒ½æ•°æ®è§£è¯»æœåŠ¡
class IntelligentDataInterpreter {
  final StatisticsService _statsService;
  final TrendAnalyzer _trendAnalyzer;
  final LLMService _llm;

  /// è§£è¯»ç”¨æˆ·è¯¢é—®çš„æ•°æ®
  Future<OtherIntentResult> interpretData(
    String query,
    VoiceContext context,
  ) async {
    // 1. è¯†åˆ«ç”¨æˆ·å…³å¿ƒçš„æ•°æ®ç»´åº¦
    final dataFocus = await _identifyDataFocus(query);

    // 2. è·å–ç›¸å…³æ•°æ®
    final data = await _fetchRelevantData(dataFocus, context);

    // 3. ç”Ÿæˆæ™ºèƒ½è§£è¯»
    final interpretation = await _generateInterpretation(
      query: query,
      data: data,
      userContext: context,
    );

    return OtherIntentResult.dataInsight(
      message: interpretation.summary,
      highlights: interpretation.keyPoints,
      visualizations: interpretation.suggestedCharts,
      actionSuggestions: interpretation.recommendations,
    );
  }

  /// è¯†åˆ«æ•°æ®ç„¦ç‚¹
  Future<DataFocus> _identifyDataFocus(String query) async {
    // æ—¶é—´ç»´åº¦è¯†åˆ«
    final timeRange = _extractTimeRange(query);

    // ç±»åˆ«ç»´åº¦è¯†åˆ«
    final categories = _extractCategories(query);

    // é—®é¢˜ç±»å‹è¯†åˆ«
    final questionType = _identifyQuestionType(query);

    return DataFocus(
      timeRange: timeRange,
      categories: categories,
      questionType: questionType,
    );
  }

  /// é—®é¢˜ç±»å‹
  QuestionType _identifyQuestionType(String query) {
    if (query.contains(RegExp(r'ä¸ºä»€ä¹ˆ.*(å¤š|å°‘|é«˜|ä½)'))) {
      return QuestionType.causation;  // åŸå› åˆ†æ
    }
    if (query.contains(RegExp(r'(å¯¹æ¯”|æ¯”è¾ƒ|å’Œ.*æ¯”)'))) {
      return QuestionType.comparison;  // å¯¹æ¯”åˆ†æ
    }
    if (query.contains(RegExp(r'(è¶‹åŠ¿|å˜åŒ–|èµ°åŠ¿)'))) {
      return QuestionType.trend;  // è¶‹åŠ¿åˆ†æ
    }
    if (query.contains(RegExp(r'(æ„æˆ|å æ¯”|åˆ†å¸ƒ)'))) {
      return QuestionType.composition;  // æ„æˆåˆ†æ
    }
    return QuestionType.general;  // ä¸€èˆ¬æ€§æŸ¥è¯¢
  }

  /// ç”Ÿæˆæ™ºèƒ½è§£è¯»
  Future<DataInterpretation> _generateInterpretation({
    required String query,
    required FinancialData data,
    required VoiceContext userContext,
  }) async {
    // æ„å»ºè§£è¯»æç¤º
    final prompt = '''
åˆ†æä»¥ä¸‹è´¢åŠ¡æ•°æ®å¹¶å›ç­”ç”¨æˆ·é—®é¢˜ï¼š

ç”¨æˆ·é—®é¢˜ï¼š$query

æ•°æ®æ¦‚è¦ï¼š
- æ—¶é—´èŒƒå›´ï¼š${data.timeRange}
- æ€»æ”¯å‡ºï¼š${data.totalExpense}
- æ€»æ”¶å…¥ï¼š${data.totalIncome}
- ä¸»è¦ç±»åˆ«åˆ†å¸ƒï¼š${data.categoryBreakdown}
- åŒæ¯”å˜åŒ–ï¼š${data.yearOverYear}
- ç¯æ¯”å˜åŒ–ï¼š${data.monthOverMonth}

è¯·æä¾›ï¼š
1. ç®€æ´çš„å›ç­”ï¼ˆ2-3å¥è¯ï¼‰
2. 3ä¸ªå…³é”®æ•°æ®ç‚¹
3. 1-2ä¸ªå¯è¡Œçš„å»ºè®®
''';

    final response = await _llm.generate(prompt);
    return DataInterpretation.fromLLMResponse(response);
  }
}

/// æ•°æ®è§£è¯»ç¤ºä¾‹å¯¹è¯
const dataInterpretationExamples = '''
ç”¨æˆ·ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªæœˆèŠ±è¿™ä¹ˆå¤šï¼Ÿ
AIï¼šæœ¬æœˆæ€»æ”¯å‡º12,580å…ƒï¼Œæ¯”ä¸Šæœˆå¢åŠ äº†35%ã€‚ä¸»è¦åŸå› æ˜¯ï¼š
   1. è´­ç‰©ç±»åˆ«æ”¯å‡º4,200å…ƒï¼ˆåŒåä¸€ä¿ƒé”€ï¼‰
   2. é¤é¥®ç±»åˆ«æ”¯å‡º2,100å…ƒï¼ˆæ¯”å¹³æ—¶å¤š800å…ƒï¼‰
   å»ºè®®ï¼šå¯ä»¥è®¾ç½®è´­ç‰©é¢„ç®—æé†’ï¼Œé¿å…å†²åŠ¨æ¶ˆè´¹ã€‚

ç”¨æˆ·ï¼šæˆ‘çš„é’±éƒ½èŠ±å“ªå»äº†ï¼Ÿ
AIï¼šè¿‡å»30å¤©çš„æ”¯å‡ºåˆ†å¸ƒå¦‚ä¸‹ï¼š
   é¤é¥® 28% (2,450å…ƒ)
   ä½æˆ¿ 25% (2,180å…ƒ)
   è´­ç‰© 20% (1,750å…ƒ)
   äº¤é€š 12% (1,050å…ƒ)
   å…¶ä»– 15% (1,310å…ƒ)
   é¤é¥®å æ¯”æœ€é«˜ï¼Œå¯ä»¥è€ƒè™‘å¤šåœ¨å®¶åšé¥­èŠ‚çœå¼€æ”¯ã€‚
''';
```

#### 18.1.2.4 æƒ…æ„Ÿé™ªä¼´å“åº”

```dart
/// æƒ…æ„Ÿé™ªä¼´æœåŠ¡
class EmotionalCompanionService {
  final SentimentAnalyzer _sentimentAnalyzer;
  final MotivationEngine _motivationEngine;
  final UserMoodTracker _moodTracker;

  /// å“åº”ç”¨æˆ·æƒ…æ„Ÿè¡¨è¾¾
  Future<OtherIntentResult> respondToEmotion(
    String input,
    VoiceContext context,
  ) async {
    // 1. æƒ…æ„Ÿåˆ†æ
    final sentiment = await _sentimentAnalyzer.analyze(input);

    // 2. è®°å½•ç”¨æˆ·æƒ…ç»ªï¼ˆç”¨äºé•¿æœŸå…³æ€€ï¼‰
    await _moodTracker.recordMood(
      userId: context.userId,
      sentiment: sentiment,
      trigger: input,
    );

    // 3. ç”Ÿæˆæƒ…æ„Ÿå“åº”
    final response = await _generateEmotionalResponse(
      sentiment: sentiment,
      input: input,
      context: context,
    );

    // 4. å¯èƒ½çš„è¡ŒåŠ¨å»ºè®®
    final suggestions = await _generateActionableSuggestions(
      sentiment: sentiment,
      context: context,
    );

    return OtherIntentResult.emotional(
      message: response,
      tone: sentiment.dominantEmotion,
      suggestions: suggestions,
    );
  }

  /// ç”Ÿæˆæƒ…æ„Ÿå“åº”
  Future<String> _generateEmotionalResponse({
    required SentimentResult sentiment,
    required String input,
    required VoiceContext context,
  }) async {
    switch (sentiment.dominantEmotion) {
      case Emotion.frustrated:
        return _handleFrustration(input, context);

      case Emotion.anxious:
        return _handleAnxiety(input, context);

      case Emotion.happy:
        return _handleHappiness(input, context);

      case Emotion.sad:
        return _handleSadness(input, context);

      case Emotion.surprised:
        return _handleSurprise(input, context);

      default:
        return _handleNeutral(input, context);
    }
  }

  /// å¤„ç†æ²®ä¸§æƒ…ç»ªï¼ˆå¦‚è¶…æ”¯ï¼‰
  Future<String> _handleFrustration(String input, VoiceContext context) async {
    // æ£€æŸ¥æ˜¯å¦ä¸è´¢åŠ¡ç›¸å…³
    if (_isFinanceRelated(input)) {
      final encouragement = await _motivationEngine.getEncouragement(
        situation: 'budget_exceeded',
        userHistory: context.userHistory,
      );

      return '''
${encouragement.empathy}

${encouragement.perspective}

${encouragement.actionTip}
''';
    }

    return 'æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ';
  }
}

/// æ¿€åŠ±å¼•æ“
class MotivationEngine {
  /// è·å–é¼“åŠ±è¯è¯­
  Future<Encouragement> getEncouragement({
    required String situation,
    required UserHistory userHistory,
  }) async {
    switch (situation) {
      case 'budget_exceeded':
        final progress = userHistory.budgetAdherence;
        if (progress > 0.7) {
          return Encouragement(
            empathy: 'è¶…æ”¯ç¡®å®è®©äººæ²®ä¸§ï¼Œä½†åˆ«å¤ªè‡ªè´£ã€‚',
            perspective: 'å…¶å®æ‚¨æœ¬æœˆæœ‰${(progress * 100).toInt()}%çš„æ—¶é—´éƒ½æ§åˆ¶å¾—å¾ˆå¥½ï¼',
            actionTip: 'è¦ä¸è¦çœ‹çœ‹å“ªäº›æ¶ˆè´¹å¯ä»¥è°ƒæ•´ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨åˆ†æã€‚',
          );
        } else {
          return Encouragement(
            empathy: 'ç†è´¢æ˜¯ä¸ªæ¸è¿›çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªäººéƒ½ä¼šé‡åˆ°æŒ‘æˆ˜ã€‚',
            perspective: 'é‡è¦çš„æ˜¯æ‚¨åœ¨å…³æ³¨è‡ªå·±çš„è´¢åŠ¡çŠ¶å†µï¼Œè¿™å·²ç»æ˜¯å¾ˆå¥½çš„å¼€å§‹äº†ã€‚',
            actionTip: 'è¦ä¸è¦ä¸€èµ·è®¾å®šä¸€ä¸ªæ›´å®¹æ˜“è¾¾æˆçš„å°ç›®æ ‡ï¼Ÿ',
          );
        }

      case 'savings_achieved':
        return Encouragement(
          empathy: 'å¤ªæ£’äº†ï¼',
          perspective: 'æ‚¨çš„åšæŒå¾—åˆ°äº†å›æŠ¥ï¼Œå‚¨è“„ç›®æ ‡è¾¾æˆï¼',
          actionTip: 'è¦ä¸è¦è®¾å®šä¸‹ä¸€ä¸ªæ›´æœ‰æŒ‘æˆ˜çš„ç›®æ ‡ï¼Ÿ',
        );

      default:
        return Encouragement.default_();
    }
  }
}

/// æƒ…æ„Ÿå“åº”ç¤ºä¾‹
const emotionalResponseExamples = '''
ç”¨æˆ·ï¼šåˆè¶…æ”¯äº†ï¼Œçƒ¦æ­»äº†
AIï¼šè¶…æ”¯ç¡®å®è®©äººæ²®ä¸§ï¼Œä½†åˆ«å¤ªè‡ªè´£ã€‚
    å…¶å®æ‚¨æœ¬æœˆæœ‰85%çš„æ—¶é—´éƒ½æ§åˆ¶å¾—å¾ˆå¥½å‘¢ï¼
    è¦ä¸è¦çœ‹çœ‹æ˜¯å“ªç¬”æ¶ˆè´¹è¶…å‡ºé¢„æœŸï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨åˆ†æä¸€ä¸‹ã€‚

ç”¨æˆ·ï¼šè¿™ä¸ªæœˆç»ˆäºæ²¡è¶…æ”¯ï¼
AIï¼šå¤ªæ£’äº†ï¼æ‚¨çš„é¢„ç®—æ§åˆ¶åšå¾—å¾ˆå¥½ï¼
    æœ¬æœˆèŠ‚çœäº†320å…ƒï¼Œç»§ç»­ä¿æŒï¼
    è¦ä¸è¦æŠŠçœä¸‹çš„é’±è½¬å…¥å‚¨è“„ç›®æ ‡ï¼Ÿ

ç”¨æˆ·ï¼šæ„Ÿè§‰è‡ªå·±å¥½ç©·å•Š
AIï¼šç†è´¢æ˜¯ä¸ªå¾ªåºæ¸è¿›çš„è¿‡ç¨‹ï¼Œæ‚¨èƒ½å…³æ³¨è‡ªå·±çš„è´¢åŠ¡çŠ¶å†µå·²ç»å¾ˆæ£’äº†ã€‚
    å…¶å®ä»æ•°æ®çœ‹ï¼Œæ‚¨æœ¬æœˆçš„å‚¨è“„ç‡æ˜¯15%ï¼Œæ¯”ä¸Šæœˆæé«˜äº†3%å‘¢ã€‚
    è¦ä¸è¦ä¸€èµ·çœ‹çœ‹è¿˜æœ‰å“ªäº›å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Ÿ
''';
```

#### 18.1.2.5 æ¨¡ç³Šæ„å›¾æ¾„æ¸…

```dart
/// æ¨¡ç³Šæ„å›¾æ¾„æ¸…æœåŠ¡
class AmbiguousIntentClarifier {
  final ContextInferenceEngine _contextEngine;
  final IntentCandidateGenerator _candidateGenerator;

  /// æ¾„æ¸…æ¨¡ç³Šæ„å›¾
  Future<OtherIntentResult> clarifyIntent(
    String input,
    VoiceContext context,
  ) async {
    // 1. ç”Ÿæˆå¯èƒ½çš„æ„å›¾å€™é€‰
    final candidates = await _candidateGenerator.generate(
      input: input,
      context: context,
    );

    // 2. å¦‚æœæœ‰é«˜ç½®ä¿¡åº¦å€™é€‰ï¼Œç›´æ¥ç¡®è®¤
    if (candidates.first.confidence > 0.7) {
      return OtherIntentResult.clarification(
        message: 'æ‚¨æ˜¯æƒ³${candidates.first.description}å—ï¼Ÿ',
        suggestedIntent: candidates.first,
        alternatives: candidates.skip(1).take(2).toList(),
      );
    }

    // 3. å¤šä¸ªå€™é€‰ï¼Œæä¾›é€‰æ‹©
    if (candidates.length >= 2) {
      return OtherIntentResult.multiChoice(
        message: 'è¯·é—®æ‚¨æƒ³è¦ï¼š',
        options: candidates.take(4).map((c) => ClarificationOption(
          label: c.shortLabel,
          description: c.description,
          action: c.action,
        )).toList(),
      );
    }

    // 4. æ— æ³•ç†è§£ï¼Œç¤¼è²Œè¯¢é—®
    return OtherIntentResult.askForClarification(
      message: 'æŠ±æ­‰ï¼Œæˆ‘ä¸å¤ªç†è§£æ‚¨çš„æ„æ€ã€‚æ‚¨å¯ä»¥æ¢ä¸ªæ–¹å¼æè¿°ä¸€ä¸‹å—ï¼Ÿ',
      hints: _generateHints(context),
    );
  }

  /// ç”Ÿæˆæç¤º
  List<String> _generateHints(VoiceContext context) {
    final hints = <String>[];

    // åŸºäºæœ€è¿‘æ“ä½œ
    if (context.lastAction != null) {
      hints.add('ç»§ç»­${context.lastAction.description}');
    }

    // å¸¸ç”¨åŠŸèƒ½æç¤º
    hints.addAll([
      'è®°ä¸€ç¬”è´¦',
      'æŸ¥çœ‹æœ¬æœˆæ”¯å‡º',
      'è®¾ç½®é¢„ç®—',
    ]);

    return hints.take(3).toList();
  }
}

/// ä¸Šä¸‹æ–‡æ¨æ–­å¼•æ“
class ContextInferenceEngine {
  /// ä»ä¸Šä¸‹æ–‡æ¨æ–­å¯èƒ½çš„æ„å›¾
  Future<List<IntentCandidate>> inferFromContext({
    required String ambiguousInput,
    required VoiceContext context,
  }) async {
    final candidates = <IntentCandidate>[];

    // 1. åŸºäºå¯¹è¯å†å²æ¨æ–­
    if (context.lastQuestion != null) {
      // å¯èƒ½æ˜¯å¯¹ä¸Šä¸€ä¸ªé—®é¢˜çš„å›ç­”
      candidates.add(IntentCandidate(
        type: IntentType.answerToPreviousQuestion,
        confidence: 0.6,
        description: 'å›ç­”"${context.lastQuestion}"',
      ));
    }

    // 2. åŸºäºå¾…ç¡®è®¤æ“ä½œæ¨æ–­
    if (context.pendingConfirmation != null) {
      candidates.add(IntentCandidate(
        type: IntentType.confirmation,
        confidence: _isAffirmative(ambiguousInput) ? 0.8 : 0.3,
        description: 'ç¡®è®¤${context.pendingConfirmation}',
      ));
    }

    // 3. åŸºäºæ—¶é—´/ä½ç½®ä¸Šä¸‹æ–‡æ¨æ–­
    final timeBasedIntent = _inferFromTimeContext(context);
    if (timeBasedIntent != null) {
      candidates.add(timeBasedIntent);
    }

    return candidates..sort((a, b) => b.confidence.compareTo(a.confidence));
  }

  /// åˆ¤æ–­æ˜¯å¦æ˜¯è‚¯å®šå›ç­”
  bool _isAffirmative(String input) {
    return RegExp(r'^(æ˜¯|å¯¹|å¥½|å¯ä»¥|ç¡®è®¤|æ²¡é—®é¢˜|OK|å—¯)').hasMatch(input);
  }
}
```

#### 18.1.2.6 è¶…å‡ºèŒƒå›´å¤„ç†

```dart
/// è¶…å‡ºèŒƒå›´è¯·æ±‚å¤„ç†
class OutOfScopeHandler {
  final FeatureCapabilityMap _capabilities;
  final PoliteDeclineGenerator _declineGenerator;

  /// å¤„ç†è¶…å‡ºèŒƒå›´çš„è¯·æ±‚
  Future<OtherIntentResult> handleOutOfScope(String input) async {
    // 1. è¯†åˆ«ç”¨æˆ·çœŸå®éœ€æ±‚
    final userNeed = await _identifyUnderlyingNeed(input);

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³åŠŸèƒ½å¯ä»¥éƒ¨åˆ†æ»¡è¶³
    final relatedFeatures = _findRelatedFeatures(userNeed);

    // 3. ç”Ÿæˆç¤¼è²Œçš„å›å¤
    if (relatedFeatures.isNotEmpty) {
      return OtherIntentResult.partialCapability(
        message: 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶ä¸èƒ½${userNeed.description}ï¼Œä¸è¿‡æˆ‘å¯ä»¥å¸®æ‚¨ï¼š',
        alternatives: relatedFeatures,
      );
    }

    // 4. å®Œå…¨æ— æ³•æ»¡è¶³
    return OtherIntentResult.decline(
      message: await _declineGenerator.generate(
        request: input,
        tone: DeclineTone.friendly,
      ),
      whatICanDo: _capabilities.getTopFeatures(5),
    );
  }

  /// æŸ¥æ‰¾ç›¸å…³åŠŸèƒ½
  List<FeatureAlternative> _findRelatedFeatures(UserNeed need) {
    final alternatives = <FeatureAlternative>[];

    // ç¤ºä¾‹ï¼šç”¨æˆ·é—®å¤©æ°”ï¼Œæ¨èæ¶ˆè´¹å»ºè®®
    if (need.category == 'weather') {
      alternatives.add(FeatureAlternative(
        feature: 'æ¶ˆè´¹å»ºè®®',
        description: 'è™½ç„¶ä¸èƒ½æŸ¥å¤©æ°”ï¼Œä½†å¯ä»¥æ ¹æ®å­£èŠ‚ç»™æ‚¨æ¶ˆè´¹å»ºè®®',
        action: () => _openSeasonalAdvice(),
      ));
    }

    // ç¤ºä¾‹ï¼šç”¨æˆ·é—®å¯¼èˆªï¼Œæ¨èé™„è¿‘æ¶ˆè´¹è®°å½•
    if (need.category == 'navigation') {
      alternatives.add(FeatureAlternative(
        feature: 'é™„è¿‘æ¶ˆè´¹',
        description: 'å¯ä»¥æŸ¥çœ‹æ‚¨åœ¨è¿™ä¸ªåŒºåŸŸçš„å†å²æ¶ˆè´¹è®°å½•',
        action: () => _openNearbyExpenses(),
      ));
    }

    return alternatives;
  }
}

/// ç¤¼è²Œæ‹’ç»ç”Ÿæˆå™¨
class PoliteDeclineGenerator {
  /// ç”Ÿæˆç¤¼è²Œçš„æ‹’ç»å›å¤
  Future<String> generate({
    required String request,
    required DeclineTone tone,
  }) async {
    final templates = {
      DeclineTone.friendly: [
        'ä¸å¥½æ„æ€ï¼Œè¿™ä¸ªæˆ‘è¿˜ä¸å¤ªä¼šå‘¢~ ä¸è¿‡è®°è´¦æ–¹é¢æˆ‘å¾ˆåœ¨è¡Œï¼',
        'è¿™ä¸ªè¶…å‡ºæˆ‘çš„èƒ½åŠ›èŒƒå›´äº†ï¼Œæˆ‘æ˜¯ä¸“æ³¨äºå¸®æ‚¨ç†è´¢çš„å°åŠ©æ‰‹å“¦ã€‚',
        'æŠ±æ­‰è¿™ä¸ªå¸®ä¸äº†æ‚¨ï¼Œä½†å¦‚æœæ˜¯è®°è´¦ã€é¢„ç®—æ–¹é¢çš„äº‹ï¼Œéšæ—¶æ‰¾æˆ‘ï¼',
      ],
      DeclineTone.professional: [
        'æŠ±æ­‰ï¼Œè¯¥åŠŸèƒ½æš‚ä¸æ”¯æŒã€‚æˆ‘å¯ä»¥å¸®æ‚¨å¤„ç†è®°è´¦ã€é¢„ç®—ç­‰è´¢åŠ¡ç›¸å…³äº‹åŠ¡ã€‚',
        'è¿™è¶…å‡ºäº†åº”ç”¨çš„æœåŠ¡èŒƒå›´ã€‚å¦‚éœ€è´¢åŠ¡ç®¡ç†å¸®åŠ©ï¼Œæˆ‘å¾ˆä¹æ„ååŠ©ã€‚',
      ],
    };

    final options = templates[tone] ?? templates[DeclineTone.friendly]!;
    return options[DateTime.now().millisecond % options.length];
  }
}
```

#### 18.1.2.7 å…¶ä»–æ„å›¾å­¦ä¹ ä¼˜åŒ–

```dart
/// å…¶ä»–æ„å›¾å­¦ä¹ æœåŠ¡
class OtherIntentLearningService {
  final LocalLearningStore _localStore;
  final GlobalPatternAggregator _globalAggregator;

  /// ä»"å…¶ä»–"æ„å›¾ä¸­å­¦ä¹ 
  Future<void> learnFromOtherIntent({
    required String input,
    required OtherIntentType classifiedType,
    required UserFeedback feedback,
  }) async {
    // 1. å¦‚æœåˆ†ç±»æ­£ç¡®ï¼Œå¼ºåŒ–æ¨¡å¼
    if (feedback.isCorrect) {
      await _reinforcePattern(input, classifiedType);
    }

    // 2. å¦‚æœåˆ†ç±»é”™è¯¯ï¼Œå­¦ä¹ æ­£ç¡®æ˜ å°„
    if (feedback.correctedType != null) {
      await _learnCorrection(input, feedback.correctedType!);
    }

    // 3. å‘ç°æ–°çš„æ„å›¾æ¨¡å¼
    if (feedback.suggestedNewType != null) {
      await _reportNewPattern(input, feedback.suggestedNewType!);
    }
  }

  /// å¼ºåŒ–æ­£ç¡®æ¨¡å¼
  Future<void> _reinforcePattern(String input, OtherIntentType type) async {
    // æå–ç‰¹å¾
    final features = _extractFeatures(input);

    // æ›´æ–°æœ¬åœ°æ¨¡å¼æƒé‡
    await _localStore.reinforcePattern(
      features: features,
      intentType: type,
      weight: 1.0,
    );

    // ä¸ŠæŠ¥ç”¨äºå…¨å±€å­¦ä¹ ï¼ˆè„±æ•ï¼‰
    await _globalAggregator.reportPattern(
      patternHash: _hashPattern(features),
      intentType: type,
    );
  }

  /// å­¦ä¹ çº æ­£
  Future<void> _learnCorrection(String input, OtherIntentType correctType) async {
    final features = _extractFeatures(input);

    // è®°å½•çº æ­£æ ·æœ¬
    await _localStore.addCorrectionSample(
      features: features,
      correctType: correctType,
    );

    // è¾¾åˆ°é˜ˆå€¼åæ›´æ–°è§„åˆ™
    final correctionCount = await _localStore.getCorrectionCount(
      features: features,
      correctType: correctType,
    );

    if (correctionCount >= 3) {
      await _updateLocalRule(features, correctType);
    }
  }

  /// å°†é¢‘ç¹å‡ºç°çš„"å…¶ä»–"æ„å›¾å‡çº§ä¸ºæ–°ç±»å‹
  Future<void> _considerPromotingToNewType() async {
    // åˆ†ææœ€è¿‘30å¤©çš„"ambiguous"åˆ†ç±»
    final ambiguousPatterns = await _localStore.getFrequentAmbiguous(
      days: 30,
      minCount: 10,
    );

    for (final pattern in ambiguousPatterns) {
      // å¦‚æœæŸä¸ªæ¨¡å¼é¢‘ç¹å‡ºç°ä¸”ç”¨æˆ·æœ€ç»ˆéƒ½åšäº†ç›¸åŒæ“ä½œ
      if (pattern.outcomeConsistency > 0.8) {
        // å»ºè®®å‡çº§ä¸ºæ˜¾å¼æ„å›¾ç±»å‹
        await _suggestNewIntentType(pattern);
      }
    }
  }
}
```

### 18.2 è¯­éŸ³è®°è´¦æ¨¡å—

```dart
/// è¯­éŸ³è®°è´¦æœåŠ¡
class VoiceBookkeepingService {
  final TransactionRepository _transactionRepo;
  final SmartCategoryService _categoryService;
  final EntityExtractor _entityExtractor;

  /// å¤„ç†è¯­éŸ³è®°è´¦è¯·æ±‚
  Future<VoiceBookkeepingResult> processVoiceBookkeeping({
    required String voiceText,
    required VoiceIntent intent,
  }) async {
    switch (intent.type) {
      case VoiceIntentType.addExpense:
      case VoiceIntentType.addIncome:
        return await _processSingleRecord(voiceText, intent);

      case VoiceIntentType.batchRecord:
        return await _processBatchRecord(voiceText, intent);

      case VoiceIntentType.useTemplate:
        return await _processTemplateRecord(voiceText, intent);

      default:
        return VoiceBookkeepingResult.error('ä¸æ”¯æŒçš„è®°è´¦ç±»å‹');
    }
  }

  /// å¤„ç†å•ç¬”è®°è´¦
  Future<VoiceBookkeepingResult> _processSingleRecord(
    String voiceText,
    VoiceIntent intent,
  ) async {
    // 1. æå–å®ä½“ä¿¡æ¯
    final entities = await _entityExtractor.extractFromText(voiceText);

    // 2. æ„å»ºäº¤æ˜“è®°å½•
    final transaction = Transaction(
      id: generateId(),
      type: intent.type == VoiceIntentType.addExpense
          ? TransactionType.expense
          : TransactionType.income,
      amount: entities.amount ?? 0,
      description: entities.description,
      categoryId: entities.categoryId,
      date: entities.date ?? DateTime.now(),
      merchantName: entities.merchantName,
    );

    // 3. æ£€æŸ¥å¿…å¡«å­—æ®µ
    final missingFields = _checkMissingFields(transaction);

    if (missingFields.isNotEmpty) {
      // è¿›å…¥å¤šè½®å¯¹è¯æ¨¡å¼è¡¥å…¨ä¿¡æ¯
      return VoiceBookkeepingResult.needMoreInfo(
        partialTransaction: transaction,
        missingFields: missingFields,
        prompt: _generatePromptForMissingField(missingFields.first),
      );
    }

    // 4. æ™ºèƒ½åˆ†ç±»è¡¥å…¨ï¼ˆå¦‚æœæ²¡æœ‰åˆ†ç±»ï¼‰
    if (transaction.categoryId == null) {
      final suggestions = await _categoryService.suggestCategories(
        description: transaction.description ?? '',
        amount: transaction.amount,
        merchant: transaction.merchantName,
      );

      if (suggestions.isNotEmpty && suggestions.first.confidence > 0.8) {
        transaction = transaction.copyWith(
          categoryId: suggestions.first.category.id,
        );
      } else {
        return VoiceBookkeepingResult.needConfirmCategory(
          partialTransaction: transaction,
          suggestions: suggestions,
        );
      }
    }

    // 5. è¯·æ±‚ç¡®è®¤
    return VoiceBookkeepingResult.needConfirmation(
      transaction: transaction,
      summary: _generateTransactionSummary(transaction),
    );
  }

  /// å¤„ç†å¤šç¬”æ‰¹é‡è®°è´¦
  /// ç¤ºä¾‹ï¼š"æ—©é¤15ï¼Œåˆé¤28ï¼Œæ™šé¤45"
  /// ç¤ºä¾‹ï¼š"ä»Šå¤©èŠ±äº†ï¼šæ‰“è½¦30ï¼Œå’–å•¡18ï¼Œä¹°ä¹¦50"
  Future<VoiceBookkeepingResult> _processBatchRecord(
    String voiceText,
    VoiceIntent intent,
  ) async {
    final transactions = await _entityExtractor.extractMultipleTransactions(voiceText);

    if (transactions.isEmpty) {
      return VoiceBookkeepingResult.error('æœªèƒ½è¯†åˆ«å‡ºäº¤æ˜“ä¿¡æ¯ï¼Œè¯·é‡æ–°æè¿°');
    }

    // ä¸ºæ¯ç¬”äº¤æ˜“è¡¥å…¨åˆ†ç±»
    final processedTransactions = <Transaction>[];
    for (final tx in transactions) {
      final suggestions = await _categoryService.suggestCategories(
        description: tx.description ?? '',
        amount: tx.amount,
      );

      processedTransactions.add(tx.copyWith(
        categoryId: suggestions.isNotEmpty ? suggestions.first.category.id : null,
      ));
    }

    final totalAmount = processedTransactions.fold<double>(0, (sum, tx) => sum + tx.amount);
    return VoiceBookkeepingResult.batchConfirmation(
      transactions: processedTransactions,
      summary: 'è¯†åˆ«åˆ°${processedTransactions.length}ç¬”äº¤æ˜“ï¼Œå…±è®¡${totalAmount.toStringAsFixed(2)}å…ƒ',
    );
  }

  /// ç¡®è®¤å¹¶ä¿å­˜äº¤æ˜“
  Future<VoiceBookkeepingResult> confirmAndSave(Transaction transaction) async {
    try {
      await _transactionRepo.insert(transaction);
      return VoiceBookkeepingResult.success(
        transaction: transaction,
        message: 'å·²è®°å½•ï¼š${transaction.categoryName} ${transaction.amount.toStringAsFixed(2)}å…ƒ',
      );
    } catch (e) {
      return VoiceBookkeepingResult.error('ä¿å­˜å¤±è´¥ï¼š$e');
    }
  }
}

/// å®ä½“æå–å™¨
class EntityExtractor {
  final LLMService _llmService;

  /// é‡‘é¢æå–æ­£åˆ™
  static final _amountPatterns = [
    RegExp(r'([0-9]+(?:\.[0-9]{1,2})?)\s*(å…ƒ|å—|å—é’±)?'),
    RegExp(r'([ï¿¥Â¥])([0-9]+(?:\.[0-9]{1,2})?)'),
  ];

  /// æ—¥æœŸæå–è§„åˆ™
  static final Map<String, DateTime Function()> _dateKeywords = {
    'ä»Šå¤©': () => DateTime.now(),
    'æ˜¨å¤©': () => DateTime.now().subtract(Duration(days: 1)),
    'å‰å¤©': () => DateTime.now().subtract(Duration(days: 2)),
    'ä¸Šå‘¨': () => DateTime.now().subtract(Duration(days: 7)),
  };

  /// ä»æ–‡æœ¬æå–å®ä½“
  Future<ExtractedEntities> extractFromText(String text) async {
    // 1. è§„åˆ™æå–é‡‘é¢
    double? amount;
    for (final pattern in _amountPatterns) {
      final match = pattern.firstMatch(text);
      if (match != null) {
        final amountStr = match.group(1) ?? match.group(2);
        amount = double.tryParse(amountStr ?? '');
        break;
      }
    }

    // 2. è§„åˆ™æå–æ—¥æœŸ
    DateTime? date;
    for (final entry in _dateKeywords.entries) {
      if (text.contains(entry.key)) {
        date = entry.value();
        break;
      }
    }

    // 3. ä½¿ç”¨LLMæå–å¤æ‚å®ä½“
    final llmEntities = await _llmService.extractEntities(
      text: text,
      entityTypes: ['description', 'merchant', 'category_hint'],
    );

    return ExtractedEntities(
      amount: amount,
      date: date ?? DateTime.now(),
      description: llmEntities['description'],
      merchantName: llmEntities['merchant'],
      categoryHint: llmEntities['category_hint'],
    );
  }

  /// æå–å¤šç¬”äº¤æ˜“
  Future<List<Transaction>> extractMultipleTransactions(String text) async {
    // æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†
    final segments = text.split(RegExp(r'[,ï¼Œ;ï¼›ã€]'));

    final transactions = <Transaction>[];
    for (final segment in segments) {
      final trimmed = segment.trim();
      if (trimmed.isEmpty) continue;

      final entities = await extractFromText(trimmed);
      if (entities.amount != null && entities.amount! > 0) {
        transactions.add(Transaction(
          id: generateId(),
          type: TransactionType.expense,
          amount: entities.amount!,
          description: entities.description ?? trimmed,
          date: entities.date,
        ));
      }
    }

    return transactions;
  }
}
```

### 18.3 æ™ºèƒ½è¯­éŸ³é…ç½®æ¨¡å—

æœ¬æ¨¡å—æ”¯æŒé€šè¿‡è¯­éŸ³ä¿®æ”¹ç³»ç»Ÿä¸­å‡ ä¹æ‰€æœ‰çš„é…ç½®é¡¹ï¼Œå®ç°"åŠ¨å£ä¸åŠ¨æ‰‹"çš„é…ç½®ä½“éªŒã€‚

#### 18.3.1 å¯é…ç½®é¡¹å…¨æ™¯å›¾

åŸºäº1.xç‰ˆæœ¬136é¡¹åŠŸèƒ½çš„å®Œæ•´é…ç½®é¡¹è¦†ç›–ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯­éŸ³å¯é…ç½®é¡¹å…¨æ™¯å›¾ï¼ˆå®Œæ•´ç‰ˆï¼‰                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¸€ã€é¢„ç®—ä¸è´¢åŠ¡é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ æœˆåº¦é¢„ç®—è®¾ç½®       â”‚ åˆ†ç±»é¢„ç®—è®¾ç½®       â”‚ é¢„ç®—é«˜çº§è®¾ç½®                   â”‚   â”‚
â”‚  â”‚ â€¢ æ€»æœˆåº¦é¢„ç®—       â”‚ â€¢ é¤é¥®/äº¤é€š/è´­ç‰©   â”‚ â€¢ é¢„ç®—å‘¨æœŸï¼ˆå‘¨/æœˆ/å¹´ï¼‰         â”‚   â”‚
â”‚  â”‚ â€¢ é¢„ç®—é¢„è­¦é˜ˆå€¼     â”‚ â€¢ å¨±ä¹/å±…ä½/åŒ»ç–—   â”‚ â€¢ é¢„ç®—èµ·å§‹æ—¥æœŸ                â”‚   â”‚
â”‚  â”‚ â€¢ è¶…æ”¯ç­–ç•¥è®¾ç½®     â”‚ â€¢ æ•™è‚²/é€šè®¯/æœé¥°   â”‚ â€¢ é¢„ç®—ç»“è½¬è§„åˆ™                â”‚   â”‚
â”‚  â”‚ â€¢ é¢„ç®—æé†’å¼€å…³     â”‚ â€¢ ç¾å¦†/æ•°ç /å…¶ä»–   â”‚ â€¢ é›¶åŸºé¢„ç®—å¼€å…³                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         äºŒã€è´¦æˆ·ä¸èµ„äº§é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è´¦æˆ·ç®¡ç†           â”‚ ä¿¡ç”¨å¡ç®¡ç†         â”‚ æŠ•èµ„è´¦æˆ·                      â”‚   â”‚
â”‚  â”‚ â€¢ ç°é‡‘è´¦æˆ·         â”‚ â€¢ æ·»åŠ ä¿¡ç”¨å¡       â”‚ â€¢ æ·»åŠ æŠ•èµ„è´¦æˆ·                â”‚   â”‚
â”‚  â”‚ â€¢ é“¶è¡Œå¡è´¦æˆ·       â”‚ â€¢ è´¦å•æ—¥è®¾ç½®       â”‚ â€¢ æŠ•èµ„ç±»å‹è®¾ç½®                â”‚   â”‚
â”‚  â”‚ â€¢ æ”¯ä»˜å®/å¾®ä¿¡      â”‚ â€¢ è¿˜æ¬¾æ—¥è®¾ç½®       â”‚ â€¢ æ”¶ç›Šè®¡ç®—æ–¹å¼                â”‚   â”‚
â”‚  â”‚ â€¢ é»˜è®¤è´¦æˆ·è®¾ç½®     â”‚ â€¢ é¢åº¦è®¾ç½®         â”‚ â€¢ é£é™©ç­‰çº§æ ‡è®°                â”‚   â”‚
â”‚  â”‚ â€¢ è´¦æˆ·ä½™é¢æ ¡æ­£     â”‚ â€¢ å…æ¯æœŸè®¾ç½®       â”‚                              â”‚   â”‚
â”‚  â”‚ â€¢ è´¦æˆ·å›¾æ ‡/é¢œè‰²    â”‚ â€¢ è¿˜æ¬¾æé†’         â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¸‰ã€è´¦æœ¬ä¸æˆå‘˜é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è´¦æœ¬ç®¡ç†           â”‚ æˆå‘˜ç®¡ç†           â”‚ æƒé™é…ç½®                      â”‚   â”‚
â”‚  â”‚ â€¢ åˆ›å»ºæ–°è´¦æœ¬       â”‚ â€¢ é‚€è¯·æˆå‘˜         â”‚ â€¢ æŸ¥çœ‹æƒé™                    â”‚   â”‚
â”‚  â”‚ â€¢ åˆ‡æ¢å½“å‰è´¦æœ¬     â”‚ â€¢ ç§»é™¤æˆå‘˜         â”‚ â€¢ ç¼–è¾‘æƒé™                    â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ä¸ºé»˜è®¤è´¦æœ¬     â”‚ â€¢ æˆå‘˜é¢„ç®—è®¾ç½®     â”‚ â€¢ å®¡æ‰¹æƒé™                    â”‚   â”‚
â”‚  â”‚ â€¢ è´¦æœ¬åç§°ä¿®æ”¹     â”‚ â€¢ æˆå‘˜è§’è‰²è®¾ç½®     â”‚ â€¢ ç®¡ç†å‘˜æƒé™                  â”‚   â”‚
â”‚  â”‚ â€¢ è´¦æœ¬å…±äº«è®¾ç½®     â”‚ â€¢ æ¶ˆè´¹å®¡æ‰¹å¼€å…³     â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         å››ã€åˆ†ç±»ä¸æ ‡ç­¾é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ æ”¯å‡ºåˆ†ç±»ç®¡ç†       â”‚ æ”¶å…¥åˆ†ç±»ç®¡ç†       â”‚ æ ‡ç­¾ç®¡ç†                      â”‚   â”‚
â”‚  â”‚ â€¢ æ·»åŠ æ”¯å‡ºåˆ†ç±»     â”‚ â€¢ æ·»åŠ æ”¶å…¥åˆ†ç±»     â”‚ â€¢ åˆ›å»ºæ ‡ç­¾                    â”‚   â”‚
â”‚  â”‚ â€¢ åˆ é™¤åˆ†ç±»         â”‚ â€¢ åˆ é™¤åˆ†ç±»         â”‚ â€¢ åˆ é™¤æ ‡ç­¾                    â”‚   â”‚
â”‚  â”‚ â€¢ ä¿®æ”¹åˆ†ç±»åç§°     â”‚ â€¢ ä¿®æ”¹åˆ†ç±»åç§°     â”‚ â€¢ æ ‡ç­¾é¢œè‰²è®¾ç½®                â”‚   â”‚
â”‚  â”‚ â€¢ åˆ†ç±»å›¾æ ‡è®¾ç½®     â”‚ â€¢ åˆ†ç±»å›¾æ ‡è®¾ç½®     â”‚ â€¢ å¸¸ç”¨æ ‡ç­¾æ’åº                â”‚   â”‚
â”‚  â”‚ â€¢ å­åˆ†ç±»ç®¡ç†       â”‚ â€¢ å­åˆ†ç±»ç®¡ç†       â”‚                              â”‚   â”‚
â”‚  â”‚ â€¢ åˆ†ç±»æ’åºè°ƒæ•´     â”‚ â€¢ åˆ†ç±»æ’åºè°ƒæ•´     â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         äº”ã€ç›®æ ‡ä¸å€ºåŠ¡é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ å‚¨è“„ç›®æ ‡           â”‚ å¼€æ”¯ç›®æ ‡           â”‚ å€ºåŠ¡ç®¡ç†                      â”‚   â”‚
â”‚  â”‚ â€¢ åˆ›å»ºå‚¨è“„ç›®æ ‡     â”‚ â€¢ åˆ›å»ºå¼€æ”¯ç›®æ ‡     â”‚ â€¢ æ·»åŠ å€ºåŠ¡                    â”‚   â”‚
â”‚  â”‚ â€¢ ç›®æ ‡é‡‘é¢è°ƒæ•´     â”‚ â€¢ æœˆåº¦é™é¢è®¾ç½®     â”‚ â€¢ å€ºåŠ¡é‡‘é¢è°ƒæ•´                â”‚   â”‚
â”‚  â”‚ â€¢ ç›®æ ‡æ—¥æœŸè®¾ç½®     â”‚ â€¢ ç›®æ ‡ç±»å‹è®¾ç½®     â”‚ â€¢ åˆ©ç‡è®¾ç½®                    â”‚   â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨å­˜å…¥è®¾ç½®     â”‚ â€¢ è¶…æ”¯æé†’å¼€å…³     â”‚ â€¢ è¿˜æ¬¾ç­–ç•¥é€‰æ‹©                â”‚   â”‚
â”‚  â”‚ â€¢ ç›®æ ‡æš‚åœ/æ¢å¤    â”‚                   â”‚ â€¢ è¿˜æ¬¾æé†’è®¾ç½®                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         å…­ã€æé†’ä¸é€šçŸ¥é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è®°è´¦æé†’           â”‚ é¢„ç®—æé†’           â”‚ è´¦å•æé†’                      â”‚   â”‚
â”‚  â”‚ â€¢ æ¯æ—¥è®°è´¦æé†’     â”‚ â€¢ é¢„ç®—é¢„è­¦é˜ˆå€¼     â”‚ â€¢ ä¿¡ç”¨å¡è¿˜æ¬¾æé†’              â”‚   â”‚
â”‚  â”‚ â€¢ æé†’æ—¶é—´è®¾ç½®     â”‚ â€¢ è¶…æ”¯å®æ—¶é€šçŸ¥     â”‚ â€¢ å®šæœŸè´¦å•æé†’                â”‚   â”‚
â”‚  â”‚ â€¢ æé†’é¢‘ç‡è®¾ç½®     â”‚ â€¢ å‘¨é¢„ç®—æ€»ç»“       â”‚ â€¢ è®¢é˜…ç»­è´¹æé†’                â”‚   â”‚
â”‚  â”‚ â€¢ æé†’æ–¹å¼è®¾ç½®     â”‚ â€¢ æœˆé¢„ç®—æ€»ç»“       â”‚ â€¢ æé†’æå‰å¤©æ•°                â”‚   â”‚
â”‚  â”‚ â€¢ å‘¨æœ«æé†’å¼€å…³     â”‚ â€¢ åˆ†ç±»é¢„ç®—æé†’     â”‚ â€¢ å¾ªç¯æé†’è®¾ç½®                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¸ƒã€æ¨¡æ¿ä¸å®šæ—¶é…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è®°è´¦æ¨¡æ¿           â”‚ å®šæ—¶è®°è´¦           â”‚ å¿«æ·å…¥å£                      â”‚   â”‚
â”‚  â”‚ â€¢ åˆ›å»ºæ¨¡æ¿         â”‚ â€¢ æ·»åŠ å®šæ—¶è®°è´¦     â”‚ â€¢ é¦–é¡µå¿«æ·æ–¹å¼                â”‚   â”‚
â”‚  â”‚ â€¢ åˆ é™¤æ¨¡æ¿         â”‚ â€¢ æ‰§è¡Œé¢‘ç‡è®¾ç½®     â”‚ â€¢ å¸¸ç”¨æ¨¡æ¿æ’åº                â”‚   â”‚
â”‚  â”‚ â€¢ ä¿®æ”¹æ¨¡æ¿å†…å®¹     â”‚ â€¢ æ‰§è¡Œæ—¶é—´è®¾ç½®     â”‚ â€¢ å¿«æ·å…¥å£æ˜¾ç¤º                â”‚   â”‚
â”‚  â”‚ â€¢ æ¨¡æ¿æ’åº         â”‚ â€¢ æš‚åœ/å¯ç”¨å®šæ—¶    â”‚                              â”‚   â”‚
â”‚  â”‚ â€¢ é»˜è®¤æ¨¡æ¿è®¾ç½®     â”‚ â€¢ å®šæ—¶æé†’å¼€å…³     â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         å…«ã€å¤–è§‚ä¸æ˜¾ç¤ºé…ç½®                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ä¸»é¢˜è®¾ç½®           â”‚ é¦–é¡µå¸ƒå±€           â”‚ æ˜¾ç¤ºåå¥½                      â”‚   â”‚
â”‚  â”‚ â€¢ æµ…è‰²/æ·±è‰²/è·Ÿéš   â”‚ â€¢ å¡ç‰‡æ˜¾ç¤º/éšè—    â”‚ â€¢ é‡‘é¢æ˜¾ç¤ºæ ¼å¼                â”‚   â”‚
â”‚  â”‚ â€¢ ä¸»é¢˜è‰²é€‰æ‹©       â”‚ â€¢ å¡ç‰‡æ’åºè°ƒæ•´     â”‚ â€¢ é»˜è®¤æ—¶é—´èŒƒå›´                â”‚   â”‚
â”‚  â”‚  (è“/ç»¿/çº¢/ç´«/æ©™)  â”‚ â€¢ ç»Ÿè®¡å›¾è¡¨ç±»å‹     â”‚ â€¢ å›¾è¡¨é»˜è®¤ç±»å‹                â”‚   â”‚
â”‚  â”‚ â€¢ è‡ªå®šä¹‰ä¸»é¢˜è‰²     â”‚ â€¢ å¿«æ·å…¥å£é…ç½®     â”‚ â€¢ éšç§æ¨¡å¼å¼€å…³                â”‚   â”‚
â”‚  â”‚ â€¢ å­—ä½“å¤§å°è®¾ç½®     â”‚ â€¢ åº•éƒ¨å¯¼èˆªé…ç½®     â”‚ â€¢ å°æ•°ä½æ•°è®¾ç½®                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ä¹ã€å›½é™…åŒ–é…ç½®                                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ è¯­è¨€è®¾ç½®           â”‚ è´§å¸è®¾ç½®           â”‚ æ ¼å¼è®¾ç½®                      â”‚   â”‚
â”‚  â”‚ â€¢ ç®€ä½“ä¸­æ–‡         â”‚ â€¢ äººæ°‘å¸ CNY       â”‚ â€¢ æ—¥æœŸæ ¼å¼                    â”‚   â”‚
â”‚  â”‚ â€¢ ç¹ä½“ä¸­æ–‡         â”‚ â€¢ ç¾å…ƒ USD         â”‚ â€¢ æ—¶é—´æ ¼å¼                    â”‚   â”‚
â”‚  â”‚ â€¢ è‹±è¯­             â”‚ â€¢ æ¬§å…ƒ EUR         â”‚ â€¢ æ•°å­—æ ¼å¼                    â”‚   â”‚
â”‚  â”‚ â€¢ æ—¥è¯­             â”‚ â€¢ è‹±é•‘ GBP         â”‚ â€¢ å‘¨èµ·å§‹æ—¥                    â”‚   â”‚
â”‚  â”‚ â€¢ éŸ©è¯­             â”‚ â€¢ æ—¥å…ƒ JPY         â”‚ â€¢ æœˆèµ·å§‹æ—¥                    â”‚   â”‚
â”‚  â”‚ â€¢ è·Ÿéšç³»ç»Ÿè¯­è¨€     â”‚ â€¢ éŸ©å…ƒ/æ¸¯å¸/å°å¸   â”‚                              â”‚   â”‚
â”‚  â”‚                   â”‚ â€¢ æ‰‹åŠ¨æ±‡ç‡è®¾ç½®     â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åã€AIä¸æ™ºèƒ½é…ç½®                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ AIè¯†åˆ«è®¾ç½®         â”‚ è¯­éŸ³è®¾ç½®           â”‚ æ™ºèƒ½åŠŸèƒ½                      â”‚   â”‚
â”‚  â”‚ â€¢ è¯­éŸ³è¯†åˆ«å¼€å…³     â”‚ â€¢ è¯­éŸ³è¯†åˆ«å¼•æ“     â”‚ â€¢ æ™ºèƒ½åˆ†ç±»å¼€å…³                â”‚   â”‚
â”‚  â”‚ â€¢ å›¾ç‰‡è¯†åˆ«å¼€å…³     â”‚ â€¢ è¯­éŸ³å”¤é†’è¯       â”‚ â€¢ é‡å¤æ£€æµ‹å¼€å…³                â”‚   â”‚
â”‚  â”‚ â€¢ é‚®ç®±è§£æå¼€å…³     â”‚ â€¢ è¯­éŸ³æ’­æŠ¥å¼€å…³     â”‚ â€¢ é‡å¤æ£€æµ‹æ—¶é—´çª—å£            â”‚   â”‚
â”‚  â”‚ â€¢ AIåˆ†ç±»å¼€å…³       â”‚ â€¢ è¯­éŸ³è¯­è¨€è®¾ç½®     â”‚ â€¢ é‡‘é¢å®¹å·®è®¾ç½®                â”‚   â”‚
â”‚  â”‚ â€¢ åˆ†ç±»ç¡®è®¤é˜ˆå€¼     â”‚ â€¢ è¯­éŸ³åé¦ˆæ–¹å¼     â”‚ â€¢ æ™ºèƒ½å»ºè®®å¼€å…³                â”‚   â”‚
â”‚  â”‚ â€¢ å›¾ç‰‡è¯†åˆ«è´¨é‡     â”‚                   â”‚ â€¢ æ¶ˆè´¹æ´å¯Ÿé€šçŸ¥                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åä¸€ã€æ•°æ®ä¸åŒæ­¥é…ç½®                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ æ•°æ®åŒæ­¥           â”‚ å¤‡ä»½è®¾ç½®           â”‚ å­˜å‚¨ç®¡ç†                      â”‚   â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨åŒæ­¥å¼€å…³     â”‚ â€¢ è‡ªåŠ¨å¤‡ä»½å¼€å…³     â”‚ â€¢ æ¥æºæ•°æ®ä¿ç•™                â”‚   â”‚
â”‚  â”‚ â€¢ åŒæ­¥é¢‘ç‡è®¾ç½®     â”‚ â€¢ å¤‡ä»½é¢‘ç‡è®¾ç½®     â”‚ â€¢ ç¼“å­˜è‡ªåŠ¨æ¸…ç†                â”‚   â”‚
â”‚  â”‚ â€¢ WiFiä¸‹åŒæ­¥       â”‚ â€¢ å¤‡ä»½ä¿ç•™æ•°é‡     â”‚ â€¢ æ•°æ®ä¿ç•™æœŸé™                â”‚   â”‚
â”‚  â”‚ â€¢ ç§å¯†æ•°æ®åŒæ­¥     â”‚ â€¢ äº‘ç«¯å¤‡ä»½å¼€å…³     â”‚ â€¢ å›¾ç‰‡è´¨é‡è®¾ç½®                â”‚   â”‚
â”‚  â”‚ â€¢ ç¦»çº¿æ¨¡å¼å¼€å…³     â”‚ â€¢ å¤‡ä»½åŠ å¯†å¼€å…³     â”‚ â€¢ éŸ³é¢‘ä¿ç•™è®¾ç½®                â”‚   â”‚
â”‚  â”‚ â€¢ å†²çªå¤„ç†ç­–ç•¥     â”‚                   â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åäºŒã€å®‰å…¨ä¸éšç§é…ç½®                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ åº”ç”¨å®‰å…¨           â”‚ éšç§è®¾ç½®           â”‚ è´¦æˆ·å®‰å…¨                      â”‚   â”‚
â”‚  â”‚ â€¢ åº”ç”¨é”å¼€å…³       â”‚ â€¢ éšç§æ¨¡å¼å¼€å…³     â”‚ â€¢ ä¿®æ”¹å¯†ç                     â”‚   â”‚
â”‚  â”‚ â€¢ æŒ‡çº¹è§£é”         â”‚ â€¢ é‡‘é¢æ¨¡ç³Šæ˜¾ç¤º     â”‚ â€¢ ç»‘å®šé‚®ç®±                    â”‚   â”‚
â”‚  â”‚ â€¢ é¢å®¹è§£é”         â”‚ â€¢ æˆªå›¾ä¿æŠ¤å¼€å…³     â”‚ â€¢ ç»‘å®šæ‰‹æœº                    â”‚   â”‚
â”‚  â”‚ â€¢ PINç è®¾ç½®        â”‚ â€¢ æ•æ„Ÿæ“ä½œç¡®è®¤     â”‚ â€¢ ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®š              â”‚   â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨é”å®šæ—¶é—´     â”‚ â€¢ æ•°æ®è„±æ•ç­‰çº§     â”‚ â€¢ ç™»å½•è®¾å¤‡ç®¡ç†                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         åä¸‰ã€ç½‘ç»œä¸æ€§èƒ½é…ç½®                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ç½‘ç»œè®¾ç½®           â”‚ æ€§èƒ½è®¾ç½®           â”‚ æ›´æ–°è®¾ç½®                      â”‚   â”‚
â”‚  â”‚ â€¢ è¿æ¥è¶…æ—¶æ—¶é—´     â”‚ â€¢ åŠ¨ç”»æ•ˆæœå¼€å…³     â”‚ â€¢ è‡ªåŠ¨æ£€æŸ¥æ›´æ–°                â”‚   â”‚
â”‚  â”‚ â€¢ æ¥æ”¶è¶…æ—¶æ—¶é—´     â”‚ â€¢ é¢„åŠ è½½æ•°æ®       â”‚ â€¢ WiFiä¸‹è‡ªåŠ¨æ›´æ–°              â”‚   â”‚
â”‚  â”‚ â€¢ é‡è¯•æ¬¡æ•°è®¾ç½®     â”‚ â€¢ åå°åˆ·æ–°å¼€å…³     â”‚ â€¢ æ›´æ–°æé†’æ–¹å¼                â”‚   â”‚
â”‚  â”‚ â€¢ ä»£ç†è®¾ç½®         â”‚ â€¢ ä½æ€§èƒ½æ¨¡å¼       â”‚ â€¢ å‚ä¸Betaæµ‹è¯•                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 18.3.2 å®Œæ•´é…ç½®é¡¹æ˜ å°„è¡¨

```dart
/// è¯­éŸ³é…ç½®æœåŠ¡ - å®Œæ•´ç‰ˆé…ç½®é¡¹æ˜ å°„
/// è¦†ç›–1.xç‰ˆæœ¬136é¡¹åŠŸèƒ½çš„æ‰€æœ‰å¯é…ç½®é¡¹
class VoiceConfigurationService {

  /// ========== å®Œæ•´é…ç½®é¡¹æ˜ å°„è¡¨ï¼ˆ200+é¡¹ï¼‰ ==========

  static const Map<String, ConfigurableItem> _configurableItems = {

    // ==================== ä¸€ã€é¢„ç®—é…ç½®ï¼ˆ20é¡¹ï¼‰ ====================
    'æ€»é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'total'),
    'æœˆåº¦é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'monthly_total'),
    'é¤é¥®é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'food'),
    'äº¤é€šé¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'transport'),
    'è´­ç‰©é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'shopping'),
    'å¨±ä¹é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'entertainment'),
    'å±…ä½é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'housing'),
    'åŒ»ç–—é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'medical'),
    'æ•™è‚²é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'education'),
    'é€šè®¯é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'communication'),
    'æœé¥°é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'clothing'),
    'ç¾å¦†é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'beauty'),
    'æ•°ç é¢„ç®—': ConfigurableItem(type: ConfigType.budget, key: 'digital'),
    'é¢„ç®—é¢„è­¦': ConfigurableItem(type: ConfigType.budgetAlert, key: 'threshold'),
    'é¢„ç®—å‘¨æœŸ': ConfigurableItem(type: ConfigType.budgetCycle, key: 'cycle'),
    'é¢„ç®—èµ·å§‹æ—¥': ConfigurableItem(type: ConfigType.budgetCycle, key: 'start_day'),
    'é¢„ç®—ç»“è½¬': ConfigurableItem(type: ConfigType.budgetSetting, key: 'rollover'),
    'é›¶åŸºé¢„ç®—': ConfigurableItem(type: ConfigType.budgetSetting, key: 'zero_based'),
    'è¶…æ”¯ç­–ç•¥': ConfigurableItem(type: ConfigType.budgetSetting, key: 'overspend_policy'),
    'é¢„ç®—æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'budget_alert'),

    // ==================== äºŒã€è´¦æˆ·é…ç½®ï¼ˆ15é¡¹ï¼‰ ====================
    'é»˜è®¤è´¦æˆ·': ConfigurableItem(type: ConfigType.account, key: 'default'),
    'ç°é‡‘è´¦æˆ·': ConfigurableItem(type: ConfigType.account, key: 'cash'),
    'é“¶è¡Œå¡': ConfigurableItem(type: ConfigType.account, key: 'bank_card'),
    'æ”¯ä»˜å®': ConfigurableItem(type: ConfigType.account, key: 'alipay'),
    'å¾®ä¿¡é’±åŒ…': ConfigurableItem(type: ConfigType.account, key: 'wechat'),
    'ä¿¡ç”¨å¡': ConfigurableItem(type: ConfigType.creditCard, key: 'credit_card'),
    'è´¦å•æ—¥': ConfigurableItem(type: ConfigType.creditCard, key: 'bill_day'),
    'è¿˜æ¬¾æ—¥': ConfigurableItem(type: ConfigType.creditCard, key: 'due_day'),
    'ä¿¡ç”¨é¢åº¦': ConfigurableItem(type: ConfigType.creditCard, key: 'credit_limit'),
    'å…æ¯æœŸ': ConfigurableItem(type: ConfigType.creditCard, key: 'grace_period'),
    'æŠ•èµ„è´¦æˆ·': ConfigurableItem(type: ConfigType.investment, key: 'investment'),
    'è´¦æˆ·ä½™é¢': ConfigurableItem(type: ConfigType.account, key: 'balance'),
    'è´¦æˆ·å›¾æ ‡': ConfigurableItem(type: ConfigType.account, key: 'icon'),
    'è´¦æˆ·é¢œè‰²': ConfigurableItem(type: ConfigType.account, key: 'color'),
    'è´¦æˆ·æ’åº': ConfigurableItem(type: ConfigType.account, key: 'order'),

    // ==================== ä¸‰ã€è´¦æœ¬ä¸æˆå‘˜é…ç½®ï¼ˆ12é¡¹ï¼‰ ====================
    'å½“å‰è´¦æœ¬': ConfigurableItem(type: ConfigType.ledger, key: 'current'),
    'é»˜è®¤è´¦æœ¬': ConfigurableItem(type: ConfigType.ledger, key: 'default'),
    'è´¦æœ¬åç§°': ConfigurableItem(type: ConfigType.ledger, key: 'name'),
    'è´¦æœ¬å…±äº«': ConfigurableItem(type: ConfigType.ledger, key: 'sharing'),
    'æˆå‘˜é‚€è¯·': ConfigurableItem(type: ConfigType.member, key: 'invite'),
    'æˆå‘˜æƒé™': ConfigurableItem(type: ConfigType.member, key: 'permission'),
    'æˆå‘˜é¢„ç®—': ConfigurableItem(type: ConfigType.member, key: 'budget'),
    'æˆå‘˜è§’è‰²': ConfigurableItem(type: ConfigType.member, key: 'role'),
    'æ¶ˆè´¹å®¡æ‰¹': ConfigurableItem(type: ConfigType.member, key: 'approval'),
    'æŸ¥çœ‹æƒé™': ConfigurableItem(type: ConfigType.permission, key: 'view'),
    'ç¼–è¾‘æƒé™': ConfigurableItem(type: ConfigType.permission, key: 'edit'),
    'ç®¡ç†æƒé™': ConfigurableItem(type: ConfigType.permission, key: 'admin'),

    // ==================== å››ã€åˆ†ç±»é…ç½®ï¼ˆ10é¡¹ï¼‰ ====================
    'æ”¯å‡ºåˆ†ç±»': ConfigurableItem(type: ConfigType.category, key: 'expense'),
    'æ”¶å…¥åˆ†ç±»': ConfigurableItem(type: ConfigType.category, key: 'income'),
    'åˆ†ç±»åç§°': ConfigurableItem(type: ConfigType.category, key: 'name'),
    'åˆ†ç±»å›¾æ ‡': ConfigurableItem(type: ConfigType.category, key: 'icon'),
    'åˆ†ç±»é¢œè‰²': ConfigurableItem(type: ConfigType.category, key: 'color'),
    'å­åˆ†ç±»': ConfigurableItem(type: ConfigType.subCategory, key: 'sub'),
    'åˆ†ç±»æ’åº': ConfigurableItem(type: ConfigType.category, key: 'order'),
    'æ ‡ç­¾': ConfigurableItem(type: ConfigType.tag, key: 'tag'),
    'æ ‡ç­¾é¢œè‰²': ConfigurableItem(type: ConfigType.tag, key: 'color'),
    'å¸¸ç”¨æ ‡ç­¾': ConfigurableItem(type: ConfigType.tag, key: 'frequent'),

    // ==================== äº”ã€ç›®æ ‡ä¸å€ºåŠ¡é…ç½®ï¼ˆ15é¡¹ï¼‰ ====================
    'å‚¨è“„ç›®æ ‡': ConfigurableItem(type: ConfigType.savingsGoal, key: 'goal'),
    'ç›®æ ‡é‡‘é¢': ConfigurableItem(type: ConfigType.savingsGoal, key: 'amount'),
    'ç›®æ ‡æ—¥æœŸ': ConfigurableItem(type: ConfigType.savingsGoal, key: 'date'),
    'è‡ªåŠ¨å­˜å…¥': ConfigurableItem(type: ConfigType.savingsGoal, key: 'auto_save'),
    'å¼€æ”¯ç›®æ ‡': ConfigurableItem(type: ConfigType.expenseTarget, key: 'target'),
    'æœˆåº¦é™é¢': ConfigurableItem(type: ConfigType.expenseTarget, key: 'limit'),
    'å€ºåŠ¡': ConfigurableItem(type: ConfigType.debt, key: 'debt'),
    'å€ºåŠ¡é‡‘é¢': ConfigurableItem(type: ConfigType.debt, key: 'amount'),
    'å€ºåŠ¡åˆ©ç‡': ConfigurableItem(type: ConfigType.debt, key: 'interest_rate'),
    'è¿˜æ¬¾ç­–ç•¥': ConfigurableItem(type: ConfigType.debt, key: 'strategy'),
    'è¿˜æ¬¾æé†’': ConfigurableItem(type: ConfigType.debt, key: 'reminder'),
    'å®šæœŸå­˜æ¬¾': ConfigurableItem(type: ConfigType.savings, key: 'fixed_deposit'),
    'å­˜æ¬¾æœŸé™': ConfigurableItem(type: ConfigType.savings, key: 'term'),
    'å­˜æ¬¾åˆ©ç‡': ConfigurableItem(type: ConfigType.savings, key: 'rate'),
    'åˆ°æœŸæé†’': ConfigurableItem(type: ConfigType.savings, key: 'maturity_reminder'),

    // ==================== å…­ã€æé†’é…ç½®ï¼ˆ18é¡¹ï¼‰ ====================
    'è®°è´¦æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'bookkeeping'),
    'æé†’æ—¶é—´': ConfigurableItem(type: ConfigType.reminder, key: 'time'),
    'æé†’é¢‘ç‡': ConfigurableItem(type: ConfigType.reminder, key: 'frequency'),
    'å‘¨æœ«æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'weekend'),
    'é¢„ç®—æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'budget'),
    'è¶…æ”¯æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'overspend'),
    'å‘¨é¢„ç®—æ€»ç»“': ConfigurableItem(type: ConfigType.reminder, key: 'weekly_summary'),
    'æœˆé¢„ç®—æ€»ç»“': ConfigurableItem(type: ConfigType.reminder, key: 'monthly_summary'),
    'è´¦å•æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'bill'),
    'è¿˜æ¬¾æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'repayment'),
    'è®¢é˜…æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'subscription'),
    'æé†’æå‰å¤©æ•°': ConfigurableItem(type: ConfigType.reminder, key: 'advance_days'),
    'å®šæ—¶è®°è´¦æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'recurring'),
    'ç›®æ ‡æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'goal'),
    'å­˜æ¬¾åˆ°æœŸæé†’': ConfigurableItem(type: ConfigType.reminder, key: 'deposit_maturity'),
    'åŒæ­¥æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'sync'),
    'å¤‡ä»½æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'backup'),
    'æ›´æ–°æé†’': ConfigurableItem(type: ConfigType.reminder, key: 'update'),

    // ==================== ä¸ƒã€æ¨¡æ¿ä¸å®šæ—¶é…ç½®ï¼ˆ10é¡¹ï¼‰ ====================
    'è®°è´¦æ¨¡æ¿': ConfigurableItem(type: ConfigType.template, key: 'template'),
    'æ¨¡æ¿åç§°': ConfigurableItem(type: ConfigType.template, key: 'name'),
    'é»˜è®¤æ¨¡æ¿': ConfigurableItem(type: ConfigType.template, key: 'default'),
    'æ¨¡æ¿æ’åº': ConfigurableItem(type: ConfigType.template, key: 'order'),
    'å®šæ—¶è®°è´¦': ConfigurableItem(type: ConfigType.recurring, key: 'recurring'),
    'æ‰§è¡Œé¢‘ç‡': ConfigurableItem(type: ConfigType.recurring, key: 'frequency'),
    'æ‰§è¡Œæ—¶é—´': ConfigurableItem(type: ConfigType.recurring, key: 'time'),
    'å®šæ—¶å¼€å…³': ConfigurableItem(type: ConfigType.recurring, key: 'enabled'),
    'å¿«æ·å…¥å£': ConfigurableItem(type: ConfigType.shortcut, key: 'shortcut'),
    'é¦–é¡µå¿«æ·æ–¹å¼': ConfigurableItem(type: ConfigType.shortcut, key: 'home'),

    // ==================== å…«ã€å¤–è§‚ä¸æ˜¾ç¤ºé…ç½®ï¼ˆ20é¡¹ï¼‰ ====================
    'ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'theme'),
    'æ·±è‰²æ¨¡å¼': ConfigurableItem(type: ConfigType.appearance, key: 'dark_mode'),
    'æµ…è‰²æ¨¡å¼': ConfigurableItem(type: ConfigType.appearance, key: 'light_mode'),
    'è·Ÿéšç³»ç»Ÿ': ConfigurableItem(type: ConfigType.appearance, key: 'system'),
    'ä¸»é¢˜è‰²': ConfigurableItem(type: ConfigType.appearance, key: 'color_theme'),
    'è“è‰²ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'blue'),
    'ç»¿è‰²ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'green'),
    'çº¢è‰²ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'red'),
    'ç´«è‰²ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'purple'),
    'æ©™è‰²ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'orange'),
    'è‡ªå®šä¹‰ä¸»é¢˜': ConfigurableItem(type: ConfigType.appearance, key: 'custom'),
    'å­—ä½“å¤§å°': ConfigurableItem(type: ConfigType.appearance, key: 'font_size'),
    'é¦–é¡µå¡ç‰‡': ConfigurableItem(type: ConfigType.homeLayout, key: 'cards'),
    'å¡ç‰‡æ’åº': ConfigurableItem(type: ConfigType.homeLayout, key: 'card_order'),
    'ç»Ÿè®¡å›¾è¡¨': ConfigurableItem(type: ConfigType.homeLayout, key: 'chart_type'),
    'å¿«æ·å…¥å£æ˜¾ç¤º': ConfigurableItem(type: ConfigType.homeLayout, key: 'shortcuts'),
    'é‡‘é¢æ˜¾ç¤º': ConfigurableItem(type: ConfigType.display, key: 'amount_format'),
    'å°æ•°ä½æ•°': ConfigurableItem(type: ConfigType.display, key: 'decimal_places'),
    'é»˜è®¤æ—¶é—´èŒƒå›´': ConfigurableItem(type: ConfigType.display, key: 'default_range'),
    'éšç§æ¨¡å¼': ConfigurableItem(type: ConfigType.display, key: 'privacy_mode'),

    // ==================== ä¹ã€å›½é™…åŒ–é…ç½®ï¼ˆ15é¡¹ï¼‰ ====================
    'è¯­è¨€': ConfigurableItem(type: ConfigType.i18n, key: 'language'),
    'ç®€ä½“ä¸­æ–‡': ConfigurableItem(type: ConfigType.i18n, key: 'zh_CN'),
    'ç¹ä½“ä¸­æ–‡': ConfigurableItem(type: ConfigType.i18n, key: 'zh_TW'),
    'è‹±è¯­': ConfigurableItem(type: ConfigType.i18n, key: 'en_US'),
    'æ—¥è¯­': ConfigurableItem(type: ConfigType.i18n, key: 'ja_JP'),
    'éŸ©è¯­': ConfigurableItem(type: ConfigType.i18n, key: 'ko_KR'),
    'è·Ÿéšç³»ç»Ÿè¯­è¨€': ConfigurableItem(type: ConfigType.i18n, key: 'system_locale'),
    'è´§å¸': ConfigurableItem(type: ConfigType.i18n, key: 'currency'),
    'äººæ°‘å¸': ConfigurableItem(type: ConfigType.i18n, key: 'CNY'),
    'ç¾å…ƒ': ConfigurableItem(type: ConfigType.i18n, key: 'USD'),
    'æ¬§å…ƒ': ConfigurableItem(type: ConfigType.i18n, key: 'EUR'),
    'æ—¥å…ƒ': ConfigurableItem(type: ConfigType.i18n, key: 'JPY'),
    'æ‰‹åŠ¨æ±‡ç‡': ConfigurableItem(type: ConfigType.i18n, key: 'manual_rate'),
    'æ—¥æœŸæ ¼å¼': ConfigurableItem(type: ConfigType.i18n, key: 'date_format'),
    'å‘¨èµ·å§‹æ—¥': ConfigurableItem(type: ConfigType.i18n, key: 'week_start'),

    // ==================== åã€AIä¸æ™ºèƒ½é…ç½®ï¼ˆ18é¡¹ï¼‰ ====================
    'è¯­éŸ³è¯†åˆ«': ConfigurableItem(type: ConfigType.ai, key: 'voice_recognition'),
    'å›¾ç‰‡è¯†åˆ«': ConfigurableItem(type: ConfigType.ai, key: 'image_recognition'),
    'é‚®ç®±è§£æ': ConfigurableItem(type: ConfigType.ai, key: 'email_parsing'),
    'AIåˆ†ç±»': ConfigurableItem(type: ConfigType.ai, key: 'ai_categorization'),
    'æ™ºèƒ½åˆ†ç±»': ConfigurableItem(type: ConfigType.ai, key: 'smart_category'),
    'åˆ†ç±»ç¡®è®¤é˜ˆå€¼': ConfigurableItem(type: ConfigType.ai, key: 'category_threshold'),
    'é‡å¤æ£€æµ‹': ConfigurableItem(type: ConfigType.ai, key: 'duplicate_detection'),
    'é‡å¤æ£€æµ‹æ—¶é—´': ConfigurableItem(type: ConfigType.ai, key: 'duplicate_time_window'),
    'é‡‘é¢å®¹å·®': ConfigurableItem(type: ConfigType.ai, key: 'amount_tolerance'),
    'è¯­éŸ³å”¤é†’': ConfigurableItem(type: ConfigType.ai, key: 'voice_wakeup'),
    'è¯­éŸ³æ’­æŠ¥': ConfigurableItem(type: ConfigType.ai, key: 'voice_broadcast'),
    'è¯­éŸ³è¯­è¨€': ConfigurableItem(type: ConfigType.ai, key: 'voice_language'),
    'æ™ºèƒ½å»ºè®®': ConfigurableItem(type: ConfigType.ai, key: 'smart_suggestion'),
    'æ¶ˆè´¹æ´å¯Ÿ': ConfigurableItem(type: ConfigType.ai, key: 'spending_insight'),
    'å›¾ç‰‡è´¨é‡': ConfigurableItem(type: ConfigType.ai, key: 'image_quality'),
    'è¯†åˆ«æ¨¡å‹': ConfigurableItem(type: ConfigType.ai, key: 'recognition_model'),
    'è¯­éŸ³æ¨¡å‹': ConfigurableItem(type: ConfigType.ai, key: 'voice_model'),
    'æ–‡æœ¬æ¨¡å‹': ConfigurableItem(type: ConfigType.ai, key: 'text_model'),

    // ==================== åä¸€ã€æ•°æ®ä¸åŒæ­¥é…ç½®ï¼ˆ18é¡¹ï¼‰ ====================
    'æ•°æ®åŒæ­¥': ConfigurableItem(type: ConfigType.sync, key: 'sync'),
    'è‡ªåŠ¨åŒæ­¥': ConfigurableItem(type: ConfigType.sync, key: 'auto_sync'),
    'åŒæ­¥é¢‘ç‡': ConfigurableItem(type: ConfigType.sync, key: 'frequency'),
    'WiFiåŒæ­¥': ConfigurableItem(type: ConfigType.sync, key: 'wifi_only'),
    'ç§å¯†æ•°æ®åŒæ­¥': ConfigurableItem(type: ConfigType.sync, key: 'private_data'),
    'ç¦»çº¿æ¨¡å¼': ConfigurableItem(type: ConfigType.sync, key: 'offline_mode'),
    'å†²çªå¤„ç†': ConfigurableItem(type: ConfigType.sync, key: 'conflict_resolution'),
    'è‡ªåŠ¨å¤‡ä»½': ConfigurableItem(type: ConfigType.backup, key: 'auto_backup'),
    'å¤‡ä»½é¢‘ç‡': ConfigurableItem(type: ConfigType.backup, key: 'frequency'),
    'å¤‡ä»½ä¿ç•™æ•°é‡': ConfigurableItem(type: ConfigType.backup, key: 'retention'),
    'äº‘ç«¯å¤‡ä»½': ConfigurableItem(type: ConfigType.backup, key: 'cloud'),
    'å¤‡ä»½åŠ å¯†': ConfigurableItem(type: ConfigType.backup, key: 'encryption'),
    'æ¥æºæ•°æ®ä¿ç•™': ConfigurableItem(type: ConfigType.storage, key: 'source_data'),
    'ç¼“å­˜æ¸…ç†': ConfigurableItem(type: ConfigType.storage, key: 'cache'),
    'æ•°æ®ä¿ç•™æœŸé™': ConfigurableItem(type: ConfigType.storage, key: 'retention_period'),
    'å›¾ç‰‡ä¿ç•™': ConfigurableItem(type: ConfigType.storage, key: 'image_retention'),
    'éŸ³é¢‘ä¿ç•™': ConfigurableItem(type: ConfigType.storage, key: 'audio_retention'),
    'å¯¼å‡ºæ ¼å¼': ConfigurableItem(type: ConfigType.export, key: 'format'),

    // ==================== åäºŒã€å®‰å…¨ä¸éšç§é…ç½®ï¼ˆ15é¡¹ï¼‰ ====================
    'åº”ç”¨é”': ConfigurableItem(type: ConfigType.security, key: 'app_lock'),
    'æŒ‡çº¹è§£é”': ConfigurableItem(type: ConfigType.security, key: 'fingerprint'),
    'é¢å®¹è§£é”': ConfigurableItem(type: ConfigType.security, key: 'face_id'),
    'PINç ': ConfigurableItem(type: ConfigType.security, key: 'pin'),
    'è‡ªåŠ¨é”å®š': ConfigurableItem(type: ConfigType.security, key: 'auto_lock'),
    'é”å®šæ—¶é—´': ConfigurableItem(type: ConfigType.security, key: 'lock_timeout'),
    'éšç§æ¨¡å¼': ConfigurableItem(type: ConfigType.privacy, key: 'privacy_mode'),
    'é‡‘é¢æ¨¡ç³Š': ConfigurableItem(type: ConfigType.privacy, key: 'blur_amount'),
    'æˆªå›¾ä¿æŠ¤': ConfigurableItem(type: ConfigType.privacy, key: 'screenshot_protection'),
    'æ•æ„Ÿæ“ä½œç¡®è®¤': ConfigurableItem(type: ConfigType.privacy, key: 'sensitive_confirm'),
    'ä¿®æ”¹å¯†ç ': ConfigurableItem(type: ConfigType.account_security, key: 'password'),
    'ç»‘å®šé‚®ç®±': ConfigurableItem(type: ConfigType.account_security, key: 'email'),
    'ç»‘å®šæ‰‹æœº': ConfigurableItem(type: ConfigType.account_security, key: 'phone'),
    'ç¬¬ä¸‰æ–¹ç»‘å®š': ConfigurableItem(type: ConfigType.account_security, key: 'oauth'),
    'ç™»å½•è®¾å¤‡': ConfigurableItem(type: ConfigType.account_security, key: 'devices'),

    // ==================== åä¸‰ã€ç½‘ç»œä¸æ€§èƒ½é…ç½®ï¼ˆ12é¡¹ï¼‰ ====================
    'è¿æ¥è¶…æ—¶': ConfigurableItem(type: ConfigType.network, key: 'connect_timeout'),
    'æ¥æ”¶è¶…æ—¶': ConfigurableItem(type: ConfigType.network, key: 'receive_timeout'),
    'é‡è¯•æ¬¡æ•°': ConfigurableItem(type: ConfigType.network, key: 'max_retries'),
    'ä»£ç†è®¾ç½®': ConfigurableItem(type: ConfigType.network, key: 'proxy'),
    'åŠ¨ç”»æ•ˆæœ': ConfigurableItem(type: ConfigType.performance, key: 'animation'),
    'é¢„åŠ è½½': ConfigurableItem(type: ConfigType.performance, key: 'preload'),
    'åå°åˆ·æ–°': ConfigurableItem(type: ConfigType.performance, key: 'background_refresh'),
    'ä½æ€§èƒ½æ¨¡å¼': ConfigurableItem(type: ConfigType.performance, key: 'low_performance'),
    'è‡ªåŠ¨æ›´æ–°': ConfigurableItem(type: ConfigType.update, key: 'auto_check'),
    'WiFiæ›´æ–°': ConfigurableItem(type: ConfigType.update, key: 'wifi_only'),
    'æ›´æ–°æé†’': ConfigurableItem(type: ConfigType.update, key: 'notification'),
    'Betaæµ‹è¯•': ConfigurableItem(type: ConfigType.update, key: 'beta'),

    // ==================== åå››ã€å•†æˆ·ç»‘å®šé…ç½®ï¼ˆ5é¡¹ï¼‰ ====================
    'å•†æˆ·åˆ†ç±»ç»‘å®š': ConfigurableItem(type: ConfigType.merchant, key: 'category'),
    'å•†æˆ·è´¦æˆ·ç»‘å®š': ConfigurableItem(type: ConfigType.merchant, key: 'account'),
    'å•†æˆ·åˆ«å': ConfigurableItem(type: ConfigType.merchant, key: 'alias'),
    'å•†æˆ·å›¾æ ‡': ConfigurableItem(type: ConfigType.merchant, key: 'icon'),
    'æ™ºèƒ½å•†æˆ·è¯†åˆ«': ConfigurableItem(type: ConfigType.merchant, key: 'auto_recognize'),
  };

  // é…ç½®é¡¹æ€»è®¡ï¼š200+é¡¹
}
```

#### 18.3.3 è¯­éŸ³é…ç½®ç¤ºä¾‹åº“ï¼ˆæ‰©å±•ç‰ˆï¼‰

| é…ç½®ç±»åˆ« | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ | ç³»ç»Ÿå“åº” |
|---------|-------------|---------|
| **é¢„ç®—è®¾ç½®** | "æŠŠé¤é¥®é¢„ç®—æ”¹æˆ2000" | å°†é¤é¥®é¢„ç®—ä»1500å…ƒä¿®æ”¹ä¸º2000å…ƒï¼Œç¡®è®¤å—ï¼Ÿ |
| **é¢„ç®—è®¾ç½®** | "è®¾ç½®æœ¬æœˆæ€»é¢„ç®—8000" | å·²å°†æœ¬æœˆæ€»é¢„ç®—è®¾ä¸º8000å…ƒ |
| **é¢„ç®—è®¾ç½®** | "é¢„ç®—ç”¨åˆ°80%æ—¶æé†’æˆ‘" | å·²è®¾ç½®é¢„ç®—é¢„è­¦é˜ˆå€¼ä¸º80% |
| **é¢„ç®—è®¾ç½®** | "å¼€å¯é¢„ç®—ç»“è½¬" | å·²å¼€å¯é¢„ç®—ç»“è½¬åŠŸèƒ½ï¼Œæœ¬æœˆå‰©ä½™é¢„ç®—å°†ç»“è½¬åˆ°ä¸‹æœˆ |
| **è´¦æˆ·ç®¡ç†** | "æŠŠå¾®ä¿¡è®¾ä¸ºé»˜è®¤è´¦æˆ·" | å·²å°†å¾®ä¿¡è®¾ä¸ºé»˜è®¤æ”¯ä»˜è´¦æˆ· |
| **è´¦æˆ·ç®¡ç†** | "æ·»åŠ ä¸€å¼ æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡" | å·²åˆ›å»ºä¿¡ç”¨å¡è´¦æˆ·"æ‹›å•†é“¶è¡Œ"ï¼Œè¯·è®¾ç½®è´¦å•æ—¥å’Œè¿˜æ¬¾æ—¥ |
| **è´¦æˆ·ç®¡ç†** | "ä¿¡ç”¨å¡è´¦å•æ—¥æ”¹æˆ5å·" | å·²å°†ä¿¡ç”¨å¡è´¦å•æ—¥è®¾ä¸ºæ¯æœˆ5æ—¥ |
| **è´¦æˆ·ç®¡ç†** | "æ ¡æ­£æ”¯ä»˜å®ä½™é¢ä¸º1500" | å·²å°†æ”¯ä»˜å®ä½™é¢æ ¡æ­£ä¸º1500å…ƒ |
| **è´¦æœ¬ç®¡ç†** | "åˆ›å»ºä¸€ä¸ªå®¶åº­è´¦æœ¬" | å·²åˆ›å»ºè´¦æœ¬"å®¶åº­"ï¼Œæ˜¯å¦è®¾ä¸ºå½“å‰è´¦æœ¬ï¼Ÿ |
| **è´¦æœ¬ç®¡ç†** | "åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬" | å·²åˆ‡æ¢åˆ°"å®¶åº­"è´¦æœ¬ |
| **æˆå‘˜ç®¡ç†** | "é‚€è¯·è€å©†åŠ å…¥è´¦æœ¬" | å·²ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼Œæœ‰æ•ˆæœŸ7å¤© |
| **åˆ†ç±»ç®¡ç†** | "æ·»åŠ ä¸€ä¸ªå® ç‰©åˆ†ç±»" | å·²æ·»åŠ æ”¯å‡ºåˆ†ç±»"å® ç‰©" |
| **åˆ†ç±»ç®¡ç†** | "ç»™é¤é¥®æ·»åŠ å¤–å–å­åˆ†ç±»" | å·²åœ¨é¤é¥®åˆ†ç±»ä¸‹æ·»åŠ å­åˆ†ç±»"å¤–å–" |
| **å‚¨è“„ç›®æ ‡** | "åˆ›å»ºä¸€ä¸ªä¹°è½¦ç›®æ ‡ï¼Œ15ä¸‡ï¼Œæ˜å¹´åº•" | å·²åˆ›å»ºå‚¨è“„ç›®æ ‡"ä¹°è½¦"ï¼Œç›®æ ‡é‡‘é¢15ä¸‡ï¼Œæˆªæ­¢æ—¥æœŸ2027å¹´12æœˆ |
| **å‚¨è“„ç›®æ ‡** | "æ¯æœˆè‡ªåŠ¨å­˜å…¥500åˆ°æ—…æ¸¸åŸºé‡‘" | å·²è®¾ç½®æ¯æœˆè‡ªåŠ¨å‘"æ—…æ¸¸"ç›®æ ‡å­˜å…¥500å…ƒ |
| **å€ºåŠ¡ç®¡ç†** | "æ·»åŠ ä¸€ç¬”æˆ¿è´·ï¼Œ120ä¸‡ï¼Œåˆ©ç‡4.2%" | å·²æ·»åŠ å€ºåŠ¡"æˆ¿è´·"ï¼Œé‡‘é¢120ä¸‡ï¼Œå¹´åˆ©ç‡4.2% |
| **æé†’è®¾ç½®** | "æ¯å¤©æ™šä¸Š8ç‚¹æé†’æˆ‘è®°è´¦" | å·²è®¾ç½®æ¯æ—¥è®°è´¦æé†’ï¼Œæ—¶é—´ï¼š20:00 |
| **æé†’è®¾ç½®** | "ä¿¡ç”¨å¡è¿˜æ¬¾æ—¥æå‰3å¤©æé†’" | å·²è®¾ç½®ä¿¡ç”¨å¡è¿˜æ¬¾æé†’ï¼Œæå‰3å¤©é€šçŸ¥ |
| **æ¨¡æ¿è®¾ç½®** | "æŠŠåˆšæ‰é‚£ç¬”ä¿å­˜ä¸ºæ¨¡æ¿" | å·²å°†"é¤é¥®-35å…ƒ"ä¿å­˜ä¸ºå¿«æ·æ¨¡æ¿ |
| **å®šæ—¶è®°è´¦** | "æ¯æœˆ15å·è‡ªåŠ¨è®°ä¸€ç¬”æˆ¿ç§Ÿ3000" | å·²åˆ›å»ºå®šæ—¶è®°è´¦ï¼šæ¯æœˆ15æ—¥ï¼Œæˆ¿ç§Ÿ3000å…ƒ |
| **ä¸»é¢˜è®¾ç½®** | "åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼" | å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼ |
| **ä¸»é¢˜è®¾ç½®** | "æŠŠä¸»é¢˜è‰²æ”¹æˆç»¿è‰²" | å·²å°†ä¸»é¢˜è‰²åˆ‡æ¢ä¸ºç»¿è‰² |
| **è¯­è¨€è®¾ç½®** | "åˆ‡æ¢åˆ°è‹±æ–‡" | å·²å°†è¯­è¨€åˆ‡æ¢ä¸ºEnglish |
| **è´§å¸è®¾ç½®** | "é»˜è®¤è´§å¸æ”¹æˆç¾å…ƒ" | å·²å°†é»˜è®¤è´§å¸ä»CNYåˆ‡æ¢ä¸ºUSD |
| **AIè®¾ç½®** | "å…³é—­æ™ºèƒ½åˆ†ç±»" | å·²å…³é—­æ™ºèƒ½åˆ†ç±»åŠŸèƒ½ï¼Œå°†ä½¿ç”¨æ‰‹åŠ¨åˆ†ç±» |
| **AIè®¾ç½®** | "é‡å¤æ£€æµ‹æ—¶é—´æ”¹æˆ30åˆ†é’Ÿ" | å·²å°†é‡å¤æ£€æµ‹æ—¶é—´çª—å£è®¾ä¸º30åˆ†é’Ÿ |
| **åŒæ­¥è®¾ç½®** | "å¼€å¯è‡ªåŠ¨åŒæ­¥" | å·²å¼€å¯è‡ªåŠ¨åŒæ­¥ï¼Œæ•°æ®å°†å®æ—¶åŒæ­¥åˆ°äº‘ç«¯ |
| **åŒæ­¥è®¾ç½®** | "åªåœ¨WiFiä¸‹åŒæ­¥" | å·²è®¾ç½®ä»…åœ¨WiFiç¯å¢ƒä¸‹è¿›è¡Œæ•°æ®åŒæ­¥ |
| **å¤‡ä»½è®¾ç½®** | "è®¾ç½®æ¯å¤©è‡ªåŠ¨å¤‡ä»½" | å·²è®¾ç½®æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼Œæ—¶é—´ï¼šå‡Œæ™¨3:00 |
| **å®‰å…¨è®¾ç½®** | "å¼€å¯åº”ç”¨é”" | å·²å¼€å¯åº”ç”¨é”ï¼Œè¯·è®¾ç½®è§£é”æ–¹å¼ |
| **å®‰å…¨è®¾ç½®** | "å¼€å¯æŒ‡çº¹è§£é”" | å·²å¼€å¯æŒ‡çº¹è§£é” |
| **éšç§è®¾ç½®** | "å¼€å¯éšç§æ¨¡å¼" | å·²å¼€å¯éšç§æ¨¡å¼ï¼Œé‡‘é¢å°†æ˜¾ç¤ºä¸º*** |
| **ç½‘ç»œè®¾ç½®** | "è¿æ¥è¶…æ—¶æ”¹æˆ60ç§’" | å·²å°†è¿æ¥è¶…æ—¶æ—¶é—´è®¾ä¸º60ç§’ |
| **æ›´æ–°è®¾ç½®** | "å¼€å¯è‡ªåŠ¨æ›´æ–°æ£€æŸ¥" | å·²å¼€å¯è‡ªåŠ¨æ›´æ–°æ£€æŸ¥ |

### 18.4 æ™ºèƒ½è¯­éŸ³å¯¼èˆªæ¨¡å—

è¯­éŸ³å¯¼èˆªæ¨¡å—æ”¯æŒä¸‰å±‚èƒ½åŠ›ï¼šé¡µé¢å¯¼èˆªã€åŠŸèƒ½å…¥å£ã€ç›´æ¥æ“ä½œã€‚åŸºäº2.0ç‰ˆæœ¬110ä¸ªåŸå‹é¡µé¢åˆ†æï¼Œ47ä¸ªé¡µé¢ï¼ˆ43%ï¼‰é«˜åº¦é€‚é…è¯­éŸ³å¯¼èˆªã€‚

#### 18.4.1 å¯¼èˆªä¸æ“ä½œèƒ½åŠ›å…¨æ™¯å›¾ï¼ˆå®Œæ•´ç‰ˆï¼‰

è¦†ç›–1.xç‰ˆæœ¬å…¨éƒ¨48ä¸ªé¡µé¢åŠæ‰€æœ‰å¯æ‰§è¡Œæ“ä½œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯­éŸ³å¯¼èˆªä¸æ“ä½œèƒ½åŠ›å…¨æ™¯å›¾ï¼ˆå®Œæ•´ç‰ˆï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ç¬¬ä¸€å±‚ï¼šé¡µé¢å¯¼èˆªï¼ˆ48ä¸ªé¡µé¢å…¨è¦†ç›–ï¼‰                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€ä¸»å¯¼èˆªã€‘                                                              â”‚   â”‚
â”‚  â”‚   é¦–é¡µ    è®¾ç½®                                                          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€è®°è´¦ç›¸å…³ã€‘                                                            â”‚   â”‚
â”‚  â”‚   æ–°å¢äº¤æ˜“   å¿«é€Ÿè®°è´¦   è¯­éŸ³è®°è´¦   å›¾ç‰‡è®°è´¦   å¤šç¬”ç¡®è®¤                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€è´¦æœ¬ä¸æˆå‘˜ã€‘                                                          â”‚   â”‚
â”‚  â”‚   è´¦æœ¬ç®¡ç†   æˆå‘˜ç®¡ç†   åŠ å…¥é‚€è¯·   æˆå‘˜é¢„ç®—   æˆå‘˜å¯¹æ¯”                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€è´¦æˆ·ç®¡ç†ã€‘                                                            â”‚   â”‚
â”‚  â”‚   è´¦æˆ·ç®¡ç†   ä¿¡ç”¨å¡    æŠ•èµ„è´¦æˆ·                                          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€åˆ†ç±»ä¸æ ‡ç­¾ã€‘                                                          â”‚   â”‚
â”‚  â”‚   åˆ†ç±»ç®¡ç†   æ ‡ç­¾ç»Ÿè®¡                                                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€é¢„ç®—ä¸ç›®æ ‡ã€‘                                                          â”‚   â”‚
â”‚  â”‚   é¢„ç®—ç®¡ç†   å‚¨è“„ç›®æ ‡   å¼€æ”¯ç›®æ ‡   å€ºåŠ¡ç®¡ç†   å€ºåŠ¡æ¨¡æ‹Ÿå™¨                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€æé†’ä¸å®šæ—¶ã€‘                                                          â”‚   â”‚
â”‚  â”‚   è´¦å•æé†’   æ¨¡æ¿ç®¡ç†   å®šæ—¶è®°è´¦                                         â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€ç»Ÿè®¡æŠ¥è¡¨ã€‘                                                            â”‚   â”‚
â”‚  â”‚   èµ„äº§æ€»è§ˆ   å¹´åº¦æŠ¥å‘Š   è‡ªå®šä¹‰æŠ¥è¡¨   å¤šè´§å¸æŠ¥è¡¨                          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€æ•°æ®ç®¡ç†ã€‘                                                            â”‚   â”‚
â”‚  â”‚   æ•°æ®å¤‡ä»½   æ•°æ®å¯¼å‡º   æ•°æ®å¯¼å…¥   æ™ºèƒ½å¯¼å…¥   æŠ¥é”€ç®¡ç†                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€ç³»ç»Ÿè®¾ç½®ã€‘                                                            â”‚   â”‚
â”‚  â”‚   ç³»ç»Ÿè®¾ç½®   è¯­è¨€è®¾ç½®   è´§å¸è®¾ç½®   æ¥æºæ•°æ®   è‡ªå®šä¹‰ä¸»é¢˜                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€ç”¨æˆ·ç›¸å…³ã€‘                                                            â”‚   â”‚
â”‚  â”‚   ç™»å½•     æ³¨å†Œ     æ‰¾å›å¯†ç    å…³äºæˆ‘ä»¬   å¸®åŠ©     ç”¨æˆ·åè®®              â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ç¬¬äºŒå±‚ï¼šåŠŸèƒ½å…¥å£ï¼ˆå¸¦ä¸Šä¸‹æ–‡é¢„å¡«ï¼‰                         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€è®°è´¦å…¥å£ã€‘                                                            â”‚   â”‚
â”‚  â”‚   è®°ä¸€ç¬”æ”¯å‡º   è®°ä¸€ç¬”æ”¶å…¥   è®°ä¸€ç¬”è½¬è´¦   è¯­éŸ³è®°è´¦   æ‹ç…§è®°è´¦             â”‚   â”‚
â”‚  â”‚   æ‰«ç è®°è´¦    æ‰¹é‡è®°è´¦    æŒ‰æ¨¡æ¿è®°è´¦                                     â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€åˆ›å»ºæ“ä½œã€‘                                                            â”‚   â”‚
â”‚  â”‚   åˆ›å»ºè´¦æœ¬   åˆ›å»ºè´¦æˆ·   åˆ›å»ºä¿¡ç”¨å¡   åˆ›å»ºåˆ†ç±»   åˆ›å»ºå­åˆ†ç±»               â”‚   â”‚
â”‚  â”‚   åˆ›å»ºæ ‡ç­¾   åˆ›å»ºé¢„ç®—   åˆ›å»ºå‚¨è“„ç›®æ ‡  åˆ›å»ºå¼€æ”¯ç›®æ ‡  åˆ›å»ºå€ºåŠ¡             â”‚   â”‚
â”‚  â”‚   åˆ›å»ºæ¨¡æ¿   åˆ›å»ºå®šæ—¶è®°è´¦  åˆ›å»ºè´¦å•æé†’                                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€ç®¡ç†æ“ä½œã€‘                                                            â”‚   â”‚
â”‚  â”‚   é‚€è¯·æˆå‘˜   è°ƒæ•´é¢„ç®—   è°ƒæ•´ç›®æ ‡   è®¾ç½®æé†’                              â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€æ•°æ®æ“ä½œã€‘                                                            â”‚   â”‚
â”‚  â”‚   å¯¼å‡ºæ•°æ®   å¯¼å…¥æ•°æ®   ç”ŸæˆæŠ¥å‘Š   å¤‡ä»½æ•°æ®   æ¢å¤æ•°æ®                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ç¬¬ä¸‰å±‚ï¼šç›´æ¥æ“ä½œï¼ˆæ— éœ€è¿›å…¥é¡µé¢ï¼‰                         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€è®°è´¦æ“ä½œã€‘              ã€è´¦æˆ·æ“ä½œã€‘              ã€é¢„ç®—æ“ä½œã€‘         â”‚   â”‚
â”‚  â”‚  â€¢ åˆ é™¤æœ€åä¸€ç¬”            â€¢ åˆ‡æ¢é»˜è®¤è´¦æˆ·            â€¢ è°ƒæ•´XXé¢„ç®—        â”‚   â”‚
â”‚  â”‚  â€¢ æ’¤é”€ä¸Šæ¬¡æ“ä½œ            â€¢ æ ¡æ­£è´¦æˆ·ä½™é¢            â€¢ é‡ç½®æœ¬æœˆé¢„ç®—      â”‚   â”‚
â”‚  â”‚  â€¢ ä¿®æ”¹åˆšæ‰é‚£ç¬”            â€¢ æŸ¥çœ‹è´¦æˆ·ä½™é¢            â€¢ é¢„ç®—ç»“è½¬          â”‚   â”‚
â”‚  â”‚  â€¢ å¤åˆ¶ä¸ºæ¨¡æ¿                                                           â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€åˆ‡æ¢æ“ä½œã€‘              ã€å¼€å…³æ“ä½œã€‘              ã€ä¸»é¢˜æ“ä½œã€‘         â”‚   â”‚
â”‚  â”‚  â€¢ åˆ‡æ¢è´¦æœ¬               â€¢ å¼€å¯/å…³é—­è‡ªåŠ¨åŒæ­¥        â€¢ åˆ‡æ¢æ·±è‰²æ¨¡å¼      â”‚   â”‚
â”‚  â”‚  â€¢ åˆ‡æ¢è¯­è¨€               â€¢ å¼€å¯/å…³é—­éšç§æ¨¡å¼        â€¢ åˆ‡æ¢æµ…è‰²æ¨¡å¼      â”‚   â”‚
â”‚  â”‚  â€¢ åˆ‡æ¢è´§å¸               â€¢ å¼€å¯/å…³é—­åº”ç”¨é”          â€¢ åˆ‡æ¢XXä¸»é¢˜è‰²      â”‚   â”‚
â”‚  â”‚                          â€¢ å¼€å¯/å…³é—­è¯­éŸ³è¯†åˆ«                            â”‚   â”‚
â”‚  â”‚                          â€¢ å¼€å¯/å…³é—­å›¾ç‰‡è¯†åˆ«                            â”‚   â”‚
â”‚  â”‚                          â€¢ å¼€å¯/å…³é—­æ™ºèƒ½åˆ†ç±»                            â”‚   â”‚
â”‚  â”‚                          â€¢ å¼€å¯/å…³é—­è®°è´¦æé†’                            â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€æ•°æ®æ“ä½œã€‘              ã€åŒæ­¥æ“ä½œã€‘              ã€ä¹ æƒ¯æ“ä½œã€‘         â”‚   â”‚
â”‚  â”‚  â€¢ ç«‹å³å¤‡ä»½               â€¢ ç«‹å³åŒæ­¥                â€¢ ä»Šæ—¥æ‰“å¡          â”‚   â”‚
â”‚  â”‚  â€¢ å¯¼å‡ºæœ¬æœˆæ•°æ®           â€¢ å¼ºåˆ¶åˆ·æ–°                â€¢ æŸ¥çœ‹æ‰“å¡è®°å½•      â”‚   â”‚
â”‚  â”‚  â€¢ å¯¼å‡ºæœ¬å¹´æ•°æ®           â€¢ æ¸…é™¤ç¼“å­˜                                    â”‚   â”‚
â”‚  â”‚  â€¢ æ¸…ç©ºå›æ”¶ç«™                                                           â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ã€å¿«æ·æ“ä½œã€‘              ã€åˆ†äº«æ“ä½œã€‘              ã€ç³»ç»Ÿæ“ä½œã€‘         â”‚   â”‚
â”‚  â”‚  â€¢ æ‰“å¼€ç›¸æœº               â€¢ åˆ†äº«æœˆåº¦æŠ¥å‘Š            â€¢ æ£€æŸ¥æ›´æ–°          â”‚   â”‚
â”‚  â”‚  â€¢ æ‰“å¼€æ‰«ç                â€¢ åˆ†äº«å¹´åº¦æŠ¥å‘Š            â€¢ æäº¤åé¦ˆ          â”‚   â”‚
â”‚  â”‚  â€¢ åˆ·æ–°æ•°æ®               â€¢ åˆ†äº«è´¦å•æˆªå›¾            â€¢ è”ç³»å®¢æœ          â”‚   â”‚
â”‚  â”‚  â€¢ è¿”å›é¦–é¡µ               â€¢ é‚€è¯·å¥½å‹                â€¢ é€€å‡ºç™»å½•          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 18.4.2 å®Œæ•´é¡µé¢è·¯ç”±æ˜ å°„è¡¨

```dart
/// è¯­éŸ³å¯¼èˆªæœåŠ¡ - å®Œæ•´ç‰ˆé¡µé¢è·¯ç”±æ˜ å°„
/// è¦†ç›–2.0ç‰ˆæœ¬å…¨éƒ¨119ä¸ªé¡µé¢
class VoiceNavigationService {

  // ==================== å®Œæ•´é¡µé¢è·¯ç”±æ˜ å°„ï¼ˆ119ä¸ªé¡µé¢ï¼‰ ====================

  static const Map<String, NavigationTarget> _navigationTargets = {

    // ========== ä¸»å¯¼èˆªï¼ˆ2ä¸ªï¼‰ ==========
    'é¦–é¡µ': NavigationTarget(route: '/home', displayName: 'é¦–é¡µ'),
    'ä¸»é¡µ': NavigationTarget(route: '/home', displayName: 'é¦–é¡µ'),
    'è®¾ç½®': NavigationTarget(route: '/settings', displayName: 'è®¾ç½®'),
    'è®¾ç½®é¡µ': NavigationTarget(route: '/settings', displayName: 'è®¾ç½®'),
    'ç³»ç»Ÿè®¾ç½®': NavigationTarget(route: '/system-settings', displayName: 'ç³»ç»Ÿè®¾ç½®'),

    // ========== è®°è´¦é¡µé¢ï¼ˆ5ä¸ªï¼‰ ==========
    'è®°è´¦': NavigationTarget(route: '/add-transaction', displayName: 'æ–°å¢äº¤æ˜“'),
    'æ–°å¢äº¤æ˜“': NavigationTarget(route: '/add-transaction', displayName: 'æ–°å¢äº¤æ˜“'),
    'è®°ä¸€ç¬”': NavigationTarget(route: '/add-transaction', displayName: 'æ–°å¢äº¤æ˜“'),
    'å¿«é€Ÿè®°è´¦': NavigationTarget(route: '/quick-entry', displayName: 'å¿«é€Ÿè®°è´¦'),
    'è¯­éŸ³è®°è´¦': NavigationTarget(route: '/voice-recognition', displayName: 'è¯­éŸ³è®°è´¦'),
    'å›¾ç‰‡è®°è´¦': NavigationTarget(route: '/image-recognition', displayName: 'å›¾ç‰‡è¯†åˆ«è®°è´¦'),
    'æ‹ç…§è®°è´¦': NavigationTarget(route: '/image-recognition', displayName: 'å›¾ç‰‡è¯†åˆ«è®°è´¦'),
    'å¤šç¬”ç¡®è®¤': NavigationTarget(route: '/multi-transaction-confirm', displayName: 'å¤šç¬”äº¤æ˜“ç¡®è®¤'),

    // ========== è´¦æœ¬ä¸æˆå‘˜ï¼ˆ5ä¸ªï¼‰ ==========
    'è´¦æœ¬': NavigationTarget(route: '/ledger-management', displayName: 'è´¦æœ¬ç®¡ç†'),
    'è´¦æœ¬ç®¡ç†': NavigationTarget(route: '/ledger-management', displayName: 'è´¦æœ¬ç®¡ç†'),
    'æˆå‘˜': NavigationTarget(route: '/member-management', displayName: 'æˆå‘˜ç®¡ç†'),
    'æˆå‘˜ç®¡ç†': NavigationTarget(route: '/member-management', displayName: 'æˆå‘˜ç®¡ç†'),
    'é‚€è¯·': NavigationTarget(route: '/join-invite', displayName: 'åŠ å…¥/é‚€è¯·'),
    'åŠ å…¥è´¦æœ¬': NavigationTarget(route: '/join-invite', displayName: 'åŠ å…¥/é‚€è¯·'),
    'æˆå‘˜é¢„ç®—': NavigationTarget(route: '/member-budget', displayName: 'æˆå‘˜é¢„ç®—'),
    'æˆå‘˜å¯¹æ¯”': NavigationTarget(route: '/member-comparison', displayName: 'æˆå‘˜å¯¹æ¯”'),

    // ========== è´¦æˆ·ç®¡ç†ï¼ˆ3ä¸ªï¼‰ ==========
    'è´¦æˆ·': NavigationTarget(route: '/account-management', displayName: 'è´¦æˆ·ç®¡ç†'),
    'è´¦æˆ·ç®¡ç†': NavigationTarget(route: '/account-management', displayName: 'è´¦æˆ·ç®¡ç†'),
    'ä¿¡ç”¨å¡': NavigationTarget(route: '/credit-card', displayName: 'ä¿¡ç”¨å¡'),
    'ä¿¡ç”¨å¡ç®¡ç†': NavigationTarget(route: '/credit-card', displayName: 'ä¿¡ç”¨å¡'),
    'æŠ•èµ„': NavigationTarget(route: '/investment', displayName: 'æŠ•èµ„è´¦æˆ·'),
    'æŠ•èµ„è´¦æˆ·': NavigationTarget(route: '/investment', displayName: 'æŠ•èµ„è´¦æˆ·'),

    // ========== åˆ†ç±»ä¸æ ‡ç­¾ï¼ˆ2ä¸ªï¼‰ ==========
    'åˆ†ç±»': NavigationTarget(route: '/category-management', displayName: 'åˆ†ç±»ç®¡ç†'),
    'åˆ†ç±»ç®¡ç†': NavigationTarget(route: '/category-management', displayName: 'åˆ†ç±»ç®¡ç†'),
    'æ ‡ç­¾': NavigationTarget(route: '/tag-statistics', displayName: 'æ ‡ç­¾ç»Ÿè®¡'),
    'æ ‡ç­¾ç»Ÿè®¡': NavigationTarget(route: '/tag-statistics', displayName: 'æ ‡ç­¾ç»Ÿè®¡'),

    // ========== é¢„ç®—ä¸ç›®æ ‡ï¼ˆ5ä¸ªï¼‰ ==========
    'é¢„ç®—': NavigationTarget(route: '/budget-management', displayName: 'é¢„ç®—ç®¡ç†'),
    'é¢„ç®—ç®¡ç†': NavigationTarget(route: '/budget-management', displayName: 'é¢„ç®—ç®¡ç†'),
    'å‚¨è“„ç›®æ ‡': NavigationTarget(route: '/savings-goal', displayName: 'å‚¨è“„ç›®æ ‡'),
    'æ”’é’±': NavigationTarget(route: '/savings-goal', displayName: 'å‚¨è“„ç›®æ ‡'),
    'å¼€æ”¯ç›®æ ‡': NavigationTarget(route: '/expense-target', displayName: 'å¼€æ”¯ç›®æ ‡'),
    'å€ºåŠ¡': NavigationTarget(route: '/debt-management', displayName: 'å€ºåŠ¡ç®¡ç†'),
    'å€ºåŠ¡ç®¡ç†': NavigationTarget(route: '/debt-management', displayName: 'å€ºåŠ¡ç®¡ç†'),
    'è¿˜å€º': NavigationTarget(route: '/debt-management', displayName: 'å€ºåŠ¡ç®¡ç†'),
    'å€ºåŠ¡æ¨¡æ‹Ÿ': NavigationTarget(route: '/debt-simulator', displayName: 'å€ºåŠ¡æ¨¡æ‹Ÿå™¨'),
    'è¿˜æ¬¾æ¨¡æ‹Ÿ': NavigationTarget(route: '/debt-simulator', displayName: 'å€ºåŠ¡æ¨¡æ‹Ÿå™¨'),

    // ========== æé†’ä¸å®šæ—¶ï¼ˆ3ä¸ªï¼‰ ==========
    'è´¦å•æé†’': NavigationTarget(route: '/bill-reminder', displayName: 'è´¦å•æé†’'),
    'æé†’': NavigationTarget(route: '/bill-reminder', displayName: 'è´¦å•æé†’'),
    'æ¨¡æ¿': NavigationTarget(route: '/template-management', displayName: 'æ¨¡æ¿ç®¡ç†'),
    'æ¨¡æ¿ç®¡ç†': NavigationTarget(route: '/template-management', displayName: 'æ¨¡æ¿ç®¡ç†'),
    'å®šæ—¶è®°è´¦': NavigationTarget(route: '/recurring-management', displayName: 'å®šæ—¶è®°è´¦'),
    'å®šæ—¶': NavigationTarget(route: '/recurring-management', displayName: 'å®šæ—¶è®°è´¦'),
    'å‘¨æœŸè®°è´¦': NavigationTarget(route: '/recurring-management', displayName: 'å®šæ—¶è®°è´¦'),

    // ========== ç»Ÿè®¡æŠ¥è¡¨ï¼ˆ4ä¸ªï¼‰ ==========
    'èµ„äº§': NavigationTarget(route: '/asset-overview', displayName: 'èµ„äº§æ€»è§ˆ'),
    'èµ„äº§æ€»è§ˆ': NavigationTarget(route: '/asset-overview', displayName: 'èµ„äº§æ€»è§ˆ'),
    'å‡€èµ„äº§': NavigationTarget(route: '/asset-overview', displayName: 'èµ„äº§æ€»è§ˆ'),
    'å¹´åº¦æŠ¥å‘Š': NavigationTarget(route: '/annual-report', displayName: 'å¹´åº¦æŠ¥å‘Š'),
    'å¹´æŠ¥': NavigationTarget(route: '/annual-report', displayName: 'å¹´åº¦æŠ¥å‘Š'),
    'è‡ªå®šä¹‰æŠ¥è¡¨': NavigationTarget(route: '/custom-report', displayName: 'è‡ªå®šä¹‰æŠ¥è¡¨'),
    'æŠ¥è¡¨': NavigationTarget(route: '/custom-report', displayName: 'è‡ªå®šä¹‰æŠ¥è¡¨'),
    'å¤šè´§å¸æŠ¥è¡¨': NavigationTarget(route: '/multi-currency-report', displayName: 'å¤šè´§å¸æŠ¥è¡¨'),
    'æ±‡ç‡æŠ¥è¡¨': NavigationTarget(route: '/multi-currency-report', displayName: 'å¤šè´§å¸æŠ¥è¡¨'),

    // ========== æ•°æ®ç®¡ç†ï¼ˆ5ä¸ªï¼‰ ==========
    'å¤‡ä»½': NavigationTarget(route: '/backup', displayName: 'æ•°æ®å¤‡ä»½'),
    'æ•°æ®å¤‡ä»½': NavigationTarget(route: '/backup', displayName: 'æ•°æ®å¤‡ä»½'),
    'å¯¼å‡º': NavigationTarget(route: '/export', displayName: 'æ•°æ®å¯¼å‡º'),
    'æ•°æ®å¯¼å‡º': NavigationTarget(route: '/export', displayName: 'æ•°æ®å¯¼å‡º'),
    'å¯¼å…¥': NavigationTarget(route: '/import', displayName: 'æ•°æ®å¯¼å…¥'),
    'æ•°æ®å¯¼å…¥': NavigationTarget(route: '/import', displayName: 'æ•°æ®å¯¼å…¥'),
    'æ™ºèƒ½å¯¼å…¥': NavigationTarget(route: '/smart-import', displayName: 'æ™ºèƒ½è´¦å•å¯¼å…¥'),
    'è´¦å•å¯¼å…¥': NavigationTarget(route: '/smart-import', displayName: 'æ™ºèƒ½è´¦å•å¯¼å…¥'),
    'æŠ¥é”€': NavigationTarget(route: '/reimbursement', displayName: 'æŠ¥é”€ç®¡ç†'),
    'æŠ¥é”€ç®¡ç†': NavigationTarget(route: '/reimbursement', displayName: 'æŠ¥é”€ç®¡ç†'),

    // ========== ç³»ç»Ÿè®¾ç½®ï¼ˆ5ä¸ªï¼‰ ==========
    'è¯­è¨€': NavigationTarget(route: '/language-settings', displayName: 'è¯­è¨€è®¾ç½®'),
    'è¯­è¨€è®¾ç½®': NavigationTarget(route: '/language-settings', displayName: 'è¯­è¨€è®¾ç½®'),
    'è´§å¸': NavigationTarget(route: '/currency-settings', displayName: 'è´§å¸è®¾ç½®'),
    'è´§å¸è®¾ç½®': NavigationTarget(route: '/currency-settings', displayName: 'è´§å¸è®¾ç½®'),
    'æ¥æºæ•°æ®': NavigationTarget(route: '/source-data-settings', displayName: 'æ¥æºæ•°æ®ç®¡ç†'),
    'æ¥æºç®¡ç†': NavigationTarget(route: '/source-data-settings', displayName: 'æ¥æºæ•°æ®ç®¡ç†'),
    'è‡ªå®šä¹‰ä¸»é¢˜': NavigationTarget(route: '/custom-theme', displayName: 'è‡ªå®šä¹‰ä¸»é¢˜'),
    'ä¸»é¢˜è®¾ç½®': NavigationTarget(route: '/custom-theme', displayName: 'è‡ªå®šä¹‰ä¸»é¢˜'),


    // ========== 2.0æ–°å¢ - é’±é¾„åˆ†æï¼ˆ8ä¸ªï¼‰ ==========
    'é’±é¾„': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'é’±é¾„è¯¦æƒ…': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'èµ„é‡‘å¹´é¾„': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'é’±é¾„è¶‹åŠ¿': NavigationTarget(route: '/money-age/trend', displayName: 'é’±é¾„è¶‹åŠ¿'),
    'é’±é¾„å†å²': NavigationTarget(route: '/money-age/trend', displayName: 'é’±é¾„è¶‹åŠ¿'),
    'FIFOèµ„æºæ± ': NavigationTarget(route: '/money-age/fifo', displayName: 'FIFOèµ„æºæ± '),
    'èµ„é‡‘æ± ': NavigationTarget(route: '/money-age/fifo', displayName: 'FIFOèµ„æºæ± '),

    // ========== 2.0æ–°å¢ - å°é‡‘åº“ï¼ˆ9ä¸ªï¼‰ ==========
    'å°é‡‘åº“': NavigationTarget(route: '/vault', displayName: 'å°é‡‘åº“æ¦‚è§ˆ'),
    'å°é‡‘åº“æ¦‚è§ˆ': NavigationTarget(route: '/vault', displayName: 'å°é‡‘åº“æ¦‚è§ˆ'),
    'å°é‡‘åº“è¯¦æƒ…': NavigationTarget(route: '/vault/detail', displayName: 'å°é‡‘åº“è¯¦æƒ…'),
    'èµ„é‡‘åˆ†é…': NavigationTarget(route: '/vault/allocate', displayName: 'èµ„é‡‘åˆ†é…'),
    'åˆ›å»ºå°é‡‘åº“': NavigationTarget(route: '/vault/create', displayName: 'åˆ›å»ºå°é‡‘åº“'),
    'é›¶åŸºé¢„ç®—': NavigationTarget(route: '/vault/zero-based', displayName: 'é›¶åŸºé¢„ç®—åˆ†é…'),

    // ========== 2.0æ–°å¢ - ä¹ æƒ¯åŸ¹å…»ï¼ˆ7ä¸ªï¼‰ ==========
    'è´¢åŠ¡å¥åº·': NavigationTarget(route: '/financial-health', displayName: 'è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜'),
    'å¥åº·åº¦': NavigationTarget(route: '/financial-health', displayName: 'è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜'),
    'è®¢é˜…åˆ†æ': NavigationTarget(route: '/subscription-waste', displayName: 'è®¢é˜…æµªè´¹è¯†åˆ«'),
    'æ‹¿é“å› å­': NavigationTarget(route: '/latte-factor', displayName: 'æ‹¿é“å› å­åˆ†æ'),
    'å°é¢æ¶ˆè´¹': NavigationTarget(route: '/latte-factor', displayName: 'æ‹¿é“å› å­åˆ†æ'),
    'åº”æ€¥é‡‘': NavigationTarget(route: '/emergency-fund', displayName: 'åº”æ€¥é‡‘ç›®æ ‡'),
    'æ‰“å¡': NavigationTarget(route: '/check-in', displayName: 'è¿ç»­æ‰“å¡'),
    'è®°è´¦æ‰“å¡': NavigationTarget(route: '/check-in', displayName: 'è¿ç»­æ‰“å¡'),

    // ========== 2.0æ–°å¢ - è´¦å•æé†’ï¼ˆ6ä¸ªï¼‰ ==========
    'å®šæœŸè´¦å•': NavigationTarget(route: '/bill-reminder', displayName: 'è´¦å•æé†’åˆ—è¡¨'),
    'ä¿¡ç”¨å¡æé†’': NavigationTarget(route: '/bill-reminder/credit-card', displayName: 'ä¿¡ç”¨å¡è¿˜æ¬¾æé†’'),
    'è´¦å•æ—¥å†': NavigationTarget(route: '/bill-reminder/calendar', displayName: 'è´¦å•æ—¥å†è§†å›¾'),
    'æ·»åŠ è´¦å•æé†’': NavigationTarget(route: '/bill-reminder/add', displayName: 'æ·»åŠ å®šæœŸè´¦å•'),

    // ========== 2.0æ–°å¢ - AIæ™ºèƒ½ä¸­å¿ƒï¼ˆ10ä¸ªï¼‰ ==========
    'AIä¸­å¿ƒ': NavigationTarget(route: '/ai-center', displayName: 'AIæ™ºèƒ½ä¸­å¿ƒ'),
    'æ™ºèƒ½ä¸­å¿ƒ': NavigationTarget(route: '/ai-center', displayName: 'AIæ™ºèƒ½ä¸­å¿ƒ'),
    'æ™ºèƒ½åˆ†ç±»': NavigationTarget(route: '/ai-center/category', displayName: 'æ™ºèƒ½åˆ†ç±»ä¸­å¿ƒ'),
    'åˆ†ç±»å­¦ä¹ ': NavigationTarget(route: '/ai-center/category-learning', displayName: 'åˆ†ç±»åé¦ˆå­¦ä¹ '),
    'æ¶ˆè´¹é¢„æµ‹': NavigationTarget(route: '/ai-center/prediction', displayName: 'æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹'),
    'è¶‹åŠ¿é¢„æµ‹': NavigationTarget(route: '/ai-center/prediction', displayName: 'æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹'),
    'å¼‚å¸¸æ£€æµ‹': NavigationTarget(route: '/ai-center/anomaly', displayName: 'å¼‚å¸¸æ£€æµ‹è®¾ç½®'),
    'å¼‚å¸¸äº¤æ˜“': NavigationTarget(route: '/ai-center/anomaly-detail', displayName: 'å¼‚å¸¸äº¤æ˜“è¯¦æƒ…'),
    'æ™ºèƒ½æœç´¢': NavigationTarget(route: '/ai-center/smart-search', displayName: 'è‡ªç„¶è¯­è¨€æœç´¢'),
    'å¯¹è¯åŠ©æ‰‹': NavigationTarget(route: '/ai-center/dialog', displayName: 'å¯¹è¯åŠ©æ‰‹è®¾ç½®'),
    'è¯­éŸ³é…ç½®': NavigationTarget(route: '/ai-center/voice-config', displayName: 'è¯­éŸ³é…ç½®ä¸­å¿ƒ'),
    'AIæˆæœ¬': NavigationTarget(route: '/ai-center/cost', displayName: 'AIæˆæœ¬ç›‘æ§'),
    'å­¦ä¹ æŠ¥å‘Š': NavigationTarget(route: '/ai-center/learning-report', displayName: 'æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š'),

    // ========== 2.0æ–°å¢ - ç³»ç»Ÿç›‘æ§ï¼ˆ6ä¸ªï¼‰ ==========
    'åº”ç”¨çŠ¶æ€': NavigationTarget(route: '/monitor/health', displayName: 'åº”ç”¨å¥åº·çŠ¶æ€'),
    'æ€§èƒ½ç›‘æ§': NavigationTarget(route: '/monitor/performance', displayName: 'æ€§èƒ½ç›‘æ§'),
    'ç³»ç»Ÿæ—¥å¿—': NavigationTarget(route: '/monitor/logs', displayName: 'ç³»ç»Ÿæ—¥å¿—'),
    'å‘Šè­¦å†å²': NavigationTarget(route: '/monitor/alerts', displayName: 'å‘Šè­¦å†å²'),
    'AIç›‘æ§': NavigationTarget(route: '/monitor/ai', displayName: 'AIæœåŠ¡ç›‘æ§'),
    'è¯Šæ–­æŠ¥å‘Š': NavigationTarget(route: '/monitor/diagnosis', displayName: 'è¯Šæ–­æŠ¥å‘Š'),

    // ========== 2.0æ–°å¢ - ä½ç½®æœåŠ¡ï¼ˆ6ä¸ªï¼‰ ==========
    'ä½ç½®è®¾ç½®': NavigationTarget(route: '/settings/location', displayName: 'ä½ç½®æœåŠ¡è®¾ç½®'),
    'å¸¸é©»åœ°ç‚¹': NavigationTarget(route: '/settings/location/frequent', displayName: 'å¸¸é©»åœ°ç‚¹è®¾ç½®'),
    'åœ°ç†å›´æ ': NavigationTarget(route: '/settings/location/geofence', displayName: 'åœ°ç†å›´æ ç®¡ç†'),
    'ä½ç½®åˆ†æ': NavigationTarget(route: '/settings/location/analysis', displayName: 'ä½ç½®åˆ†ææŠ¥å‘Š'),
    'å¼‚åœ°æ¶ˆè´¹': NavigationTarget(route: '/settings/location/travel', displayName: 'å¼‚åœ°æ¶ˆè´¹è®°å½•'),

    // ========== 2.0æ–°å¢ - å®‰å…¨éšç§ï¼ˆ6ä¸ªï¼‰ ==========
    'éšç§è®¾ç½®': NavigationTarget(route: '/settings/privacy', displayName: 'éšç§æ¨¡å¼è®¾ç½®'),
    'åº”ç”¨é”': NavigationTarget(route: '/settings/app-lock', displayName: 'åº”ç”¨é”è®¾ç½®'),
    'PINç ': NavigationTarget(route: '/settings/pin', displayName: 'PINç è®¾ç½®'),
    'å®‰å…¨æ—¥å¿—': NavigationTarget(route: '/settings/audit-log', displayName: 'å®‰å…¨å®¡è®¡æ—¥å¿—'),
    'æ•°æ®ç®¡ç†': NavigationTarget(route: '/settings/data', displayName: 'æ•°æ®ç®¡ç†'),


    // ========== 2.0æ–°å¢ - é’±é¾„åˆ†æï¼ˆ8ä¸ªï¼‰ ==========
    'é’±é¾„': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'é’±é¾„è¯¦æƒ…': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'èµ„é‡‘å¹´é¾„': NavigationTarget(route: '/money-age', displayName: 'é’±é¾„è¯¦æƒ…'),
    'é’±é¾„è¶‹åŠ¿': NavigationTarget(route: '/money-age/trend', displayName: 'é’±é¾„è¶‹åŠ¿'),
    'é’±é¾„å†å²': NavigationTarget(route: '/money-age/trend', displayName: 'é’±é¾„è¶‹åŠ¿'),
    'FIFOèµ„æºæ± ': NavigationTarget(route: '/money-age/fifo', displayName: 'FIFOèµ„æºæ± '),
    'èµ„é‡‘æ± ': NavigationTarget(route: '/money-age/fifo', displayName: 'FIFOèµ„æºæ± '),

    // ========== 2.0æ–°å¢ - å°é‡‘åº“ï¼ˆ9ä¸ªï¼‰ ==========
    'å°é‡‘åº“': NavigationTarget(route: '/vault', displayName: 'å°é‡‘åº“æ¦‚è§ˆ'),
    'å°é‡‘åº“æ¦‚è§ˆ': NavigationTarget(route: '/vault', displayName: 'å°é‡‘åº“æ¦‚è§ˆ'),
    'å°é‡‘åº“è¯¦æƒ…': NavigationTarget(route: '/vault/detail', displayName: 'å°é‡‘åº“è¯¦æƒ…'),
    'èµ„é‡‘åˆ†é…': NavigationTarget(route: '/vault/allocate', displayName: 'èµ„é‡‘åˆ†é…'),
    'åˆ›å»ºå°é‡‘åº“': NavigationTarget(route: '/vault/create', displayName: 'åˆ›å»ºå°é‡‘åº“'),
    'é›¶åŸºé¢„ç®—': NavigationTarget(route: '/vault/zero-based', displayName: 'é›¶åŸºé¢„ç®—åˆ†é…'),

    // ========== 2.0æ–°å¢ - ä¹ æƒ¯åŸ¹å…»ï¼ˆ7ä¸ªï¼‰ ==========
    'è´¢åŠ¡å¥åº·': NavigationTarget(route: '/financial-health', displayName: 'è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜'),
    'å¥åº·åº¦': NavigationTarget(route: '/financial-health', displayName: 'è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜'),
    'è®¢é˜…åˆ†æ': NavigationTarget(route: '/subscription-waste', displayName: 'è®¢é˜…æµªè´¹è¯†åˆ«'),
    'æ‹¿é“å› å­': NavigationTarget(route: '/latte-factor', displayName: 'æ‹¿é“å› å­åˆ†æ'),
    'å°é¢æ¶ˆè´¹': NavigationTarget(route: '/latte-factor', displayName: 'æ‹¿é“å› å­åˆ†æ'),
    'åº”æ€¥é‡‘': NavigationTarget(route: '/emergency-fund', displayName: 'åº”æ€¥é‡‘ç›®æ ‡'),
    'æ‰“å¡': NavigationTarget(route: '/check-in', displayName: 'è¿ç»­æ‰“å¡'),
    'è®°è´¦æ‰“å¡': NavigationTarget(route: '/check-in', displayName: 'è¿ç»­æ‰“å¡'),

    // ========== 2.0æ–°å¢ - è´¦å•æé†’ï¼ˆ6ä¸ªï¼‰ ==========
    'å®šæœŸè´¦å•': NavigationTarget(route: '/bill-reminder', displayName: 'è´¦å•æé†’åˆ—è¡¨'),
    'ä¿¡ç”¨å¡æé†’': NavigationTarget(route: '/bill-reminder/credit-card', displayName: 'ä¿¡ç”¨å¡è¿˜æ¬¾æé†’'),
    'è´¦å•æ—¥å†': NavigationTarget(route: '/bill-reminder/calendar', displayName: 'è´¦å•æ—¥å†è§†å›¾'),
    'æ·»åŠ è´¦å•æé†’': NavigationTarget(route: '/bill-reminder/add', displayName: 'æ·»åŠ å®šæœŸè´¦å•'),

    // ========== 2.0æ–°å¢ - AIæ™ºèƒ½ä¸­å¿ƒï¼ˆ10ä¸ªï¼‰ ==========
    'AIä¸­å¿ƒ': NavigationTarget(route: '/ai-center', displayName: 'AIæ™ºèƒ½ä¸­å¿ƒ'),
    'æ™ºèƒ½ä¸­å¿ƒ': NavigationTarget(route: '/ai-center', displayName: 'AIæ™ºèƒ½ä¸­å¿ƒ'),
    'æ™ºèƒ½åˆ†ç±»': NavigationTarget(route: '/ai-center/category', displayName: 'æ™ºèƒ½åˆ†ç±»ä¸­å¿ƒ'),
    'åˆ†ç±»å­¦ä¹ ': NavigationTarget(route: '/ai-center/category-learning', displayName: 'åˆ†ç±»åé¦ˆå­¦ä¹ '),
    'æ¶ˆè´¹é¢„æµ‹': NavigationTarget(route: '/ai-center/prediction', displayName: 'æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹'),
    'è¶‹åŠ¿é¢„æµ‹': NavigationTarget(route: '/ai-center/prediction', displayName: 'æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹'),
    'å¼‚å¸¸æ£€æµ‹': NavigationTarget(route: '/ai-center/anomaly', displayName: 'å¼‚å¸¸æ£€æµ‹è®¾ç½®'),
    'å¼‚å¸¸äº¤æ˜“': NavigationTarget(route: '/ai-center/anomaly-detail', displayName: 'å¼‚å¸¸äº¤æ˜“è¯¦æƒ…'),
    'æ™ºèƒ½æœç´¢': NavigationTarget(route: '/ai-center/smart-search', displayName: 'è‡ªç„¶è¯­è¨€æœç´¢'),
    'å¯¹è¯åŠ©æ‰‹': NavigationTarget(route: '/ai-center/dialog', displayName: 'å¯¹è¯åŠ©æ‰‹è®¾ç½®'),
    'è¯­éŸ³é…ç½®': NavigationTarget(route: '/ai-center/voice-config', displayName: 'è¯­éŸ³é…ç½®ä¸­å¿ƒ'),
    'AIæˆæœ¬': NavigationTarget(route: '/ai-center/cost', displayName: 'AIæˆæœ¬ç›‘æ§'),
    'å­¦ä¹ æŠ¥å‘Š': NavigationTarget(route: '/ai-center/learning-report', displayName: 'æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š'),

    // ========== 2.0æ–°å¢ - ç³»ç»Ÿç›‘æ§ï¼ˆ6ä¸ªï¼‰ ==========
    'åº”ç”¨çŠ¶æ€': NavigationTarget(route: '/monitor/health', displayName: 'åº”ç”¨å¥åº·çŠ¶æ€'),
    'æ€§èƒ½ç›‘æ§': NavigationTarget(route: '/monitor/performance', displayName: 'æ€§èƒ½ç›‘æ§'),
    'ç³»ç»Ÿæ—¥å¿—': NavigationTarget(route: '/monitor/logs', displayName: 'ç³»ç»Ÿæ—¥å¿—'),
    'å‘Šè­¦å†å²': NavigationTarget(route: '/monitor/alerts', displayName: 'å‘Šè­¦å†å²'),
    'AIç›‘æ§': NavigationTarget(route: '/monitor/ai', displayName: 'AIæœåŠ¡ç›‘æ§'),
    'è¯Šæ–­æŠ¥å‘Š': NavigationTarget(route: '/monitor/diagnosis', displayName: 'è¯Šæ–­æŠ¥å‘Š'),

    // ========== 2.0æ–°å¢ - ä½ç½®æœåŠ¡ï¼ˆ6ä¸ªï¼‰ ==========
    'ä½ç½®è®¾ç½®': NavigationTarget(route: '/settings/location', displayName: 'ä½ç½®æœåŠ¡è®¾ç½®'),
    'å¸¸é©»åœ°ç‚¹': NavigationTarget(route: '/settings/location/frequent', displayName: 'å¸¸é©»åœ°ç‚¹è®¾ç½®'),
    'åœ°ç†å›´æ ': NavigationTarget(route: '/settings/location/geofence', displayName: 'åœ°ç†å›´æ ç®¡ç†'),
    'ä½ç½®åˆ†æ': NavigationTarget(route: '/settings/location/analysis', displayName: 'ä½ç½®åˆ†ææŠ¥å‘Š'),
    'å¼‚åœ°æ¶ˆè´¹': NavigationTarget(route: '/settings/location/travel', displayName: 'å¼‚åœ°æ¶ˆè´¹è®°å½•'),

    // ========== 2.0æ–°å¢ - å®‰å…¨éšç§ï¼ˆ6ä¸ªï¼‰ ==========
    'éšç§è®¾ç½®': NavigationTarget(route: '/settings/privacy', displayName: 'éšç§æ¨¡å¼è®¾ç½®'),
    'åº”ç”¨é”': NavigationTarget(route: '/settings/app-lock', displayName: 'åº”ç”¨é”è®¾ç½®'),
    'PINç ': NavigationTarget(route: '/settings/pin', displayName: 'PINç è®¾ç½®'),
    'å®‰å…¨æ—¥å¿—': NavigationTarget(route: '/settings/audit-log', displayName: 'å®‰å…¨å®¡è®¡æ—¥å¿—'),
    'æ•°æ®ç®¡ç†': NavigationTarget(route: '/settings/data', displayName: 'æ•°æ®ç®¡ç†'),

    // ========== ç”¨æˆ·ç›¸å…³ï¼ˆ6ä¸ªï¼‰ ==========
    'ç™»å½•': NavigationTarget(route: '/login', displayName: 'ç™»å½•'),
    'æ³¨å†Œ': NavigationTarget(route: '/register', displayName: 'æ³¨å†Œ'),
    'æ‰¾å›å¯†ç ': NavigationTarget(route: '/forgot-password', displayName: 'æ‰¾å›å¯†ç '),
    'å¿˜è®°å¯†ç ': NavigationTarget(route: '/forgot-password', displayName: 'æ‰¾å›å¯†ç '),
    'å…³äº': NavigationTarget(route: '/about', displayName: 'å…³äºæˆ‘ä»¬'),
    'å…³äºæˆ‘ä»¬': NavigationTarget(route: '/about', displayName: 'å…³äºæˆ‘ä»¬'),
    'å¸®åŠ©': NavigationTarget(route: '/help', displayName: 'å¸®åŠ©'),
    'å¸®åŠ©ä¸­å¿ƒ': NavigationTarget(route: '/help', displayName: 'å¸®åŠ©'),
    'åè®®': NavigationTarget(route: '/agreement', displayName: 'ç”¨æˆ·åè®®'),
    'ç”¨æˆ·åè®®': NavigationTarget(route: '/agreement', displayName: 'ç”¨æˆ·åè®®'),

    // ========== äº¤æ˜“åˆ—è¡¨ç›¸å…³ ==========
    'è´¦å•': NavigationTarget(route: '/transactions', displayName: 'è´¦å•åˆ—è¡¨'),
    'æµæ°´': NavigationTarget(route: '/transactions', displayName: 'è´¦å•åˆ—è¡¨'),
    'æ˜ç»†': NavigationTarget(route: '/transactions', displayName: 'è´¦å•åˆ—è¡¨'),
    'äº¤æ˜“è®°å½•': NavigationTarget(route: '/transactions', displayName: 'è´¦å•åˆ—è¡¨'),
    'æ”¶æ”¯': NavigationTarget(route: '/transactions', displayName: 'è´¦å•åˆ—è¡¨'),

    // ========== ç»Ÿè®¡åˆ†æ ==========
    'ç»Ÿè®¡': NavigationTarget(route: '/statistics', displayName: 'ç»Ÿè®¡åˆ†æ'),
    'åˆ†æ': NavigationTarget(route: '/statistics', displayName: 'ç»Ÿè®¡åˆ†æ'),
    'å›¾è¡¨': NavigationTarget(route: '/statistics', displayName: 'ç»Ÿè®¡åˆ†æ'),
    'è¶‹åŠ¿': NavigationTarget(route: '/trends', displayName: 'è¶‹åŠ¿åˆ†æ'),
    'æ¶ˆè´¹è¶‹åŠ¿': NavigationTarget(route: '/trends', displayName: 'è¶‹åŠ¿åˆ†æ'),
  };

  // ==================== ç›´æ¥æ“ä½œæ˜ å°„ï¼ˆ60+é¡¹ï¼‰ ====================

  static final Map<String, DirectAction> _directActions = {

    // ========== è®°è´¦æ“ä½œ ==========
    'åˆ é™¤æœ€åä¸€ç¬”': DirectAction(type: ActionType.deleteLastTransaction, needConfirm: true),
    'æ’¤é”€': DirectAction(type: ActionType.undo, needConfirm: false),
    'æ’¤é”€ä¸Šæ¬¡æ“ä½œ': DirectAction(type: ActionType.undo, needConfirm: false),
    'ä¿®æ”¹åˆšæ‰é‚£ç¬”': DirectAction(type: ActionType.editLastTransaction, needConfirm: false),
    'å¤åˆ¶ä¸ºæ¨¡æ¿': DirectAction(type: ActionType.copyAsTemplate, needConfirm: false),

    // ========== è´¦æœ¬åˆ‡æ¢ ==========
    'åˆ‡æ¢è´¦æœ¬': DirectAction(type: ActionType.switchLedger, needConfirm: false),
    'åˆ‡æ¢åˆ°ä¸ªäººè´¦æœ¬': DirectAction(type: ActionType.switchToPersonalLedger, needConfirm: false),
    'åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬': DirectAction(type: ActionType.switchToFamilyLedger, needConfirm: false),

    // ========== è´¦æˆ·æ“ä½œ ==========
    'åˆ‡æ¢é»˜è®¤è´¦æˆ·': DirectAction(type: ActionType.switchDefaultAccount, needConfirm: false),
    'æ ¡æ­£ä½™é¢': DirectAction(type: ActionType.correctBalance, needConfirm: true),
    'æŸ¥çœ‹ä½™é¢': DirectAction(type: ActionType.viewBalance, needConfirm: false),

    // ========== é¢„ç®—æ“ä½œ ==========
    'é‡ç½®é¢„ç®—': DirectAction(type: ActionType.resetBudget, needConfirm: true),
    'é¢„ç®—ç»“è½¬': DirectAction(type: ActionType.rolloverBudget, needConfirm: true),

    // ========== ä¸»é¢˜æ“ä½œ ==========
    'åˆ‡æ¢æ·±è‰²æ¨¡å¼': DirectAction(type: ActionType.toggleDarkMode, needConfirm: false),
    'å¼€å¯æ·±è‰²æ¨¡å¼': DirectAction(type: ActionType.enableDarkMode, needConfirm: false),
    'å…³é—­æ·±è‰²æ¨¡å¼': DirectAction(type: ActionType.disableDarkMode, needConfirm: false),
    'åˆ‡æ¢æµ…è‰²æ¨¡å¼': DirectAction(type: ActionType.disableDarkMode, needConfirm: false),
    'åˆ‡æ¢è“è‰²ä¸»é¢˜': DirectAction(type: ActionType.setThemeBlue, needConfirm: false),
    'åˆ‡æ¢ç»¿è‰²ä¸»é¢˜': DirectAction(type: ActionType.setThemeGreen, needConfirm: false),
    'åˆ‡æ¢çº¢è‰²ä¸»é¢˜': DirectAction(type: ActionType.setThemeRed, needConfirm: false),
    'åˆ‡æ¢ç´«è‰²ä¸»é¢˜': DirectAction(type: ActionType.setThemePurple, needConfirm: false),
    'åˆ‡æ¢æ©™è‰²ä¸»é¢˜': DirectAction(type: ActionType.setThemeOrange, needConfirm: false),

    // ========== è¯­è¨€åˆ‡æ¢ ==========
    'åˆ‡æ¢ä¸­æ–‡': DirectAction(type: ActionType.setLanguageZhCN, needConfirm: false),
    'åˆ‡æ¢è‹±æ–‡': DirectAction(type: ActionType.setLanguageEnUS, needConfirm: false),
    'åˆ‡æ¢æ—¥æ–‡': DirectAction(type: ActionType.setLanguageJaJP, needConfirm: false),
    'åˆ‡æ¢ç¹ä½“': DirectAction(type: ActionType.setLanguageZhTW, needConfirm: false),

    // ========== è´§å¸åˆ‡æ¢ ==========
    'åˆ‡æ¢äººæ°‘å¸': DirectAction(type: ActionType.setCurrencyCNY, needConfirm: false),
    'åˆ‡æ¢ç¾å…ƒ': DirectAction(type: ActionType.setCurrencyUSD, needConfirm: false),
    'åˆ‡æ¢æ¬§å…ƒ': DirectAction(type: ActionType.setCurrencyEUR, needConfirm: false),
    'åˆ‡æ¢æ—¥å…ƒ': DirectAction(type: ActionType.setCurrencyJPY, needConfirm: false),

    // ========== å¼€å…³æ“ä½œ ==========
    'å¼€å¯è‡ªåŠ¨åŒæ­¥': DirectAction(type: ActionType.enableAutoSync, needConfirm: false),
    'å…³é—­è‡ªåŠ¨åŒæ­¥': DirectAction(type: ActionType.disableAutoSync, needConfirm: false),
    'å¼€å¯éšç§æ¨¡å¼': DirectAction(type: ActionType.enablePrivacyMode, needConfirm: false),
    'å…³é—­éšç§æ¨¡å¼': DirectAction(type: ActionType.disablePrivacyMode, needConfirm: false),
    'éšè—é‡‘é¢': DirectAction(type: ActionType.enablePrivacyMode, needConfirm: false),
    'æ˜¾ç¤ºé‡‘é¢': DirectAction(type: ActionType.disablePrivacyMode, needConfirm: false),
    'å¼€å¯åº”ç”¨é”': DirectAction(type: ActionType.enableAppLock, needConfirm: true),
    'å…³é—­åº”ç”¨é”': DirectAction(type: ActionType.disableAppLock, needConfirm: true),
    'å¼€å¯è¯­éŸ³è¯†åˆ«': DirectAction(type: ActionType.enableVoiceRecognition, needConfirm: false),
    'å…³é—­è¯­éŸ³è¯†åˆ«': DirectAction(type: ActionType.disableVoiceRecognition, needConfirm: false),
    'å¼€å¯å›¾ç‰‡è¯†åˆ«': DirectAction(type: ActionType.enableImageRecognition, needConfirm: false),
    'å…³é—­å›¾ç‰‡è¯†åˆ«': DirectAction(type: ActionType.disableImageRecognition, needConfirm: false),
    'å¼€å¯æ™ºèƒ½åˆ†ç±»': DirectAction(type: ActionType.enableSmartCategory, needConfirm: false),
    'å…³é—­æ™ºèƒ½åˆ†ç±»': DirectAction(type: ActionType.disableSmartCategory, needConfirm: false),
    'å¼€å¯é‡å¤æ£€æµ‹': DirectAction(type: ActionType.enableDuplicateDetection, needConfirm: false),
    'å…³é—­é‡å¤æ£€æµ‹': DirectAction(type: ActionType.disableDuplicateDetection, needConfirm: false),
    'å¼€å¯è®°è´¦æé†’': DirectAction(type: ActionType.enableBookkeepingReminder, needConfirm: false),
    'å…³é—­è®°è´¦æé†’': DirectAction(type: ActionType.disableBookkeepingReminder, needConfirm: false),
    'å¼€å¯é¢„ç®—æé†’': DirectAction(type: ActionType.enableBudgetReminder, needConfirm: false),
    'å…³é—­é¢„ç®—æé†’': DirectAction(type: ActionType.disableBudgetReminder, needConfirm: false),
    'å¼€å¯ç¦»çº¿æ¨¡å¼': DirectAction(type: ActionType.enableOfflineMode, needConfirm: false),
    'å…³é—­ç¦»çº¿æ¨¡å¼': DirectAction(type: ActionType.disableOfflineMode, needConfirm: false),

    // ========== æ•°æ®æ“ä½œ ==========
    'ç«‹å³å¤‡ä»½': DirectAction(type: ActionType.backupNow, needConfirm: true),
    'å¤‡ä»½æ•°æ®': DirectAction(type: ActionType.backupNow, needConfirm: true),
    'åŒæ­¥æ•°æ®': DirectAction(type: ActionType.syncNow, needConfirm: false),
    'ç«‹å³åŒæ­¥': DirectAction(type: ActionType.syncNow, needConfirm: false),
    'å¼ºåˆ¶åˆ·æ–°': DirectAction(type: ActionType.forceRefresh, needConfirm: false),
    'åˆ·æ–°': DirectAction(type: ActionType.refresh, needConfirm: false),
    'åˆ·æ–°æ•°æ®': DirectAction(type: ActionType.refresh, needConfirm: false),
    'æ¸…é™¤ç¼“å­˜': DirectAction(type: ActionType.clearCache, needConfirm: true),
    'æ¸…ç©ºå›æ”¶ç«™': DirectAction(type: ActionType.emptyTrash, needConfirm: true),
    'å¯¼å‡ºæœ¬æœˆæ•°æ®': DirectAction(type: ActionType.exportMonthData, needConfirm: false),
    'å¯¼å‡ºæœ¬å¹´æ•°æ®': DirectAction(type: ActionType.exportYearData, needConfirm: false),
    'å¯¼å‡ºå…¨éƒ¨æ•°æ®': DirectAction(type: ActionType.exportAllData, needConfirm: true),

    // ========== å¿«æ·æ“ä½œ ==========
    'æ‰“å¼€ç›¸æœº': DirectAction(type: ActionType.openCamera, needConfirm: false),
    'æ‰«ä¸€æ‰«': DirectAction(type: ActionType.openScanner, needConfirm: false),
    'å¼€å§‹æ‰«ç ': DirectAction(type: ActionType.openScanner, needConfirm: false),
    'è¿”å›é¦–é¡µ': DirectAction(type: ActionType.goHome, needConfirm: false),
    'å›åˆ°é¦–é¡µ': DirectAction(type: ActionType.goHome, needConfirm: false),

    // ========== ä¹ æƒ¯æ“ä½œ ==========
    'æ‰“å¡': DirectAction(type: ActionType.habitCheckIn, needConfirm: false),
    'ä»Šå¤©æ‰“å¡': DirectAction(type: ActionType.habitCheckIn, needConfirm: false),
    'è®°è´¦æ‰“å¡': DirectAction(type: ActionType.habitCheckIn, needConfirm: false),
    'æŸ¥çœ‹æ‰“å¡': DirectAction(type: ActionType.viewCheckInHistory, needConfirm: false),

    // ========== åˆ†äº«æ“ä½œ ==========
    'åˆ†äº«æœˆæŠ¥': DirectAction(type: ActionType.shareMonthlyReport, needConfirm: false),
    'åˆ†äº«æœˆåº¦æŠ¥å‘Š': DirectAction(type: ActionType.shareMonthlyReport, needConfirm: false),
    'åˆ†äº«å¹´æŠ¥': DirectAction(type: ActionType.shareAnnualReport, needConfirm: false),
    'åˆ†äº«å¹´åº¦æŠ¥å‘Š': DirectAction(type: ActionType.shareAnnualReport, needConfirm: false),
    'åˆ†äº«è´¦å•': DirectAction(type: ActionType.shareTransaction, needConfirm: false),
    'é‚€è¯·å¥½å‹': DirectAction(type: ActionType.inviteFriend, needConfirm: false),

    // ========== ç³»ç»Ÿæ“ä½œ ==========
    'æ£€æŸ¥æ›´æ–°': DirectAction(type: ActionType.checkUpdate, needConfirm: false),
    'æäº¤åé¦ˆ': DirectAction(type: ActionType.openFeedback, needConfirm: false),
    'è”ç³»å®¢æœ': DirectAction(type: ActionType.contactSupport, needConfirm: false),
    'é€€å‡ºç™»å½•': DirectAction(type: ActionType.logout, needConfirm: true),
    'æ³¨é”€è´¦å·': DirectAction(type: ActionType.deleteAccount, needConfirm: true),
  };
}
```

#### 18.4.3 è¯­éŸ³å¯¼èˆªä¸æ“ä½œç¤ºä¾‹åº“ï¼ˆæ‰©å±•ç‰ˆï¼‰

| èƒ½åŠ›å±‚çº§ | è¯­éŸ³æŒ‡ä»¤ç¤ºä¾‹ | ç³»ç»Ÿå“åº” |
|---------|-------------|---------|
| **é¡µé¢å¯¼èˆª** | "æ‰“å¼€é¢„ç®—ç®¡ç†" | æ­£åœ¨æ‰“å¼€é¢„ç®—ç®¡ç†é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "å»ä¿¡ç”¨å¡é¡µé¢" | æ­£åœ¨æ‰“å¼€ä¿¡ç”¨å¡ç®¡ç†é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "çœ‹çœ‹æˆ‘çš„å€ºåŠ¡" | æ­£åœ¨æ‰“å¼€å€ºåŠ¡ç®¡ç†é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "æ‰“å¼€å¹´åº¦æŠ¥å‘Š" | æ­£åœ¨æ‰“å¼€å¹´åº¦æŠ¥å‘Šé¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "å»æ™ºèƒ½å¯¼å…¥" | æ­£åœ¨æ‰“å¼€æ™ºèƒ½è´¦å•å¯¼å…¥é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "æ‰“å¼€è¯­è¨€è®¾ç½®" | æ­£åœ¨æ‰“å¼€è¯­è¨€è®¾ç½®é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "æŸ¥çœ‹æˆå‘˜å¯¹æ¯”" | æ­£åœ¨æ‰“å¼€æˆå‘˜å¯¹æ¯”é¡µé¢ |
| **é¡µé¢å¯¼èˆª** | "æ‰“å¼€å€ºåŠ¡æ¨¡æ‹Ÿå™¨" | æ­£åœ¨æ‰“å¼€å€ºåŠ¡æ¨¡æ‹Ÿå™¨é¡µé¢ |
| **åŠŸèƒ½å…¥å£** | "è®°ä¸€ç¬”æ”¯å‡º" | å·²æ‰“å¼€æ–°å¢äº¤æ˜“é¡µé¢ï¼Œç±»å‹å·²é€‰"æ”¯å‡º" |
| **åŠŸèƒ½å…¥å£** | "åˆ›å»ºä¸€ä¸ªæ—…æ¸¸å‚¨è“„ç›®æ ‡" | å·²æ‰“å¼€å‚¨è“„ç›®æ ‡åˆ›å»ºé¡µé¢ï¼Œåç§°å·²é¢„å¡«"æ—…æ¸¸" |
| **åŠŸèƒ½å…¥å£** | "æ·»åŠ ä¸€å¼ å·¥å•†é“¶è¡Œå¡" | å·²æ‰“å¼€æ·»åŠ è´¦æˆ·é¡µé¢ï¼Œç±»å‹å·²é€‰é“¶è¡Œå¡ï¼Œåç§°å·²é¢„å¡« |
| **åŠŸèƒ½å…¥å£** | "è®¾ç½®æˆ¿ç§Ÿæé†’" | å·²æ‰“å¼€è´¦å•æé†’é¡µé¢ï¼Œç±»å‹å·²é€‰"æˆ¿ç§Ÿ" |
| **åŠŸèƒ½å…¥å£** | "åˆ›å»ºå®¶åº­è´¦æœ¬" | å·²æ‰“å¼€è´¦æœ¬åˆ›å»ºé¡µé¢ï¼Œåç§°å·²é¢„å¡«"å®¶åº­" |
| **ç›´æ¥æ“ä½œ** | "åˆ‡æ¢æ·±è‰²æ¨¡å¼" | å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼ |
| **ç›´æ¥æ“ä½œ** | "åˆ‡æ¢åˆ°å®¶åº­è´¦æœ¬" | å·²åˆ‡æ¢åˆ°"å®¶åº­"è´¦æœ¬ |
| **ç›´æ¥æ“ä½œ** | "åˆ‡æ¢è‹±æ–‡" | å·²å°†è¯­è¨€åˆ‡æ¢ä¸ºEnglish |
| **ç›´æ¥æ“ä½œ** | "åˆ‡æ¢ç¾å…ƒ" | å·²å°†è´§å¸åˆ‡æ¢ä¸ºUSD |
| **ç›´æ¥æ“ä½œ** | "å¼€å¯è‡ªåŠ¨åŒæ­¥" | å·²å¼€å¯è‡ªåŠ¨åŒæ­¥ |
| **ç›´æ¥æ“ä½œ** | "å…³é—­æ™ºèƒ½åˆ†ç±»" | å·²å…³é—­æ™ºèƒ½åˆ†ç±»åŠŸèƒ½ |
| **ç›´æ¥æ“ä½œ** | "éšè—é‡‘é¢" | å·²å¼€å¯éšç§æ¨¡å¼ï¼Œé‡‘é¢å·²éšè— |
| **ç›´æ¥æ“ä½œ** | "åˆ é™¤æœ€åä¸€ç¬”" | ç¡®å®šè¦åˆ é™¤æœ€åä¸€ç¬”è®°å½•å—ï¼Ÿï¼ˆé¤é¥® 35å…ƒï¼‰ |
| **ç›´æ¥æ“ä½œ** | "æ’¤é”€" | å·²æ’¤é”€ä¸Šæ¬¡æ“ä½œ |
| **ç›´æ¥æ“ä½œ** | "ç«‹å³å¤‡ä»½" | æ•°æ®å¤‡ä»½å®Œæˆ |
| **ç›´æ¥æ“ä½œ** | "åŒæ­¥æ•°æ®" | æ•°æ®åŒæ­¥å®Œæˆ |
| **ç›´æ¥æ“ä½œ** | "å¯¼å‡ºæœ¬æœˆæ•°æ®" | æœ¬æœˆæ•°æ®å·²å¯¼å‡ºåˆ°ï¼š/Documents/export_202601.xlsx |
| **ç›´æ¥æ“ä½œ** | "æ‰“å¡" | æ‰“å¡æˆåŠŸï¼å·²è¿ç»­è®°è´¦15å¤© |
| **ç›´æ¥æ“ä½œ** | "æ‰«ä¸€æ‰«" | å·²æ‰“å¼€æ‰«ç åŠŸèƒ½ |
| **ç›´æ¥æ“ä½œ** | "åˆ†äº«æœˆæŠ¥" | æ­£åœ¨ç”Ÿæˆå¹¶åˆ†äº«æœˆåº¦æŠ¥å‘Š |
| **ç›´æ¥æ“ä½œ** | "æ£€æŸ¥æ›´æ–°" | å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ |
| **ç›´æ¥æ“ä½œ** | "é€€å‡ºç™»å½•" | ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ |
| **2.0æ–°å¢-é’±é¾„** | "çœ‹çœ‹é’±é¾„" | æ­£åœ¨æ‰“å¼€é’±é¾„è¯¦æƒ…é¡µé¢ |
| **2.0æ–°å¢-é’±é¾„** | "é’±é¾„è¶‹åŠ¿" | æ­£åœ¨æ‰“å¼€é’±é¾„å†å²è¶‹åŠ¿é¡µé¢ |
| **2.0æ–°å¢-é’±é¾„** | "èµ„é‡‘æ± " | æ­£åœ¨æ‰“å¼€FIFOèµ„æºæ± é¡µé¢ |
| **2.0æ–°å¢-å°é‡‘åº“** | "æ‰“å¼€å°é‡‘åº“" | æ­£åœ¨æ‰“å¼€å°é‡‘åº“æ¦‚è§ˆé¡µé¢ |
| **2.0æ–°å¢-å°é‡‘åº“** | "åˆ›å»ºæ—…æ¸¸å°é‡‘åº“" | å·²æ‰“å¼€åˆ›å»ºå°é‡‘åº“é¡µé¢ï¼Œåç§°å·²é¢„å¡«"æ—…æ¸¸" |
| **2.0æ–°å¢-å°é‡‘åº“** | "åˆ†é…èµ„é‡‘" | æ­£åœ¨æ‰“å¼€èµ„é‡‘åˆ†é…é¡µé¢ |
| **2.0æ–°å¢-å°é‡‘åº“** | "é›¶åŸºé¢„ç®—" | æ­£åœ¨æ‰“å¼€é›¶åŸºé¢„ç®—åˆ†é…é¡µé¢ |
| **2.0æ–°å¢-ä¹ æƒ¯** | "è´¢åŠ¡å¥åº·" | æ­£åœ¨æ‰“å¼€è´¢åŠ¡å¥åº·ä»ªè¡¨ç›˜ |
| **2.0æ–°å¢-ä¹ æƒ¯** | "è®¢é˜…åˆ†æ" | æ­£åœ¨æ‰“å¼€è®¢é˜…æµªè´¹è¯†åˆ«é¡µé¢ |
| **2.0æ–°å¢-ä¹ æƒ¯** | "æ‹¿é“å› å­" | æ­£åœ¨æ‰“å¼€æ‹¿é“å› å­åˆ†æé¡µé¢ |
| **2.0æ–°å¢-ä¹ æƒ¯** | "åº”æ€¥é‡‘è¿›åº¦" | æ­£åœ¨æ‰“å¼€åº”æ€¥é‡‘ç›®æ ‡é¡µé¢ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "æ‰“å¼€æ™ºèƒ½ä¸­å¿ƒ" | æ­£åœ¨æ‰“å¼€AIæ™ºèƒ½ä¸­å¿ƒ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "æ™ºèƒ½åˆ†ç±»" | æ­£åœ¨æ‰“å¼€æ™ºèƒ½åˆ†ç±»ä¸­å¿ƒ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "é¢„æµ‹ä¸‹æœˆæ¶ˆè´¹" | æ­£åœ¨æŸ¥è¯¢ä¸‹æœˆæ¶ˆè´¹é¢„æµ‹... |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "æŸ¥çœ‹å¼‚å¸¸äº¤æ˜“" | æ­£åœ¨æ‰“å¼€å¼‚å¸¸äº¤æ˜“è¯¦æƒ…é¡µé¢ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "æ™ºèƒ½æœç´¢åˆé¤" | æ­£åœ¨æœç´¢ä¸"åˆé¤"ç›¸å…³çš„äº¤æ˜“... |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "è¯­éŸ³é…ç½®" | æ­£åœ¨æ‰“å¼€è¯­éŸ³é…ç½®ä¸­å¿ƒ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "AIæˆæœ¬" | æ­£åœ¨æ‰“å¼€AIæˆæœ¬ç›‘æ§é¡µé¢ |
| **2.0æ–°å¢-AIä¸­å¿ƒ** | "å­¦ä¹ æŠ¥å‘Š" | æ­£åœ¨æ‰“å¼€æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š |
| **2.0æ–°å¢-è´¦å•æé†’** | "è´¦å•æé†’" | æ­£åœ¨æ‰“å¼€è´¦å•æé†’åˆ—è¡¨ |
| **2.0æ–°å¢-è´¦å•æé†’** | "ä¿¡ç”¨å¡æé†’" | æ­£åœ¨æ‰“å¼€ä¿¡ç”¨å¡è¿˜æ¬¾æé†’é¡µé¢ |
| **2.0æ–°å¢-è´¦å•æé†’** | "è´¦å•æ—¥å†" | æ­£åœ¨æ‰“å¼€è´¦å•æ—¥å†è§†å›¾ |
| **2.0æ–°å¢-ç›‘æ§** | "åº”ç”¨çŠ¶æ€" | æ­£åœ¨æ‰“å¼€åº”ç”¨å¥åº·çŠ¶æ€é¡µé¢ |
| **2.0æ–°å¢-ç›‘æ§** | "AIç›‘æ§" | æ­£åœ¨æ‰“å¼€AIæœåŠ¡ç›‘æ§é¡µé¢ |
| **2.0æ–°å¢-ä½ç½®** | "ä½ç½®åˆ†æ" | æ­£åœ¨æ‰“å¼€ä½ç½®åˆ†ææŠ¥å‘Š |
| **2.0æ–°å¢-ä½ç½®** | "å¼‚åœ°æ¶ˆè´¹" | æ­£åœ¨æ‰“å¼€å¼‚åœ°æ¶ˆè´¹è®°å½• |
| **2.0æ–°å¢-å®‰å…¨** | "å®‰å…¨æ—¥å¿—" | æ­£åœ¨æ‰“å¼€å®‰å…¨å®¡è®¡æ—¥å¿— |
| **2.0æ–°å¢-å®‰å…¨** | "éšç§è®¾ç½®" | æ­£åœ¨æ‰“å¼€éšç§æ¨¡å¼è®¾ç½® |
| **2.0æ–°å¢-æ“ä½œ** | "å¼€å¯å¼‚å¸¸æ£€æµ‹" | å·²å¼€å¯å¼‚å¸¸æ£€æµ‹åŠŸèƒ½ |
| **2.0æ–°å¢-æ“ä½œ** | "é‡æ–°è®­ç»ƒåˆ†ç±»" | æ­£åœ¨é‡æ–°è®­ç»ƒåˆ†ç±»æ¨¡å‹... |


### 18.5 æ™ºèƒ½è¯­éŸ³æŸ¥è¯¢æ¨¡å—

```dart
/// è¯­éŸ³æŸ¥è¯¢æœåŠ¡ - é€šè¿‡è¯­éŸ³æŸ¥è¯¢å„ç§æ•°æ®
class VoiceQueryService {
  final TransactionRepository _transactionRepo;
  final BudgetRepository _budgetRepo;
  final MoneyAgeService _moneyAgeService;
  final StatsService _statsService;
  final LLMService _llmService;

  /// å¤„ç†è¯­éŸ³æŸ¥è¯¢è¯·æ±‚
  Future<VoiceQueryResult> processVoiceQuery({
    required String voiceText,
    required VoiceIntent intent,
  }) async {
    switch (intent.type) {
      case VoiceIntentType.queryExpense:
        return await _processExpenseQuery(voiceText, intent);
      case VoiceIntentType.queryIncome:
        return await _processIncomeQuery(voiceText, intent);
      case VoiceIntentType.queryBudget:
        return await _processBudgetQuery(voiceText, intent);
      case VoiceIntentType.queryMoneyAge:
        return await _processMoneyAgeQuery(voiceText, intent);
      case VoiceIntentType.queryTrend:
        return await _processTrendQuery(voiceText, intent);
      case VoiceIntentType.queryBalance:
        return await _processBalanceQuery(voiceText, intent);
      case VoiceIntentType.queryReport:
        return await _processReportQuery(voiceText, intent);
      default:
        return VoiceQueryResult.error('ä¸æ”¯æŒçš„æŸ¥è¯¢ç±»å‹');
    }
  }

  /// å¤„ç†æ¶ˆè´¹æŸ¥è¯¢
  /// ç¤ºä¾‹ï¼š"è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘"ã€"ä»Šå¤©é¤é¥®æ¶ˆè´¹å¤šå°‘"
  Future<VoiceQueryResult> _processExpenseQuery(
    String voiceText,
    VoiceIntent intent,
  ) async {
    final timeRange = _parseTimeRange(voiceText);
    final category = _parseCategory(voiceText);

    final expenses = await _transactionRepo.getExpenses(
      startDate: timeRange.start,
      endDate: timeRange.end,
      categoryId: category?.id,
    );

    final totalAmount = expenses.fold<double>(0, (sum, tx) => sum + tx.amount);
    final count = expenses.length;

    String response;
    if (category != null) {
      response = '${timeRange.displayName}ï¼Œ${category.name}æ¶ˆè´¹å…±${totalAmount.toStringAsFixed(2)}å…ƒï¼Œå…±$countç¬”';
    } else {
      response = '${timeRange.displayName}ï¼Œæ€»æ¶ˆè´¹${totalAmount.toStringAsFixed(2)}å…ƒï¼Œå…±$countç¬”';
    }

    return VoiceQueryResult.success(
      summary: response,
      data: QueryData(
        type: QueryDataType.expense,
        amount: totalAmount,
        count: count,
        timeRange: timeRange,
        category: category,
        details: expenses.take(5).toList(),
      ),
      followUpSuggestions: ['æŸ¥çœ‹æ˜ç»†', 'æŒ‰åˆ†ç±»ç»Ÿè®¡', 'å¯¹æ¯”ä¸Šæœˆ'],
    );
  }

  /// å¤„ç†é¢„ç®—æŸ¥è¯¢
  /// ç¤ºä¾‹ï¼š"é¤é¥®é¢„ç®—è¿˜å‰©å¤šå°‘"ã€"è¿™ä¸ªæœˆé¢„ç®—è¶…æ”¯æ²¡"
  Future<VoiceQueryResult> _processBudgetQuery(
    String voiceText,
    VoiceIntent intent,
  ) async {
    final category = _parseCategory(voiceText);

    if (category != null) {
      final budget = await _budgetRepo.getBudgetByCategory(category.id);
      if (budget == null) {
        return VoiceQueryResult.success(
          summary: '${category.name}è¿˜æ²¡æœ‰è®¾ç½®é¢„ç®—',
          followUpSuggestions: ['è®¾ç½®é¢„ç®—'],
        );
      }

      final spent = await _getSpentAmount(category.id);
      final remaining = budget.amount - spent;
      final usageRate = spent / budget.amount;

      String status;
      if (remaining < 0) {
        status = 'å·²è¶…æ”¯${(-remaining).toStringAsFixed(2)}å…ƒ';
      } else if (usageRate > 0.8) {
        status = 'å‰©ä½™${remaining.toStringAsFixed(2)}å…ƒï¼Œæ³¨æ„æ§åˆ¶';
      } else {
        status = 'å‰©ä½™${remaining.toStringAsFixed(2)}å…ƒï¼Œä½¿ç”¨æ­£å¸¸';
      }

      return VoiceQueryResult.success(
        summary: '${category.name}é¢„ç®—${budget.amount.toStringAsFixed(2)}å…ƒï¼Œå·²ç”¨${spent.toStringAsFixed(2)}å…ƒï¼Œ$status',
        data: QueryData(
          type: QueryDataType.budget,
          budgetAmount: budget.amount,
          spentAmount: spent,
          usageRate: usageRate,
          category: category,
        ),
      );
    } else {
      final totalBudget = await _budgetRepo.getTotalMonthlyBudget();
      final totalSpent = await _transactionRepo.getMonthlyExpenseTotal();
      final remaining = totalBudget - totalSpent;

      return VoiceQueryResult.success(
        summary: 'æœ¬æœˆæ€»é¢„ç®—${totalBudget.toStringAsFixed(2)}å…ƒï¼Œå·²ç”¨${totalSpent.toStringAsFixed(2)}å…ƒï¼Œå‰©ä½™${remaining.toStringAsFixed(2)}å…ƒ',
        followUpSuggestions: ['æŸ¥çœ‹åˆ†ç±»é¢„ç®—', 'è°ƒæ•´é¢„ç®—'],
      );
    }
  }

  /// å¤„ç†é’±é¾„æŸ¥è¯¢
  /// ç¤ºä¾‹ï¼š"æˆ‘çš„é’±é¾„æƒ…å†µæ€ä¹ˆæ ·"ã€"èµ„é‡‘å¥åº·åº¦å¦‚ä½•"
  Future<VoiceQueryResult> _processMoneyAgeQuery(
    String voiceText,
    VoiceIntent intent,
  ) async {
    final moneyAgeData = await _moneyAgeService.getCurrentMoneyAge();

    final freshRatio = moneyAgeData.freshMoneyRatio * 100;
    final avgAge = moneyAgeData.averageAge;

    String healthDescription;
    if (moneyAgeData.healthScore >= 80) {
      healthDescription = 'éå¸¸å¥åº·';
    } else if (moneyAgeData.healthScore >= 60) {
      healthDescription = 'è‰¯å¥½';
    } else if (moneyAgeData.healthScore >= 40) {
      healthDescription = 'ä¸€èˆ¬ï¼Œå»ºè®®å¢åŠ å‚¨è“„';
    } else {
      healthDescription = 'éœ€è¦å…³æ³¨ï¼Œå»ºè®®æ§åˆ¶æ”¯å‡º';
    }

    return VoiceQueryResult.success(
      summary: 'æ‚¨çš„èµ„é‡‘å¥åº·åº¦$healthDescriptionï¼Œè¯„åˆ†${moneyAgeData.healthScore.toStringAsFixed(0)}åˆ†ã€‚å¹³å‡é’±é¾„${avgAge.toStringAsFixed(1)}å¤©ï¼Œæ–°é²œèµ„é‡‘å æ¯”${freshRatio.toStringAsFixed(1)}%',
      data: QueryData(
        type: QueryDataType.moneyAge,
        moneyAgeData: moneyAgeData,
      ),
      followUpSuggestions: ['æŸ¥çœ‹è¯¦ç»†åˆ†æ', 'å¦‚ä½•æ”¹å–„'],
    );
  }

  /// å¤„ç†è¶‹åŠ¿æŸ¥è¯¢
  /// ç¤ºä¾‹ï¼š"æ¶ˆè´¹è¶‹åŠ¿æ€ä¹ˆæ ·"ã€"å’Œä¸Šæœˆå¯¹æ¯”"
  Future<VoiceQueryResult> _processTrendQuery(
    String voiceText,
    VoiceIntent intent,
  ) async {
    final now = DateTime.now();
    final thisMonth = await _transactionRepo.getMonthlyExpenseTotal(
      year: now.year,
      month: now.month,
    );
    final lastMonth = await _transactionRepo.getMonthlyExpenseTotal(
      year: now.month == 1 ? now.year - 1 : now.year,
      month: now.month == 1 ? 12 : now.month - 1,
    );

    final change = thisMonth - lastMonth;
    final changeRate = lastMonth > 0 ? (change / lastMonth * 100) : 0;

    String trend;
    if (change > 0) {
      trend = 'æ¯”ä¸Šæœˆå¤šèŠ±äº†${change.toStringAsFixed(2)}å…ƒï¼ˆ+${changeRate.toStringAsFixed(1)}%ï¼‰';
    } else if (change < 0) {
      trend = 'æ¯”ä¸Šæœˆå°‘èŠ±äº†${(-change).toStringAsFixed(2)}å…ƒï¼ˆ${changeRate.toStringAsFixed(1)}%ï¼‰';
    } else {
      trend = 'å’Œä¸ŠæœˆæŒå¹³';
    }

    return VoiceQueryResult.success(
      summary: 'æœ¬æœˆå·²æ¶ˆè´¹${thisMonth.toStringAsFixed(2)}å…ƒï¼Œ$trend',
      followUpSuggestions: ['æŸ¥çœ‹åˆ†ç±»å¯¹æ¯”', 'æŸ¥çœ‹è¶‹åŠ¿å›¾'],
    );
  }

  /// è§£ææ—¶é—´èŒƒå›´
  TimeRange _parseTimeRange(String text) {
    final now = DateTime.now();

    if (text.contains('ä»Šå¤©')) {
      return TimeRange(
        start: DateTime(now.year, now.month, now.day),
        end: now,
        displayName: 'ä»Šå¤©',
      );
    }
    if (text.contains('æ˜¨å¤©')) {
      final yesterday = now.subtract(Duration(days: 1));
      return TimeRange(
        start: DateTime(yesterday.year, yesterday.month, yesterday.day),
        end: DateTime(yesterday.year, yesterday.month, yesterday.day, 23, 59, 59),
        displayName: 'æ˜¨å¤©',
      );
    }
    if (text.contains('æœ¬å‘¨') || text.contains('è¿™å‘¨')) {
      final weekStart = now.subtract(Duration(days: now.weekday - 1));
      return TimeRange(
        start: DateTime(weekStart.year, weekStart.month, weekStart.day),
        end: now,
        displayName: 'æœ¬å‘¨',
      );
    }
    if (text.contains('ä¸Šå‘¨')) {
      final lastWeekEnd = now.subtract(Duration(days: now.weekday));
      final lastWeekStart = lastWeekEnd.subtract(Duration(days: 6));
      return TimeRange(
        start: DateTime(lastWeekStart.year, lastWeekStart.month, lastWeekStart.day),
        end: DateTime(lastWeekEnd.year, lastWeekEnd.month, lastWeekEnd.day, 23, 59, 59),
        displayName: 'ä¸Šå‘¨',
      );
    }
    if (text.contains('ä¸Šä¸ªæœˆ') || text.contains('ä¸Šæœˆ')) {
      final lastMonth = DateTime(now.year, now.month - 1, 1);
      final lastMonthEnd = DateTime(now.year, now.month, 0);
      return TimeRange(
        start: lastMonth,
        end: lastMonthEnd,
        displayName: 'ä¸Šä¸ªæœˆ',
      );
    }

    // é»˜è®¤æœ¬æœˆ
    return TimeRange(
      start: DateTime(now.year, now.month, 1),
      end: now,
      displayName: 'è¿™ä¸ªæœˆ',
    );
  }

  /// è§£æåˆ†ç±»
  Category? _parseCategory(String text) {
    final categoryKeywords = {
      'é¤é¥®': 'food', 'åƒé¥­': 'food',
      'äº¤é€š': 'transport', 'æ‰“è½¦': 'transport',
      'è´­ç‰©': 'shopping', 'ä¹°ä¸œè¥¿': 'shopping',
      'å¨±ä¹': 'entertainment',
      'å±…ä½': 'housing', 'æˆ¿ç§Ÿ': 'housing',
      'åŒ»ç–—': 'medical', 'çœ‹ç—…': 'medical',
      'æ•™è‚²': 'education',
    };

    for (final entry in categoryKeywords.entries) {
      if (text.contains(entry.key)) {
        return Category(id: entry.value, name: entry.key);
      }
    }
    return null;
  }
}

/// æ—¶é—´èŒƒå›´
class TimeRange {
  final DateTime start;
  final DateTime end;
  final String displayName;

  TimeRange({required this.start, required this.end, required this.displayName});
}

/// æŸ¥è¯¢æ•°æ®ç±»å‹
enum QueryDataType { expense, income, budget, moneyAge, trend, balance, report }
```

### 18.6 è¯­éŸ³äº¤äº’ä¼šè¯ç®¡ç†

```dart
/// è¯­éŸ³äº¤äº’ä¼šè¯ç®¡ç†å™¨
/// è´Ÿè´£ç®¡ç†å¤šè½®å¯¹è¯çŠ¶æ€ã€ä¸Šä¸‹æ–‡ä¿æŒå’Œä¼šè¯æ¢å¤
class VoiceSessionManager {
  final IntentRecognitionEngine _intentEngine;
  final VoiceBookkeepingService _bookkeepingService;
  final VoiceConfigurationService _configService;
  final VoiceNavigationService _navigationService;
  final VoiceQueryService _queryService;

  VoiceSessionState _state = VoiceSessionState.idle;
  VoiceContext? _context;
  final List<DialogTurn> _history = [];

  /// å¤„ç†è¯­éŸ³è¾“å…¥
  Future<VoiceResponse> processVoiceInput(String voiceText) async {
    _history.add(DialogTurn(role: 'user', content: voiceText));

    // æ£€æŸ¥æ˜¯å¦åœ¨å¤šè½®å¯¹è¯ä¸­
    if (_state != VoiceSessionState.idle && _context != null) {
      return await _handleContextualInput(voiceText);
    }

    // è¯†åˆ«æ„å›¾
    final intent = await _intentEngine.recognizeIntent(voiceText);

    // å¤„ç†é€šç”¨æ„å›¾
    if (intent.type == VoiceIntentType.cancel) return _handleCancel();
    if (intent.type == VoiceIntentType.help) return _handleHelp();

    // æ ¹æ®æ„å›¾ç±»å‹åˆ†å‘å¤„ç†
    return await _dispatchIntent(voiceText, intent);
  }

  /// åˆ†å‘æ„å›¾å¤„ç†
  Future<VoiceResponse> _dispatchIntent(String voiceText, VoiceIntent intent) async {
    // è®°è´¦ç±»æ„å›¾
    if (_isBookkeepingIntent(intent.type)) {
      final result = await _bookkeepingService.processVoiceBookkeeping(
        voiceText: voiceText,
        intent: intent,
      );
      return _handleBookkeepingResult(result);
    }

    // é…ç½®ç±»æ„å›¾
    if (_isConfigIntent(intent.type)) {
      final result = await _configService.processVoiceConfig(
        voiceText: voiceText,
        intent: intent,
      );
      return _handleConfigResult(result);
    }

    // å¯¼èˆªç±»æ„å›¾
    if (_isNavigationIntent(intent.type)) {
      final result = await _navigationService.processVoiceNavigation(
        voiceText: voiceText,
        intent: intent,
      );
      return _handleNavigationResult(result);
    }

    // æŸ¥è¯¢ç±»æ„å›¾
    if (_isQueryIntent(intent.type)) {
      final result = await _queryService.processVoiceQuery(
        voiceText: voiceText,
        intent: intent,
      );
      return _handleQueryResult(result);
    }

    // æœªè¯†åˆ«
    return VoiceResponse(
      message: 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„æ„æ€ã€‚æ‚¨å¯ä»¥è¯´"å¸®åŠ©"äº†è§£æˆ‘èƒ½åšä»€ä¹ˆã€‚',
      suggestions: ['è®°ä¸€ç¬”', 'æŸ¥æ¶ˆè´¹', 'æ‰“å¼€è®¾ç½®', 'å¸®åŠ©'],
      state: VoiceResponseState.needInput,
    );
  }

  /// å¤„ç†å¸®åŠ©
  VoiceResponse _handleHelp() {
    return VoiceResponse(
      message: '''æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
- è®°è´¦ï¼šè¯´"è®°ä¸€ç¬”"æˆ–"èŠ±äº†50åƒé¥­"
- æŸ¥è¯¢ï¼šè¯´"è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘"æˆ–"é¤é¥®é¢„ç®—è¿˜å‰©å¤šå°‘"
- è®¾ç½®ï¼šè¯´"æŠŠé¤é¥®é¢„ç®—æ”¹æˆ2000"
- å¯¼èˆªï¼šè¯´"æ‰“å¼€è®¾ç½®"æˆ–"å»é¢„ç®—é¡µé¢"
- åˆ†æï¼šè¯´"é’±é¾„æƒ…å†µ"æˆ–"æ¶ˆè´¹è¶‹åŠ¿"

è¯·é—®æ‚¨æƒ³åšä»€ä¹ˆï¼Ÿ''',
      suggestions: ['è®°ä¸€ç¬”', 'æŸ¥æ¶ˆè´¹', 'çœ‹é¢„ç®—', 'æ‰“å¼€è®¾ç½®'],
      state: VoiceResponseState.needInput,
    );
  }

  VoiceResponse _handleCancel() {
    _resetSession();
    return VoiceResponse(message: 'å·²å–æ¶ˆ', state: VoiceResponseState.complete);
  }

  void _resetSession() {
    _state = VoiceSessionState.idle;
    _context = null;
  }

  bool _isBookkeepingIntent(VoiceIntentType type) => [
    VoiceIntentType.addExpense, VoiceIntentType.addIncome,
    VoiceIntentType.addTransfer, VoiceIntentType.batchRecord,
    VoiceIntentType.useTemplate,
  ].contains(type);

  bool _isConfigIntent(VoiceIntentType type) => [
    VoiceIntentType.setBudget, VoiceIntentType.setCategory,
    VoiceIntentType.setAccount, VoiceIntentType.setReminder,
    VoiceIntentType.setVault, VoiceIntentType.setGeneral,
  ].contains(type);

  bool _isNavigationIntent(VoiceIntentType type) => [
    VoiceIntentType.navigateTo, VoiceIntentType.searchFunction,
    VoiceIntentType.quickAction,
  ].contains(type);

  bool _isQueryIntent(VoiceIntentType type) => [
    VoiceIntentType.queryExpense, VoiceIntentType.queryIncome,
    VoiceIntentType.queryBudget, VoiceIntentType.queryMoneyAge,
    VoiceIntentType.queryTrend, VoiceIntentType.queryReport,
    VoiceIntentType.queryBalance,
  ].contains(type);
}

/// ä¼šè¯çŠ¶æ€æšä¸¾
enum VoiceSessionState {
  idle, waitingAmount, waitingCategory, waitingConfirmation, waitingConfigValue
}

/// è¯­éŸ³å“åº”çŠ¶æ€
enum VoiceResponseState { complete, needInput, needConfirmation, navigating, error }

/// è¯­éŸ³å“åº”
class VoiceResponse {
  final String message;
  final List<String>? suggestions;
  final VoiceResponseState state;
  final dynamic data;

  VoiceResponse({required this.message, this.suggestions, required this.state, this.data});
}
```

### 18.7 è¯­éŸ³äº¤äº’ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯­éŸ³äº¤äº’ç•Œé¢è®¾è®¡è§„èŒƒ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         è¯­éŸ³äº¤äº’ä¸»ç•Œé¢                                   â”‚    â”‚
â”‚  â”‚                                                                         â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚   â”‚                      å¯¹è¯è®°å½•åŒº                              â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚ ç”¨æˆ·: "è®°ä¸€ç¬”æ—©é¤15å—"                                  â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚ åŠ©æ‰‹: å¥½çš„ï¼Œå·²è®°å½•ï¼šé¤é¥® 15.00å…ƒ                        â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚       è¿˜æœ‰å…¶ä»–éœ€è¦è®°å½•çš„å—ï¼Ÿ                           â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚ ç”¨æˆ·: "è¿™ä¸ªæœˆé¤é¥®èŠ±äº†å¤šå°‘"                              â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚ åŠ©æ‰‹: è¿™ä¸ªæœˆé¤é¥®æ¶ˆè´¹å…±856.50å…ƒï¼Œå…±23ç¬”                  â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â”‚       [æŸ¥çœ‹æ˜ç»†] [æŒ‰æ—¥ç»Ÿè®¡] [å¯¹æ¯”ä¸Šæœˆ]                  â”‚  â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                                                                         â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚   â”‚                      å¿«æ·å»ºè®®åŒº                              â”‚       â”‚    â”‚
â”‚  â”‚   â”‚  [è®°ä¸€ç¬”] [æŸ¥æ¶ˆè´¹] [çœ‹é¢„ç®—] [æ‰“å¼€è®¾ç½®]                       â”‚       â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                                                                         â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚   â”‚                      è¯­éŸ³è¾“å…¥åŒº                              â”‚       â”‚    â”‚
â”‚  â”‚   â”‚                    [ ğŸ¤ æŒ‰ä½è¯´è¯ ]                          â”‚       â”‚    â”‚
â”‚  â”‚   â”‚                      [é”®ç›˜è¾“å…¥]                             â”‚       â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚  ã€äº¤äº’çŠ¶æ€è§†è§‰åé¦ˆã€‘                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çŠ¶æ€           â”‚  è§†è§‰è¡¨ç°                    â”‚  éŸ³æ•ˆ                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  ç©ºé—²           â”‚  éº¦å…‹é£å›¾æ ‡é™æ­¢              â”‚  æ—                        â”‚ â”‚
â”‚  â”‚  å½•éŸ³ä¸­         â”‚  æ³¢æµªåŠ¨ç”»+éº¦å…‹é£é«˜äº®          â”‚  å¼€å§‹æç¤ºéŸ³               â”‚ â”‚
â”‚  â”‚  è¯†åˆ«ä¸­         â”‚  è½¬åœˆåŠ è½½åŠ¨ç”»                â”‚  æ—                        â”‚ â”‚
â”‚  â”‚  AIæ€è€ƒä¸­       â”‚  æ‰“å­—æœºæ•ˆæœæ¸æ˜¾              â”‚  æ—                        â”‚ â”‚
â”‚  â”‚  ç­‰å¾…è¾“å…¥       â”‚  è¾“å…¥æ¡†é«˜äº®+å…‰æ ‡é—ªçƒ          â”‚  æç¤ºéŸ³                   â”‚ â”‚
â”‚  â”‚  æ“ä½œæˆåŠŸ       â”‚  ç»¿è‰²å¯¹å‹¾+æˆåŠŸåŠ¨ç”»            â”‚  æˆåŠŸæç¤ºéŸ³               â”‚ â”‚
â”‚  â”‚  æ“ä½œå¤±è´¥       â”‚  çº¢è‰²å‰å·+éœ‡åŠ¨              â”‚  å¤±è´¥æç¤ºéŸ³               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18.8 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

| é›†æˆç³»ç»Ÿ | è¯­éŸ³èƒ½åŠ› | è§¦å‘ç¤ºä¾‹ | è¾“å‡ºç»“æœ |
|---------|---------|---------|---------|
| **äº¤æ˜“ç³»ç»Ÿ** | è¯­éŸ³è®°è´¦ | "è®°ä¸€ç¬”åˆé¤35" | åˆ›å»ºäº¤æ˜“è®°å½• |
| **é¢„ç®—ç³»ç»Ÿ** | é¢„ç®—æŸ¥è¯¢/è®¾ç½® | "é¤é¥®é¢„ç®—è¿˜å‰©å¤šå°‘" | é¢„ç®—çŠ¶æ€/ä¿®æ”¹é¢„ç®— |
| **é›¶åŸºé¢„ç®—** | å°é‡‘åº“é…ç½® | "åˆ›å»ºæ—…æ¸¸å°é‡‘åº“" | åˆ›å»ºå°é‡‘åº“ |
| **é’±é¾„ç³»ç»Ÿ** | é’±é¾„æŸ¥è¯¢ | "æˆ‘çš„èµ„é‡‘å¥åº·åº¦" | é’±é¾„åˆ†ææŠ¥å‘Š |
| **ä¹ æƒ¯åŸ¹å…»** | æ‰“å¡æé†’ | "è®¾ç½®è®°è´¦æé†’" | é…ç½®æé†’ |
| **æ•°æ®åˆ†æ** | ç»Ÿè®¡æŸ¥è¯¢ | "è¿™ä¸ªæœˆæ¶ˆè´¹è¶‹åŠ¿" | è¶‹åŠ¿åˆ†æ |
| **å¯¼èˆªç³»ç»Ÿ** | é¡µé¢è·³è½¬ | "æ‰“å¼€è®¾ç½®é¡µé¢" | æ‰§è¡Œå¯¼èˆª |

### 18.9 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// æ™ºèƒ½è¯­éŸ³äº¤äº’ç³»ç»ŸéªŒæ”¶æ ‡å‡†
class VoiceInteractionAcceptanceCriteria {
  /// åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥
  static final functionalChecks = {
    'è¯­éŸ³è®°è´¦': [
      'æ”¯æŒå•ç¬”è¯­éŸ³è®°è´¦',
      'æ”¯æŒå¤šç¬”æ‰¹é‡è®°è´¦',
      'è‡ªåŠ¨è¯†åˆ«é‡‘é¢ã€åˆ†ç±»ã€å•†å®¶',
      'å¤šè½®å¯¹è¯è¡¥å…¨ç¼ºå¤±ä¿¡æ¯',
    ],
    'è¯­éŸ³é…ç½®': [
      'æ”¯æŒé¢„ç®—è®¾ç½®',
      'æ”¯æŒåˆ†ç±»ç®¡ç†',
      'æ”¯æŒæé†’è®¾ç½®',
      'æ”¯æŒå°é‡‘åº“é…ç½®',
    ],
    'è¯­éŸ³å¯¼èˆª': [
      'æ”¯æŒé¡µé¢ç›´æ¥è·³è½¬',
      'æ”¯æŒåŠŸèƒ½æœç´¢',
      'æ”¯æŒå¿«æ·æ“ä½œ',
    ],
    'è¯­éŸ³æŸ¥è¯¢': [
      'æ”¯æŒæ¶ˆè´¹ç»Ÿè®¡æŸ¥è¯¢',
      'æ”¯æŒé¢„ç®—ä½™é¢æŸ¥è¯¢',
      'æ”¯æŒé’±é¾„å¥åº·æŸ¥è¯¢',
      'æ”¯æŒè¶‹åŠ¿å¯¹æ¯”æŸ¥è¯¢',
    ],
  };

  /// æ€§èƒ½æŒ‡æ ‡
  static final performanceMetrics = {
    'è¯­éŸ³è¯†åˆ«å»¶è¿Ÿ': '< 1ç§’',
    'æ„å›¾è¯†åˆ«å‡†ç¡®ç‡': '> 90%',
    'å®ä½“æå–å‡†ç¡®ç‡': '> 85%',
    'ç«¯åˆ°ç«¯å“åº”æ—¶é—´': '< 3ç§’',
  };

  /// ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
  static final uxMetrics = {
    'ä¸€æ¬¡æˆåŠŸç‡': '> 80%',  // ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯´å°±èƒ½å®Œæˆæ“ä½œ
    'å¤šè½®å¯¹è¯è½®æ¬¡': '< 3è½®',  // å¹³å‡å¯¹è¯è½®æ¬¡
    'æ”¾å¼ƒç‡': '< 10%',  // ç”¨æˆ·ä¸­é€”æ”¾å¼ƒæ¯”ä¾‹
  };
}
```

### 18.10 æ™ºèƒ½è¯­éŸ³åé¦ˆä¸å®¢æœç³»ç»Ÿ

æœ¬æ¨¡å—å®ç°é€šè¿‡è¯­éŸ³æ”¶é›†ç”¨æˆ·åé¦ˆã€æ™ºèƒ½åˆ†ç±»é—®é¢˜ã€è‡ªåŠ¨å›å¤å¸¸è§é—®é¢˜ã€æƒ…ç»ªè¯†åˆ«ä¸åº”å¯¹ã€ä»¥åŠåé¦ˆé—­ç¯ç®¡ç†çš„å®Œæ•´å®¢æœç³»ç»Ÿã€‚

#### 18.10.0 ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½è¯­éŸ³åé¦ˆä¸å®¢æœç³»ç»Ÿ - æ¶æ„å…¨æ™¯å›¾                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              ç”¨æˆ·è¯­éŸ³è¾“å…¥                                         â”‚   â”‚
â”‚  â”‚                    "è¿™ä¸ªåŠŸèƒ½å¤ªéš¾ç”¨äº†" / "æ€ä¹ˆè®¾ç½®é¢„ç®—"                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           å¤šç»´åº¦æ™ºèƒ½åˆ†æå¼•æ“                                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚   æ„å›¾è¯†åˆ«     â”‚   ç±»å‹åˆ†ç±»     â”‚   æƒ…ç»ªè¯†åˆ«     â”‚   ç´§æ€¥åº¦åˆ¤æ–­   â”‚   ä¸Šä¸‹æ–‡ç†è§£    â”‚   â”‚
â”‚  â”‚               â”‚               â”‚               â”‚               â”‚                 â”‚   â”‚
â”‚  â”‚  â€¢ é—®é¢˜å’¨è¯¢    â”‚  â€¢ åŠŸèƒ½é—®é¢˜    â”‚  â€¢ ç§¯æ/æ»¡æ„   â”‚  â€¢ ç´§æ€¥       â”‚  â€¢ å†å²ä¼šè¯     â”‚   â”‚
â”‚  â”‚  â€¢ åŠŸèƒ½å»ºè®®    â”‚  â€¢ ä½“éªŒé—®é¢˜    â”‚  â€¢ ä¸­æ€§/å›°æƒ‘   â”‚  â€¢ é‡è¦       â”‚  â€¢ ç”¨æˆ·ç”»åƒ     â”‚   â”‚
â”‚  â”‚  â€¢ Bugåé¦ˆ    â”‚  â€¢ æ€§èƒ½é—®é¢˜    â”‚  â€¢ æ¶ˆæ/ä¸æ»¡   â”‚  â€¢ ä¸€èˆ¬       â”‚  â€¢ ä½¿ç”¨åœºæ™¯     â”‚   â”‚
â”‚  â”‚  â€¢ æŠ•è¯‰æŠ±æ€¨    â”‚  â€¢ å»ºè®®ä¼˜åŒ–    â”‚  â€¢ æ„¤æ€’/ç„¦è™‘   â”‚  â€¢ å…¶ä»–       â”‚  â€¢ è®¾å¤‡ä¿¡æ¯     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚                 â”‚                 â”‚                               â”‚
â”‚                    â–¼                 â–¼                 â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   æ™ºèƒ½çŸ¥è¯†åº“åŒ¹é…     â”‚ â”‚   æƒ…ç»ªåŒ–åº”å¯¹ç­–ç•¥     â”‚ â”‚   é—®é¢˜å·¥å•ç”Ÿæˆ       â”‚              â”‚
â”‚  â”‚                     â”‚ â”‚                     â”‚ â”‚                     â”‚              â”‚
â”‚  â”‚  â€¢ å¸®åŠ©æ–‡æ¡£æ£€ç´¢      â”‚ â”‚  â€¢ å…±æƒ…å¼å¼€åœº        â”‚ â”‚  â€¢ è‡ªåŠ¨åˆ†ç±»æ ‡ç­¾      â”‚              â”‚
â”‚  â”‚  â€¢ FAQç²¾å‡†åŒ¹é…       â”‚ â”‚  â€¢ è¯­æ°”è°ƒæ•´          â”‚ â”‚  â€¢ ä¼˜å…ˆçº§è®¾å®š        â”‚              â”‚
â”‚  â”‚  â€¢ ç›¸ä¼¼é—®é¢˜æ¨è      â”‚ â”‚  â€¢ å®‰æŠšè¯æœ¯          â”‚ â”‚  â€¢ æŒ‡æ´¾è§„åˆ™          â”‚              â”‚
â”‚  â”‚  â€¢ æ“ä½œæŒ‡å¼•ç”Ÿæˆ      â”‚ â”‚  â€¢ å‡çº§åˆ¤æ–­          â”‚ â”‚  â€¢ SLAæ—¶æ•ˆ          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚             â”‚                       â”‚                       â”‚                          â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                     â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           æ™ºèƒ½å“åº”ç”Ÿæˆå™¨                                          â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚   è¾“å…¥: ç”¨æˆ·é—®é¢˜ + æƒ…ç»ªçŠ¶æ€ + çŸ¥è¯†åŒ¹é…ç»“æœ + å†å²ä¸Šä¸‹æ–‡                             â”‚   â”‚
â”‚  â”‚   è¾“å‡º: ä¸ªæ€§åŒ–ã€æƒ…æ„ŸåŒ–ã€å‡†ç¡®çš„å›å¤å†…å®¹                                              â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                                  â”‚
â”‚                                      â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           åé¦ˆé—­ç¯ç®¡ç†ç³»ç»Ÿ                                         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  å›å¤æ»¡æ„åº¦    â”‚â”€â”€â”€â†’â”‚  ç­”å¤è´¨é‡è¯„ä¼°  â”‚â”€â”€â”€â†’â”‚  ç­–ç•¥è‡ªåŠ¨ä¼˜åŒ–  â”‚â”€â”€â”€â†’â”‚  çŸ¥è¯†åº“æ›´æ–°  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    æ”¶é›†       â”‚    â”‚    åˆ†æ       â”‚    â”‚    è¿­ä»£       â”‚    â”‚    æ‰©å……     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 18.10.1 åé¦ˆç±»å‹ä¸æƒ…ç»ªè¯†åˆ«

```dart
/// åé¦ˆç±»å‹æšä¸¾
enum FeedbackType {
  // === é—®é¢˜ç±» ===
  question,           // åŠŸèƒ½å’¨è¯¢ï¼šæ€ä¹ˆç”¨ã€åœ¨å“ªé‡Œ
  bugReport,          // Bugåé¦ˆï¼šå‡ºé”™ã€é—ªé€€ã€æ•°æ®ä¸¢å¤±
  performanceIssue,   // æ€§èƒ½é—®é¢˜ï¼šå¡é¡¿ã€æ…¢ã€è€—ç”µ
  dataIssue,          // æ•°æ®é—®é¢˜ï¼šåŒæ­¥å¤±è´¥ã€æ•°æ®ä¸å¯¹

  // === å»ºè®®ç±» ===
  featureRequest,     // åŠŸèƒ½å»ºè®®ï¼šå¸Œæœ›å¢åŠ xxxåŠŸèƒ½
  uiSuggestion,       // ç•Œé¢å»ºè®®ï¼šå¸Œæœ›ç•Œé¢xxx
  experienceSuggestion, // ä½“éªŒå»ºè®®ï¼šæ“ä½œä¸æ–¹ä¾¿

  // === æƒ…ç»ªç±» ===
  complaint,          // æŠ•è¯‰æŠ±æ€¨ï¼šä¸æ»¡æ„ã€å¤ªå·®äº†
  praise,             // è¡¨æ‰¬ç§°èµï¼šå¥½ç”¨ã€å–œæ¬¢

  // === å…¶ä»– ===
  general,            // ä¸€èˆ¬åé¦ˆ
  unknown,            // æœªè¯†åˆ«
}

/// æƒ…ç»ªç±»å‹æšä¸¾
enum EmotionType {
  positive,           // ç§¯æï¼šæ»¡æ„ã€å¼€å¿ƒã€æ„Ÿè°¢
  neutral,            // ä¸­æ€§ï¼šå¹³é™ã€è¯¢é—®
  confused,           // å›°æƒ‘ï¼šä¸ç†è§£ã€ä¸ä¼šç”¨
  frustrated,         // æ²®ä¸§ï¼šå¤±æœ›ã€æ— å¥ˆ
  angry,              // æ„¤æ€’ï¼šç”Ÿæ°”ã€ä¸æ»¡
  anxious,            // ç„¦è™‘ï¼šç€æ€¥ã€æ‹…å¿ƒ
  sarcastic,          // è®½åˆºï¼šé˜´é˜³æ€ªæ°”
}

/// ç´§æ€¥ç¨‹åº¦æšä¸¾
enum UrgencyLevel {
  critical,           // ç´§æ€¥ï¼šæ•°æ®ä¸¢å¤±ã€æ— æ³•ä½¿ç”¨
  high,               // é‡è¦ï¼šæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸
  medium,             // ä¸€èˆ¬ï¼šéæ ¸å¿ƒåŠŸèƒ½é—®é¢˜
  low,                // ä½ï¼šå»ºè®®ã€å’¨è¯¢
}

/// åé¦ˆåˆ†æç»“æœ
class FeedbackAnalysis {
  final FeedbackType type;
  final EmotionType emotion;
  final UrgencyLevel urgency;
  final double emotionIntensity;      // æƒ…ç»ªå¼ºåº¦ 0-1
  final List<String> keywords;        // å…³é”®è¯
  final String? relatedFeature;       // ç›¸å…³åŠŸèƒ½æ¨¡å—
  final Map<String, dynamic> context; // ä¸Šä¸‹æ–‡ä¿¡æ¯

  FeedbackAnalysis({
    required this.type,
    required this.emotion,
    required this.urgency,
    required this.emotionIntensity,
    required this.keywords,
    this.relatedFeature,
    this.context = const {},
  });
}

/// åé¦ˆåˆ†æå¼•æ“
class FeedbackAnalysisEngine {
  final LLMService _llmService;

  /// æƒ…ç»ªè¯†åˆ«å…³é”®è¯åº“
  static const Map<EmotionType, List<String>> _emotionKeywords = {
    EmotionType.positive: [
      'å¥½ç”¨', 'å–œæ¬¢', 'å¤ªæ£’äº†', 'æ„Ÿè°¢', 'ä¸é”™', 'æ–¹ä¾¿', 'èµ', 'å‰å®³',
      'æ»¡æ„', 'æ¨è', 'äº”æ˜Ÿ', 'å®Œç¾', 'ä¼˜ç§€',
    ],
    EmotionType.neutral: [
      'è¯·é—®', 'æ€ä¹ˆ', 'å¦‚ä½•', 'å¯ä»¥å—', 'åœ¨å“ª', 'æ˜¯ä»€ä¹ˆ',
    ],
    EmotionType.confused: [
      'ä¸æ‡‚', 'ä¸ç†è§£', 'ä¸ä¼š', 'çœ‹ä¸æ‡‚', 'ä¸çŸ¥é“', 'ä¸æ˜ç™½', 'è¿·æƒ‘',
      'æä¸æ¸…', 'å¼„ä¸æ˜ç™½',
    ],
    EmotionType.frustrated: [
      'å¤±æœ›', 'æ— å¥ˆ', 'ç®—äº†', 'æ”¾å¼ƒ', 'ä¸æƒ³ç”¨äº†', 'å¤ªéº»çƒ¦',
      'å—ä¸äº†', 'å´©æºƒ',
    ],
    EmotionType.angry: [
      'åƒåœ¾', 'å¤ªå·®', 'ä»€ä¹ˆç©æ„', 'å‘äºº', 'éª—å­', 'é€€æ¬¾', 'å¸è½½',
      'å·®è¯„', 'æŠ•è¯‰', 'ä¸¾æŠ¥', 'æ„¤æ€’', 'æ°”æ­»',
    ],
    EmotionType.anxious: [
      'æ€¥', 'ç€æ€¥', 'é©¬ä¸Š', 'ç«‹åˆ»', 'ç´§æ€¥', 'å¿«ç‚¹', 'ç­‰ä¸äº†',
      'æ‹…å¿ƒ', 'å®³æ€•', 'ä¸¢äº†',
    ],
    EmotionType.sarcastic: [
      'å‘µå‘µ', 'çœŸå‰å®³', 'ç‰›é€¼å•Š', 'æœäº†', 'ä½©æœ', 'é«˜æ˜',
    ],
  };

  /// é—®é¢˜ç±»å‹è¯†åˆ«å…³é”®è¯
  static const Map<FeedbackType, List<String>> _typeKeywords = {
    FeedbackType.question: [
      'æ€ä¹ˆ', 'å¦‚ä½•', 'åœ¨å“ª', 'å“ªé‡Œ', 'ä¸ºä»€ä¹ˆ', 'æ˜¯ä»€ä¹ˆ', 'èƒ½ä¸èƒ½',
      'å¯ä»¥å—', 'è¯·é—®', 'æ•™æˆ‘',
    ],
    FeedbackType.bugReport: [
      'å‡ºé”™', 'æŠ¥é”™', 'é—ªé€€', 'å´©æºƒ', 'æ‰“ä¸å¼€', 'ç”¨ä¸äº†', 'å¤±è´¥',
      'bug', 'é—®é¢˜', 'å¼‚å¸¸', 'å¡æ­»',
    ],
    FeedbackType.performanceIssue: [
      'å¡', 'æ…¢', 'å¡é¡¿', 'åŠ è½½æ…¢', 'è€—ç”µ', 'å‘çƒ­', 'å†…å­˜', 'å ç”¨',
    ],
    FeedbackType.dataIssue: [
      'æ•°æ®ä¸¢å¤±', 'åŒæ­¥å¤±è´¥', 'æ•°æ®ä¸å¯¹', 'è®°å½•æ²¡äº†', 'é‡‘é¢é”™è¯¯',
      'ä¸åŒæ­¥', 'æ•°æ®é”™ä¹±',
    ],
    FeedbackType.featureRequest: [
      'å¸Œæœ›', 'å»ºè®®', 'èƒ½ä¸èƒ½åŠ ', 'è¦æ˜¯æœ‰', 'å¦‚æœèƒ½', 'æœ€å¥½èƒ½',
      'éœ€è¦', 'æƒ³è¦', 'ç¼ºå°‘',
    ],
    FeedbackType.complaint: [
      'æŠ•è¯‰', 'ä¸¾æŠ¥', 'é€€æ¬¾', 'å·®è¯„', 'å¤ªå·®', 'åƒåœ¾', 'éª—äºº',
    ],
    FeedbackType.praise: [
      'å¥½è¯„', 'äº”æ˜Ÿ', 'æ¨è', 'å¤ªå¥½ç”¨', 'å¾ˆæ£’', 'å–œæ¬¢',
    ],
  };

  /// åˆ†æç”¨æˆ·åé¦ˆ
  Future<FeedbackAnalysis> analyzeFeedback(String text) async {
    // 1. è§„åˆ™åŒ¹é…å¿«é€Ÿè¯†åˆ«
    final ruleResult = _ruleBasedAnalysis(text);

    // 2. LLMæ·±åº¦åˆ†æ
    final llmResult = await _llmService.analyzeFeedback(
      text: text,
      feedbackTypes: FeedbackType.values.map((e) => e.name).toList(),
      emotionTypes: EmotionType.values.map((e) => e.name).toList(),
    );

    // 3. ç»¼åˆåˆ¤æ–­
    return FeedbackAnalysis(
      type: _mergeTypeResult(ruleResult.type, llmResult.type),
      emotion: _mergeEmotionResult(ruleResult.emotion, llmResult.emotion),
      urgency: _calculateUrgency(ruleResult, llmResult),
      emotionIntensity: llmResult.emotionIntensity,
      keywords: llmResult.keywords,
      relatedFeature: llmResult.relatedFeature,
      context: {
        'originalText': text,
        'analysisTime': DateTime.now().toIso8601String(),
        'confidence': llmResult.confidence,
      },
    );
  }

  /// è§„åˆ™åŒ¹é…åˆ†æ
  _RuleAnalysisResult _ruleBasedAnalysis(String text) {
    // æƒ…ç»ªè¯†åˆ«
    EmotionType emotion = EmotionType.neutral;
    int maxEmotionScore = 0;

    for (final entry in _emotionKeywords.entries) {
      int score = 0;
      for (final keyword in entry.value) {
        if (text.contains(keyword)) score++;
      }
      if (score > maxEmotionScore) {
        maxEmotionScore = score;
        emotion = entry.key;
      }
    }

    // ç±»å‹è¯†åˆ«
    FeedbackType type = FeedbackType.general;
    int maxTypeScore = 0;

    for (final entry in _typeKeywords.entries) {
      int score = 0;
      for (final keyword in entry.value) {
        if (text.contains(keyword)) score++;
      }
      if (score > maxTypeScore) {
        maxTypeScore = score;
        type = entry.key;
      }
    }

    return _RuleAnalysisResult(type: type, emotion: emotion);
  }

  /// è®¡ç®—ç´§æ€¥ç¨‹åº¦
  UrgencyLevel _calculateUrgency(
    _RuleAnalysisResult ruleResult,
    _LLMAnalysisResult llmResult,
  ) {
    // æ•°æ®ä¸¢å¤±ã€æ— æ³•ä½¿ç”¨ â†’ ç´§æ€¥
    if (ruleResult.type == FeedbackType.dataIssue ||
        llmResult.keywords.any((k) => ['ä¸¢å¤±', 'æ²¡äº†', 'ç”¨ä¸äº†'].contains(k))) {
      return UrgencyLevel.critical;
    }

    // Bugã€æ„¤æ€’æƒ…ç»ª â†’ é‡è¦
    if (ruleResult.type == FeedbackType.bugReport ||
        ruleResult.emotion == EmotionType.angry) {
      return UrgencyLevel.high;
    }

    // å›°æƒ‘ã€æ²®ä¸§ â†’ ä¸€èˆ¬
    if (ruleResult.emotion == EmotionType.confused ||
        ruleResult.emotion == EmotionType.frustrated) {
      return UrgencyLevel.medium;
    }

    // å»ºè®®ã€å’¨è¯¢ â†’ ä½
    return UrgencyLevel.low;
  }
}
```

#### 18.10.2 æƒ…ç»ªåŒ–åº”å¯¹ç­–ç•¥

```dart
/// æƒ…ç»ªåº”å¯¹ç­–ç•¥ç”Ÿæˆå™¨
class EmotionalResponseStrategy {

  /// æ ¹æ®æƒ…ç»ªç”Ÿæˆåº”å¯¹ç­–ç•¥
  static ResponseStrategy getStrategy(FeedbackAnalysis analysis) {
    return ResponseStrategy(
      openingStyle: _getOpeningStyle(analysis.emotion, analysis.emotionIntensity),
      toneAdjustment: _getToneAdjustment(analysis.emotion),
      responseTemplate: _getResponseTemplate(analysis),
      followUpAction: _getFollowUpAction(analysis),
      escalationNeeded: _needsEscalation(analysis),
    );
  }

  /// å¼€åœºç™½é£æ ¼
  static OpeningStyle _getOpeningStyle(EmotionType emotion, double intensity) {
    switch (emotion) {
      case EmotionType.angry:
        if (intensity > 0.7) {
          return OpeningStyle(
            style: 'è¯šæ³é“æ­‰',
            templates: [
              'éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥äº†ä¸å¥½çš„ä½“éªŒï¼Œæˆ‘å®Œå…¨ç†è§£æ‚¨çš„å¿ƒæƒ…ã€‚',
              'çœŸçš„å¾ˆæŠ±æ­‰è®©æ‚¨é‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œæ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬éå¸¸é‡è¦ã€‚',
              'é¦–å…ˆå‘æ‚¨è¡¨è¾¾æ·±æ·±çš„æ­‰æ„ï¼Œæˆ‘ä»¬éå¸¸é‡è§†æ‚¨åé¦ˆçš„é—®é¢˜ã€‚',
            ],
          );
        }
        return OpeningStyle(
          style: 'ç†è§£å…±æƒ…',
          templates: [
            'ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œé‡åˆ°è¿™æ ·çš„é—®é¢˜ç¡®å®è®©äººç€æ€¥ã€‚',
            'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘æ¥å¸®æ‚¨çœ‹çœ‹è¿™ä¸ªé—®é¢˜ã€‚',
          ],
        );

      case EmotionType.anxious:
        return OpeningStyle(
          style: 'å¿«é€Ÿå“åº”',
          templates: [
            'åˆ«æ‹…å¿ƒï¼Œæˆ‘æ¥å¸®æ‚¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚',
            'æˆ‘å·²ç»æ”¶åˆ°æ‚¨çš„åé¦ˆï¼Œé©¬ä¸Šä¸ºæ‚¨å¤„ç†ã€‚',
            'è¯·æ”¾å¿ƒï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥è§£å†³ã€‚',
          ],
        );

      case EmotionType.frustrated:
        return OpeningStyle(
          style: 'æ¸©æš–é¼“åŠ±',
          templates: [
            'ç†è§£æ‚¨çš„æ„Ÿå—ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚',
            'åˆ«ç°å¿ƒï¼Œè¿™ä¸ªé—®é¢˜å…¶å®ä¸éš¾è§£å†³ã€‚',
            'æ„Ÿè°¢æ‚¨çš„è€å¿ƒï¼Œæˆ‘æ¥å¸®æ‚¨æƒ³åŠæ³•ã€‚',
          ],
        );

      case EmotionType.confused:
        return OpeningStyle(
          style: 'è€å¿ƒå¼•å¯¼',
          templates: [
            'æ²¡å…³ç³»ï¼Œè¿™ä¸ªåŠŸèƒ½ç¡®å®éœ€è¦äº†è§£ä¸€ä¸‹ï¼Œæˆ‘æ¥ç»™æ‚¨è¯¦ç»†è¯´æ˜ã€‚',
            'è¿™æ˜¯ä¸ªå¥½é—®é¢˜ï¼Œè®©æˆ‘æ¥å¸®æ‚¨è§£ç­”ã€‚',
            'åˆ«ç€æ€¥ï¼Œæˆ‘æ¥ä¸€æ­¥æ­¥æ•™æ‚¨æ€ä¹ˆæ“ä½œã€‚',
          ],
        );

      case EmotionType.positive:
        return OpeningStyle(
          style: 'çƒ­æƒ…å›åº”',
          templates: [
            'å¤ªé«˜å…´æ‚¨å–œæ¬¢æˆ‘ä»¬çš„äº§å“ï¼',
            'æ„Ÿè°¢æ‚¨çš„è®¤å¯ï¼Œè¿™æ˜¯å¯¹æˆ‘ä»¬æœ€å¤§çš„é¼“åŠ±ï¼',
            'è°¢è°¢æ‚¨çš„å¥½è¯„ï¼Œæˆ‘ä»¬ä¼šç»§ç»­åŠªåŠ›ï¼',
          ],
        );

      case EmotionType.sarcastic:
        return OpeningStyle(
          style: 'çœŸè¯šé¢å¯¹',
          templates: [
            'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ç¡®å®è¿˜æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚',
            'æ‚¨è¯´å¾—å¯¹ï¼Œè¿™æ–¹é¢æˆ‘ä»¬åšå¾—è¿˜ä¸å¤Ÿå¥½ï¼Œæ­£åœ¨åŠªåŠ›æ”¹è¿›ã€‚',
          ],
        );

      default:
        return OpeningStyle(
          style: 'æ ‡å‡†é—®å€™',
          templates: [
            'æ‚¨å¥½ï¼Œæ„Ÿè°¢æ‚¨çš„åé¦ˆã€‚',
            'æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼Œæˆ‘æ¥ä¸ºæ‚¨è§£ç­”ã€‚',
          ],
        );
    }
  }

  /// è¯­æ°”è°ƒæ•´å»ºè®®
  static ToneAdjustment _getToneAdjustment(EmotionType emotion) {
    switch (emotion) {
      case EmotionType.angry:
        return ToneAdjustment(
          speed: 'slower',           // è¯­é€Ÿæ”¾æ…¢
          formality: 'formal',       // æ­£å¼
          warmth: 'high',            // é«˜æ¸©æš–åº¦
          directness: 'moderate',    // é€‚åº¦ç›´æ¥
          avoidWords: ['ä½†æ˜¯', 'ä¸è¿‡', 'å…¶å®'],  // é¿å…è½¬æŠ˜è¯
          useWords: ['æŠ±æ­‰', 'ç†è§£', 'ä¸€å®š', 'é©¬ä¸Š'],
        );

      case EmotionType.anxious:
        return ToneAdjustment(
          speed: 'normal',
          formality: 'casual',       // è½»æ¾
          warmth: 'high',
          directness: 'high',        // ç›´æ¥ç»™æ–¹æ¡ˆ
          avoidWords: ['å¯èƒ½', 'ä¹Ÿè®¸', 'å¤§æ¦‚'],
          useWords: ['æ”¾å¿ƒ', 'é©¬ä¸Š', 'ç«‹åˆ»', 'å·²ç»'],
        );

      case EmotionType.confused:
        return ToneAdjustment(
          speed: 'slower',
          formality: 'casual',
          warmth: 'medium',
          directness: 'low',         // å¾ªåºæ¸è¿›
          avoidWords: ['ç®€å•', 'å¾ˆå®¹æ˜“', 'åº”è¯¥çŸ¥é“'],
          useWords: ['é¦–å…ˆ', 'ç„¶å', 'æ¥ä¸‹æ¥', 'è¿™æ ·'],
        );

      case EmotionType.positive:
        return ToneAdjustment(
          speed: 'normal',
          formality: 'casual',
          warmth: 'high',
          directness: 'moderate',
          avoidWords: [],
          useWords: ['è°¢è°¢', 'å¾ˆé«˜å…´', 'æœŸå¾…'],
        );

      default:
        return ToneAdjustment(
          speed: 'normal',
          formality: 'casual',
          warmth: 'medium',
          directness: 'moderate',
          avoidWords: [],
          useWords: [],
        );
    }
  }

  /// åˆ¤æ–­æ˜¯å¦éœ€è¦å‡çº§å¤„ç†
  static bool _needsEscalation(FeedbackAnalysis analysis) {
    // ç´§æ€¥é—®é¢˜
    if (analysis.urgency == UrgencyLevel.critical) return true;

    // é«˜å¼ºåº¦è´Ÿé¢æƒ…ç»ª
    if (analysis.emotion == EmotionType.angry &&
        analysis.emotionIntensity > 0.8) return true;

    // æŠ•è¯‰ç±»å‹
    if (analysis.type == FeedbackType.complaint) return true;

    // æ•°æ®å®‰å…¨é—®é¢˜
    if (analysis.type == FeedbackType.dataIssue &&
        analysis.keywords.any((k) => ['ä¸¢å¤±', 'æ³„éœ²', 'å®‰å…¨'].contains(k))) {
      return true;
    }

    return false;
  }
}

/// å¼€åœºç™½é£æ ¼
class OpeningStyle {
  final String style;
  final List<String> templates;

  OpeningStyle({required this.style, required this.templates});

  String getRandomTemplate() {
    return templates[DateTime.now().millisecond % templates.length];
  }
}

/// è¯­æ°”è°ƒæ•´
class ToneAdjustment {
  final String speed;
  final String formality;
  final String warmth;
  final String directness;
  final List<String> avoidWords;
  final List<String> useWords;

  ToneAdjustment({
    required this.speed,
    required this.formality,
    required this.warmth,
    required this.directness,
    required this.avoidWords,
    required this.useWords,
  });
}

/// åº”å¯¹ç­–ç•¥
class ResponseStrategy {
  final OpeningStyle openingStyle;
  final ToneAdjustment toneAdjustment;
  final String responseTemplate;
  final String followUpAction;
  final bool escalationNeeded;

  ResponseStrategy({
    required this.openingStyle,
    required this.toneAdjustment,
    required this.responseTemplate,
    required this.followUpAction,
    required this.escalationNeeded,
  });
}
```

#### 18.10.3 æ™ºèƒ½çŸ¥è¯†åº“ç³»ç»Ÿ

```dart
/// çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ
/// å°†è®¾è®¡æ–‡æ¡£ã€å¸®åŠ©æ–‡æ¡£ã€FAQç­‰æ•´ç†ä¸ºå¯æ£€ç´¢çš„çŸ¥è¯†åº“
class KnowledgeBaseService {
  final VectorDBService _vectorDB;
  final LLMService _llmService;

  /// çŸ¥è¯†æ¥æºç±»å‹
  static const knowledgeSources = {
    'design_doc': 'è®¾è®¡æ–‡æ¡£',
    'help_doc': 'å¸®åŠ©æ–‡æ¡£',
    'faq': 'å¸¸è§é—®é¢˜',
    'feature_list': 'åŠŸèƒ½æ¸…å•',
    'release_notes': 'æ›´æ–°æ—¥å¿—',
    'user_manual': 'ç”¨æˆ·æ‰‹å†Œ',
    'troubleshooting': 'æ•…éšœæ’é™¤',
    'best_practices': 'æœ€ä½³å®è·µ',
  };

  /// çŸ¥è¯†æ¡ç›®ç»“æ„
  /// ä»è®¾è®¡æ–‡æ¡£ä¸­è‡ªåŠ¨æå–å¹¶ç»“æ„åŒ–
  static const knowledgeSchema = {
    'feature': {
      'name': 'åŠŸèƒ½åç§°',
      'description': 'åŠŸèƒ½æè¿°',
      'howToUse': 'ä½¿ç”¨æ–¹æ³•',
      'relatedFeatures': 'ç›¸å…³åŠŸèƒ½',
      'tips': 'ä½¿ç”¨æŠ€å·§',
      'commonIssues': 'å¸¸è§é—®é¢˜',
    },
    'faq': {
      'question': 'é—®é¢˜',
      'answer': 'ç­”æ¡ˆ',
      'category': 'åˆ†ç±»',
      'keywords': 'å…³é”®è¯',
      'relatedQuestions': 'ç›¸å…³é—®é¢˜',
    },
    'troubleshooting': {
      'symptom': 'é—®é¢˜ç—‡çŠ¶',
      'cause': 'å¯èƒ½åŸå› ',
      'solution': 'è§£å†³æ–¹æ¡ˆ',
      'steps': 'æ“ä½œæ­¥éª¤',
    },
  };

  /// ä»è®¾è®¡æ–‡æ¡£è‡ªåŠ¨æ„å»ºçŸ¥è¯†åº“
  Future<void> buildKnowledgeBase() async {
    // 1. è§£æè®¾è®¡æ–‡æ¡£
    final designDoc = await _parseDesignDocument('app_v2_design.md');

    // 2. æå–åŠŸèƒ½çŸ¥è¯†
    final features = await _extractFeatureKnowledge(designDoc);

    // 3. ç”ŸæˆFAQ
    final faqs = await _generateFAQFromFeatures(features);

    // 4. ç”Ÿæˆæ•…éšœæ’é™¤æŒ‡å—
    final troubleshooting = await _generateTroubleshootingGuide(features);

    // 5. å‘é‡åŒ–å­˜å‚¨
    await _vectorDB.indexDocuments([
      ...features.map((f) => f.toDocument()),
      ...faqs.map((f) => f.toDocument()),
      ...troubleshooting.map((t) => t.toDocument()),
    ]);
  }

  /// æ™ºèƒ½æœç´¢çŸ¥è¯†
  Future<List<KnowledgeItem>> searchKnowledge({
    required String query,
    FeedbackType? feedbackType,
    int limit = 5,
  }) async {
    // 1. å…³é”®è¯æå–
    final keywords = await _llmService.extractKeywords(query);

    // 2. å‘é‡ç›¸ä¼¼åº¦æœç´¢
    final vectorResults = await _vectorDB.search(
      query: query,
      limit: limit * 2,
    );

    // 3. å…³é”®è¯ç²¾ç¡®åŒ¹é…
    final keywordResults = await _searchByKeywords(keywords);

    // 4. æ ¹æ®åé¦ˆç±»å‹è¿‡æ»¤
    final filtered = _filterByFeedbackType(
      [...vectorResults, ...keywordResults],
      feedbackType,
    );

    // 5. æ’åºå»é‡
    return _rankAndDeduplicate(filtered, query).take(limit).toList();
  }

  /// ç”Ÿæˆæ™ºèƒ½å›å¤
  Future<SmartReply> generateReply({
    required String userQuery,
    required FeedbackAnalysis analysis,
    required List<KnowledgeItem> knowledge,
  }) async {
    // è·å–æƒ…ç»ªåº”å¯¹ç­–ç•¥
    final strategy = EmotionalResponseStrategy.getStrategy(analysis);

    // æ„å»ºä¸Šä¸‹æ–‡
    final context = {
      'userQuery': userQuery,
      'emotion': analysis.emotion.name,
      'emotionIntensity': analysis.emotionIntensity,
      'feedbackType': analysis.type.name,
      'openingStyle': strategy.openingStyle.style,
      'toneAdjustment': strategy.toneAdjustment,
      'knowledgeItems': knowledge.map((k) => k.toMap()).toList(),
    };

    // LLMç”Ÿæˆå›å¤
    final reply = await _llmService.generateCustomerServiceReply(
      context: context,
      systemPrompt: _buildSystemPrompt(strategy),
    );

    return SmartReply(
      content: reply.content,
      confidence: reply.confidence,
      sources: knowledge.map((k) => k.source).toList(),
      followUpQuestions: reply.suggestedFollowUps,
      needsEscalation: strategy.escalationNeeded || reply.confidence < 0.6,
    );
  }

  /// æ„å»ºç³»ç»Ÿæç¤ºè¯
  String _buildSystemPrompt(ResponseStrategy strategy) {
    return '''
ä½ æ˜¯AIæ™ºèƒ½è®°è´¦çš„å®¢æœåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç­–ç•¥å›å¤ç”¨æˆ·ï¼š

## å¼€åœºé£æ ¼
${strategy.openingStyle.style}

## è¯­æ°”è¦æ±‚
- è¯­é€Ÿï¼š${strategy.toneAdjustment.speed}
- æ­£å¼åº¦ï¼š${strategy.toneAdjustment.formality}
- æ¸©æš–åº¦ï¼š${strategy.toneAdjustment.warmth}
- ç›´æ¥åº¦ï¼š${strategy.toneAdjustment.directness}
- é¿å…ä½¿ç”¨ï¼š${strategy.toneAdjustment.avoidWords.join('ã€')}
- å»ºè®®ä½¿ç”¨ï¼š${strategy.toneAdjustment.useWords.join('ã€')}

## å›å¤åŸåˆ™
1. å…ˆå…±æƒ…ï¼Œå†è§£å†³é—®é¢˜
2. ç»™å‡ºå…·ä½“çš„æ“ä½œæ­¥éª¤
3. å¦‚æœä¸ç¡®å®šï¼Œè¯šå®å‘ŠçŸ¥å¹¶æä¾›æ›¿ä»£æ–¹æ¡ˆ
4. ç»“å°¾è¯¢é—®æ˜¯å¦è¿˜æœ‰å…¶ä»–é—®é¢˜

## ç¦æ­¢äº‹é¡¹
1. ä¸è¦æ¨å¸è´£ä»»
2. ä¸è¦ä½¿ç”¨æœºæ¢°åŒ–æ¨¡æ¿è¯­è¨€
3. ä¸è¦å¿½è§†ç”¨æˆ·çš„æƒ…ç»ª
''';
  }
}

/// çŸ¥è¯†æ¡ç›®
class KnowledgeItem {
  final String id;
  final String type;           // feature, faq, troubleshooting
  final String title;
  final String content;
  final String source;         // æ¥æºæ–‡æ¡£
  final List<String> keywords;
  final double relevanceScore;
  final Map<String, dynamic> metadata;

  KnowledgeItem({
    required this.id,
    required this.type,
    required this.title,
    required this.content,
    required this.source,
    required this.keywords,
    this.relevanceScore = 0,
    this.metadata = const {},
  });

  Map<String, dynamic> toMap() => {
    'id': id,
    'type': type,
    'title': title,
    'content': content,
    'source': source,
    'keywords': keywords,
  };
}

/// æ™ºèƒ½å›å¤
class SmartReply {
  final String content;
  final double confidence;
  final List<String> sources;
  final List<String> followUpQuestions;
  final bool needsEscalation;

  SmartReply({
    required this.content,
    required this.confidence,
    required this.sources,
    required this.followUpQuestions,
    required this.needsEscalation,
  });
}
```

#### 18.10.4 é—®é¢˜å·¥å•ç³»ç»Ÿ

```dart
/// é—®é¢˜å·¥å•æœåŠ¡
class FeedbackTicketService {
  final ApiService _apiService;
  final LocalStorage _localStorage;

  /// åˆ›å»ºåé¦ˆå·¥å•
  Future<FeedbackTicket> createTicket({
    required String userId,
    required String content,
    required FeedbackAnalysis analysis,
    SmartReply? autoReply,
  }) async {
    final ticket = FeedbackTicket(
      id: generateTicketId(),
      userId: userId,
      content: content,
      type: analysis.type,
      emotion: analysis.emotion,
      urgency: analysis.urgency,
      status: TicketStatus.open,
      autoReplyContent: autoReply?.content,
      autoReplyConfidence: autoReply?.confidence ?? 0,
      needsHumanReview: autoReply?.needsEscalation ?? true,
      createdAt: DateTime.now(),
      metadata: {
        'emotionIntensity': analysis.emotionIntensity,
        'keywords': analysis.keywords,
        'relatedFeature': analysis.relatedFeature,
        'deviceInfo': await _getDeviceInfo(),
        'appVersion': await _getAppVersion(),
      },
    );

    // ä¸ŠæŠ¥åˆ°æœåŠ¡å™¨
    await _apiService.post('/feedback/tickets', ticket.toJson());

    // æœ¬åœ°ç¼“å­˜
    await _localStorage.saveTicket(ticket);

    return ticket;
  }

  /// æ‰¹é‡åŒæ­¥æœªä¸ŠæŠ¥çš„å·¥å•
  Future<void> syncPendingTickets() async {
    final pending = await _localStorage.getPendingTickets();
    for (final ticket in pending) {
      try {
        await _apiService.post('/feedback/tickets', ticket.toJson());
        await _localStorage.markTicketSynced(ticket.id);
      } catch (e) {
        debugPrint('Failed to sync ticket ${ticket.id}: $e');
      }
    }
  }
}

/// åé¦ˆå·¥å•
class FeedbackTicket {
  final String id;
  final String userId;
  final String content;
  final FeedbackType type;
  final EmotionType emotion;
  final UrgencyLevel urgency;
  final TicketStatus status;
  final String? autoReplyContent;
  final double autoReplyConfidence;
  final bool needsHumanReview;
  final DateTime createdAt;
  final DateTime? resolvedAt;
  final String? assignedTo;
  final List<TicketReply> replies;
  final Map<String, dynamic> metadata;
  final UserSatisfaction? satisfaction;

  FeedbackTicket({
    required this.id,
    required this.userId,
    required this.content,
    required this.type,
    required this.emotion,
    required this.urgency,
    required this.status,
    this.autoReplyContent,
    this.autoReplyConfidence = 0,
    this.needsHumanReview = false,
    required this.createdAt,
    this.resolvedAt,
    this.assignedTo,
    this.replies = const [],
    this.metadata = const {},
    this.satisfaction,
  });

  Map<String, dynamic> toJson() => {
    'id': id,
    'userId': userId,
    'content': content,
    'type': type.name,
    'emotion': emotion.name,
    'urgency': urgency.name,
    'status': status.name,
    'autoReplyContent': autoReplyContent,
    'autoReplyConfidence': autoReplyConfidence,
    'needsHumanReview': needsHumanReview,
    'createdAt': createdAt.toIso8601String(),
    'metadata': metadata,
  };
}

/// å·¥å•çŠ¶æ€
enum TicketStatus {
  open,           // æ–°å»º
  autoReplied,    // å·²è‡ªåŠ¨å›å¤
  pending,        // ç­‰å¾…äººå·¥å¤„ç†
  inProgress,     // å¤„ç†ä¸­
  resolved,       // å·²è§£å†³
  closed,         // å·²å…³é—­
  reopened,       // é‡æ–°æ‰“å¼€
}

/// ç”¨æˆ·æ»¡æ„åº¦
class UserSatisfaction {
  final int rating;           // 1-5æ˜Ÿ
  final bool helpful;         // æ˜¯å¦æœ‰å¸®åŠ©
  final String? comment;      // è¯„ä»·å†…å®¹
  final DateTime ratedAt;

  UserSatisfaction({
    required this.rating,
    required this.helpful,
    this.comment,
    required this.ratedAt,
  });
}
```

#### 18.10.5 ç­”å¤è´¨é‡è¯„ä¼°ä¸ä¼˜åŒ–

```dart
/// ç­”å¤è´¨é‡è¯„ä¼°æœåŠ¡
class ReplyQualityService {
  final ApiService _apiService;
  final LLMService _llmService;

  /// è¯„ä¼°ç»´åº¦
  static const evaluationDimensions = {
    'accuracy': 'å‡†ç¡®æ€§ - å›ç­”æ˜¯å¦æ­£ç¡®è§£å†³äº†ç”¨æˆ·é—®é¢˜',
    'relevance': 'ç›¸å…³æ€§ - å›ç­”æ˜¯å¦åˆ‡é¢˜',
    'completeness': 'å®Œæ•´æ€§ - å›ç­”æ˜¯å¦å…¨é¢',
    'empathy': 'å…±æƒ…åº¦ - æ˜¯å¦ä½“ç°äº†å¯¹ç”¨æˆ·æƒ…ç»ªçš„ç†è§£',
    'actionability': 'å¯æ“ä½œæ€§ - æ˜¯å¦ç»™å‡ºäº†å…·ä½“çš„æ“ä½œæ­¥éª¤',
    'clarity': 'æ¸…æ™°åº¦ - è¡¨è¾¾æ˜¯å¦æ¸…æ™°æ˜“æ‡‚',
  };

  /// æ”¶é›†ç”¨æˆ·æ»¡æ„åº¦åé¦ˆ
  Future<void> collectSatisfaction({
    required String ticketId,
    required int rating,
    required bool helpful,
    String? comment,
  }) async {
    await _apiService.post('/feedback/satisfaction', {
      'ticketId': ticketId,
      'rating': rating,
      'helpful': helpful,
      'comment': comment,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }

  /// å®šæœŸåˆ†æå›å¤è´¨é‡
  Future<QualityAnalysisReport> analyzeReplyQuality({
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    // 1. è·å–æ—¶é—´æ®µå†…çš„æ‰€æœ‰å·¥å•
    final tickets = await _apiService.get('/feedback/tickets', params: {
      'startDate': startDate.toIso8601String(),
      'endDate': endDate.toIso8601String(),
      'hasAutoReply': true,
    });

    // 2. æŒ‰ç±»å‹åˆ†ç»„åˆ†æ
    final analysisResults = <FeedbackType, TypeAnalysis>{};

    for (final type in FeedbackType.values) {
      final typeTickets = tickets.where((t) => t.type == type).toList();
      if (typeTickets.isEmpty) continue;

      analysisResults[type] = await _analyzeTypeQuality(typeTickets);
    }

    // 3. è¯†åˆ«é—®é¢˜æ¨¡å¼
    final patterns = await _identifyProblemPatterns(tickets);

    // 4. ç”Ÿæˆä¼˜åŒ–å»ºè®®
    final suggestions = await _generateOptimizationSuggestions(
      analysisResults,
      patterns,
    );

    return QualityAnalysisReport(
      period: DateRange(start: startDate, end: endDate),
      totalTickets: tickets.length,
      overallSatisfaction: _calculateOverallSatisfaction(tickets),
      typeAnalysis: analysisResults,
      problemPatterns: patterns,
      optimizationSuggestions: suggestions,
    );
  }

  /// åˆ†æç‰¹å®šç±»å‹çš„å›å¤è´¨é‡
  Future<TypeAnalysis> _analyzeTypeQuality(List<FeedbackTicket> tickets) async {
    final withSatisfaction = tickets.where((t) => t.satisfaction != null).toList();

    // æ»¡æ„åº¦ç»Ÿè®¡
    final avgRating = withSatisfaction.isEmpty ? 0.0 :
        withSatisfaction.map((t) => t.satisfaction!.rating).average;

    final helpfulRate = withSatisfaction.isEmpty ? 0.0 :
        withSatisfaction.where((t) => t.satisfaction!.helpful).length /
        withSatisfaction.length;

    // è‡ªåŠ¨å›å¤æˆåŠŸç‡
    final autoReplySuccess = tickets.where((t) =>
        t.autoReplyConfidence > 0.7 &&
        (t.satisfaction?.helpful ?? false)
    ).length / tickets.length;

    // å‡çº§ç‡
    final escalationRate = tickets.where((t) => t.needsHumanReview).length /
        tickets.length;

    // å¸¸è§é—®é¢˜æå–
    final commonIssues = await _extractCommonIssues(tickets);

    // ä½åˆ†å›å¤åˆ†æ
    final lowRatedReplies = withSatisfaction
        .where((t) => t.satisfaction!.rating <= 2)
        .toList();
    final lowRatedAnalysis = await _analyzeLowRatedReplies(lowRatedReplies);

    return TypeAnalysis(
      totalCount: tickets.length,
      avgRating: avgRating,
      helpfulRate: helpfulRate,
      autoReplySuccessRate: autoReplySuccess,
      escalationRate: escalationRate,
      commonIssues: commonIssues,
      lowRatedAnalysis: lowRatedAnalysis,
    );
  }

  /// è¯†åˆ«é—®é¢˜æ¨¡å¼
  Future<List<ProblemPattern>> _identifyProblemPatterns(
    List<FeedbackTicket> tickets,
  ) async {
    // ä½¿ç”¨LLMåˆ†æå·¥å•å†…å®¹ï¼Œè¯†åˆ«åå¤å‡ºç°çš„é—®é¢˜æ¨¡å¼
    final contents = tickets.map((t) => t.content).toList();

    final patterns = await _llmService.identifyPatterns(
      texts: contents,
      minOccurrence: 3,  // è‡³å°‘å‡ºç°3æ¬¡
    );

    return patterns.map((p) => ProblemPattern(
      pattern: p.description,
      frequency: p.count,
      examples: p.examples,
      suggestedAction: p.suggestedAction,
    )).toList();
  }

  /// ç”Ÿæˆä¼˜åŒ–å»ºè®®
  Future<List<OptimizationSuggestion>> _generateOptimizationSuggestions(
    Map<FeedbackType, TypeAnalysis> typeAnalysis,
    List<ProblemPattern> patterns,
  ) async {
    final suggestions = <OptimizationSuggestion>[];

    // 1. åŸºäºä½æ»¡æ„åº¦ç±»å‹ç”Ÿæˆå»ºè®®
    for (final entry in typeAnalysis.entries) {
      if (entry.value.avgRating < 3.5) {
        suggestions.add(OptimizationSuggestion(
          type: SuggestionType.improveReply,
          target: entry.key.name,
          description: '${entry.key.name}ç±»å‹çš„å›å¤æ»¡æ„åº¦è¾ƒä½(${entry.value.avgRating.toStringAsFixed(1)}åˆ†)ï¼Œ'
              'å»ºè®®ä¼˜åŒ–è¯¥ç±»å‹çš„å›å¤ç­–ç•¥',
          priority: entry.value.avgRating < 3.0 ? 'high' : 'medium',
          actions: entry.value.lowRatedAnalysis.suggestedImprovements,
        ));
      }
    }

    // 2. åŸºäºé«˜é¢‘é—®é¢˜æ¨¡å¼ç”Ÿæˆå»ºè®®
    for (final pattern in patterns.where((p) => p.frequency >= 5)) {
      suggestions.add(OptimizationSuggestion(
        type: SuggestionType.addKnowledge,
        target: pattern.pattern,
        description: 'å‘ç°é«˜é¢‘é—®é¢˜æ¨¡å¼ï¼š${pattern.pattern}ï¼Œå‡ºç°${pattern.frequency}æ¬¡',
        priority: 'high',
        actions: [
          'åœ¨çŸ¥è¯†åº“ä¸­æ·»åŠ é’ˆå¯¹æ€§è§£ç­”',
          'è€ƒè™‘åœ¨å¸®åŠ©æ–‡æ¡£ä¸­å¢åŠ ç›¸å…³è¯´æ˜',
          pattern.suggestedAction,
        ],
      ));
    }

    // 3. åŸºäºå‡çº§ç‡ç”Ÿæˆå»ºè®®
    final highEscalationTypes = typeAnalysis.entries
        .where((e) => e.value.escalationRate > 0.5)
        .toList();

    for (final entry in highEscalationTypes) {
      suggestions.add(OptimizationSuggestion(
        type: SuggestionType.improveAutoReply,
        target: entry.key.name,
        description: '${entry.key.name}ç±»å‹çš„å·¥å•å‡çº§ç‡è¿‡é«˜(${(entry.value.escalationRate * 100).toStringAsFixed(0)}%)ï¼Œ'
            'å»ºè®®å¢å¼ºè‡ªåŠ¨å›å¤èƒ½åŠ›',
        priority: 'medium',
        actions: [
          'æ‰©å……è¯¥ç±»å‹çš„çŸ¥è¯†åº“å†…å®¹',
          'ä¼˜åŒ–æ„å›¾è¯†åˆ«å‡†ç¡®åº¦',
          'å¢åŠ æ›´å¤šå›å¤æ¨¡æ¿',
        ],
      ));
    }

    return suggestions;
  }

  /// è‡ªåŠ¨åº”ç”¨ä¼˜åŒ–
  Future<void> applyOptimizations(List<OptimizationSuggestion> suggestions) async {
    for (final suggestion in suggestions.where((s) => s.autoApplicable)) {
      switch (suggestion.type) {
        case SuggestionType.addKnowledge:
          // è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†æ¡ç›®
          await _autoGenerateKnowledge(suggestion);
          break;

        case SuggestionType.improveReply:
          // è°ƒæ•´å›å¤ç­–ç•¥å‚æ•°
          await _adjustReplyStrategy(suggestion);
          break;

        case SuggestionType.improveAutoReply:
          // æ›´æ–°è‡ªåŠ¨å›å¤è§„åˆ™
          await _updateAutoReplyRules(suggestion);
          break;
      }
    }
  }
}

/// è´¨é‡åˆ†ææŠ¥å‘Š
class QualityAnalysisReport {
  final DateRange period;
  final int totalTickets;
  final double overallSatisfaction;
  final Map<FeedbackType, TypeAnalysis> typeAnalysis;
  final List<ProblemPattern> problemPatterns;
  final List<OptimizationSuggestion> optimizationSuggestions;

  QualityAnalysisReport({
    required this.period,
    required this.totalTickets,
    required this.overallSatisfaction,
    required this.typeAnalysis,
    required this.problemPatterns,
    required this.optimizationSuggestions,
  });
}

/// ç±»å‹åˆ†æ
class TypeAnalysis {
  final int totalCount;
  final double avgRating;
  final double helpfulRate;
  final double autoReplySuccessRate;
  final double escalationRate;
  final List<String> commonIssues;
  final LowRatedAnalysis lowRatedAnalysis;

  TypeAnalysis({
    required this.totalCount,
    required this.avgRating,
    required this.helpfulRate,
    required this.autoReplySuccessRate,
    required this.escalationRate,
    required this.commonIssues,
    required this.lowRatedAnalysis,
  });
}

/// é—®é¢˜æ¨¡å¼
class ProblemPattern {
  final String pattern;
  final int frequency;
  final List<String> examples;
  final String suggestedAction;

  ProblemPattern({
    required this.pattern,
    required this.frequency,
    required this.examples,
    required this.suggestedAction,
  });
}

/// ä¼˜åŒ–å»ºè®®
class OptimizationSuggestion {
  final SuggestionType type;
  final String target;
  final String description;
  final String priority;
  final List<String> actions;
  final bool autoApplicable;

  OptimizationSuggestion({
    required this.type,
    required this.target,
    required this.description,
    required this.priority,
    required this.actions,
    this.autoApplicable = false,
  });
}

enum SuggestionType {
  addKnowledge,     // æ·»åŠ çŸ¥è¯†
  improveReply,     // ä¼˜åŒ–å›å¤
  improveAutoReply, // æå‡è‡ªåŠ¨å›å¤
  escalateToAdmin,  // å‡çº§ç»™ç®¡ç†å‘˜
}
```

#### 18.10.6 ç®¡ç†å‘˜å·¥å•ç³»ç»Ÿ

```dart
/// ç®¡ç†å‘˜å·¥å•å¤„ç†æœåŠ¡ï¼ˆåç«¯APIï¼‰
class AdminTicketService {
  /// è·å–å¾…å¤„ç†å·¥å•åˆ—è¡¨
  Future<List<FeedbackTicket>> getPendingTickets({
    UrgencyLevel? urgency,
    FeedbackType? type,
    int page = 1,
    int pageSize = 20,
  }) async {
    // ä¼˜å…ˆçº§æ’åºï¼šç´§æ€¥åº¦ > æƒ…ç»ªå¼ºåº¦ > åˆ›å»ºæ—¶é—´
    return await _queryTickets(
      status: [TicketStatus.pending, TicketStatus.open],
      urgency: urgency,
      type: type,
      orderBy: ['urgency DESC', 'emotionIntensity DESC', 'createdAt ASC'],
      page: page,
      pageSize: pageSize,
    );
  }

  /// æ™ºèƒ½åˆ†é…å·¥å•
  Future<void> autoAssignTickets() async {
    final pendingTickets = await getPendingTickets();
    final availableAdmins = await _getAvailableAdmins();

    for (final ticket in pendingTickets) {
      // æ ¹æ®é—®é¢˜ç±»å‹åŒ¹é…ä¸“é•¿ç®¡ç†å‘˜
      final bestAdmin = _findBestAdmin(ticket, availableAdmins);

      if (bestAdmin != null) {
        await assignTicket(ticket.id, bestAdmin.id);
      }
    }
  }

  /// ç”Ÿæˆç³»ç»Ÿé—®é¢˜å•
  /// å½“çŸ¥è¯†åº“æ— æ³•å›ç­”ä¸”æ— æ³•è‡ªåŠ¨è§£å†³æ—¶
  Future<SystemIssue> createSystemIssue({
    required String ticketId,
    required String description,
    required String suggestedSolution,
  }) async {
    final issue = SystemIssue(
      id: generateIssueId(),
      sourceTicketId: ticketId,
      type: _classifyIssueType(description),
      description: description,
      suggestedSolution: suggestedSolution,
      status: IssueStatus.open,
      priority: _calculateIssuePriority(ticketId),
      createdAt: DateTime.now(),
    );

    await _saveSystemIssue(issue);

    // é€šçŸ¥ç®¡ç†å‘˜
    await _notifyAdmins(issue);

    return issue;
  }

  /// ä»è§£å†³çš„é—®é¢˜ä¸­å­¦ä¹ 
  Future<void> learnFromResolution({
    required String ticketId,
    required String resolution,
    required bool addToKnowledge,
  }) async {
    if (addToKnowledge) {
      final ticket = await _getTicket(ticketId);

      // ç”Ÿæˆæ–°çš„çŸ¥è¯†æ¡ç›®
      final knowledge = KnowledgeItem(
        id: generateKnowledgeId(),
        type: 'faq',
        title: _generateTitle(ticket.content),
        content: resolution,
        source: 'admin_resolution',
        keywords: await _extractKeywords(ticket.content),
      );

      await _knowledgeService.addKnowledge(knowledge);
    }
  }
}

/// ç³»ç»Ÿé—®é¢˜å•
class SystemIssue {
  final String id;
  final String sourceTicketId;
  final IssueType type;
  final String description;
  final String suggestedSolution;
  final IssueStatus status;
  final String priority;
  final DateTime createdAt;
  final DateTime? resolvedAt;
  final String? resolution;

  SystemIssue({
    required this.id,
    required this.sourceTicketId,
    required this.type,
    required this.description,
    required this.suggestedSolution,
    required this.status,
    required this.priority,
    required this.createdAt,
    this.resolvedAt,
    this.resolution,
  });
}

enum IssueType {
  bugFix,           // éœ€è¦ä¿®å¤çš„Bug
  featureGap,       // åŠŸèƒ½ç¼ºå¤±
  documentationGap, // æ–‡æ¡£ç¼ºå¤±
  knowledgeGap,     // çŸ¥è¯†åº“ç¼ºå¤±
  uxIssue,          // ç”¨æˆ·ä½“éªŒé—®é¢˜
}

enum IssueStatus {
  open,
  inProgress,
  resolved,
  wontFix,
}
```

#### 18.10.7 è¯­éŸ³åé¦ˆäº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯­éŸ³åé¦ˆå®Œæ•´äº¤äº’æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ç”¨æˆ·: "è¿™ä¸ªé¢„ç®—åŠŸèƒ½å¤ªéš¾ç”¨äº†ï¼Œæˆ‘è®¾ç½®äº†åŠå¤©éƒ½æ²¡æˆåŠŸï¼ŒçœŸæ˜¯æ°”æ­»äººäº†ï¼"               â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Step 1: å¤šç»´åº¦åˆ†æ                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ ç±»å‹: åŠŸèƒ½é—®é¢˜ (bugReport/experienceSuggestion)                       â”‚   â”‚
â”‚  â”‚  â€¢ æƒ…ç»ª: æ„¤æ€’ (angry), å¼ºåº¦: 0.75                                        â”‚   â”‚
â”‚  â”‚  â€¢ ç´§æ€¥åº¦: ä¸­ç­‰ (medium)                                                 â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®è¯: [é¢„ç®—, åŠŸèƒ½, éš¾ç”¨, è®¾ç½®, å¤±è´¥]                                  â”‚   â”‚
â”‚  â”‚  â€¢ ç›¸å…³åŠŸèƒ½: budget_management                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Step 2: çŸ¥è¯†åº“æ£€ç´¢                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  æ£€ç´¢ç»“æœ:                                                               â”‚   â”‚
â”‚  â”‚  1. [FAQ] å¦‚ä½•è®¾ç½®åˆ†ç±»é¢„ç®— (ç›¸å…³åº¦: 0.92)                                 â”‚   â”‚
â”‚  â”‚  2. [Troubleshooting] é¢„ç®—è®¾ç½®å¸¸è§é—®é¢˜ (ç›¸å…³åº¦: 0.88)                     â”‚   â”‚
â”‚  â”‚  3. [Feature] é¢„ç®—ç®¡ç†åŠŸèƒ½è¯´æ˜ (ç›¸å…³åº¦: 0.85)                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Step 3: æƒ…ç»ªåº”å¯¹ç­–ç•¥                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ å¼€åœºé£æ ¼: ç†è§£å…±æƒ…                                                    â”‚   â”‚
â”‚  â”‚  â€¢ è¯­æ°”: æ¸©å’Œã€æ­£å¼ã€é¿å…è½¬æŠ˜è¯                                          â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®è¯: ç†è§£ã€æŠ±æ­‰ã€ä¸€å®šã€é©¬ä¸Š                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Step 4: ç”Ÿæˆå›å¤                                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  AIå›å¤:                                                                â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  "ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œé¢„ç®—è®¾ç½®ä¸æˆåŠŸç¡®å®è®©äººç€æ€¥ã€‚è®©æˆ‘æ¥å¸®æ‚¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚      â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   é¢„ç®—è®¾ç½®çš„æ­£ç¡®æ­¥éª¤æ˜¯ï¼š                                                 â”‚   â”‚
â”‚  â”‚   1. è¿›å…¥ã€é¢„ç®—ã€‘é¡µé¢                                                   â”‚   â”‚
â”‚  â”‚   2. ç‚¹å‡»æƒ³è¦è®¾ç½®çš„åˆ†ç±»ï¼ˆå¦‚é¤é¥®ï¼‰                                        â”‚   â”‚
â”‚  â”‚   3. åœ¨å¼¹å‡ºçš„é¡µé¢ä¸­è¾“å…¥é¢„ç®—é‡‘é¢                                          â”‚   â”‚
â”‚  â”‚   4. ç‚¹å‡»ã€ä¿å­˜ã€‘æŒ‰é’®                                                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   å¸¸è§é—®é¢˜ï¼šå¦‚æœä¿å­˜æ—¶æç¤ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š                                  â”‚   â”‚
â”‚  â”‚   â€¢ é‡‘é¢æ˜¯å¦ä¸ºæ­£æ•°                                                      â”‚   â”‚
â”‚  â”‚   â€¢ ç½‘ç»œæ˜¯å¦æ­£å¸¸è¿æ¥                                                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   æ‚¨å¯ä»¥æŒ‰ç…§è¿™ä¸ªæ­¥éª¤å†è¯•ä¸€æ¬¡ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘å…·ä½“æ˜¯å“ªä¸€æ­¥å‡ºäº†é—®é¢˜ï¼Œ            â”‚   â”‚
â”‚  â”‚   æˆ‘æ¥å¸®æ‚¨è¿›ä¸€æ­¥æ’æŸ¥ã€‚"                                                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Step 5: åç»­è·Ÿè¿›                                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ åˆ›å»ºå·¥å•: #FB-20260103-0042                                          â”‚   â”‚
â”‚  â”‚  â€¢ å·¥å•çŠ¶æ€: å·²è‡ªåŠ¨å›å¤                                                  â”‚   â”‚
â”‚  â”‚  â€¢ æ»¡æ„åº¦æ”¶é›†: ç­‰å¾…ç”¨æˆ·åé¦ˆ                                              â”‚   â”‚
â”‚  â”‚  â€¢ åç»­æé—®å»ºè®®: ["è¿˜æœ‰å“ªä¸€æ­¥ä¸æ¸…æ¥šï¼Ÿ", "é—®é¢˜è§£å†³äº†å—ï¼Ÿ"]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 15.12.10.8 æƒ…ç»ªåº”å¯¹ç¤ºä¾‹åº“

| ç”¨æˆ·æƒ…ç»ª | ç”¨æˆ·è¡¨è¾¾ç¤ºä¾‹ | AIåº”å¯¹ç­–ç•¥ | AIå›å¤ç¤ºä¾‹ |
|---------|------------|-----------|-----------|
| **æ„¤æ€’** | "ä»€ä¹ˆåƒåœ¾è½¯ä»¶ï¼Œæ•°æ®éƒ½ä¸¢äº†ï¼" | è¯šæ³é“æ­‰+å¿«é€Ÿå“åº”+è§£å†³æ–¹æ¡ˆ | "éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥è¿™ä¹ˆç³Ÿç³•çš„ä½“éªŒï¼æ•°æ®å¯¹æ‚¨éå¸¸é‡è¦ï¼Œæˆ‘å®Œå…¨ç†è§£æ‚¨ç°åœ¨çš„å¿ƒæƒ…ã€‚è¯·æ‚¨å…ˆåˆ«æ‹…å¿ƒï¼Œè®©æˆ‘é©¬ä¸Šå¸®æ‚¨çœ‹çœ‹èƒ½å¦æ¢å¤æ•°æ®..." |
| **ç„¦è™‘** | "æ€¥ï¼æˆ‘çš„è®°å½•æ‰¾ä¸åˆ°äº†æ€ä¹ˆåŠ" | å®‰æŠš+ç¡®å®šæ€§æ‰¿è¯º+å¿«é€Ÿæ–¹æ¡ˆ | "åˆ«æ‹…å¿ƒï¼Œè®°å½•å¾ˆå¯èƒ½è¿˜åœ¨ã€‚è¯·æ‚¨æŒ‰ä»¥ä¸‹æ­¥éª¤æ£€æŸ¥ï¼š1. çœ‹çœ‹æ˜¯å¦åˆ‡æ¢äº†æ—¶é—´ç­›é€‰... 2. æ£€æŸ¥æ˜¯å¦åœ¨å…¶ä»–è´¦æˆ·... æˆ‘ä»¬ä¸€å®šèƒ½æ‰¾åˆ°ï¼" |
| **æ²®ä¸§** | "ç®—äº†ï¼Œè¿™åŠŸèƒ½æˆ‘å­¦ä¸ä¼š" | æ¸©æš–é¼“åŠ±+ç®€åŒ–å¼•å¯¼+é™ªä¼´ | "åˆ«ç°å¿ƒï¼è¿™ä¸ªåŠŸèƒ½ç¡®å®éœ€è¦ç†Ÿæ‚‰ä¸€ä¸‹ï¼Œä½†å…¶å®å¾ˆç®€å•ã€‚è®©æˆ‘ç”¨æœ€ç®€å•çš„æ–¹å¼æ•™æ‚¨ï¼Œå°±ä¸‰æ­¥ï¼Œä¿è¯æ‚¨èƒ½å­¦ä¼š..." |
| **å›°æƒ‘** | "è¿™ä¸ªé’±é¾„æ˜¯å•¥æ„æ€å•Šï¼Œçœ‹ä¸æ‡‚" | è€å¿ƒè§£é‡Š+ç±»æ¯”è¯´æ˜+ä¸¾ä¾‹ | "é’±é¾„å…¶å®å¾ˆå¥½ç†è§£ï¼Œå°±åƒé£Ÿç‰©æœ‰ä¿è´¨æœŸä¸€æ ·ã€‚æ¯”å¦‚æ‚¨ä»Šå¤©èŠ±çš„100å—ï¼Œå¯èƒ½æ˜¯ä¸Šä¸ªæœˆ15å·å‘çš„å·¥èµ„ï¼Œé‚£è¿™ç¬”é’±çš„'å¹´é¾„'å°±æ˜¯15å¤©ã€‚é’±é¾„è¶ŠçŸ­è¯´æ˜æ‚¨çš„èµ„é‡‘å‘¨è½¬è¶Šå¥åº·..." |
| **è®½åˆº** | "è¿™é¢„ç®—åŠŸèƒ½è®¾è®¡å¾—çœŸ'å¥½'å•Š" | çœŸè¯šæ¥å—+æ‰¿è®¤ä¸è¶³+æ”¹è¿›æ‰¿è¯º | "æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œçœ‹å¾—å‡ºé¢„ç®—åŠŸèƒ½ç¡®å®æ²¡æœ‰è¾¾åˆ°æ‚¨çš„æœŸæœ›ã€‚èƒ½å…·ä½“è¯´è¯´æ˜¯å“ªé‡Œè®©æ‚¨è§‰å¾—ä¸å¥½ç”¨å—ï¼Ÿæ‚¨çš„æ„è§å¯¹æˆ‘ä»¬æ”¹è¿›éå¸¸é‡è¦ã€‚" |
| **ç§¯æ** | "è¿™ä¸ªè¯­éŸ³è®°è´¦å¤ªæ–¹ä¾¿äº†ï¼" | çƒ­æƒ…å›åº”+å¼•å¯¼æ·±å…¥ä½¿ç”¨ | "å¤ªé«˜å…´æ‚¨å–œæ¬¢è¯­éŸ³è®°è´¦ï¼é™¤äº†å•ç¬”è®°è´¦ï¼Œæ‚¨è¿˜å¯ä»¥è¯´'æ—©é¤15ï¼Œåˆé¤30ï¼Œæ™šé¤50'ä¸€æ¬¡è®°å¤šç¬”å“¦ï¼Œæ›´æ–¹ä¾¿ï¼" |

##### 15.12.10.9 ç³»ç»Ÿé›†æˆä¸æ•°æ®æµ

| é›†æˆç³»ç»Ÿ | æ•°æ®æµå‘ | ç”¨é€” |
|---------|---------|------|
| **çŸ¥è¯†åº“ç³»ç»Ÿ** | è®¾è®¡æ–‡æ¡£ â†’ çŸ¥è¯†åº“ â†’ æ™ºèƒ½å›å¤ | è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©å†…å®¹ï¼Œæ”¯æ’‘æ™ºèƒ½é—®ç­” |
| **å·¥å•ç³»ç»Ÿ** | ç”¨æˆ·åé¦ˆ â†’ å·¥å• â†’ ç®¡ç†åå° | é—®é¢˜è¿½è¸ªä¸é—­ç¯ç®¡ç† |
| **è´¨é‡è¯„ä¼°ç³»ç»Ÿ** | æ»¡æ„åº¦æ•°æ® â†’ åˆ†ææŠ¥å‘Š â†’ ä¼˜åŒ–å»ºè®® | æŒç»­æ”¹è¿›å›å¤è´¨é‡ |
| **ç”¨æˆ·ç”»åƒç³»ç»Ÿ** | å†å²äº¤äº’ â†’ ç”¨æˆ·ç”»åƒ â†’ ä¸ªæ€§åŒ–å›å¤ | æä¾›æ›´è´´åˆç”¨æˆ·çš„æœåŠ¡ |
| **è¿è¥ç›‘æ§ç³»ç»Ÿ** | å·¥å•ç»Ÿè®¡ â†’ ç›‘æ§å¤§ç›˜ â†’ å‘Šè­¦ | åŠæ—¶å‘ç°é—®é¢˜è¶‹åŠ¿ |

##### 15.12.10.10 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// æ™ºèƒ½åé¦ˆç³»ç»ŸéªŒæ”¶æ ‡å‡†
class VoiceFeedbackAcceptanceCriteria {
  /// åŠŸèƒ½å®Œæ•´æ€§
  static final functionalChecks = {
    'åé¦ˆæ”¶é›†': [
      'æ”¯æŒè¯­éŸ³åé¦ˆè¾“å…¥',
      'è‡ªåŠ¨è½¬æ–‡å­—å¹¶å­˜å‚¨',
      'æ”¯æŒè¿½åŠ è¯´æ˜å’Œå›¾ç‰‡',
    ],
    'æ™ºèƒ½åˆ†æ': [
      'åé¦ˆç±»å‹è‡ªåŠ¨åˆ†ç±»å‡†ç¡®ç‡ > 85%',
      'æƒ…ç»ªè¯†åˆ«å‡†ç¡®ç‡ > 80%',
      'ç´§æ€¥ç¨‹åº¦åˆ¤æ–­åˆç†',
    ],
    'æ™ºèƒ½å›å¤': [
      'çŸ¥è¯†åº“åŒ¹é…ç‡ > 70%',
      'å›å¤ç›¸å…³æ€§ > 80%',
      'æƒ…ç»ªåº”å¯¹ç­–ç•¥æ­£ç¡®åº”ç”¨',
    ],
    'å·¥å•ç®¡ç†': [
      'å·¥å•è‡ªåŠ¨åˆ›å»ºå’Œåˆ†ç±»',
      'ä¼˜å…ˆçº§è‡ªåŠ¨è®¾å®š',
      'çŠ¶æ€æµè½¬å®Œæ•´',
    ],
    'è´¨é‡ä¼˜åŒ–': [
      'æ»¡æ„åº¦æ•°æ®æ”¶é›†å®Œæ•´',
      'å®šæœŸç”Ÿæˆè´¨é‡åˆ†ææŠ¥å‘Š',
      'ä¼˜åŒ–å»ºè®®å¯æ‰§è¡Œ',
    ],
  };

  /// æ€§èƒ½æŒ‡æ ‡
  static final performanceMetrics = {
    'åé¦ˆåˆ†æå»¶è¿Ÿ': '< 2ç§’',
    'çŸ¥è¯†æ£€ç´¢å»¶è¿Ÿ': '< 1ç§’',
    'å›å¤ç”Ÿæˆå»¶è¿Ÿ': '< 3ç§’',
    'ç«¯åˆ°ç«¯å“åº”æ—¶é—´': '< 5ç§’',
  };

  /// è´¨é‡æŒ‡æ ‡
  static final qualityMetrics = {
    'è‡ªåŠ¨å›å¤æ»¡æ„åº¦': '> 3.5åˆ† (5åˆ†åˆ¶)',
    'è‡ªåŠ¨å›å¤æœ‰æ•ˆç‡': '> 60%',  // ç”¨æˆ·è®¤ä¸ºæœ‰å¸®åŠ©çš„æ¯”ä¾‹
    'äººå·¥å‡çº§ç‡': '< 30%',       // éœ€è¦äººå·¥ä»‹å…¥çš„æ¯”ä¾‹
    'é—®é¢˜è§£å†³ç‡': '> 80%',       // é¦–æ¬¡å›å¤å³è§£å†³çš„æ¯”ä¾‹
  };
}
```

---



## 19. æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–

### 19.0 æ€§èƒ½è®¾è®¡æ¦‚è¿°

#### 19.0.1 ç« èŠ‚å®šä½ä¸è®¾è®¡ç›®æ ‡

æœ¬ç« èŠ‚æ•´åˆ2.0ç‰ˆæœ¬å„æ¨¡å—çš„æ€§èƒ½è®¾è®¡è¦æ±‚ï¼Œå»ºç«‹ç»Ÿä¸€çš„æ€§èƒ½ç›®æ ‡ã€ä¼˜åŒ–ç­–ç•¥å’Œç›‘æ§ä½“ç³»ï¼Œç¡®ä¿åº”ç”¨åœ¨å„ç§åœºæ™¯ä¸‹éƒ½èƒ½æä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¬¬16ç«  æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€è®¾è®¡ç›®æ ‡ã€‘                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      æ€§èƒ½è®¾è®¡å››ç»´åº¦                                  â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚   â”‚   å¯åŠ¨æ€§èƒ½   â”‚   â”‚   è¿è¡Œæ€§èƒ½   â”‚   â”‚   å“åº”æ€§èƒ½   â”‚          â”‚ â”‚
â”‚  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚          â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ å†·å¯åŠ¨<2s  â”‚   â”‚ â€¢ å¸§ç‡â‰¥55fps â”‚   â”‚ â€¢ æ“ä½œ<100ms â”‚          â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ çƒ­å¯åŠ¨<0.5sâ”‚   â”‚ â€¢ å†…å­˜â‰¤200MB â”‚   â”‚ â€¢ åŠ è½½<500ms â”‚          â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ é¦–å±<500ms â”‚   â”‚ â€¢ CPU<15%    â”‚   â”‚ â€¢ API<5s     â”‚          â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚                            â”‚                                        â”‚ â”‚
â”‚  â”‚                            â–¼                                        â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚ â”‚
â”‚  â”‚              â”‚       èµ„æºæ€§èƒ½           â”‚                          â”‚ â”‚
â”‚  â”‚              â”‚                          â”‚                          â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ å®‰è£…åŒ…<50MB  â€¢ å­˜å‚¨<100MB                         â”‚ â”‚
â”‚  â”‚              â”‚ â€¢ æµé‡ä¼˜åŒ–    â€¢ ç”µé‡ä¼˜åŒ–                            â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€æ ¸å¿ƒç†å¿µã€‘                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  "ç¦»çº¿ä¼˜å…ˆï¼Œæœ¬åœ°ä¸ºç‹ï¼Œäº‘ç«¯å¢å¼ºï¼Œæ¸è¿›åŠ è½½"                              â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚   ç¦»çº¿ä¼˜å…ˆ â”€â”€â†’ æ ¸å¿ƒåŠŸèƒ½é›¶ç½‘ç»œä¾èµ–                                    â”‚ â”‚
â”‚  â”‚   æœ¬åœ°ä¸ºç‹ â”€â”€â†’ æœ¬åœ°è®¡ç®—ä¼˜å…ˆï¼Œå‡å°‘ç½‘ç»œå¾€è¿”                            â”‚ â”‚
â”‚  â”‚   äº‘ç«¯å¢å¼º â”€â”€â†’ AIã€åŒæ­¥ç­‰å¢å€¼åŠŸèƒ½ä¾èµ–äº‘ç«¯                            â”‚ â”‚
â”‚  â”‚   æ¸è¿›åŠ è½½ â”€â”€â†’ ä¼˜å…ˆå±•ç¤ºæ ¸å¿ƒå†…å®¹ï¼Œå»¶è¿ŸåŠ è½½æ¬¡è¦å†…å®¹                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€ä¸å…¶ä»–ç« èŠ‚å…³ç³»ã€‘                                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¬¬7ç«       â”‚  â”‚  ç¬¬10ç«       â”‚  â”‚  ç¬¬16ç«      â”‚  â”‚  ç¬¬15ç«      â”‚    â”‚
â”‚  â”‚  é’±é¾„ç³»ç»Ÿ   â”‚  â”‚  AIè¯†åˆ«     â”‚  â”‚  æ™ºèƒ½åŒ–     â”‚  â”‚  æŠ€æœ¯æ¶æ„   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                â”‚                â”‚                â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                 â”‚                                        â”‚
â”‚                                 â–¼                                        â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                      â”‚   ç¬¬19ç«         â”‚                                â”‚
â”‚                      â”‚ æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ–  â”‚                                â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                               â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â–¼                     â–¼                     â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  æ€§èƒ½æŒ‡æ ‡   â”‚      â”‚  ä¼˜åŒ–ç­–ç•¥   â”‚      â”‚  æ€§èƒ½ç›‘æ§   â”‚             â”‚
â”‚  â”‚  é‡åŒ–ç›®æ ‡   â”‚      â”‚  ç¼“å­˜/é¢„åŠ è½½ â”‚      â”‚  ç¬¬5ç« é›†æˆ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 19.0.2 è®¾è®¡åŸåˆ™åœ¨æ€§èƒ½è®¾è®¡ä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | æ€§èƒ½åº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|---------|---------|---------|
| **å•ä¸€èŒè´£** | æ¨¡å—ç‹¬ç«‹ä¼˜åŒ– | å„æ¨¡å—æ€§èƒ½æŒ‡æ ‡ç‹¬ç«‹ã€äº’ä¸å½±å“ | å•æ¨¡å—ä¼˜åŒ–ä¸å½±å“å…¨å±€ |
| **æ•°æ®ä¸€è‡´æ€§** | ç¼“å­˜ä¸€è‡´æ€§ | å¤šçº§ç¼“å­˜å¤±æ•ˆç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶ | ç¼“å­˜å‘½ä¸­ç‡>90% |
| **æç®€è®¾è®¡** | æœ€å°èµ„æºå ç”¨ | æŒ‰éœ€åŠ è½½ã€æ‡’åˆå§‹åŒ–ã€èµ„æºæ± åŒ– | å†…å­˜å ç”¨<200MB |
| **å¯æ‰©å±•æ€§** | æ€§èƒ½å¯é…ç½® | æ€§èƒ½å‚æ•°å¯è°ƒæ•´ã€é™çº§ç­–ç•¥å¯é…ç½® | é€‚é…ä¸åŒè®¾å¤‡ |
| **æ€§èƒ½ä¼˜åŒ–** | åˆ†å±‚ä¼˜åŒ– | æœ¬åœ°è®¡ç®—ä¼˜å…ˆã€ç½‘ç»œè¯·æ±‚åˆå¹¶ã€å¼‚æ­¥å¤„ç† | æ ¸å¿ƒåŠŸèƒ½0å»¶è¿Ÿ |
| **å¯è§‚æµ‹æ€§** | æ€§èƒ½å¯è§†åŒ– | æ€§èƒ½æŒ‡æ ‡é‡‡é›†ã€è¶‹åŠ¿åˆ†æã€å¼‚å¸¸å‘Šè­¦ | æ€§èƒ½é—®é¢˜<5åˆ†é’Ÿå®šä½ |

### 19.1 æ€§èƒ½æŒ‡æ ‡ä½“ç³»

#### 19.1.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼ˆKPIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ä½“ç³»                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€å¯åŠ¨æ€§èƒ½æŒ‡æ ‡ã€‘                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŒ‡æ ‡åç§°          â”‚  ç›®æ ‡å€¼      â”‚  æµ‹é‡æ–¹æ³•      â”‚  ä¼˜å…ˆçº§        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  å†·å¯åŠ¨æ—¶é—´        â”‚  <2ç§’        â”‚  ä»ç‚¹å‡»åˆ°é¦–å±  â”‚  P0            â”‚ â”‚
â”‚  â”‚  çƒ­å¯åŠ¨æ—¶é—´        â”‚  <0.5ç§’      â”‚  ä»åå°æ¢å¤    â”‚  P0            â”‚ â”‚
â”‚  â”‚  é¦–æ¬¡å†…å®¹ç»˜åˆ¶(FCP) â”‚  <1ç§’        â”‚  é¦–ä¸ªDOMæ¸²æŸ“   â”‚  P0            â”‚ â”‚
â”‚  â”‚  å¯äº¤äº’æ—¶é—´(TTI)   â”‚  <2ç§’        â”‚  å¯å“åº”è¾“å…¥    â”‚  P1            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€è¿è¡Œæ€§èƒ½æŒ‡æ ‡ã€‘                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŒ‡æ ‡åç§°          â”‚  ç›®æ ‡å€¼      â”‚  æµ‹é‡æ–¹æ³•      â”‚  ä¼˜å…ˆçº§        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  å¹³å‡å¸§ç‡          â”‚  â‰¥55fps      â”‚  å¸§ç‡ç›‘æ§      â”‚  P0            â”‚ â”‚
â”‚  â”‚  å¸§ç‡æŠ–åŠ¨          â”‚  <5fps       â”‚  å¸§ç‡æ ‡å‡†å·®    â”‚  P1            â”‚ â”‚
â”‚  â”‚  å†…å­˜å ç”¨          â”‚  <200MB      â”‚  å¸¸é©»å†…å­˜      â”‚  P0            â”‚ â”‚
â”‚  â”‚  CPUå ç”¨(ç©ºé—²)     â”‚  <5%         â”‚  åå°CPU      â”‚  P1            â”‚ â”‚
â”‚  â”‚  CPUå ç”¨(æ´»è·ƒ)     â”‚  <15%        â”‚  å‰å°CPU      â”‚  P1            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€å“åº”æ€§èƒ½æŒ‡æ ‡ã€‘                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŒ‡æ ‡åç§°          â”‚  ç›®æ ‡å€¼      â”‚  æµ‹é‡æ–¹æ³•      â”‚  ä¼˜å…ˆçº§        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  ç‚¹å‡»å“åº”          â”‚  <100ms      â”‚  ä»ç‚¹å‡»åˆ°åé¦ˆ  â”‚  P0            â”‚ â”‚
â”‚  â”‚  é¡µé¢åˆ‡æ¢          â”‚  <300ms      â”‚  è·¯ç”±åˆ‡æ¢å®Œæˆ  â”‚  P0            â”‚ â”‚
â”‚  â”‚  åˆ—è¡¨æ»šåŠ¨          â”‚  60fps       â”‚  æ»šåŠ¨æ—¶å¸§ç‡    â”‚  P0            â”‚ â”‚
â”‚  â”‚  é¡µé¢åŠ è½½          â”‚  <500ms      â”‚  æ•°æ®åŠ è½½å®Œæˆ  â”‚  P0            â”‚ â”‚
â”‚  â”‚  æœç´¢å“åº”          â”‚  <200ms      â”‚  ç»“æœå±•ç¤º      â”‚  P1            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€ç½‘ç»œæ€§èƒ½æŒ‡æ ‡ã€‘                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŒ‡æ ‡åç§°          â”‚  ç›®æ ‡å€¼      â”‚  æµ‹é‡æ–¹æ³•      â”‚  ä¼˜å…ˆçº§        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  APIå“åº”æ—¶é—´       â”‚  <500ms      â”‚  è¯·æ±‚åˆ°å“åº”    â”‚  P0            â”‚ â”‚
â”‚  â”‚  AIæœåŠ¡å“åº”        â”‚  <5ç§’        â”‚  å¤§æ¨¡å‹è°ƒç”¨    â”‚  P1            â”‚ â”‚
â”‚  â”‚  åŒæ­¥å»¶è¿Ÿ          â”‚  <30ç§’       â”‚  æ•°æ®åŒæ­¥      â”‚  P1            â”‚ â”‚
â”‚  â”‚  ç¦»çº¿å¯ç”¨ç‡        â”‚  100%        â”‚  æ ¸å¿ƒåŠŸèƒ½ç¦»çº¿  â”‚  P0            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 19.1.2 å„ä¸šåŠ¡æ¨¡å—æ€§èƒ½è¦æ±‚

| ä¸šåŠ¡æ¨¡å— | æ ¸å¿ƒæ“ä½œ | æ€§èƒ½è¦æ±‚ | æŠ€æœ¯æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| **é’±é¾„ç³»ç»Ÿ** | FIFOèµ„æºæ± è®¡ç®— | <100ms | ç´¢å¼•ä¼˜åŒ–+æ‰¹é‡å¤„ç†+ç¼“å­˜ |
| **é¢„ç®—ç³»ç»Ÿ** | é¢„ç®—çŠ¶æ€æŸ¥è¯¢ | <50ms | é¢„è®¡ç®—+å¢é‡æ›´æ–° |
| **å°é‡‘åº“ç³»ç»Ÿ** | ä½™é¢æŸ¥è¯¢ | <30ms | å†…å­˜ç¼“å­˜+æ‡’åŠ è½½ |
| **ä¹ æƒ¯ç³»ç»Ÿ** | æ‰“å¡çŠ¶æ€ | <20ms | æœ¬åœ°å­˜å‚¨+ä¹è§‚æ›´æ–° |
| **è¯­éŸ³è®°è´¦** | è¯­éŸ³è¯†åˆ« | <2ç§’ | æµå¼å¤„ç†+æœ¬åœ°ç¼“å­˜ |
| **å›¾åƒè®°è´¦** | OCRè¯†åˆ« | <3ç§’ | å›¾ç‰‡å‹ç¼©+åˆ†æ­¥å¤„ç† |
| **æŠ¥è¡¨ç³»ç»Ÿ** | å›¾è¡¨æ¸²æŸ“ | <1ç§’ | é¢„èšåˆ+å¢é‡æ›´æ–°+æ‡’åŠ è½½ |
| **åŒæ­¥ç³»ç»Ÿ** | å¢é‡åŒæ­¥ | <30ç§’ | å·®é‡åŒæ­¥+æ–­ç‚¹ç»­ä¼  |
| **ä¼™ä¼´åŒ–æ–‡æ¡ˆ** | åŠ¨æ€æ–‡æ¡ˆç”Ÿæˆ | <100ms | LLMé¢„ç”Ÿæˆ+æ¨¡æ¿é™çº§ |

### 19.2 ç¼“å­˜æ¶æ„è®¾è®¡

#### 19.2.1 å¤šçº§ç¼“å­˜ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤šçº§ç¼“å­˜æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         L1: å†…å­˜ç¼“å­˜                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  ç‰¹ç‚¹: æœ€å¿«è®¿é—®(<1ms) â”‚ å®¹é‡: 50MB â”‚ ç”Ÿå‘½å‘¨æœŸ: åº”ç”¨è¿è¡ŒæœŸ     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ç¼“å­˜å†…å®¹:                                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å½“å‰ç”¨æˆ·ä¿¡æ¯ã€è´¦æˆ·åˆ—è¡¨ã€åˆ†ç±»åˆ—è¡¨                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å½“å‰æœˆä»½é¢„ç®—çŠ¶æ€ã€é’±é¾„è®¡ç®—ç»“æœ                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ æœ€è¿‘è®¿é—®çš„äº¤æ˜“åˆ—è¡¨(æœ€å¤š100æ¡)                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å¸¸ç”¨å•†å®¶â†’åˆ†ç±»æ˜ å°„è¡¨                                        â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚ Miss                               â”‚
â”‚                                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         L2: æœ¬åœ°æ•°æ®åº“                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  ç‰¹ç‚¹: å¿«é€Ÿè®¿é—®(<10ms) â”‚ å®¹é‡: 500MB â”‚ ç”Ÿå‘½å‘¨æœŸ: æŒä¹…åŒ–       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  å­˜å‚¨å†…å®¹:                                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å…¨é‡äº¤æ˜“è®°å½•ã€è´¦æˆ·æ•°æ®ã€é¢„ç®—é…ç½®                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ èµ„æºæ± æ•°æ®(é’±é¾„è®¡ç®—åŸºç¡€)                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ ç¦»çº¿é˜Ÿåˆ—(å¾…åŒæ­¥æ“ä½œ)                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ é¢„èšåˆæŠ¥è¡¨æ•°æ®                                             â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚ Miss/Sync                          â”‚
â”‚                                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         L3: è¿œç¨‹æœåŠ¡                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  ç‰¹ç‚¹: ç½‘ç»œè®¿é—®(100-500ms) â”‚ å®¹é‡: æ— é™ â”‚ æ•°æ®æƒå¨æº          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  æœåŠ¡å†…å®¹:                                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ äº‘ç«¯æ•°æ®åŒæ­¥ã€è·¨è®¾å¤‡æ•°æ®                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ AIè¯†åˆ«æœåŠ¡(è¯­éŸ³/å›¾åƒ/åˆ†ç±»)                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ åº”ç”¨æ›´æ–°ã€é…ç½®ä¸‹å‘                                         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 19.2.2 ç¼“å­˜ç­–ç•¥å®ç°

```dart
/// ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨
class CacheManager {
  final MemoryCache _memoryCache;
  final DatabaseCache _dbCache;
  final CacheConfig _config;

  /// è·å–æ•°æ®ï¼ˆå¤šçº§ç¼“å­˜ç©¿é€ï¼‰
  Future<T?> get<T>(
    String key, {
    Duration? maxAge,
    bool forceRefresh = false,
  }) async {
    // 1. å¼ºåˆ¶åˆ·æ–°æ—¶è·³è¿‡ç¼“å­˜
    if (forceRefresh) {
      return null;
    }

    // 2. L1: å†…å­˜ç¼“å­˜
    final memoryResult = _memoryCache.get<T>(key);
    if (memoryResult != null && !_isExpired(memoryResult, maxAge)) {
      return memoryResult.data;
    }

    // 3. L2: æœ¬åœ°æ•°æ®åº“ç¼“å­˜
    final dbResult = await _dbCache.get<T>(key);
    if (dbResult != null && !_isExpired(dbResult, maxAge)) {
      // å›å¡«å†…å­˜ç¼“å­˜
      _memoryCache.set(key, dbResult.data, dbResult.timestamp);
      return dbResult.data;
    }

    return null;
  }

  /// è®¾ç½®ç¼“å­˜ï¼ˆåŒæ—¶æ›´æ–°L1å’ŒL2ï¼‰
  Future<void> set<T>(
    String key,
    T data, {
    CacheLevel level = CacheLevel.both,
    Duration? ttl,
  }) async {
    final timestamp = DateTime.now();

    if (level == CacheLevel.memory || level == CacheLevel.both) {
      _memoryCache.set(key, data, timestamp, ttl: ttl);
    }

    if (level == CacheLevel.database || level == CacheLevel.both) {
      await _dbCache.set(key, data, timestamp, ttl: ttl);
    }
  }

  /// ä½¿ç¼“å­˜å¤±æ•ˆ
  Future<void> invalidate(String key) async {
    _memoryCache.remove(key);
    await _dbCache.remove(key);
  }

  /// æŒ‰æ¨¡å¼æ‰¹é‡å¤±æ•ˆ
  Future<void> invalidateByPattern(String pattern) async {
    _memoryCache.removeByPattern(pattern);
    await _dbCache.removeByPattern(pattern);
  }

  /// é¢„çƒ­ç¼“å­˜ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
  Future<void> warmUp() async {
    // é¢„åŠ è½½é«˜é¢‘æ•°æ®åˆ°å†…å­˜
    final warmUpKeys = [
      'user_info',
      'account_list',
      'category_list',
      'current_month_budget',
      'money_age_current',
    ];

    for (final key in warmUpKeys) {
      final dbResult = await _dbCache.get(key);
      if (dbResult != null) {
        _memoryCache.set(key, dbResult.data, dbResult.timestamp);
      }
    }
  }
}

/// ç¼“å­˜åˆ·æ–°ç®¡ç†å™¨ï¼ˆå¸¦å»é‡å’ŒèŠ‚æµï¼‰
class CacheRefreshManager {
  final Map<String, DateTime> _lastRefreshTime = {};
  final Map<String, Completer<void>> _pendingRefreshes = {};
  final Duration _minRefreshInterval;

  CacheRefreshManager({
    Duration minRefreshInterval = const Duration(seconds: 5),
  }) : _minRefreshInterval = minRefreshInterval;

  /// è¯·æ±‚åˆ·æ–°ï¼ˆå¸¦å»é‡ï¼‰
  Future<void> requestRefresh(
    String key,
    Future<void> Function() refreshFn,
  ) async {
    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„åˆ·æ–°
    if (_pendingRefreshes.containsKey(key)) {
      return _pendingRefreshes[key]!.future;
    }

    // æ£€æŸ¥åˆ·æ–°é—´éš”
    final lastRefresh = _lastRefreshTime[key];
    if (lastRefresh != null &&
        DateTime.now().difference(lastRefresh) < _minRefreshInterval) {
      return;
    }

    // æ‰§è¡Œåˆ·æ–°
    final completer = Completer<void>();
    _pendingRefreshes[key] = completer;

    try {
      await refreshFn();
      _lastRefreshTime[key] = DateTime.now();
      completer.complete();
    } catch (e) {
      completer.completeError(e);
      rethrow;
    } finally {
      _pendingRefreshes.remove(key);
    }
  }
}
```

#### 19.2.3 ä¸šåŠ¡ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | ç¼“å­˜çº§åˆ« | TTL | å¤±æ•ˆç­–ç•¥ | æ›´æ–°ç­–ç•¥ |
|---------|---------|-----|---------|---------|
| **ç”¨æˆ·ä¿¡æ¯** | L1+L2 | æ°¸ä¹… | ç™»å‡º/æ›´æ–°æ—¶å¤±æ•ˆ | å†™ç©¿é€ |
| **è´¦æˆ·åˆ—è¡¨** | L1+L2 | æ°¸ä¹… | å¢åˆ æ”¹æ—¶å¤±æ•ˆ | å†™ç©¿é€ |
| **åˆ†ç±»åˆ—è¡¨** | L1+L2 | æ°¸ä¹… | å¢åˆ æ”¹æ—¶å¤±æ•ˆ | å†™ç©¿é€ |
| **äº¤æ˜“è®°å½•** | L2 | æ°¸ä¹… | å¢åˆ æ”¹æ—¶å¤±æ•ˆ | å†™ç©¿é€ |
| **å½“æœˆé¢„ç®—** | L1+L2 | 5åˆ†é’Ÿ | äº¤æ˜“å˜æ›´æ—¶å¤±æ•ˆ | æŒ‰éœ€åˆ·æ–° |
| **é’±é¾„ç»“æœ** | L1 | 5åˆ†é’Ÿ | äº¤æ˜“å˜æ›´æ—¶å¤±æ•ˆ | å¢é‡æ›´æ–° |
| **å•†å®¶æ˜ å°„** | L1+L2 | 24å°æ—¶ | ç”¨æˆ·ä¿®æ­£æ—¶æ›´æ–° | å­¦ä¹ æ›´æ–° |
| **æŠ¥è¡¨æ•°æ®** | L2 | 1å°æ—¶ | æ•°æ®å˜æ›´æ—¶å¤±æ•ˆ | é¢„èšåˆæ›´æ–° |
| **AIè¯†åˆ«ç»“æœ** | L1 | ä¼šè¯å†… | ä¼šè¯ç»“æŸæ¸…ç† | ä¸ç¼“å­˜ |

### 19.3 åŠ è½½ä¼˜åŒ–ç­–ç•¥

#### 19.3.1 åº”ç”¨å¯åŠ¨ä¼˜åŒ–

```dart
/// åº”ç”¨å¯åŠ¨ä¼˜åŒ–å™¨
class AppStartupOptimizer {
  /// åˆ†é˜¶æ®µå¯åŠ¨
  Future<void> optimizedStartup() async {
    // é˜¶æ®µ1: æœ€å°åŒ–å¯åŠ¨ï¼ˆ<500msï¼‰
    await _minimalStartup();

    // é˜¶æ®µ2: æ˜¾ç¤ºéª¨æ¶å±ï¼Œç»§ç»­åå°åŠ è½½
    _showSkeletonScreen();

    // é˜¶æ®µ3: å¹¶è¡ŒåŠ è½½æ ¸å¿ƒæ•°æ®
    await _parallelLoadCoreData();

    // é˜¶æ®µ4: å»¶è¿ŸåŠ è½½éæ ¸å¿ƒæ¨¡å—
    _deferredLoadModules();
  }

  /// é˜¶æ®µ1: æœ€å°åŒ–å¯åŠ¨
  Future<void> _minimalStartup() async {
    // åªåˆå§‹åŒ–å¿…è¦æœåŠ¡
    await Future.wait([
      DatabaseService.instance.initialize(),  // æ•°æ®åº“
      SharedPreferences.getInstance(),        // é…ç½®
      _initializeLogging(),                   // æ—¥å¿—
    ]);
  }

  /// é˜¶æ®µ3: å¹¶è¡ŒåŠ è½½æ ¸å¿ƒæ•°æ®
  Future<void> _parallelLoadCoreData() async {
    await Future.wait([
      _loadUserInfo(),
      _loadAccountList(),
      _loadCategoryList(),
      _loadCurrentBudget(),
      _warmUpCache(),
    ]);
  }

  /// é˜¶æ®µ4: å»¶è¿ŸåŠ è½½éæ ¸å¿ƒæ¨¡å—
  void _deferredLoadModules() {
    // é¦–å±æ¸²æŸ“åå»¶è¿Ÿ500msåŠ è½½
    Future.delayed(Duration(milliseconds: 500), () async {
      await Future.wait([
        _initializeAIService(),      // AIæœåŠ¡
        _initializeSyncService(),    // åŒæ­¥æœåŠ¡
        _initializeNotifications(),  // é€šçŸ¥æœåŠ¡
        _preloadCommonScreens(),     // é¢„åŠ è½½å¸¸ç”¨é¡µé¢
      ]);
    });
  }
}

/// å¯åŠ¨æ€§èƒ½è¿½è¸ª
class StartupPerformanceTracker {
  final Stopwatch _totalStopwatch = Stopwatch();
  final Map<String, Duration> _phaseTimings = {};

  void startTracking() {
    _totalStopwatch.start();
  }

  void markPhase(String phaseName) {
    _phaseTimings[phaseName] = _totalStopwatch.elapsed;
  }

  void endTracking() {
    _totalStopwatch.stop();
    _reportMetrics();
  }

  void _reportMetrics() {
    final metrics = PerformanceMetrics(
      coldStartTime: _totalStopwatch.elapsed,
      phaseTimings: _phaseTimings,
    );
    ObservabilityService().metrics.recordStartup(metrics);
  }
}
```

#### 19.3.2 é¡µé¢åŠ è½½ä¼˜åŒ–

```dart
/// é¡µé¢æ‡’åŠ è½½æ··å…¥
mixin LazyLoadingMixin<T extends StatefulWidget> on State<T> {
  bool _isFirstBuild = true;
  final List<Future<void>> _deferredTasks = [];

  @override
  void initState() {
    super.initState();
    // é¦–å¸§æ¸²æŸ“åæ‰§è¡Œå»¶è¿Ÿä»»åŠ¡
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _executeDeferredTasks();
    });
  }

  /// æ·»åŠ å»¶è¿Ÿä»»åŠ¡
  void deferTask(Future<void> Function() task) {
    _deferredTasks.add(Future(task));
  }

  void _executeDeferredTasks() async {
    for (final task in _deferredTasks) {
      await task;
    }
  }

  /// é¦–æ¬¡æ„å»ºæ—¶æ˜¾ç¤ºéª¨æ¶å±
  Widget buildWithSkeleton({
    required Widget Function() builder,
    required Widget skeleton,
  }) {
    if (_isFirstBuild) {
      _isFirstBuild = false;
      // å»¶è¿Ÿä¸€å¸§åé‡å»º
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted) setState(() {});
      });
      return skeleton;
    }
    return builder();
  }
}

/// åˆ—è¡¨è™šæ‹ŸåŒ–
class VirtualizedListView extends StatelessWidget {
  final int itemCount;
  final double itemExtent;
  final Widget Function(BuildContext, int) itemBuilder;

  const VirtualizedListView({
    required this.itemCount,
    required this.itemExtent,
    required this.itemBuilder,
  });

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: itemCount,
      itemExtent: itemExtent,  // å›ºå®šé«˜åº¦ï¼Œä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
      cacheExtent: itemExtent * 5,  // é¢„æ¸²æŸ“5ä¸ªitem
      itemBuilder: (context, index) {
        return RepaintBoundary(  // éš”ç¦»é‡ç»˜
          child: itemBuilder(context, index),
        );
      },
    );
  }
}

/// å›¾ç‰‡æ‡’åŠ è½½
class LazyImage extends StatelessWidget {
  final String url;
  final double? width;
  final double? height;
  final Widget placeholder;

  const LazyImage({
    required this.url,
    this.width,
    this.height,
    this.placeholder = const SizedBox(),
  });

  @override
  Widget build(BuildContext context) {
    return Image.network(
      url,
      width: width,
      height: height,
      fit: BoxFit.cover,
      loadingBuilder: (context, child, loadingProgress) {
        if (loadingProgress == null) return child;
        return placeholder;
      },
      errorBuilder: (context, error, stackTrace) {
        return Icon(Icons.broken_image, size: width ?? 48);
      },
      // å¯ç”¨ç¼“å­˜
      cacheWidth: width?.toInt(),
      cacheHeight: height?.toInt(),
    );
  }
}
```

#### 19.3.3 æ•°æ®é¢„åŠ è½½ç­–ç•¥

```dart
/// æ•°æ®é¢„åŠ è½½æœåŠ¡
class DataPreloadService {
  /// åŸºäºç”¨æˆ·è¡Œä¸ºçš„é¢„æµ‹æ€§é¢„åŠ è½½
  Future<void> predictivePreload(String currentPage) async {
    final nextPages = _predictNextPages(currentPage);

    for (final page in nextPages) {
      _preloadPageData(page);
    }
  }

  /// é¢„æµ‹ä¸‹ä¸€ä¸ªå¯èƒ½è®¿é—®çš„é¡µé¢
  List<String> _predictNextPages(String currentPage) {
    // åŸºäºå†å²è¡Œä¸ºæ•°æ®é¢„æµ‹
    const pageTransitions = {
      'home': ['add_transaction', 'budget', 'statistics'],
      'add_transaction': ['home', 'category_select'],
      'budget': ['budget_detail', 'home'],
      'statistics': ['transaction_list', 'category_detail'],
    };
    return pageTransitions[currentPage] ?? [];
  }

  /// é¢„åŠ è½½é¡µé¢æ•°æ®
  Future<void> _preloadPageData(String page) async {
    switch (page) {
      case 'add_transaction':
        await _preloadTransactionData();
        break;
      case 'budget':
        await _preloadBudgetData();
        break;
      case 'statistics':
        await _preloadStatisticsData();
        break;
    }
  }

  Future<void> _preloadTransactionData() async {
    await Future.wait([
      CacheManager().get('category_list'),
      CacheManager().get('account_list'),
      CacheManager().get('recent_merchants'),
    ]);
  }

  Future<void> _preloadBudgetData() async {
    await Future.wait([
      CacheManager().get('current_month_budget'),
      CacheManager().get('piggy_banks'),
    ]);
  }

  Future<void> _preloadStatisticsData() async {
    await Future.wait([
      CacheManager().get('monthly_summary'),
      CacheManager().get('category_stats'),
    ]);
  }
}
```

### 19.4 è®¡ç®—ä¼˜åŒ–ç­–ç•¥

#### 19.4.1 é’±é¾„è®¡ç®—ä¼˜åŒ–

```dart
/// é’±é¾„è®¡ç®—ä¼˜åŒ–å™¨
class MoneyAgeCalculationOptimizer {
  final Database _db;
  final CacheManager _cache;

  /// å¢é‡è®¡ç®—é’±é¾„ï¼ˆåªé‡ç®—å—å½±å“çš„éƒ¨åˆ†ï¼‰
  Future<MoneyAgeResult> calculateIncremental({
    required String? lastAffectedTransactionId,
  }) async {
    // 1. æ£€æŸ¥ç¼“å­˜
    final cached = await _cache.get<MoneyAgeResult>('money_age_current');
    if (cached != null && lastAffectedTransactionId == null) {
      return cached;
    }

    // 2. ç¡®å®šéœ€è¦é‡ç®—çš„èŒƒå›´
    final recalculateFrom = await _findRecalculateStartPoint(
      lastAffectedTransactionId,
    );

    // 3. å¢é‡è®¡ç®—
    final result = await _incrementalCalculate(recalculateFrom);

    // 4. æ›´æ–°ç¼“å­˜
    await _cache.set('money_age_current', result, ttl: Duration(minutes: 5));

    return result;
  }

  /// æ‰¹é‡FIFOæ¶ˆè´¹ï¼ˆä¼˜åŒ–æ•°æ®åº“æ“ä½œï¼‰
  Future<List<ResourceConsumption>> batchConsume({
    required List<Transaction> transactions,
  }) async {
    final consumptions = <ResourceConsumption>[];

    // ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å¤„ç†
    await _db.transaction((txn) async {
      // 1. ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰æœ‰ä½™é¢çš„èµ„æºæ± 
      final pools = await txn.query(
        'resource_pools',
        where: 'remaining_amount > 0',
        orderBy: 'created_at ASC',
      );

      // 2. åœ¨å†…å­˜ä¸­è®¡ç®—æ¶ˆè´¹åˆ†é…
      var poolIndex = 0;
      for (final transaction in transactions) {
        var remaining = transaction.amount;

        while (remaining > 0 && poolIndex < pools.length) {
          final pool = pools[poolIndex];
          final poolRemaining = pool['remaining_amount'] as double;
          final consumeAmount = min(remaining, poolRemaining);

          consumptions.add(ResourceConsumption(
            poolId: pool['id'] as String,
            transactionId: transaction.id,
            amount: consumeAmount,
            ageAtConsumption: _calculateAge(pool, transaction.date),
          ));

          // æ›´æ–°æ± ä½™é¢ï¼ˆå†…å­˜ä¸­ï¼‰
          pool['remaining_amount'] = poolRemaining - consumeAmount;
          remaining -= consumeAmount;

          if (pool['remaining_amount'] <= 0) {
            poolIndex++;
          }
        }
      }

      // 3. æ‰¹é‡å†™å…¥æ•°æ®åº“
      final batch = txn.batch();
      for (final consumption in consumptions) {
        batch.insert('resource_consumptions', consumption.toMap());
      }

      // 4. æ‰¹é‡æ›´æ–°èµ„æºæ± 
      for (final pool in pools) {
        batch.update(
          'resource_pools',
          {'remaining_amount': pool['remaining_amount']},
          where: 'id = ?',
          whereArgs: [pool['id']],
        );
      }

      await batch.commit(noResult: true);
    });

    return consumptions;
  }
}
```

#### 19.4.2 æŠ¥è¡¨èšåˆä¼˜åŒ–

```dart
/// æŠ¥è¡¨é¢„èšåˆæœåŠ¡
class ReportAggregationService {
  final Database _db;

  /// é¢„èšåˆè¡¨ç»“æ„
  static const String createAggregationTables = '''
    -- æ—¥èšåˆè¡¨
    CREATE TABLE IF NOT EXISTS daily_aggregations (
      date TEXT PRIMARY KEY,
      total_income REAL NOT NULL DEFAULT 0,
      total_expense REAL NOT NULL DEFAULT 0,
      transaction_count INTEGER NOT NULL DEFAULT 0,
      category_breakdown TEXT,  -- JSON
      updated_at TEXT NOT NULL
    );

    -- æœˆèšåˆè¡¨
    CREATE TABLE IF NOT EXISTS monthly_aggregations (
      year_month TEXT PRIMARY KEY,
      total_income REAL NOT NULL DEFAULT 0,
      total_expense REAL NOT NULL DEFAULT 0,
      transaction_count INTEGER NOT NULL DEFAULT 0,
      category_breakdown TEXT,
      daily_averages TEXT,
      updated_at TEXT NOT NULL
    );

    -- åˆ›å»ºæ›´æ–°è§¦å‘å™¨
    CREATE TRIGGER IF NOT EXISTS trg_update_daily_agg
    AFTER INSERT ON transactions
    BEGIN
      INSERT OR REPLACE INTO daily_aggregations (date, total_income, total_expense, transaction_count, updated_at)
      SELECT
        date(NEW.transaction_date),
        COALESCE(SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END), 0),
        COALESCE(SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END), 0),
        COUNT(*),
        datetime('now')
      FROM transactions
      WHERE date(transaction_date) = date(NEW.transaction_date);
    END;
  ''';

  /// è·å–æœˆåº¦æŠ¥è¡¨ï¼ˆä»é¢„èšåˆè¡¨ï¼‰
  Future<MonthlyReport> getMonthlyReport(int year, int month) async {
    final yearMonth = '$year-${month.toString().padLeft(2, '0')}';

    // 1. ä¼˜å…ˆä»é¢„èšåˆè¡¨è·å–
    final agg = await _db.query(
      'monthly_aggregations',
      where: 'year_month = ?',
      whereArgs: [yearMonth],
    );

    if (agg.isNotEmpty) {
      return MonthlyReport.fromAggregation(agg.first);
    }

    // 2. é™çº§åˆ°å®æ—¶è®¡ç®—å¹¶ç¼“å­˜
    final report = await _calculateMonthlyReport(year, month);
    await _saveMonthlyAggregation(yearMonth, report);
    return report;
  }

  /// å¢é‡æ›´æ–°èšåˆæ•°æ®
  Future<void> updateAggregations(Transaction transaction) async {
    final date = transaction.transactionDate;
    final yearMonth = '${date.year}-${date.month.toString().padLeft(2, '0')}';

    // 1. æ›´æ–°æ—¥èšåˆ
    await _updateDailyAggregation(date);

    // 2. æ›´æ–°æœˆèšåˆ
    await _updateMonthlyAggregation(yearMonth);
  }
}
```

#### 19.4.3 å¼‚æ­¥è®¡ç®—ä¸éš”ç¦»

```dart
/// è®¡ç®—éš”ç¦»æœåŠ¡ï¼ˆä½¿ç”¨Isolateå¤„ç†CPUå¯†é›†ä»»åŠ¡ï¼‰
class ComputeIsolateService {
  /// åœ¨éš”ç¦»ä¸­æ‰§è¡Œé’±é¾„è®¡ç®—
  static Future<MoneyAgeResult> computeMoneyAgeInIsolate(
    MoneyAgeInput input,
  ) async {
    return await compute(_calculateMoneyAgeIsolated, input);
  }

  static MoneyAgeResult _calculateMoneyAgeIsolated(MoneyAgeInput input) {
    // åœ¨éš”ç¦»ä¸­æ‰§è¡ŒCPUå¯†é›†è®¡ç®—
    final pools = input.resourcePools;
    final transactions = input.transactions;

    var totalAge = 0.0;
    var totalAmount = 0.0;

    for (final pool in pools) {
      if (pool.remainingAmount > 0) {
        final age = DateTime.now().difference(pool.createdAt).inDays;
        totalAge += pool.remainingAmount * age;
        totalAmount += pool.remainingAmount;
      }
    }

    return MoneyAgeResult(
      averageAge: totalAmount > 0 ? totalAge / totalAmount : 0,
      totalAssets: totalAmount,
      distribution: _calculateDistribution(pools),
    );
  }

  /// åœ¨éš”ç¦»ä¸­æ‰§è¡ŒæŠ¥è¡¨è®¡ç®—
  static Future<ReportData> computeReportInIsolate(
    ReportInput input,
  ) async {
    return await compute(_calculateReportIsolated, input);
  }

  static ReportData _calculateReportIsolated(ReportInput input) {
    // å¤æ‚æŠ¥è¡¨è®¡ç®—
    final transactions = input.transactions;

    // åˆ†ç±»èšåˆ
    final categoryTotals = <String, double>{};
    // è¶‹åŠ¿è®¡ç®—
    final dailyTotals = <DateTime, double>{};
    // å•†å®¶æ’å
    final merchantTotals = <String, double>{};

    for (final txn in transactions) {
      categoryTotals.update(
        txn.categoryId,
        (v) => v + txn.amount,
        ifAbsent: () => txn.amount,
      );
      // ... æ›´å¤šè®¡ç®—
    }

    return ReportData(
      categoryBreakdown: categoryTotals,
      dailyTrend: dailyTotals,
      topMerchants: merchantTotals,
    );
  }
}
```

### 19.5 ç½‘ç»œä¼˜åŒ–ç­–ç•¥

#### 19.5.1 è¯·æ±‚åˆå¹¶ä¸æ‰¹å¤„ç†

```dart
/// APIè¯·æ±‚æ‰¹å¤„ç†å™¨
class APIBatchProcessor {
  final Map<String, List<_PendingRequest>> _pendingRequests = {};
  final Duration _batchWindow;
  Timer? _batchTimer;

  APIBatchProcessor({
    Duration batchWindow = const Duration(milliseconds: 50),
  }) : _batchWindow = batchWindow;

  /// æ·»åŠ è¯·æ±‚åˆ°æ‰¹å¤„ç†é˜Ÿåˆ—
  Future<T> enqueue<T>(
    String batchKey,
    String endpoint,
    Map<String, dynamic> params,
  ) async {
    final completer = Completer<T>();

    _pendingRequests.putIfAbsent(batchKey, () => []).add(
      _PendingRequest(
        endpoint: endpoint,
        params: params,
        completer: completer,
      ),
    );

    // å¯åŠ¨æ‰¹å¤„ç†å®šæ—¶å™¨
    _batchTimer ??= Timer(_batchWindow, _processBatch);

    return completer.future;
  }

  void _processBatch() {
    _batchTimer = null;

    for (final entry in _pendingRequests.entries) {
      final requests = entry.value;
      if (requests.isEmpty) continue;

      // åˆå¹¶è¯·æ±‚
      _executeBatchRequest(entry.key, requests);
    }

    _pendingRequests.clear();
  }

  Future<void> _executeBatchRequest(
    String batchKey,
    List<_PendingRequest> requests,
  ) async {
    try {
      // å‘é€æ‰¹é‡è¯·æ±‚
      final response = await _httpClient.post(
        '/api/batch',
        data: {
          'batch_key': batchKey,
          'requests': requests.map((r) => {
            'endpoint': r.endpoint,
            'params': r.params,
          }).toList(),
        },
      );

      // åˆ†å‘å“åº”
      final results = response.data['results'] as List;
      for (var i = 0; i < requests.length; i++) {
        requests[i].completer.complete(results[i]);
      }
    } catch (e) {
      // é”™è¯¯æ—¶æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥
      for (final request in requests) {
        request.completer.completeError(e);
      }
    }
  }
}
```

#### 19.5.2 ç¦»çº¿ä¼˜å…ˆä¸é™çº§ç­–ç•¥

```dart
/// ç¦»çº¿ä¼˜å…ˆè¯·æ±‚ç­–ç•¥
class OfflineFirstStrategy {
  final CacheManager _cache;
  final HttpClient _http;
  final ConnectivityService _connectivity;

  /// ç¦»çº¿ä¼˜å…ˆè¯·æ±‚
  Future<T> request<T>(
    String endpoint, {
    required String cacheKey,
    required T Function(dynamic) parser,
    Duration? cacheTTL,
    bool forceNetwork = false,
  }) async {
    // 1. éå¼ºåˆ¶ç½‘ç»œæ—¶ï¼Œå…ˆå°è¯•ç¼“å­˜
    if (!forceNetwork) {
      final cached = await _cache.get<T>(cacheKey);
      if (cached != null) {
        // åå°é™é»˜åˆ·æ–°
        _backgroundRefresh(endpoint, cacheKey, parser, cacheTTL);
        return cached;
      }
    }

    // 2. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    final isOnline = await _connectivity.isConnected;
    if (!isOnline) {
      // ç¦»çº¿æ—¶è¿”å›ç¼“å­˜æˆ–æŠ›å‡ºå¼‚å¸¸
      final cached = await _cache.get<T>(cacheKey);
      if (cached != null) return cached;
      throw OfflineException('æ— ç½‘ç»œè¿æ¥ï¼Œè¯·ç¨åé‡è¯•');
    }

    // 3. ç½‘ç»œè¯·æ±‚
    try {
      final response = await _http.get(endpoint);
      final data = parser(response.data);

      // 4. æ›´æ–°ç¼“å­˜
      await _cache.set(cacheKey, data, ttl: cacheTTL);

      return data;
    } catch (e) {
      // ç½‘ç»œå¤±è´¥æ—¶é™çº§åˆ°ç¼“å­˜
      final cached = await _cache.get<T>(cacheKey);
      if (cached != null) return cached;
      rethrow;
    }
  }

  /// åå°é™é»˜åˆ·æ–°
  void _backgroundRefresh<T>(
    String endpoint,
    String cacheKey,
    T Function(dynamic) parser,
    Duration? cacheTTL,
  ) {
    Future.microtask(() async {
      try {
        final response = await _http.get(endpoint);
        final data = parser(response.data);
        await _cache.set(cacheKey, data, ttl: cacheTTL);
      } catch (e) {
        // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·
        debugPrint('Background refresh failed: $e');
      }
    });
  }
}

/// AIæœåŠ¡é™çº§ç­–ç•¥
class AIServiceDegradeStrategy {
  /// å¸¦é™çº§çš„AIè°ƒç”¨
  Future<T> callWithDegrade<T>({
    required Future<T> Function() primaryCall,
    required Future<T> Function() fallbackCall,
    required T Function() localFallback,
    Duration timeout = const Duration(seconds: 5),
  }) async {
    try {
      // 1. å°è¯•ä¸»è¦è°ƒç”¨ï¼ˆå¸¦è¶…æ—¶ï¼‰
      return await primaryCall().timeout(timeout);
    } catch (e) {
      debugPrint('Primary AI call failed: $e');

      try {
        // 2. å°è¯•å¤‡ç”¨è°ƒç”¨
        return await fallbackCall().timeout(timeout);
      } catch (e) {
        debugPrint('Fallback AI call failed: $e');

        // 3. æœ¬åœ°å…œåº•
        return localFallback();
      }
    }
  }
}
```

### 19.6 æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥

#### 19.6.1 å›¾è¡¨æ¸²æŸ“ä¼˜åŒ–

```dart
/// å›¾è¡¨æ¸²æŸ“ä¼˜åŒ–å™¨
class ChartRenderOptimizer {
  /// æ•°æ®é‡‡æ ·ï¼ˆå¤§æ•°æ®é‡æ—¶é™é‡‡æ ·ï¼‰
  List<ChartDataPoint> sampleData(
    List<ChartDataPoint> data, {
    int maxPoints = 100,
  }) {
    if (data.length <= maxPoints) return data;

    final step = data.length / maxPoints;
    final sampled = <ChartDataPoint>[];

    for (var i = 0; i < data.length; i += step.ceil()) {
      // LTTBç®—æ³•ï¼šä¿ç•™è§†è§‰ç‰¹å¾çš„é™é‡‡æ ·
      sampled.add(_selectRepresentativePoint(
        data,
        i,
        min(i + step.ceil(), data.length),
      ));
    }

    return sampled;
  }

  /// åˆ†å—æ¸²æŸ“ï¼ˆé˜²æ­¢é•¿æ—¶é—´é˜»å¡ï¼‰
  Stream<List<ChartDataPoint>> chunkedRender(
    List<ChartDataPoint> data, {
    int chunkSize = 50,
  }) async* {
    for (var i = 0; i < data.length; i += chunkSize) {
      yield data.sublist(i, min(i + chunkSize, data.length));
      // è®©å‡ºæ‰§è¡Œæƒï¼Œé¿å…å¡é¡¿
      await Future.delayed(Duration.zero);
    }
  }
}

/// é«˜æ€§èƒ½å›¾è¡¨ç»„ä»¶
class PerformantChart extends StatelessWidget {
  final List<ChartDataPoint> data;
  final ChartType type;

  const PerformantChart({
    required this.data,
    required this.type,
  });

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(  // éš”ç¦»é‡ç»˜åŒºåŸŸ
      child: CustomPaint(
        painter: _ChartPainter(
          data: ChartRenderOptimizer().sampleData(data),
          type: type,
        ),
        willChange: false,  // é™æ€å†…å®¹ä¼˜åŒ–
        isComplex: true,    // å¯ç”¨ç¼“å­˜
      ),
    );
  }
}
```

#### 19.6.2 åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–

```dart
/// é«˜æ€§èƒ½åˆ—è¡¨ç»„ä»¶
class PerformantListView<T> extends StatelessWidget {
  final List<T> items;
  final Widget Function(BuildContext, T, int) itemBuilder;
  final double? itemExtent;
  final bool separatorEnabled;

  const PerformantListView({
    required this.items,
    required this.itemBuilder,
    this.itemExtent,
    this.separatorEnabled = true,
  });

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: separatorEnabled ? items.length * 2 - 1 : items.length,
      itemExtent: itemExtent,
      cacheExtent: 500,  // é¢„æ¸²æŸ“åŒºåŸŸ
      addAutomaticKeepAlives: false,  // ç¦ç”¨è‡ªåŠ¨ä¿æ´»
      addRepaintBoundaries: true,     // å¯ç”¨é‡ç»˜è¾¹ç•Œ
      itemBuilder: (context, index) {
        if (separatorEnabled && index.isOdd) {
          return const Divider(height: 1);
        }
        final itemIndex = separatorEnabled ? index ~/ 2 : index;
        return RepaintBoundary(
          child: itemBuilder(context, items[itemIndex], itemIndex),
        );
      },
    );
  }
}

/// æ— é™æ»šåŠ¨åˆ—è¡¨
class InfiniteScrollList<T> extends StatefulWidget {
  final Future<List<T>> Function(int page, int pageSize) loadMore;
  final Widget Function(BuildContext, T) itemBuilder;
  final int pageSize;

  const InfiniteScrollList({
    required this.loadMore,
    required this.itemBuilder,
    this.pageSize = 20,
  });

  @override
  State<InfiniteScrollList<T>> createState() => _InfiniteScrollListState<T>();
}

class _InfiniteScrollListState<T> extends State<InfiniteScrollList<T>> {
  final List<T> _items = [];
  int _currentPage = 0;
  bool _isLoading = false;
  bool _hasMore = true;

  @override
  Widget build(BuildContext context) {
    return NotificationListener<ScrollNotification>(
      onNotification: (notification) {
        if (notification is ScrollEndNotification) {
          final metrics = notification.metrics;
          if (metrics.pixels >= metrics.maxScrollExtent - 200) {
            _loadNextPage();
          }
        }
        return false;
      },
      child: ListView.builder(
        itemCount: _items.length + (_hasMore ? 1 : 0),
        itemBuilder: (context, index) {
          if (index >= _items.length) {
            return _buildLoadingIndicator();
          }
          return widget.itemBuilder(context, _items[index]);
        },
      ),
    );
  }

  Future<void> _loadNextPage() async {
    if (_isLoading || !_hasMore) return;

    setState(() => _isLoading = true);

    try {
      final newItems = await widget.loadMore(_currentPage, widget.pageSize);
      setState(() {
        _items.addAll(newItems);
        _currentPage++;
        _hasMore = newItems.length >= widget.pageSize;
        _isLoading = false;
      });
    } catch (e) {
      setState(() => _isLoading = false);
    }
  }
}
```

### 19.7 æ€§èƒ½ç›‘æ§ä¸å‘Šè­¦

#### 19.7.1 æ€§èƒ½ç›‘æ§é›†æˆ

```dart
/// æ€§èƒ½ç›‘æ§æœåŠ¡ï¼ˆä¸ç¬¬5ç« å¯è§‚æµ‹æ€§é›†æˆï¼‰
class PerformanceMonitoringService {
  final ObservabilityService _observability;

  /// ç›‘æ§é…ç½®
  static const performanceThresholds = {
    'cold_start': Duration(seconds: 2),
    'page_load': Duration(milliseconds: 500),
    'api_response': Duration(milliseconds: 500),
    'frame_rate': 55.0,  // fps
    'memory_usage': 200 * 1024 * 1024,  // 200MB
  };

  /// å¯åŠ¨æ€§èƒ½ç›‘æ§
  void startMonitoring() {
    // 1. å¸§ç‡ç›‘æ§
    SchedulerBinding.instance.addTimingsCallback(_onFrameTimings);

    // 2. å†…å­˜ç›‘æ§ï¼ˆå®šæœŸé‡‡æ ·ï¼‰
    Timer.periodic(Duration(seconds: 30), (_) => _recordMemoryUsage());

    // 3. é¡µé¢æ€§èƒ½ç›‘æ§
    NavigatorObserverManager.addObserver(_pagePerformanceObserver);
  }

  /// å¸§ç‡å›è°ƒ
  void _onFrameTimings(List<FrameTiming> timings) {
    for (final timing in timings) {
      final buildDuration = timing.buildDuration;
      final rasterDuration = timing.rasterDuration;
      final totalDuration = buildDuration + rasterDuration;

      // è®°å½•å¸§è€—æ—¶
      _observability.metrics.recordFrameTime(
        buildMs: buildDuration.inMilliseconds,
        rasterMs: rasterDuration.inMilliseconds,
        totalMs: totalDuration.inMilliseconds,
      );

      // æ£€æµ‹å¡é¡¿å¸§ï¼ˆ>16.67msï¼‰
      if (totalDuration.inMilliseconds > 16) {
        _observability.logger.warning(
          'Jank frame detected',
          context: {
            'build_ms': buildDuration.inMilliseconds,
            'raster_ms': rasterDuration.inMilliseconds,
          },
        );
      }
    }
  }

  /// å†…å­˜ä½¿ç”¨è®°å½•
  void _recordMemoryUsage() {
    final usage = ProcessInfo.currentRss;
    _observability.metrics.recordMemory(usage);

    // å†…å­˜å‘Šè­¦
    if (usage > performanceThresholds['memory_usage']!) {
      _observability.logger.warning(
        'High memory usage',
        context: {'usage_mb': usage ~/ (1024 * 1024)},
      );
    }
  }
}

/// æ€§èƒ½å‘Šè­¦è§„åˆ™
class PerformanceAlertRules {
  static const rules = [
    AlertRule(
      name: 'high_cold_start',
      metric: 'cold_start_time',
      condition: '>2000ms',
      severity: AlertSeverity.warning,
      message: 'åº”ç”¨å†·å¯åŠ¨æ—¶é—´è¶…è¿‡2ç§’',
    ),
    AlertRule(
      name: 'low_frame_rate',
      metric: 'avg_frame_rate',
      condition: '<55fps',
      duration: Duration(seconds: 10),
      severity: AlertSeverity.warning,
      message: 'åº”ç”¨å¸§ç‡æŒç»­ä½äº55fps',
    ),
    AlertRule(
      name: 'high_memory',
      metric: 'memory_usage',
      condition: '>200MB',
      duration: Duration(minutes: 1),
      severity: AlertSeverity.warning,
      message: 'åº”ç”¨å†…å­˜å ç”¨è¶…è¿‡200MB',
    ),
    AlertRule(
      name: 'slow_api',
      metric: 'api_response_p95',
      condition: '>1000ms',
      severity: AlertSeverity.warning,
      message: 'APIå“åº”P95è¶…è¿‡1ç§’',
    ),
    AlertRule(
      name: 'crash_rate_high',
      metric: 'crash_rate',
      condition: '>0.1%',
      severity: AlertSeverity.critical,
      message: 'å´©æºƒç‡è¶…è¿‡0.1%',
    ),
  ];
}
```

#### 19.7.2 æ€§èƒ½æŠ¥å‘Š

```dart
/// æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå™¨
class PerformanceReportGenerator {
  /// ç”Ÿæˆæ—¥æŠ¥
  Future<PerformanceReport> generateDailyReport(DateTime date) async {
    final metrics = await _fetchMetrics(date);

    return PerformanceReport(
      date: date,
      summary: PerformanceSummary(
        avgColdStartTime: metrics.avgColdStartTime,
        avgPageLoadTime: metrics.avgPageLoadTime,
        avgFrameRate: metrics.avgFrameRate,
        avgMemoryUsage: metrics.avgMemoryUsage,
        crashRate: metrics.crashRate,
        apiSuccessRate: metrics.apiSuccessRate,
      ),
      trends: PerformanceTrends(
        coldStartTrend: _calculateTrend(metrics.coldStartHistory),
        frameRateTrend: _calculateTrend(metrics.frameRateHistory),
        memoryTrend: _calculateTrend(metrics.memoryHistory),
      ),
      anomalies: _detectAnomalies(metrics),
      recommendations: _generateRecommendations(metrics),
    );
  }

  /// æ€§èƒ½è¯„åˆ†
  int calculatePerformanceScore(PerformanceSummary summary) {
    var score = 100;

    // å¯åŠ¨æ€§èƒ½ï¼ˆ30åˆ†ï¼‰
    if (summary.avgColdStartTime > Duration(seconds: 3)) {
      score -= 30;
    } else if (summary.avgColdStartTime > Duration(seconds: 2)) {
      score -= 15;
    }

    // æµç•…åº¦ï¼ˆ30åˆ†ï¼‰
    if (summary.avgFrameRate < 50) {
      score -= 30;
    } else if (summary.avgFrameRate < 55) {
      score -= 15;
    }

    // ç¨³å®šæ€§ï¼ˆ20åˆ†ï¼‰
    if (summary.crashRate > 0.5) {
      score -= 20;
    } else if (summary.crashRate > 0.1) {
      score -= 10;
    }

    // APIæ€§èƒ½ï¼ˆ20åˆ†ï¼‰
    if (summary.apiSuccessRate < 95) {
      score -= 20;
    } else if (summary.apiSuccessRate < 99) {
      score -= 10;
    }

    return score.clamp(0, 100);
  }
}
```

### 19.8 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

#### 19.8.1 å¼€å‘é˜¶æ®µæ£€æŸ¥

| æ£€æŸ¥é¡¹ | æ£€æŸ¥å†…å®¹ | é€šè¿‡æ ‡å‡† |
|-------|---------|---------|
| **å¯åŠ¨ä¼˜åŒ–** | æ˜¯å¦ä½¿ç”¨åˆ†é˜¶æ®µå¯åŠ¨ | å†·å¯åŠ¨<2ç§’ |
| **ç¼“å­˜ä½¿ç”¨** | æ˜¯å¦åˆç†ä½¿ç”¨å¤šçº§ç¼“å­˜ | ç¼“å­˜å‘½ä¸­ç‡>80% |
| **åˆ—è¡¨ä¼˜åŒ–** | æ˜¯å¦ä½¿ç”¨è™šæ‹ŸåŒ–åˆ—è¡¨ | æ»šåŠ¨60fps |
| **å›¾ç‰‡ä¼˜åŒ–** | æ˜¯å¦å‹ç¼©å’Œæ‡’åŠ è½½ | æ— æ˜æ˜¾åŠ è½½å»¶è¿Ÿ |
| **ç½‘ç»œä¼˜åŒ–** | æ˜¯å¦ä½¿ç”¨è¯·æ±‚åˆå¹¶ | å‡å°‘è¯·æ±‚æ•°>30% |
| **å†…å­˜ç®¡ç†** | æ˜¯å¦åŠæ—¶é‡Šæ”¾èµ„æº | æ— å†…å­˜æ³„æ¼ |
| **å¼‚æ­¥å¤„ç†** | è€—æ—¶æ“ä½œæ˜¯å¦å¼‚æ­¥ | æ— ä¸»çº¿ç¨‹é˜»å¡ |
| **é‡ç»˜ä¼˜åŒ–** | æ˜¯å¦éš”ç¦»é‡ç»˜åŒºåŸŸ | æ— ä¸å¿…è¦é‡ç»˜ |

#### 19.8.2 å‘å¸ƒå‰æ€§èƒ½æµ‹è¯•

```dart
/// æ€§èƒ½æµ‹è¯•å¥—ä»¶
class PerformanceTestSuite {
  /// å¯åŠ¨æ€§èƒ½æµ‹è¯•
  Future<StartupTestResult> testStartupPerformance() async {
    final results = <Duration>[];

    for (var i = 0; i < 5; i++) {
      await _killApp();
      final duration = await _measureColdStart();
      results.add(duration);
    }

    return StartupTestResult(
      coldStartTimes: results,
      average: results.reduce((a, b) => a + b) ~/ results.length,
      passed: results.every((d) => d < Duration(seconds: 2)),
    );
  }

  /// é¡µé¢åŠ è½½æµ‹è¯•
  Future<PageLoadTestResult> testPageLoads() async {
    final pages = ['home', 'add_transaction', 'budget', 'statistics', 'settings'];
    final results = <String, Duration>{};

    for (final page in pages) {
      final duration = await _measurePageLoad(page);
      results[page] = duration;
    }

    return PageLoadTestResult(
      pageLoadTimes: results,
      passed: results.values.every((d) => d < Duration(milliseconds: 500)),
    );
  }

  /// æ»šåŠ¨æ€§èƒ½æµ‹è¯•
  Future<ScrollTestResult> testScrollPerformance() async {
    final frameRates = <double>[];

    await _navigateToTransactionList();
    await _startFrameRateMonitoring();
    await _performScroll(scrollCount: 50);
    frameRates.addAll(_stopFrameRateMonitoring());

    return ScrollTestResult(
      avgFrameRate: frameRates.reduce((a, b) => a + b) / frameRates.length,
      minFrameRate: frameRates.reduce(min),
      jankFrameCount: frameRates.where((f) => f < 55).length,
      passed: frameRates.every((f) => f >= 55),
    );
  }

  /// å†…å­˜å‹åŠ›æµ‹è¯•
  Future<MemoryTestResult> testMemoryUnderPressure() async {
    final initialMemory = _getCurrentMemory();

    // æ¨¡æ‹Ÿå¤§é‡æ“ä½œ
    for (var i = 0; i < 100; i++) {
      await _navigateRandomPage();
      await _performRandomAction();
    }

    final peakMemory = _getPeakMemory();
    final finalMemory = _getCurrentMemory();

    return MemoryTestResult(
      initialMemory: initialMemory,
      peakMemory: peakMemory,
      finalMemory: finalMemory,
      memoryLeaked: finalMemory - initialMemory > 50 * 1024 * 1024,
      passed: peakMemory < 200 * 1024 * 1024,
    );
  }
}
```

### 19.9 ä¸å…¶ä»–ç« èŠ‚çš„é›†æˆ

#### 19.9.1 æ€§èƒ½è®¾è®¡æ¨ªåˆ‡å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ€§èƒ½è®¾è®¡æ¨ªåˆ‡å…³ç³»å›¾                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                          ä¸šåŠ¡åŠŸèƒ½æ¨¡å—                                     â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚  â”‚ é’±é¾„ç³»ç»Ÿ â”‚  â”‚ é¢„ç®—ç³»ç»Ÿ â”‚  â”‚ ä¹ æƒ¯ç³»ç»Ÿ â”‚  â”‚ AIè¯†åˆ«  â”‚  â”‚ æŠ¥è¡¨ç³»ç»Ÿ â”‚       â”‚   â”‚
â”‚   â”‚  â”‚ <100ms  â”‚  â”‚ <50ms   â”‚  â”‚ <20ms   â”‚  â”‚ <5s     â”‚  â”‚ <1s     â”‚       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚            â”‚            â”‚            â”‚            â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     ç¬¬16ç«  æ€§èƒ½è®¾è®¡ä¸ä¼˜åŒ– æ¨ªåˆ‡                            â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚   â”‚   â”‚ å¤šçº§ç¼“å­˜æ¶æ„  â”‚  â”‚ è®¡ç®—ä¼˜åŒ–ç­–ç•¥  â”‚  â”‚ åŠ è½½ä¼˜åŒ–ç­–ç•¥  â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ L1å†…å­˜ç¼“å­˜  â”‚  â”‚ â€¢ å¢é‡è®¡ç®—   â”‚  â”‚ â€¢ åˆ†é˜¶æ®µå¯åŠ¨  â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ L2æœ¬åœ°DB   â”‚  â”‚ â€¢ æ‰¹é‡å¤„ç†   â”‚  â”‚ â€¢ æ‡’åŠ è½½     â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ L3è¿œç¨‹API  â”‚  â”‚ â€¢ å¼‚æ­¥éš”ç¦»   â”‚  â”‚ â€¢ é¢„åŠ è½½     â”‚                  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚   â”‚   â”‚ ç½‘ç»œä¼˜åŒ–ç­–ç•¥  â”‚  â”‚ æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥  â”‚  â”‚ æ€§èƒ½ç›‘æ§å‘Šè­¦  â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ è¯·æ±‚åˆå¹¶   â”‚  â”‚ â€¢ è™šæ‹Ÿåˆ—è¡¨   â”‚  â”‚ â€¢ å¸§ç‡ç›‘æ§   â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ ç¦»çº¿ä¼˜å…ˆ   â”‚  â”‚ â€¢ å›¾è¡¨é‡‡æ ·   â”‚  â”‚ â€¢ å†…å­˜ç›‘æ§   â”‚                  â”‚   â”‚
â”‚   â”‚   â”‚ â€¢ æ™ºèƒ½é™çº§   â”‚  â”‚ â€¢ é‡ç»˜éš”ç¦»   â”‚  â”‚ â€¢ æ€§èƒ½å‘Šè­¦   â”‚                  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚            â”‚            â”‚            â”‚            â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     æ”¯æ’‘å±‚                                               â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚   â”‚  â”‚ ç¬¬15ç«    â”‚  â”‚ ç¬¬23ç«    â”‚  â”‚ ç¬¬25ç«   â”‚  â”‚ æµ‹è¯•ç­–ç•¥  â”‚                â”‚   â”‚
â”‚   â”‚  â”‚ æŠ€æœ¯æ¶æ„ â”‚  â”‚ å¼‚å¸¸å¤„ç† â”‚  â”‚ å¯è§‚æµ‹æ€§ â”‚  â”‚ æ€§èƒ½æµ‹è¯•  â”‚                â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 19.9.2 ç« èŠ‚ä¾èµ–å…³ç³»

| æœ¬ç« å†…å®¹ | ä¾èµ–ç« èŠ‚ | ä¾èµ–å†…å®¹ |
|---------|---------|---------|
| ç¼“å­˜æ¶æ„è®¾è®¡ | ç¬¬15ç«  æŠ€æœ¯æ¶æ„ | æ•°æ®å­˜å‚¨å±‚è®¾è®¡ |
| é’±é¾„è®¡ç®—ä¼˜åŒ– | ç¬¬7ç«  é’±é¾„ç³»ç»Ÿ | FIFOè®¡ç®—é€»è¾‘ |
| æŠ¥è¡¨èšåˆä¼˜åŒ– | ç¬¬12ç«  æ•°æ®å¯è§†åŒ– | æŠ¥è¡¨æ•°æ®ç»“æ„ |
| AIæœåŠ¡é™çº§ | ç¬¬16ç«  æ™ºèƒ½åŒ–æ–¹æ¡ˆ | AIè°ƒç”¨ç­–ç•¥ |
| æ€§èƒ½ç›‘æ§ | ç¬¬25ç«  å¯è§‚æµ‹æ€§ | æŒ‡æ ‡é‡‡é›†ä½“ç³» |
| æ€§èƒ½æµ‹è¯• | æµ‹è¯•ç­–ç•¥æ–‡æ¡£ | æ€§èƒ½æµ‹è¯•æ–¹æ³• |



---


---

# ç¬¬äº”éƒ¨åˆ†ï¼šç”¨æˆ·ä½“éªŒè®¾è®¡

---

## 20. ç”¨æˆ·ä½“éªŒè®¾è®¡

### 20.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥ç”¨æˆ·ä½“éªŒè®¾è®¡ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·ä½“éªŒè®¾è®¡ - è®¾è®¡åŸåˆ™çŸ©é˜µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ‡’äººè®¾è®¡    â”‚  â”‚  ä¼™ä¼´åŒ–      â”‚  â”‚  æ¸¸æˆåŒ–      â”‚  â”‚  æƒ…æ„ŸåŒ–      â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ æœ€å°‘ï¿½ï¿½ä½œ    â”‚  â”‚ AIé™ªä¼´      â”‚  â”‚ æˆå°±æ¿€åŠ±    â”‚  â”‚ æ­£å‘åé¦ˆ    â”‚       â”‚
â”‚  â”‚ æ™ºèƒ½é»˜è®¤    â”‚  â”‚ ä¸»åŠ¨å…³æ€€    â”‚  â”‚ ç­‰çº§è¿›é˜¶    â”‚  â”‚ æƒ…ç»ªå…±é¸£    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æç®€äº¤äº’    â”‚  â”‚  æ™ºèƒ½å¼•å¯¼    â”‚  â”‚  è§†è§‰æ„‰æ‚¦    â”‚  â”‚  ä¿¡ä»»å»ºç«‹    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ å•æ‰‹æ“ä½œ    â”‚  â”‚ åœºæ™¯å»ºè®®    â”‚  â”‚ åŠ¨æ•ˆæµç•…    â”‚  â”‚ é€æ˜å¯æ§    â”‚       â”‚
â”‚  â”‚ æ‰‹åŠ¿ä¼˜å…ˆ    â”‚  â”‚ é¢„æµ‹è¾“å…¥    â”‚  â”‚ æ•°æ®å¯è§†    â”‚  â”‚ éšç§å®‰å¿ƒ    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  ç”¨æˆ·ä½“éªŒæ ¸å¿ƒç†å¿µï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "æˆé•¿ä¸ºä¸­å¿ƒï¼Œä¹ æƒ¯å…»æˆï¼Œæ„‰æ‚¦ä½“éªŒï¼Œä¿¡ä»»ç¬¬ä¸€"                            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   æˆé•¿ä¸ºä¸­å¿ƒ â”€â”€â†’ ä»"è®°å½•æ¶ˆè´¹"è½¬å‘"åŸ¹å…»è´¢åŠ¡ä¹ æƒ¯"                       â”‚   â”‚
â”‚  â”‚   ä¹ æƒ¯å…»æˆ   â”€â”€â†’ é’±é¾„å¯è§†åŒ–è®©ç”¨æˆ·ä¸»åŠ¨æ‰“å¼€APP                          â”‚   â”‚
â”‚  â”‚   æ„‰æ‚¦ä½“éªŒ   â”€â”€â†’ ç²¾å¿ƒè®¾è®¡çš„è§†è§‰ã€åŠ¨æ•ˆã€åé¦ˆ                           â”‚   â”‚
â”‚  â”‚   ä¿¡ä»»ç¬¬ä¸€   â”€â”€â†’ æ•°æ®é€æ˜ã€æ“ä½œå¯é€†ã€éšç§ä¿æŠ¤                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.0.1 è®¾è®¡åŸåˆ™åœ¨ç”¨æˆ·ä½“éªŒä¸­çš„ä½“ç°

| è®¾è®¡åŸåˆ™ | UXåº”ç”¨ | å…·ä½“æªæ–½ | æ•ˆæœæŒ‡æ ‡ |
|---------|---------|---------|---------|
| **æ‡’äººè®¾è®¡** | æœ€å°‘æ“ä½œ | è¯­éŸ³è®°è´¦ã€æ™ºèƒ½åˆ†ç±»ã€ä¸€é”®æ¨¡æ¿ | è®°è´¦<5ç§’ |
| **ä¼™ä¼´åŒ–** | AIé™ªä¼´ | æ™ºèƒ½æ´å¯Ÿã€ä¸»åŠ¨æé†’ã€è´¢åŠ¡å»ºè®® | æ—¥æ´»ç‡+40% |
| **æ¸¸æˆåŒ–** | æˆå°±ç³»ç»Ÿ | å¾½ç« ã€ç­‰çº§ã€è¿ç»­æ‰“å¡å¥–åŠ± | ç•™å­˜ç‡+30% |
| **æƒ…æ„ŸåŒ–** | æ­£å‘åé¦ˆ | åº†ç¥åŠ¨ç”»ã€é¼“åŠ±æ–‡æ¡ˆã€æˆé•¿è½¨è¿¹ | NPS>50 |
| **æç®€äº¤äº’** | å•æ‰‹æ“ä½œ | åº•éƒ¨å¯¼èˆªã€æ‰‹åŠ¿æ»‘åŠ¨ã€å¤§æŒ‰é’® | æ“ä½œæˆåŠŸç‡>95% |
| **ä¿¡ä»»å»ºç«‹** | é€æ˜å¯æ§ | æ•°æ®å¯å¯¼å‡ºã€æ“ä½œå¯æ’¤é”€ã€éšç§è®¾ç½® | ç”¨æˆ·æŠ•è¯‰ç‡<0.1% |

#### 20.0.2 ä¸å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·ä½“éªŒä¸å…¶ä»–æ¨¡å—çš„ååŒå…³ç³»                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   20. ç”¨æˆ·ä½“éªŒè®¾è®¡       â”‚                         â”‚
â”‚                        â”‚       ï¼ˆæœ¬ç« ï¼‰           â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                    â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â–¼                           â–¼                           â–¼           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ 7.é’±é¾„   â”‚              â”‚ 8.é¢„ç®—   â”‚              â”‚ 9.ä¹ æƒ¯   â”‚        â”‚
â”‚   â”‚  ç³»ç»Ÿ    â”‚              â”‚  ç³»ç»Ÿ    â”‚              â”‚  åŸ¹å…»    â”‚        â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚        â”‚
â”‚   â”‚ é’±é¾„ä»ªè¡¨ â”‚              â”‚ é¢„ç®—å¯è§† â”‚              â”‚ æˆå°±å±•ç¤º â”‚        â”‚
â”‚   â”‚ ç­‰çº§å¾½ç«  â”‚              â”‚ å°é‡‘åº“å¡ â”‚              â”‚ æ‰“å¡ç•Œé¢ â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â–¼                                       â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   12. æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–   â”‚                         â”‚
â”‚                        â”‚   - å›¾è¡¨ç»„ä»¶            â”‚                         â”‚
â”‚                        â”‚   - æ•°æ®åŠ¨æ•ˆ            â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                           2.0æ–°å¢åä½œæ¨¡å—                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚18.è¯­éŸ³   â”‚  â”‚17.è‡ªå­¦ä¹  â”‚  â”‚13.å®¶åº­   â”‚  â”‚10.AIè¯†åˆ« â”‚  â”‚28-29.å¢é•¿â”‚   â”‚
â”‚   â”‚  äº¤äº’    â”‚  â”‚  ç³»ç»Ÿ    â”‚  â”‚  è´¦æœ¬    â”‚  â”‚  ç³»ç»Ÿ    â”‚  â”‚  ä½“ç³»    â”‚   â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚   â”‚è¯­éŸ³æŒ‰é’®  ï¿½ï¿½ï¿½  â”‚ä¸ªæ€§åŒ–UI  â”‚  â”‚å®¶åº­è§†å›¾  â”‚  â”‚è¯†åˆ«åé¦ˆ  â”‚  â”‚å¼•å¯¼æµç¨‹  â”‚   â”‚
â”‚   â”‚æ³¢å½¢åŠ¨ç”»  â”‚  â”‚æ™ºèƒ½æ’åº  â”‚  â”‚æˆå‘˜åˆ‡æ¢  â”‚  â”‚ç»“æœå±•ç¤º  â”‚  â”‚åˆ†äº«ç•Œé¢  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.0.3 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// ç¬¬20ç« è®¾è®¡ç›®æ ‡è¾¾æˆæ£€æµ‹
class Chapter20GoalChecker {
  /// æ£€æŸ¥ç”¨æˆ·ä½“éªŒè®¾è®¡ç›®æ ‡æ˜¯å¦è¾¾æˆ
  static Future<GoalCheckResult> checkGoals() async {
    final results = <GoalCheck>[];

    // 1. è®°è´¦æ•ˆç‡ç›®æ ‡
    results.add(GoalCheck(
      goal: 'è®°è´¦æ“ä½œ<5ç§’',
      checker: () async {
        final avgTime = await UXAnalytics.getAverageRecordTime();
        return avgTime.inSeconds <= 5;
      },
      requirement: 'è¯­éŸ³/æ‹ç…§/æ¨¡æ¿ä»»ä¸€æ–¹å¼',
    ));

    // 2. å•æ‰‹æ“ä½œç›®æ ‡
    results.add(GoalCheck(
      goal: 'æ ¸å¿ƒåŠŸèƒ½å•æ‰‹å¯è¾¾',
      checker: () => UXAudit.checkSingleHandReachability(),
      requirement: 'åº•éƒ¨å¯¼èˆª+æ‰‹åŠ¿æ»‘åŠ¨',
    ));

    // 3. é¦–å±åŠ è½½ç›®æ ‡
    results.add(GoalCheck(
      goal: 'é¦–å±åŠ è½½<500ms',
      checker: () async {
        final loadTime = await PerformanceMetrics.getFirstScreenTime();
        return loadTime.inMilliseconds <= 500;
      },
      requirement: 'æ‡’åŠ è½½+æœ¬åœ°ç¼“å­˜',
    ));

    // 4. ç”¨æˆ·æ»¡æ„åº¦ç›®æ ‡
    results.add(GoalCheck(
      goal: 'NPS>50',
      checker: () async {
        final nps = await UserSurvey.getLatestNPS();
        return nps >= 50;
      },
      requirement: 'ç”¨æˆ·æ„¿æ„æ¨è',
    ));

    // 5. æ—¥æ´»ç‡ç›®æ ‡
    results.add(GoalCheck(
      goal: 'æ—¥æ´»ç‡æå‡40%',
      checker: () async {
        final improvement = await UXAnalytics.getDAUImprovement();
        return improvement >= 0.40;
      },
      requirement: 'é’±é¾„å¯è§†åŒ–é©±åŠ¨',
    ));

    return GoalCheckResult(checks: results);
  }
}
```

> **è®¾è®¡åŸåˆ™ä¾æ®**ï¼šæœ¬ç« çš„æ‰€æœ‰è®¾è®¡å®ç°éµå¾ªç¬¬3ç« "[æ‡’äººè®¾è®¡åŸåˆ™](#3-æ‡’äººè®¾è®¡åŸåˆ™)"å’Œç¬¬4ç« "[ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™](#4-ä¼™ä¼´åŒ–è®¾è®¡åŸåˆ™)"ï¼ŒåŒ…æ‹¬æœ€å°‘æ“ä½œã€æ™ºèƒ½é»˜è®¤ã€æ¸è¿›å¤æ‚åº¦ã€å•æ‰‹æ“ä½œã€ä¼™ä¼´åŸåˆ™ç­‰æ ¸å¿ƒç†å¿µã€‚

### 20.1 æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šä»¥é’±é¾„å’Œé›¶åŸºé¢„ç®—ä¸ºä¸­å¿ƒ

#### 20.1.1 è®¾è®¡å“²å­¦

ä¼ ç»Ÿè®°è´¦APPä»¥"è®°å½•"ä¸ºæ ¸å¿ƒï¼Œç”¨æˆ·è®°å®Œè´¦å°±å…³é—­äº†APPã€‚æˆ‘ä»¬çš„2.0ç‰ˆæœ¬ä»¥"åŸ¹å…»è´¢åŠ¡ä¹ æƒ¯"ä¸ºæ ¸å¿ƒï¼Œè®©ç”¨æˆ·**ä¸»åŠ¨æƒ³æ‰“å¼€APP**æŸ¥çœ‹è‡ªå·±çš„è´¢åŠ¡å¥åº·çŠ¶å†µã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¾è®¡å“²å­¦è½¬å˜                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚   ä¼ ç»Ÿè®°è´¦APP                    â†’     AIæ™ºèƒ½è®°è´¦ 2.0                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚                  â”‚                â”‚                  â”‚            â”‚
â”‚   â”‚   è®°å½•ä¸ºä¸­å¿ƒ     â”‚     â”€â”€â†’        â”‚   æˆé•¿ä¸ºä¸­å¿ƒ     â”‚            â”‚
â”‚   â”‚   "èŠ±äº†å¤šå°‘é’±"   â”‚                â”‚   "è´¢åŠ¡åœ¨å˜å¥½å—" â”‚            â”‚
â”‚   â”‚                  â”‚                â”‚                  â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                        â”‚
â”‚   ç—›ç‚¹ï¼š                              ç›®æ ‡ï¼š                           â”‚
â”‚   â€¢ è®°å®Œå°±å…³                          â€¢ ä¸»åŠ¨æ‰“å¼€æŸ¥çœ‹                   â”‚
â”‚   â€¢ æ— æˆå°±æ„Ÿ                          â€¢ æ¸¸æˆåŒ–æ¿€åŠ±                     â”‚
â”‚   â€¢ è¶…æ”¯åæ‚”                          â€¢ è¶…æ”¯å‰é¢„è­¦                     â”‚
â”‚   â€¢ æ•°æ®å­¤å²›                          â€¢ æ´å¯Ÿä¸å»ºè®®                     â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.1.2 ä¿¡æ¯æ¶æ„é‡æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPä¿¡æ¯æ¶æ„ 2.0                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        åº•éƒ¨å¯¼èˆªæ                                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚    [ğŸ“Š]           [ğŸ“ˆ]           [â•]          [ğŸ’°]         [ğŸ‘¤] â”‚  â”‚
â”‚  â”‚   ä»ªè¡¨ç›˜         è¶‹åŠ¿            è®°è´¦          é¢„ç®—          æˆ‘çš„ â”‚  â”‚
â”‚  â”‚  Dashboard      Insights       Record       Budget        Profileâ”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  é¡µé¢å±‚çº§ï¼š                                                            â”‚
â”‚                                                                        â”‚
â”‚  ä»ªè¡¨ç›˜ â”€â”€â†’ è´¢åŠ¡å¥åº·æ€»è§ˆï¼ˆé’±é¾„ä¸ºæ ¸å¿ƒæŒ‡æ ‡ï¼‰                             â”‚
â”‚         â”‚â”€â”€ é’±é¾„è¯¦æƒ…åˆ†æ                                              â”‚
â”‚         â”‚â”€â”€ åº”æ€¥é‡‘è¿›åº¦                                                â”‚
â”‚         â””â”€â”€ æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ                                              â”‚
â”‚                                                                        â”‚
â”‚  è¶‹åŠ¿ â”€â”€â”€â”€â†’ å¤šç»´åº¦å›¾è¡¨åˆ†æ                                            â”‚
â”‚         â”‚â”€â”€ æ¶ˆè´¹è¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾/çƒ­åŠ›å›¾ï¼‰                                 â”‚
â”‚         â”‚â”€â”€ åˆ†ç±»å æ¯”ï¼ˆé¥¼å›¾/ç¯å½¢å›¾ï¼‰                                   â”‚
â”‚         â”‚â”€â”€ æ¶ˆè´¹æ´å¯Ÿï¼ˆæ‹¿é“å› å­/è®¢é˜…åˆ†æï¼‰                             â”‚
â”‚         â””â”€â”€ å¯¹æ¯”åˆ†æï¼ˆåŒæœŸå¯¹æ¯”/é¢„ç®—å¯¹æ¯”ï¼‰                             â”‚
â”‚                                                                        â”‚
â”‚  è®°è´¦ â”€â”€â”€â”€â†’ å¿«é€Ÿè®°è´¦å…¥å£                                              â”‚
â”‚         â”‚â”€â”€ è¯­éŸ³è®°è´¦                                                  â”‚
â”‚         â”‚â”€â”€ å›¾ç‰‡è¯†åˆ«                                                  â”‚
â”‚         â”‚â”€â”€ æ‰‹åŠ¨è¾“å…¥                                                  â”‚
â”‚         â””â”€â”€ æ¨¡æ¿å¿«è®°                                                  â”‚
â”‚                                                                        â”‚
â”‚  é¢„ç®— â”€â”€â”€â”€â†’ é›¶åŸºé¢„ç®—ç®¡ç†                                              â”‚
â”‚         â”‚â”€â”€ æ”¶å…¥æ± åˆ†é…                                                â”‚
â”‚         â”‚â”€â”€ å°é‡‘åº“ç®¡ç†                                                â”‚
â”‚         â”‚â”€â”€ é¢„ç®—æ‰§è¡Œç›‘æ§                                              â”‚
â”‚         â””â”€â”€ ç»“è½¬ä¸è°ƒæ•´                                                â”‚
â”‚                                                                        â”‚
â”‚  æˆ‘çš„ â”€â”€â”€â”€â†’ è´¦æˆ·ä¸è®¾ç½®                                                â”‚
â”‚         â”‚â”€â”€ è´¦æˆ·ç®¡ç†                                                  â”‚
â”‚         â”‚â”€â”€ æ•°æ®åŒæ­¥                                                  â”‚
â”‚         â”‚â”€â”€ æˆå°±å¾½ç«                                                   â”‚
â”‚         â””â”€â”€ ç³»ç»Ÿè®¾ç½®                                                  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 20.2 å…¨æ–°é¦–é¡µä»ªè¡¨ç›˜è®¾è®¡

#### 20.2.1 ä»ªè¡¨ç›˜æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‰¡  AIæ™ºèƒ½è®°è´¦                                    ğŸ”” 2   ğŸ‘¤        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ğŸ’« è´¢åŠ¡å¥åº·æ€»è§ˆ                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚                     â”‚  è´¢åŠ¡å¥åº·åˆ† 78/100  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    â±ï¸      â”‚    é’±é¾„ 18 å¤©       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   18å¤©     â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  ğŸ“ˆ è¾ƒä¸Šæœˆ +5åˆ†     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚    Level 3 ç¨³å¥è€…   â”‚                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚    ç›®æ ‡: 30å¤©ä»å®¹è€…  â”‚  [æŸ¥çœ‹è¯¦æƒ… â†’]       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  ğŸ“… æœ¬æœˆé¢„ç®—          â”‚  â”‚  ğŸ›¡ï¸ åº”æ€¥é‡‘å‚¨å¤‡       â”‚               â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚               â”‚
â”‚  â”‚  Â¥8,500 / Â¥12,000   â”‚  â”‚  Â¥18,000 / Â¥36,000  â”‚               â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 71%   â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 50%   â”‚               â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚               â”‚
â”‚  â”‚  å‰©ä½™ Â¥3,500        â”‚  â”‚  ç›®æ ‡: 6ä¸ªæœˆæ”¯å‡º     â”‚               â”‚
â”‚  â”‚  è¿˜æœ‰ 12 å¤©          â”‚  â”‚  å·²è¾¾æˆ3ä¸ªæœˆ âœ“      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æœ¬æœˆæ”¶æ”¯æ¦‚è§ˆ                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æ”¶å…¥ Â¥15,000          æ”¯å‡º Â¥8,500           ç»“ä½™ Â¥6,500   â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¡ ä»Šæ—¥æ´å¯Ÿ                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ¯ é¤é¥®é¢„ç®—è¿˜å‰© Â¥580ï¼Œå»ºè®®æœ¬å‘¨æ§åˆ¶åœ¨ Â¥82/å¤©        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  âš ï¸ è§†é¢‘ä¼šå‘˜å·²è¿ç»­3ä¸ªæœˆæœªä½¿ç”¨ï¼Œæ¯æœˆ Â¥30             â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”¥ è¿ç»­è®°è´¦ 45å¤©                           æ–°çºªå½•! ğŸ†       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [ğŸ“Š]         [ğŸ“ˆ]         [â•]         [ğŸ’°]         [ğŸ‘¤]        â”‚
â”‚   ä»ªè¡¨ç›˜        è¶‹åŠ¿          è®°è´¦          é¢„ç®—          æˆ‘çš„       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.2.2 ä»ªè¡¨ç›˜ç»„ä»¶ä»£ç è®¾è®¡

```dart
/// 2.0 å…¨æ–°é¦–é¡µä»ªè¡¨ç›˜
class DashboardPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: _buildAppBar(context),
      body: RefreshIndicator(
        onRefresh: () => ref.refresh(dashboardDataProvider.future),
        child: SingleChildScrollView(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              // æ ¸å¿ƒæŒ‡æ ‡ï¼šé’±é¾„ + è´¢åŠ¡å¥åº·åˆ†
              FinancialHealthHeroCard(),
              SizedBox(height: 16),

              // åŒå¡ç‰‡ï¼šé¢„ç®—æ¦‚è§ˆ + åº”æ€¥é‡‘
              Row(
                children: [
                  Expanded(child: BudgetOverviewMiniCard()),
                  SizedBox(width: 12),
                  Expanded(child: EmergencyFundMiniCard()),
                ],
              ),
              SizedBox(height: 16),

              // æœ¬æœˆæ”¶æ”¯ä¸‰æ 
              MonthlyOverviewCard(),
              SizedBox(height: 16),

              // ä»Šæ—¥æ´å¯Ÿå¡ç‰‡
              TodayInsightsCard(),
              SizedBox(height: 16),

              // è¿ç»­è®°è´¦æ¿€åŠ±
              RecordingStreakBanner(),
              SizedBox(height: 80), // åº•éƒ¨å¯¼èˆªæ ç•™ç™½
            ],
          ),
        ),
      ),
    );
  }
}

/// è´¢åŠ¡å¥åº·è‹±é›„å¡ç‰‡ï¼ˆæ ¸å¿ƒè§†è§‰ç„¦ç‚¹ï¼‰
class FinancialHealthHeroCard extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final moneyAge = ref.watch(moneyAgeProvider);
    final healthScore = ref.watch(financialHealthScoreProvider);

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Theme.of(context).primaryColor,
            Theme.of(context).primaryColor.withOpacity(0.7),
          ],
        ),
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).primaryColor.withOpacity(0.3),
            blurRadius: 20,
            offset: Offset(0, 10),
          ),
        ],
      ),
      child: Padding(
        padding: EdgeInsets.all(20),
        child: Column(
          children: [
            Text('ğŸ’« è´¢åŠ¡å¥åº·æ€»è§ˆ',
              style: TextStyle(color: Colors.white70, fontSize: 14)),
            SizedBox(height: 16),
            Row(
              children: [
                // å·¦ä¾§ï¼šé’±é¾„åœ†ç¯
                _buildMoneyAgeRing(moneyAge),
                SizedBox(width: 20),
                // ä¸­é—´ï¼šé’±é¾„ä¿¡æ¯
                Expanded(child: _buildMoneyAgeInfo(moneyAge)),
                // å³ä¾§ï¼šå¥åº·åˆ†
                _buildHealthScoreCard(healthScore),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMoneyAgeRing(MoneyAge moneyAge) {
    return Container(
      width: 80,
      height: 80,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // èƒŒæ™¯åœ†ç¯
          CircularProgressIndicator(
            value: 1,
            strokeWidth: 8,
            backgroundColor: Colors.white24,
            valueColor: AlwaysStoppedAnimation(Colors.white24),
          ),
          // è¿›åº¦åœ†ç¯ï¼ˆ30å¤©ä¸ºæ»¡ï¼‰
          CircularProgressIndicator(
            value: (moneyAge.days / 30).clamp(0, 1),
            strokeWidth: 8,
            backgroundColor: Colors.transparent,
            valueColor: AlwaysStoppedAnimation(Colors.white),
          ),
          // ä¸­å¿ƒæ•°å­—
          Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text('â±ï¸', style: TextStyle(fontSize: 16)),
              Text('${moneyAge.days}å¤©',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                )),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildMoneyAgeInfo(MoneyAge moneyAge) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('é’±é¾„ ${moneyAge.days} å¤©',
          style: TextStyle(
            color: Colors.white,
            fontSize: 22,
            fontWeight: FontWeight.bold,
          )),
        SizedBox(height: 4),
        Text('Level ${moneyAge.stage.level} ${moneyAge.stage.name}',
          style: TextStyle(color: Colors.white70)),
        SizedBox(height: 8),
        if (moneyAge.nextStage != null)
          Container(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: Colors.white24,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Text(
              'ç›®æ ‡: ${moneyAge.nextStage!.minAge}å¤© ${moneyAge.nextStage!.name}',
              style: TextStyle(color: Colors.white, fontSize: 12),
            ),
          ),
      ],
    );
  }

  Widget _buildHealthScoreCard(FinancialHealthScore score) {
    return Container(
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        children: [
          Text('è´¢åŠ¡å¥åº·åˆ†', style: TextStyle(fontSize: 10, color: Colors.grey)),
          Text('${score.totalScore}',
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.bold,
              color: _getScoreColor(score.totalScore),
            )),
          Text('/100', style: TextStyle(fontSize: 10, color: Colors.grey)),
          SizedBox(height: 4),
          if (score.comparisonToLastMonth != 0)
            Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  score.comparisonToLastMonth > 0
                      ? Icons.arrow_upward : Icons.arrow_downward,
                  size: 12,
                  color: score.comparisonToLastMonth > 0
                      ? Colors.green : Colors.red,
                ),
                Text(
                  '${score.comparisonToLastMonth > 0 ? '+' : ''}${score.comparisonToLastMonth}',
                  style: TextStyle(
                    fontSize: 11,
                    color: score.comparisonToLastMonth > 0
                        ? Colors.green : Colors.red,
                  ),
                ),
              ],
            ),
        ],
      ),
    );
  }

  Color _getScoreColor(int score) {
    if (score >= 80) return Colors.green;
    if (score >= 60) return Colors.blue;
    if (score >= 40) return Colors.orange;
    return Colors.red;
  }
}
```

### 20.3 è¶‹åŠ¿åˆ†æé¡µé¢è®¾è®¡

#### 20.3.1 è¶‹åŠ¿é¡µé¢æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  è¶‹åŠ¿åˆ†æ                                          ğŸ“… æœ¬æœˆ â–¼    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [æ¶ˆè´¹è¶‹åŠ¿]  [åˆ†ç±»å æ¯”]  [æ´å¯Ÿåˆ†æ]  [å¯¹æ¯”æŠ¥å‘Š]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                        æ¶ˆè´¹è¶‹åŠ¿ Tab                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ æ—¥æ¶ˆè´¹è¶‹åŠ¿                              [æ—¥] [å‘¨] [æœˆ]   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚      Â¥                                                       â”‚   â”‚
â”‚  â”‚    800 â”¤                    â—                                â”‚   â”‚
â”‚  â”‚        â”‚              â—    â”‚ â—                               â”‚   â”‚
â”‚  â”‚    600 â”¤         â—   â”‚ â—  â”‚   â—                             â”‚   â”‚
â”‚  â”‚        â”‚    â—   â”‚ â— â”‚     â”‚     â—   â—                       â”‚   â”‚
â”‚  â”‚    400 â”¤   â”‚ â— â”‚   â”‚      â”‚       â”‚ â”‚ â—                     â”‚   â”‚
â”‚  â”‚        â”‚  â”‚   â”‚            â”‚        â”‚   â—                    â”‚   â”‚
â”‚  â”‚    200 â”¤ â”‚                           â”‚                       â”‚   â”‚
â”‚  â”‚        â”‚                                                     â”‚   â”‚
â”‚  â”‚      0 â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â†’            â”‚   â”‚
â”‚  â”‚        1   3   5   7   9  11  13  15  17  19  æ—¥æœŸ           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ æœ¬æœˆæ¶ˆè´¹å³°å€¼å‡ºç°åœ¨ 9æ—¥(Â¥856)ï¼Œä¸»è¦æ˜¯è´­ç‰©æ”¯å‡º            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”¥ æ¶ˆè´¹çƒ­åŠ›å›¾                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚        å‘¨ä¸€  å‘¨äºŒ  å‘¨ä¸‰  å‘¨å››  å‘¨äº”  å‘¨å…­  å‘¨æ—¥               â”‚   â”‚
â”‚  â”‚   0-6   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘   â–‘â–‘                    â”‚   â”‚
â”‚  â”‚   6-12  â–’â–’   â–’â–’   â–“â–“   â–’â–’   â–’â–’   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ                â”‚   â”‚
â”‚  â”‚  12-18  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ                â”‚   â”‚
â”‚  â”‚  18-24  â–“â–“   â–“â–“   â–“â–“   â–“â–“   â–ˆâ–ˆâ–ˆâ–ˆ â–“â–“     â–’â–’                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ“Œ å‘¨æœ«ä¸‹åˆæ˜¯æ‚¨æ¶ˆè´¹æœ€æ´»è·ƒçš„æ—¶æ®µ                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å‘¨æ¶ˆè´¹å¯¹æ¯”                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   ç¬¬1å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,156                       â”‚   â”‚
â”‚  â”‚   ç¬¬2å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,892                 â”‚   â”‚
â”‚  â”‚   ç¬¬3å‘¨  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,456  â† æœ¬å‘¨           â”‚   â”‚
â”‚  â”‚   é¢„ç®—çº¿  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Â¥2,750                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.3.2 åˆ†ç±»å æ¯” Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åˆ†ç±»å æ¯” Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ© æ”¯å‡ºåˆ†ç±»æ„æˆ                            æœ¬æœˆ Â¥8,500      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â”‚
â”‚  â”‚            â•±   ğŸ” é¤é¥®       â•²    ç‚¹å‡»åˆ†ç±»                   â”‚   â”‚
â”‚  â”‚          â•±       32%          â•²   å¯ä¸‹é’»æŸ¥çœ‹                 â”‚   â”‚
â”‚  â”‚        â•±     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â•²  å­åˆ†ç±»æ˜ç»†                 â”‚   â”‚
â”‚  â”‚       â”‚  ğŸ›’  â”‚  å…¶ä»–   â”‚  ğŸš—   â”‚                            â”‚   â”‚
â”‚  â”‚       â”‚ è´­ç‰© â”‚   12%   â”‚ äº¤é€š  â”‚                            â”‚   â”‚
â”‚  â”‚       â”‚ 25%  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  15%  â”‚                            â”‚   â”‚
â”‚  â”‚        â•²         ğŸ®           â•±                              â”‚   â”‚
â”‚  â”‚          â•²    å¨±ä¹ 10%      â•±                                â”‚   â”‚
â”‚  â”‚            â•²   ğŸ  å±…ä½    â•±                                  â”‚   â”‚
â”‚  â”‚              â•²   6%    â•±                                     â”‚   â”‚
â”‚  â”‚                â”€â”€â”€â”€â”€â”€â”€                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“‹ åˆ†ç±»æ’è¡Œæ¦œ                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  1. ğŸ” é¤é¥®      Â¥2,720    32%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â†‘3%       â”‚   â”‚
â”‚  â”‚  2. ğŸ›’ è´­ç‰©      Â¥2,125    25%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â†“5%       â”‚   â”‚
â”‚  â”‚  3. ğŸš— äº¤é€š      Â¥1,275    15%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ          â†’         â”‚   â”‚
â”‚  â”‚  4. ğŸ® å¨±ä¹      Â¥850      10%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            â†‘2%       â”‚   â”‚
â”‚  â”‚  5. ğŸ  å±…ä½      Â¥510       6%   â–ˆâ–ˆâ–ˆ              â†’         â”‚   â”‚
â”‚  â”‚  6. å…¶ä»–         Â¥1,020    12%   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â†’         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ é¤é¥®å æ¯”è¾ƒä¸Šæœˆå¢åŠ 3%ï¼Œå¯èƒ½éœ€è¦å…³æ³¨                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å¿…è¦ vs å¯é€‰æ¶ˆè´¹                                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¿…è¦æ¶ˆè´¹ (å¿…éœ€å“+é‡è¦æ¶ˆè´¹)                                  â”‚   â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥5,525  65%         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¯é€‰æ¶ˆè´¹ (éå¿…éœ€å“)                                         â”‚   â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  Â¥2,975  35%                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   âœ… æ¶ˆè´¹ç»“æ„å¥åº·ï¼Œå¯é€‰æ¶ˆè´¹å æ¯”é€‚ä¸­                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.3.3 æ´å¯Ÿåˆ†æ Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ´å¯Ÿåˆ†æ Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â˜• æ‹¿é“å› å­åˆ†æï¼ˆé«˜é¢‘å°é¢æ¶ˆè´¹ï¼‰                 è¿‘3ä¸ªæœˆ     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚     ğŸ’° å¦‚æœæ¯å¤©å°‘èŠ± Â¥25ï¼Œä¸€å¹´å¯ä»¥å¤šå­˜ Â¥9,125       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  TOP é«˜é¢‘å°é¢æ¶ˆè´¹ï¼š                                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ â˜• å’–å•¡/å¥¶èŒ¶                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 45æ¬¡  â”‚  æ€»é¢: Â¥1,350  â”‚  æ—¥å‡: Â¥15        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†‘23%   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   ğŸ’¡ å‡å°‘2æ¯/å‘¨å¯å¹´çœ Â¥1,560                        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ¥¡ å¤–å–é…é€è´¹                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 62æ¬¡  â”‚  æ€»é¢: Â¥310   â”‚  å‡: Â¥5/å•         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†’                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   ğŸ’¡ è‡ªå–å¯çœé…é€è´¹ Â¥310/æœˆ                         â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ğŸª é›¶é£Ÿ/ä¾¿åˆ©åº—                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   é¢‘æ¬¡: 38æ¬¡  â”‚  æ€»é¢: Â¥760   â”‚  å‡: Â¥20/æ¬¡        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â†“15%                            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   âœ… è¾ƒä¸Šæœˆå‡å°‘15%ï¼Œç»§ç»­ä¿æŒï¼                       â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“º è®¢é˜…æœåŠ¡è¿½è¸ª                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æœåŠ¡åç§°      æœˆè´¹    ä¸Šæ¬¡ä½¿ç”¨    çŠ¶æ€        æ“ä½œ        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  ğŸµ éŸ³ä¹ä¼šå‘˜    Â¥15    2å¤©å‰       âœ… æ´»è·ƒ      [è¯¦æƒ…]      â”‚   â”‚
â”‚  â”‚  ğŸ“º è§†é¢‘ä¼šå‘˜    Â¥30    3ä¸ªæœˆå‰     âš ï¸ é—²ç½®     [æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚  â˜ï¸ äº‘å­˜å‚¨      Â¥6     ç»å¸¸ä½¿ç”¨    âœ… æ´»è·ƒ      [è¯¦æƒ…]      â”‚   â”‚
â”‚  â”‚  ğŸ® æ¸¸æˆä¼šå‘˜    Â¥25    1ä¸ªæœˆå‰     âš ï¸ å°‘ç”¨     [æŸ¥çœ‹]      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ’¡ å‘ç°2ä¸ªå¯èƒ½ä¸éœ€è¦çš„è®¢é˜…ï¼Œå¹´çœçº¦ Â¥660           â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                               [æŸ¥çœ‹ä¼˜åŒ–å»ºè®® â†’]     â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”® æ¶ˆè´¹é¢„æµ‹                                                 â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åŸºäºæ‚¨çš„æ¶ˆè´¹ä¹ æƒ¯ï¼Œé¢„æµ‹æœ¬æœˆæ€»æ”¯å‡ºï¼š                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚        é¢„æµ‹åŒºé—´: Â¥11,200 ~ Â¥12,800                          â”‚   â”‚
â”‚  â”‚        æœ€å¯èƒ½: Â¥12,000                                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   Â¥10k  Â¥11k  Â¥12k  Â¥13k  Â¥14k                              â”‚   â”‚
â”‚  â”‚     â”‚     â”‚     â”‚     â”‚     â”‚                               â”‚   â”‚
â”‚  â”‚     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘                                â”‚   â”‚
â”‚  â”‚              â–²                                               â”‚   â”‚
â”‚  â”‚           æœ€å¯èƒ½                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  é¢„ç®—: Â¥12,000    é¢„æµ‹: Â¥12,000    çŠ¶æ€: âœ… é¢„è®¡è¾¾æ ‡        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.3.4 å¯¹æ¯”æŠ¥å‘Š Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯¹æ¯”æŠ¥å‘Š Tab                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š æœˆåº¦åŒæœŸå¯¹æ¯”                           12æœˆ vs 11æœˆ     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚         æŒ‡æ ‡         12æœˆ        11æœˆ        å˜åŒ–           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚    ğŸ’° æ€»æ”¯å‡º        Â¥8,500     Â¥9,200     â†“ Â¥700 (7.6%)    â”‚   â”‚
â”‚  â”‚    ğŸ’µ æ€»æ”¶å…¥        Â¥15,000    Â¥15,000    â†’ æŒå¹³           â”‚   â”‚
â”‚  â”‚    ğŸ“ˆ ç»“ä½™ç‡        43.3%      38.7%      â†‘ 4.6%           â”‚   â”‚
â”‚  â”‚    â±ï¸ é’±é¾„          18å¤©       14å¤©       â†‘ 4å¤©            â”‚   â”‚
â”‚  â”‚    ğŸ“… è®°è´¦å¤©æ•°      19/20      18/30      â†‘ æ”¹å–„           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                     12æœˆ           11æœˆ                      â”‚   â”‚
â”‚  â”‚  æ€»æ”¯å‡º    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚   â”‚
â”‚  â”‚  æ€»æ”¶å…¥    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚   â”‚
â”‚  â”‚  ç»“ä½™      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ              â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  âœ¨ æœ¬æœˆè´¢åŠ¡è¡¨ç°ä¼˜äºä¸Šæœˆï¼ç»“ä½™ç‡æå‡4.6%                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„è¶‹åŠ¿ï¼ˆè¿‘6ä¸ªæœˆï¼‰                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¤©                                                         â”‚   â”‚
â”‚  â”‚   30 â”¤ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€  ç›®æ ‡çº¿          â”‚   â”‚
â”‚  â”‚      â”‚                                   â—                   â”‚   â”‚
â”‚  â”‚   20 â”¤                            â—    â•±                     â”‚   â”‚
â”‚  â”‚      â”‚                     â—    â•±  â—â•±                       â”‚   â”‚
â”‚  â”‚   14 â”¤ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â—â•± â”€ â”€ â”€ â”€ â”€ â”€ â”€  ç¨³å¥è€…çº¿         â”‚   â”‚
â”‚  â”‚      â”‚            â—   â•±                                      â”‚   â”‚
â”‚  â”‚   10 â”¤      â—   â•±                                            â”‚   â”‚
â”‚  â”‚      â”‚    â•±  â—                                               â”‚   â”‚
â”‚  â”‚    7 â”¤ â— â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€  èµ·æ­¥è€…çº¿         â”‚   â”‚
â”‚  â”‚      â”‚                                                       â”‚   â”‚
â”‚  â”‚    0 â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â†’                              â”‚   â”‚
â”‚  â”‚       7æœˆ  8æœˆ  9æœˆ  10æœˆ 11æœˆ 12æœˆ                          â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ‰ æ­å–œï¼æ‚¨å·²ä»"èµ·æ­¥è€…"æ™‹å‡ä¸º"ç¨³å¥è€…"                       â”‚   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„æå‡è¶‹åŠ¿è‰¯å¥½ï¼Œç»§ç»­ä¿æŒå¯åœ¨2ä¸ªæœˆå†…è¾¾åˆ°"ä»å®¹è€…"        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ†š é¢„ç®—æ‰§è¡Œå¯¹æ¯”                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                    é¢„ç®—       å®é™…       è¾¾æˆç‡    çŠ¶æ€      â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  ğŸ” é¤é¥®         Â¥3,000    Â¥2,720      91%      âœ… è¾¾æ ‡    â”‚   â”‚
â”‚  â”‚  ğŸ›’ è´­ç‰©         Â¥2,000    Â¥2,125      106%     âš ï¸ è½»å¾®è¶…æ”¯â”‚   â”‚
â”‚  â”‚  ğŸš— äº¤é€š         Â¥1,500    Â¥1,275      85%      âœ… ç»“ä½™    â”‚   â”‚
â”‚  â”‚  ğŸ® å¨±ä¹         Â¥800      Â¥850        106%     âš ï¸ è½»å¾®è¶…æ”¯â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  æ•´ä½“é¢„ç®—æ‰§è¡Œç‡: 92%                                         â”‚   â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è´­ç‰©å’Œå¨±ä¹è½»å¾®è¶…æ”¯ï¼Œå»ºè®®ä¸‹æœˆé€‚å½“è°ƒæ•´é¢„ç®—åˆ†é…             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 20.4 é›¶åŸºé¢„ç®—é¡µé¢è®¾è®¡

#### 20.4.1 é¢„ç®—é¡µé¢æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  é›¶åŸºé¢„ç®—                                          ğŸ“… 12æœˆ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’° æœ¬æœˆæ”¶å…¥æ±                                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              Â¥15,000                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   å·²åˆ†é… Â¥12,000    â”‚    å¾…åˆ†é… Â¥3,000              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  80%                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ’¡ è¿˜æœ‰ Â¥3,000 æœªåˆ†é…ï¼Œå»ºè®®åˆ†é…åˆ°åº”æ€¥é‡‘æˆ–å‚¨è“„             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¦ å°é‡‘åº“ä¸€è§ˆ                                    [+ æ–°å»º]   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ›¡ï¸ åº”æ€¥é‡‘                              ç›®æ ‡: 6ä¸ªæœˆ     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   Â¥18,000 / Â¥36,000                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  50%                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”‚ 3ä¸ªæœˆ â”‚  â”‚ 4ä¸ªæœˆ â”‚  â”‚ 6ä¸ªæœˆ â”‚  é‡Œç¨‹ç¢‘            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â”‚  âœ“   â”‚  â”‚  â—‹   â”‚  â”‚  â—‹   â”‚                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   æœ¬æœˆè‡ªåŠ¨å­˜å…¥: Â¥1,500              [è°ƒæ•´åˆ†é…]        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ” é¤é¥®                                    æœˆåº¦é¢„ç®—     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å·²ç”¨ Â¥2,720 / é¢„ç®— Â¥3,000                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  91%        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å‰©ä½™ Â¥280    â”‚    å‰©ä½™12å¤©    â”‚    å»ºè®® Â¥23/å¤©     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ›’ è´­ç‰©                                    æœˆåº¦é¢„ç®—     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   å·²ç”¨ Â¥2,125 / é¢„ç®— Â¥2,000         âš ï¸ è¶…æ”¯ Â¥125     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 106%      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   [ä»åº”æ€¥é‡‘å€Ÿè°ƒ]  [è°ƒæ•´å…¶ä»–é¢„ç®—]  [æ¥å—è¶…æ”¯]          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸš— äº¤é€š           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘   Â¥1,275    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ® å¨±ä¹           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘  Â¥850      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ  å±…ä½           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Â¥510      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“± é€šè®¯           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Â¥128      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â• æŸ¥çœ‹å…¨éƒ¨å°é‡‘åº“...                                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¸ å¾…åˆ†é…å»ºè®®                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  æ‚¨è¿˜æœ‰ Â¥3,000 å¾…åˆ†é…ï¼Œå»ºè®®ï¼š                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ›¡ï¸ åº”æ€¥é‡‘ +Â¥1,500 ï¼ˆè¡¥å……è‡³4ä¸ªæœˆç›®æ ‡ï¼‰                   â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ¯ å¹´åº¦æ—…è¡ŒåŸºé‡‘ +Â¥1,000                                  â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ’ è‡ªç”±æ”¯é… +Â¥500                                        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                              [ä¸€é”®åˆ†é…]    [è‡ªå®šä¹‰åˆ†é…]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.4.2 é¢„ç®—åˆ†é…å¯è§†åŒ–ç»„ä»¶

```dart
/// æ”¶å…¥æ± å¯è§†åŒ–ç»„ä»¶
class IncomePoolVisualization extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final pool = ref.watch(incomePoolProvider);

    return Column(
      children: [
        // æ€»é‡‘é¢
        Text('Â¥${pool.totalIncome.toStringAsFixed(0)}',
          style: TextStyle(fontSize: 36, fontWeight: FontWeight.bold)),
        SizedBox(height: 16),

        // åˆ†é…è¿›åº¦æ¡
        Stack(
          children: [
            // èƒŒæ™¯
            Container(
              height: 40,
              decoration: BoxDecoration(
                color: Colors.grey.shade200,
                borderRadius: BorderRadius.circular(20),
              ),
            ),
            // å·²åˆ†é…
            FractionallySizedBox(
              widthFactor: pool.allocatedPercentage,
              child: Container(
                height: 40,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.blue.shade400, Colors.green.shade400],
                  ),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Center(
                  child: Text('å·²åˆ†é… Â¥${pool.allocated.toStringAsFixed(0)}',
                    style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                ),
              ),
            ),
          ],
        ),
        SizedBox(height: 8),

        // åˆ†é¡¹è¯´æ˜
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            _buildLegend('å·²åˆ†é…', pool.allocated, Colors.blue),
            _buildLegend('å¾…åˆ†é…', pool.unallocated, Colors.grey),
          ],
        ),
      ],
    );
  }
}

/// å°é‡‘åº“å¡ç‰‡ç»„ä»¶
class VaultCard extends StatelessWidget {
  final BudgetVault vault;

  @override
  Widget build(BuildContext context) {
    final isOverspent = vault.spent > vault.allocated;
    final progress = vault.allocated > 0
        ? vault.spent / vault.allocated
        : 0.0;

    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // æ ‡é¢˜è¡Œ
            Row(
              children: [
                Icon(vault.icon, color: vault.color),
                SizedBox(width: 8),
                Expanded(
                  child: Text(vault.name,
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                ),
                Text(vault.type.displayName,
                  style: TextStyle(color: Colors.grey, fontSize: 12)),
              ],
            ),
            SizedBox(height: 12),

            // é‡‘é¢æ˜¾ç¤º
            Row(
              children: [
                Text('Â¥${vault.spent.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                Text(' / Â¥${vault.allocated.toStringAsFixed(0)}',
                  style: TextStyle(fontSize: 16, color: Colors.grey)),
                Spacer(),
                if (isOverspent)
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: Colors.red.shade50,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text('è¶…æ”¯ Â¥${(vault.spent - vault.allocated).toStringAsFixed(0)}',
                      style: TextStyle(color: Colors.red, fontSize: 12)),
                  ),
              ],
            ),
            SizedBox(height: 8),

            // è¿›åº¦æ¡
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: progress.clamp(0, 1),
                backgroundColor: Colors.grey.shade200,
                valueColor: AlwaysStoppedAnimation(
                  isOverspent ? Colors.red :
                  progress > 0.9 ? Colors.orange :
                  vault.color,
                ),
                minHeight: 8,
              ),
            ),
            SizedBox(height: 8),

            // åº•éƒ¨ä¿¡æ¯
            if (vault.type == VaultType.monthly) ...[
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text('å‰©ä½™ Â¥${(vault.allocated - vault.spent).clamp(0, double.infinity).toStringAsFixed(0)}',
                    style: TextStyle(color: isOverspent ? Colors.red : Colors.green)),
                  Text('å‰©ä½™ ${vault.daysRemaining} å¤©',
                    style: TextStyle(color: Colors.grey, fontSize: 12)),
                  Text('å»ºè®® Â¥${vault.suggestedDailySpend.toStringAsFixed(0)}/å¤©',
                    style: TextStyle(color: Colors.blue, fontSize: 12)),
                ],
              ),
            ],

            // é‡Œç¨‹ç¢‘ï¼ˆç›®æ ‡å‹å°é‡‘åº“ï¼‰
            if (vault.type == VaultType.goal && vault.milestones != null) ...[
              SizedBox(height: 12),
              _buildMilestones(vault.milestones!),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildMilestones(List<Milestone> milestones) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: milestones.map((m) => Column(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: m.isReached ? Colors.green : Colors.grey.shade200,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: m.isReached
                  ? Icon(Icons.check, color: Colors.white, size: 20)
                  : Text(m.label, style: TextStyle(fontSize: 10)),
            ),
          ),
          SizedBox(height: 4),
          Text(m.label, style: TextStyle(fontSize: 10, color: Colors.grey)),
        ],
      )).toList(),
    );
  }
}
```

### 20.5 é’±é¾„ä¸“å±åˆ†æé¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  é’±é¾„åˆ†æ                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        â±ï¸                                    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                      18 å¤©                                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚              Level 3 â€¢ ç¨³å¥è€…                                â”‚   â”‚
â”‚  â”‚              "æœ‰åŠä¸ªæœˆä»¥ä¸Šçš„ç¼“å†²"                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚         â”‚ L1 â”‚ L2 â”‚ L3 â”‚ L4 â”‚ L5 â”‚                          â”‚   â”‚
â”‚  â”‚         â”‚ âœ“  â”‚ âœ“  â”‚ â˜…  â”‚ â—‹  â”‚ â—‹  â”‚                          â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚        æœˆå…‰  èµ·æ­¥  ç¨³å¥  ä»å®¹  è‡ªç”±                           â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“ˆ é’±é¾„å˜åŒ–è¶‹åŠ¿                                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å¤©                                                         â”‚   â”‚
â”‚  â”‚   30 â”¤                         â”Œ â”€ â”€ â”€ â”€ ç›®æ ‡:ä»å®¹è€…         â”‚   â”‚
â”‚  â”‚      â”‚                        â•±                              â”‚   â”‚
â”‚  â”‚   20 â”¤                   â—â”€â”€â—                                â”‚   â”‚
â”‚  â”‚      â”‚              â—â”€â”€â—                                     â”‚   â”‚
â”‚  â”‚   14 â”¤         â—â”€â”€â—                                          â”‚   â”‚
â”‚  â”‚      â”‚    â—â”€â”€â—                                               â”‚   â”‚
â”‚  â”‚    7 â”¤ â—                                                     â”‚   â”‚
â”‚  â”‚      â”‚                                                       â”‚   â”‚
â”‚  â”‚    0 â”¼â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â†’                                 â”‚   â”‚
â”‚  â”‚      6æœˆ 7æœˆ 8æœˆ 9æœˆ 10æœˆ11æœˆ12æœˆ                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ğŸ‰ 6ä¸ªæœˆå†…é’±é¾„ä»7å¤©å¢é•¿åˆ°18å¤©ï¼Œè¿›æ­¥æ˜¾è‘—ï¼                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¯ å‡çº§ä»»åŠ¡                                                 â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  è·ç¦»"ä»å®¹è€…"(30å¤©)è¿˜å·® 12 å¤©                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  éœ€è¦é¢å¤–å‚¨è“„: çº¦ Â¥7,200                                     â”‚   â”‚
â”‚  â”‚  (åŸºäºæ‚¨æ—¥å‡æ”¯å‡º Â¥600 è®¡ç®—)                                  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  æ¨èç­–ç•¥ï¼š                                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  1. æ¯æœˆå¤šå­˜ Â¥1,200ï¼Œçº¦6ä¸ªæœˆè¾¾æˆ                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  2. å‡å°‘å¯é€‰æ¶ˆè´¹10%ï¼Œçº¦4ä¸ªæœˆè¾¾æˆ                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  3. ç»¼åˆç­–ç•¥ï¼Œçº¦3ä¸ªæœˆè¾¾æˆ â­ æ¨è                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š å½±å“é’±é¾„çš„å› ç´                                            â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   æ­£é¢å› ç´  (+)                    è´Ÿé¢å› ç´  (-)               â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚   âœ… åº”æ€¥é‡‘å‚¨å¤‡    +5å¤©          âš ï¸ é«˜é¢‘å¤–å–      -2å¤©      â”‚   â”‚
â”‚  â”‚   âœ… æ”¶å…¥ç¨³å®š      +3å¤©          âš ï¸ è®¢é˜…æœªä½¿ç”¨    -1å¤©      â”‚   â”‚
â”‚  â”‚   âœ… é¢„ç®—æ§åˆ¶è‰¯å¥½  +2å¤©          âš ï¸ æœˆæœ«é›†ä¸­æ¶ˆè´¹  -1å¤©      â”‚   â”‚
â”‚  â”‚   âœ… è®°è´¦ä¹ æƒ¯åšæŒ  +1å¤©                                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚   å‡€å½±å“: +7å¤©                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ’¡ ä¸ªæ€§åŒ–å»ºè®®                                               â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  åŸºäºæ‚¨çš„æ¶ˆè´¹æ¨¡å¼ï¼Œä»¥ä¸‹æ˜¯æå‡é’±é¾„çš„å…·ä½“å»ºè®®ï¼š                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  1. å‡å°‘2æ¯/å‘¨å’–å•¡ â†’ æœˆçœ Â¥240 â†’ é’±é¾„ +0.4å¤©                â”‚   â”‚
â”‚  â”‚  2. å–æ¶ˆé—²ç½®è§†é¢‘ä¼šå‘˜ â†’ æœˆçœ Â¥30 â†’ é’±é¾„ +0.05å¤©              â”‚   â”‚
â”‚  â”‚  3. å¤–å–æ”¹è‡ªå– â†’ æœˆçœ Â¥150 â†’ é’±é¾„ +0.25å¤©                   â”‚   â”‚
â”‚  â”‚  4. è®¾ç½®è‡ªåŠ¨å‚¨è“„ Â¥500/æœˆ â†’ é’±é¾„ +0.8å¤©                      â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  ç»„åˆæ‰§è¡Œé¢„è®¡: é’±é¾„ +1.5å¤©/æœˆ                                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚                                       [å¼€å§‹æ‰§è¡Œè®¡åˆ’ â†’]       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 20.6 è§†è§‰è§„èŒƒä¸äº¤äº’åŸåˆ™

> æ ¸å¿ƒè®¾è®¡åŸåˆ™è¯¦è§ç¬¬4ç« "[æ‡’äººè®¾è®¡åŸåˆ™](#3-æ‡’äººè®¾è®¡åŸåˆ™)"ï¼Œæœ¬èŠ‚èšç„¦äºè§†è§‰å±‚é¢çš„å…·ä½“åº”ç”¨ã€‚

| åŸåˆ™ | æè¿° | åº”ç”¨åœºæ™¯ |
|------|------|----------|
| **å³æ—¶åé¦ˆ** | æ¯ä¸ªæ“ä½œéƒ½æœ‰æ˜ç¡®çš„è§†è§‰åé¦ˆ | æŒ‰é’®ç‚¹å‡»ã€æ•°æ®ä¿å­˜ã€åŒæ­¥çŠ¶æ€ |
| **æ¸è¿›æŠ«éœ²** | æŒ‰éœ€å±•ç¤ºå¤æ‚ä¿¡æ¯ï¼ˆå¯¹åº”ç¬¬4ç« "æ¸è¿›å¼å¤æ‚åº¦åŸåˆ™"ï¼‰ | é«˜çº§è®¾ç½®ã€è¯¦ç»†æŠ¥å‘Š |
| **å®¹é”™è®¾è®¡** | å…è®¸æ’¤é”€ï¼Œé˜²æ­¢è¯¯æ“ä½œï¼ˆå¯¹åº”ç¬¬4ç« "æ™ºèƒ½é»˜è®¤åŸåˆ™"ï¼‰ | åˆ é™¤ç¡®è®¤ã€ç¼–è¾‘æ’¤é”€ |
| **ä¸€è‡´æ€§** | ç›¸åŒåŠŸèƒ½ä½¿ç”¨ç›¸åŒäº¤äº’æ¨¡å¼ | åˆ—è¡¨æ“ä½œã€è¡¨å•è®¾è®¡ |
| **æ— éšœç¢** | æ”¯æŒå„ç±»ç”¨æˆ·ä½¿ç”¨ï¼ˆè¯¦è§ç¬¬3ç« ï¼‰ | è¯­éŸ³æ§åˆ¶ã€é«˜å¯¹æ¯”åº¦ |
| **æ•°æ®å¯è§†åŒ–** | å¤æ‚æ•°æ®ç”¨å›¾è¡¨å‘ˆç° | è¶‹åŠ¿å›¾ã€é¥¼å›¾ã€çƒ­åŠ›å›¾ |
| **æ¸¸æˆåŒ–** | ç­‰çº§ã€å¾½ç« ã€è¿›åº¦æ¿€åŠ±ç”¨æˆ· | é’±é¾„ç­‰çº§ã€è¿ç»­è®°è´¦å¾½ç«  |
| **æ¸©å’Œæé†’** | é¢„è­¦è€Œéæ‰¹è¯„ï¼ˆå¯¹åº”ç¬¬4ç« "ä¼™ä¼´åŸåˆ™"ï¼‰ | è¶…æ”¯å‰é¢„è­¦ã€è®¢é˜…é—²ç½®æé†’ |

### 20.7 ä¸»é¢˜ä¸è§†è§‰

```dart
/// ä¸»é¢˜é…ç½®
class AppTheme {
  /// äº®è‰²ä¸»é¢˜
  static ThemeData light() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: Color(0xFF1976D2),
      brightness: Brightness.light,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,

      // å¡ç‰‡æ ·å¼
      cardTheme: CardTheme(
        elevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
          side: BorderSide(color: colorScheme.outlineVariant),
        ),
      ),

      // æŒ‰é’®æ ·å¼
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),

      // è¾“å…¥æ¡†æ ·å¼
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: colorScheme.surfaceContainerHighest.withOpacity(0.5),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: colorScheme.primary, width: 2),
        ),
      ),

      // åˆ—è¡¨é¡¹æ ·å¼
      listTileTheme: ListTileThemeData(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      ),
    );
  }

  /// æš—è‰²ä¸»é¢˜
  static ThemeData dark() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: Color(0xFF42A5F5),
      brightness: Brightness.dark,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,
      // ... æš—è‰²ä¸»é¢˜é…ç½®
    );
  }
}
```

### 20.8 æ ¸å¿ƒé¡µé¢å¸ƒå±€

#### 20.8.1 é¦–é¡µä»ªè¡¨ç›˜

```dart
/// é¦–é¡µä»ªè¡¨ç›˜
class DashboardPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      body: CustomScrollView(
        slivers: [
          // é¡¶éƒ¨æ¦‚è§ˆ
          SliverToBoxAdapter(
            child: _MonthlyOverviewCard(),
          ),

          // å¿«æ·æ“ä½œåŒº
          SliverToBoxAdapter(
            child: _QuickActionsRow(),
          ),

          // åŠŸèƒ½å¡ç‰‡ç½‘æ ¼
          SliverPadding(
            padding: EdgeInsets.all(16),
            sliver: SliverGrid(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                mainAxisSpacing: 16,
                crossAxisSpacing: 16,
                childAspectRatio: 1.2,
              ),
              delegate: SliverChildListDelegate([
                // é’±é¾„å¡ç‰‡
                MoneyAgeDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/money-age'),
                ),
                // é¢„ç®—å¡ç‰‡
                BudgetDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/budget'),
                ),
                // å°é‡‘åº“å¡ç‰‡
                VaultDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/vaults'),
                ),
                // è´¦æˆ·å¡ç‰‡
                AccountDashboardCard(
                  onTap: () => Navigator.pushNamed(context, '/accounts'),
                ),
              ]),
            ),
          ),

          // æœ€è¿‘äº¤æ˜“
          SliverToBoxAdapter(
            child: _RecentTransactionsSection(),
          ),
        ],
      ),

      // å¿«é€Ÿè®°è´¦æŒ‰é’®
      floatingActionButton: _ExpandableFAB(),
    );
  }
}

/// å¯å±•å¼€çš„FABï¼ˆå¿«é€Ÿè®°è´¦å…¥å£ï¼‰
class _ExpandableFAB extends StatefulWidget {
  @override
  _ExpandableFABState createState() => _ExpandableFABState();
}

class _ExpandableFABState extends State<_ExpandableFAB>
    with SingleTickerProviderStateMixin {
  bool _isOpen = false;
  late AnimationController _controller;

  @override
  Widget build(BuildContext context) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        // å±•å¼€çš„é€‰é¡¹
        if (_isOpen) ...[
          _buildOption(
            icon: Icons.mic,
            label: 'è¯­éŸ³',
            onTap: () => Navigator.pushNamed(context, '/voice-entry'),
          ),
          SizedBox(height: 8),
          _buildOption(
            icon: Icons.camera_alt,
            label: 'æ‹ç…§',
            onTap: () => Navigator.pushNamed(context, '/image-entry'),
          ),
          SizedBox(height: 8),
          _buildOption(
            icon: Icons.edit,
            label: 'æ‰‹åŠ¨',
            onTap: () => Navigator.pushNamed(context, '/manual-entry'),
          ),
          SizedBox(height: 16),
        ],

        // ä¸»æŒ‰é’®
        FloatingActionButton(
          onPressed: () => setState(() => _isOpen = !_isOpen),
          child: AnimatedRotation(
            turns: _isOpen ? 0.125 : 0,
            duration: Duration(milliseconds: 200),
            child: Icon(Icons.add),
          ),
        ),
      ],
    );
  }
}
```

### 20.9 æ‰‹åŠ¿äº¤äº’

```dart
/// äº¤æ˜“åˆ—è¡¨é¡¹ï¼ˆæ”¯æŒæ»‘åŠ¨æ“ä½œï¼‰
class TransactionListItem extends StatelessWidget {
  final Transaction transaction;
  final VoidCallback? onTap;
  final VoidCallback? onEdit;
  final VoidCallback? onDelete;

  @override
  Widget build(BuildContext context) {
    return Dismissible(
      key: Key(transaction.id),
      background: _buildSwipeBackground(
        color: Colors.blue,
        icon: Icons.edit,
        alignment: Alignment.centerLeft,
      ),
      secondaryBackground: _buildSwipeBackground(
        color: Colors.red,
        icon: Icons.delete,
        alignment: Alignment.centerRight,
      ),
      confirmDismiss: (direction) async {
        if (direction == DismissDirection.startToEnd) {
          onEdit?.call();
          return false;  // ä¸åˆ é™¤ï¼Œåªè§¦å‘ç¼–è¾‘
        } else {
          return await _showDeleteConfirm(context);
        }
      },
      onDismissed: (direction) {
        if (direction == DismissDirection.endToStart) {
          onDelete?.call();
        }
      },
      child: ListTile(
        onTap: onTap,
        leading: CategoryIcon(categoryId: transaction.categoryId),
        title: Text(transaction.description ?? 'æ— æè¿°'),
        subtitle: Text(transaction.date.format('yyyy-MM-dd')),
        trailing: AmountText(
          amount: transaction.amount,
          type: transaction.type,
        ),
      ),
    );
  }
}
```

---


---

### 20.10 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 20.10.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

ç”¨æˆ·ä½“éªŒè®¾è®¡ä¸å…¶ä»–2.0æ¨¡å—çš„é›†æˆèšç„¦äºè§†è§‰å‘ˆç°å’Œäº¤äº’æµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ä½“éªŒé›†æˆå…¨æ™¯å›¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        UXè®¾è®¡ç³»ç»Ÿæ ¸å¿ƒ                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ è§†è§‰è§„èŒƒ  â”‚  â”‚ äº¤äº’æ¨¡å¼  â”‚  â”‚ åŠ¨æ•ˆç³»ç»Ÿ  â”‚  â”‚ ç»„ä»¶åº“   â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡    â”‚     â”‚  æ™ºèƒ½å¢å¼º    â”‚     â”‚  2.0æ–°å¢    â”‚                 â”‚
â”‚  â”‚  ç•Œé¢é›†æˆ    â”‚     â”‚  ç•Œé¢é›†æˆ    â”‚     â”‚  ç•Œé¢é›†æˆ    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ é’±é¾„ä»ªè¡¨ç›˜â”‚     â”‚ â€¢ AIè¯†åˆ«ç»“æœâ”‚     â”‚ â€¢ è¯­éŸ³äº¤äº’UIâ”‚                 â”‚
â”‚  â”‚ â€¢ é¢„ç®—å¡ç‰‡  â”‚     â”‚ â€¢ æ™ºèƒ½å»ºè®®å¡â”‚     â”‚ â€¢ å®¶åº­è§†å›¾  â”‚                 â”‚
â”‚  â”‚ â€¢ ä¹ æƒ¯æ‰“å¡  â”‚     â”‚ â€¢ æ´å¯Ÿå›¾è¡¨  â”‚     â”‚ â€¢ æ–°æ‰‹å¼•å¯¼  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 20.10.2 è¯­éŸ³äº¤äº’ç•Œé¢é›†æˆ

```dart
/// è¯­éŸ³äº¤äº’UIç»„ä»¶
class VoiceInteractionUI extends StatefulWidget {
  final VoiceRecognitionService voiceService;
  final Function(String) onResult;

  @override
  State<VoiceInteractionUI> createState() => _VoiceInteractionUIState();
}

class _VoiceInteractionUIState extends State<VoiceInteractionUI>
    with SingleTickerProviderStateMixin {
  late AnimationController _waveController;
  VoiceState _state = VoiceState.idle;
  String _recognizedText = '';
  double _volume = 0.0;

  @override
  void initState() {
    super.initState();
    _waveController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    )..repeat();

    widget.voiceService.volumeStream.listen((volume) {
      setState(() => _volume = volume);
    });

    widget.voiceService.stateStream.listen((state) {
      setState(() => _state = state);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surface,
        borderRadius: BorderRadius.circular(24),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // è¯­éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨
          _buildStateIndicator(),
          const SizedBox(height: 16),

          // æ³¢å½¢åŠ¨ç”»
          _buildWaveAnimation(),
          const SizedBox(height: 16),

          // è¯†åˆ«æ–‡æœ¬æ˜¾ç¤º
          _buildRecognizedText(),
          const SizedBox(height: 24),

          // æ“ä½œæŒ‰é’®
          _buildActionButtons(),
        ],
      ),
    );
  }

  Widget _buildWaveAnimation() {
    return AnimatedBuilder(
      animation: _waveController,
      builder: (context, child) {
        return CustomPaint(
          size: const Size(200, 60),
          painter: VoiceWavePainter(
            progress: _waveController.value,
            volume: _volume,
            color: _getStateColor(),
            isActive: _state == VoiceState.listening,
          ),
        );
      },
    );
  }

  Widget _buildStateIndicator() {
    final stateConfig = _getStateConfig();
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Icon(stateConfig.icon, color: stateConfig.color, size: 20),
        const SizedBox(width: 8),
        Text(
          stateConfig.text,
          style: TextStyle(
            color: stateConfig.color,
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  StateConfig _getStateConfig() {
    switch (_state) {
      case VoiceState.idle:
        return StateConfig(
          icon: Icons.mic_none,
          text: 'ç‚¹å‡»å¼€å§‹è¯­éŸ³è®°è´¦',
          color: Colors.grey,
        );
      case VoiceState.listening:
        return StateConfig(
          icon: Icons.mic,
          text: 'æ­£åœ¨è†å¬...',
          color: Theme.of(context).colorScheme.primary,
        );
      case VoiceState.processing:
        return StateConfig(
          icon: Icons.psychology,
          text: 'AIæ­£åœ¨ç†è§£...',
          color: Colors.orange,
        );
      case VoiceState.success:
        return StateConfig(
          icon: Icons.check_circle,
          text: 'è¯†åˆ«å®Œæˆ',
          color: Colors.green,
        );
      case VoiceState.error:
        return StateConfig(
          icon: Icons.error,
          text: 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•',
          color: Colors.red,
        );
    }
  }
}

/// æ³¢å½¢ç»˜åˆ¶å™¨
class VoiceWavePainter extends CustomPainter {
  final double progress;
  final double volume;
  final Color color;
  final bool isActive;

  VoiceWavePainter({
    required this.progress,
    required this.volume,
    required this.color,
    required this.isActive,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (!isActive) {
      // é™æ€æ³¢å½¢
      _drawStaticWave(canvas, size);
      return;
    }

    // åŠ¨æ€æ³¢å½¢
    final paint = Paint()
      ..color = color
      ..style = PaintingStyle.fill;

    final barCount = 20;
    final barWidth = size.width / (barCount * 2);

    for (int i = 0; i < barCount; i++) {
      final x = i * barWidth * 2 + barWidth / 2;
      final normalizedHeight = (sin((i / barCount + progress) * 2 * pi) + 1) / 2;
      final barHeight = normalizedHeight * size.height * volume.clamp(0.2, 1.0);

      canvas.drawRRect(
        RRect.fromRectAndRadius(
          Rect.fromCenter(
            center: Offset(x, size.height / 2),
            width: barWidth,
            height: barHeight,
          ),
          Radius.circular(barWidth / 2),
        ),
        paint,
      );
    }
  }

  @override
  bool shouldRepaint(VoiceWavePainter oldDelegate) {
    return oldDelegate.progress != progress ||
        oldDelegate.volume != volume ||
        oldDelegate.isActive != isActive;
  }
}
```

#### 20.10.3 AIè¯†åˆ«ç»“æœå±•ç¤º

```dart
/// AIè¯†åˆ«ç»“æœå±•ç¤ºç»„ä»¶
class AIRecognitionResultCard extends StatelessWidget {
  final RecognitionResult result;
  final VoidCallback onConfirm;
  final VoidCallback onEdit;
  final VoidCallback onRetry;

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // å¤´éƒ¨ï¼šAIè¯†åˆ«æ ‡è¯†
            _buildHeader(context),
            const SizedBox(height: 16),

            // è¯†åˆ«ç»“æœé¢„è§ˆ
            _buildResultPreview(context),
            const SizedBox(height: 16),

            // ç½®ä¿¡åº¦æŒ‡ç¤ºå™¨
            _buildConfidenceIndicator(context),
            const SizedBox(height: 16),

            // æ“ä½œæŒ‰é’®
            _buildActions(context),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    return Row(
      children: [
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.primaryContainer,
            borderRadius: BorderRadius.circular(8),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.auto_awesome,
                size: 16,
                color: Theme.of(context).colorScheme.primary,
              ),
              const SizedBox(width: 4),
              Text(
                'AIæ™ºèƒ½è¯†åˆ«',
                style: TextStyle(
                  fontSize: 12,
                  color: Theme.of(context).colorScheme.primary,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ),
        const Spacer(),
        Text(
          _getSourceLabel(),
          style: Theme.of(context).textTheme.bodySmall,
        ),
      ],
    );
  }

  Widget _buildResultPreview(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surfaceVariant,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        children: [
          // åˆ†ç±»å›¾æ ‡
          CategoryIcon(
            categoryId: result.categoryId,
            size: 48,
          ),
          const SizedBox(width: 12),

          // äº¤æ˜“ä¿¡æ¯
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  result.description ?? 'æœªè¯†åˆ«æè¿°',
                  style: Theme.of(context).textTheme.titleMedium,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 4),
                Text(
                  result.categoryName,
                  style: Theme.of(context).textTheme.bodySmall,
                ),
              ],
            ),
          ),

          // é‡‘é¢
          AmountText(
            amount: result.amount,
            type: result.type,
            style: Theme.of(context).textTheme.titleLarge?.copyWith(
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConfidenceIndicator(BuildContext context) {
    final confidence = result.confidence;
    final color = confidence >= 0.9
        ? Colors.green
        : confidence >= 0.7
            ? Colors.orange
            : Colors.red;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              'AIç½®ä¿¡åº¦',
              style: Theme.of(context).textTheme.bodySmall,
            ),
            Text(
              '${(confidence * 100).toStringAsFixed(0)}%',
              style: TextStyle(
                color: color,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
        const SizedBox(height: 4),
        LinearProgressIndicator(
          value: confidence,
          backgroundColor: color.withOpacity(0.2),
          valueColor: AlwaysStoppedAnimation<Color>(color),
          borderRadius: BorderRadius.circular(4),
        ),
        if (confidence < 0.7) ...[
          const SizedBox(height: 8),
          Text(
            'ğŸ’¡ å»ºè®®æ£€æŸ¥è¯†åˆ«ç»“æœæ˜¯å¦å‡†ç¡®',
            style: TextStyle(
              fontSize: 12,
              color: Colors.orange[700],
            ),
          ),
        ],
      ],
    );
  }

  Widget _buildActions(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: OutlinedButton.icon(
            onPressed: onRetry,
            icon: const Icon(Icons.refresh, size: 18),
            label: const Text('é‡æ–°è¯†åˆ«'),
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: OutlinedButton.icon(
            onPressed: onEdit,
            icon: const Icon(Icons.edit, size: 18),
            label: const Text('ç¼–è¾‘'),
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          flex: 2,
          child: FilledButton.icon(
            onPressed: onConfirm,
            icon: const Icon(Icons.check, size: 18),
            label: const Text('ç¡®è®¤è®°è´¦'),
          ),
        ),
      ],
    );
  }

  String _getSourceLabel() {
    switch (result.source) {
      case RecognitionSource.voice:
        return 'æ¥è‡ªè¯­éŸ³';
      case RecognitionSource.image:
        return 'æ¥è‡ªå›¾ç‰‡';
      case RecognitionSource.text:
        return 'æ¥è‡ªæ–‡æœ¬';
    }
  }
}
```

#### 20.10.4 å®¶åº­è´¦æœ¬ç•Œé¢é›†æˆ

```dart
/// å®¶åº­è´¦æœ¬è§†å›¾åˆ‡æ¢å™¨
class FamilyViewSwitcher extends StatelessWidget {
  final String? currentFamilyId;
  final List<FamilyInfo> families;
  final Function(String?) onFamilyChanged;

  @override
  Widget build(BuildContext context) {
    return PopupMenuButton<String?>(
      initialValue: currentFamilyId,
      onSelected: onFamilyChanged,
      offset: const Offset(0, 48),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: Theme.of(context).colorScheme.surfaceVariant,
          borderRadius: BorderRadius.circular(20),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              currentFamilyId == null ? Icons.person : Icons.family_restroom,
              size: 20,
            ),
            const SizedBox(width: 8),
            Text(
              currentFamilyId == null
                  ? 'ä¸ªäººè´¦æœ¬'
                  : families.firstWhere((f) => f.id == currentFamilyId).name,
              style: const TextStyle(fontWeight: FontWeight.w500),
            ),
            const SizedBox(width: 4),
            const Icon(Icons.arrow_drop_down, size: 20),
          ],
        ),
      ),
      itemBuilder: (context) => [
        // ä¸ªäººè´¦æœ¬é€‰é¡¹
        PopupMenuItem<String?>(
          value: null,
          child: ListTile(
            leading: const Icon(Icons.person),
            title: const Text('ä¸ªäººè´¦æœ¬'),
            trailing: currentFamilyId == null
                ? const Icon(Icons.check, color: Colors.green)
                : null,
            contentPadding: EdgeInsets.zero,
          ),
        ),
        const PopupMenuDivider(),
        // å®¶åº­è´¦æœ¬åˆ—è¡¨
        ...families.map((family) => PopupMenuItem<String>(
          value: family.id,
          child: ListTile(
            leading: CircleAvatar(
              backgroundImage: family.avatarUrl != null
                  ? NetworkImage(family.avatarUrl!)
                  : null,
              child: family.avatarUrl == null
                  ? Text(family.name[0])
                  : null,
            ),
            title: Text(family.name),
            subtitle: Text('${family.memberCount}ä½æˆå‘˜'),
            trailing: currentFamilyId == family.id
                ? const Icon(Icons.check, color: Colors.green)
                : null,
            contentPadding: EdgeInsets.zero,
          ),
        )),
        const PopupMenuDivider(),
        // åˆ›å»º/åŠ å…¥å®¶åº­
        PopupMenuItem<String>(
          value: '__create__',
          child: ListTile(
            leading: const Icon(Icons.add_circle_outline),
            title: const Text('åˆ›å»ºæˆ–åŠ å…¥å®¶åº­'),
            contentPadding: EdgeInsets.zero,
          ),
        ),
      ],
    );
  }
}

/// å®¶åº­æˆå‘˜æ¶ˆè´¹æ’è¡Œæ¦œ
class FamilyMemberRanking extends StatelessWidget {
  final List<MemberSpending> rankings;
  final String currentUserId;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                const Icon(Icons.leaderboard, size: 20),
                const SizedBox(width: 8),
                Text(
                  'æœ¬æœˆæ¶ˆè´¹æ’è¡Œ',
                  style: Theme.of(context).textTheme.titleMedium,
                ),
              ],
            ),
            const SizedBox(height: 16),
            ...rankings.asMap().entries.map((entry) {
              final index = entry.key;
              final member = entry.value;
              final isCurrentUser = member.userId == currentUserId;

              return _buildRankingItem(
                context,
                rank: index + 1,
                member: member,
                isCurrentUser: isCurrentUser,
              );
            }),
          ],
        ),
      ),
    );
  }

  Widget _buildRankingItem(
    BuildContext context, {
    required int rank,
    required MemberSpending member,
    required bool isCurrentUser,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: isCurrentUser
            ? Theme.of(context).colorScheme.primaryContainer.withOpacity(0.3)
            : null,
        borderRadius: BorderRadius.circular(8),
        border: isCurrentUser
            ? Border.all(color: Theme.of(context).colorScheme.primary)
            : null,
      ),
      child: Row(
        children: [
          // æ’å
          SizedBox(
            width: 32,
            child: Text(
              _getRankEmoji(rank),
              style: const TextStyle(fontSize: 20),
            ),
          ),
          // å¤´åƒ
          CircleAvatar(
            radius: 18,
            backgroundImage: member.avatarUrl != null
                ? NetworkImage(member.avatarUrl!)
                : null,
            child: member.avatarUrl == null
                ? Text(member.name[0])
                : null,
          ),
          const SizedBox(width: 12),
          // åå­—
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  member.name + (isCurrentUser ? ' (æˆ‘)' : ''),
                  style: const TextStyle(fontWeight: FontWeight.w500),
                ),
                Text(
                  '${member.transactionCount}ç¬”äº¤æ˜“',
                  style: Theme.of(context).textTheme.bodySmall,
                ),
              ],
            ),
          ),
          // é‡‘é¢
          Text(
            'Â¥${member.totalAmount.toStringAsFixed(0)}',
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: rank == 1 ? Colors.orange : null,
            ),
          ),
        ],
      ),
    );
  }

  String _getRankEmoji(int rank) {
    switch (rank) {
      case 1: return 'ğŸ¥‡';
      case 2: return 'ğŸ¥ˆ';
      case 3: return 'ğŸ¥‰';
      default: return '$rank';
    }
  }
}
```

#### 20.10.5 æ–°æ‰‹å¼•å¯¼æµç¨‹é›†æˆ

```dart
/// æ–°æ‰‹å¼•å¯¼ç®¡ç†å™¨
class OnboardingManager {
  final UserPreferences _prefs;
  final AnalyticsService _analytics;

  /// å¼•å¯¼æ­¥éª¤å®šä¹‰
  static const onboardingSteps = [
    OnboardingStep(
      id: 'welcome',
      title: 'æ¬¢è¿ä½¿ç”¨ AIæ™ºèƒ½è®°è´¦',
      description: 'æ‚¨çš„æ™ºèƒ½è´¢åŠ¡ä¼™ä¼´ï¼Œå¸®åŠ©æ‚¨å…»æˆè‰¯å¥½çš„ç†è´¢ä¹ æƒ¯',
      illustration: 'assets/onboarding/welcome.svg',
    ),
    OnboardingStep(
      id: 'money_age',
      title: 'è®¤è¯†"é’±é¾„"',
      description: 'é’±é¾„æ˜¯è¡¡é‡æ‚¨è´¢åŠ¡å¥åº·çš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œæ•°å€¼è¶Šé«˜ä»£è¡¨æ‚¨çš„è´¢åŠ¡çŠ¶å†µè¶Šç¨³å®š',
      illustration: 'assets/onboarding/money_age.svg',
      highlightFeature: 'moneyAgeWidget',
    ),
    OnboardingStep(
      id: 'zero_budget',
      title: 'é›¶åŸºé¢„ç®—æ³•',
      description: 'ç»™æ¯ä¸€åˆ†é’±éƒ½å®‰æ’å·¥ä½œï¼Œè®©æ‚¨çš„æ”¶å…¥å‘æŒ¥æœ€å¤§ä»·å€¼',
      illustration: 'assets/onboarding/zero_budget.svg',
      highlightFeature: 'budgetAllocation',
    ),
    OnboardingStep(
      id: 'voice_record',
      title: 'è¯­éŸ³å¿«é€Ÿè®°è´¦',
      description: 'è¯´ä¸€å¥è¯å°±èƒ½è®°è´¦ï¼Œæ¯”å¦‚"åˆé¤èŠ±äº†25å—"',
      illustration: 'assets/onboarding/voice.svg',
      demoAction: DemoAction.showVoiceDemo,
    ),
    OnboardingStep(
      id: 'ai_insights',
      title: 'AIæ™ºèƒ½æ´å¯Ÿ',
      description: 'æˆ‘ä»¬ä¼šåˆ†ææ‚¨çš„æ¶ˆè´¹ä¹ æƒ¯ï¼Œæä¾›ä¸ªæ€§åŒ–çš„çœé’±å»ºè®®',
      illustration: 'assets/onboarding/ai_insights.svg',
    ),
    OnboardingStep(
      id: 'ready',
      title: 'å‡†å¤‡å¼€å§‹ï¼',
      description: 'è®¾ç½®æ‚¨çš„ç¬¬ä¸€ä¸ªæœˆé¢„ç®—ï¼Œå¼€å¯ç†è´¢ä¹‹æ—…',
      illustration: 'assets/onboarding/start.svg',
      action: OnboardingAction.setupFirstBudget,
    ),
  ];

  /// æ˜¾ç¤ºå¼•å¯¼é¡µé¢
  Future<void> showOnboarding(BuildContext context) async {
    final completed = await _prefs.isOnboardingCompleted();
    if (completed) return;

    await Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => OnboardingScreen(
          steps: onboardingSteps,
          onComplete: () async {
            await _prefs.setOnboardingCompleted(true);
            await _analytics.logEvent('onboarding_completed');
            Navigator.of(context).pop();
          },
          onSkip: () async {
            await _prefs.setOnboardingCompleted(true);
            await _analytics.logEvent('onboarding_skipped');
            Navigator.of(context).pop();
          },
        ),
        fullscreenDialog: true,
      ),
    );
  }

  /// æ˜¾ç¤ºåŠŸèƒ½å¼•å¯¼æ°”æ³¡
  Future<void> showFeatureCoachMark(
    BuildContext context,
    String featureId,
    GlobalKey targetKey,
  ) async {
    final shown = await _prefs.isCoachMarkShown(featureId);
    if (shown) return;

    final config = _getCoachMarkConfig(featureId);
    if (config == null) return;

    await showCoachMark(
      context: context,
      targetKey: targetKey,
      title: config.title,
      description: config.description,
      onDismiss: () async {
        await _prefs.setCoachMarkShown(featureId);
      },
    );
  }

  CoachMarkConfig? _getCoachMarkConfig(String featureId) {
    const configs = {
      'voice_button': CoachMarkConfig(
        title: 'è¯­éŸ³è®°è´¦',
        description: 'ç‚¹å‡»è¿™é‡Œï¼Œè¯´å‡ºæ‚¨çš„æ¶ˆè´¹ï¼ŒAIä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è®°å½•',
      ),
      'money_age_card': CoachMarkConfig(
        title: 'æ‚¨çš„é’±é¾„',
        description: 'è¿™æ˜¯æ‚¨çš„è´¢åŠ¡å¥åº·æŒ‡æ ‡ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åˆ†æ',
      ),
      'quick_add': CoachMarkConfig(
        title: 'å¿«é€Ÿè®°è´¦',
        description: 'é•¿æŒ‰å¯ä»¥é€‰æ‹©ä¸åŒçš„è®°è´¦æ–¹å¼',
      ),
      'budget_card': CoachMarkConfig(
        title: 'é¢„ç®—ç®¡ç†',
        description: 'ç‚¹å‡»æŸ¥çœ‹å’Œè°ƒæ•´æ‚¨çš„å°é‡‘åº“åˆ†é…',
      ),
    };
    return configs[featureId];
  }
}

/// å¼•å¯¼æ°”æ³¡ç»„ä»¶
class CoachMarkOverlay extends StatelessWidget {
  final GlobalKey targetKey;
  final String title;
  final String description;
  final VoidCallback onDismiss;

  @override
  Widget build(BuildContext context) {
    final targetBox = targetKey.currentContext?.findRenderObject() as RenderBox?;
    if (targetBox == null) return const SizedBox();

    final targetPosition = targetBox.localToGlobal(Offset.zero);
    final targetSize = targetBox.size;

    return Stack(
      children: [
        // åŠé€æ˜é®ç½©ï¼ˆé•‚ç©ºç›®æ ‡åŒºåŸŸï¼‰
        CustomPaint(
          size: MediaQuery.of(context).size,
          painter: CoachMarkPainter(
            targetRect: Rect.fromLTWH(
              targetPosition.dx - 8,
              targetPosition.dy - 8,
              targetSize.width + 16,
              targetSize.height + 16,
            ),
          ),
        ),

        // æç¤ºå¡ç‰‡
        Positioned(
          left: 16,
          right: 16,
          top: targetPosition.dy + targetSize.height + 16,
          child: Card(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    title,
                    style: Theme.of(context).textTheme.titleMedium?.copyWith(
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(description),
                  const SizedBox(height: 16),
                  Align(
                    alignment: Alignment.centerRight,
                    child: FilledButton(
                      onPressed: onDismiss,
                      child: const Text('çŸ¥é“äº†'),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}
```

#### 20.10.6 æˆå°±ç³»ç»Ÿç•Œé¢é›†æˆ

```dart
/// æˆå°±è§£é”åŠ¨ç”»
class AchievementUnlockAnimation extends StatefulWidget {
  final Achievement achievement;
  final VoidCallback onComplete;

  @override
  State<AchievementUnlockAnimation> createState() =>
      _AchievementUnlockAnimationState();
}

class _AchievementUnlockAnimationState extends State<AchievementUnlockAnimation>
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _confettiController;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();

    _scaleController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );

    _confettiController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _scaleAnimation = CurvedAnimation(
      parent: _scaleController,
      curve: Curves.elasticOut,
    );

    // å¯åŠ¨åŠ¨ç”»åºåˆ—
    _startAnimationSequence();
  }

  Future<void> _startAnimationSequence() async {
    // 1. ç¼©æ”¾åŠ¨ç”»
    await _scaleController.forward();

    // 2. ç¤¼èŠ±åŠ¨ç”»
    _confettiController.forward();

    // 3. æ’­æ”¾éŸ³æ•ˆ
    await HapticFeedback.mediumImpact();

    // 4. å»¶è¿Ÿåå…³é—­
    await Future.delayed(const Duration(seconds: 2));
    widget.onComplete();
  }

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.black54,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // ç¤¼èŠ±æ•ˆæœ
          ConfettiWidget(
            confettiController: _confettiController,
            blastDirectionality: BlastDirectionality.explosive,
            colors: const [
              Colors.yellow,
              Colors.orange,
              Colors.pink,
              Colors.purple,
            ],
          ),

          // æˆå°±å¡ç‰‡
          ScaleTransition(
            scale: _scaleAnimation,
            child: _buildAchievementCard(context),
          ),
        ],
      ),
    );
  }

  Widget _buildAchievementCard(BuildContext context) {
    return Container(
      width: 280,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Colors.amber[300]!,
            Colors.orange[400]!,
          ],
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.orange.withOpacity(0.4),
            blurRadius: 20,
            spreadRadius: 5,
          ),
        ],
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // ğŸ‰ å›¾æ ‡
          const Text(
            'ğŸ‰',
            style: TextStyle(fontSize: 48),
          ),
          const SizedBox(height: 16),

          // æ ‡é¢˜
          const Text(
            'æˆå°±è§£é”ï¼',
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 16),

          // å¾½ç« 
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              color: Colors.white,
              shape: BoxShape.circle,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 10,
                ),
              ],
            ),
            child: Center(
              child: Text(
                widget.achievement.icon,
                style: const TextStyle(fontSize: 40),
              ),
            ),
          ),
          const SizedBox(height: 16),

          // æˆå°±åç§°
          Text(
            widget.achievement.name,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: Colors.white,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),

          // æˆå°±æè¿°
          Text(
            widget.achievement.description,
            style: TextStyle(
              fontSize: 14,
              color: Colors.white.withOpacity(0.9),
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),

          // å¥–åŠ±
          if (widget.achievement.reward != null)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.3),
                borderRadius: BorderRadius.circular(20),
              ),
              child: Text(
                'å¥–åŠ±ï¼š${widget.achievement.reward}',
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _confettiController.dispose();
    super.dispose();
  }
}
```

---

## 21. å›½é™…åŒ–ä¸æœ¬åœ°åŒ–

### 21.0 è®¾è®¡åŸåˆ™å›é¡¾

åœ¨æ·±å…¥å›½é™…åŒ–ä¸æœ¬åœ°åŒ–ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾æœ¬ç« å¦‚ä½•ä½“ç°2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å›½é™…åŒ–ä¸æœ¬åœ°åŒ– - è®¾è®¡åŸåˆ™çŸ©é˜µ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ–‡åŒ–é€‚åº”    â”‚  â”‚  ä¸€è‡´ä½“éªŒ    â”‚  â”‚  çµæ´»æ‰©å±•    â”‚  â”‚  æ€§èƒ½ä¼˜å…ˆ    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ å°Šé‡æ–‡åŒ–    â”‚  â”‚ åŠŸèƒ½ä¸€è‡´    â”‚  â”‚ æ˜“äºæ‰©å±•    â”‚  â”‚ æŒ‰éœ€åŠ è½½    â”‚       â”‚
â”‚  â”‚ æœ¬åœ°ä¹ æƒ¯    â”‚  â”‚ ä½“éªŒç»Ÿä¸€    â”‚  â”‚ æœ€å°æ”¹åŠ¨    â”‚  â”‚ æ‡’åŠ è½½èµ„æº  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚              â”‚
â”‚         â–¼                â–¼                â–¼                â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  è´§å¸æ ¼å¼    â”‚  â”‚  æ—¥æœŸæ—¶é—´    â”‚  â”‚  åˆ†ç±»ç¿»è¯‘    â”‚  â”‚  AIæœ¬åœ°åŒ–   â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ åœ°åŒºç¬¦å·    â”‚  â”‚ åœ°åŒºæ ¼å¼    â”‚  â”‚ å¤šè¯­è¨€åç§°  â”‚  â”‚ è¯­è¨€è¾“å‡º    â”‚       â”‚
â”‚  â”‚ åƒåˆ†ä½      â”‚  â”‚ æ—¶åŒºå¤„ç†    â”‚  â”‚ å›¾æ ‡é€‚é…    â”‚  â”‚ æç¤ºè¯ç¿»è¯‘  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â”‚  å›½é™…åŒ–æ ¸å¿ƒç†å¿µï¼š                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "æ–‡åŒ–å°Šé‡ï¼Œä½“éªŒä¸€è‡´ï¼Œçµæ´»æ‰©å±•ï¼Œæ€§èƒ½ä¼˜å…ˆ"                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   æ–‡åŒ–å°Šé‡ â”€â”€â†’ å°Šé‡ä¸åŒåœ°åŒºçš„è¯­è¨€ã€è´§å¸ã€æ—¥æœŸä¹ æƒ¯                       â”‚   â”‚
â”‚  â”‚   ä½“éªŒä¸€è‡´ â”€â”€â†’ æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬åŠŸèƒ½å®Œæ•´ã€ä½“éªŒç»Ÿä¸€                          â”‚   â”‚
â”‚  â”‚   çµæ´»æ‰©å±• â”€â”€â†’ æ˜“äºæ·»åŠ æ–°è¯­è¨€ï¼Œæœ€å°ä»£ç æ”¹åŠ¨                            â”‚   â”‚
â”‚  â”‚   æ€§èƒ½ä¼˜å…ˆ â”€â”€â†’ è¯­è¨€èµ„æºæŒ‰éœ€åŠ è½½ï¼Œä¸å½±å“å¯åŠ¨é€Ÿåº¦                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 21.0.1 å›½é™…åŒ–è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å›½é™…åŒ–è®¾è®¡åŸåˆ™                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ–‡åŒ–é€‚åº”æ€§  â”‚    â”‚  ä¸€è‡´æ€§ä½“éªŒ  â”‚    â”‚  çµæ´»æ‰©å±•   â”‚    â”‚  æ€§èƒ½ä¼˜å…ˆ   â”‚ â”‚
â”‚  â”‚  Cultural   â”‚    â”‚  Consistent â”‚    â”‚  Extensible â”‚    â”‚  Performanceâ”‚ â”‚
â”‚  â”‚  Adaptation â”‚    â”‚  Experience â”‚    â”‚   Design    â”‚    â”‚    First    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†“                  â†“                  â†“                  â†“          â”‚
â”‚   å°Šé‡ä¸åŒåœ°åŒº       æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬         æ˜“äºæ·»åŠ æ–°è¯­è¨€       æœ¬åœ°åŒ–èµ„æº      â”‚
â”‚   çš„æ–‡åŒ–ä¹ æƒ¯         åŠŸèƒ½ä½“éªŒä¸€è‡´         æœ€å°ä»£ç æ”¹åŠ¨         æŒ‰éœ€åŠ è½½        â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 21.0.2 2.0ç‰ˆæœ¬å›½é™…åŒ–ç›®æ ‡

| ç›®æ ‡ | æè¿° | è¾¾æˆæ ‡å‡† |
|------|------|----------|
| **è¯­è¨€è¦†ç›–** | æ”¯æŒä¸œäºšä¸»è¦è¯­è¨€å¸‚åœº | ç®€ä¸­/ç¹ä¸­/è‹±/æ—¥/éŸ© 5ç§è¯­è¨€å®Œæ•´ç¿»è¯‘ |
| **è´§å¸æ”¯æŒ** | æ”¯æŒä¸»æµè´§å¸ | CNY/USD/EUR/JPY/KRW/HKD/TWD/GBP |
| **æ—¥æœŸæ ¼å¼** | ç¬¦åˆåœ°åŒºä¹ æƒ¯ | è‡ªåŠ¨åŒ¹é…åœ°åŒºæ—¥æœŸæ ¼å¼åå¥½ |
| **åˆ†ç±»æœ¬åœ°åŒ–** | é¢„è®¾åˆ†ç±»ç¿»è¯‘ | æ‰€æœ‰åˆ†ç±»æ”¯æŒå¤šè¯­è¨€æ˜¾ç¤º |
| **AIå†…å®¹** | AIç”Ÿæˆå†…å®¹æœ¬åœ°åŒ– | AIæ´å¯Ÿã€å»ºè®®ä½¿ç”¨ç”¨æˆ·è¯­è¨€ |
| **RTLæ”¯æŒ** | ä¸ºæœªæ¥é¢„ç•™ | æ¶æ„æ”¯æŒRTLå¸ƒå±€æ‰©å±• |

#### 21.0.3 ä¸å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å›½é™…åŒ–ä¸å…¶ä»–æ¨¡å—çš„ååŒå…³ç³»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   21. å›½é™…åŒ–ä¸æœ¬åœ°åŒ–     â”‚                         â”‚
â”‚                        â”‚       ï¼ˆæœ¬ç« ï¼‰           â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                    â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â–¼                           â–¼                           â–¼           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ 10.AI    â”‚              â”‚ 11.åˆ†ç±»   â”‚              â”‚ 20.ç”¨æˆ·   â”‚        â”‚
â”‚   â”‚  è¯†åˆ«    â”‚              â”‚  ç³»ç»Ÿ    â”‚              â”‚  ä½“éªŒ    â”‚        â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚        â”‚
â”‚   â”‚ AIå¤šè¯­è¨€ â”‚              â”‚ åˆ†ç±»ç¿»è¯‘ â”‚              â”‚ UIæ–‡æœ¬   â”‚        â”‚
â”‚   â”‚ ç†è§£è¾“å‡º â”‚              â”‚ å›¾æ ‡é€‚é… â”‚              â”‚ æœ¬åœ°åŒ–   â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â–¼                                       â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                        â”‚   15. æŠ€æœ¯æ¶æ„          â”‚                         â”‚
â”‚                        â”‚   - èµ„æºåŠ è½½æœºåˆ¶        â”‚                         â”‚
â”‚                        â”‚   - ç¼“å­˜ç­–ç•¥            â”‚                         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                           2.0æ–°å¢åä½œæ¨¡å—                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚18.è¯­éŸ³   â”‚  â”‚14.ä½ç½®   â”‚  â”‚13.å®¶åº­   â”‚  â”‚9.ä¹ æƒ¯    â”‚  â”‚28-29.å¢é•¿â”‚   â”‚
â”‚   â”‚  äº¤äº’    â”‚  â”‚  æ™ºèƒ½    â”‚  â”‚  è´¦æœ¬    â”‚  â”‚  åŸ¹å…»    â”‚  â”‚  ä½“ç³»    â”‚   â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚   â”‚è¯­éŸ³è¯†åˆ«  â”‚  â”‚åŸå¸‚POI   â”‚  â”‚æˆå‘˜åç§°  â”‚  â”‚æˆå°±æ–‡æ¡ˆ  â”‚  â”‚é‚€è¯·æ–‡æ¡ˆ  â”‚   â”‚
â”‚   â”‚å¤šè¯­è¨€    â”‚  â”‚æœ¬åœ°åŒ–    â”‚  â”‚å¤šè¯­è¨€    â”‚  â”‚å¤šè¯­è¨€    â”‚  â”‚å¤šè¯­è¨€    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 21.1 æ”¯æŒçš„è¯­è¨€

#### 21.1.1 è¯­è¨€åˆ—è¡¨ä¸çŠ¶æ€

| è¯­è¨€ | ä»£ç  | åŸç”Ÿåç§° | å›½æ—— | çŠ¶æ€ | ç¿»è¯‘å®Œæˆåº¦ |
|------|------|----------|------|------|------------|
| ç®€ä½“ä¸­æ–‡ | zh_CN | ç®€ä½“ä¸­æ–‡ | ğŸ‡¨ğŸ‡³ | âœ… å®Œæˆ | 100% |
| ç¹ä½“ä¸­æ–‡ | zh_TW | ç¹é«”ä¸­æ–‡ | ğŸ‡¹ğŸ‡¼ | âœ… å®Œæˆ | 100% |
| è‹±è¯­ | en | English | ğŸ‡ºğŸ‡¸ | âœ… å®Œæˆ | 100% |
| æ—¥è¯­ | ja | æ—¥æœ¬èª | ğŸ‡¯ğŸ‡µ | âœ… å®Œæˆ | 100% |
| éŸ©è¯­ | ko | í•œêµ­ì–´ | ğŸ‡°ğŸ‡· | âœ… å®Œæˆ | 100% |
| è¥¿ç­ç‰™è¯­ | es | EspaÃ±ol | ğŸ‡ªğŸ‡¸ | ğŸ“‹ è§„åˆ’ | - |
| æ³°è¯­ | th | à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ | ğŸ‡¹ğŸ‡­ | ğŸ“‹ è§„åˆ’ | - |
| è¶Šå—è¯­ | vi | Tiáº¿ng Viá»‡t | ğŸ‡»ğŸ‡³ | ğŸ“‹ è§„åˆ’ | - |

#### 21.1.2 è¯­è¨€å®šä¹‰ä¸é…ç½®

```dart
/// æ”¯æŒçš„è¯­è¨€æšä¸¾
enum AppLanguage {
  zhCN, // ç®€ä½“ä¸­æ–‡
  zhTW, // ç¹ä½“ä¸­æ–‡
  en,   // è‹±è¯­
  ja,   // æ—¥è¯­
  ko,   // éŸ©è¯­
}

/// è¯­è¨€ä¿¡æ¯æ•°æ®ç±»
class LanguageInfo {
  final AppLanguage language;
  final String code;        // è¯­è¨€ä»£ç  (å¦‚ 'zh_CN')
  final String name;        // æœ¬åœ°åç§° (å¦‚ 'ç®€ä½“ä¸­æ–‡')
  final String nameEn;      // è‹±æ–‡åç§° (å¦‚ 'Simplified Chinese')
  final Locale locale;      // Flutter Localeå¯¹è±¡
  final String flag;        // å›½æ——Emoji

  const LanguageInfo({
    required this.language,
    required this.code,
    required this.name,
    required this.nameEn,
    required this.locale,
    required this.flag,
  });
}

/// è¯­è¨€æ³¨å†Œè¡¨
class AppLanguages {
  static const Map<AppLanguage, LanguageInfo> all = {
    AppLanguage.zhCN: LanguageInfo(
      language: AppLanguage.zhCN,
      code: 'zh_CN',
      name: 'ç®€ä½“ä¸­æ–‡',
      nameEn: 'Simplified Chinese',
      locale: Locale('zh', 'CN'),
      flag: 'ğŸ‡¨ğŸ‡³',
    ),
    AppLanguage.zhTW: LanguageInfo(
      language: AppLanguage.zhTW,
      code: 'zh_TW',
      name: 'ç¹é«”ä¸­æ–‡',
      nameEn: 'Traditional Chinese',
      locale: Locale('zh', 'TW'),
      flag: 'ğŸ‡¹ğŸ‡¼',
    ),
    AppLanguage.en: LanguageInfo(
      language: AppLanguage.en,
      code: 'en',
      name: 'English',
      nameEn: 'English',
      locale: Locale('en'),
      flag: 'ğŸ‡ºğŸ‡¸',
    ),
    AppLanguage.ja: LanguageInfo(
      language: AppLanguage.ja,
      code: 'ja',
      name: 'æ—¥æœ¬èª',
      nameEn: 'Japanese',
      locale: Locale('ja'),
      flag: 'ğŸ‡¯ğŸ‡µ',
    ),
    AppLanguage.ko: LanguageInfo(
      language: AppLanguage.ko,
      code: 'ko',
      name: 'í•œêµ­ì–´',
      nameEn: 'Korean',
      locale: Locale('ko'),
      flag: 'ğŸ‡°ğŸ‡·',
    ),
  };

  static LanguageInfo get(AppLanguage lang) => all[lang]!;
  static List<LanguageInfo> get list => all.values.toList();
  static List<Locale> get supportedLocales => all.values.map((l) => l.locale).toList();
}
```

### 21.2 å›½é™…åŒ–æ¶æ„è®¾è®¡

#### 21.2.1 å¤šå±‚æœ¬åœ°åŒ–æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¤šå±‚æœ¬åœ°åŒ–æ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         è¡¨ç°å±‚ (UI Layer)                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚  â”‚  S.of(context) â”‚  â”‚  l10n Provider â”‚  â”‚  æœ¬åœ°åŒ–Widget   â”‚         â”‚ â”‚
â”‚  â”‚  â”‚  (gen-l10n)    â”‚  â”‚  (Riverpod)    â”‚  â”‚  LocalizedText â”‚         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        æœåŠ¡å±‚ (Service Layer)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ LocaleProvider  â”‚  â”‚ CategoryL10n   â”‚  â”‚ AccountL10n    â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ è¯­è¨€çŠ¶æ€ç®¡ç†     â”‚  â”‚ åˆ†ç±»æœ¬åœ°åŒ–æœåŠ¡   â”‚  â”‚ è´¦æˆ·æœ¬åœ°åŒ–æœåŠ¡   â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        èµ„æºå±‚ (Resource Layer)                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚  ARB Files      â”‚  â”‚  Category Map   â”‚  â”‚  Currency Data  â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  app_*.arb      â”‚  â”‚  ç¿»è¯‘æ˜ å°„è¡¨      â”‚  â”‚  è´§å¸æ•°æ®è¡¨      â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 21.2.2 æœ¬åœ°åŒ–æ–‡ä»¶ç»“æ„

```
app/
â”œâ”€â”€ l10n.yaml                           # Flutter L10né…ç½®
â””â”€â”€ lib/
    â””â”€â”€ l10n/
        â”œâ”€â”€ app_en.arb                  # è‹±è¯­ï¼ˆæ¨¡æ¿æ–‡ä»¶ï¼‰
        â”œâ”€â”€ app_zh.arb                  # ç®€ä½“ä¸­æ–‡
        â”œâ”€â”€ app_zh_CN.arb               # ç®€ä½“ä¸­æ–‡ï¼ˆåœ°åŒºå˜ä½“ï¼‰
        â”œâ”€â”€ app_zh_TW.arb               # ç¹ä½“ä¸­æ–‡
        â”œâ”€â”€ app_ja.arb                  # æ—¥è¯­
        â”œâ”€â”€ app_ko.arb                  # éŸ©è¯­
        â”œâ”€â”€ app_localizations.dart      # æœ¬åœ°åŒ–å…¥å£
        â”œâ”€â”€ l10n.dart                   # ä¾¿æ·è®¿é—®ç±»
        â””â”€â”€ generated/                  # gen-l10nç”Ÿæˆç›®å½•
            â””â”€â”€ app_localizations_*.dart
```

#### 21.2.3 l10n.yamlé…ç½®

```yaml
arb-dir: lib/l10n
template-arb-file: app_en.arb
output-dir: lib/l10n/generated
output-localization-file: app_localizations.dart
output-class: S
nullable-getter: false
untranslated-messages-file: untranslated_messages.txt
```

### 21.3 è¯­è¨€çŠ¶æ€ç®¡ç†

```dart
/// è¯­è¨€è®¾ç½®çŠ¶æ€
class LocaleState {
  final AppLanguage? selectedLanguage; // nullè¡¨ç¤ºè·Ÿéšç³»ç»Ÿ
  final AppLanguage effectiveLanguage; // å®é™…ä½¿ç”¨çš„è¯­è¨€

  bool get followSystem => selectedLanguage == null;
  LanguageInfo get languageInfo => AppLanguages.get(effectiveLanguage);
  Locale get locale => languageInfo.locale;
}

/// è¯­è¨€è®¾ç½®Provider
class LocaleNotifier extends Notifier<LocaleState> {
  static AppLanguage getSystemLanguage() {
    final systemLocale = PlatformDispatcher.instance.locale;
    if (systemLocale.languageCode == 'zh') {
      if (['TW', 'HK', 'MO'].contains(systemLocale.countryCode)) {
        return AppLanguage.zhTW;
      }
      return AppLanguage.zhCN;
    }
    return switch (systemLocale.languageCode) {
      'en' => AppLanguage.en,
      'ja' => AppLanguage.ja,
      'ko' => AppLanguage.ko,
      _ => AppLanguage.zhCN,
    };
  }

  Future<void> setLanguage(AppLanguage language) async { /* ... */ }
  Future<void> setFollowSystem() async { /* ... */ }
}
```

### 21.4 ARBæ–‡ä»¶è§„èŒƒ

#### 21.4.1 ç¿»è¯‘æ¡ç›®åˆ†ç±»

| åˆ†ç±» | å‰ç¼€ | è¯´æ˜ |
|------|------|------|
| é€šç”¨æ“ä½œ | - | confirm, cancel, save |
| å¯¼èˆª | nav_ | nav_home, nav_stats |
| è®°è´¦ | tx_ | tx_expense, tx_income |
| ç»Ÿè®¡ | stats_ | stats_total, stats_average |
| é¢„ç®— | budget_ | budget_monthly |
| è´¦æˆ· | account_ | account_cash |
| è®¾ç½® | settings_ | settings_language |
| é”™è¯¯ | error_ | error_network |
| AI | ai_ | ai_insight |

### 21.5 åˆ†ç±»ä¸è´¦æˆ·æœ¬åœ°åŒ–

#### 21.5.1 åˆ†ç±»ç¿»è¯‘å®Œæ•´è¡¨

| åˆ†ç±»ID | ä¸­æ–‡ | English | æ—¥æœ¬èª | í•œêµ­ì–´ |
|--------|------|---------|--------|--------|
| food | é¤é¥® | Food & Dining | é£Ÿè²» | ì‹ë¹„ |
| transport | äº¤é€š | Transportation | äº¤é€šè²» | êµí†µë¹„ |
| shopping | è´­ç‰© | Shopping | è²·ã„ç‰© | ì‡¼í•‘ |
| entertainment | å¨±ä¹ | Entertainment | å¨¯æ¥½ | ì˜¤ë½ |
| housing | å±…ä½ | Housing | ä½å±…è²» | ì£¼ê±°ë¹„ |
| utilities | æ°´ç”µç‡ƒæ°” | Utilities | å…‰ç†±è²» | ê³µê³¼ê¸ˆ |
| medical | åŒ»ç–— | Medical | åŒ»ç™‚è²» | ì˜ë£Œë¹„ |
| education | æ•™è‚² | Education | æ•™è‚²è²» | êµìœ¡ë¹„ |
| salary | å·¥èµ„ | Salary | çµ¦æ–™ | ê¸‰ì—¬ |
| bonus | å¥–é‡‘ | Bonus | ãƒœãƒ¼ãƒŠã‚¹ | ë³´ë„ˆìŠ¤ |
| investment | æŠ•èµ„æ”¶ç›Š | Investment | æŠ•è³‡åç›Š | íˆ¬ììˆ˜ìµ |

### 21.6 è´§å¸ç³»ç»Ÿè®¾è®¡

#### 21.6.1 æ”¯æŒçš„è´§å¸

| è´§å¸ | ä»£ç  | ç¬¦å· | å›½æ—— | å°æ•°ä½ |
|------|------|------|------|--------|
| äººæ°‘å¸ | CNY | Â¥ | ğŸ‡¨ğŸ‡³ | 2 |
| ç¾å…ƒ | USD | $ | ğŸ‡ºğŸ‡¸ | 2 |
| æ¬§å…ƒ | EUR | â‚¬ | ğŸ‡ªğŸ‡º | 2 |
| æ—¥å…ƒ | JPY | Â¥ | ğŸ‡¯ğŸ‡µ | 0 |
| éŸ©å…ƒ | KRW | â‚© | ğŸ‡°ğŸ‡· | 0 |
| æ¸¯å¸ | HKD | HK$ | ğŸ‡­ğŸ‡° | 2 |
| æ–°å°å¸ | TWD | NT$ | ğŸ‡¹ğŸ‡¼ | 0 |
| è‹±é•‘ | GBP | Â£ | ğŸ‡¬ğŸ‡§ | 2 |

### 21.7 æ—¥æœŸä¸æ—¶é—´æ ¼å¼åŒ–

| è¯­è¨€ | æ—¥æœŸæ ¼å¼ | ç¤ºä¾‹ |
|------|----------|------|
| ç®€ä½“ä¸­æ–‡ | yyyyå¹´MMæœˆddæ—¥ | 2024å¹´12æœˆ31æ—¥ |
| ç¹ä½“ä¸­æ–‡ | yyyyå¹´MMæœˆddæ—¥ | 2024å¹´12æœˆ31æ—¥ |
| è‹±è¯­ | MMM dd, yyyy | Dec 31, 2024 |
| æ—¥è¯­ | yyyyå¹´MMæœˆddæ—¥ | 2024å¹´12æœˆ31æ—¥ |
| éŸ©è¯­ | yyyyë…„ MMì›” ddì¼ | 2024ë…„ 12ì›” 31ì¼ |

### 21.8 AIå†…å®¹æœ¬åœ°åŒ–

AIæç¤ºè¯å’Œç”Ÿæˆå†…å®¹æ ¹æ®ç”¨æˆ·è¯­è¨€è®¾ç½®è‡ªåŠ¨è°ƒæ•´ï¼Œç¡®ä¿AIæ´å¯Ÿã€å»ºè®®ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€è¾“å‡ºã€‚

### 21.9 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// å›½é™…åŒ–ç›®æ ‡è¾¾æˆæ£€æµ‹ï¼ˆå¯¹é½1.4.2èŠ‚å®šä¹‰ï¼‰
static const i18nGoal = GoalCriteria(
  name: 'å›½é™…åŒ–æ”¯æŒ',
  featureCompleteness: [
    'æ”¯æŒ5ç§ä¸»è¦è¯­è¨€ï¼ˆç®€ä¸­/ç¹ä¸­/è‹±/æ—¥/éŸ©ï¼‰',
    'æ‰€æœ‰UIæ–‡æœ¬100%æœ¬åœ°åŒ–',
    'åˆ†ç±»åç§°æ”¯æŒæœ¬åœ°åŒ–æ˜¾ç¤º',
    'è´§å¸æ ¼å¼ç¬¦åˆåœ°åŒºä¹ æƒ¯',
    'æ—¥æœŸæ ¼å¼ç¬¦åˆåœ°åŒºä¹ æƒ¯',
    'AIå†…å®¹ä½¿ç”¨ç”¨æˆ·è¯­è¨€è¾“å‡º',
    'è¯­è¨€è®¾ç½®æ”¯æŒè·Ÿéšç³»ç»Ÿ',
  ],
  outcomeMetrics: [
    OutcomeMetric(name: 'ç¿»è¯‘å‡†ç¡®åº¦', target: 0.02),  // <2%æŠ¥å‘Šé—®é¢˜
    OutcomeMetric(name: 'å›½é™…ç”¨æˆ·ç•™å­˜', target: 0.40), // 40%ç•™å­˜
    OutcomeMetric(name: 'è´§å¸é€‚é…æ»¡æ„åº¦', target: 0.90), // 90%æ»¡æ„
  ],
);
```

---


---

# ç¬¬å…­éƒ¨åˆ†ï¼šå·¥ç¨‹ä¿éšœ

---

### 21.10 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 21.10.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

å›½é™…åŒ–ç³»ç»Ÿä¸å…¶ä»–2.0æ¨¡å—çš„é›†æˆç¡®ä¿æ‰€æœ‰ç”¨æˆ·ç•Œé¢å’Œå†…å®¹æ­£ç¡®æœ¬åœ°åŒ–ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å›½é™…åŒ–é›†æˆå…¨æ™¯å›¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        å›½é™…åŒ–æ ¸å¿ƒæœåŠ¡                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ è¯­è¨€ç®¡ç†  â”‚  â”‚ è´§å¸æ ¼å¼  â”‚  â”‚ æ—¥æœŸæ ¼å¼  â”‚  â”‚ èµ„æºåŠ è½½  â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  UIæ–‡æœ¬      â”‚     â”‚  æ•°æ®æ ¼å¼    â”‚     â”‚  AIå†…å®¹      â”‚                 â”‚
â”‚  â”‚  æœ¬åœ°åŒ–      â”‚     â”‚  æœ¬åœ°åŒ–      â”‚     â”‚  æœ¬åœ°åŒ–      â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ é¡µé¢æ–‡æœ¬   â”‚     â”‚ â€¢ è´§å¸æ˜¾ç¤º   â”‚     â”‚ â€¢ è¯­éŸ³è¯†åˆ«   â”‚                 â”‚
â”‚  â”‚ â€¢ æŒ‰é’®æ ‡ç­¾   â”‚     â”‚ â€¢ æ—¥æœŸæ˜¾ç¤º   â”‚     â”‚ â€¢ AIå»ºè®®     â”‚                 â”‚
â”‚  â”‚ â€¢ æç¤ºä¿¡æ¯   â”‚     â”‚ â€¢ æ•°å­—æ ¼å¼   â”‚     â”‚ â€¢ æ´å¯Ÿæ–‡æ¡ˆ   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 21.10.2 è¯­éŸ³äº¤äº’ç³»ç»Ÿé›†æˆ

è¯­éŸ³è¯†åˆ«éœ€è¦æ ¹æ®ç”¨æˆ·è¯­è¨€è®¾ç½®è°ƒæ•´è¯†åˆ«è¯­è¨€å’Œæ•°å­—è¡¨è¾¾æ¨¡å¼ï¼š

| è¯­è¨€ | è¯†åˆ«è¯­è¨€ä»£ç  | æ•°å­—è¡¨è¾¾ç¤ºä¾‹ | è´§å¸è¡¨è¾¾ç¤ºä¾‹ |
|------|-------------|-------------|-------------|
| ç®€ä½“ä¸­æ–‡ | cmn-Hans-CN | "åå—"ã€"ä¸€ç™¾" | "25å—é’±" |
| ç¹ä½“ä¸­æ–‡ | cmn-Hant-TW | "åå¡Š"ã€"ä¸€ç™¾" | "25å¡ŠéŒ¢" |
| è‹±è¯­ | en-US | "ten", "hundred" | "$25" |
| æ—¥è¯­ | ja-JP | "åå††"ã€"ç™¾å††" | "25å††" |
| éŸ©è¯­ | ko-KR | "ì‹­ì›"ã€"ë°±ì›" | "25ì›" |

#### 21.10.3 AIç³»ç»Ÿé›†æˆ

AIæç¤ºè¯å’Œç”Ÿæˆå†…å®¹æ ¹æ®ç”¨æˆ·è¯­è¨€è®¾ç½®è‡ªåŠ¨è°ƒæ•´ï¼š

| åŠŸèƒ½ | æœ¬åœ°åŒ–å†…å®¹ | ç¤ºä¾‹ |
|------|-----------|------|
| äº¤æ˜“è§£æ | æç¤ºè¯æ¨¡æ¿ | è¯·åˆ†æ...ï¼ˆä¸­æ–‡ï¼‰/ Please analyze...ï¼ˆè‹±æ–‡ï¼‰ |
| æ´å¯Ÿç”Ÿæˆ | è¾“å‡ºè¯­è¨€ | æœ¬æœˆæ¶ˆè´¹... / This month's spending... |
| å»ºè®®æ–‡æ¡ˆ | å»ºè®®å†…å®¹ | å»ºè®®æ§åˆ¶... / Consider reducing... |
| åˆ†ç±»è¯†åˆ« | åˆ†ç±»åç§° | è¿”å›æœ¬åœ°åŒ–åˆ†ç±»å |

#### 21.10.4 åˆ†ç±»ç³»ç»Ÿé›†æˆ

é¢„è®¾åˆ†ç±»çš„å¤šè¯­è¨€åç§°æ˜ å°„ï¼š

| åˆ†ç±»Key | ç®€ä¸­ | ç¹ä¸­ | è‹±è¯­ | æ—¥è¯­ | éŸ©è¯­ |
|---------|------|------|------|------|------|
| food | é¤é¥® | é¤é£² | Food | é£Ÿè²» | ì‹ë¹„ |
| transport | äº¤é€š | äº¤é€š | Transportation | äº¤é€šè²» | êµí†µ |
| shopping | ï¿½ï¿½ï¿½ç‰© | è³¼ç‰© | Shopping | è²·ã„ç‰© | ì‡¼í•‘ |
| entertainment | å¨±ä¹ | å¨›æ¨‚ | Entertainment | å¨¯æ¥½ | ì˜¤ë½ |
| healthcare | åŒ»ç–— | é†«ç™‚ | Healthcare | åŒ»ç™‚ | ì˜ë£Œ |

#### 21.10.5 è´§å¸æ ¼å¼é›†æˆ

æ”¯æŒçš„è´§å¸åŠå…¶æ ¼å¼åŒ–è§„åˆ™ï¼š

| è´§å¸ | ç¬¦å· | å°æ•°ä½ | åƒåˆ†ä½ | ç¤ºä¾‹ |
|------|------|--------|--------|------|
| CNY | Â¥ | 2 | , | Â¥1,234.56 |
| USD | $ | 2 | , | $1,234.56 |
| JPY | Â¥ | 0 | , | Â¥1,234 |
| KRW | â‚© | 0 | , | â‚©1,234 |
| EUR | â‚¬ | 2 | . | â‚¬1.234,56 |
| TWD | NT$ | 0 | , | NT$1,234 |
| HKD | HK$ | 2 | , | HK$1,234.56 |

#### 21.10.6 æ—¥æœŸæ—¶é—´æ ¼å¼é›†æˆ

ä¸åŒè¯­è¨€çš„æ—¥æœŸæ—¶é—´æ ¼å¼ï¼š

| æ ¼å¼ç±»å‹ | ç®€ä¸­ | è‹±è¯­ | ï¿½ï¿½ï¿½è¯­ | éŸ©è¯­ |
|----------|------|------|------|------|
| çŸ­æ—¥æœŸ | 12/25 | 12/25 | 12/25 | 12/25 |
| ä¸­æ—¥æœŸ | 2024å¹´12æœˆ25æ—¥ | Dec 25, 2024 | 2024å¹´12æœˆ25æ—¥ | 2024ë…„ 12ì›” 25ì¼ |
| ç›¸å¯¹æ—¶é—´ | 3åˆ†é’Ÿå‰ | 3 minutes ago | 3åˆ†å‰ | 3ë¶„ ì „ |
| æ˜ŸæœŸ | å‘¨ä¸€ | Mon | æœˆ | ì›” |

---

## 22. å®‰å…¨ä¸éšç§

æœ¬ç« èŠ‚åŸºäº**å®‰å…¨ç¬¬ä¸€åŸåˆ™**å’Œ**éšç§ä¿æŠ¤åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿçš„å®‰å…¨æ¶æ„å’Œéšç§ä¿æŠ¤æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·è´¢åŠ¡æ•°æ®çš„å®‰å…¨æ€§å’Œéšç§æ€§ã€‚

### 22.0 è®¾è®¡åŸåˆ™å›é¡¾

#### 22.0.1 å®‰å…¨ä¸éšç§è®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®‰å…¨ä¸éšç§è®¾è®¡åŸåˆ™çŸ©é˜µ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ•°æ®å®‰å…¨åŸåˆ™                                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ åŠ å¯†å­˜å‚¨ï¼šæ‰€æœ‰æ•æ„Ÿæ•°æ®åœ¨æœ¬åœ°å’Œä¼ è¾“ä¸­å‡åŠ å¯†                             â”‚ â”‚
â”‚  â”‚  â€¢ æœ€å°æƒé™ï¼šåº”ç”¨åªè¯·æ±‚å¿…è¦çš„ç³»ç»Ÿæƒé™                                    â”‚ â”‚
â”‚  â”‚  â€¢ å®‰å…¨ä¼ è¾“ï¼šæ‰€æœ‰ç½‘ç»œé€šä¿¡ä½¿ç”¨ TLS 1.3                                    â”‚ â”‚
â”‚  â”‚  â€¢ å¯†é’¥ç®¡ç†ï¼šå¯†é’¥ä¸ç¡¬ç¼–ç ï¼Œä½¿ç”¨ç³»ç»Ÿå®‰å…¨å­˜å‚¨                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  éšç§ä¿æŠ¤åŸåˆ™                                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ æœ¬åœ°ä¼˜å…ˆï¼šæ•æ„Ÿæ•°æ®ä¼˜å…ˆæœ¬åœ°å¤„ç†ï¼Œå‡å°‘äº‘ç«¯æš´éœ²                           â”‚ â”‚
â”‚  â”‚  â€¢ é€æ˜æˆæƒï¼šæ˜ç¡®å‘ŠçŸ¥æ•°æ®ç”¨é€”ï¼Œç”¨æˆ·å¯æ§                                  â”‚ â”‚
â”‚  â”‚  â€¢ æ•°æ®æœ€å°åŒ–ï¼šåªæ”¶é›†å¿…è¦çš„æ•°æ®                                         â”‚ â”‚
â”‚  â”‚  â€¢ å¯åˆ é™¤æ€§ï¼šç”¨æˆ·å¯å®Œå…¨åˆ é™¤è‡ªå·±çš„æ•°æ®                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è®¿é—®æ§åˆ¶åŸåˆ™                                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ å¼ºè®¤è¯ï¼šæ”¯æŒå¤šå› ç´ è®¤è¯ï¼ˆPIN + ç”Ÿç‰©è¯†åˆ«ï¼‰                              â”‚ â”‚
â”‚  â”‚  â€¢ ä¼šè¯ç®¡ç†ï¼šè‡ªåŠ¨é”å®šã€ä¼šè¯è¶…æ—¶                                         â”‚ â”‚
â”‚  â”‚  â€¢ å®¡è®¡è¿½è¸ªï¼šå…³é”®æ“ä½œè®°å½•å®¡è®¡æ—¥å¿—                                        â”‚ â”‚
â”‚  â”‚  â€¢ é˜²ç¯¡æ”¹ï¼šæ£€æµ‹å’Œé˜²æ­¢æ•°æ®ç¯¡æ”¹                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 22.0.2 å®‰å…¨æ¨¡å—åä½œå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®‰å…¨ä¸éšç§ç³»ç»Ÿæ¨¡å—åä½œå›¾                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                           â”‚    ç”¨æˆ·è®¿é—®å…¥å£      â”‚                            â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          è®¤è¯ä¸è®¿é—®æ§åˆ¶å±‚                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  åº”ç”¨é”     â”‚  â”‚  ç”Ÿç‰©è¯†åˆ«   â”‚  â”‚  PIN/å›¾æ¡ˆ   â”‚  â”‚  ä¼šè¯ç®¡ç†   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  (22.2)     â”‚  â”‚  (22.2)     â”‚  â”‚  (22.2)     â”‚  â”‚  (22.4)     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                            â”‚                            â”‚          â”‚
â”‚         â–¼                            â–¼                            â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   æ•°æ®åŠ å¯†å±‚     â”‚   â”‚    éšç§ä¿æŠ¤å±‚        â”‚   â”‚    å¤‡ä»½æ¢å¤å±‚        â”‚    â”‚
â”‚  â”‚     (22.1)      â”‚   â”‚      (22.2)         â”‚   â”‚      (22.3)         â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚ SQLCipher   â”‚ â”‚   â”‚ â”‚  éšç§æ¨¡å¼       â”‚ â”‚   â”‚ â”‚  æœ¬åœ°å¤‡ä»½       â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ AES-256     â”‚ â”‚   â”‚ â”‚  æˆªå›¾ä¿æŠ¤       â”‚ â”‚   â”‚ â”‚  åŠ å¯†å‹ç¼©       â”‚ â”‚    â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚    â”‚
â”‚  â”‚ â”‚ SecureStore â”‚ â”‚   â”‚ â”‚  æ•°æ®è„±æ•       â”‚ â”‚   â”‚ â”‚  äº‘ç«¯åŒæ­¥       â”‚ â”‚    â”‚
â”‚  â”‚ â”‚ Keychain    â”‚ â”‚   â”‚ â”‚  æƒé™æ§åˆ¶       â”‚ â”‚   â”‚ â”‚  å¢é‡å¤‡ä»½       â”‚ â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          å®¡è®¡ä¸åˆè§„å±‚ (22.5)                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  æ“ä½œæ—¥å¿—   â”‚  â”‚  å®‰å…¨äº‹ä»¶   â”‚  â”‚  æ•°æ®ä¿ç•™   â”‚  â”‚  åˆè§„æ£€æŸ¥   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.0.3 ä¸å…¶ä»–æ¨¡å—çš„ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®‰å…¨æ¨¡å—ä¸å…¶ä»–ç³»ç»Ÿçš„ä¾èµ–å…³ç³»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                         â”‚
â”‚                        â•‘    ç¬¬22ç«  å®‰å…¨ä¸éšç§       â•‘                         â”‚
â”‚                        â•‘    (åŸºç¡€å®‰å…¨è®¾æ–½)          â•‘                         â”‚
â”‚                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                         â”‚
â”‚                                    â”‚                                         â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚             â”‚              â”‚              â”‚             â”‚            â”‚
â”‚       â–¼             â–¼              â–¼              â–¼             â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç¬¬7ç«    â”‚  â”‚  ç¬¬15ç«   â”‚  â”‚  ç¬¬15ç«   â”‚  â”‚  ç¬¬23ç«   â”‚  â”‚  ç¬¬25ç«  â”‚        â”‚
â”‚  â”‚é’±é¾„ç³»ç»Ÿ â”‚  â”‚åœ°ç†ä½ç½®  â”‚  â”‚æŠ€æœ¯æ¶æ„  â”‚  â”‚ç‰ˆæœ¬è¿ç§»  â”‚  â”‚å¯è§‚æµ‹æ€§ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â”‚            â”‚             â”‚             â”‚             â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚        å®‰å…¨æœåŠ¡æä¾›çš„èƒ½åŠ›          â”‚                       â”‚
â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚                  â”‚ â€¢ æ•°æ®åŠ å¯†å­˜å‚¨ (â†’ æ‰€æœ‰æ•°æ®æ¨¡å—)    â”‚                       â”‚
â”‚                  â”‚ â€¢ ä½ç½®æ•°æ®åŠ å¯† (â†’ ç¬¬15ç« )          â”‚                       â”‚
â”‚                  â”‚ â€¢ APIé€šä¿¡åŠ å¯† (â†’ ç¬¬15ç« )           â”‚                       â”‚
â”‚                  â”‚ â€¢ å¤‡ä»½åŠ å¯† (â†’ ç¬¬23ç« )              â”‚                       â”‚
â”‚                  â”‚ â€¢ å®‰å…¨å®¡è®¡æ—¥å¿— (â†’ ç¬¬25ç« )          â”‚                       â”‚
â”‚                  â”‚ â€¢ ç”¨æˆ·è®¤è¯ (â†’ æ‰€æœ‰éœ€è®¤è¯çš„æ¨¡å—)    â”‚                       â”‚
â”‚                  â”‚ â€¢ éšç§æ¨¡å¼ (â†’ UIå±•ç¤ºå±‚)           â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                              â”‚
â”‚  ä¾èµ–æ–¹å‘è¯´æ˜ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â€¢ ç¬¬22ç« æ˜¯åŸºç¡€å®‰å…¨è®¾æ–½ï¼Œè¢«æ‰€æœ‰æ¶‰åŠæ•æ„Ÿæ•°æ®çš„æ¨¡å—ä¾èµ–                          â”‚
â”‚  â€¢ å„æ¨¡å—é€šè¿‡å®‰å…¨æœåŠ¡æ¥å£è·å–åŠ å¯†ã€è®¤è¯ã€å®¡è®¡èƒ½åŠ›                             â”‚
â”‚  â€¢ ç¬¬22ç« ä¾èµ–ç¬¬25ç« çš„ç›‘æ§èƒ½åŠ›è®°å½•å®‰å…¨äº‹ä»¶                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 22.0.4 å®‰å…¨å­ç³»ç»ŸèŒè´£è¾¹ç•Œè¡¨

| å­ç³»ç»Ÿ | ç« èŠ‚ | æ ¸å¿ƒèŒè´£ | è¾“å…¥ | è¾“å‡º |
|--------|------|----------|------|------|
| **æ•°æ®å®‰å…¨** | 22.1 | åŠ å¯†å­˜å‚¨ã€ä¼ è¾“åŠ å¯†ã€å¯†é’¥ç®¡ç† | æ˜æ–‡æ•°æ® | åŠ å¯†æ•°æ® |
| **éšç§ä¿æŠ¤** | 22.2 | åº”ç”¨é”ã€éšç§æ¨¡å¼ã€æˆªå›¾ä¿æŠ¤ | ç”¨æˆ·æ“ä½œ | éšç§ä¿æŠ¤çŠ¶æ€ |
| **å¤‡ä»½æ¢å¤** | 22.3 | æœ¬åœ°å¤‡ä»½ã€äº‘ç«¯åŒæ­¥ã€æ•°æ®æ¢å¤ | æ•°æ®åº“ | åŠ å¯†å¤‡ä»½æ–‡ä»¶ |
| **è®¤è¯æˆæƒ** | 22.4 | ç”¨æˆ·è®¤è¯ã€ä¼šè¯ç®¡ç†ã€Tokenåˆ·æ–° | å‡­è¯ | è®¤è¯çŠ¶æ€ |
| **å®¡è®¡åˆè§„** | 22.5 | æ“ä½œæ—¥å¿—ã€å®‰å…¨äº‹ä»¶ã€åˆè§„æ£€æŸ¥ | æ“ä½œè®°å½• | å®¡è®¡æŠ¥å‘Š |

### 22.1 æ•°æ®å®‰å…¨ç­–ç•¥

#### 22.1.1 å®‰å…¨æªæ–½æ€»è§ˆ

| å®‰å…¨æªæ–½ | æè¿° | å®ç°æ–¹å¼ |
|----------|------|----------|
| **æœ¬åœ°åŠ å¯†** | SQLite æ•°æ®åº“ä½¿ç”¨ SQLCipher åŠ å¯† | AES-256-CBC |
| **ä¼ è¾“åŠ å¯†** | æ‰€æœ‰ API è¯·æ±‚ä½¿ç”¨ HTTPS | TLS 1.3 |
| **æ•æ„Ÿæ•°æ®ä¿æŠ¤** | å¯†ç ã€API Key ä½¿ç”¨å®‰å…¨å­˜å‚¨ | iOS Keychain / Android Keystore |
| **ç”Ÿç‰©è¯†åˆ«** | æ”¯æŒæŒ‡çº¹/é¢å®¹è§£é”åº”ç”¨ | local_auth æ’ä»¶ |
| **è‡ªåŠ¨é”å®š** | åå°è¶…æ—¶è‡ªåŠ¨é”å®š | å¯é…ç½® 1-30 åˆ†é’Ÿ |
| **é˜²æˆªå›¾** | éšç§æ¨¡å¼ä¸‹é˜»æ­¢æˆªå›¾ | FLAG_SECURE (Android) |

#### 22.1.2 æ•°æ®åŠ å¯†æœåŠ¡

```dart
/// åŠ å¯†æœåŠ¡
class EncryptionService {
  static const _algorithm = AESMode.gcm;
  static const _keySize = 256;

  /// è·å–æˆ–ç”ŸæˆåŠ å¯†å¯†é’¥
  Future<SecretKey> _getOrCreateKey() async {
    final storage = FlutterSecureStorage();
    final existingKey = await storage.read(key: 'db_encryption_key');

    if (existingKey != null) {
      return SecretKey(base64Decode(existingKey));
    }

    // ç”Ÿæˆæ–°å¯†é’¥
    final algorithm = AesGcm.with256bits();
    final secretKey = await algorithm.newSecretKey();
    final keyBytes = await secretKey.extractBytes();

    // å®‰å…¨å­˜å‚¨å¯†é’¥
    await storage.write(
      key: 'db_encryption_key',
      value: base64Encode(keyBytes),
    );

    return secretKey;
  }

  /// åŠ å¯†æ•°æ®
  Future<Uint8List> encrypt(Uint8List plaintext) async {
    final algorithm = AesGcm.with256bits();
    final secretKey = await _getOrCreateKey();
    final nonce = algorithm.newNonce();

    final secretBox = await algorithm.encrypt(
      plaintext,
      secretKey: secretKey,
      nonce: nonce,
    );

    // è¿”å› nonce + ciphertext + mac
    return Uint8List.fromList([
      ...nonce,
      ...secretBox.cipherText,
      ...secretBox.mac.bytes,
    ]);
  }

  /// è§£å¯†æ•°æ®
  Future<Uint8List> decrypt(Uint8List encrypted) async {
    final algorithm = AesGcm.with256bits();
    final secretKey = await _getOrCreateKey();

    // æå– nonce (12 bytes), ciphertext, mac (16 bytes)
    final nonce = encrypted.sublist(0, 12);
    final mac = Mac(encrypted.sublist(encrypted.length - 16));
    final cipherText = encrypted.sublist(12, encrypted.length - 16);

    final secretBox = SecretBox(cipherText, nonce: nonce, mac: mac);

    return Uint8List.fromList(
      await algorithm.decrypt(secretBox, secretKey: secretKey),
    );
  }
}

/// æ•æ„Ÿæ•°æ®å­—æ®µåŠ å¯†è£…é¥°å™¨
class EncryptedField {
  final EncryptionService _encryption;

  /// åŠ å¯†å­—æ®µå€¼
  Future<String> encryptField(String plaintext) async {
    final encrypted = await _encryption.encrypt(
      Uint8List.fromList(utf8.encode(plaintext)),
    );
    return base64Encode(encrypted);
  }

  /// è§£å¯†å­—æ®µå€¼
  Future<String> decryptField(String encrypted) async {
    final decrypted = await _encryption.decrypt(
      base64Decode(encrypted),
    );
    return utf8.decode(decrypted);
  }
}
```

#### 22.1.3 å®‰å…¨å­˜å‚¨æœåŠ¡

```dart
/// å®‰å…¨å­˜å‚¨æœåŠ¡ï¼ˆAPI Keyã€Tokenç­‰æ•æ„Ÿæ•°æ®ï¼‰
class SecureStorageService {
  final FlutterSecureStorage _storage;

  SecureStorageService() : _storage = FlutterSecureStorage(
    aOptions: AndroidOptions(
      encryptedSharedPreferences: true,
      keyCipherAlgorithm: KeyCipherAlgorithm.RSA_ECB_OAEPwithSHA_256andMGF1Padding,
      storageCipherAlgorithm: StorageCipherAlgorithm.AES_GCM_NoPadding,
    ),
    iOptions: IOSOptions(
      accessibility: KeychainAccessibility.first_unlock_this_device,
    ),
  );

  /// å­˜å‚¨æ•æ„Ÿæ•°æ®
  Future<void> write(String key, String value) async {
    await _storage.write(key: key, value: value);
  }

  /// è¯»å–æ•æ„Ÿæ•°æ®
  Future<String?> read(String key) async {
    return await _storage.read(key: key);
  }

  /// åˆ é™¤æ•æ„Ÿæ•°æ®
  Future<void> delete(String key) async {
    await _storage.delete(key: key);
  }

  /// æ¸…é™¤æ‰€æœ‰å®‰å…¨å­˜å‚¨æ•°æ®
  Future<void> deleteAll() async {
    await _storage.deleteAll();
  }

  /// å­˜å‚¨ API Token
  Future<void> saveAccessToken(String token) async {
    await write('access_token', token);
    await write('token_saved_at', DateTime.now().toIso8601String());
  }

  /// è·å– API Token
  Future<String?> getAccessToken() async {
    final savedAt = await read('token_saved_at');
    if (savedAt != null) {
      final savedTime = DateTime.parse(savedAt);
      // Token æœ‰æ•ˆæœŸæ£€æŸ¥ï¼ˆå‡è®¾ 7 å¤©ï¼‰
      if (DateTime.now().difference(savedTime).inDays > 7) {
        await delete('access_token');
        return null;
      }
    }
    return await read('access_token');
  }
}
```

### 22.2 éšç§ä¿æŠ¤

#### 22.2.1 éšç§è®¾ç½®

```dart
/// éšç§è®¾ç½®
class PrivacySettings {
  /// æ˜¯å¦å¯ç”¨åº”ç”¨é”
  bool appLockEnabled = false;

  /// é”å®šæ–¹å¼
  LockMethod lockMethod = LockMethod.pin;

  /// è‡ªåŠ¨é”å®šæ—¶é—´ï¼ˆç§’ï¼‰
  int autoLockTimeout = 300;

  /// æ˜¯å¦åœ¨æˆªå›¾æ—¶éšè—é‡‘é¢
  bool hideAmountInScreenshot = true;

  /// æ˜¯å¦å¯ç”¨éšç§æ¨¡å¼
  bool privacyModeEnabled = false;

  /// æ˜¯å¦å…è®¸æ•°æ®åˆ†æï¼ˆåŒ¿åä½¿ç”¨ç»Ÿè®¡ï¼‰
  bool allowAnalytics = true;

  /// æ˜¯å¦å…è®¸å´©æºƒæŠ¥å‘Š
  bool allowCrashReporting = true;

  /// æ˜¯å¦åœ¨æœ€è¿‘ä»»åŠ¡ä¸­æ¨¡ç³Šæ˜¾ç¤º
  bool blurInRecentApps = true;

  /// æ˜¯å¦å…è®¸å‰ªè´´æ¿è®¿é—®
  bool allowClipboardAccess = false;
}

enum LockMethod {
  pin,       // PINç 
  pattern,   // å›¾æ¡ˆ
  biometric, // ç”Ÿç‰©è¯†åˆ«
}
```

#### 22.2.2 åº”ç”¨é”æœåŠ¡

```dart
/// åº”ç”¨é”æœåŠ¡
class AppLockService {
  final SecureStorageService _storage;
  final LocalAuthentication _localAuth;

  DateTime? _lastUnlockTime;
  bool _isLocked = true;

  /// éªŒè¯ç”¨æˆ·
  Future<bool> authenticate({String? reason}) async {
    final settings = await _getPrivacySettings();

    if (!settings.appLockEnabled) {
      _isLocked = false;
      return true;
    }

    switch (settings.lockMethod) {
      case LockMethod.biometric:
        final authenticated = await _localAuth.authenticate(
          localizedReason: reason ?? 'è¯·éªŒè¯èº«ä»½ä»¥è®¿é—®æ‚¨çš„è´¢åŠ¡æ•°æ®',
          options: AuthenticationOptions(
            stickyAuth: true,
            biometricOnly: false, // å…è®¸å›é€€åˆ°PIN
          ),
        );
        if (authenticated) {
          _isLocked = false;
          _lastUnlockTime = DateTime.now();
        }
        return authenticated;

      case LockMethod.pin:
        return await _showPinDialog();

      case LockMethod.pattern:
        return await _showPatternDialog();
    }
  }

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éªŒè¯
  bool shouldReauthenticate() {
    if (!_isLocked && _lastUnlockTime != null) {
      final settings = _getCachedSettings();
      final elapsed = DateTime.now().difference(_lastUnlockTime!);
      if (elapsed.inSeconds > settings.autoLockTimeout) {
        _isLocked = true;
        return true;
      }
      return false;
    }
    return _isLocked;
  }

  /// é”å®šåº”ç”¨
  void lock() {
    _isLocked = true;
    _lastUnlockTime = null;
  }

  /// è®¾ç½® PIN ç 
  Future<void> setPin(String pin) async {
    // ä½¿ç”¨ PBKDF2 æ´¾ç”Ÿå¯†é’¥
    final salt = _generateSalt();
    final hash = await _hashPin(pin, salt);

    await _storage.write('pin_hash', hash);
    await _storage.write('pin_salt', salt);
  }

  /// éªŒè¯ PIN ç 
  Future<bool> verifyPin(String pin) async {
    final storedHash = await _storage.read('pin_hash');
    final salt = await _storage.read('pin_salt');

    if (storedHash == null || salt == null) return false;

    final hash = await _hashPin(pin, salt);
    return hash == storedHash;
  }
}
```

#### 22.2.3 éšç§æ¨¡å¼ä¸é‡‘é¢è„±æ•

```dart
/// éšç§æ¨¡å¼ç®¡ç†å™¨
class PrivacyModeManager extends ChangeNotifier {
  bool _isPrivacyMode = false;

  bool get isPrivacyMode => _isPrivacyMode;

  /// åˆ‡æ¢éšç§æ¨¡å¼
  void toggle() {
    _isPrivacyMode = !_isPrivacyMode;
    notifyListeners();
  }

  /// é‡‘é¢è„±æ•æ˜¾ç¤º
  String maskAmount(double amount) {
    if (_isPrivacyMode) {
      return '****';
    }
    return amount.toStringAsFixed(2);
  }

  /// è´¦æˆ·åè„±æ•
  String maskAccountName(String name) {
    if (_isPrivacyMode && name.length > 2) {
      return '${name[0]}${'*' * (name.length - 2)}${name[name.length - 1]}';
    }
    return name;
  }

  /// åˆ†ç±»åè„±æ•ï¼ˆä¸è„±æ•ï¼Œå› ä¸ºä¸æ•æ„Ÿï¼‰
  String maskCategoryName(String name) => name;
}

/// æˆªå›¾ä¿æŠ¤ Widget
class ScreenshotProtection extends StatefulWidget {
  final Widget child;
  final bool enabled;

  const ScreenshotProtection({
    required this.child,
    this.enabled = true,
  });

  @override
  State<ScreenshotProtection> createState() => _ScreenshotProtectionState();
}

class _ScreenshotProtectionState extends State<ScreenshotProtection> {
  @override
  void initState() {
    super.initState();
    if (widget.enabled && Platform.isAndroid) {
      // Android: è®¾ç½® FLAG_SECURE
      FlutterWindowManager.addFlags(FlutterWindowManager.FLAG_SECURE);
    }
  }

  @override
  void dispose() {
    if (widget.enabled && Platform.isAndroid) {
      FlutterWindowManager.clearFlags(FlutterWindowManager.FLAG_SECURE);
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) => widget.child;
}
```

### 22.3 æ•°æ®å¤‡ä»½ä¸æ¢å¤

#### 22.3.1 å¤‡ä»½æœåŠ¡

```dart
/// å¤‡ä»½æœåŠ¡
class BackupService {
  final EncryptionService _encryption;
  final DatabaseService _database;

  /// åˆ›å»ºæœ¬åœ°å¤‡ä»½
  Future<BackupResult> createLocalBackup() async {
    try {
      // 1. å¯¼å‡ºæ‰€æœ‰æ•°æ®
      final backupData = await _exportAllData();

      // 2. åºåˆ—åŒ–
      final jsonData = jsonEncode(backupData);

      // 3. å‹ç¼©
      final compressed = gzip.encode(utf8.encode(jsonData));

      // 4. åŠ å¯†
      final encrypted = await _encryption.encrypt(Uint8List.fromList(compressed));

      // 5. ç”Ÿæˆå¤‡ä»½å…ƒæ•°æ®
      final metadata = BackupMetadata(
        version: '2.0',
        createdAt: DateTime.now(),
        appVersion: await PackageInfo.fromPlatform().then((p) => p.version),
        recordCount: await _countRecords(),
        checksum: _calculateChecksum(encrypted),
      );

      // 6. ä¿å­˜åˆ°æ–‡ä»¶
      final file = await _saveToFile(encrypted, metadata);

      return BackupResult.success(
        file: file,
        metadata: metadata,
      );
    } catch (e, stackTrace) {
      return BackupResult.failure(
        error: e.toString(),
        stackTrace: stackTrace,
      );
    }
  }

  /// æ¢å¤å¤‡ä»½
  Future<RestoreResult> restoreFromBackup(File backupFile) async {
    try {
      // 1. è¯»å–æ–‡ä»¶
      final encrypted = await backupFile.readAsBytes();

      // 2. éªŒè¯æ ¡éªŒå’Œ
      final metadata = await _readMetadata(backupFile);
      if (_calculateChecksum(encrypted) != metadata.checksum) {
        throw BackupCorruptedException('å¤‡ä»½æ–‡ä»¶æ ¡éªŒå¤±è´¥');
      }

      // 3. è§£å¯†
      final decrypted = await _encryption.decrypt(Uint8List.fromList(encrypted));

      // 4. è§£å‹
      final decompressed = gzip.decode(decrypted);

      // 5. ååºåˆ—åŒ–
      final backupData = jsonDecode(utf8.decode(decompressed)) as Map<String, dynamic>;

      // 6. ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
      await _checkVersionCompatibility(backupData['version'] as String);

      // 7. å¯¼å…¥æ•°æ®
      await _importAllData(backupData);

      return RestoreResult.success(
        recordsRestored: await _countRecords(),
      );
    } on BackupCorruptedException catch (e) {
      return RestoreResult.failure(error: e.message);
    } catch (e) {
      return RestoreResult.failure(error: 'æ¢å¤å¤±è´¥: $e');
    }
  }

  /// äº‘ç«¯åŒæ­¥å¤‡ä»½
  Future<void> syncToCloud() async {
    final backup = await createLocalBackup();
    if (backup.isSuccess) {
      await _cloudStorage.upload(
        file: backup.file!,
        path: 'backups/${DateTime.now().toIso8601String()}.backup',
      );
    }
  }

  /// è·å–å¤‡ä»½åˆ—è¡¨
  Future<List<BackupMetadata>> listBackups() async {
    final localBackups = await _listLocalBackups();
    final cloudBackups = await _listCloudBackups();

    return [...localBackups, ...cloudBackups]
      ..sort((a, b) => b.createdAt.compareTo(a.createdAt));
  }

  /// åˆ é™¤å¤‡ä»½
  Future<void> deleteBackup(BackupMetadata metadata) async {
    if (metadata.isLocal) {
      await File(metadata.path).delete();
    } else {
      await _cloudStorage.delete(metadata.path);
    }
  }
}
```

#### 22.3.2 è‡ªåŠ¨å¤‡ä»½ç­–ç•¥

```dart
/// è‡ªåŠ¨å¤‡ä»½ç®¡ç†å™¨
class AutoBackupManager {
  final BackupService _backupService;
  final SharedPreferences _prefs;

  /// è‡ªåŠ¨å¤‡ä»½é…ç½®
  static const _autoBackupKey = 'auto_backup_enabled';
  static const _backupIntervalKey = 'backup_interval_days';
  static const _lastBackupKey = 'last_backup_time';
  static const _keepBackupsKey = 'keep_backups_count';

  /// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¤‡ä»½
  Future<bool> shouldAutoBackup() async {
    final enabled = _prefs.getBool(_autoBackupKey) ?? true;
    if (!enabled) return false;

    final lastBackup = _prefs.getString(_lastBackupKey);
    if (lastBackup == null) return true;

    final lastBackupTime = DateTime.parse(lastBackup);
    final interval = _prefs.getInt(_backupIntervalKey) ?? 7;

    return DateTime.now().difference(lastBackupTime).inDays >= interval;
  }

  /// æ‰§è¡Œè‡ªåŠ¨å¤‡ä»½
  Future<void> performAutoBackup() async {
    if (!await shouldAutoBackup()) return;

    final result = await _backupService.createLocalBackup();
    if (result.isSuccess) {
      await _prefs.setString(_lastBackupKey, DateTime.now().toIso8601String());
      await _cleanupOldBackups();
    }
  }

  /// æ¸…ç†æ—§å¤‡ä»½
  Future<void> _cleanupOldBackups() async {
    final keepCount = _prefs.getInt(_keepBackupsKey) ?? 5;
    final backups = await _backupService.listBackups();

    // åªä¿ç•™æœ€è¿‘çš„Nä¸ªå¤‡ä»½
    if (backups.length > keepCount) {
      for (final backup in backups.skip(keepCount)) {
        await _backupService.deleteBackup(backup);
      }
    }
  }
}
```

### 22.4 è®¤è¯ä¸æˆæƒ

#### 22.4.1 ç”¨æˆ·è®¤è¯æœåŠ¡

```dart
/// ç”¨æˆ·è®¤è¯æœåŠ¡
class AuthenticationService {
  final HttpService _http;
  final SecureStorageService _secureStorage;

  /// å½“å‰ç”¨æˆ·
  User? _currentUser;

  /// ç™»å½•
  Future<AuthResult> login({
    required String username,
    required String password,
  }) async {
    try {
      final response = await _http.post('/api/auth/login', data: {
        'username': username,
        'password': password,
      });

      final accessToken = response.data['access_token'] as String;
      final refreshToken = response.data['refresh_token'] as String;

      // å®‰å…¨å­˜å‚¨ Token
      await _secureStorage.write('access_token', accessToken);
      await _secureStorage.write('refresh_token', refreshToken);

      _currentUser = User.fromJson(response.data['user']);

      return AuthResult.success(user: _currentUser!);
    } on DioException catch (e) {
      if (e.response?.statusCode == 401) {
        return AuthResult.failure(error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
      }
      return AuthResult.failure(error: 'ç™»å½•å¤±è´¥: ${e.message}');
    }
  }

  /// åˆ·æ–° Token
  Future<bool> refreshToken() async {
    try {
      final refreshToken = await _secureStorage.read('refresh_token');
      if (refreshToken == null) return false;

      final response = await _http.post('/api/auth/refresh', data: {
        'refresh_token': refreshToken,
      });

      final newAccessToken = response.data['access_token'] as String;
      await _secureStorage.write('access_token', newAccessToken);

      // å¦‚æœè¿”å›äº†æ–°çš„ refresh_tokenï¼Œä¹Ÿæ›´æ–°
      if (response.data['refresh_token'] != null) {
        await _secureStorage.write(
          'refresh_token',
          response.data['refresh_token'] as String,
        );
      }

      return true;
    } catch (e) {
      return false;
    }
  }

  /// ç™»å‡º
  Future<void> logout() async {
    try {
      await _http.post('/api/auth/logout');
    } finally {
      await _secureStorage.delete('access_token');
      await _secureStorage.delete('refresh_token');
      _currentUser = null;
    }
  }

  /// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  Future<bool> isLoggedIn() async {
    final token = await _secureStorage.read('access_token');
    return token != null;
  }
}
```

#### 22.4.2 HTTP è¯·æ±‚æ‹¦æˆªå™¨

```dart
/// è®¤è¯æ‹¦æˆªå™¨
class AuthInterceptor extends Interceptor {
  final SecureStorageService _secureStorage;
  final AuthenticationService _authService;

  @override
  Future<void> onRequest(
    RequestOptions options,
    RequestInterceptorHandler handler,
  ) async {
    // æ·»åŠ  Token åˆ°è¯·æ±‚å¤´
    final token = await _secureStorage.read('access_token');
    if (token != null) {
      options.headers['Authorization'] = 'Bearer $token';
    }
    handler.next(options);
  }

  @override
  Future<void> onError(
    DioException err,
    ErrorInterceptorHandler handler,
  ) async {
    if (err.response?.statusCode == 401) {
      // Token è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
      final refreshed = await _authService.refreshToken();
      if (refreshed) {
        // é‡è¯•åŸè¯·æ±‚
        final token = await _secureStorage.read('access_token');
        err.requestOptions.headers['Authorization'] = 'Bearer $token';

        try {
          final response = await Dio().fetch(err.requestOptions);
          return handler.resolve(response);
        } catch (e) {
          return handler.next(err);
        }
      }
    }
    handler.next(err);
  }
}
```

### 22.5 å®¡è®¡ä¸åˆè§„

#### 22.5.1 å®‰å…¨å®¡è®¡æ—¥å¿—

```dart
/// å®‰å…¨å®¡è®¡æœåŠ¡
class SecurityAuditService {
  final DatabaseService _database;

  /// è®°å½•å®‰å…¨äº‹ä»¶
  Future<void> logSecurityEvent({
    required SecurityEventType type,
    required String description,
    Map<String, dynamic>? metadata,
  }) async {
    await _database.insert('security_audit_log', {
      'id': Uuid().v4(),
      'event_type': type.name,
      'description': description,
      'metadata': metadata != null ? jsonEncode(metadata) : null,
      'timestamp': DateTime.now().toIso8601String(),
      'device_info': await _getDeviceInfo(),
    });
  }

  /// å®‰å…¨äº‹ä»¶ç±»å‹
  Future<void> onLoginSuccess(String userId) async {
    await logSecurityEvent(
      type: SecurityEventType.loginSuccess,
      description: 'ç”¨æˆ·ç™»å½•æˆåŠŸ',
      metadata: {'user_id': userId},
    );
  }

  Future<void> onLoginFailed(String reason) async {
    await logSecurityEvent(
      type: SecurityEventType.loginFailed,
      description: 'ç™»å½•å¤±è´¥: $reason',
    );
  }

  Future<void> onAppUnlocked(LockMethod method) async {
    await logSecurityEvent(
      type: SecurityEventType.appUnlocked,
      description: 'åº”ç”¨è§£é”',
      metadata: {'method': method.name},
    );
  }

  Future<void> onBackupCreated(String backupId) async {
    await logSecurityEvent(
      type: SecurityEventType.backupCreated,
      description: 'åˆ›å»ºå¤‡ä»½',
      metadata: {'backup_id': backupId},
    );
  }

  Future<void> onDataExported() async {
    await logSecurityEvent(
      type: SecurityEventType.dataExported,
      description: 'æ•°æ®å¯¼å‡º',
    );
  }

  /// è·å–å®¡è®¡æ—¥å¿—
  Future<List<SecurityAuditLog>> getAuditLogs({
    DateTime? startDate,
    DateTime? endDate,
    SecurityEventType? eventType,
    int limit = 100,
  }) async {
    // æŸ¥è¯¢å®¡è®¡æ—¥å¿—
    return await _database.querySecurityLogs(
      startDate: startDate,
      endDate: endDate,
      eventType: eventType,
      limit: limit,
    );
  }
}

enum SecurityEventType {
  loginSuccess,
  loginFailed,
  appUnlocked,
  appLocked,
  backupCreated,
  backupRestored,
  dataExported,
  dataImported,
  privacyModeToggled,
  securitySettingsChanged,
}
```

#### 22.5.2 æ•°æ®ä¿ç•™ç­–ç•¥

```dart
/// æ•°æ®ä¿ç•™ç­–ç•¥æœåŠ¡
class DataRetentionService {
  final DatabaseService _database;

  /// é»˜è®¤ä¿ç•™æœŸé™ï¼ˆå¤©ï¼‰
  static const defaultRetentionDays = 365 * 5; // 5å¹´

  /// åº”ç”¨æ•°æ®ä¿ç•™ç­–ç•¥
  Future<DataRetentionResult> applyRetentionPolicy() async {
    final results = <String, int>{};

    // 1. æ¸…ç†è¿‡æœŸçš„å®‰å…¨å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰
    final auditLogsDeleted = await _database.deleteWhere(
      'security_audit_log',
      where: 'timestamp < ?',
      whereArgs: [
        DateTime.now().subtract(Duration(days: 365)).toIso8601String(),
      ],
    );
    results['audit_logs'] = auditLogsDeleted;

    // 2. æ¸…ç†è¿‡æœŸçš„åŒæ­¥æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰
    final syncLogsDeleted = await _database.deleteWhere(
      'sync_log',
      where: 'timestamp < ?',
      whereArgs: [
        DateTime.now().subtract(Duration(days: 30)).toIso8601String(),
      ],
    );
    results['sync_logs'] = syncLogsDeleted;

    // 3. äº¤æ˜“æ•°æ®ä¸è‡ªåŠ¨åˆ é™¤ï¼Œç”±ç”¨æˆ·æ§åˆ¶

    return DataRetentionResult(
      deletedRecords: results,
      executedAt: DateTime.now(),
    );
  }

  /// ç”¨æˆ·è¯·æ±‚åˆ é™¤æ‰€æœ‰æ•°æ®
  Future<void> deleteAllUserData() async {
    // 1. åˆ é™¤æ‰€æœ‰äº¤æ˜“
    await _database.deleteAll('transactions');

    // 2. åˆ é™¤æ‰€æœ‰è´¦æˆ·
    await _database.deleteAll('accounts');

    // 3. åˆ é™¤æ‰€æœ‰åˆ†ç±»
    await _database.deleteAll('categories');

    // 4. åˆ é™¤æ‰€æœ‰é¢„ç®—
    await _database.deleteAll('budgets');

    // 5. åˆ é™¤æ‰€æœ‰å¤‡ä»½
    await BackupService().deleteAllBackups();

    // 6. æ¸…é™¤å®‰å…¨å­˜å‚¨
    await SecureStorageService().deleteAll();

    // 7. è®°å½•æ•°æ®åˆ é™¤äº‹ä»¶
    await SecurityAuditService().logSecurityEvent(
      type: SecurityEventType.dataExported,
      description: 'ç”¨æˆ·è¯·æ±‚åˆ é™¤æ‰€æœ‰æ•°æ®',
    );
  }
}
```


---


---

### 22.6 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 22.6.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

å®‰å…¨ä¸éšç§ç³»ç»Ÿä¸ºå…¶ä»–2.0æ¨¡å—æä¾›åŸºç¡€å®‰å…¨èƒ½åŠ›ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®‰å…¨ä¸éšç§é›†æˆå…¨æ™¯å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        å®‰å…¨æ ¸å¿ƒæœåŠ¡                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ æ•°æ®åŠ å¯†  â”‚  â”‚ è®¤è¯æˆæƒ  â”‚  â”‚ éšç§ä¿æŠ¤  â”‚  â”‚ å®¡è®¡æ—¥å¿—  â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡    â”‚     â”‚  æ™ºèƒ½å¢å¼º    â”‚     â”‚  2.0æ–°å¢    â”‚                 â”‚
â”‚  â”‚  å®‰å…¨ä¿æŠ¤    â”‚     â”‚  å®‰å…¨ä¿æŠ¤    â”‚     â”‚  å®‰å…¨ä¿æŠ¤    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ é’±é¾„æ•°æ®   â”‚     â”‚ â€¢ AIæ¨¡å‹    â”‚     â”‚ â€¢ ä½ç½®æ•°æ®   â”‚                 â”‚
â”‚  â”‚ â€¢ é¢„ç®—æ•°æ®   â”‚     â”‚ â€¢ è¯­éŸ³æ•°æ®   â”‚     â”‚ â€¢ å®¶åº­æ•°æ®   â”‚                 â”‚
â”‚  â”‚ â€¢ äº¤æ˜“è®°å½•   â”‚     â”‚ â€¢ è¯†åˆ«ç»“æœ   â”‚     â”‚ â€¢ åŒæ­¥æ•°æ®   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 22.6.2 ä½ç½®æ•°æ®å®‰å…¨é›†æˆ

ä½ç½®æ•°æ®æ˜¯é«˜åº¦æ•æ„Ÿçš„éšç§ä¿¡æ¯ï¼Œéœ€è¦ç‰¹æ®Šä¿æŠ¤ï¼š

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| æœ¬åœ°åŠ å¯†å­˜å‚¨ | AES-256åŠ å¯† | åŸå§‹åæ ‡åŠ å¯†å­˜å‚¨ |
| ç²¾åº¦é™çº§ | ç½‘æ ¼åŒ–å¤„ç† | å­˜å‚¨æ—¶é™ä½ç²¾åº¦ |
| è‡ªåŠ¨æ¸…ç† | å®šæ—¶ä»»åŠ¡ | è¶…è¿‡30å¤©è‡ªåŠ¨åˆ é™¤ |
| è®¿é—®æ§åˆ¶ | æƒé™æ£€æŸ¥ | éœ€è¦æ˜ç¡®ç”¨æˆ·æˆæƒ |
| ä¼ è¾“ä¿æŠ¤ | TLS 1.3 | ä¸Šä¼ æœåŠ¡å™¨æ—¶åŠ å¯† |

#### 22.6.3 è¯­éŸ³æ•°æ®å®‰å…¨é›†æˆ

è¯­éŸ³è®°è´¦æ¶‰åŠç”¨æˆ·è¯­éŸ³æ•°æ®çš„å¤„ç†ï¼š

| é˜¶æ®µ | å®‰å…¨æªæ–½ | è¯´æ˜ |
|------|----------|------|
| å½•åˆ¶ | å†…å­˜å¤„ç† | éŸ³é¢‘ä¸è½åœ°å­˜å‚¨ |
| è¯†åˆ« | æœ¬åœ°ä¼˜å…ˆ | ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ASR |
| ä¼ è¾“ | ç«¯åˆ°ç«¯åŠ å¯† | ä¼ è¾“åˆ°äº‘ç«¯æ—¶åŠ å¯† |
| å­˜å‚¨ | ä¸å­˜åŸéŸ³ | åªå­˜å‚¨è¯†åˆ«æ–‡æœ¬ |
| æ¸…ç† | å³æ—¶åˆ é™¤ | è¯†åˆ«å®Œæˆç«‹å³åˆ é™¤ |

#### 22.6.4 å®¶åº­è´¦æœ¬å®‰å…¨é›†æˆ

å®¶åº­è´¦æœ¬æ¶‰åŠå¤šç”¨æˆ·æ•°æ®å…±äº«ï¼š

| å®‰å…¨éœ€æ±‚ | å®ç°æ–¹å¼ |
|----------|----------|
| æˆå‘˜è®¤è¯ | å®¶åº­é‚€è¯·ç  + ç”¨æˆ·è®¤è¯ |
| æ•°æ®éš”ç¦» | å®¶åº­IDéš”ç¦» + æˆå‘˜æƒé™ |
| æ“ä½œå®¡è®¡ | è®°å½•æˆå‘˜æ“ä½œæ—¥å¿— |
| é€€å‡ºæ¸…ç† | æˆå‘˜é€€å‡ºæ—¶æ¸…ç†å…³è”æ•°æ® |
| ä¼ è¾“åŠ å¯† | å®¶åº­åŒæ­¥æ•°æ®åŠ å¯†ä¼ è¾“ |

#### 22.6.5 AIè¯†åˆ«å®‰å…¨é›†æˆ

AIè¯†åˆ«æ¶‰åŠç”¨æˆ·è´¢åŠ¡æ•°æ®çš„å¤„ç†ï¼š

| æ•°æ®ç±»å‹ | å®‰å…¨æªæ–½ |
|----------|----------|
| ç¥¨æ®å›¾ç‰‡ | æœ¬åœ°é¢„å¤„ç†åä¸Šä¼ ï¼Œè¯†åˆ«ååˆ é™¤äº‘ç«¯å‰¯æœ¬ |
| æ¶ˆè´¹æ–‡æœ¬ | è„±æ•å¤„ç†ï¼Œä¸ä¸Šä¼ çœŸå®å•†æˆ·å |
| è¯†åˆ«ç»“æœ | ä»…å­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼Œä¸å­˜åŸå§‹è¾“å…¥ |
| AIæ¨¡å‹ | æ”¯æŒæœ¬åœ°æ¨¡å‹ï¼Œå‡å°‘äº‘ç«¯ä¾èµ– |

#### 22.6.6 æ•°æ®åŒæ­¥å®‰å…¨é›†æˆ

è·¨è®¾å¤‡åŒæ­¥éœ€è¦ç¡®ä¿æ•°æ®å®‰å…¨ï¼š

| å®‰å…¨æªæ–½ | è¯´æ˜ |
|----------|------|
| ç«¯åˆ°ç«¯åŠ å¯† | åŒæ­¥æ•°æ®åœ¨å®¢æˆ·ç«¯åŠ å¯†ï¼ŒæœåŠ¡ç«¯æ— æ³•è§£å¯† |
| è®¾å¤‡ç»‘å®š | æ–°è®¾å¤‡éœ€è¦éªŒè¯æ‰èƒ½åŒæ­¥ |
| å†²çªè§£å†³ | ä½¿ç”¨ç‰ˆæœ¬å‘é‡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ |
| ä¼ è¾“åŠ å¯† | TLS 1.3 + åº”ç”¨å±‚åŠ å¯†åŒé‡ä¿æŠ¤ |
| å¢é‡åŒæ­¥ | ä»…åŒæ­¥å˜æ›´æ•°æ®ï¼Œå‡å°‘æš´éœ²é¢ |

---

## 23. å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡

æœ¬ç« èŠ‚åŸºäº**é«˜å¯ç”¨ä¼˜å…ˆåŸåˆ™**å’Œ**æ•°æ®ä¸€è‡´æ€§åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿåœ¨é¢å¯¹å„ç±»å¼‚å¸¸æƒ…å†µæ—¶çš„å¤„ç†ç­–ç•¥ã€‚


### 23.0 è®¾è®¡åŸåˆ™å›é¡¾

#### 23.0.1 å¼‚å¸¸å¤„ç†è®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡åŸåˆ™çŸ©é˜µ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é«˜å¯ç”¨ä¼˜å…ˆåŸåˆ™                                                         â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ æœåŠ¡æ°¸è¿œå¯ç”¨ï¼šå³ä½¿éƒ¨åˆ†ç»„ä»¶æ•…éšœï¼Œæ ¸å¿ƒåŠŸèƒ½ä»å¯ä½¿ç”¨                       â”‚ â”‚
â”‚  â”‚  â€¢ ä¼˜é›…é™çº§ï¼šé«˜çº§åŠŸèƒ½ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°åŸºç¡€åŠŸèƒ½                         â”‚ â”‚
â”‚  â”‚  â€¢ å¿«é€Ÿå¤±è´¥ï¼šæ£€æµ‹åˆ°ä¸å¯æ¢å¤é”™è¯¯æ—¶ï¼Œç«‹å³é€šçŸ¥ç”¨æˆ·è€Œéæ— é™ç­‰å¾…               â”‚ â”‚
â”‚  â”‚  â€¢ ç¦»çº¿ä¼˜å…ˆï¼šç½‘ç»œä¸å¯ç”¨æ—¶ï¼Œæœ¬åœ°åŠŸèƒ½æ­£å¸¸è¿è¡Œ                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ•°æ®ä¸€è‡´æ€§åŸåˆ™                                                         â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼Œä¿è¯æœ€ç»ˆæ•°æ®æ­£ç¡®                           â”‚ â”‚
â”‚  â”‚  â€¢ å¹‚ç­‰æ“ä½œï¼šç›¸åŒæ“ä½œé‡å¤æ‰§è¡Œç»“æœä¸€è‡´                                    â”‚ â”‚
â”‚  â”‚  â€¢ å†²çªæ£€æµ‹ï¼šå‘ç°æ•°æ®å†²çªæ—¶æä¾›ç”¨æˆ·é€‰æ‹©                                  â”‚ â”‚
â”‚  â”‚  â€¢ æ•°æ®å®Œæ•´æ€§ï¼šå®šæœŸæ£€æŸ¥å’Œä¿®å¤æ•°æ®é—®é¢˜                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç”¨æˆ·ä½“éªŒä¿éšœåŸåˆ™                                                       â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ é€æ˜åé¦ˆï¼šè®©ç”¨æˆ·çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€æ­£åœ¨åšä»€ä¹ˆ                             â”‚ â”‚
â”‚  â”‚  â€¢ å¯æ“ä½œæç¤ºï¼šæä¾›æ˜ç¡®çš„ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®                                   â”‚ â”‚
â”‚  â”‚  â€¢ åˆ†çº§å¤„ç†ï¼šæ ¹æ®å¼‚å¸¸ä¸¥é‡ç¨‹åº¦é‡‡ç”¨ä¸åŒçš„UIåé¦ˆæ–¹å¼                         â”‚ â”‚
â”‚  â”‚  â€¢ é™é»˜æ¢å¤ï¼šå¯è‡ªåŠ¨æ¢å¤çš„å¼‚å¸¸ä¸æ‰“æ‰°ç”¨æˆ·                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.0.2 å¼‚å¸¸å¤„ç†æ¨¡å—åä½œå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¼‚å¸¸å¤„ç†ä¸å®¹é”™ç³»ç»Ÿæ¨¡å—åä½œå›¾                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                           â”‚    ç”¨æˆ·æ“ä½œå…¥å£      â”‚                            â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          å¼‚å¸¸å¤„ç†åè°ƒå±‚                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ å¼‚å¸¸åˆ†ç±»å™¨   â”‚  â”‚  é‡è¯•ç­–ç•¥   â”‚  â”‚  é™çº§ç­–ç•¥   â”‚  â”‚  ç†”æ–­å™¨     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ (23.1)      â”‚  â”‚  (23.1.2)   â”‚  â”‚  (23.5)     â”‚  â”‚  (23.5)     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                            â”‚                            â”‚          â”‚
â”‚         â–¼                            â–¼                            â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   ä¸šåŠ¡å¼‚å¸¸å¤„ç†   â”‚   â”‚   æ•°æ®åŒæ­¥å¼‚å¸¸å¤„ç†   â”‚   â”‚   ç”¨æˆ·ä½“éªŒå¼‚å¸¸å¤„ç†   â”‚    â”‚
â”‚  â”‚     (23.3)      â”‚   â”‚       (23.2)        â”‚   â”‚       (23.6)        â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚é’±é¾„è®¡ç®—å®¹é”™ â”‚ â”‚   â”‚ â”‚  ç¦»çº¿æ“ä½œé˜Ÿåˆ—   â”‚ â”‚   â”‚ â”‚   å¼‚å¸¸UIåé¦ˆ    â”‚ â”‚    â”‚
â”‚  â”‚ â”‚  (23.3.1)   â”‚ â”‚   â”‚ â”‚    (23.2.1)     â”‚ â”‚   â”‚ â”‚    (23.6.1)     â”‚ â”‚    â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚ â”‚é¢„ç®—åˆ†é…å®¹é”™ â”‚ â”‚   â”‚ â”‚  åŒæ­¥çŠ¶æ€æœº     â”‚ â”‚   â”‚                     â”‚    â”‚
â”‚  â”‚ â”‚  (23.3.2)   â”‚ â”‚   â”‚ â”‚    (23.2.2)     â”‚ â”‚   â”‚                     â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚                            â”‚                            â”‚          â”‚
â”‚         â–¼                            â–¼                            â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ•°æ®å®Œæ•´æ€§æ£€æŸ¥  â”‚   â”‚     å¹‚ç­‰æ€§æœåŠ¡      â”‚   â”‚   å¯è§‚æµ‹æ€§ä¸ç›‘æ§    â”‚    â”‚
â”‚  â”‚    (23.1.3)     â”‚   â”‚      (23.4)        â”‚   â”‚   (ç¬¬25ç« è”åŠ¨)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.0.3 ä¸å…¶ä»–æ¨¡å—çš„ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¼‚å¸¸å¤„ç†æ¨¡å—ä¸å…¶ä»–ç³»ç»Ÿçš„ä¾èµ–å…³ç³»                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                         â”‚
â”‚                        â•‘  ç¬¬23ç«  å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡ â•‘                         â”‚
â”‚                        â•‘    (æ¨ªåˆ‡å…³æ³¨ç‚¹ç³»ç»Ÿ)        â•‘                         â”‚
â”‚                        â•šâ•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                         â”‚
â”‚                                    â”‚                                         â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚             â”‚              â”‚              â”‚             â”‚            â”‚
â”‚       â–¼             â–¼              â–¼              â–¼             â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç¬¬7ç«    â”‚  â”‚  ç¬¬8ç«    â”‚  â”‚  ç¬¬10ç«    â”‚  â”‚  ç¬¬15ç«   â”‚  â”‚  ç¬¬25ç«  â”‚        â”‚
â”‚  â”‚é’±é¾„ç³»ç»Ÿ â”‚  â”‚é¢„ç®—ç³»ç»Ÿ  â”‚  â”‚AIè¯†åˆ«   â”‚  â”‚æŠ€æœ¯æ¶æ„  â”‚  â”‚å¯è§‚æµ‹æ€§  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â”‚            â”‚             â”‚             â”‚             â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚         å¼‚å¸¸å¤„ç†æä¾›çš„èƒ½åŠ›          â”‚                       â”‚
â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚                  â”‚ â€¢ é’±é¾„è®¡ç®—å®¹é”™ (â†’ ç¬¬7ç« )           â”‚                       â”‚
â”‚                  â”‚ â€¢ é¢„ç®—åˆ†é…å®¹é”™ (â†’ ç¬¬8ç« )           â”‚                       â”‚
â”‚                  â”‚ â€¢ AIæœåŠ¡é™çº§ (â†’ ç¬¬10ç« )             â”‚                       â”‚
â”‚                  â”‚ â€¢ ç½‘ç»œè¯·æ±‚é‡è¯• (â†’ ç¬¬15ç« )          â”‚                       â”‚
â”‚                  â”‚ â€¢ å¼‚å¸¸ä¸ŠæŠ¥ç›‘æ§ (â†’ ç¬¬5ç« )          â”‚                       â”‚
â”‚                  â”‚ â€¢ ç¦»çº¿é˜Ÿåˆ—åŒæ­¥ (â†’ æ•°æ®åŒæ­¥)        â”‚                       â”‚
â”‚                  â”‚ â€¢ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ (â†’ æ‰€æœ‰æ•°æ®æ¨¡å—)   â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                              â”‚
â”‚  ä¾èµ–æ–¹å‘è¯´æ˜ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  â€¢ ç¬¬23ç« æ˜¯æ¨ªåˆ‡å…³æ³¨ç‚¹(Cross-Cutting Concern)ï¼Œè¢«æ‰€æœ‰ä¸šåŠ¡æ¨¡å—ä¾èµ–               â”‚
â”‚  â€¢ å„ä¸šåŠ¡æ¨¡å—é€šè¿‡è£…é¥°å™¨/ä¸­é—´ä»¶/æ‹¦æˆªå™¨æ¨¡å¼æ¥å…¥å¼‚å¸¸å¤„ç†èƒ½åŠ›                       â”‚
â”‚  â€¢ ç¬¬23ç« ä¾èµ–ç¬¬25ç« çš„å¯è§‚æµ‹æ€§èƒ½åŠ›è¿›è¡Œå¼‚å¸¸ä¸ŠæŠ¥å’Œç›‘æ§                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.0.4 å¼‚å¸¸å¤„ç†å­ç³»ç»ŸèŒè´£è¾¹ç•Œè¡¨

| å­ç³»ç»Ÿ | ç« èŠ‚ | æ ¸å¿ƒèŒè´£ | è¾“å…¥ | è¾“å‡º |
|--------|------|----------|------|------|
| **å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†** | 23.1 | ç»Ÿä¸€å¼‚å¸¸å®šä¹‰ã€åˆ†ç±»ã€ç½‘ç»œé‡è¯•ã€æ•°æ®ä¿®å¤ | åŸå§‹å¼‚å¸¸ | AppException |
| **ç¦»çº¿åŒæ­¥** | 23.2 | ç¦»çº¿æ“ä½œé˜Ÿåˆ—ã€å†²çªæ£€æµ‹ã€åŒæ­¥çŠ¶æ€æœº | ç”¨æˆ·æ“ä½œ | åŒæ­¥ç»“æœ |
| **ä¸šåŠ¡å¼‚å¸¸å¤„ç†** | 23.3 | é’±é¾„è®¡ç®—å®¹é”™ã€é¢„ç®—åˆ†é…å®¹é”™ | ä¸šåŠ¡æ•°æ® | å®¹é”™ç»“æœ |
| **å¹‚ç­‰æ€§æœåŠ¡** | 23.4 | å¹‚ç­‰é”®ç®¡ç†ã€é‡å¤æ“ä½œæ£€æµ‹ | æ“ä½œè¯·æ±‚ | å¹‚ç­‰ç»“æœ |
| **é™çº§ä¸ç†”æ–­** | 23.5 | æœåŠ¡å¥åº·æ£€æµ‹ã€é™çº§ç­–ç•¥ã€ç†”æ–­å™¨ | æœåŠ¡è°ƒç”¨ | é™çº§ç»“æœ |
| **ç”¨æˆ·ä½“éªŒä¿éšœ** | 23.6 | å¼‚å¸¸UIåˆ†çº§åé¦ˆ | AppException | UIæç¤º |

#### 23.0.5 å¼‚å¸¸å¤„ç†æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¼‚å¸¸å¤„ç†æ•°æ®æµç¤ºæ„å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·æ“ä½œ                                                                     â”‚
â”‚      â”‚                                                                       â”‚
â”‚      â–¼                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   ä¸šåŠ¡å±‚è°ƒç”¨    â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æˆåŠŸ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   æ­£å¸¸æ‰§è¡Œ      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   è¿”å›ç»“æœ      â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚           â”‚ å¼‚å¸¸                                                             â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  å¼‚å¸¸æ•è·å±‚     â”‚                                                          â”‚
â”‚  â”‚ try-catchåŒ…è£…   â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  å¼‚å¸¸åˆ†ç±»å™¨     â”‚â”€â”€â”€â–¶ ç¡®å®š ExceptionCategory + ExceptionSeverity           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚           â”‚                                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚     â”‚           â”‚             â”‚             â”‚                               â”‚
â”‚     â–¼           â–¼             â–¼             â–¼                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚ â”‚å¯é‡è¯•   â”‚ â”‚éœ€é™çº§   â”‚   â”‚éœ€ä¸ŠæŠ¥   â”‚   â”‚éœ€æç¤º   â”‚                            â”‚
â”‚ â”‚network â”‚ â”‚server  â”‚   â”‚criticalâ”‚   â”‚warning â”‚                            â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                            â”‚
â”‚      â”‚          â”‚            â”‚            â”‚                                 â”‚
â”‚      â–¼          â–¼            â–¼            â–¼                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚ â”‚é‡è¯•ç­–ç•¥ â”‚ â”‚é™çº§ç­–ç•¥ â”‚   â”‚å¼‚å¸¸ä¸ŠæŠ¥ â”‚   â”‚UIåé¦ˆ   â”‚                            â”‚
â”‚ â”‚æŒ‡æ•°é€€é¿ â”‚ â”‚å¤‡é€‰æ–¹æ¡ˆ â”‚   â”‚ç›‘æ§ç³»ç»Ÿ â”‚   â”‚ç”¨æˆ·æç¤º â”‚                            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 23.1 å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥

#### 23.1.1 å¼‚å¸¸åˆ†ç±»ä½“ç³»

```dart
/// å¼‚å¸¸åˆ†ç±»æšä¸¾
enum ExceptionCategory {
  /// ç½‘ç»œå¼‚å¸¸ - å¯é‡è¯•
  network,

  /// æœåŠ¡ç«¯å¼‚å¸¸ - éœ€é™çº§
  server,

  /// å®¢æˆ·ç«¯å¼‚å¸¸ - éœ€ç”¨æˆ·ä»‹å…¥
  client,

  /// æ•°æ®å¼‚å¸¸ - éœ€ä¿®å¤
  data,

  /// ä¸šåŠ¡å¼‚å¸¸ - æ­£å¸¸å¤„ç†
  business,

  /// ç³»ç»Ÿå¼‚å¸¸ - éœ€ä¸ŠæŠ¥
  system,
}

/// å¼‚å¸¸ä¸¥é‡ç¨‹åº¦
enum ExceptionSeverity {
  /// å¯å¿½ç•¥ - é™é»˜å¤„ç†
  ignorable,

  /// å¯æ¢å¤ - è‡ªåŠ¨é‡è¯•
  recoverable,

  /// éœ€æç¤º - é€šçŸ¥ç”¨æˆ·
  warning,

  /// ä¸¥é‡ - é˜»æ–­æ“ä½œ
  critical,

  /// è‡´å‘½ - åº”ç”¨å´©æºƒé£é™©
  fatal,
}

/// ç»Ÿä¸€å¼‚å¸¸å®šä¹‰
class AppException implements Exception {
  final String code;
  final String message;
  final String? userMessage;
  final ExceptionCategory category;
  final ExceptionSeverity severity;
  final dynamic originalError;
  final StackTrace? stackTrace;
  final Map<String, dynamic>? context;
  final DateTime timestamp;

  AppException({
    required this.code,
    required this.message,
    this.userMessage,
    required this.category,
    required this.severity,
    this.originalError,
    this.stackTrace,
    this.context,
  }) : timestamp = DateTime.now();

  /// æ˜¯å¦å¯é‡è¯•
  bool get isRetryable =>
    category == ExceptionCategory.network ||
    (category == ExceptionCategory.server && severity != ExceptionSeverity.fatal);

  /// æ˜¯å¦éœ€è¦ä¸ŠæŠ¥
  bool get shouldReport =>
    severity == ExceptionSeverity.critical ||
    severity == ExceptionSeverity.fatal;
}
```

#### 23.1.2 ç½‘ç»œå¼‚å¸¸å¤„ç†

```dart
/// ç½‘ç»œå¼‚å¸¸å¤„ç†å™¨
class NetworkExceptionHandler {
  static const int maxRetries = 3;
  static const Duration initialBackoff = Duration(seconds: 1);

  /// ç½‘ç»œè¯·æ±‚åŒ…è£…å™¨ï¼ˆå¸¦é‡è¯•ï¼‰
  Future<T> executeWithRetry<T>({
    required Future<T> Function() request,
    required String operationName,
    int? maxRetries,
    bool showLoading = true,
  }) async {
    final retries = maxRetries ?? NetworkExceptionHandler.maxRetries;
    Duration backoff = initialBackoff;

    for (int attempt = 1; attempt <= retries; attempt++) {
      try {
        return await request();
      } on SocketException catch (e) {
        // æ— ç½‘ç»œè¿æ¥
        if (attempt == retries) {
          throw AppException(
            code: 'NETWORK_UNAVAILABLE',
            message: 'No network connection',
            userMessage: 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
            category: ExceptionCategory.network,
            severity: ExceptionSeverity.warning,
            originalError: e,
          );
        }
        await _waitWithBackoff(backoff);
        backoff *= 2;
      } on TimeoutException catch (e) {
        // è¯·æ±‚è¶…æ—¶
        if (attempt == retries) {
          throw AppException(
            code: 'REQUEST_TIMEOUT',
            message: 'Request timeout after $retries attempts',
            userMessage: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
            category: ExceptionCategory.network,
            severity: ExceptionSeverity.recoverable,
            originalError: e,
          );
        }
        await _waitWithBackoff(backoff);
        backoff *= 2;
      } on HttpException catch (e) {
        // HTTPé”™è¯¯ï¼Œæ ¹æ®çŠ¶æ€ç å†³å®šæ˜¯å¦é‡è¯•
        final statusCode = _extractStatusCode(e);
        if (_isRetryableStatusCode(statusCode) && attempt < retries) {
          await _waitWithBackoff(backoff);
          backoff *= 2;
          continue;
        }
        throw _mapHttpException(e, statusCode);
      }
    }

    throw AppException(
      code: 'UNEXPECTED_RETRY_FAILURE',
      message: 'All retry attempts exhausted',
      category: ExceptionCategory.network,
      severity: ExceptionSeverity.critical,
    );
  }

  /// å¯é‡è¯•çš„HTTPçŠ¶æ€ç 
  bool _isRetryableStatusCode(int? statusCode) {
    if (statusCode == null) return true;
    return statusCode == 408 || // Request Timeout
           statusCode == 429 || // Too Many Requests
           statusCode == 502 || // Bad Gateway
           statusCode == 503 || // Service Unavailable
           statusCode == 504;   // Gateway Timeout
  }

  /// æŒ‡æ•°é€€é¿ç­‰å¾…
  Future<void> _waitWithBackoff(Duration duration) async {
    final jitter = Random().nextDouble() * 0.3; // 0-30% éšæœºæŠ–åŠ¨
    final actualWait = duration * (1 + jitter);
    await Future.delayed(actualWait);
  }
}
```

#### 23.1.3 æ•°æ®å¼‚å¸¸å¤„ç†

```dart
/// æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æœåŠ¡
class DataIntegrityService {
  final DatabaseService _db;
  final Logger _logger;

  /// äº¤æ˜“æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
  Future<DataIntegrityReport> checkTransactionIntegrity() async {
    final issues = <DataIntegrityIssue>[];

    // 1. æ£€æŸ¥å­¤å„¿äº¤æ˜“ï¼ˆå…³è”çš„è´¦æˆ·/åˆ†ç±»å·²åˆ é™¤ï¼‰
    final orphanTransactions = await _findOrphanTransactions();
    for (final tx in orphanTransactions) {
      issues.add(DataIntegrityIssue(
        type: IssueType.orphanRecord,
        table: 'transactions',
        recordId: tx.id,
        description: 'äº¤æ˜“å…³è”çš„è´¦æˆ·æˆ–åˆ†ç±»ä¸å­˜åœ¨',
        suggestedFix: DataFix.assignDefault,
        autoFixable: true,
      ));
    }

    // 2. æ£€æŸ¥é‡‘é¢å¼‚å¸¸ï¼ˆNaNã€æ— ç©·å¤§ã€è´Ÿæ•°é‡‘é¢åœ¨ä¸è¯¥å‡ºç°çš„åœ°æ–¹ï¼‰
    final invalidAmounts = await _findInvalidAmounts();
    for (final tx in invalidAmounts) {
      issues.add(DataIntegrityIssue(
        type: IssueType.invalidValue,
        table: 'transactions',
        recordId: tx.id,
        description: 'é‡‘é¢å€¼å¼‚å¸¸: ${tx.amount}',
        suggestedFix: DataFix.manualReview,
        autoFixable: false,
      ));
    }

    // 3. æ£€æŸ¥æ—¥æœŸå¼‚å¸¸ï¼ˆæœªæ¥æ—¥æœŸè¶…è¿‡1å¹´ã€è¿‡å»æ—¥æœŸè¶…è¿‡100å¹´ï¼‰
    final invalidDates = await _findInvalidDates();
    for (final tx in invalidDates) {
      issues.add(DataIntegrityIssue(
        type: IssueType.invalidValue,
        table: 'transactions',
        recordId: tx.id,
        description: 'æ—¥æœŸå¼‚å¸¸: ${tx.date}',
        suggestedFix: DataFix.setToNow,
        autoFixable: true,
      ));
    }

    // 4. æ£€æŸ¥é‡å¤äº¤æ˜“
    final duplicates = await _findDuplicateTransactions();
    for (final group in duplicates) {
      issues.add(DataIntegrityIssue(
        type: IssueType.duplicate,
        table: 'transactions',
        recordId: group.first.id,
        relatedIds: group.skip(1).map((t) => t.id).toList(),
        description: 'å‘ç°${group.length}æ¡å¯èƒ½é‡å¤çš„äº¤æ˜“',
        suggestedFix: DataFix.mergeDuplicates,
        autoFixable: false,
      ));
    }

    // 5. æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
    final balanceIssues = await _checkAccountBalances();
    issues.addAll(balanceIssues);

    return DataIntegrityReport(
      checkTime: DateTime.now(),
      totalIssues: issues.length,
      criticalIssues: issues.where((i) => i.severity == IssueSeverity.critical).length,
      autoFixableIssues: issues.where((i) => i.autoFixable).length,
      issues: issues,
    );
  }

  /// è‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„é—®é¢˜
  Future<DataFixResult> autoFixIssues(DataIntegrityReport report) async {
    final fixedCount = <IssueType, int>{};
    final failedFixes = <DataIntegrityIssue>[];

    for (final issue in report.issues.where((i) => i.autoFixable)) {
      try {
        await _applyFix(issue);
        fixedCount[issue.type] = (fixedCount[issue.type] ?? 0) + 1;
      } catch (e) {
        failedFixes.add(issue);
        _logger.error('Failed to fix issue: ${issue.description}', error: e);
      }
    }

    return DataFixResult(
      totalFixed: fixedCount.values.fold(0, (a, b) => a + b),
      fixedByType: fixedCount,
      failedFixes: failedFixes,
    );
  }

  /// æŸ¥æ‰¾å­¤å„¿äº¤æ˜“
  Future<List<Transaction>> _findOrphanTransactions() async {
    return await _db.rawQuery('''
      SELECT t.* FROM transactions t
      LEFT JOIN accounts a ON t.account_id = a.id
      LEFT JOIN categories c ON t.category_id = c.id
      WHERE a.id IS NULL OR c.id IS NULL
    ''');
  }

  /// æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
  Future<List<DataIntegrityIssue>> _checkAccountBalances() async {
    final issues = <DataIntegrityIssue>[];
    final accounts = await _db.getAllAccounts();

    for (final account in accounts) {
      // è®¡ç®—äº¤æ˜“ç´¯åŠ ä½™é¢
      final calculatedBalance = await _calculateAccountBalance(account.id);

      // ä¸å­˜å‚¨çš„ä½™é¢æ¯”è¾ƒ
      if ((calculatedBalance - account.balance).abs() > 0.01) {
        issues.add(DataIntegrityIssue(
          type: IssueType.balanceMismatch,
          table: 'accounts',
          recordId: account.id,
          description: 'è´¦æˆ·ä½™é¢ä¸ä¸€è‡´: å­˜å‚¨=${account.balance}, è®¡ç®—=${calculatedBalance}',
          suggestedFix: DataFix.recalculateBalance,
          autoFixable: true,
          metadata: {
            'storedBalance': account.balance,
            'calculatedBalance': calculatedBalance,
            'difference': calculatedBalance - account.balance,
          },
        ));
      }
    }

    return issues;
  }
}
```

### 23.2 ç¦»çº¿ä¼˜å…ˆä¸æ•°æ®åŒæ­¥

#### 23.2.1 ç¦»çº¿æ“ä½œé˜Ÿåˆ—

```dart
/// ç¦»çº¿æ“ä½œé˜Ÿåˆ—ç®¡ç†å™¨
class OfflineOperationQueue {
  final DatabaseService _db;
  final SyncService _syncService;
  final ConnectivityService _connectivity;

  /// æ“ä½œé˜Ÿåˆ—è¡¨ç»“æ„
  /// CREATE TABLE offline_queue (
  ///   id TEXT PRIMARY KEY,
  ///   operation_type TEXT NOT NULL,  -- CREATE, UPDATE, DELETE
  ///   entity_type TEXT NOT NULL,     -- transaction, account, category
  ///   entity_id TEXT NOT NULL,
  ///   payload TEXT NOT NULL,         -- JSONåºåˆ—åŒ–çš„æ•°æ®
  ///   created_at TEXT NOT NULL,
  ///   retry_count INTEGER DEFAULT 0,
  ///   last_error TEXT,
  ///   status TEXT DEFAULT 'pending'  -- pending, processing, failed, completed
  /// );

  /// æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—
  Future<void> enqueue(OfflineOperation operation) async {
    await _db.insert('offline_queue', {
      'id': operation.id,
      'operation_type': operation.type.name,
      'entity_type': operation.entityType,
      'entity_id': operation.entityId,
      'payload': jsonEncode(operation.payload),
      'created_at': DateTime.now().toIso8601String(),
      'status': 'pending',
    });

    // å¦‚æœåœ¨çº¿ï¼Œç«‹å³å°è¯•åŒæ­¥
    if (await _connectivity.isOnline) {
      _processQueue();
    }
  }

  /// å¤„ç†é˜Ÿåˆ—
  Future<void> _processQueue() async {
    final pendingOperations = await _getPendingOperations();

    for (final operation in pendingOperations) {
      try {
        await _updateStatus(operation.id, 'processing');
        await _executeOperation(operation);
        await _updateStatus(operation.id, 'completed');
      } catch (e) {
        final retryCount = operation.retryCount + 1;
        if (retryCount >= 5) {
          await _updateStatus(operation.id, 'failed', error: e.toString());
          // é€šçŸ¥ç”¨æˆ·æœ‰åŒæ­¥å¤±è´¥çš„æ“ä½œ
          _notifyFailedOperation(operation);
        } else {
          await _updateRetryCount(operation.id, retryCount, error: e.toString());
        }
      }
    }
  }

  /// å†²çªæ£€æµ‹ä¸è§£å†³
  Future<ConflictResolution> detectAndResolveConflict(
    OfflineOperation localOperation,
    ServerData serverData,
  ) async {
    // æ¯”è¾ƒç‰ˆæœ¬å·
    if (serverData.version > localOperation.baseVersion) {
      // æœåŠ¡å™¨æœ‰æ›´æ–°ç‰ˆæœ¬
      if (localOperation.type == OperationType.update) {
        // å­—æ®µçº§å†²çªæ£€æµ‹
        final conflicts = _detectFieldConflicts(
          localOperation.payload,
          serverData.data,
        );

        if (conflicts.isEmpty) {
          // æ— å­—æ®µå†²çªï¼Œåˆå¹¶
          return ConflictResolution.merge(_mergePayloads(
            localOperation.payload,
            serverData.data,
          ));
        } else {
          // æœ‰å­—æ®µå†²çªï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
          return ConflictResolution.userChoice(conflicts);
        }
      } else if (localOperation.type == OperationType.delete) {
        // æœ¬åœ°åˆ é™¤ï¼ŒæœåŠ¡å™¨æœ‰æ›´æ–°
        return ConflictResolution.userChoice([
          ConflictOption('ä¿ç•™æœåŠ¡å™¨ç‰ˆæœ¬', serverData.data),
          ConflictOption('ä»ç„¶åˆ é™¤', null),
        ]);
      }
    }

    // æœ¬åœ°ç‰ˆæœ¬æ›´æ–°æˆ–ç›¸åŒï¼Œä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬
    return ConflictResolution.useLocal();
  }
}
```

#### 23.2.2 æ•°æ®åŒæ­¥çŠ¶æ€æœº

```dart
/// åŒæ­¥çŠ¶æ€æœº
class SyncStateMachine {
  SyncState _state = SyncState.idle;
  final StreamController<SyncState> _stateController = StreamController.broadcast();

  Stream<SyncState> get stateStream => _stateController.stream;
  SyncState get currentState => _state;

  /// çŠ¶æ€è½¬æ¢è§„åˆ™
  ///
  /// idle â”€â”€[startSync]â”€â”€> syncing
  /// syncing â”€â”€[complete]â”€â”€> idle
  /// syncing â”€â”€[conflict]â”€â”€> conflictResolution
  /// syncing â”€â”€[error]â”€â”€> error
  /// conflictResolution â”€â”€[resolved]â”€â”€> syncing
  /// conflictResolution â”€â”€[cancelled]â”€â”€> idle
  /// error â”€â”€[retry]â”€â”€> syncing
  /// error â”€â”€[giveUp]â”€â”€> idle

  void transition(SyncEvent event) {
    final newState = _getNextState(_state, event);
    if (newState != _state) {
      _state = newState;
      _stateController.add(_state);
    }
  }

  SyncState _getNextState(SyncState current, SyncEvent event) {
    switch (current) {
      case SyncState.idle:
        if (event == SyncEvent.startSync) return SyncState.syncing;
        break;
      case SyncState.syncing:
        if (event == SyncEvent.complete) return SyncState.idle;
        if (event == SyncEvent.conflict) return SyncState.conflictResolution;
        if (event == SyncEvent.error) return SyncState.error;
        break;
      case SyncState.conflictResolution:
        if (event == SyncEvent.resolved) return SyncState.syncing;
        if (event == SyncEvent.cancelled) return SyncState.idle;
        break;
      case SyncState.error:
        if (event == SyncEvent.retry) return SyncState.syncing;
        if (event == SyncEvent.giveUp) return SyncState.idle;
        break;
    }
    return current;
  }
}

enum SyncState { idle, syncing, conflictResolution, error }
enum SyncEvent { startSync, complete, conflict, error, resolved, cancelled, retry, giveUp }
```

### 23.3 ä¸šåŠ¡å¼‚å¸¸å¤„ç†

#### 23.3.1 é’±é¾„è®¡ç®—å¼‚å¸¸å¤„ç†

```dart
/// é’±é¾„è®¡ç®—å®¹é”™æœåŠ¡
class MoneyAgeCalculationService {
  /// è®¡ç®—é’±é¾„ï¼ˆå¸¦å®¹é”™ï¼‰
  Future<MoneyAgeResult> calculateMoneyAge({
    required List<Transaction> expenses,
    required List<Income> incomes,
  }) async {
    try {
      // 1. æ•°æ®é¢„å¤„ç†ä¸éªŒè¯
      final validatedExpenses = _validateExpenses(expenses);
      final validatedIncomes = _validateIncomes(incomes);

      // 2. å¼‚å¸¸æƒ…å†µå¤„ç†
      if (validatedIncomes.isEmpty) {
        // æ— æ”¶å…¥è®°å½• - è¿”å›ç‰¹æ®ŠçŠ¶æ€
        return MoneyAgeResult.noIncome(
          message: 'æš‚æ— æ”¶å…¥è®°å½•ï¼Œæ— æ³•è®¡ç®—é’±é¾„',
          suggestion: 'è¯·æ·»åŠ æ”¶å…¥è®°å½•ä»¥å¼€å§‹è¿½è¸ªé’±é¾„',
        );
      }

      if (validatedExpenses.isEmpty) {
        // æ— æ”¯å‡ºè®°å½• - é’±é¾„ä¸ºæ— ç©·å¤§ï¼ˆç†è®ºä¸Šï¼‰
        final oldestIncome = validatedIncomes
          .reduce((a, b) => a.date.isBefore(b.date) ? a : b);
        final daysSinceFirstIncome = DateTime.now().difference(oldestIncome.date).inDays;

        return MoneyAgeResult.noExpense(
          theoreticalAge: daysSinceFirstIncome,
          message: 'æ— æ”¯å‡ºè®°å½•ï¼Œæ‚¨çš„èµ„é‡‘éå¸¸å¥åº·ï¼',
        );
      }

      // 3. æ­£å¸¸è®¡ç®—
      final resourcePools = _buildResourcePools(validatedIncomes);
      final ageResult = _calculateWeightedAge(validatedExpenses, resourcePools);

      // 4. ç»“æœéªŒè¯
      if (ageResult.days < 0) {
        // è´Ÿæ•°é’±é¾„ - æ•°æ®å¼‚å¸¸
        _logger.warning('Negative money age detected', context: {
          'calculatedDays': ageResult.days,
          'expenseCount': validatedExpenses.length,
          'incomeCount': validatedIncomes.length,
        });
        return MoneyAgeResult.dataAnomaly(
          message: 'æ•°æ®å¯èƒ½å­˜åœ¨å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥äº¤æ˜“è®°å½•',
        );
      }

      if (ageResult.days > 3650) { // è¶…è¿‡10å¹´
        // å¼‚å¸¸é«˜çš„é’±é¾„ - å¯èƒ½æœ‰æœªè®°å½•çš„æ”¯å‡º
        return MoneyAgeResult.success(
          days: ageResult.days,
          warning: 'é’±é¾„è¶…è¿‡10å¹´ï¼Œå¯èƒ½æœ‰æœªè®°å½•çš„æ”¯å‡º',
        );
      }

      return MoneyAgeResult.success(days: ageResult.days);

    } catch (e, stackTrace) {
      _logger.error('Money age calculation failed', error: e, stackTrace: stackTrace);
      return MoneyAgeResult.error(
        message: 'é’±é¾„è®¡ç®—å¤±è´¥',
        error: e,
      );
    }
  }

  /// éªŒè¯æ”¯å‡ºæ•°æ®
  List<Transaction> _validateExpenses(List<Transaction> expenses) {
    return expenses.where((e) {
      // æ’é™¤æ— æ•ˆæ•°æ®
      if (e.amount <= 0) return false;
      if (e.amount.isNaN || e.amount.isInfinite) return false;
      if (e.date.isAfter(DateTime.now().add(Duration(days: 1)))) return false;
      return true;
    }).toList();
  }

  /// æ„å»ºèµ„æºæ± ï¼ˆå¤„ç†æ”¶å…¥æ—¶é—´é¡ºåºï¼‰
  List<ResourcePool> _buildResourcePools(List<Income> incomes) {
    // æŒ‰æ—¥æœŸæ’åº
    final sorted = List<Income>.from(incomes)
      ..sort((a, b) => a.date.compareTo(b.date));

    return sorted.map((income) => ResourcePool(
      incomeId: income.id,
      incomeDate: income.date,
      originalAmount: income.amount,
      remainingAmount: income.amount,
    )).toList();
  }
}
```

#### 23.3.2 é¢„ç®—åˆ†é…å¼‚å¸¸å¤„ç†

```dart
/// é›¶åŸºé¢„ç®—åˆ†é…æœåŠ¡ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
///
/// è¿™æ˜¯å®Œæ•´çš„åˆ†é…æœåŠ¡å®ç°ï¼Œæ”¯æŒå¤šç§åˆ†é…ç­–ç•¥å’Œå¥å£®çš„å¼‚å¸¸å¤„ç†ã€‚
/// ç®€åŒ–ç‰ˆæœ¬å‚è§5.2.2èŠ‚çš„ AllocationServiceã€‚
class BudgetAllocationService {
  /// åˆ†é…æ”¶å…¥åˆ°å°é‡‘åº“
  Future<AllocationResult> allocateIncome({
    required Income income,
    required List<BudgetVault> vaults,
    required AllocationStrategy strategy,
  }) async {
    final allocations = <VaultAllocation>[];
    var remainingAmount = income.amount;

    // 1. éªŒè¯è¾“å…¥
    if (income.amount <= 0) {
      return AllocationResult.invalid('æ”¶å…¥é‡‘é¢å¿…é¡»å¤§äº0');
    }

    if (vaults.isEmpty) {
      return AllocationResult.invalid('è¯·å…ˆåˆ›å»ºè‡³å°‘ä¸€ä¸ªå°é‡‘åº“');
    }

    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    final sortedVaults = _sortByPriority(vaults, strategy);

    // 3. åˆ†é…é€»è¾‘
    for (final vault in sortedVaults) {
      if (remainingAmount <= 0) break;

      double allocationAmount;

      switch (vault.allocationType) {
        case AllocationType.fixed:
          // å›ºå®šé‡‘é¢
          allocationAmount = min(vault.targetAllocation, remainingAmount);
          break;

        case AllocationType.percentage:
          // ç™¾åˆ†æ¯”
          allocationAmount = income.amount * vault.targetPercentage;
          allocationAmount = min(allocationAmount, remainingAmount);
          break;

        case AllocationType.remainder:
          // å‰©ä½™é‡‘é¢
          allocationAmount = remainingAmount;
          break;

        case AllocationType.topUp:
          // è¡¥è¶³åˆ°ç›®æ ‡
          final needed = vault.targetAmount - vault.currentAmount;
          allocationAmount = min(max(needed, 0), remainingAmount);
          break;
      }

      // 4. å¤„ç†åˆ†é…ç»“æœ
      if (allocationAmount > 0) {
        allocations.add(VaultAllocation(
          vaultId: vault.id,
          vaultName: vault.name,
          amount: allocationAmount,
          type: vault.allocationType,
        ));
        remainingAmount -= allocationAmount;
      }
    }

    // 5. å¤„ç†å‰©ä½™é‡‘é¢
    if (remainingAmount > 0.01) { // å…è®¸1åˆ†é’±çš„ç²¾åº¦è¯¯å·®
      // æœ‰æœªåˆ†é…é‡‘é¢
      return AllocationResult.partial(
        allocations: allocations,
        unallocated: remainingAmount,
        suggestion: 'æœ‰ Â¥${remainingAmount.toStringAsFixed(2)} æœªåˆ†é…ï¼Œ'
                   'å»ºè®®åˆ›å»º"æœºåŠ¨èµ„é‡‘"å°é‡‘åº“',
      );
    }

    // 6. ç™¾åˆ†æ¯”æ€»å’ŒéªŒè¯
    final totalPercentage = vaults
      .where((v) => v.allocationType == AllocationType.percentage)
      .fold(0.0, (sum, v) => sum + v.targetPercentage);

    if (totalPercentage > 1.0) {
      return AllocationResult.warning(
        allocations: allocations,
        warning: 'ç™¾åˆ†æ¯”æ€»å’Œè¶…è¿‡100%ï¼Œå®é™…æŒ‰æ¯”ä¾‹è°ƒæ•´',
      );
    }

    return AllocationResult.success(allocations: allocations);
  }
}
```

### 23.4 å¹‚ç­‰æ€§è®¾è®¡

#### 23.4.1 å¹‚ç­‰æ“ä½œå®ç°

```dart
/// å¹‚ç­‰æ€§æ“ä½œæœåŠ¡
class IdempotentOperationService {
  final DatabaseService _db;
  final CacheService _cache;

  /// å¹‚ç­‰é”®è¡¨ç»“æ„
  /// CREATE TABLE idempotency_keys (
  ///   key TEXT PRIMARY KEY,
  ///   operation_type TEXT NOT NULL,
  ///   result TEXT,
  ///   created_at TEXT NOT NULL,
  ///   expires_at TEXT NOT NULL
  /// );

  /// æ‰§è¡Œå¹‚ç­‰æ“ä½œ
  Future<T> executeIdempotent<T>({
    required String idempotencyKey,
    required String operationType,
    required Future<T> Function() operation,
    required T Function(String) deserializeResult,
    required String Function(T) serializeResult,
    Duration validity = const Duration(hours: 24),
  }) async {
    // 1. æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ
    final existing = await _getExistingResult(idempotencyKey);
    if (existing != null) {
      // å·²æ‰§è¡Œï¼Œè¿”å›ç¼“å­˜ç»“æœ
      return deserializeResult(existing);
    }

    // 2. è·å–é”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
    final lock = await _acquireLock(idempotencyKey);
    if (!lock) {
      // ç­‰å¾…å…¶ä»–è¯·æ±‚å®Œæˆ
      await _waitForResult(idempotencyKey);
      final result = await _getExistingResult(idempotencyKey);
      if (result != null) {
        return deserializeResult(result);
      }
      throw AppException(
        code: 'IDEMPOTENT_LOCK_FAILED',
        message: 'Failed to acquire idempotency lock',
        category: ExceptionCategory.system,
        severity: ExceptionSeverity.critical,
      );
    }

    try {
      // 3. æ‰§è¡Œæ“ä½œ
      final result = await operation();

      // 4. ä¿å­˜ç»“æœ
      await _saveResult(
        idempotencyKey,
        operationType,
        serializeResult(result),
        validity,
      );

      return result;
    } finally {
      // 5. é‡Šæ”¾é”
      await _releaseLock(idempotencyKey);
    }
  }

  /// ç”Ÿæˆå¹‚ç­‰é”®
  String generateKey({
    required String userId,
    required String operation,
    required Map<String, dynamic> params,
  }) {
    final sortedParams = SplayTreeMap<String, dynamic>.from(params);
    final paramsStr = jsonEncode(sortedParams);
    final bytes = utf8.encode('$userId:$operation:$paramsStr');
    return sha256.convert(bytes).toString();
  }
}

/// äº¤æ˜“åˆ›å»ºå¹‚ç­‰åŒ…è£…
class TransactionService {
  final IdempotentOperationService _idempotent;

  Future<Transaction> createTransaction({
    required String userId,
    required CreateTransactionRequest request,
    required String idempotencyKey,
  }) async {
    return await _idempotent.executeIdempotent<Transaction>(
      idempotencyKey: idempotencyKey,
      operationType: 'CREATE_TRANSACTION',
      operation: () => _doCreateTransaction(userId, request),
      serializeResult: (tx) => jsonEncode(tx.toJson()),
      deserializeResult: (json) => Transaction.fromJson(jsonDecode(json)),
    );
  }
}
```

### 23.5 é™çº§ä¸ç†”æ–­ç­–ç•¥

#### 23.5.1 æœåŠ¡é™çº§

```dart
/// æœåŠ¡é™çº§ç®¡ç†å™¨
class DegradationManager {
  final Map<String, ServiceHealth> _serviceHealth = {};

  /// AIæœåŠ¡é™çº§ç­–ç•¥
  Future<RecognitionResult> recognizeWithDegradation({
    required String input,
    required RecognitionType type,
  }) async {
    // 1. å°è¯•ä¸»æœåŠ¡ï¼ˆé€šä¹‰åƒé—®ï¼‰
    if (_isServiceHealthy('qwen')) {
      try {
        return await _qwenService.recognize(input, type);
      } catch (e) {
        _recordFailure('qwen');
        // ç»§ç»­å°è¯•å¤‡ç”¨æœåŠ¡
      }
    }

    // 2. å°è¯•å¤‡ç”¨æœåŠ¡ï¼ˆæ™ºè°±AIï¼‰
    if (_isServiceHealthy('zhipu')) {
      try {
        return await _zhipuService.recognize(input, type);
      } catch (e) {
        _recordFailure('zhipu');
        // ç»§ç»­é™çº§
      }
    }

    // 3. æœ¬åœ°è§„åˆ™å¼•æ“ï¼ˆç¦»çº¿å¯ç”¨ï¼‰
    try {
      return await _localRuleEngine.recognize(input, type);
    } catch (e) {
      // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥
    }

    // 4. æœ€ç»ˆé™çº§ï¼šè¿”å›æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
    return RecognitionResult.manualInput(
      suggestion: 'æ™ºèƒ½è¯†åˆ«æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥',
      partialResult: _extractBasicInfo(input),
    );
  }

  /// åŒæ­¥æœåŠ¡é™çº§
  Future<void> syncWithDegradation() async {
    if (!_isServiceHealthy('sync')) {
      // åŒæ­¥æœåŠ¡ä¸å¥åº·ï¼Œå»¶è¿ŸåŒæ­¥
      await _scheduleDelayedSync();
      return;
    }

    try {
      await _fullSync();
    } catch (e) {
      _recordFailure('sync');

      // é™çº§åˆ°å¢é‡åŒæ­¥
      try {
        await _incrementalSync();
      } catch (e) {
        // å¢é‡åŒæ­¥ä¹Ÿå¤±è´¥ï¼Œä»…åŒæ­¥å…³é”®æ•°æ®
        await _criticalDataSync();
      }
    }
  }
}

/// ç†”æ–­å™¨å®ç°
class CircuitBreaker {
  final String serviceName;
  final int failureThreshold;
  final Duration resetTimeout;

  CircuitState _state = CircuitState.closed;
  int _failureCount = 0;
  DateTime? _lastFailure;
  DateTime? _openedAt;

  CircuitBreaker({
    required this.serviceName,
    this.failureThreshold = 5,
    this.resetTimeout = const Duration(minutes: 1),
  });

  /// æ‰§è¡Œå¸¦ç†”æ–­ä¿æŠ¤çš„æ“ä½œ
  Future<T> execute<T>(Future<T> Function() operation) async {
    // æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
    if (_state == CircuitState.open) {
      if (_shouldAttemptReset()) {
        _state = CircuitState.halfOpen;
      } else {
        throw CircuitBreakerOpenException(serviceName);
      }
    }

    try {
      final result = await operation();
      _onSuccess();
      return result;
    } catch (e) {
      _onFailure();
      rethrow;
    }
  }

  void _onSuccess() {
    _failureCount = 0;
    _state = CircuitState.closed;
  }

  void _onFailure() {
    _failureCount++;
    _lastFailure = DateTime.now();

    if (_failureCount >= failureThreshold) {
      _state = CircuitState.open;
      _openedAt = DateTime.now();
    }
  }

  bool _shouldAttemptReset() {
    if (_openedAt == null) return true;
    return DateTime.now().difference(_openedAt!) >= resetTimeout;
  }
}

enum CircuitState { closed, open, halfOpen }
```

### 23.6 ç”¨æˆ·ä½“éªŒä¿éšœ

#### 23.6.1 å¼‚å¸¸UIåé¦ˆ

```dart
/// å¼‚å¸¸UIå¤„ç†å™¨
class ExceptionUIHandler {
  /// æ˜¾ç¤ºå¼‚å¸¸åé¦ˆ
  void showExceptionFeedback(
    BuildContext context,
    AppException exception,
  ) {
    switch (exception.severity) {
      case ExceptionSeverity.ignorable:
        // ä¸æ˜¾ç¤º
        break;

      case ExceptionSeverity.recoverable:
        // çŸ­æš‚æç¤ºï¼Œè‡ªåŠ¨æ¶ˆå¤±
        _showAutoRetrySnackBar(context, exception);
        break;

      case ExceptionSeverity.warning:
        // ç”¨æˆ·å¯æ“ä½œçš„æç¤º
        _showActionableSnackBar(context, exception);
        break;

      case ExceptionSeverity.critical:
        // é˜»æ–­å¼å¯¹è¯æ¡†
        _showBlockingDialog(context, exception);
        break;

      case ExceptionSeverity.fatal:
        // å…¨å±é”™è¯¯é¡µ
        _navigateToErrorPage(context, exception);
        break;
    }
  }

  /// è‡ªåŠ¨é‡è¯•æç¤º
  void _showAutoRetrySnackBar(BuildContext context, AppException exception) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            SizedBox(
              width: 16,
              height: 16,
              child: CircularProgressIndicator(strokeWidth: 2),
            ),
            SizedBox(width: 12),
            Expanded(child: Text(exception.userMessage ?? 'æ­£åœ¨é‡è¯•...')),
          ],
        ),
        duration: Duration(seconds: 3),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// å¯æ“ä½œæç¤º
  void _showActionableSnackBar(BuildContext context, AppException exception) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(exception.userMessage ?? exception.message),
        action: SnackBarAction(
          label: 'é‡è¯•',
          onPressed: () => _retryLastOperation(),
        ),
        duration: Duration(seconds: 5),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// é˜»æ–­å¼å¯¹è¯æ¡†
  void _showBlockingDialog(BuildContext context, AppException exception) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        icon: Icon(Icons.error_outline, color: Colors.red, size: 48),
        title: Text('æ“ä½œå¤±è´¥'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(exception.userMessage ?? exception.message),
            if (exception.code != null) ...[
              SizedBox(height: 8),
              Text(
                'é”™è¯¯ä»£ç : ${exception.code}',
                style: TextStyle(fontSize: 12, color: Colors.grey),
              ),
            ],
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('å–æ¶ˆ'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              _retryLastOperation();
            },
            child: Text('é‡è¯•'),
          ),
        ],
      ),
    );
  }
}
```

---


---

### 23.7 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 23.7.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

å¼‚å¸¸å¤„ç†ä¸å®¹é”™ç³»ç»Ÿä½œä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œä¸ºæ‰€æœ‰2.0æ¨¡å—æä¾›ç»Ÿä¸€çš„å®¹é”™èƒ½åŠ›ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¼‚å¸¸å¤„ç†ä¸å®¹é”™é›†æˆå…¨æ™¯å›¾                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        å¼‚å¸¸å¤„ç†æ ¸å¿ƒæœåŠ¡                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ å¼‚å¸¸åˆ†ç±»  â”‚  â”‚ é‡è¯•ç­–ç•¥  â”‚  â”‚ é™çº§ç†”æ–­  â”‚  â”‚ UIåé¦ˆ   â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡    â”‚     â”‚  æ™ºèƒ½å¢å¼º    â”‚     â”‚  2.0æ–°å¢    â”‚                 â”‚
â”‚  â”‚  å®¹é”™ä¿æŠ¤    â”‚     â”‚  å®¹é”™ä¿æŠ¤    â”‚     â”‚  å®¹é”™ä¿æŠ¤    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ é’±é¾„è®¡ç®—   â”‚     â”‚ â€¢ AIè¯†åˆ«    â”‚     â”‚ â€¢ è¯­éŸ³è¯†åˆ«   â”‚                 â”‚
â”‚  â”‚ â€¢ é¢„ç®—åˆ†é…   â”‚     â”‚ â€¢ æ™ºèƒ½åˆ†ç±»   â”‚     â”‚ â€¢ ä½ç½®æœåŠ¡   â”‚                 â”‚
â”‚  â”‚ â€¢ äº¤æ˜“åŒæ­¥   â”‚     â”‚ â€¢ æ•°æ®åˆ†æ   â”‚     â”‚ â€¢ å®¶åº­åŒæ­¥   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 23.7.2 è¯­éŸ³è¯†åˆ«å®¹é”™é›†æˆ

è¯­éŸ³è¯†åˆ«å¤±è´¥æ—¶çš„å®¹é”™å¤„ç†ï¼š

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·ä½“éªŒ |
|----------|----------|----------|
| ç½‘ç»œè¶…æ—¶ | è‡ªåŠ¨é‡è¯•3æ¬¡ | æ˜¾ç¤ºé‡è¯•è¿›åº¦ |
| è¯†åˆ«å¤±è´¥ | åˆ‡æ¢åˆ°æœ¬åœ°ASR | æç¤ºç²¾åº¦å¯èƒ½é™ä½ |
| æœåŠ¡ä¸å¯ç”¨ | é™çº§åˆ°æ‰‹åŠ¨è¾“å…¥ | å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨è®°è´¦ |
| éƒ¨åˆ†è¯†åˆ« | å±•ç¤ºè¯†åˆ«ç»“æœä¾›ä¿®æ”¹ | é¢„å¡«å……å·²è¯†åˆ«å†…å®¹ |

#### 23.7.3 AIè¯†åˆ«å®¹é”™é›†æˆ

AIæœåŠ¡å¼‚å¸¸æ—¶çš„å®¹é”™å¤„ç†ï¼š

| æœåŠ¡ | é™çº§æ–¹æ¡ˆ | æ¢å¤æ£€æµ‹ |
|------|----------|----------|
| ç¥¨æ®OCR | ä½¿ç”¨æœ¬åœ°OCRæ¨¡å‹ | æ¯5åˆ†é’Ÿæ£€æµ‹ä¸»æœåŠ¡ |
| æ™ºèƒ½åˆ†ç±» | ä½¿ç”¨è§„åˆ™å¼•æ“åˆ†ç±» | æˆåŠŸåè‡ªåŠ¨æ¢å¤ |
| æ¶ˆè´¹æ´å¯Ÿ | ä½¿ç”¨ç¼“å­˜çš„æ´å¯Ÿ | åå°é™é»˜é‡è¯• |
| é¢„ç®—å»ºè®® | ä½¿ç”¨å†å²å»ºè®®æ¨¡æ¿ | ç”¨æˆ·å¯æ‰‹åŠ¨åˆ·æ–° |

#### 23.7.4 ä½ç½®æœåŠ¡å®¹é”™é›†æˆ

ä½ç½®æœåŠ¡å¼‚å¸¸æ—¶çš„å®¹é”™å¤„ç†ï¼š

| å¼‚å¸¸æƒ…å†µ | å®¹é”™ç­–ç•¥ | æ•°æ®å¤„ç† |
|----------|----------|----------|
| GPSä¸å¯ç”¨ | ä½¿ç”¨ç½‘ç»œå®šä½ | é™ä½ä½ç½®ç²¾åº¦ |
| å®šä½è¶…æ—¶ | ä½¿ç”¨æœ€åå·²çŸ¥ä½ç½® | æ ‡è®°ä¸ºæ¨æµ‹ä½ç½® |
| æƒé™è¢«æ‹’ | è·³è¿‡ä½ç½®åŠŸèƒ½ | äº¤æ˜“ä¸å…³è”ä½ç½® |
| POIåŒ¹é…å¤±è´¥ | ä½¿ç”¨é€šç”¨åœºæ™¯ | ä¸å½±å“è®°è´¦æµç¨‹ |

#### 23.7.5 å®¶åº­åŒæ­¥å®¹é”™é›†æˆ

å®¶åº­è´¦æœ¬åŒæ­¥å¼‚å¸¸æ—¶çš„å®¹é”™å¤„ç†ï¼š

| å¼‚å¸¸ç±»å‹ | å®¹é”™ç­–ç•¥ | å†²çªè§£å†³ |
|----------|----------|----------|
| åŒæ­¥å¤±è´¥ | æœ¬åœ°é˜Ÿåˆ—æš‚å­˜ | è‡ªåŠ¨é‡è¯• |
| æ•°æ®å†²çª | ç‰ˆæœ¬å‘é‡æ£€æµ‹ | ç”¨æˆ·é€‰æ‹©ä¿ç•™ç‰ˆæœ¬ |
| æˆå‘˜ç¦»çº¿ | æ ‡è®°å¾…åŒæ­¥ | ä¸Šçº¿åè‡ªåŠ¨æ¨é€ |
| æƒé™å˜æ›´ | ç¼“å­˜åˆ·æ–° | æç¤ºæƒé™ä¸è¶³ |

#### 23.7.6 æ•°æ®åŒæ­¥å®¹é”™é›†æˆ

è·¨è®¾å¤‡æ•°æ®åŒæ­¥çš„å®¹é”™è®¾è®¡ï¼š

| åŒæ­¥é˜¶æ®µ | å¼‚å¸¸å¤„ç† | æ•°æ®ä¿æŠ¤ |
|----------|----------|----------|
| ä¸Šä¼ å¤±è´¥ | æŒ‡æ•°é€€é¿é‡è¯• | æœ¬åœ°æŒä¹…åŒ–é˜Ÿåˆ— |
| ä¸‹è½½å¤±è´¥ | ä½¿ç”¨æœ¬åœ°ç¼“å­˜ | æ ‡è®°æ•°æ®ç‰ˆæœ¬ |
| éƒ¨åˆ†æˆåŠŸ | æ–­ç‚¹ç»­ä¼  | äº‹åŠ¡å›æ»šä¿æŠ¤ |
| ç‰ˆæœ¬å†²çª | CRDTåˆå¹¶ | ä¿ç•™æ‰€æœ‰å˜æ›´å†å² |

---

## 24. å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„

æœ¬ç« èŠ‚åŸºäº**å¯æ‰©å±•æ€§åŸåˆ™**å’Œ**æ¼”è¿›å¼æ¶æ„åŸåˆ™**ï¼Œè®¾è®¡ç³»ç»Ÿçš„æ‰©å±•èƒ½åŠ›å’Œæœªæ¥æ¼”è¿›è·¯å¾„ï¼Œç¡®ä¿2.0ç‰ˆæœ¬çš„å„é¡¹åŠŸèƒ½æ¨¡å—èƒ½å¤Ÿç‹¬ç«‹æ‰©å±•å’Œå¹³æ»‘æ¼”è¿›ã€‚

### 24.0 è®¾è®¡åŸåˆ™å›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„è®¾è®¡åŸåˆ™                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¯æ‰©å±•æ€§åŸåˆ™                                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ åŠŸèƒ½æ‰©å±•ï¼šæ–°å¢æ¨¡å—å¯ç›´æ¥æ¥å…¥ï¼Œä¸å½±å“ç°æœ‰æ¨¡å—                          â”‚ â”‚
â”‚  â”‚  â€¢ è§„æ¨¡æ‰©å±•ï¼šç”¨æˆ·é‡å¢é•¿æ—¶ï¼Œå¯é€šè¿‡å¢åŠ èŠ‚ç‚¹æ¨ªå‘æ‰©å±•                        â”‚ â”‚
â”‚  â”‚  â€¢ æ¨¡å—åŒ–è®¾è®¡ï¼šå„åŠŸèƒ½æ¨¡å—ç‹¬ç«‹ï¼Œé€šè¿‡æ ‡å‡†æ¥å£é€šä¿¡                          â”‚ â”‚
â”‚  â”‚  â€¢ æ°´å¹³æ‰©å®¹ä¼˜å…ˆï¼šä¼˜å…ˆæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œè€Œéå‚ç›´æ‰©å®¹                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ¼”è¿›å¼æ¶æ„åŸåˆ™                                                         â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  â€¢ æ¸è¿›å‡çº§ï¼šæ¶æ„éšä¸šåŠ¡å‘å±•é€æ­¥è¿­ä»£ï¼Œé¿å…ä¸€æ­¥åˆ°ä½                        â”‚ â”‚
â”‚  â”‚  â€¢ å¹³æ»‘è¿ç§»ï¼šç‰ˆæœ¬å‡çº§å¯¹ç”¨æˆ·é€æ˜ï¼Œæ•°æ®æ— æŸè¿ç§»                           â”‚ â”‚
â”‚  â”‚  â€¢ å‘åå…¼å®¹ï¼šæ–°ç‰ˆæœ¬å…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®å’ŒAPI                                  â”‚ â”‚
â”‚  â”‚  â€¢ åŠŸèƒ½å¼€å…³ï¼šæ–°åŠŸèƒ½é€šè¿‡ç°åº¦å‘å¸ƒï¼Œé™ä½é£é™©                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  2.0ç‰ˆæœ¬æ‰©å±•è§„åˆ’                                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  æ ¸å¿ƒæ¨¡å—ï¼šé’±é¾„ç³»ç»Ÿã€é›¶åŸºé¢„ç®—ã€å°é‡‘åº“ã€é‡‘èä¹ æƒ¯åŸ¹å…»                       â”‚ â”‚
â”‚  â”‚  æ™ºèƒ½æ¨¡å—ï¼šAIè¯†åˆ«ã€åœ°ç†ä½ç½®æ™ºèƒ½ã€æ™ºèƒ½åˆ†ç±»                                â”‚ â”‚
â”‚  â”‚  ä½“éªŒæ¨¡å—ï¼šä¼™ä¼´åŒ–è®¾è®¡ã€æ— éšœç¢ã€å›½é™…åŒ–                                    â”‚ â”‚
â”‚  â”‚  ä¿éšœæ¨¡å—ï¼šç¦»çº¿åŒæ­¥ã€æ•°æ®è¿ç§»ã€å¯è§‚æµ‹æ€§                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 24.1 å¯æ‰©å±•æ€§æ¶æ„æ€»è§ˆ

#### 24.1.1 ç« èŠ‚å®šä½ä¸è®¾è®¡ç›®æ ‡

æœ¬ç« èŠ‚å®šä¹‰ç³»ç»Ÿçš„å¯æ‰©å±•æ€§æ¶æ„å’Œæ¼”è¿›ç­–ç•¥ï¼Œç¡®ä¿2.0ç‰ˆæœ¬çš„å„é¡¹åˆ›æ–°åŠŸèƒ½ï¼ˆé’±é¾„ç³»ç»Ÿã€é›¶åŸºé¢„ç®—ã€å°é‡‘åº“ã€é‡‘èä¹ æƒ¯åŸ¹å…»ï¼‰èƒ½å¤Ÿç‹¬ç«‹æ‰©å±•ã€å¹³æ»‘å‡çº§ï¼ŒåŒæ—¶ä¸ºæœªæ¥ç‰ˆæœ¬ï¼ˆ2.1åä½œè®°è´¦ã€2.2æ™ºèƒ½æŠ•èµ„ï¼‰é¢„ç•™æ‰©å±•æ¥å£ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬24ç«  å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„ - è®¾è®¡å®šä½                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ã€ç« èŠ‚è®¾è®¡ç›®æ ‡ã€‘                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        å¯æ‰©å±•æ€§äº”å¤§æ”¯æŸ±                                   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚   â”‚  æ¨¡å—åŒ–    â”‚ â”‚  æ’ä»¶åŒ–    â”‚ â”‚  ç­–ç•¥åŒ–    â”‚ â”‚  ç‰ˆæœ¬åŒ–    â”‚          â”‚   â”‚
â”‚  â”‚   â”‚ Modular    â”‚ â”‚  Plugin    â”‚ â”‚ Strategy   â”‚ â”‚ Versioned  â”‚          â”‚   â”‚
â”‚  â”‚   â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚          â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ åŠŸèƒ½éš”ç¦» â”‚ â”‚ â€¢ çƒ­æ’æ‹”   â”‚ â”‚ â€¢ è¡Œä¸ºæ›¿æ¢ â”‚ â”‚ â€¢ APIç‰ˆæœ¬  â”‚          â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ ä¾èµ–ç®¡ç† â”‚ â”‚ â€¢ æŒ‰éœ€åŠ è½½ â”‚ â”‚ â€¢ ç®—æ³•æ‰©å±• â”‚ â”‚ â€¢ æ•°æ®è¿ç§» â”‚          â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ ç‹¬ç«‹éƒ¨ç½² â”‚ â”‚ â€¢ æ‰©å±•ç‚¹   â”‚ â”‚ â€¢ è§„åˆ™å¼•æ“ â”‚ â”‚ â€¢ å‘åå…¼å®¹ â”‚          â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚  â”‚                        â”‚  æ¼”è¿›åŒ–    â”‚                                   â”‚   â”‚
â”‚  â”‚                        â”‚ Evolution  â”‚                                   â”‚   â”‚
â”‚  â”‚                        â”‚            â”‚                                   â”‚   â”‚
â”‚  â”‚                        â”‚ â€¢ ç°åº¦å‘å¸ƒ â”‚                                   â”‚   â”‚
â”‚  â”‚                        â”‚ â€¢ åŠŸèƒ½å¼€å…³ â”‚                                   â”‚   â”‚
â”‚  â”‚                        â”‚ â€¢ A/Bæµ‹è¯•  â”‚                                   â”‚   â”‚
â”‚  â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  ã€2.0ç‰ˆæœ¬å¯æ‰©å±•æ€§é‡ç‚¹ã€‘                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  é’±é¾„ç³»ç»Ÿ   â”‚    â”‚  é›¶åŸºé¢„ç®—   â”‚    â”‚  ç¦»çº¿ä¼˜å…ˆ   â”‚    â”‚  AIè¯†åˆ«     â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ è®¡ç®—ç­–ç•¥   â”‚    â”‚ åˆ†é…ç­–ç•¥   â”‚    â”‚ åŒæ­¥ç­–ç•¥   â”‚    â”‚ è¯†åˆ«å¼•æ“   â”‚     â”‚
â”‚  â”‚ å¯æ›¿æ¢     â”‚    â”‚ å¯æ›¿æ¢     â”‚    â”‚ å¯é…ç½®     â”‚    â”‚ å¯æ‰©å±•     â”‚     â”‚
â”‚  â”‚            â”‚    â”‚            â”‚    â”‚            â”‚    â”‚            â”‚     â”‚
â”‚  â”‚ â€¢ FIFO     â”‚    â”‚ â€¢ ä¿¡å°æ³•   â”‚    â”‚ â€¢ å†²çªè§£å†³ â”‚    â”‚ â€¢ è¯­éŸ³     â”‚     â”‚
â”‚  â”‚ â€¢ åŠ æƒå¹³å‡ â”‚    â”‚ â€¢ 50/30/20 â”‚    â”‚ â€¢ å¢é‡åŒæ­¥ â”‚    â”‚ â€¢ å›¾ç‰‡     â”‚     â”‚
â”‚  â”‚ â€¢ è‡ªå®šä¹‰   â”‚    â”‚ â€¢ è‡ªå®šä¹‰   â”‚    â”‚ â€¢ å…¨é‡åŒæ­¥ â”‚    â”‚ â€¢ NLU      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â”‚  ã€ä¸å…¶ä»–ç« èŠ‚å…³ç³»ã€‘                                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                 â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚  ç¬¬7ç«       â”‚        â”‚  ç¬¬8ç«       â”‚        â”‚  ç¬¬9ç«       â”‚          â”‚
â”‚        â”‚  é’±é¾„ç³»ç»Ÿ   â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  é›¶åŸºé¢„ç®—   â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  å°é‡‘åº“     â”‚          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚               â”‚                      â”‚                      â”‚                  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                      â”‚                                         â”‚
â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                             â”‚    ç¬¬24ç«        â”‚                                â”‚
â”‚                             â”‚ å¯æ‰©å±•æ€§ä¸æ¼”è¿›  â”‚                                â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                      â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚                             â”‚                             â”‚          â”‚
â”‚        â–¼                             â–¼                             â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ¨¡å—æ³¨å†Œ  â”‚               â”‚ ç‰ˆæœ¬è¿ç§»  â”‚               â”‚ ç°åº¦å‘å¸ƒ  â”‚        â”‚
â”‚  â”‚ ä¾èµ–ç®¡ç†  â”‚               â”‚ APIæ¼”è¿›   â”‚               â”‚ åŠŸèƒ½å¼€å…³  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.1.2 å¯æ‰©å±•æ€§æ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯æ‰©å±•æ€§æ¶æ„å…¨æ™¯å›¾                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          åº”ç”¨å±‚ (Presentation)                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚  é¡µé¢è·¯ç”±æ‰©å±•  â”‚  â”‚  ä¸»é¢˜ç³»ç»Ÿæ‰©å±•  â”‚  â”‚  ç»„ä»¶åº“æ‰©å±•   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ RouteExtensionâ”‚  â”‚ ThemeExtensionâ”‚  â”‚WidgetExtensionâ”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                  â”‚                  â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        ä¸šåŠ¡æ¨¡å—å±‚ (Business Modules)                      â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                     FeatureRegistry (æ¨¡å—æ³¨å†Œä¸­å¿ƒ)                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ é’±é¾„æ¨¡å— â”‚ â”‚ é¢„ç®—æ¨¡å— â”‚ â”‚ å°é‡‘åº“   â”‚ â”‚ ä¹ æƒ¯åŸ¹å…» â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ MoneyAge â”‚ â”‚ Budget   â”‚ â”‚ Vault    â”‚ â”‚ Habit    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Module   â”‚ â”‚ Module   â”‚ â”‚ Module   â”‚ â”‚ Module   â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚       â”‚            â”‚            â”‚            â”‚                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                            â”‚                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                    â”‚  ä¾èµ–æ³¨å…¥å®¹å™¨  â”‚                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                    â”‚   GetIt.I     â”‚                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                  StrategyManager (ç­–ç•¥ç®¡ç†å™¨)                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ è®°è´¦ç­–ç•¥     â”‚  â”‚ é’±é¾„è®¡ç®—ç­–ç•¥ â”‚  â”‚ é¢„ç®—åˆ†é…ç­–ç•¥ â”‚           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Bookkeeping  â”‚  â”‚ MoneyAge     â”‚  â”‚ Budget       â”‚           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Strategy     â”‚  â”‚ Strategy     â”‚  â”‚ Strategy     â”‚           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        åŸºç¡€æœåŠ¡å±‚ (Core Services)                         â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                    ExtensionPointRegistry (æ‰©å±•ç‚¹æ³¨å†Œ)             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ äº¤æ˜“é’©å­   â”‚  â”‚ é¢„ç®—é’©å­   â”‚  â”‚ AIæ‰©å±•     â”‚  â”‚ å¯¼å‡ºæ‰©å±•   â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚Transaction â”‚  â”‚ Budget     â”‚  â”‚ AI         â”‚  â”‚ Export     â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Hooks      â”‚  â”‚ Hooks      â”‚  â”‚ Extensions â”‚  â”‚ Extensions â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                    VersionManager (ç‰ˆæœ¬ç®¡ç†)                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ APIç‰ˆæœ¬    â”‚  â”‚ æ•°æ®è¿ç§»   â”‚  â”‚ åŠŸèƒ½å¼€å…³   â”‚  â”‚ ç°åº¦æ§åˆ¶   â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ APIVersion â”‚  â”‚ Migration  â”‚  â”‚ FeatureFlagâ”‚  â”‚ GrayScale  â”‚ â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ•°æ®å±‚ (Data Layer)                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                      ExtensibleEntity (å¯æ‰©å±•å®ä½“)                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ extensions: Map<String, dynamic>  // JSONæ‰©å±•å­—æ®µ              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ metadata: Map<String, dynamic>    // å…ƒæ•°æ®å­—æ®µ                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ version: int                      // å®ä½“ç‰ˆæœ¬å·                â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.1.3 å¯æ‰©å±•æ€§æœåŠ¡å…¥å£

```dart
/// å¯æ‰©å±•æ€§æ ¸å¿ƒæœåŠ¡
/// ç»Ÿä¸€ç®¡ç†æ¨¡å—æ³¨å†Œã€ç­–ç•¥ç®¡ç†ã€æ‰©å±•ç‚¹ã€ç‰ˆæœ¬æ§åˆ¶
class ExtensibilityService {
  static final ExtensibilityService _instance = ExtensibilityService._();
  factory ExtensibilityService() => _instance;
  ExtensibilityService._();

  late final FeatureRegistry _featureRegistry;
  late final StrategyManager _strategyManager;
  late final ExtensionPointRegistry _extensionRegistry;
  late final VersionManager _versionManager;
  late final FeatureFlagService _featureFlagService;

  /// åˆå§‹åŒ–å¯æ‰©å±•æ€§æœåŠ¡
  Future<void> initialize({
    required ExtensibilityConfig config,
  }) async {
    // åˆå§‹åŒ–åŠŸèƒ½å¼€å…³æœåŠ¡
    _featureFlagService = FeatureFlagService();
    await _featureFlagService.initialize(config.featureFlags);

    // åˆå§‹åŒ–ç‰ˆæœ¬ç®¡ç†å™¨
    _versionManager = VersionManager();
    await _versionManager.initialize(
      currentVersion: config.appVersion,
      apiVersion: config.apiVersion,
    );

    // åˆå§‹åŒ–æ‰©å±•ç‚¹æ³¨å†Œè¡¨
    _extensionRegistry = ExtensionPointRegistry();
    _registerCoreExtensionPoints();

    // åˆå§‹åŒ–ç­–ç•¥ç®¡ç†å™¨
    _strategyManager = StrategyManager();
    _registerCoreStrategies();

    // åˆå§‹åŒ–åŠŸèƒ½æ¨¡å—æ³¨å†Œè¡¨
    _featureRegistry = FeatureRegistry();
    await _registerCoreModules();
  }

  /// æ³¨å†Œæ ¸å¿ƒæ‰©å±•ç‚¹
  void _registerCoreExtensionPoints() {
    _extensionRegistry
      ..registerPoint(TransactionExtensionPoint())
      ..registerPoint(BudgetExtensionPoint())
      ..registerPoint(AIExtensionPoint())
      ..registerPoint(ExportExtensionPoint())
      ..registerPoint(SyncExtensionPoint());
  }

  /// æ³¨å†Œæ ¸å¿ƒç­–ç•¥
  void _registerCoreStrategies() {
    // è®°è´¦ç­–ç•¥
    _strategyManager.registerBookkeepingStrategy(TraditionalBookkeepingStrategy());
    _strategyManager.registerBookkeepingStrategy(ZeroBasedBookkeepingStrategy());

    // é’±é¾„è®¡ç®—ç­–ç•¥
    _strategyManager.registerMoneyAgeStrategy(FIFOMoneyAgeStrategy());
    _strategyManager.registerMoneyAgeStrategy(WeightedAverageMoneyAgeStrategy());

    // é¢„ç®—åˆ†é…ç­–ç•¥
    _strategyManager.registerBudgetStrategy(EnvelopeBudgetStrategy());
    _strategyManager.registerBudgetStrategy(Rule503020Strategy());
  }

  /// æ³¨å†Œæ ¸å¿ƒæ¨¡å—
  Future<void> _registerCoreModules() async {
    // åŸºç¡€æ¨¡å—
    _featureRegistry.register(TransactionModule());
    _featureRegistry.register(AccountModule());
    _featureRegistry.register(CategoryModule());

    // 2.0æ ¸å¿ƒæ¨¡å—ï¼ˆæŒ‰åŠŸèƒ½å¼€å…³æ§åˆ¶ï¼‰
    if (_featureFlagService.isEnabled('money_age')) {
      _featureRegistry.register(MoneyAgeModule());
    }
    if (_featureFlagService.isEnabled('zero_based_budget')) {
      _featureRegistry.register(ZeroBasedBudgetModule());
    }
    if (_featureFlagService.isEnabled('budget_vault')) {
      _featureRegistry.register(BudgetVaultModule());
    }
    if (_featureFlagService.isEnabled('financial_habit')) {
      _featureRegistry.register(FinancialHabitModule());
    }

    // æ™ºèƒ½æ¨¡å—
    if (_featureFlagService.isEnabled('ai_recognition')) {
      _featureRegistry.register(AIRecognitionModule());
    }
    if (_featureFlagService.isEnabled('geo_location')) {
      _featureRegistry.register(GeoLocationModule());
    }

    await _featureRegistry.initializeAll();
  }

  /// è·å–åŠŸèƒ½æ¨¡å—
  T? getModule<T extends FeatureModule>(String id) => _featureRegistry.getModule<T>(id);

  /// è·å–ç­–ç•¥
  T getStrategy<T>(String strategyType, String strategyId) =>
    _strategyManager.getStrategy<T>(strategyType, strategyId);

  /// è·å–æ‰©å±•ç‚¹
  ExtensionPoint getExtensionPoint(String pointId) =>
    _extensionRegistry.getPoint(pointId);

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  bool isFeatureAvailable(String featureId) =>
    _featureFlagService.isEnabled(featureId) &&
    _versionManager.isFeatureSupported(featureId);
}

/// å¯æ‰©å±•æ€§é…ç½®
class ExtensibilityConfig {
  final String appVersion;
  final String apiVersion;
  final Map<String, bool> featureFlags;
  final List<String> enabledModules;
  final Map<String, String> defaultStrategies;

  const ExtensibilityConfig({
    required this.appVersion,
    required this.apiVersion,
    this.featureFlags = const {},
    this.enabledModules = const [],
    this.defaultStrategies = const {},
  });

  /// 2.0ç‰ˆæœ¬é»˜è®¤é…ç½®
  factory ExtensibilityConfig.v2Default() => ExtensibilityConfig(
    appVersion: '2.0.0',
    apiVersion: 'v2',
    featureFlags: {
      'money_age': true,
      'zero_based_budget': true,
      'budget_vault': true,
      'financial_habit': true,
      'ai_recognition': true,
      'geo_location': true,
      'offline_sync': true,
      'collaborative_budget': false, // 2.1ç‰ˆæœ¬
      'smart_investment': false,      // 2.2ç‰ˆæœ¬
    },
    defaultStrategies: {
      'bookkeeping': 'zero_based',
      'money_age': 'fifo',
      'budget': 'envelope',
    },
  );
}
```

### 24.2 æ¨¡å—åŒ–æ¶æ„è®¾è®¡

#### 24.2.1 åŠŸèƒ½æ¨¡å—å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         2.0 ç‰ˆæœ¬åŠŸèƒ½æ¨¡å—ä¾èµ–å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚          åº”ç”¨å…¥å£å±‚              â”‚                       â”‚
â”‚                    â”‚   (main.dart + è·¯ç”± + ä¸»é¢˜)      â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â”‚                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚          â”‚                         â”‚                         â”‚               â”‚
â”‚          â–¼                         â–¼                         â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   æ ¸å¿ƒä¸šåŠ¡å±‚   â”‚        â”‚   æ™ºèƒ½å¢å¼ºå±‚   â”‚        â”‚   ç”¨æˆ·ä½“éªŒå±‚   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                         â”‚                         â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ â€¢ é’±é¾„ç³»ç»Ÿ     â”‚        â”‚ â€¢ AIè¯†åˆ«ç³»ç»Ÿ  â”‚        â”‚ â€¢ ä¼™ä¼´åŒ–è®¾è®¡   â”‚        â”‚
â”‚  â”‚ â€¢ é›¶åŸºé¢„ç®—     â”‚        â”‚ â€¢ åœ°ç†ä½ç½®    â”‚        â”‚ â€¢ æ— éšœç¢è®¾è®¡   â”‚        â”‚
â”‚  â”‚ â€¢ å°é‡‘åº“ç®¡ç†   â”‚        â”‚ â€¢ æ™ºèƒ½åˆ†ç±»    â”‚        â”‚ â€¢ æ‡’äººè®¾è®¡     â”‚        â”‚
â”‚  â”‚ â€¢ é‡‘èä¹ æƒ¯åŸ¹å…» â”‚        â”‚ â€¢ æ¶ˆè´¹æ´å¯Ÿ    â”‚        â”‚ â€¢ æ•°æ®å¯è§†åŒ–   â”‚        â”‚
â”‚  â”‚ â€¢ é¢„ç®—ç®¡ç†     â”‚        â”‚ â€¢ è¡Œä¸ºé¢„æµ‹    â”‚        â”‚ â€¢ å›½é™…åŒ–      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                         â”‚                         â”‚               â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚          åŸºç¡€æœåŠ¡å±‚              â”‚                       â”‚
â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                       â”‚
â”‚                    â”‚  â”‚ â€¢ æ•°æ®æŒä¹…åŒ– (SQLite/API)   â”‚â”‚                       â”‚
â”‚                    â”‚  â”‚ â€¢ ç¦»çº¿åŒæ­¥æœåŠ¡              â”‚â”‚                       â”‚
â”‚                    â”‚  â”‚ â€¢ ç”¨æˆ·è®¤è¯æœåŠ¡              â”‚â”‚                       â”‚
â”‚                    â”‚  â”‚ â€¢ æ—¥å¿—ä¸ç›‘æ§                â”‚â”‚                       â”‚
â”‚                    â”‚  â”‚ â€¢ é…ç½®ç®¡ç†æœåŠ¡              â”‚â”‚                       â”‚
â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.2.2 æ’ä»¶åŒ–åŠŸèƒ½æ¨¡å—

```dart
/// åŠŸèƒ½æ¨¡å—æ³¨å†Œè¡¨
class FeatureRegistry {
  static final FeatureRegistry _instance = FeatureRegistry._();
  factory FeatureRegistry() => _instance;
  FeatureRegistry._();

  final Map<String, FeatureModule> _modules = {};
  final Map<String, List<String>> _dependencies = {};

  /// æ³¨å†ŒåŠŸèƒ½æ¨¡å—
  void register(FeatureModule module) {
    if (_modules.containsKey(module.id)) {
      throw FeatureRegistrationException('Module ${module.id} already registered');
    }

    // æ£€æŸ¥ä¾èµ–
    for (final dep in module.dependencies) {
      if (!_modules.containsKey(dep)) {
        throw FeatureRegistrationException(
          'Module ${module.id} depends on $dep which is not registered'
        );
      }
    }

    _modules[module.id] = module;
    _dependencies[module.id] = module.dependencies;
  }

  /// è·å–æ¨¡å—
  T? getModule<T extends FeatureModule>(String id) {
    return _modules[id] as T?;
  }

  /// åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
  Future<void> initializeAll() async {
    final sorted = _topologicalSort();
    for (final moduleId in sorted) {
      await _modules[moduleId]!.initialize();
    }
  }

  /// æ‹“æ‰‘æ’åºï¼ˆå¤„ç†ä¾èµ–é¡ºåºï¼‰
  List<String> _topologicalSort() {
    final result = <String>[];
    final visited = <String>{};
    final temp = <String>{};

    void visit(String id) {
      if (temp.contains(id)) {
        throw FeatureRegistrationException('Circular dependency detected: $id');
      }
      if (visited.contains(id)) return;

      temp.add(id);
      for (final dep in _dependencies[id] ?? []) {
        visit(dep);
      }
      temp.remove(id);
      visited.add(id);
      result.add(id);
    }

    for (final id in _modules.keys) {
      visit(id);
    }

    return result;
  }
}

/// åŠŸèƒ½æ¨¡å—åŸºç±»
abstract class FeatureModule {
  String get id;
  String get name;
  String get version;
  List<String> get dependencies => [];

  /// æ¨¡å—åˆå§‹åŒ–
  Future<void> initialize();

  /// æ¨¡å—é”€æ¯
  Future<void> dispose();

  /// æ¨¡å—å¥åº·æ£€æŸ¥
  Future<HealthStatus> healthCheck();
}

/// 2.0ç‰ˆæœ¬æ ¸å¿ƒæ¨¡å—æ³¨å†Œ
class AppModuleInitializer {
  static Future<void> initializeAll() async {
    final registry = FeatureRegistry();

    // åŸºç¡€æ¨¡å—
    registry.register(TransactionModule());
    registry.register(AccountModule());
    registry.register(CategoryModule());

    // 2.0æ ¸å¿ƒæ¨¡å—
    registry.register(MoneyAgeModule());
    registry.register(ZeroBasedBudgetModule());
    registry.register(BudgetVaultModule());
    registry.register(FinancialHabitModule());

    // æ™ºèƒ½å¢å¼ºæ¨¡å—
    registry.register(AIRecognitionModule());
    registry.register(GeoLocationModule());
    registry.register(ConsumptionInsightModule());

    // ä½“éªŒæ¨¡å—
    registry.register(CompanionDesignModule());
    registry.register(AccessibilityModule());
    registry.register(LocalizationModule());

    await registry.initializeAll();
  }
}

/// é’±é¾„æ¨¡å—ç¤ºä¾‹
class MoneyAgeModule extends FeatureModule {
  @override
  String get id => 'money_age';

  @override
  String get name => 'é’±é¾„åˆ†æ';

  @override
  String get version => '2.0.0';

  @override
  List<String> get dependencies => ['transaction', 'account'];

  late final MoneyAgeCalculator _calculator;
  late final MoneyAgeRepository _repository;

  @override
  Future<void> initialize() async {
    _repository = MoneyAgeRepository();
    _calculator = MoneyAgeCalculator(_repository);

    // æ³¨å†Œåˆ°æœåŠ¡å®šä½å™¨
    GetIt.I.registerSingleton<MoneyAgeCalculator>(_calculator);
    GetIt.I.registerSingleton<MoneyAgeRepository>(_repository);
  }

  @override
  Future<void> dispose() async {
    GetIt.I.unregister<MoneyAgeCalculator>();
    GetIt.I.unregister<MoneyAgeRepository>();
  }

  @override
  Future<HealthStatus> healthCheck() async {
    try {
      await _calculator.calculateMoneyAge([]);
      return HealthStatus.healthy;
    } catch (e) {
      return HealthStatus.unhealthy(e.toString());
    }
  }
}

/// é‡‘èä¹ æƒ¯åŸ¹å…»æ¨¡å—
class FinancialHabitModule extends FeatureModule {
  @override
  String get id => 'financial_habit';

  @override
  String get name => 'é‡‘èä¹ æƒ¯åŸ¹å…»';

  @override
  String get version => '2.0.0';

  @override
  List<String> get dependencies => ['transaction', 'budget', 'money_age'];

  @override
  Future<void> initialize() async {
    // æ¶ˆè´¹å®¡è§†ç³»ç»Ÿ
    GetIt.I.registerSingleton<SubscriptionTrackingService>(
      SubscriptionTrackingService()
    );
    GetIt.I.registerSingleton<LatteFactorAnalyzer>(
      LatteFactorAnalyzer()
    );
    GetIt.I.registerSingleton<ActionableInsightService>(
      ActionableInsightService()
    );

    // å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤
    GetIt.I.registerSingleton<ImpulseControlService>(
      ImpulseControlService()
    );
    GetIt.I.registerSingleton<SpendingPlanningService>(
      SpendingPlanningService()
    );

    // è´¢åŠ¡ç¼“å†²å»ºç«‹
    GetIt.I.registerSingleton<FinancialBufferService>(
      FinancialBufferService()
    );
    GetIt.I.registerSingleton<DebtHealthService>(
      DebtHealthService()
    );

    // å¼¹æ€§æ¿€åŠ±ç³»ç»Ÿ
    GetIt.I.registerSingleton<InclusiveMotivationService>(
      InclusiveMotivationService()
    );
    GetIt.I.registerSingleton<SocialComparisonService>(
      SocialComparisonService()
    );
    GetIt.I.registerSingleton<FinancialCommitmentService>(
      FinancialCommitmentService()
    );
  }

  @override
  Future<void> dispose() async {
    // æŒ‰æ³¨å†Œé¡ºåºé€†åºæ³¨é”€
    GetIt.I.unregister<FinancialCommitmentService>();
    GetIt.I.unregister<SocialComparisonService>();
    GetIt.I.unregister<InclusiveMotivationService>();
    GetIt.I.unregister<DebtHealthService>();
    GetIt.I.unregister<FinancialBufferService>();
    GetIt.I.unregister<SpendingPlanningService>();
    GetIt.I.unregister<ImpulseControlService>();
    GetIt.I.unregister<ActionableInsightService>();
    GetIt.I.unregister<LatteFactorAnalyzer>();
    GetIt.I.unregister<SubscriptionTrackingService>();
  }

  @override
  Future<HealthStatus> healthCheck() async {
    try {
      // æ£€æŸ¥æ ¸å¿ƒæœåŠ¡æ˜¯å¦å¯ç”¨
      GetIt.I.get<SubscriptionTrackingService>();
      GetIt.I.get<ImpulseControlService>();
      GetIt.I.get<FinancialBufferService>();
      return HealthStatus.healthy;
    } catch (e) {
      return HealthStatus.unhealthy(e.toString());
    }
  }
}
```

#### 24.2.3 ç­–ç•¥æ¨¡å¼æ‰©å±•ç‚¹

```dart
/// è®°è´¦ç­–ç•¥æ‰©å±•ç‚¹
abstract class BookkeepingStrategy {
  String get strategyId;
  String get strategyName;

  /// å¤„ç†äº¤æ˜“åˆ›å»º
  Future<Transaction> processTransaction(TransactionInput input);

  /// éªŒè¯äº¤æ˜“
  Future<ValidationResult> validateTransaction(Transaction transaction);

  /// è·å–æ¨èåˆ†ç±»
  Future<List<Category>> getRecommendedCategories(TransactionInput input);
}

/// ä¼ ç»Ÿè®°è´¦ç­–ç•¥
class TraditionalBookkeepingStrategy implements BookkeepingStrategy {
  @override
  String get strategyId => 'traditional';

  @override
  String get strategyName => 'ä¼ ç»Ÿè®°è´¦';

  @override
  Future<Transaction> processTransaction(TransactionInput input) async {
    // ä¼ ç»Ÿè®°è´¦ï¼šç›´æ¥åˆ›å»ºäº¤æ˜“
    return Transaction(
      id: uuid.v4(),
      amount: input.amount,
      type: input.type,
      categoryId: input.categoryId,
      accountId: input.accountId,
      date: input.date ?? DateTime.now(),
      description: input.description,
    );
  }

  @override
  Future<ValidationResult> validateTransaction(Transaction transaction) async {
    final errors = <String>[];

    if (transaction.amount <= 0) {
      errors.add('é‡‘é¢å¿…é¡»å¤§äº0');
    }
    if (transaction.categoryId == null) {
      errors.add('è¯·é€‰æ‹©åˆ†ç±»');
    }

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
    );
  }

  @override
  Future<List<Category>> getRecommendedCategories(TransactionInput input) async {
    // åŸºäºå†å²è®°å½•æ¨è
    return await _categoryService.getFrequentCategories(limit: 5);
  }
}

/// é›¶åŸºé¢„ç®—ç­–ç•¥
class ZeroBasedBookkeepingStrategy implements BookkeepingStrategy {
  @override
  String get strategyId => 'zero_based';

  @override
  String get strategyName => 'é›¶åŸºé¢„ç®—';

  @override
  Future<Transaction> processTransaction(TransactionInput input) async {
    // é›¶åŸºé¢„ç®—ï¼šåˆ›å»ºäº¤æ˜“ + å…³è”å°é‡‘åº“ + æ›´æ–°èµ„æºæ± 
    final transaction = await _createTransaction(input);

    // æŸ¥æ‰¾æˆ–åˆ›å»ºå°é‡‘åº“å…³è”
    if (input.type == TransactionType.expense) {
      final vault = await _findMatchingVault(transaction);
      if (vault != null) {
        await _linkToVault(transaction, vault);
        await _updateResourcePool(transaction);
      }
    } else if (input.type == TransactionType.income) {
      await _createResourcePool(transaction);
    }

    return transaction;
  }

  @override
  Future<ValidationResult> validateTransaction(Transaction transaction) async {
    final baseResult = await TraditionalBookkeepingStrategy()
      .validateTransaction(transaction);

    final errors = List<String>.from(baseResult.errors);
    final warnings = <String>[];

    // é›¶åŸºé¢„ç®—ç‰¹æœ‰éªŒè¯
    if (transaction.type == TransactionType.expense) {
      final vault = await _findMatchingVault(transaction);
      if (vault == null) {
        warnings.add('æ­¤æ”¯å‡ºæœªå…³è”å°é‡‘åº“ï¼Œå°†è®¡å…¥"æœªåˆ†é…"');
      } else if (transaction.amount > vault.remainingAmount) {
        warnings.add('æ­¤æ”¯å‡ºå°†è¶…å‡ºå°é‡‘åº“é¢„ç®—');
      }
    }

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
      warnings: warnings,
    );
  }

  @override
  Future<List<Category>> getRecommendedCategories(TransactionInput input) async {
    // åŸºäºå°é‡‘åº“æ¨è
    final vaultsWithBudget = await _getVaultsWithRemainingBudget();
    return vaultsWithBudget
      .where((v) => v.linkedCategory != null)
      .map((v) => v.linkedCategory!)
      .toList();
  }
}

/// ç­–ç•¥ç®¡ç†å™¨
class BookkeepingStrategyManager {
  final Map<String, BookkeepingStrategy> _strategies = {};
  String _currentStrategyId = 'traditional';

  void registerStrategy(BookkeepingStrategy strategy) {
    _strategies[strategy.strategyId] = strategy;
  }

  void setCurrentStrategy(String strategyId) {
    if (!_strategies.containsKey(strategyId)) {
      throw StrategyNotFoundException(strategyId);
    }
    _currentStrategyId = strategyId;
  }

  BookkeepingStrategy get currentStrategy => _strategies[_currentStrategyId]!;

  List<BookkeepingStrategy> get availableStrategies => _strategies.values.toList();
}
```

### 24.3 æ•°æ®æ¨¡å‹æ‰©å±•

#### 24.3.1 å¯æ‰©å±•çš„æ•°æ®æ¨¡å‹

```dart
/// å¯æ‰©å±•å®ä½“åŸºç±»
abstract class ExtensibleEntity {
  String get id;
  DateTime get createdAt;
  DateTime get updatedAt;

  /// æ‰©å±•å±æ€§ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
  Map<String, dynamic> get extensions;

  /// è·å–æ‰©å±•å±æ€§
  T? getExtension<T>(String key) {
    final value = extensions[key];
    if (value == null) return null;
    if (value is T) return value;

    // å°è¯•ç±»å‹è½¬æ¢
    return _convertExtension<T>(value);
  }

  /// è®¾ç½®æ‰©å±•å±æ€§
  ExtensibleEntity setExtension(String key, dynamic value);
}

/// äº¤æ˜“å®ä½“ï¼ˆå¯æ‰©å±•ï¼‰
class Transaction extends ExtensibleEntity {
  @override
  final String id;
  final double amount;
  final TransactionType type;
  final String? categoryId;
  final String accountId;
  final DateTime date;
  final String? description;

  @override
  final DateTime createdAt;
  @override
  final DateTime updatedAt;
  @override
  final Map<String, dynamic> extensions;

  Transaction({
    required this.id,
    required this.amount,
    required this.type,
    this.categoryId,
    required this.accountId,
    required this.date,
    this.description,
    DateTime? createdAt,
    DateTime? updatedAt,
    Map<String, dynamic>? extensions,
  }) : createdAt = createdAt ?? DateTime.now(),
       updatedAt = updatedAt ?? DateTime.now(),
       extensions = extensions ?? {};

  /// æ‰©å±•å±æ€§å¿«æ·è®¿é—®

  /// åœ°ç†ä½ç½®ï¼ˆå¦‚æœå¯ç”¨äº†ä½ç½®æ¨¡å—ï¼‰
  GeoLocation? get location => getExtension<GeoLocation>('location');

  /// å…³è”çš„å°é‡‘åº“IDï¼ˆå¦‚æœå¯ç”¨äº†é›¶åŸºé¢„ç®—ï¼‰
  String? get vaultId => getExtension<String>('vault_id');

  /// èµ„æºæ± æ¶ˆè€—è®°å½•ï¼ˆå¦‚æœå¯ç”¨äº†é’±é¾„è®¡ç®—ï¼‰
  List<ResourcePoolConsumption>? get resourcePoolConsumptions =>
    getExtension<List<ResourcePoolConsumption>>('resource_consumptions');

  /// æºæ•°æ®ï¼ˆå¦‚æœæ˜¯å¯¼å…¥çš„äº¤æ˜“ï¼‰
  SourceData? get sourceData => getExtension<SourceData>('source_data');

  /// æ ‡ç­¾åˆ—è¡¨
  List<String> get tags => getExtension<List<String>>('tags') ?? [];

  /// é™„ä»¶åˆ—è¡¨
  List<Attachment> get attachments =>
    getExtension<List<Attachment>>('attachments') ?? [];

  @override
  Transaction setExtension(String key, dynamic value) {
    return copyWith(
      extensions: {...extensions, key: value},
    );
  }

  Transaction copyWith({
    String? id,
    double? amount,
    TransactionType? type,
    String? categoryId,
    String? accountId,
    DateTime? date,
    String? description,
    DateTime? createdAt,
    DateTime? updatedAt,
    Map<String, dynamic>? extensions,
  }) {
    return Transaction(
      id: id ?? this.id,
      amount: amount ?? this.amount,
      type: type ?? this.type,
      categoryId: categoryId ?? this.categoryId,
      accountId: accountId ?? this.accountId,
      date: date ?? this.date,
      description: description ?? this.description,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: DateTime.now(),
      extensions: extensions ?? this.extensions,
    );
  }
}
```

#### 24.3.2 æ•°æ®åº“è¿ç§»æ¡†æ¶

```dart
/// æ•°æ®åº“è¿ç§»æ¡†æ¶
class MigrationFramework {
  final DatabaseService _db;
  final Logger _logger;

  /// è¿ç§»æ³¨å†Œè¡¨
  final List<Migration> _migrations = [];

  /// æ³¨å†Œè¿ç§»
  void registerMigration(Migration migration) {
    _migrations.add(migration);
    _migrations.sort((a, b) => a.version.compareTo(b.version));
  }

  /// æ‰§è¡Œè¿ç§»
  Future<MigrationResult> migrate() async {
    final currentVersion = await _getCurrentVersion();
    final targetVersion = _migrations.last.version;

    if (currentVersion >= targetVersion) {
      return MigrationResult.upToDate();
    }

    final pendingMigrations = _migrations
      .where((m) => m.version > currentVersion)
      .toList();

    _logger.info('Starting migration from v$currentVersion to v$targetVersion');

    final executedMigrations = <int>[];

    try {
      for (final migration in pendingMigrations) {
        _logger.info('Executing migration v${migration.version}: ${migration.description}');

        await _db.transaction((txn) async {
          // æ‰§è¡Œè¿ç§»
          await migration.up(txn);

          // æ›´æ–°ç‰ˆæœ¬å·
          await _updateVersion(txn, migration.version);
        });

        executedMigrations.add(migration.version);
      }

      return MigrationResult.success(
        fromVersion: currentVersion,
        toVersion: targetVersion,
        executedMigrations: executedMigrations,
      );
    } catch (e, stackTrace) {
      _logger.error('Migration failed', error: e, stackTrace: stackTrace);

      // å°è¯•å›æ»š
      if (executedMigrations.isNotEmpty) {
        await _rollback(executedMigrations.last);
      }

      return MigrationResult.failed(
        error: e,
        lastSuccessfulVersion: executedMigrations.isEmpty
          ? currentVersion
          : executedMigrations.last,
      );
    }
  }

  /// å›æ»šè¿ç§»
  Future<void> _rollback(int toVersion) async {
    final currentVersion = await _getCurrentVersion();

    final migrationsToRollback = _migrations
      .where((m) => m.version <= currentVersion && m.version > toVersion)
      .toList()
      .reversed;

    for (final migration in migrationsToRollback) {
      if (migration.down != null) {
        _logger.info('Rolling back migration v${migration.version}');
        await _db.transaction((txn) async {
          await migration.down!(txn);
          await _updateVersion(txn, migration.version - 1);
        });
      }
    }
  }
}

/// è¿ç§»å®šä¹‰
class Migration {
  final int version;
  final String description;
  final Future<void> Function(Transaction txn) up;
  final Future<void> Function(Transaction txn)? down;

  Migration({
    required this.version,
    required this.description,
    required this.up,
    this.down,
  });
}

/// ç¤ºä¾‹è¿ç§»ï¼šæ·»åŠ åœ°ç†ä½ç½®æ”¯æŒ
final migration_25_add_location = Migration(
  version: 25,
  description: 'æ·»åŠ åœ°ç†ä½ç½®å­—æ®µæ”¯æŒ',
  up: (txn) async {
    // æ·»åŠ ä½ç½®è¡¨
    await txn.execute('''
      CREATE TABLE IF NOT EXISTS locations (
        id TEXT PRIMARY KEY,
        city TEXT NOT NULL,
        province TEXT,
        country TEXT DEFAULT 'CN',
        city_tier TEXT,
        latitude REAL,
        longitude REAL,
        created_at TEXT NOT NULL
      )
    ''');

    // æ·»åŠ äº¤æ˜“-ä½ç½®å…³è”ç´¢å¼•
    await txn.execute('''
      CREATE INDEX IF NOT EXISTS idx_transactions_location
      ON transactions((json_extract(extensions, '$.location.city')))
    ''');
  },
  down: (txn) async {
    await txn.execute('DROP TABLE IF EXISTS locations');
    await txn.execute('DROP INDEX IF EXISTS idx_transactions_location');
  },
);
```

### 24.4 APIç‰ˆæœ¬ç®¡ç†

#### 24.4.1 APIç‰ˆæœ¬æ§åˆ¶

```dart
/// APIç‰ˆæœ¬ç®¡ç†å™¨
class ApiVersionManager {
  /// å½“å‰æ”¯æŒçš„APIç‰ˆæœ¬
  static const List<String> supportedVersions = ['v1', 'v2'];
  static const String latestVersion = 'v2';
  static const String minimumVersion = 'v1';

  /// ç‰ˆæœ¬åå•†
  String negotiateVersion(String? requestedVersion) {
    if (requestedVersion == null) {
      return latestVersion;
    }

    if (supportedVersions.contains(requestedVersion)) {
      return requestedVersion;
    }

    // å°è¯•å‘ä¸‹å…¼å®¹
    final requestedMajor = _extractMajorVersion(requestedVersion);
    for (final version in supportedVersions.reversed) {
      if (_extractMajorVersion(version) <= requestedMajor) {
        return version;
      }
    }

    throw ApiVersionException(
      'API version $requestedVersion is not supported. '
      'Minimum version: $minimumVersion, Latest: $latestVersion'
    );
  }

  int _extractMajorVersion(String version) {
    return int.parse(version.replaceAll('v', ''));
  }
}

/// APIç‰ˆæœ¬é€‚é…å™¨
abstract class ApiVersionAdapter<TRequest, TResponse> {
  String get version;

  /// è¯·æ±‚è½¬æ¢ï¼ˆæ—§ç‰ˆæœ¬ -> æœ€æ–°ç‰ˆæœ¬ï¼‰
  TRequest transformRequest(TRequest request);

  /// å“åº”è½¬æ¢ï¼ˆæœ€æ–°ç‰ˆæœ¬ -> æ—§ç‰ˆæœ¬ï¼‰
  TResponse transformResponse(TResponse response);
}

/// äº¤æ˜“API v1é€‚é…å™¨
class TransactionApiV1Adapter
    extends ApiVersionAdapter<TransactionRequest, TransactionResponse> {
  @override
  String get version => 'v1';

  @override
  TransactionRequest transformRequest(TransactionRequest request) {
    // v1ä¸æ”¯æŒextensionså­—æ®µï¼Œå¿½ç•¥
    return request.copyWith(extensions: null);
  }

  @override
  TransactionResponse transformResponse(TransactionResponse response) {
    // v1å“åº”ä¸åŒ…å«extensionså­—æ®µ
    return response.copyWith(
      data: response.data.map((tx) => tx.copyWith(extensions: {})).toList(),
    );
  }
}
```

### 24.5 æ¼”è¿›å¼æ¶æ„è·¯çº¿

#### 24.5.1 æ¶æ„æ¼”è¿›é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ¶æ„æ¼”è¿›è·¯çº¿å›¾ (2.0 ç‰ˆæœ¬æ›´æ–°)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  é˜¶æ®µ1: å•ä½“åº”ç”¨ + ç¦»çº¿ä¼˜å…ˆ (2.0 å½“å‰é˜¶æ®µ)                              â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘  â”‚
â”‚  â•‘  â”‚                     Flutter App (å®¢æˆ·ç«¯)                          â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â”‚ é’±é¾„ç³»ç»Ÿ   â”‚  â”‚ é›¶åŸºé¢„ç®—   â”‚  â”‚ é‡‘èä¹ æƒ¯   â”‚                  â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â”‚ MoneyAge   â”‚  â”‚ ZeroBased  â”‚  â”‚ Habits     â”‚                  â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â•‘  â”‚
â”‚  â•‘  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â•‘  â”‚
â”‚  â•‘  â”‚                        â†“                                          â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â”‚  SQLite (æœ¬åœ°)  +  OfflineQueueService  +  AutoSyncService  â”‚ â”‚ â•‘  â”‚
â”‚  â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘  â”‚
â”‚  â•‘                                   â”‚ (æœ‰ç½‘ç»œæ—¶åŒæ­¥)                      â•‘  â”‚
â”‚  â•‘                                   â†“                                    â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘  â”‚
â”‚  â•‘  â”‚  FastAPI Backend  +  PostgreSQL  +  Redis  +  AIæœåŠ¡ (é€šä¹‰åƒé—®)   â”‚ â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘  é€‚ç”¨è§„æ¨¡: DAU < 10,000                                                â•‘  â”‚
â”‚  â•‘  2.0æ–°å¢èƒ½åŠ›:                                                          â•‘  â”‚
â”‚  â•‘    â€¢ ç¦»çº¿ä¼˜å…ˆæ¶æ„ï¼Œç½‘ç»œæ–­å¼€æ—¶å®Œæ•´å¯ç”¨                                   â•‘  â”‚
â”‚  â•‘    â€¢ é’±é¾„è®¡ç®—æœ¬åœ°å®Œæˆï¼Œæ— éœ€ç½‘ç»œ                                         â•‘  â”‚
â”‚  â•‘    â€¢ AIè¯†åˆ«æ”¯æŒç«¯ä¾§æ¨¡å‹é™çº§                                             â•‘  â”‚
â”‚  â•‘    â€¢ åœ°ç†ä½ç½®æ™ºèƒ½æœ¬åœ°ç¼“å­˜                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                              â†“ (DAU > 10,000)                                â”‚
â”‚                                                                              â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  é˜¶æ®µ2: å‚ç›´æ‹†åˆ† + è¯»å†™åˆ†ç¦»                                             â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘                        API Gateway (Nginx)                             â•‘  â”‚
â”‚  â•‘                              â†“                                         â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â•‘  â”‚
â”‚  â•‘  â”‚  ç”¨æˆ·æœåŠ¡   â”‚    â”‚  è®°è´¦æœåŠ¡   â”‚    â”‚  æ™ºèƒ½æœåŠ¡   â”‚                â•‘  â”‚
â”‚  â•‘  â”‚  (Auth)     â”‚    â”‚ (Bookkeep)  â”‚    â”‚  (AI/Stats) â”‚                â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â•‘  â”‚
â”‚  â•‘         â”‚                  â”‚                  â”‚                        â•‘  â”‚
â”‚  â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â•‘  â”‚
â”‚  â•‘                   â†“                  â†“                                 â•‘  â”‚
â”‚  â•‘            PostgreSQL           Redis (ç¼“å­˜)                           â•‘  â”‚
â”‚  â•‘            (ä¸»+ä» è¯»å†™åˆ†ç¦»)        + æ¶ˆæ¯é˜Ÿåˆ—                           â•‘  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘  é€‚ç”¨è§„æ¨¡: 10,000 < DAU < 50,000                                       â•‘  â”‚
â”‚  â•‘  æ–°å¢èƒ½åŠ›:                                                              â•‘  â”‚
â”‚  â•‘    â€¢ æ™ºèƒ½æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œæ”¯æŒGPUåŠ é€Ÿ                                      â•‘  â”‚
â”‚  â•‘    â€¢ ç»Ÿè®¡è®¡ç®—å¼‚æ­¥å¤„ç†ï¼Œæå‡å“åº”é€Ÿåº¦                                      â•‘  â”‚
â”‚  â•‘    â€¢ æ•°æ®è¯»å†™åˆ†ç¦»ï¼Œæå‡å¹¶å‘èƒ½åŠ›                                         â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                              â†“ (DAU > 50,000)                                â”‚
â”‚                                                                              â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  é˜¶æ®µ3: å¾®æœåŠ¡æ¶æ„ + é¢†åŸŸé©±åŠ¨                                            â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘                    API Gateway + Service Mesh                          â•‘  â”‚
â”‚  â•‘                              â†“                                         â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”         â•‘  â”‚
â”‚  â•‘  â”‚ ç”¨æˆ·  â”‚ â”‚ è´¦æˆ·  â”‚ â”‚ äº¤æ˜“  â”‚ â”‚ é¢„ç®—  â”‚ â”‚ é’±é¾„  â”‚ â”‚  AI   â”‚         â•‘  â”‚
â”‚  â•‘  â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚ â”‚ æœåŠ¡  â”‚         â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â•‘  â”‚
â”‚  â•‘      â”‚         â”‚         â”‚         â”‚         â”‚         â”‚              â•‘  â”‚
â”‚  â•‘      â†“         â†“         â†“         â†“         â†“         â†“              â•‘  â”‚
â”‚  â•‘   UserDB   AccountDB  TransDB   BudgetDB  MoneyDB    AI-API          â•‘  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘  æ¶ˆæ¯é˜Ÿåˆ—: Kafka (äº‹ä»¶é©±åŠ¨)                                             â•‘  â”‚
â”‚  â•‘  æœåŠ¡å‘ç°: Consul / Kubernetes                                         â•‘  â”‚
â”‚  â•‘  é…ç½®ä¸­å¿ƒ: Apollo / Nacos                                              â•‘  â”‚
â”‚  â•‘  é“¾è·¯è¿½è¸ª: Jaeger / Zipkin                                             â•‘  â”‚
â”‚  â•‘                                                                        â•‘  â”‚
â”‚  â•‘  é€‚ç”¨è§„æ¨¡: DAU > 50,000                                                â•‘  â”‚
â”‚  â•‘  æ–°å¢èƒ½åŠ›:                                                              â•‘  â”‚
â”‚  â•‘    â€¢ é’±é¾„æœåŠ¡ç‹¬ç«‹ï¼Œæ”¯æŒæ‰¹é‡è®¡ç®—å’Œå®æ—¶æ›´æ–°                                â•‘  â”‚
â”‚  â•‘    â€¢ é¢†åŸŸäº‹ä»¶é©±åŠ¨ï¼ŒæœåŠ¡é—´æ¾è€¦åˆ                                         â•‘  â”‚
â”‚  â•‘    â€¢ ç°åº¦å‘å¸ƒæŒ‰ç”¨æˆ·IDè·¯ç”±                                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.5.2 å¹³æ»‘è¿ç§»ç­–ç•¥

```dart
/// æœåŠ¡æŠ½è±¡å±‚ï¼ˆæ”¯æŒå¹³æ»‘è¿ç§»ï¼‰
abstract class ServiceClient<T> {
  Future<T> call(ServiceRequest request);
}

/// æœ¬åœ°æœåŠ¡å®¢æˆ·ç«¯ï¼ˆå•ä½“é˜¶æ®µï¼‰
class LocalServiceClient<T> implements ServiceClient<T> {
  final T Function(ServiceRequest) _handler;

  LocalServiceClient(this._handler);

  @override
  Future<T> call(ServiceRequest request) async {
    return _handler(request);
  }
}

/// è¿œç¨‹æœåŠ¡å®¢æˆ·ç«¯ï¼ˆå¾®æœåŠ¡é˜¶æ®µï¼‰
class RemoteServiceClient<T> implements ServiceClient<T> {
  final String _serviceUrl;
  final HttpClient _httpClient;
  final T Function(Map<String, dynamic>) _deserializer;

  RemoteServiceClient(this._serviceUrl, this._httpClient, this._deserializer);

  @override
  Future<T> call(ServiceRequest request) async {
    final response = await _httpClient.post(
      Uri.parse(_serviceUrl),
      body: jsonEncode(request.toJson()),
    );
    return _deserializer(jsonDecode(response.body));
  }
}

/// æœåŠ¡å·¥å‚ï¼ˆæ ¹æ®é…ç½®é€‰æ‹©å®ç°ï¼‰
class ServiceFactory {
  final AppConfig _config;

  ServiceClient<TransactionList> createTransactionService() {
    if (_config.useRemoteServices) {
      return RemoteServiceClient(
        _config.transactionServiceUrl,
        HttpClient(),
        (json) => TransactionList.fromJson(json),
      );
    } else {
      return LocalServiceClient(
        (request) => _localTransactionService.handle(request),
      );
    }
  }
}
```

### 24.6 åŠŸèƒ½å¼€å…³ä¸ç°åº¦å‘å¸ƒ

#### 24.6.1 2.0ç‰ˆæœ¬åŠŸèƒ½å¼€å…³æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         2.0 ç‰ˆæœ¬åŠŸèƒ½å¼€å…³çŠ¶æ€                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ ¸å¿ƒåŠŸèƒ½ (å·²å…¨é‡)                                          ç°åº¦æ¯”ä¾‹    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ zero_based_budget  é›¶åŸºé¢„ç®—ç³»ç»Ÿ                            100%     â”‚ â”‚
â”‚  â”‚ â€¢ money_age          é’±é¾„è®¡ç®—ä¸å±•ç¤º                          100%     â”‚ â”‚
â”‚  â”‚ â€¢ budget_vault       å°é‡‘åº“ç®¡ç†                              100%     â”‚ â”‚
â”‚  â”‚ â€¢ offline_sync       ç¦»çº¿åŒæ­¥æœåŠ¡                            100%     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é‡‘èä¹ æƒ¯åŸ¹å…» (åˆ†é˜¶æ®µç°åº¦)                                   ç°åº¦æ¯”ä¾‹    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ subscription_tracking    è®¢é˜…è¿½è¸ªä¸æµªè´¹æ£€æµ‹                 80%     â”‚ â”‚
â”‚  â”‚ â€¢ latte_factor            æ‹¿é“å› å­åˆ†æ                        80%     â”‚ â”‚
â”‚  â”‚ â€¢ actionable_insights     å¯æ“ä½œæ´å¯Ÿå»ºè®®                      60%     â”‚ â”‚
â”‚  â”‚ â€¢ impulse_control         å†²åŠ¨æ¶ˆè´¹å¹²é¢„                        70%     â”‚ â”‚
â”‚  â”‚ â€¢ spending_planning       å…ˆè§„åˆ’å†æ¶ˆè´¹å¼•å¯¼                    50%     â”‚ â”‚
â”‚  â”‚ â€¢ financial_buffer        åº”æ€¥é‡‘ç®¡ç†                          80%     â”‚ â”‚
â”‚  â”‚ â€¢ debt_health             å€ºåŠ¡å¥åº·ç®¡ç†                        60%     â”‚ â”‚
â”‚  â”‚ â€¢ social_comparison       ç¤¾ä¼šè®¤åŒå‚ç…§                        30%     â”‚ â”‚
â”‚  â”‚ â€¢ financial_commitment    æ‰¿è¯ºä¸€è‡´æœºåˆ¶                        40%     â”‚ â”‚
â”‚  â”‚ â€¢ inclusive_motivation    åŒ…å®¹æ€§è®°è´¦æ¿€åŠ±                      70%     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ™ºèƒ½å¢å¼º (æŠ€æœ¯éªŒè¯é˜¶æ®µ)                                     ç°åº¦æ¯”ä¾‹    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ geo_location            åœ°ç†ä½ç½®æ™ºèƒ½æ¨è                    50%     â”‚ â”‚
â”‚  â”‚ â€¢ cross_region_detection  å¼‚åœ°æ¶ˆè´¹æ£€æµ‹                        40%     â”‚ â”‚
â”‚  â”‚ â€¢ ai_recognition_v2       AIè¯†åˆ«å¼•æ“V2                        20%     â”‚ â”‚
â”‚  â”‚ â€¢ ondevice_ai             ç«¯ä¾§AIæ¨¡å‹                          10%     â”‚ â”‚
â”‚  â”‚ â€¢ voice_realtime          å®æ—¶è¯­éŸ³è¯†åˆ«                        60%     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä½“éªŒè®¾è®¡ (æ¸è¿›å¼€æ”¾)                                         ç°åº¦æ¯”ä¾‹    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ companion_copywriting   ä¼™ä¼´åŒ–æ–‡æ¡ˆç”Ÿæˆ                      70%     â”‚ â”‚
â”‚  â”‚ â€¢ dynamic_theme           åŠ¨æ€ä¸»é¢˜è‰²å½©                        80%     â”‚ â”‚
â”‚  â”‚ â€¢ drilldown_navigation    æ•°æ®ä¸‹é’»å¯¼èˆª                        90%     â”‚ â”‚
â”‚  â”‚ â€¢ accessibility_enhanced  å¢å¼ºæ— éšœç¢æ”¯æŒ                      100%    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœªæ¥è§„åˆ’ (2.1+ ç‰ˆæœ¬)                                        ç°åº¦æ¯”ä¾‹    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ â€¢ collaborative_budget    åä½œé¢„ç®— (å¤šäººå…±äº«)                  0%     â”‚ â”‚
â”‚  â”‚ â€¢ family_account          å®¶åº­è´¦æˆ·                             0%     â”‚ â”‚
â”‚  â”‚ â€¢ investment_tracking     æŠ•èµ„è¿½è¸ª                             0%     â”‚ â”‚
â”‚  â”‚ â€¢ financial_planning      è´¢åŠ¡è§„åˆ’åŠ©æ‰‹                         0%     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.6.2 åŠŸèƒ½å¼€å…³ç³»ç»Ÿå®ç°

```dart
/// åŠŸèƒ½å¼€å…³æœåŠ¡
class FeatureFlagService {
  final RemoteConfigService _remoteConfig;
  final LocalStorageService _localStorage;

  /// 2.0ç‰ˆæœ¬åŠŸèƒ½å¼€å…³å®šä¹‰
  static const Map<String, FeatureFlagDefinition> _definitions = {
    // ====== æ ¸å¿ƒåŠŸèƒ½ (å·²å…¨é‡) ======
    'zero_based_budget': FeatureFlagDefinition(
      name: 'é›¶åŸºé¢„ç®—',
      description: 'å¯ç”¨é›¶åŸºé¢„ç®—åŠŸèƒ½',
      defaultEnabled: true,
      rolloutPercentage: 100,
      category: FeatureCategory.core,
    ),
    'money_age': FeatureFlagDefinition(
      name: 'é’±é¾„è®¡ç®—',
      description: 'å¯ç”¨é’±é¾„è®¡ç®—å’Œå±•ç¤º',
      defaultEnabled: true,
      rolloutPercentage: 100,
      category: FeatureCategory.core,
    ),
    'budget_vault': FeatureFlagDefinition(
      name: 'å°é‡‘åº“',
      description: 'å¯ç”¨å°é‡‘åº“ç®¡ç†åŠŸèƒ½',
      defaultEnabled: true,
      rolloutPercentage: 100,
      category: FeatureCategory.core,
    ),
    'offline_sync': FeatureFlagDefinition(
      name: 'ç¦»çº¿åŒæ­¥',
      description: 'å¯ç”¨ç¦»çº¿æ•°æ®åŒæ­¥',
      defaultEnabled: true,
      rolloutPercentage: 100,
      category: FeatureCategory.core,
    ),

    // ====== é‡‘èä¹ æƒ¯åŸ¹å…» ======
    'subscription_tracking': FeatureFlagDefinition(
      name: 'è®¢é˜…è¿½è¸ª',
      description: 'è‡ªåŠ¨è¯†åˆ«å’Œè¿½è¸ªè®¢é˜…æ¶ˆè´¹',
      defaultEnabled: false,
      rolloutPercentage: 80,
      category: FeatureCategory.habit,
    ),
    'actionable_insights': FeatureFlagDefinition(
      name: 'å¯æ“ä½œæ´å¯Ÿ',
      description: 'æä¾›å…·ä½“å¯æ“ä½œçš„æ¶ˆè´¹å»ºè®®',
      defaultEnabled: false,
      rolloutPercentage: 60,
      category: FeatureCategory.habit,
    ),
    'impulse_control': FeatureFlagDefinition(
      name: 'å†²åŠ¨æ¶ˆè´¹å¹²é¢„',
      description: 'å¤§é¢æ¶ˆè´¹å‰çš„å†·é™æœŸæé†’',
      defaultEnabled: false,
      rolloutPercentage: 70,
      category: FeatureCategory.habit,
    ),
    'social_comparison': FeatureFlagDefinition(
      name: 'ç¤¾ä¼šè®¤åŒå‚ç…§',
      description: 'åŒç±»ç”¨æˆ·æ¶ˆè´¹æ°´å¹³å¯¹æ¯”',
      defaultEnabled: false,
      rolloutPercentage: 30,
      category: FeatureCategory.habit,
    ),
    'financial_commitment': FeatureFlagDefinition(
      name: 'æ‰¿è¯ºä¸€è‡´æœºåˆ¶',
      description: 'è´¢åŠ¡ç›®æ ‡æ‰¿è¯ºä¸è¿½è¸ª',
      defaultEnabled: false,
      rolloutPercentage: 40,
      category: FeatureCategory.habit,
    ),

    // ====== æ™ºèƒ½å¢å¼º ======
    'geo_location': FeatureFlagDefinition(
      name: 'åœ°ç†ä½ç½®æ™ºèƒ½',
      description: 'å¯ç”¨åŸºäºä½ç½®çš„æ™ºèƒ½æ¨è',
      defaultEnabled: false,
      rolloutPercentage: 50,
      category: FeatureCategory.ai,
    ),
    'ai_recognition_v2': FeatureFlagDefinition(
      name: 'AIè¯†åˆ«V2',
      description: 'ä½¿ç”¨æ–°ç‰ˆAIè¯†åˆ«å¼•æ“',
      defaultEnabled: false,
      rolloutPercentage: 20,
      category: FeatureCategory.ai,
    ),
    'ondevice_ai': FeatureFlagDefinition(
      name: 'ç«¯ä¾§AI',
      description: 'ä½¿ç”¨ç«¯ä¾§AIæ¨¡å‹è¿›è¡Œç¦»çº¿è¯†åˆ«',
      defaultEnabled: false,
      rolloutPercentage: 10,
      category: FeatureCategory.ai,
    ),

    // ====== ä½“éªŒè®¾è®¡ ======
    'companion_copywriting': FeatureFlagDefinition(
      name: 'ä¼™ä¼´åŒ–æ–‡æ¡ˆ',
      description: 'å¯ç”¨AIç”Ÿæˆçš„ä¼™ä¼´åŒ–æ–‡æ¡ˆ',
      defaultEnabled: false,
      rolloutPercentage: 70,
      category: FeatureCategory.experience,
    ),
    'drilldown_navigation': FeatureFlagDefinition(
      name: 'æ•°æ®ä¸‹é’»',
      description: 'å¯ç”¨æ•°æ®ä¸‹é’»å¯¼èˆª',
      defaultEnabled: false,
      rolloutPercentage: 90,
      category: FeatureCategory.experience,
    ),

    // ====== æœªæ¥è§„åˆ’ ======
    'collaborative_budget': FeatureFlagDefinition(
      name: 'åä½œé¢„ç®—',
      description: 'æ”¯æŒå¤šäººå…±äº«é¢„ç®—',
      defaultEnabled: false,
      rolloutPercentage: 0,
      requiredVersion: '2.1.0',
      category: FeatureCategory.future,
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  Future<bool> isEnabled(String featureKey, {String? userId}) async {
    final definition = _definitions[featureKey];
    if (definition == null) return false;

    // 1. æ£€æŸ¥ç‰ˆæœ¬è¦æ±‚
    if (definition.requiredVersion != null) {
      final currentVersion = await _getCurrentAppVersion();
      if (!_meetsVersionRequirement(currentVersion, definition.requiredVersion!)) {
        return false;
      }
    }

    // 2. æ£€æŸ¥è¿œç¨‹é…ç½®è¦†ç›–
    final remoteOverride = await _remoteConfig.getBool('feature_$featureKey');
    if (remoteOverride != null) return remoteOverride;

    // 3. æ£€æŸ¥æœ¬åœ°è¦†ç›–ï¼ˆå¼€å‘/æµ‹è¯•ç”¨ï¼‰
    final localOverride = _localStorage.getBool('feature_override_$featureKey');
    if (localOverride != null) return localOverride;

    // 4. æ£€æŸ¥ç°åº¦ç™¾åˆ†æ¯”
    if (userId != null && definition.rolloutPercentage < 100) {
      final userBucket = _getUserBucket(userId, featureKey);
      return userBucket < definition.rolloutPercentage;
    }

    // 5. è¿”å›é»˜è®¤å€¼
    return definition.defaultEnabled || definition.rolloutPercentage >= 100;
  }

  /// æ ¹æ®ç”¨æˆ·IDè®¡ç®—bucketï¼ˆç¡®ä¿åŒä¸€ç”¨æˆ·å§‹ç»ˆåœ¨åŒä¸€bucketï¼‰
  int _getUserBucket(String userId, String featureKey) {
    final hash = md5.convert(utf8.encode('$userId:$featureKey'));
    return hash.bytes.first % 100;
  }

  /// å¯ç”¨åŠŸèƒ½ï¼ˆç”¨äºA/Bæµ‹è¯•ï¼‰
  Widget featureWidget({
    required String featureKey,
    required Widget enabledWidget,
    required Widget disabledWidget,
    String? userId,
  }) {
    return FutureBuilder<bool>(
      future: isEnabled(featureKey, userId: userId),
      builder: (context, snapshot) {
        if (snapshot.hasData && snapshot.data!) {
          return enabledWidget;
        }
        return disabledWidget;
      },
    );
  }
}
```

### 24.7 ç‰ˆæœ¬åŠŸèƒ½æ‰©å±•è§„åˆ’

#### 24.7.1 ç‰ˆæœ¬æ¼”è¿›è·¯çº¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç‰ˆæœ¬åŠŸèƒ½æ¼”è¿›è·¯çº¿ (2.0 â†’ 3.0)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  2.0.x (å½“å‰)                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ ¸å¿ƒåŠŸèƒ½å®Œå–„                                                             â”‚ â”‚
â”‚  â”‚ â€¢ é’±é¾„ç³»ç»Ÿç¨³å®šæ€§ä¼˜åŒ–                                                     â”‚ â”‚
â”‚  â”‚ â€¢ é›¶åŸºé¢„ç®—ç”¨æˆ·ä½“éªŒæ”¹è¿›                                                   â”‚ â”‚
â”‚  â”‚ â€¢ é‡‘èä¹ æƒ¯åŸ¹å…»åŠŸèƒ½ç°åº¦å…¨é‡                                               â”‚ â”‚
â”‚  â”‚ â€¢ ç¦»çº¿åŒæ­¥å†²çªè§£å†³ä¼˜åŒ–                                                   â”‚ â”‚
â”‚  â”‚ â€¢ æ€§èƒ½ä¼˜åŒ–ä¸Bugä¿®å¤                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                               â”‚
â”‚  2.1.x (è§„åˆ’ä¸­)                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç¤¾äº¤ä¸åä½œ                                                               â”‚ â”‚
â”‚  â”‚ â€¢ å®¶åº­è´¦æˆ·å…±äº«                                                          â”‚ â”‚
â”‚  â”‚ â€¢ åä½œé¢„ç®— (AAè®°è´¦ã€è´¹ç”¨åˆ†æ‘Š)                                            â”‚ â”‚
â”‚  â”‚ â€¢ è´¦å•åˆ†äº«ä¸å¯¹è´¦                                                         â”‚ â”‚
â”‚  â”‚ â€¢ æ¶ˆè´¹åœˆå­ (åŒ¿åæ¶ˆè´¹ä¹ æƒ¯åˆ†äº«)                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                               â”‚
â”‚  2.2.x (è§„åˆ’ä¸­)                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ™ºèƒ½åŒ–å‡çº§                                                               â”‚ â”‚
â”‚  â”‚ â€¢ ç«¯ä¾§AIæ¨¡å‹å…¨é‡éƒ¨ç½²                                                     â”‚ â”‚
â”‚  â”‚ â€¢ æ™ºèƒ½è´¢åŠ¡è§„åˆ’åŠ©æ‰‹                                                       â”‚ â”‚
â”‚  â”‚ â€¢ æ¶ˆè´¹é¢„æµ‹ä¸é¢„è­¦                                                         â”‚ â”‚
â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–ç†è´¢å»ºè®®                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                               â”‚
â”‚  3.0.x (è¿œæœŸæ„¿æ™¯)                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é‡‘èç”Ÿæ€æ•´åˆ                                                             â”‚ â”‚
â”‚  â”‚ â€¢ é“¶è¡Œè´¦æˆ·è‡ªåŠ¨åŒæ­¥                                                       â”‚ â”‚
â”‚  â”‚ â€¢ æŠ•èµ„ç»„åˆè¿½è¸ª                                                           â”‚ â”‚
â”‚  â”‚ â€¢ è·¨å¹³å°èµ„äº§ç®¡ç†                                                         â”‚ â”‚
â”‚  â”‚ â€¢ AIç†è´¢é¡¾é—®                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.7.2 æ‰©å±•ç‚¹é¢„ç•™è®¾è®¡

```dart
/// 2.0ç‰ˆæœ¬æ‰©å±•ç‚¹é¢„ç•™
class ExtensionPointRegistry {
  /// äº¤æ˜“å¤„ç†æ‰©å±•ç‚¹
  static const transactionExtensions = [
    'pre_create_hook',      // äº¤æ˜“åˆ›å»ºå‰é’©å­
    'post_create_hook',     // äº¤æ˜“åˆ›å»ºåé’©å­
    'validation_chain',     // éªŒè¯é“¾æ‰©å±•
    'categorization',       // åˆ†ç±»ç­–ç•¥æ‰©å±•
    'smart_tags',           // æ™ºèƒ½æ ‡ç­¾æ‰©å±•
  ];

  /// é¢„ç®—ç®¡ç†æ‰©å±•ç‚¹
  static const budgetExtensions = [
    'allocation_strategy',  // åˆ†é…ç­–ç•¥æ‰©å±•
    'rollover_policy',      // ç»“è½¬ç­–ç•¥æ‰©å±•
    'alert_rules',          // é¢„è­¦è§„åˆ™æ‰©å±•
    'visualization',        // å¯è§†åŒ–æ‰©å±•
  ];

  /// AIèƒ½åŠ›æ‰©å±•ç‚¹
  static const aiExtensions = [
    'recognition_model',    // è¯†åˆ«æ¨¡å‹æ‰©å±•
    'nlu_parser',           // NLUè§£æå™¨æ‰©å±•
    'insight_generator',    // æ´å¯Ÿç”Ÿæˆæ‰©å±•
    'prediction_model',     // é¢„æµ‹æ¨¡å‹æ‰©å±•
  ];

  /// æ•°æ®å¯¼å‡ºæ‰©å±•ç‚¹
  static const exportExtensions = [
    'format_handler',       // æ ¼å¼å¤„ç†å™¨æ‰©å±•
    'template_engine',      // æ¨¡æ¿å¼•æ“æ‰©å±•
    'encryption_provider',  // åŠ å¯†æä¾›è€…æ‰©å±•
  ];

  /// ç¬¬ä¸‰æ–¹é›†æˆæ‰©å±•ç‚¹ (2.1+)
  static const integrationExtensions = [
    'bank_sync_provider',   // é“¶è¡ŒåŒæ­¥æä¾›è€…
    'payment_detector',     // æ”¯ä»˜æ£€æµ‹å™¨
    'receipt_parser',       // æ”¶æ®è§£æå™¨
  ];
}

/// æ‰©å±•ç‚¹æ³¨å†Œç¤ºä¾‹
class TransactionExtensionPoint {
  final List<TransactionHook> _preCreateHooks = [];
  final List<TransactionHook> _postCreateHooks = [];

  /// æ³¨å†Œé¢„åˆ›å»ºé’©å­
  void registerPreCreateHook(TransactionHook hook) {
    _preCreateHooks.add(hook);
  }

  /// æ³¨å†Œååˆ›å»ºé’©å­
  void registerPostCreateHook(TransactionHook hook) {
    _postCreateHooks.add(hook);
  }

  /// æ‰§è¡Œé¢„åˆ›å»ºé’©å­é“¾
  Future<TransactionInput> executePreCreateHooks(TransactionInput input) async {
    var result = input;
    for (final hook in _preCreateHooks) {
      result = await hook.execute(result);
    }
    return result;
  }

  /// æ‰§è¡Œååˆ›å»ºé’©å­é“¾
  Future<void> executePostCreateHooks(Transaction transaction) async {
    for (final hook in _postCreateHooks) {
      await hook.onCreated(transaction);
    }
  }
}

/// äº¤æ˜“é’©å­æ¥å£
abstract class TransactionHook {
  String get hookId;
  int get priority; // æ‰§è¡Œä¼˜å…ˆçº§

  Future<TransactionInput> execute(TransactionInput input);
  Future<void> onCreated(Transaction transaction);
}

/// ç¤ºä¾‹ï¼šé’±é¾„æ›´æ–°é’©å­
class MoneyAgeUpdateHook implements TransactionHook {
  @override
  String get hookId => 'money_age_update';

  @override
  int get priority => 100;

  @override
  Future<TransactionInput> execute(TransactionInput input) async {
    // é¢„å¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é’±é¾„
    return input;
  }

  @override
  Future<void> onCreated(Transaction transaction) async {
    // äº¤æ˜“åˆ›å»ºåè§¦å‘é’±é¾„é‡æ–°è®¡ç®—
    if (transaction.type == TransactionType.expense) {
      await GetIt.I.get<MoneyAgeCalculator>().recalculateAfterExpense(transaction);
    } else if (transaction.type == TransactionType.income) {
      await GetIt.I.get<MoneyAgeCalculator>().addIncomeToPool(transaction);
    }
  }
}

/// ç¤ºä¾‹ï¼šé‡‘èä¹ æƒ¯åˆ†æé’©å­
class FinancialHabitAnalysisHook implements TransactionHook {
  @override
  String get hookId => 'financial_habit_analysis';

  @override
  int get priority => 200;

  @override
  Future<TransactionInput> execute(TransactionInput input) async {
    // é¢„å¤„ç†ï¼šå†²åŠ¨æ¶ˆè´¹æ£€æµ‹
    if (input.amount > 500) {
      await GetIt.I.get<ImpulseControlService>().checkImpulsePurchase(input);
    }
    return input;
  }

  @override
  Future<void> onCreated(Transaction transaction) async {
    // åå¤„ç†ï¼šæ›´æ–°æ¶ˆè´¹ä¹ æƒ¯åˆ†æ
    await GetIt.I.get<SubscriptionTrackingService>().analyzeTransaction(transaction);
    await GetIt.I.get<LatteFactorAnalyzer>().trackSmallExpense(transaction);
  }
}
```

#### 24.7.3 å‘åå…¼å®¹ä¿éšœ

```dart
/// ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†
class VersionCompatibilityManager {
  /// åŠŸèƒ½å…¼å®¹æ€§çŸ©é˜µ
  static const Map<String, VersionRequirement> featureRequirements = {
    // 2.0.0 æ ¸å¿ƒåŠŸèƒ½
    'money_age_basic': VersionRequirement(minVersion: '2.0.0'),
    'zero_based_budget': VersionRequirement(minVersion: '2.0.0'),
    'budget_vault': VersionRequirement(minVersion: '2.0.0'),

    // 2.0.5 å¢å¼ºåŠŸèƒ½
    'money_age_trend': VersionRequirement(minVersion: '2.0.5'),
    'actionable_insights': VersionRequirement(minVersion: '2.0.5'),

    // 2.1.0 åä½œåŠŸèƒ½
    'collaborative_budget': VersionRequirement(
      minVersion: '2.1.0',
      apiVersion: 'v2',
    ),
    'family_account': VersionRequirement(
      minVersion: '2.1.0',
      apiVersion: 'v2',
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  static bool isFeatureAvailable(String featureId, String currentVersion) {
    final requirement = featureRequirements[featureId];
    if (requirement == null) return false;

    return _compareVersions(currentVersion, requirement.minVersion) >= 0;
  }

  /// æ•°æ®æ ¼å¼å…¼å®¹è½¬æ¢
  static Future<Map<String, dynamic>> ensureDataCompatibility(
    Map<String, dynamic> data,
    String fromVersion,
    String toVersion,
  ) async {
    var result = Map<String, dynamic>.from(data);

    // 1.x â†’ 2.0 æ•°æ®è¿ç§»
    if (_compareVersions(fromVersion, '2.0.0') < 0 &&
        _compareVersions(toVersion, '2.0.0') >= 0) {
      result = await _migrateV1ToV2(result);
    }

    // 2.0.x â†’ 2.1.x æ•°æ®è¿ç§»
    if (_compareVersions(fromVersion, '2.1.0') < 0 &&
        _compareVersions(toVersion, '2.1.0') >= 0) {
      result = await _migrateV20ToV21(result);
    }

    return result;
  }

  /// 1.x â†’ 2.0 æ•°æ®è¿ç§»
  static Future<Map<String, dynamic>> _migrateV1ToV2(Map<String, dynamic> data) async {
    // æ·»åŠ é’±é¾„ç›¸å…³å­—æ®µé»˜è®¤å€¼
    if (!data.containsKey('resource_pools')) {
      data['resource_pools'] = [];
    }
    // æ·»åŠ å°é‡‘åº“ç›¸å…³å­—æ®µ
    if (!data.containsKey('budget_vaults')) {
      data['budget_vaults'] = [];
    }
    // è¿ç§»é¢„ç®—ç±»å‹
    if (data.containsKey('budgets')) {
      for (final budget in data['budgets'] as List) {
        budget['budget_type'] ??= 'traditional';
      }
    }
    return data;
  }

  /// ç‰ˆæœ¬å·æ¯”è¾ƒ
  static int _compareVersions(String v1, String v2) {
    final parts1 = v1.split('.').map(int.parse).toList();
    final parts2 = v2.split('.').map(int.parse).toList();

    for (var i = 0; i < 3; i++) {
      final p1 = i < parts1.length ? parts1[i] : 0;
      final p2 = i < parts2.length ? parts2[i] : 0;
      if (p1 != p2) return p1 - p2;
    }
    return 0;
  }
}

/// ç‰ˆæœ¬è¦æ±‚å®šä¹‰
class VersionRequirement {
  final String minVersion;
  final String? apiVersion;
  final List<String>? requiredPermissions;

  const VersionRequirement({
    required this.minVersion,
    this.apiVersion,
    this.requiredPermissions,
  });
}
```

### 24.8 ç¦»çº¿æ‰©å±•æ¶æ„

#### 24.8.1 ç¦»çº¿ä¼˜å…ˆæ‰©å±•è®¾è®¡

ç¦»çº¿ä¼˜å…ˆæ¶æ„æ˜¯2.0ç‰ˆæœ¬çš„æ ¸å¿ƒè®¾è®¡ç†å¿µï¼Œæ‰€æœ‰æ‰©å±•æ¨¡å—éƒ½éœ€è¦æ”¯æŒç¦»çº¿åœºæ™¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç¦»çº¿æ‰©å±•æ¶æ„è®¾è®¡                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        ç¦»çº¿æ‰©å±•å±‚çº§æ¶æ„                                   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Level 3: æ™ºèƒ½ç¦»çº¿ (AI Offline)                                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æœ¬åœ°AIæ¨¡å‹ (TFLite)    â€¢ ç¦»çº¿åˆ†ç±»æ¨æ–­    â€¢ ç¼“å­˜çš„æ™ºèƒ½å»ºè®®        â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                               â”‚                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Level 2: ä¸šåŠ¡ç¦»çº¿ (Business Offline)                               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ é’±é¾„æœ¬åœ°è®¡ç®—    â€¢ é¢„ç®—æœ¬åœ°åˆ†é…    â€¢ å°é‡‘åº“æœ¬åœ°ç®¡ç†               â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                               â”‚                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Level 1: æ•°æ®ç¦»çº¿ (Data Offline)                                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ SQLiteæœ¬åœ°å­˜å‚¨    â€¢ æ“ä½œé˜Ÿåˆ— (OfflineQueue)    â€¢ å†²çªè§£å†³ç­–ç•¥    â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  OfflineCapable æ¥å£ï¼šæ‰€æœ‰æ”¯æŒç¦»çº¿çš„æ‰©å±•å¿…é¡»å®ç°                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ canWorkOffline(): bool         // æ˜¯å¦æ”¯æŒç¦»çº¿                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ getOfflineFallback(): T        // è·å–ç¦»çº¿é™çº§ç­–ç•¥                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ queueForSync(operation): void  // å…¥é˜Ÿå¾…åŒæ­¥æ“ä½œ                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ syncOnReconnect(): Future      // ç½‘ç»œæ¢å¤æ—¶åŒæ­¥                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// ç¦»çº¿èƒ½åŠ›æ‰©å±•æ¥å£
abstract class OfflineCapable<T> {
  bool get canWorkOffline;
  OfflineFallbackStrategy<T> get offlineFallback;
  Future<void> queueForSync(OfflineOperation operation);
  Future<SyncResult> syncOnReconnect();
}

/// é’±é¾„æ¨¡å—ç¦»çº¿æ”¯æŒ
class MoneyAgeOfflineCapability implements OfflineCapable<MoneyAgeResult> {
  final MoneyAgeLocalCalculator _localCalculator;
  final OfflineQueueService _queue;

  @override
  bool get canWorkOffline => true;

  @override
  OfflineFallbackStrategy<MoneyAgeResult> get offlineFallback =>
    OfflineFallbackStrategy(
      strategy: FallbackType.useLocalCache,
      cacheKey: 'money_age_cache',
      maxAge: Duration(hours: 24),
    );

  @override
  Future<void> queueForSync(OfflineOperation operation) async {
    await _queue.enqueue(operation);
  }

  @override
  Future<SyncResult> syncOnReconnect() async {
    final pending = await _queue.getPending('money_age');
    for (final op in pending) {
      await _processOperation(op);
      await _queue.markCompleted(op.id);
    }
    return SyncResult.success(syncedCount: pending.length);
  }
}
```

### 24.9 AIèƒ½åŠ›æ‰©å±•æ¡†æ¶

#### 24.9.1 AIè¯†åˆ«å¼•æ“æ‰©å±•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AIèƒ½åŠ›æ‰©å±•æ¡†æ¶                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    AIExtensionRegistry                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ è¯­éŸ³è¯†åˆ«   â”‚  â”‚ å›¾ç‰‡è¯†åˆ«   â”‚  â”‚ NLUè§£æ    â”‚  â”‚ åˆ†ç±»æ¨è   â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â–¼                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                    â”‚     AIEngineManager     â”‚                                 â”‚
â”‚                    â”‚  â€¢ å¼•æ“é€‰æ‹© â€¢ é™çº§ç­–ç•¥  â”‚                                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                  â”‚                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â–¼                        â–¼                        â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  äº‘ç«¯AI    â”‚           â”‚  ç«¯ä¾§AI    â”‚           â”‚  æ··åˆAI    â”‚             â”‚
â”‚  â”‚ â€¢ åƒé—®API  â”‚           â”‚ â€¢ TFLite   â”‚           â”‚ â€¢ ä¼˜å…ˆæœ¬åœ° â”‚             â”‚
â”‚  â”‚ â€¢ GPT-4    â”‚           â”‚ â€¢ ML Kit   â”‚           â”‚ â€¢ äº‘ç«¯å¢å¼º â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// AIå¼•æ“æ‰©å±•æ¥å£
abstract class AIRecognitionEngine<I, O> {
  String get engineId;
  String get engineName;
  AIEngineType get engineType;
  Future<AIRecognitionResult<O>> recognize(I input, {Map<String, dynamic>? options});
  Future<bool> isAvailable();
}

enum AIEngineType { cloud, onDevice, hybrid }

/// AIå¼•æ“ç®¡ç†å™¨
class AIEngineManager {
  final Map<String, AIRecognitionEngine> _engines = {};
  final AIEngineSelector _selector;

  void registerEngine(AIRecognitionEngine engine) {
    _engines[engine.engineId] = engine;
  }

  Future<AIRecognitionResult<O>> recognize<I, O>(
    I input, {
    String? preferredEngine,
    bool allowFallback = true,
  }) async {
    final engine = await _selector.selectBestEngine<I, O>(
      input: input,
      preferredEngine: preferredEngine,
      availableEngines: _engines.values.toList(),
    );

    try {
      return await engine.recognize(input);
    } catch (e) {
      if (allowFallback) {
        final fallback = await _selector.getFallbackEngine<I, O>(
          excludeEngine: engine.engineId,
          availableEngines: _engines.values.toList(),
        );
        return await fallback.recognize(input);
      }
      rethrow;
    }
  }
}
```

### 24.10 ç›®æ ‡è¾¾æˆæ£€æµ‹

#### 24.10.1 å¯æ‰©å±•æ€§ç›®æ ‡æ£€æµ‹

```dart
/// ç¬¬22ç« ç›®æ ‡è¾¾æˆæ£€æµ‹
class ExtensibilityGoalDetector {
  Future<GoalDetectionResult> detectGoals() async {
    final results = <GoalCheckItem>[];

    results.add(await _checkModularArchitecture());
    results.add(await _checkPluginCapability());
    results.add(await _checkStrategyPattern());
    results.add(await _checkVersionCompatibility());
    results.add(await _checkGrayScaleCapability());
    results.add(await _checkOfflineExtension());
    results.add(await _checkAIExtension());

    return GoalDetectionResult(
      chapterName: 'ç¬¬24ç«  å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„',
      items: results,
      overallScore: _calculateOverallScore(results),
    );
  }

  Future<GoalCheckItem> _checkModularArchitecture() async {
    final checks = <String, bool>{};
    final registry = FeatureRegistry();

    checks['é’±é¾„æ¨¡å—å·²æ³¨å†Œ'] = registry.hasModule('money_age');
    checks['é¢„ç®—æ¨¡å—å·²æ³¨å†Œ'] = registry.hasModule('budget');
    checks['å°é‡‘åº“æ¨¡å—å·²æ³¨å†Œ'] = registry.hasModule('budget_vault');
    checks['ä¹ æƒ¯åŸ¹å…»æ¨¡å—å·²æ³¨å†Œ'] = registry.hasModule('financial_habit');
    checks['æ¨¡å—ä¾èµ–æ— å¾ªç¯'] = await _checkNoCyclicDependencies();

    return GoalCheckItem(
      name: 'æ¨¡å—åŒ–æ¶æ„',
      description: 'æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ç‹¬ç«‹æ³¨å†Œã€ä¾èµ–æ¸…æ™°',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkPluginCapability() async {
    final checks = <String, bool>{};
    final extensionRegistry = ExtensionPointRegistry();

    checks['äº¤æ˜“æ‰©å±•ç‚¹å¯ç”¨'] = extensionRegistry.hasPoint('transaction');
    checks['é¢„ç®—æ‰©å±•ç‚¹å¯ç”¨'] = extensionRegistry.hasPoint('budget');
    checks['AIæ‰©å±•ç‚¹å¯ç”¨'] = extensionRegistry.hasPoint('ai');
    checks['å¯¼å‡ºæ‰©å±•ç‚¹å¯ç”¨'] = extensionRegistry.hasPoint('export');

    return GoalCheckItem(
      name: 'æ’ä»¶åŒ–èƒ½åŠ›',
      description: 'æ‰©å±•ç‚¹å®Œæ•´ã€é’©å­æœºåˆ¶å¯ç”¨',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkStrategyPattern() async {
    final checks = <String, bool>{};
    final strategyManager = StrategyManager();

    checks['ä¼ ç»Ÿè®°è´¦ç­–ç•¥å¯ç”¨'] = strategyManager.hasStrategy('bookkeeping', 'traditional');
    checks['é›¶åŸºé¢„ç®—ç­–ç•¥å¯ç”¨'] = strategyManager.hasStrategy('bookkeeping', 'zero_based');
    checks['FIFOç­–ç•¥å¯ç”¨'] = strategyManager.hasStrategy('money_age', 'fifo');
    checks['ç­–ç•¥å¯åŠ¨æ€åˆ‡æ¢'] = await _checkStrategySwitch();

    return GoalCheckItem(
      name: 'ç­–ç•¥æ¨¡å¼æ‰©å±•',
      description: 'å¤šç§ç­–ç•¥å¯é€‰ã€æ”¯æŒåŠ¨æ€åˆ‡æ¢',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkVersionCompatibility() async {
    final checks = <String, bool>{};

    checks['APIç‰ˆæœ¬v2å¯ç”¨'] = await _checkApiVersion('v2');
    checks['1.xâ†’2.0è¿ç§»è·¯å¾„å­˜åœ¨'] = await _checkMigrationPath('1.0', '2.0');
    checks['æ—§ç‰ˆAPIä»å¯è®¿é—®'] = await _checkBackwardCompatibility();

    return GoalCheckItem(
      name: 'ç‰ˆæœ¬å…¼å®¹æ€§',
      description: 'APIç‰ˆæœ¬ç®¡ç†ã€æ•°æ®è¿ç§»ã€å‘åå…¼å®¹',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkGrayScaleCapability() async {
    final checks = <String, bool>{};
    final featureFlags = FeatureFlagService();

    checks['åŠŸèƒ½å¼€å…³æœåŠ¡å¯ç”¨'] = featureFlags.isInitialized;
    checks['2.0æ ¸å¿ƒåŠŸèƒ½å¼€å…³é…ç½®'] = featureFlags.hasFlag('money_age');
    checks['A/Bæµ‹è¯•æ¡†æ¶å¯ç”¨'] = await _checkABTestFramework();

    return GoalCheckItem(
      name: 'ç°åº¦å‘å¸ƒèƒ½åŠ›',
      description: 'åŠŸèƒ½å¼€å…³ã€ç”¨æˆ·åˆ†ç»„ã€A/Bæµ‹è¯•',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkOfflineExtension() async {
    final checks = <String, bool>{};

    checks['é’±é¾„æ¨¡å—æ”¯æŒç¦»çº¿'] = await _checkModuleOfflineCapability('money_age');
    checks['é¢„ç®—æ¨¡å—æ”¯æŒç¦»çº¿'] = await _checkModuleOfflineCapability('budget');
    checks['ç¦»çº¿æ“ä½œé˜Ÿåˆ—å¯ç”¨'] = await _checkOfflineQueue();
    checks['ç½‘ç»œæ¢å¤è‡ªåŠ¨åŒæ­¥'] = await _checkAutoSync();

    return GoalCheckItem(
      name: 'ç¦»çº¿æ‰©å±•èƒ½åŠ›',
      description: 'æ ¸å¿ƒæ¨¡å—ç¦»çº¿æ”¯æŒã€æ“ä½œé˜Ÿåˆ—ã€è‡ªåŠ¨åŒæ­¥',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  Future<GoalCheckItem> _checkAIExtension() async {
    final checks = <String, bool>{};
    final aiManager = AIEngineManager();

    checks['è¯­éŸ³è¯†åˆ«å¼•æ“å·²æ³¨å†Œ'] = aiManager.hasEngine('voice');
    checks['å›¾ç‰‡è¯†åˆ«å¼•æ“å·²æ³¨å†Œ'] = aiManager.hasEngine('image');
    checks['æœ¬åœ°åˆ†ç±»å¼•æ“å·²æ³¨å†Œ'] = aiManager.hasEngine('on_device_category');
    checks['AIå¼•æ“æ”¯æŒé™çº§'] = await _checkAIFallback();

    return GoalCheckItem(
      name: 'AIèƒ½åŠ›æ‰©å±•',
      description: 'å¤šå¼•æ“æ”¯æŒã€é™çº§ç­–ç•¥ã€å¯æ‰©å±•',
      checks: checks,
      passed: checks.values.every((v) => v),
    );
  }

  double _calculateOverallScore(List<GoalCheckItem> items) {
    if (items.isEmpty) return 0;
    return items.where((i) => i.passed).length / items.length;
  }
}
```

---


---

### 24.11 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 24.11.1 ç³»ç»Ÿé›†æˆæ¦‚è§ˆ

å¯æ‰©å±•æ€§æ¶æ„ä¸ºæ‰€æœ‰2.0æ¨¡å—æä¾›ç»Ÿä¸€çš„æ‰©å±•èƒ½åŠ›ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¯æ‰©å±•æ€§ä¸æ¼”è¿›æ¶æ„é›†æˆå…¨æ™¯å›¾                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        æ‰©å±•æ€§æ ¸å¿ƒæœåŠ¡                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ æ¨¡å—æ³¨å†Œ  â”‚  â”‚ ç­–ç•¥ç®¡ç†  â”‚  â”‚ ç‰ˆæœ¬æ§åˆ¶  â”‚  â”‚ ç°åº¦å‘å¸ƒ  â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡    â”‚     â”‚  æ™ºèƒ½å¢å¼º    â”‚     â”‚  2.0æ–°å¢    â”‚                 â”‚
â”‚  â”‚  æ‰©å±•æ”¯æŒ    â”‚     â”‚  æ‰©å±•æ”¯æŒ    â”‚     â”‚  æ‰©å±•æ”¯æŒ    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ â€¢ é’±é¾„ç­–ç•¥   â”‚     â”‚ â€¢ AIå¼•æ“    â”‚     â”‚ â€¢ è¯­éŸ³è¯†åˆ«   â”‚                 â”‚
â”‚  â”‚ â€¢ é¢„ç®—ç­–ç•¥   â”‚     â”‚ â€¢ åˆ†ç±»ç­–ç•¥   â”‚     â”‚ â€¢ ä½ç½®æœåŠ¡   â”‚                 â”‚
â”‚  â”‚ â€¢ å°é‡‘åº“è§„åˆ™ â”‚     â”‚ â€¢ æ´å¯Ÿç”Ÿæˆ   â”‚     â”‚ â€¢ å®¶åº­åŒæ­¥   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.11.2 é’±é¾„ç³»ç»Ÿæ‰©å±•é›†æˆ

é’±é¾„è®¡ç®—ç­–ç•¥çš„å¯æ‰©å±•è®¾è®¡ï¼š

| ç­–ç•¥ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| FIFO | å†…ç½®ç­–ç•¥ | å…ˆè¿›å…ˆå‡ºï¼Œé»˜è®¤ç­–ç•¥ |
| åŠ æƒå¹³å‡ | ç­–ç•¥æ³¨å†Œ | æŒ‰æƒé‡è®¡ç®—å¹³å‡é’±é¾„ |
| æŒ‰è´¦æˆ· | ç­–ç•¥æ‰©å±• | ä¸åŒè´¦æˆ·ä¸åŒè®¡ç®—æ–¹å¼ |
| è‡ªå®šä¹‰ | æ’ä»¶åŒ– | ç”¨æˆ·è‡ªå®šä¹‰è®¡ç®—è§„åˆ™ |

#### 24.11.3 é¢„ç®—ç³»ç»Ÿæ‰©å±•é›†æˆ

é¢„ç®—åˆ†é…ç­–ç•¥çš„å¯æ‰©å±•è®¾è®¡ï¼š

| ç­–ç•¥ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| ä¿¡å°æ³• | å†…ç½®ç­–ç•¥ | å›ºå®šé‡‘é¢åˆ†é… |
| 50/30/20 | ç­–ç•¥æ³¨å†Œ | æ¯”ä¾‹åˆ†é…æ³•åˆ™ |
| æ™ºèƒ½åˆ†é… | AIæ‰©å±• | åŸºäºæ¶ˆè´¹ä¹ æƒ¯æ™ºèƒ½åˆ†é… |
| è‡ªå®šä¹‰ | æ’ä»¶åŒ– | ç”¨æˆ·è‡ªå®šä¹‰åˆ†é…è§„åˆ™ |

#### 24.11.4 AIè¯†åˆ«æ‰©å±•é›†æˆ

AIè¯†åˆ«å¼•æ“çš„å¯æ‰©å±•è®¾è®¡ï¼š

| è¯†åˆ«ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| è¯­éŸ³è¯†åˆ« | å¼•æ“æ³¨å†Œ | æ”¯æŒå¤šASRå¼•æ“åˆ‡æ¢ |
| å›¾ç‰‡OCR | å¼•æ“æ³¨å†Œ | æ”¯æŒå¤šOCRå¼•æ“åˆ‡æ¢ |
| æ™ºèƒ½åˆ†ç±» | æ¨¡å‹æ‰©å±• | æ”¯æŒæœ¬åœ°/äº‘ç«¯æ¨¡å‹ |
| æ¶ˆè´¹è§£æ | è§„åˆ™æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰è§£æè§„åˆ™ |

#### 24.11.5 ä½ç½®æœåŠ¡æ‰©å±•é›†æˆ

ä½ç½®æ™ºèƒ½æœåŠ¡çš„å¯æ‰©å±•è®¾è®¡ï¼š

| æœåŠ¡ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| å®šä½æœåŠ¡ | æœåŠ¡æ³¨å†Œ | æ”¯æŒGPS/ç½‘ç»œ/æ··åˆ |
| POIåŒ¹é… | æ•°æ®æºæ‰©å±• | æ”¯æŒå¤šæ•°æ®æº |
| åœºæ™¯è¯†åˆ« | è§„åˆ™æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰åœºæ™¯è§„åˆ™ |
| åœ°ç†å›´æ  | é…ç½®æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰å›´æ  |

#### 24.11.6 å®¶åº­è´¦æœ¬æ‰©å±•é›†æˆ

å®¶åº­è´¦æœ¬åä½œçš„å¯æ‰©å±•è®¾è®¡ï¼š

| åŠŸèƒ½ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| æƒé™æ¨¡å‹ | é…ç½®æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰è§’è‰²æƒé™ |
| åŒæ­¥ç­–ç•¥ | ç­–ç•¥æ³¨å†Œ | æ”¯æŒå¤šç§å†²çªè§£å†³ç­–ç•¥ |
| å…±äº«è§„åˆ™ | è§„åˆ™æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰å…±äº«èŒƒå›´ |
| é€šçŸ¥æ¨¡æ¿ | æ¨¡æ¿æ‰©å±• | æ”¯æŒè‡ªå®šä¹‰é€šçŸ¥æ ·å¼ |

#### 24.11.7 ç‰ˆæœ¬è¿ç§»æ‰©å±•é›†æˆ

æ•°æ®è¿ç§»çš„å¯æ‰©å±•è®¾è®¡ï¼š

| è¿ç§»ç±»å‹ | æ‰©å±•æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| å®ä½“è¿ç§» | è¿ç§»è„šæœ¬ | æ³¨å†Œç‰ˆæœ¬è¿ç§»è„šæœ¬ |
| é…ç½®è¿ç§» | é…ç½®æ˜ å°„ | æ—§é…ç½®åˆ°æ–°é…ç½®æ˜ å°„ |
| æ•°æ®è½¬æ¢ | è½¬æ¢å™¨ | æ³¨å†Œæ•°æ®æ ¼å¼è½¬æ¢å™¨ |
| å›æ»šæ”¯æŒ | å›æ»šè„šæœ¬ | æ”¯æŒè¿ç§»å›æ»š |

---

## 25. å¯è§‚æµ‹æ€§ä¸ç›‘æ§

### 25.1 å¯è§‚æµ‹æ€§ç³»ç»Ÿæ€»è§ˆ

#### 25.1.1 ç« èŠ‚å®šä½ä¸è®¾è®¡ç›®æ ‡

æœ¬ç« èŠ‚åŸºäº**å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±**ï¼ˆæ—¥å¿—ã€æŒ‡æ ‡ã€è¿½è¸ªï¼‰è®¾è®¡ç³»ç»Ÿçš„å…¨é¢ç›‘æ§èƒ½åŠ›ï¼Œç¡®ä¿ç³»ç»Ÿå¥åº·çŠ¶æ€å¯çŸ¥ã€é—®é¢˜å¯è¿½æº¯ã€æ€§èƒ½å¯ä¼˜åŒ–ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¬¬25ç«  å¯è§‚æµ‹æ€§ä¸ç›‘æ§                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€è®¾è®¡ç›®æ ‡ã€‘                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±                                  â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚  â”‚   â”‚    æ—¥å¿—      â”‚   â”‚    æŒ‡æ ‡      â”‚   â”‚    è¿½è¸ª      â”‚           â”‚ â”‚
â”‚  â”‚   â”‚   Logging    â”‚   â”‚   Metrics    â”‚   â”‚   Tracing    â”‚           â”‚ â”‚
â”‚  â”‚   â”‚              â”‚   â”‚              â”‚   â”‚              â”‚           â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ ç»“æ„åŒ–æ—¥å¿— â”‚   â”‚ â€¢ æ€§èƒ½æŒ‡æ ‡   â”‚   â”‚ â€¢ åˆ†å¸ƒå¼è¿½è¸ª â”‚           â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ åˆ†çº§è¾“å‡º   â”‚   â”‚ â€¢ ä¸šåŠ¡æŒ‡æ ‡   â”‚   â”‚ â€¢ è¯·æ±‚é“¾è·¯   â”‚           â”‚ â”‚
â”‚  â”‚   â”‚ â€¢ è¿œç¨‹æ”¶é›†   â”‚   â”‚ â€¢ ç³»ç»ŸæŒ‡æ ‡   â”‚   â”‚ â€¢ é”™è¯¯è¿½è¸ª   â”‚           â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚  â”‚                            â”‚                                        â”‚ â”‚
â”‚  â”‚                            â–¼                                        â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ â”‚
â”‚  â”‚              â”‚       ç»Ÿä¸€ç›‘æ§å¹³å°          â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚  Unified Observability      â”‚                       â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  ã€2.0ç‰ˆæœ¬æ–°å¢èƒ½åŠ›ã€‘                                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  âœ“ ç¦»çº¿ä¼˜å…ˆç›‘æ§ï¼šç¦»çº¿çŠ¶æ€ä¸‹çš„æ•°æ®é‡‡é›†ä¸æ¢å¤ä¸ŠæŠ¥                          â”‚
â”‚  âœ“ AIæœåŠ¡ç›‘æ§ï¼šè¯†åˆ«å¼•æ“ã€LLMè°ƒç”¨çš„ä¸“é¡¹ç›‘æ§                               â”‚
â”‚  âœ“ é’±é¾„è®¡ç®—è¿½è¸ªï¼šé’±é¾„è®¡ç®—æ€§èƒ½ä¸å‡†ç¡®æ€§ç›‘æ§                                â”‚
â”‚  âœ“ ä¸šåŠ¡æŒ‡æ ‡ä½“ç³»ï¼šç”¨æˆ·è¡Œä¸ºã€åŠŸèƒ½ä½¿ç”¨ã€è½¬åŒ–æ¼æ–—                            â”‚
â”‚  âœ“ å®æ—¶å‘Šè­¦ï¼šå¤šæ¸ é“å‘Šè­¦é€šçŸ¥ä¸å‘Šè­¦æŠ‘åˆ¶                                    â”‚
â”‚  âœ“ ç«¯ä¾§æ€§èƒ½ï¼šå¸§ç‡ã€å†…å­˜ã€å¯åŠ¨æ—¶é—´ç­‰ç«¯ä¾§æŒ‡æ ‡                              â”‚
â”‚                                                                          â”‚
â”‚  ã€ä¸å…¶ä»–ç« èŠ‚å…³ç³»ã€‘                                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  ç¬¬10ç«       â”‚      â”‚  ç¬¬21ç«      â”‚      â”‚  ç¬¬22ç«      â”‚             â”‚
â”‚  â”‚  AIè¯†åˆ«     â”‚â”€â”€â”€â”€â”€â–ºâ”‚  å¼‚å¸¸å¤„ç†   â”‚â”€â”€â”€â”€â”€â–ºâ”‚  æ¶æ„æ¼”è¿›   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                    â”‚                    â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                              â–¼                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                    â”‚   ç¬¬5ç«         â”‚                                  â”‚
â”‚                    â”‚ å¯è§‚æµ‹æ€§ä¸ç›‘æ§  â”‚                                  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                              â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â–¼                    â–¼                    â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  æ€§èƒ½ç›‘æ§   â”‚      â”‚  é”™è¯¯è¿½è¸ª   â”‚      â”‚  ä¸šåŠ¡æ´å¯Ÿ   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 25.1.2 å¯è§‚æµ‹æ€§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯è§‚æµ‹æ€§ç³»ç»Ÿæ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        æ•°æ®é‡‡é›†å±‚                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚ æ—¥å¿—é‡‡é›†  â”‚ â”‚ æŒ‡æ ‡é‡‡é›†  â”‚ â”‚ è¿½è¸ªé‡‡é›†  â”‚ â”‚ äº‹ä»¶é‡‡é›†  â”‚            â”‚    â”‚
â”‚  â”‚  â”‚ Logger   â”‚ â”‚ Metrics  â”‚ â”‚ Tracer   â”‚ â”‚ Events   â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚            â”‚            â”‚            â”‚                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                              â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      æœ¬åœ°ç¼“å­˜å±‚ (ç¦»çº¿æ”¯æŒ)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  SQLite: observability_cache                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ logs (id, level, message, context, timestamp, synced)     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ metrics (id, name, value, tags, timestamp, synced)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ traces (id, trace_id, span_id, data, timestamp, synced)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ events (id, type, payload, timestamp, synced)             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚ (ç½‘ç»œæ¢å¤æ—¶æ‰¹é‡ä¸ŠæŠ¥)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        è¿œç¨‹æ”¶é›†å±‚                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚   æ—¥å¿—æ”¶é›†   â”‚  â”‚   æŒ‡æ ‡æ”¶é›†   â”‚  â”‚   è¿½è¸ªæ”¶é›†   â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ (Loki/ELK)   â”‚  â”‚ (Prometheus) â”‚  â”‚ (Jaeger)     â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        åˆ†æä¸å±•ç¤ºå±‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚   Grafana    â”‚  â”‚   å‘Šè­¦ç³»ç»Ÿ   â”‚  â”‚   ç®¡ç†åå°   â”‚             â”‚  â”‚
â”‚  â”‚  â”‚   Dashboard  â”‚  â”‚   Alerting   â”‚  â”‚   Admin Web  â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 25.1.3 å¯è§‚æµ‹æ€§æœåŠ¡å…¥å£

```dart
/// å¯è§‚æµ‹æ€§ç»Ÿä¸€å…¥å£
/// æä¾›æ—¥å¿—ã€æŒ‡æ ‡ã€è¿½è¸ªçš„ç»Ÿä¸€è®¿é—®æ¥å£
class ObservabilityService {
  static final ObservabilityService _instance = ObservabilityService._();
  factory ObservabilityService() => _instance;
  ObservabilityService._();

  late final LoggerService _logger;
  late final MetricsService _metrics;
  late final TracingService _tracing;
  late final EventService _events;
  late final ObservabilityCache _cache;

  /// åˆå§‹åŒ–å¯è§‚æµ‹æ€§æœåŠ¡
  Future<void> initialize({
    required ObservabilityConfig config,
  }) async {
    // åˆå§‹åŒ–æœ¬åœ°ç¼“å­˜
    _cache = ObservabilityCache();
    await _cache.initialize();

    // åˆå§‹åŒ–æ—¥å¿—æœåŠ¡
    _logger = LoggerService();
    await _logger.initialize(
      minLevel: config.logLevel,
      outputs: [
        ConsoleLogOutput(),
        FileLogOutput(config.logFilePath),
        CachedRemoteLogOutput(_cache, config.logEndpoint),
      ],
    );

    // åˆå§‹åŒ–æŒ‡æ ‡æœåŠ¡
    _metrics = MetricsService();
    await _metrics.initialize(
      flushInterval: config.metricsFlushInterval,
      cache: _cache,
    );

    // åˆå§‹åŒ–è¿½è¸ªæœåŠ¡
    _tracing = TracingService();
    await _tracing.initialize(
      serviceName: 'ai-bookkeeping-app',
      endpoint: config.tracingEndpoint,
      cache: _cache,
    );

    // åˆå§‹åŒ–äº‹ä»¶æœåŠ¡
    _events = EventService();
    await _events.initialize(cache: _cache);

    // å¯åŠ¨åå°åŒæ­¥
    _startBackgroundSync();
  }

  /// è·å–æ—¥å¿—æœåŠ¡
  LoggerService get logger => _logger;

  /// è·å–æŒ‡æ ‡æœåŠ¡
  MetricsService get metrics => _metrics;

  /// è·å–è¿½è¸ªæœåŠ¡
  TracingService get tracing => _tracing;

  /// è·å–äº‹ä»¶æœåŠ¡
  EventService get events => _events;

  /// åå°åŒæ­¥ç¼“å­˜æ•°æ®
  void _startBackgroundSync() {
    Timer.periodic(Duration(minutes: 5), (_) async {
      if (await _hasNetworkConnection()) {
        await _cache.syncPendingData();
      }
    });
  }
}

/// å¯è§‚æµ‹æ€§é…ç½®
class ObservabilityConfig {
  final LogLevel logLevel;
  final String logFilePath;
  final String logEndpoint;
  final Duration metricsFlushInterval;
  final String tracingEndpoint;

  const ObservabilityConfig({
    this.logLevel = LogLevel.info,
    required this.logFilePath,
    required this.logEndpoint,
    this.metricsFlushInterval = const Duration(seconds: 60),
    required this.tracingEndpoint,
  });
}
```

### 25.2 æ—¥å¿—ç³»ç»Ÿ

#### 25.2.1 ç»“æ„åŒ–æ—¥å¿—

```dart
/// ç»“æ„åŒ–æ—¥å¿—æœåŠ¡
class LoggerService {
  static final LoggerService _instance = LoggerService._();
  factory LoggerService() => _instance;
  LoggerService._();

  late final Logger _logger;
  final List<LogOutput> _outputs = [];

  /// åˆå§‹åŒ–
  Future<void> initialize({
    required LogLevel minLevel,
    required List<LogOutput> outputs,
  }) async {
    _outputs.addAll(outputs);
    _logger = Logger(
      printer: StructuredLogPrinter(),
      filter: ProductionFilter(minLevel),
      output: MultiOutput(_outputs),
    );
  }

  /// æ—¥å¿—æ–¹æ³•
  void debug(String message, {Map<String, dynamic>? context}) {
    _log(LogLevel.debug, message, context: context);
  }

  void info(String message, {Map<String, dynamic>? context}) {
    _log(LogLevel.info, message, context: context);
  }

  void warning(String message, {Map<String, dynamic>? context, dynamic error}) {
    _log(LogLevel.warning, message, context: context, error: error);
  }

  void error(String message, {
    Map<String, dynamic>? context,
    dynamic error,
    StackTrace? stackTrace,
  }) {
    _log(LogLevel.error, message, context: context, error: error, stackTrace: stackTrace);
  }

  void _log(
    LogLevel level,
    String message, {
    Map<String, dynamic>? context,
    dynamic error,
    StackTrace? stackTrace,
  }) {
    final logEntry = LogEntry(
      timestamp: DateTime.now(),
      level: level,
      message: message,
      context: {
        ...?context,
        'app_version': BuildInfo.version,
        'build_number': BuildInfo.buildNumber,
        'platform': Platform.operatingSystem,
        if (error != null) 'error': error.toString(),
        if (stackTrace != null) 'stack_trace': stackTrace.toString(),
      },
    );

    for (final output in _outputs) {
      output.write(logEntry);
    }
  }
}

/// æ—¥å¿—æ¡ç›®
class LogEntry {
  final DateTime timestamp;
  final LogLevel level;
  final String message;
  final Map<String, dynamic> context;

  LogEntry({
    required this.timestamp,
    required this.level,
    required this.message,
    required this.context,
  });

  Map<String, dynamic> toJson() => {
    'timestamp': timestamp.toIso8601String(),
    'level': level.name,
    'message': message,
    ...context,
  };
}

/// æ§åˆ¶å°è¾“å‡º
class ConsoleLogOutput extends LogOutput {
  @override
  void write(LogEntry entry) {
    final color = _getColor(entry.level);
    print('$color[${entry.level.name.toUpperCase()}] ${entry.timestamp}: ${entry.message}\x1B[0m');
    if (entry.context.isNotEmpty) {
      print('  Context: ${jsonEncode(entry.context)}');
    }
  }
}

/// æ–‡ä»¶è¾“å‡º
class FileLogOutput extends LogOutput {
  final File _logFile;
  IOSink? _sink;

  FileLogOutput(String path) : _logFile = File(path);

  @override
  void write(LogEntry entry) {
    _sink ??= _logFile.openWrite(mode: FileMode.append);
    _sink!.writeln(jsonEncode(entry.toJson()));
  }

  Future<void> flush() async {
    await _sink?.flush();
  }
}

/// è¿œç¨‹æ—¥å¿—è¾“å‡º
class RemoteLogOutput extends LogOutput {
  final String _endpoint;
  final List<LogEntry> _buffer = [];
  final int _batchSize;
  Timer? _flushTimer;

  RemoteLogOutput(this._endpoint, {int batchSize = 100})
    : _batchSize = batchSize {
    _flushTimer = Timer.periodic(Duration(seconds: 30), (_) => _flush());
  }

  @override
  void write(LogEntry entry) {
    _buffer.add(entry);
    if (_buffer.length >= _batchSize) {
      _flush();
    }
  }

  Future<void> _flush() async {
    if (_buffer.isEmpty) return;

    final batch = List<LogEntry>.from(_buffer);
    _buffer.clear();

    try {
      await http.post(
        Uri.parse(_endpoint),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(batch.map((e) => e.toJson()).toList()),
      );
    } catch (e) {
      // ä¸ŠæŠ¥å¤±è´¥ï¼Œé‡æ–°å…¥é˜Ÿï¼ˆæœ‰é™åˆ¶ï¼‰
      if (_buffer.length < 1000) {
        _buffer.insertAll(0, batch);
      }
    }
  }
}
```

### 25.3 æ€§èƒ½ç›‘æ§

#### 25.3.1 æ€§èƒ½è¿½è¸ª

```dart
/// æ€§èƒ½ç›‘æ§æœåŠ¡
class PerformanceMonitor {
  static final PerformanceMonitor _instance = PerformanceMonitor._();
  factory PerformanceMonitor() => _instance;
  PerformanceMonitor._();

  final Map<String, PerformanceTrace> _activeTraces = {};
  final List<PerformanceMetric> _metrics = [];

  /// å¼€å§‹è¿½è¸ª
  PerformanceTrace startTrace(String name, {Map<String, dynamic>? attributes}) {
    final trace = PerformanceTrace(
      name: name,
      startTime: DateTime.now(),
      attributes: attributes ?? {},
    );
    _activeTraces[trace.id] = trace;
    return trace;
  }

  /// ç»“æŸè¿½è¸ª
  void endTrace(PerformanceTrace trace) {
    trace.endTime = DateTime.now();
    _activeTraces.remove(trace.id);

    final metric = PerformanceMetric(
      name: trace.name,
      duration: trace.duration,
      attributes: trace.attributes,
      timestamp: trace.startTime,
    );

    _metrics.add(metric);
    _reportMetric(metric);
  }

  /// æµ‹é‡æ“ä½œ
  Future<T> measure<T>(
    String name,
    Future<T> Function() operation, {
    Map<String, dynamic>? attributes,
  }) async {
    final trace = startTrace(name, attributes: attributes);
    try {
      final result = await operation();
      trace.attributes['success'] = true;
      return result;
    } catch (e) {
      trace.attributes['success'] = false;
      trace.attributes['error'] = e.toString();
      rethrow;
    } finally {
      endTrace(trace);
    }
  }

  /// è®°å½•å¸§ç‡
  void recordFrameRate(double fps) {
    _metrics.add(PerformanceMetric(
      name: 'frame_rate',
      duration: Duration.zero,
      attributes: {'fps': fps},
      timestamp: DateTime.now(),
    ));
  }

  /// è®°å½•å†…å­˜ä½¿ç”¨
  void recordMemoryUsage() {
    final usage = ProcessInfo.currentRss;
    _metrics.add(PerformanceMetric(
      name: 'memory_usage',
      duration: Duration.zero,
      attributes: {'bytes': usage},
      timestamp: DateTime.now(),
    ));
  }
}

/// æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç›‘æ§
class QueryPerformanceMonitor {
  /// åŒ…è£…æ•°æ®åº“æŸ¥è¯¢
  Future<T> monitorQuery<T>(
    String queryName,
    Future<T> Function() query, {
    String? sql,
    Map<String, dynamic>? parameters,
  }) async {
    final stopwatch = Stopwatch()..start();

    try {
      final result = await query();
      stopwatch.stop();

      _recordQueryMetric(
        name: queryName,
        duration: stopwatch.elapsed,
        success: true,
        rowCount: _extractRowCount(result),
      );

      // æ…¢æŸ¥è¯¢è­¦å‘Š
      if (stopwatch.elapsedMilliseconds > 500) {
        LoggerService().warning(
          'Slow query detected: $queryName',
          context: {
            'duration_ms': stopwatch.elapsedMilliseconds,
            'sql': sql,
            'parameters': parameters,
          },
        );
      }

      return result;
    } catch (e) {
      stopwatch.stop();
      _recordQueryMetric(
        name: queryName,
        duration: stopwatch.elapsed,
        success: false,
        error: e.toString(),
      );
      rethrow;
    }
  }
}
```

#### 25.3.2 ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

```dart
/// ç”¨æˆ·ä½“éªŒæŒ‡æ ‡æ”¶é›†
class UXMetricsCollector {
  /// é¡µé¢åŠ è½½æ—¶é—´
  void recordPageLoad(String pageName, Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'page_load',
      duration: duration,
      attributes: {'page': pageName},
      timestamp: DateTime.now(),
    ));
  }

  /// ç”¨æˆ·äº¤äº’å“åº”æ—¶é—´
  void recordInteraction(String action, Duration responseTime) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'interaction_response',
      duration: responseTime,
      attributes: {'action': action},
      timestamp: DateTime.now(),
    ));
  }

  /// é¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼ˆFCPï¼‰
  void recordFCP(Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'first_contentful_paint',
      duration: duration,
      attributes: {},
      timestamp: DateTime.now(),
    ));
  }

  /// å¯äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰
  void recordTTI(Duration duration) {
    PerformanceMonitor().record(PerformanceMetric(
      name: 'time_to_interactive',
      duration: duration,
      attributes: {},
      timestamp: DateTime.now(),
    ));
  }
}

/// é¡µé¢æ€§èƒ½è¿½è¸ªMixin
mixin PagePerformanceTracker<T extends StatefulWidget> on State<T> {
  late final DateTime _pageStartTime;
  late final Stopwatch _renderStopwatch;

  @override
  void initState() {
    super.initState();
    _pageStartTime = DateTime.now();
    _renderStopwatch = Stopwatch()..start();
  }

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();

    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_renderStopwatch.isRunning) {
        _renderStopwatch.stop();
        UXMetricsCollector().recordPageLoad(
          widget.runtimeType.toString(),
          _renderStopwatch.elapsed,
        );
      }
    });
  }
}
```

### 25.4 é”™è¯¯è¿½è¸ª

#### 25.4.1 é”™è¯¯ä¸ŠæŠ¥æœåŠ¡

```dart
/// é”™è¯¯è¿½è¸ªæœåŠ¡
class ErrorTrackingService {
  static final ErrorTrackingService _instance = ErrorTrackingService._();
  factory ErrorTrackingService() => _instance;
  ErrorTrackingService._();

  late final String _dsn;
  late final String _environment;
  final Map<String, dynamic> _userContext = {};
  final List<String> _breadcrumbs = [];

  /// åˆå§‹åŒ–
  void initialize({
    required String dsn,
    required String environment,
  }) {
    _dsn = dsn;
    _environment = environment;

    // æ•è·Flutteré”™è¯¯
    FlutterError.onError = (details) {
      captureException(
        details.exception,
        stackTrace: details.stack,
        context: {'flutter_error': details.exceptionAsString()},
      );
    };

    // æ•è·æœªå¤„ç†çš„å¼‚æ­¥é”™è¯¯
    PlatformDispatcher.instance.onError = (error, stack) {
      captureException(error, stackTrace: stack);
      return true;
    };
  }

  /// è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
  void setUser(String userId, {String? email, Map<String, dynamic>? extra}) {
    _userContext['id'] = userId;
    if (email != null) _userContext['email'] = email;
    if (extra != null) _userContext.addAll(extra);
  }

  /// æ·»åŠ é¢åŒ…å±‘
  void addBreadcrumb(String message, {String? category, Map<String, dynamic>? data}) {
    _breadcrumbs.add(jsonEncode({
      'timestamp': DateTime.now().toIso8601String(),
      'message': message,
      'category': category,
      'data': data,
    }));

    // ä¿ç•™æœ€è¿‘50æ¡
    while (_breadcrumbs.length > 50) {
      _breadcrumbs.removeAt(0);
    }
  }

  /// æ•è·å¼‚å¸¸
  Future<void> captureException(
    dynamic exception, {
    StackTrace? stackTrace,
    Map<String, dynamic>? context,
    ErrorSeverity severity = ErrorSeverity.error,
  }) async {
    final errorReport = ErrorReport(
      exception: exception.toString(),
      stackTrace: stackTrace?.toString(),
      severity: severity,
      environment: _environment,
      appVersion: BuildInfo.version,
      buildNumber: BuildInfo.buildNumber,
      platform: Platform.operatingSystem,
      platformVersion: Platform.operatingSystemVersion,
      user: _userContext,
      breadcrumbs: List.from(_breadcrumbs),
      context: context,
      timestamp: DateTime.now(),
    );

    // æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿æ—¶ï¼‰
    await _storeLocally(errorReport);

    // å°è¯•ä¸ŠæŠ¥
    await _uploadReport(errorReport);
  }

  /// æœ¬åœ°å­˜å‚¨
  Future<void> _storeLocally(ErrorReport report) async {
    final db = await DatabaseService().database;
    await db.insert('error_reports', {
      'id': uuid.v4(),
      'data': jsonEncode(report.toJson()),
      'created_at': DateTime.now().toIso8601String(),
      'uploaded': 0,
    });
  }

  /// ä¸ŠæŠ¥é”™è¯¯
  Future<void> _uploadReport(ErrorReport report) async {
    try {
      await http.post(
        Uri.parse(_dsn),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode(report.toJson()),
      );

      // æ ‡è®°ä¸ºå·²ä¸ŠæŠ¥
      await _markAsUploaded(report.id);
    } catch (e) {
      // é™é»˜å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡åŒæ­¥
    }
  }

  /// åŒæ­¥æœªä¸ŠæŠ¥çš„é”™è¯¯
  Future<void> syncPendingReports() async {
    final db = await DatabaseService().database;
    final pending = await db.query(
      'error_reports',
      where: 'uploaded = 0',
      limit: 50,
    );

    for (final row in pending) {
      try {
        await http.post(
          Uri.parse(_dsn),
          headers: {'Content-Type': 'application/json'},
          body: row['data'],
        );
        await db.update(
          'error_reports',
          {'uploaded': 1},
          where: 'id = ?',
          whereArgs: [row['id']],
        );
      } catch (e) {
        break; // ç½‘ç»œé—®é¢˜ï¼Œåœæ­¢åŒæ­¥
      }
    }
  }
}

enum ErrorSeverity { debug, info, warning, error, fatal }
```

### 25.5 å¥åº·æ£€æŸ¥

#### 25.5.1 åº”ç”¨å¥åº·æ£€æŸ¥

```dart
/// å¥åº·æ£€æŸ¥æœåŠ¡
class HealthCheckService {
  /// æ‰§è¡Œå…¨é¢å¥åº·æ£€æŸ¥
  Future<HealthReport> performHealthCheck() async {
    final checks = <HealthCheckResult>[];

    // 1. æ•°æ®åº“æ£€æŸ¥
    checks.add(await _checkDatabase());

    // 2. ç½‘ç»œæ£€æŸ¥
    checks.add(await _checkNetwork());

    // 3. å­˜å‚¨ç©ºé—´æ£€æŸ¥
    checks.add(await _checkStorage());

    // 4. å†…å­˜æ£€æŸ¥
    checks.add(await _checkMemory());

    // 5. APIæœåŠ¡æ£€æŸ¥
    checks.add(await _checkApiServices());

    // 6. AIæœåŠ¡æ£€æŸ¥
    checks.add(await _checkAiServices());

    // æ±‡æ€»ç»“æœ
    final overallStatus = checks.any((c) => c.status == HealthStatus.critical)
      ? HealthStatus.critical
      : checks.any((c) => c.status == HealthStatus.degraded)
        ? HealthStatus.degraded
        : HealthStatus.healthy;

    return HealthReport(
      timestamp: DateTime.now(),
      overallStatus: overallStatus,
      checks: checks,
    );
  }

  /// æ•°æ®åº“å¥åº·æ£€æŸ¥
  Future<HealthCheckResult> _checkDatabase() async {
    try {
      final db = await DatabaseService().database;
      final stopwatch = Stopwatch()..start();

      // æ‰§è¡Œç®€å•æŸ¥è¯¢
      await db.rawQuery('SELECT 1');

      stopwatch.stop();

      return HealthCheckResult(
        name: 'database',
        status: stopwatch.elapsedMilliseconds < 100
          ? HealthStatus.healthy
          : HealthStatus.degraded,
        latency: stopwatch.elapsed,
        details: {'query_time_ms': stopwatch.elapsedMilliseconds},
      );
    } catch (e) {
      return HealthCheckResult(
        name: 'database',
        status: HealthStatus.critical,
        error: e.toString(),
      );
    }
  }

  /// å­˜å‚¨ç©ºé—´æ£€æŸ¥
  Future<HealthCheckResult> _checkStorage() async {
    try {
      final appDir = await getApplicationDocumentsDirectory();
      final stat = await appDir.stat();

      // è·å–å¯ç”¨ç©ºé—´ï¼ˆå¹³å°ç‰¹å®šï¼‰
      final freeSpace = await _getFreeSpace();
      final totalSpace = await _getTotalSpace();
      final usagePercent = (totalSpace - freeSpace) / totalSpace * 100;

      HealthStatus status;
      if (freeSpace < 100 * 1024 * 1024) { // < 100MB
        status = HealthStatus.critical;
      } else if (freeSpace < 500 * 1024 * 1024) { // < 500MB
        status = HealthStatus.degraded;
      } else {
        status = HealthStatus.healthy;
      }

      return HealthCheckResult(
        name: 'storage',
        status: status,
        details: {
          'free_space_mb': freeSpace ~/ (1024 * 1024),
          'total_space_mb': totalSpace ~/ (1024 * 1024),
          'usage_percent': usagePercent.toStringAsFixed(1),
        },
      );
    } catch (e) {
      return HealthCheckResult(
        name: 'storage',
        status: HealthStatus.degraded,
        error: e.toString(),
      );
    }
  }

  /// APIæœåŠ¡æ£€æŸ¥
  Future<HealthCheckResult> _checkApiServices() async {
    try {
      final stopwatch = Stopwatch()..start();

      final response = await http.get(
        Uri.parse('${AppConfig.apiBaseUrl}/health'),
      ).timeout(Duration(seconds: 5));

      stopwatch.stop();

      if (response.statusCode == 200) {
        return HealthCheckResult(
          name: 'api_service',
          status: stopwatch.elapsedMilliseconds < 1000
            ? HealthStatus.healthy
            : HealthStatus.degraded,
          latency: stopwatch.elapsed,
          details: jsonDecode(response.body),
        );
      } else {
        return HealthCheckResult(
          name: 'api_service',
          status: HealthStatus.degraded,
          details: {'status_code': response.statusCode},
        );
      }
    } catch (e) {
      return HealthCheckResult(
        name: 'api_service',
        status: HealthStatus.critical,
        error: e.toString(),
      );
    }
  }
}

enum HealthStatus { healthy, degraded, critical }

/// å¥åº·æ£€æŸ¥ç»“æœ
class HealthCheckResult {
  final String name;
  final HealthStatus status;
  final Duration? latency;
  final Map<String, dynamic>? details;
  final String? error;

  HealthCheckResult({
    required this.name,
    required this.status,
    this.latency,
    this.details,
    this.error,
  });
}
```

### 25.6 å‘Šè­¦ç³»ç»Ÿ

#### 25.6.1 å‘Šè­¦è§„åˆ™ä¸é€šçŸ¥

```dart
/// å‘Šè­¦æœåŠ¡
class AlertService {
  final List<AlertRule> _rules = [];
  final List<AlertChannel> _channels = [];

  /// æ³¨å†Œå‘Šè­¦è§„åˆ™
  void registerRule(AlertRule rule) {
    _rules.add(rule);
  }

  /// æ³¨å†Œé€šçŸ¥æ¸ é“
  void registerChannel(AlertChannel channel) {
    _channels.add(channel);
  }

  /// æ£€æŸ¥å‘Šè­¦æ¡ä»¶
  Future<void> checkAlerts(MetricData metrics) async {
    for (final rule in _rules) {
      if (rule.evaluate(metrics)) {
        await _triggerAlert(rule, metrics);
      }
    }
  }

  /// è§¦å‘å‘Šè­¦
  Future<void> _triggerAlert(AlertRule rule, MetricData metrics) async {
    final alert = Alert(
      ruleId: rule.id,
      ruleName: rule.name,
      severity: rule.severity,
      message: rule.formatMessage(metrics),
      timestamp: DateTime.now(),
      metrics: metrics,
    );

    // æ£€æŸ¥å‘Šè­¦æŠ‘åˆ¶
    if (await _shouldSuppress(alert)) {
      return;
    }

    // å‘é€åˆ°æ‰€æœ‰æ¸ é“
    for (final channel in _channels.where((c) => c.acceptsSeverity(rule.severity))) {
      try {
        await channel.send(alert);
      } catch (e) {
        LoggerService().error('Failed to send alert via ${channel.name}', error: e);
      }
    }

    // è®°å½•å‘Šè­¦å†å²
    await _recordAlert(alert);
  }
}

/// å‘Šè­¦è§„åˆ™
class AlertRule {
  final String id;
  final String name;
  final AlertSeverity severity;
  final bool Function(MetricData) condition;
  final String Function(MetricData) messageTemplate;
  final Duration cooldown;

  AlertRule({
    required this.id,
    required this.name,
    required this.severity,
    required this.condition,
    required this.messageTemplate,
    this.cooldown = const Duration(minutes: 5),
  });

  bool evaluate(MetricData metrics) => condition(metrics);
  String formatMessage(MetricData metrics) => messageTemplate(metrics);
}

/// é¢„å®šä¹‰å‘Šè­¦è§„åˆ™
class PredefinedAlertRules {
  static final highErrorRate = AlertRule(
    id: 'high_error_rate',
    name: 'é«˜é”™è¯¯ç‡',
    severity: AlertSeverity.critical,
    condition: (m) => m.errorRate > 0.05, // 5%
    messageTemplate: (m) => 'é”™è¯¯ç‡è¿‡é«˜: ${(m.errorRate * 100).toStringAsFixed(1)}%',
  );

  static final slowApiResponse = AlertRule(
    id: 'slow_api',
    name: 'APIå“åº”æ…¢',
    severity: AlertSeverity.warning,
    condition: (m) => m.avgApiLatency.inMilliseconds > 2000,
    messageTemplate: (m) => 'APIå¹³å‡å“åº”æ—¶é—´: ${m.avgApiLatency.inMilliseconds}ms',
  );

  static final lowDiskSpace = AlertRule(
    id: 'low_disk',
    name: 'ç£ç›˜ç©ºé—´ä¸è¶³',
    severity: AlertSeverity.warning,
    condition: (m) => m.freeDiskSpace < 100 * 1024 * 1024, // 100MB
    messageTemplate: (m) => 'å¯ç”¨ç©ºé—´: ${m.freeDiskSpace ~/ (1024 * 1024)}MB',
  );

  static final syncFailure = AlertRule(
    id: 'sync_failure',
    name: 'åŒæ­¥å¤±è´¥',
    severity: AlertSeverity.warning,
    condition: (m) => m.syncFailureCount > 3,
    messageTemplate: (m) => 'è¿ç»­åŒæ­¥å¤±è´¥${m.syncFailureCount}æ¬¡',
  );
}

enum AlertSeverity { info, warning, critical }

/// æœ¬åœ°é€šçŸ¥æ¸ é“
class LocalNotificationChannel extends AlertChannel {
  @override
  String get name => 'local_notification';

  @override
  Future<void> send(Alert alert) async {
    await FlutterLocalNotificationsPlugin().show(
      alert.hashCode,
      _getSeverityTitle(alert.severity),
      alert.message,
      NotificationDetails(
        android: AndroidNotificationDetails(
          'alerts',
          'ç³»ç»Ÿå‘Šè­¦',
          importance: _getImportance(alert.severity),
          priority: Priority.high,
        ),
        iOS: DarwinNotificationDetails(),
      ),
    );
  }

  Importance _getImportance(AlertSeverity severity) {
    switch (severity) {
      case AlertSeverity.critical: return Importance.max;
      case AlertSeverity.warning: return Importance.high;
      case AlertSeverity.info: return Importance.defaultImportance;
    }
  }
}
```

### 25.7 AIæœåŠ¡ä¸“é¡¹ç›‘æ§

#### 25.7.1 AIè¯†åˆ«æœåŠ¡ç›‘æ§

```dart
/// AIæœåŠ¡ç›‘æ§
/// é’ˆå¯¹AIè¯†åˆ«å¼•æ“ã€LLMè°ƒç”¨çš„ä¸“é¡¹ç›‘æ§
class AIServiceMonitor {
  final MetricsService _metrics;
  final LoggerService _logger;
  final TracingService _tracing;

  /// ç›‘æ§AIè¯†åˆ«è¯·æ±‚
  Future<T> monitorRecognition<T>({
    required String recognitionType,
    required Future<T> Function() operation,
    Map<String, dynamic>? context,
  }) async {
    final trace = _tracing.startSpan(
      'ai_recognition',
      attributes: {
        'type': recognitionType,
        ...?context,
      },
    );

    final stopwatch = Stopwatch()..start();

    try {
      final result = await operation();
      stopwatch.stop();

      // è®°å½•æˆåŠŸæŒ‡æ ‡
      _metrics.recordHistogram(
        'ai_recognition_duration_ms',
        stopwatch.elapsedMilliseconds.toDouble(),
        tags: {'type': recognitionType, 'status': 'success'},
      );

      _metrics.incrementCounter(
        'ai_recognition_total',
        tags: {'type': recognitionType, 'status': 'success'},
      );

      trace.setStatus(SpanStatus.ok);
      return result;
    } catch (e, stackTrace) {
      stopwatch.stop();

      // è®°å½•å¤±è´¥æŒ‡æ ‡
      _metrics.incrementCounter(
        'ai_recognition_total',
        tags: {'type': recognitionType, 'status': 'error'},
      );

      _metrics.incrementCounter(
        'ai_recognition_errors',
        tags: {'type': recognitionType, 'error_type': e.runtimeType.toString()},
      );

      _logger.error(
        'AI recognition failed',
        context: {
          'type': recognitionType,
          'duration_ms': stopwatch.elapsedMilliseconds,
          ...?context,
        },
        error: e,
        stackTrace: stackTrace,
      );

      trace.setStatus(SpanStatus.error, message: e.toString());
      rethrow;
    } finally {
      trace.end();
    }
  }

  /// ç›‘æ§LLMè°ƒç”¨
  Future<T> monitorLLMCall<T>({
    required String provider,
    required String model,
    required int inputTokens,
    required Future<T> Function() operation,
  }) async {
    final trace = _tracing.startSpan(
      'llm_call',
      attributes: {
        'provider': provider,
        'model': model,
        'input_tokens': inputTokens,
      },
    );

    final stopwatch = Stopwatch()..start();

    try {
      final result = await operation();
      stopwatch.stop();

      // è®°å½•è°ƒç”¨æŒ‡æ ‡
      _metrics.recordHistogram(
        'llm_call_duration_ms',
        stopwatch.elapsedMilliseconds.toDouble(),
        tags: {'provider': provider, 'model': model},
      );

      _metrics.incrementCounter(
        'llm_tokens_used',
        value: inputTokens,
        tags: {'provider': provider, 'type': 'input'},
      );

      trace.setStatus(SpanStatus.ok);
      return result;
    } catch (e) {
      _metrics.incrementCounter(
        'llm_call_errors',
        tags: {'provider': provider, 'model': model},
      );

      trace.setStatus(SpanStatus.error);
      rethrow;
    } finally {
      trace.end();
    }
  }
}

/// AIæœåŠ¡å¥åº·ä»ªè¡¨ç›˜æ•°æ®
class AIServiceDashboard {
  final AIServiceMonitor _monitor;

  /// è·å–AIæœåŠ¡å¥åº·æ‘˜è¦
  Future<AIServiceHealth> getHealthSummary() async {
    final last24h = DateTime.now().subtract(Duration(hours: 24));

    return AIServiceHealth(
      voiceRecognition: await _getServiceHealth('voice', last24h),
      imageRecognition: await _getServiceHealth('image', last24h),
      textRecognition: await _getServiceHealth('text', last24h),
      llmService: await _getLLMServiceHealth(last24h),
    );
  }

  Future<ServiceHealthMetrics> _getServiceHealth(
    String type,
    DateTime since,
  ) async {
    // ä»æŒ‡æ ‡æœåŠ¡æŸ¥è¯¢
    final successCount = await _monitor._metrics.queryCounter(
      'ai_recognition_total',
      tags: {'type': type, 'status': 'success'},
      since: since,
    );
    final errorCount = await _monitor._metrics.queryCounter(
      'ai_recognition_total',
      tags: {'type': type, 'status': 'error'},
      since: since,
    );
    final avgLatency = await _monitor._metrics.queryHistogramAvg(
      'ai_recognition_duration_ms',
      tags: {'type': type},
      since: since,
    );

    final total = successCount + errorCount;
    final successRate = total > 0 ? successCount / total : 1.0;

    return ServiceHealthMetrics(
      serviceName: '${type}_recognition',
      totalRequests: total,
      successRate: successRate,
      avgLatencyMs: avgLatency,
      status: _determineHealthStatus(successRate, avgLatency),
    );
  }

  HealthStatus _determineHealthStatus(double successRate, double latency) {
    if (successRate < 0.9 || latency > 5000) return HealthStatus.critical;
    if (successRate < 0.95 || latency > 2000) return HealthStatus.degraded;
    return HealthStatus.healthy;
  }
}
```

### 25.8 ä¸šåŠ¡æŒ‡æ ‡ä½“ç³»

#### 25.8.1 æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡å®šä¹‰

```dart
/// ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†æœåŠ¡
class BusinessMetricsService {
  final MetricsService _metrics;
  final EventService _events;

  /// è®°å½•è®°è´¦è¡Œä¸º
  void recordTransaction({
    required String source,  // 'voice', 'image', 'manual', 'import'
    required String category,
    required double amount,
    required bool isAIAssisted,
    Duration? recognitionTime,
  }) {
    _metrics.incrementCounter(
      'transactions_created',
      tags: {
        'source': source,
        'category': category,
        'ai_assisted': isAIAssisted.toString(),
      },
    );

    _metrics.recordHistogram(
      'transaction_amount',
      amount,
      tags: {'category': category},
    );

    if (recognitionTime != null) {
      _metrics.recordHistogram(
        'transaction_recognition_time_ms',
        recognitionTime.inMilliseconds.toDouble(),
        tags: {'source': source},
      );
    }

    _events.track(
      'transaction_created',
      properties: {
        'source': source,
        'category': category,
        'amount_range': _getAmountRange(amount),
        'ai_assisted': isAIAssisted,
      },
    );
  }

  /// è®°å½•é¢„ç®—ç›¸å…³è¡Œä¸º
  void recordBudgetAction({
    required String action, // 'create', 'update', 'check', 'exceed'
    required String budgetType,
    double? utilizationRate,
  }) {
    _metrics.incrementCounter(
      'budget_actions',
      tags: {'action': action, 'type': budgetType},
    );

    if (utilizationRate != null) {
      _metrics.recordGauge(
        'budget_utilization',
        utilizationRate,
        tags: {'type': budgetType},
      );
    }

    _events.track('budget_$action', properties: {
      'budget_type': budgetType,
      'utilization_rate': utilizationRate,
    });
  }

  /// è®°å½•é’±é¾„ç›¸å…³æŒ‡æ ‡
  void recordMoneyAgeMetrics({
    required int moneyAgeDays,
    required double dailySpending,
    required int transactionCount,
  }) {
    _metrics.recordGauge('money_age_days', moneyAgeDays.toDouble());
    _metrics.recordGauge('daily_spending', dailySpending);

    _events.track('money_age_calculated', properties: {
      'days': moneyAgeDays,
      'daily_spending': dailySpending,
      'transaction_count': transactionCount,
    });
  }

  /// è®°å½•åŠŸèƒ½ä½¿ç”¨æƒ…å†µ
  void recordFeatureUsage({
    required String feature,
    required String action,
    Map<String, dynamic>? properties,
  }) {
    _metrics.incrementCounter(
      'feature_usage',
      tags: {'feature': feature, 'action': action},
    );

    _events.track('feature_$action', properties: {
      'feature': feature,
      ...?properties,
    });
  }

  String _getAmountRange(double amount) {
    if (amount < 10) return '0-10';
    if (amount < 50) return '10-50';
    if (amount < 100) return '50-100';
    if (amount < 500) return '100-500';
    if (amount < 1000) return '500-1000';
    return '1000+';
  }
}
```

#### 25.8.2 ç”¨æˆ·è¡Œä¸ºåˆ†æ

```dart
/// ç”¨æˆ·è¡Œä¸ºåˆ†ææœåŠ¡
class UserBehaviorAnalytics {
  final EventService _events;
  final MetricsService _metrics;

  /// è®°å½•ç”¨æˆ·ä¼šè¯
  void startSession() {
    _events.track('session_start', properties: {
      'timestamp': DateTime.now().toIso8601String(),
      'app_version': BuildInfo.version,
      'platform': Platform.operatingSystem,
    });
  }

  /// è®°å½•é¡µé¢è®¿é—®
  void trackPageView(String pageName, {Map<String, dynamic>? properties}) {
    _metrics.incrementCounter('page_views', tags: {'page': pageName});
    _events.track('page_view', properties: {
      'page': pageName,
      ...?properties,
    });
  }

  /// è®°å½•ç”¨æˆ·æ—…ç¨‹
  void trackJourney({
    required String journeyName,
    required String step,
    bool completed = false,
    Duration? stepDuration,
  }) {
    _events.track('journey_step', properties: {
      'journey': journeyName,
      'step': step,
      'completed': completed,
      'duration_ms': stepDuration?.inMilliseconds,
    });

    if (completed) {
      _metrics.incrementCounter(
        'journey_completed',
        tags: {'journey': journeyName},
      );
    }
  }

  /// è®°å½•è½¬åŒ–æ¼æ–—
  void trackFunnelStep({
    required String funnel,
    required int step,
    required String stepName,
    bool converted = false,
  }) {
    _events.track('funnel_step', properties: {
      'funnel': funnel,
      'step': step,
      'step_name': stepName,
      'converted': converted,
    });

    _metrics.incrementCounter(
      'funnel_${funnel}_step_$step',
      tags: {'converted': converted.toString()},
    );
  }
}

/// é¢„å®šä¹‰ç”¨æˆ·æ—…ç¨‹
class UserJourneys {
  static const firstTransaction = 'first_transaction';
  static const setupBudget = 'setup_budget';
  static const viewMoneyAge = 'view_money_age';
  static const enableVoiceRecognition = 'enable_voice_recognition';
  static const completeWeeklyReview = 'complete_weekly_review';
}

/// é¢„å®šä¹‰è½¬åŒ–æ¼æ–—
class ConversionFunnels {
  /// æ–°ç”¨æˆ·æ¿€æ´»æ¼æ–—
  static const newUserActivation = [
    'app_install',
    'registration_complete',
    'first_transaction',
    'budget_created',
    'day_7_active',
  ];

  /// è¯­éŸ³è®°è´¦æ¼æ–—
  static const voiceBookkeeping = [
    'voice_button_clicked',
    'recording_started',
    'recognition_complete',
    'transaction_confirmed',
  ];

  /// é¢„ç®—è®¾ç½®æ¼æ–—
  static const budgetSetup = [
    'budget_page_opened',
    'category_selected',
    'amount_entered',
    'budget_saved',
  ];
}
```

#### 25.8.3 ç›‘æ§ä»ªè¡¨ç›˜é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡ç›‘æ§ä»ªè¡¨ç›˜ (Grafana)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡ (å®æ—¶)                                    åˆ·æ–°: 30s   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  æ—¥æ´»ç”¨æˆ·    â”‚  â”‚  æ–°å¢äº¤æ˜“    â”‚  â”‚  å¹³å‡é’±é¾„    â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (DAU)      â”‚  â”‚   (24h)      â”‚  â”‚   (å¤©)       â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   12,345    â”‚  â”‚   45,678    â”‚  â”‚    14.2     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   â†‘ 5.2%    â”‚  â”‚   â†‘ 8.1%    â”‚  â”‚   â†‘ 0.3     â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  AIè¯†åˆ«ç‡    â”‚  â”‚  é¢„ç®—è¾¾æˆ    â”‚  â”‚  7æ—¥ç•™å­˜     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (æˆåŠŸ%)    â”‚  â”‚   (ç”¨æˆ·%)    â”‚  â”‚   (%)        â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   96.8%     â”‚  â”‚   72.3%     â”‚  â”‚   45.6%     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   â†“ 0.2%    â”‚  â”‚   â†‘ 1.5%    â”‚  â”‚   â†‘ 2.1%    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è®°è´¦æ¥æºåˆ†å¸ƒ (24h)                              äº¤æ˜“é‡‘é¢åˆ†å¸ƒ       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚   è¯­éŸ³è®°è´¦ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 45%      0-50å…ƒ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 40%    â”‚ â”‚
â”‚  â”‚   å›¾ç‰‡è¯†åˆ« â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 25%      50-200å…ƒ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ 30%    â”‚ â”‚
â”‚  â”‚   æ‰‹åŠ¨å½•å…¥ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%      200-500  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%    â”‚ â”‚
â”‚  â”‚   æ‰¹é‡å¯¼å…¥ â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%      500+     â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%    â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AIæœåŠ¡æ€§èƒ½ (P50/P95/P99 å»¶è¿Ÿ)                                      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚  è¯­éŸ³è¯†åˆ«:  P50: 1.2s  â”‚  P95: 2.8s  â”‚  P99: 4.1s   [æ­£å¸¸]         â”‚ â”‚
â”‚  â”‚  å›¾ç‰‡OCR:   P50: 0.8s  â”‚  P95: 1.5s  â”‚  P99: 2.3s   [æ­£å¸¸]         â”‚ â”‚
â”‚  â”‚  LLMè§£æ:   P50: 1.5s  â”‚  P95: 3.2s  â”‚  P99: 5.0s   [è­¦å‘Š]         â”‚ â”‚
â”‚  â”‚  é’±é¾„è®¡ç®—:  P50: 50ms  â”‚  P95: 120ms â”‚  P99: 200ms  [æ­£å¸¸]         â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


---

# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®æ–½è®¡åˆ’

---

## 26. ç‰ˆæœ¬è¿ç§»ç­–ç•¥

æœ¬ç« è¯¦ç»†è¯´æ˜APPç‰ˆæœ¬å‡çº§è¿‡ç¨‹ä¸­çš„æ•°æ®è¿ç§»ã€å…¼å®¹æ€§ä¿éšœã€å¤‡ä»½ç­–ç•¥ç­‰æŠ€æœ¯æ–¹æ¡ˆï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®åœ¨ç‰ˆæœ¬è¿­ä»£ä¸­çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚

### 26.0 è®¾è®¡åŸåˆ™å›é¡¾

#### 24.0.1 ç‰ˆæœ¬è¿ç§»è®¾è®¡åŸåˆ™çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰ˆæœ¬è¿ç§»ç­–ç•¥ - è®¾è®¡åŸåˆ™åº”ç”¨çŸ©é˜µ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å•ä¸€èŒè´£   â”‚    â”‚ æ•°æ®ä¸€è‡´æ€§  â”‚    â”‚  æç®€è®¾è®¡   â”‚    â”‚  å¯æ‰©å±•æ€§   â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ è¿ç§»è„šæœ¬    â”‚    â”‚ å‡çº§å‰å¤‡ä»½  â”‚    â”‚ åªå¢ä¸åˆ     â”‚    â”‚ Schemaç‰ˆæœ¬  â”‚      â”‚
â”‚  â”‚ ç‹¬ç«‹ç¼–å†™    â”‚    â”‚ è¿ç§»åæ ¡éªŒ  â”‚    â”‚ å‘åå…¼å®¹    â”‚    â”‚ ç‹¬ç«‹ç®¡ç†    â”‚      â”‚
â”‚  â”‚ é€ç‰ˆæœ¬æ‰§è¡Œ  â”‚    â”‚ å¤±è´¥å¯å›æ»š  â”‚    â”‚ æ¸è¿›å¼å‡çº§  â”‚    â”‚ å¢é‡è¿ç§»    â”‚      â”‚
â”‚  â”‚ å¯æµ‹è¯•éªŒè¯  â”‚    â”‚ å®Œæ•´æ€§æ£€æŸ¥  â”‚    â”‚ æ— æ„ŸçŸ¥å‡çº§  â”‚    â”‚ ç‰ˆæœ¬é“¾æ¡    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                     ç‰ˆæœ¬è¿ç§»æ ¸å¿ƒæµç¨‹                              â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚           â”‚
â”‚  â”‚  â”‚  æ£€æµ‹ç‰ˆæœ¬ â†’ æ™ºèƒ½å¤‡ä»½ â†’ åˆ†æ‰¹è¿ç§» â†’ æ ¡éªŒå®Œæ•´ â†’ å®Œæˆå‡çº§     â”‚   â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚                                                      â”‚                â”‚
â”‚         â–¼                                                      â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æ€§èƒ½ä¼˜åŒ–   â”‚                                        â”‚  å¯è§‚æµ‹æ€§   â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ åˆ†æ‰¹å¤„ç†    â”‚                                        â”‚ è¿ç§»è¿›åº¦    â”‚        â”‚
â”‚  â”‚ æ–­ç‚¹ç»­ä¼     â”‚                                        â”‚ æ ¡éªŒæ—¥å¿—    â”‚        â”‚
â”‚  â”‚ åå°æ‰§è¡Œ    â”‚                                        â”‚ é”™è¯¯è¿½è¸ª    â”‚        â”‚
â”‚  â”‚ å¢é‡è¿ç§»    â”‚                                        â”‚ å›æ»šè®°å½•    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 24.0.2 è®¾è®¡ç†å¿µ

| è®¾è®¡ç»´åº¦ | åœ¨ç‰ˆæœ¬è¿ç§»ç³»ç»Ÿçš„ä½“ç° | å…·ä½“å®ç° |
|---------|---------------------|---------|
| **å•ä¸€èŒè´£** | æ¯ä¸ªè¿ç§»è„šæœ¬åªåšä¸€ä»¶äº‹ | Migrationç±»å°è£…å•ä¸ªç‰ˆæœ¬çš„å˜æ›´ï¼Œæ”¯æŒç‹¬ç«‹æµ‹è¯•å’Œå›æ»š |
| **æ•°æ®ä¸€è‡´æ€§** | å‡çº§å‰åæ•°æ®å®Œæ•´æ€§ä¿è¯ | å¤‡ä»½â†’è¿ç§»â†’æ ¡éªŒä¸‰æ­¥èµ°ï¼›é‡‘é¢/ä½™é¢å¼ºæ ¡éªŒï¼›å¤±è´¥è‡ªåŠ¨å›æ»š |
| **æç®€è®¾è®¡** | å¯¹ç”¨æˆ·é€æ˜çš„å‡çº§ä½“éªŒ | åªå¢ä¸åˆ å­—æ®µç­–ç•¥ï¼›å‘åå…¼å®¹è®¾è®¡ï¼›æ— éœ€ç”¨æˆ·å¹²é¢„çš„é™é»˜è¿ç§» |
| **å¯æ‰©å±•æ€§** | æ”¯æŒä»»æ„ç‰ˆæœ¬è·¨åº¦å‡çº§ | Schemaç‰ˆæœ¬ç‹¬ç«‹ç®¡ç†ï¼›ç‰ˆæœ¬é“¾å¼è¿ç§»ï¼›æ”¯æŒè·³ç‰ˆæœ¬å‡çº§ |
| **æ€§èƒ½ä¼˜åŒ–** | å¤§æ•°æ®é‡è¿ç§»ä¸å¡é¡¿ | åˆ†æ‰¹å¤„ç†(500æ¡/æ‰¹)ï¼›æ–­ç‚¹ç»­ä¼ ï¼›åå°çº¿ç¨‹æ‰§è¡Œ |
| **å¯è§‚æµ‹æ€§** | è¿ç§»è¿‡ç¨‹å®Œå…¨å¯è¿½æº¯ | è¿›åº¦å¯è§†åŒ–ï¼›è¯¦ç»†æ—¥å¿—ï¼›é”™è¯¯å †æ ˆè®°å½•ï¼›è¿ç§»æŠ¥å‘Š |

#### 24.0.3 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç‰ˆæœ¬è¿ç§»ç­–ç•¥ - ç³»ç»ŸååŒå…¨æ™¯å›¾                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚    ç‰ˆæœ¬è¿ç§»ç­–ç•¥        â”‚                              â”‚
â”‚                          â”‚  MigrationService     â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                      â”‚                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚             â”‚           â”‚               â”‚           â”‚             â”‚       â”‚
â”‚    â–¼             â–¼           â–¼               â–¼           â–¼             â–¼       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚æ•°æ®å¤‡ä»½â”‚  â”‚APPå‡çº§â”‚  â”‚é›¶åŸºé¢„ç®—   â”‚  â”‚ é’±é¾„ç³»ç»Ÿ  â”‚  â”‚æ•°æ®å¯¼å…¥â”‚  â”‚åŒæ­¥ç³»ç»Ÿ   â”‚  â”‚
â”‚ â”‚       â”‚  â”‚       â”‚  â”‚           â”‚  â”‚           â”‚  â”‚       â”‚  â”‚           â”‚  â”‚
â”‚ â”‚å‡çº§å¤‡ä»½â”‚  â”‚ç‰ˆæœ¬æ£€æµ‹â”‚  â”‚Schemaè¿ç§» â”‚  â”‚èµ„æºæ± åˆå§‹ â”‚  â”‚æ ¼å¼å…¼å®¹â”‚  â”‚å¢é‡åŒæ­¥   â”‚  â”‚
â”‚ â”‚è‡ªåŠ¨å›æ»šâ”‚  â”‚å¢é‡æ›´æ–°â”‚  â”‚å°é‡‘åº“åˆ›å»º â”‚  â”‚é’±é¾„é‡ç®—   â”‚  â”‚ç‰ˆæœ¬è½¬æ¢â”‚  â”‚å†²çªè§£å†³   â”‚  â”‚
â”‚ â”‚å®Œæ•´æ¢å¤â”‚  â”‚å¼ºåˆ¶æ›´æ–°â”‚  â”‚é¢„ç®—ç»§æ‰¿   â”‚  â”‚å†å²è¡¥ç®—   â”‚  â”‚æ•°æ®ä¿®å¤â”‚  â”‚ç‰ˆæœ¬å¯¹é½   â”‚  â”‚
â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚          â”‚            â”‚              â”‚            â”‚            â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚             è¿ç§»å®‰å…¨ä¿éšœ                      â”‚                   â”‚
â”‚              â”‚  æ™ºèƒ½å¤‡ä»½ â†’ åˆ†æ‰¹è¿ç§» â†’ å®Œæ•´æ ¡éªŒ â†’ å®‰å…¨å›æ»š   â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                         è¿ç§»è§¦å‘åœºæ™¯                                 â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ APPå‡çº§       â”‚ æ•°æ®æ¢å¤       â”‚ æ•°æ®å¯¼å…¥       â”‚ æ¢æœºè¿ç§»          â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ â€¢ ç‰ˆæœ¬å·å˜æ›´  â”‚ â€¢ å¤‡ä»½æ¢å¤     â”‚ â€¢ æ—§ç‰ˆæ•°æ®     â”‚ â€¢ æ–°è®¾å¤‡ç™»å½•      â”‚       â”‚
â”‚  â”‚ â€¢ Schemaå˜æ›´  â”‚ â€¢ äº‘ç«¯åŒæ­¥     â”‚ â€¢ æ ¼å¼è½¬æ¢     â”‚ â€¢ äº‘ç«¯æ•°æ®æ‹‰å–    â”‚       â”‚
â”‚  â”‚ â€¢ åŠŸèƒ½å¼€å…³    â”‚ â€¢ é”™è¯¯ä¿®å¤     â”‚ â€¢ æ•°æ®ä¿®å¤     â”‚ â€¢ Schemaå¯¹é½      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 26.1 æ•°æ®åº“è¿ç§»

```dart
/// æ•°æ®åº“è¿ç§»ç®¡ç†
class DatabaseMigration {
  static const int currentVersion = 20;  // 2.0 ç‰ˆæœ¬æ•°æ®åº“ç‰ˆæœ¬

  /// è¿ç§»è„šæœ¬
  static final migrations = <int, Migration>{
    // 1.x -> 2.0 æ ¸å¿ƒè¿ç§»
    15: Migration(
      description: 'æ·»åŠ å°é‡‘åº“è¡¨',
      up: '''
        CREATE TABLE IF NOT EXISTS budget_vaults (
          id TEXT PRIMARY KEY,
          name TEXT NOT NULL,
          type TEXT NOT NULL,
          target_amount REAL DEFAULT 0,
          allocated_amount REAL DEFAULT 0,
          spent_amount REAL DEFAULT 0,
          -- ...
        );
      ''',
    ),

    16: Migration(
      description: 'æ·»åŠ èµ„æºæ± è¡¨ï¼ˆé’±é¾„è®¡ç®—ï¼‰',
      up: '''
        CREATE TABLE IF NOT EXISTS resource_pools (
          id TEXT PRIMARY KEY,
          income_transaction_id TEXT NOT NULL,
          original_amount REAL NOT NULL,
          remaining_amount REAL NOT NULL,
          created_at TEXT NOT NULL
        );

        CREATE TABLE IF NOT EXISTS resource_consumptions (
          id TEXT PRIMARY KEY,
          pool_id TEXT NOT NULL,
          transaction_id TEXT NOT NULL,
          amount REAL NOT NULL,
          age_at_consumption INTEGER NOT NULL,
          created_at TEXT NOT NULL
        );
      ''',
    ),

    17: Migration(
      description: 'äº¤æ˜“è¡¨æ·»åŠ å°é‡‘åº“å…³è”',
      up: '''
        ALTER TABLE transactions ADD COLUMN vault_id TEXT;
      ''',
    ),

    18: Migration(
      description: 'åˆå§‹åŒ–å†å²æ•°æ®çš„èµ„æºæ± ',
      up: _initializeResourcePools,
    ),

    // ...
  };

  /// åˆå§‹åŒ–å†å²æ•°æ®çš„èµ„æºæ± 
  static Future<void> _initializeResourcePools(Database db) async {
    // è·å–æ‰€æœ‰å†å²æ”¶å…¥
    final incomes = await db.query('transactions',
      where: 'type = ?',
      whereArgs: ['income'],
      orderBy: 'date ASC',
    );

    for (final income in incomes) {
      await db.insert('resource_pools', {
        'id': generateId(),
        'income_transaction_id': income['id'],
        'original_amount': income['amount'],
        'remaining_amount': income['amount'],
        'created_at': income['date'],
      });
    }

    // é‡æ–°è®¡ç®—æ‰€æœ‰æ”¯å‡ºçš„é’±é¾„
    // ...
  }
}
```

### 26.2 åŠŸèƒ½å¼€å…³

```dart
/// åŠŸèƒ½å¼€å…³æœåŠ¡
class FeatureFlagService {
  /// 2.0 æ–°åŠŸèƒ½å¼€å…³
  static const Map<String, FeatureFlag> flags = {
    'money_age': FeatureFlag(
      name: 'é’±é¾„åˆ†æ',
      description: 'è¿½è¸ªæ‚¨èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…å‰èµšçš„',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'zero_based_budget': FeatureFlag(
      name: 'é›¶åŸºé¢„ç®—',
      description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰æ˜ç¡®ç”¨é€”',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'vaults': FeatureFlag(
      name: 'å°é‡‘åº“',
      description: 'å°†é¢„ç®—åˆ†é…åˆ°ä¸åŒçš„å°é‡‘åº“',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
    'smart_import': FeatureFlag(
      name: 'æ™ºèƒ½å¯¼å…¥',
      description: 'æ™ºèƒ½è§£æè´¦å•å¹¶è‡ªåŠ¨å»é‡',
      defaultEnabled: true,
      minimumVersion: '2.0.0',
    ),
  };

  /// æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  Future<bool> isEnabled(String flagName) async {
    final flag = flags[flagName];
    if (flag == null) return false;

    // æ£€æŸ¥ç‰ˆæœ¬è¦æ±‚
    final currentVersion = await _getAppVersion();
    if (!_meetsVersionRequirement(currentVersion, flag.minimumVersion)) {
      return false;
    }

    // æ£€æŸ¥ç”¨æˆ·è®¾ç½®
    final userSettings = await _getUserFeatureSettings();
    return userSettings[flagName] ?? flag.defaultEnabled;
  }
}
```

### 26.3 æ¸è¿›å¼å‡çº§å¼•å¯¼

```dart
/// å‡çº§å¼•å¯¼é¡µé¢
class UpgradeGuidePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: PageView(
        children: [
          // æ¬¢è¿é¡µ
          _WelcomePage(),

          // é’±é¾„åŠŸèƒ½ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šé’±é¾„åˆ†æ',
            description: 'äº†è§£æ‚¨èŠ±çš„æ¯ä¸€åˆ†é’±æ˜¯å¤šä¹…å‰èµšçš„ï¼Œ\nè®©è´¢åŠ¡æ›´é€æ˜',
            illustration: 'assets/illustrations/money_age.png',
          ),

          // é›¶åŸºé¢„ç®—ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šé›¶åŸºé¢„ç®—',
            description: 'è®©æ¯ä¸€åˆ†é’±éƒ½æœ‰å»å¤„ï¼Œ\nå‘Šåˆ«æ— è®¡åˆ’æ¶ˆè´¹',
            illustration: 'assets/illustrations/zero_budget.png',
          ),

          // å°é‡‘åº“ä»‹ç»
          _FeatureIntroPage(
            title: 'å…¨æ–°åŠŸèƒ½ï¼šå°é‡‘åº“',
            description: 'åƒå­˜é’±ç½ä¸€æ ·ç®¡ç†é¢„ç®—ï¼Œ\næ›´ç›´è§‚æ›´æœ‰è¶£',
            illustration: 'assets/illustrations/vaults.png',
          ),

          // å¼€å§‹ä½¿ç”¨
          _GetStartedPage(),
        ],
      ),
    );
  }
}
```

### 26.4 æ•°æ®å…¼å®¹æ€§ç­–ç•¥

#### 26.4.1 æ•°æ®å…¼å®¹æ€§åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å…¼å®¹æ€§æ ¸å¿ƒåŸåˆ™                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  åŸåˆ™ä¸€ï¼šåªå¢ä¸åˆ ï¼ˆAdditive Onlyï¼‰                                         â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“å­—æ®µåªå¢åŠ ï¼Œä¸åˆ é™¤å·²æœ‰å­—æ®µ                                       â”‚
â”‚  â”œâ”€â”€ æ–°å­—æ®µå¿…é¡»æœ‰é»˜è®¤å€¼æˆ–å…è®¸NULL                                          â”‚
â”‚  â””â”€â”€ åºŸå¼ƒå­—æ®µæ ‡è®°ä¸ºdeprecatedï¼Œä¿ç•™è‡³å°‘2ä¸ªå¤§ç‰ˆæœ¬                            â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™äºŒï¼šå‘åå…¼å®¹ï¼ˆBackward Compatibleï¼‰                                   â”‚
â”‚  â”œâ”€â”€ æ–°ç‰ˆæœ¬APPèƒ½è¯»å–æ—§ç‰ˆæœ¬æ•°æ®                                             â”‚
â”‚  â”œâ”€â”€ æ—§ç‰ˆæœ¬APPèƒ½è¯»å–æ–°ç‰ˆæœ¬æ•°æ®ï¼ˆå¿½ç•¥æœªçŸ¥å­—æ®µï¼‰                               â”‚
â”‚  â””â”€â”€ æ•°æ®æ ¼å¼å˜æ›´å¿…é¡»æä¾›è½¬æ¢å™¨                                            â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™ä¸‰ï¼šå‡çº§å‰å¤‡ä»½ï¼ˆBackup Before Upgradeï¼‰                                â”‚
â”‚  â”œâ”€â”€ é‡å¤§å‡çº§å‰è‡ªåŠ¨åˆ›å»ºæ•°æ®å¤‡ä»½                                            â”‚
â”‚  â”œâ”€â”€ å¤‡ä»½åŒ…å«å®Œæ•´æ•°æ®åº“å’Œé…ç½®                                              â”‚
â”‚  â””â”€â”€ ä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬çš„å¤‡ä»½                                                 â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™å››ï¼šæ¸è¿›å¼è¿ç§»ï¼ˆProgressive Migrationï¼‰                                â”‚
â”‚  â”œâ”€â”€ å¤§é‡æ•°æ®è¿ç§»åˆ†æ‰¹æ‰§è¡Œï¼Œé¿å…ANR                                         â”‚
â”‚  â”œâ”€â”€ è¿ç§»è¿‡ç¨‹å¯ä¸­æ–­å¯æ¢å¤                                                  â”‚
â”‚  â””â”€â”€ è¿ç§»è¿›åº¦å¯è§†åŒ–å±•ç¤º                                                   â”‚
â”‚                                                                          â”‚
â”‚  åŸåˆ™äº”ï¼šæ•°æ®æ ¡éªŒï¼ˆData Validationï¼‰                                        â”‚
â”‚  â”œâ”€â”€ è¿ç§»å‰åæ•°æ®å®Œæ•´æ€§æ ¡éªŒ                                                â”‚
â”‚  â”œâ”€â”€ å…³é”®æ•°æ®ï¼ˆé‡‘é¢ã€ä½™é¢ï¼‰å¿…é¡»æ ¡éªŒä¸€è‡´                                     â”‚
â”‚  â””â”€â”€ æ ¡éªŒå¤±è´¥åˆ™å›æ»šå¹¶æŠ¥å‘Š                                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 26.4.2 æ•°æ®åº“Schemaç‰ˆæœ¬ç®¡ç†

```dart
/// Schemaç‰ˆæœ¬ç®¡ç†å™¨
class SchemaVersionManager {
  /// ç‰ˆæœ¬å†å²è®°å½•
  static const Map<int, SchemaVersion> versions = {
    1: SchemaVersion(
      version: 1,
      description: 'åˆå§‹ç‰ˆæœ¬ - åŸºç¡€è®°è´¦åŠŸèƒ½',
      releaseDate: '2025-01-01',
      tables: ['transactions', 'categories', 'accounts'],
    ),
    15: SchemaVersion(
      version: 15,
      description: '2.0 Alpha - å°é‡‘åº“æ”¯æŒ',
      releaseDate: '2025-06-01',
      tables: ['budget_vaults', 'vault_allocations'],
      addedColumns: {'transactions': ['vault_id']},
    ),
    16: SchemaVersion(
      version: 16,
      description: '2.0 Alpha - é’±é¾„è®¡ç®—',
      releaseDate: '2025-06-15',
      tables: ['resource_pools', 'resource_consumptions'],
    ),
    20: SchemaVersion(
      version: 20,
      description: '2.0 Release - å®Œæ•´åŠŸèƒ½',
      releaseDate: '2025-09-01',
      tables: ['locations', 'habits', 'achievements'],
      addedColumns: {
        'transactions': ['location_id', 'context_type'],
        'budgets': ['carry_over_enabled', 'carry_over_mode'],
      },
    ),
  };

  /// è·å–ä¸¤ä¸ªç‰ˆæœ¬é—´çš„å·®å¼‚
  static SchemaDiff getDiff(int fromVersion, int toVersion) {
    final addedTables = <String>[];
    final addedColumns = <String, List<String>>{};
    final migrations = <int>[];

    for (var v = fromVersion + 1; v <= toVersion; v++) {
      final version = versions[v];
      if (version != null) {
        addedTables.addAll(version.tables);
        version.addedColumns?.forEach((table, columns) {
          addedColumns.putIfAbsent(table, () => []).addAll(columns);
        });
        migrations.add(v);
      }
    }

    return SchemaDiff(
      fromVersion: fromVersion,
      toVersion: toVersion,
      addedTables: addedTables,
      addedColumns: addedColumns,
      requiredMigrations: migrations,
    );
  }
}

/// Schemaç‰ˆæœ¬å®šä¹‰
class SchemaVersion {
  final int version;
  final String description;
  final String releaseDate;
  final List<String> tables;
  final Map<String, List<String>>? addedColumns;
  final Map<String, List<String>>? deprecatedColumns;

  const SchemaVersion({
    required this.version,
    required this.description,
    required this.releaseDate,
    required this.tables,
    this.addedColumns,
    this.deprecatedColumns,
  });
}
```

#### 26.4.3 ç‰ˆæœ¬å‘å¸ƒå…ƒæ•°æ®

æ¯æ¬¡æ‰“åŒ…å‘å¸ƒæ—¶ï¼Œå¿…é¡»åœ¨ç‰ˆæœ¬å…ƒæ•°æ®ä¸­æ ‡æ³¨æ˜¯å¦å­˜åœ¨æ•°æ®åº“å˜åŠ¨ï¼Œç”¨äºå®¢æˆ·ç«¯æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½ã€‚

```yaml
# pubspec.yaml æˆ–ç‹¬ç«‹çš„ version_metadata.yaml
version: 1.2.23+40

# ç‰ˆæœ¬å…ƒæ•°æ®ï¼ˆæ„å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆåˆ° assets/version_metadata.jsonï¼‰
metadata:
  release_date: "2026-01-15"

  # æ•°æ®åº“å˜åŠ¨æ ‡è®°ï¼ˆå…³é”®å­—æ®µï¼‰
  database_changes: true          # æ˜¯å¦æœ‰æ•°æ®åº“å˜åŠ¨
  schema_version: 21              # ç›®æ ‡Schemaç‰ˆæœ¬
  previous_schema_version: 20     # ä¸Šä¸€ç‰ˆæœ¬Schemaç‰ˆæœ¬

  # å˜åŠ¨è¯¦æƒ…ï¼ˆç”¨äºå±•ç¤ºç»™ç”¨æˆ·ï¼‰
  migration_notes:
    - "æ–°å¢ä¹ æƒ¯è¿½è¸ªè¡¨ (habits)"
    - "äº¤æ˜“è¡¨å¢åŠ  recurring_id å­—æ®µ"

  # å¤‡ä»½å»ºè®®çº§åˆ«
  backup_level: required          # required(å¿…é¡») / recommended(å»ºè®®) / optional(å¯é€‰)

  # è¿ç§»é¢„ä¼°æ—¶é—´ï¼ˆç§’ï¼Œç”¨äºè¿›åº¦å±•ç¤ºï¼‰
  estimated_migration_time: 30

  # æœ€ä½å…¼å®¹ç‰ˆæœ¬ï¼ˆä½äºæ­¤ç‰ˆæœ¬å¿…é¡»å¼ºåˆ¶å‡çº§ï¼‰
  min_compatible_version: "1.2.0"
```

```dart
/// ç‰ˆæœ¬å…ƒæ•°æ®æ¨¡å‹
class VersionMetadata {
  final String version;
  final String releaseDate;

  /// æ•°æ®åº“å˜åŠ¨ç›¸å…³
  final bool databaseChanges;
  final int schemaVersion;
  final int previousSchemaVersion;
  final List<String> migrationNotes;
  final BackupLevel backupLevel;
  final int estimatedMigrationTime;

  /// å…¼å®¹æ€§
  final String minCompatibleVersion;

  VersionMetadata({
    required this.version,
    required this.releaseDate,
    required this.databaseChanges,
    required this.schemaVersion,
    required this.previousSchemaVersion,
    this.migrationNotes = const [],
    this.backupLevel = BackupLevel.optional,
    this.estimatedMigrationTime = 0,
    required this.minCompatibleVersion,
  });

  factory VersionMetadata.fromJson(Map<String, dynamic> json) {
    return VersionMetadata(
      version: json['version'] as String,
      releaseDate: json['release_date'] as String,
      databaseChanges: json['database_changes'] as bool? ?? false,
      schemaVersion: json['schema_version'] as int,
      previousSchemaVersion: json['previous_schema_version'] as int,
      migrationNotes: (json['migration_notes'] as List<dynamic>?)
          ?.cast<String>() ?? [],
      backupLevel: BackupLevel.fromString(json['backup_level'] as String?),
      estimatedMigrationTime: json['estimated_migration_time'] as int? ?? 0,
      minCompatibleVersion: json['min_compatible_version'] as String,
    );
  }

  /// æ˜¯å¦éœ€è¦å¤‡ä»½
  bool get requiresBackup =>
    databaseChanges || backupLevel == BackupLevel.required;

  /// æ˜¯å¦å»ºè®®å¤‡ä»½
  bool get shouldBackup =>
    requiresBackup || backupLevel == BackupLevel.recommended;
}

enum BackupLevel {
  required,     // å¿…é¡»å¤‡ä»½ï¼ˆæœ‰æ•°æ®åº“å˜åŠ¨ï¼‰
  recommended,  // å»ºè®®å¤‡ä»½ï¼ˆé‡å¤§åŠŸèƒ½æ›´æ–°ï¼‰
  optional;     // å¯é€‰å¤‡ä»½ï¼ˆå°ç‰ˆæœ¬æ›´æ–°ï¼‰

  static BackupLevel fromString(String? value) {
    switch (value) {
      case 'required': return BackupLevel.required;
      case 'recommended': return BackupLevel.recommended;
      default: return BackupLevel.optional;
    }
  }
}

/// æ„å»ºè„šæœ¬ï¼šè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å…ƒæ•°æ®
/// åœ¨ scripts/build.dart ä¸­è°ƒç”¨
class VersionMetadataGenerator {
  /// ç”Ÿæˆç‰ˆæœ¬å…ƒæ•°æ®æ–‡ä»¶
  static Future<void> generate({
    required String version,
    required int buildNumber,
    required bool hasDatabaseChanges,
    required int schemaVersion,
    List<String>? migrationNotes,
  }) async {
    // è¯»å–ä¸Šä¸€ç‰ˆæœ¬çš„ schema_version
    final previousMetadata = await _loadPreviousMetadata();
    final previousSchemaVersion = previousMetadata?.schemaVersion ?? schemaVersion;

    final metadata = {
      'version': version,
      'build_number': buildNumber,
      'release_date': DateTime.now().toIso8601String().substring(0, 10),
      'database_changes': hasDatabaseChanges,
      'schema_version': schemaVersion,
      'previous_schema_version': previousSchemaVersion,
      'migration_notes': migrationNotes ?? [],
      'backup_level': hasDatabaseChanges ? 'required' : 'optional',
      'estimated_migration_time': hasDatabaseChanges ? _estimateMigrationTime() : 0,
      'min_compatible_version': '1.2.0',
    };

    final file = File('app/assets/version_metadata.json');
    await file.writeAsString(JsonEncoder.withIndent('  ').convert(metadata));

    print('âœ“ å·²ç”Ÿæˆ version_metadata.json');
    if (hasDatabaseChanges) {
      print('  âš ï¸ æ­¤ç‰ˆæœ¬åŒ…å«æ•°æ®åº“å˜åŠ¨ï¼Œå‡çº§æ—¶å°†è§¦å‘å¤‡ä»½');
    }
  }
}
```

#### 26.4.4 æ™ºèƒ½å‡çº§å¤‡ä»½ç­–ç•¥

åŸºäºç‰ˆæœ¬å…ƒæ•°æ®ï¼Œæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨å‡çº§å‰è¿›è¡Œå¤‡ä»½ï¼Œé¿å…æ— æ•ˆå¤‡ä»½ã€‚

**å¤‡ä»½å­˜å‚¨ä½ç½®è¯´æ˜ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤‡ä»½å­˜å‚¨ç­–ç•¥                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  å¤‡ä»½ç±»å‹            å­˜å‚¨ä½ç½®        ç”¨é€”                  ä¿ç•™ç­–ç•¥        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  å‡çº§å¤‡ä»½            æœ¬åœ°            å‡çº§å¤±è´¥å¿«é€Ÿå›æ»š      ä¿ç•™æœ€è¿‘3ä¸ª      â”‚
â”‚  æ‰‹åŠ¨å¤‡ä»½            æœ¬åœ°+äº‘ç«¯       ç”¨æˆ·ä¸»åŠ¨å¤‡ä»½          ç”¨æˆ·è‡ªå®šä¹‰       â”‚
â”‚  è‡ªåŠ¨å®šæœŸå¤‡ä»½        äº‘ç«¯            æ•°æ®å®‰å…¨/æ¢æœºæ¢å¤     æœ€è¿‘7å¤©+æœˆå¤‡ä»½   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å‡çº§å¤‡ä»½é€‰æ‹©ã€æœ¬åœ°ã€‘çš„åŸå› ï¼š                                      â”‚    â”‚
â”‚  â”‚  â€¢ é€Ÿåº¦å¿«ï¼šæœ¬åœ°IOæ— ç½‘ç»œå»¶è¿Ÿï¼Œå‡çº§ä½“éªŒæµç•…                         â”‚    â”‚
â”‚  â”‚  â€¢ ç¦»çº¿å¯ç”¨ï¼šæ— ç½‘ç»œæ—¶ä¹Ÿèƒ½å®Œæˆå‡çº§                                 â”‚    â”‚
â”‚  â”‚  â€¢ ä¸´æ—¶æ€§ï¼šä»…ç”¨äºå‡çº§å›æ»šï¼ŒæˆåŠŸåå¯æ¸…ç†                           â”‚    â”‚
â”‚  â”‚  â€¢ éšç§å®‰å…¨ï¼šæ•æ„Ÿæ•°æ®ä¸ç»è¿‡ç½‘ç»œä¼ è¾“                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  äº‘ç«¯å¤‡ä»½çš„è§¦å‘æ—¶æœºï¼š                                              â”‚    â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"å¤‡ä»½åˆ°äº‘ç«¯"                                        â”‚    â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨å®šæœŸå¤‡ä»½ï¼ˆå¯åœ¨è®¾ç½®ä¸­å¼€å¯ï¼Œé»˜è®¤å…³é—­ï¼‰                        â”‚    â”‚
â”‚  â”‚  â€¢ æ¢æœºæ¢å¤æµç¨‹ä¸­ä»äº‘ç«¯æ‹‰å–                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ™ºèƒ½å¤‡ä»½å†³ç­–æµç¨‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ™ºèƒ½å¤‡ä»½å†³ç­–æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬å¯ç”¨                                                       â”‚
â”‚       â†“                                                                   â”‚
â”‚  2. ä¸‹è½½æ–°ç‰ˆæœ¬çš„ version_metadata.json                                    â”‚
â”‚       â†“                                                                   â”‚
â”‚  3. æ£€æŸ¥ database_changes å­—æ®µ                                            â”‚
â”‚       â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ database_changes â”‚                   å¤„ç†æ–¹å¼                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚     true       â”‚ æœ¬åœ°å¤‡ä»½ â†’ æ˜¾ç¤ºå¤‡ä»½è¿›åº¦ â†’ æ‰§è¡Œè¿ç§»               â”‚   â”‚
â”‚  â”‚     false      â”‚ è·³è¿‡å¤‡ä»½ â†’ ç›´æ¥å®‰è£…æ›´æ–°                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  4. ç”¨æˆ·å¯é€‰æ‹©æ‰‹åŠ¨å¤‡ä»½ï¼ˆè®¾ç½® â†’ æ•°æ®å¤‡ä»½ â†’ å¤‡ä»½åˆ°äº‘ç«¯ï¼‰                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```dart
/// æ™ºèƒ½å‡çº§æœåŠ¡
class SmartUpgradeService {
  final UpgradeBackupService _backupService;
  final HttpService _http;

  /// æ£€æŸ¥å‡çº§å¹¶å†³å®šæ˜¯å¦éœ€è¦å¤‡ä»½
  Future<UpgradeDecision> checkUpgrade() async {
    // 1. è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
    final currentVersion = BuildInfo.version;
    final currentSchemaVersion = await _db.getSchemaVersion();

    // 2. ä»æœåŠ¡å™¨è·å–æœ€æ–°ç‰ˆæœ¬å…ƒæ•°æ®
    final latestMetadata = await _fetchLatestVersionMetadata();

    if (latestMetadata == null) {
      return UpgradeDecision.noUpdate();
    }

    // 3. æ¯”è¾ƒç‰ˆæœ¬
    if (!_isNewerVersion(latestMetadata.version, currentVersion)) {
      return UpgradeDecision.noUpdate();
    }

    // 4. åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½
    final needsBackup = latestMetadata.databaseChanges ||
        latestMetadata.schemaVersion > currentSchemaVersion;

    return UpgradeDecision(
      hasUpdate: true,
      currentVersion: currentVersion,
      newVersion: latestMetadata.version,
      needsBackup: needsBackup,
      backupLevel: latestMetadata.backupLevel,
      migrationNotes: latestMetadata.migrationNotes,
      estimatedMigrationTime: latestMetadata.estimatedMigrationTime,
    );
  }

  /// æ‰§è¡Œå‡çº§ï¼ˆæ ¹æ®å†³ç­–è‡ªåŠ¨å¤„ç†å¤‡ä»½ï¼‰
  Stream<UpgradeProgress> executeUpgrade(UpgradeDecision decision) async* {
    if (decision.needsBackup) {
      // éœ€è¦å¤‡ä»½ï¼šæ˜¾ç¤ºå¤‡ä»½é˜¶æ®µ
      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'æ­£åœ¨å¤‡ä»½æ•°æ®...',
        progress: 0.1,
      );

      final backupResult = await _backupService.createUpgradeBackup(
        fromVersion: decision.currentVersion,
        toVersion: decision.newVersion,
      );

      if (!backupResult.isSuccess) {
        yield UpgradeProgress(
          phase: UpgradePhase.failed,
          message: 'å¤‡ä»½å¤±è´¥: ${backupResult.error}',
        );
        return;
      }

      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'å¤‡ä»½å®Œæˆ',
        progress: 0.2,
      );
    } else {
      // æ— éœ€å¤‡ä»½ï¼šç›´æ¥è¿›å…¥å®‰è£…é˜¶æ®µ
      yield UpgradeProgress(
        phase: UpgradePhase.installing,
        message: 'æ— æ•°æ®åº“å˜åŠ¨ï¼Œè·³è¿‡å¤‡ä»½',
        progress: 0.2,
      );
    }

    // ç»§ç»­æ‰§è¡Œå®‰è£…å’Œè¿ç§»...
    yield* _executeInstallAndMigrate(decision);
  }

  /// è·å–æœ€æ–°ç‰ˆæœ¬å…ƒæ•°æ®
  Future<VersionMetadata?> _fetchLatestVersionMetadata() async {
    try {
      final response = await _http.get('/api/app-versions/latest/metadata');
      if (response.isSuccess) {
        return VersionMetadata.fromJson(response.data);
      }
    } catch (_) {}
    return null;
  }
}

/// å‡çº§å†³ç­–
class UpgradeDecision {
  final bool hasUpdate;
  final String currentVersion;
  final String newVersion;
  final bool needsBackup;
  final BackupLevel backupLevel;
  final List<String> migrationNotes;
  final int estimatedMigrationTime;

  UpgradeDecision({
    required this.hasUpdate,
    this.currentVersion = '',
    this.newVersion = '',
    this.needsBackup = false,
    this.backupLevel = BackupLevel.optional,
    this.migrationNotes = const [],
    this.estimatedMigrationTime = 0,
  });

  factory UpgradeDecision.noUpdate() => UpgradeDecision(hasUpdate: false);

  /// å‡çº§æè¿°ï¼ˆå±•ç¤ºç»™ç”¨æˆ·ï¼‰
  String get description {
    if (!hasUpdate) return 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';

    final buffer = StringBuffer('å‘ç°æ–°ç‰ˆæœ¬ $newVersion\n');

    if (needsBackup) {
      buffer.writeln('âš ï¸ æ­¤ç‰ˆæœ¬åŒ…å«æ•°æ®åº“å˜åŠ¨ï¼Œå‡çº§å‰å°†è‡ªåŠ¨å¤‡ä»½');
    }

    if (migrationNotes.isNotEmpty) {
      buffer.writeln('\næ›´æ–°å†…å®¹ï¼š');
      for (final note in migrationNotes) {
        buffer.writeln('â€¢ $note');
      }
    }

    if (estimatedMigrationTime > 0) {
      buffer.writeln('\né¢„è®¡è¿ç§»æ—¶é—´ï¼šçº¦ ${estimatedMigrationTime} ç§’');
    }

    return buffer.toString();
  }
}
```

```dart
/// å‡çº§å¤‡ä»½æœåŠ¡
class UpgradeBackupService {
  final DatabaseService _db;
  final FileService _fileService;

  /// å¤‡ä»½ç›®å½•
  static const String backupDir = 'backups/upgrade';

  /// æœ€å¤§ä¿ç•™å¤‡ä»½æ•°
  static const int maxBackups = 3;

  /// æ™ºèƒ½å¤‡ä»½ï¼šä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ
  Future<BackupResult?> smartBackup({
    required UpgradeDecision decision,
  }) async {
    // ä¸éœ€è¦å¤‡ä»½æ—¶ç›´æ¥è¿”å›
    if (!decision.needsBackup) {
      return null;  // null è¡¨ç¤ºè·³è¿‡å¤‡ä»½
    }

    return createUpgradeBackup(
      fromVersion: decision.currentVersion,
      toVersion: decision.newVersion,
    );
  }

  /// æ‰§è¡Œå‡çº§å‰å¤‡ä»½
  Future<BackupResult> createUpgradeBackup({
    required String fromVersion,
    required String toVersion,
  }) async {
    final backupId = '${fromVersion}_to_${toVersion}_${DateTime.now().millisecondsSinceEpoch}';
    final backupPath = '$backupDir/$backupId';

    try {
      // 1. åˆ›å»ºå¤‡ä»½ç›®å½•
      await _fileService.createDirectory(backupPath);

      // 2. å¤‡ä»½æ•°æ®åº“
      final dbBackupPath = '$backupPath/database.db';
      await _db.backup(dbBackupPath);

      // 3. å¤‡ä»½é…ç½®æ–‡ä»¶
      final configBackupPath = '$backupPath/config.json';
      await _backupConfig(configBackupPath);

      // 4. è®°å½•å¤‡ä»½å…ƒä¿¡æ¯
      final metadata = BackupMetadata(
        id: backupId,
        fromVersion: fromVersion,
        toVersion: toVersion,
        createdAt: DateTime.now(),
        dbSize: await _fileService.getFileSize(dbBackupPath),
        tables: await _getTableCounts(),
      );
      await _saveMetadata('$backupPath/metadata.json', metadata);

      // 5. æ¸…ç†æ—§å¤‡ä»½
      await _cleanupOldBackups();

      return BackupResult.success(
        backupId: backupId,
        path: backupPath,
        metadata: metadata,
      );
    } catch (e) {
      return BackupResult.failed(error: e);
    }
  }

  /// ä»å¤‡ä»½æ¢å¤
  Future<RestoreResult> restoreFromBackup(String backupId) async {
    final backupPath = '$backupDir/$backupId';

    // 1. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
    if (!await _validateBackup(backupPath)) {
      return RestoreResult.failed(error: 'å¤‡ä»½æ–‡ä»¶æŸåæˆ–ä¸å®Œæ•´');
    }

    // 2. å…³é—­å½“å‰æ•°æ®åº“è¿æ¥
    await _db.close();

    // 3. æ¢å¤æ•°æ®åº“
    await _fileService.copy(
      '$backupPath/database.db',
      _db.databasePath,
    );

    // 4. æ¢å¤é…ç½®
    await _restoreConfig('$backupPath/config.json');

    // 5. é‡æ–°æ‰“å¼€æ•°æ®åº“
    await _db.open();

    return RestoreResult.success(restoredVersion: backupId);
  }

  /// è·å–å¯ç”¨å¤‡ä»½åˆ—è¡¨
  Future<List<BackupMetadata>> getAvailableBackups() async {
    final backups = <BackupMetadata>[];
    final dirs = await _fileService.listDirectories(backupDir);

    for (final dir in dirs) {
      try {
        final metadata = await _loadMetadata('$dir/metadata.json');
        backups.add(metadata);
      } catch (_) {
        // å¿½ç•¥æ— æ•ˆå¤‡ä»½
      }
    }

    return backups..sort((a, b) => b.createdAt.compareTo(a.createdAt));
  }
}

/// å¤‡ä»½å…ƒæ•°æ®
class BackupMetadata {
  final String id;
  final String fromVersion;
  final String toVersion;
  final DateTime createdAt;
  final int dbSize;
  final Map<String, int> tables; // è¡¨å -> è®°å½•æ•°

  BackupMetadata({
    required this.id,
    required this.fromVersion,
    required this.toVersion,
    required this.createdAt,
    required this.dbSize,
    required this.tables,
  });

  /// å¤‡ä»½æè¿°
  String get description =>
    'ä» v$fromVersion å‡çº§åˆ° v$toVersion (${createdAt.toString().substring(0, 16)})';
}

/// å¤‡ä»½å­˜å‚¨ä½ç½®
enum BackupStorage {
  local,   // æœ¬åœ°å­˜å‚¨ï¼ˆå‡çº§å¤‡ä»½ï¼‰
  cloud,   // äº‘ç«¯å­˜å‚¨ï¼ˆæ‰‹åŠ¨/å®šæœŸå¤‡ä»½ï¼‰
  both,    // æœ¬åœ°+äº‘ç«¯ï¼ˆæ‰‹åŠ¨å¤‡ä»½å¯é€‰ï¼‰
}

/// ç»Ÿä¸€å¤‡ä»½æœåŠ¡ï¼ˆæ”¯æŒæœ¬åœ°å’Œäº‘ç«¯ï¼‰
class UnifiedBackupService {
  final UpgradeBackupService _localBackup;
  final CloudBackupService _cloudBackup;

  /// åˆ›å»ºå¤‡ä»½
  Future<BackupResult> createBackup({
    required BackupStorage storage,
    String? description,
  }) async {
    switch (storage) {
      case BackupStorage.local:
        return _localBackup.createManualBackup(description: description);

      case BackupStorage.cloud:
        // å…ˆåˆ›å»ºæœ¬åœ°ä¸´æ—¶å¤‡ä»½ï¼Œå†ä¸Šä¼ åˆ°äº‘ç«¯
        final localResult = await _localBackup.createManualBackup(
          description: description,
          temporary: true,
        );
        if (!localResult.isSuccess) return localResult;

        final cloudResult = await _cloudBackup.upload(localResult.path!);
        // ä¸Šä¼ æˆåŠŸååˆ é™¤ä¸´æ—¶æœ¬åœ°å¤‡ä»½
        if (cloudResult.isSuccess) {
          await _localBackup.deleteBackup(localResult.backupId!);
        }
        return cloudResult;

      case BackupStorage.both:
        // æœ¬åœ°ä¿ç•™ä¸€ä»½ï¼Œäº‘ç«¯ä¸Šä¼ ä¸€ä»½
        final localResult = await _localBackup.createManualBackup(
          description: description,
        );
        if (localResult.isSuccess) {
          // å¼‚æ­¥ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œä¸é˜»å¡
          _cloudBackup.upload(localResult.path!).catchError((e) {
            // äº‘ç«¯ä¸Šä¼ å¤±è´¥ä¸å½±å“æœ¬åœ°å¤‡ä»½
            _logger.warning('äº‘ç«¯å¤‡ä»½ä¸Šä¼ å¤±è´¥: $e');
          });
        }
        return localResult;
    }
  }

  /// è·å–æ‰€æœ‰å¯ç”¨å¤‡ä»½ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
  Future<List<BackupInfo>> getAllBackups() async {
    final localBackups = await _localBackup.getAvailableBackups();
    final cloudBackups = await _cloudBackup.listBackups();

    return [
      ...localBackups.map((b) => BackupInfo.fromLocal(b)),
      ...cloudBackups.map((b) => BackupInfo.fromCloud(b)),
    ]..sort((a, b) => b.createdAt.compareTo(a.createdAt));
  }
}

/// äº‘ç«¯å¤‡ä»½æœåŠ¡
class CloudBackupService {
  final HttpService _http;
  final AuthService _auth;

  /// ä¸Šä¼ å¤‡ä»½åˆ°äº‘ç«¯
  Future<BackupResult> upload(String localPath) async {
    try {
      // 1. å‹ç¼©å¤‡ä»½æ–‡ä»¶
      final compressedPath = await _compress(localPath);

      // 2. è·å–ä¸Šä¼ å‡­è¯
      final uploadToken = await _http.post('/api/backups/upload-token');

      // 3. åˆ†ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰
      final result = await _uploadWithProgress(
        filePath: compressedPath,
        uploadUrl: uploadToken.data['url'],
      );

      // 4. é€šçŸ¥æœåŠ¡å™¨ä¸Šä¼ å®Œæˆ
      await _http.post('/api/backups/complete', body: {
        'backup_id': result.backupId,
        'size': result.size,
        'checksum': result.checksum,
      });

      return BackupResult.success(
        backupId: result.backupId,
        storage: BackupStorage.cloud,
      );
    } catch (e) {
      return BackupResult.failed(error: e);
    }
  }

  /// ä»äº‘ç«¯æ¢å¤
  Future<RestoreResult> restore(String cloudBackupId) async {
    try {
      // 1. è·å–ä¸‹è½½é“¾æ¥
      final downloadInfo = await _http.get('/api/backups/$cloudBackupId/download');

      // 2. ä¸‹è½½åˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•
      final localPath = await _downloadWithProgress(
        url: downloadInfo.data['url'],
        expectedSize: downloadInfo.data['size'],
      );

      // 3. è§£å‹
      final extractedPath = await _extract(localPath);

      // 4. æ¢å¤æ•°æ®åº“
      return _localBackup.restoreFromPath(extractedPath);
    } catch (e) {
      return RestoreResult.failed(error: e);
    }
  }

  /// è·å–äº‘ç«¯å¤‡ä»½åˆ—è¡¨
  Future<List<CloudBackupMetadata>> listBackups() async {
    final response = await _http.get('/api/backups');
    return (response.data as List)
        .map((json) => CloudBackupMetadata.fromJson(json))
        .toList();
  }

  /// åˆ é™¤äº‘ç«¯å¤‡ä»½
  Future<void> deleteBackup(String backupId) async {
    await _http.delete('/api/backups/$backupId');
  }
}

/// äº‘ç«¯å¤‡ä»½å…ƒæ•°æ®
class CloudBackupMetadata {
  final String id;
  final String version;
  final DateTime createdAt;
  final int size;
  final String? description;
  final String deviceName;

  CloudBackupMetadata({
    required this.id,
    required this.version,
    required this.createdAt,
    required this.size,
    this.description,
    required this.deviceName,
  });
}
```

#### 26.4.5 æ¸è¿›å¼æ•°æ®è¿ç§»

```dart
/// æ¸è¿›å¼è¿ç§»æ‰§è¡Œå™¨
class ProgressiveMigrationExecutor {
  final DatabaseService _db;
  final Logger _logger;

  /// æ¯æ‰¹å¤„ç†è®°å½•æ•°
  static const int batchSize = 500;

  /// æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  static const int batchDelayMs = 50;

  /// æ‰§è¡Œå¸¦è¿›åº¦çš„è¿ç§»
  Stream<MigrationProgress> executeMigration(Migration migration) async* {
    final totalRecords = await _getTotalRecords(migration);
    var processedRecords = 0;
    var currentBatch = 0;

    yield MigrationProgress(
      phase: MigrationPhase.starting,
      total: totalRecords,
      processed: 0,
      message: 'å¼€å§‹è¿ç§»: ${migration.description}',
    );

    try {
      while (processedRecords < totalRecords) {
        // å¤„ç†ä¸€æ‰¹æ•°æ®
        final batchResult = await _processBatch(
          migration: migration,
          offset: processedRecords,
          limit: batchSize,
        );

        processedRecords += batchResult.processedCount;
        currentBatch++;

        yield MigrationProgress(
          phase: MigrationPhase.processing,
          total: totalRecords,
          processed: processedRecords,
          message: 'æ­£åœ¨è¿ç§»æ•°æ® ($processedRecords/$totalRecords)',
        );

        // æ‰¹æ¬¡é—´çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…é˜»å¡UI
        if (processedRecords < totalRecords) {
          await Future.delayed(Duration(milliseconds: batchDelayMs));
        }

        // ä¿å­˜è¿ç§»æ–­ç‚¹ï¼ˆæ”¯æŒä¸­æ–­æ¢å¤ï¼‰
        await _saveCheckpoint(migration.version, processedRecords);
      }

      // æ¸…ç†æ–­ç‚¹
      await _clearCheckpoint(migration.version);

      yield MigrationProgress(
        phase: MigrationPhase.completed,
        total: totalRecords,
        processed: processedRecords,
        message: 'è¿ç§»å®Œæˆ',
      );
    } catch (e, stackTrace) {
      _logger.error('Migration failed at batch $currentBatch',
        error: e, stackTrace: stackTrace);

      yield MigrationProgress(
        phase: MigrationPhase.failed,
        total: totalRecords,
        processed: processedRecords,
        message: 'è¿ç§»å¤±è´¥: $e',
        error: e,
      );
    }
  }

  /// ä»æ–­ç‚¹æ¢å¤è¿ç§»
  Future<int?> getCheckpoint(int migrationVersion) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getInt('migration_checkpoint_$migrationVersion');
  }

  /// æ¢å¤ä¸­æ–­çš„è¿ç§»
  Stream<MigrationProgress> resumeMigration(Migration migration) async* {
    final checkpoint = await getCheckpoint(migration.version);

    if (checkpoint == null) {
      // æ— æ–­ç‚¹ï¼Œä»å¤´å¼€å§‹
      yield* executeMigration(migration);
      return;
    }

    yield MigrationProgress(
      phase: MigrationPhase.resuming,
      processed: checkpoint,
      message: 'ä»æ–­ç‚¹æ¢å¤è¿ç§» (å·²å¤„ç† $checkpoint æ¡)',
    );

    // ç»§ç»­è¿ç§»...
    // ï¼ˆå®ç°ä¸executeMigrationç±»ä¼¼ï¼Œä½†ä»checkpointå¼€å§‹ï¼‰
  }
}

/// è¿ç§»è¿›åº¦
class MigrationProgress {
  final MigrationPhase phase;
  final int? total;
  final int processed;
  final String message;
  final Object? error;

  MigrationProgress({
    required this.phase,
    this.total,
    required this.processed,
    required this.message,
    this.error,
  });

  /// è¿›åº¦ç™¾åˆ†æ¯”
  double get percentage =>
    total != null && total! > 0 ? processed / total! : 0;
}

enum MigrationPhase {
  starting,
  resuming,
  processing,
  completed,
  failed,
}
```

#### 26.4.6 æ•°æ®å®Œæ•´æ€§æ ¡éªŒ

```dart
/// æ•°æ®å®Œæ•´æ€§æ ¡éªŒæœåŠ¡
class DataIntegrityValidator {
  final DatabaseService _db;

  /// æ‰§è¡Œå®Œæ•´æ€§æ ¡éªŒ
  Future<ValidationResult> validate() async {
    final errors = <ValidationError>[];

    // 1. å¤–é”®å®Œæ•´æ€§
    errors.addAll(await _validateForeignKeys());

    // 2. é‡‘é¢ä¸€è‡´æ€§ï¼ˆè´¦æˆ·ä½™é¢ = æ”¶å…¥ - æ”¯å‡ºï¼‰
    errors.addAll(await _validateAccountBalances());

    // 3. é¢„ç®—æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§
    errors.addAll(await _validateBudgetData());

    // 4. èµ„æºæ± æ•°æ®ä¸€è‡´æ€§ï¼ˆé’±é¾„è®¡ç®—ï¼‰
    errors.addAll(await _validateResourcePools());

    // 5. æ—¶é—´æˆ³åˆç†æ€§
    errors.addAll(await _validateTimestamps());

    return ValidationResult(
      isValid: errors.isEmpty,
      errors: errors,
      checkedAt: DateTime.now(),
    );
  }

  /// æ ¡éªŒè´¦æˆ·ä½™é¢
  Future<List<ValidationError>> _validateAccountBalances() async {
    final errors = <ValidationError>[];

    final accounts = await _db.query('accounts');
    for (final account in accounts) {
      final accountId = account['id'] as String;
      final recordedBalance = account['balance'] as double;

      // è®¡ç®—å®é™…ä½™é¢
      final incomeSum = await _db.rawQuery('''
        SELECT COALESCE(SUM(amount), 0) as total
        FROM transactions
        WHERE account_id = ? AND type = 'income'
      ''', [accountId]);

      final expenseSum = await _db.rawQuery('''
        SELECT COALESCE(SUM(amount), 0) as total
        FROM transactions
        WHERE account_id = ? AND type = 'expense'
      ''', [accountId]);

      final calculatedBalance =
        (incomeSum.first['total'] as num) - (expenseSum.first['total'] as num);

      // å…è®¸0.01çš„æµ®ç‚¹è¯¯å·®
      if ((recordedBalance - calculatedBalance).abs() > 0.01) {
        errors.add(ValidationError(
          type: ValidationErrorType.balanceMismatch,
          table: 'accounts',
          recordId: accountId,
          message: 'è´¦æˆ·ä½™é¢ä¸ä¸€è‡´: è®°å½•=$recordedBalance, è®¡ç®—=$calculatedBalance',
          severity: ValidationSeverity.critical,
          autoFix: () async {
            await _db.update('accounts',
              {'balance': calculatedBalance},
              where: 'id = ?',
              whereArgs: [accountId],
            );
          },
        ));
      }
    }

    return errors;
  }

  /// æ ¡éªŒèµ„æºæ± ï¼ˆé’±é¾„è®¡ç®—æ•°æ®ï¼‰
  Future<List<ValidationError>> _validateResourcePools() async {
    final errors = <ValidationError>[];

    // æ£€æŸ¥èµ„æºæ± æ€»é¢æ˜¯å¦ç­‰äºæ”¶å…¥æ€»é¢
    final poolTotal = await _db.rawQuery('''
      SELECT COALESCE(SUM(original_amount), 0) as total FROM resource_pools
    ''');

    final incomeTotal = await _db.rawQuery('''
      SELECT COALESCE(SUM(amount), 0) as total FROM transactions WHERE type = 'income'
    ''');

    final poolSum = poolTotal.first['total'] as num;
    final incomeSum = incomeTotal.first['total'] as num;

    if ((poolSum - incomeSum).abs() > 0.01) {
      errors.add(ValidationError(
        type: ValidationErrorType.resourcePoolMismatch,
        table: 'resource_pools',
        message: 'èµ„æºæ± æ€»é¢ä¸æ”¶å…¥æ€»é¢ä¸ä¸€è‡´: èµ„æºæ± =$poolSum, æ”¶å…¥=$incomeSum',
        severity: ValidationSeverity.warning,
        autoFix: () async => await _rebuildResourcePools(),
      ));
    }

    // æ£€æŸ¥æ¶ˆè€—è®°å½•æ˜¯å¦è¶…è¿‡èµ„æºæ± å‰©ä½™
    final overConsumedPools = await _db.rawQuery('''
      SELECT p.id, p.original_amount, p.remaining_amount,
             COALESCE(SUM(c.amount), 0) as consumed
      FROM resource_pools p
      LEFT JOIN resource_consumptions c ON p.id = c.pool_id
      GROUP BY p.id
      HAVING p.original_amount - consumed != p.remaining_amount
    ''');

    for (final pool in overConsumedPools) {
      errors.add(ValidationError(
        type: ValidationErrorType.resourcePoolMismatch,
        table: 'resource_pools',
        recordId: pool['id'] as String,
        message: 'èµ„æºæ± å‰©ä½™é‡‘é¢è®¡ç®—é”™è¯¯',
        severity: ValidationSeverity.warning,
      ));
    }

    return errors;
  }

  /// å‡çº§åæ ¡éªŒ
  Future<PostUpgradeValidation> validateAfterUpgrade({
    required BackupMetadata backup,
  }) async {
    // å¯¹æ¯”å‡çº§å‰åçš„å…³é”®æŒ‡æ ‡
    final currentCounts = await _getTableCounts();

    final mismatches = <String, TableCountMismatch>{};

    // æ ¸å¿ƒè¡¨çš„è®°å½•æ•°ä¸åº”å‡å°‘
    for (final table in ['transactions', 'accounts', 'categories']) {
      final before = backup.tables[table] ?? 0;
      final after = currentCounts[table] ?? 0;

      if (after < before) {
        mismatches[table] = TableCountMismatch(
          table: table,
          before: before,
          after: after,
          difference: after - before,
        );
      }
    }

    // è®¡ç®—æ€»é‡‘é¢å¯¹æ¯”
    final beforeTotalIncome = backup.tables['_total_income'] ?? 0;
    final afterTotalIncome = await _getTotalAmount('income');

    final beforeTotalExpense = backup.tables['_total_expense'] ?? 0;
    final afterTotalExpense = await _getTotalAmount('expense');

    return PostUpgradeValidation(
      isValid: mismatches.isEmpty &&
        (beforeTotalIncome - afterTotalIncome).abs() < 0.01 &&
        (beforeTotalExpense - afterTotalExpense).abs() < 0.01,
      tableMismatches: mismatches,
      incomeMatch: (beforeTotalIncome - afterTotalIncome).abs() < 0.01,
      expenseMatch: (beforeTotalExpense - afterTotalExpense).abs() < 0.01,
    );
  }
}

/// æ ¡éªŒé”™è¯¯
class ValidationError {
  final ValidationErrorType type;
  final String table;
  final String? recordId;
  final String message;
  final ValidationSeverity severity;
  final Future<void> Function()? autoFix;

  ValidationError({
    required this.type,
    required this.table,
    this.recordId,
    required this.message,
    required this.severity,
    this.autoFix,
  });
}

enum ValidationErrorType {
  foreignKeyViolation,
  balanceMismatch,
  resourcePoolMismatch,
  timestampInvalid,
  duplicateRecord,
  orphanedRecord,
}

enum ValidationSeverity {
  critical,  // å¿…é¡»ä¿®å¤
  warning,   // å»ºè®®ä¿®å¤
  info,      // ä»…æç¤º
}
```

#### 26.4.7 æ•°æ®æ ¼å¼ç‰ˆæœ¬åŒ–

```dart
/// æ•°æ®å¯¼å‡ºæ ¼å¼ç‰ˆæœ¬ç®¡ç†
class ExportFormatVersion {
  /// å½“å‰å¯¼å‡ºæ ¼å¼ç‰ˆæœ¬
  static const int currentVersion = 3;

  /// ç‰ˆæœ¬ç‰¹æ€§
  static const Map<int, FormatFeatures> features = {
    1: FormatFeatures(
      description: 'åŸºç¡€å¯¼å‡ºæ ¼å¼',
      fields: ['id', 'amount', 'type', 'category', 'date', 'note'],
    ),
    2: FormatFeatures(
      description: 'å¢åŠ è´¦æˆ·å’Œæ ‡ç­¾æ”¯æŒ',
      fields: ['account_id', 'tags', 'attachment_ids'],
    ),
    3: FormatFeatures(
      description: 'å¢åŠ å°é‡‘åº“å’Œé’±é¾„å­—æ®µ',
      fields: ['vault_id', 'money_age', 'location'],
    ),
  };

  /// å¯¼å‡ºæ•°æ®æ—¶é™„åŠ ç‰ˆæœ¬ä¿¡æ¯
  static Map<String, dynamic> wrapExport(List<Map<String, dynamic>> data) {
    return {
      '_format_version': currentVersion,
      '_exported_at': DateTime.now().toIso8601String(),
      '_app_version': BuildInfo.version,
      'data': data,
    };
  }

  /// å¯¼å…¥æ—¶æ£€æŸ¥å¹¶è½¬æ¢æ ¼å¼
  static Future<List<Map<String, dynamic>>> unwrapImport(
    Map<String, dynamic> imported,
  ) async {
    final formatVersion = imported['_format_version'] as int? ?? 1;
    var data = imported['data'] as List<dynamic>;

    // é€ç‰ˆæœ¬å‡çº§æ•°æ®æ ¼å¼
    if (formatVersion < 2) {
      data = _upgradeV1ToV2(data);
    }
    if (formatVersion < 3) {
      data = _upgradeV2ToV3(data);
    }

    return data.cast<Map<String, dynamic>>();
  }

  /// V1 -> V2 æ ¼å¼è½¬æ¢
  static List<dynamic> _upgradeV1ToV2(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'account_id': null,  // é»˜è®¤æ— è´¦æˆ·
        'tags': <String>[],
        'attachment_ids': <String>[],
      };
    }).toList();
  }

  /// V2 -> V3 æ ¼å¼è½¬æ¢
  static List<dynamic> _upgradeV2ToV3(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'vault_id': null,
        'money_age': null,  // å¯¼å…¥åé‡æ–°è®¡ç®—
        'location': null,
      };
    }).toList();
  }
}
```

#### 26.4.8 APIå…¼å®¹æ€§å±‚

```dart
/// APIå“åº”å…¼å®¹æ€§é€‚é…å™¨
class ApiCompatibilityAdapter {
  /// æœåŠ¡å™¨APIç‰ˆæœ¬
  final String serverVersion;

  /// å®¢æˆ·ç«¯æ”¯æŒçš„æœ€ä½APIç‰ˆæœ¬
  static const String minSupportedVersion = 'v1';

  ApiCompatibilityAdapter(this.serverVersion);

  /// é€‚é…äº¤æ˜“å“åº”
  Transaction adaptTransaction(Map<String, dynamic> json) {
    // V1 API: categoryæ˜¯å­—ç¬¦ä¸²
    // V2 API: categoryæ˜¯å¯¹è±¡
    if (_isV1Api) {
      final categoryName = json['category'] as String?;
      json['category'] = {
        'id': categoryName,
        'name': categoryName,
      };
    }

    // V2 APIæ–°å¢å­—æ®µï¼ŒV1æ²¡æœ‰åˆ™è®¾é»˜è®¤å€¼
    json['vault_id'] ??= null;
    json['money_age'] ??= null;
    json['location'] ??= null;

    return Transaction.fromJson(json);
  }

  /// é€‚é…é¢„ç®—å“åº”
  Budget adaptBudget(Map<String, dynamic> json) {
    // V1 API: æ— é›¶åŸºé¢„ç®—æ¦‚å¿µ
    // V2 API: å¢åŠ budget_typeå­—æ®µ
    json['budget_type'] ??= 'traditional';
    json['carry_over_enabled'] ??= false;

    return Budget.fromJson(json);
  }

  bool get _isV1Api => serverVersion == 'v1';
}

/// è¯·æ±‚é™çº§é€‚é…å™¨ï¼ˆæ–°å®¢æˆ·ç«¯ -> æ—§æœåŠ¡å™¨ï¼‰
class RequestDowngradeAdapter {
  /// é™çº§äº¤æ˜“è¯·æ±‚
  static Map<String, dynamic> downgradeTransaction(
    Map<String, dynamic> request,
    String targetApiVersion,
  ) {
    if (targetApiVersion == 'v1') {
      // ç§»é™¤V2æ–°å¢å­—æ®µ
      return Map.from(request)
        ..remove('vault_id')
        ..remove('money_age')
        ..remove('location')
        ..['category'] = request['category']?['name'] ?? request['category'];
    }
    return request;
  }
}
```

#### 26.4.9 å‡çº§æµç¨‹UI

```dart
/// å‡çº§è¿›åº¦é¡µé¢
class UpgradeProgressPage extends ConsumerStatefulWidget {
  final String fromVersion;
  final String toVersion;

  const UpgradeProgressPage({
    required this.fromVersion,
    required this.toVersion,
  });

  @override
  ConsumerState<UpgradeProgressPage> createState() => _UpgradeProgressPageState();
}

class _UpgradeProgressPageState extends ConsumerState<UpgradeProgressPage> {
  UpgradePhase _phase = UpgradePhase.preparing;
  double _progress = 0;
  String _message = 'å‡†å¤‡å‡çº§...';
  bool _canCancel = true;

  @override
  void initState() {
    super.initState();
    _startUpgrade();
  }

  Future<void> _startUpgrade() async {
    final upgradeService = ref.read(upgradeServiceProvider);

    try {
      // 1. å¤‡ä»½é˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.backup;
        _message = 'æ­£åœ¨å¤‡ä»½æ•°æ®...';
        _progress = 0.1;
      });

      final backup = await upgradeService.createBackup(
        fromVersion: widget.fromVersion,
        toVersion: widget.toVersion,
      );

      // 2. è¿ç§»é˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.migrating;
        _canCancel = false;  // è¿ç§»å¼€å§‹åä¸å¯å–æ¶ˆ
      });

      await for (final progress in upgradeService.executeMigrations()) {
        setState(() {
          _progress = 0.2 + progress.percentage * 0.6;
          _message = progress.message;
        });
      }

      // 3. æ ¡éªŒé˜¶æ®µ
      setState(() {
        _phase = UpgradePhase.validating;
        _message = 'æ­£åœ¨éªŒè¯æ•°æ®å®Œæ•´æ€§...';
        _progress = 0.85;
      });

      final validation = await upgradeService.validateAfterUpgrade(backup);

      if (!validation.isValid) {
        // æ ¡éªŒå¤±è´¥ï¼Œæç¤ºç”¨æˆ·
        final shouldRestore = await _showValidationError(validation);
        if (shouldRestore) {
          await upgradeService.restoreFromBackup(backup.id);
          _showRestoreSuccess();
          return;
        }
      }

      // 4. å®Œæˆ
      setState(() {
        _phase = UpgradePhase.completed;
        _message = 'å‡çº§å®Œæˆï¼';
        _progress = 1.0;
      });

      await Future.delayed(Duration(seconds: 1));
      Navigator.of(context).pushReplacementNamed('/home');

    } catch (e) {
      setState(() {
        _phase = UpgradePhase.failed;
        _message = 'å‡çº§å¤±è´¥: $e';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async => _canCancel,
      child: Scaffold(
        body: SafeArea(
          child: Padding(
            padding: EdgeInsets.all(24),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // è¿›åº¦æŒ‡ç¤ºå™¨
                _buildProgressIndicator(),

                SizedBox(height: 32),

                // é˜¶æ®µå›¾æ ‡
                _buildPhaseIcon(),

                SizedBox(height: 16),

                // æ¶ˆæ¯
                Text(
                  _message,
                  style: Theme.of(context).textTheme.titleMedium,
                  textAlign: TextAlign.center,
                ),

                SizedBox(height: 8),

                // ç‰ˆæœ¬ä¿¡æ¯
                Text(
                  '${widget.fromVersion} â†’ ${widget.toVersion}',
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    color: Colors.grey,
                  ),
                ),

                SizedBox(height: 32),

                // æ“ä½œæŒ‰é’®
                if (_phase == UpgradePhase.failed) ...[
                  ElevatedButton(
                    onPressed: () => _showRecoveryOptions(),
                    child: Text('æ¢å¤é€‰é¡¹'),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildProgressIndicator() {
    return Column(
      children: [
        LinearProgressIndicator(
          value: _progress,
          backgroundColor: Colors.grey[200],
          minHeight: 8,
          borderRadius: BorderRadius.circular(4),
        ),
        SizedBox(height: 8),
        Text(
          '${(_progress * 100).toInt()}%',
          style: TextStyle(fontWeight: FontWeight.bold),
        ),
      ],
    );
  }

  Widget _buildPhaseIcon() {
    IconData icon;
    Color color;

    switch (_phase) {
      case UpgradePhase.preparing:
        icon = Icons.hourglass_empty;
        color = Colors.grey;
      case UpgradePhase.backup:
        icon = Icons.backup;
        color = Colors.blue;
      case UpgradePhase.migrating:
        icon = Icons.sync;
        color = Colors.orange;
      case UpgradePhase.validating:
        icon = Icons.verified;
        color = Colors.purple;
      case UpgradePhase.completed:
        icon = Icons.check_circle;
        color = Colors.green;
      case UpgradePhase.failed:
        icon = Icons.error;
        color = Colors.red;
    }

    return Icon(icon, size: 64, color: color);
  }
}

enum UpgradePhase {
  preparing,
  backup,
  migrating,
  validating,
  completed,
  failed,
}
```

### 26.5 ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ

#### 26.5.0 ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰ˆæœ¬è¿ç§»ç­–ç•¥ - ç³»ç»Ÿé›†æˆå…¨æ™¯å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚    ç‰ˆæœ¬è¿ç§»æœåŠ¡        â”‚                              â”‚
â”‚                          â”‚  MigrationService     â”‚                              â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                      â”‚                                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚             â”‚           â”‚               â”‚           â”‚             â”‚       â”‚
â”‚    â–¼             â–¼           â–¼               â–¼           â–¼             â–¼       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚é’±é¾„ç³»ç»Ÿâ”‚  â”‚é›¶åŸºé¢„ç®—â”‚  â”‚ æ•°æ®å¯¼å…¥  â”‚  â”‚ æ•°æ®å¤‡ä»½  â”‚  â”‚APPå‡çº§â”‚  â”‚åŒæ­¥ç³»ç»Ÿ   â”‚  â”‚
â”‚ â”‚ (7ç« ) â”‚  â”‚ (8ç« ) â”‚  â”‚  (11ç« )  â”‚  â”‚  (æœ¬ç« )  â”‚  â”‚(æœ¬ç« ) â”‚  â”‚  (16ç« )  â”‚  â”‚
â”‚ â”‚èµ„æºæ±   â”‚  â”‚å°é‡‘åº“  â”‚  â”‚æ ¼å¼è½¬æ¢   â”‚  â”‚å‡çº§å¤‡ä»½   â”‚  â”‚ç‰ˆæœ¬å…ƒæ•°â”‚  â”‚æ•°æ®å¯¹é½   â”‚  â”‚
â”‚ â”‚åˆå§‹åŒ–  â”‚  â”‚è¿ç§»    â”‚  â”‚å…¼å®¹æ€§å¤„ç† â”‚  â”‚å®Œæ•´æ¢å¤   â”‚  â”‚æ®æ£€æŸ¥  â”‚  â”‚ç‰ˆæœ¬åŒæ­¥   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                              2.0æ–°å¢è¿ç§»æ¨¡å—                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ å®¶åº­è´¦æœ¬  â”‚  â”‚ è¯­éŸ³äº¤äº’  â”‚  â”‚ è‡ªå­¦ä¹ ç³»ç»Ÿ â”‚  â”‚ ä½ç½®æ™ºèƒ½  â”‚  â”‚ ä¹ æƒ¯åŸ¹å…»  â”‚     â”‚
â”‚ â”‚  (13ç« )  â”‚  â”‚  (18ç« )  â”‚  â”‚  (17ç« )  â”‚  â”‚  (14ç« )  â”‚  â”‚  (9ç« )   â”‚     â”‚
â”‚ â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚     â”‚
â”‚ â”‚ å®¶åº­å…³ç³»  â”‚  â”‚ è¯­éŸ³é…ç½®  â”‚  â”‚ å­¦ä¹ æ¨¡å‹  â”‚  â”‚ ä½ç½®åå¥½  â”‚  â”‚ æˆå°±æ•°æ®  â”‚     â”‚
â”‚ â”‚ è¡¨è¿ç§»   â”‚  â”‚ æ•°æ®è¿ç§»  â”‚  â”‚ æ•°æ®è¿ç§»  â”‚  â”‚ æ•°æ®è¿ç§»  â”‚  â”‚ ç§¯åˆ†è¿ç§»  â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 26.5.1 é›†æˆè§¦å‘ç‚¹

| é›†æˆæ¨¡å— | è§¦å‘åœºæ™¯ | è¿ç§»æ“ä½œ | å›æ»šç­–ç•¥ |
|---------|---------|---------|---------|
| **é’±é¾„ç³»ç»Ÿ** | Schemaå‡çº§åˆ°v16 | åˆ›å»ºèµ„æºæ± è¡¨ã€åˆå§‹åŒ–å†å²æ•°æ® | åˆ é™¤èµ„æºæ± è¡¨åŠæ•°æ® |
| **é›¶åŸºé¢„ç®—** | Schemaå‡çº§åˆ°v15 | åˆ›å»ºå°é‡‘åº“è¡¨ã€è¿ç§»é¢„ç®—æ•°æ® | æ¢å¤åŸé¢„ç®—ç»“æ„ |
| **æ•°æ®å¯¼å…¥** | å¯¼å…¥æ—§ç‰ˆæ•°æ® | æ ¼å¼ç‰ˆæœ¬æ£€æµ‹ã€é€ç‰ˆæœ¬è½¬æ¢ | ä¿ç•™åŸå§‹å¯¼å…¥æ–‡ä»¶ |
| **æ•°æ®å¤‡ä»½** | ç‰ˆæœ¬å‡çº§å‰ | æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½ | ä»å¤‡ä»½å®Œæ•´æ¢å¤ |
| **APPå‡çº§** | æ–°ç‰ˆæœ¬å®‰è£… | æ£€æµ‹ç‰ˆæœ¬å…ƒæ•°æ®ã€æ‰§è¡Œè¿ç§»é“¾ | å›æ»šåˆ°å‡çº§å‰ç‰ˆæœ¬ |
| **åŒæ­¥ç³»ç»Ÿ** | å¤šè®¾å¤‡æ•°æ®åŒæ­¥ | ç‰ˆæœ¬å¯¹é½ã€Schemaå…¼å®¹ | ä¿ç•™å†²çªæ•°æ®ä¾›ç”¨æˆ·å¤„ç† |

#### 26.5.2 ä¸é’±é¾„ç³»ç»Ÿé›†æˆ

```dart
/// ç‰ˆæœ¬è¿ç§»ä¸é’±é¾„ç³»ç»Ÿé›†æˆ
/// è´Ÿè´£åœ¨å‡çº§åˆ°2.0æ—¶åˆå§‹åŒ–é’±é¾„è®¡ç®—æ‰€éœ€çš„èµ„æºæ± æ•°æ®
class MigrationMoneyAgeIntegration {
  final DatabaseService _db;
  final Logger _logger;

  /// è¿ç§»ç‰ˆæœ¬ï¼šv16å¼•å…¥é’±é¾„è®¡ç®—
  static const int moneyAgeSchemaVersion = 16;

  /// æ‰§è¡Œé’±é¾„ç³»ç»Ÿè¿ç§»
  Stream<MigrationProgress> migrateMoneyAgeSystem({
    required int fromVersion,
  }) async* {
    if (fromVersion >= moneyAgeSchemaVersion) {
      yield MigrationProgress(
        phase: MigrationPhase.skipped,
        message: 'é’±é¾„ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œè·³è¿‡è¿ç§»',
      );
      return;
    }

    // 1. åˆ›å»ºèµ„æºæ± è¡¨
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'åˆ›å»ºé’±é¾„æ•°æ®è¡¨...',
      progress: 0.1,
    );

    await _createResourcePoolTables();

    // 2. è·å–æ‰€æœ‰å†å²æ”¶å…¥äº¤æ˜“
    final incomes = await _db.query('transactions',
      where: 'type = ?',
      whereArgs: ['income'],
      orderBy: 'date ASC',
    );

    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'åˆå§‹åŒ–èµ„æºæ±  (å…±${incomes.length}ç¬”æ”¶å…¥)...',
      progress: 0.2,
    );

    // 3. ä¸ºæ¯ç¬”æ”¶å…¥åˆ›å»ºèµ„æºæ± 
    for (var i = 0; i < incomes.length; i++) {
      final income = incomes[i];
      await _db.insert('resource_pools', {
        'id': generateUuid(),
        'income_transaction_id': income['id'],
        'original_amount': income['amount'],
        'remaining_amount': income['amount'],  // åˆå§‹æ—¶ç­‰äºåŸå§‹é‡‘é¢
        'created_at': income['date'],
      });

      if (i % 100 == 0) {
        yield MigrationProgress(
          phase: MigrationPhase.processing,
          message: 'åˆå§‹åŒ–èµ„æºæ±  ($i/${incomes.length})...',
          progress: 0.2 + 0.5 * (i / incomes.length),
        );
      }
    }

    // 4. é‡æ–°è®¡ç®—æ‰€æœ‰æ”¯å‡ºçš„é’±é¾„
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'é‡æ–°è®¡ç®—æ”¯å‡ºé’±é¾„...',
      progress: 0.7,
    );

    await _recalculateExpenseMoneyAge();

    yield MigrationProgress(
      phase: MigrationPhase.completed,
      message: 'é’±é¾„ç³»ç»Ÿè¿ç§»å®Œæˆ',
      progress: 1.0,
    );
  }

  Future<void> _createResourcePoolTables() async {
    await _db.execute('''
      CREATE TABLE IF NOT EXISTS resource_pools (
        id TEXT PRIMARY KEY,
        income_transaction_id TEXT NOT NULL,
        original_amount REAL NOT NULL,
        remaining_amount REAL NOT NULL,
        created_at TEXT NOT NULL,
        FOREIGN KEY (income_transaction_id) REFERENCES transactions(id)
      )
    ''');

    await _db.execute('''
      CREATE TABLE IF NOT EXISTS resource_consumptions (
        id TEXT PRIMARY KEY,
        pool_id TEXT NOT NULL,
        transaction_id TEXT NOT NULL,
        amount REAL NOT NULL,
        age_at_consumption INTEGER NOT NULL,
        created_at TEXT NOT NULL,
        FOREIGN KEY (pool_id) REFERENCES resource_pools(id),
        FOREIGN KEY (transaction_id) REFERENCES transactions(id)
      )
    ''');

    // åˆ›å»ºç´¢å¼•
    await _db.execute(
      'CREATE INDEX IF NOT EXISTS idx_pools_income ON resource_pools(income_transaction_id)'
    );
    await _db.execute(
      'CREATE INDEX IF NOT EXISTS idx_consumptions_pool ON resource_consumptions(pool_id)'
    );
  }

  Future<void> _recalculateExpenseMoneyAge() async {
    // è·å–æ‰€æœ‰æ”¯å‡ºäº¤æ˜“ï¼ŒæŒ‰æ—¶é—´é¡ºåºå¤„ç†
    final expenses = await _db.query('transactions',
      where: 'type = ?',
      whereArgs: ['expense'],
      orderBy: 'date ASC',
    );

    for (final expense in expenses) {
      await _consumeFromPools(
        transactionId: expense['id'] as String,
        amount: (expense['amount'] as num).toDouble(),
        date: DateTime.parse(expense['date'] as String),
      );
    }
  }

  /// FIFOæ–¹å¼æ¶ˆè´¹èµ„æºæ± 
  Future<void> _consumeFromPools({
    required String transactionId,
    required double amount,
    required DateTime date,
  }) async {
    var remainingAmount = amount;

    // è·å–æœ‰å‰©ä½™é‡‘é¢çš„èµ„æºæ± ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ŒFIFOï¼‰
    final pools = await _db.query('resource_pools',
      where: 'remaining_amount > 0 AND created_at <= ?',
      whereArgs: [date.toIso8601String()],
      orderBy: 'created_at ASC',
    );

    for (final pool in pools) {
      if (remainingAmount <= 0) break;

      final poolRemaining = (pool['remaining_amount'] as num).toDouble();
      final consumeAmount = remainingAmount < poolRemaining
          ? remainingAmount
          : poolRemaining;

      // è®¡ç®—é’±é¾„
      final poolCreatedAt = DateTime.parse(pool['created_at'] as String);
      final ageInDays = date.difference(poolCreatedAt).inDays;

      // è®°å½•æ¶ˆè´¹
      await _db.insert('resource_consumptions', {
        'id': generateUuid(),
        'pool_id': pool['id'],
        'transaction_id': transactionId,
        'amount': consumeAmount,
        'age_at_consumption': ageInDays,
        'created_at': date.toIso8601String(),
      });

      // æ›´æ–°èµ„æºæ± å‰©ä½™é‡‘é¢
      await _db.update('resource_pools',
        {'remaining_amount': poolRemaining - consumeAmount},
        where: 'id = ?',
        whereArgs: [pool['id']],
      );

      remainingAmount -= consumeAmount;
    }
  }
}
```

#### 26.5.3 ä¸é›¶åŸºé¢„ç®—ç³»ç»Ÿé›†æˆ

```dart
/// ç‰ˆæœ¬è¿ç§»ä¸é›¶åŸºé¢„ç®—ç³»ç»Ÿé›†æˆ
/// è´Ÿè´£åœ¨å‡çº§åˆ°2.0æ—¶åˆå§‹åŒ–å°é‡‘åº“ç»“æ„
class MigrationBudgetVaultIntegration {
  final DatabaseService _db;
  final Logger _logger;

  /// è¿ç§»ç‰ˆæœ¬ï¼šv15å¼•å…¥å°é‡‘åº“
  static const int vaultSchemaVersion = 15;

  /// æ‰§è¡Œå°é‡‘åº“è¿ç§»
  Stream<MigrationProgress> migrateVaultSystem({
    required int fromVersion,
  }) async* {
    if (fromVersion >= vaultSchemaVersion) {
      yield MigrationProgress(
        phase: MigrationPhase.skipped,
        message: 'å°é‡‘åº“ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œè·³è¿‡è¿ç§»',
      );
      return;
    }

    // 1. åˆ›å»ºå°é‡‘åº“è¡¨
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'åˆ›å»ºå°é‡‘åº“æ•°æ®è¡¨...',
      progress: 0.1,
    );

    await _createVaultTables();

    // 2. ä»ç°æœ‰é¢„ç®—æ•°æ®è¿ç§»
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'è¿ç§»ç°æœ‰é¢„ç®—æ•°æ®...',
      progress: 0.3,
    );

    await _migrateExistingBudgets();

    // 3. åˆ›å»ºé»˜è®¤å°é‡‘åº“
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'åˆ›å»ºé»˜è®¤å°é‡‘åº“...',
      progress: 0.7,
    );

    await _createDefaultVaults();

    // 4. æ›´æ–°äº¤æ˜“è¡¨å…³è”
    yield MigrationProgress(
      phase: MigrationPhase.processing,
      message: 'æ›´æ–°äº¤æ˜“å…³è”...',
      progress: 0.9,
    );

    await _updateTransactionVaultLinks();

    yield MigrationProgress(
      phase: MigrationPhase.completed,
      message: 'å°é‡‘åº“ç³»ç»Ÿè¿ç§»å®Œæˆ',
      progress: 1.0,
    );
  }

  Future<void> _createVaultTables() async {
    await _db.execute('''
      CREATE TABLE IF NOT EXISTS budget_vaults (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        icon TEXT,
        color TEXT,
        target_amount REAL DEFAULT 0,
        allocated_amount REAL DEFAULT 0,
        spent_amount REAL DEFAULT 0,
        sort_order INTEGER DEFAULT 0,
        is_active INTEGER DEFAULT 1,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
      )
    ''');

    // äº¤æ˜“è¡¨æ·»åŠ å°é‡‘åº“å…³è”å­—æ®µ
    await _db.execute('''
      ALTER TABLE transactions ADD COLUMN vault_id TEXT
    ''');
  }

  Future<void> _migrateExistingBudgets() async {
    // è·å–ç°æœ‰æŒ‰åˆ†ç±»çš„é¢„ç®—è®¾ç½®
    final budgets = await _db.query('budgets');

    for (final budget in budgets) {
      // ä¸ºæ¯ä¸ªé¢„ç®—åˆ†ç±»åˆ›å»ºå¯¹åº”çš„å°é‡‘åº“
      final vaultId = generateUuid();
      await _db.insert('budget_vaults', {
        'id': vaultId,
        'name': budget['category_name'] ?? 'é¢„ç®—',
        'type': 'expense',
        'target_amount': budget['amount'] ?? 0,
        'allocated_amount': budget['amount'] ?? 0,
        'spent_amount': 0,
        'sort_order': budget['sort_order'] ?? 0,
        'is_active': 1,
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
      });

      // è®°å½•åˆ†ç±»åˆ°å°é‡‘åº“çš„æ˜ å°„ï¼ˆç”¨äºåç»­äº¤æ˜“å…³è”ï¼‰
      _categoryToVaultMap[budget['category_id'] as String] = vaultId;
    }
  }

  final Map<String, String> _categoryToVaultMap = {};

  Future<void> _createDefaultVaults() async {
    // åˆ›å»ºä¸‰ä¸ªé»˜è®¤å°é‡‘åº“
    final defaultVaults = [
      {'name': 'æ—¥å¸¸å¼€æ”¯', 'type': 'expense', 'icon': 'shopping_cart'},
      {'name': 'å‚¨è“„ç›®æ ‡', 'type': 'savings', 'icon': 'savings'},
      {'name': 'åº”æ€¥åŸºé‡‘', 'type': 'emergency', 'icon': 'security'},
    ];

    for (var i = 0; i < defaultVaults.length; i++) {
      final vault = defaultVaults[i];
      await _db.insert('budget_vaults', {
        'id': generateUuid(),
        'name': vault['name'],
        'type': vault['type'],
        'icon': vault['icon'],
        'target_amount': 0,
        'allocated_amount': 0,
        'spent_amount': 0,
        'sort_order': 100 + i,  // æ’åœ¨è¿ç§»çš„åé¢
        'is_active': 1,
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
      });
    }
  }

  Future<void> _updateTransactionVaultLinks() async {
    // æ ¹æ®åˆ†ç±»æ˜ å°„æ›´æ–°å†å²äº¤æ˜“çš„å°é‡‘åº“å…³è”
    for (final entry in _categoryToVaultMap.entries) {
      await _db.update('transactions',
        {'vault_id': entry.value},
        where: 'category_id = ?',
        whereArgs: [entry.key],
      );
    }
  }
}
```

#### 26.5.4 ä¸æ•°æ®å¯¼å…¥ç³»ç»Ÿé›†æˆ

```dart
/// ç‰ˆæœ¬è¿ç§»ä¸æ•°æ®å¯¼å…¥ç³»ç»Ÿé›†æˆ
/// è´Ÿè´£å¤„ç†å¯¼å…¥æ—§ç‰ˆæœ¬æ•°æ®æ—¶çš„æ ¼å¼è½¬æ¢
class MigrationImportIntegration {
  final DatabaseService _db;

  /// å¯¼å…¥æ•°æ®æ—¶çš„ç‰ˆæœ¬å…¼å®¹å¤„ç†
  Future<ImportResult> importWithVersionCompat({
    required Map<String, dynamic> importData,
  }) async {
    // 1. æ£€æµ‹æ•°æ®æ ¼å¼ç‰ˆæœ¬
    final formatVersion = importData['_format_version'] as int? ?? 1;
    final currentFormatVersion = 3;

    // 2. é€ç‰ˆæœ¬å‡çº§æ•°æ®æ ¼å¼
    var data = importData['data'] as List<dynamic>;

    if (formatVersion < 2) {
      data = _upgradeV1ToV2(data);
    }
    if (formatVersion < 3) {
      data = _upgradeV2ToV3(data);
    }

    // 3. å¯¼å…¥å‡çº§åçš„æ•°æ®
    return _importData(data.cast<Map<String, dynamic>>());
  }

  /// V1 -> V2: æ·»åŠ è´¦æˆ·å’Œæ ‡ç­¾æ”¯æŒ
  List<dynamic> _upgradeV1ToV2(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'account_id': null,
        'tags': <String>[],
        'attachment_ids': <String>[],
      };
    }).toList();
  }

  /// V2 -> V3: æ·»åŠ å°é‡‘åº“å’Œé’±é¾„å­—æ®µ
  List<dynamic> _upgradeV2ToV3(List<dynamic> data) {
    return data.map((item) {
      return {
        ...item as Map<String, dynamic>,
        'vault_id': null,
        'money_age': null,  // å¯¼å…¥åéœ€è¦é‡æ–°è®¡ç®—
        'location': null,
      };
    }).toList();
  }

  Future<ImportResult> _importData(List<Map<String, dynamic>> data) async {
    var imported = 0;
    var skipped = 0;
    var errors = <String>[];

    for (final item in data) {
      try {
        // æ£€æŸ¥æ˜¯å¦é‡å¤
        final existing = await _db.query('transactions',
          where: 'id = ?',
          whereArgs: [item['id']],
        );

        if (existing.isNotEmpty) {
          skipped++;
          continue;
        }

        await _db.insert('transactions', item);
        imported++;
      } catch (e) {
        errors.add('å¯¼å…¥å¤±è´¥: ${item['id']} - $e');
      }
    }

    return ImportResult(
      total: data.length,
      imported: imported,
      skipped: skipped,
      errors: errors,
    );
  }
}
```

#### 26.5.5 ä¸APPå‡çº§ç³»ç»Ÿé›†æˆ

```dart
/// ç‰ˆæœ¬è¿ç§»ä¸APPå‡çº§ç³»ç»Ÿé›†æˆ
/// è´Ÿè´£åè°ƒAPPå‡çº§è¿‡ç¨‹ä¸­çš„è¿ç§»æµç¨‹
class MigrationUpgradeIntegration {
  final MigrationService _migration;
  final UpgradeBackupService _backup;
  final AppUpgradeService _upgrade;

  /// å®Œæ•´çš„å‡çº§æµç¨‹
  Stream<UpgradeProgress> executeFullUpgrade({
    required UpgradeDecision decision,
  }) async* {
    // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
    if (decision.needsBackup) {
      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'æ­£åœ¨å¤‡ä»½æ•°æ®...',
        progress: 0.1,
      );

      final backupResult = await _backup.createUpgradeBackup(
        fromVersion: decision.currentVersion,
        toVersion: decision.newVersion,
      );

      if (!backupResult.isSuccess) {
        yield UpgradeProgress(
          phase: UpgradePhase.failed,
          message: 'å¤‡ä»½å¤±è´¥: ${backupResult.error}',
        );
        return;
      }

      yield UpgradeProgress(
        phase: UpgradePhase.backup,
        message: 'å¤‡ä»½å®Œæˆ',
        progress: 0.2,
      );
    }

    // 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
    yield UpgradeProgress(
      phase: UpgradePhase.migrating,
      message: 'æ­£åœ¨è¿ç§»æ•°æ®...',
      progress: 0.3,
    );

    try {
      await for (final migrationProgress in _migration.runMigrations()) {
        yield UpgradeProgress(
          phase: UpgradePhase.migrating,
          message: migrationProgress.message,
          progress: 0.3 + 0.5 * migrationProgress.progress,
        );
      }
    } catch (e) {
      // è¿ç§»å¤±è´¥ï¼Œå°è¯•å›æ»š
      if (decision.needsBackup) {
        await _backup.restoreLatestBackup();
      }

      yield UpgradeProgress(
        phase: UpgradePhase.failed,
        message: 'è¿ç§»å¤±è´¥: $e',
      );
      return;
    }

    // 3. æ•°æ®æ ¡éªŒ
    yield UpgradeProgress(
      phase: UpgradePhase.validating,
      message: 'æ­£åœ¨æ ¡éªŒæ•°æ®å®Œæ•´æ€§...',
      progress: 0.85,
    );

    final validationResult = await _migration.validateDataIntegrity();
    if (!validationResult.isValid) {
      // æ ¡éªŒå¤±è´¥ï¼Œå›æ»š
      if (decision.needsBackup) {
        await _backup.restoreLatestBackup();
      }

      yield UpgradeProgress(
        phase: UpgradePhase.failed,
        message: 'æ•°æ®æ ¡éªŒå¤±è´¥: ${validationResult.errors.join(", ")}',
      );
      return;
    }

    // 4. å‡çº§å®Œæˆ
    yield UpgradeProgress(
      phase: UpgradePhase.completed,
      message: 'å‡çº§å®Œæˆï¼',
      progress: 1.0,
    );

    // 5. æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
    await _backup.cleanupOldBackups(keepCount: 3);
  }

  /// å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
  Future<RollbackResult> rollbackToVersion(String backupId) async {
    try {
      // 1. æ¢å¤å¤‡ä»½
      final restoreResult = await _backup.restoreFromBackup(backupId);
      if (!restoreResult.isSuccess) {
        return RollbackResult.failed(error: restoreResult.error);
      }

      // 2. è®°å½•å›æ»šäº‹ä»¶
      await _logRollbackEvent(
        backupId: backupId,
        reason: 'user_initiated',
      );

      return RollbackResult.success(
        restoredVersion: restoreResult.restoredVersion,
      );
    } catch (e) {
      return RollbackResult.failed(error: e);
    }
  }

  Future<void> _logRollbackEvent({
    required String backupId,
    required String reason,
  }) async {
    // è®°å½•å›æ»šäº‹ä»¶ç”¨äºåˆ†æ
    await _db.insert('migration_logs', {
      'id': generateUuid(),
      'type': 'rollback',
      'backup_id': backupId,
      'reason': reason,
      'created_at': DateTime.now().toIso8601String(),
    });
  }
}
```

#### 26.5.6 ä¸åŒæ­¥ç³»ç»Ÿé›†æˆ

```dart
/// ç‰ˆæœ¬è¿ç§»ä¸åŒæ­¥ç³»ç»Ÿé›†æˆ
/// è´Ÿè´£å¤„ç†å¤šè®¾å¤‡é—´çš„æ•°æ®ç‰ˆæœ¬å¯¹é½
class MigrationSyncIntegration {
  final DatabaseService _db;
  final SyncService _sync;

  /// åŒæ­¥æ—¶çš„ç‰ˆæœ¬å¯¹é½
  Future<SyncAlignmentResult> alignVersions({
    required int localSchemaVersion,
    required int remoteSchemaVersion,
  }) async {
    if (localSchemaVersion == remoteSchemaVersion) {
      return SyncAlignmentResult.aligned();
    }

    if (localSchemaVersion < remoteSchemaVersion) {
      // æœ¬åœ°ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦å‡çº§
      return SyncAlignmentResult.needsLocalUpgrade(
        fromVersion: localSchemaVersion,
        toVersion: remoteSchemaVersion,
      );
    }

    // è¿œç¨‹ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦ç­‰å¾…è¿œç¨‹å‡çº§
    return SyncAlignmentResult.needsRemoteUpgrade(
      remoteVersion: remoteSchemaVersion,
      localVersion: localSchemaVersion,
    );
  }

  /// åŒæ­¥å†²çªæ—¶çš„ç‰ˆæœ¬å…¼å®¹å¤„ç†
  Future<SyncConflictResolution> resolveVersionConflict({
    required Map<String, dynamic> localData,
    required Map<String, dynamic> remoteData,
  }) async {
    final localVersion = localData['_schema_version'] as int? ?? 1;
    final remoteVersion = remoteData['_schema_version'] as int? ?? 1;

    // å°†ä¸¤è¾¹æ•°æ®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬å†æ¯”è¾ƒ
    final normalizedLocal = await _normalizeToLatestVersion(
      data: localData,
      fromVersion: localVersion,
    );
    final normalizedRemote = await _normalizeToLatestVersion(
      data: remoteData,
      fromVersion: remoteVersion,
    );

    // ä½¿ç”¨æœ€åä¿®æ”¹æ—¶é—´å†³å®šä¿ç•™å“ªä¸ª
    final localModified = DateTime.parse(
      normalizedLocal['updated_at'] as String
    );
    final remoteModified = DateTime.parse(
      normalizedRemote['updated_at'] as String
    );

    if (localModified.isAfter(remoteModified)) {
      return SyncConflictResolution.useLocal(data: normalizedLocal);
    } else {
      return SyncConflictResolution.useRemote(data: normalizedRemote);
    }
  }

  Future<Map<String, dynamic>> _normalizeToLatestVersion({
    required Map<String, dynamic> data,
    required int fromVersion,
  }) async {
    var result = Map<String, dynamic>.from(data);

    // é€ç‰ˆæœ¬å‡çº§å­—æ®µ
    if (fromVersion < 15) {
      result['vault_id'] = null;
    }
    if (fromVersion < 16) {
      result['money_age'] = null;
    }
    if (fromVersion < 20) {
      result['location_id'] = null;
      result['context_type'] = null;
    }

    return result;
  }
}

/// åŒæ­¥ç‰ˆæœ¬å¯¹é½ç»“æœ
class SyncAlignmentResult {
  final SyncAlignmentStatus status;
  final int? fromVersion;
  final int? toVersion;

  SyncAlignmentResult._({
    required this.status,
    this.fromVersion,
    this.toVersion,
  });

  factory SyncAlignmentResult.aligned() => SyncAlignmentResult._(
    status: SyncAlignmentStatus.aligned,
  );

  factory SyncAlignmentResult.needsLocalUpgrade({
    required int fromVersion,
    required int toVersion,
  }) => SyncAlignmentResult._(
    status: SyncAlignmentStatus.needsLocalUpgrade,
    fromVersion: fromVersion,
    toVersion: toVersion,
  );

  factory SyncAlignmentResult.needsRemoteUpgrade({
    required int remoteVersion,
    required int localVersion,
  }) => SyncAlignmentResult._(
    status: SyncAlignmentStatus.needsRemoteUpgrade,
    fromVersion: remoteVersion,
    toVersion: localVersion,
  );
}

enum SyncAlignmentStatus {
  aligned,
  needsLocalUpgrade,
  needsRemoteUpgrade,
}
```

---


---

## 27. å®æ–½è·¯çº¿å›¾

### 27.1 å¼€å‘é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          2.0 ç‰ˆæœ¬å¼€å‘è·¯çº¿å›¾                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„å‡çº§ (Alpha)                                          â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ•°æ®å±‚                                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ•°æ®åº“è¿ç§»è„šæœ¬ (v14 â†’ v20)                                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ResourcePool / ResourceConsumption æ•°æ®æ¨¡å‹                  â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ BudgetVault (å°é‡‘åº“) æ•°æ®æ¨¡å‹                                â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ Transaction æ¨¡å‹æ‰©å±• (vault_id, location_info)              â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ¶æ„å±‚                                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ Riverpod 3.x Provider æ¶æ„å‡çº§                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ CrudNotifier ç»Ÿä¸€æ¨¡å¼é‡æ„                                    â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ç¦»çº¿é˜Ÿåˆ—æœåŠ¡ (OfflineQueueService)                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ è‡ªåŠ¨åŒæ­¥æœåŠ¡ (AutoSyncService)                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µäºŒï¼šæ ¸å¿ƒä¸šåŠ¡å¼•æ“ (Beta-1)                                        â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ é’±é¾„ç³»ç»Ÿ (ç¬¬7ç« )                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ MoneyAgeCalculator é’±é¾„è®¡ç®—å¼•æ“                              â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ FIFO/LIFO/åŠ æƒå¹³å‡ æ¶ˆè´¹é¡ºåºç­–ç•¥                              â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å†å²æ•°æ®é’±é¾„é‡å»ºæœåŠ¡                                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ é’±é¾„è¶‹åŠ¿åˆ†æä¸é¢„æµ‹                                           â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ é›¶åŸºé¢„ç®—ç³»ç»Ÿ (ç¬¬8ç« )                                            â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ AllocationService é¢„ç®—åˆ†é…æœåŠ¡                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ™ºèƒ½åˆ†é…å»ºè®®ç®—æ³•                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å°é‡‘åº“ CRUD åŠŸèƒ½                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ äº¤æ˜“-å°é‡‘åº“è‡ªåŠ¨å…³è”                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ é¢„ç®—ç»“è½¬ä¸å‘¨æœŸç®¡ç†                                           â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µä¸‰ï¼šé‡‘èä¹ æƒ¯åŸ¹å…» (Beta-2)                                        â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ¶ˆè´¹å®¡è§†ç³»ç»Ÿ (ç¬¬6.2ç« )                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ SubscriptionTrackingService è®¢é˜…è¿½è¸ª                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ LatteFactorAnalyzer æ‹¿é“å› å­åˆ†æ                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ¶ˆè´¹æ´å¯Ÿä¸å¯æ“ä½œå»ºè®® (ActionableInsightService)              â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ OperationGuide æ“ä½œæŒ‡å—ç”Ÿæˆ                                  â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤ (ç¬¬6.3ç« )                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ImpulseControlService å†²åŠ¨æ¶ˆè´¹å¹²é¢„                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ CoolingOffPeriodService å†·é™æœŸæœåŠ¡                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ SpendingPlanningService å…ˆè§„åˆ’å†æ¶ˆè´¹å¼•å¯¼                     â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ WishListService æ„¿æœ›æ¸…å•ç®¡ç†                                 â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ è´¢åŠ¡ç¼“å†²å»ºç«‹ (ç¬¬6.4ç« )                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ FinancialBufferService åº”æ€¥é‡‘ç®¡ç†                            â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ DebtHealthService å€ºåŠ¡å¥åº·ç®¡ç†                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ DebtSnowballService å€ºåŠ¡é›ªçƒè¿˜æ¬¾è®¡åˆ’                         â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ å¼¹æ€§æ¿€åŠ±ç³»ç»Ÿ (ç¬¬6.5-6.6ç« )                                      â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ AdaptiveBudgetService å¼¹æ€§é¢„ç®—è°ƒæ•´                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ InclusiveMotivationService åŒ…å®¹æ€§è®°è´¦æ¿€åŠ±                    â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ SocialComparisonService ç¤¾ä¼šè®¤åŒå‚ç…§                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ FinancialCommitmentService æ‰¿è¯ºä¸€è‡´æœºåˆ¶                      â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µå››ï¼šAIæ™ºèƒ½åŒ–å¢å¼º (Beta-3)                                        â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ AIè¯†åˆ«ç³»ç»Ÿ (ç¬¬10ç« )                                              â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ EnhancedVoiceRecognitionService å®æ—¶è¯­éŸ³è¯†åˆ«                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ NLUService è‡ªç„¶è¯­è¨€ç†è§£æœåŠ¡                                  â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å¤šæ¨¡æ€è¾“å…¥ç»Ÿä¸€å¤„ç† (è¯­éŸ³/å›¾ç‰‡/æ–‡æœ¬)                          â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ (ç¬¬15ç« )                                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ç«¯ä¾§AIæ¨¡å‹éƒ¨ç½²                                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ç¦»çº¿æ™ºèƒ½åˆ†ç±»                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ éšç§ä¿æŠ¤è”é‚¦å­¦ä¹                                              â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ åœ°ç†ä½ç½®æ™ºèƒ½åŒ– (ç¬¬15ç« )                                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ LocationService ä½ç½®æœåŠ¡å±‚                                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ CrossRegionSpendingService å¼‚åœ°æ¶ˆè´¹æ£€æµ‹                      â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ GeofenceAlertService åœ°ç†å›´æ æé†’                            â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ LocationAwareMoneyAgeService ä½ç½®æ„ŸçŸ¥é’±é¾„                    â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µäº”ï¼šä½“éªŒè®¾è®¡ä¼˜åŒ– (RC-1)                                          â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ•°æ®è”åŠ¨ä¸å¯è§†åŒ– (ç¬¬12ç« )                                        â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ DrillDownNavigationService æ•°æ®ä¸‹é’»å¯¼èˆª                      â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ BreadcrumbStateManager é¢åŒ…å±‘çŠ¶æ€ç®¡ç†                        â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ äº¤äº’å¼å›¾è¡¨ç»„ä»¶ (åˆ†ç±»é¥¼å›¾ä¸‹é’»ã€è¶‹åŠ¿å›¾)                        â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ä¸‹é’»è¿‡æ¸¡åŠ¨ç”»                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ ç”¨æˆ·ä½“éªŒè®¾è®¡ (ç¬¬17ç« )                                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ Material Design 3 ä¸»é¢˜ç³»ç»Ÿ                                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ åŠ¨æ€è‰²å½©ä¸æ·±è‰²æ¨¡å¼                                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å¾®äº¤äº’åŠ¨ç”»                                                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ‰‹åŠ¿æ“ä½œä¼˜åŒ–                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ‡’äººè®¾è®¡åŸåˆ™ (ç¬¬3ç« )                                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æœ€å°‘æ“ä½œåŸåˆ™è½åœ°                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ™ºèƒ½é»˜è®¤å€¼ç³»ç»Ÿ                                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å•æ‰‹æ“ä½œä¼˜åŒ–                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ FeatureUsageWeightModel æ“ä½œæ•ˆç‡æ¨¡å‹                         â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µå…­ï¼šä¼™ä¼´åŒ–ä¸æƒ…æ„Ÿè®¾è®¡ (RC-2)                                      â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ ä¼™ä¼´åŒ–è®¾è®¡ (ç¬¬4ç« )                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ CompanionCopywritingService ä¼™ä¼´åŒ–æ–‡æ¡ˆç”Ÿæˆ                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ åœºæ™¯è¯†åˆ«å™¨ + æƒ…æ„Ÿåˆ†æå™¨                                      â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ åŠ¨æ€æ–‡æ¡ˆç¼“å­˜æ±                                                â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æƒ…æ„ŸåŒ–äº¤äº’åé¦ˆ                                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æ— éšœç¢è®¾è®¡ (ç¬¬5ç« )                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ SemanticLabelService è¯­ä¹‰åŒ–æ ‡ç­¾                              â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å±å¹•é˜…è¯»å™¨å®Œæ•´æ”¯æŒ                                           â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ é«˜å¯¹æ¯”åº¦æ¨¡å¼                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ è§¦æ§åŒºåŸŸä¼˜åŒ–                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ å›½é™…åŒ–ä¸æœ¬åœ°åŒ– (ç¬¬18ç« )                                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å¤šè¯­è¨€æ”¯æŒ (ä¸­/è‹±/æ—¥/éŸ©ç­‰)                                   â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ è´§å¸æ ¼å¼æœ¬åœ°åŒ–                                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ—¥æœŸæ—¶é—´æœ¬åœ°åŒ–                                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                      â†“                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  é˜¶æ®µä¸ƒï¼šè´¨é‡ä¿éšœä¸å‘å¸ƒ (Release)                                     â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ æµ‹è¯•ä¸è´¨é‡ (ç¬¬18-19ç« )                                          â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å•å…ƒæµ‹è¯• (55%) + Widgetæµ‹è¯• (25%)                            â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ é›†æˆæµ‹è¯• (15%) + E2Eæµ‹è¯• (5%)                                â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡éªŒè¯                                       â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šå›¾è¡¨æ¸²æŸ“ã€åˆ—è¡¨è™šæ‹ŸåŒ–                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ å®‰å…¨ä¸éšç§ (ç¬¬19ç« )                                             â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ•°æ®åŠ å¯†å­˜å‚¨                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ•æ„Ÿæ•°æ®è„±æ•                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æƒé™æœ€å°åŒ–åŸåˆ™                                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ å¯è§‚æµ‹æ€§ (ç¬¬22ç« )                                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ—¥å¿—é‡‡é›†ä¸åˆ†æ                                               â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ æ€§èƒ½ç›‘æ§æŒ‡æ ‡                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ é”™è¯¯è¿½è¸ªä¸å‘Šè­¦                                               â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘   â”‚
â”‚  â•‘  â”‚ ç‰ˆæœ¬è¿ç§»ä¸å‘å¸ƒ (ç¬¬23ç« )                                         â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ 1.x â†’ 2.0 æ•°æ®è¿ç§»è„šæœ¬                                       â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ å‡çº§å¼•å¯¼æµç¨‹                                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ åº”ç”¨å•†åº—å‡†å¤‡ (æˆªå›¾/æè¿°/ASO)                                 â”‚ â•‘   â”‚
â”‚  â•‘  â”‚  â€¢ ç°åº¦å‘å¸ƒ (10% â†’ 50% â†’ 100%)                                  â”‚ â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 27.2 ä»»åŠ¡æ¸…å•

#### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„å‡çº§ (Alpha)

**æ•°æ®å±‚**
- [ ] è®¾è®¡å¹¶å®ç°æ•°æ®åº“è¿ç§»è„šæœ¬ (v14 â†’ v20)
- [ ] å®ç° ResourcePool å’Œ ResourceConsumption æ•°æ®æ¨¡å‹
- [ ] å®ç° BudgetVault (å°é‡‘åº“) æ•°æ®æ¨¡å‹
- [ ] æ‰©å±• Transaction æ¨¡å‹ï¼Œæ·»åŠ  vault_idã€location_info å­—æ®µ
- [ ] è®¾è®¡å¹¶å®ç°æ•°æ®æ¨¡å‹ç‰ˆæœ¬å…¼å®¹å±‚

**æ¶æ„å±‚**
- [ ] å‡çº§è‡³ Riverpod 3.x Provider æ¶æ„
- [ ] é‡æ„æ‰€æœ‰ Provider ä¸º CrudNotifier ç»Ÿä¸€æ¨¡å¼
- [ ] å®ç° OfflineQueueService ç¦»çº¿é˜Ÿåˆ—æœåŠ¡
- [ ] å®ç° AutoSyncService è‡ªåŠ¨åŒæ­¥æœåŠ¡
- [ ] å®ç°å†²çªæ£€æµ‹ä¸è§£å†³ç­–ç•¥

#### é˜¶æ®µäºŒï¼šæ ¸å¿ƒä¸šåŠ¡å¼•æ“ (Beta-1)

**é’±é¾„ç³»ç»Ÿ**
- [ ] å®ç° MoneyAgeCalculator é’±é¾„è®¡ç®—å¼•æ“
- [ ] å®ç° FIFO/LIFO/åŠ æƒå¹³å‡ æ¶ˆè´¹é¡ºåºç­–ç•¥
- [ ] å®ç°å†å²æ•°æ®é’±é¾„é‡å»ºæœåŠ¡
- [ ] å®ç°é’±é¾„è¶‹åŠ¿åˆ†æä¸é¢„æµ‹ç®—æ³•
- [ ] å®ç°é’±é¾„ä»ªè¡¨ç›˜å¡ç‰‡ç»„ä»¶
- [ ] å®ç°é’±é¾„è¶‹åŠ¿å›¾ï¼ˆæ”¯æŒç‚¹å‡»ä¸‹é’»ï¼‰
- [ ] å®ç°é’±é¾„è¯¦æƒ…é¡µ

**é›¶åŸºé¢„ç®—ç³»ç»Ÿ**
- [ ] å®ç° AllocationService é¢„ç®—åˆ†é…æœåŠ¡
- [ ] å®ç°æ™ºèƒ½åˆ†é…å»ºè®®ç®—æ³•
- [ ] å®ç°å°é‡‘åº“ CRUD å®Œæ•´åŠŸèƒ½
- [ ] å®ç°äº¤æ˜“-å°é‡‘åº“è‡ªåŠ¨å…³è”é€»è¾‘
- [ ] å®ç°é¢„ç®—ç»“è½¬ä¸å‘¨æœŸç®¡ç†
- [ ] å®ç°å°é‡‘åº“æ¦‚è§ˆé¡µ
- [ ] å®ç°èµ„é‡‘åˆ†é…é¡µ

#### é˜¶æ®µä¸‰ï¼šé‡‘èä¹ æƒ¯åŸ¹å…» (Beta-2)

**æ¶ˆè´¹å®¡è§†ç³»ç»Ÿ**
- [ ] å®ç° SubscriptionTrackingService è®¢é˜…è¿½è¸ªæœåŠ¡
- [ ] å®ç°è®¢é˜…æµªè´¹æ£€æµ‹ä¸æé†’
- [ ] å®ç° LatteFactorAnalyzer æ‹¿é“å› å­åˆ†æ
- [ ] å®ç° ActionableInsightService å¯æ“ä½œæ´å¯ŸæœåŠ¡
- [ ] å®ç° OperationGuide æ“ä½œæŒ‡å—ç”Ÿæˆï¼ˆå«å–æ¶ˆè®¢é˜…æŒ‡å—ï¼‰
- [ ] å®ç° GuideLifecycleManager æŒ‡å—ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å†²åŠ¨æ¶ˆè´¹é˜²æŠ¤**
- [ ] å®ç° ImpulseControlService å†²åŠ¨æ¶ˆè´¹å¹²é¢„æœåŠ¡
- [ ] å®ç° CoolingOffPeriodService å†·é™æœŸæœåŠ¡
- [ ] å®ç° SpendingPlanningService å…ˆè§„åˆ’å†æ¶ˆè´¹å¼•å¯¼
- [ ] å®ç° WishListService æ„¿æœ›æ¸…å•ç®¡ç†
- [ ] å®ç° MonthlyPlanningCard æœˆåº¦è§„åˆ’å¡ç‰‡

**è´¢åŠ¡ç¼“å†²å»ºç«‹**
- [ ] å®ç° FinancialBufferService åº”æ€¥é‡‘ç®¡ç†æœåŠ¡
- [ ] å®ç°åº”æ€¥é‡‘ç›®æ ‡è®¾å®šä¸è¿›åº¦è¿½è¸ª
- [ ] å®ç° DebtHealthService å€ºåŠ¡å¥åº·ç®¡ç†æœåŠ¡
- [ ] å®ç° DebtSnowballService å€ºåŠ¡é›ªçƒè¿˜æ¬¾è®¡åˆ’
- [ ] å®ç° DebtHealthCard å€ºåŠ¡å¥åº·å¡ç‰‡

**å¼¹æ€§æ¿€åŠ±ç³»ç»Ÿ**
- [ ] å®ç° AdaptiveBudgetService å¼¹æ€§é¢„ç®—è°ƒæ•´æœåŠ¡
- [ ] å®ç° InclusiveMotivationService åŒ…å®¹æ€§è®°è´¦æ¿€åŠ±
- [ ] å®ç° FlexibleRecordingGoal å¼¹æ€§è®°è´¦ç›®æ ‡
- [ ] å®ç° BreakRecoveryAssistant ä¸­æ–­æ¢å¤åŠ©æ‰‹
- [ ] å®ç° SocialComparisonService ç¤¾ä¼šè®¤åŒå‚ç…§æœåŠ¡
- [ ] å®ç° PeerComparisonCard åŒç±»ç”¨æˆ·å¯¹æ¯”å¡ç‰‡
- [ ] å®ç° FinancialCommitmentService æ‰¿è¯ºä¸€è‡´æœºåˆ¶
- [ ] å®ç° CommitmentCreationWizard æ‰¿è¯ºåˆ›å»ºå‘å¯¼
- [ ] å®ç° CommitmentProgressCard æ‰¿è¯ºè¿›åº¦å¡ç‰‡

#### é˜¶æ®µå››ï¼šAIæ™ºèƒ½åŒ–å¢å¼º (Beta-3)

**AIè¯†åˆ«ç³»ç»Ÿ**
- [ ] å®ç° EnhancedVoiceRecognitionService å®æ—¶è¯­éŸ³è¯†åˆ«
- [ ] å®ç° NLUService è‡ªç„¶è¯­è¨€ç†è§£æœåŠ¡
- [ ] å®ç°å¤šæ¨¡æ€è¾“å…¥ç»Ÿä¸€å¤„ç†ï¼ˆè¯­éŸ³/å›¾ç‰‡/æ–‡æœ¬ï¼‰
- [ ] ä¼˜åŒ–è¯­éŸ³è¯†åˆ«å‡†ç¡®ç‡ä¸å“åº”é€Ÿåº¦
- [ ] å®ç°å›¾åƒOCRç¥¨æ®è¯†åˆ«å¢å¼º

**æ™ºèƒ½åŒ–æŠ€æœ¯æ–¹æ¡ˆ**
- [ ] ç«¯ä¾§AIæ¨¡å‹è¯„ä¼°ä¸é€‰å‹
- [ ] å®ç°ç¦»çº¿æ™ºèƒ½åˆ†ç±»åŠŸèƒ½
- [ ] å®ç°ç”¨æˆ·è¡Œä¸ºå­¦ä¹ ä¸é¢„æµ‹
- [ ] éšç§ä¿æŠ¤è”é‚¦å­¦ä¹ æ–¹æ¡ˆè®¾è®¡

**åœ°ç†ä½ç½®æ™ºèƒ½åŒ–**
- [ ] å®ç° LocationService ä½ç½®æœåŠ¡æŠ½è±¡å±‚
- [ ] å®ç° PreciseLocationService GPSé«˜ç²¾åº¦å®šä½
- [ ] å®ç° ApproximateLocationService ç½‘ç»œç²—ç•¥å®šä½
- [ ] å®ç° CrossRegionSpendingService å¼‚åœ°æ¶ˆè´¹æ£€æµ‹
- [ ] å®ç° GeofenceAlertService åœ°ç†å›´æ æé†’
- [ ] å®ç° LocationAwareMoneyAgeService ä½ç½®æ„ŸçŸ¥é’±é¾„
- [ ] å®ç° SpendingContextAnalyzer æ¶ˆè´¹åœºæ™¯åˆ†æ

#### é˜¶æ®µäº”ï¼šä½“éªŒè®¾è®¡ä¼˜åŒ– (RC-1)

**æ•°æ®è”åŠ¨ä¸å¯è§†åŒ–**
- [ ] å®ç° DrillDownNavigationService æ•°æ®ä¸‹é’»å¯¼èˆªæœåŠ¡
- [ ] å®ç° BreadcrumbStateManager é¢åŒ…å±‘çŠ¶æ€ç®¡ç†
- [ ] å®ç°äº¤äº’å¼åˆ†ç±»é¥¼å›¾ï¼ˆæ”¯æŒä¸‹é’»ï¼‰
- [ ] å®ç°è¶‹åŠ¿å›¾äº¤äº’ç»„ä»¶
- [ ] å®ç°ä¸‹é’»è¿‡æ¸¡åŠ¨ç”»æ•ˆæœ

**ç”¨æˆ·ä½“éªŒè®¾è®¡**
- [ ] å®ç° Material Design 3 å®Œæ•´ä¸»é¢˜ç³»ç»Ÿ
- [ ] å®ç°åŠ¨æ€è‰²å½©ç”Ÿæˆä¸åº”ç”¨
- [ ] å®ç°æ·±è‰²æ¨¡å¼å®Œæ•´é€‚é…
- [ ] å®ç°å¾®äº¤äº’åŠ¨ç”»åº“
- [ ] ä¼˜åŒ–æ‰‹åŠ¿æ“ä½œä½“éªŒ

**æ‡’äººè®¾è®¡åŸåˆ™è½åœ°**
- [ ] å®ç°æœ€å°‘æ“ä½œåŸåˆ™ç›¸å…³ä¼˜åŒ–
- [ ] å®ç°æ™ºèƒ½é»˜è®¤å€¼ç³»ç»Ÿ
- [ ] ä¼˜åŒ–å•æ‰‹æ“ä½œä½“éªŒ
- [ ] å®ç° FeatureUsageWeightModel æ“ä½œæ•ˆç‡æ¨¡å‹
- [ ] å®ç°æ¸è¿›å¼å¤æ‚åº¦åŠŸèƒ½å±•ç¤º

**å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ï¼ˆç¬¬13ç« ï¼‰**
- [ ] å®ç° Ledger è´¦æœ¬æ•°æ®æ¨¡å‹ï¼ˆä¸ªäºº/å®¶åº­/æƒ…ä¾£/ç¾¤ç»„/ä¸“é¡¹ï¼‰
- [ ] å®ç° LedgerService è´¦æœ¬ç®¡ç†æœåŠ¡
- [ ] å®ç° MemberService æˆå‘˜ç®¡ç†æœåŠ¡
- [ ] å®ç°é‚€è¯·ç ç”Ÿæˆä¸éªŒè¯æœºåˆ¶
- [ ] å®ç°äºŒç»´ç é‚€è¯·åŠŸèƒ½
- [ ] å®ç°æˆå‘˜è§’è‰²æƒé™ç³»ç»Ÿï¼ˆæ‰€æœ‰è€…/ç®¡ç†å‘˜/æˆå‘˜/åªè¯»ï¼‰
- [ ] å®ç°å®¶åº­é¢„ç®—åˆ†é…ä¸é…é¢ç®¡ç†
- [ ] å®ç° SplitService AAåˆ†æ‘ŠæœåŠ¡
- [ ] å®ç°å¤šç§åˆ†æ‘Šç­–ç•¥ï¼ˆå‡æ‘Š/æŒ‰æ¯”ä¾‹/è‡ªå®šä¹‰ï¼‰
- [ ] å®ç°åˆ†æ‘Šç»“ç®—ä¸æé†’åŠŸèƒ½
- [ ] å®ç°å®¶åº­è´¦æœ¬åŒæ­¥æœåŠ¡ (FamilyLedgerSyncService)
- [ ] å®ç°è´¦æœ¬åˆ‡æ¢ä¸æ•°æ®éš”ç¦»
- [ ] å®ç°å®¶åº­æˆå‘˜è´¡çŒ®åˆ†æ
- [ ] å®ç°å®¶åº­æŠ¥è¡¨ä¸è¶‹åŠ¿åˆ†æ
- [ ] å®ç°éšç§å¯è§æ€§æ§åˆ¶ï¼ˆè´¦ç›®å¯¹æˆå‘˜çš„å¯è§æ€§ï¼‰

#### é˜¶æ®µå…­ï¼šä¼™ä¼´åŒ–ä¸æƒ…æ„Ÿè®¾è®¡ (RC-2)

**ä¼™ä¼´åŒ–è®¾è®¡**
- [ ] å®ç° CompanionCopywritingService ä¼™ä¼´åŒ–æ–‡æ¡ˆç”ŸæˆæœåŠ¡
- [ ] å®ç°åœºæ™¯è¯†åˆ«å™¨
- [ ] å®ç°æƒ…æ„Ÿåˆ†æå™¨
- [ ] å®ç°åŠ¨æ€æ–‡æ¡ˆç¼“å­˜æ± 
- [ ] å®ç°æƒ…æ„ŸåŒ–äº¤äº’åé¦ˆç³»ç»Ÿ
- [ ] é¢„ç”Ÿæˆæ–‡æ¡ˆåº“ï¼ˆæ”¯æŒç¦»çº¿ä½¿ç”¨ï¼‰

**æ— éšœç¢è®¾è®¡**
- [ ] å®ç° SemanticLabelService è¯­ä¹‰åŒ–æ ‡ç­¾æœåŠ¡
- [ ] å®Œå–„å±å¹•é˜…è¯»å™¨æ”¯æŒï¼ˆTalkBack/VoiceOverï¼‰
- [ ] å®ç°é«˜å¯¹æ¯”åº¦æ¨¡å¼
- [ ] ä¼˜åŒ–è§¦æ§åŒºåŸŸå°ºå¯¸ï¼ˆæœ€å°48x48dpï¼‰
- [ ] å®ç°é”®ç›˜å¯¼èˆªæ”¯æŒ

**å›½é™…åŒ–ä¸æœ¬åœ°åŒ–**
- [ ] å®Œå–„å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­/è‹±/æ—¥/éŸ©ï¼‰
- [ ] å®ç°è´§å¸æ ¼å¼æœ¬åœ°åŒ–
- [ ] å®ç°æ—¥æœŸæ—¶é—´æœ¬åœ°åŒ–
- [ ] å®ç°æ•°å­—æ ¼å¼æœ¬åœ°åŒ–
- [ ] å®ç° RTL å¸ƒå±€æ”¯æŒ

#### é˜¶æ®µä¸ƒï¼šè´¨é‡ä¿éšœä¸å‘å¸ƒ (Release)

**æµ‹è¯•ä¸è´¨é‡**
- [ ] ç¼–å†™æ ¸å¿ƒä¸šåŠ¡å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡â‰¥55%ï¼‰
- [ ] ç¼–å†™ Widget æµ‹è¯•ï¼ˆè¦†ç›–ç‡â‰¥25%ï¼‰
- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆè¦†ç›–ç‡â‰¥15%ï¼‰
- [ ] ç¼–å†™ E2E ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆè¦†ç›–ç‡â‰¥5%ï¼‰
- [ ] å¼‚å¸¸å¤„ç†ä¸å®¹é”™è®¾è®¡éªŒè¯
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šå›¾è¡¨æ¸²æŸ“ä¼˜åŒ–
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šåˆ—è¡¨è™šæ‹ŸåŒ–
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šå†…å­˜å ç”¨ä¼˜åŒ–

**å®‰å…¨ä¸éšç§**
- [ ] å®ç°æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] å®ç°æ•æ„Ÿæ•°æ®å±•ç¤ºè„±æ•
- [ ] æƒé™æœ€å°åŒ–åŸåˆ™å®¡æŸ¥
- [ ] å®‰å…¨æ¼æ´æ‰«æä¸ä¿®å¤

**å¯è§‚æµ‹æ€§**
- [ ] å®ç°æ—¥å¿—é‡‡é›†ä¸åˆ†æç³»ç»Ÿ
- [ ] å®ç°æ€§èƒ½ç›‘æ§æŒ‡æ ‡ä¸ŠæŠ¥
- [ ] å®ç°é”™è¯¯è¿½è¸ªä¸å‘Šè­¦æœºåˆ¶
- [ ] å®ç°ç”¨æˆ·è¡Œä¸ºåˆ†æåŸ‹ç‚¹

**ç‰ˆæœ¬è¿ç§»ä¸å‘å¸ƒ**
- [ ] å®ç° 1.x â†’ 2.0 æ•°æ®è¿ç§»è„šæœ¬
- [ ] å®ç°æ™ºèƒ½å‡çº§å¤‡ä»½ç­–ç•¥
- [ ] è®¾è®¡å¹¶å®ç°å‡çº§å¼•å¯¼æµç¨‹
- [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£
- [ ] æ›´æ–° API æ–‡æ¡£
- [ ] å‡†å¤‡åº”ç”¨å•†åº—æˆªå›¾å’Œæè¿°
- [ ] ASO ä¼˜åŒ–ï¼ˆå…³é”®è¯ã€æè¿°ï¼‰
- [ ] å†…éƒ¨ç°åº¦æµ‹è¯•
- [ ] ç°åº¦å‘å¸ƒ (10% â†’ 50% â†’ 100%)
- [ ] æ­£å¼å‘å¸ƒä¸ç‰ˆæœ¬ç›‘æ§

#### é˜¶æ®µå…«ï¼šç”¨æˆ·å¢é•¿ä½“ç³» (Post-Launch)

**NPSç›‘æµ‹ä¸å£ç¢‘ä¼˜åŒ–ï¼ˆç¬¬28ç« ï¼‰**
- [ ] å®ç°åº”ç”¨å†…NPSè°ƒæŸ¥ç»„ä»¶ï¼ˆæ™ºèƒ½è§¦å‘æ—¶æœºï¼‰
- [ ] å®ç°NPSæ•°æ®é‡‡é›†ä¸åˆ†ææœåŠ¡
- [ ] å®ç°ç”¨æˆ·åˆ†ç¾¤ç­–ç•¥ï¼ˆæ¨èè€…/è¢«åŠ¨è€…/è´¬æŸè€…ï¼‰
- [ ] å®ç°é’ˆå¯¹æ€§åé¦ˆæ”¶é›†ä¸å“åº”æœºåˆ¶
- [ ] å®ç°å£ç¢‘åˆ†äº«ç´ æè‡ªåŠ¨ç”Ÿæˆ
- [ ] å®ç°æˆå°±å¾½ç« ä¸é‡Œç¨‹ç¢‘åˆ†äº«åŠŸèƒ½
- [ ] å®ç°åº”ç”¨å•†åº—å¥½è¯„å¼•å¯¼æµç¨‹

**ç¤¾äº¤è£‚å˜ä¸ä½æˆæœ¬è·å®¢ï¼ˆç¬¬29ç« ï¼‰**
- [ ] å®ç°å®¶åº­/æƒ…ä¾£è®°è´¦é‚€è¯·ç æœºåˆ¶
- [ ] å®ç°é‚€è¯·å¥–åŠ±ç³»ç»Ÿï¼ˆåŒå‘æ¿€åŠ±ï¼‰
- [ ] å®ç°ç¤¾äº¤åˆ†äº«ç»„ä»¶ï¼ˆå¾®ä¿¡/æœ‹å‹åœˆ/å¾®åšï¼‰
- [ ] å®ç°è´¦å•åˆ†äº«å¡ç‰‡è®¾è®¡ä¸ç”Ÿæˆ
- [ ] å®ç°é‚€è¯·æ¼æ–—æ•°æ®åŸ‹ç‚¹ä¸åˆ†æ
- [ ] å®ç° A/B æµ‹è¯•æ¡†æ¶ï¼ˆé‚€è¯·æ–‡æ¡ˆ/å¥–åŠ±ç­–ç•¥ï¼‰

**ASOä¸å†…å®¹è¥é”€å‡†å¤‡**
- [ ] å®Œå–„åº”ç”¨å•†åº—å…³é”®è¯ä¼˜åŒ–
- [ ] å‡†å¤‡ç†è´¢çŸ¥è¯†å°è´´å£«å†…å®¹åº“
- [ ] å®ç°è®°è´¦æŠ€å·§å¡ç‰‡åˆ†äº«åŠŸèƒ½
- [ ] å®ç°ç”¨æˆ·æ•…äº‹æ”¶é›†ä¸å±•ç¤ºæ¨¡å—

> **æ³¨**ï¼šé˜¶æ®µå…«ä¸ºå‘å¸ƒåæŒç»­è¿­ä»£å†…å®¹ï¼Œä¸é˜¶æ®µä¸ƒå¯å¹¶è¡Œæ¨è¿›éƒ¨åˆ†ä»»åŠ¡

> **æ³¨**ï¼šæµ‹è¯•ç­–ç•¥å·²ç‹¬ç«‹ä¸ºå•ç‹¬æ–‡æ¡£ï¼Œè¯¦è§ [AIæ™ºèƒ½è®°è´¦ 2.0 æµ‹è¯•ç­–ç•¥](./app_v2_test_strategy.md)

> ğŸ“ **ç›¸å…³æ–‡æ¡£**ï¼šå®Œæ•´çš„3å¹´æˆ˜ç•¥ç›®æ ‡ï¼ˆè´¢åŠ¡/ç”¨æˆ·/äº§å“/å¸‚åœºï¼‰ã€OKRåˆ†è§£ã€èµ„æºé…ç½®åŠé£é™©ç®¡ç†è§[AIæ™ºèƒ½è®°è´¦2.0æˆ˜ç•¥åˆ†ææŠ¥å‘Šï¼ˆäº”çœ‹ä¸‰å®šï¼‰](../AIæ™ºèƒ½è®°è´¦2.0æˆ˜ç•¥åˆ†ææŠ¥å‘Šï¼ˆäº”çœ‹ä¸‰å®šï¼‰.md#8-ç¬¬äºŒå®šå®šç›®æ ‡)

---

---

## 28. ç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡

### 28.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

| åŸåˆ™ | åº”ç”¨æ–¹å¼ |
|------|----------|
| **æ‡’äººè®¾è®¡** | å£ç¢‘åˆ†äº«ä¸€é”®å®Œæˆï¼Œæ— éœ€å¤æ‚æ“ä½œ |
| **ä¼™ä¼´åŒ–è®¾è®¡** | é€šè¿‡æƒ…æ„Ÿè¿æ¥åŸ¹å…»æ¨èè€… |
| **ç”¨æˆ·ä¼˜å…ˆ** | ä»¥ç”¨æˆ·çœŸå®ä»·å€¼ä¸ºå£ç¢‘åŸºç¡€ï¼Œè€Œéè¥é”€æ‰‹æ®µ |

#### 28.0.1 NPSä¸äº§å“æˆåŠŸçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NPSé©±åŠ¨å¢é•¿é£è½®                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                      â”Œâ”€â”€â”€â–ºâ”‚  æ¨èè€…å¢åŠ    â”‚â”€â”€â”€â”                         â”‚
â”‚                      â”‚    â”‚  (NPSæå‡)   â”‚   â”‚                         â”‚
â”‚                      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                         â”‚
â”‚                      â”‚                       â–¼                         â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚               â”‚  äº§å“ä½“éªŒä¼˜åŒ– â”‚        â”‚  å£ç¢‘ä¼ æ’­    â”‚                 â”‚
â”‚               â”‚  (ä»·å€¼äº¤ä»˜)   â”‚        â”‚  (è‡ªç„¶è·å®¢)  â”‚                 â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                      â–²                       â”‚                         â”‚
â”‚                      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                         â”‚
â”‚                      â””â”€â”€â”€â”€â”‚  ç”¨æˆ·åé¦ˆ    â”‚â—„â”€â”€â”˜                         â”‚
â”‚                           â”‚  (æŒç»­æ”¹è¿›)  â”‚                              â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â”‚  ã€æ ¸å¿ƒç†å¿µã€‘NPSä¸æ˜¯è¥é”€æŒ‡æ ‡ï¼Œè€Œæ˜¯äº§å“ä»·å€¼çš„çœŸå®åæ˜                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 28.0.2 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NPSæå‡ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„ååŒ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  ä¼™ä¼´åŒ–è®¾è®¡    â”‚  â”‚  ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ  â”‚  â”‚  é’±é¾„åˆ†æç³»ç»Ÿ  â”‚               â”‚
â”‚  â”‚  (ç¬¬4ç« )      â”‚  â”‚  (ç¬¬9ç« )      â”‚  â”‚  (ç¬¬7ç« )      â”‚               â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚               â”‚
â”‚  â”‚ æƒ…æ„Ÿè¿æ¥â†’    â”‚  â”‚ æˆå°±ç³»ç»Ÿâ†’    â”‚  â”‚ å·®å¼‚åŒ–ä»·å€¼â†’  â”‚               â”‚
â”‚  â”‚ æ¨èè€…åŸ¹è‚²   â”‚  â”‚ åˆ†äº«ç´ æ     â”‚  â”‚ å£ç¢‘ä¼ æ’­ç‚¹   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                 â”‚                 â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â–¼                                             â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                â”‚  NPSæå‡è®¾è®¡ (æœ¬ç« )  â”‚                                 â”‚
â”‚                â”‚                     â”‚                                 â”‚
â”‚                â”‚  â€¢ æƒŠå–œæ—¶åˆ»ç³»ç»Ÿ     â”‚                                 â”‚
â”‚                â”‚  â€¢ å£ç¢‘åˆ†äº«æœºåˆ¶     â”‚                                 â”‚
â”‚                â”‚  â€¢ è´Ÿé¢ä½“éªŒä¿®å¤     â”‚                                 â”‚
â”‚                â”‚  â€¢ æ¨èè€…åŸ¹è‚²       â”‚                                 â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â–¼                â–¼                â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  æ•°æ®å¯è§†åŒ–    â”‚ â”‚  å›½é™…åŒ–ç³»ç»Ÿ    â”‚ â”‚  ç”¨æˆ·ä½“éªŒè®¾è®¡  â”‚                â”‚
â”‚  â”‚  (ç¬¬12ç« )     â”‚ â”‚  (ç¬¬21ç« )     â”‚ â”‚  (ç¬¬20ç« )     â”‚                â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚                â”‚
â”‚  â”‚ åˆ†äº«å¡ç‰‡è®¾è®¡  â”‚ â”‚ å¤šè¯­è¨€åˆ†äº«    â”‚ â”‚ é¦–å‘¨ä½“éªŒä¼˜åŒ–  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 28.1 NPSç›®æ ‡ä¸ç›‘æµ‹æœºåˆ¶

#### 28.1.1 NPSç›®æ ‡è®¾å®š

| é˜¶æ®µ | æ—¶é—´èŠ‚ç‚¹ | NPSç›®æ ‡ | è¯´æ˜ |
|------|----------|---------|------|
| **MVPéªŒè¯æœŸ** | ä¸Šçº¿å3ä¸ªæœˆ | â‰¥30 | éªŒè¯æ ¸å¿ƒä»·å€¼è¢«è®¤å¯ |
| **å¢é•¿æœŸ** | ä¸Šçº¿å6ä¸ªæœˆ | â‰¥40 | å£ç¢‘å¼€å§‹ä¼ æ’­ |
| **æˆç†ŸæœŸ** | ä¸Šçº¿å12ä¸ªæœˆ | â‰¥50 | å½¢æˆå£ç¢‘é£è½® |
| **é¢†å…ˆæœŸ** | ä¸Šçº¿å24ä¸ªæœˆ | â‰¥60 | è¡Œä¸šé¢†å…ˆæ°´å¹³ |

#### 28.1.2 NPSç›‘æµ‹ä½“ç³»

```dart
/// NPSç›‘æµ‹æœåŠ¡
class NpsMonitoringService {
  /// NPSè°ƒæŸ¥è§¦å‘æ—¶æœº
  static const surveyTriggers = [
    NpsSurveyTrigger(
      event: 'first_week_completed',
      delay: Duration(days: 7),
      description: 'ä½¿ç”¨æ»¡ä¸€å‘¨åé¦–æ¬¡æ”¶é›†',
    ),
    NpsSurveyTrigger(
      event: 'monthly_active_user',
      interval: Duration(days: 90),
      description: 'æ´»è·ƒç”¨æˆ·æ¯90å¤©è°ƒæŸ¥ä¸€æ¬¡',
    ),
    NpsSurveyTrigger(
      event: 'milestone_achieved',
      milestones: ['money_age_30_days', 'savings_goal_completed', 'streak_30_days'],
      description: 'è¾¾æˆé‡è¦é‡Œç¨‹ç¢‘åè°ƒæŸ¥',
    ),
    NpsSurveyTrigger(
      event: 'feature_intensive_use',
      threshold: 50,  // ä½¿ç”¨æŸåŠŸèƒ½50æ¬¡ä»¥ä¸Š
      description: 'æ·±åº¦ä½¿ç”¨æŸåŠŸèƒ½åè°ƒæŸ¥è¯¥åŠŸèƒ½NPS',
    ),
  ];

  /// NPSé—®å·è®¾è®¡
  /// ã€æ— éšœç¢è®¾è®¡ã€‘å‚è€ƒç¬¬5ç« ï¼Œæä¾›å¤šç§è¾“å…¥æ–¹å¼
  Future<NpsSurveyResult> conductSurvey(String userId) async {
    // æ ¸å¿ƒé—®é¢˜ - æ”¯æŒå¤šç§æ— éšœç¢è¾“å…¥æ–¹å¼
    final score = await _askNpsQuestion(
      question: 'æ‚¨æœ‰å¤šå¤§å¯èƒ½å‘æœ‹å‹æˆ–åŒäº‹æ¨èAIæ™ºèƒ½è®°è´¦ï¼Ÿ',
      scale: 10,  // 0-10åˆ†
      // ã€æ— éšœç¢ã€‘è¯„åˆ†è¾“å…¥æ–¹å¼
      inputMethods: [
        NpsInputMethod.slider,      // æ»‘å—ï¼ˆé»˜è®¤ï¼‰
        NpsInputMethod.numberButtons, // æ•°å­—æŒ‰é’®ï¼ˆè¿åŠ¨éšœç¢å‹å¥½ï¼‰
        NpsInputMethod.voiceInput,  // è¯­éŸ³è¾“å…¥ï¼ˆè§†éšœå‹å¥½ï¼‰
      ],
      // ã€æ— éšœç¢ã€‘è¯­ä¹‰åŒ–è¯„åˆ†è¯´æ˜
      accessibilityHints: {
        0: '0åˆ†ï¼Œå®Œå…¨ä¸å¯èƒ½æ¨è',
        5: '5åˆ†ï¼Œä¸­ç«‹æ€åº¦',
        10: '10åˆ†ï¼Œéå¸¸æ„¿æ„æ¨è',
      },
    );

    // è¿½é—®åŸå› ï¼ˆæ ¹æ®åˆ†æ•°åˆ†ç±»ï¼‰
    String? reason;
    if (score >= 9) {
      // æ¨èè€…ï¼šäº†è§£æ¨èåŠ¨åŠ›
      // ã€æ‡’äººè®¾è®¡ã€‘æä¾›ä¸°å¯Œçš„é¢„è®¾é€‰é¡¹ï¼Œå‡å°‘ç”¨æˆ·è¾“å…¥
      reason = await _askOpenQuestion(
        question: 'å¤ªæ£’äº†ï¼æ˜¯ä»€ä¹ˆè®©æ‚¨æ„¿æ„æ¨èæˆ‘ä»¬ï¼Ÿ',
        suggestions: [
          'é’±é¾„åˆ†æè®©æˆ‘çŸ¥é“é’±èŠ±å“ªäº†',
          'è¯­éŸ³è®°è´¦å¤ªæ–¹ä¾¿äº†',
          'é¢„ç®—ç®¡ç†å¸®æˆ‘çœäº†ä¸å°‘é’±',
          'ç•Œé¢ç®€æ´å¥½çœ‹',
          'è®°è´¦ä¹ æƒ¯ç»ˆäºå…»æˆäº†',
          'å®¶åº­è´¦æœ¬å¾ˆå®ç”¨',
        ],
        allowMultiple: true,  // å…è®¸å¤šé€‰
        skipOption: 'ç›´æ¥æäº¤',  // å¯è·³è¿‡è¯¦ç»†åé¦ˆ
      );
    } else if (score >= 7) {
      // è¢«åŠ¨è€…ï¼šäº†è§£æå‡ç©ºé—´
      // ã€æ‡’äººè®¾è®¡ã€‘æä¾›å¸¸è§æ”¹è¿›æ–¹å‘é€‰é¡¹
      reason = await _askOpenQuestion(
        question: 'æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼æˆ‘ä»¬è¿˜èƒ½åšäº›ä»€ä¹ˆè®©æ‚¨æ›´æ»¡æ„ï¼Ÿ',
        suggestions: [
          'å¸Œæœ›åŒæ­¥ï¿½ï¿½å¿«',
          'å¸Œæœ›å¢åŠ æ›´å¤šå›¾è¡¨',
          'å¸Œæœ›æ”¯æŒæ›´å¤šé“¶è¡Œå¯¼å…¥',
          'å¸Œæœ›æœ‰æ¡Œé¢ç‰ˆ',
          'ç›®å‰æŒºå¥½çš„',
        ],
        skipOption: 'æš‚æ—¶æ²¡æœ‰å»ºè®®',
      );
    } else {
      // è´¬æŸè€…ï¼šäº†è§£é—®é¢˜æ‰€åœ¨
      // ã€æ‡’äººè®¾è®¡ã€‘æä¾›å¸¸è§é—®é¢˜é€‰é¡¹ï¼Œé™ä½åé¦ˆé—¨æ§›
      reason = await _askOpenQuestion(
        question: 'å¾ˆæŠ±æ­‰æ²¡èƒ½è®©æ‚¨æ»¡æ„ï¼Œèƒ½å‘Šè¯‰æˆ‘ä»¬å“ªé‡Œéœ€è¦æ”¹è¿›å—ï¼Ÿ',
        suggestions: [
          'æ“ä½œå¤ªå¤æ‚',
          'åŠŸèƒ½ä¸å¤Ÿç”¨',
          'Appç»å¸¸å¡é¡¿',
          'æ•°æ®åŒæ­¥æœ‰é—®é¢˜',
          'ç•Œé¢ä¸å¥½çœ‹',
          'å¹¿å‘Šå¤ªå¤š',  // è™½ç„¶æˆ‘ä»¬æ²¡å¹¿å‘Šï¼Œä½†ç”¨æˆ·å¯èƒ½è¯¯è§£
        ],
        allowMultiple: true,
        requireSelection: true,  // è´¬æŸè€…å¿…é¡»é€‰æ‹©è‡³å°‘ä¸€é¡¹
      );
    }

    return NpsSurveyResult(
      userId: userId,
      score: score,
      reason: reason,
      timestamp: DateTime.now(),
      context: await _captureContext(),  // è®°å½•è°ƒæŸ¥æ—¶çš„ä¸Šä¸‹æ–‡
    );
  }

  /// NPSè®¡ç®—
  double calculateNps(List<NpsSurveyResult> results) {
    if (results.isEmpty) return 0;

    int promoters = 0;   // 9-10åˆ†
    int detractors = 0;  // 0-6åˆ†

    for (final result in results) {
      if (result.score >= 9) {
        promoters++;
      } else if (result.score <= 6) {
        detractors++;
      }
    }

    final promoterRate = promoters / results.length * 100;
    final detractorRate = detractors / results.length * 100;

    return promoterRate - detractorRate;
  }
}
```

#### 28.1.3 NPSåˆ†è§£åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NPSé©±åŠ¨å› ç´ åˆ†è§£                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æ€»ä½“NPS = f(åŠŸèƒ½ä»·å€¼, ä½“éªŒè´¨é‡, æƒ…æ„Ÿè¿æ¥, ä¿¡ä»»åº¦)                        â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŠŸèƒ½ä»·å€¼ (40%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ é’±é¾„åˆ†ææœ‰ç”¨æ€§                                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ é¢„ç®—ç®¡ç†æ•ˆæœ                                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ AIè¯†åˆ«å‡†ç¡®æ€§                                                â”‚   â”‚
â”‚  â”‚  â””â”€ ä¹ æƒ¯åŸ¹å…»æˆæ•ˆ                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä½“éªŒè´¨é‡ (30%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ è®°è´¦ä¾¿æ·æ€§                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç•Œé¢ç¾è§‚åº¦                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ“ä½œæµç•…æ€§                                                  â”‚   â”‚
â”‚  â”‚  â””â”€ å­¦ä¹ æˆæœ¬ä½                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æƒ…æ„Ÿè¿æ¥ (20%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ ä¼™ä¼´æ„Ÿå—                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ æˆå°±æ„Ÿè·å¾—                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ æƒŠå–œä½“éªŒ                                                    â”‚   â”‚
â”‚  â”‚  â””â”€ è¢«ç†è§£æ„Ÿ                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¿¡ä»»åº¦ (10%)                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ•°æ®å®‰å…¨æ„Ÿ                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ éšç§ä¿æŠ¤                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç®—æ³•é€æ˜                                                    â”‚   â”‚
â”‚  â”‚  â””â”€ ç¨³å®šå¯é                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 28.2 æƒŠå–œæ—¶åˆ»ç³»ç»Ÿè®¾è®¡

#### 28.2.1 æƒŠå–œæ—¶åˆ»å®šä¹‰

æƒŠå–œæ—¶åˆ»(Delight Moments)æ˜¯æŒ‡è¶…å‡ºç”¨æˆ·é¢„æœŸã€å¸¦æ¥æ„‰æ‚¦æ„Ÿçš„äº§å“ä½“éªŒç‚¹ã€‚è¿™äº›æ—¶åˆ»æ˜¯åŸ¹å…»æ¨èè€…çš„å…³é”®è§¦å‘å™¨ã€‚

```dart
/// æƒŠå–œæ—¶åˆ»æœåŠ¡
class DelightMomentService {
  final NotificationService _notificationService;
  final AnimationService _animationService;
  final AchievementService _achievementService;

  /// é‡Œç¨‹ç¢‘æƒŠå–œé…ç½®
  static const milestoneDelights = [
    // é¦–æ¬¡ä½“éªŒæƒŠå–œ
    // ã€æ— éšœç¢è®¾è®¡ã€‘å‚è€ƒç¬¬5ç« ï¼Œå°Šé‡ç³»ç»ŸåŠ¨ç”»åå¥½è®¾ç½®
    MilestoneDelight(
      trigger: 'first_transaction_saved',
      title: 'è®°è´¦ä¹‹æ—…å¼€å§‹äº†ï¼',
      message: 'æ­å–œå®Œæˆç¬¬ä¸€ç¬”è®°è´¦ï¼Œä½ çš„è´¢åŠ¡ç®¡ç†æ–°ç¯‡ç« å¼€å¯å•¦',
      animation: 'confetti_celebration',
      // ã€æ— éšœç¢ã€‘ä¸ºå‡å°‘åŠ¨ç”»åå¥½ç”¨æˆ·æä¾›é™æ€ç‰ˆæœ¬
      staticFallback: 'achievement_badge_static',
      // ã€æ— éšœç¢ã€‘åŠ¨ç”»æ˜¯å¦å°Šé‡ç³»ç»Ÿè®¾ç½®
      respectsReduceMotion: true,
      reward: AchievementBadge('first_step'),
    ),

    // é’±é¾„çªç ´æƒŠå–œ
    MilestoneDelight(
      trigger: 'money_age_reached_7_days',
      title: 'é’±é¾„çªç ´7å¤©ï¼',
      message: 'ä½ çš„é’±ç°åœ¨å¯ä»¥"æ´»"ä¸€å‘¨äº†ï¼Œæ¯”å¤§å¤šæ•°æœˆå…‰æ—å¼ºå¤šäº†',
      animation: 'level_up',
      reward: AchievementBadge('money_age_7'),
      shareCard: true,  // å¯ç”Ÿæˆåˆ†äº«å¡ç‰‡
    ),
    MilestoneDelight(
      trigger: 'money_age_reached_30_days',
      title: 'è¿›å…¥å®‰å…¨åŒºï¼',
      message: 'é’±é¾„30å¤©ï¼Œä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªæœˆçš„è´¢åŠ¡ç¼“å†²äº†',
      animation: 'grand_celebration',
      reward: AchievementBadge('money_age_30'),
      shareCard: true,
    ),

    // è¿ç»­è®°è´¦æƒŠå–œ
    MilestoneDelight(
      trigger: 'streak_7_days',
      title: 'è¿ç»­è®°è´¦ä¸€å‘¨ï¼',
      message: 'åšæŒå°±æ˜¯èƒœåˆ©ï¼Œä½ å·²ç»å…»æˆäº†åˆæ­¥çš„è®°è´¦ä¹ æƒ¯',
      animation: 'streak_fire',
      reward: AchievementBadge('streak_7'),
    ),
    MilestoneDelight(
      trigger: 'streak_30_days',
      title: 'è®°è´¦è¾¾äººè¯ç”Ÿï¼',
      message: 'è¿ç»­30å¤©ï¼Œè®°è´¦å·²ç»æˆä¸ºä½ çš„æ—¥å¸¸ä¹ æƒ¯äº†',
      animation: 'master_unlock',
      reward: AchievementBadge('streak_master'),
      shareCard: true,
    ),

    // å‚¨è“„ç›®æ ‡æƒŠå–œ
    MilestoneDelight(
      trigger: 'savings_goal_50_percent',
      title: 'ç›®æ ‡è¿‡åŠï¼',
      message: 'å‚¨è“„ç›®æ ‡å·²å®Œæˆ50%ï¼Œç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥',
      animation: 'progress_boost',
    ),
    MilestoneDelight(
      trigger: 'savings_goal_completed',
      title: 'ç›®æ ‡è¾¾æˆï¼',
      message: 'æ­å–œä½ å®Œæˆäº†å‚¨è“„ç›®æ ‡ï¼ä½ è¯æ˜äº†è‡ªå·±å¯ä»¥åšåˆ°',
      animation: 'goal_achieved',
      reward: AchievementBadge('goal_achiever'),
      shareCard: true,
    ),

    // èŠ‚çœé‡‘é¢æƒŠå–œ
    MilestoneDelight(
      trigger: 'total_saved_1000',
      title: 'çœä¸‹1000å…ƒï¼',
      message: 'é€šè¿‡é¢„ç®—ç®¡ç†ï¼Œä½ å·²ç»ç´¯è®¡èŠ‚çœäº†1000å…ƒ',
      animation: 'money_rain',
      storyGeneration: true,  // ç”Ÿæˆçœé’±æ•…äº‹
    ),
    MilestoneDelight(
      trigger: 'total_saved_10000',
      title: 'ä¸‡å…ƒä¿±ä¹éƒ¨ï¼',
      message: 'ç´¯è®¡èŠ‚çœ10000å…ƒï¼ä½ çš„è´¢åŠ¡ç®¡ç†èƒ½åŠ›ä»¤äººæ•¬ä½©',
      animation: 'fireworks',
      reward: AchievementBadge('savings_master'),
      shareCard: true,
    ),
  ];

  /// è§¦å‘æƒŠå–œæ—¶åˆ»
  Future<void> triggerDelight(MilestoneDelight delight) async {
    // 1. æ’­æ”¾åŠ¨ç”»
    await _animationService.play(delight.animation);

    // 2. æ˜¾ç¤ºç¥è´ºæ¶ˆæ¯
    await _showDelightCard(delight);

    // 3. å‘æ”¾å¥–åŠ±
    if (delight.reward != null) {
      await _achievementService.award(delight.reward!);
    }

    // 4. ç”Ÿæˆåˆ†äº«å†…å®¹
    if (delight.shareCard) {
      await _prepareShareCard(delight);
    }

    // 5. è®°å½•æƒŠå–œæ—¶åˆ»
    await _logDelightMoment(delight);
  }

  /// ã€æ‡’äººè®¾è®¡ã€‘ç”¨æˆ·åˆ†äº«å¹³å°åå¥½è®°å¿†
  Future<void> shareWithPreference(ShareCard card) async {
    // è·å–ç”¨æˆ·ä¸Šæ¬¡ä½¿ç”¨çš„å¹³å°
    final preferredPlatform = await _prefs.getString('last_share_platform');

    if (preferredPlatform != null) {
      // ä¸€é”®åˆ†äº«åˆ°å¸¸ç”¨å¹³å°
      final confirmed = await _showQuickShareConfirm(
        platform: preferredPlatform,
        message: 'åˆ†äº«åˆ°$preferredPlatformï¼Ÿ',
      );
      if (confirmed) {
        await _shareToplatform(card, preferredPlatform);
        return;
      }
    }

    // é¦–æ¬¡æˆ–ç”¨æˆ·æƒ³æ¢å¹³å°æ—¶ï¼Œæ˜¾ç¤ºå¹³å°é€‰æ‹©
    final selectedPlatform = await _showPlatformPicker(card.platforms);
    if (selectedPlatform != null) {
      await _prefs.setString('last_share_platform', selectedPlatform);
      await _shareToplatform(card, selectedPlatform);
    }
  }
}
```

#### 28.2.2 æ™ºèƒ½æƒŠå–œå‘ç°

```dart
/// æ™ºèƒ½æƒŠå–œå‘ç°æœåŠ¡
class SmartDelightDiscoveryService {
  /// å‘ç°ç”¨æˆ·ç‹¬ç‰¹çš„æ¶ˆè´¹è§„å¾‹å¹¶ç»™äºˆæƒŠå–œåé¦ˆ
  Future<List<SmartDelight>> discoverDelights(String userId) async {
    final delights = <SmartDelight>[];
    final transactions = await _getRecentTransactions(userId, days: 90);

    // å‘ç°å‘¨æœŸæ€§æ¶ˆè´¹è§„å¾‹
    final patterns = _analyzeConsumptionPatterns(transactions);
    for (final pattern in patterns) {
      if (pattern.confidence > 0.8) {
        delights.add(SmartDelight(
          type: DelightType.patternDiscovery,
          title: 'æˆ‘å‘ç°äº†ä¸€ä¸ªå°ç§˜å¯†',
          message: _generatePatternMessage(pattern),
          // ä¾‹å¦‚: "ä½ å¥½åƒæ¯å‘¨äº”éƒ½ä¼šçŠ’åŠ³è‡ªå·±ä¸€æ¯å’–å•¡â˜•"
        ));
      }
    }

    // å‘ç°ç§¯æå˜åŒ–
    final improvements = _detectImprovements(transactions);
    for (final improvement in improvements) {
      delights.add(SmartDelight(
        type: DelightType.improvementNotice,
        title: 'æ‚„æ‚„å‘Šè¯‰ä½ ä¸€ä¸ªå¥½æ¶ˆæ¯',
        message: _generateImprovementMessage(improvement),
        // ä¾‹å¦‚: "è¿™ä¸ªæœˆå¤–å–æ”¯å‡ºæ¯”ä¸Šä¸ªæœˆå‡å°‘äº†20%ï¼"
      ));
    }

    return delights;
  }

  /// é¢„æµ‹å³å°†è¾¾æˆçš„æˆå°±å¹¶æå‰æ¿€åŠ±
  Future<void> predictAndEncourage(String userId) async {
    // æ£€æµ‹å³å°†è¾¾æˆçš„ç›®æ ‡
    final nearMilestones = await _detectNearMilestones(userId);

    for (final milestone in nearMilestones) {
      if (milestone.progressPercent >= 90) {
        await _sendEncouragement(
          userId: userId,
          title: 'å°±å·®ä¸€ç‚¹ç‚¹äº†ï¼',
          message: '${milestone.name}å³å°†è¾¾æˆï¼Œå†åšæŒ${milestone.remaining}å°±æˆåŠŸäº†',
        );
      }
    }
  }

  /// ç”Ÿæˆæ¶ˆè´¹è§„å¾‹æ¶ˆæ¯
  String _generatePatternMessage(ConsumptionPattern pattern) {
    switch (pattern.type) {
      case PatternType.weeklyRecurring:
        return 'ä½ å¥½åƒæ¯${pattern.dayOfWeek}éƒ½ä¼š${pattern.description}';
      case PatternType.monthlyRecurring:
        return 'æ¯ä¸ªæœˆ${pattern.dayOfMonth}å·ï¼Œä½ éƒ½ä¼š${pattern.description}';
      case PatternType.locationBased:
        return 'æ¯æ¬¡å»${pattern.location}ï¼Œä½ éƒ½å–œæ¬¢${pattern.description}';
      default:
        return 'æˆ‘å‘ç°äº†ä½ çš„ä¸€ä¸ªæ¶ˆè´¹å°ä¹ æƒ¯';
    }
  }
}
```

#### 28.2.3 æƒŠå–œæ—¶åˆ»çš„æ—¶æœºä¸é¢‘ç‡æ§åˆ¶

```dart
/// æƒŠå–œæ—¶åˆ»é¢‘ç‡æ§åˆ¶å™¨
class DelightFrequencyController {
  /// é¢‘ç‡æ§åˆ¶è§„åˆ™
  static const frequencyRules = FrequencyRules(
    // åŒä¸€ç±»å‹æƒŠå–œçš„æœ€å°é—´éš”
    minIntervalBetweenSameType: Duration(days: 7),

    // æ¯æ—¥æƒŠå–œä¸Šé™
    maxDelightsPerDay: 2,

    // æ¯å‘¨æƒŠå–œä¸Šé™
    maxDelightsPerWeek: 5,

    // æƒŠå–œç–²åŠ³æ¢å¤æœŸ
    fatigueRecoveryPeriod: Duration(days: 3),

    // ç”¨æˆ·åå¥½è‡ªé€‚åº”
    adaptToUserPreference: true,
  );

  /// åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘æƒŠå–œ
  Future<bool> shouldTrigger(String userId, MilestoneDelight delight) async {
    // æ£€æŸ¥æ¯æ—¥ä¸Šé™
    final todayCount = await _getTodayDelightCount(userId);
    if (todayCount >= frequencyRules.maxDelightsPerDay) {
      return false;
    }

    // æ£€æŸ¥åŒç±»å‹é—´éš”
    final lastSameType = await _getLastDelightOfType(userId, delight.type);
    if (lastSameType != null) {
      final interval = DateTime.now().difference(lastSameType.timestamp);
      if (interval < frequencyRules.minIntervalBetweenSameType) {
        return false;
      }
    }

    // æ£€æŸ¥ç”¨æˆ·åå¥½
    if (frequencyRules.adaptToUserPreference) {
      final preference = await _getUserDelightPreference(userId);
      if (preference.delightFrequency == DelightFrequency.minimal) {
        // åªè§¦å‘é‡è¦é‡Œç¨‹ç¢‘
        return delight.importance >= DelightImportance.high;
      }
    }

    return true;
  }
}
```

### 28.3 ç¤¾äº¤åˆ†äº«ä¸å£ç¢‘ä¼ æ’­æœºåˆ¶

#### 28.3.1 å¯åˆ†äº«å†…å®¹è®¾è®¡

```dart
/// åˆ†äº«å†…å®¹æœåŠ¡
class ShareableContentService {
  /// ç”Ÿæˆæˆå°±åˆ†äº«å¡ç‰‡
  Future<ShareCard> generateAchievementCard(Achievement achievement) async {
    final user = await _getCurrentUser();
    final stats = await _getUserStats();

    // ã€æ— éšœç¢è®¾è®¡ã€‘ç”Ÿæˆå›¾åƒçš„æ›¿ä»£æ–‡æœ¬æè¿°
    final accessibilityDescription = _generateAccessibilityDescription(
      achievement: achievement,
      stats: stats,
    );

    return ShareCard(
      type: ShareCardType.achievement,
      title: achievement.title,
      subtitle: achievement.description,
      visual: AchievementVisual(
        badge: achievement.badge,
        backgroundColor: achievement.themeColor,
        animation: achievement.celebrationAnimation,
      ),
      // ã€æ— éšœç¢ã€‘å›¾åƒæ›¿ä»£æ–‡æœ¬ï¼Œä¾›å±å¹•é˜…è¯»å™¨å’Œåˆ†äº«æ—¶ä½¿ç”¨
      accessibilityDescription: accessibilityDescription,
      // ã€æ— éšœç¢ã€‘çº¯æ–‡æœ¬ç‰ˆæœ¬ï¼Œä¾›æ— æ³•æ˜¾ç¤ºå›¾åƒæ—¶ä½¿ç”¨
      textOnlyVersion: _generateTextOnlyVersion(achievement, stats),
      stats: [
        StatItem(label: 'é’±é¾„', value: '${stats.moneyAge}å¤©'),
        StatItem(label: 'è®°è´¦å¤©æ•°', value: '${stats.recordingDays}å¤©'),
        StatItem(label: 'ç´¯è®¡èŠ‚çœ', value: 'Â¥${stats.totalSaved}'),
      ],
      callToAction: ShareCTA(
        text: 'å’Œæˆ‘ä¸€èµ·ç®¡ç†è´¢åŠ¡å§',
        link: 'https://aibook.app/invite/${user.referralCode}',
      ),
      branding: AppBranding(
        logo: 'assets/logo_small.png',
        slogan: 'AIæ™ºèƒ½è®°è´¦ - ä½ çš„æ™ºèƒ½ç†è´¢ä¼™ä¼´',
      ),
    );
  }

  /// ç”Ÿæˆå¹´åº¦/æœˆåº¦è´¦å•æŠ¥å‘Š
  Future<ShareCard> generateFinancialReport(ReportPeriod period) async {
    final report = await _generateReport(period);

    return ShareCard(
      type: ShareCardType.financialReport,
      title: '${period.year}å¹´${period.month}æœˆè´¢åŠ¡å°ç»“',
      sections: [
        ReportSection(
          title: 'æ”¶æ”¯æ¦‚è§ˆ',
          items: [
            ReportItem(icon: 'ğŸ’°', label: 'æ€»æ”¶å…¥', value: 'Â¥${report.totalIncome}'),
            ReportItem(icon: 'ğŸ’¸', label: 'æ€»æ”¯å‡º', value: 'Â¥${report.totalExpense}'),
            ReportItem(icon: 'ğŸ¯', label: 'ç»“ä½™', value: 'Â¥${report.balance}'),
          ],
        ),
        ReportSection(
          title: 'é’±é¾„å˜åŒ–',
          visualization: MoneyAgeTrendChart(data: report.moneyAgeTrend),
          highlight: 'é’±é¾„ä»${report.startMoneyAge}å¤©æå‡åˆ°${report.endMoneyAge}å¤©',
        ),
        ReportSection(
          title: 'æ¶ˆè´¹TOP3',
          items: report.topCategories.map((c) =>
            ReportItem(icon: c.icon, label: c.name, value: 'Â¥${c.amount}')
          ).toList(),
        ),
      ],
      style: ReportStyle.elegant,
      shareText: 'è¿™æ˜¯æˆ‘çš„${period.month}æœˆè´¢åŠ¡å°ç»“ï¼Œé’±é¾„${report.endMoneyAge}å¤©ï¼',
    );
  }

  /// ç”Ÿæˆé’±é¾„é‡Œç¨‹ç¢‘å¡ç‰‡
  Future<ShareCard> generateMoneyAgeMilestoneCard(int moneyAge) async {
    final level = MoneyAgeLevel.fromDays(moneyAge);

    return ShareCard(
      type: ShareCardType.moneyAgeMilestone,
      title: 'é’±é¾„${moneyAge}å¤©ï¼',
      subtitle: level.title,
      visual: MoneyAgeVisual(
        level: level,
        days: moneyAge,
        animation: 'money_age_celebration',
      ),
      encouragement: level.encouragement,
      shareText: 'æˆ‘çš„é’±é¾„è¾¾åˆ°${moneyAge}å¤©äº†ï¼ä½ çš„é’±èƒ½æ´»å¤šä¹…ï¼Ÿ',
    );
  }
}
```

#### 28.3.2 åˆ†äº«æ¸ é“ä¸è¿½è¸ª

```dart
/// åˆ†äº«æ¸ é“æœåŠ¡
class ShareChannelService {
  /// æ”¯æŒçš„åˆ†äº«æ¸ é“
  static const supportedChannels = [
    ShareChannel(
      id: 'wechat_moment',
      name: 'å¾®ä¿¡æœ‹å‹åœˆ',
      icon: 'wechat',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'wechat_friend',
      name: 'å¾®ä¿¡å¥½å‹',
      icon: 'wechat',
      cardStyle: ShareCardStyle.horizontal,
    ),
    ShareChannel(
      id: 'weibo',
      name: 'å¾®åš',
      icon: 'weibo',
      cardStyle: ShareCardStyle.vertical,
    ),
    ShareChannel(
      id: 'xiaohongshu',
      name: 'å°çº¢ä¹¦',
      icon: 'xiaohongshu',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'save_image',
      name: 'ä¿å­˜å›¾ç‰‡',
      icon: 'download',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'copy_link',
      name: 'å¤åˆ¶é“¾æ¥',
      icon: 'link',
    ),
  ];

  /// æ‰§è¡Œåˆ†äº«
  Future<ShareResult> share(ShareCard card, ShareChannel channel) async {
    // 1. æ ¹æ®æ¸ é“è°ƒæ•´å¡ç‰‡æ ·å¼
    final adaptedCard = _adaptCardForChannel(card, channel);

    // 2. ç”Ÿæˆåˆ†äº«å†…å®¹
    final content = await _generateShareContent(adaptedCard, channel);

    // 3. è°ƒç”¨åˆ†äº«SDK
    final result = await _invokeShareSdk(channel, content);

    // 4. è®°å½•åˆ†äº«äº‹ä»¶
    await _trackShareEvent(ShareEvent(
      cardType: card.type,
      channel: channel.id,
      success: result.success,
      timestamp: DateTime.now(),
    ));

    return result;
  }

  /// è¿½è¸ªåˆ†äº«å¸¦æ¥çš„æ–°ç”¨æˆ·
  Future<void> trackReferral(String referralCode, String newUserId) async {
    final referrer = await _getUserByReferralCode(referralCode);
    if (referrer != null) {
      // è®°å½•æ¨èå…³ç³»
      await _saveReferralRelation(
        referrerId: referrer.id,
        refereeId: newUserId,
        timestamp: DateTime.now(),
      );

      // ç»™æ¨èè€…å‘æ”¾å¥–åŠ±
      await _awardReferrer(referrer.id);

      // æ›´æ–°æ¨èè€…ç»Ÿè®¡
      await _updateReferrerStats(referrer.id);
    }
  }
}
```

#### 28.3.3 é‚€è¯·å¥–åŠ±æœºåˆ¶

```dart
/// é‚€è¯·å¥–åŠ±æœåŠ¡
class ReferralRewardService {
  /// å¥–åŠ±è§„åˆ™
  static const rewardRules = ReferralRewardRules(
    // æ¨èè€…å¥–åŠ±
    referrerRewards: [
      ReferralReward(
        trigger: 'referee_registered',
        reward: '7å¤©é«˜çº§ä¼šå‘˜ä½“éªŒ',
        description: 'å¥½å‹æ³¨å†ŒæˆåŠŸ',
      ),
      ReferralReward(
        trigger: 'referee_active_7_days',
        reward: 'è§£é”ä¸“å±ä¸»é¢˜',
        description: 'å¥½å‹æ´»è·ƒä½¿ç”¨7å¤©',
      ),
      ReferralReward(
        trigger: 'referee_subscribed',
        reward: '1ä¸ªæœˆé«˜çº§ä¼šå‘˜',
        description: 'å¥½å‹è®¢é˜…ä¼šå‘˜',
      ),
    ],

    // è¢«æ¨èè€…å¥–åŠ±
    refereeRewards: [
      ReferralReward(
        trigger: 'registration',
        reward: '14å¤©é«˜çº§ä¼šå‘˜ä½“éªŒ',
        description: 'æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±',
      ),
    ],

    // ç´¯è®¡æ¨èå¥–åŠ±
    cumulativeRewards: [
      CumulativeReward(
        count: 3,
        reward: 'æ¨èè¾¾äººå¾½ç« ',
      ),
      CumulativeReward(
        count: 10,
        reward: '3ä¸ªæœˆé«˜çº§ä¼šå‘˜',
      ),
      CumulativeReward(
        count: 50,
        reward: 'ç»ˆèº«é«˜çº§ä¼šå‘˜',
      ),
    ],
  );

  /// å¤„ç†æ¨èå¥–åŠ±
  Future<void> processReferralReward(ReferralEvent event) async {
    final rules = rewardRules;

    // æ£€æŸ¥æ¨èè€…å¥–åŠ±
    for (final reward in rules.referrerRewards) {
      if (reward.trigger == event.type) {
        await _grantReward(event.referrerId, reward);
        await _notifyReferrer(event.referrerId, reward);
      }
    }

    // æ£€æŸ¥ç´¯è®¡å¥–åŠ±
    final totalReferrals = await _getTotalReferrals(event.referrerId);
    for (final cumReward in rules.cumulativeRewards) {
      if (totalReferrals == cumReward.count) {
        await _grantReward(event.referrerId, cumReward.reward);
        await _celebrateMilestone(event.referrerId, cumReward);
      }
    }
  }
}
```

### 28.4 é¦–å‘¨ä»·å€¼æ„ŸçŸ¥è·¯å¾„

#### 28.4.1 é¦–å‘¨ä½“éªŒè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é¦–å‘¨ä»·å€¼æ„ŸçŸ¥è·¯å¾„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Day 1: åˆæ¬¡ä½“éªŒ                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: å®Œæˆé¦–ç¬”è®°è´¦ï¼Œåˆè¯†"é’±é¾„"æ¦‚å¿µ                               â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  æç®€æ³¨å†Œï¼ˆæ‰‹æœºå·ä¸€é”®ç™»å½•ï¼‰                                    â”‚   â”‚
â”‚  â”‚  â‘¡ 30ç§’æ–°æ‰‹å¼•å¯¼ï¼ˆçªå‡ºé’±é¾„æ¦‚å¿µï¼‰                                  â”‚   â”‚
â”‚  â”‚  â‘¢ å¼•å¯¼å®Œæˆé¦–ç¬”è®°è´¦                                              â”‚   â”‚
â”‚  â”‚  â‘£ ç«‹å³å±•ç¤ºé’±é¾„è®¡ç®—ç»“æœ                                          â”‚   â”‚
â”‚  â”‚  â‘¤ æƒŠå–œåŠ¨ç”» + "è®°è´¦ä¹‹æ—…å¼€å§‹äº†"                                   â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "åŸæ¥æˆ‘çš„é’±åªèƒ½æ´»Xå¤©"                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 2-3: å»ºç«‹ä¹ æƒ¯                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: ä½“éªŒAIä¾¿æ·ï¼Œè®¾ç½®é¦–ä¸ªå°é‡‘åº“                                 â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  æ¨é€æ¸©å’Œæé†’è®°è´¦                                              â”‚   â”‚
â”‚  â”‚  â‘¡ å¼•å¯¼å°è¯•è¯­éŸ³/æ‹ç…§è®°è´¦                                         â”‚   â”‚
â”‚  â”‚  â‘¢ å±•ç¤ºAIæ™ºèƒ½åˆ†ç±»èƒ½åŠ›                                            â”‚   â”‚
â”‚  â”‚  â‘£ å¼•å¯¼è®¾ç½®ç¬¬ä¸€ä¸ªå°é‡‘åº“é¢„ç®—                                      â”‚   â”‚
â”‚  â”‚  â‘¤ å¯è§†åŒ–å±•ç¤ºé¢„ç®—åˆ†é…                                            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "è®°è´¦åŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 4-5: äº§ç”Ÿæ´å¯Ÿ                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: è·å¾—é¦–ä¸ªæ¶ˆè´¹æ´å¯Ÿ                                          â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  ç§¯ç´¯è¶³å¤Ÿæ•°æ®åï¼Œç”Ÿæˆæ¶ˆè´¹åˆ†æ                                  â”‚   â”‚
â”‚  â”‚  â‘¡ å±•ç¤ºæ¶ˆè´¹åˆ†ç±»åˆ†å¸ƒ                                              â”‚   â”‚
â”‚  â”‚  â‘¢ æ™ºèƒ½å‘ç°æ¶ˆè´¹è§„å¾‹                                              â”‚   â”‚
â”‚  â”‚  â‘£ å¯¹æ¯”åŒé¾„äººå¹³å‡æ°´å¹³                                            â”‚   â”‚
â”‚  â”‚  â‘¤ ç»™å‡ºç¬¬ä¸€æ¡æ”¹å–„å»ºè®®                                            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "æˆ‘ç»ˆäºçŸ¥é“é’±éƒ½èŠ±å“ªäº†"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 6-7: å½¢æˆä¹ æƒ¯                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: å®Œæˆé¦–å‘¨ï¼Œå»ºç«‹åˆæ­¥ä¹ æƒ¯                                     â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  å±•ç¤ºé¦–å‘¨è´¢åŠ¡å°ç»“                                              â”‚   â”‚
â”‚  â”‚  â‘¡ æ˜¾ç¤ºé’±é¾„å˜åŒ–è¶‹åŠ¿                                              â”‚   â”‚
â”‚  â”‚  â‘¢ è§£é”"åšæŒä¸€å‘¨"æˆå°±                                           â”‚   â”‚
â”‚  â”‚  â‘£ æ”¶é›†é¦–æ¬¡NPSåé¦ˆ                                               â”‚   â”‚
â”‚  â”‚  â‘¤ å¼•å¯¼è®¾ç½®å‚¨è“„ç›®æ ‡                                              â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "ä¸€å‘¨å°±æœ‰äº†è¿™ä¹ˆå¤šå˜åŒ–"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 28.4.2 é¦–å‘¨å¼•å¯¼æœåŠ¡

```dart
/// é¦–å‘¨å¼•å¯¼æœåŠ¡
class FirstWeekGuidanceService {
  /// é¦–å‘¨ä»»åŠ¡æ¸…å•
  static const firstWeekTasks = [
    DailyTask(
      day: 1,
      tasks: [
        Task(id: 'complete_onboarding', name: 'å®Œæˆæ–°æ‰‹å¼•å¯¼', required: true),
        Task(id: 'first_transaction', name: 'è®°å½•ç¬¬ä¸€ç¬”è´¦', required: true),
        Task(id: 'view_money_age', name: 'æŸ¥çœ‹é’±é¾„', required: false),
      ],
    ),
    DailyTask(
      day: 2,
      tasks: [
        Task(id: 'try_voice_recording', name: 'å°è¯•è¯­éŸ³è®°è´¦', required: false),
        Task(id: 'second_transaction', name: 'è®°å½•ç¬¬äºŒç¬”è´¦', required: true),
      ],
    ),
    DailyTask(
      day: 3,
      tasks: [
        Task(id: 'setup_first_vault', name: 'è®¾ç½®ç¬¬ä¸€ä¸ªå°é‡‘åº“', required: true),
        Task(id: 'try_photo_recording', name: 'å°è¯•æ‹ç…§è®°è´¦', required: false),
      ],
    ),
    DailyTask(
      day: 4,
      tasks: [
        Task(id: 'view_category_stats', name: 'æŸ¥çœ‹åˆ†ç±»ç»Ÿè®¡', required: true),
        Task(id: 'continue_recording', name: 'ç»§ç»­è®°è´¦', required: true),
      ],
    ),
    DailyTask(
      day: 5,
      tasks: [
        Task(id: 'view_first_insight', name: 'æŸ¥çœ‹æ¶ˆè´¹æ´å¯Ÿ', required: true),
        Task(id: 'review_budget', name: 'æ£€æŸ¥é¢„ç®—ä½¿ç”¨æƒ…å†µ', required: false),
      ],
    ),
    DailyTask(
      day: 6,
      tasks: [
        Task(id: 'set_savings_goal', name: 'è®¾ç½®å‚¨è“„ç›®æ ‡', required: false),
        Task(id: 'explore_more_features', name: 'æ¢ç´¢æ›´å¤šåŠŸèƒ½', required: false),
      ],
    ),
    DailyTask(
      day: 7,
      tasks: [
        Task(id: 'view_weekly_summary', name: 'æŸ¥çœ‹é¦–å‘¨æ€»ç»“', required: true),
        Task(id: 'complete_nps_survey', name: 'å®Œæˆæ»¡æ„åº¦è°ƒæŸ¥', required: true),
      ],
    ),
  ];

  /// è·å–ä»Šæ—¥å¼•å¯¼ä»»åŠ¡
  Future<List<Task>> getTodayTasks(String userId) async {
    final daysActive = await _getDaysActive(userId);
    if (daysActive > 7) return [];  // é¦–å‘¨åä¸å†å¼•å¯¼

    final dailyTask = firstWeekTasks.firstWhere(
      (dt) => dt.day == daysActive,
      orElse: () => DailyTask(day: 0, tasks: []),
    );

    // è¿‡æ»¤å·²å®Œæˆçš„ä»»åŠ¡
    final completedTasks = await _getCompletedTasks(userId);
    return dailyTask.tasks
        .where((t) => !completedTasks.contains(t.id))
        .toList();
  }

  /// æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µå¹¶è§¦å‘å¥–åŠ±
  Future<void> checkTaskCompletion(String userId, String taskId) async {
    await _markTaskCompleted(userId, taskId);

    // æ£€æŸ¥æ˜¯å¦å®Œæˆä»Šæ—¥æ‰€æœ‰å¿…åšä»»åŠ¡
    final todayTasks = await getTodayTasks(userId);
    final requiredTasks = todayTasks.where((t) => t.required).toList();
    if (requiredTasks.isEmpty) {
      await _triggerDailyCompletion(userId);
    }

    // æ£€æŸ¥æ˜¯å¦å®Œæˆé¦–å‘¨æ‰€æœ‰ä»»åŠ¡
    final allCompleted = await _checkAllFirstWeekTasksCompleted(userId);
    if (allCompleted) {
      await _triggerFirstWeekCompletion(userId);
    }
  }
}
```

### 28.5 è´Ÿé¢ä½“éªŒæ£€æµ‹ä¸ä¿®å¤

#### 28.5.1 è´Ÿé¢ä¿¡å·æ£€æµ‹

```dart
/// è´Ÿé¢ä½“éªŒæ£€æµ‹æœåŠ¡
class NegativeExperienceDetector {
  /// è´Ÿé¢ä¿¡å·å®šä¹‰
  static const negativeSignals = [
    // æ“ä½œå±‚é¢çš„è´Ÿé¢ä¿¡å·
    NegativeSignal(
      id: 'repeated_failures',
      description: 'è¿ç»­æ“ä½œå¤±è´¥',
      detection: '3æ¬¡ä»¥ä¸Šè¿ç»­æ“ä½œå¤±è´¥',
      severity: SignalSeverity.medium,
    ),
    NegativeSignal(
      id: 'rage_clicks',
      description: 'æ„¤æ€’ç‚¹å‡»',
      detection: 'çŸ­æ—¶é—´å†…åŒä¸€ä½ç½®å¤šæ¬¡ç‚¹å‡»',
      severity: SignalSeverity.high,
    ),
    NegativeSignal(
      id: 'long_confusion',
      description: 'é•¿æ—¶é—´å›°æƒ‘',
      detection: 'åœ¨åŒä¸€é¡µé¢åœç•™è¶…è¿‡2åˆ†é’Ÿæ— æœ‰æ•ˆæ“ä½œ',
      severity: SignalSeverity.low,
    ),
    NegativeSignal(
      id: 'quick_exit',
      description: 'å¿«é€Ÿé€€å‡º',
      detection: 'è¿›å…¥åŠŸèƒ½å5ç§’å†…è¿”å›',
      severity: SignalSeverity.low,
    ),

    // ä½¿ç”¨æ¨¡å¼çš„è´Ÿé¢ä¿¡å·
    NegativeSignal(
      id: 'usage_decline',
      description: 'ä½¿ç”¨é¢‘ç‡ä¸‹é™',
      detection: 'å‘¨ä½¿ç”¨é¢‘ç‡ä¸‹é™è¶…è¿‡50%',
      severity: SignalSeverity.high,
    ),
    NegativeSignal(
      id: 'feature_abandonment',
      description: 'åŠŸèƒ½æ”¾å¼ƒ',
      detection: 'å¼€å§‹ä½¿ç”¨æŸåŠŸèƒ½åä¸­é€”æ”¾å¼ƒ',
      severity: SignalSeverity.medium,
    ),
    NegativeSignal(
      id: 'session_shortening',
      description: 'ä¼šè¯æ—¶é•¿ç¼©çŸ­',
      detection: 'å¹³å‡ä¼šè¯æ—¶é•¿æŒç»­ä¸‹é™',
      severity: SignalSeverity.medium,
    ),

    // æµå¤±é¢„è­¦ä¿¡å·
    NegativeSignal(
      id: 'approaching_churn',
      description: 'æ¥è¿‘æµå¤±',
      detection: '7å¤©æœªä½¿ç”¨',
      severity: SignalSeverity.critical,
    ),
    NegativeSignal(
      id: 'negative_feedback',
      description: 'è´Ÿé¢åé¦ˆ',
      detection: 'åº”ç”¨å•†åº—1-2æ˜Ÿè¯„ä»·æˆ–è´Ÿé¢åé¦ˆæäº¤',
      severity: SignalSeverity.critical,
    ),
  ];

  /// å®æ—¶æ£€æµ‹è´Ÿé¢ä¿¡å·
  Stream<NegativeSignalEvent> monitorNegativeSignals(String userId) async* {
    // ç›‘æ§æ“ä½œäº‹ä»¶
    await for (final event in _operationEventStream(userId)) {
      final signals = _detectOperationSignals(event);
      for (final signal in signals) {
        yield NegativeSignalEvent(
          userId: userId,
          signal: signal,
          context: event,
          timestamp: DateTime.now(),
        );
      }
    }
  }

  /// åˆ†æç”¨æˆ·çš„è´Ÿé¢ä½“éªŒæ¨¡å¼
  Future<NegativeExperienceReport> analyzeNegativePatterns(String userId) async {
    final signals = await _getRecentSignals(userId, days: 30);

    return NegativeExperienceReport(
      userId: userId,
      totalSignals: signals.length,
      signalsByType: _groupByType(signals),
      signalsByFeature: _groupByFeature(signals),
      churnRisk: _calculateChurnRisk(signals),
      recommendations: _generateRecoveryRecommendations(signals),
    );
  }
}
```

#### 28.5.2 è´Ÿé¢ä½“éªŒä¿®å¤æœºåˆ¶

```dart
/// è´Ÿé¢ä½“éªŒä¿®å¤æœåŠ¡
class NegativeExperienceRecoveryService {
  /// ä¿®å¤ç­–ç•¥
  static const recoveryStrategies = {
    // æ“ä½œå¤±è´¥ä¿®å¤
    'repeated_failures': RecoveryStrategy(
      immediateAction: 'å¼¹å‡ºå¸®åŠ©æç¤ºï¼Œè¯¢é—®æ˜¯å¦éœ€è¦ååŠ©',
      followUp: 'å‘é€æ“ä½œæŒ‡å—æ¨é€',
      escalation: 'é‚€è¯·åŠ å…¥ç”¨æˆ·æ”¯æŒç¾¤',
    ),

    // å›°æƒ‘çŠ¶æ€ä¿®å¤
    'long_confusion': RecoveryStrategy(
      immediateAction: 'æ˜¾ç¤ºåŠŸèƒ½å¼•å¯¼æ°”æ³¡',
      followUp: 'æ¨é€ç›¸å…³åŠŸèƒ½æ•™ç¨‹',
      escalation: null,
    ),

    // æ„¤æ€’ç‚¹å‡»ä¿®å¤
    'rage_clicks': RecoveryStrategy(
      immediateAction: 'æ˜¾ç¤º"é‡åˆ°é—®é¢˜ï¼Ÿè®©æˆ‘æ¥å¸®ä½ "å…¥å£',
      followUp: 'å‘é€å…³æ€€æ¶ˆæ¯å’Œå¸®åŠ©é“¾æ¥',
      escalation: 'äº§å“å›¢é˜Ÿä»‹å…¥åˆ†æ',
    ),

    // ä½¿ç”¨ä¸‹é™ä¿®å¤
    'usage_decline': RecoveryStrategy(
      immediateAction: null,
      followUp: 'å‘é€ä¸ªæ€§åŒ–å”¤é†’æ¶ˆæ¯',
      escalation: 'åˆ†ææµå¤±åŸå› ',
    ),

    // æ¥è¿‘æµå¤±ä¿®å¤
    'approaching_churn': RecoveryStrategy(
      immediateAction: null,
      followUp: 'å‘é€ä»·å€¼å›é¡¾æ¶ˆæ¯ï¼Œå±•ç¤ºç´¯è®¡æˆå°±',
      escalation: 'å‘é€æŒ½å›ä¼˜æƒ æˆ–1å¯¹1å…³æ€€',
    ),

    // è´Ÿé¢åé¦ˆä¿®å¤
    'negative_feedback': RecoveryStrategy(
      immediateAction: 'æ„Ÿè°¢åé¦ˆï¼Œæ‰¿è¯ºæ”¹è¿›',
      followUp: 'è·Ÿè¿›é—®é¢˜è§£å†³è¿›åº¦',
      escalation: 'äº§å“è´Ÿè´£äººäº²è‡ªå›å¤',
    ),
  };

  /// æ‰§è¡Œä¿®å¤ç­–ç•¥
  Future<void> executeRecovery(NegativeSignalEvent event) async {
    final strategy = recoveryStrategies[event.signal.id];
    if (strategy == null) return;

    // æ‰§è¡Œå³æ—¶ä¿®å¤
    if (strategy.immediateAction != null) {
      await _executeImmediateAction(event.userId, strategy.immediateAction!);
    }

    // å®‰æ’åç»­è·Ÿè¿›
    if (strategy.followUp != null) {
      await _scheduleFollowUp(
        userId: event.userId,
        action: strategy.followUp!,
        delay: Duration(hours: 24),
      );
    }

    // è®°å½•ä¿®å¤å°è¯•
    await _logRecoveryAttempt(event, strategy);
  }

  /// æµå¤±ç”¨æˆ·æŒ½å›
  Future<void> attemptChurnRecovery(String userId) async {
    final user = await _getUser(userId);
    final stats = await _getUserStats(userId);

    // ç”Ÿæˆä¸ªæ€§åŒ–æŒ½å›æ¶ˆæ¯
    final message = WinbackMessage(
      title: 'å¥½ä¹…ä¸è§ï¼Œæƒ³ä½ äº†',
      body: _generatePersonalizedWinbackMessage(user, stats),
      highlights: [
        'ä½ çš„é’±é¾„å·²è¾¾${stats.moneyAge}å¤©',
        'ç´¯è®¡è®°å½•${stats.totalTransactions}ç¬”è´¦',
        'æ€»å…±èŠ‚çœäº†Â¥${stats.totalSaved}',
      ],
      callToAction: 'å›æ¥çœ‹çœ‹',
      incentive: stats.isPremiumUser ? null : 'å›å½’å³é€7å¤©ä¼šå‘˜',
    );

    await _sendWinbackNotification(userId, message);
  }
}
```

### 28.6 æ¨èè€…åŸ¹è‚²è®¡åˆ’

#### 28.6.1 æ¨èè€…è¯†åˆ«

```dart
/// æ¨èè€…è¯†åˆ«æœåŠ¡
class PromoterIdentificationService {
  /// æ¨èè€…ç‰¹å¾
  static const promoterIndicators = [
    PromoterIndicator(
      id: 'high_engagement',
      description: 'é«˜æ´»è·ƒåº¦',
      criteria: 'å‘¨æ´»è·ƒâ‰¥5å¤©ï¼Œæ—¥å‡ä½¿ç”¨â‰¥3æ¬¡',
      weight: 0.25,
    ),
    PromoterIndicator(
      id: 'feature_adoption',
      description: 'åŠŸèƒ½é‡‡ç”¨å¹¿',
      criteria: 'ä½¿ç”¨â‰¥5ä¸ªæ ¸å¿ƒåŠŸèƒ½',
      weight: 0.20,
    ),
    PromoterIndicator(
      id: 'positive_outcomes',
      description: 'æ­£å‘æˆæœ',
      criteria: 'é’±é¾„æå‡ã€é¢„ç®—è¾¾æˆã€å‚¨è“„ç›®æ ‡è¿›å±•',
      weight: 0.25,
    ),
    PromoterIndicator(
      id: 'long_tenure',
      description: 'é•¿æœŸç”¨æˆ·',
      criteria: 'ä½¿ç”¨â‰¥3ä¸ªæœˆ',
      weight: 0.15,
    ),
    PromoterIndicator(
      id: 'social_behavior',
      description: 'ç¤¾äº¤è¡Œä¸º',
      criteria: 'æ›¾åˆ†äº«æˆå°±æˆ–é‚€è¯·å¥½å‹',
      weight: 0.15,
    ),
  ];

  /// è®¡ç®—æ¨èè€…æ½œåŠ›åˆ†æ•°
  Future<double> calculatePromoterPotential(String userId) async {
    double score = 0;

    for (final indicator in promoterIndicators) {
      final met = await _checkIndicator(userId, indicator);
      if (met) {
        score += indicator.weight;
      }
    }

    return score;  // 0-1ä¹‹é—´
  }

  /// è¯†åˆ«æ½œåœ¨æ¨èè€…
  Future<List<PotentialPromoter>> identifyPotentialPromoters() async {
    final activeUsers = await _getActiveUsers(days: 30);
    final potentialPromoters = <PotentialPromoter>[];

    for (final userId in activeUsers) {
      final score = await calculatePromoterPotential(userId);
      if (score >= 0.7) {  // é˜ˆå€¼
        potentialPromoters.add(PotentialPromoter(
          userId: userId,
          score: score,
          indicators: await _getMetIndicators(userId),
        ));
      }
    }

    return potentialPromoters..sort((a, b) => b.score.compareTo(a.score));
  }
}
```

#### 28.6.2 æ¨èè€…æ¿€æ´»

```dart
/// æ¨èè€…æ¿€æ´»æœåŠ¡
class PromoterActivationService {
  /// æ¿€æ´»ç­–ç•¥
  Future<void> activatePromoter(PotentialPromoter promoter) async {
    // 1. å‘é€ä¸“å±æ„Ÿè°¢
    await _sendAppreciationMessage(promoter.userId);

    // 2. é‚€è¯·åŠ å…¥VIPç”¨æˆ·ç¾¤
    await _inviteToVipGroup(promoter.userId);

    // 3. è§£é”æ¨èè€…ä¸“å±åŠŸèƒ½
    await _unlockPromoterFeatures(promoter.userId);

    // 4. å±•ç¤ºæ¨èå…¥å£
    await _enablePromoterDashboard(promoter.userId);
  }

  /// æ¨èè€…ä¸“å±åŠŸèƒ½
  static const promoterFeatures = [
    PromoterFeature(
      id: 'custom_share_cards',
      name: 'å®šåˆ¶åˆ†äº«å¡ç‰‡',
      description: 'å¯è‡ªå®šä¹‰åˆ†äº«å¡ç‰‡çš„æ ·å¼å’Œå†…å®¹',
    ),
    PromoterFeature(
      id: 'referral_dashboard',
      name: 'æ¨èæ•°æ®é¢æ¿',
      description: 'æŸ¥çœ‹é‚€è¯·å¥½å‹çš„æ•°æ®ç»Ÿè®¡',
    ),
    PromoterFeature(
      id: 'early_access',
      name: 'æ–°åŠŸèƒ½æŠ¢å…ˆä½“éªŒ',
      description: 'ä¼˜å…ˆä½“éªŒæ–°åŠŸèƒ½å¹¶æä¾›åé¦ˆ',
    ),
    PromoterFeature(
      id: 'priority_support',
      name: 'ä¼˜å…ˆå®¢æœæ”¯æŒ',
      description: 'ä¸“å±å®¢æœé€šé“ï¼Œå¿«é€Ÿå“åº”',
    ),
  ];

  /// æ¨èè€…ä»ªè¡¨ç›˜æ•°æ®
  Future<PromoterDashboard> getPromoterDashboard(String userId) async {
    return PromoterDashboard(
      totalReferrals: await _getTotalReferrals(userId),
      activeReferrals: await _getActiveReferrals(userId),
      earnedRewards: await _getEarnedRewards(userId),
      pendingRewards: await _getPendingRewards(userId),
      referralLink: await _getReferralLink(userId),
      shareStats: await _getShareStats(userId),
    );
  }
}
```

### 28.7 è´¬æŸè€…æŒ½å›ç­–ç•¥

#### 28.7.1 è´¬æŸè€…åˆ†æ

```dart
/// è´¬æŸè€…åˆ†ææœåŠ¡
class DetractorAnalysisService {
  /// è´¬æŸè€…ç±»å‹
  enum DetractorType {
    functional,      // åŠŸèƒ½ä¸æ»¡æ„
    experience,      // ä½“éªŒä¸æ»¡æ„
    expectation,     // æœŸæœ›è½å·®
    technical,       // æŠ€æœ¯é—®é¢˜
    value,           // ä»·å€¼æ„ŸçŸ¥ä¸è¶³
  }

  /// åˆ†æè´¬æŸåŸå› 
  Future<DetractorAnalysis> analyzeDetractor(String userId, int npsScore, String? reason) async {
    final analysis = DetractorAnalysis(userId: userId, npsScore: npsScore);

    // åˆ†ææ–‡æœ¬åé¦ˆ
    if (reason != null) {
      analysis.detractorType = await _classifyReason(reason);
      analysis.keyIssues = await _extractKeyIssues(reason);
    }

    // åˆ†æä½¿ç”¨è¡Œä¸º
    analysis.usagePattern = await _analyzeUsagePattern(userId);
    analysis.failurePoints = await _identifyFailurePoints(userId);
    analysis.abandonedFeatures = await _getAbandonedFeatures(userId);

    // è¯„ä¼°æŒ½å›å¯èƒ½æ€§
    analysis.recoveryProbability = _calculateRecoveryProbability(analysis);

    return analysis;
  }

  /// è®¡ç®—æŒ½å›å¯èƒ½æ€§
  double _calculateRecoveryProbability(DetractorAnalysis analysis) {
    double probability = 0.5;  // åŸºç¡€æ¦‚ç‡

    // æ ¹æ®è´¬æŸç±»å‹è°ƒæ•´
    switch (analysis.detractorType) {
      case DetractorType.technical:
        probability += 0.3;  // æŠ€æœ¯é—®é¢˜å®¹æ˜“ä¿®å¤
        break;
      case DetractorType.functional:
        probability += 0.2;  // åŠŸèƒ½é—®é¢˜å¯ä»¥æ”¹è¿›
        break;
      case DetractorType.experience:
        probability += 0.1;  // ä½“éªŒé—®é¢˜éœ€è¦æ—¶é—´
        break;
      case DetractorType.expectation:
        probability -= 0.1;  // æœŸæœ›è½å·®è¾ƒéš¾å¼¥è¡¥
        break;
      case DetractorType.value:
        probability -= 0.2;  // ä»·å€¼æ„ŸçŸ¥é—®é¢˜è¾ƒéš¾
        break;
    }

    // æ ¹æ®ä½¿ç”¨æ—¶é•¿è°ƒæ•´
    if (analysis.usagePattern.daysActive > 30) {
      probability += 0.1;  // è€ç”¨æˆ·æ›´å®¹æ˜“æŒ½å›
    }

    return probability.clamp(0.0, 1.0);
  }
}
```

#### 28.7.2 è´¬æŸè€…æŒ½å›æ‰§è¡Œ

```dart
/// è´¬æŸè€…æŒ½å›æœåŠ¡
class DetractorRecoveryService {
  /// æŒ½å›ç­–ç•¥
  Future<RecoveryPlan> createRecoveryPlan(DetractorAnalysis analysis) async {
    final plan = RecoveryPlan(userId: analysis.userId);

    // æ ¹æ®è´¬æŸç±»å‹åˆ¶å®šç­–ç•¥
    switch (analysis.detractorType) {
      case DetractorType.technical:
        plan.immediateActions = [
          'ç«‹å³è”ç³»ç”¨æˆ·äº†è§£æŠ€æœ¯é—®é¢˜è¯¦æƒ…',
          'ä¼˜å…ˆä¿®å¤ç”¨æˆ·é‡åˆ°çš„æŠ€æœ¯é—®é¢˜',
          'ä¿®å¤åä¸»åŠ¨é€šçŸ¥ç”¨æˆ·å¹¶é“æ­‰',
        ];
        plan.compensation = 'èµ é€1ä¸ªæœˆä¼šå‘˜';
        break;

      case DetractorType.functional:
        plan.immediateActions = [
          'è®°å½•åŠŸèƒ½æ”¹è¿›å»ºè®®',
          'å‘ŠçŸ¥ç”¨æˆ·æ”¹è¿›è®¡åˆ’å’Œé¢„æœŸæ—¶é—´',
          'é‚€è¯·ç”¨æˆ·åŠ å…¥åŠŸèƒ½å†…æµ‹ç¾¤',
        ];
        plan.compensation = 'è§£é”é«˜çº§åŠŸèƒ½14å¤©ä½“éªŒ';
        break;

      case DetractorType.experience:
        plan.immediateActions = [
          'å®‰æ’1å¯¹1ä½¿ç”¨æŒ‡å¯¼',
          'å‘é€ä¸ªæ€§åŒ–ä½¿ç”¨æ•™ç¨‹',
          'æŒç»­è·Ÿè¿›ä½¿ç”¨ä½“éªŒ',
        ];
        plan.compensation = null;  // ä¸éœ€è¦ç‰©è´¨è¡¥å¿
        break;

      case DetractorType.value:
        plan.immediateActions = [
          'å±•ç¤ºç”¨æˆ·å·²è·å¾—çš„ä»·å€¼ï¼ˆçœé’±é‡‘é¢ã€é’±é¾„æå‡ï¼‰',
          'æ¨èæ›´é€‚åˆç”¨æˆ·çš„åŠŸèƒ½ç»„åˆ',
          'æä¾›1å¯¹1è´¢åŠ¡è§„åˆ’å»ºè®®',
        ];
        plan.compensation = 'å»¶é•¿ä¼šå‘˜ä½“éªŒæœŸ';
        break;

      default:
        plan.immediateActions = [
          'å‘é€è¯šæŒšé“æ­‰å’Œæ„Ÿè°¢åé¦ˆ',
          'é‚€è¯·æ·±åº¦è®¿è°ˆäº†è§£å…·ä½“é—®é¢˜',
        ];
    }

    return plan;
  }

  /// æ‰§è¡ŒæŒ½å›è®¡åˆ’
  Future<RecoveryResult> executeRecoveryPlan(RecoveryPlan plan) async {
    final result = RecoveryResult(userId: plan.userId);

    // æ‰§è¡Œå³æ—¶è¡ŒåŠ¨
    for (final action in plan.immediateActions) {
      try {
        await _executeAction(plan.userId, action);
        result.completedActions.add(action);
      } catch (e) {
        result.failedActions.add(ActionFailure(action: action, error: e.toString()));
      }
    }

    // å‘æ”¾è¡¥å¿
    if (plan.compensation != null) {
      await _grantCompensation(plan.userId, plan.compensation!);
      result.compensationGranted = true;
    }

    // è®¾ç½®è·Ÿè¿›æé†’
    await _scheduleFollowUp(plan.userId, Duration(days: 7));

    return result;
  }

  /// è·Ÿè¿›è´¬æŸè€…çŠ¶æ€
  Future<void> followUpDetractor(String userId) async {
    // æ£€æŸ¥ç”¨æˆ·è¿‘æœŸè¡Œä¸º
    final recentActivity = await _getRecentActivity(userId);

    if (recentActivity.isActive) {
      // ç”¨æˆ·å›å½’æ´»è·ƒï¼Œå‘é€æ„Ÿè°¢
      await _sendThankYouMessage(userId);

      // å†æ¬¡æ”¶é›†NPS
      await _scheduleNpsSurvey(userId, delay: Duration(days: 14));
    } else {
      // ç”¨æˆ·ä»ä¸æ´»è·ƒï¼Œå‡çº§å¤„ç†
      await _escalateToManualOutreach(userId);
    }
  }
}
```

### 28.7.3 æ— éšœç¢è®¾è®¡é›†æˆ

> ğŸ“ **å‚è€ƒç« èŠ‚**ï¼šæ— éšœç¢è®¾è®¡è§„èŒƒè¯¦è§[ç¬¬5ç«  æ— éšœç¢è®¾è®¡](#5-æ— éšœç¢è®¾è®¡)

NPSä¸å£ç¢‘ç³»ç»Ÿçš„æ— éšœç¢å®ç°è¦ç‚¹ï¼š

| ç»„ä»¶ | æ— éšœç¢è¦æ±‚ | å®ç°æ–¹å¼ |
|------|-----------|---------|
| NPSè¯„åˆ† | å¤šç§è¾“å…¥æ–¹å¼ | æ»‘å—+æ•°å­—æŒ‰é’®+è¯­éŸ³ |
| åˆ†äº«å¡ç‰‡ | å›¾åƒæ›¿ä»£æ–‡æœ¬ | `accessibilityDescription` |
| æƒŠå–œåŠ¨ç”» | å‡å°‘åŠ¨ç”»æ”¯æŒ | `respectsReduceMotion` |
| åé¦ˆé€‰é¡¹ | è§¦æ§ç›®æ ‡ | â‰¥48x48åƒç´  |
| æˆå°±å¾½ç«  | é¢œè‰²+å›¾æ ‡ | ä¸ä»…ä¾èµ–é¢œè‰²ä¼ è¾¾ä¿¡æ¯ |

```dart
/// ã€æ— éšœç¢ã€‘NPSç³»ç»Ÿæ— éšœç¢æœåŠ¡
class NpsAccessibilityService {
  /// æ£€æŸ¥æ˜¯å¦åº”ä½¿ç”¨ç®€åŒ–åŠ¨ç”»
  static Future<bool> shouldReduceMotion() async {
    return MediaQuery.of(context).disableAnimations ||
           await AccessibilityService.isReduceMotionEnabled();
  }

  /// ç”Ÿæˆåˆ†äº«å¡ç‰‡çš„çº¯æ–‡æœ¬ç‰ˆæœ¬
  static String generateTextOnlyShareContent(Achievement achievement) {
    return 'æˆ‘åœ¨AIæ™ºèƒ½è®°è´¦è·å¾—äº†ã€Œ${achievement.title}ã€æˆå°±ï¼'
           '${achievement.description}';
  }

  /// NPSè¯„åˆ†çš„è¯­éŸ³è¾“å…¥æç¤º
  static const voiceInputPrompt = 'è¯·è¯´å‡º0åˆ°10ä¹‹é—´çš„æ•°å­—ï¼Œ'
      '0è¡¨ç¤ºå®Œå…¨ä¸ä¼šæ¨èï¼Œ10è¡¨ç¤ºéå¸¸æ„¿æ„æ¨è';
}
```

### 28.8 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// NPSç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡
class NpsGoalDetector {
  /// NPSç›¸å…³ç›®æ ‡
  static const npsGoals = NpsGoalCriteria(
    // æ ¸å¿ƒNPSæŒ‡æ ‡
    overallNps: NpsTarget(
      target: 50,
      measurement: 'æ•´ä½“ç”¨æˆ·NPSè¯„åˆ†',
    ),

    // æ¨èè€…æ¯”ä¾‹
    promoterRate: RateTarget(
      target: 0.40,  // 40%æ¨èè€…
      measurement: '9-10åˆ†ç”¨æˆ·å æ¯”',
    ),

    // è´¬æŸè€…æ¯”ä¾‹
    detractorRate: RateTarget(
      target: 0.10,  // æ§åˆ¶åœ¨10%ä»¥å†…
      measurement: '0-6åˆ†ç”¨æˆ·å æ¯”',
    ),

    // å£ç¢‘è·å®¢æ¯”ä¾‹
    referralRate: RateTarget(
      target: 0.15,  // 15%ç”¨æˆ·æ¥è‡ªæ¨è
      measurement: 'æ¨èæ³¨å†Œç”¨æˆ·å æ¯”',
    ),

    // åˆ†äº«ç‡
    shareRate: RateTarget(
      target: 0.20,  // 20%ç”¨æˆ·æœ‰åˆ†äº«è¡Œä¸º
      measurement: 'æœ‰åˆ†äº«è¡Œä¸ºçš„æ´»è·ƒç”¨æˆ·å æ¯”',
    ),
  );

  /// æ£€æµ‹ç›®æ ‡è¾¾æˆçŠ¶æ€
  Future<NpsGoalStatus> checkGoalStatus() async {
    final status = NpsGoalStatus();

    // è®¡ç®—å½“å‰NPS
    final currentNps = await _calculateCurrentNps();
    status.overallNps = GoalCheckResult(
      current: currentNps,
      target: npsGoals.overallNps.target,
      achieved: currentNps >= npsGoals.overallNps.target,
    );

    // è®¡ç®—æ¨èè€…æ¯”ä¾‹
    final promoterRate = await _calculatePromoterRate();
    status.promoterRate = GoalCheckResult(
      current: promoterRate,
      target: npsGoals.promoterRate.target,
      achieved: promoterRate >= npsGoals.promoterRate.target,
    );

    // è®¡ç®—è´¬æŸè€…æ¯”ä¾‹
    final detractorRate = await _calculateDetractorRate();
    status.detractorRate = GoalCheckResult(
      current: detractorRate,
      target: npsGoals.detractorRate.target,
      achieved: detractorRate <= npsGoals.detractorRate.target,  // è¶Šä½è¶Šå¥½
    );

    // è®¡ç®—å£ç¢‘è·å®¢æ¯”ä¾‹
    final referralRate = await _calculateReferralRate();
    status.referralRate = GoalCheckResult(
      current: referralRate,
      target: npsGoals.referralRate.target,
      achieved: referralRate >= npsGoals.referralRate.target,
    );

    // è®¡ç®—åˆ†äº«ç‡
    final shareRate = await _calculateShareRate();
    status.shareRate = GoalCheckResult(
      current: shareRate,
      target: npsGoals.shareRate.target,
      achieved: shareRate >= npsGoals.shareRate.target,
    );

    return status;
  }

  /// ç”ŸæˆNPSæ”¹è¿›å»ºè®®
  Future<List<NpsImprovement>> generateImprovementSuggestions(NpsGoalStatus status) async {
    final suggestions = <NpsImprovement>[];

    if (!status.overallNps.achieved) {
      // åˆ†æNPSçŸ­æ¿
      final analysis = await _analyzeNpsDrivers();

      if (analysis.functionalSatisfaction < 0.7) {
        suggestions.add(NpsImprovement(
          area: 'åŠŸèƒ½ä»·å€¼',
          priority: Priority.high,
          suggestions: [
            'æå‡é’±é¾„åˆ†æçš„å‡†ç¡®æ€§å’Œæ´å¯Ÿæ·±åº¦',
            'å¢å¼ºé¢„ç®—ç®¡ç†çš„æ™ºèƒ½æ¨èèƒ½åŠ›',
            'ä¼˜åŒ–AIè¯†åˆ«çš„å‡†ç¡®ç‡',
          ],
        ));
      }

      if (analysis.experienceSatisfaction < 0.7) {
        suggestions.add(NpsImprovement(
          area: 'ä½“éªŒè´¨é‡',
          priority: Priority.high,
          suggestions: [
            'ç®€åŒ–æ ¸å¿ƒæ“ä½œæµç¨‹',
            'ä¼˜åŒ–é¦–å‘¨å¼•å¯¼ä½“éªŒ',
            'æå‡åº”ç”¨æ€§èƒ½å’Œç¨³å®šæ€§',
          ],
        ));
      }

      if (analysis.emotionalConnection < 0.5) {
        suggestions.add(NpsImprovement(
          area: 'æƒ…æ„Ÿè¿æ¥',
          priority: Priority.medium,
          suggestions: [
            'å¢åŠ æƒŠå–œæ—¶åˆ»çš„è§¦å‘ç‚¹',
            'ä¼˜åŒ–ä¼™ä¼´åŒ–æ–‡æ¡ˆçš„æƒ…æ„Ÿè¡¨è¾¾',
            'ä¸°å¯Œæˆå°±ç³»ç»Ÿçš„å¥–åŠ±æœºåˆ¶',
          ],
        ));
      }
    }

    if (!status.shareRate.achieved) {
      suggestions.add(NpsImprovement(
        area: 'åˆ†äº«æœºåˆ¶',
        priority: Priority.medium,
        suggestions: [
          'ä¼˜åŒ–åˆ†äº«å¡ç‰‡çš„è§†è§‰è®¾è®¡',
          'å¢åŠ æ›´å¤šå¯åˆ†äº«çš„å†…å®¹ç±»å‹',
          'ç®€åŒ–åˆ†äº«æ“ä½œæµç¨‹',
        ],
      ));
    }

    return suggestions;
  }
}
```

---


### 28.7 è·¨æ¨¡å—é€šçŸ¥é¢‘ç‡ç»Ÿä¸€æ§åˆ¶

#### 28.7.1 å…¨å±€é€šçŸ¥æ§åˆ¶å™¨

ä¸ºé¿å…å¤šä¸ªæ¨¡å—ï¼ˆå®¶åº­è´¦æœ¬ã€NPSã€è£‚å˜å¼•å¯¼ç­‰ï¼‰çš„é€šçŸ¥ç´¯ç§¯é€ æˆç”¨æˆ·æ‰“æ‰°ï¼Œå»ºç«‹ç»Ÿä¸€çš„é€šçŸ¥é¢‘ç‡æ§åˆ¶æœºåˆ¶ã€‚

```dart
/// ã€æ‡’äººè®¾è®¡ã€‘å…¨å±€é€šçŸ¥é¢‘ç‡æ§åˆ¶å™¨
/// ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¨¡å—çš„é€šçŸ¥ï¼Œé˜²æ­¢é€šçŸ¥è½°ç‚¸
class GlobalNotificationController {
  // é€šçŸ¥ç±»å‹æƒé‡ï¼ˆå†³å®šä¼˜å…ˆçº§ï¼‰
  static const typeWeights = {
    NotificationType.transactionReminder: 1,   // ä½ä¼˜å…ˆçº§
    NotificationType.budgetAlert: 3,           // é«˜ä¼˜å…ˆçº§
    NotificationType.familyActivity: 2,        // ä¸­ä¼˜å…ˆçº§
    NotificationType.achievementUnlock: 2,     // ä¸­ä¼˜å…ˆçº§
    NotificationType.npsRequest: 1,            // ä½ä¼˜å…ˆçº§
    NotificationType.viralPrompt: 1,           // ä½ä¼˜å…ˆçº§
    NotificationType.splitRequest: 4,          // æœ€é«˜ä¼˜å…ˆçº§ï¼ˆæ¶‰åŠé‡‘é’±ï¼‰
  };

  // æ¯æ—¥é€šçŸ¥ä¸Šé™
  static const maxDailyNotifications = 8;
  static const maxDailyLowPriority = 3;  // ä½ä¼˜å…ˆçº§é€šçŸ¥æ¯å¤©æœ€å¤š3æ¡

  /// è¯·æ±‚å‘é€é€šçŸ¥ï¼ˆéœ€ç»è¿‡æ§åˆ¶å™¨å®¡æ‰¹ï¼‰
  static Future<bool> requestNotification({
    required String userId,
    required NotificationType type,
    required Map<String, dynamic> payload,
  }) async {
    final todayCount = await _getTodayNotificationCount(userId);
    final weight = typeWeights[type] ?? 1;

    // é«˜ä¼˜å…ˆçº§é€šçŸ¥æ€»æ˜¯å…è®¸
    if (weight >= 3) {
      await _sendNotification(userId, type, payload);
      await _incrementCount(userId);
      return true;
    }

    // æ£€æŸ¥æ¯æ—¥ä¸Šé™
    if (todayCount >= maxDailyNotifications) {
      return false;  // ä»Šæ—¥å·²è¾¾ä¸Šé™
    }

    // æ£€æŸ¥ä½ä¼˜å…ˆçº§ä¸Šé™
    if (weight == 1) {
      final lowPriorityCount = await _getLowPriorityCount(userId);
      if (lowPriorityCount >= maxDailyLowPriority) {
        return false;
      }
    }

    await _sendNotification(userId, type, payload);
    await _incrementCount(userId);
    return true;
  }

  /// æ™ºèƒ½é€šçŸ¥æ—¶æœºé€‰æ‹©
  static Future<DateTime> getBestNotificationTime(String userId) async {
    // åŸºäºç”¨æˆ·æ´»è·ƒæ—¶é—´å†å²ï¼Œé€‰æ‹©æœ€ä½³é€šçŸ¥æ—¶æœº
    final activeHours = await _getUserActiveHours(userId);
    final now = DateTime.now();

    // é¿å¼€ç¡çœ æ—¶é—´ï¼ˆé»˜è®¤22:00-08:00ï¼‰
    if (now.hour >= 22 || now.hour < 8) {
      return now.copyWith(hour: 9, minute: 0);
    }

    // é€‰æ‹©ç”¨æˆ·æœ€æ´»è·ƒçš„æ—¶é—´æ®µ
    if (activeHours.contains(now.hour)) {
      return now;
    }

    // å»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªæ´»è·ƒæ—¶é—´
    for (int h = now.hour + 1; h < 22; h++) {
      if (activeHours.contains(h)) {
        return now.copyWith(hour: h, minute: 0);
      }
    }

    return now.copyWith(hour: 9, minute: 0, day: now.day + 1);
  }
}
```

#### 28.7.2 é€šçŸ¥åˆå¹¶ç­–ç•¥

```dart
/// é€šçŸ¥åˆå¹¶æœåŠ¡ - å°†å¤šæ¡ç›¸ä¼¼é€šçŸ¥åˆå¹¶ä¸ºä¸€æ¡
class NotificationMergeService {
  /// å¯åˆå¹¶çš„é€šçŸ¥ç±»å‹
  static const mergeableTypes = {
    NotificationType.familyActivity,     // å®¶åº­åŠ¨æ€å¯åˆå¹¶
    NotificationType.achievementUnlock,  // æˆå°±å¯åˆå¹¶
  };

  /// åˆå¹¶å¾…å‘é€é€šçŸ¥
  static Future<List<MergedNotification>> mergeNotifications(
    List<PendingNotification> pending,
  ) async {
    final merged = <MergedNotification>[];
    final byType = <NotificationType, List<PendingNotification>>{};

    // æŒ‰ç±»å‹åˆ†ç»„
    for (final n in pending) {
      byType.putIfAbsent(n.type, () => []).add(n);
    }

    for (final entry in byType.entries) {
      if (mergeableTypes.contains(entry.key) && entry.value.length > 1) {
        // åˆå¹¶ä¸ºä¸€æ¡
        merged.add(MergedNotification(
          type: entry.key,
          title: _generateMergedTitle(entry.key, entry.value.length),
          // ä¾‹å¦‚: "å®¶åº­è´¦æœ¬æœ‰3æ¡æ–°åŠ¨æ€"
          items: entry.value,
        ));
      } else {
        // ä¸åˆå¹¶ï¼Œä¿æŒåŸæ ·
        for (final n in entry.value) {
          merged.add(MergedNotification.single(n));
        }
      }
    }

    return merged;
  }
}
```

---

## 29. ä½æˆæœ¬è·å®¢ä¸è‡ªç„¶å¢é•¿è®¾è®¡

### 29.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

| åŸåˆ™ | åº”ç”¨æ–¹å¼ |
|------|----------|
| **æ‡’äººè®¾è®¡** | ç”¨æˆ·æ— éœ€é¢å¤–æ“ä½œå³å¯æˆä¸ºä¼ æ’­èŠ‚ç‚¹ |
| **ç”¨æˆ·ä¼˜å…ˆ** | å¢é•¿æ‰‹æ®µä¸æŸå®³ç”¨æˆ·ä½“éªŒ |
| **å¯è§‚æµ‹æ€§** | è·å®¢æ¸ é“å¯è¿½è¸ªã€å¯å½’å› ã€å¯ä¼˜åŒ– |

#### 29.0.1 è·å®¢æˆæœ¬(CAC)æ§åˆ¶ç›®æ ‡

```
+-------------------------------------------------------------------------+
|                      è·å®¢æˆæœ¬æ§åˆ¶ç›®æ ‡                                     |
+-------------------------------------------------------------------------+
|                                                                         |
|  æˆ˜ç•¥ç›®æ ‡: CAC <= 30å…ƒ/ç”¨æˆ·                                              |
|                                                                         |
|  +---------------------------------------------------------------------+|
|  |                     è·å®¢æ¸ é“æˆæœ¬åˆ†å¸ƒç›®æ ‡                          |   |
|  +---------------------------------------------------------------------+|
|  |                                                                 |   |
|  |  è‡ªç„¶æµé‡ (ç›®æ ‡å æ¯” 40%, CAC = 0å…ƒ)                              |   |
|  |  - åº”ç”¨å•†åº—è‡ªç„¶æœç´¢                                             |   |
|  |  - SEO/å†…å®¹è¥é”€å¸¦æ¥çš„æµé‡                                       |   |
|  |  - ç”¨æˆ·è‡ªå‘åˆ†äº«                                                 |   |
|  |                                                                 |   |
|  |  å£ç¢‘è£‚å˜ (ç›®æ ‡å æ¯” 25%, CAC = 5å…ƒ)                              |   |
|  |  - é‚€è¯·å¥–åŠ±æœºåˆ¶                                                 |   |
|  |  - æˆå°±åˆ†äº«å¸¦æ¥çš„æ–°ç”¨æˆ·                                         |   |
|  |  - å®¶åº­/æœ‹å‹æ¨è                                                |   |
|  |                                                                 |   |
|  |  å†…å®¹è·å®¢ (ç›®æ ‡å æ¯” 20%, CAC = 15å…ƒ)                             |   |
|  |  - äº§å“å†…ç”Ÿæˆçš„å¯ä¼ æ’­å†…å®¹                                       |   |
|  |  - ç”¨æˆ·UGCå†…å®¹                                                  |   |
|  |  - KOL/KOCåˆä½œ                                                  |   |
|  |                                                                 |   |
|  |  ä»˜è´¹æ¨å¹¿ (ç›®æ ‡å æ¯” 15%, CAC = 80å…ƒ)                             |   |
|  |  - åº”ç”¨å•†åº—å¹¿å‘Š                                                 |   |
|  |  - ä¿¡æ¯æµå¹¿å‘Š                                                   |   |
|  |  - ç²¾å‡†æŠ•æ”¾                                                     |   |
|  |                                                                 |   |
|  +---------------------------------------------------------------------+|
|                                                                         |
|  ç»¼åˆCAC = 40%*0 + 25%*5 + 20%*15 + 15%*80 = 16.25å…ƒ < 30å…ƒ            |
|                                                                         |
+-------------------------------------------------------------------------+
```

#### 29.0.2 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
+-------------------------------------------------------------------------+
|                   ä½æˆæœ¬è·å®¢ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„ååŒ                           |
+-------------------------------------------------------------------------+
|                                                                         |
|  +---------------+  +---------------+  +---------------+                |
|  |  é’±é¾„åˆ†æç³»ç»Ÿ  |  |  æ•°æ®å¯è§†åŒ–   |  |  ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ  |                |
|  |  (ç¬¬7ç« )      |  |  (ç¬¬12ç« )     |  |  (ç¬¬9ç« )      |                |
|  |              |  |              |  |              |                |
|  | å·®å¼‚åŒ–å–ç‚¹ -> |  | å¯ä¼ æ’­å›¾è¡¨ -> |  | æˆå°±å¾½ç«  ->   |                |
|  | å†…å®¹ç´ æ     |  | åˆ†äº«ç´ æ     |  | åˆ†äº«ç´ æ     |                |
|  +------+-------+  +------+-------+  +------+-------+                |
|         |                 |                 |                         |
|         +----------------++-----------------+                         |
|                          v                                             |
|                +---------------------+                                 |
|                | ä½æˆæœ¬è·å®¢è®¾è®¡ (æœ¬ç« ) |                                 |
|                |                     |                                 |
|                |  - äº§å“å†…ç½®å¢é•¿å¼•æ“  |                                 |
|                |  - ASOä¼˜åŒ–è®¾è®¡      |                                 |
|                |  - å†…å®¹ç”Ÿæˆç³»ç»Ÿ     |                                 |
|                |  - ç—…æ¯’ç³»æ•°ä¼˜åŒ–     |                                 |
|                +----------+----------+                                 |
|                          |                                             |
|         +----------------+----------------+                           |
|         v                v                v                           |
|  +---------------+ +---------------+ +---------------+                |
|  |  NPSæå‡ç³»ç»Ÿ   | |  å®¶åº­è´¦æœ¬ç³»ç»Ÿ  | |  å›½é™…åŒ–ç³»ç»Ÿ    |                |
|  |  (ç¬¬28ç« )     | |  (ç¬¬13ç« )     | |  (ç¬¬21ç« )     |                |
|  |              | |              | |              |                |
|  | æ¨èè€…åŸ¹è‚² -> | | å®¶åº­è£‚å˜ ->   | | å¤šå¸‚åœºè¦†ç›– -> |                |
|  | å£ç¢‘è·å®¢     | | è‡ªç„¶å¢é•¿     | | æ‰©å¤§åŸºæ•°     |                |
|  +---------------+ +---------------+ +---------------+                |
|                                                                         |
+-------------------------------------------------------------------------+
```

### 29.1 äº§å“å†…ç½®å¢é•¿å¼•æ“

#### 29.1.1 å¢é•¿å¼•æ“æ¶æ„

äº§å“å†…ç½®å¢é•¿å¼•æ“æ˜¯æŒ‡å°†è·å®¢èƒ½åŠ›åµŒå…¥äº§å“æ ¸å¿ƒåŠŸèƒ½ï¼Œè®©ç”¨æˆ·åœ¨æ­£å¸¸ä½¿ç”¨è¿‡ç¨‹ä¸­è‡ªç„¶æˆä¸ºä¼ æ’­èŠ‚ç‚¹ã€‚

```dart
/// ã€æ‡’äººè®¾è®¡ã€‘è£‚å˜å¼•å¯¼é¢‘ç‡æ§åˆ¶å™¨
/// é˜²æ­¢è¿‡åº¦æ‰“æ‰°ç”¨æˆ·ï¼Œä¿æŠ¤ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
class ViralFrequencyController {
  static const maxDailyPrompts = 2;        // æ¯å¤©æœ€å¤š2æ¬¡è£‚å˜å¼•å¯¼
  static const minIntervalHours = 4;       // ä¸¤æ¬¡å¼•å¯¼é—´éš”è‡³å°‘4å°æ—¶
  static const cooldownAfterDismiss = 24;  // ç”¨æˆ·å…³é—­å24å°æ—¶å†…ä¸å†æç¤º

  /// æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºè£‚å˜å¼•å¯¼
  static Future<bool> canShowViralPrompt(String userId) async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);

    // æ£€æŸ¥ä»Šæ—¥æ¬¡æ•°
    final todayCount = prefs.getInt('viral_count_$today') ?? 0;
    if (todayCount >= maxDailyPrompts) return false;

    // æ£€æŸ¥ä¸Šæ¬¡æç¤ºæ—¶é—´
    final lastPrompt = prefs.getInt('last_viral_prompt');
    if (lastPrompt != null) {
      final hoursSince = DateTime.now().difference(
        DateTime.fromMillisecondsSinceEpoch(lastPrompt)
      ).inHours;
      if (hoursSince < minIntervalHours) return false;
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨å†·å´æœŸ
    final dismissedAt = prefs.getInt('viral_dismissed_at');
    if (dismissedAt != null) {
      final hoursSince = DateTime.now().difference(
        DateTime.fromMillisecondsSinceEpoch(dismissedAt)
      ).inHours;
      if (hoursSince < cooldownAfterDismiss) return false;
    }

    return true;
  }

  /// è®°å½•ç”¨æˆ·å…³é—­å¼•å¯¼
  static Future<void> recordDismiss() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt('viral_dismissed_at', DateTime.now().millisecondsSinceEpoch);
  }
}

/// äº§å“å†…ç½®å¢é•¿å¼•æ“
class ProductGrowthEngine {
  /// å¢é•¿è§¦å‘ç‚¹
  static const growthTriggers = [
    // ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘æˆå°±è§£é”æ—¶ - å…ˆåº†ç¥3ç§’ï¼Œå†æ¸©å’Œå¼•å¯¼åˆ†äº«
    // å‚è€ƒç¬¬4ç« "é¼“åŠ±è€Œéè¯´æ•™"åŸåˆ™
    GrowthTrigger(
      event: 'achievement_unlocked',
      action: 'å…ˆå±•ç¤ºåº†ç¥åŠ¨ç”»3ç§’ï¼Œç„¶åä»¥æ¬¡è¦é€‰é¡¹å±•ç¤ºåˆ†äº«å…¥å£',
      celebrationFirst: true,        // åº†ç¥ä¼˜å…ˆ
      celebrationDuration: 3000,     // åº†ç¥åŠ¨ç”»æŒç»­3ç§’
      shareButtonStyle: 'secondary', // åˆ†äº«æŒ‰é’®ä¸ºæ¬¡è¦æ ·å¼
      dismissOption: 'ä¸‹æ¬¡å†åˆ†äº«',    // æä¾›ç¨åé€‰é¡¹
      expectedConversion: 0.15,
    ),

    // é’±é¾„é‡Œç¨‹ç¢‘æ—¶
    GrowthTrigger(
      event: 'money_age_milestone',
      action: 'ç”Ÿæˆé’±é¾„å¡ç‰‡ï¼Œå¼•å¯¼åˆ†äº«åˆ°ç¤¾äº¤å¹³å°',
      expectedConversion: 0.20,
    ),

    // å‚¨è“„ç›®æ ‡è¾¾æˆæ—¶
    GrowthTrigger(
      event: 'savings_goal_achieved',
      action: 'ç”Ÿæˆç›®æ ‡è¾¾æˆåº†ç¥å¡ç‰‡',
      expectedConversion: 0.25,
    ),

    // æœˆåº¦/å¹´åº¦æ€»ç»“æ—¶
    GrowthTrigger(
      event: 'periodic_summary',
      action: 'ç”Ÿæˆç²¾ç¾è´¢åŠ¡æŠ¥å‘Šå¡ç‰‡',
      expectedConversion: 0.30,
    ),

    // å®¶åº­è´¦æœ¬é‚€è¯·æ—¶
    GrowthTrigger(
      event: 'family_ledger_created',
      action: 'å¼•å¯¼é‚€è¯·å®¶äººåŠ å…¥',
      expectedConversion: 0.80,  // åˆ›å»ºå®¶åº­è´¦æœ¬çš„ç”¨æˆ·å¤§æ¦‚ç‡ä¼šé‚€è¯·
    ),
  ];

  /// è®¡ç®—ç—…æ¯’ç³»æ•°(K-factor)
  /// K = é‚€è¯·å‘é€ç‡ * å¹³å‡é‚€è¯·æ•° * é‚€è¯·è½¬åŒ–ç‡
  Future<double> calculateViralCoefficient() async {
    final inviteSendRate = await _getInviteSendRate();      // å‘é€é‚€è¯·çš„ç”¨æˆ·æ¯”ä¾‹
    final avgInvitesPerUser = await _getAvgInvitesPerUser(); // å¹³å‡æ¯ç”¨æˆ·å‘é€é‚€è¯·æ•°
    final inviteConversionRate = await _getInviteConversionRate(); // é‚€è¯·è½¬åŒ–ç‡

    return inviteSendRate * avgInvitesPerUser * inviteConversionRate;
    // ç›®æ ‡: K > 0.5 (æ¯2ä¸ªç”¨æˆ·å¸¦æ¥1ä¸ªæ–°ç”¨æˆ·)
  }
}
```

#### 29.1.2 åˆ†äº«ç´ æè‡ªåŠ¨ç”Ÿæˆ

> ğŸ“ **è®¾è®¡è¯´æ˜**ï¼šæœ¬æœåŠ¡ä¸ºç»Ÿä¸€çš„åˆ†äº«ç´ æç”ŸæˆæœåŠ¡ï¼ŒåŒæ—¶è¢«ç¬¬28ç« ï¼ˆNPSå£ç¢‘åˆ†äº«ï¼‰å’Œç¬¬29ç« ï¼ˆå¢é•¿è£‚å˜ï¼‰å¤ç”¨ï¼Œç¡®ä¿åˆ†äº«ä½“éªŒä¸€è‡´æ€§ã€‚

```dart
/// ã€ç»Ÿä¸€æœåŠ¡ã€‘åˆ†äº«ç´ æç”ŸæˆæœåŠ¡
/// è¢«ç¬¬28ç« NPSç³»ç»Ÿå’Œç¬¬29ç« å¢é•¿ç³»ç»Ÿå…±åŒä½¿ç”¨
class ShareAssetGeneratorService {
  /// å¯åˆ†äº«ç´ æç±»å‹
  static const shareableAssets = [
    // è´¢åŠ¡æˆå°±ç±»
    ShareableAsset(
      type: AssetType.moneyAgeMilestone,
      template: 'money_age_card',
      headline: 'æˆ‘çš„é’±é¾„è¾¾åˆ°äº†{days}å¤©ï¼',
      subheadline: 'ä½ çš„é’±èƒ½æ´»å¤šä¹…ï¼Ÿ',
      callToAction: 'æµ‹æµ‹ä½ çš„é’±é¾„',
      platforms: [Platform.wechatMoments, Platform.weibo, Platform.xiaohongshu],
    ),
    ShareableAsset(
      type: AssetType.savingsAchievement,
      template: 'savings_card',
      headline: 'æˆåŠŸå­˜ä¸‹äº†{amount}ï¼',
      subheadline: 'ç¬¬{n}ä¸ªå‚¨è“„ç›®æ ‡è¾¾æˆ',
      callToAction: 'ä¸€èµ·æ¥å­˜é’±',
      platforms: [Platform.wechatMoments, Platform.weibo],
    ),

    // æ•°æ®æ´å¯Ÿç±»
    ShareableAsset(
      type: AssetType.monthlyReport,
      template: 'monthly_report_card',
      headline: '{month}æœˆè´¢åŠ¡å°ç»“',
      subheadline: 'æ”¶å…¥{income} æ”¯å‡º{expense} ç»“ä½™{balance}',
      callToAction: 'ç”Ÿæˆä½ çš„è´¢åŠ¡æŠ¥å‘Š',
      platforms: [Platform.wechatMoments, Platform.xiaohongshu],
    ),
    ShareableAsset(
      type: AssetType.yearlyReport,
      template: 'yearly_report_card',
      headline: '{year}å¹´åº¦è´¦å•',
      subheadline: 'è¿™ä¸€å¹´ï¼Œæˆ‘èŠ±äº†{total}',
      callToAction: 'æŸ¥çœ‹ä½ çš„å¹´åº¦è´¦å•',
      platforms: [Platform.wechatMoments, Platform.weibo, Platform.xiaohongshu, Platform.douyin],
      seasonalBoost: true,  // å¹´ç»ˆå­£èŠ‚æ€§çƒ­ç‚¹
    ),

    // è¶£å‘³ç±»ï¼ˆé«˜ä¼ æ’­æ€§ï¼‰
    ShareableAsset(
      type: AssetType.financialPersonality,
      template: 'personality_card',
      headline: 'æˆ‘çš„ç†è´¢äººæ ¼æ˜¯ï¼š{personality}',
      subheadline: '{description}',
      callToAction: 'æµ‹æµ‹ä½ çš„ç†è´¢äººæ ¼',
      platforms: [Platform.wechatMoments, Platform.xiaohongshu, Platform.weibo],
      viralPotential: ViralPotential.high,
    ),
    ShareableAsset(
      type: AssetType.spendingComparison,
      template: 'comparison_card',
      headline: 'æˆ‘æ¯”{percent}%çš„åŒé¾„äººæ›´ä¼šçœé’±',
      subheadline: 'é’±é¾„{days}å¤©ï¼Œè¶…è¿‡{percent}%çš„ç”¨æˆ·',
      callToAction: 'ä½ èƒ½è¶…è¿‡å¤šå°‘äººï¼Ÿ',
      platforms: [Platform.wechatMoments, Platform.xiaohongshu],
      viralPotential: ViralPotential.high,
    ),
  ];

  /// ç”Ÿæˆåˆ†äº«å¡ç‰‡
  Future<ShareCard> generateCard(ShareableAsset asset, Map<String, dynamic> data) async {
    // 1. é€‰æ‹©æ¨¡æ¿
    final template = await _loadTemplate(asset.template);

    // 2. å¡«å……æ•°æ®
    final filledTemplate = _fillTemplate(template, data);

    // 3. æ·»åŠ å“ç‰Œå…ƒç´ 
    final brandedCard = _addBranding(filledTemplate);

    // 4. æ·»åŠ è¿½è¸ªå‚æ•°
    final trackableCard = _addTrackingParams(brandedCard, asset.type);

    // 5. é’ˆå¯¹ä¸åŒå¹³å°ä¼˜åŒ–å°ºå¯¸
    final platformCards = <Platform, ShareCard>{};
    for (final platform in asset.platforms) {
      platformCards[platform] = _optimizeForPlatform(trackableCard, platform);
    }

    return ShareCard(
      type: asset.type,
      cards: platformCards,
      shareText: _generateShareText(asset, data),
      deepLink: _generateDeepLink(asset.type),
    );
  }
}
```

#### 29.1.3 ç—…æ¯’ç¯è·¯è®¾è®¡

```
+-------------------------------------------------------------------------+
|                         ç—…æ¯’ç¯è·¯è®¾è®¡                                      |
+-------------------------------------------------------------------------+
|                                                                         |
|  æ ¸å¿ƒç—…æ¯’ç¯è·¯ (é«˜é¢‘è§¦å‘)                                                  |
|                                                                         |
|       +--------------+                                                  |
|       |   æ–°ç”¨æˆ·æ³¨å†Œ  |                                                  |
|       +------+-------+                                                  |
|              v                                                          |
|       +--------------+                                                  |
|       |  å®Œæˆé¦–å‘¨ä½“éªŒ |<-----------------------------------+            |
|       +------+-------+                                  |            |
|              v                                          |            |
|       +--------------+                                  |            |
|       | è·å¾—æˆå°±/é‡Œç¨‹ç¢‘|                                 |            |
|       +------+-------+                                  |            |
|              v                                          |            |
|       +--------------+     +--------------+            |            |
|       |  ç”Ÿæˆåˆ†äº«å¡ç‰‡ |---->|  åˆ†äº«åˆ°ç¤¾äº¤å¹³å° |            |            |
|       +--------------+     +------+-------+            |            |
|                                   v                    |            |
|                            +--------------+            |            |
|                            |  å¥½å‹çœ‹åˆ°å¡ç‰‡ |            |            |
|                            +------+-------+            |            |
|                                   v                    |            |
|                            +--------------+            |            |
|                            |  ç‚¹å‡»äº†è§£äº§å“ |            |            |
|                            +------+-------+            |            |
|                                   v                    |            |
|                            +--------------+            |            |
|                            |   ä¸‹è½½å®‰è£…    |------------+            |
|                            +--------------+                          |
|                                                                         |
|  ç—…æ¯’ç³»æ•°ç›®æ ‡: K = 0.6 (æ¯10ä¸ªç”¨æˆ·å¸¦æ¥6ä¸ªæ–°ç”¨æˆ·)                          |
|                                                                         |
+-------------------------------------------------------------------------+
```

### 29.2 åº”ç”¨å•†åº—ä¼˜åŒ–(ASO)è®¾è®¡

#### 29.2.1 ASOå…³é”®è¯ç­–ç•¥

```dart
/// ASOä¼˜åŒ–æœåŠ¡
class AsoOptimizationService {
  /// æ ¸å¿ƒå…³é”®è¯çŸ©é˜µ
  static const keywordMatrix = KeywordMatrix(
    // å“ç±»è¯ï¼ˆé«˜æœç´¢é‡ï¼Œé«˜ç«äº‰ï¼‰
    categoryKeywords: [
      Keyword(word: 'è®°è´¦', priority: Priority.high, difficulty: Difficulty.high),
      Keyword(word: 'è®°è´¦è½¯ä»¶', priority: Priority.high, difficulty: Difficulty.high),
      Keyword(word: 'è®°è´¦APP', priority: Priority.high, difficulty: Difficulty.high),
      Keyword(word: 'ç†è´¢', priority: Priority.medium, difficulty: Difficulty.high),
    ],

    // åŠŸèƒ½è¯ï¼ˆä¸­ç­‰æœç´¢é‡ï¼Œä¸­ç­‰ç«äº‰ï¼‰
    featureKeywords: [
      Keyword(word: 'è¯­éŸ³è®°è´¦', priority: Priority.high, difficulty: Difficulty.medium),
      Keyword(word: 'æ‹ç…§è®°è´¦', priority: Priority.high, difficulty: Difficulty.medium),
      Keyword(word: 'é¢„ç®—ç®¡ç†', priority: Priority.high, difficulty: Difficulty.medium),
      Keyword(word: 'æ™ºèƒ½è®°è´¦', priority: Priority.high, difficulty: Difficulty.medium),
      Keyword(word: 'AIè®°è´¦', priority: Priority.high, difficulty: Difficulty.low),
    ],

    // å·®å¼‚åŒ–è¯ï¼ˆä½æœç´¢é‡ï¼Œä½ç«äº‰ï¼Œé«˜è½¬åŒ–ï¼‰
    differentiatorKeywords: [
      Keyword(word: 'é’±é¾„', priority: Priority.critical, difficulty: Difficulty.low),
      Keyword(word: 'é›¶åŸºé¢„ç®—', priority: Priority.high, difficulty: Difficulty.low),
      Keyword(word: 'ä¿¡å°é¢„ç®—', priority: Priority.medium, difficulty: Difficulty.low),
      Keyword(word: 'å°é‡‘åº“', priority: Priority.high, difficulty: Difficulty.low),
    ],

    // åœºæ™¯è¯ï¼ˆç²¾å‡†ç”¨æˆ·ï¼Œé«˜è½¬åŒ–ï¼‰
    scenarioKeywords: [
      Keyword(word: 'æœˆå…‰æ—', priority: Priority.high, difficulty: Difficulty.low),
      Keyword(word: 'å­˜é’±', priority: Priority.high, difficulty: Difficulty.medium),
      Keyword(word: 'çœé’±', priority: Priority.medium, difficulty: Difficulty.medium),
      Keyword(word: 'å®¶åº­è®°è´¦', priority: Priority.medium, difficulty: Difficulty.medium),
      Keyword(word: 'æƒ…ä¾£è®°è´¦', priority: Priority.medium, difficulty: Difficulty.low),
    ],

    // ç«å“è¯ï¼ˆæˆªæµï¼‰
    competitorKeywords: [
      Keyword(word: 'éšæ‰‹è®°æ›¿ä»£', priority: Priority.medium, difficulty: Difficulty.medium),
      Keyword(word: 'YNABä¸­æ–‡', priority: Priority.high, difficulty: Difficulty.low),
    ],
  );

  /// ç”Ÿæˆåº”ç”¨æ ‡é¢˜å˜ä½“ï¼ˆç”¨äºA/Bæµ‹è¯•ï¼‰
  static const titleVariants = [
    'AIæ™ºèƒ½è®°è´¦ - é’±é¾„åˆ†æï¼Œè®©æ¯åˆ†é’±æ›´æœ‰ä»·å€¼',
    'AIæ™ºèƒ½è®°è´¦ - è¯­éŸ³è®°è´¦ï¼Œ3ç§’æå®š',
    'AIæ™ºèƒ½è®°è´¦ - é›¶åŸºé¢„ç®—ï¼Œå‘Šåˆ«æœˆå…‰',
    'AIæ™ºèƒ½è®°è´¦ - ä½ çš„æ™ºèƒ½ç†è´¢ä¼™ä¼´',
  ];
}
```

#### 29.2.2 åº”ç”¨å•†åº—è¯„åˆ†ä¼˜åŒ–

```dart
/// åº”ç”¨è¯„åˆ†ä¼˜åŒ–æœåŠ¡
class AppRatingOptimizationService {
  /// è¯„åˆ†è¯·æ±‚ç­–ç•¥
  static const ratingRequestStrategy = RatingStrategy(
    // è§¦å‘æ—¶æœºï¼ˆç”¨æˆ·å¤„äºç§¯ææƒ…ç»ªæ—¶ï¼‰
    triggers: [
      RatingTrigger(
        event: 'achievement_unlocked',
        condition: 'first_meaningful_achievement',
        delay: Duration(seconds: 3),
        description: 'é¦–æ¬¡è§£é”æœ‰æ„ä¹‰çš„æˆå°±å',
      ),
      RatingTrigger(
        event: 'savings_goal_progress',
        condition: 'progress >= 50%',
        delay: Duration(seconds: 2),
        description: 'å‚¨è“„ç›®æ ‡å®Œæˆè¿‡åŠæ—¶',
      ),
      RatingTrigger(
        event: 'positive_money_age_change',
        condition: 'increase >= 3 days',
        delay: Duration(seconds: 3),
        description: 'é’±é¾„æå‡3å¤©ä»¥ä¸Šæ—¶',
      ),
    ],

    // è¯·æ±‚é™åˆ¶
    constraints: RatingConstraints(
      minDaysAfterInstall: 3,           // å®‰è£…3å¤©åæ‰è¯·æ±‚
      minSessionsBeforeRequest: 5,       // è‡³å°‘ä½¿ç”¨5æ¬¡
      minDaysBetweenRequests: 90,        // ä¸¤æ¬¡è¯·æ±‚é—´éš”90å¤©
      maxRequestsPerUser: 3,             // æ¯ç”¨æˆ·æœ€å¤šè¯·æ±‚3æ¬¡
    ),

    // ä½åˆ†ç”¨æˆ·å¼•å¯¼
    lowRatingIntervention: LowRatingIntervention(
      threshold: 3,  // 3æ˜ŸåŠä»¥ä¸‹
      action: 'å±•ç¤ºåé¦ˆå…¥å£ï¼Œå¼•å¯¼ç”¨æˆ·å…ˆå‘Šè¯‰æˆ‘ä»¬é—®é¢˜',
      message: 'å¾ˆæŠ±æ­‰æ²¡èƒ½è®©æ‚¨æ»¡æ„ï¼Œèƒ½å‘Šè¯‰æˆ‘ä»¬å“ªé‡Œéœ€è¦æ”¹è¿›å—ï¼Ÿ',
    ),
  );
}
```

### 29.3 å†…å®¹é©±åŠ¨å¢é•¿è®¾è®¡

#### 29.3.1 äº§å“å†…å®¹ç”Ÿæˆç³»ç»Ÿ

äº§å“è‡ªåŠ¨ç”Ÿæˆå¯ä¼ æ’­çš„å†…å®¹ï¼Œé™ä½ç”¨æˆ·åˆ›ä½œé—¨æ§›ã€‚

```dart
/// å†…å®¹ç”Ÿæˆå¼•æ“
class ContentGenerationEngine {
  /// è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹ç±»å‹
  static const contentTypes = [
    // ä¸ªäººè´¢åŠ¡æ•…äº‹
    ContentType(
      id: 'financial_story',
      name: 'æˆ‘çš„ç†è´¢æ•…äº‹',
      description: 'åŸºäºç”¨æˆ·æ•°æ®è‡ªåŠ¨ç”Ÿæˆçš„è´¢åŠ¡æˆé•¿æ•…äº‹',
      frequency: ContentFrequency.monthly,
      shareability: Shareability.high,
    ),

    // ç†è´¢äººæ ¼æµ‹è¯•
    ContentType(
      id: 'financial_personality',
      name: 'ç†è´¢äººæ ¼æµ‹è¯•',
      description: 'åŸºäºæ¶ˆè´¹æ¨¡å¼åˆ†æçš„äººæ ¼æµ‹è¯•',
      frequency: ContentFrequency.onDemand,
      shareability: Shareability.veryHigh,
    ),

    // å¹´åº¦ç›˜ç‚¹
    ContentType(
      id: 'yearly_recap',
      name: 'å¹´åº¦è´¢åŠ¡ç›˜ç‚¹',
      description: 'å¹´åº¦æ¶ˆè´¹ã€å‚¨è“„ã€é’±é¾„å…¨é¢ç›˜ç‚¹',
      frequency: ContentFrequency.yearly,
      shareability: Shareability.veryHigh,
      seasonalBoost: true,
    ),
  ];

  /// ç”Ÿæˆç†è´¢äººæ ¼æµ‹è¯•ç»“æœ
  Future<PersonalityResult> generateFinancialPersonality(String userId) async {
    final transactions = await _getTransactions(userId, days: 90);
    final stats = _analyzeSpendingPattern(transactions);

    // æ ¹æ®æ¶ˆè´¹æ¨¡å¼ç¡®å®šç†è´¢äººæ ¼
    final personality = _determinePersonality(stats);

    return PersonalityResult(
      type: personality.type,
      title: personality.title,  // å¦‚: "ç†æ€§è§„åˆ’å¸ˆ"ã€"éšæ€§æ¢ç´¢è€…"
      description: personality.description,
      strengths: personality.strengths,
      improvements: personality.improvements,
      rarity: await _calculateRarity(personality.type),  // "ä»…æœ‰12%çš„ç”¨æˆ·æ˜¯è¿™ä¸ªç±»å‹"
      shareCard: await _generatePersonalityCard(personality),
    );
  }

  /// ç”Ÿæˆå¹´åº¦ç›˜ç‚¹è¶£å‘³äº‹å®
  List<FunFact> generateFunFacts(YearData data) {
    return [
      FunFact(
        text: 'ä½ ä»Šå¹´å–äº†${data.coffeeCount}æ¯å’–å•¡',
      ),
      FunFact(
        text: 'ä½ ç‚¹äº†${data.takeoutCount}æ¬¡å¤–å–',
      ),
      FunFact(
        text: 'ä½ æœ€èƒ½çœé’±çš„æœˆä»½æ˜¯${data.mostFrugalMonth}æœˆ',
      ),
    ];
  }
}
```

#### 29.3.2 ç”¨æˆ·UGCå¼•å¯¼è®¾è®¡

```dart
/// UGCå¼•å¯¼æœåŠ¡
class UgcGuidanceService {
  /// UGCå¼•å¯¼åœºæ™¯
  static const ugcScenarios = [
    // æˆåŠŸæ•…äº‹åˆ†äº«
    UgcScenario(
      trigger: 'significant_savings_milestone',
      prompt: 'æ­å–œä½ å­˜ä¸‹äº†{amount}ï¼æ„¿æ„åˆ†äº«ä½ çš„çœé’±å¿ƒå¾—å—ï¼Ÿ',
      template: UgcTemplate(
        title: 'æˆ‘æ˜¯å¦‚ä½•{days}å¤©å­˜ä¸‹{amount}çš„',
        sections: ['èµ·å› ', 'æ–¹æ³•', 'æ”¶è·'],
        hashtags: ['ç†è´¢æ‰“å¡', 'çœé’±æ—¥è®°', 'AIè®°è´¦'],
      ),
      incentive: 'åˆ†äº«åå¯è§£é”ä¸“å±å¾½ç« ',
    ),

    // é’±é¾„è¿›é˜¶åˆ†äº«
    UgcScenario(
      trigger: 'money_age_level_up',
      prompt: 'é’±é¾„å‡çº§åˆ°{level}äº†ï¼åˆ†äº«ä½ çš„é’±é¾„æ•…äº‹å§',
      template: UgcTemplate(
        title: 'æˆ‘çš„é’±é¾„ä»{before}å¤©åˆ°{after}å¤©çš„å†ç¨‹',
        sections: ['æ”¹å˜å‰', 'æˆ‘åšäº†ä»€ä¹ˆ', 'ç°åœ¨çš„å˜åŒ–'],
        hashtags: ['é’±é¾„æŒ‘æˆ˜', 'è´¢åŠ¡è‡ªç”±', 'AIè®°è´¦'],
      ),
      incentive: 'ç²¾é€‰æ•…äº‹å°†è·å¾—å®˜æ–¹æ¨è',
    ),

    // ä¹ æƒ¯å…»æˆåˆ†äº«
    UgcScenario(
      trigger: 'habit_formed',
      prompt: 'è¿ç»­è®°è´¦{days}å¤©äº†ï¼ä½ çš„åšæŒå€¼å¾—è¢«çœ‹è§',
      template: UgcTemplate(
        title: 'æˆ‘æ˜¯å¦‚ä½•åšæŒè®°è´¦{days}å¤©çš„',
        sections: ['ä¸ºä»€ä¹ˆå¼€å§‹', 'å¦‚ä½•åšæŒ', 'ç»™æ–°äººçš„å»ºè®®'],
        hashtags: ['è®°è´¦æ‰“å¡', 'ä¹ æƒ¯å…»æˆ', 'AIè®°è´¦'],
      ),
      incentive: 'è·å¾—"ä¹ æƒ¯å¯¼å¸ˆ"ç§°å·',
    ),
  ];
}
```

### 29.4 ç¤¾äº¤è£‚å˜æœºåˆ¶è®¾è®¡

#### 29.4.1 å®¶åº­è´¦æœ¬è£‚å˜

> ğŸ“ **ç›¸å…³ç« èŠ‚**ï¼šå®¶åº­è´¦æœ¬æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§[ç¬¬13ç«  å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ](#13-å®¶åº­è´¦æœ¬ä¸å¤šæˆå‘˜ç®¡ç†ç³»ç»Ÿ)

å®¶åº­è´¦æœ¬æ˜¯å¤©ç„¶çš„è£‚å˜åœºæ™¯ï¼Œåˆ›å»ºè€…å¿…ç„¶ä¼šé‚€è¯·å®¶äººåŠ å…¥ã€‚

```dart
/// å®¶åº­è´¦æœ¬è£‚å˜æœåŠ¡
class FamilyLedgerViralService {
  /// ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘è£‚å˜è·¯å¾„è®¾è®¡ - æ¸©æš–å‹å–„çš„å¼•å¯¼è¯­
  /// å‚è€ƒç¬¬4ç« ä¼™ä¼´åŒ–æ–‡æ¡ˆè®¾è®¡åŸåˆ™
  static const viralPath = FamilyViralPath(
    // åˆ›å»ºæ—¶å¼•å¯¼ - ä½¿ç”¨æ¸©æš–çš„ä¼™ä¼´è¯­æ°”
    onCreation: ViralStep(
      message: 'å¤ªå¥½äº†ï¼Œå®¶åº­è´¦æœ¬å‡†å¤‡å¥½äº†ï¼ğŸ  è¦ä¸è¦é‚€è¯·å®¶äººä¸€èµ·ç®¡ç†è´¢åŠ¡å‘€ï¼Ÿ',
      actions: [
        // ã€æ— éšœç¢è®¾è®¡ã€‘å‚è€ƒç¬¬5ç« TouchTargetServiceï¼Œç¡®ä¿è§¦æ§ç›®æ ‡â‰¥48x48
        ViralAction(
          type: ActionType.inviteSpouse,
          label: 'é‚€è¯·å¦ä¸€åŠ',
          expectedConversion: 0.70,
          // ã€æ— éšœç¢ã€‘æŒ‰é’®æ— éšœç¢é…ç½®
          accessibility: ViralActionAccessibility(
            semanticLabel: 'é‚€è¯·å¦ä¸€åŠåŠ å…¥å®¶åº­è´¦æœ¬',
            minTouchTarget: 48.0,  // WCAG 2.5.5 è¦æ±‚
            hint: 'ç‚¹å‡»åå¯é€‰æ‹©é‚€è¯·æ–¹å¼',
          ),
        ),
        ViralAction(
          type: ActionType.inviteParents,
          label: 'é‚€è¯·çˆ¶æ¯',
          expectedConversion: 0.30,
        ),
        ViralAction(
          type: ActionType.inviteChildren,
          label: 'é‚€è¯·å­©å­',
          expectedConversion: 0.20,
        ),
      ],
    ),

    // ä½¿ç”¨ä¸­æŒç»­å¼•å¯¼
    duringUsage: [
      ViralStep(
        trigger: 'first_shared_expense',
        message: 'ç¬¬ä¸€ç¬”å®¶åº­è´¦è®°å¥½å•¦ï¼ğŸ“ åˆ†äº«ç»™å®¶äººçœ‹çœ‹ï¼Ÿä¸€èµ·ç®¡é’±æ›´æœ‰åŠ¨åŠ›å“¦~',
      ),
      ViralStep(
        trigger: 'budget_set',
        message: 'é¢„ç®—è®¡åˆ’åˆ¶å®šå®Œæˆï¼âœ¨ é‚€è¯·å®¶äººä¸€èµ·å‚ä¸ï¼Œå¤§å®¶éƒ½æœ‰æ•°æ‰èƒ½ä¸€èµ·çœ~',
      ),
      ViralStep(
        trigger: 'monthly_summary',
        message: 'è¿™ä¸ªæœˆçš„å®¶åº­è´¢åŠ¡æŠ¥å‘Šå‡ºç‚‰å•¦ï¼ğŸ“Š è¦ä¸è¦å’Œå®¶äººä¸€èµ·çœ‹çœ‹æˆæœï¼Ÿ',
      ),
    ],

    // è¢«é‚€è¯·è€…æ¿€æ´»è·¯å¾„
    inviteeActivation: InviteeActivation(
      welcomeMessage: '{inviterName}é‚€è¯·ä½ åŠ å…¥"{ledgerName}"å®¶åº­è´¦æœ¬',
      quickActions: ['è®°ä¸€ç¬”', 'æŸ¥çœ‹é¢„ç®—', 'æŸ¥çœ‹æŠ¥è¡¨'],
      incentive: 'æ–°æˆå‘˜è®°å½•ç¬¬ä¸€ç¬”è´¦å¯è·å¾—å®¶åº­å¾½ç« ',
    ),
  );
}
```

#### 29.4.2 æƒ…ä¾£/AAè®°è´¦è£‚å˜

```dart
/// æƒ…ä¾£/AAè®°è´¦è£‚å˜æœåŠ¡
class CoupleAccountingViralService {
  /// AAè®°è´¦è‡ªç„¶è£‚å˜
  static const aaViralDesign = AAViralDesign(
    // AAåˆ†è´¦æ—¶è‡ªç„¶å¼•å¯¼
    onSplitBill: ViralStep(
      message: 'è¿™ç¬”è´¦{partnerName}ä¹Ÿè¦è®°ä¸€ä¸‹å—ï¼Ÿä¸€èµ·è®°æ›´æ¸…æ¥šå“¦~ ğŸ’‘',
      actions: [
        ViralAction(
          type: ActionType.sendReminder,
          label: 'å‘é€æé†’',
          expectedConversion: 0.60,
        ),
        ViralAction(
          type: ActionType.inviteToApp,
          label: 'é‚€è¯·TAä¹Ÿç”¨AIè®°è´¦',
          expectedConversion: 0.30,
        ),
      ],
    ),

    // å‘é€AAæé†’æ—¶é™„å¸¦é‚€è¯·
    aaReminderWithInvite: ReminderTemplate(
      title: '{senderName}è¯·ä½ AA{amount}å…ƒ',
      body: '{senderName}é€šè¿‡AIæ™ºèƒ½è®°è´¦å‘èµ·äº†AAè¯·æ±‚',
      callToAction: 'ä¸‹è½½APPï¼Œä¸€é”®ç¡®è®¤',
      deepLink: 'aibook://aa/{billId}',
    ),
  );
}
```

#### 29.4.3 ç¤¾äº¤å¯¹æ¯”ï¼ˆéšç§ä¼˜å…ˆè®¾è®¡ï¼‰

```dart
/// ç¤¾äº¤æ’è¡Œæ¦œæœåŠ¡
class SocialLeaderboardService {
  /// æ’è¡Œæ¦œç±»å‹ï¼ˆéšç§ä¼˜å…ˆè®¾è®¡ï¼‰
  static const leaderboardTypes = [
    // åŒ¿ååŒé¾„äººå¯¹æ¯”
    LeaderboardType(
      id: 'peer_comparison',
      name: 'åŒé¾„äººå¯¹æ¯”',
      description: 'ä¸åŒé¾„ã€åŒåŸç”¨æˆ·åŒ¿åå¯¹æ¯”',
      privacy: PrivacyLevel.anonymous,
      metrics: ['é’±é¾„', 'å‚¨è“„ç‡', 'è®°è´¦åšæŒåº¦'],
    ),

    // å¥½å‹æ’è¡Œï¼ˆéœ€æ˜ç¡®æˆæƒï¼‰
    LeaderboardType(
      id: 'friends_ranking',
      name: 'å¥½å‹æ’è¡Œ',
      description: 'ä¸å¥½å‹å¯¹æ¯”è´¢åŠ¡å¥åº·åº¦',
      privacy: PrivacyLevel.optIn,
      metrics: ['é’±é¾„ç­‰çº§', 'è®°è´¦å¤©æ•°', 'ç›®æ ‡å®Œæˆæ•°'],
    ),

    // å®¶åº­å†…éƒ¨æ’è¡Œ
    LeaderboardType(
      id: 'family_ranking',
      name: 'å®¶åº­æˆå‘˜æ’è¡Œ',
      description: 'å®¶åº­æˆå‘˜é—´çš„è‰¯æ€§ç«äº‰',
      privacy: PrivacyLevel.familyOnly,
      metrics: ['æœ¬æœˆèŠ‚çœ', 'é¢„ç®—è¾¾æˆç‡', 'è®°è´¦ç§¯ææ€§'],
    ),
  ];

  /// ç”Ÿæˆå¯¹æ¯”ç»“æœï¼ˆç”¨äºåˆ†äº«ï¼‰
  Future<ComparisonResult> generateComparison(String userId) async {
    final userStats = await _getUserStats(userId);
    final peerStats = await _getPeerAverageStats(userId);

    // ã€ä¼™ä¼´åŒ–è®¾è®¡ã€‘ä½¿ç”¨æ¸©å’Œçš„æ­£å‘è¡¨è¿°ï¼Œé¿å…ç‚«è€€æˆ–ç„¦è™‘
    // å‚è€ƒç¬¬4ç« 4.6.1èŠ‚"ä¸å¯¹æ¯”ç”¨æˆ·ä¸ä»–äººçš„æ¶ˆè´¹"åŸåˆ™
    final percentile = _calculatePercentile(userStats.moneyAge, peerStats.moneyAgeDistribution);

    // æ ¹æ®ç”¨æˆ·è¡¨ç°ç”Ÿæˆæ¸©å’Œçš„é¼“åŠ±è¯­
    // ã€æ— éšœç¢è®¾è®¡ã€‘åŒæ—¶ä½¿ç”¨å›¾æ ‡+æ–‡å­—+é¢œè‰²ï¼Œä¸ä»…ä¾èµ–é¢œè‰²ä¼ è¾¾ä¿¡æ¯
    String message;
    String statusIcon;  // æ— éšœç¢ï¼šå›¾æ ‡è¾…åŠ©
    String statusLabel; // æ— éšœç¢ï¼šæ–‡å­—çŠ¶æ€æ ‡ç­¾
    if (percentile >= 80) {
      message = 'ä½ çš„è´¢åŠ¡ä¹ æƒ¯å¾ˆå¥åº·ï¼Œç»§ç»­ä¿æŒï¼âœ¨';
      statusIcon = 'ğŸŒŸ';
      statusLabel = 'ä¼˜ç§€';
    } else if (percentile >= 50) {
      message = 'è´¢åŠ¡ç®¡ç†ç¨³æ­¥æå‡ä¸­ï¼ŒåŠ æ²¹ï¼ğŸ’ª';
      statusIcon = 'ğŸ“ˆ';
      statusLabel = 'è‰¯å¥½';
    } else {
      // å¯¹äºä½äºå¹³å‡çš„ç”¨æˆ·ï¼Œå®Œå…¨ä¸æåŠå¯¹æ¯”ï¼Œåªé¼“åŠ±
      message = 'æ¯ä¸€æ­¥éƒ½æ˜¯è¿›æ­¥ï¼Œæˆ‘ä»¬ä¸€èµ·åŠªåŠ›ï¼ğŸŒ±';
      statusIcon = 'ğŸŒ±';
      statusLabel = 'æˆé•¿ä¸­';
    }

    return ComparisonResult(
      highlights: [
        ComparisonItem(
          metric: 'é’±é¾„',
          userValue: '${userStats.moneyAge}å¤©',
          peerAverage: '${peerStats.avgMoneyAge}å¤©',
          percentile: percentile,
          message: message,  // ä½¿ç”¨æ¸©å’Œçš„é¼“åŠ±è¯­
        ),
      ],
      shareCard: await _generateComparisonCard(userStats, peerStats),
    );
  }
}
```

### 29.5 è½åœ°é¡µä¸è½¬åŒ–ä¼˜åŒ–

#### 29.5.1 è½åœ°é¡µè®¾è®¡

```dart
/// è½åœ°é¡µæœåŠ¡
class LandingPageService {
  /// è½åœ°é¡µå˜ä½“ï¼ˆç”¨äºA/Bæµ‹è¯•ï¼‰
  static const landingPageVariants = [
    // å˜ä½“Aï¼šé’±é¾„æ¦‚å¿µä¸»æ‰“
    LandingPageVariant(
      id: 'money_age_focus',
      headline: 'ä½ çš„é’±èƒ½"æ´»"å¤šä¹…ï¼Ÿ',
      subheadline: 'é’±é¾„åˆ†æï¼Œè®©æ¯åˆ†é’±æ›´æœ‰ä»·å€¼',
      features: ['é’±é¾„åˆ†æ', 'æ™ºèƒ½è®°è´¦', 'é›¶åŸºé¢„ç®—'],
      cta: 'æµ‹æµ‹æˆ‘çš„é’±é¾„',
      targetAudience: 'ynab_seekers',
    ),

    // å˜ä½“Bï¼šä¾¿æ·æ€§ä¸»æ‰“
    LandingPageVariant(
      id: 'convenience_focus',
      headline: '3ç§’è®°è´¦ï¼Œå‘Šåˆ«æœˆå…‰',
      subheadline: 'è¯­éŸ³ã€æ‹ç…§ï¼Œæ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥',
      features: ['è¯­éŸ³è®°è´¦', 'æ‹ç…§è®°è´¦', 'æ™ºèƒ½åˆ†ç±»'],
      cta: 'ç«‹å³ä¸‹è½½',
      targetAudience: 'convenience_seekers',
    ),

    // å˜ä½“Cï¼šå®¶åº­åœºæ™¯ä¸»æ‰“
    LandingPageVariant(
      id: 'family_focus',
      headline: 'å…¨å®¶ä¸€èµ·ç®¡é’±ï¼Œæ›´é€æ˜æ›´é«˜æ•ˆ',
      subheadline: 'å®¶åº­è´¦æœ¬ï¼Œå…±åŒç†è´¢',
      features: ['å®¶åº­è´¦æœ¬', 'æˆå‘˜ç®¡ç†', 'AAåˆ†è´¦'],
      cta: 'åˆ›å»ºå®¶åº­è´¦æœ¬',
      targetAudience: 'family_users',
    ),
  ];

  /// æ ¹æ®æ¥æºæ¸ é“é€‰æ‹©æœ€ä½³è½åœ°é¡µ
  LandingPageVariant selectVariant(TrafficSource source) {
    switch (source.channel) {
      case 'ynab_content':
      case 'budget_keywords':
        return landingPageVariants.firstWhere((v) => v.id == 'money_age_focus');
      case 'family_content':
      case 'couple_content':
        return landingPageVariants.firstWhere((v) => v.id == 'family_focus');
      default:
        return landingPageVariants.firstWhere((v) => v.id == 'convenience_focus');
    }
  }
}
```

#### 29.5.2 æ·±åº¦é“¾æ¥ä¸å½’å› 

```dart
/// æ·±åº¦é“¾æ¥ä¸å½’å› æœåŠ¡
class DeepLinkAttributionService {
  /// æ·±åº¦é“¾æ¥ç”Ÿæˆ
  Future<DeepLink> generateDeepLink(DeepLinkParams params) async {
    return DeepLink(
      url: 'https://aibook.app/go/${params.shortCode}',
      fallbackUrl: _getAppStoreUrl(params.platform),
      parameters: {
        'source': params.source,
        'campaign': params.campaign,
        'content': params.content,
        'referrer': params.referrerId,
      },
    );
  }

  /// å½’å› è¿½è¸ª
  Future<void> trackAttribution(String userId, InstallContext context) async {
    final attribution = Attribution(
      userId: userId,
      source: context.source,
      campaign: context.campaign,
      referrer: context.referrerId,
      installTime: DateTime.now(),
    );

    await _saveAttribution(attribution);

    // å¦‚æœæœ‰æ¨èäººï¼Œè§¦å‘æ¨èå¥–åŠ±
    if (context.referrerId != null) {
      await _processReferral(context.referrerId!, userId);
    }
  }

  /// è·å–æ¸ é“CAC
  Future<Map<String, double>> calculateChannelCAC(DateRange period) async {
    final costs = await _getChannelCosts(period);
    final installs = await _getChannelInstalls(period);

    return Map.fromEntries(
      costs.keys.map((channel) => MapEntry(
        channel,
        costs[channel]! / (installs[channel] ?? 1),
      )),
    );
  }
}
```

### 29.5.1 æ— éšœç¢è®¾è®¡é›†æˆ

> ğŸ“ **å‚è€ƒç« èŠ‚**ï¼šæ— éšœç¢è®¾è®¡è§„èŒƒè¯¦è§[ç¬¬5ç«  æ— éšœç¢è®¾è®¡](#5-æ— éšœç¢è®¾è®¡)

ä½æˆæœ¬è·å®¢ç³»ç»Ÿçš„æ— éšœç¢å®ç°è¦ç‚¹ï¼š

| ç»„ä»¶ | æ— éšœç¢è¦æ±‚ | å®ç°æ–¹å¼ |
|------|-----------|---------|
| è£‚å˜æŒ‰é’® | è§¦æ§ç›®æ ‡â‰¥48px | `ViralActionAccessibility` |
| åˆ†äº«å¼•å¯¼ | è¯­ä¹‰åŒ–æ ‡ç­¾ | `semanticLabel` + `hint` |
| æ’è¡Œæ¦œ | ä¸ä¾èµ–é¢œè‰² | å›¾æ ‡+æ–‡å­—+é¢œè‰²ç»„åˆ |
| é‚€è¯·å¡ç‰‡ | æ›¿ä»£æ–‡æœ¬ | `accessibilityDescription` |
| è½åœ°é¡µ | é”®ç›˜å¯¼èˆª | ç„¦ç‚¹é¡ºåºåˆç† |

```dart
/// ã€æ— éšœç¢ã€‘è£‚å˜ç³»ç»Ÿæ— éšœç¢é…ç½®
class ViralAccessibilityConfig {
  /// è£‚å˜æŒ‰é’®æ— éšœç¢å±æ€§
  static Widget wrapViralButton({
    required Widget child,
    required String semanticLabel,
    required VoidCallback onPressed,
  }) {
    return Semantics(
      button: true,
      label: semanticLabel,
      child: TouchTargetService.ensureMinTouchTarget(
        child: child,
        onTap: onPressed,
      ),
    );
  }

  /// æ’è¡Œæ¦œé¡¹ç›®è¯­ä¹‰åŒ–ï¼ˆä¸ä¾èµ–é¢œè‰²ï¼‰
  static String getRankingItemSemantics({
    required int rank,
    required String metric,
    required String value,
    required bool isAboveAverage,
  }) {
    final status = isAboveAverage ? 'é«˜äºå¹³å‡' : 'ç»§ç»­åŠªåŠ›';
    return 'ç¬¬$rankåï¼Œ$metricï¼š$valueï¼Œ$status';
  }
}

/// ã€æ— éšœç¢ã€‘è£‚å˜æŒ‰é’®æ— éšœç¢é…ç½®ç±»
class ViralActionAccessibility {
  final String semanticLabel;
  final double minTouchTarget;
  final String? hint;

  const ViralActionAccessibility({
    required this.semanticLabel,
    this.minTouchTarget = 48.0,
    this.hint,
  });
}
```

### 29.6 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// è·å®¢æˆæœ¬ç›®æ ‡æ£€æµ‹æœåŠ¡
class CacGoalDetector {
  /// CACç›¸å…³ç›®æ ‡
  static const cacGoals = CacGoalCriteria(
    // æ€»ä½“CACç›®æ ‡
    overallCac: CacTarget(
      target: 30.0,  // <=30å…ƒ/ç”¨æˆ·
      measurement: 'æ€»è·å®¢æˆæœ¬/æ€»æ–°å¢ç”¨æˆ·',
    ),

    // è‡ªç„¶æµé‡å æ¯”
    organicRate: RateTarget(
      target: 0.40,  // 40%æ¥è‡ªè‡ªç„¶æµé‡
      measurement: 'è‡ªç„¶æµé‡æ–°å¢/æ€»æ–°å¢',
    ),

    // å£ç¢‘è£‚å˜å æ¯”
    referralRate: RateTarget(
      target: 0.25,  // 25%æ¥è‡ªå£ç¢‘è£‚å˜
      measurement: 'æ¨èæ–°å¢/æ€»æ–°å¢',
    ),

    // ç—…æ¯’ç³»æ•°
    viralCoefficient: ViralTarget(
      target: 0.5,  // K>=0.5
      measurement: 'é‚€è¯·å‘é€ç‡*å¹³å‡é‚€è¯·æ•°*è½¬åŒ–ç‡',
    ),

    // åˆ†äº«ç‡
    shareRate: RateTarget(
      target: 0.20,  // 20%ç”¨æˆ·æœ‰åˆ†äº«è¡Œä¸º
      measurement: 'æœ‰åˆ†äº«è¡Œä¸ºçš„æ´»è·ƒç”¨æˆ·/æ€»æ´»è·ƒç”¨æˆ·',
    ),

    // åº”ç”¨å•†åº—è¯„åˆ†
    appRating: RatingTarget(
      target: 4.5,  // >=4.5æ˜Ÿ
      measurement: 'åº”ç”¨å•†åº—å¹³å‡è¯„åˆ†',
    ),
  );

  /// æ£€æµ‹ç›®æ ‡è¾¾æˆçŠ¶æ€
  Future<CacGoalStatus> checkGoalStatus(DateRange period) async {
    final status = CacGoalStatus();

    // è®¡ç®—å½“å‰CAC
    final totalCost = await _getTotalAcquisitionCost(period);
    final totalInstalls = await _getTotalInstalls(period);
    final currentCac = totalCost / totalInstalls;
    status.overallCac = GoalCheckResult(
      current: currentCac,
      target: cacGoals.overallCac.target,
      achieved: currentCac <= cacGoals.overallCac.target,
    );

    // è®¡ç®—è‡ªç„¶æµé‡å æ¯”
    final organicInstalls = await _getOrganicInstalls(period);
    final organicRate = organicInstalls / totalInstalls;
    status.organicRate = GoalCheckResult(
      current: organicRate,
      target: cacGoals.organicRate.target,
      achieved: organicRate >= cacGoals.organicRate.target,
    );

    // è®¡ç®—ç—…æ¯’ç³»æ•°
    final viralCoefficient = await _calculateViralCoefficient(period);
    status.viralCoefficient = GoalCheckResult(
      current: viralCoefficient,
      target: cacGoals.viralCoefficient.target,
      achieved: viralCoefficient >= cacGoals.viralCoefficient.target,
    );

    return status;
  }

  /// ç”ŸæˆCACä¼˜åŒ–å»ºè®®
  Future<List<CacOptimization>> generateOptimizationSuggestions(CacGoalStatus status) async {
    final suggestions = <CacOptimization>[];

    if (!status.overallCac.achieved) {
      if (!status.organicRate.achieved) {
        suggestions.add(CacOptimization(
          area: 'è‡ªç„¶æµé‡',
          priority: Priority.high,
          suggestions: [
            'ä¼˜åŒ–åº”ç”¨å•†åº—å…³é”®è¯ï¼Œæå‡ASOæ’å',
            'å¢åŠ é’±é¾„ç­‰å·®å¼‚åŒ–å…³é”®è¯çš„è¦†ç›–',
            'æå‡åº”ç”¨å•†åº—è¯„åˆ†å’Œè¯„è®ºæ•°é‡',
          ],
          expectedImpact: 'æå‡10%è‡ªç„¶æµé‡å¯é™ä½CACçº¦4å…ƒ',
        ));
      }

      if (!status.viralCoefficient.achieved) {
        suggestions.add(CacOptimization(
          area: 'ç—…æ¯’ä¼ æ’­',
          priority: Priority.high,
          suggestions: [
            'ä¼˜åŒ–åˆ†äº«å¡ç‰‡è®¾è®¡ï¼Œæå‡åˆ†äº«æ„æ„¿',
            'å¢åŠ å¯åˆ†äº«å†…å®¹ç±»å‹ï¼ˆå¹´åº¦æŠ¥å‘Šã€ç†è´¢äººæ ¼ï¼‰',
            'ä¼˜åŒ–é‚€è¯·å¥–åŠ±æœºåˆ¶ï¼Œæå‡è½¬åŒ–ç‡',
          ],
          expectedImpact: 'Kå€¼æ¯æå‡0.1å¯é™ä½CACçº¦5å…ƒ',
        ));
      }
    }

    return suggestions;
  }
}
```

