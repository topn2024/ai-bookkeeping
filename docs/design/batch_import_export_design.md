# 批量账单导入导出功能设计方案

## 一、功能概述

### 1.1 核心需求
- **批量导入**：支持上传微信账单、支付宝账单、银行流水等表格文件，自动识别格式并提取账目数据
- **智能去重**：基于多维度特征匹配+语义相似度分析，识别已录入的账目，防止重复导入
- **批量操作**：支持批量确认、批量跳过、批量修改分类等操作
- **数据导出**：支持将手机中的账目明细导出为多种通用格式

### 1.2 功能入口位置

```
设置页面
├── 数据管理（新增分组）
│   ├── 📥 导入账单（新功能，替代原有简单导入）
│   │   ├── 智能导入（微信/支付宝/银行）
│   │   └── 通用表格导入
│   ├── 📤 导出账单（增强原有导出）
│   │   ├── 导出为CSV
│   │   ├── 导出为Excel
│   │   └── 导出为PDF
│   └── 🔄 备份与恢复（原有功能）
```

---

## 二、支持的文件格式

### 2.1 文件格式支持矩阵

| 格式 | 扩展名 | 编码 | 说明 |
|-----|-------|------|------|
| CSV | .csv | UTF-8/GBK/GB2312 | 通用逗号分隔值 |
| Excel | .xlsx, .xls | - | Microsoft Excel 格式 |
| OFX | .ofx | UTF-8 | 开放金融交换格式（银行常用） |
| QIF | .qif | ASCII | Quicken 交换格式 |
| TSV | .tsv | UTF-8 | 制表符分隔值 |
| JSON | .json | UTF-8 | 部分银行API导出格式 |

### 2.2 账单来源与格式

#### 微信支付账单
- **获取方式**：微信 → 我 → 服务 → 钱包 → 账单 → 常见问题 → 下载账单
- **文件格式**：CSV（UTF-8 + BOM）
- **表头结构**：
```
微信支付账单明细
微信昵称：[xxx]
起始时间：[2024-01-01 00:00:00] 终止时间：[2024-01-31 23:59:59]
----------------------微信支付账单明细列表--------------------
交易时间,交易类型,交易对方,商品,收/支,金额(元),支付方式,当前状态,交易单号,商户单号,备注
```

#### 支付宝账单
- **获取方式**：支付宝 → 我的 → 账单 → 右上角"..." → 开具交易流水证明
- **文件格式**：CSV（GBK编码）
- **表头结构**：
```
支付宝交易记录明细查询
账号:[xxx@xxx.com]
起始日期:[2024-01-01 00:00:00]    终止日期:[2024-01-31 23:59:59]
--------------------------------交易记录明细列表--------------------------------
交易创建时间,付款时间,最近修改时间,交易来源地,类型,交易对方,商品名称,金额（元）,收/支,交易状态,...
```

#### 银行流水（Excel/OFX）
- **招商银行**：支持导出 Excel 和 OFX
- **工商银行**：支持导出 Excel
- **其他银行**：多数支持 Excel 或 PDF（PDF暂不支持）

---

## 三、智能去重方案

### 3.1 去重策略架构

```
┌─────────────────────────────────────────────────────────────┐
│                     第一层：精确匹配                          │
│         通过外部交易号 (externalId) 精确识别同一笔交易         │
│                    匹配 → 100分（确定重复）                   │
└─────────────────────────────────────────────────────────────┘
                              ↓ 未匹配
┌─────────────────────────────────────────────────────────────┐
│                     第二层：特征匹配                          │
│    日期 + 金额 + 类型 + 分类 + 语义相似度 → 综合评分           │
│                  评分范围：0-95分                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     去重决策                                  │
│   ≥85分：高度重复  |  60-84分：疑似重复  |  <60分：新交易      │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 特征匹配评分算法

```dart
class DuplicateScorer {
  /// 计算两笔交易的重复可能性评分 (0-100)
  Future<DuplicateScore> calculate(
    Transaction existing,
    ImportCandidate candidate,
  ) async {
    // ===== 第一层：精确匹配 =====
    if (existing.externalId != null &&
        existing.externalId == candidate.externalId &&
        existing.externalSource == candidate.externalSource) {
      return DuplicateScore(
        score: 100,
        level: DuplicateLevel.exact,
        reason: '交易单号完全匹配',
      );
    }

    // ===== 第二层：特征匹配 =====
    int score = 0;
    final reasons = <String>[];

    // 1. 日期匹配（必要条件）
    final daysDiff = existing.date.difference(candidate.date).inDays.abs();
    if (daysDiff > 1) {
      return DuplicateScore(score: 0, level: DuplicateLevel.none);
    }

    // 2. 金额匹配（30分）- 必要条件
    final amountMatch = (existing.amount - candidate.amount).abs() < 0.01;
    if (!amountMatch) {
      return DuplicateScore(score: 0, level: DuplicateLevel.none);
    }
    score += 30;
    reasons.add('金额相同');

    // 3. 交易类型匹配（10分）
    if (existing.type == candidate.type) {
      score += 10;
      reasons.add('类型相同');
    }

    // 4. 分类匹配（15分）
    if (existing.category == candidate.category) {
      score += 15;
      reasons.add('分类相同');
    } else if (_isSameParentCategory(existing.category, candidate.category)) {
      score += 8;
      reasons.add('同属一级分类');
    }

    // 5. 时间接近度（20分）
    final minutesDiff = existing.date.difference(candidate.date).inMinutes.abs();
    if (minutesDiff <= 5) {
      score += 20;
      reasons.add('时间高度接近(≤5分钟)');
    } else if (minutesDiff <= 30) {
      score += 15;
      reasons.add('时间接近(≤30分钟)');
    } else if (minutesDiff <= 120) {
      score += 8;
      reasons.add('时间较近(≤2小时)');
    }

    // 6. 语义相似度（20分）- 调用AI分析
    final semanticScore = await _calculateSemanticSimilarity(
      existing.note ?? '',
      candidate.note ?? '',
      existing.merchant,
      candidate.rawMerchant,
    );
    score += (semanticScore * 20).round();
    if (semanticScore > 0.7) {
      reasons.add('备注语义高度相似');
    } else if (semanticScore > 0.4) {
      reasons.add('备注语义相似');
    }

    // 7. 账户匹配（5分）
    if (existing.accountId == candidate.accountId) {
      score += 5;
      reasons.add('账户相同');
    }

    return DuplicateScore(
      score: score,
      level: _getLevel(score),
      reason: reasons.join('、'),
      matchedTransaction: existing,
    );
  }

  /// 语义相似度计算（调用AI）
  Future<double> _calculateSemanticSimilarity(
    String note1,
    String note2,
    String? merchant1,
    String? merchant2,
  ) async {
    // 组合文本
    final text1 = [note1, merchant1].whereType<String>().join(' ');
    final text2 = [note2, merchant2].whereType<String>().join(' ');

    if (text1.isEmpty && text2.isEmpty) return 0.5;
    if (text1.isEmpty || text2.isEmpty) return 0.0;

    // 调用千问API计算语义相似度
    final prompt = '''
判断以下两段消费描述是否指向同一笔交易，返回相似度(0-1):
描述1: $text1
描述2: $text2

只返回一个0到1之间的数字，不要其他内容。
相同商户不同商品=0.3，相同商户相同商品=0.9，完全不相关=0
''';

    try {
      final result = await _qwenService.chat(prompt);
      return double.tryParse(result.trim()) ?? 0.0;
    } catch (e) {
      // 降级：使用简单的关键词匹配
      return _fallbackSimilarity(text1, text2);
    }
  }

  /// 降级的相似度计算（无需API）
  double _fallbackSimilarity(String text1, String text2) {
    final words1 = _tokenize(text1);
    final words2 = _tokenize(text2);
    if (words1.isEmpty || words2.isEmpty) return 0.0;

    final intersection = words1.intersection(words2);
    final union = words1.union(words2);
    return intersection.length / union.length; // Jaccard相似度
  }

  DuplicateLevel _getLevel(int score) {
    if (score >= 85) return DuplicateLevel.high;
    if (score >= 60) return DuplicateLevel.medium;
    if (score >= 40) return DuplicateLevel.low;
    return DuplicateLevel.none;
  }
}

enum DuplicateLevel {
  exact,   // 100分，确定重复
  high,    // 85-99分，高度疑似
  medium,  // 60-84分，可能重复
  low,     // 40-59分，轻微相似
  none,    // <40分，新交易
}
```

### 3.3 去重结果处理

| 评分 | 级别 | 默认处理 | 用户操作 |
|-----|------|---------|---------|
| 100 | 确定重复 | 自动跳过 | 可强制导入 |
| 85-99 | 高度疑似 | 默认跳过 | 可选择导入 |
| 60-84 | 可能重复 | 提示确认 | 可批量处理 |
| 40-59 | 轻微相似 | 默认导入 | 可选择跳过 |
| <40 | 新交易 | 自动导入 | 可选择跳过 |

---

## 四、交互界面设计

### 4.1 导入主页面

```
┌─────────────────────────────────────────────────────────────┐
│ ←  导入账单                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                                                     │   │
│   │         ┌──────────────────────┐                   │   │
│   │         │   📄                 │                   │   │
│   │         │   ───────            │                   │   │
│   │         │   ───────            │                   │   │
│   │         │   ───────            │                   │   │
│   │         └──────────────────────┘                   │   │
│   │                                                     │   │
│   │         点击选择文件或拖放到这里                      │   │
│   │                                                     │   │
│   │    支持格式：CSV、Excel、OFX、QIF、TSV、JSON         │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ─────────────── 支持的账单类型 ────────────────           │
│                                                             │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│   │  微信   │  │  支付宝  │  │  银行   │  │  通用   │       │
│   │  💬    │  │  🔷    │  │  🏦    │  │  📊    │       │
│   │  支付   │  │         │  │  流水   │  │  表格   │       │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘       │
│                                                             │
│   ─────────────── 最近导入记录 ────────────────             │
│                                                             │
│   📋 微信账单_2024年1月.csv     156笔    01-15 10:30       │
│   📋 招商银行流水.xlsx          89笔     01-10 14:20       │
│   📋 支付宝账单.csv            203笔    01-05 09:15       │
│                                                             │
│                    [查看全部导入历史]                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 格式识别与解析页面

```
┌─────────────────────────────────────────────────────────────┐
│ ←  解析账单                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   📄 微信账单_2024年1月.csv                                  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  ✅ 识别成功                                         │   │
│   │                                                     │   │
│   │  账单类型：微信支付账单                               │   │
│   │  账单周期：2024-01-01 至 2024-01-31                  │   │
│   │  交易笔数：156 笔                                    │   │
│   │  文件编码：UTF-8                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  📊 解析预览                                         │   │
│   ├─────────────────────────────────────────────────────┤   │
│   │  日期         商户          金额      类型           │   │
│   ├─────────────────────────────────────────────────────┤   │
│   │  01-15 12:30  星巴克        -35.00    支出           │   │
│   │  01-15 14:20  美团外卖      -28.50    支出           │   │
│   │  01-15 18:00  滴滴出行      -23.00    支出           │   │
│   │  01-16 09:00  工资          +8500.00  收入           │   │
│   │  ...显示前5条...                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ⏳ 正在进行智能分类和去重检测...                           │
│   ████████████████░░░░░░░░░░░░░░░░░░  45%                  │
│                                                             │
│               [取消]            [下一步]                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 去重检测结果页面

```
┌─────────────────────────────────────────────────────────────┐
│ ←  检测结果                                        [导入]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📊 检测摘要                                          │  │
│  │                                                       │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │  │
│  │  │   142   │ │   8     │ │   4     │ │   2     │     │  │
│  │  │  新交易  │ │ 可能重复 │ │ 高度疑似 │ │ 确定重复 │     │  │
│  │  │   ✅    │ │   ⚠️    │ │   🔴    │ │   ⛔    │     │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘     │  │
│  │                                                       │  │
│  │  总计 156 笔 | 预计导入 150 笔 | 跳过 6 笔             │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ [全部] [新交易 142] [可能重复 8] [高度疑似 4] [确定重复 2]│  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  批量操作:  [全选本页] [跳过所有重复] [导入所有]        │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ ☑️  01-15 12:30   星巴克                    -¥35.00   │  │
│  │     拿铁咖啡                                   餐饮    │  │
│  │     🆕 新交易                                 [编辑]   │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │ ☑️  01-15 14:20   美团外卖                   -¥28.50   │  │
│  │     午餐便当                                   餐饮    │  │
│  │     ⚠️ 可能重复 (相似度 72%)                  [编辑]   │  │
│  │     ┌─────────────────────────────────────────────┐   │  │
│  │     │ 匹配到已有交易:                             │   │  │
│  │     │ 01-15 14:18  美团  ¥28.50  [语音录入]      │   │  │
│  │     │ 匹配原因: 金额相同、时间接近、备注语义相似   │   │  │
│  │     │                                             │   │  │
│  │     │   [跳过]  [仍然导入]  [查看对比]            │   │  │
│  │     └─────────────────────────────────────────────┘   │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │ ☐  01-15 15:30   瑞幸咖啡                    -¥18.00   │  │
│  │     生椰拿铁                                   餐饮    │  │
│  │     🔴 高度疑似 (相似度 89%)                  [编辑]   │  │
│  │     ┌─────────────────────────────────────────────┐   │  │
│  │     │ 匹配到已有交易:                             │   │  │
│  │     │ 01-15 15:28  瑞幸  ¥18.00  [图片识别]      │   │  │
│  │     │ 匹配原因: 金额相同、时间高度接近、分类相同、 │   │  │
│  │     │         备注语义高度相似                    │   │  │
│  │     │                                             │   │  │
│  │     │   [跳过]  [仍然导入]  [查看对比]            │   │  │
│  │     └─────────────────────────────────────────────┘   │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │ ━  01-15 18:00   滴滴出行                    -¥23.00   │  │
│  │     快车                                       交通    │  │
│  │     ⛔ 确定重复 (交易单号匹配)                         │  │
│  │     已自动跳过，点击可强制导入                         │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  [上一页]  1 / 16  [下一页]                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 交易对比弹窗

```
┌─────────────────────────────────────────────────────────────┐
│                     交易对比                           [×]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐    ┌─────────────────────┐        │
│  │    📥 待导入交易     │    │    📋 已有交易       │        │
│  ├─────────────────────┤    ├─────────────────────┤        │
│  │                     │    │                     │        │
│  │ 日期: 01-15 14:20   │ ≈  │ 日期: 01-15 14:18   │        │
│  │ 金额: ¥28.50        │ =  │ 金额: ¥28.50        │        │
│  │ 类型: 支出          │ =  │ 类型: 支出          │        │
│  │ 分类: 餐饮          │ =  │ 分类: 餐饮          │        │
│  │ 商户: 美团外卖      │ ≈  │ 商户: 美团          │        │
│  │ 备注: 午餐便当      │ ≈  │ 备注: 午餐          │        │
│  │                     │    │                     │        │
│  │ 来源: 微信账单导入  │    │ 来源: 🎤 语音录入   │        │
│  │ 交易号: 420000xxx   │    │ 交易号: -           │        │
│  │                     │    │                     │        │
│  └─────────────────────┘    └─────────────────────┘        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🔍 相似度分析                                       │   │
│  │                                                     │   │
│  │  总评分: 72分 (可能重复)                             │   │
│  │                                                     │   │
│  │  ├─ 金额匹配      ████████████████████ 30/30       │   │
│  │  ├─ 类型匹配      ████████████████████ 10/10       │   │
│  │  ├─ 分类匹配      ████████████████████ 15/15       │   │
│  │  ├─ 时间接近      ██████████████░░░░░░ 15/20       │   │
│  │  ├─ 语义相似      ██████░░░░░░░░░░░░░░  2/20       │   │
│  │  └─ 账户匹配      ░░░░░░░░░░░░░░░░░░░░  0/5        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│           [跳过此条]              [确认导入]                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.5 批量操作面板

```
┌─────────────────────────────────────────────────────────────┐
│                     批量操作                           [×]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  已选择 14 笔交易                                           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  导入/跳过                                           │   │
│  │  ○ 全部导入                                         │   │
│  │  ○ 全部跳过                                         │   │
│  │  ● 智能处理（跳过高度疑似，导入其他）                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  批量修改分类                                        │   │
│  │  ┌─────────────────────────────────┐                │   │
│  │  │ 选择分类...                   ▼ │                │   │
│  │  └─────────────────────────────────┘                │   │
│  │  ☐ 同时应用到相同商户的其他交易                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  批量修改账户                                        │   │
│  │  ┌─────────────────────────────────┐                │   │
│  │  │ 选择账户...                   ▼ │                │   │
│  │  └─────────────────────────────────┘                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│              [取消]                [应用]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.6 编辑单条交易

```
┌─────────────────────────────────────────────────────────────┐
│                     编辑交易                           [×]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  日期                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2024-01-15 14:20                               📅   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  金额                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ¥ 28.50                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  类型                                                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │  ● 支出    │  │  ○ 收入    │  │  ○ 转账    │            │
│  └────────────┘  └────────────┘  └────────────┘            │
│                                                             │
│  分类                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🍜 餐饮 > 午餐                                    ▼  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  账户                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 💳 微信零钱                                      ▼  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  备注                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 午餐便当                                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│              [取消]                [保存]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.7 导入结果页面

```
┌─────────────────────────────────────────────────────────────┐
│                     导入完成                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                        ✅                                   │
│                                                             │
│                   导入成功！                                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │     成功导入        跳过重复        导入失败         │   │
│  │                                                     │   │
│  │       142            12              2              │   │
│  │        笔             笔              笔             │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📊 导入统计                                         │   │
│  │                                                     │   │
│  │  支出总额：¥ 3,256.80                               │   │
│  │  收入总额：¥ 8,500.00                               │   │
│  │  净收入：  ¥ 5,243.20                               │   │
│  │                                                     │   │
│  │  日期范围：2024-01-01 至 2024-01-31                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ⚠️ 2笔导入失败                            [查看]   │   │
│  │  数据格式异常，已记录详情                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  批次ID: IMP20240115103045                                  │
│  如需撤销，可在导入历史中操作                               │
│                                                             │
│        [查看导入历史]            [返回首页]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.8 导入历史页面

```
┌─────────────────────────────────────────────────────────────┐
│ ←  导入历史                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📋 微信账单_2024年1月.csv                            │  │
│  │  导入时间：2024-01-15 10:30:45                        │  │
│  │  批次ID：IMP20240115103045                            │  │
│  │                                                       │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                 │  │
│  │  │   142   │ │   12    │ │   2     │                 │  │
│  │  │  已导入  │ │  已跳过  │ │   失败  │                 │  │
│  │  └─────────┘ └─────────┘ └─────────┘                 │  │
│  │                                                       │  │
│  │  状态：✅ 有效                                        │  │
│  │                                                       │  │
│  │        [查看详情]              [撤销导入]             │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  📋 招商银行流水.xlsx                                 │  │
│  │  导入时间：2024-01-10 14:20:30                        │  │
│  │  批次ID：IMP20240110142030                            │  │
│  │                                                       │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                 │  │
│  │  │   89    │ │   5     │ │   0     │                 │  │
│  │  │  已导入  │ │  已跳过  │ │   失败  │                 │  │
│  │  └─────────┘ └─────────┘ └─────────┘                 │  │
│  │                                                       │  │
│  │  状态：⚪ 已撤销 (2024-01-11 09:00)                   │  │
│  │                                                       │  │
│  │        [查看详情]              [重新导入]             │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.9 导出页面

```
┌─────────────────────────────────────────────────────────────┐
│ ←  导出账单                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📅 时间范围                                                 │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ 2024-01-01      📅  │至│ 2024-01-31      📅  │          │
│  └─────────────────────┘  └─────────────────────┘          │
│                                                             │
│  [本周] [本月] [上月] [近三月] [今年] [全部]                  │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📊 筛选条件                                                 │
│                                                             │
│  交易类型                                                    │
│  ┌────────┐ ┌────────┐ ┌────────┐                          │
│  │ ☑️ 支出 │ │ ☑️ 收入 │ │ ☐ 转账 │                          │
│  └────────┘ └────────┘ └────────┘                          │
│                                                             │
│  分类筛选                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 全部分类                                         ▼  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  账户筛选                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 全部账户                                         ▼  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📄 导出格式                                                 │
│  ┌──────────────────┐                                      │
│  │ ○ CSV (通用表格)  │  适合导入其他记账软件                 │
│  ├──────────────────┤                                      │
│  │ ● Excel (.xlsx)  │  带格式，支持多Sheet，适合分析        │
│  ├──────────────────┤                                      │
│  │ ○ PDF 报表       │  带图表，适合打印归档                 │
│  └──────────────────┘                                      │
│                                                             │
│  ⚙️ 导出选项                                                 │
│  ☑️ 包含统计摘要（收支汇总）                                 │
│  ☑️ 包含分类汇总（按类别统计）                               │
│  ☐ 包含趋势图表（仅PDF）                                    │
│  ☐ 包含二级分类明细                                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📋 预览                                                     │
│  共 256 笔交易                                              │
│  支出：¥12,580.00  |  收入：¥8,500.00  |  净额：-¥4,080.00  │
│                                                             │
│          [导出到文件]              [分享]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、数据模型扩展

### 5.1 Transaction 模型新增字段

```dart
class Transaction {
  // ... 现有字段 ...

  /// 外部系统交易ID（用于精确去重）
  /// 微信交易单号、支付宝交易号、银行流水号等
  final String? externalId;

  /// 外部系统来源标识
  /// wechat_pay, alipay, cmb_bank, icbc_bank, manual, etc.
  final String? externalSource;

  /// 导入批次ID（用于批量回滚）
  final String? importBatchId;

  /// 原始商户名（用于AI分类学习）
  final String? rawMerchant;
}
```

### 5.2 导入批次模型

```dart
class ImportBatch {
  final String id;                    // 批次ID: IMP + 时间戳
  final String fileName;              // 原始文件名
  final String fileFormat;            // 文件格式: wechat_pay, alipay, etc.
  final int totalCount;               // 文件中总条数
  final int importedCount;            // 成功导入条数
  final int skippedCount;             // 跳过条数（重复）
  final int failedCount;              // 失败条数
  final double totalExpense;          // 导入的总支出
  final double totalIncome;           // 导入的总收入
  final DateTime? dateRangeStart;     // 交易日期范围开始
  final DateTime? dateRangeEnd;       // 交易日期范围结束
  final DateTime createdAt;           // 导入时间
  final ImportBatchStatus status;     // 状态: active, revoked
  final String? revokedAt;            // 撤销时间
  final String? errorLog;             // 错误日志
}

enum ImportBatchStatus {
  active,   // 有效
  revoked,  // 已撤销
}
```

### 5.3 导入候选项模型

```dart
class ImportCandidate {
  final int index;                    // 在文件中的行号
  final DateTime date;                // 交易日期
  final double amount;                // 金额
  final TransactionType type;         // 类型
  final String? externalId;           // 外部交易号
  final String? rawMerchant;          // 原始商户名
  final String? note;                 // 备注/商品名
  final String? rawPaymentMethod;     // 原始支付方式
  final String? rawStatus;            // 原始交易状态

  // 解析后填充
  String? category;                   // 推断的分类
  String? accountId;                  // 映射的账户
  DuplicateCheckResult? duplicateResult;  // 去重检测结果

  // 用户操作
  ImportAction action;                // 导入/跳过/待定
  bool isEdited;                      // 是否被编辑过
}

enum ImportAction {
  import,   // 导入
  skip,     // 跳过
  pending,  // 待用户确认
}
```

---

## 六、数据库变更

```sql
-- transactions 表新增字段
ALTER TABLE transactions ADD COLUMN externalId TEXT;
ALTER TABLE transactions ADD COLUMN externalSource TEXT;
ALTER TABLE transactions ADD COLUMN importBatchId TEXT;
ALTER TABLE transactions ADD COLUMN rawMerchant TEXT;

-- 创建索引
CREATE INDEX idx_transactions_external ON transactions(externalId, externalSource);
CREATE INDEX idx_transactions_import_batch ON transactions(importBatchId);
CREATE INDEX idx_transactions_dedup ON transactions(date, amount, type, category);

-- 导入批次表
CREATE TABLE import_batches (
  id TEXT PRIMARY KEY,
  fileName TEXT NOT NULL,
  fileFormat TEXT NOT NULL,
  totalCount INTEGER NOT NULL,
  importedCount INTEGER NOT NULL,
  skippedCount INTEGER NOT NULL,
  failedCount INTEGER NOT NULL DEFAULT 0,
  totalExpense REAL DEFAULT 0,
  totalIncome REAL DEFAULT 0,
  dateRangeStart INTEGER,
  dateRangeEnd INTEGER,
  createdAt INTEGER NOT NULL,
  status INTEGER NOT NULL DEFAULT 1,
  revokedAt INTEGER,
  errorLog TEXT
);
```

---

## 七、文件结构

```
app/lib/
├── models/
│   ├── transaction.dart              # 扩展字段
│   ├── import_batch.dart             # 新增
│   └── import_candidate.dart         # 新增
├── services/
│   ├── import/
│   │   ├── bill_format_detector.dart     # 格式检测
│   │   ├── bill_parser.dart              # 解析器基类
│   │   ├── wechat_bill_parser.dart       # 微信
│   │   ├── alipay_bill_parser.dart       # 支付宝
│   │   ├── bank_bill_parser.dart         # 银行通用
│   │   ├── excel_parser.dart             # Excel解析
│   │   ├── ofx_parser.dart               # OFX解析
│   │   └── encoding_handler.dart         # 编码处理
│   ├── duplicate_scorer.dart             # 去重评分（增强）
│   ├── semantic_similarity_service.dart  # 语义相似度
│   ├── batch_import_service.dart         # 批量导入
│   ├── batch_category_service.dart       # 批量分类
│   └── enhanced_export_service.dart      # 增强导出
├── pages/
│   ├── import/
│   │   ├── smart_import_page.dart        # 导入主页
│   │   ├── import_parsing_page.dart      # 解析进度页
│   │   ├── import_preview_page.dart      # 预览确认页
│   │   ├── import_result_page.dart       # 结果页
│   │   └── import_history_page.dart      # 历史页
│   └── export/
│       └── enhanced_export_page.dart     # 增强导出页
└── widgets/
    └── import/
        ├── file_picker_card.dart         # 文件选择
        ├── format_detection_card.dart    # 格式识别卡片
        ├── duplicate_warning_card.dart   # 重复警告
        ├── import_item_tile.dart         # 交易项
        ├── transaction_compare_dialog.dart # 对比弹窗
        ├── batch_action_sheet.dart       # 批量操作
        └── edit_transaction_dialog.dart  # 编辑弹窗
```

---

## 八、开发阶段建议

### 阶段一：核心功能
1. 数据模型扩展和数据库迁移
2. 微信账单CSV解析器
3. 基础去重检测（精确匹配+特征匹配）
4. 导入预览和确认界面
5. 批量导入和回滚功能

### 阶段二：格式扩展
1. 支付宝账单解析器
2. Excel文件解析（xlsx）
3. 银行流水通用解析器
4. 格式自动检测优化

### 阶段三：智能增强
1. 语义相似度服务（接入千问）
2. 批量分类推断优化
3. 商户-分类学习记忆
4. 账户智能映射

### 阶段四：交互完善
1. 批量操作面板
2. 交易对比弹窗
3. 导入历史管理
4. 增强导出（Excel/PDF）
