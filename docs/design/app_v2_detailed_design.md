# AI智能记账 2.0 版本详细设计

> 版本：2.0.0
> 日期：2026-01-01
> 状态：设计阶段

## 目录

- [1. 钱龄智能分析系统](#1-钱龄智能分析系统)
- [2. 零基预算与小金库系统](#2-零基预算与小金库系统)
- [3. 金融习惯培养系统](#3-金融习惯培养系统)
- [4. AI智能识别系统](#4-ai智能识别系统)
- [5. 数据导入导出系统](#5-数据导入导出系统)
- [6. 数据联动与可视化](#6-数据联动与可视化)
- [7. 家庭账本与多成员管理系统](#7-家庭账本与多成员管理系统)
- [8. 技术架构设计](#8-技术架构设计)
- [9. 用户体验设计](#9-用户体验设计)
- [10. 工程保障](#10-工程保障)

> **相关文档**:
> - [AI智能记账 2.0 概要设计](./app_v2_overview_design.md) - 高层次设计概述
> - [AI智能记账 2.0 代码设计](./app_v2_code_design.md) - 代码实现
> - [AI智能记账 2.0 完整设计](./app_v2_design.md) - 原始完整设计文档

---

## 1. 钱龄智能分析系统

### 1.1 FIFO资源池模型

钱龄计算采用FIFO（先进先出）资源池模型，精确追踪每笔支出对应的收入来源。

```
资源池队列（FIFO）
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│Pool #1 │ │Pool #2 │ │Pool #3 │ │Pool #4 │
│1月工资 │ │1月奖金 │ │2月工资 │ │2月兼职 │
│¥8,000  │ │¥2,000  │ │¥8,500  │ │¥1,500  │
│剩余¥0  │ │剩余¥0  │ │剩余¥500│ │剩余¥1.5k│
└────────┘ └────────┘ └────────┘ └────────┘
  ↑已用完    ↑已用完    ↑部分用   ↑当前消费
```

**核心算法特性**：

| 特性 | 说明 | 技术实现 |
|-----|------|---------|
| **FIFO原则** | 先赚的钱先花 | 资源池按时间排序，顺序消费 |
| **增量计算** | 只重算受影响交易 | 交易变更时标记脏数据，定时刷新 |
| **加权平均** | 单笔支出跨多个收入池 | Σ(金额×钱龄) / 总金额 |
| **资源追溯** | 每笔支出可追溯到具体收入 | ResourceConsumption记录消费链路 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块50](app_v2_code_design.md#code-50)

### 1.2 钱龄可视化组件

**可视化设计原则**：

| 原则 | 说明 | 实现方式 |
|-----|------|---------|
| **一眼可见** | 核心数据无需点击即可获取 | 首页钱龄卡片突出显示天数 |
| **颜色编码** | 用色彩传达健康状态 | 6级颜色对应6个健康等级 |
| **渐进披露** | 从概览到详情逐层展开 | 首页卡片→详情页→影响分析 |
| **数据关联** | 钱龄与交易、预算联动展示 | 点击趋势图可下钻到具体交易 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块52-54](app_v2_code_design.md#code-52)

### 1.3 钱龄与其他系统集成

| 触发事件 | 集成动作 | 涉及系统 |
|---------|---------|---------|
| 新增收入 | 创建资源池，更新钱龄统计 | 资源池管理器 |
| 新增支出 | FIFO消费资源池，计算单笔钱龄 | 所有集成系统 |
| 钱龄等级变化 | 触发预警/庆祝，更新成就 | 冲动防护、习惯培养、伙伴化 |
| 周期结算 | 生成钱龄报告，调整预算建议 | 零基预算、消费审视 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块55](app_v2_code_design.md#code-55)

---

## 2. 零基预算与小金库系统

### 2.1 预算分配模型

```
月收入 ¥10,000
    │
    ├─► 必要支出 (50%) ¥5,000
    │     ├─ 房租 ¥2,000
    │     ├─ 水电 ¥300
    │     └─ 通勤 ¥500
    │
    ├─► 生活支出 (30%) ¥3,000
    │     ├─ 餐饮 ¥1,500
    │     └─ 日用品 ¥500
    │
    └─► 储蓄目标 (20%) ¥2,000
          ├─ 应急金 ¥1,000
          └─ 旅行基金 ¥1,000
```

### 2.2 小金库管理

**小金库类型**：

| 类型 | 描述 | 特性 |
|-----|------|-----|
| **固定小金库** | 每月固定金额 | 房租、保险等 |
| **弹性小金库** | 有上限但可调整 | 餐饮、娱乐等 |
| **目标小金库** | 累积型储蓄 | 旅行、购物目标 |
| **应急小金库** | 紧急备用金 | 医疗、意外等 |

**智能调拨规则**：
- 超支时从弹性小金库调拨
- 月末结余可转入目标小金库
- 应急小金库优先保护

> 📄 **代码实现**: 见 [代码设计文档 - 代码块60-65](app_v2_code_design.md#code-60)

---

## 3. 金融习惯培养系统

### 3.1 消费审视模块

**识别模式**：

| 模式 | 检测规则 | 提醒方式 |
|-----|---------|---------|
| **订阅浪费** | 连续3月未使用的订阅 | 月度报告提醒 |
| **拿铁因子** | 小额高频消费累计 | 周度汇总 |
| **冲动消费** | 大额非必要支出 | 实时提醒 |
| **重复购买** | 同类商品短期重复 | 购买时提醒 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块70](app_v2_code_design.md#code-70)

### 3.2 冲动消费防护

**防护机制**：

1. **金额阈值触发**：超过设定金额触发冷静期
2. **24小时冷静期**：延迟确认大额消费
3. **钱龄预警**：低钱龄时加强提醒
4. **预算关联**：超预算时触发二次确认

> 📄 **代码实现**: 见 [代码设计文档 - 代码块71](app_v2_code_design.md#code-71)

### 3.3 习惯养成激励

**成就系统**：

| 成就 | 条件 | 奖励 |
|-----|------|-----|
| 初次记账 | 完成第一笔记账 | 新手徽章 |
| 连续7天 | 连续7天记账 | 坚持徽章 |
| 预算达人 | 连续3月预算内 | 预算徽章 |
| 钱龄提升 | 钱龄提升一个等级 | 理财徽章 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块72](app_v2_code_design.md#code-72)

---

## 4. AI智能识别系统

### 4.1 语音识别流程

```
用户语音输入
    │
    ▼
┌─────────────┐
│ 本地ASR预处理 │ ← 离线可用
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 云端ASR增强  │ ← 在线更准确
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ LLM语义理解  │ ← 提取金额、分类、备注
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 交易记录生成 │
└─────────────┘
```

**支持的语音模式**：
- 单笔记账："午饭花了35"
- 多笔记账："午饭35，打车18"
- 带分类："买了本书，花了50"
- 带时间："昨天晚饭花了80"

> 📄 **代码实现**: 见 [代码设计文档 - 代码块80-85](app_v2_code_design.md#code-80)

### 4.2 图片识别流程

**支持的图片类型**：

| 类型 | 识别内容 | 准确率 |
|-----|---------|-------|
| 小票 | 商户、金额、时间、商品 | >95% |
| 外卖截图 | 商户、金额、商品列表 | >90% |
| 银行账单 | 交易明细、余额 | >95% |
| 手写记录 | 金额、备注 | >80% |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块86-90](app_v2_code_design.md#code-86)

### 4.3 智能分类算法

**分类优先级**：
1. 用户历史修正（最高优先）
2. 商户名称匹配
3. 关键词规则
4. ML模型预测
5. LLM语义分析

> 📄 **代码实现**: 见 [代码设计文档 - 代码块91](app_v2_code_design.md#code-91)

---

## 5. 数据导入导出系统

### 5.1 三层递进式去重

```
导入数据
    │
    ▼
┌─────────────────┐
│ 第一层：精确匹配  │ ← 100%置信度
│ 完全相同的交易   │
└────────┬────────┘
         │ 未匹配
         ▼
┌─────────────────┐
│ 第二层：特征匹配  │ ← 70-95%置信度
│ 关键字段匹配     │
└────────┬────────┘
         │ 未匹配
         ▼
┌─────────────────┐
│ 第三层：AI语义匹配│ ← 60-90%置信度
│ 智能识别相似交易  │
└────────┬────────┘
         │
         ▼
    用户确认/自动处理
```

> 📄 **代码实现**: 见 [代码设计文档 - 代码块100-105](app_v2_code_design.md#code-100)

### 5.2 支持的导入格式

| 格式 | 来源 | 解析方式 |
|-----|------|---------|
| CSV | 通用导出 | 列映射 |
| Excel | 银行账单 | 模板识别 |
| JSON | API导入 | 结构解析 |
| 图片 | 截图/小票 | OCR识别 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块106](app_v2_code_design.md#code-106)

---

## 6. 数据联动与可视化

### 6.1 数据下钻设计

**下钻路径**：
```
首页概览 → 分类统计 → 具体分类 → 交易列表 → 交易详情
    │
    └─→ 钱龄卡片 → 钱龄详情 → 影响因素 → 相关交易
    │
    └─→ 预算卡片 → 预算详情 → 小金库 → 消费记录
```

> 📄 **代码实现**: 见 [代码设计文档 - 代码块110](app_v2_code_design.md#code-110)

### 6.2 图表组件

| 图表类型 | 用途 | 交互 |
|---------|------|-----|
| 折线图 | 趋势展示 | 点击查看详情 |
| 饼图 | 分类占比 | 点击下钻分类 |
| 柱状图 | 对比分析 | 点击查看明细 |
| 仪表盘 | 进度展示 | 点击查看目标 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块111-115](app_v2_code_design.md#code-111)

---

## 7. 家庭账本与多成员管理系统

### 7.1 权限模型

| 角色 | 权限 |
|-----|------|
| **管理员** | 全部权限，包括成员管理 |
| **记账员** | 记账、查看、编辑自己的记录 |
| **查看者** | 仅查看权限 |

### 7.2 数据隔离

- 个人账本：完全私有
- 家庭账本：成员共享
- 混合模式：部分共享

> 📄 **代码实现**: 见 [代码设计文档 - 代码块120-125](app_v2_code_design.md#code-120)

---

## 8. 技术架构设计

### 8.1 离线能力矩阵

| 功能模块 | 离线等级 | 离线能力 | 联网增强 |
|---------|---------|---------|---------|
| 手动记账 | ● L0 | 完整功能 | 云端同步 |
| 钱龄计算 | ● L0 | 本地FIFO算法 | - |
| 语音输入 | ◐ L1 | 本地ASR | 云端ASR更准 |
| 图片OCR | ◐ L1 | 本地OCR | 云端OCR更准 |
| AI洞察 | ○ L2 | 缓存洞察 | 实时分析 |
| 数据同步 | ◇ L3 | - | 必需 |

### 8.2 数据同步策略

**冲突解决**：
- 时间戳优先：最后修改者优先
- 用户选择：重要冲突提示用户
- 自动合并：非冲突字段自动合并

> 📄 **代码实现**: 见 [代码设计文档 - 代码块179-185](app_v2_code_design.md#code-179)

---

## 9. 用户体验设计

### 9.1 拇指热区设计

```
┌─────────────────────────────────────┐
│           困难区 (Hard)             │ ← 低频功能
├─────────────────────────────────────┤
│           舒适区 (Natural)          │ ← 查看类功能
├─────────────────────────────────────┤
│      ★★★ 黄金区 (Easy) ★★★        │ ← 核心操作
├─────────────────────────────────────┤
│   [首页]  [预算]  [洞察]  [设置]    │ ← 底部导航
└─────────────────────────────────────┘
```

### 9.2 动效设计

| 场景 | 动效 | 时长 |
|-----|------|-----|
| 页面切换 | 滑动过渡 | 300ms |
| 数据加载 | 骨架屏 | - |
| 操作反馈 | 涟漪效果 | 200ms |
| 成就解锁 | 庆祝动画 | 1000ms |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块200-210](app_v2_code_design.md#code-200)

---

## 10. 工程保障

### 10.1 异常处理策略

| 异常类型 | 处理方式 |
|---------|---------|
| 网络异常 | 离线队列缓存，恢复后重试 |
| 数据异常 | 回滚到最近有效状态 |
| 计算异常 | 降级到简化算法 |
| UI异常 | 显示友好错误页面 |

### 10.2 监控指标

| 指标 | 阈值 | 告警 |
|-----|------|-----|
| 首屏加载 | <1s | >2s告警 |
| API响应 | <500ms | >1s告警 |
| 崩溃率 | <0.1% | >0.5%告警 |
| 同步成功率 | >99.9% | <99%告警 |

> 📄 **代码实现**: 见 [代码设计文档 - 代码块220-230](app_v2_code_design.md#code-220)

---

## 附录

### A. 代码块索引

完整的代码实现请参考 [代码设计文档](./app_v2_code_design.md)。

### B. 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 2.0.0 | 2026-01-01 | 初始版本，从完整设计文档拆分 |
