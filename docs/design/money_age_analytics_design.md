# 钱龄核心统计分析系统设计方案

## 一、设计理念

### 1.1 什么是钱龄

钱龄是零基预算理念中的核心指标，表示**当前花费的钱是多少天前赚到的**。

- **钱龄 = 0-7天**：月光族，花的是刚赚到的钱
- **钱龄 = 14-29天**：良好状态，有一定缓冲
- **钱龄 ≥ 30天**：优秀状态，至少有一个月的缓冲资金

### 1.2 核心目标

> **让用户从"活在当下"转变为"为未来消费"**

通过钱龄系统，帮助用户：
1. 打破月光循环
2. 建立财务缓冲
3. 减少财务焦虑
4. 实现财务自由的第一步

---

## 二、钱龄计算模型

### 2.1 基础计算公式

```
钱龄 = Σ(每笔可用资金 × 该资金存在天数) / Σ(每笔可用资金)
```

### 2.2 资金池分层模型

```
┌─────────────────────────────────────────────────────────────┐
│                     用户总资产                               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   现金池     │  │   预算池     │  │      储蓄池         │  │
│  │ (即时可用)   │  │ (已分配用途) │  │ (目标储蓄/应急金)   │  │
│  │             │  │             │  │                     │  │
│  │ 钱龄影响:高  │  │ 钱龄影响:中  │  │ 钱龄影响:低         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    投资池 (不计入钱龄)                   ││
│  │              长期投资、股票、基金等                       ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    负债池 (负向影响)                      ││
│  │              信用卡待还、贷款、借款等                      ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 2.3 FIFO 资金追踪

采用先进先出 (FIFO) 原则追踪每笔资金的"年龄"：

```dart
class MoneyBatch {
  final String id;
  final double amount;           // 金额
  final DateTime receivedDate;   // 收到日期
  final String source;           // 来源 (工资/转入/其他收入)
  double remainingAmount;        // 剩余金额

  int get ageInDays => DateTime.now().difference(receivedDate).inDays;
}

class MoneyAgeCalculator {
  List<MoneyBatch> _moneyBatches = [];

  // 收入时添加资金批次
  void addIncome(double amount, DateTime date, String source) {
    _moneyBatches.add(MoneyBatch(
      id: uuid(),
      amount: amount,
      receivedDate: date,
      source: source,
      remainingAmount: amount,
    ));
  }

  // 支出时按FIFO扣减
  void recordExpense(double amount) {
    var remaining = amount;
    for (var batch in _moneyBatches) {
      if (remaining <= 0) break;
      if (batch.remainingAmount > 0) {
        var deduct = min(batch.remainingAmount, remaining);
        batch.remainingAmount -= deduct;
        remaining -= deduct;
      }
    }
    // 清理已耗尽的批次
    _moneyBatches.removeWhere((b) => b.remainingAmount <= 0);
  }

  // 计算加权平均钱龄
  double get moneyAge {
    if (_moneyBatches.isEmpty) return 0;

    var totalWeightedAge = 0.0;
    var totalAmount = 0.0;

    for (var batch in _moneyBatches) {
      totalWeightedAge += batch.remainingAmount * batch.ageInDays;
      totalAmount += batch.remainingAmount;
    }

    return totalAmount > 0 ? totalWeightedAge / totalAmount : 0;
  }
}
```

---

## 三、钱龄仪表盘设计

### 3.1 首页钱龄卡片 (核心展示)

```
┌─────────────────────────────────────────────────────────────┐
│  💰 钱龄                                        良好 ↗       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│              ┌────────────────────┐                         │
│              │                    │                         │
│              │       23 天        │        目标: 30天       │
│              │                    │        距离: 7天        │
│              └────────────────────┘                         │
│                                                             │
│    ════════════════════════████████░░░░░░                   │
│    0天        7天        14天       23天      30天+         │
│    │          │          │          ▲         │             │
│    危险       一般       良好       当前      优秀           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  📈 趋势: 较上周 +2.3天  │  🎯 预计达成: 12月15日           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 钱龄详情页

```
┌─────────────────────────────────────────────────────────────┐
│  ← 钱龄分析                                      📊 报告    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  钱龄历史趋势图                       │    │
│  │     30 ─────────────────────────────────────────     │    │
│  │        ╱                                     ╲      │    │
│  │     20 ─────────────────────╱──────────────────     │    │
│  │              ╱─────────────╱                        │    │
│  │     10 ─────╱──────────────────────────────────     │    │
│  │        ╱                                            │    │
│  │      0 ────────────────────────────────────────     │    │
│  │        1月   2月   3月   4月   5月   6月   7月      │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                                             │
│  📊 资金池分析                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  现金账户                    ¥12,500    钱龄 28天   │    │
│  │  ████████████████████░░░░                           │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  预算余额                    ¥8,200     钱龄 15天   │    │
│  │  ████████████░░░░░░░░░░░░                           │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  应急储蓄                    ¥30,000    钱龄 45天   │    │
│  │  ████████████████████████████                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 钱龄健康度评分

```
┌─────────────────────────────────────────────────────────────┐
│  🏥 钱龄健康报告                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│         ┌──────────────────────┐                            │
│         │                      │                            │
│         │     健康分数: 78     │        B+ 良好             │
│         │       ───────        │                            │
│         │                      │                            │
│         └──────────────────────┘                            │
│                                                             │
│  评分维度:                                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  💰 钱龄天数        23天      ████████░░  80分       │    │
│  │  📈 钱龄稳定性      稳定上升   █████████░  90分       │    │
│  │  🎯 目标达成度      77%       ███████░░░  70分       │    │
│  │  💳 负债影响        低        ████████░░  80分       │    │
│  │  🏦 储蓄缓冲        1.5月     ███████░░░  70分       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  💡 改进建议:                                                │
│  • 每月多存 ¥2,000 可在2个月后达成30天钱龄                   │
│  • 减少冲动消费，本月已有3笔非计划支出                        │
│  • 信用卡待还款影响了钱龄，建议优先还清                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、钱龄与各模块的整合

### 4.1 与预算管理整合

```
┌─────────────────────────────────────────────────────────────┐
│  📋 预算 vs 钱龄                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  预算执行情况对钱龄的影响分析:                                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  餐饮预算                                            │    │
│  │  预算: ¥3,000  已用: ¥2,100  剩余: ¥900             │    │
│  │  ████████████████████░░░░░░  70%                    │    │
│  │                                                     │    │
│  │  💡 钱龄影响: 如果本月节省 ¥500，钱龄可增加 1.2天    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  购物预算                                            │    │
│  │  预算: ¥2,000  已用: ¥2,800  超支: ¥800 ⚠️          │    │
│  │  ████████████████████████████  140%                 │    │
│  │                                                     │    │
│  │  ⚠️ 钱龄影响: 超支 ¥800 导致钱龄减少 2.1天          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 预算遵守度与钱龄相关性:                                   │
│  遵守预算的月份，钱龄平均增长 3.5天                           │
│  超支月份，钱龄平均下降 2.8天                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 与储蓄目标整合

```
┌─────────────────────────────────────────────────────────────┐
│  🎯 储蓄目标与钱龄                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🏠 买房首付                                         │    │
│  │  目标: ¥300,000  已存: ¥85,000  进度: 28%           │    │
│  │  ████████░░░░░░░░░░░░░░░░░░░░                       │    │
│  │                                                     │    │
│  │  📊 对钱龄贡献:                                      │    │
│  │  这笔储蓄为你的钱龄贡献了 +8.5天                      │    │
│  │  (高龄资金，存入超过90天)                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🚨 应急储蓄金                                       │    │
│  │  目标: 3个月支出  已存: 1.5个月  进度: 50%          │    │
│  │  ███████████████░░░░░░░░░░░░░░                      │    │
│  │                                                     │    │
│  │  💡 钱龄建议:                                        │    │
│  │  应急金是钱龄的重要保障                              │    │
│  │  建议优先完成应急金目标，再追求更高钱龄               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ⭐ 钱龄目标 (智能推荐)                                      │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  当前钱龄: 23天  →  目标钱龄: 30天                   │    │
│  │                                                     │    │
│  │  达成方案:                                          │    │
│  │  • 每月额外存入 ¥2,000 到储蓄账户                    │    │
│  │  • 预计 6 周后达成目标                               │    │
│  │  • 达成后每月可减少储蓄至 ¥1,500 维持钱龄            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 与信用卡/负债整合

```
┌─────────────────────────────────────────────────────────────┐
│  💳 负债与钱龄                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⚠️ 负债对钱龄的影响                                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  当前负债总额: ¥15,200                               │    │
│  │                                                     │    │
│  │  📊 负债构成:                                        │    │
│  │  ├── 招商银行信用卡    ¥8,500   账单日还款 ✓        │    │
│  │  ├── 工商银行信用卡    ¥4,200   账单日还款 ✓        │    │
│  │  └── 花呗              ¥2,500   分期中 ⚠️            │    │
│  │                                                     │    │
│  │  💡 钱龄分析:                                        │    │
│  │  • 信用卡账期内还款不影响钱龄 ✓                       │    │
│  │  • 花呗分期会持续影响钱龄 (每月消耗 -1.2天)          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  🎯 还款优化建议:                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  优先还清花呗分期                                    │    │
│  │  • 提前还清可节省利息 ¥156                           │    │
│  │  • 钱龄预计提升 1.2天                                │    │
│  │                                                     │    │
│  │  [立即还款]                                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📈 如果还清所有负债:                                        │
│  当前钱龄: 23天  →  预计钱龄: 28天 (+5天)                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 与投资账户整合

```
┌─────────────────────────────────────────────────────────────┐
│  📈 投资与钱龄                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  投资资产概览:                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  投资总额: ¥150,000                                  │    │
│  │                                                     │    │
│  │  ├── 股票        ¥50,000   (不计入钱龄)             │    │
│  │  ├── 基金        ¥80,000   (不计入钱龄)             │    │
│  │  └── 货币基金     ¥20,000   (计入钱龄) ✓            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  💡 钱龄说明:                                                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  为什么长期投资不计入钱龄？                          │    │
│  │                                                     │    │
│  │  钱龄衡量的是"可随时使用的缓冲资金"                  │    │
│  │  • 股票/基金: 需要卖出变现，且有波动风险              │    │
│  │  • 货币基金: T+0 赎回，视为流动资金                   │    │
│  │                                                     │    │
│  │  投资是财富增值手段，不是日常缓冲                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  🔄 投资收益对钱龄的贡献:                                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  本月投资收益: ¥2,500                                │    │
│  │                                                     │    │
│  │  💰 如果将收益转入现金账户:                          │    │
│  │  钱龄将增加约 0.8天                                  │    │
│  │                                                     │    │
│  │  [转入现金账户]  [继续投资]                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、钱龄提升行动计划

### 5.1 智能建议系统

```
┌─────────────────────────────────────────────────────────────┐
│  🎯 钱龄提升计划                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  当前: 23天  →  目标: 30天  →  理想: 45天+                  │
│  ════════════════════════▲══════════════════░░░░░░░░░       │
│                                                             │
│  📋 本月行动清单:                                            │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ☐ 每周存入 ¥500 到储蓄账户                          │    │
│  │    预期钱龄提升: +0.5天/周                           │    │
│  │    本周进度: ¥500/¥500 ✓                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ☐ 餐饮预算控制在 ¥2,500 以内                        │    │
│  │    上月超支 ¥500，影响钱龄 -1.5天                    │    │
│  │    本周进度: ¥1,200/¥2,500                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ☐ 还清花呗分期                                      │    │
│  │    剩余: ¥2,500                                      │    │
│  │    还清后钱龄提升: +1.2天                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 预测:                                                    │
│  如果完成所有行动，预计 4周后 钱龄达到 30天                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 钱龄里程碑

```
┌─────────────────────────────────────────────────────────────┐
│  🏆 钱龄成就                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ══════════════════════════════════════════════════════════ │
│                                                             │
│  🥉 起步者      7天    ✓ 2024-03-15 达成                    │
│  ───────────────────────────────────────────────────────── │
│  🥈 稳健理财    14天   ✓ 2024-05-22 达成                    │
│  ───────────────────────────────────────────────────────── │
│  🥇 财务自由    30天   ◐ 进行中 (23/30天)                   │
│  ───────────────────────────────────────────────────────── │
│  💎 财务大师    60天   ○ 未开始                             │
│  ───────────────────────────────────────────────────────── │
│  👑 财务自由    90天   ○ 未开始                             │
│                                                             │
│  ══════════════════════════════════════════════════════════ │
│                                                             │
│  🎉 最近成就:                                                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🏅 连续30天钱龄不下降                                │    │
│  │     达成时间: 2024-11-20                             │    │
│  │     奖励: 解锁"稳定理财者"称号                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、统计报表系统

### 6.1 周报

```
┌─────────────────────────────────────────────────────────────┐
│  📊 钱龄周报                         2024年12月第1周        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  💰 本周钱龄变化                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │      开始: 21天  →  结束: 23天  →  变化: +2天 ↑      │    │
│  │                                                     │    │
│  │   25│            ╱──●                               │    │
│  │   23│        ╱──╱                                   │    │
│  │   21│  ●────╱                                       │    │
│  │   19│                                               │    │
│  │     └──────────────────────────────────────         │    │
│  │       周一  周二  周三  周四  周五  周六  周日       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  📈 关键指标                                                 │
│  ┌──────────────┬──────────────┬──────────────┐            │
│  │   收入       │    支出      │    净流入     │            │
│  │  ¥8,500     │   ¥5,200    │   ¥3,300     │            │
│  │   (工资)     │   (日常)     │   (+38%)     │            │
│  └──────────────┴──────────────┴──────────────┘            │
│                                                             │
│  💡 钱龄影响分析                                             │
│  ├── ✓ 工资到账增加钱龄 +3.2天                              │
│  ├── ✗ 周六聚餐消耗老资金 -0.8天                            │
│  └── ◐ 预算执行良好，节省 ¥800                              │
│                                                             │
│  🎯 下周建议                                                 │
│  控制周末消费，预计下周钱龄可达 25天                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 月报

```
┌─────────────────────────────────────────────────────────────┐
│  📊 钱龄月报                              2024年11月         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ══════════════════ 本月总览 ══════════════════              │
│                                                             │
│  ┌──────────┬──────────┬──────────┬──────────┐             │
│  │  钱龄    │  收入     │   支出   │  储蓄率   │             │
│  │  23天    │ ¥25,000  │ ¥18,500 │   26%    │             │
│  │  ↑ +5天  │  ↑ +2000 │  ↓ -500 │  ↑ +4%   │             │
│  └──────────┴──────────┴──────────┴──────────┘             │
│                                                             │
│  📈 钱龄趋势                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │   30│                              目标线            │    │
│  │   25│                    ╱────────────●              │    │
│  │   20│          ╱────────╱                            │    │
│  │   15│  ●──────╱                                      │    │
│  │   10│                                                │    │
│  │     └────────────────────────────────────────        │    │
│  │       第1周    第2周    第3周    第4周               │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  📊 资金流向分析                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  收入来源            │  支出去向                      │    │
│  │                      │                               │    │
│  │  工资    ████ 80%   │  餐饮    ████░ 25%            │    │
│  │  兼职    █░░░ 12%   │  购物    ███░░ 18%            │    │
│  │  其他    ░░░░ 8%    │  交通    ██░░░ 12%            │    │
│  │                      │  房租    █████ 30%            │    │
│  │                      │  其他    ███░░ 15%            │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  🔍 钱龄变动原因                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  增长因素:                                           │    │
│  │  + 工资收入及时存入          +6.5天                  │    │
│  │  + 预算执行良好              +1.2天                  │    │
│  │  + 还清一笔分期              +0.8天                  │    │
│  │                                                     │    │
│  │  消耗因素:                                           │    │
│  │  - 双11购物超支              -2.5天                  │    │
│  │  - 朋友婚礼份子钱            -1.0天                  │    │
│  │                                                     │    │
│  │  净变化:                      +5.0天                 │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 年度报告

```
┌─────────────────────────────────────────────────────────────┐
│                    🎊 2024年钱龄年度报告                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │         🏆 年度钱龄成长: 5天 → 23天                  │    │
│  │               增长 360%！                            │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  📊 月度钱龄走势                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │   30│                                    ●          │    │
│  │   25│                              ●────╱           │    │
│  │   20│                    ●────────╱                 │    │
│  │   15│          ●────────╱                           │    │
│  │   10│    ●────╱                                     │    │
│  │    5│●──╱                                           │    │
│  │     └────────────────────────────────────────       │    │
│  │     1月 2月 3月 4月 5月 6月 7月 8月 9月 10月11月12月 │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  🏅 年度成就                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🥉 达成7天钱龄                    2024-02-15       │    │
│  │  🥈 达成14天钱龄                   2024-05-22       │    │
│  │  🎖️ 连续100天钱龄上涨              2024-08-30       │    │
│  │  💰 累计储蓄突破10万               2024-10-15       │    │
│  │  📈 钱龄从未低于10天(下半年)        2024-12-31       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  💡 年度洞察                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  • 最高钱龄: 25天 (11月)                             │    │
│  │  • 最低钱龄: 5天 (1月)                               │    │
│  │  • 钱龄最稳定月份: 9月 (波动仅1天)                    │    │
│  │  • 对钱龄贡献最大: 坚持每月固定储蓄                    │    │
│  │  • 对钱龄威胁最大: Q4购物季支出                       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│  🎯 2025年目标                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  目标钱龄: 45天                                      │    │
│  │  策略: 每月储蓄 ¥3,000 + 控制预算 + 减少分期          │    │
│  │  预计达成时间: 2025年6月                             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                             │
│                    [分享我的钱龄成长]                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、技术实现架构

### 7.1 数据模型

```dart
// 资金批次
class MoneyBatch {
  String id;
  double amount;
  double remainingAmount;
  DateTime receivedDate;
  String sourceType;  // income, transfer, investment_return
  String? sourceId;   // 关联收入记录ID
  String accountId;

  int get ageInDays;
}

// 钱龄快照
class MoneyAgeSnapshot {
  String id;
  DateTime date;
  double moneyAge;           // 当日钱龄
  double totalLiquidAssets;  // 流动资产总额
  double totalDebt;          // 负债总额
  double netWorth;           // 净值
  int healthScore;           // 健康分数 0-100
  Map<String, double> accountBreakdown;  // 各账户贡献
}

// 钱龄目标
class MoneyAgeGoal {
  String id;
  double targetAge;      // 目标钱龄天数
  DateTime? targetDate;  // 目标达成日期
  double currentAge;     // 当前钱龄
  String status;         // in_progress, achieved, failed
  List<String> strategies;  // 推荐策略
}

// 钱龄分析报告
class MoneyAgeReport {
  String id;
  String type;           // daily, weekly, monthly, yearly
  DateTime startDate;
  DateTime endDate;
  double startAge;
  double endAge;
  double changeAmount;
  List<MoneyAgeInfluence> influences;  // 影响因素
  List<String> insights;               // 洞察
  List<String> recommendations;        // 建议
}

// 钱龄影响因素
class MoneyAgeInfluence {
  String type;           // income, expense, debt_change, savings
  String description;
  double impact;         // 正数增加，负数减少
  String? relatedId;     // 关联交易/预算/目标ID
}
```

### 7.2 计算服务

```dart
class MoneyAgeService {
  // 计算当前钱龄
  Future<double> calculateCurrentMoneyAge();

  // 预测未来钱龄
  Future<MoneyAgeForecast> forecastMoneyAge({
    required int daysAhead,
    double? additionalSavings,
    double? reducedSpending,
  });

  // 生成钱龄报告
  Future<MoneyAgeReport> generateReport({
    required String type,
    required DateTime startDate,
    required DateTime endDate,
  });

  // 获取提升建议
  Future<List<MoneyAgeSuggestion>> getSuggestions();

  // 计算交易对钱龄的影响
  Future<double> calculateTransactionImpact(Transaction transaction);

  // 模拟场景
  Future<MoneyAgeSimulation> simulateScenario({
    double? oneTimeExpense,
    double? oneTimeIncome,
    double? monthlyBudgetChange,
    double? debtPayoff,
  });
}
```

### 7.3 前端组件

```dart
// 钱龄仪表盘
class MoneyAgeDashboard extends ConsumerWidget {
  // 主卡片显示当前钱龄
  // 趋势图
  // 快速操作按钮
}

// 钱龄详情页
class MoneyAgeDetailPage extends ConsumerWidget {
  // 历史趋势
  // 资金池分析
  // 健康评分
  // 影响因素
}

// 钱龄目标设置
class MoneyAgeGoalPage extends ConsumerWidget {
  // 设置目标
  // 查看进度
  // 行动计划
}

// 钱龄报告页
class MoneyAgeReportPage extends ConsumerWidget {
  // 周报/月报/年报切换
  // 详细分析
  // 导出/分享
}
```

---

## 八、实施路线图

### Phase 1: 基础钱龄计算 (2周)
- [ ] 实现FIFO资金追踪模型
- [ ] 计算基础钱龄指标
- [ ] 首页钱龄卡片展示
- [ ] 钱龄趋势图

### Phase 2: 钱龄分析 (2周)
- [ ] 资金池分层模型
- [ ] 健康度评分系统
- [ ] 影响因素分析
- [ ] 基础报告生成

### Phase 3: 与现有模块整合 (2周)
- [ ] 预算管理联动
- [ ] 储蓄目标联动
- [ ] 信用卡/负债联动
- [ ] 投资账户联动

### Phase 4: 智能建议系统 (2周)
- [ ] 钱龄提升建议
- [ ] 行动计划生成
- [ ] 场景模拟
- [ ] 目标预测

### Phase 5: 报表与成就 (1周)
- [ ] 周报/月报/年报
- [ ] 成就系统
- [ ] 分享功能
- [ ] 导出功能

---

## 九、零基预算与钱龄的深度整合

### 9.1 零基预算核心理念

零基预算是一种科学的预算管理方法，核心原则是：**"让每一分钱都有去处"**

```
传统预算思维:                    零基预算思维:
┌─────────────────────┐        ┌─────────────────────┐
│  收入 - 支出 = 储蓄  │   vs   │  收入 - 储蓄 = 支出  │
│  (被动储蓄)          │        │  (主动分配)          │
└─────────────────────┘        └─────────────────────┘
```

**零基预算四大原则与钱龄的关系:**

| 原则 | 说明 | 与钱龄的关系 |
|-----|------|------------|
| 原则1: 量入为出 | 所有收入都要分配用途 | 未分配资金不计入钱龄缓冲 |
| 原则2: 未雨绸缪 | 为年度大额支出提前准备 | 预留资金提升长期钱龄稳定性 |
| 原则3: 灵活调整 | 预算不是死的，可以挪用 | 智能重分配时显示钱龄影响 |
| 原则4: 花旧钱 | 消费上个月的收入 | **这就是钱龄的核心目标!** |

### 9.2 零基预算资金分配模型

```
┌─────────────────────────────────────────────────────────────────┐
│                     本月可用资金: ¥25,000                         │
│                     (上月结余 + 本月收入)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    💰 待分配资金池                        │    │
│  │                       ¥25,000                            │    │
│  │                    钱龄: 15天 (加权平均)                  │    │
│  └──────────────────────────┬──────────────────────────────┘    │
│                             │                                   │
│          ┌─────────────────┴─────────────────┐                 │
│          ▼                                   ▼                 │
│  ┌───────────────────┐          ┌───────────────────────────┐  │
│  │   必要支出小金库     │          │      弹性支出小金库          │  │
│  │   (Must-Have)     │          │      (Nice-to-Have)        │  │
│  │                   │          │                            │  │
│  │  🏠 房租  ¥5,000  │          │  🍕 餐饮  ¥3,000           │  │
│  │  💡 水电  ¥300    │          │  🎮 娱乐  ¥1,000           │  │
│  │  📱 通讯  ¥200    │          │  👗 购物  ¥2,000           │  │
│  │  🚌 交通  ¥500    │          │  🎁 社交  ¥800            │  │
│  │  🍚 基础伙食 ¥1,500│          │  ☕ 咖啡  ¥400            │  │
│  │                   │          │                            │  │
│  │  小计: ¥7,500     │          │  小计: ¥7,200              │  │
│  └───────────────────┘          └───────────────────────────┘  │
│          │                                   │                 │
│          └─────────────────┬─────────────────┘                 │
│                            ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    储蓄与目标小金库                         │   │
│  │                                                          │   │
│  │  🎯 应急储蓄    ¥2,000  (优先级1 - 钱龄保障)              │   │
│  │  🏠 买房首付    ¥3,000  (优先级2)                        │   │
│  │  ✈️ 年度旅行    ¥1,500  (年度开支预留)                    │   │
│  │  🎄 节日支出    ¥500   (年度开支预留)                    │   │
│  │  🔧 意外维修    ¥300   (年度开支预留)                    │   │
│  │                                                          │   │
│  │  小计: ¥7,300                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                   │
│                            ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │   📊 分配汇总                                             │   │
│  │                                                          │   │
│  │   可用: ¥25,000                                          │   │
│  │   已分配: ¥22,000                                        │   │
│  │   ─────────────────────────────────────────────          │   │
│  │   待分配: ¥3,000  ← 考虑增加储蓄以提升钱龄                 │   │
│  │                                                          │   │
│  │   💡 建议: 将 ¥3,000 分配至应急储蓄，钱龄可提升 2.5天      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 小金库系统与钱龄联动

#### 9.3.1 小金库钱龄独立追踪

```dart
/// 预算小金库 (零基预算概念)
class BudgetVault {
  String id;
  String name;
  String type;           // must_have, nice_to_have, savings, annual_expense
  double allocated;      // 本周期分配金额
  double spent;          // 已支出
  double available;      // 可用 = allocated - spent + carryover

  // 小金库专属钱龄
  List<MoneyBatch> moneyBatches;  // 该小金库内的资金批次

  /// 计算该小金库的资金钱龄
  double get vaultMoneyAge {
    if (moneyBatches.isEmpty) return 0;
    var totalWeightedAge = 0.0;
    var totalAmount = 0.0;
    for (var batch in moneyBatches) {
      totalWeightedAge += batch.remainingAmount * batch.ageInDays;
      totalAmount += batch.remainingAmount;
    }
    return totalAmount > 0 ? totalWeightedAge / totalAmount : 0;
  }
}
```

#### 9.3.2 小金库钱龄可视化

```
┌─────────────────────────────────────────────────────────────┐
│  📋 小金库钱龄一览                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🍕 餐饮小金库                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  可用: ¥1,800 / ¥3,000        小金库钱龄: 8天          │    │
│  │  ████████████░░░░░░  60%                            │    │
│  │                                                     │    │
│  │  资金来源:                                          │    │
│  │  ├── 12月工资 (12天前)  ¥1,200  ⬤⬤⬤⬤⬤⬤⬤⬤⬤⬤⬤⬤     │    │
│  │  └── 11月结余 (35天前)  ¥600   ⬤⬤⬤⬤⬤...            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  🎯 应急储蓄小金库                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  已存: ¥30,000              小金库钱龄: 68天 ⭐        │    │
│  │  ████████████████████████████ 100%                  │    │
│  │                                                     │    │
│  │  💡 这笔储蓄大幅提升了您的整体钱龄                    │    │
│  │     对总钱龄贡献: +12天                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  🎮 娱乐小金库                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  可用: ¥200 / ¥1,000          小金库钱龄: 3天 ⚠️       │    │
│  │  ██░░░░░░░░░░░░░░░░  20%                            │    │
│  │                                                     │    │
│  │  ⚠️ 本月娱乐支出较快，都是最近的收入                   │    │
│  │     考虑控制节奏，使用更"老"的钱                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.4 "年度开支预留"与钱龄稳定性

"未雨绸缪"原则是保持钱龄稳定的关键——提前为那些不常发生但必然会来的大额支出做准备：

```
┌─────────────────────────────────────────────────────────────┐
│  📅 年度开支规划 - 钱龄稳定器                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  什么是年度开支？                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  那些不是每月发生，但一定会来的开支：                   │    │
│  │  • 年度保险费    • 汽车保养    • 节日红包              │    │
│  │  • 房屋维修      • 设备更换    • 会员订阅              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ⚠️ 不规划年度开支对钱龄的影响:                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │  钱龄  │     车险到期                                │    │
│  │   30  │─────────────────╲                          │    │
│  │   25  │                  ╲                         │    │
│  │   20  │                   ╲──────────────────      │    │
│  │   15  │                          大额支出导致       │    │
│  │   10  │                          钱龄断崖式下跌     │    │
│  │       └─────────────────────────────────────────   │    │
│  │       1月  2月  3月  4月  5月  6月  7月             │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ✅ 规划年度开支后:                                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │  钱龄  │     车险到期(已预留)                         │    │
│  │   30  │─────────────────────────────────────────   │    │
│  │   25  │     每月存 ¥500 到车险小金库                   │    │
│  │   20  │     支出时使用专用小金库，钱龄几乎不受影响       │    │
│  │   15  │                                            │    │
│  │   10  │                                            │    │
│  │       └─────────────────────────────────────────   │    │
│  │       1月  2月  3月  4月  5月  6月  7月             │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 年度开支小金库列表:                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  小金库名称        月存    已存     目标    到期       │    │
│  │  ─────────────────────────────────────────────────  │    │
│  │  🚗 车险         ¥500   ¥3,000   ¥6,000  6月      │    │
│  │  🏠 房屋维修     ¥300   ¥1,800   ¥5,000  随时      │    │
│  │  🎄 节日支出     ¥400   ¥2,800   ¥4,800  12月     │    │
│  │  📱 换手机       ¥200   ¥800     ¥4,000  明年Q3   │    │
│  │  ─────────────────────────────────────────────────  │    │
│  │  💰 年度开支储备总计: ¥8,400                        │    │
│  │  🎯 这些储备为钱龄贡献: +6.2天                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.5 小金库挪用与钱龄影响

零基预算允许"灵活调整"，但挪用会影响钱龄：

```
┌─────────────────────────────────────────────────────────────┐
│  🔄 小金库资金挪用                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⚠️ 超支提醒                                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🍕 餐饮小金库超支 ¥500                                │    │
│  │                                                     │    │
│  │  选择资金来源:                                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  从 🎮 娱乐小金库 挪用                                 │    │
│  │  可用: ¥800  小金库钱龄: 5天                          │    │
│  │                                                     │    │
│  │  💡 钱龄影响: 挪用年轻的钱，对总钱龄影响小 (-0.3天)   │    │
│  │  ✅ 推荐选择                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  从 🎯 应急储蓄 挪用                                 │    │
│  │  可用: ¥30,000  小金库钱龄: 68天                      │    │
│  │                                                     │    │
│  │  ⚠️ 钱龄影响: 挪用老钱，总钱龄下降明显 (-2.1天)       │    │
│  │  ❌ 不推荐 - 会损害长期钱龄                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  从 💰 待分配资金 挪用                               │    │
│  │  可用: ¥1,200  资金钱龄: 2天                        │    │
│  │                                                     │    │
│  │  💡 钱龄影响: 使用最新的钱，对钱龄影响最小 (-0.1天)   │    │
│  │  ✅ 最优选择                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 挪用策略建议:                                            │
│  优先顺序: 待分配 > 非必要小金库 > 年度开支储备 > 应急储蓄      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.6 零基预算周期与钱龄

```
┌─────────────────────────────────────────────────────────────┐
│  📅 月度预算周期 - 钱龄视角                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  月初 (发薪日)                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1️⃣ 收入入账                                         │    │
│  │     工资 ¥15,000 进入"待分配池"                       │    │
│  │     这笔钱的年龄: 0天                                 │    │
│  │                                                     │    │
│  │  2️⃣ 零基分配                                         │    │
│  │     给每一分钱分配小金库                                │    │
│  │     💡 先分配储蓄小金库可让资金更快"变老"                │    │
│  │                                                     │    │
│  │  3️⃣ 小金库资金老化                                      │    │
│  │     储蓄小金库的钱不消费，持续老化                       │    │
│  │     支出小金库的钱按消费速度消耗                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  月中                                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  4️⃣ 消费与钱龄消耗                                    │    │
│  │     FIFO: 消费时优先消耗最老的钱                       │    │
│  │     ✅ 这就是"用老钱"的实现                            │    │
│  │                                                     │    │
│  │  5️⃣ 小金库调整                                          │    │
│  │     超支时从其他小金库挪用                              │    │
│  │     系统提示对钱龄的影响                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  月末                                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  6️⃣ 结余处理                                          │    │
│  │     小金库结余继续老化 → 钱龄提升                        │    │
│  │     选项A: 结余留在原小金库 (推荐)                       │    │
│  │     选项B: 结余转入储蓄 (钱龄提升更快)                 │    │
│  │                                                     │    │
│  │  7️⃣ 月度钱龄报告                                      │    │
│  │     本月钱龄变化分析                                  │    │
│  │     下月预算建议                                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ═══════════════════════════════════════════════════════   │
│                                                             │
│  🎯 零基预算如何提升钱龄:                                     │
│                                                             │
│  传统预算:                                                   │
│  收入 ¥15,000 → 随意消费 → 月底剩 ¥2,000 → 钱龄难以提升     │
│                                                             │
│  零基预算:                                                   │
│  收入 ¥15,000 → 先分配储蓄 ¥4,000 → 剩余按小金库消费           │
│              → 储蓄持续老化 → 钱龄稳步提升                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.7 零基预算钱龄提升策略

```
┌─────────────────────────────────────────────────────────────┐
│  🚀 零基预算 + 钱龄提升策略                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  策略1: 缓冲月策略 (Buffer Month)                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  目标: 存够下个月的全部支出                           │    │
│  │                                                     │    │
│  │  实现后:                                             │    │
│  │  • 本月收入 → 存入缓冲                               │    │
│  │  • 本月消费 → 使用上月缓冲                            │    │
│  │  • 钱龄自动 ≥ 30天！                                 │    │
│  │                                                     │    │
│  │  进度: ¥12,000 / ¥18,000  (67%)                     │    │
│  │  ████████████████████░░░░░░░░░░                     │    │
│  │                                                     │    │
│  │  💡 再存 ¥6,000 即可实现"用老钱"                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  策略2: 小金库老化策略                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  方法: 每月在储蓄小金库多留一些                         │    │
│  │                                                     │    │
│  │  第1个月: 储蓄小金库存 ¥2,000 (钱龄贡献 +2天)           │    │
│  │  第2个月: 再存 ¥2,000 (累计贡献 +5天)                 │    │
│  │  第3个月: 再存 ¥2,000 (累计贡献 +9天)                 │    │
│  │  ...                                                │    │
│  │                                                     │    │
│  │  💡 复利效应: 储蓄越久，钱龄提升越快                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  策略3: 年度开支预存策略                                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  方法: 提前为年度开支创建小金库并持续存入               │    │
│  │                                                     │    │
│  │  优势:                                               │    │
│  │  • 这些钱长期不动，会变得很"老"                       │    │
│  │  • 大额支出时使用专用小金库，不影响日常钱龄             │    │
│  │  • 心理上更轻松，没有意外支出的焦虑                   │    │
│  │                                                     │    │
│  │  示例: 车险小金库                                      │    │
│  │  每月存 ¥500 × 12个月 = ¥6,000                      │    │
│  │  到期时这笔钱平均年龄 = 6个月 = 180天!               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  策略4: 收入延迟消费策略                                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  方法: 新收入先存入"下月预算"小金库                     │    │
│  │                                                     │    │
│  │  本月收入 ¥15,000                                   │    │
│  │      ↓                                              │    │
│  │  存入"下月预算"小金库                                  │    │
│  │      ↓                                              │    │
│  │  本月消费用"本月预算"(上月存入)                       │    │
│  │      ↓                                              │    │
│  │  自动实现30+天钱龄                                   │    │
│  │                                                     │    │
│  │  ⏰ 需要1-2个月的过渡期建立缓冲                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.8 零基预算UI整合设计

```
┌─────────────────────────────────────────────────────────────┐
│  📱 零基预算主界面 (钱龄视角)                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  💰 待分配                           钱龄: 3天        │    │
│  │     ¥5,200                                          │    │
│  │     ════════════════════════════════                │    │
│  │     上次收入: 12月3日 工资                           │    │
│  │     [立即分配] 让这笔钱开始"工作"                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ━━━━━━━━━ 本月小金库 ━━━━━━━━━                               │
│                                                             │
│  必要支出                               整体钱龄: 12天       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🏠 房租          ¥5,000/¥5,000   ●──── 已支付      │    │
│  │  💡 水电          ¥180/¥300      ●─────────         │    │
│  │  🚌 交通          ¥320/¥500      ●────────          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  弹性支出                               整体钱龄: 8天        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🍕 餐饮          ¥1,800/¥3,000   ●────── 60%       │    │
│  │  🎮 娱乐          ¥650/¥1,000     ●───── 65%  ⚠️   │    │
│  │  ☕ 咖啡          ¥280/¥400       ●────── 70%       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  储蓄目标                               整体钱龄: 45天 ⭐    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🎯 应急储蓄      ¥30,000         ●━━━━━━━ 稳定老化  │    │
│  │  🏠 买房首付      ¥85,000         ●━━━━━━ 持续累积   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  年度开支储备                           整体钱龄: 92天 💎    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🚗 车险          ¥3,500/¥6,000   6月到期           │    │
│  │  🎄 节日          ¥2,800/¥4,800   12月到期          │    │
│  │  📱 换手机        ¥800/¥4,000     持续储备          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                                             │
│  📊 本月钱龄概览                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │  综合钱龄: 23天 ↑                   [查看详情]       │    │
│  │  ══════════════════════▲════════░░░░░░░░           │    │
│  │  0天        14天       23天      30天    目标       │    │
│  │                                                     │    │
│  │  💡 储蓄小金库贡献了 15天钱龄，继续保持！               │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.9 技术实现扩展

```dart
/// 零基预算服务 (扩展钱龄计算)
class ZeroBasedBudgetService {

  /// 从待分配池分配资金到小金库
  Future<void> allocateToVault({
    required String vaultId,
    required double amount,
  }) async {
    // 1. 从待分配池按FIFO取出资金批次
    final batches = await _unallocatedPool.withdrawFIFO(amount);

    // 2. 将资金批次转移到目标小金库
    await _vaultRepository.addMoneyBatches(vaultId, batches);

    // 3. 更新小金库钱龄统计
    await _updateVaultMoneyAge(vaultId);

    // 4. 重新计算总体钱龄
    await _moneyAgeService.recalculateTotalMoneyAge();
  }

  /// 小金库间资金挪用
  Future<MoneyTransferResult> transferBetweenVaults({
    required String fromVaultId,
    required String toVaultId,
    required double amount,
  }) async {
    // 1. 计算挪用对钱龄的影响
    final impact = await _calculateTransferImpact(
      fromVaultId, toVaultId, amount
    );

    // 2. 执行转移 (FIFO)
    final batches = await _vaultRepository.withdrawFIFO(
      fromVaultId, amount
    );
    await _vaultRepository.addMoneyBatches(toVaultId, batches);

    // 3. 更新钱龄
    await _moneyAgeService.recalculateTotalMoneyAge();

    return MoneyTransferResult(
      success: true,
      moneyAgeImpact: impact,
      transferredBatches: batches,
    );
  }

  /// 获取最优挪用建议
  Future<List<TransferSuggestion>> getOptimalTransferSuggestions({
    required String targetVaultId,
    required double neededAmount,
  }) async {
    final suggestions = <TransferSuggestion>[];
    final vaults = await _vaultRepository.getAllWithBalance();

    for (final vault in vaults) {
      if (vault.id == targetVaultId) continue;
      if (vault.available <= 0) continue;

      final impact = await _calculateTransferImpact(
        vault.id, targetVaultId,
        min(vault.available, neededAmount)
      );

      suggestions.add(TransferSuggestion(
        fromVault: vault,
        availableAmount: vault.available,
        moneyAgeImpact: impact,
        recommendation: _getRecommendationLevel(vault, impact),
      ));
    }

    // 按钱龄影响排序 (影响最小的优先)
    suggestions.sort((a, b) =>
      a.moneyAgeImpact.abs().compareTo(b.moneyAgeImpact.abs())
    );

    return suggestions;
  }

  /// 计算小金库对总钱龄的贡献
  Future<VaultMoneyAgeContribution> calculateVaultContribution(
    String vaultId
  ) async {
    final vault = await _vaultRepository.get(vaultId);
    final totalAssets = await _getTotalLiquidAssets();

    final contribution = (vault.available / totalAssets)
                        * vault.vaultMoneyAge;

    return VaultMoneyAgeContribution(
      vaultId: vaultId,
      vaultName: vault.name,
      amount: vault.available,
      vaultAge: vault.vaultMoneyAge,
      contributionDays: contribution,
      percentageOfTotal: vault.available / totalAssets * 100,
    );
  }
}

/// 小金库钱龄贡献
class VaultMoneyAgeContribution {
  final String vaultId;
  final String vaultName;
  final double amount;
  final double vaultAge;      // 小金库自身钱龄
  final double contributionDays;  // 对总钱龄的贡献天数
  final double percentageOfTotal; // 占总资产比例
}

/// 挪用建议
class TransferSuggestion {
  final BudgetVault fromVault;
  final double availableAmount;
  final double moneyAgeImpact;
  final RecommendationLevel recommendation;
}

enum RecommendationLevel {
  optimal,    // 最优 - 从待分配或年轻的钱挪用
  acceptable, // 可接受 - 从非必要小金库挪用
  notRecommended, // 不推荐 - 从储蓄挪用
}
```

---

## 十、数据联动与下钻交互设计

### 10.1 交互架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        钱龄数据交互地图                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────────────────────────────────────────────┐      │
│   │                    首页钱龄卡片                        │      │
│   │                     (入口层)                          │      │
│   └────────────────────────┬─────────────────────────────┘      │
│                            │ 点击                               │
│              ┌─────────────┴─────────────┐                      │
│              ▼                           ▼                      │
│   ┌─────────────────────┐     ┌─────────────────────┐           │
│   │    钱龄详情页        │     │    钱龄报告页        │           │
│   │    (分析层)          │     │    (报表层)          │           │
│   └──────────┬──────────┘     └──────────┬──────────┘           │
│              │                           │                      │
│    ┌─────────┼─────────┐       ┌─────────┼─────────┐            │
│    ▼         ▼         ▼       ▼         ▼         ▼            │
│ ┌─────┐ ┌─────┐ ┌─────┐   ┌─────┐ ┌─────┐ ┌─────┐             │
│ │账户 │ │小金库│ │交易 │   │周报 │ │月报 │ │年报 │             │
│ │详情 │ │详情 │ │列表 │   │详情 │ │详情 │ │详情 │             │
│ └──┬──┘ └──┬──┘ └──┬──┘   └──┬──┘ └──┬──┘ └──┬──┘             │
│    │       │       │         │       │       │                  │
│    └───────┴───────┴─────────┴───────┴───────┘                  │
│                            │                                    │
│                            ▼                                    │
│              ┌─────────────────────────────┐                    │
│              │        交易详情页           │                    │
│              │        (数据层)             │                    │
│              └─────────────────────────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 首页钱龄卡片交互

```
┌─────────────────────────────────────────────────────────────┐
│  💰 钱龄                                        良好 ↗       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│              ┌────────────────────┐                         │
│              │                    │    ← 点击数字           │
│              │       23 天        │      跳转: 钱龄详情页   │
│              │                    │                         │
│              └────────────────────┘                         │
│                                                             │
│    ════════════════════════████████░░░░░░  ← 点击进度条     │
│    0天        7天        14天       23天      跳转: 目标设置 │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  📈 趋势: 较上周 +2.3天  │  🎯 预计达成: 12月15日           │
│  ↑ 点击趋势              │  ↑ 点击预测                      │
│  跳转: 周报详情          │  跳转: 钱龄目标页                │
└─────────────────────────────────────────────────────────────┘

交互定义:
┌────────────────────┬────────────────────┬──────────────────────┐
│  触发区域           │  交互动作          │  跳转目标             │
├────────────────────┼────────────────────┼──────────────────────┤
│  钱龄数字(23天)     │  点击              │  钱龄详情页           │
│  进度条             │  点击              │  钱龄目标设置         │
│  趋势区域           │  点击              │  最近周报             │
│  预计达成           │  点击              │  钱龄目标页           │
│  整个卡片           │  长按              │  快速操作菜单         │
│  状态标签(良好)     │  点击              │  钱龄健康评分详情     │
└────────────────────┴────────────────────┴──────────────────────┘
```

### 10.3 钱龄详情页下钻

```
┌─────────────────────────────────────────────────────────────┐
│  ← 钱龄分析                                      📊 报告    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  钱龄历史趋势图                       │    │
│  │                                                     │    │
│  │   30 ──────────────────────────────────────────     │    │
│  │         ╱                                           │    │
│  │   20 ──╱────────────────────────────────────────    │    │
│  │       ╱     ◉ ← 点击数据点                          │    │
│  │   10 ╱          弹出: 2024-11-15 钱龄: 22天         │    │
│  │                  [查看当日详情]                      │    │
│  │    0 ────────────────────────────────────────────   │    │
│  │      1月   2月   3月   4月   5月   6月   7月        │    │
│  │      ↑                                             │    │
│  │      点击月份标签 → 跳转该月月报                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 资金池分析                          [展开全部 ▼]        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  现金账户  ←────────── 点击整行                      │    │
│  │  ████████████████████░░░░ ¥12,500  钱龄 28天        │    │
│  │                          跳转: 账户详情页            │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  餐饮小金库  ←────────── 点击整行                    │    │
│  │  ████████████░░░░░░░░  ¥1,800   钱龄 8天           │    │
│  │                          跳转: 小金库详情页          │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  应急储蓄小金库  ←────────── 点击整行                 │    │
│  │  ████████████████████████ ¥30,000  钱龄 45天        │    │
│  │                          跳转: 储蓄目标详情页        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  🔍 钱龄影响因素  (本周)                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  + 工资收入         +3.2天  ← 点击                   │    │
│  │                            跳转: 收入交易详情        │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  - 周六聚餐         -0.8天  ← 点击                   │    │
│  │                            跳转: 支出交易详情        │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  ◐ 预算节省         +0.5天  ← 点击                   │    │
│  │                            跳转: 预算执行详情        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.4 小金库详情页下钻

```
┌─────────────────────────────────────────────────────────────┐
│  ← 餐饮小金库                                    ⚙️ 设置    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  可用: ¥1,800 / ¥3,000        小金库钱龄: 8天        │    │
│  │  ████████████░░░░░░  60%                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 资金批次明细  (FIFO追踪)                                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │  批次1: 12月工资分配                                 │    │
│  │  ├── 金额: ¥1,200                                   │    │
│  │  ├── 入账: 12天前 (12月3日)  ← 点击日期             │    │
│  │  │                            跳转: 当日收入详情     │    │
│  │  ├── 钱龄: 12天                                     │    │
│  │  └── 来源: 工资收入  ← 点击来源                      │    │
│  │                       跳转: 关联交易详情             │    │
│  │                                                     │    │
│  │  批次2: 11月结余转入                                 │    │
│  │  ├── 金额: ¥600                                     │    │
│  │  ├── 入账: 35天前 (11月10日)                        │    │
│  │  ├── 钱龄: 35天                                     │    │
│  │  └── 来源: 上期结转                                 │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📝 本月消费记录                         [查看全部 →]       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  12月10日  外卖      -¥35    ← 点击                 │    │
│  │            消耗批次1          跳转: 交易详情         │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  12月8日   超市购物  -¥128   ← 点击                 │    │
│  │            消耗批次2          跳转: 交易详情         │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  12月5日   餐厅      -¥86    ← 点击                 │    │
│  │            消耗批次2          跳转: 交易详情         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  💡 钱龄分析                                                │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  该小金库对总钱龄贡献: +1.2天                        │    │
│  │                                                     │    │
│  │  建议:                       ← 点击建议              │    │
│  │  控制本周消费 ¥200，可保持小金库钱龄 ≥ 10天         │    │
│  │                              跳转: 预算调整页        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.5 报告页面数据联动

```
┌─────────────────────────────────────────────────────────────┐
│  📊 钱龄周报                         2024年12月第1周        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  💰 本周钱龄变化                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │      开始: 21天  →  结束: 23天  →  变化: +2天 ↑      │    │
│  │                                                     │    │
│  │   25│            ╱──●                               │    │
│  │   23│        ╱──╱    ↑ 点击数据点                   │    │
│  │   21│  ●────╱        弹出当日详情面板               │    │
│  │   19│                                               │    │
│  │     └──────────────────────────────────────         │    │
│  │       周一  周二  周三  周四  周五  周六  周日       │    │
│  │       ↑                                             │    │
│  │       点击日期 → 展开当日交易列表                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📈 关键指标                                ← 点击卡片      │
│  ┌──────────────┬──────────────┬──────────────┐            │
│  │   收入       │    支出      │    净流入     │            │
│  │  ¥8,500     │   ¥5,200    │   ¥3,300     │            │
│  │  跳转:收入列表│  跳转:支出列表│  跳转:现金流  │            │
│  └──────────────┴──────────────┴──────────────┘            │
│                                                             │
│  💡 钱龄影响分析                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✓ 工资到账增加钱龄 +3.2天  ← 点击                   │    │
│  │                             跳转: 12月3日收入详情    │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  ✗ 周六聚餐消耗老资金 -0.8天  ← 点击                 │    │
│  │                             跳转: 12月7日支出详情    │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │  ◐ 预算执行良好，节省 ¥800  ← 点击                   │    │
│  │                             跳转: 本周预算执行报告    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📊 小金库消耗排行                                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1. 🍕 餐饮     消耗 ¥1,200  ← 点击                  │    │
│  │                              跳转: 餐饮小金库详情     │    │
│  │  2. 🎮 娱乐     消耗 ¥500   ← 点击                  │    │
│  │                              跳转: 娱乐小金库详情     │    │
│  │  3. 🚌 交通     消耗 ¥180   ← 点击                  │    │
│  │                              跳转: 交通小金库详情     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  [← 上周]                                    [下周 →]       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.6 交易详情与钱龄关联

```
┌─────────────────────────────────────────────────────────────┐
│  ← 交易详情                                      🗑️ 删除    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🍕 外卖 - 美团                                      │    │
│  │                                                     │    │
│  │  金额: -¥35.00                                      │    │
│  │  时间: 2024-12-10 12:30                             │    │
│  │  分类: 餐饮                      ← 点击分类          │    │
│  │                                   跳转: 餐饮分类统计 │    │
│  │  账户: 微信支付                   ← 点击账户         │    │
│  │                                   跳转: 账户详情     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  💰 钱龄影响分析                                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                     │    │
│  │  📊 本次消费对钱龄的影响: -0.03天                    │    │
│  │                                                     │    │
│  │  资金来源追踪 (FIFO):                               │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │  来自: 12月工资  ← 点击                      │    │    │
│  │  │  金额: ¥35.00    跳转: 关联收入交易详情      │    │    │
│  │  │  资金年龄: 7天                               │    │    │
│  │  │  所属小金库: 餐饮  ← 点击                     │    │    │
│  │  │                    跳转: 餐饮小金库详情       │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  │                                                     │    │
│  │  💡 如果延迟3天消费:                                │    │
│  │     资金年龄将达到 10天，更符合"花旧钱"理念         │    │
│  │                                                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  📝 相关交易                            [查看更多 →]        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  同一小金库的其他消费:                               │    │
│  │  • 12月8日  超市购物  -¥128  ← 点击跳转             │    │
│  │  • 12月5日  餐厅      -¥86   ← 点击跳转             │    │
│  │                                                     │    │
│  │  同一收入来源的其他消费:                             │    │
│  │  • 12月9日  通勤      -¥20   ← 点击跳转             │    │
│  │  • 12月8日  咖啡      -¥30   ← 点击跳转             │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.7 数据联动路由定义

```dart
/// 钱龄模块路由配置
class MoneyAgeRoutes {
  // 主要页面
  static const String dashboard = '/money-age';
  static const String detail = '/money-age/detail';
  static const String goal = '/money-age/goal';
  static const String report = '/money-age/report';

  // 报告详情
  static const String weeklyReport = '/money-age/report/weekly';
  static const String monthlyReport = '/money-age/report/monthly';
  static const String yearlyReport = '/money-age/report/yearly';

  // 小金库相关
  static const String vaultDetail = '/budget/vault/:id';
  static const String vaultTransactions = '/budget/vault/:id/transactions';

  // 交易下钻
  static const String transactionDetail = '/transaction/:id';
  static const String transactionsByDate = '/transactions/date/:date';
  static const String transactionsByVault = '/transactions/vault/:id';

  // 账户下钻
  static const String accountDetail = '/account/:id';
  static const String accountMoneyAge = '/account/:id/money-age';
}

/// 下钻参数传递
class DrillDownParams {
  final String sourceScreen;    // 来源页面
  final String targetScreen;    // 目标页面
  final Map<String, dynamic> context;  // 上下文数据
  final DateTimeRange? dateRange;      // 日期范围筛选
  final String? vaultId;               // 小金库ID
  final String? accountId;             // 账户ID
  final String? transactionId;         // 交易ID

  /// 返回时是否需要刷新来源页面
  final bool refreshOnReturn;
}

/// 导航服务
class MoneyAgeNavigationService {
  /// 从首页卡片跳转
  void navigateFromDashboard(DrillDownType type) {
    switch (type) {
      case DrillDownType.moneyAgeNumber:
        _navigator.push(MoneyAgeRoutes.detail);
        break;
      case DrillDownType.progressBar:
        _navigator.push(MoneyAgeRoutes.goal);
        break;
      case DrillDownType.trend:
        _navigator.push(MoneyAgeRoutes.weeklyReport);
        break;
      case DrillDownType.prediction:
        _navigator.push(MoneyAgeRoutes.goal);
        break;
    }
  }

  /// 从详情页下钻到资金池
  void drillDownToPool(String poolId, PoolType type) {
    switch (type) {
      case PoolType.account:
        _navigator.push(MoneyAgeRoutes.accountDetail,
          params: {'id': poolId});
        break;
      case PoolType.vault:
        _navigator.push(MoneyAgeRoutes.vaultDetail,
          params: {'id': poolId});
        break;
      case PoolType.savings:
        _navigator.push('/savings-goal/$poolId');
        break;
    }
  }

  /// 从影响因素下钻到交易
  void drillDownToInfluence(MoneyAgeInfluence influence) {
    if (influence.relatedTransactionId != null) {
      _navigator.push(MoneyAgeRoutes.transactionDetail,
        params: {'id': influence.relatedTransactionId});
    } else if (influence.relatedDate != null) {
      _navigator.push(MoneyAgeRoutes.transactionsByDate,
        params: {'date': influence.relatedDate!.toIso8601String()});
    }
  }

  /// 从报告下钻到具体数据
  void drillDownFromReport({
    required ReportDrillDownType type,
    required DateTime date,
    String? vaultId,
  }) {
    switch (type) {
      case ReportDrillDownType.dailyData:
        _navigator.push(MoneyAgeRoutes.transactionsByDate,
          params: {'date': date.toIso8601String()});
        break;
      case ReportDrillDownType.income:
        _navigator.push('/transactions',
          queryParams: {'type': 'income', 'date': date.toIso8601String()});
        break;
      case ReportDrillDownType.expense:
        _navigator.push('/transactions',
          queryParams: {'type': 'expense', 'date': date.toIso8601String()});
        break;
      case ReportDrillDownType.vault:
        _navigator.push(MoneyAgeRoutes.vaultDetail,
          params: {'id': vaultId});
        break;
    }
  }
}

enum DrillDownType {
  moneyAgeNumber,
  progressBar,
  trend,
  prediction,
}

enum PoolType {
  account,
  vault,
  savings,
}

enum ReportDrillDownType {
  dailyData,
  income,
  expense,
  vault,
}
```

### 10.8 交互状态管理

```dart
/// 下钻状态管理
class DrillDownState extends StateNotifier<DrillDownStack> {
  DrillDownState() : super(DrillDownStack.empty());

  /// 下钻记录栈 (用于面包屑导航)
  void push(DrillDownRecord record) {
    state = state.push(record);
  }

  void pop() {
    state = state.pop();
  }

  void popTo(int index) {
    state = state.popTo(index);
  }

  /// 获取面包屑路径
  List<BreadcrumbItem> get breadcrumbs => state.toBreadcrumbs();
}

/// 下钻记录
class DrillDownRecord {
  final String screenName;
  final String displayName;
  final Map<String, dynamic> params;
  final DateTime timestamp;
}

/// 面包屑导航组件
class MoneyAgeBreadcrumb extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final breadcrumbs = ref.watch(drillDownProvider).breadcrumbs;

    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: Row(
        children: breadcrumbs.asMap().entries.map((entry) {
          final index = entry.key;
          final item = entry.value;
          final isLast = index == breadcrumbs.length - 1;

          return Row(
            children: [
              GestureDetector(
                onTap: isLast ? null : () {
                  ref.read(drillDownProvider.notifier).popTo(index);
                  Navigator.popUntil(context, (route) =>
                    route.settings.name == item.routeName);
                },
                child: Text(
                  item.displayName,
                  style: TextStyle(
                    color: isLast ? Colors.black : Colors.blue,
                    fontWeight: isLast ? FontWeight.bold : FontWeight.normal,
                  ),
                ),
              ),
              if (!isLast)
                const Padding(
                  padding: EdgeInsets.symmetric(horizontal: 8),
                  child: Icon(Icons.chevron_right, size: 16),
                ),
            ],
          );
        }).toList(),
      ),
    );
  }
}
```

### 10.9 联动数据缓存策略

```dart
/// 下钻数据预加载服务
class DrillDownPreloadService {
  final Map<String, CachedData> _cache = {};

  /// 预加载可能的下钻数据
  Future<void> preloadForScreen(String screenName, Map<String, dynamic> params) async {
    switch (screenName) {
      case 'money_age_detail':
        // 预加载资金池详情
        await _preloadAccountDetails(params['accountIds']);
        await _preloadVaultDetails(params['vaultIds']);
        break;

      case 'weekly_report':
        // 预加载每日交易数据
        await _preloadDailyTransactions(params['dateRange']);
        break;

      case 'vault_detail':
        // 预加载小金库交易和资金批次
        await _preloadVaultTransactions(params['vaultId']);
        await _preloadMoneyBatches(params['vaultId']);
        break;
    }
  }

  /// 获取缓存数据 (下钻时使用)
  T? getCached<T>(String key) {
    final cached = _cache[key];
    if (cached != null && !cached.isExpired) {
      return cached.data as T;
    }
    return null;
  }

  /// 清理过期缓存
  void cleanExpired() {
    _cache.removeWhere((_, v) => v.isExpired);
  }
}

class CachedData {
  final dynamic data;
  final DateTime cachedAt;
  final Duration ttl;

  bool get isExpired =>
    DateTime.now().difference(cachedAt) > ttl;
}
```

### 10.10 交互动画与过渡

```dart
/// 下钻过渡动画
class DrillDownTransition extends StatelessWidget {
  final Widget child;
  final DrillDownDirection direction;

  @override
  Widget build(BuildContext context) {
    return SlideTransition(
      position: Tween<Offset>(
        begin: direction == DrillDownDirection.down
            ? const Offset(0, 0.3)
            : const Offset(0.3, 0),
        end: Offset.zero,
      ).animate(CurvedAnimation(
        parent: ModalRoute.of(context)!.animation!,
        curve: Curves.easeOutCubic,
      )),
      child: FadeTransition(
        opacity: ModalRoute.of(context)!.animation!,
        child: child,
      ),
    );
  }
}

/// 数据高亮动画 (从来源位置展开)
class DataHighlightAnimation extends StatefulWidget {
  final String highlightId;  // 需要高亮的数据项ID
  final Widget child;

  @override
  State<DataHighlightAnimation> createState() => _DataHighlightAnimationState();
}

class _DataHighlightAnimationState extends State<DataHighlightAnimation>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<Color?> _colorAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    );

    _colorAnimation = ColorTween(
      begin: Colors.yellow.withOpacity(0.5),
      end: Colors.transparent,
    ).animate(_controller);

    // 延迟后开始高亮动画
    Future.delayed(const Duration(milliseconds: 300), () {
      _controller.forward();
    });
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _colorAnimation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            color: _colorAnimation.value,
            borderRadius: BorderRadius.circular(8),
          ),
          child: widget.child,
        );
      },
    );
  }
}
```

---

## 十一、总结

钱龄系统将成为应用的核心指标，通过零基预算的深度整合实现：

### 核心价值

1. **简单直观的数字** - 用户一眼就能了解财务健康状况
2. **游戏化目标** - 提升钱龄像升级一样有成就感
3. **可操作的建议** - 每个建议都能直接执行
4. **全模块联动** - 预算、储蓄、负债都与钱龄关联

### 零基预算整合价值

5. **小金库独立钱龄** - 每个小金库都有自己的资金年龄
6. **智能挪用建议** - 挪用时提示对钱龄的影响
7. **年度开支规划** - 预存策略让钱龄更稳定
8. **缓冲月目标** - 零基预算"花旧钱"原则的直接体现

### 最终目标

> 帮助用户从"月光族"成长为"财务自由者"
>
> 通过零基预算的"让每一分钱都有去处"，实现理财的终极目标——"花旧钱"
