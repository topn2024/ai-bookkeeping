# 启动管理控制台指南

## 当前状态诊断

### ✅ 已确认正常
- 服务器在线：39.105.12.124 可访问
- Nginx运行中：nginx/1.20.1
- 管理控制台已构建：本地 `admin-web/dist/` 目录存在

### ❌ 存在的问题
1. **HTTPS端口被阻止**：443端口连接超时
2. **所有HTTP请求强制重定向到HTTPS**
3. **无法访问管理控制台**

## 解决方案

### 方案一：开放443端口（推荐）

#### 步骤1: SSH登录服务器
```bash
ssh root@39.105.12.124
```

#### 步骤2: 开放443端口

**如果使用ufw防火墙：**
```bash
sudo ufw allow 443/tcp
sudo ufw reload
sudo ufw status
```

**如果使用firewall-cmd：**
```bash
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-ports
```

**如果使用iptables：**
```bash
sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -L -n | grep 443
```

#### 步骤3: 配置云服务器安全组

**阿里云：**
1. 登录阿里云控制台
2. 进入 ECS 实例详情
3. 点击"安全组" → "配置规则"
4. 添加入方向规则：
   - 端口范围：443/443
   - 授权对象：0.0.0.0/0
   - 协议类型：TCP

**腾讯云：**
1. 登录腾讯云控制台
2. 进入云服务器详情
3. 点击"安全组" → "添加规则"
4. 添加入站规则：
   - 类型：自定义TCP
   - 端口：443
   - 来源：0.0.0.0/0

#### 步骤4: 验证端口开放
```bash
# 在本地执行
curl -v https://39.105.12.124
```

### 方案二：使用自动化部署脚本

如果有SSH密钥访问权限，可以使用准备好的部署脚本：

```bash
cd /Users/beihua/code/baiji/ai-bookkeeping/admin-web
./deploy-to-39.sh
```

这个脚本会自动：
1. 构建管理控制台（如果需要）
2. 上传文件到服务器
3. 配置防火墙开放443端口
4. 重载Nginx配置

### 方案三：临时允许HTTP访问（不推荐生产环境）

如果需要立即访问，可以临时修改nginx配置：

```bash
ssh root@39.105.12.124

# 编辑nginx配置
vim /etc/nginx/sites-available/ai-bookkeeping.conf

# 找到并注释掉这些行（在80端口的server块中）：
# return 301 https://$server_name$request_uri;

# 添加：
location /admin-web {
    alias /var/www/admin-web;
    try_files $uri $uri/ /admin-web/index.html;
    index index.html;
}

# 保存并重载
nginx -t
systemctl reload nginx
```

然后可以通过 http://39.105.12.124/admin-web/ 访问（不安全）

## 部署管理控制台文件

如果服务器上还没有管理控制台文件：

```bash
# 1. 确保本地已构建
cd /Users/beihua/code/baiji/ai-bookkeeping/admin-web
npm run build

# 2. 上传到服务器
rsync -avz --delete ./dist/ root@39.105.12.124:/var/www/admin-web/

# 3. 配置nginx（如果还没配置）
ssh root@39.105.12.124

# 编辑nginx配置
vim /etc/nginx/sites-available/ai-bookkeeping.conf

# 在443端口的server块中添加：
location /admin-web {
    alias /var/www/admin-web;
    try_files $uri $uri/ /admin-web/index.html;
    index index.html;
}

# 重载nginx
nginx -t
systemctl reload nginx
```

## 验证部署

### 检查文件是否存在
```bash
ssh root@39.105.12.124 "ls -la /var/www/admin-web/"
```

### 检查nginx配置
```bash
ssh root@39.105.12.124 "nginx -t"
```

### 检查端口监听
```bash
ssh root@39.105.12.124 "netstat -tlnp | grep ':443'"
```

### 访问测试
```bash
# 测试HTTPS访问
curl -k https://39.105.12.124/admin-web/

# 应该返回HTML内容，而不是404或连接超时
```

## 访问地址

部署完成后，访问地址：
- **HTTPS**（推荐）：https://39.105.12.124/admin-web/
- **HTTP**（不推荐）：http://39.105.12.124/admin-web/（需要修改nginx配置）

## 默认管理员账户

如果是首次部署，需要在服务器上创建管理员账户：

```bash
ssh root@39.105.12.124

# 切换到应用目录
cd /home/ai-bookkeeping/app/server

# 激活虚拟环境
source /home/ai-bookkeeping/venv/bin/activate

# 创建管理员
python -m app.admin.create_admin
```

## 常见问题

### Q1: 443端口仍然无法访问？
A: 检查云服务器安全组配置，确保443端口在云服务商控制台中已开放。

### Q2: nginx配置正确但仍然404？
A: 检查 `/var/www/admin-web/` 目录是否有文件，nginx用户是否有读权限。

### Q3: 访问时提示证书错误？
A: 使用的是自签名证书，浏览器会警告。可以点击"继续访问"或配置正式的SSL证书。

### Q4: 无法SSH登录服务器？
A: 联系服务器管理员获取SSH密钥或密码。

## 技术支持

如需进一步帮助，请提供：
1. `curl -v https://39.105.12.124` 的完整输出
2. 服务器上的 nginx 错误日志：`tail -50 /var/log/nginx/error.log`
3. 防火墙规则：`iptables -L -n` 或 `ufw status`
