# 服务器数据同步方案

## 一、服务器现状

### 服务器1：160.202.238.29（主服务器）
- **用途**：开发和测试服务器
- **状态**：完整部署
- **组件**：
  - PostgreSQL数据库
  - MinIO对象存储
  - 后端API服务
  - 管理控制台

### 服务器2：39.105.12.124（新服务器）
- **用途**：生产服务器
- **状态**：部分部署
- **已部署**：
  - PostgreSQL数据库
  - 后端API服务（8000, 8001, 8002）
  - Nginx反向代理
  - 管理控制台（已部署）
- **缺失**：
  - MinIO对象存储（APK文件存储必需）

## 二、版本管理策略

### 版本一致性原则

**主版本号规则**：
- 遵循 `major.minor.patch+build` 格式
- 例如：`2.0.6+48`
- 每次发布自动递增build号

**当前版本状态**：
```
本地开发版本: 2.0.6+48（已包含交互式引导功能）
服务器1 (160.202.238.29): 需要检查
服务器2 (39.105.12.124): 需要检查
```

**版本发布流程**：
1. 本地开发并测试
2. 更新pubspec.yaml版本号
3. 构建APK
4. **同时**发布到两台服务器
5. 验证两台服务器版本一致

## 三、数据同步方案

### 方案A：主从复制（推荐用于数据库）

**架构**：
```
160.202.238.29 (主)  ──→  39.105.12.124 (从)
    [写入]                   [只读]
                  |
                  ├──> 流复制
                  └──> 定期同步
```

**优点**：
- 实时性高
- 数据一致性强
- 故障转移方便

**实现**：PostgreSQL主从流复制

### 方案B：定期同步（推荐用于对象存储和版本文件）

**同步内容**：
1. APK文件（MinIO）
2. 版本记录（数据库）
3. 用户数据（数据库）
4. 管理员配置

**同步频率**：
- 版本发布：实时同步
- 用户数据：每小时同步
- APK文件：版本发布时同步

### 方案C：双活模式（未来考虑）

**架构**：
```
160.202.238.29  ←──→  39.105.12.124
     [R/W]              [R/W]
         |                 |
         └─── 双向同步 ────┘
```

**优点**：
- 高可用
- 负载均衡

**缺点**：
- 复杂度高
- 需要解决冲突

## 四、立即执行的部署任务

### 任务1：在39.105.12.124安装MinIO

MinIO是对象存储服务，用于存储APK文件。

```bash
# SSH到服务器
ssh -i ~/.ssh/ai-bookkeeping-39 root@39.105.12.124

# 安装MinIO
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
mv minio /usr/local/bin/

# 创建数据目录
mkdir -p /data/minio
chown -R ai-bookkeeping:ai-bookkeeping /data/minio

# 创建systemd服务
cat > /etc/systemd/system/minio.service << 'EOF'
[Unit]
Description=MinIO Object Storage
After=network.target

[Service]
Type=notify
User=ai-bookkeeping
Group=ai-bookkeeping
Environment="MINIO_ROOT_USER=admin"
Environment="MINIO_ROOT_PASSWORD=YourSecurePassword"
ExecStart=/usr/local/bin/minio server /data/minio --console-address ":9001"
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启动MinIO
systemctl daemon-reload
systemctl enable minio
systemctl start minio

# 验证
systemctl status minio
curl http://localhost:9000/minio/health/live
```

### 任务2：配置数据库主从复制

#### 在主服务器（160.202.238.29）：

```bash
# 1. 修改PostgreSQL配置
sudo -u postgres psql << EOF
-- 创建复制用户
CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'repl_password';

-- 配置pg_hba.conf
\! echo "host replication replicator 39.105.12.124/32 md5" >> /var/lib/pgsql/data/pg_hba.conf
EOF

# 2. 修改postgresql.conf
cat >> /var/lib/pgsql/data/postgresql.conf << EOF
wal_level = replica
max_wal_senders = 3
wal_keep_size = 64
EOF

# 3. 重启PostgreSQL
systemctl restart postgresql
```

#### 在从服务器（39.105.12.124）：

```bash
# 1. 停止PostgreSQL
systemctl stop postgresql

# 2. 清空数据目录
rm -rf /var/lib/pgsql/data/*

# 3. 从主服务器复制数据
pg_basebackup -h 160.202.238.29 -U replicator -D /var/lib/pgsql/data -Fp -Xs -P -R

# 4. 启动PostgreSQL
systemctl start postgresql

# 5. 验证复制状态
sudo -u postgres psql -c "SELECT * FROM pg_stat_wal_receiver;"
```

### 任务3：创建同步脚本

#### APK文件同步脚本

```bash
# /home/ai-bookkeeping/scripts/sync_apk.sh
#!/bin/bash
# APK文件同步脚本

SOURCE_HOST="160.202.238.29"
SOURCE_PATH="/data/minio/apks"
TARGET_PATH="/data/minio/apks"

echo "[$(date)] 开始同步APK文件..."

# 使用rsync同步
rsync -avz --progress \
  -e "ssh -i /root/.ssh/sync_key" \
  ai-bookkeeping@${SOURCE_HOST}:${SOURCE_PATH}/ \
  ${TARGET_PATH}/

if [ $? -eq 0 ]; then
    echo "[$(date)] APK文件同步成功"
else
    echo "[$(date)] APK文件同步失败"
    exit 1
fi
```

#### 定期同步cron任务

```bash
# 在39.105.12.124上配置crontab
crontab -e

# 添加以下内容：
# 每小时同步APK文件
0 * * * * /home/ai-bookkeeping/scripts/sync_apk.sh >> /var/log/sync_apk.log 2>&1

# 每天凌晨2点备份数据库
0 2 * * * /home/ai-bookkeeping/scripts/backup_db.sh >> /var/log/backup_db.log 2>&1
```

### 任务4：版本一致性检查脚本

```bash
#!/bin/bash
# /home/ai-bookkeeping/scripts/check_version_consistency.sh
# 检查两台服务器版本一致性

SERVER1="160.202.238.29"
SERVER2="39.105.12.124"

echo "=== 版本一致性检查 ==="
echo ""

# 检查服务器1
echo "服务器1 ($SERVER1):"
VERSION1=$(curl -s http://${SERVER1}/admin/app-versions/latest | jq -r '.version_name + "+" + (.version_code|tostring)')
echo "  最新版本: $VERSION1"

# 检查服务器2
echo ""
echo "服务器2 ($SERVER2):"
VERSION2=$(curl -k -s https://${SERVER2}/admin/app-versions/latest | jq -r '.version_name + "+" + (.version_code|tostring)')
echo "  最新版本: $VERSION2"

echo ""
if [ "$VERSION1" = "$VERSION2" ]; then
    echo "✓ 版本一致"
    exit 0
else
    echo "✗ 版本不一致！需要同步"
    exit 1
fi
```

## 五、统一发布脚本

### 改进的发布脚本（发布到两台服务器）

```bash
#!/bin/bash
# 统一发布到两台服务器

VERSION="2.0.6"
CODE="48"
NOTES="实现交互式页面引导功能"

SERVERS=(
    "160.202.238.29:http"
    "39.105.12.124:https"
)

echo "=========================================="
echo "统一发布 v${VERSION}+${CODE}"
echo "=========================================="

# 1. 构建APK
echo "[1/4] 构建APK..."
cd app
flutter clean
flutter pub get
flutter build apk --release --no-tree-shake-icons
cd ..

APK_PATH="app/build/app/outputs/flutter-apk/app-release.apk"

# 2. 发布到服务器1
echo ""
echo "[2/4] 发布到服务器1 (160.202.238.29)..."
API_BASE_URL="http://160.202.238.29" \
ADMIN_PASSWORD="admin123" \
./scripts/publish_apk.sh \
  --version "$VERSION" \
  --code "$CODE" \
  --notes "$NOTES" \
  --apk "$APK_PATH" \
  --publish

# 3. 发布到服务器2
echo ""
echo "[3/4] 发布到服务器2 (39.105.12.124)..."
API_BASE_URL="https://39.105.12.124" \
ADMIN_PASSWORD="admin123" \
./scripts/publish_apk.sh \
  --version "$VERSION" \
  --code "$CODE" \
  --notes "$NOTES" \
  --apk "$APK_PATH" \
  --publish

# 4. 验证一致性
echo ""
echo "[4/4] 验证版本一致性..."
./scripts/check_version_consistency.sh

echo ""
echo "=========================================="
echo "✅ 统一发布完成！"
echo "=========================================="
```

## 六、监控和告警

### 1. 版本一致性监控

```bash
# 每小时检查一次版本一致性
*/60 * * * * /home/ai-bookkeeping/scripts/check_version_consistency.sh || echo "版本不一致警告" | mail -s "服务器版本不一致" admin@example.com
```

### 2. 同步状态监控

```bash
# 监控数据库复制延迟
*/5 * * * * sudo -u postgres psql -c "SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS replication_delay_seconds;" | mail -s "Replication Status" admin@example.com
```

### 3. APK文件完整性检查

```bash
#!/bin/bash
# 检查两台服务器的APK文件是否一致

for server in $SERVERS; do
    echo "检查 $server ..."
    ssh $server "md5sum /data/minio/apks/*.apk"
done
```

## 七、故障恢复

### 场景1：主服务器故障

1. 将从服务器（39.105.12.124）提升为主服务器
2. 停止复制：`sudo -u postgres psql -c "SELECT pg_promote();"`
3. 更新DNS/负载均衡指向新主服务器

### 场景2：从服务器故障

1. 修复服务器问题
2. 重新执行主从复制配置
3. 从主服务器重新同步数据

### 场景3：数据不一致

1. 停止两台服务器的写入
2. 从主服务器全量导出数据
3. 导入到从服务器
4. 重新启动复制

## 八、执行清单

### 立即执行（优先级P0）

- [ ] 在39.105.12.124安装MinIO
- [ ] 配置MinIO访问密钥
- [ ] 测试APK上传功能
- [ ] 创建统一发布脚本
- [ ] 发布v2.0.6到两台服务器

### 本周内完成（优先级P1）

- [ ] 配置PostgreSQL主从复制
- [ ] 创建APK同步脚本
- [ ] 配置定期同步cron任务
- [ ] 创建版本一致性检查脚本
- [ ] 设置监控告警

### 本月内完成（优先级P2）

- [ ] 完善故障恢复文档
- [ ] 建立备份策略
- [ ] 实施自动化测试
- [ ] 性能优化

## 九、注意事项

1. **密码安全**：
   - 所有密码使用环境变量或密钥管理工具
   - 定期更换密码
   - 使用强密码

2. **网络安全**：
   - 限制数据库复制只能从特定IP访问
   - 使用SSL/TLS加密传输
   - 配置防火墙规则

3. **数据备份**：
   - 定期备份两台服务器的数据
   - 异地存储备份文件
   - 定期测试恢复流程

4. **版本回滚**：
   - 保留历史APK文件
   - 记录每次发布的详细信息
   - 准备回滚脚本

## 十、联系人

- **运维负责人**：[待填写]
- **开发负责人**：[待填写]
- **紧急联系电话**：[待填写]
