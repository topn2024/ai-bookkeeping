# ä¸€é”®å¼è‡ªåŠ¨å‘å¸ƒæŒ‡å—

## ðŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šäº¤äº’å¼å‘å¸ƒï¼ˆæŽ¨èæ–°æ‰‹ï¼‰

```bash
cd /Users/beihua/code/baiji/ai-bookkeeping
./release.sh
```

è„šæœ¬ä¼šå¼•å¯¼æ‚¨å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼ŒåŒ…æ‹¬ï¼š
- è‡ªåŠ¨ä»Žpubspec.yamlè¯»å–ç‰ˆæœ¬ä¿¡æ¯
- è¯¢é—®æ˜¯å¦ç”Ÿæˆå¢žé‡è¡¥ä¸
- è¯¢é—®æœåŠ¡å™¨åœ°å€
- è¯¢é—®æ˜¯å¦å¼ºåˆ¶æ›´æ–°
- è‡ªåŠ¨ä½¿ç”¨å‘å¸ƒè¯´æ˜Žæ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œå‘å¸ƒï¼ˆæŽ¨èç†Ÿç»ƒç”¨æˆ·ï¼‰

```bash
# åŸºæœ¬ç”¨æ³•ï¼ˆæ— è¡¥ä¸ï¼‰
python3 auto_release.py --version 2.0.3 --code 43

# å¸¦å¢žé‡è¡¥ä¸
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --previous-version 2.0.2 \
  --previous-code 42

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --previous-version 2.0.2 \
  --previous-code 42 \
  --base-url http://160.202.238.29:8000 \
  --admin-user admin \
  --force-update \
  --release-notes RELEASE_NOTES_2.0.3.md
```

## ðŸ“‹ å‰ç½®å‡†å¤‡

### 1. å®‰è£…ä¾èµ–

```bash
# Pythonä¾èµ–
pip install requests bsdiff4

# FlutterçŽ¯å¢ƒ
flutter doctor  # ç¡®ä¿çŽ¯å¢ƒæ­£å¸¸
```

### 2. å‡†å¤‡ç®¡ç†å‘˜è´¦å·

ç¡®ä¿æ‚¨æœ‰ç®¡ç†åŽå°çš„ç™»å½•å‡­æ®ï¼š
- ç”¨æˆ·åï¼ˆé»˜è®¤ï¼šadminï¼‰
- å¯†ç 

### 3. å‡†å¤‡æ—§ç‰ˆæœ¬APKï¼ˆå¯é€‰ï¼‰

å¦‚æžœè¦ç”Ÿæˆå¢žé‡è¡¥ä¸ï¼Œéœ€è¦ä¿å­˜æ—§ç‰ˆæœ¬APKåˆ° `dist/` ç›®å½•ï¼š

```bash
mkdir -p dist
cp app/build/app/outputs/flutter-apk/app-release.apk dist/ai_bookkeeping_2.0.2.apk
```

## ðŸ”§ è„šæœ¬åŠŸèƒ½

### auto_release.py - æ ¸å¿ƒè‡ªåŠ¨åŒ–è„šæœ¬

**è‡ªåŠ¨å®Œæˆçš„æ­¥éª¤ï¼š**

1. âœ… **æž„å»ºAPK** - æ¸…ç†ã€èŽ·å–ä¾èµ–ã€æž„å»ºreleaseç‰ˆæœ¬
2. âœ… **ç”Ÿæˆè¡¥ä¸** - ä½¿ç”¨bsdiffç”Ÿæˆå¢žé‡æ›´æ–°æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
3. âœ… **ç™»å½•åŽå°** - è‡ªåŠ¨ç™»å½•ç®¡ç†åŽå°èŽ·å–token
4. âœ… **åˆ›å»ºç‰ˆæœ¬** - åœ¨æ•°æ®åº“åˆ›å»ºç‰ˆæœ¬è®°å½•ï¼ˆè‰ç¨¿çŠ¶æ€ï¼‰
5. âœ… **ä¸Šä¼ APK** - ä¸Šä¼ APKæ–‡ä»¶åˆ°MinIOå¯¹è±¡å­˜å‚¨
6. âœ… **ä¸Šä¼ Patch** - ä¸Šä¼ è¡¥ä¸æ–‡ä»¶åˆ°MinIOï¼ˆå¦‚æžœæœ‰ï¼‰
7. âœ… **å‘å¸ƒç‰ˆæœ¬** - å°†ç‰ˆæœ¬çŠ¶æ€æ”¹ä¸ºå·²å‘å¸ƒï¼Œç”¨æˆ·å¯è§

**å‚æ•°è¯´æ˜Žï¼š**

```
å¿…éœ€å‚æ•°:
  --version, -v      ç‰ˆæœ¬åç§°ï¼Œä¾‹å¦‚ï¼š2.0.3
  --code, -c         ç‰ˆæœ¬å·ï¼ˆæ•´æ•°ï¼‰ï¼Œä¾‹å¦‚ï¼š43

å¯é€‰å‚æ•°:
  --previous-version  ä¸Šä¸€ä¸ªç‰ˆæœ¬åç§°ï¼ˆç”¨äºŽç”Ÿæˆè¡¥ä¸ï¼‰
  --previous-code     ä¸Šä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆç”¨äºŽç”Ÿæˆè¡¥ä¸ï¼‰
  --base-url         æœåŠ¡å™¨åœ°å€ï¼ˆé»˜è®¤ï¼šhttp://localhost:8000ï¼‰
  --admin-user       ç®¡ç†å‘˜ç”¨æˆ·åï¼ˆé»˜è®¤ï¼šadminï¼‰
  --admin-password   ç®¡ç†å‘˜å¯†ç ï¼ˆä¸æä¾›åˆ™æç¤ºè¾“å…¥ï¼‰
  --force-update     è®¾ç½®ä¸ºå¼ºåˆ¶æ›´æ–°
  --release-notes    æ›´æ–°è¯´æ˜Žæ–‡æœ¬æˆ–æ–‡ä»¶è·¯å¾„
  --no-build         è·³è¿‡æž„å»ºï¼Œä½¿ç”¨å·²æœ‰APK
```

### release.sh - äº¤äº’å¼å¿«æ·è„šæœ¬

å°è£…äº†auto_release.pyï¼Œæä¾›å‹å¥½çš„äº¤äº’ç•Œé¢ï¼š
- è‡ªåŠ¨è¯»å–ç‰ˆæœ¬ä¿¡æ¯
- äº¤äº’å¼è¯¢é—®å„é¡¹é…ç½®
- è‡ªåŠ¨ä¿å­˜APKåˆ°distç›®å½•

## ðŸ“ å‘å¸ƒæµç¨‹ç¤ºä¾‹

### åœºæ™¯1: é¦–æ¬¡å‘å¸ƒï¼ˆæ— æ—§ç‰ˆæœ¬ï¼‰

```bash
# 1. ç¡®ä¿ç‰ˆæœ¬å·å·²æ›´æ–°
vim app/pubspec.yaml  # version: 2.0.3+43

# 2. å‡†å¤‡å‘å¸ƒè¯´æ˜Ž
cat > RELEASE_NOTES_2.0.3.md << 'EOF'
# ç‰ˆæœ¬ 2.0.3 æ›´æ–°è¯´æ˜Ž

## Bugä¿®å¤
- ä¿®å¤å¯†ç æ‰¾å›žé‚®ä»¶å‘é€é—®é¢˜
EOF

# 3. æ‰§è¡Œå‘å¸ƒ
./release.sh
# æˆ–
python3 auto_release.py --version 2.0.3 --code 43
```

### åœºæ™¯2: æ›´æ–°å‘å¸ƒï¼ˆæœ‰æ—§ç‰ˆæœ¬ï¼Œç”Ÿæˆè¡¥ä¸ï¼‰

```bash
# 1. ç¡®ä¿æ—§ç‰ˆæœ¬APKå·²ä¿å­˜
ls dist/ai_bookkeeping_2.0.2.apk

# 2. æ›´æ–°ç‰ˆæœ¬å·
vim app/pubspec.yaml  # version: 2.0.3+43

# 3. æ‰§è¡Œå‘å¸ƒï¼ˆå¸¦è¡¥ä¸ï¼‰
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --previous-version 2.0.2 \
  --previous-code 42 \
  --release-notes RELEASE_NOTES_2.0.3.md
```

### åœºæ™¯3: è·³è¿‡æž„å»ºï¼ˆAPKå·²å‡†å¤‡å¥½ï¼‰

```bash
# å¦‚æžœå·²ç»æ‰‹åŠ¨æž„å»ºäº†APK
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --no-build
```

### åœºæ™¯4: å¼ºåˆ¶æ›´æ–°

```bash
# å…³é”®æ›´æ–°ï¼Œè¦æ±‚ç”¨æˆ·å¿…é¡»å‡çº§
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --force-update
```

## ðŸŽ¯ å‘å¸ƒåˆ°è¿œç¨‹æœåŠ¡å™¨

```bash
# å‘å¸ƒåˆ°ç”Ÿäº§æœåŠ¡å™¨
python3 auto_release.py \
  --version 2.0.3 \
  --code 43 \
  --base-url http://160.202.238.29:8000 \
  --admin-user admin \
  --release-notes RELEASE_NOTES_2.0.3.md
```

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜1: æž„å»ºå¤±è´¥

```bash
# æ£€æŸ¥FlutterçŽ¯å¢ƒ
flutter doctor

# æ¸…ç†å¹¶é‡è¯•
cd app
flutter clean
flutter pub get
flutter build apk --release
```

### é—®é¢˜2: ç™»å½•å¤±è´¥

```
âœ— ç™»å½•å¤±è´¥: 401 - {"detail":"Incorrect credentials"}
```

**è§£å†³æ–¹æ³•ï¼š**
- æ£€æŸ¥ç®¡ç†å‘˜ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦å¯è®¿é—®
- ç¡®è®¤ç®¡ç†åŽå°æœåŠ¡æ­£å¸¸è¿è¡Œ

### é—®é¢˜3: ä¸Šä¼ å¤±è´¥

```
âœ— APKä¸Šä¼ å¤±è´¥: Connection timeout
```

**è§£å†³æ–¹æ³•ï¼š**
- æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
- æ£€æŸ¥MinIOæœåŠ¡æ˜¯å¦è¿è¡Œ
- å¢žåŠ è¶…æ—¶æ—¶é—´ï¼ˆè„šæœ¬ä¸­é»˜è®¤5åˆ†é’Ÿï¼‰

### é—®é¢˜4: bsdiff4æœªå®‰è£…

```
âš  bsdiff4æœªå®‰è£…ï¼Œè·³è¿‡è¡¥ä¸ç”Ÿæˆ
```

**è§£å†³æ–¹æ³•ï¼š**
```bash
pip install bsdiff4
```

### é—®é¢˜5: ç‰ˆæœ¬å·²å­˜åœ¨

```
âœ— ç‰ˆæœ¬åˆ›å»ºå¤±è´¥: 400 - {"detail":"è¯¥ç‰ˆæœ¬å·å·²å­˜åœ¨"}
```

**è§£å†³æ–¹æ³•ï¼š**
- æ›´æ–°ç‰ˆæœ¬å·ï¼ˆversionå’Œcodeéƒ½è¦é€’å¢žï¼‰
- æˆ–è€…åœ¨ç®¡ç†åŽå°åˆ é™¤è‰ç¨¿ç‰ˆæœ¬

## ðŸ“Š è¾“å‡ºç¤ºä¾‹

æˆåŠŸå‘å¸ƒçš„å®Œæ•´è¾“å‡ºï¼š

```
============================================================
ðŸš€ AIæ™ºèƒ½è®°è´¦ - ä¸€é”®å¼è‡ªåŠ¨å‘å¸ƒ
============================================================
ç‰ˆæœ¬: 2.0.3 (Build 43)
æœåŠ¡å™¨: http://localhost:8000

[æ­¥éª¤ 1/7] æž„å»ºAndroid APK
  æ¸…ç†ä¹‹å‰çš„æž„å»º...
  èŽ·å–ä¾èµ–...
  æž„å»ºrelease APKï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰...
âœ“ APKæž„å»ºæˆåŠŸ: /path/to/app-release.apk
    å¤§å°: 23.4 MB

[æ­¥éª¤ 2/7] ç”Ÿæˆå¢žé‡è¡¥ä¸
  åŸºç¡€ç‰ˆæœ¬: /path/to/ai_bookkeeping_2.0.2.apk
  ç›®æ ‡ç‰ˆæœ¬: /path/to/app-release.apk
âœ“ è¡¥ä¸ç”ŸæˆæˆåŠŸ: /path/to/update.patch
    å¤§å°: 3.2 MB (èŠ‚çœ 86.3%)

[æ­¥éª¤ 3/7] ç™»å½•ç®¡ç†åŽå°
âœ“ ç™»å½•æˆåŠŸ

[æ­¥éª¤ 4/7] åˆ›å»ºç‰ˆæœ¬è®°å½•
âœ“ ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ: 2.0.3+43
    ç‰ˆæœ¬ID: 550e8400-e29b-41d4-a716-446655440000

[æ­¥éª¤ 5/7] ä¸Šä¼ APKåˆ°MinIO
âœ“ APKä¸Šä¼ æˆåŠŸ
    URL: http://localhost:9000/ai-bookkeeping/app-releases/android/2.0.3/app-release-43.apk
    å¤§å°: 23.4 MB
    MD5: a1b2c3d4e5f6...

[æ­¥éª¤ 6/7] ä¸Šä¼ å¢žé‡è¡¥ä¸åˆ°MinIO
âœ“ è¡¥ä¸ä¸Šä¼ æˆåŠŸ
    URL: http://localhost:9000/ai-bookkeeping/app-releases/android/2.0.3/patch-42-to-43.patch
    å¤§å°: 3.2 MB
    åŸºç¡€ç‰ˆæœ¬: 2.0.2+42

[æ­¥éª¤ 7/7] å‘å¸ƒç‰ˆæœ¬
âœ“ ç‰ˆæœ¬å‘å¸ƒæˆåŠŸ: 2.0.3+43
    å‘å¸ƒæ—¶é—´: 2026-01-11T10:30:00

============================================================
âœ… å‘å¸ƒå®Œæˆï¼
============================================================
ç‰ˆæœ¬ 2.0.3+43 å·²æˆåŠŸå‘å¸ƒ

ç”¨æˆ·å¯ä»¥é€šè¿‡åº”ç”¨å†…æ›´æ–°åŠŸèƒ½èŽ·å–æ–°ç‰ˆæœ¬
```

## ðŸ“‚ æ–‡ä»¶ç»“æž„

```
ai-bookkeeping/
â”œâ”€â”€ auto_release.py           # æ ¸å¿ƒè‡ªåŠ¨åŒ–è„šæœ¬
â”œâ”€â”€ release.sh                # äº¤äº’å¼å¿«æ·è„šæœ¬
â”œâ”€â”€ quick_build.sh            # ä»…æž„å»ºAPKï¼ˆä¸å‘å¸ƒï¼‰
â”œâ”€â”€ RELEASE_NOTES_2.0.3.md   # å‘å¸ƒè¯´æ˜Ž
â”œâ”€â”€ dist/                     # åŽ†å²ç‰ˆæœ¬APKå­˜æ¡£
â”‚   â””â”€â”€ ai_bookkeeping_2.0.2.apk
â”œâ”€â”€ temp_release/             # ä¸´æ—¶æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
â””â”€â”€ app/
    â””â”€â”€ build/app/outputs/flutter-apk/
        â””â”€â”€ app-release.apk   # æž„å»ºè¾“å‡º
```

## ðŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ä¸è¦åœ¨å‘½ä»¤è¡Œä¸­ç›´æŽ¥è¾“å…¥å¯†ç **
   - å»ºè®®çœç•¥ `--admin-password` å‚æ•°ï¼Œè„šæœ¬ä¼šå®‰å…¨åœ°æç¤ºè¾“å…¥

2. **ä¸è¦æäº¤.envæ–‡ä»¶**
   - æ•æ„Ÿé…ç½®åº”é€šè¿‡çŽ¯å¢ƒå˜é‡æˆ–.envæ–‡ä»¶ç®¡ç†

3. **ä¿æŠ¤ç®¡ç†å‘˜å‡­æ®**
   - å®šæœŸæ›´æ¢ç®¡ç†å‘˜å¯†ç 
   - ä½¿ç”¨å¼ºå¯†ç 

## ðŸ’¡ æœ€ä½³å®žè·µ

1. **ç‰ˆæœ¬å·ç®¡ç†**
   - version nameéµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemVerï¼‰ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢å·
   - version codeæ¯æ¬¡é€’å¢žï¼Œä¸å¯é‡å¤

2. **å‘å¸ƒè¯´æ˜Ž**
   - æ¯æ¬¡å‘å¸ƒéƒ½åº”å‡†å¤‡è¯¦ç»†çš„å‘å¸ƒè¯´æ˜Ž
   - ä½¿ç”¨Markdownæ ¼å¼ä¾¿äºŽé˜…è¯»

3. **å¢žé‡æ›´æ–°**
   - ä¿ç•™æœ€è¿‘2-3ä¸ªç‰ˆæœ¬çš„APKç”¨äºŽç”Ÿæˆè¡¥ä¸
   - è¡¥ä¸å¯ä»¥å¤§å¹…å‡å°‘ç”¨æˆ·ä¸‹è½½é‡ï¼ˆé€šå¸¸èŠ‚çœ80-90%ï¼‰

4. **æµ‹è¯•éªŒè¯**
   - å‘å¸ƒå‰åœ¨æµ‹è¯•è®¾å¤‡ä¸ŠéªŒè¯APK
   - æ£€æŸ¥åº”ç”¨å†…æ›´æ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸

5. **å¤‡ä»½ç®¡ç†**
   - å°†æ¯ä¸ªå‘å¸ƒçš„APKä¿å­˜åˆ°distç›®å½•
   - å®šæœŸå¤‡ä»½distç›®å½•åˆ°äº‘ç«¯

## ðŸŽ“ è¿›é˜¶ç”¨æ³•

### é›†æˆåˆ°CI/CD

```yaml
# .github/workflows/release.yml
name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v2
      - run: pip install requests bsdiff4
      - run: |
          python3 auto_release.py \
            --version ${{ github.ref_name }} \
            --code ${{ github.run_number }} \
            --base-url ${{ secrets.SERVER_URL }} \
            --admin-password ${{ secrets.ADMIN_PASSWORD }}
```

### æ‰¹é‡ç®¡ç†å¤šä¸ªç‰ˆæœ¬

```bash
# æŸ¥çœ‹æ‰€æœ‰å·²å‘å¸ƒç‰ˆæœ¬
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/admin/app-versions

# åºŸå¼ƒæ—§ç‰ˆæœ¬
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/admin/app-versions/$VERSION_ID/deprecate
```

## ðŸ“ž èŽ·å–å¸®åŠ©

```bash
# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
python3 auto_release.py --help

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
python3 auto_release.py --version
```
