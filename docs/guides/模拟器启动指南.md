# Android 模拟器启动指南 - 使用ADB端口5038

## 当前状态

### ✅ 已完成
- ADB服务器已配置在端口5038（避开被占用的5037端口）
- 模拟器进程正在运行
- 模拟器系统已完全启动

### ⚠️ 问题
- ADB无法稳定连接到模拟器
- 设备显示为"offline"或不显示

## 快速启动步骤

### 方法1: 使用PowerShell脚本（推荐）

```powershell
# 启动模拟器和ADB
.\scripts\launch_emulator_5038.ps1

# 等待30-60秒后检查状态
.\scripts\check_emulator_status.ps1
```

### 方法2: 手动启动

#### 步骤1: 启动ADB服务器（端口5038）
```powershell
# 设置环境变量
$env:ANDROID_ADB_SERVER_PORT = "5038"

# 启动ADB服务器
D:\Android\Sdk\platform-tools\adb.exe -P 5038 start-server
```

#### 步骤2: 启动模拟器
```powershell
# 打开模拟器窗口
Start-Process D:\Android\Sdk\emulator\emulator.exe -ArgumentList "-avd AI_Bookkeeping_Emulator -gpu swiftshader_indirect"
```

#### 步骤3: 等待启动（30-60秒）
模拟器窗口会打开并显示Android启动画面。

#### 步骤4: 检查设备连接
```powershell
# 检查设备列表
D:\Android\Sdk\platform-tools\adb.exe -P 5038 devices

# 应该看到类似:
# List of devices attached
# emulator-5554    device
```

## 在Flutter中使用模拟器

### 配置Flutter使用端口5038的ADB

#### 选项A: 临时设置（每次终端会话）
```powershell
# PowerShell
$env:ANDROID_ADB_SERVER_PORT = "5038"
flutter devices
flutter run
```

#### 选项B: 永久设置（推荐）
```powershell
# 设置用户环境变量
[Environment]::SetEnvironmentVariable('ANDROID_ADB_SERVER_PORT', '5038', 'User')

# 重启终端后生效
flutter devices
flutter run
```

## 故障排除

### 问题1: 设备显示offline

**原因**: ADB和模拟器连接不稳定

**解决方案**:
```powershell
# 1. 重启ADB服务器
D:\Android\Sdk\platform-tools\adb.exe -P 5038 kill-server
D:\Android\Sdk\platform-tools\adb.exe -P 5038 start-server

# 2. 等待几秒
Start-Sleep -Seconds 5

# 3. 检查设备
D:\Android\Sdk\platform-tools\adb.exe -P 5038 devices
```

### 问题2: 找不到设备

**原因**: 模拟器还在启动中或ADB连接丢失

**解决方案**:
```powershell
# 1. 确认模拟器进程正在运行
Get-Process | Where-Object {$_.ProcessName -like "*emulator*"}

# 2. 等待更长时间（模拟器首次启动可能需要1-2分钟）

# 3. 手动连接到模拟器
D:\Android\Sdk\platform-tools\adb.exe -P 5038 connect 127.0.0.1:5554
```

### 问题3: 模拟器无法启动

**原因**: 系统资源不足或配置问题

**解决方案**:
```powershell
# 1. 关闭其他占用资源的程序

# 2. 使用软件渲染启动
D:\Android\Sdk\emulator\emulator.exe -avd AI_Bookkeeping_Emulator -gpu swiftshader_indirect

# 3. 查看模拟器日志
D:\Android\Sdk\emulator\emulator.exe -avd AI_Bookkeeping_Emulator -verbose
```

## 替代方案: 直接构建APK并手动安装

如果模拟器连接问题持续存在，可以：

### 1. 构建APK
```bash
cd D:\code\ai-bookkeeping\app
flutter build apk --no-tree-shake-icons
```

### 2. 找到APK文件
```
D:\code\ai-bookkeeping\app\build\app\outputs\flutter-apk\app-release.apk
```

### 3. 安装选项

#### 选项A: 拖放安装
1. 等待模拟器完全启动
2. 将APK文件拖放到模拟器窗口
3. 点击安装

#### 选项B: 使用ADB安装
```powershell
D:\Android\Sdk\platform-tools\adb.exe -P 5038 install -r D:\code\ai-bookkeeping\app\build\app\outputs\flutter-apk\app-release.apk
```

#### 选项C: 通过模拟器文件管理器
1. 在模拟器中打开文件管理器
2. 找到共享文件夹中的APK
3. 点击安装

## 已创建的脚本

| 脚本 | 用途 |
|------|------|
| `scripts/start_adb_5038.ps1` | 启动ADB服务器在端口5038 |
| `scripts/launch_emulator_5038.ps1` | 启动模拟器（使用5038端口） |
| `scripts/check_emulator_status.ps1` | 检查模拟器和ADB状态 |

## 技术说明

### 为什么使用端口5038？

默认的ADB端口5037被Windows系统服务（svchost）占用，导致ADB无法启动。使用替代端口5038可以避开这个冲突。

### 如何让Flutter识别使用5038端口的ADB？

通过设置环境变量`ANDROID_ADB_SERVER_PORT=5038`，Flutter会自动使用指定端口的ADB服务器。

### 模拟器位置变化的影响

由于我们迁移了Android配置到D盘：
- AVD配置: `D:\Android\.android\avd`
- 系统镜像: `D:\Android\Sdk\system-images`
- 模拟器可执行文件: `D:\Android\Sdk\emulator`

所有路径都已正确配置，不影响使用。

## 快速参考命令

```powershell
# 设置ADB端口
$env:ANDROID_ADB_SERVER_PORT = "5038"

# ADB常用命令
D:\Android\Sdk\platform-tools\adb.exe -P 5038 devices          # 列出设备
D:\Android\Sdk\platform-tools\adb.exe -P 5038 shell            # 进入设备shell
D:\Android\Sdk\platform-tools\adb.exe -P 5038 logcat          # 查看日志
D:\Android\Sdk\platform-tools\adb.exe -P 5038 install app.apk # 安装应用

# Flutter命令（需先设置ANDROID_ADB_SERVER_PORT）
flutter devices       # 查看设备
flutter run           # 运行应用
flutter install       # 安装应用
flutter logs          # 查看日志
```

## 注意事项

1. **每次打开新终端**: 需要重新设置`ANDROID_ADB_SERVER_PORT`环境变量，或者永久设置到系统环境变量中。

2. **模拟器启动时间**: 首次启动可能需要1-2分钟，后续启动会快一些。

3. **资源需求**: 模拟器需要较多内存（建议系统有8GB+RAM）。

4. **ADB连接稳定性**: 如果连接不稳定，可以尝试重启ADB服务器或重启模拟器。

---

**创建时间**: 2025-12-28
**状态**: 模拟器可以启动，ADB配置在5038端口
