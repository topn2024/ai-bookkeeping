# 权利要求书

## 离线优先的财务数据增量同步方法及系统

### 独立权利要求

**权利要求1**：一种离线优先的财务数据增量同步方法，其特征在于，包括以下步骤：

S1. 金额精度保护步骤：
- 本地存储采用Decimal(18,2)类型，精确到分；
- 网络传输采用字符串格式，避免浮点数精度损失；
- 运算采用银行家舍入法，保证财务计算精度；

S2. 交易原子性保证步骤：
- 使用写前日志（WAL）保证操作可恢复；
- 采用两阶段提交（2PC）协议保证分布式原子性；
- 转账操作、预算扣减、资金池操作作为原子事务执行；

S3. 财务一致性约束检查步骤：
- 账户余额一致性：account_balance = Σ(income) - Σ(expense)；
- 预算一致性：budget_spent = Σ(transactions in budget_period)；
- 资金池一致性：pool_balance = pool_initial + Σ(deposits) - Σ(withdrawals)；
- 借贷平衡：Σ(debit) = Σ(credit)；

S4. 财务语义级冲突解决步骤：
- 金额字段：采用Multi-Value Register策略，保留所有版本供用户选择；
- 交易时间字段：保留最早时间；
- 分类字段：优先主设备；
- 备注字段：采用操作变换（OT）算法合并；

S5. 离线数据完整性验证步骤：
- 每100个操作创建检查点；
- 离线后验证数据完整性；
- 账户余额不一致时自动生成调整分录。

**权利要求2**：一种离线优先的财务数据增量同步系统，其特征在于，包括：

精度保护模块：用于金额数据的精确存储和传输；

原子性保证模块：用于实现两阶段提交和写前日志；

一致性检查模块：用于验证财务数据一致性约束；

冲突解决模块：用于财务语义级的冲突检测与解决；

完整性验证模块：用于离线数据的完整性校验和恢复。

### 从属权利要求

**权利要求3**：根据权利要求1所述的方法，其特征在于，所述金额精度保护还包括：

- 序列化格式：JSON.stringify({amount: "1234.56"})；
- 反序列化：amount = Decimal(JSON.parse(data).amount)；
- 校验和：checksum = SHA256(amount_string)。

**权利要求4**：根据权利要求1所述的方法，其特征在于，所述基于交易时间戳的冲突解决包括：

- 交易时间优先：保留交易时间更早的版本；
- 编辑时间辅助：交易时间相同时，保留编辑时间更晚的版本；
- 设备优先级：时间完全相同时，主设备>从设备。

**权利要求5**：根据权利要求1所述的方法，其特征在于，所述基于金额差异的智能分析包括：

- 小额差异（<1元）：可能是舍入误差，展示差异原因；
- 整数倍差异：可能是数量错误，建议检查交易数量；
- 大额差异（>10%）：可能是不同交易，建议确认。

**权利要求6**：根据权利要求1所述的方法，其特征在于，还包括预算同步优化：

- 预算配置同步：高优先级，最后写入胜出（LWW）；
- 预算消费同步：高优先级，采用PN-Counter累加合并；
- 预算调整同步：中优先级，批量同步。

**权利要求7**：根据权利要求1所述的方法，其特征在于，还包括资金池同步优化：

- 资金池余额：采用PN-Counter数据结构，无冲突自动合并；
- 资金池转账：采用两阶段提交保证原子性。

**权利要求8**：根据权利要求1所述的方法，其特征在于，还包括离线期间数据保护：

- 操作序列化：保证操作顺序；
- 定期检查点：每100个操作创建快照；
- 断电恢复：从WAL恢复未完成操作。

**权利要求9**：根据权利要求2所述的系统，其特征在于，还包括：

- 日志管理模块：管理写前日志和操作日志；
- 增量备份模块：离线期间增量备份；
- 自动修复模块：检测到不一致时自动修复。

**权利要求10**：根据权利要求1所述的方法，其特征在于，本发明基于传统CRDT（无冲突复制数据类型）进行财务领域创新，所述Financial-CRDT架构包括：

- Decimal-Counter：替代传统G-Counter/PN-Counter的浮点数表示，采用字符串存储和精确Decimal计算，解决浮点数精度损失问题（如0.1+0.2≠0.3）；
- Financial-Transaction-Group：将多个CRDT操作包装为原子单元，使用group_id、operations列表、status和checksum，解决传统CRDT无法表达跨账户事务原子性的问题；
- Semantic-Resolver：基于财务语义的字段级冲突解决策略，区别于传统CRDT的通用LWW/MVR策略。

**权利要求11**：根据权利要求1所述的方法，其特征在于，所述Financial-CRDT与传统CRDT的区别包括：

- 精度保护：传统CRDT使用浮点数存在精度误差，本发明使用Decimal(18,2)保证金额零损失；
- 原子性粒度：传统CRDT仅支持单值原子性，本发明支持财务事务组原子性（如转账：账户A-100, 账户B+100）；
- 一致性模型：传统CRDT仅保证最终一致性，本发明增加财务强一致性约束（借贷平衡、账户余额验证）。

**权利要求12**：根据权利要求1所述的方法，其特征在于，所述Financial-CRDT的三层架构包括：

- 财务语义层：包含Decimal-Counter、Financial-Transaction-Group、Semantic-Resolver；
- 一致性约束层：包含账户余额检查、预算检查、借贷平衡（Σ借=Σ贷）检查；
- 存储网络层：包含WAL存储、2PC协议、加密传输。
