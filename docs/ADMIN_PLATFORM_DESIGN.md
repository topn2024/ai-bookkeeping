# AI智能记账 - 企业级管理平台设计方案

## 1. 概述

### 1.1 项目背景
为AI智能记账APP提供一套完整的企业级后台管理系统，实现对用户数据、系统运行状态、业务指标的全面监控和管理。

### 1.2 设计目标
- **安全性**：多层级权限控制，操作审计，数据脱敏
- **可扩展性**：模块化设计，支持功能扩展
- **易用性**：直观的Web界面，响应式设计
- **高性能**：支持大数据量统计分析，实时监控

### 1.3 技术选型

| 层次 | 技术方案 | 说明 |
|------|---------|------|
| 前端框架 | Vue 3 + TypeScript | 现代化响应式框架 |
| UI组件库 | Element Plus | 企业级UI组件 |
| 状态管理 | Pinia | Vue 3官方推荐 |
| 图表库 | ECharts | 丰富的可视化支持 |
| 后端框架 | FastAPI | 与现有后端一致 |
| 数据库 | PostgreSQL | 与现有数据库共用 |
| 缓存 | Redis | 会话管理、数据缓存 |
| 认证 | JWT + RBAC | 基于角色的访问控制 |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        管理平台前端 (Vue 3)                       │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐       │
│  │ 仪表盘   │ 用户管理  │ 数据管理  │ 系统监控  │ 系统设置  │       │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     API Gateway (Nginx)                          │
│                  /api/v1/* → APP API                             │
│                  /admin/* → Admin API                            │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   APP API       │ │   Admin API     │ │   定时任务       │
│   (FastAPI)     │ │   (FastAPI)     │ │   (Celery)      │
└─────────────────┘ └─────────────────┘ └─────────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     数据层                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ PostgreSQL  │  │    Redis    │  │  文件存储    │              │
│  │  (主数据库)  │  │  (缓存/会话) │  │  (备份/日志) │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
server/
├── app/                          # 现有APP API
│   ├── api/v1/                   # APP接口
│   ├── models/                   # 数据模型
│   └── ...
│
├── admin/                        # 管理平台后端 (新增)
│   ├── api/                      # Admin API接口
│   │   ├── __init__.py
│   │   ├── auth.py              # 管理员认证
│   │   ├── dashboard.py         # 仪表盘数据
│   │   ├── users.py             # 用户管理
│   │   ├── transactions.py      # 交易数据管理
│   │   ├── statistics.py        # 统计分析
│   │   ├── system.py            # 系统管理
│   │   ├── logs.py              # 日志管理
│   │   └── settings.py          # 系统配置
│   │
│   ├── models/                   # Admin专用模型
│   │   ├── admin_user.py        # 管理员账户
│   │   ├── admin_role.py        # 角色权限
│   │   ├── admin_log.py         # 操作日志
│   │   └── system_config.py     # 系统配置
│   │
│   ├── services/                 # 业务服务
│   │   ├── stats_service.py     # 统计服务
│   │   ├── export_service.py    # 导出服务
│   │   └── alert_service.py     # 告警服务
│   │
│   ├── core/                     # 核心模块
│   │   ├── security.py          # 安全认证
│   │   ├── permissions.py       # 权限控制
│   │   └── audit.py             # 审计日志
│   │
│   └── main.py                   # Admin应用入口
│
admin-web/                        # 管理平台前端 (新增)
├── src/
│   ├── views/                    # 页面视图
│   │   ├── dashboard/           # 仪表盘
│   │   ├── users/               # 用户管理
│   │   ├── data/                # 数据管理
│   │   ├── monitor/             # 系统监控
│   │   └── settings/            # 系统设置
│   │
│   ├── components/              # 公共组件
│   ├── api/                     # API调用
│   ├── stores/                  # 状态管理
│   ├── router/                  # 路由配置
│   └── utils/                   # 工具函数
│
├── package.json
└── vite.config.ts
```

---

## 3. 权限设计

### 3.1 角色定义

| 角色 | 权限范围 | 说明 |
|------|---------|------|
| **超级管理员** | 全部权限 | 系统最高权限，可管理其他管理员 |
| **运营管理员** | 用户管理、数据查看、统计分析 | 日常运营管理 |
| **数据分析员** | 数据查看、统计分析 | 只读权限，用于数据分析 |
| **客服专员** | 用户查看、交易查看 | 处理用户问题 |
| **审计员** | 日志查看、审计报告 | 安全审计 |

### 3.2 权限矩阵

```
权限项                    超级管理员  运营管理员  数据分析员  客服专员  审计员
─────────────────────────────────────────────────────────────────────────
仪表盘查看                    ✓          ✓          ✓         ✓        ✓
用户列表查看                  ✓          ✓          ✓         ✓        ✗
用户详情查看                  ✓          ✓          ✓         ✓        ✗
用户状态修改                  ✓          ✓          ✗         ✗        ✗
用户数据删除                  ✓          ✗          ✗         ✗        ✗
交易数据查看                  ✓          ✓          ✓         ✓        ✗
交易数据修改                  ✓          ✗          ✗         ✗        ✗
统计报表查看                  ✓          ✓          ✓         ✗        ✗
统计报表导出                  ✓          ✓          ✓         ✗        ✗
系统配置管理                  ✓          ✗          ✗         ✗        ✗
管理员管理                    ✓          ✗          ✗         ✗        ✗
操作日志查看                  ✓          ✓          ✗         ✗        ✓
审计报告生成                  ✓          ✗          ✗         ✗        ✓
```

### 3.3 数据脱敏规则

| 数据类型 | 脱敏规则 | 示例 |
|---------|---------|------|
| 手机号 | 中间4位隐藏 | 138****5678 |
| 邮箱 | @前保留首尾 | a***z@qq.com |
| 姓名 | 保留姓 | 张** |
| 金额 | 根据权限显示 | 运营可见，客服不可见具体金额 |
| 备注 | 敏感词过滤 | 自动识别并脱敏 |

---

## 4. 模块设计

### 4.1 仪表盘模块

**核心指标卡片：**
- 今日新增用户 / 环比
- 今日活跃用户 / 环比
- 今日交易笔数 / 环比
- 今日交易金额 / 环比

**图表展示：**
- 用户增长趋势图（7天/30天/自定义）
- 交易趋势图（收入/支出/转账）
- 用户活跃度热力图
- 交易类型分布饼图
- TOP10活跃用户排行

**实时数据：**
- 最近交易流水（实时滚动）
- 在线用户数
- API调用量

### 4.2 用户管理模块

**用户列表：**
- 搜索：ID、邮箱、手机号、昵称
- 筛选：注册时间、最后活跃、用户状态、会员类型
- 排序：注册时间、交易笔数、交易金额
- 批量操作：导出、禁用/启用

**用户详情：**
- 基本信息：头像、昵称、邮箱、注册时间
- 账户概览：账本数、账户数、交易笔数、总资产
- 行为分析：登录历史、操作记录
- 关联数据：可查看用户的账本、账户、交易（脱敏）

**用户操作：**
- 禁用/启用账户
- 重置密码（发送重置邮件）
- 清除登录状态
- 删除用户（软删除，保留数据30天）

### 4.3 数据管理模块

**交易管理：**
- 全局交易搜索
- 异常交易标记（金额异常、频率异常）
- 交易数据导出

**账本/账户管理：**
- 查看所有账本/账户
- 数据完整性检查

**分类管理：**
- 系统分类维护
- 用户自定义分类统计

**备份管理：**
- 查看所有用户备份
- 备份存储统计
- 过期备份清理

### 4.4 统计分析模块

**用户分析：**
- 用户增长分析
- 用户留存分析（日/周/月留存率）
- 用户流失预警
- 用户画像分析

**交易分析：**
- 收支趋势分析
- 分类消费排行
- 平均客单价
- 交易时段分布

**业务分析：**
- 功能使用率（AI识别、语音记账等）
- 会员转化率
- 付费用户分析

**报表导出：**
- 日报/周报/月报自动生成
- 自定义报表
- 多格式导出（Excel、PDF）

### 4.5 系统监控模块

**服务状态：**
- API健康检查
- 数据库连接状态
- Redis状态
- 存储空间使用

**性能监控：**
- API响应时间
- 请求量统计
- 错误率统计
- 慢查询日志

**告警管理：**
- 告警规则配置
- 告警历史记录
- 通知方式配置（邮件/短信/Webhook）

### 4.6 系统设置模块

**基础配置：**
- 系统名称、Logo
- 注册开关
- 邮件服务配置
- 短信服务配置

**AI服务配置：**
- 千问API配置
- 模型参数调整
- 调用限额设置

**安全设置：**
- 登录策略（密码强度、失败锁定）
- IP白名单
- 操作二次确认

**管理员管理：**
- 管理员账户CRUD
- 角色分配
- 权限调整

---

## 5. 安全设计

### 5.1 认证机制

```
登录流程：
1. 管理员输入账号密码
2. 验证Google Authenticator/短信验证码（可选MFA）
3. 服务端验证，生成JWT Token
4. Token有效期2小时，支持自动刷新
5. 单点登录（同一账号只能在一处登录）
```

### 5.2 审计日志

记录所有敏感操作：
- 操作人、操作时间、IP地址
- 操作类型、操作对象
- 操作前后数据对比（敏感数据脱敏）
- 操作结果

### 5.3 安全措施

- HTTPS强制加密
- SQL注入防护
- XSS防护
- CSRF Token
- 请求频率限制
- 敏感操作二次确认

---

## 6. 部署方案

### 6.1 开发环境
```
Admin API: http://localhost:8001
Admin Web: http://localhost:3000
```

### 6.2 生产环境
```
Admin API: https://admin-api.yourdomain.com
Admin Web: https://admin.yourdomain.com

Nginx配置：
- /admin/* → Admin Web (静态文件)
- /admin-api/* → Admin API (反向代理)
```

### 6.3 Docker部署
```yaml
services:
  admin-api:
    build: ./server/admin
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=...
      - REDIS_URL=...

  admin-web:
    build: ./admin-web
    ports:
      - "3000:80"
```

---

## 7. 开发计划

### 第一阶段：基础框架（核心）
- [ ] Admin API框架搭建
- [ ] 管理员认证系统
- [ ] 角色权限系统
- [ ] 基础仪表盘

### 第二阶段：数据管理
- [ ] 用户管理模块
- [ ] 交易数据管理
- [ ] 数据导出功能

### 第三阶段：统计分析
- [ ] 统计图表
- [ ] 报表生成
- [ ] 数据分析

### 第四阶段：监控告警
- [ ] 系统监控
- [ ] 告警系统
- [ ] 日志管理

### 第五阶段：完善优化
- [ ] 审计日志
- [ ] 性能优化
- [ ] 安全加固

---

## 8. 技术要点

### 8.1 大数据量处理
- 分页查询，避免全量加载
- 统计数据定时预计算缓存
- 复杂查询使用物化视图

### 8.2 实时数据推送
- WebSocket实时推送
- 仪表盘数据自动刷新

### 8.3 导出优化
- 大文件异步生成
- 流式下载
- 定时清理过期文件

---

**文档版本**: v1.0
**创建日期**: 2025-12-30
**最后更新**: 2025-12-30
