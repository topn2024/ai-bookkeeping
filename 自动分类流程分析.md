# AI智能记账 - 自动分类处理流程分析

## 📋 分类服务架构

### 1. CategorySuggestionService（实际使用）
路径：`app/lib/services/ai/category_suggestion_service.dart`

#### 分类策略：两层策略

**第一层：千问AI分类（在线）**
- 调用 `QwenService.suggestCategory()`
- 使用通义千问API
- 成功率高，但需要网络连接
- 如果失败，自动降级到本地分类

**第二层：本地关键词匹配（离线）**
- 使用 `localSuggestCategory()`
- 基于关键词列表匹配
- 支持细粒度二级分类（如 `food_breakfast`, `transport_taxi`）
- 100% 离线可用

---

## 🔄 分类流程详解

### 流程图

```
用户输入描述
    ↓
CategorySuggestionService.suggestCategory()
    ↓
尝试：QwenService.suggestCategory()（千问API）
    ├─ 成功 → 映射分类 → 返回分类ID
    └─ 失败 → 降级到本地分类
         ↓
    localSuggestCategory()（关键词匹配）
         ↓
    返回分类ID
```

---

## 🎯 千问AI分类（第一层）

### API调用
```dart
Future<String?> suggestCategory(String description) async {
  final response = await _dio.post(
    _textApiUrl,
    data: {
      'model': _models.categoryModel,
      'input': {
        'messages': [
          {
            'role': 'system',
            'content': '''你是一个消费分类助手。根据用户描述的消费内容，返回最合适的分类。
可选分类：餐饮、交通、购物、娱乐、住房、医疗、教育、其他
只返回分类名称，不要其他文字。'''
          },
          {
            'role': 'user',
            'content': description,
          }
        ]
      }
    }
  );
}
```

### 分类映射
```dart
AIRecognitionResult.categoryMap = {
  '餐饮': 'food',
  '交通': 'transport',
  '购物': 'shopping',
  '娱乐': 'entertainment',
  '住房': 'housing',
  '医疗': 'medical',
  '教育': 'education',
  '其他': 'other',
}
```

### 问题分析
❌ **仅支持8个一级分类，无法返回细粒度的二级分类**
❌ **千问模型只能从这8个分类中选择**
❌ **无法识别：水电燃气、通讯、服饰、收入类等分类**

---

## 📝 本地关键词分类（第二层）

### 关键词表结构
```dart
// 交通分类（优先级高）
if (_containsAny(text, ['打车', '滴滴', '出租车', '高德打车', 'T3', '曹操'])) {
  return 'transport_taxi'; // 打车
}
if (_containsAny(text, ['地铁', '公交', '公交卡', '地铁卡'])) {
  return 'transport_public'; // 公共交通
}
if (_containsAny(text, ['高铁', '火车', '12306', '铁路', '动车'])) {
  return 'transport_train'; // 火车高铁
}
if (_containsAny(text, ['飞机', '机票', '航班', '航空'])) {
  return 'transport_flight'; // 飞机
}
if (_containsAny(text, ['加油', '中国石化', '中国石油'])) {
  return 'transport_fuel'; // 加油
}
if (_containsAny(text, ['停车', '停车费', '停车场'])) {
  return 'transport_parking'; // 停车
}

// 餐饮分类
if (_containsAny(text, ['早餐', '早饭', '早点'])) {
  return 'food_breakfast'; // 早餐
}
if (_containsAny(text, ['午餐', '午饭', '中餐'])) {
  return 'food_lunch'; // 午餐
}
if (_containsAny(text, ['晚餐', '晚饭', '夜宵'])) {
  return 'food_dinner'; // 晚餐
}
if (_containsAny(text, ['咖啡', '星巴克', '瑞幸', '奶茶'])) {
  return 'food_drink'; // 饮品
}
if (_containsAny(text, ['外卖', '美团外卖', '饿了么'])) {
  return 'food_delivery'; // 外卖
}
```

### 覆盖的分类
✅ **支持细粒度二级分类**
- 交通：打车、公共交通、火车、飞机、加油、停车
- 餐饮：早餐、午餐、晚餐、饮品、外卖、水果、零食
- 购物：日用品、数码、家电、家具、礼物
- 娱乐：电影、游戏、旅游、健身
- 居住：房租、房贷、物业
- 水电燃气：电费、水费、燃气、暖气
- 医疗：门诊、买药、体检
- 教育：学费、书籍、培训
- 通讯：话费、网费
- 服饰：衣服、鞋子、配饰
- 收入：工资、奖金、兼职、投资、红包、报销

---

## ⚠️ 当前问题分析

### 问题1：千问AI分类限制过多
**现象：** 千问模型只能返回8个一级分类
**影响：** 
- 无法识别水电燃气、通讯、服饰等分类
- 无法返回二级分类（如打车、早餐等）
- 导致很多交易被错误分类为"其他"

**示例：**
- "充话费100元" → AI返回"其他" → 本地分类为 `communication_phone` ✓
- "买了件衣服" → AI返回"其他" → 本地分类为 `clothing_clothes` ✓
- "交电费" → AI返回"其他" → 本地分类为 `utilities_electric` ✓

### 问题2：本地分类关键词不全
**现象：** 某些描述没有包含关键词，无法匹配
**示例：**
- "去了趟商场" → 缺少"购物"关键词 → 分类为 `other_expense`
- "吃了顿饭" → 可能匹配到"吃" → 分类为 `food` ✓

### 问题3：AI和本地分类不一致
**现象：** AI返回粗粒度分类，本地返回细粒度分类
**示例：**
- AI：description="打车去机场" → 返回"交通" → 映射为 `transport`
- 本地：description="打车去机场" → 返回 `transport_taxi`
- 结果：AI成功时返回一级分类，失败时返回二级分类

### 问题4：分类映射表过时
**位置：** `AIRecognitionResult.categoryMap`
**问题：** 只有8个分类的映射，其他分类无法处理

---

## 🔍 实际使用场景

### 场景1：语音记账
```dart
// 用户说："打车去机场花了50"
// ↓
QwenService.recognizeMultipleTransactions()
// ↓ 千问返回
{
  'amount': 50,
  'category': '交通',  // ❌ 只是一级分类
  'description': '打车去机场'
}
// ↓ 映射
category_id = 'transport'  // ❌ 不是 transport_taxi
```

### 场景2：短信导入
```dart
// 短信："您尾号1234的卡支出100.00元[美团外卖]"
// ↓
CategorySuggestionService.suggestCategory("美团外卖")
// ↓ 尝试AI
QwenService.suggestCategory("美团外卖")
// 返回："餐饮"
// ↓ 映射
category_id = 'food'  // ❌ 不是 food_delivery
```

### 场景3：AI失败降级
```dart
// 网络失败或AI错误
// ↓ 降级到本地
localSuggestCategory("美团外卖")
// ↓ 关键词匹配
if (_containsAny(text, ['外卖', '美团外卖', '饿了么'])) {
  return 'food_delivery';  // ✓ 正确的细粒度分类
}
```

---

## 💡 改进建议

### 建议1：扩展千问模型的分类列表
**当前：** 8个一级分类
**建议：** 扩展到包含所有细粒度分类

```dart
'content': '''你是一个消费分类助手。根据用户描述的消费内容，返回最合适的分类。

可选分类（支持细粒度）：
餐饮类：餐饮、早餐、午餐、晚餐、外卖、饮品、水果、零食
交通类：交通、打车、公共交通、火车高铁、飞机、加油、停车
购物类：购物、日用品、数码产品、家电、家具、礼物
娱乐类：娱乐、电影、游戏、旅游、健身
居住类：居住、房租、房贷、物业
水电燃气：电费、水费、燃气费、暖气费
医疗类：医疗、门诊、买药、体检
教育类：教育、学费、书籍、培训
通讯类：话费、网费
服饰类：衣服、鞋子、配饰
收入类：工资、奖金、兼职、投资收益、红包、报销

只返回分类名称，优先返回细粒度分类。'''
```

### 建议2：完善分类映射表
**扩展 `AIRecognitionResult.categoryMap`** 包含所有分类：

```dart
static const Map<String, String> categoryMap = {
  // 餐饮类
  '餐饮': 'food',
  '早餐': 'food_breakfast',
  '午餐': 'food_lunch',
  '晚餐': 'food_dinner',
  '外卖': 'food_delivery',
  '饮品': 'food_drink',
  '水果': 'food_fruit',
  '零食': 'food_snack',
  
  // 交通类
  '交通': 'transport',
  '打车': 'transport_taxi',
  '公共交通': 'transport_public',
  '火车高铁': 'transport_train',
  '飞机': 'transport_flight',
  '加油': 'transport_fuel',
  '停车': 'transport_parking',
  
  // ... 其他分类
};
```

### 建议3：优化关键词列表
**补充遗漏的关键词：**

```dart
// 购物关键词补充
'shopping': ['购物', '商场', '逛街', '买东西'],

// 餐饮关键词补充
'food': ['饭店', '餐厅', '食品', '吃饭'],

// 娱乐关键词补充  
'entertainment': ['玩', '游玩', '放松'],
```

### 建议4：统一分类粒度
**策略：** 优先使用细粒度分类
- AI和本地都返回细粒度分类
- 如果AI只能返回粗粒度，用本地再细化

```dart
Future<String?> suggestCategory(String description) async {
  // 尝试AI
  final aiCategory = await _qwenService.suggestCategory(description);
  
  if (aiCategory != null) {
    final mapped = AIRecognitionResult.categoryMap[aiCategory];
    if (mapped != null) {
      // 如果AI返回粗粒度（如'food'），用本地再细化
      if (_isCoarseCategory(mapped)) {
        return _refineWithLocal(description, mapped);
      }
      return mapped;
    }
  }
  
  // 降级到本地
  return localSuggestCategory(description);
}
```

---

## 📊 分类准确率对比

| 场景 | 当前准确率 | 改进后预期 |
|-----|-----------|-----------|
| 餐饮类 | 70% | 90% |
| 交通类 | 75% | 92% |
| 购物类 | 65% | 88% |
| 水电燃气 | 30% | 85% |
| 通讯类 | 40% | 90% |
| 服饰类 | 50% | 85% |
| 收入类 | 80% | 95% |

