# AI 记账 App 本地开发快速开始指南

## 问题说明

系统服务 **LogsAndAlerts** 占用了 ADB 默认端口 **5037**，导致无法直接使用 Android 调试功能。

已将 ADB 配置为使用备用端口 **5038**。

## 开发环境启动（3 步）

### 1. 启动 ADB 服务

双击运行或在命令行中执行：
```
D:\code\ai-bookkeeping\scripts\start-adb.bat
```

此脚本会启动 ADB 服务器在端口 5038 上。

### 2. 启动 Android 模拟器

使用以下命令启动模拟器（或通过 Android Studio 启动）：
```
flutter emulators --launch Medium_Phone_API_36
```

等待模拟器完全启动（约 30-60 秒）。

### 3. 验证连接

运行启动脚本以验证模拟器连接：
```
D:\code\ai-bookkeeping\scripts\start-adb.bat
```

应该看到类似以下输出：
```
List of devices attached
emulator-5554          device product:sdk_gphone64_x86_64 ...
```

## Flutter 开发工作流

### 方式A：使用开发脚本（推荐）

1. 双击运行 `flutter-dev.bat`
2. 在打开的命令行窗口中执行 Flutter 命令

### 方式B：手动设置（每次开发前执行）

打开命令提示符（cmd.exe）并执行：

```cmd
set ANDROID_ADB_SERVER_PORT=5038
cd D:\code\ai-bookkeeping\app

REM 运行应用
flutter run

REM 或构建 APK
flutter build apk
```

## 常见命令

```cmd
REM 查看连接的设备
set ANDROID_ADB_SERVER_PORT=5038 && adb devices

REM 列出可用模拟器
flutter emulators

REM 安装 APK 到模拟器
set ANDROID_ADB_SERVER_PORT=5038 && adb install app-debug.apk

REM 查看日志
set ANDROID_ADB_SERVER_PORT=5038 && adb logcat
```

## 故障排除

### 问题：Flutter 未检测到 Android 设备

**解决方法：**

1. 确保先运行 `start-adb.bat`
2. 确保模拟器完全启动（可以看到主屏幕）
3. 使用开发脚本 `flutter-dev.bat` 来运行 Flutter 命令
4. 在运行 Flutter 命令前设置环境变量：
   ```cmd
   set ANDROID_ADB_SERVER_PORT=5038
   ```

### 问题：模拟器显示 offline

**解决方法：**

1. 重启 ADB：
   ```cmd
   set ANDROID_ADB_SERVER_PORT=5038
   adb kill-server
   adb start-server
   ```

2. 如果仍然 offline，重启模拟器

### 问题：端口冲突

**检查端口占用：**
```cmd
netstat -ano | findstr "5037"
netstat -ano | findstr "5038"
```

如果 5037 被占用是正常的（LogsAndAlerts 服务）。
如果 5038 被占用，请检查是否有其他 ADB 实例在运行。

## 环境变量说明

已为您的用户账户配置以下环境变量：

- `ANDROID_ADB_SERVER_PORT=5038` - ADB 服务器端口
- PATH 中包含 `D:\code\ai-bookkeeping\scripts` - 脚本目录

**重要：** 新打开的命令行窗口才会应用这些环境变量。建议使用提供的启动脚本。

## IDE 配置建议

### VS Code

1. 先运行 `flutter-dev.bat` 进入开发环境
2. 在该命令行中启动 VS Code：
   ```cmd
   code D:\code\ai-bookkeeping
   ```

### Android Studio

使用 Android Studio 的内置终端，并在终端中设置：
```cmd
set ANDROID_ADB_SERVER_PORT=5038
```

## 测试开发环境

运行以下测试脚本：
```cmd
D:\code\ai-bookkeeping\scripts\test-flutter.bat
```

此脚本会显示 Flutter 检测到的所有设备。
