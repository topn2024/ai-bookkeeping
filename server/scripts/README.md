# 数据库管理脚本

## reset_database.py - 数据库重置工具

### 功能说明

这个脚本用于测试环境的数据库重置和初始化，**会删除所有表并重新创建**，支持表结构变更。提供三种模式：

1. **clean** - 删除并重建所有表（不初始化数据）
   - ❌ 删除所有数据库表
   - ✅ 重新创建所有表结构
   - 适用于：表结构更新后需要重建

2. **init** - 重建表并初始化系统数据（推荐）
   - ❌ 删除所有数据库表
   - ✅ 重新创建所有表结构
   - ✅ 初始化系统预设分类（餐饮、购物、交通等）
   - ✅ 初始化管理员角色和权限
   - ✅ 创建默认超级管理员账号
   - 适用于：测试环境重置

3. **full** - 完整重置（含测试数据）
   - 执行 init 模式的所有操作
   - ✅ 创建测试用户账号
   - ✅ 创建示例账本和账户
   - ✅ 创建示例交易记录
   - ✅ 创建示例预算
   - 适用于：开发环境初始化、功能测试

### 重要特性

⭐ **支持表结构变更**：脚本会删除所有表并重新创建，因此当数据库模型发生变化时（添加字段、修改类型等），可以直接使用此脚本重建数据库。

### 使用方法

#### 基本用法

```bash
# 进入 server 目录
cd server

# 重建表并初始化系统数据（推荐用于测试环境重置）
python scripts/reset_database.py --mode init

# 完整重置（包含测试数据）
python scripts/reset_database.py --mode full

# 仅重建表结构（不初始化数据）
python scripts/reset_database.py --mode clean
```

#### 跳过确认提示

```bash
# 危险操作！跳过确认直接执行
python scripts/reset_database.py --mode full --confirm
```

#### 查看帮助

```bash
python scripts/reset_database.py --help
```

### 初始化数据说明

#### 系统分类

**支出分类：**
- 餐饮 🍜
- 购物 🛍️
- 交通 🚗
- 娱乐 🎮
- 医疗 💊
- 住房 🏠
- 教育 📚
- 通讯 📱
- 服饰 👔
- 美容 💄
- 运动 ⚽
- 旅游 ✈️
- 数码 💻
- 宠物 🐕
- 礼物 🎁
- 其他 📦

**收入分类：**
- 工资 💰
- 奖金 🎉
- 投资 📈
- 兼职 💼
- 红包 🧧
- 退款 ↩️
- 其他 💵

#### 管理员角色

1. **超级管理员** (super_admin)
   - 拥有所有权限
   - 可管理所有功能

2. **运营管理员** (operator)
   - 日常运营管理
   - 可管理用户和数据

3. **数据分析员** (analyst)
   - 只读权限
   - 用于数据分析

4. **客服专员** (customer_service)
   - 处理用户问题
   - 查看用户和交易信息

5. **审计员** (auditor)
   - 安全审计
   - 查看操作日志

#### 默认账号

**管理员账号：**
- 用户名: `admin`
- 密码: `admin123`
- 邮箱: `admin@example.com`

**测试用户账号（仅 full 模式）：**
- 手机号: `13800138000`
- 邮箱: `test@example.com`
- 密码: `test123`

### 测试数据说明（full 模式）

#### 账户
- 现金: ¥1,000.00
- 工商银行: ¥5,000.00
- 支付宝: ¥2,000.00
- 微信: ¥500.00

#### 交易记录
- 1 笔收入（工资 ¥8,000.00）
- 4 笔支出（餐饮、购物、交通等）

#### 预算
- 月度总预算: ¥3,000.00

### 安全警告

⚠️ **重要提示：**

1. **仅用于测试环境** - 此脚本会删除所有表和数据，切勿在生产环境使用！
2. **表结构重建** - 脚本会执行 DROP ALL TABLES 和 CREATE ALL TABLES，所有数据将永久丢失
3. **确认数据库连接** - 执行前请确认 `DATABASE_URL` 环境变量指向正确的数据库
4. **备份数据** - 如有重要数据，请先备份
5. **谨慎使用 --confirm** - 跳过确认提示可能导致误操作
6. **不支持回滚** - 表删除后无法恢复，请谨慎操作

### 环境要求

- Python 3.11+
- PostgreSQL 数据库
- 已配置 `.env` 文件中的数据库连接

### 故障排除

#### 问题：找不到模块

```bash
# 确保在 server 目录下执行
cd server
python scripts/reset_database.py --mode init
```

#### 问题：数据库连接失败

```bash
# 检查 .env 文件中的 DATABASE_URL 配置
cat .env | grep DATABASE_URL

# 确保数据库服务正在运行
```

#### 问题：权限不足

```bash
# 确保数据库用户有足够的权限执行 TRUNCATE 操作
```

### 开发建议

1. **日常开发** - 使用 `--mode init` 重置测试环境
2. **功能测试** - 使用 `--mode full` 快速创建测试数据
3. **CI/CD** - 在自动化测试中使用 `--mode full --confirm`

### 相关文档

- [数据库模型文档](../app/models/README.md)
- [管理员系统文档](../admin/README.md)
- [API 文档](../docs/api.md)
