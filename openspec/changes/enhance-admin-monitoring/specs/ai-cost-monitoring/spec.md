# 规范：AI服务成本监控

## 功能概述
为管理控制台提供AI服务成本的精细化监控和管理能力，按功能维度统计AI调用和成本，提供成本优化建议，确保AI成本可控。

## 新增需求

### 需求：ACM-001 - 按功能维度记录AI调用
系统**必须**记录每次AI服务调用的详细信息，特别是功能来源。

#### 场景：OCR图片识别调用
**前置条件**：
- 用户使用图片记账功能
- 调用通义千问OCR服务

**操作步骤**：
1. 用户上传账单图片
2. 后端调用通义千问OCR API识别图片
3. 记录AI调用详情：
   ```python
   {
     'service_name': 'qwen',
     'feature_name': 'ocr_recognition',
     'call_type': 'ocr',
     'user_id': user_id,
     'input_size': 245,  # KB
     'tokens': {
       'total': 1500,
       'prompt': 500,
       'completion': 1000,
     },
     'latency_ms': 850,
     'cost': 0.015,  # 元
     'success': True,
     'timestamp': datetime.now(),
   }
   ```
4. 写入AI调用记录表

**预期结果**：
- 调用详情准确记录
- 成本计算准确（基于Token数和单价）
- 关联到具体功能

#### 场景：文本解析调用
**前置条件**：
- 用户使用语音记账
- 语音识别后需要AI解析

**操作步骤**：
1. 语音转文字："今天中午在沙县小吃花了25块钱"
2. 调用AI服务解析交易信息
3. 记录调用详情（feature_name='voice_parsing'）

**预期结果**：
- feature_name准确标识功能来源
- 成本分配到语音记账功能

### 需求：ACM-002 - 成本数据聚合
系统**必须**定期聚合AI成本数据，生成统计报告。

#### 场景：小时级成本聚合
**前置条件**：
- AI调用记录表有数据
- Celery聚合任务正常运行

**操作步骤**：
1. 每小时聚合过去1小时的AI调用数据
2. 按service_name, feature_name, call_type分组统计：
   - 总调用次数
   - 成功/失败次数
   - 总Token数（prompt/completion分开）
   - 总成本
   - 平均延迟
3. 写入ai_service_costs表

**预期结果**：
- 统计数据准确
- granularity='hourly'
- 支持快速查询

**数据示例**：
```json
{
  "periodStart": "2026-01-11T08:00:00Z",
  "periodEnd": "2026-01-11T09:00:00Z",
  "granularity": "hourly",
  "serviceName": "qwen",
  "featureName": "ocr_recognition",
  "callType": "ocr",
  "totalCalls": 450,
  "successfulCalls": 445,
  "failedCalls": 5,
  "totalTokens": 675000,
  "promptTokens": 225000,
  "completionTokens": 450000,
  "estimatedCost": 6.75,
  "avgLatencyMs": 820
}
```

#### 场景：日级和月级聚合
**前置条件**：同上

**操作步骤**：
1. 每天凌晨聚合前一天的数据（granularity='daily'）
2. 每月1号聚合上月数据（granularity='monthly'）
3. 计算额外的指标：
   - 成本同比环比增长率
   - 单次调用平均成本
   - 成本排行榜

**预期结果**：
- 多粒度数据支持不同时间跨度的分析
- 趋势分析更准确

### 需求：ACM-003 - AI成本监控仪表盘
管理员**必须**能在控制台查看AI成本的详细信息和趋势。

#### 场景：查看成本总览
**前置条件**：
- 管理员已登录控制台
- 有monitor:ai_costs:view权限

**操作步骤**：
1. 访问"系统监控" -> "AI成本管理"页面
2. 选择时间范围（默认本月）
3. 调用GET /admin/monitoring/ai-costs/overview
4. 显示总览数据

**预期结果**：
- 显示关键指标卡片：
  - 总成本（元）
  - 总调用次数
  - 平均单次成本
  - 成本趋势（↑↓）
- 显示成本趋势图（面积图，区分不同服务）
- 显示功能成本分布（饼图）
- 显示优化建议

**界面示例**：
```
┌────────────────────────────────────────────────────┐
│ AI成本管理              [本月 ▼] [刷新] [导出]     │
├────────────────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │总成本 │ │调用次数│ │平均成本│ │节省建议│              │
│ │¥2,850│ │125K  │ │¥0.0228│ │ 3条   │              │
│ │↑12% │ │↑8%  │ │↑4%   │ │       │              │
│ └──────┘ └──────┘ └──────┘ └──────┘              │
├────────────────────────────────────────────────────┤
│ 成本趋势                                          │
│ ┌────────────────────────────────────────────┐   │
│ │ [通义千问] [智谱GLM]                        │   │
│ │                                            │   │
│ └────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────┤
│ 功能成本分布                                      │
│ 🥧 OCR识别 42% | 文本解析 33% | 语音识别 25%      │
└────────────────────────────────────────────────────┘
```

#### 场景：查看特定功能的成本详情
**前置条件**：同上

**操作步骤**：
1. 点击功能列表中的"OCR识别"
2. 查看该功能的详细成本信息

**预期结果**：
- 显示该功能的成本趋势
- 显示调用量和成功率
- 显示平均延迟和Token使用
- 显示该功能的优化建议

#### 场景：对比不同时间段的成本
**前置条件**：同上

**操作步骤**：
1. 选择对比模式
2. 选择两个时间段（如本月 vs 上月）
3. 查看成本对比

**预期结果**：
- 并排显示两个时间段的成本
- 显示增长率和差异金额
- 高亮显示增长最快的功能

### 需求：ACM-004 - 成本优化建议
系统**必须**自动分析成本数据，提供具体的优化建议。

#### 场景：识别高重复率调用
**前置条件**：
- 系统分析AI调用记录
- 识别相同输入的重复调用

**操作步骤**：
1. 后台任务分析AI调用记录
2. 对比相同feature和相似输入（如相同图片哈希）
3. 计算重复率
4. 生成缓存建议

**预期结果**：
- 识别重复率高的场景
- 计算缓存可节省的成本
- 提供实施建议

**建议示例**：
```
优化建议 #1：OCR识别缓存

📊 分析结果：
- OCR识别重复率：15%
- 重复调用次数：6,750次/月
- 浪费成本：约¥180/月

💡 优化方案：
1. 对图片计算哈希值
2. 缓存识别结果（有效期7天）
3. 相同图片直接返回缓存结果

💰 预期节省：
- 月节省成本：¥180（6.3%）
- 减少API调用：6,750次
- 改善响应速度：缓存命中<50ms

🔧 实施难度：中等
```

#### 场景：识别批量处理机会
**前置条件**：同上

**操作步骤**：
1. 分析调用时间分布
2. 识别短时间内的大量调用
3. 建议批量处理

**预期结果**：
- 识别可批量处理的场景
- 计算批量API的成本优势
- 提供实施建议

#### 场景：识别异常高成本调用
**前置条件**：同上

**操作步骤**：
1. 监控单次调用成本
2. 识别成本>¥1的异常调用
3. 分析原因（如输入过大、参数不当）
4. 提供优化建议

**预期结果**：
- 识别异常调用
- 分析根因（Token数异常高、失败重试过多等）
- 提供具体优化措施

### 需求：ACM-005 - 成本告警和预算管理
系统**必须**支持设置成本预算和告警阈值。

#### 场景：设置月度预算
**前置条件**：
- 管理员有相应权限
- 访问AI成本管理页面

**操作步骤**：
1. 点击"预算设置"
2. 设置月度预算：¥5,000
3. 设置告警阈值：
   - 80%预算使用：发送Email提醒
   - 100%预算使用：发送Email和SMS告警
   - 120%预算使用：发送紧急告警并抄送上级

**预期结果**：
- 预算设置成功保存
- 系统实时监控预算使用情况
- 达到阈值时自动触发告警

#### 场景：预算超支告警
**前置条件**：
- 已设置月度预算¥5,000
- 当月累计成本达到¥5,100

**操作步骤**：
1. 系统监控到成本超过100%预算
2. 触发告警流程
3. 发送告警通知

**预期结果**：
- 发送Email和SMS告警
- 告警内容包含：
  - 当前成本和预算
  - 超支金额和比例
  - 主要成本来源
  - 优化建议链接

**告警示例**：
```
主题：[紧急] AI成本预算超支告警

内容：
本月AI成本已超出预算：

预算：¥5,000
实际成本：¥5,100
超支：¥100（2%）

主要成本来源：
1. OCR识别：¥2,142（42%）
2. 文本解析：¥1,683（33%）
3. 语音识别：¥1,275（25%）

建议立即查看优化方案：
https://admin.example.com/monitor/ai-costs

AI Bookkeeping 管理控制台
```

#### 场景：成本异常增长告警
**前置条件**：
- 系统监控成本趋势

**操作步骤**：
1. 系统对比今日成本与昨日
2. 发现增长超过30%
3. 触发异常告警

**预期结果**：
- 发送告警通知
- 分析增长原因（调用量增加还是单价上涨）
- 提供排查建议

## 修改需求

### 需求：ACM-M001 - 扩展现有AI服务监控
现有的AI服务监控（server/admin/api/monitoring.py中的AI Service部分）**必须**增加成本维度。

#### 场景：AI服务监控页面显示成本
**前置条件**：
- 管理员访问"系统监控" -> "AI服务监控"页面

**操作步骤**：
1. 查看AI服务状态
2. 除了现有的成功率、延迟等指标
3. 增加显示成本指标

**预期结果**：
- AI服务监控页面增加成本卡片
- 显示今日成本、本月成本
- 显示成本趋势
- 链接到详细的成本管理页面

**变更内容**：
- 扩展GET /admin/monitoring/ai-service API，增加cost字段
- admin-web/src/views/monitor/AIService.vue增加成本展示组件

## 技术约束

### 约束：ACM-T001 - 成本计算准确性
成本计算应准确反映实际费用。

**要求**：
- 使用最新的AI服务价格表
- 考虑不同模型、不同类型调用的差异
- 考虑优惠和折扣
- 定期校验（每月对账）

**实现方式**：
- 配置文件维护价格表
- 支持价格表更新
- 记录使用的价格版本

**价格示例**（通义千问）：
```python
QWEN_PRICING = {
    'text': {
        'prompt': 0.0008,  # 元/1K tokens
        'completion': 0.002,  # 元/1K tokens
    },
    'ocr': {
        'per_image': 0.01,  # 元/张
    },
    'embedding': {
        'per_1k_tokens': 0.0007,
    }
}
```

### 约束：ACM-T002 - 实时性要求
成本数据应及时更新，支持实时决策。

**要求**：
- AI调用记录10分钟内写入数据库
- 小时级聚合延迟<15分钟
- 日级聚合次日凌晨完成
- 仪表盘数据延迟<30分钟

### 约束：ACM-T003 - 数据精度
成本数据应保留足够精度，同时避免过度精确。

**要求**：
- 成本金额保留4位小数（如¥0.0123）
- 聚合统计保留2位小数（如¥125.67）
- 百分比保留1位小数（如42.3%）

## 验收标准

### AC-001：成本记录准确
- [ ] AI调用成本计算准确率100%
- [ ] 覆盖所有AI服务类型
- [ ] 价格表可配置和更新

### AC-002：成本聚合准确
- [ ] 聚合数据与原始数据对账差异<0.1%
- [ ] 多粒度聚合数据一致
- [ ] 聚合任务按时执行

### AC-003：监控仪表盘完整
- [ ] 总览页面数据准确
- [ ] 趋势图正确展示
- [ ] 功能分布准确
- [ ] 优化建议有价值

### AC-004：告警及时有效
- [ ] 预算告警准确触发
- [ ] 异常告警及时发送
- [ ] 无重复告警骚扰

### AC-005：性能符合要求
- [ ] 成本记录耗时<5ms（不阻塞AI调用）
- [ ] 监控API响应P95<500ms
- [ ] 聚合任务执行<10分钟

## 依赖关系
- **依赖**：现有AI服务调用（server/app/services/llm_service.py）
- **依赖**：现有AI服务监控
- **依赖**：Celery任务调度
- **被依赖**：成本优化决策依赖此监控数据

## 参考资料
- LLM服务：server/app/services/llm_service.py
- 现有AI监控：server/admin/api/monitoring.py（AI Service部分）
- 前端AI监控页面：admin-web/src/views/monitor/AIService.vue
- 通义千问API文档：https://help.aliyun.com/document_detail/2712194.html
- 智谱API文档：https://open.bigmodel.cn/dev/api
