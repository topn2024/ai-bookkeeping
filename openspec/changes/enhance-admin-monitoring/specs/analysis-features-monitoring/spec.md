# 规范：分析功能监控

## 功能概述
为管理控制台提供数据分析功能的使用监控，追踪用户使用行为，识别性能瓶颈，优化查询性能。

## 新增需求

### 需求：AFM-001 - 分析功能使用追踪
系统**必须**追踪用户对各数据分析功能的使用情况，包括使用频率、查询参数、性能指标等。

#### 场景：用户查看消费趋势图表
**前置条件**：
- 用户打开分析中心页面
- 移动端已集成埋点

**操作步骤**：
1. 用户点击"趋势分析"标签
2. 选择时间范围"本月"
3. 系统查询数据并绘制图表
4. 记录使用事件：
   ```dart
   {
     'type': 'analysis_feature_usage',
     'userId': user.id,
     'data': {
       'featureName': 'trend_analysis',
       'featureParams': {'period': 'month', 'category': 'all'},
       'queryTimeMs': 156,
       'dataPoints': 30,
       'resultSizeKb': 12,
       'sessionId': sessionId,
     },
     'timestamp': DateTime.now(),
   }
   ```
5. 事件发送到后端并记录

**预期结果**：
- 事件成功记录到analysis_feature_usage表
- 包含完整的性能指标
- 支持后续性能分析

#### 场景：用户使用分类占比分析
**前置条件**：同上

**操作步骤**：
1. 用户点击"分类分析"标签
2. 查看分类占比饼图
3. 记录使用事件

**预期结果**：
- featureName='category_pie'
- 记录查询参数（时间范围、账本等）
- 记录查询性能

### 需求：AFM-002 - 功能使用统计
管理员**必须**能查看各分析功能的使用统计和排名。

#### 场景：查看功能使用概览
**前置条件**：
- 管理员已登录控制台
- 有monitor:analysis_features:view权限

**操作步骤**：
1. 访问"系统监控" -> "分析功能监控"页面
2. 选择时间范围（最近30天）
3. 调用GET /admin/monitoring/analysis-features/overview
4. 显示统计数据

**预期结果**：
- 显示关键指标：
  - 总使用次数
  - 活跃用户数
  - 平均查询时间
  - P95/P99查询时间
- 显示功能使用排行榜
- 显示性能趋势图

**界面示例**：
```
┌─────────────────────────────────────────────────┐
│ 分析功能监控         [最近30天 ▼] [刷新]        │
├─────────────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐           │
│ │总使用量│ │活跃用户│ │平均耗时│ │P95耗时│           │
│ │85K   │ │6.5K  │ │245ms │ │850ms │           │
│ └──────┘ └──────┘ └──────┘ └──────┘           │
├─────────────────────────────────────────────────┤
│ 功能使用排行                                    │
│ 1. 趋势分析        25K次 (29%)  平均180ms     │
│ 2. 分类占比        18K次 (21%)  平均120ms     │
│ 3. 时期对比        15K次 (18%)  平均200ms     │
│ 4. 月度报告        12K次 (14%)  平均350ms     │
│ 5. AI消费预测      10K次 (12%)  平均500ms     │
└─────────────────────────────────────────────────┘
```

#### 场景：查看特定功能的详细数据
**前置条件**：同上

**操作步骤**：
1. 点击功能列表中的"趋势分析"
2. 查看该功能的详细使用情况

**预期结果**：
- 显示使用趋势（按天/周）
- 显示热门参数组合
- 显示性能分布直方图
- 显示用户留存情况

### 需求：AFM-003 - 慢查询识别和优化
系统**必须**自动识别慢查询，提供性能优化建议。

#### 场景：识别慢查询
**前置条件**：
- 系统正常运行，收集性能数据

**操作步骤**：
1. 后台任务分析analysis_feature_usage表
2. 识别查询时间>2000ms的记录
3. 按功能、参数分组统计慢查询
4. 生成慢查询报告

**预期结果**：
- 慢查询列表显示：
  - 功能名称
  - 查询参数
  - 查询时间
  - 发生频率
  - 影响用户数
- 按严重程度排序

**慢查询示例**：
```
慢查询报告

⚠️ 趋势分析 - 年度视图
  - 查询时间：2500ms（P95）
  - 发生频率：150次/天
  - 影响用户：85人
  - 原因分析：查询365天数据，无索引优化
  - 优化建议：
    1. 添加 (user_id, date) 复合索引
    2. 预聚合月度数据
    3. 考虑数据分页加载

⚠️ 分类占比 - 多账本合并
  - 查询时间：1800ms（P95）
  - 发生频率：80次/天
  - 优化建议：增加账本维度的预聚合
```

#### 场景：性能对比分析
**前置条件**：同上

**操作步骤**：
1. 选择两个时间段（如优化前 vs 优化后）
2. 对比同一功能的性能变化
3. 评估优化效果

**预期结果**：
- 显示性能改善百分比
- 显示P50/P95/P99的变化
- 高亮显示显著改善

### 需求：AFM-004 - 用户行为分析
管理员**必须**能分析用户在数据分析功能中的行为模式。

#### 场景：功能使用路径分析
**前置条件**：
- 系统已收集用户session数据

**操作步骤**：
1. 分析用户在一个session中使用功能的顺序
2. 识别常见的功能使用路径
3. 发现用户关注的数据维度

**预期结果**：
- 显示热门路径（如：首页 → 趋势分析 → 分类详情）
- 识别流失点（用户离开的节点）
- 提供产品优化建议

#### 场景：功能留存分析
**前置条件**：同上

**操作步骤**：
1. 统计首次使用某功能的用户
2. 追踪这些用户在后续N天的回访情况
3. 计算留存率

**预期结果**：
- 显示各功能的1日/7日/30日留存率
- 识别留存率低的功能
- 提供改进建议

## 技术约束

### 约束：AFM-T001 - 性能测量准确性
性能数据应准确反映用户真实体验。

**要求**：
- 测量从用户操作到数据展示的完整时间
- 包含网络延迟和渲染时间
- 排除用户暂停、切换应用等干扰

**实现方式**：
- 使用Stopwatch精确计时
- 记录各阶段耗时（网络、计算、渲染）
- 异常值过滤（如>30秒认为是暂停）

### 约束：AFM-T002 - 数据采样
为控制数据量，对高频功能可采样。

**采样策略**：
- 使用次数<100次/天的功能：100%采样
- 使用次数100-1000次/天：50%采样
- 使用次数>1000次/天：10%采样
- 慢查询（>1000ms）：100%采样

### 约束：AFM-T003 - 实时性要求
性能数据应尽快反馈到监控系统。

**要求**：
- 埋点数据5分钟内写入数据库
- 慢查询告警5分钟内触发
- 监控仪表盘数据延迟<10分钟

## 验收标准

### AC-001：使用追踪准确
- [ ] 所有分析功能都集成埋点
- [ ] 性能数据测量准确（与实际体验误差<5%）
- [ ] 参数记录完整

### AC-002：监控仪表盘有效
- [ ] 功能使用统计准确
- [ ] 性能指标计算正确
- [ ] 慢查询识别准确率>95%

### AC-003：优化建议有价值
- [ ] 慢查询优化建议可执行
- [ ] 至少提供3种优化方向
- [ ] 预估优化效果

### AC-004：性能符合要求
- [ ] 埋点耗时<10ms
- [ ] 监控API响应P95<500ms
- [ ] 不影响分析功能正常性能

## 依赖关系
- **依赖**：移动端分析中心页面（app/lib/pages/analysis_center_page.dart）
- **依赖**：事件收集API
- **被依赖**：性能优化工作参考此监控数据

## 参考资料
- 分析中心实现：app/lib/pages/analysis_center_page.dart
- 趋势图表：app/lib/widgets/interactive_trend_chart.dart
- 现有监控API：server/admin/api/monitoring.py
