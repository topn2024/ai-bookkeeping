# 规范：数据质量监控

## 功能概述
为管理控制台提供全面的数据质量监控能力，自动检测数据异常，及时告警，确保移动应用展示的真实数据准确可靠。

## 新增需求

### 需求：DQM-001 - 自动化数据质量检查
管理控制台**必须**定期自动检查数据库中的数据质量问题，包括空值、异常值、数据不一致等。

#### 场景：定时检查空值
**前置条件**：
- 系统已配置数据质量检查任务
- Celery worker正常运行

**操作步骤**：
1. 系统每小时自动触发数据质量检查任务
2. 检查任务扫描关键表的关键字段（如transactions.amount, categories.name等）
3. 统计每个字段的空值数量和比例
4. 将检查结果写入data_quality_checks表
5. 如果空值比例超过阈值（如5%），触发告警

**预期结果**：
- 检查结果准确记录到数据库
- 超过阈值的问题触发告警通知
- 管理员可在控制台看到检查结果

**数据示例**：
```json
{
  "checkId": 12345,
  "checkTime": "2026-01-11T08:00:00Z",
  "checkType": "null_check",
  "targetTable": "transactions",
  "targetColumn": "amount",
  "severity": "high",
  "totalRecords": 150000,
  "affectedRecords": 8,
  "issueDetails": {
    "nullCount": 8,
    "nullPercentage": 0.0053,
    "sampleIds": ["tx_001", "tx_002", "tx_003"]
  },
  "status": "detected"
}
```

#### 场景：检查数据范围异常
**前置条件**：同上

**操作步骤**：
1. 检查任务检查数值字段是否在合理范围内
2. 例如：transactions.amount < 0（支出金额为负）、amount > 1000000（单笔金额过大）
3. 记录异常值的数量和样本
4. 严重程度根据异常数量判定

**预期结果**：
- 识别出所有范围异常的记录
- 按严重程度分类（low/medium/high/critical）
- 提供异常样本供管理员查看

#### 场景：检查数据一致性
**前置条件**：同上

**操作步骤**：
1. 检查跨表数据一致性，例如：
   - 账户余额 = SUM(交易金额)
   - 分类交易数 = 该分类下的实际交易数
2. 计算差异值和差异比例
3. 记录不一致的账户/分类ID

**预期结果**：
- 发现数据不一致问题
- 提供具体的不一致详情
- 给出修复建议

### 需求：DQM-002 - 数据质量概览仪表盘
管理员**必须**能在控制台看到数据质量的整体状况和趋势。

#### 场景：查看数据质量总览
**前置条件**：
- 管理员已登录控制台
- 有monitor:data_quality:view权限

**操作步骤**：
1. 管理员访问"系统监控" -> "数据质量监控"页面
2. 页面调用GET /admin/monitoring/data-quality/overview
3. 显示数据质量总览信息

**预期结果**：
- 显示综合评分（如95.8分）
- 显示各严重程度问题数量（Critical: 2, High: 5等）
- 显示各数据表的质量评分
- 显示最近的检查记录列表

**界面示例**：
```
┌─────────────────────────────────────────────────┐
│ 数据质量监控                    [刷新] [导出]   │
├─────────────────────────────────────────────────┤
│ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐        │
│ │综合评分│ │严重问题│ │待处理 │ │已解决 │        │
│ │ 95.8  │ │ 2     │ │ 17   │ │ 32   │        │
│ │ [优秀]│ │ [高]  │ │      │ │      │        │
│ └───────┘ └───────┘ └───────┘ └───────┘        │
└─────────────────────────────────────────────────┘
```

#### 场景：查看特定表的数据质量
**前置条件**：同上

**操作步骤**：
1. 在数据表质量评分列表中，点击某个表（如"transactions"）
2. 查看该表的详细质量报告
3. 包含各字段的质量评分、问题分布等

**预期结果**：
- 显示表级别的详细质量指标
- 显示各字段的质量评分
- 显示该表相关的问题列表

### 需求：DQM-003 - 数据质量问题管理
管理员**必须**能查看、筛选、处理数据质量问题。

#### 场景：筛选和查看问题列表
**前置条件**：
- 管理员已登录控制台
- 有monitor:data_quality:view权限

**操作步骤**：
1. 访问数据质量监控页面
2. 使用筛选器选择：
   - 严重程度：Critical, High
   - 状态：detected（待处理）
   - 时间范围：最近7天
3. 系统调用GET /admin/monitoring/data-quality/checks?severity=critical,high&status=detected&days=7
4. 显示筛选后的问题列表

**预期结果**：
- 列表显示符合条件的问题
- 每个问题显示：检查时间、类型、目标表/字段、严重程度、影响记录数、状态
- 支持分页浏览
- 支持点击查看详情

#### 场景：查看问题详情
**前置条件**：同上

**操作步骤**：
1. 点击问题列表中的某个问题
2. 打开问题详情弹窗或页面
3. 显示完整的问题信息

**预期结果**：
- 显示完整的检查结果
- 显示异常数据样本（ID列表）
- 显示修复建议
- 提供操作按钮：标记为"调查中"、"已解决"、"忽略"

**详情示例**：
```
问题详情 #12345
─────────────────────────────────────
检查时间：2026-01-11 08:00:00
检查类型：空值检查
目标表：transactions
目标字段：amount
严重程度：高 🔴

影响范围：
- 总记录数：150,000
- 受影响记录：8条
- 影响比例：0.0053%

异常样本：
- tx_001 | 用户A | 2026-01-10 | amount=NULL
- tx_002 | 用户B | 2026-01-10 | amount=NULL
- tx_003 | 用户C | 2026-01-11 | amount=NULL
[查看完整列表]

修复建议：
1. 检查移动端提交逻辑，确保amount字段必填
2. 对现有空值记录，可考虑：
   - 联系用户补充信息
   - 设置默认值0并标记为"待确认"
   - 删除无效记录

操作：
[标记为调查中] [标记为已解决] [忽略此问题]
```

#### 场景：标记问题为已解决
**前置条件**：
- 管理员已登录
- 有monitor:data_quality:manage权限

**操作步骤**：
1. 在问题详情页面，点击"标记为已解决"按钮
2. 填写解决说明（如"已修复移动端Bug，空值记录已清理"）
3. 提交

**预期结果**：
- 调用POST /admin/monitoring/data-quality/checks/{checkId}/resolve
- 问题状态更新为"fixed"
- 记录resolved_at时间和resolution_notes
- 记录到审计日志
- 页面显示成功提示

### 需求：DQM-004 - 数据质量告警
当检测到严重的数据质量问题时，**必须**自动触发告警通知相关人员。

#### 场景：触发高严重度告警
**前置条件**：
- 数据质量检查任务检测到高严重度问题
- 告警系统已配置

**操作步骤**：
1. 检查任务发现transactions.amount空值率超过5%
2. 创建数据质量检查记录，严重程度为"high"
3. 触发告警逻辑
4. 调用告警系统发送通知

**预期结果**：
- 发送Email通知到运维团队
- Email包含问题摘要、影响范围、处理链接
- 记录告警发送日志

**告警内容示例**：
```
主题：[高] 数据质量告警 - transactions.amount空值异常

内容：
数据质量检查发现高严重度问题：

表：transactions
字段：amount
问题类型：空值异常
影响记录：8条（占比0.0053%）
检查时间：2026-01-11 08:00:00

请及时处理：
https://admin.example.com/monitor/data-quality/checks/12345

AI Bookkeeping 管理控制台
```

#### 场景：严重问题持续未解决的升级告警
**前置条件**：
- 高严重度问题创建超过24小时未解决

**操作步骤**：
1. 告警系统定期检查未解决的高严重度问题
2. 对超过24小时的问题，发送升级告警
3. 抄送更高级别管理员

**预期结果**：
- 发送升级告警Email和SMS
- 标记问题为"需要关注"
- 在控制台显著位置提醒

### 需求：DQM-005 - 数据质量趋势分析
管理员**必须**能查看数据质量随时间的变化趋势，评估改进效果。

#### 场景：查看数据质量趋势图
**前置条件**：
- 管理员已登录控制台
- 系统已积累至少7天的数据质量数据

**操作步骤**：
1. 访问数据质量监控页面
2. 查看"质量趋势"图表
3. 选择时间范围（最近30天）
4. 查看综合评分、问题数量的趋势变化

**预期结果**：
- 显示折线图，展示综合评分的变化
- 显示堆积柱状图，展示各严重程度问题的数量变化
- 能识别质量改善或恶化的趋势
- 支持按表、按检查类型筛选

## 修改需求

### 需求：DQM-M001 - 扩展现有告警系统
现有告警系统（server/admin/api/monitoring.py中的告警功能）**必须**支持数据质量告警类型。

#### 场景：数据质量告警集成到告警列表
**前置条件**：
- 管理员访问"系统监控" -> "告警管理"页面

**操作步骤**：
1. 查看告警列表
2. 筛选告警类型为"数据质量"

**预期结果**：
- 数据质量告警显示在统一的告警列表中
- 支持按类型、严重程度筛选
- 支持确认、忽略、升级等操作

**变更内容**：
- 告警类型枚举中增加"data_quality"
- 告警模型中支持关联data_quality_checks表
- 前端告警页面（Alerts.vue）增加数据质量告警的展示和处理逻辑

## 技术约束

### 约束：DQM-T001 - 性能要求
数据质量检查任务不应影响主业务性能。

**要求**：
- 检查任务在数据库低峰期运行（如凌晨2点、上午10点等）
- 单次检查时间不超过5分钟
- 检查查询使用只读副本（如果有）
- 对大表使用采样检查而非全表扫描

**实现方式**：
- Celery定时任务配置
- 查询优化（索引、LIMIT采样）
- 超时控制

### 约束：DQM-T002 - 数据保留
数据质量检查记录应根据状态和严重程度保留不同时长。

**保留策略**：
- 已解决的低严重度问题：保留30天
- 已解决的中高严重度问题：保留90天
- 未解决的问题：永久保留直到解决
- 关键问题（影响超过1000条记录）：永久保留

**实现方式**：
- Celery定期清理任务
- 数据归档到对象存储（MinIO）

### 约束：DQM-T003 - 告警频率限制
避免告警轰炸，同一问题不应短时间内重复告警。

**要求**：
- 同一检查类型 + 目标表/字段，24小时内最多告警1次
- 如果问题持续恶化（影响记录数增加50%以上），可突破限制再次告警

**实现方式**：
- Redis缓存最近告警记录
- 告警去重逻辑

## 验收标准

### AC-001：自动检查正常运行
- [ ] Celery任务每小时自动执行
- [ ] 检查覆盖所有关键表和字段
- [ ] 检查结果准确记录到数据库
- [ ] 任务失败时有日志记录和告警

### AC-002：问题准确识别
- [ ] 空值检查：准确率100%
- [ ] 范围检查：误报率<1%
- [ ] 一致性检查：准确识别差异

### AC-003：控制台功能完整
- [ ] 数据质量概览页面正常显示
- [ ] 问题列表支持筛选和分页
- [ ] 问题详情显示完整信息
- [ ] 标记解决功能正常工作
- [ ] 权限控制正确实施

### AC-004：告警及时准确
- [ ] 高严重度问题5分钟内发送告警
- [ ] 告警内容包含必要信息
- [ ] 无重复告警骚扰
- [ ] 告警记录可追溯

### AC-005：性能符合要求
- [ ] 检查任务单次执行时间<5分钟
- [ ] API响应时间P95<500ms
- [ ] 对主业务数据库负载影响<5%

### AC-006：数据安全
- [ ] 所有API需要管理员权限
- [ ] 审计日志记录所有操作
- [ ] 导出数据不包含敏感信息

## 依赖关系
- **依赖**：现有监控系统（server/admin/api/monitoring.py）
- **依赖**：现有告警系统
- **依赖**：Celery任务调度系统
- **被依赖**：其他监控功能可参考数据质量监控的实现模式

## 参考资料
- 现有监控API：server/admin/api/monitoring.py
- 告警管理页面：admin-web/src/views/monitor/Alerts.vue
- 数据库Schema：server/app/models/
- Celery配置：server/celery_app.py
