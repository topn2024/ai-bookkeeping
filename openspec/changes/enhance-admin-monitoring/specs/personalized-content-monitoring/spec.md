# 规范：千人千面内容监控

## 功能概述
为管理控制台提供千人千面功能的监控能力，追踪个性化内容的生成、展示和用户反馈，支持A/B测试和效果评估。

## 新增需求

### 需求：PCM-001 - 千人千面事件追踪
系统**必须**追踪移动端千人千面功能的使用情况，包括浏览、刷新、交互等事件。

#### 场景：用户查看个性化问候语
**前置条件**：
- 移动端已集成埋点SDK
- 用户打开应用首页

**操作步骤**：
1. HomePageTextProvider生成个性化问候语
2. 用户看到问候语后，移动端记录事件
3. 事件数据：
   ```dart
   {
     'type': 'personalized_content_view',
     'userId': user.id,
     'data': {
       'contentType': 'greeting',
       'contentVariant': 'early_morning_1',
       'seedValue': 'user123_20260111_08_greeting',
       'sessionId': sessionId,
     },
     'timestamp': DateTime.now(),
   }
   ```
4. 批量发送到后端/api/v1/events/batch
5. 后端写入Redis队列
6. Celery任务消费队列并写入数据库

**预期结果**：
- 事件成功记录到personalized_content_events表
- 包含完整的上下文信息（用户、内容类型、变体、种子值等）
- 后续可用于统计分析

#### 场景：用户手动刷新内容
**前置条件**：同上

**操作步骤**：
1. 用户下拉刷新首页
2. HomePageTextNotifier.refresh()被调用
3. 生成新的个性化内容
4. 记录刷新事件

**预期结果**：
- 事件类型为'personalized_content_refresh'
- 记录刷新原因（手动/自动）
- 关联同一session的view事件

#### 场景：用户与内容交互
**前置条件**：同上

**操作步骤**：
1. 用户点击首页文案（如"查看消费明细"）
2. 记录交互事件
3. 包含交互类型（点击、长按等）

**预期结果**：
- 事件类型为'personalized_content_interact'
- 记录交互详情
- 用于计算内容的转化率和有效性

### 需求：PCM-002 - 千人千面数据聚合
系统**必须**定期聚合千人千面事件数据，生成统计指标。

#### 场景：小时级数据聚合
**前置条件**：
- personalized_content_events表中有事件数据
- Celery聚合任务正常运行

**操作步骤**：
1. 每小时运行一次聚合任务
2. 按contentType分组统计过去1小时的数据：
   - 总浏览量（view事件数）
   - 总刷新量（refresh事件数）
   - 唯一用户数（distinct userId）
   - 各变体的分布（variant_distribution）
   - 平均停留时间（从事件metadata中提取）
3. 写入personalized_content_stats表

**预期结果**：
- 统计数据准确
- granularity='hourly'
- 支持快速查询和展示

**数据示例**：
```json
{
  "periodStart": "2026-01-11T08:00:00Z",
  "periodEnd": "2026-01-11T09:00:00Z",
  "granularity": "hourly",
  "contentType": "greeting",
  "totalViews": 2500,
  "totalRefreshes": 850,
  "uniqueUsers": 450,
  "avgSessionDuration": 5.2,
  "variantDistribution": {
    "early_morning_1": 600,
    "early_morning_2": 500,
    "early_morning_3": 450,
    "early_morning_4": 420,
    "early_morning_5": 380,
    "early_morning_6": 150
  }
}
```

#### 场景：日级数据聚合
**前置条件**：同上

**操作步骤**：
1. 每天凌晨运行一次日级聚合任务
2. 聚合前一天的数据
3. 计算额外的指标：
   - 日活跃用户数
   - 人均浏览次数
   - 刷新率（refreshes/views）
   - 各时段的分布

**预期结果**：
- granularity='daily'
- 数据更全面
- 用于趋势分析

### 需求：PCM-003 - 千人千面监控仪表盘
管理员**必须**能在控制台查看千人千面功能的使用情况和效果。

#### 场景：查看功能总览
**前置条件**：
- 管理员已登录控制台
- 有monitor:personalized_content:view权限

**操作步骤**：
1. 访问"系统监控" -> "千人千面监控"页面
2. 选择时间范围（默认最近7天）
3. 页面调用GET /admin/monitoring/personalized-content/overview
4. 显示总览数据和图表

**预期结果**：
- 显示关键指标卡片：
  - 总浏览量
  - 总刷新次数
  - 活跃用户数
  - 平均刷新率
- 显示使用趋势图（折线图）
- 显示内容类型分布（饼图或柱状图）

**界面示例**：
```
┌────────────────────────────────────────────────────┐
│ 千人千面监控            [最近7天 ▼] [刷新] [导出]  │
├────────────────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │总浏览量│ │刷新次数│ │活跃用户│ │刷新率 │              │
│ │125K  │ │45K   │ │8.5K  │ │36%  │              │
│ │↑15% │ │↑22% │ │↑8%  │ │↑5%  │              │
│ └──────┘ └──────┘ └──────┘ └──────┘              │
├────────────────────────────────────────────────────┤
│ 使用趋势                                          │
│ ┌────────────────────────────────────────────┐   │
│ │ [折线图：浏览量、刷新次数、活跃用户]         │   │
│ │                                            │   │
│ └────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────┤
│ 内容类型分布                                      │
│ [问候语42%] [结余趋势28%] [连续记账18%] [钱龄12%] │
└────────────────────────────────────────────────────┘
```

#### 场景：查看特定内容类型的表现
**前置条件**：同上

**操作步骤**：
1. 点击内容类型标签页（如"问候语"）
2. 调用GET /admin/monitoring/personalized-content/variants?contentType=greeting
3. 显示该类型的文案变体表现

**预期结果**：
- 显示各变体的统计数据：
  - 浏览量
  - 占比
  - 平均停留时间
  - 交互率
- 按表现排序（浏览量或交互率）
- 识别表现最好和最差的变体

**表格示例**：
```
问候语文案变体表现

排名 | 变体标识        | 浏览量 | 占比  | 停留时间 | 交互率
-----|----------------|-------|-------|---------|-------
1    | early_morning_1| 12K   | 24%   | 5.2s    | 15%
2    | early_morning_2| 10K   | 20%   | 4.8s    | 12%
3    | early_morning_3| 9K    | 18%   | 4.5s    | 11%
...
```

#### 场景：对比不同时间段的数据
**前置条件**：同上

**操作步骤**：
1. 选择对比模式
2. 选择两个时间段（如本周 vs 上周）
3. 查看对比结果

**预期结果**：
- 并排显示两个时间段的指标
- 显示增长率或变化趋势
- 高亮显示显著变化

### 需求：PCM-004 - 文案效果分析
管理员**必须**能评估不同文案变体的效果，支持数据驱动的文案优化。

#### 场景：识别低效文案
**前置条件**：
- 系统已积累足够的数据（至少7天）
- 管理员访问千人千面监控页面

**操作步骤**：
1. 查看文案变体表现列表
2. 按交互率升序排序
3. 识别交互率低于平均值的变体

**预期结果**：
- 系统自动标记低效文案（如交互率<5%）
- 提供优化建议
- 支持禁用或替换低效文案

**建议示例**：
```
低效文案识别

⚠️ greeting/early_morning_6
  - 浏览量：150（占比6%）
  - 交互率：2%（平均12%）
  - 建议：考虑替换或优化此文案

💡 优化建议：
  1. 参考表现较好的文案风格（如early_morning_1）
  2. 增加情感共鸣或行动召唤
  3. A/B测试新的文案变体
```

#### 场景：A/B测试支持
**前置条件**：
- 管理员想测试新的文案变体

**操作步骤**：
1. 在文案库中添加新变体（如early_morning_7）
2. 设置A/B测试参数：
   - 测试变体：early_morning_1（对照组）vs early_morning_7（实验组）
   - 流量分配：50% vs 50%
   - 测试时长：7天
3. 移动端根据用户ID哈希分配到对照组或实验组
4. 监控页面实时跟踪两组的表现

**预期结果**：
- 两组数据并排展示
- 显示统计显著性（如p-value）
- 测试结束后给出结论和建议

### 需求：PCM-005 - 用户反馈收集
系统**必须**支持收集用户对个性化内容的反馈。

#### 场景：用户喜欢某条文案
**前置条件**：
- 移动端显示个性化内容
- 用户可以点赞或反馈

**操作步骤**：
1. 用户看到问候语"早安，美好的一天开始了 ☀️"
2. 用户点击👍按钮
3. 移动端记录正面反馈事件
4. 事件包含contentVariant等信息

**预期结果**：
- 反馈记录到事件表的metadata字段
- 统计时计算正面反馈率
- 用于评估文案受欢迎程度

#### 场景：用户不喜欢某条文案
**前置条件**：同上

**操作步骤**：
1. 用户点击👎按钮或"换一条"
2. 记录负面反馈事件
3. 可选：用户填写反馈原因

**预期结果**：
- 负面反馈记录到数据库
- 高负面反馈率的文案被标记
- 支持管理员查看用户反馈理由

## 修改需求

### 需求：PCM-M001 - 移动端埋点集成
现有移动端代码**必须**集成埋点功能，追踪千人千面事件。

#### 场景：HomePageTextProvider触发埋点
**前置条件**：
- HomePageTextProvider已生成内容

**操作步骤**：
1. 在HomePageTextProvider._refreshAllTexts()中
2. 调用埋点服务记录刷新事件
3. 在首页组件中，当内容显示时记录浏览事件

**预期结果**：
- 埋点代码不阻塞主流程
- 埋点数据批量发送，减少网络请求
- 失败时不影响用户体验

**代码位置**：
- app/lib/providers/home_page_text_provider.dart
- app/lib/pages/home_page.dart
- 新增：app/lib/services/analytics_service.dart（埋点服务）

## 技术约束

### 约束：PCM-T001 - 埋点性能
移动端埋点不应影响应用性能和用户体验。

**要求**：
- 埋点操作异步执行
- 批量发送（每5分钟或累计50条）
- 本地队列缓存（离线时不丢失）
- 失败重试机制（最多3次）
- 单次埋点耗时<10ms

**实现方式**：
- 本地SQLite队列
- 后台定时任务
- 网络可用时发送

### 约束：PCM-T002 - 数据采样
为控制数据量，可对事件进行采样。

**采样策略**：
- view事件：100%采样（全量）
- refresh事件：100%采样
- interact事件：100%采样
- 详细metadata（如页面停留时长）：10%采样

**实现方式**：
- 移动端根据采样率决定是否记录详细数据
- 后端聚合时考虑采样率进行还原

### 约束：PCM-T003 - 隐私保护
埋点数据不应包含敏感个人信息。

**要求**：
- 只记录用户ID，不记录姓名、手机号等
- 文案内容不包含用户个人数据
- 导出数据时脱敏
- 遵循GDPR和个人信息保护法

## 验收标准

### AC-001：埋点正常工作
- [ ] 移动端成功发送埋点事件
- [ ] 事件数据完整准确
- [ ] 批量发送机制正常
- [ ] 离线缓存和重试机制有效

### AC-002：数据聚合准确
- [ ] 小时级聚合数据准确率>99%
- [ ] 日级聚合数据准确率100%
- [ ] 聚合任务按时执行
- [ ] 失败时有告警

### AC-003：监控仪表盘功能完整
- [ ] 总览页面正常显示
- [ ] 图表数据正确
- [ ] 文案变体表现准确
- [ ] 对比功能正常
- [ ] 权限控制正确

### AC-004：性能符合要求
- [ ] 移动端埋点耗时<10ms
- [ ] API响应时间P95<500ms
- [ ] 聚合任务执行时间<5分钟

### AC-005：用户反馈功能
- [ ] 用户可以提交反馈
- [ ] 反馈数据正确记录
- [ ] 管理员可以查看反馈统计

## 依赖关系
- **依赖**：移动端HomePageTextService和Provider
- **依赖**：事件收集API（/api/v1/events/batch）
- **依赖**：Celery任务调度系统
- **被依赖**：未来其他个性化功能可复用此监控模式

## 参考资料
- 千人千面实现：app/lib/services/home_page_text_service.dart
- 千人千面Provider：app/lib/providers/home_page_text_provider.dart
- 首页组件：app/lib/pages/home_page.dart
- 现有监控API：server/admin/api/monitoring.py
