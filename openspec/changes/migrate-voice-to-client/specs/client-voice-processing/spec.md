# 规范增量：客户端语音处理

## 新增需求

### 需求：客户端VAD检测
客户端必须支持本地语音活动检测（VAD），无需依赖后端。

#### 场景：检测用户开始说话
- **前提**: 用户已激活语音助手
- **当**: 麦克风检测到连续3帧以上的语音信号
- **则**: 触发`onSpeechStart`回调
- **且**: VAD检测延迟应小于10ms

#### 场景：检测用户停止说话
- **前提**: 用户正在说话（VAD已检测到语音开始）
- **当**: 麦克风检测到连续10帧以上的静音
- **则**: 触发`onSpeechEnd`回调

#### 场景：自适应噪声阈值
- **前提**: 环境噪声变化
- **当**: 检测到持续低能量音频
- **则**: 自动调整噪声基底
- **且**: 语音检测阈值相应调整

---

### 需求：客户端打断检测
客户端必须支持三层打断检测机制，实现低延迟的用户打断响应。

#### 场景：第一层快速打断（VAD+ASR联合）
- **前提**: AI正在播放TTS响应
- **当**: VAD检测到语音 且 ASR中间结果文本长度>=4字 且 与TTS文本相似度<0.4
- **则**: 立即触发打断
- **且**: 停止TTS播放
- **且**: 打断响应延迟应小于30ms

#### 场景：第二层ASR打断
- **前提**: AI正在播放TTS响应
- **当**: ASR中间结果文本长度>=8字 且 与TTS文本相似度<0.3
- **则**: 触发打断
- **且**: 停止TTS播放

#### 场景：第三层完成结果打断
- **前提**: AI正在播放TTS响应 或 在回声窗口内（TTS结束后1.5秒内）
- **当**: ASR返回最终结果 且 通过回声抑制过滤
- **则**: 停止当前TTS（如果仍在播放）
- **且**: 处理用户新请求

#### 场景：打断冷却时间
- **前提**: 刚刚触发过打断
- **当**: 在1.5秒内再次检测到可能的打断
- **则**: 忽略该打断信号
- **原因**: 防止误触发

---

### 需求：客户端回声抑制
客户端必须能够识别和过滤TTS回声，避免AI响应自己。

#### 场景：识别TTS回声
- **前提**: AI正在播放或刚刚播放完TTS
- **当**: ASR返回结果与最近TTS文本相似度>0.6
- **则**: 判定为回声，忽略该ASR结果

#### 场景：VAD辅助判断
- **前提**: VAD检测到用户确实在说话
- **当**: ASR结果与TTS文本相似度>0.8
- **则**: 才判定为回声（提高阈值，减少误过滤）

#### 场景：相似度计算
- **前提**: 需要比较ASR结果和TTS文本
- **当**: 计算相似度
- **则**: 使用Jaccard相似度和最长公共子串(LCS)的加权组合

---

### 需求：LLM API安全管理
客户端直连LLM API时必须采取安全措施保护API密钥。

#### 场景：加密存储
- **前提**: 需要持久化存储API Key片段
- **当**: 存储到本地
- **则**: 使用flutter_secure_storage加密存储
- **且**: 不存储完整Key

#### 场景：分段组装
- **前提**: 需要使用API Key
- **当**: 组装完整Key
- **则**: 从多个来源（编译时、本地加密、远程配置）获取片段
- **且**: 运行时组装
- **且**: 使用后尽快丢弃引用

#### 场景：代码混淆
- **前提**: 发布APK/IPA
- **当**: 构建发布版本
- **则**: 启用Dart obfuscation
- **且**: 分离调试信息

#### 场景：定期更新
- **前提**: Key已使用超过配置的有效期
- **当**: 启动应用或定时检查
- **则**: 从远程配置获取最新Key片段
- **且**: 更新本地加密存储

---

### 需求：简化的ASR/TTS代理协议
客户端与后端之间必须使用简化的WebSocket协议进行ASR和TTS通信。

#### 场景：发送音频进行ASR
- **前提**: WebSocket连接已建立
- **当**: 客户端录制到音频数据
- **则**: 发送`{"type": "audio_chunk", "data": "<base64>"}`
- **且**: 后端转发到阿里云ASR

#### 场景：接收ASR中间结果
- **前提**: 后端收到阿里云ASR中间结果
- **当**: 转发到客户端
- **则**: 发送`{"type": "asr_intermediate", "text": "..."}`

#### 场景：接收ASR最终结果
- **前提**: 后端收到阿里云ASR句子结束
- **当**: 转发到客户端
- **则**: 发送`{"type": "asr_final", "text": "..."}`

#### 场景：请求TTS合成
- **前提**: 客户端需要播放语音
- **当**: 发送TTS请求
- **则**: 发送`{"type": "tts_request", "text": "..."}`

#### 场景：接收TTS音频
- **前提**: 后端正在合成TTS
- **当**: 收到音频块
- **则**: 发送`{"type": "tts_audio", "data": "<base64>"}`

#### 场景：TTS合成完成
- **前提**: 后端完成TTS合成
- **当**: 所有音频已发送
- **则**: 发送`{"type": "tts_complete"}`

#### 场景：打断通知
- **前提**: 客户端检测到用户打断
- **当**: 需要停止后端TTS
- **则**: 发送`{"type": "interrupt"}`
- **且**: 后端停止当前TTS合成

---

### 需求：会话状态本地管理
客户端必须本地管理会话状态，包括超时检测和主动对话触发。

#### 场景：用户活动超时检测
- **前提**: 会话处于活动状态
- **当**: 用户无活动超过30秒
- **则**: 触发超时警告
- **且**: 播放提示语音

#### 场景：主动对话触发
- **前提**: 会话处于等待用户输入状态
- **当**: 用户沉默超过10秒
- **则**: 可选择性触发主动对话
- **且**: 基于用户画像生成话题

#### 场景：会话结束检测
- **前提**: 用户发出结束意图
- **当**: 检测到"好了"、"谢谢"、"拜拜"等结束语
- **则**: 播放告别语
- **且**: 关闭会话

---

## 修改需求

### 需求：ChatCompanionService职责变更
原有的ChatCompanionService必须调整职责，从依赖后端处理变为本地处理。

#### 场景：状态管理本地化
- **前提**: 原依赖后端状态同步
- **当**: 状态变化
- **则**: 本地状态机直接管理
- **且**: 不再等待后端确认

#### 场景：打断处理本地化
- **前提**: 原依赖后端`interrupted`消息
- **当**: 检测到打断
- **则**: 本地立即执行打断响应
- **且**: 通知后端停止TTS（如果正在合成）

---

## 移除需求

### 需求：移除后端集中处理逻辑
后端不再负责VAD检测、打断判断、回声抑制等逻辑。

#### 场景：移除后端VAD
- **前提**: 后端原有VADService
- **当**: 迁移完成
- **则**: 后端VADService不再使用
- **且**: 可以移除或保留作为降级方案

#### 场景：移除后端打断检测
- **前提**: 后端原有三层打断检测
- **当**: 迁移完成
- **则**: 后端不再判断打断
- **且**: 仅响应客户端的`interrupt`消息

#### 场景：移除后端回声抑制
- **前提**: 后端原有回声抑制逻辑
- **当**: 迁移完成
- **则**: 后端不再进行回声过滤
- **且**: 直接转发所有ASR结果到客户端
