# 语音音频处理规范增量

## 新增需求

### 需求：TTS播放时提供AEC参考信号

当TTS播放音频时，系统必须将播放的PCM数据同时传递给AEC模块作为参考信号，以便消除麦克风中录入的TTS回声。

#### 场景：在线TTS播放时传递AEC参考信号

**给定** 用户正在使用语音助手
**当** 系统播放阿里云TTS合成的语音回复
**那么** 系统请求PCM格式的TTS音频（16kHz，单声道）
**并且** 将PCM数据同时发送给播放器和AEC参考信号接口
**并且** AEC模块收到参考信号后能够从麦克风输入中消除TTS回声

#### 场景：AEC消除TTS回声

**给定** TTS正在播放"晚上好"
**并且** 麦克风录入了TTS的声音
**当** 音频数据经过AEC处理
**那么** 处理后的音频不包含TTS的"晚上好"内容
**并且** ASR不会识别出TTS播放的内容

#### 场景：用户在TTS播放期间打断

**给定** TTS正在播放
**并且** AEC参考信号正在传递
**当** 用户说"停"
**那么** VAD检测到用户语音
**并且** AEC消除TTS回声后保留用户的"停"
**并且** 系统正确识别用户的打断指令

### 需求：离线TTS降级处理

当网络不可用无法使用在线TTS时，系统必须降级到离线TTS，并采用替代方案处理回声问题。

#### 场景：网络不可用时降级到离线TTS

**给定** 网络连接不可用
**当** 系统需要播放TTS回复
**那么** 系统使用flutter_tts离线引擎播放
**并且** 系统在TTS播放期间标记speaking状态
**并且** speaking状态下麦克风音频仅用于VAD打断检测，不发送给ASR

## 修改需求

### 需求：TTS服务支持PCM格式输出

修改现有TTS服务，必须支持请求和处理PCM格式的音频数据。

#### 场景：StreamingTTSService请求PCM格式

**给定** 在线TTS服务可用
**当** 合成语音请求发送到阿里云
**那么** 请求参数包含format=pcm
**并且** 请求参数包含sample_rate=16000
**并且** 返回的音频数据为PCM16格式

#### 场景：使用PCM播放器播放音频

**给定** 收到PCM格式的TTS音频数据
**当** 播放该音频
**那么** 使用PCM专用播放器（flutter_pcm_sound）播放
**并且** 播放前设置采样率为16kHz
**并且** 播放过程中同步触发AEC参考信号回调
