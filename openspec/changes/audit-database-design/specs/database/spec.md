# 数据库设计规范增量

## 新增需求

### 需求：数据库索引策略

系统必须为高频查询字段建立索引以确保查询性能。

#### 场景：按日期查询交易
- **当** 用户按日期范围筛选交易时
- **那么** 系统必须使用 transactions.date 索引快速定位数据

#### 场景：按账本查询交易
- **当** 用户切换账本查看交易时
- **那么** 系统必须使用 transactions.ledgerId 索引快速筛选

#### 场景：按账户查询交易
- **当** 用户查看某账户的交易记录时
- **那么** 系统必须使用 transactions.accountId 索引快速筛选

#### 场景：按分类统计
- **当** 系统生成分类统计报表时
- **那么** 系统必须使用 transactions.category 索引提高聚合效率

### 需求：updatedAt 时间戳追踪

所有核心业务表必须记录最后更新时间，以支持增量同步和审计追踪。

#### 场景：记录更新时间
- **当** 用户修改任何核心业务记录（账户、分类、账本、预算等）时
- **那么** 系统必须自动更新该记录的 updatedAt 字段为当前时间戳

#### 场景：增量同步
- **当** 客户端请求增量同步时
- **那么** 系统可以使用 updatedAt 字段识别自上次同步后变更的记录

### 需求：数据库迁移安全

数据库版本升级必须确保数据安全和向后兼容。

#### 场景：迁移前备份
- **当** 系统检测到需要数据库升级时
- **那么** 系统必须先创建数据库备份

#### 场景：迁移失败回滚
- **当** 数据库迁移过程中发生错误时
- **那么** 系统必须记录错误日志并保留原始数据库

#### 场景：迁移幂等性
- **当** 执行数据库迁移脚本时
- **那么** 系统必须确保脚本可重复执行不会产生副作用（使用 IF NOT EXISTS 等）

### 需求：数据引用完整性（Phase 2）

系统必须确保表间引用关系的完整性，防止孤儿记录。

#### 场景：删除被引用记录
- **当** 用户尝试删除一个被其他记录引用的账户时
- **那么** 系统必须阻止删除或级联更新引用记录

#### 场景：创建无效引用
- **当** 尝试创建引用不存在记录的数据时
- **那么** 系统必须拒绝创建并返回错误

### 需求：软删除机制（Phase 2）

核心业务数据必须支持软删除，保留删除历史以支持恢复和审计。

#### 场景：软删除记录
- **当** 用户删除交易、账户或其他核心数据时
- **那么** 系统必须标记记录为已删除（isDeleted = 1）而非物理删除

#### 场景：查询排除已删除
- **当** 用户查询交易列表时
- **那么** 系统必须默认排除已删除的记录

#### 场景：恢复已删除记录
- **当** 用户在保留期内请求恢复已删除记录时
- **那么** 系统必须能够恢复该记录

#### 场景：定期清理
- **当** 已删除记录超过保留期（如30天）时
- **那么** 系统应物理删除这些记录以释放空间

## 修改需求

### 需求：数据库版本管理

系统必须支持数据库架构的版本化管理，确保平滑升级。

#### 场景：版本升级
- **当** 应用启动时检测到数据库版本低于当前版本时
- **那么** 系统必须执行对应的迁移脚本升级数据库结构
- **并且** 迁移必须保持现有数据完整

#### 场景：版本16升级
- **当** 从版本15升级到版本16时
- **那么** 系统必须添加以下索引：
  - idx_transactions_date
  - idx_transactions_ledger
  - idx_transactions_account
  - idx_transactions_category
  - idx_budgets_ledger
  - idx_categories_parent
- **并且** 系统必须为以下表添加 updatedAt 字段：
  - accounts
  - categories
  - ledgers
  - templates
  - recurring_transactions
  - credit_cards
  - bill_reminders
  - budgets
