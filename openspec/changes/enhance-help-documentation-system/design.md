# 设计文档：帮助文档系统架构

## 架构决策

### 决策1：JSON vs 代码内嵌 vs 数据库

**问题**：帮助内容应该如何存储和管理？

**选项**：

A. **JSON文件（推荐）**
   - 优点：
     - 易于编辑和维护，非开发人员也可编辑
     - 支持热更新（可选）
     - 文件结构清晰，按模块组织
     - 版本控制友好
   - 缺点：
     - 需要解析JSON
     - 初次加载需要时间（可缓存）

B. **代码内嵌（Dart常量）**
   - 优点：
     - 编译时类型检查
     - 无需解析，性能最佳
   - 缺点：
     - 难以维护，237个页面内容在代码中很冗长
     - 修改需要重新编译
     - 非开发人员无法编辑

C. **本地数据库（SQLite）**
   - 优点：
     - 查询性能好
     - 支持复杂搜索
   - 缺点：
     - 初始化数据复杂
     - 更新维护困难
     - 过度设计

**决策**：选择 **A - JSON文件**

**理由**：
1. 内容维护是主要考虑因素，JSON最易维护
2. 237个页面的帮助内容在代码中会很难管理
3. 性能不是瓶颈（帮助内容总量不大，可全部缓存）
4. 未来可能支持在线更新帮助内容

---

### 决策2：单文件 vs 多文件组织

**问题**：所有帮助内容放一个JSON文件还是按模块分文件？

**选项**：

A. **单文件（all_help_content.json）**
   - 优点：
     - 简单，只需加载一个文件
     - 便于全局搜索
   - 缺点：
     - 文件巨大（237个页面）
     - 难以维护和编辑
     - Git冲突风险高

B. **多文件按模块分（推荐）**
   - 优点：
     - 每个文件大小适中（5-30页）
     - 多人协作时减少冲突
     - 按需加载（可选优化）
     - 清晰的文件组织结构
   - 缺点：
     - 需要加载多个文件
     - 管理20个文件

**决策**：选择 **B - 多文件按模块分**

**理由**：
1. 可维护性优先于加载复杂度
2. 20个文件仍然可管理
3. 可实现懒加载优化（初期不需要）

---

### 决策3：帮助内容结构设计

**问题**：帮助内容应该包含哪些字段？如何平衡详细度和简洁性？

**考虑因素**：
- 用户需求：快速了解功能、学习使用方法
- 维护成本：字段越多，维护成本越高
- 显示空间：移动端屏幕有限

**设计方案**：

```dart
class HelpContent {
  final String pageId;           // 必填：页面唯一标识
  final String title;            // 必填：页面标题
  final String module;           // 必填：所属模块
  final String description;      // 必填：功能描述（1-2句话）
  final List<String> useCases;   // 推荐：使用场景列表（2-4个）
  final List<HelpStep> steps;    // 推荐：操作步骤（3-8步）
  final List<String> tips;       // 可选：注意事项（0-5个）
  final List<String> relatedPages; // 可选：相关页面（0-5个）
  final List<String> keywords;   // 可选：搜索关键词
}
```

**字段说明**：

1. **必填字段**：确保所有页面至少有基本信息
   - `pageId`：与路由对应，用于查找
   - `title`：显示名称
   - `module`：用于分类导航
   - `description`：核心信息，用户快速了解作用

2. **推荐字段**：提供实用价值
   - `useCases`：帮助用户理解何时使用该功能
   - `steps`：最重要的实操指导

3. **可选字段**：增强但非必须
   - `tips`：进阶技巧和注意事项
   - `relatedPages`：引导用户发现相关功能
   - `keywords`：优化搜索（如果标题和描述不够）

**权衡**：
- 不包含图片路径：初期专注文字内容，图片后续增强
- 不包含视频：避免增加应用体积
- 步骤不包含详细的字段属性：保持简洁

---

### 决策4：UI导航结构

**问题**：如何组织帮助页面的导航，让用户快速找到需要的信息？

**设计方案**：

```
HelpPage (TabBar)
├── 快速入门 (QuickStartTab)
│   └── 精选5-10个核心教程
├── 按模块浏览 (ModuleBrowserTab)
│   ├── 20个模块列表
│   └── 点击模块 → 页面列表 → 页面详情
└── 常见问题 (FAQTab)
    └── 分类FAQ列表
```

**导航路径示例**：

1. **快速查找**：搜索栏 → 直接进入页面详情
2. **探索式**：模块列表 → 页面列表 → 页面详情
3. **新手**：快速入门 → 教程详情
4. **问题排查**：常见问题 → 展开FAQ

**关键设计点**：

1. **搜索优先**：搜索栏固定在顶部，任何时候都可搜索
2. **三级导航**：模块 → 页面 → 详情，深度合理
3. **面包屑**：在详情页显示路径，方便返回
4. **相关功能链接**：在详情页提供横向导航

---

### 决策5：搜索实现策略

**问题**：如何实现快速准确的帮助内容搜索？

**搜索范围**：
- 页面标题（权重最高）
- 功能描述
- 使用场景
- 操作步骤中的关键词
- 自定义关键词

**搜索算法**：

```dart
// 简化的相关度计算
double calculateRelevance(HelpContent content, String query) {
  double score = 0.0;

  // 标题完全匹配：+10分
  if (content.title.toLowerCase() == query.toLowerCase()) {
    score += 10.0;
  }
  // 标题包含：+5分
  else if (content.title.toLowerCase().contains(query.toLowerCase())) {
    score += 5.0;
  }

  // 描述包含：+3分
  if (content.description.toLowerCase().contains(query.toLowerCase())) {
    score += 3.0;
  }

  // 关键词匹配：+2分
  if (content.keywords.any((k) => k.toLowerCase().contains(query.toLowerCase()))) {
    score += 2.0;
  }

  // 使用场景/步骤包含：+1分
  // ...

  return score;
}
```

**优化策略**：
1. **缓存**：帮助内容全部缓存在内存中
2. **异步搜索**：搜索在独立线程进行（Isolate）
3. **实时更新**：输入时实时显示结果
4. **最近搜索**：记录搜索历史，快速回溯

---

### 决策6：内容编写工作流

**问题**：如何确保237个页面的帮助内容质量和一致性？

**编写流程**：

1. **模板化**：提供标准模板，确保结构一致
   ```json
   {
     "pageId": "/example",
     "title": "示例页面",
     "module": "模块名称",
     "description": "一句话描述功能作用",
     "useCases": [
       "场景1：具体场景描述",
       "场景2：具体场景描述"
     ],
     "steps": [
       {
         "title": "步骤1",
         "description": "详细操作说明"
       }
     ],
     "tips": [
       "注意事项1",
       "注意事项2"
     ],
     "relatedPages": ["/related1", "/related2"]
   }
   ```

2. **分工协作**：
   - 核心模块（50页）：由产品经理或资深用户编写
   - 其他模块（187页）：可由开发者编写基础版本
   - 后续优化：根据用户反馈持续改进

3. **质量检查**：
   - 必填字段检查（CI/CD自动化）
   - 拼写和语法检查（可选：自动化工具）
   - 内容审核（人工Review）

4. **版本同步**：
   - 新功能开发时同步编写帮助内容
   - Code Review时检查是否包含帮助内容更新
   - 功能改动时更新对应帮助内容

---

### 决策7：性能优化策略

**问题**：237个页面的帮助内容如何保证加载性能？

**预期数据量**：
- 每个页面帮助：平均1KB
- 总量：~237KB
- JSON解析：~50ms（首次）

**优化方案**：

1. **启动时加载**（推荐）
   - 应用启动时后台加载所有帮助内容
   - 缓存到内存中
   - 首次打开帮助页面时已加载完成

2. **懒加载**（备选，如果数据量更大）
   - 先加载模块列表和快速入门
   - 点击模块时加载该模块内容
   - 适合未来扩展到500+页面

3. **缓存策略**
   ```dart
   class HelpContentService {
     Map<String, HelpContent> _cache = {};
     bool _isLoaded = false;

     Future<void> preload() async {
       if (_isLoaded) return;
       // 加载所有模块JSON
       _cache = await _loadAllModules();
       _isLoaded = true;
     }

     HelpContent? getContent(String pageId) {
       return _cache[pageId];
     }
   }
   ```

**性能目标**：
- 首次加载：< 200ms
- 搜索响应：< 100ms
- 页面切换：< 50ms

---

### 决策8：扩展性设计

**问题**：如何为未来功能预留扩展空间？

**可能的未来需求**：

1. **多语言支持**
   - 方案：为每种语言创建独立的JSON文件集
   - 文件结构：`assets/help/en/`, `assets/help/zh/`
   - 根据应用语言设置加载对应语言的帮助内容

2. **在线更新**
   - 方案：支持从服务器下载最新帮助内容
   - 本地JSON作为默认版本
   - 下载的内容覆盖本地缓存
   - 应用重启时使用更新后的内容

3. **图片和视频**
   - 方案：`HelpStep`中添加`mediaUrl`字段
   - 图片/视频存储在assets或CDN
   - 初期不实现，保留扩展接口

4. **用户生成内容**
   - 方案：允许用户添加笔记或评论
   - 存储在本地数据库
   - 与官方帮助内容分离显示

5. **智能推荐**
   - 方案：根据用户使用习惯推荐相关帮助
   - 统计用户操作，识别困惑点
   - 在合适时机弹出帮助提示

**扩展原则**：
- 保持核心模型简单
- 通过可选字段和版本化支持扩展
- 避免过度设计

---

## 技术风险评估

### 风险1：内容维护成本高

**风险描述**：237个页面的帮助内容需要持续维护，功能更新时容易遗漏

**缓解措施**：
1. 建立开发流程规范，功能PR必须包含帮助内容更新
2. 自动化检查：CI检查新增页面是否有对应帮助内容
3. 定期审核：每季度审核帮助内容与实际功能的一致性

### 风险2：JSON文件冲突

**风险描述**：多人同时编辑同一模块的JSON文件导致Git冲突

**缓解措施**：
1. 文件按模块拆分，减少冲突概率
2. 建议：大规模内容编写时协调分工
3. JSON格式化规范，减少无意义的格式差异

### 风险3：搜索性能

**风险描述**：全文搜索可能在低端设备上性能不佳

**缓解措施**：
1. 初期实现简单算法，满足基本需求
2. 监控性能，如有问题再优化
3. 备选方案：使用全文搜索库（如flutter_search）

---

## 开发检查清单

在实施前确认：

- [ ] 确认JSON文件组织结构（20个模块文件）
- [ ] 确认数据模型字段（必填、推荐、可选）
- [ ] 确认UI导航结构（三个Tab）
- [ ] 确认搜索算法（简单相关度计算）
- [ ] 确认性能优化策略（启动时加载）
- [ ] 确认内容编写模板和规范
- [ ] 确认质量检查流程（CI + 人工审核）
- [ ] 确认扩展性预留（多语言、在线更新接口）
