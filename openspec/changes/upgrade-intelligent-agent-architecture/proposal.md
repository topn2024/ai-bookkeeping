# 提案：智能体架构升级

## 背景

当前语音助手的架构存在以下问题：

1. **执行与对话耦合**：业务操作（如记账）阻塞对话流程，用户需要等待操作完成才能继续交互
2. **输入预处理缺失**：无意义输入（语气词）、情绪表达、用户反馈（确认/取消）直接进入 LLM，浪费资源
3. **执行结果通知生硬**：操作完成后立即告知用户，不考虑对话上下文和时机
4. **聚合等待时间固定**：1500ms 的固定等待无法适应不同场景，连续多笔交易体验差

## 目标

构建更智能的语音交互体验：
- 快速过滤无意义输入，减少 LLM 调用
- 用户可以"边聊边做"，对话不被业务操作阻塞
- 在合适的时机自然地告知执行结果
- 滑动窗口 + 动态等待时间，优化多笔交易录入

## 核心设计

### 1. 两层分类架构

**第一层：InputFilter（预处理，<10ms，纯规则）**

| 类型 | 特征 | 响应策略 |
|------|------|----------|
| noise | 语气词（嗯、啊、哦、那个...）| 静默忽略，继续监听 |
| emotion | 情绪表达（啊啊啊、呜呜呜、哈哈哈）| 情感关怀回复 |
| feedback | 用户反馈（嗯嗯、好的、不要、取消）| 处理确认/取消/犹豫 |
| processable | 可处理内容 | 进入第二层 |

**第二层：SmartIntentRecognizer（现有，LLM+规则）**

| 类型 | 说明 |
|------|------|
| operation | 业务操作 → 执行队列 |
| chat | 闲聊 → ChatEngine |
| clarify | 意图模糊 → 反问澄清 |
| failed | 识别失败 → 错误处理 |

### 2. 执行层与对话层分离

```
用户输入 → InputFilter →
  ├─ noise → 忽略
  ├─ emotion → 情感回复
  ├─ feedback → 处理确认/取消
  └─ processable → SmartIntentRecognizer →
       ├─ operation → ExecutionQueue（异步）+ 立即确认
       └─ chat → ChatEngine

ExecutionQueue 完成 → ResultBuffer 暂存 → TimingJudge 判断时机 → 适时通知
```

### 3. 时机判断器（TimingJudge）

执行结果不立即告知，而是根据对话状态判断时机：
- 用户主动询问 → immediate（立即告知）
- 用户刚说完业务相关话题 → natural（自然融入回复）
- 用户沉默/主动话题时机 → onIdle（主动告知）
- 用户话题转换 → onTopicShift（适时告知）
- 用户深度闲聊/情绪不佳 → defer（暂不告知）

### 4. 滑动窗口 + 动态聚合

**滑动窗口机制**：每次 ASR 返回新内容时，计时器重置

```
T0:     "早餐15" → 缓冲区[早餐15] → 计时器(1200ms)
T800:   "午餐35" → 缓冲区[早餐15,午餐35] → 重置计时器(1200ms)
T1500:  "还有晚餐50" → 检测到"还有" → 重置计时器(2000ms，延长)
T2800:  "打车20" → 缓冲区[...] → 重置计时器(1200ms)
T4000:  计时器到期 → 聚合处理4笔交易
```

**动态等待时间**：
- 检测到连接词（还有、另外）→ 延长至 2000ms
- 完整交易 + VAD停顿 > 500ms → 缩短至 800ms
- 以逗号结尾（列举模式）→ 延长至 2000ms
- 默认 → 1200ms

## 范围

### 包含
- InputFilter 输入预过滤器
- ResultBuffer 结果缓冲
- TimingJudge 时机判断器
- DynamicAggregationWindow 动态聚合窗口
- 对话上下文融合

### 不包含
- TTS/ASR 底层优化
- 新增业务操作类型
- UI 层改动

## 影响

### 修改的模块
- `intelligence_engine.dart` - 集成 InputFilter，分离执行/对话
- `voice_pipeline_controller.dart` - 滑动窗口 + 动态聚合
- `chat_engine.dart` - 融合执行结果上下文

### 新增的模块
- `input_filter.dart` - 输入预过滤器
- `result_buffer.dart` - 结果缓冲
- `timing_judge.dart` - 时机判断器
- `dynamic_aggregation_window.dart` - 动态聚合窗口

## 风险

1. **规则维护成本**：InputFilter 的规则需要持续调优
2. **时机判断误差**：可能出现告知时机不当的情况
3. **滑动窗口边界**：极端情况下可能无限等待（需要最大等待时间兜底）

## 成功标准

1. 无意义输入（语气词）不触发 LLM 调用
2. 业务操作不阻塞对话流程
3. 执行结果在合适时机自然融入对话
4. 多笔交易连续录入体验流畅（5笔以内无明显等待感）
