# 语音流水线规范

## 新增需求

### 需求：流式TTS流水线

系统**必须**实现三路并行的流式TTS流水线，将LLM生成、TTS合成、音频播放三个环节并行处理。

#### 场景：LLM流式输出触发TTS合成

**给定** 用户完成语音输入
**当** LLM开始流式生成响应
**那么** 系统**必须**：
- 将LLM输出流入句子缓冲区
- 检测到完整句子后立即放入TTS队列
- TTS队列工作器异步合成音频
- 合成的音频立即开始播放
- LLM生成、TTS合成、音频播放三个环节并行执行

#### 场景：首字延迟要求

**给定** ASR返回用户最终识别结果
**当** 系统处理并生成响应
**那么** 从ASR最终结果到用户听到第一个音频字节的时间**必须**小于600ms

#### 场景：句子缓冲区分割

**给定** LLM正在流式生成文本
**当** 文本中出现句子分隔符（。！？；\n）
**那么** 系统**必须**：
- 提取完整句子（包含分隔符）
- 检查句子长度是否达到最小要求（4个字符）
- 将符合要求的句子放入TTS队列
- 保留剩余文本继续缓冲

---

### 需求：三层打断检测

系统**必须**实现三层递进的打断检测机制，在TTS播放期间快速响应用户打断。

#### 场景：第一层打断检测（VAD + ASR联合）

**给定** TTS正在播放
**并且** VAD检测到用户语音活动
**当** ASR返回中间结果且长度 ≥ 4个字符
**并且** 中间结果与当前TTS文本的相似度 < 0.4
**那么** 系统**必须**在200ms内停止TTS播放并处理用户新输入

#### 场景：第二层打断检测（纯ASR）

**给定** TTS正在播放
**当** ASR返回中间结果且长度 ≥ 8个字符
**并且** 中间结果与当前TTS文本的相似度 < 0.3
**那么** 系统**必须**在500ms内停止TTS播放并处理用户新输入

#### 场景：第三层打断检测（完整句子）

**给定** TTS正在播放
**当** ASR返回完整识别结果
**并且** 结果通过四层回声过滤
**那么** 系统**必须**停止TTS播放并处理用户新输入

#### 场景：打断冷却期

**给定** 刚刚触发了一次打断
**当** 在1.5秒内再次检测到可能的打断
**那么** 系统**必须**忽略该打断请求（防止误触发）

---

### 需求：四层回声防护

系统**必须**实现四层回声防护机制，防止TTS播放的声音被ASR误识别为用户输入。

#### 场景：硬件级AEC

**给定** 系统启动音频录制
**那么** 系统**必须**使用 VOICE_COMMUNICATION 音源以启用系统级回声消除

#### 场景：文本相似度过滤

**给定** TTS正在播放文本T
**当** ASR识别到文本A
**并且** A与T的相似度 > 0.5
**那么** 系统**必须**将A判定为回声并忽略

#### 场景：短句过滤

**给定** TTS正在播放
**当** ASR识别到长度 < 3个字符的文本
**那么** 系统**必须**将其判定为可能的回声并忽略

#### 场景：静默窗口

**给定** TTS刚刚停止播放
**当** 在停止后500ms内ASR识别到文本
**那么** 系统**必须**对该文本进行更严格的回声过滤

---

### 需求：响应ID追踪

系统**必须**使用响应ID机制防止竞态条件。

#### 场景：新响应覆盖旧响应

**给定** 响应A正在处理中（ID=1）
**当** 用户打断并触发新响应B（ID=2）
**那么** 系统**必须**：
- 立即停止响应A的TTS播放
- 丢弃响应A后续的TTS队列任务
- 开始处理响应B

#### 场景：旧响应完成事件忽略

**给定** 响应B正在处理中（ID=2）
**当** 响应A（ID=1）的完成事件到达
**那么** 系统**必须**忽略该完成事件，不影响响应B的处理

---

### 需求：会话状态管理

系统**必须**维护简洁的会话状态机。

#### 场景：状态转换 - 正常流程

**给定** 系统处于IDLE状态
**当** 用户启动语音助手
**那么** 系统**必须**转换到LISTENING状态
**当** 用户说话完成
**那么** 系统**必须**转换到PROCESSING状态
**当** 开始播放响应
**那么** 系统**必须**转换到SPEAKING状态
**当** 播放完成
**那么** 系统**必须**转换回LISTENING状态

#### 场景：状态转换 - 打断

**给定** 系统处于SPEAKING状态
**当** 检测到有效的用户打断
**那么** 系统**必须**立即转换到LISTENING状态

#### 场景：沉默超时

**给定** 系统处于LISTENING状态
**当** 用户30秒内无语音输入
**那么** 系统**必须**自动结束会话并转换到IDLE状态

---

## 修改需求

### 需求：流式TTS服务改进

原有的流式TTS服务**必须**支持队列模式。

#### 场景：句子队列合成

**给定** TTS队列中有多个待合成句子
**当** 当前句子合成完成
**那么** 系统**必须**立即开始下一个句子的合成，无需等待播放完成

#### 场景：合成失败降级

**给定** 流式TTS合成失败
**当** 连续失败次数达到3次
**那么** 系统**必须**自动降级到离线TTS模式

---

### 需求：VAD服务增强

原有的VAD服务**必须**支持打断检测联动。

#### 场景：TTS播放期间的VAD

**给定** TTS正在播放
**当** VAD检测到语音活动
**那么** 系统**必须**将VAD结果传递给打断检测器

---

## 性能需求

### 需求：延迟指标

系统**必须**满足以下延迟指标。

#### 场景：首字延迟

**给定** 系统正常运行
**当** 测量首字延迟（ASR最终结果到TTS首音频）
**那么** 95%的请求**必须**在600ms内完成

#### 场景：打断响应

**给定** TTS正在播放
**当** 用户打断
**那么** 95%的打断**必须**在300ms内响应

### 需求：准确性指标

系统**必须**满足以下准确性指标。

#### 场景：回声误触发率

**给定** TTS正在播放
**当** 统计回声误触发
**那么** 误触发率**必须**低于1%

#### 场景：有效打断识别率

**给定** 用户在TTS播放期间说话
**当** 用户意图打断
**那么** 系统**必须**有95%以上的概率正确识别打断
