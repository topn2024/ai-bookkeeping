# 变更：实现全局语音助手系统

## 为什么

当前的语音助手实现存在以下限制：
1. **页面绑定** - 语音功能只能在特定页面使用，用户需要先导航到语音页面才能开始记账
2. **上下文割裂** - 离开语音页面后对话状态丢失，无法实现连续交互
3. **操作繁琐** - 用户需要多次点击才能完成一次语音记账
4. **体验中断** - 使用语音功能时必须离开当前页面，打断用户的工作流程

用户期望的是一个"随时可用、无处不在"的语音助手，能够在任何页面快速启动语音交互，同时保持当前页面上下文不丢失。

## 变更内容

### 核心功能

1. **全局悬浮球 Overlay**
   - 使用 Flutter Overlay 实现真正的全局悬浮球
   - 悬浮球始终显示在所有页面之上
   - 支持拖动定位和边缘吸附
   - 用户可手动隐藏/显示

2. **一键语音激活**
   - 点击悬浮球立即开始录音
   - 图标变为波浪形动画表示正在录音
   - 松开或再次点击停止录音
   - 录音过程中悬浮球保持可见

3. **上下文感知**
   - 语音助手自动感知当前所在页面
   - 根据页面上下文提供智能响应
   - 例如在预算页面问"还剩多少"自动理解为查询预算余额

4. **后台对话界面**
   - 聊天界面记录所有交互历史
   - 可收起到后台继续悬浮球交互
   - 随时打开查看完整对话记录
   - 支持文字输入作为语音补充

### 交互流程

```
[任意页面] → 点击悬浮球 → [悬浮球变为波浪] → 语音输入
                                              ↓
                              [AI处理] → [悬浮球短暂显示结果]
                                              ↓
                              继续当前页面 或 打开聊天界面查看详情
```

### 状态设计

悬浮球状态：
- `idle` - 默认麦克风图标
- `recording` - 波浪动画，表示正在录音
- `processing` - 加载动画，表示正在处理
- `success` - 短暂显示勾号
- `error` - 短暂显示错误提示

## 影响

- 受影响规范：global-voice-assistant（新建）
- 受影响代码：
  - `app/lib/services/floating_ball_service.dart` - 升级为全局 Overlay 管理
  - `app/lib/widgets/global_floating_ball.dart` - 新建全局悬浮球组件
  - `app/lib/services/voice_context_service.dart` - 新建上下文感知服务
  - `app/lib/pages/voice_chat_page.dart` - 改造为可后台运行的聊天界面
  - `app/lib/main.dart` - 集成全局悬浮球初始化

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Overlay 层级冲突 | 中 | 使用 OverlayPortal 统一管理层级 |
| 内存占用增加 | 低 | 悬浮球轻量化，延迟初始化语音服务 |
| 上下文感知误判 | 中 | 提供明确的页面标识，允许用户纠正 |
| 与现有页面冲突 | 低 | 悬浮球自动避让关键交互区域 |

## 验收标准

1. 悬浮球在所有页面（除设置明确排除的页面外）始终可见
2. 点击悬浮球后 200ms 内开始录音并显示波浪动画
3. 语音识别结果在 2 秒内返回（正常网络条件）
4. 在预算页面使用语音查询预算时，自动关联当前预算分类
5. 聊天记录在 App 生命周期内持久保存
6. 用户可随时拖动悬浮球到任意位置
7. 悬浮球不遮挡页面关键交互元素（底部导航、FAB 按钮）
