# 全局语音助手规范

## 新增需求

### 需求：全局悬浮球显示

系统必须提供一个全局悬浮球作为语音助手的入口，始终显示在应用界面最顶层，用户可从任意页面快速启动语音交互。

#### 场景：首次启动应用显示悬浮球

```gherkin
假设 用户首次启动应用
当 应用加载完成
那么 悬浮球显示在屏幕右下角
并且 悬浮球显示麦克风图标
并且 悬浮球位于底部导航栏上方
```

#### 场景：悬浮球跨页面持久显示

```gherkin
假设 用户在首页
并且 悬浮球可见
当 用户导航到预算页面
那么 悬浮球仍然可见
并且 悬浮球位置保持不变
```

#### 场景：拖动悬浮球到新位置

```gherkin
假设 悬浮球显示在右下角
当 用户拖动悬浮球到左上角
并且 松开手指
那么 悬浮球吸附到左侧边缘
并且 新位置被保存
```

#### 场景：悬浮球自动避让

```gherkin
假设 悬浮球在底部中央位置
当 底部出现 FAB 按钮
那么 悬浮球自动上移避开 FAB 区域
```

### 需求：一键语音录入

系统必须支持一键语音录入，用户点击悬浮球即可开始语音输入，无需额外操作步骤。

#### 场景：点击开始录音

```gherkin
假设 悬浮球处于 idle 状态
当 用户点击悬浮球
那么 悬浮球状态变为 recording
并且 麦克风图标变为波浪动画
并且 开始录制语音
并且 设备震动提示
```

#### 场景：再次点击停止录音

```gherkin
假设 悬浮球处于 recording 状态
当 用户再次点击悬浮球
那么 停止录音
并且 悬浮球状态变为 processing
并且 显示加载动画
```

#### 场景：录音成功记账

```gherkin
假设 用户正在录音
并且 用户说"午餐花了35块"
当 用户停止录音
那么 系统识别语音内容
并且 创建支出记录金额35元分类餐饮
并且 悬浮球状态变为 success
并且 显示勾号图标2秒
并且 悬浮球恢复为 idle 状态
```

#### 场景：录音识别失败

```gherkin
假设 用户正在录音
并且 录音时间小于0.5秒
当 用户停止录音
那么 悬浮球状态变为 error
并且 显示错误图标
并且 显示提示"录音时间太短"
并且 悬浮球恢复为 idle 状态
```

### 需求：页面上下文感知

语音助手必须能够感知用户当前所在页面，根据页面上下文提供智能化的响应。

#### 场景：首页快速记账

```gherkin
假设 用户在首页
当 用户通过悬浮球说"记一笔35"
那么 系统创建支出记录金额35元
并且 响应"已记录支出35元"
```

#### 场景：预算页查询余额

```gherkin
假设 用户在餐饮预算页面
并且 餐饮预算剩余500元
当 用户通过悬浮球说"还剩多少"
那么 系统识别为查询当前预算
并且 响应"餐饮预算还剩500元"
```

#### 场景：交易详情页修改金额

```gherkin
假设 用户在交易详情页
并且 当前交易金额为50元
当 用户通过悬浮球说"改成80"
那么 系统识别为修改当前交易金额
并且 更新交易金额为80元
并且 响应"已将金额修改为80元"
```

#### 场景：报表页查询统计

```gherkin
假设 用户在月度报表页
并且 当前显示12月数据
当 用户通过悬浮球说"餐饮花了多少"
那么 系统查询12月餐饮支出
并且 响应"12月餐饮支出共XXX元"
```

### 需求：对话历史管理

系统必须记录所有语音交互历史，用户可随时查看完整对话记录。

#### 场景：悬浮球交互记录到历史

```gherkin
假设 用户通过悬浮球完成一次记账
当 交互完成
那么 用户消息添加到对话历史
并且 系统响应添加到对话历史
并且 对话历史时间戳正确
```

#### 场景：长按打开聊天界面

```gherkin
假设 悬浮球处于 idle 状态
当 用户长按悬浮球
那么 打开语音聊天页面
并且 显示完整对话历史
```

#### 场景：聊天界面显示悬浮球交互

```gherkin
假设 用户通过悬浮球记录了3笔支出
当 用户打开聊天界面
那么 显示所有3次交互记录
并且 每条记录显示时间和内容
```

### 需求：悬浮球可配置

系统必须允许用户根据偏好配置悬浮球的显示和行为。

#### 场景：关闭悬浮球

```gherkin
假设 悬浮球处于显示状态
当 用户在设置中关闭悬浮球开关
那么 悬浮球立即隐藏
并且 关闭状态被保存
```

#### 场景：重新开启悬浮球

```gherkin
假设 悬浮球处于关闭状态
当 用户在设置中开启悬浮球开关
那么 悬浮球显示在上次保存的位置
```

#### 场景：排除特定页面

```gherkin
假设 语音设置页被配置为排除页面
当 用户进入语音设置页
那么 悬浮球自动隐藏
当 用户离开语音设置页
那么 悬浮球自动恢复显示
```

## 修改需求

### 需求：改进现有语音聊天页面

必须修改现有语音聊天页面以支持与全局悬浮球的集成，统一对话历史管理。

#### 场景：统一对话历史

```gherkin
假设 用户通过悬浮球完成交互
当 用户打开语音聊天页面
那么 悬浮球交互记录与页面内交互记录统一显示
并且 按时间顺序排列
```

#### 场景：移除聊天页面独立录音

```gherkin
假设 用户在语音聊天页面
当 页面加载完成
那么 不显示独立的录音按钮
并且 悬浮球保持可见用于录音
```

## 移除需求

无

## 重命名需求

无

## 交叉引用

- 关联规范：voice-assistant（语音助手核心规范）
- 关联规范：multi-intent-voice-processing（多意图处理规范）
- 关联规范：complete-voice-assistant（语音助手实现规范）
