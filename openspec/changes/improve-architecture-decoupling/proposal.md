# 提案：改进架构解耦

## 概述

当前 Flutter 应用存在多处架构耦合问题，影响代码的可测试性、可维护性和可扩展性。本提案旨在通过引入依赖注入、完善分层架构、建立服务接口契约等方式，系统性地改进代码架构。

## 背景

### 当前问题

经过代码分析，发现以下主要架构问题：

1. **模型层与服务层耦合** (高优先级)
   - `Account` 和 `Category` 模型直接调用 `LocalizationService`
   - 违反单一职责原则和依赖倒置原则

2. **UI层直接访问数据层** (高优先级)
   - 6 个页面直接调用 `DatabaseService`
   - 违反分层架构原则

3. **缺乏服务接口抽象** (高优先级)
   - 190+ 个服务均为具体实现，无接口定义
   - 难以进行单元测试和模拟

4. **CRUD Notifier 内部创建依赖** (高优先级)
   - 12 个 Provider 继承 `SimpleCrudNotifier`
   - 基类内部直接创建服务实例，无法进行依赖注入

5. **全局单例模式滥用** (中优先级)
   - 所有服务采用单例模式
   - 测试困难，难以隔离

6. **API 配置硬编码** (中优先级)
   - API URL 和密钥硬编码在服务中
   - 环境切换困难

## 目标

1. 建立清晰的分层边界，消除层间反向依赖
2. 引入依赖注入机制，提高可测试性
3. 定义核心服务接口，实现依赖倒置
4. 完善 Repository 模式，统一数据访问
5. 集中化配置管理

## 预期收益

- **可测试性**: 服务可被模拟，单元测试覆盖率可提升
- **可维护性**: 职责清晰，修改影响范围可控
- **可扩展性**: 新增功能无需修改现有代码
- **可配置性**: 支持多环境部署

## 范围

### 包含

- Flutter 应用 (`app/`) 的架构改进
- 核心服务接口定义
- 依赖注入基础设施
- 模型层解耦
- UI 层与数据层分离

### 不包含

- 后端服务 (`server/`) 重构
- 管理后台 (`admin-web/`) 重构
- 功能变更或新增

## 风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 引入回归缺陷 | 中 | 高 | 增量重构，每步验证测试 |
| 重构周期过长 | 中 | 中 | 分阶段实施，优先高价值改进 |
| 团队学习曲线 | 低 | 中 | 提供文档和代码示例 |

## 成功标准

1. `flutter analyze` 无新增警告
2. 所有现有测试通过
3. 核心服务具备接口定义
4. 模型层无服务依赖
5. UI 层不直接访问数据库
