# 语音智能助手规范

## 新增需求

### 需求：语音识别服务

系统必须提供完整的语音识别功能，支持在线和离线两种模式，能够将用户语音准确转换为文本。

#### 场景：在线语音识别成功
- **当** 用户在有网络的环境下进行语音输入
- **并且** 麦克风权限已授予
- **那么** 系统使用阿里云ASR服务进行识别
- **并且** 识别准确率达到95%以上（普通话环境）
- **并且** 识别延迟小于2秒

#### 场景：离线语音识别降级
- **当** 用户在无网络环境下进行语音输入
- **那么** 系统自动切换到Sherpa-ONNX离线识别引擎
- **并且** 提示用户"已切换到离线模式"
- **并且** 识别功能正常可用

#### 场景：流式识别实时反馈
- **当** 用户使用WebSocket流式识别模式
- **那么** 系统实时显示部分识别结果
- **并且** 用户可以看到文字逐步出现
- **并且** 最终结果在用户停止说话后1秒内显示

#### 场景：热词识别增强
- **当** 用户说出常用分类或商家名称
- **那么** 系统使用热词表提高这些词汇的识别准确率
- **并且** 热词表包含用户历史使用的分类和商家

---

### 需求：语音合成服务

系统必须提供语音合成功能，能够将文本转换为自然流畅的语音播报，为用户提供语音反馈。

#### 场景：系统TTS播报
- **当** 系统需要向用户播报信息
- **并且** 用户未设置高质量TTS偏好
- **那么** 系统使用Flutter TTS进行播报
- **并且** 播报延迟小于500ms
- **并且** 语音清晰可理解

#### 场景：高质量TTS播报
- **当** 用户设置了高质量TTS偏好
- **并且** 网络可用
- **那么** 系统使用阿里云TTS进行播报
- **并且** 语音更加自然流畅
- **并且** 支持多种音色选择

#### 场景：TTS播放控制
- **当** TTS正在播报
- **那么** 用户可以暂停播报
- **并且** 用户可以停止播报
- **并且** 用户可以调节语速和音量

#### 场景：TTS离线降级
- **当** 网络不可用
- **并且** 用户设置了高质量TTS
- **那么** 系统自动降级到Flutter TTS
- **并且** 功能正常可用

---

### 需求：唤醒词检测

系统必须支持语音唤醒功能，用户可以通过说出唤醒词来激活语音助手，无需手动点击。

#### 场景：唤醒词激活助手
- **当** 唤醒词功能已开启
- **并且** 用户说出唤醒词"小白管家"
- **那么** 语音助手被激活
- **并且** 系统播放激活提示音
- **并且** 开始监听用户指令

#### 场景：后台唤醒检测
- **当** 应用在后台运行
- **并且** 唤醒词功能已开启
- **那么** 系统持续监听唤醒词
- **并且** 检测到唤醒词时将应用唤起到前台

#### 场景：唤醒词灵敏度调节
- **当** 用户在设置中调节唤醒词灵敏度
- **那么** 系统根据设置调整检测阈值
- **并且** 高灵敏度更容易触发但可能有误触
- **并且** 低灵敏度更精确但可能漏检

#### 场景：唤醒词功能关闭
- **当** 用户关闭唤醒词功能
- **那么** 系统停止后台音频监听
- **并且** 释放相关资源
- **并且** 用户只能通过点击激活助手

---

### 需求：API密钥安全管理

系统必须安全地管理语音服务所需的API密钥，确保密钥不被泄露或滥用。

#### 场景：Token代理获取
- **当** 客户端需要访问语音服务API
- **那么** 客户端向后端Token代理请求临时Token
- **并且** 后端使用安全存储的AK/SK获取Token
- **并且** 返回有效期1小时的临时Token

#### 场景：Token安全存储
- **当** 客户端获取到临时Token
- **那么** Token存储在flutter_secure_storage中
- **并且** Token经过加密保护
- **并且** Token不会出现在日志或调试信息中

#### 场景：Token自动刷新
- **当** Token即将过期（剩余时间小于5分钟）
- **那么** 系统自动请求新Token
- **并且** 无缝切换到新Token
- **并且** 用户无感知

#### 场景：Token获取失败
- **当** Token代理服务不可用
- **那么** 系统降级到离线模式
- **并且** 提示用户"在线服务暂时不可用"

---

### 需求：确认流程交互

系统必须在执行重要操作前向用户确认，支持语音和触摸两种确认方式。

#### 场景：语音确认流程
- **当** 系统需要用户确认操作（如添加交易）
- **那么** 系统播报确认提示"确认记录xxx吗？"
- **并且** 用户可以说"是"或"确认"来确认
- **并且** 用户可以说"否"或"取消"来取消
- **并且** 确认超时（10秒）后自动取消

#### 场景：触摸确认流程
- **当** 系统需要用户确认操作
- **那么** 系统显示确认对话框
- **并且** 用户可以点击"确认"或"取消"按钮
- **并且** 对话框显示操作详情

#### 场景：确认流程超时
- **当** 用户在确认流程中超过10秒未响应
- **那么** 系统自动取消操作
- **并且** 播报"操作已取消"
- **并且** 返回待命状态

---

### 需求：命令历史记录

系统必须记录用户的语音命令历史，方便用户查看和重放历史命令。

#### 场景：命令历史显示
- **当** 用户打开命令历史面板
- **那么** 系统显示最近50条语音命令
- **并且** 每条记录包含：原始语音文本、执行结果、时间戳
- **并且** 按时间倒序排列

#### 场景：命令历史重放
- **当** 用户点击历史命令记录
- **那么** 系统重新执行该命令
- **并且** 显示执行结果

#### 场景：命令历史清空
- **当** 用户点击清空历史按钮
- **那么** 系统删除所有命令历史
- **并且** 显示"历史已清空"提示

---

### 需求：错误处理和稳定性

系统必须优雅地处理各种错误情况，确保语音功能的稳定性和用户体验。

#### 场景：网络超时处理
- **当** API请求超过10秒未响应
- **那么** 系统取消请求
- **并且** 尝试重试（最多3次）
- **并且** 重试失败后降级到离线模式

#### 场景：API限流处理
- **当** 收到API限流响应（429）
- **那么** 系统使用指数退避重试
- **并且** 提示用户"请稍后再试"
- **并且** 可选择切换到离线模式

#### 场景：识别失败重试
- **当** 语音识别失败或结果为空
- **那么** 系统提示"没听清，请再说一遍"
- **并且** 自动重新开始监听
- **并且** 连续3次失败后停止

#### 场景：权限检查和引导
- **当** 用户首次使用语音功能
- **那么** 系统检查麦克风权限
- **并且** 权限未授予时显示说明对话框
- **并且** 提供跳转系统设置的按钮
