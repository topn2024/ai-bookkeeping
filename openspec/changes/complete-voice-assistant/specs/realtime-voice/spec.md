# 规范增量：实时语音对话

## 新增需求

### 需求：实时对话会话管理

系统应提供实时对话会话管理能力，支持自然流畅的语音交互。

#### 场景：用户点击悬浮球开始对话

**前提条件**:
- 用户已授权麦克风权限
- 悬浮球处于空闲状态

**操作**:
1. 用户点击悬浮球

**预期结果**:
- 系统进入监听状态
- 悬浮球显示监听动画
- VAD开始检测语音活动

#### 场景：系统检测到用户说话结束

**前提条件**:
- 系统处于用户说话状态
- VAD检测到500ms静音

**操作**:
1. VAD报告语音结束事件

**预期结果**:
- 系统自动进入思考状态
- 开始处理用户输入
- 无需用户手动点击

#### 场景：智能体说话后等待用户响应

**前提条件**:
- 智能体刚说完一句话

**操作**:
1. 系统进入轮次结束停顿（1.5秒）

**预期结果**:
- 系统保持监听状态
- 如果用户在停顿期间说话，立即响应
- 如果超时，进入等待输入状态

#### 场景：用户长时间沉默后智能体主动发起话题

**前提条件**:
- 系统处于等待输入状态
- 用户沉默超过5秒
- 有可用的主动话题

**操作**:
1. 等待超时触发

**预期结果**:
- 系统进入主动状态
- 智能体主动发起话题
- 话题基于用户画像和上下文

### 需求：对话层与执行层分离

系统应实现对话层与执行层的分离，使操作执行不阻塞对话流程。

#### 场景：用户发起记账操作

**前提条件**:
- 用户说"记一笔午餐35块"
- 系统识别为记账意图

**操作**:
1. 对话层生成响应"好的，记下了"
2. 同时将操作请求发送到执行层

**预期结果**:
- 用户立即听到确认响应
- 操作在后台异步执行
- 对话流程不被阻塞

#### 场景：执行结果反馈到对话

**前提条件**:
- 后台操作执行完成
- 用户仍在对话中

**操作**:
1. 执行层返回操作结果

**预期结果**:
- 结果注入对话上下文
- 智能体可主动告知"刚才那笔记好了"
- 用户可以说"改成50"修改

### 需求：智能打断机制

系统应支持用户随时打断智能体说话。

#### 场景：用户打断智能体说话

**前提条件**:
- 智能体正在播放TTS
- VAD检测到用户开始说话

**操作**:
1. 用户开始说话
2. 或说"停"、"等等"

**预期结果**:
- TTS音量在100ms内淡出停止
- 取消当前AI响应生成
- 系统切换到监听模式
- 处理用户新请求

#### 场景：用户说"继续"恢复被打断内容

**前提条件**:
- 智能体说话被打断
- 打断内容已记录

**操作**:
1. 用户说"继续"

**预期结果**:
- 智能体从打断处继续说

### 需求：对话自动结束

系统应能检测用户结束对话的意图并优雅关闭。

#### 场景：用户显式结束对话

**前提条件**:
- 对话进行中

**操作**:
1. 用户说"好了"、"没了"、"谢谢"或"拜拜"

**预期结果**:
- 系统检测到结束意图
- 智能体说"好的，有需要随时叫我"
- 1秒后自动关闭会话
- 悬浮球恢复空闲状态

#### 场景：用户隐式结束对话

**前提条件**:
- 连续两轮用户无响应

**操作**:
1. 智能体主动询问后用户无响应

**预期结果**:
- 系统优雅结束对话
- 悬浮球恢复空闲状态

### 需求：异常输入处理

系统应能优雅处理各类异常输入。

#### 场景：语音识别层异常-静音输入

**前提条件**:
- 系统处于监听状态
- 检测到纯静音/噪音

**操作**:
1. 用户只是试麦克风

**预期结果**:
- 系统友好提示"没听清，再说一次？"
- 保持监听状态

#### 场景：语义理解层异常-无关话题

**前提条件**:
- 用户说了与记账无关的话题

**操作**:
1. 用户说"今天天气怎么样"

**预期结果**:
- 智能体友好回应"这个我不太懂，记账的事我在行～"
- 引导用户回到记账场景

#### 场景：操作层异常-越权操作

**前提条件**:
- 用户尝试危险操作

**操作**:
1. 用户说"删除所有记录"

**预期结果**:
- 系统阻止操作
- 提示"这个操作风险较高，需要在设置里手动操作"

### 需求：高频重复输入处理

系统应能智能处理高频或重复输入。

#### 场景：快速重复相同指令

**前提条件**:
- 3秒内收到相同或近似指令

**操作**:
1. 用户重复说"记一笔午餐35"

**预期结果**:
- 只执行第一次
- 响应"收到了，正在处理～"（只响应一次）

#### 场景：来回修改同一笔记录

**前提条件**:
- 短时间内对同一笔记录修改超过3次

**操作**:
1. 用户说"改成35"→"不对改40"→"还是35"

**预期结果**:
- 友好询问"改了好几次了，要不我显示出来你直接改？"
- 提供UI编辑选项

### 需求：中断恢复机制

系统应能从各种中断场景中恢复。

#### 场景：多轮对话中途放弃

**前提条件**:
- 系统追问"金额多少？"
- 用户沉默/切换页面

**操作**:
1. 用户5秒内无响应

**预期结果**:
- 系统提示"没想好的话，等会儿再说也行～"
- 保存当前对话状态
- 下次激活语音时：
  - 间隔<10分钟: "接着刚才的，金额多少？"
  - 间隔>10分钟: 重新开始

#### 场景：来电/通知打断

**前提条件**:
- 对话进行中
- 应用被切换到后台

**操作**:
1. 用户接电话或查看通知

**预期结果**:
- 立即保存对话上下文
- 如果正在进行关键操作，自动取消
- 用户返回后：
  - 间隔<2分钟: "刚才被打断了，继续吗？"
  - 间隔<30分钟: 轻提示"可以继续刚才的操作"
  - 间隔>30分钟: 直接重置

#### 场景：用户突然改变意图

**前提条件**:
- 用户正在记账中途

**操作**:
1. 用户说"算了，先查一下上个月花了多少"

**预期结果**:
- 识别到新意图，优先处理
- 暂存未完成的操作上下文
- 新意图处理完成后询问"对了，刚才午餐那笔还要记吗？"
