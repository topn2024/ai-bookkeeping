# 提案：修复 App 代码质量问题

## 概述

本提案旨在系统性地修复 AI Bookkeeping 应用中发现的代码完整性和一致性问题，提升代码质量、稳定性和可维护性。

## 背景

通过对 app/lib 目录下所有代码的全面审查，发现了以下几类问题：

1. **严重运行时问题**：包括会导致崩溃的代码逻辑错误
2. **内存泄漏风险**：Stream 监听未正确取消、资源未释放
3. **数据序列化不一致**：DateTime、Boolean、Enum 的序列化方式混乱
4. **错误处理缺失**：大量异步操作未捕获异常
5. **国际化不完整**：154 个页面存在硬编码中文字符串
6. **代码冗余**：151 个孤立页面未被使用

## 目标

1. 消除所有会导致运行时崩溃的代码问题
2. 修复内存泄漏和资源管理问题
3. 统一数据序列化规范
4. 完善错误处理机制
5. 提升代码可维护性

## 范围

### 包含

- `app/lib/models/` - 数据模型层
- `app/lib/services/` - 服务层
- `app/lib/providers/` - 状态管理层
- `app/lib/pages/` - 页面层（仅修复严重问题）

### 不包含

- 国际化完整覆盖（范围过大，建议单独提案）
- 孤立页面清理（需要产品决策）
- UI/UX 改进

## 实施阶段

### Phase 1: 严重问题修复（Critical）
- 修复运行时崩溃问题
- 修复安全漏洞
- 修复内存泄漏

### Phase 2: 模型层一致性（High）
- 统一 DateTime 序列化格式
- 统一 Boolean 序列化方式
- 统一 Enum 序列化方式
- 补全缺失的序列化方法
- 解决类名重复问题

### Phase 3: 服务层健壮性（High）
- 修复 async void 反模式
- 完善错误处理
- 修复资源管理问题
- 统一单例模式实现

### Phase 4: Provider 层规范化（Medium）
- 统一 dispose 实现
- 完善错误状态处理
- 修复异步初始化问题

## 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 序列化变更导致数据不兼容 | 中 | 高 | 添加迁移逻辑，保持向后兼容 |
| 重构引入新 bug | 中 | 中 | 逐步修改，每步验证 |
| 修改影响范围过大 | 低 | 中 | 分阶段实施，优先修复严重问题 |

## 成功标准

1. 所有严重问题（运行时崩溃）修复完成
2. 代码通过 `flutter analyze` 无 error
3. 现有测试全部通过
4. 无新增内存泄漏

## 相关文档

- [设计文档](./design.md) - 详细技术方案
- [任务列表](./tasks.md) - 实施任务分解
