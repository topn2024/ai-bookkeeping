# 语音智能体规范增量

## 修改需求

### 需求：主动对话计数管理

系统必须正确追踪主动对话次数，仅在用户主动输入时重置计数，系统延迟响应不应影响计数。

#### 场景：用户主动输入重置计数
- **当** 用户通过语音输入新内容
- **那么** 主动对话计数器重置为0
- **并且** 静默计时器重新开始

#### 场景：系统延迟响应不重置计数
- **当** 系统处理延迟操作后发送响应
- **那么** 主动对话计数器保持不变
- **并且** 静默计时器重新开始

#### 场景：连续主动对话达到上限
- **当** 系统连续发起3次主动对话且用户无响应
- **那么** 系统应结束当前会话
- **并且** 播放友好的告别语

---

### 需求：会话超时管理

系统必须在用户持续无响应时自动结束会话，30秒总计无响应计时器在任何情况下都应正确工作。

#### 场景：30秒无响应结束会话
- **当** 会话开始后用户持续30秒无任何输入
- **那么** 系统自动结束会话
- **并且** 释放所有资源

#### 场景：用户输入重置30秒计时器
- **当** 用户在30秒内有任何输入
- **那么** 30秒计时器重新开始计时

#### 场景：主动对话后继续计时
- **当** 系统发起主动对话后用户无响应
- **那么** 30秒总计时器继续计时
- **并且** 不会因主动对话而重置

---

### 需求：延迟操作执行保证

系统必须确保延迟操作在合理时间内执行，即使用户持续输入也不应无限延迟。

#### 场景：滑动窗口聚合
- **当** 用户在2.5秒内有连续输入
- **那么** 系统聚合这些输入一起处理
- **并且** 在用户停止输入2.5秒后执行

#### 场景：最大等待时间强制执行
- **当** 用户持续输入超过10秒
- **那么** 系统强制执行已缓存的延迟操作
- **并且** 开始新的聚合窗口

#### 场景：正常执行延迟操作
- **当** 延迟操作执行完成
- **那么** 系统清理所有相关计时器
- **并且** 通过回调通知外部

---

## 新增需求

### 需求：状态转换原子性

系统必须保证语音会话状态转换的原子性，防止竞态条件导致状态不一致。

#### 场景：并发ASR结果处理
- **当** 多个ASR结果同时到达
- **那么** 系统只处理第一个有效结果
- **并且** 忽略后续过期的结果

#### 场景：状态版本校验
- **当** 异步操作完成时状态已变化
- **那么** 系统跳过该操作的状态更新
- **并且** 记录日志便于调试

---

### 需求：音频资源安全管理

系统必须确保音频录制资源的正确释放，防止内存泄漏和资源冲突。

#### 场景：防止重复启动录音
- **当** 录音已在进行中时再次调用启动
- **那么** 系统跳过重复启动
- **并且** 返回已有的录音流

#### 场景：异常时资源清理
- **当** 录音过程中发生异常
- **那么** 系统自动清理所有音频资源
- **并且** 重置录音状态标志

#### 场景：正常停止时资源释放
- **当** 调用停止录音
- **那么** 系统等待录音器完全停止
- **并且** 关闭所有流和订阅

---

### 需求：双通道操作顺序保证

系统必须保证多操作并发入队时的执行顺序，即时操作优先于延迟操作。

#### 场景：即时操作立即执行
- **当** 即时操作入队
- **那么** 系统立即执行该操作
- **并且** 不等待其他操作

#### 场景：延迟操作顺序执行
- **当** 多个延迟操作入队
- **那么** 系统按入队顺序依次执行
- **并且** 等待前一个完成再执行下一个

#### 场景：并发入队互斥
- **当** 多个线程同时入队操作
- **那么** 系统使用锁保护队列
- **并且** 确保操作不会丢失或重复

---

### 需求：网络错误重试机制

系统必须在网络错误时自动重试，使用指数退避策略避免服务过载。

#### 场景：超时自动重试
- **当** LLM识别请求超时
- **那么** 系统使用指数退避重试
- **并且** 最多重试3次

#### 场景：网络错误重试
- **当** 发生网络连接错误
- **那么** 系统自动重试
- **并且** 记录重试日志

#### 场景：业务错误不重试
- **当** 发生业务逻辑错误
- **那么** 系统直接返回错误
- **并且** 不进行重试

#### 场景：重试耗尽降级
- **当** 重试次数耗尽
- **那么** 系统降级到本地规则识别
- **并且** 通知用户使用了降级方案

---

### 需求：操作执行结果详细反馈

系统必须为每个操作提供独立的执行结果，让用户清楚知道哪些成功哪些失败。

#### 场景：全部成功反馈
- **当** 所有操作执行成功
- **那么** 系统返回统一的成功消息
- **例如** "已记录3笔"

#### 场景：部分失败反馈
- **当** 部分操作执行失败
- **那么** 系统分别说明成功和失败的操作
- **例如** "已记录: 早餐15元；失败: 午餐(网络错误)"

#### 场景：全部失败反馈
- **当** 所有操作执行失败
- **那么** 系统返回详细的错误信息
- **并且** 提供重试建议
