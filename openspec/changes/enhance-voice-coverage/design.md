# 语音助手覆盖度增强 - 技术设计

## 上下文

当前语音助手已具备完整的基础架构：
- SmartIntentRecognizer 5层递进识别（精确规则→同义词→模板→学习缓存→LLM兜底）
- VoiceServiceCoordinator 统一协调12种意图类型
- VoiceNavigationService 支持244页导航
- VoiceConfigService 支持114项配置

设计文档（第18章）定义了更完整的能力矩阵，需要扩展现有架构以达成设计目标。

## 目标 / 非目标

### 目标
- 将语音配置项覆盖率从57%提升到90%+
- 将直接操作覆盖率从50%提升到85%+
- 激活自学习系统，实现规则自动优化
- 降低LLM兜底比例从40%到15%以下

### 非目标
- 不重构现有架构（仅扩展）
- 不实现多用户协同学习（预留接口）
- 不实现语音客服系统（知识库仅用于自动回答）

## 架构设计

### 1. 配置项扩展架构

```
┌─────────────────────────────────────────────────────────────┐
│                    VoiceConfigService                        │
├─────────────────────────────────────────────────────────────┤
│  现有114项                           待添加86项              │
│  ┌─────────────┐                   ┌─────────────┐         │
│  │ 预算基础配置 │                   │ 预算高级配置 │         │
│  │ 账户基础配置 │                   │ 信用卡详细  │         │
│  │ 主题/语言   │                   │ 家庭账本权限 │         │
│  │ AI基础开关  │                   │ AI详细参数  │         │
│  │ 同步/备份   │                   │ 习惯培养配置 │         │
│  └─────────────┘                   └─────────────┘         │
│                                                              │
│  配置项命名空间：                                            │
│  - budget.* (预算)     - account.* (账户)                   │
│  - creditcard.* (信用卡) - book.* (账本)                    │
│  - family.* (家庭)     - habit.* (习惯)                     │
│  - ai.* (智能)         - sync.* (同步)                      │
│  - security.* (安全)   - theme.* (主题)                     │
│  - reminder.* (提醒)   - money_age.* (钱龄)                 │
└─────────────────────────────────────────────────────────────┘
```

### 2. 直接操作扩展架构

```
┌─────────────────────────────────────────────────────────────┐
│                VoiceServiceCoordinator                       │
├─────────────────────────────────────────────────────────────┤
│  现有处理器                         待添加处理器             │
│  ┌─────────────────────┐          ┌────────────────────┐   │
│  │ _handleAddIntent    │          │ _handleMoneyAgeOps │   │
│  │ _handleQueryIntent  │          │ _handleHabitOps    │   │
│  │ _handleDeleteIntent │          │ _handleVaultOps    │   │
│  │ _handleModifyIntent │          │ _handleDataOps     │   │
│  │ _handleNavigate     │          │ _handleShareOps    │   │
│  │ _handleConfig       │          │ _handleSystemOps   │   │
│  └─────────────────────┘          └────────────────────┘   │
│                                                              │
│  新增意图类型：                                              │
│  - moneyAgeOperation   - habitOperation                     │
│  - vaultOperation      - dataOperation                      │
│  - shareOperation      - systemOperation                    │
└─────────────────────────────────────────────────────────────┘
```

### 3. 自学习系统激活架构

```
┌─────────────────────────────────────────────────────────────┐
│                    自学习系统架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────┐    ┌──────────────────┐              │
│  │   数据采集层      │    │   反馈信号        │              │
│  │  ┌────────────┐  │    │  • 用户确认      │              │
│  │  │ SampleStore│◄─┼────┤  • 用户修改      │              │
│  │  └────────────┘  │    │  • 用户取消      │              │
│  └────────┬─────────┘    │  • 执行成功/失败 │              │
│           │              └──────────────────┘              │
│           ▼                                                 │
│  ┌──────────────────┐    触发条件：                         │
│  │   模式挖掘层      │    • 样本数 > 100                     │
│  │  ┌────────────┐  │    • 每日凌晨2:00                     │
│  │  │PatternMiner│  │    • 手动触发                        │
│  │  └────────────┘  │                                       │
│  └────────┬─────────┘                                       │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────┐    学习输出：                         │
│  │   规则生成层      │    • 用户个性化规则                   │
│  │  ┌────────────┐  │    • 同义词扩展                       │
│  │  │RuleGenerator│ │    • 模板优化                         │
│  │  └────────────┘  │                                       │
│  └────────┬─────────┘                                       │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────┐    评估指标：                         │
│  │   效果评估层      │    • 规则命中率                       │
│  │  ┌─────────────┐ │    • 准确率变化                       │
│  │  │LearningMetrics│    • LLM调用减少                      │
│  │  └─────────────┘ │                                       │
│  └──────────────────┘                                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4. 知识库系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    知识库系统架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                   知识库入口                           │   │
│  │  • "怎么设置预算" → FAQ匹配                           │   │
│  │  • "这个功能怎么用" → 帮助引导                         │   │
│  │  • "有个问题想反馈" → 问题收集                         │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│           ┌───────────────┼───────────────┐                 │
│           ▼               ▼               ▼                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ FAQ知识库  │  │ 帮助文档库 │  │ 问题工单库 │            │
│  │            │  │            │  │            │            │
│  │ 100+问答对 │  │ 功能说明   │  │ 用户反馈   │            │
│  │ 关键词索引 │  │ 操作指引   │  │ 问题分类   │            │
│  │ 相似度匹配 │  │ 视频链接   │  │ 优先级     │            │
│  └────────────┘  └────────────┘  └────────────┘            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 决策

### 决策1: 配置项扩展方式

**选择**: 在现有VoiceConfigService中添加新配置项，使用命名空间分组

**考虑的替代方案**:
- 创建新的配置服务文件 → 增加维护成本
- 使用配置文件外置 → 不利于类型检查

**理由**: 保持单一数据源，利用现有解析逻辑

### 决策2: 自学习触发机制

**选择**: 被动学习（用户反馈驱动） + 定时学习（凌晨批量处理）

**考虑的替代方案**:
- 实时学习 → 性能开销大
- 纯手动触发 → 用户不会主动使用

**理由**: 平衡性能和时效性

### 决策3: 知识库数据来源

**选择**: 内置FAQ + 设计文档提取 + 用户反馈积累

**考虑的替代方案**:
- 仅LLM生成 → 可控性差
- 人工编辑 → 维护成本高

**理由**: 多来源融合确保覆盖度

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `voice_config_service.dart` | 修改 | 添加86项新配置 |
| `voice_service_coordinator.dart` | 修改 | 添加6种新操作处理器 |
| `smart_intent_recognizer.dart` | 修改 | 扩展规则库和同义词 |
| `voice/self_learning_service.dart` | 新建 | 自学习服务 |
| `voice/knowledge_base_service.dart` | 新建 | 知识库服务 |
| `voice/faq_repository.dart` | 新建 | FAQ数据仓库 |
| `voice/learning_metrics.dart` | 新建 | 学习效果评估 |

## 风险 / 权衡

| 风险 | 缓解措施 |
|------|----------|
| 配置项冲突导致误操作 | 使用明确的命名空间+确认流程 |
| 自学习产生错误规则 | 规则置信度阈值+用户反馈修正 |
| 知识库答案不准确 | 优先使用精确匹配+LLM兜底 |
| 增加App包大小 | 知识库可选下载/按需加载 |

## 待决问题

1. 自学习规则的生效周期（即时 vs 下次启动）
2. 知识库是否需要多语言支持
3. 配置项冲突时的优先级规则
