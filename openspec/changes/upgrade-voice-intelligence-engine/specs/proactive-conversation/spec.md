# 主动对话能力规范

> **能力ID**: proactive-conversation
> **变更ID**: upgrade-voice-intelligence-engine
> **依赖**: adaptive-conversation

## 新增需求

### 需求：ProactiveConversationManager 支持静默触发

**优先级**: P1
**关联能力**: 无

ProactiveConversationManager 必须在用户静默 30 秒后主动发起对话。

#### 场景：30 秒无输入后触发主动对话

**前置条件**:
- ProactiveConversationManager 已初始化
- 用户已完成一次对话
- 主动对话功能已启用

**输入**: 用户 30 秒无输入

**预期行为**:
- 启动 30 秒计时器
- 30 秒后触发主动对话
- 生成话题并播放
- 重置计时器

**验收标准**:
- 计时器准确为 30 秒（误差 ≤ 1s）
- 触发后生成话题
- 话题播放流畅

#### 场景：用户输入重置计时器

**前置条件**:
- ProactiveConversationManager 已初始化
- 计时器已运行 20 秒

**输入**: 用户输入 "打车35"

**预期行为**:
- 检测到用户输入
- 重置 30 秒计时器
- 从 0 开始重新计时
- 不触发主动对话

**验收标准**:
- 用户输入立即重置计时器
- 计时器重新开始
- 不影响正常对话

#### 场景：语音助手关闭时停止计时器

**前置条件**:
- ProactiveConversationManager 已初始化
- 计时器已运行 15 秒

**输入**: 用户关闭语音助手

**预期行为**:
- 检测到助手关闭
- 停止计时器
- 清理资源
- 不触发主动对话

**验收标准**:
- 计时器正确停止
- 资源正确释放
- 不产生内存泄漏

### 需求：ProactiveConversationManager 支持频率限制

**优先级**: P0
**关联能力**: 无

ProactiveConversationManager 必须限制主动对话次数，避免打扰用户。

#### 场景：最多触发 3 次主动对话

**前置条件**:
- ProactiveConversationManager 已初始化
- 主动对话计数器为 0

**输入**: 连续 4 次 30 秒静默

**预期行为**:
- 第 1 次静默：触发主动对话，计数器 = 1
- 第 2 次静默：触发主动对话，计数器 = 2
- 第 3 次静默：触发主动对话，计数器 = 3
- 第 4 次静默：不触发，计数器保持 3

**验收标准**:
- 最多触发 3 次
- 计数器准确
- 第 4 次不触发

#### 场景：用户响应后重置计数器

**前置条件**:
- ProactiveConversationManager 已初始化
- 主动对话计数器为 2

**输入**:
- 主动对话: "今天午餐花了35，晚餐想吃什么？"
- 用户响应: "吃火锅吧"

**预期行为**:
- 检测到用户响应
- 重置计数器为 0
- 重新开始 30 秒计时
- 可再次触发 3 次

**验收标准**:
- 用户响应重置计数器
- 计数器归零
- 可再次触发

#### 场景：会话结束后重置计数器

**前置条件**:
- ProactiveConversationManager 已初始化
- 主动对话计数器为 3

**输入**: 用户结束会话（关闭语音助手）

**预期行为**:
- 检测到会话结束
- 重置计数器为 0
- 下次会话可再次触发
- 清理状态

**验收标准**:
- 会话结束重置计数器
- 状态正确清理
- 下次会话正常

### 需求：ProactiveConversationManager 支持话题生成

**优先级**: P1
**关联能力**: adaptive-conversation

ProactiveConversationManager 必须根据用户画像生成个性化话题。

#### 场景：基于最近消费生成话题

**前置条件**:
- ProactiveConversationManager 已初始化
- 用户最近消费: 交通 35 元（今天中午）

**输入**: 触发主动对话

**预期行为**:
- 查询用户最近消费记录
- 分析消费分类和时间
- 调用 LLM 生成话题
- 生成话题: "今天午餐花了35，晚餐想吃什么？"

**验收标准**:
- 话题与用户画像相关
- 话题自然流畅
- 不重复历史话题

#### 场景：基于预算状态生成话题

**前置条件**:
- ProactiveConversationManager 已初始化
- 用户本月预算剩余 100 元（接近超支）

**输入**: 触发主动对话

**预期行为**:
- 查询用户预算状态
- 检测到接近超支
- 调用 LLM 生成话题
- 生成话题: "本月预算还剩100元，需要帮您规划一下吗？"

**验收标准**:
- 话题与预算状态相关
- 提供有价值的建议
- 语气友好不强迫

#### 场景：LLM 不可用时使用预定义话题

**前置条件**:
- ProactiveConversationManager 已初始化
- LLM 不可用

**输入**: 触发主动对话

**预期行为**:
- 检测到 LLM 不可用
- 降级到预定义话题库
- 随机选择一个话题
- 播放话题: "需要帮您记账吗？"

**验收标准**:
- LLM 不可用不阻塞功能
- 预定义话题库包含 10+ 话题
- 话题不重复

#### 场景：话题生成超时后降级

**前置条件**:
- ProactiveConversationManager 已初始化
- LLM 响应慢

**输入**: 触发主动对话，LLM 超时 3s

**预期行为**:
- LLM 调用在 3s 后超时
- 自动降级到预定义话题
- 播放话题
- 记录超时日志

**验收标准**:
- 超时时间准确为 3s
- 降级不影响用户体验
- 超时率 < 20%

### 需求：ProactiveConversationManager 支持用户拒绝检测

**优先级**: P0
**关联能力**: multi-operation-recognition

ProactiveConversationManager 必须检测用户拒绝，并停止主动对话。

#### 场景：检测到明确拒绝关键词

**前置条件**:
- ProactiveConversationManager 已初始化
- 主动对话已触发

**输入**:
- 主动对话: "需要帮您记账吗？"
- 用户响应: "不用了"

**预期行为**:
- 检测到拒绝关键词（"不用了"）
- 设置 _proactiveDisabled = true
- 停止主动对话功能
- 记录用户偏好

**验收标准**:
- 拒绝关键词包括："不用了"、"别说了"、"安静"、"闭嘴"
- 检测准确率 ≥ 90%
- 停止后不再触发

#### 场景：检测到隐含拒绝

**前置条件**:
- ProactiveConversationManager 已初始化
- 主动对话已触发 2 次

**输入**:
- 主动对话 1: "需要帮您记账吗？"
- 用户无响应
- 主动对话 2: "本月预算还剩100元"
- 用户无响应

**预期行为**:
- 检测到连续 2 次无响应
- 视为隐含拒绝
- 降低主动对话频率（60 秒触发）
- 不完全停止

**验收标准**:
- 连续 2 次无响应触发降频
- 触发间隔从 30s 增加到 60s
- 不完全停止功能

#### 场景：用户重新启用主动对话

**前置条件**:
- ProactiveConversationManager 已初始化
- _proactiveDisabled = true

**输入**: 用户在设置中重新启用主动对话

**预期行为**:
- 检测到设置变化
- 设置 _proactiveDisabled = false
- 重置计数器为 0
- 重新开始 30 秒计时

**验收标准**:
- 设置变化立即生效
- 状态正确恢复
- 功能正常工作

### 需求：ProactiveConversationManager 支持状态管理

**优先级**: P0
**关联能力**: 无

ProactiveConversationManager 必须维护清晰的状态机，确保主动对话逻辑正确。

#### 场景：状态正确转换

**前置条件**:
- ProactiveConversationManager 已初始化
- 当前状态为 idle

**输入**: 用户完成一次对话

**预期行为**:
- 状态转换: idle → waiting(30s)
- 30 秒后: waiting → generating
- 话题生成后: generating → speaking
- 播放完成后: speaking → idle

**验收标准**:
- 状态转换顺序正确
- 每个状态持续时间合理
- 状态可查询

#### 场景：用户拒绝后状态停止

**前置条件**:
- ProactiveConversationManager 已初始化
- 当前状态为 speaking

**输入**: 用户响应 "不用了"

**预期行为**:
- 检测到拒绝
- 状态转换: speaking → stopped
- 停止计时器
- 不再转换到 idle

**验收标准**:
- stopped 状态持久化
- 计时器正确停止
- 不再触发主动对话

## 性能要求

- 静默检测延迟：< 1s
- 话题生成延迟：P95 < 3s
- 预定义话题选择延迟：< 50ms
- 拒绝检测延迟：< 100ms
- 状态转换延迟：< 10ms

## 安全要求

- 主动对话频率限制：最多 3 次/会话
- 话题长度限制：≤ 50 字
- LLM 超时保护：3s
- 用户画像数据脱敏

## 兼容性要求

- 支持用户在设置中关闭主动对话
- 保持现有对话流程不变
- 不影响被动响应功能
