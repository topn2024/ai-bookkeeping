# 智能导入功能规范增量

## 新增需求

### 需求：短信导入交易记录
系统必须支持从手机短信中读取和解析交易记录，并导入到记账系统中。

#### 场景：Android平台短信导入成功
- **当** 用户在Android设备上点击"短信导入"按钮
- **并且** 用户授予READ_SMS权限
- **并且** 用户选择时间范围（起始日期和结束日期）
- **那么** 系统应读取该时间范围内的所有短信
- **并且** 系统应过滤出支付相关的短信（银行、支付宝、微信等）
- **并且** 系统应使用AI服务批量解析短信内容
- **并且** 系统应将解析结果转换为交易候选记录（ImportCandidate）
- **并且** 系统应使用现有的重复检测逻辑检查重复
- **并且** 系统应显示预览页面供用户确认
- **并且** 系统应在整个过程中显示进度信息

#### 场景：iOS平台显示不可用提示
- **当** 用户在iOS设备上点击"短信导入"按钮
- **那么** 系统应显示功能不可用的提示信息
- **并且** 提示信息应说明iOS系统限制无法读取短信
- **并且** 提示信息应建议用户使用其他导入方式（如文件导入）

#### 场景：用户拒绝短信权限
- **当** 用户在Android设备上点击"短信导入"按钮
- **并且** 用户拒绝授予READ_SMS权限
- **那么** 系统应显示友好的权限说明对话框
- **并且** 对话框应解释为什么需要短信权限
- **并且** 对话框应提供"重新申请"和"取消"按钮
- **并且** 如果用户选择"不再询问"，系统应提供跳转到应用设置的按钮

#### 场景：短信解析失败处理
- **当** AI服务解析短信失败（网络错误、API错误等）
- **那么** 系统应显示错误信息
- **并且** 系统应提供"重试"按钮
- **并且** 系统应保留已成功解析的部分结果
- **并且** 系统应在错误信息中说明失败原因

#### 场景：大量短信处理
- **当** 用户选择的时间范围包含大量短信（如超过1000条）
- **那么** 系统应分批读取和解析短信
- **并且** 系统应显示实时进度（当前处理数量/总数量）
- **并且** 系统应提供"取消"按钮允许用户中断处理
- **并且** 系统应在后台线程执行，不阻塞UI

#### 场景：重复交易检测
- **当** 短信解析出的交易记录与已有记录重复
- **那么** 系统应使用现有的DuplicateScorer计算重复分数
- **并且** 系统应在预览页面标记疑似重复的记录
- **并且** 系统应允许用户选择是否导入重复记录
- **并且** 系统应统计并显示重复记录数量

#### 场景：预览和确认解析结果
- **当** 短信解析和重复检测完成
- **那么** 系统必须复用现有的ImportPreviewPage显示解析结果
- **并且** 系统必须显示所有解析出的交易候选记录列表
- **并且** 每条记录必须显示：金额、类型、日期、商户、分类、重复状态
- **并且** 系统必须提供筛选功能（全部、待导入、跳过、重复）
- **并且** 系统必须提供批量操作（智能选择、全部导入、全部跳过）
- **并且** 用户必须能够点击单条记录查看详情和修改
- **并且** 用户必须能够手动修改每条记录的导入动作（导入/跳过）
- **并且** 系统必须显示统计信息（总数、待导入、重复、跳过）
- **并且** 用户确认后系统才执行实际导入操作

#### 场景：修改解析结果
- **当** 用户在预览页面点击某条记录
- **那么** 系统必须显示该记录的详细信息
- **并且** 用户必须能够修改金额、类型、日期、商户、分类等字段
- **并且** 用户必须能够修改导入动作（导入/跳过）
- **并且** 用户必须能够查看该记录的重复检测详情（如果有）
- **并且** 用户必须能够查看原始短信内容（作为参考）
- **并且** 修改保存后系统必须更新预览列表

### 需求：短信导入配置
系统必须提供短信导入的配置选项，允许用户自定义导入参数。

#### 场景：选择时间范围
- **当** 用户进入短信导入配置页面
- **那么** 系统应显示起始日期选择器
- **并且** 系统应显示结束日期选择器
- **并且** 系统应提供快捷选项（最近7天、最近30天、最近90天）
- **并且** 系统应验证结束日期不早于起始日期
- **并且** 系统应显示预计读取的短信数量（如果可获取）

#### 场景：权限申请引导
- **当** 用户首次使用短信导入功能
- **并且** 应用尚未获得READ_SMS权限
- **那么** 系统应在配置页面显示权限说明
- **并且** 说明应包含权限用途（读取交易短信）
- **并且** 说明应包含隐私保护承诺（不存储短信原文）
- **并且** 系统应提供"授予权限"按钮

### 需求：短信解析AI服务
系统必须使用AI服务智能解析短信内容，提取交易信息。

#### 场景：批量解析短信
- **当** 系统需要解析多条短信
- **那么** 系统应将短信分批处理（每批15-20条）
- **并且** 系统应构造结构化的AI Prompt
- **并且** Prompt应要求AI返回JSON格式的交易列表
- **并且** 每个交易应包含：金额、类型、时间、商户、备注等字段
- **并且** 系统应设置合理的超时时间（30秒）
- **并且** 系统应实现失败重试机制（最多3次）

#### 场景：过滤非交易短信
- **当** AI服务解析短信
- **那么** AI应识别并忽略非交易类短信（验证码、广告、通知等）
- **并且** AI应对无法识别的短信返回null
- **并且** 系统应统计并显示被过滤的短信数量

#### 场景：解析结果转换
- **当** AI服务返回解析结果
- **那么** 系统应将结果转换为ImportCandidate格式
- **并且** 系统应设置来源标记为"短信导入"
- **并且** 系统应保留原始短信内容作为备注（可选）
- **并且** 系统应处理日期格式转换
- **并且** 系统应处理金额格式转换

### 需求：短信导入进度显示
系统必须在短信导入过程中显示详细的进度信息。

#### 场景：多阶段进度显示
- **当** 短信导入过程执行
- **那么** 系统应显示当前阶段（读取短信、解析内容、检测重复等）
- **并且** 系统应显示当前阶段的进度百分比
- **并且** 系统应显示当前处理数量和总数量
- **并且** 系统应显示预计剩余时间（可选）
- **并且** 系统应提供"取消"按钮

#### 场景：取消导入操作
- **当** 用户在导入过程中点击"取消"按钮
- **那么** 系统应立即停止读取和解析
- **并且** 系统应清理已分配的资源
- **并且** 系统应显示取消确认信息
- **并且** 系统应返回到导入配置页面

### 需求：短信导入历史记录
系统必须记录短信导入的历史，便于用户追溯。

#### 场景：记录导入历史
- **当** 短信导入成功完成
- **那么** 系统应在导入历史中创建记录
- **并且** 记录应包含导入时间
- **并且** 记录应包含导入来源（"短信导入"）
- **并且** 记录应包含时间范围（起始日期、结束日期）
- **并且** 记录应包含导入数量统计（总数、成功、重复、跳过）
- **并且** 用户应能在导入历史页面查看该记录

#### 场景：查看导入详情
- **当** 用户在导入历史页面点击短信导入记录
- **那么** 系统应显示该次导入的详细信息
- **并且** 详情应包含导入的交易列表
- **并且** 详情应标记哪些是重复记录
- **并且** 详情应显示解析失败的短信数量（如果有）

## 修改需求

### 需求：智能导入入口
系统必须在智能导入页面提供多种导入方式的入口。

#### 场景：显示导入方式选项
- **当** 用户进入智能导入页面（SmartImportPage）
- **那么** 系统必须显示"文件导入"按钮
- **并且** 系统必须显示"短信导入"按钮（新增）
- **并且** 如果是Android平台，"短信导入"按钮必须可点击
- **并且** 如果是iOS平台，"短信导入"按钮必须显示为禁用状态或显示"不可用"标签
- **并且** 系统必须显示"导入历史"按钮

#### 场景：点击短信导入按钮
- **当** 用户点击"短信导入"按钮
- **并且** 当前平台是Android
- **那么** 系统必须导航到短信导入配置页面
- **并且** 如果当前平台是iOS
- **那么** 系统必须显示功能不可用的提示对话框

## 新增需求

### 需求：隐私保护和数据安全
系统必须妥善处理短信数据，保护用户隐私。

#### 场景：短信数据处理
- **当** 系统读取和解析短信
- **那么** 短信内容应仅在内存中临时处理
- **并且** 系统禁止将短信原文存储到本地数据库
- **并且** 系统禁止将短信原文上传到服务器（除AI解析必需的文本内容）
- **并且** 上传到AI服务的内容应不包含发件人号码
- **并且** 解析完成后应立即释放短信内容

#### 场景：权限说明和隐私政策
- **当** 用户首次使用短信导入功能
- **那么** 系统应显示权限说明对话框
- **并且** 说明应明确告知短信权限的用途（读取交易短信）
- **并且** 说明应承诺不存储短信原文
- **并且** 说明应提供隐私政策链接
- **并且** 用户应能在隐私政策中查看详细的数据处理说明
