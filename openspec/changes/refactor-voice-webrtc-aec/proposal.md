# 变更：语音处理架构重构 - WebRTC AEC + Silero VAD

## 变更ID
`refactor-voice-webrtc-aec`

## 为什么

当前语音处理架构存在根本性设计问题：

1. **回声消除方案不正确**：使用文本相似度过滤回声，这是在错误的层级解决问题。回声应该在音频层面消除，而不是在ASR识别后用文本比对过滤。
2. **代码冗余复杂**：EchoFilter、BargeInDetectorV2、SimilarityCalculator等多个组件职责重叠，逻辑复杂且相互干扰。
3. **打断检测不可靠**：当前基于ASR文本和振幅的打断检测容易误判，导致TTS被错误打断或真正的用户输入被忽略。

行业标准做法是：
- **WebRTC AEC/NS/AGC**：在音频采集层面消除回声、降噪、自动增益
- **Silero VAD**：基于深度学习的语音活动检测，用于打断检测
- 三层架构：**端侧音频预处理 → 云端ASR/TTS → 业务逻辑**

## 变更内容

### 核心架构变更

1. **引入 WebRTC 音频处理模块**
   - AEC（Acoustic Echo Cancellation）：声学回声消除
   - NS（Noise Suppression）：噪声抑制
   - AGC（Automatic Gain Control）：自动增益控制
   - 使用 `flutter_webrtc_audio_processing` 或类似包

2. **重构 Silero VAD 集成**
   - 作为唯一的语音活动检测来源
   - 用于 Barge-in 打断检测
   - 用于静音检测和轮次结束判断

3. **删除冗余组件**
   - `echo_filter.dart` - 文本相似度回声过滤（WebRTC AEC替代）
   - `similarity_calculator.dart` - 相似度计算器（不再需要）
   - `barge_in_detector_v2.dart` 中的文本相似度逻辑（Silero VAD替代）
   - `input_pipeline.dart` 中的 `_isLikelyEcho` 方法

4. **简化打断检测逻辑**
   - 仅基于 Silero VAD 的语音检测
   - TTS播放期间检测到VAD语音事件 → 触发打断
   - 移除复杂的多层打断检测

### 保留不变的部分

1. **意图识别层**
   - `smart_intent_recognizer.dart`
   - `intelligence_engine/` 目录下的智能引擎

2. **执行层**
   - `action_router.dart`
   - `bookkeeping_operation_adapter.dart`
   - `actions/` 目录下的动作实现

3. **云端服务**
   - ASR 服务（阿里云语音识别）
   - TTS 服务（阿里云语音合成）
   - LLM 服务（通义千问）

### 新架构流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        端侧音频预处理                              │
├─────────────────────────────────────────────────────────────────┤
│  麦克风 → WebRTC AEC → WebRTC NS → WebRTC AGC → 干净音频          │
│                ↑                                                 │
│         TTS播放音频（参考信号）                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        语音活动检测                               │
├─────────────────────────────────────────────────────────────────┤
│  干净音频 → Silero VAD → speechStart / speechEnd 事件            │
│                       → Barge-in 打断检测                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                         云端能力                                  │
├─────────────────────────────────────────────────────────────────┤
│  干净音频 → 阿里云 ASR → 文本 → LLM → 回复 → TTS → 音频播放        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                 │
├─────────────────────────────────────────────────────────────────┤
│  意图识别 → 动作路由 → 记账操作适配器 → 数据库/UI操作               │
└─────────────────────────────────────────────────────────────────┘
```

## 影响

### 受影响模块
- `lib/services/voice/detection/` - 重构或删除
- `lib/services/voice/pipeline/` - 简化逻辑
- `lib/services/voice/realtime_vad_config.dart` - 调整配置

### 需要新增的依赖
- WebRTC 音频处理 Flutter 包（需要评估选项）

### 代码删除范围
| 文件 | 原因 |
|------|------|
| `echo_filter.dart` | WebRTC AEC替代 |
| `similarity_calculator.dart` | 不再需要文本相似度 |
| `barge_in_detector_v2.dart` 部分逻辑 | Silero VAD替代 |

## 技术决策

### 为什么选择 WebRTC AEC 而不是文本相似度过滤

| 维度 | 文本相似度过滤 | WebRTC AEC |
|------|---------------|------------|
| 处理层级 | ASR后（文本层） | 音频采集层 |
| 延迟 | 需要等ASR结果 | 实时（<10ms） |
| 准确性 | 依赖ASR准确度 | 音频信号级处理 |
| 行业标准 | 非标准方案 | 业界通用标准 |
| 复杂度 | 需要维护相似度阈值 | 配置即用 |

### 为什么选择 Silero VAD 做打断检测

| 维度 | 当前多层检测 | Silero VAD |
|------|-------------|------------|
| 检测来源 | VAD+ASR+振幅 | 纯VAD |
| 复杂度 | 高（多层判断） | 低（单一来源） |
| 可靠性 | 各层可能冲突 | 一致可靠 |
| 响应速度 | 依赖ASR延迟 | 实时（~100ms） |

## 风险与缓解

| 风险 | 缓解措施 |
|------|---------|
| WebRTC包兼容性 | 提前评估多个候选包，准备fallback方案 |
| AEC效果不佳 | 保留简单的静音窗口作为补充 |
| VAD误检 | 调优Silero VAD参数，设置合理的语音持续时间阈值 |

## 参考资料

### 行业标准方案
1. **WebRTC**: Google开源的实时通信框架，包含成熟的AEC/NS/AGC实现
2. **Silero VAD**: 基于深度学习的高精度语音活动检测模型

### Flutter 包候选
1. `flutter_webrtc` - 包含完整WebRTC支持
2. 需要评估是否有独立的音频处理包

## 实施原则

1. **先删后加**：先清理冗余代码，再添加新实现
2. **单一职责**：每个组件只做一件事
3. **层级清晰**：音频处理→语音检测→ASR/TTS→业务逻辑
4. **可测试性**：每层可独立测试
