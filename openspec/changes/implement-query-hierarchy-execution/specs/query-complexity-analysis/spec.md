# 规范：查询复杂度分析

## 新增需求

### 需求：查询复杂度自动判定

系统必须能够根据查询请求的特征自动计算复杂度评分，并确定合适的响应层级（Level 1/2/3）。

#### 场景：简单查询判定

**前置条件**：
- 用户发起查询请求
- 查询时间跨度为单日或一周内
- 无分组维度或只有一个维度
- 预期数据点数 ≤ 2

**操作**：
- 系统计算查询复杂度评分

**预期结果**：
- 复杂度评分 ≤ 1
- 判定为Level 1（纯语音响应）

**示例**：
- "今天花了多少" → 评分0，Level 1
- "昨天的支出" → 评分0，Level 1
- "本周花了多少" → 评分1，Level 1

#### 场景：中等查询判定

**前置条件**：
- 用户发起查询请求
- 查询时间跨度为一周到一月
- 有2个数据维度或包含占比/对比分析
- 预期数据点数 3-4个

**操作**：
- 系统计算查询复杂度评分

**预期结果**：
- 复杂度评分 2-4
- 判定为Level 2（语音+轻量卡片）

**示例**：
- "餐饮这个月花了多少" → 评分2，Level 2（有分类维度+占比）
- "本月和上月对比" → 评分3，Level 2（两期对比）
- "预算还剩多少" → 评分2，Level 2（进度查询）

#### 场景：复杂查询判定

**前置条件**：
- 用户发起查询请求
- 查询时间跨度超过一月或需要趋势分析
- 有3个及以上数据维度
- 预期数据点数 ≥ 5个

**操作**：
- 系统计算查询复杂度评分

**预期结果**：
- 复杂度评分 ≥ 5
- 判定为Level 3（语音摘要+交互图表）

**示例**：
- "最近三个月的消费趋势" → 评分7，Level 3（时间4分+趋势2分+数据点2分）
- "各分类占比分布" → 评分5，Level 3（分布2分+多维度3分）
- "本年度每月支出对比" → 评分8，Level 3（时间4分+数据点2分+对比1分）

### 需求：复杂度评分算法

系统必须实现基于多因素的复杂度评分算法。

#### 场景：时间跨度评分

**前置条件**：
- 查询请求包含时间范围

**操作**：
- 系统根据时间跨度计算评分

**预期结果**：
- 单日（≤1天）：0分
- 一周内（≤7天）：1分
- 一月内（≤31天）：2分
- 三月内（≤90天）：3分
- 三月以上：4分

#### 场景：数据维度评分

**前置条件**：
- 查询请求包含筛选条件或分组维度

**操作**：
- 系统统计数据维度数量

**预期结果**：
- 0-1个维度：0分
- 2个维度：1分
- 3个及以上维度：3分

**维度包括**：
- 分类筛选（category）
- 来源筛选（source）
- 账户筛选（account）
- 分组维度（groupBy）

#### 场景：数据点数评分

**前置条件**：
- 查询请求包含分组或时间序列

**操作**：
- 系统估算预期数据点数

**预期结果**：
- ≤2个数据点：0分
- 3-4个数据点：1分
- ≥5个数据点：2分

#### 场景：查询类型评分

**前置条件**：
- 查询请求指定查询类型

**操作**：
- 系统根据查询类型加分

**预期结果**：
- summary（总额统计）：0分
- recent（最近记录）：0分
- comparison（对比分析）：1分
- distribution（分布/占比）：2分
- trend（趋势分析）：2分
- custom（自定义查询）：3分

### 需求：复杂度判定性能

系统必须快速完成复杂度判定，不影响查询响应时间。

#### 场景：判定性能要求

**前置条件**：
- 用户发起任意查询请求

**操作**：
- 系统执行复杂度判定

**预期结果**：
- 判定时间 < 10ms
- 不阻塞查询执行
- 判定结果准确

## 修改需求

### 需求：查询请求数据结构扩展

现有的查询参数必须扩展以支持复杂度判定。

#### 场景：查询请求包含完整信息

**前置条件**：
- 用户通过语音发起查询

**操作**：
- SmartIntentRecognizer识别查询意图
- 构建QueryRequest对象

**预期结果**：
- QueryRequest包含以下字段：
  - queryType（查询类型）
  - timeRange（时间范围）
  - category（分类筛选，可选）
  - source（来源筛选，可选）
  - account（账户筛选，可选）
  - transactionType（交易类型，可选）
  - aggregationType（聚合类型，可选）
  - groupBy（分组维度列表，可选）
  - sortOrder（排序方式，可选）
  - limit（数据点限制，可选）

## 相关功能

- 关联：[query-result-routing](../query-result-routing/spec.md) - 使用复杂度判定结果进行路由
- 关联：[lightweight-query-card](../lightweight-query-card/spec.md) - Level 2响应
- 关联：[interactive-query-chart](../interactive-query-chart/spec.md) - Level 3响应
