# æ¸è¿›å¼å‡çº§æ–¹æ¡ˆï¼šå¯¹è¯æ™ºèƒ½ä½“ä¸Šä¸‹æ–‡æ•´åˆç³»ç»Ÿ

**ç‰ˆæœ¬**: v3.0
**åŸåˆ™**: æ¯é˜¶æ®µç‹¬ç«‹å¯éƒ¨ç½²ï¼Œç³»ç»Ÿå§‹ç»ˆä¿æŒæ­£å¸¸è¿è¡Œ

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¸è¿›å¼å‡çº§åŸåˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ–°å¢ä¸ä¿®æ”¹ï¼šåªæ·»åŠ æ–°ä»£ç ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç                    â”‚
â”‚ 2. å¼€å…³æ§åˆ¶ï¼šæ‰€æœ‰æ–°åŠŸèƒ½é€šè¿‡ Feature Flag æ§åˆ¶                â”‚
â”‚ 3. å¹¶è¡Œè¿è¡Œï¼šæ–°æ—§é€»è¾‘å¯ä»¥åŒæ—¶å­˜åœ¨                            â”‚
â”‚ 4. éšæ—¶å›æ»šï¼šå…³é—­å¼€å…³å³å¯æ¢å¤åŸæœ‰è¡Œä¸º                        â”‚
â”‚ 5. ç‹¬ç«‹æµ‹è¯•ï¼šæ¯é˜¶æ®µå®Œæˆåå¯ä»¥å•ç‹¬æµ‹è¯•éªŒè¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é˜¶æ®µæ¦‚è§ˆ

| é˜¶æ®µ | åç§° | æ”¹åŠ¨èŒƒå›´ | é£é™© | å¯å›æ»š |
|------|------|---------|------|--------|
| 0 | Feature Flag åŸºç¡€è®¾æ–½ | æ–°å¢1ä¸ªæ–‡ä»¶ | æ—  | âœ… |
| 1 | æ•°æ®ç»“æ„å®šä¹‰ | æ–°å¢1ä¸ªæ–‡ä»¶ | æ—  | âœ… |
| 2 | ä¸Šä¸‹æ–‡æä¾›è€…ï¼ˆåªè¯»ï¼‰ | æ–°å¢1ä¸ªæ–‡ä»¶ | æ—  | âœ… |
| 3 | æç¤ºè¯æ„å»ºå™¨ | æ–°å¢2ä¸ªæ–‡ä»¶ | æ—  | âœ… |
| 4 | å¢å¼ºç”Ÿæˆå™¨ï¼ˆç»§æ‰¿ï¼‰ | æ–°å¢1ä¸ªæ–‡ä»¶ | æ—  | âœ… |
| 5 | å¯é€‰é›†æˆ | ä¿®æ”¹1ä¸ªæ–‡ä»¶ï¼Œ1è¡Œä»£ç  | æä½ | âœ… |
| 6 | ç°åº¦å¯ç”¨ | ä¿®æ”¹é…ç½® | ä½ | âœ… |

**æ€»è®¡**: æ–°å¢6ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹1ä¸ªæ–‡ä»¶ï¼ˆä»…1è¡Œä»£ç ï¼‰

---

## é˜¶æ®µ 0ï¼šFeature Flag åŸºç¡€è®¾æ–½

### ç›®æ ‡
åˆ›å»ºåŠŸèƒ½å¼€å…³ç³»ç»Ÿï¼Œä¸ºåç»­æ‰€æœ‰é˜¶æ®µæä¾›æ§åˆ¶èƒ½åŠ›ã€‚

### æ”¹åŠ¨
æ–°å¢æ–‡ä»¶ï¼š`services/voice/feature_flags.dart`

```dart
/// è¯­éŸ³ç³»ç»ŸåŠŸèƒ½å¼€å…³
/// æ‰€æœ‰æ–°åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œé€šè¿‡æ­¤ç±»æ§åˆ¶å¯ç”¨
class VoiceFeatureFlags {
  // ç§æœ‰æ„é€ å‡½æ•°ï¼Œå•ä¾‹æ¨¡å¼
  VoiceFeatureFlags._();
  static final instance = VoiceFeatureFlags._();

  // ========== ä¸Šä¸‹æ–‡ç³»ç»Ÿå¼€å…³ ==========

  /// æ˜¯å¦ä½¿ç”¨å¢å¼ºç‰ˆè¯é¢˜ç”Ÿæˆå™¨
  /// é»˜è®¤ falseï¼Œä¿æŒåŸæœ‰è¡Œä¸º
  bool useEnhancedTopicGenerator = false;

  /// æ˜¯å¦å¯ç”¨ LLM ç”Ÿæˆè¯é¢˜
  /// ä»…åœ¨ useEnhancedTopicGenerator=true æ—¶ç”Ÿæ•ˆ
  bool enableLLMTopicGeneration = false;

  /// æ˜¯å¦åœ¨æ—¥å¿—ä¸­è¾“å‡ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
  bool debugLogContext = false;

  // ========== ä¾¿æ·æ–¹æ³• ==========

  /// é‡ç½®æ‰€æœ‰å¼€å…³åˆ°é»˜è®¤å€¼ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  void resetToDefaults() {
    useEnhancedTopicGenerator = false;
    enableLLMTopicGeneration = false;
    debugLogContext = false;
  }

  /// å¯ç”¨å¢å¼ºæ¨¡å¼ï¼ˆä»…è§„åˆ™ï¼Œä¸ç”¨LLMï¼‰
  void enableEnhancedRulesOnly() {
    useEnhancedTopicGenerator = true;
    enableLLMTopicGeneration = false;
  }

  /// å¯ç”¨å®Œæ•´å¢å¼ºæ¨¡å¼ï¼ˆè§„åˆ™ + LLMï¼‰
  void enableFullEnhanced() {
    useEnhancedTopicGenerator = true;
    enableLLMTopicGeneration = true;
  }
}

/// å…¨å±€è®¿é—®ç‚¹
VoiceFeatureFlags get voiceFlags => VoiceFeatureFlags.instance;
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- ç°æœ‰åŠŸèƒ½æ— å½±å“
- å¯ä»¥åœ¨ä»»æ„ä½ç½®è®¿é—® `voiceFlags`

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œæ— ä»»ä½•å˜åŒ–

---

## é˜¶æ®µ 1ï¼šæ•°æ®ç»“æ„å®šä¹‰

### ç›®æ ‡
å®šä¹‰ç»Ÿä¸€çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„ï¼Œçº¯æ•°æ®ç±»ï¼Œä¸ä¾èµ–ä»»ä½•ç°æœ‰ç»„ä»¶ã€‚

### æ”¹åŠ¨
æ–°å¢æ–‡ä»¶ï¼š`services/voice/context/proactive_context.dart`

```dart
/// ä¸»åŠ¨å¯¹è¯ä¸Šä¸‹æ–‡
/// çº¯æ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨ç»„ä»¶é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯
class ProactiveContext {
  /// å¾…é€šçŸ¥çš„æ‰§è¡Œç»“æœ
  final List<PendingResult> pendingResults;

  /// ç”¨æˆ·åå¥½
  final UserPreferences userPreferences;

  /// æœ€è¿‘å¯¹è¯æ‘˜è¦
  final List<ConversationTurn> recentConversation;

  /// é•¿æœŸè®°å¿†è¦ç‚¹
  final List<String> longTermMemory;

  /// ç¯å¢ƒä¿¡æ¯
  final EnvironmentInfo environment;

  const ProactiveContext({
    this.pendingResults = const [],
    this.userPreferences = const UserPreferences(),
    this.recentConversation = const [],
    this.longTermMemory = const [],
    this.environment = const EnvironmentInfo(),
  });

  /// æ˜¯å¦æœ‰å¾…é€šçŸ¥çš„ç»“æœ
  bool get hasPendingResults => pendingResults.isNotEmpty;

  /// æ˜¯å¦ç”¨æˆ·å–œæ¬¢ä¸»åŠ¨å¯¹è¯
  bool get likesProactiveChat => userPreferences.likesProactiveChat;

  /// åˆ›å»ºç©ºä¸Šä¸‹æ–‡ï¼ˆç”¨äºé™çº§ï¼‰
  static const empty = ProactiveContext();
}

/// å¾…é€šçŸ¥çš„æ‰§è¡Œç»“æœ
class PendingResult {
  final String actionType;  // 'record', 'query', 'modify' ç­‰
  final String summary;     // "è®°å½•äº†15å…ƒæ—©é¤"
  final DateTime timestamp;
  final bool isSuccess;

  const PendingResult({
    required this.actionType,
    required this.summary,
    required this.timestamp,
    this.isSuccess = true,
  });
}

/// ç”¨æˆ·åå¥½
class UserPreferences {
  final bool likesProactiveChat;
  final String preferredStyle;  // 'casual', 'formal', 'brief'
  final List<String> frequentCategories;

  const UserPreferences({
    this.likesProactiveChat = true,
    this.preferredStyle = 'casual',
    this.frequentCategories = const [],
  });
}

/// å¯¹è¯è½®æ¬¡
class ConversationTurn {
  final String role;     // 'user' or 'assistant'
  final String content;
  final DateTime timestamp;

  const ConversationTurn({
    required this.role,
    required this.content,
    required this.timestamp,
  });
}

/// ç¯å¢ƒä¿¡æ¯
class EnvironmentInfo {
  final DateTime currentTime;
  final String? timeOfDay;  // 'morning', 'noon', 'afternoon', 'evening', 'night'
  final int silenceDuration; // ç”¨æˆ·æ²‰é»˜æ—¶é•¿ï¼ˆç§’ï¼‰

  const EnvironmentInfo({
    DateTime? currentTime,
    this.timeOfDay,
    this.silenceDuration = 0,
  }) : currentTime = currentTime ?? const _DefaultDateTime();

  /// æ ¹æ®å½“å‰æ—¶é—´æ¨æ–­æ—¶æ®µ
  String get inferredTimeOfDay {
    if (timeOfDay != null) return timeOfDay!;
    final hour = currentTime.hour;
    if (hour >= 5 && hour < 9) return 'morning';
    if (hour >= 11 && hour < 13) return 'noon';
    if (hour >= 13 && hour < 18) return 'afternoon';
    if (hour >= 18 && hour < 22) return 'evening';
    return 'night';
  }
}

/// é»˜è®¤æ—¶é—´ï¼ˆç¼–è¯‘æ—¶å¸¸é‡éœ€è¦ï¼‰
class _DefaultDateTime implements DateTime {
  const _DefaultDateTime();
  // ... å§”æ‰˜ç»™ DateTime.now() çš„å®ç°
}
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- å¯ä»¥åˆ›å»º ProactiveContext å®ä¾‹
- ç°æœ‰åŠŸèƒ½æ— å½±å“

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªæœªä½¿ç”¨çš„æ•°æ®ç±»

---

## é˜¶æ®µ 2ï¼šä¸Šä¸‹æ–‡æä¾›è€…ï¼ˆåªè¯»ï¼‰

### ç›®æ ‡
åˆ›å»ºä¸Šä¸‹æ–‡æä¾›è€…ï¼Œä»ç°æœ‰ç»„ä»¶**è¯»å–**æ•°æ®ï¼Œä½†ä¸ä¿®æ”¹å®ƒä»¬ã€‚

### æ”¹åŠ¨
æ–°å¢æ–‡ä»¶ï¼š`services/voice/context/conversation_context_provider.dart`

```dart
import 'proactive_context.dart';
import '../intelligence_engine/result_buffer.dart';
import '../memory/conversation_memory.dart';
import '../agent/context_manager.dart';
import '../../user_profile_service.dart';

/// å¯¹è¯ä¸Šä¸‹æ–‡æä¾›è€…
/// åªè¯»æ–¹å¼æ•´åˆå„æ•°æ®æºï¼Œä¸ä¿®æ”¹ä»»ä½•ç°æœ‰ç»„ä»¶
class ConversationContextProvider {
  final ResultBuffer? _resultBuffer;
  final ConversationMemory? _conversationMemory;
  final ContextManager? _contextManager;
  final UserProfileService? _userProfileService;

  /// ä¾èµ–æ³¨å…¥ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½æ˜¯å¯é€‰çš„
  ConversationContextProvider({
    ResultBuffer? resultBuffer,
    ConversationMemory? conversationMemory,
    ContextManager? contextManager,
    UserProfileService? userProfileService,
  }) : _resultBuffer = resultBuffer,
       _conversationMemory = conversationMemory,
       _contextManager = contextManager,
       _userProfileService = userProfileService;

  /// è·å–ä¸»åŠ¨å¯¹è¯ä¸Šä¸‹æ–‡
  /// å®‰å…¨åœ°ä»å„ç»„ä»¶æ”¶é›†æ•°æ®ï¼Œä»»ä½•ç»„ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“
  Future<ProactiveContext> getProactiveContext() async {
    return ProactiveContext(
      pendingResults: await _getPendingResults(),
      userPreferences: await _getUserPreferences(),
      recentConversation: _getRecentConversation(),
      longTermMemory: _getLongTermMemory(),
      environment: _getEnvironment(),
    );
  }

  /// ä» ResultBuffer è·å–å¾…é€šçŸ¥ç»“æœ
  Future<List<PendingResult>> _getPendingResults() async {
    if (_resultBuffer == null) return [];

    try {
      final results = _resultBuffer!.getPendingResults();
      return results.map((r) => PendingResult(
        actionType: r.type,
        summary: r.summary,
        timestamp: r.timestamp,
        isSuccess: r.success,
      )).toList();
    } catch (e) {
      // é™é»˜å¤±è´¥ï¼Œè¿”å›ç©ºåˆ—è¡¨
      return [];
    }
  }

  /// ä» UserProfileService è·å–ç”¨æˆ·åå¥½
  Future<UserPreferences> _getUserPreferences() async {
    if (_userProfileService == null) return const UserPreferences();

    try {
      final profile = await _userProfileService!.getCurrentProfile();
      return UserPreferences(
        likesProactiveChat: profile?.likesProactiveChat ?? true,
        preferredStyle: profile?.chatStyle ?? 'casual',
        frequentCategories: profile?.frequentCategories ?? [],
      );
    } catch (e) {
      return const UserPreferences();
    }
  }

  /// ä» ConversationMemory è·å–æœ€è¿‘å¯¹è¯
  List<ConversationTurn> _getRecentConversation() {
    if (_conversationMemory == null) return [];

    try {
      final history = _conversationMemory!.getRecentHistory(limit: 5);
      return history.map((h) => ConversationTurn(
        role: h.role,
        content: h.content,
        timestamp: h.timestamp,
      )).toList();
    } catch (e) {
      return [];
    }
  }

  /// ä» ContextManager è·å–é•¿æœŸè®°å¿†
  List<String> _getLongTermMemory() {
    if (_contextManager == null) return [];

    try {
      return _contextManager!.getKeyMemories(limit: 3);
    } catch (e) {
      return [];
    }
  }

  /// æ„å»ºç¯å¢ƒä¿¡æ¯
  EnvironmentInfo _getEnvironment() {
    return EnvironmentInfo(
      currentTime: DateTime.now(),
    );
  }
}
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- å¯ä»¥åˆ›å»º ConversationContextProvider å®ä¾‹
- è°ƒç”¨ getProactiveContext() è¿”å›æœ‰æ•ˆæ•°æ®
- ç°æœ‰åŠŸèƒ½æ— å½±å“

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œæ–°ç»„ä»¶åªæ˜¯è¯»å–æ•°æ®ï¼Œä¸æ”¹å˜ä»»ä½•è¡Œä¸º

---

## é˜¶æ®µ 3ï¼šæç¤ºè¯æ„å»ºå™¨

### ç›®æ ‡
åˆ›å»ºæç¤ºè¯æ„å»ºç³»ç»Ÿï¼Œç‹¬ç«‹äºç°æœ‰ä»£ç ã€‚

### æ”¹åŠ¨
æ–°å¢æ–‡ä»¶1ï¼š`services/voice/context/task_type.dart`

```dart
/// è¯­éŸ³åŠ©æ‰‹ä»»åŠ¡ç±»å‹
enum VoiceTaskType {
  /// ä¸»åŠ¨é€šçŸ¥æ‰§è¡Œç»“æœ
  notifyResult,

  /// æ—¶é—´å¼•å¯¼ï¼ˆå¦‚åˆé¤æ—¶é—´æé†’ï¼‰
  timeGuidance,

  /// ç¤¼è²Œå‘Šåˆ«
  politeGoodbye,

  /// é—²èŠ
  casualChat,

  /// é™é»˜ï¼ˆä¸è¯´è¯ï¼‰
  silence,
}

extension VoiceTaskTypeExtension on VoiceTaskType {
  String get description {
    switch (this) {
      case VoiceTaskType.notifyResult:
        return 'å‘ŠçŸ¥ç”¨æˆ·æ“ä½œæ‰§è¡Œç»“æœ';
      case VoiceTaskType.timeGuidance:
        return 'æ ¹æ®æ—¶é—´å¼•å¯¼è®°è´¦';
      case VoiceTaskType.politeGoodbye:
        return 'ç¤¼è²Œå‘Šåˆ«';
      case VoiceTaskType.casualChat:
        return 'è½»æ¾é—²èŠ';
      case VoiceTaskType.silence:
        return 'ä¿æŒé™é»˜';
    }
  }
}
```

æ–°å¢æ–‡ä»¶2ï¼š`services/voice/context/voice_agent_prompt_builder.dart`

```dart
import 'proactive_context.dart';
import 'task_type.dart';

/// è¯­éŸ³åŠ©æ‰‹æç¤ºè¯æ„å»ºå™¨
/// æ ¹æ®ä¸Šä¸‹æ–‡å’Œä»»åŠ¡ç±»å‹æ„å»º LLM æç¤ºè¯
class VoiceAgentPromptBuilder {
  /// æ„å»ºå®Œæ•´æç¤ºè¯
  String build({
    required ProactiveContext context,
    required VoiceTaskType taskType,
  }) {
    final buffer = StringBuffer();

    // ç¬¬ä¸€å±‚ï¼šè§’è‰²å®šä¹‰
    buffer.writeln(_buildRoleDefinition());
    buffer.writeln();

    // ç¬¬äºŒå±‚ï¼šç”¨æˆ·åå¥½
    buffer.writeln(_buildUserPreferences(context.userPreferences));
    buffer.writeln();

    // ç¬¬ä¸‰å±‚ï¼šä¼šè¯ä¸Šä¸‹æ–‡
    buffer.writeln(_buildSessionContext(context));
    buffer.writeln();

    // ç¬¬å››å±‚ï¼šå½“å‰ä»»åŠ¡
    buffer.writeln(_buildTaskInstruction(taskType, context));
    buffer.writeln();

    // ç¬¬äº”å±‚ï¼šè¾“å‡ºçº¦æŸ
    buffer.writeln(_buildOutputConstraints());

    return buffer.toString();
  }

  String _buildRoleDefinition() {
    return '''
## è§’è‰²
ä½ æ˜¯ã€Œå°ç™½ã€ï¼ŒAIæ™ºèƒ½è®°è´¦åŠ©æ‰‹ã€‚æ€§æ ¼ï¼šæ¸©æš–ã€è´´å¿ƒã€ä¸“ä¸šä½†ä¸æ­»æ¿ã€‚
è¯´è¯é£æ ¼ï¼šç®€æ´è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©ï¼Œä¸ç”¨æ•¬è¯­ã€‚''';
  }

  String _buildUserPreferences(UserPreferences prefs) {
    final style = prefs.preferredStyle == 'formal' ? 'æ­£å¼' : 'è½»æ¾';
    final categories = prefs.frequentCategories.isNotEmpty
        ? prefs.frequentCategories.take(3).join('ã€')
        : 'é¤é¥®ã€äº¤é€š';

    return '''
## ç”¨æˆ·åå¥½
- å¯¹è¯é£æ ¼ï¼š$style
- å¸¸ç”¨åˆ†ç±»ï¼š$categories
- ä¸»åŠ¨å¯¹è¯ï¼š${prefs.likesProactiveChat ? 'æ¬¢è¿' : 'åå°‘'}''';
  }

  String _buildSessionContext(ProactiveContext context) {
    final buffer = StringBuffer('## å½“å‰çŠ¶æ€\n');

    // å¾…é€šçŸ¥ç»“æœ
    if (context.hasPendingResults) {
      buffer.writeln('- å¾…å‘ŠçŸ¥ï¼š${context.pendingResults.length}ä¸ªæ“ä½œç»“æœ');
      for (final r in context.pendingResults.take(3)) {
        buffer.writeln('  - ${r.summary}');
      }
    }

    // æ—¶é—´
    buffer.writeln('- å½“å‰æ—¶é—´ï¼š${context.environment.inferredTimeOfDay}');

    // æ²‰é»˜æ—¶é•¿
    if (context.environment.silenceDuration > 0) {
      buffer.writeln('- ç”¨æˆ·å·²æ²‰é»˜ï¼š${context.environment.silenceDuration}ç§’');
    }

    return buffer.toString();
  }

  String _buildTaskInstruction(VoiceTaskType taskType, ProactiveContext context) {
    switch (taskType) {
      case VoiceTaskType.notifyResult:
        final results = context.pendingResults;
        if (results.length == 1) {
          return '## ä»»åŠ¡\nå‘Šè¯‰ç”¨æˆ·ï¼š${results.first.summary}ï¼Œç„¶åé—®è¿˜æœ‰æ²¡æœ‰è¦è®°çš„ã€‚';
        } else {
          return '## ä»»åŠ¡\nå‘Šè¯‰ç”¨æˆ·ï¼šå·²å®Œæˆ${results.length}ç¬”è®°è´¦ï¼Œç„¶åé—®è¿˜æœ‰æ²¡æœ‰è¦è®°çš„ã€‚';
        }

      case VoiceTaskType.timeGuidance:
        final time = context.environment.inferredTimeOfDay;
        final meal = _getMealForTime(time);
        return '## ä»»åŠ¡\nè‡ªç„¶åœ°é—®ç”¨æˆ·${meal}è®°äº†æ²¡ï¼Œä¸è¦å¤ªç”Ÿç¡¬ã€‚';

      case VoiceTaskType.politeGoodbye:
        return '## ä»»åŠ¡\nç¤¼è²Œå‘Šåˆ«ï¼Œè®©ç”¨æˆ·çŸ¥é“æœ‰éœ€è¦éšæ—¶å¯ä»¥æ‰¾ä½ ã€‚';

      case VoiceTaskType.casualChat:
        return '## ä»»åŠ¡\nè½»æ¾é—²èŠï¼Œå¯ä»¥èŠèŠç†è´¢å°çŸ¥è¯†æˆ–é¼“åŠ±åšæŒè®°è´¦ã€‚';

      case VoiceTaskType.silence:
        return '## ä»»åŠ¡\nä¿æŒé™é»˜ï¼Œä¸è¾“å‡ºä»»ä½•å†…å®¹ã€‚';
    }
  }

  String _getMealForTime(String timeOfDay) {
    switch (timeOfDay) {
      case 'morning': return 'æ—©é¤';
      case 'noon': return 'åˆé¤';
      case 'afternoon': return 'ä¸‹åˆèŒ¶';
      case 'evening': return 'æ™šé¤';
      default: return 'æ¶ˆè´¹';
    }
  }

  String _buildOutputConstraints() {
    return '''
## è¾“å‡ºè¦æ±‚
- ä¸è¶…è¿‡15ä¸ªå­—
- ç¦æ­¢ä½¿ç”¨è¡¨æƒ…ç¬¦å·
- ç›´æ¥è¾“å‡ºè¦è¯´çš„è¯ï¼Œä¸è¦ä»»ä½•è§£é‡Š''';
  }
}
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- å¯ä»¥åˆ›å»º VoiceAgentPromptBuilder å®ä¾‹
- è°ƒç”¨ build() è¿”å›åˆç†çš„æç¤ºè¯
- ç°æœ‰åŠŸèƒ½æ— å½±å“

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œåªæ˜¯å¤šäº†ç‹¬ç«‹çš„æç¤ºè¯æ„å»ºå·¥å…·

---

## é˜¶æ®µ 4ï¼šå¢å¼ºç”Ÿæˆå™¨ï¼ˆç»§æ‰¿æ–¹å¼ï¼‰

### ç›®æ ‡
åˆ›å»ºå¢å¼ºç‰ˆè¯é¢˜ç”Ÿæˆå™¨ï¼Œ**ç»§æ‰¿**ç°æœ‰ç”Ÿæˆå™¨ï¼Œä¸ä¿®æ”¹åŸæœ‰ä»£ç ã€‚

### æ”¹åŠ¨
æ–°å¢æ–‡ä»¶ï¼š`services/voice/enhanced_proactive_topic_generator.dart`

```dart
import 'proactive_topic_generator.dart';
import 'context/proactive_context.dart';
import 'context/conversation_context_provider.dart';
import 'context/voice_agent_prompt_builder.dart';
import 'context/task_type.dart';
import 'feature_flags.dart';
import '../qwen_service.dart';

/// å¢å¼ºç‰ˆä¸»åŠ¨è¯é¢˜ç”Ÿæˆå™¨
/// ç»§æ‰¿åŸæœ‰ç”Ÿæˆå™¨ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡æ„ŸçŸ¥å’ŒLLMç”Ÿæˆèƒ½åŠ›
class EnhancedProactiveTopicGenerator extends ProactiveTopicGenerator {
  final ConversationContextProvider _contextProvider;
  final VoiceAgentPromptBuilder _promptBuilder;
  final QwenService _qwenService;

  /// LLM è°ƒç”¨è¶…æ—¶æ—¶é—´
  static const _llmTimeout = Duration(seconds: 3);

  EnhancedProactiveTopicGenerator({
    required ConversationContextProvider contextProvider,
    required QwenService qwenService,
  }) : _contextProvider = contextProvider,
       _promptBuilder = VoiceAgentPromptBuilder(),
       _qwenService = qwenService;

  /// ç”Ÿæˆä¸»åŠ¨è¯é¢˜
  /// ä¼˜å…ˆä½¿ç”¨ LLMï¼Œè¶…æ—¶æˆ–å¤±è´¥åˆ™é™çº§åˆ°è§„åˆ™ç”Ÿæˆ
  @override
  Future<ProactiveTopic?> generateTopic() async {
    // å¦‚æœ Feature Flag å…³é—­ï¼Œç›´æ¥ä½¿ç”¨çˆ¶ç±»æ–¹æ³•
    if (!voiceFlags.useEnhancedTopicGenerator) {
      return super.generateTopic();
    }

    // è·å–ä¸Šä¸‹æ–‡
    final context = await _contextProvider.getProactiveContext();

    // å†³å®šä»»åŠ¡ç±»å‹
    final taskType = _decideTaskType(context);

    // å¦‚æœå†³å®šé™é»˜ï¼Œç›´æ¥è¿”å› null
    if (taskType == VoiceTaskType.silence) {
      return null;
    }

    // å¦‚æœå¯ç”¨ LLM ä¸”ä»»åŠ¡ç±»å‹é€‚åˆï¼Œå°è¯• LLM ç”Ÿæˆ
    if (voiceFlags.enableLLMTopicGeneration && _shouldUseLLM(taskType)) {
      final llmResult = await _tryLLMGeneration(context, taskType);
      if (llmResult != null) {
        return llmResult;
      }
      // LLM å¤±è´¥ï¼Œé™çº§åˆ°è§„åˆ™ç”Ÿæˆ
    }

    // è§„åˆ™ç”Ÿæˆï¼ˆç»§æ‰¿è‡ªçˆ¶ç±»æˆ–æœ¬åœ°å¢å¼ºè§„åˆ™ï¼‰
    return _generateByRules(context, taskType);
  }

  /// å†³å®šä»»åŠ¡ç±»å‹
  VoiceTaskType _decideTaskType(ProactiveContext context) {
    // ä¼˜å…ˆçº§1ï¼šæœ‰å¾…é€šçŸ¥ç»“æœ
    if (context.hasPendingResults) {
      return VoiceTaskType.notifyResult;
    }

    // ä¼˜å…ˆçº§2ï¼šç”¨æˆ·ä¸å–œæ¬¢ä¸»åŠ¨å¯¹è¯ï¼Œä¿æŒé™é»˜
    if (!context.likesProactiveChat) {
      return VoiceTaskType.silence;
    }

    // ä¼˜å…ˆçº§3ï¼šç‰¹å®šæ—¶é—´å¼•å¯¼
    final timeOfDay = context.environment.inferredTimeOfDay;
    if (['morning', 'noon', 'evening'].contains(timeOfDay)) {
      return VoiceTaskType.timeGuidance;
    }

    // ä¼˜å…ˆçº§4ï¼šæ²‰é»˜å¤ªä¹…ï¼Œç¤¼è²Œå‘Šåˆ«
    if (context.environment.silenceDuration > 30) {
      return VoiceTaskType.politeGoodbye;
    }

    // é»˜è®¤é™é»˜
    return VoiceTaskType.silence;
  }

  /// æ˜¯å¦åº”è¯¥ä½¿ç”¨ LLM
  bool _shouldUseLLM(VoiceTaskType taskType) {
    // é™é»˜å’Œç®€å•é€šçŸ¥ä¸éœ€è¦ LLM
    return taskType != VoiceTaskType.silence;
  }

  /// å°è¯• LLM ç”Ÿæˆ
  Future<ProactiveTopic?> _tryLLMGeneration(
    ProactiveContext context,
    VoiceTaskType taskType,
  ) async {
    try {
      final prompt = _promptBuilder.build(
        context: context,
        taskType: taskType,
      );

      final response = await _qwenService
          .generateText(prompt)
          .timeout(_llmTimeout);

      if (response != null && response.isNotEmpty) {
        return ProactiveTopic(
          text: response.trim(),
          type: taskType.name,
          source: 'llm',
        );
      }
    } catch (e) {
      // è¶…æ—¶æˆ–å…¶ä»–é”™è¯¯ï¼Œé™é»˜å¤„ç†
      if (voiceFlags.debugLogContext) {
        print('[EnhancedGenerator] LLM failed: $e');
      }
    }
    return null;
  }

  /// è§„åˆ™ç”Ÿæˆ
  ProactiveTopic? _generateByRules(
    ProactiveContext context,
    VoiceTaskType taskType,
  ) {
    String? text;

    switch (taskType) {
      case VoiceTaskType.notifyResult:
        final count = context.pendingResults.length;
        text = count == 1 ? 'è®°å¥½äº†ï¼Œè¿˜æœ‰å—ï¼Ÿ' : '$countç¬”éƒ½è®°å¥½äº†ï¼Œè¿˜æœ‰è¦è®°çš„å—ï¼Ÿ';
        break;

      case VoiceTaskType.timeGuidance:
        final meal = _getMealName(context.environment.inferredTimeOfDay);
        text = '$mealè®°äº†å—ï¼Ÿ';
        break;

      case VoiceTaskType.politeGoodbye:
        text = 'æœ‰éœ€è¦éšæ—¶æ‰¾æˆ‘å“¦';
        break;

      case VoiceTaskType.casualChat:
        text = 'è®°è´¦è´µåœ¨åšæŒå“¦';
        break;

      case VoiceTaskType.silence:
        return null;
    }

    if (text != null) {
      return ProactiveTopic(
        text: text,
        type: taskType.name,
        source: 'rules',
      );
    }
    return null;
  }

  String _getMealName(String timeOfDay) {
    switch (timeOfDay) {
      case 'morning': return 'æ—©é¤';
      case 'noon': return 'åˆé¤';
      case 'evening': return 'æ™šé¤';
      default: return 'æ¶ˆè´¹';
    }
  }
}
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- å¯ä»¥åˆ›å»º EnhancedProactiveTopicGenerator å®ä¾‹
- Feature Flag å…³é—­æ—¶ï¼Œè¡Œä¸ºä¸åŸç”Ÿæˆå™¨å®Œå…¨ä¸€è‡´
- Feature Flag å¼€å¯æ—¶ï¼Œä½¿ç”¨æ–°é€»è¾‘
- ç°æœ‰åŠŸèƒ½æ— å½±å“ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰ä½¿ç”¨æ–°ç”Ÿæˆå™¨ï¼‰

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œæ–°ç”Ÿæˆå™¨å­˜åœ¨ä½†æœªè¢«ä½¿ç”¨

---

## é˜¶æ®µ 5ï¼šå¯é€‰é›†æˆï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

### ç›®æ ‡
åœ¨è°ƒç”¨ç‚¹æ·»åŠ æ¡ä»¶é€»è¾‘ï¼Œæ ¹æ® Feature Flag é€‰æ‹©ä½¿ç”¨å“ªä¸ªç”Ÿæˆå™¨ã€‚

### æ”¹åŠ¨
ä¿®æ”¹æ–‡ä»¶ï¼š`services/voice_service_coordinator.dart`ï¼ˆä»…æ·»åŠ å‡ è¡Œä»£ç ï¼‰

**æ”¹åŠ¨å‰**:
```dart
class VoiceServiceCoordinator {
  late final ProactiveTopicGenerator _topicGenerator;

  void _initializeComponents() {
    _topicGenerator = ProactiveTopicGenerator();
    // ...
  }
}
```

**æ”¹åŠ¨å**:
```dart
import 'voice/feature_flags.dart';
import 'voice/enhanced_proactive_topic_generator.dart';
import 'voice/context/conversation_context_provider.dart';

class VoiceServiceCoordinator {
  late final ProactiveTopicGenerator _topicGenerator;

  void _initializeComponents() {
    // æ ¹æ® Feature Flag é€‰æ‹©ç”Ÿæˆå™¨
    if (voiceFlags.useEnhancedTopicGenerator) {
      _topicGenerator = EnhancedProactiveTopicGenerator(
        contextProvider: ConversationContextProvider(
          resultBuffer: _resultBuffer,
          conversationMemory: _conversationMemory,
          contextManager: _contextManager,
          userProfileService: _userProfileService,
        ),
        qwenService: _qwenService,
      );
    } else {
      _topicGenerator = ProactiveTopicGenerator();
    }
    // ...
  }
}
```

### éªŒè¯
- ç¼–è¯‘é€šè¿‡
- Feature Flag å…³é—­ï¼šä½¿ç”¨åŸç”Ÿæˆå™¨ï¼Œè¡Œä¸ºå®Œå…¨ä¸å˜
- Feature Flag å¼€å¯ï¼šä½¿ç”¨æ–°ç”Ÿæˆå™¨
- å¯ä»¥éšæ—¶é€šè¿‡ä¿®æ”¹ Flag åˆ‡æ¢

### ç³»ç»ŸçŠ¶æ€
âœ… å®Œå…¨æ­£å¸¸ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜ï¼ˆFlag é»˜è®¤å…³é—­ï¼‰

---

## é˜¶æ®µ 6ï¼šç°åº¦å¯ç”¨

### ç›®æ ‡
é€æ­¥å¯ç”¨æ–°åŠŸèƒ½ï¼Œç›‘æ§æ•ˆæœã€‚

### å¯ç”¨æ­¥éª¤

**Step 1: å¼€å‘ç¯å¢ƒæµ‹è¯•**
```dart
// åœ¨ main.dart æˆ–åˆå§‹åŒ–ä»£ç ä¸­
void main() {
  // å¼€å‘ç¯å¢ƒå¯ç”¨è°ƒè¯•æ—¥å¿—
  if (kDebugMode) {
    voiceFlags.debugLogContext = true;
    voiceFlags.useEnhancedTopicGenerator = true;
    // æš‚ä¸å¯ç”¨ LLM
    voiceFlags.enableLLMTopicGeneration = false;
  }
  runApp(MyApp());
}
```

**Step 2: å†…æµ‹ç”¨æˆ·å¯ç”¨ï¼ˆçº¯è§„åˆ™æ¨¡å¼ï¼‰**
```dart
// æ ¹æ®ç”¨æˆ·IDåˆ¤æ–­
if (isInternalTester(userId)) {
  voiceFlags.enableEnhancedRulesOnly();
}
```

**Step 3: éƒ¨åˆ†ç”¨æˆ·å¯ç”¨ LLM**
```dart
// 10% ç”¨æˆ·å¯ç”¨ LLM
if (userId.hashCode % 100 < 10) {
  voiceFlags.enableFullEnhanced();
} else if (userId.hashCode % 100 < 50) {
  voiceFlags.enableEnhancedRulesOnly();
}
```

**Step 4: å…¨é‡å‘å¸ƒ**
```dart
// æ‰€æœ‰ç”¨æˆ·å¯ç”¨
voiceFlags.enableFullEnhanced();
```

### å›æ»šæ–¹æ¡ˆ
ä»»ä½•æ—¶å€™å‘ç°é—®é¢˜ï¼Œåªéœ€ï¼š
```dart
voiceFlags.resetToDefaults();
```
ç³»ç»Ÿç«‹å³æ¢å¤åŸæœ‰è¡Œä¸ºã€‚

### ç³»ç»ŸçŠ¶æ€
âœ… å¯æ§çš„é€æ­¥å¯ç”¨ï¼Œéšæ—¶å¯å›æ»š

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰
```
app/lib/services/voice/
â”œâ”€â”€ feature_flags.dart                              # é˜¶æ®µ0
â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ proactive_context.dart                      # é˜¶æ®µ1
â”‚   â”œâ”€â”€ conversation_context_provider.dart          # é˜¶æ®µ2
â”‚   â”œâ”€â”€ task_type.dart                              # é˜¶æ®µ3
â”‚   â””â”€â”€ voice_agent_prompt_builder.dart             # é˜¶æ®µ3
â””â”€â”€ enhanced_proactive_topic_generator.dart         # é˜¶æ®µ4
```

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ1ä¸ªï¼Œä»…é˜¶æ®µ5ï¼‰
```
app/lib/services/voice_service_coordinator.dart     # çº¦10è¡Œä»£ç 
```

---

## æ—¶é—´è¡¨

| é˜¶æ®µ | é¢„è®¡è€—æ—¶ | ç´¯è®¡ | å¯éƒ¨ç½² |
|------|---------|------|--------|
| 0 | 0.5h | 0.5h | âœ… |
| 1 | 1h | 1.5h | âœ… |
| 2 | 2h | 3.5h | âœ… |
| 3 | 2h | 5.5h | âœ… |
| 4 | 3h | 8.5h | âœ… |
| 5 | 0.5h | 9h | âœ… |
| 6 | ç°åº¦ | - | âœ… |

**æ€»è®¡**: çº¦9å°æ—¶å¼€å‘ + ç°åº¦è§‚å¯ŸæœŸ

---

## æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¸è¿›å¼å‡çº§ä¿éšœ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… æ¯é˜¶æ®µå®Œæˆåç³»ç»Ÿæ­£å¸¸è¿è¡Œ                                  â”‚
â”‚ âœ… é»˜è®¤è¡Œä¸ºä¸å˜ï¼Œéœ€æ˜¾å¼å¯ç”¨æ–°åŠŸèƒ½                            â”‚
â”‚ âœ… Feature Flag æ§åˆ¶ï¼Œéšæ—¶å¯å›æ»š                            â”‚
â”‚ âœ… æ–°å¢ä»£ç ä¸ºä¸»ï¼Œæœ€å°åŒ–ä¿®æ”¹ç°æœ‰ä»£ç                           â”‚
â”‚ âœ… å¯ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæ–°ç»„ä»¶                                      â”‚
â”‚ âœ… æ”¯æŒ A/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€**: ğŸ“ æ–¹æ¡ˆå·²è®¾è®¡
**ä¸‹ä¸€æ­¥**: ä»é˜¶æ®µ0å¼€å§‹å®æ–½
