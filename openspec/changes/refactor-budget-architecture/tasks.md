# 预算系统架构重构任务清单

## 任务概述

本文档列出了预算系统架构重构的所有任务，按照实施阶段组织，每个任务都是可验证的小型工作项。

---

## 阶段1：数据层重构

### 1.1 创建统一模型

- [ ] **任务1.1.1**: 定义 `UnifiedBudget` 模型类
  - 创建 `app/lib/models/unified_budget.dart`
  - 定义所有字段和构造函数
  - 实现 `copyWith()` 方法
  - **验证**: 编译通过，无警告

- [ ] **任务1.1.2**: 定义 `BudgetMode` 枚举
  - 在 `unified_budget.dart` 中定义枚举
  - 添加 `displayName` extension
  - 添加 `description` extension
  - **验证**: 单元测试通过

- [ ] **任务1.1.3**: 实现序列化方法
  - 实现 `toMap()` 方法
  - 实现 `fromMap()` 工厂方法
  - 处理所有可选字段
  - **验证**: 序列化/反序列化测试通过

- [ ] **任务1.1.4**: 实现计算属性
  - 实现 `currentAmount` getter
  - 实现 `available` getter
  - 实现 `progress` getter
  - 实现 `usageRate` getter
  - 实现 `status` getter
  - **验证**: 单元测试覆盖所有计算逻辑

### 1.2 数据库迁移

- [ ] **任务1.2.1**: 创建数据库迁移脚本
  - 在 `database_service.dart` 中添加迁移方法
  - 创建 `unified_budgets` 表
  - 定义所有字段和约束
  - **验证**: 表创建成功

- [ ] **任务1.2.2**: 创建数据库索引
  - 创建 `ledgerId` 索引
  - 创建 `mode` 索引
  - 创建 `categoryId` 索引
  - 创建 `isEnabled` 索引
  - **验证**: 索引创建成功，查询性能测试通过

- [ ] **任务1.2.3**: 编写数据迁移逻辑
  - 从 `budgets` 表迁移数据
  - 从 `budget_vaults` 表迁移数据
  - 处理字段映射和类型转换
  - **验证**: 迁移测试通过（使用测试数据）

- [ ] **任务1.2.4**: 实现备份和回滚
  - 重命名旧表为 `_backup` 后缀
  - 实现回滚方法
  - 添加迁移状态检查
  - **验证**: 回滚测试通过

- [ ] **任务1.2.5**: 更新数据库版本
  - 更新 `_databaseVersion` 常量
  - 在 `_onUpgrade` 中调用迁移方法
  - 添加版本检查逻辑
  - **验证**: 数据库升级成功

### 1.3 Repository 层

- [ ] **任务1.3.1**: 创建 `UnifiedBudgetRepository` 接口
  - 定义 CRUD 方法签名
  - 定义零基预算特有方法
  - 定义查询方法
  - **验证**: 接口定义清晰，编译通过

- [ ] **任务1.3.2**: 实现基础 CRUD 操作
  - 实现 `create()` 方法
  - 实现 `update()` 方法
  - 实现 `delete()` 方法
  - 实现 `getById()` 方法
  - 实现 `getAll()` 方法
  - **验证**: 单元测试通过

- [ ] **任务1.3.3**: 实现查询方法
  - 实现 `getByLedger()` 方法
  - 实现 `getByMode()` 方法
  - 实现 `getByCategory()` 方法
  - 实现 `getByVaultType()` 方法
  - **验证**: 查询测试通过

- [ ] **任务1.3.4**: 实现零基预算操作
  - 实现 `allocate()` 方法（分配金额）
  - 实现 `spend()` 方法（记录支出）
  - 实现 `transfer()` 方法（小金库转账）
  - **验证**: 业务逻辑测试通过

- [ ] **任务1.3.5**: 实现统计方法
  - 实现 `getTotalAllocated()` 方法
  - 实现 `getTotalSpent()` 方法
  - 实现 `getSummary()` 方法
  - **验证**: 统计计算正确

- [ ] **任务1.3.6**: 编写 Repository 单元测试
  - 测试所有 CRUD 操作
  - 测试所有查询方法
  - 测试零基预算操作
  - 测试边界条件和错误处理
  - **验证**: 测试覆盖率 > 80%

---

## 阶段2：业务层重构

### 2.1 Provider 重构

- [ ] **任务2.1.1**: 创建 `UnifiedBudgetProvider`
  - 创建 `app/lib/providers/unified_budget_provider.dart`
  - 继承 `StateNotifier<List<UnifiedBudget>>`
  - 注入 `UnifiedBudgetRepository`
  - **验证**: 编译通过

- [ ] **任务2.1.2**: 实现数据加载
  - 实现 `loadAll()` 方法
  - 实现 `loadByLedger()` 方法
  - 添加加载状态管理
  - **验证**: 数据加载测试通过

- [ ] **任务2.1.3**: 实现 CRUD 操作
  - 实现 `create()` 方法
  - 实现 `update()` 方法
  - 实现 `delete()` 方法
  - 更新 state
  - **验证**: 状态更新测试通过

- [ ] **任务2.1.4**: 实现过滤和查询
  - 实现 `traditionalBudgets` getter
  - 实现 `zeroBasedBudgets` getter
  - 实现 `getByVaultType()` 方法
  - 实现 `getByCategory()` 方法
  - **验证**: 过滤逻辑测试通过

- [ ] **任务2.1.5**: 实现零基预算操作
  - 实现 `allocate()` 方法
  - 实现 `transfer()` 方法
  - 实现 `recordSpending()` 方法
  - **验证**: 业务逻辑测试通过

- [ ] **任务2.1.6**: 实现统计计算
  - 实现 `totalAllocated` getter
  - 实现 `totalSpent` getter
  - 实现 `totalAvailable` getter
  - 实现 `summary` getter
  - **验证**: 统计计算正确

- [ ] **任务2.1.7**: 编写 Provider 单元测试
  - 测试所有方法
  - 测试状态更新
  - 测试错误处理
  - **验证**: 测试覆盖率 > 80%

### 2.2 Service 整合

- [ ] **任务2.2.1**: 创建 `UnifiedBudgetService`
  - 创建 `app/lib/services/unified_budget_service.dart`
  - 整合 `smart_budget_service.dart` 逻辑
  - 整合 `adaptive_budget_service.dart` 逻辑
  - **验证**: 编译通过

- [ ] **任务2.2.2**: 实现预算计算逻辑
  - 实现预算剩余计算
  - 实现预算使用率计算
  - 实现预算状态判断
  - **验证**: 计算逻辑测试通过

- [ ] **任务2.2.3**: 实现预算提醒逻辑
  - 实现超支提醒
  - 实现即将超支提醒
  - 实现到期提醒
  - **验证**: 提醒触发测试通过

- [ ] **任务2.2.4**: 实现预算结转逻辑
  - 实现月度结转
  - 实现剩余结转
  - 实现超支结转
  - **验证**: 结转逻辑测试通过

- [ ] **任务2.2.5**: 实现零基预算分配逻辑
  - 实现自动分配算法
  - 实现优先级分配
  - 实现智能分配建议
  - **验证**: 分配算法测试通过

- [ ] **任务2.2.6**: 删除重复代码
  - 标记 `smart_budget_service.dart` 为废弃
  - 标记 `vault_repository.dart` 为废弃
  - 更新所有引用
  - **验证**: 无编译错误

- [ ] **任务2.2.7**: 编写 Service 单元测试
  - 测试所有业务逻辑
  - 测试边界条件
  - 测试错误处理
  - **验证**: 测试覆盖率 > 80%

### 2.3 业务逻辑迁移

- [ ] **任务2.3.1**: 迁移预算监控逻辑
  - 从 `budget_alert_service.dart` 迁移
  - 适配新模型
  - 更新提醒触发条件
  - **验证**: 提醒功能正常

- [ ] **任务2.3.2**: 迁移预算建议逻辑
  - 从 `budget_suggestion_engine.dart` 迁移
  - 适配新模型
  - 更新建议算法
  - **验证**: 建议功能正常

- [ ] **任务2.3.3**: 迁移预算分析逻辑
  - 从 `budget_planning_coordinator.dart` 迁移
  - 适配新模型
  - 更新分析算法
  - **验证**: 分析功能正常

- [ ] **任务2.3.4**: 更新交易关联逻辑
  - 更新 `transaction_provider.dart`
  - 支持新预算模型
  - 更新预算扣减逻辑
  - **验证**: 交易记录正确关联预算

---

## 阶段3：UI层重构

### 3.1 预算中心页面

- [ ] **任务3.1.1**: 设计预算中心界面
  - 设计模式切换开关
  - 设计传统预算视图
  - 设计零基预算视图
  - **验证**: UI设计评审通过

- [ ] **任务3.1.2**: 实现预算中心页面
  - 创建 `app/lib/pages/unified_budget_center_page.dart`
  - 实现页面布局
  - 实现模式切换
  - **验证**: 页面渲染正常

- [ ] **任务3.1.3**: 实现传统预算视图
  - 显示分类预算列表
  - 显示预算使用情况
  - 显示预算状态
  - **验证**: 视图显示正确

- [ ] **任务3.1.4**: 实现零基预算视图
  - 显示小金库列表
  - 按类型分组显示
  - 显示分配和使用情况
  - **验证**: 视图显示正确

- [ ] **任务3.1.5**: 实现预算摘要卡片
  - 显示总预算
  - 显示已使用
  - 显示剩余
  - 显示状态指示器
  - **验证**: 摘要数据正确

- [ ] **任务3.1.6**: 实现预算列表
  - 实现列表项组件
  - 实现滑动操作
  - 实现点击跳转
  - **验证**: 交互流畅

### 3.2 预算详情页面

- [ ] **任务3.2.1**: 设计预算详情界面
  - 设计传统预算详情
  - 设计零基预算详情
  - 设计编辑界面
  - **验证**: UI设计评审通过

- [ ] **任务3.2.2**: 实现预算详情页面
  - 创建 `app/lib/pages/unified_budget_detail_page.dart`
  - 实现页面布局
  - 根据模式显示不同内容
  - **验证**: 页面渲染正常

- [ ] **任务3.2.3**: 实现传统预算详情
  - 显示预算信息
  - 显示使用情况图表
  - 显示相关交易列表
  - **验证**: 详情显示正确

- [ ] **任务3.2.4**: 实现零基预算详情
  - 显示小金库信息
  - 显示分配历史
  - 显示支出记录
  - 显示转账记录
  - **验证**: 详情显示正确

- [ ] **任务3.2.5**: 实现预算编辑功能
  - 实现编辑表单
  - 实现字段验证
  - 实现保存逻辑
  - **验证**: 编辑功能正常

- [ ] **任务3.2.6**: 实现零基预算操作
  - 实现分配金额对话框
  - 实现转账对话框
  - 实现操作确认
  - **验证**: 操作功能正常

### 3.3 首页集成

- [ ] **任务3.3.1**: 更新首页预算摘要
  - 更新 `home_page.dart`
  - 使用 `UnifiedBudgetProvider`
  - 根据模式显示不同指标
  - **验证**: 首页显示正确

- [ ] **任务3.3.2**: 更新预算状态栏
  - 更新 `budget_status_bar.dart`
  - 适配新模型
  - 显示统一的预算状态
  - **验证**: 状态栏显示正确

- [ ] **任务3.3.3**: 更新预算卡片
  - 更新首页预算卡片
  - 显示当前模式的摘要
  - 添加快速操作按钮
  - **验证**: 卡片显示正确

### 3.4 引导流程

- [ ] **任务3.4.1**: 设计预算模式选择向导
  - 设计欢迎页面
  - 设计模式对比页面
  - 设计模式选择页面
  - **验证**: UI设计评审通过

- [ ] **任务3.4.2**: 实现预算模式选择向导
  - 创建 `app/lib/pages/budget_mode_wizard_page.dart`
  - 实现多步骤向导
  - 实现模式对比展示
  - **验证**: 向导流程正常

- [ ] **任务3.4.3**: 实现首次使用引导
  - 检测首次使用
  - 自动显示向导
  - 保存用户选择
  - **验证**: 引导触发正确

- [ ] **任务3.4.4**: 实现模式切换确认
  - 实现切换确认对话框
  - 提示数据迁移影响
  - 实现切换逻辑
  - **验证**: 切换功能正常

### 3.5 其他页面更新

- [ ] **任务3.5.1**: 更新报表页面
  - 更新 `budget_report_page.dart`
  - 适配新模型
  - 更新图表数据源
  - **验证**: 报表显示正确

- [ ] **任务3.5.2**: 更新设置页面
  - 添加预算模式设置
  - 添加预算相关设置
  - **验证**: 设置功能正常

- [ ] **任务3.5.3**: 更新语音助手
  - 更新预算相关语音命令
  - 适配新模型
  - 更新语音反馈
  - **验证**: 语音功能正常

---

## 阶段4：测试与优化

### 4.1 功能测试

- [ ] **任务4.1.1**: 传统预算功能测试
  - 测试预算创建
  - 测试预算编辑
  - 测试预算删除
  - 测试预算监控
  - 测试预算提醒
  - **验证**: 所有功能正常

- [ ] **任务4.1.2**: 零基预算功能测试
  - 测试小金库创建
  - 测试收入分配
  - 测试支出记录
  - 测试小金库转账
  - 测试预算提醒
  - **验证**: 所有功能正常

- [ ] **任务4.1.3**: 模式切换测试
  - 测试从传统切换到零基
  - 测试从零基切换到传统
  - 测试数据迁移
  - 测试数据一致性
  - **验证**: 切换功能正常

- [ ] **任务4.1.4**: 数据迁移测试
  - 准备测试数据
  - 测试迁移脚本
  - 验证数据完整性
  - 测试回滚功能
  - **验证**: 迁移成功，数据无丢失

- [ ] **任务4.1.5**: 集成测试
  - 测试完整的用户流程
  - 测试跨页面交互
  - 测试数据同步
  - **验证**: 端到端流程正常

### 4.2 性能优化

- [ ] **任务4.2.1**: 查询性能优化
  - 分析慢查询
  - 优化索引使用
  - 优化查询语句
  - **验证**: 查询时间 < 100ms

- [ ] **任务4.2.2**: 缓存策略优化
  - 实现预算数据缓存
  - 实现智能缓存失效
  - 减少数据库访问
  - **验证**: 缓存命中率 > 80%

- [ ] **任务4.2.3**: 内存使用优化
  - 分析内存占用
  - 优化大对象创建
  - 实现对象池
  - **验证**: 内存占用 < 50MB

- [ ] **任务4.2.4**: UI渲染优化
  - 优化列表渲染
  - 实现懒加载
  - 减少重建次数
  - **验证**: 页面渲染 < 16ms

### 4.3 用户体验优化

- [ ] **任务4.3.1**: 交互流程优化
  - 简化操作步骤
  - 添加快捷操作
  - 优化表单输入
  - **验证**: 用户测试反馈良好

- [ ] **任务4.3.2**: 错误提示优化
  - 添加友好的错误提示
  - 提供解决方案建议
  - 优化错误恢复
  - **验证**: 错误处理完善

- [ ] **任务4.3.3**: 加载状态优化
  - 添加加载指示器
  - 实现骨架屏
  - 优化加载体验
  - **验证**: 加载体验流畅

- [ ] **任务4.3.4**: 动画效果优化
  - 添加页面转场动画
  - 添加列表动画
  - 优化动画性能
  - **验证**: 动画流畅，无卡顿

---

## 阶段5：文档与发布

### 5.1 文档更新

- [ ] **任务5.1.1**: 更新 API 文档
  - 文档化 `UnifiedBudget` 模型
  - 文档化 `UnifiedBudgetProvider`
  - 文档化 `UnifiedBudgetService`
  - **验证**: 文档完整清晰

- [ ] **任务5.1.2**: 更新用户指南
  - 编写预算功能使用指南
  - 编写模式选择指南
  - 编写常见问题解答
  - **验证**: 用户指南易懂

- [ ] **任务5.1.3**: 编写迁移指南
  - 编写开发者迁移指南
  - 说明 API 变更
  - 提供迁移示例
  - **验证**: 迁移指南完整

- [ ] **任务5.1.4**: 更新架构文档
  - 更新系统架构图
  - 更新数据库设计文档
  - 更新技术决策记录
  - **验证**: 架构文档准确

### 5.2 发布准备

- [ ] **任务5.2.1**: 编写 Release Notes
  - 列出新功能
  - 列出改进项
  - 列出已知问题
  - **验证**: Release Notes 完整

- [ ] **任务5.2.2**: 准备回滚方案
  - 编写回滚步骤
  - 准备回滚脚本
  - 测试回滚流程
  - **验证**: 回滚方案可行

- [ ] **任务5.2.3**: 准备用户通知
  - 编写更新通知
  - 准备功能介绍
  - 准备帮助文档链接
  - **验证**: 通知内容清晰

- [ ] **任务5.2.4**: 代码审查
  - 提交 Pull Request
  - 进行代码审查
  - 修复审查问题
  - **验证**: 代码审查通过

- [ ] **任务5.2.5**: 最终测试
  - 在测试环境全面测试
  - 修复发现的问题
  - 确认所有功能正常
  - **验证**: 测试通过，无阻塞问题

- [ ] **任务5.2.6**: 发布到生产环境
  - 部署新版本
  - 监控系统状态
  - 收集用户反馈
  - **验证**: 发布成功，系统稳定

---

## 任务依赖关系

### 关键路径

1. 数据层重构 → 业务层重构 → UI层重构 → 测试与优化 → 发布
2. 模型定义 → 数据库迁移 → Repository → Provider → UI

### 可并行任务

- 任务1.1（模型定义）和任务1.2（数据库迁移）可以并行
- 任务3.1（预算中心）和任务3.2（预算详情）可以并行
- 任务3.3（首页集成）和任务3.4（引导流程）可以并行
- 任务4.1（功能测试）和任务4.2（性能优化）可以并行

### 阻塞关系

- 任务2.x 依赖任务1.x 完成
- 任务3.x 依赖任务2.x 完成
- 任务4.x 依赖任务3.x 完成
- 任务5.x 依赖任务4.x 完成

---

## 任务统计

- **总任务数**: 106
- **阶段1**: 21 个任务
- **阶段2**: 24 个任务
- **阶段3**: 31 个任务
- **阶段4**: 18 个任务
- **阶段5**: 12 个任务

---

## 进度跟踪

- [ ] 阶段1：数据层重构（0/21）
- [ ] 阶段2：业务层重构（0/24）
- [ ] 阶段3：UI层重构（0/31）
- [ ] 阶段4：测试与优化（0/18）
- [ ] 阶段5：文档与发布（0/12）

**总进度**: 0/106 (0%)

---

**最后更新**: 2026-01-25
**预计完成时间**: 8-12 个工作日
