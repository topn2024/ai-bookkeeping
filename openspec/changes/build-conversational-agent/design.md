# å¯¹è¯å¼æ™ºèƒ½ä½“æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ä¸Šä¸‹æ–‡

### å½“å‰çŠ¶æ€

è¯­éŸ³åŠ©æ‰‹å·²å…·å¤‡ä»¥ä¸‹åŸºç¡€èƒ½åŠ›ï¼š
- ASRè¯­éŸ³è¯†åˆ«ï¼ˆé˜¿é‡Œäº‘åœ¨çº¿ + ç¦»çº¿é™çº§ï¼‰
- TTSè¯­éŸ³åˆæˆï¼ˆç³»ç»ŸTTS + é˜¿é‡Œäº‘TTSï¼‰
- LLMæ„å›¾è¯†åˆ«ï¼ˆåƒé—®å¤§æ¨¡å‹ï¼‰
- è§„åˆ™å¼•æ“å…œåº•ï¼ˆVoiceIntentRouterï¼‰
- å¹¶å‘è¯­éŸ³ç®¡é“ï¼ˆConcurrentVoicePipelineï¼‰
- å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆConversationContextï¼‰

### ç¼ºå¤±èƒ½åŠ›

1. **èŠå¤©/åŠŸèƒ½åˆ†ç¦»**ï¼šå½“å‰æ‰€æœ‰è¾“å…¥éƒ½è¢«å½“ä½œ"å‘½ä»¤"å¤„ç†
2. **è¡Œä¸ºæŠ½è±¡**ï¼šå„åŠŸèƒ½ï¼ˆè®°è´¦ã€æŸ¥è¯¢ã€å¯¼èˆªï¼‰è€¦åˆåœ¨ä¸€èµ·
3. **ä¸»åŠ¨äº¤äº’**ï¼šåªèƒ½è¢«åŠ¨å“åº”ï¼Œæ— æ³•ä¸»åŠ¨å‘èµ·
4. **äººæ ¼ä¸€è‡´æ€§**ï¼šå“åº”ç¼ºä¹ç»Ÿä¸€çš„"åŠ©æ‰‹äººæ ¼"

### çº¦æŸ

- å¿…é¡»å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½ï¼Œé¿å…é‡å¤å»ºè®¾
- å“åº”å»¶è¿Ÿæ§åˆ¶åœ¨ç”¨æˆ·å¯æ¥å—èŒƒå›´ï¼ˆ<2ç§’ï¼‰
- æ”¯æŒç¦»çº¿é™çº§æ¨¡å¼
- éµå¾ªç°æœ‰ä»£ç è§„èŒƒå’Œæ¶æ„æ¨¡å¼

---

## ç›®æ ‡ / éç›®æ ‡

### ç›®æ ‡

1. æ„å»ºå¯¹è¯å¼æ™ºèƒ½ä½“æ ¸å¿ƒå¼•æ“
2. å®ç°èŠå¤©ä¸åŠŸèƒ½çš„æ™ºèƒ½è·¯ç”±
3. å»ºç«‹å¯æ‰©å±•çš„è¡Œä¸ºæ‰§è¡Œæ¡†æ¶
4. å¢å¼ºä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›
5. æä¾›ç»Ÿä¸€çš„åŠ©æ‰‹äººæ ¼

### éç›®æ ‡

- ä¸æ¶‰åŠASR/TTSåº•å±‚æ”¹é€ ï¼ˆå·²æœ‰ï¼‰
- ä¸å®ç°å¤šåŠ©æ‰‹äººæ ¼åˆ‡æ¢
- ä¸å®ç°ç¦»çº¿èŠå¤©ï¼ˆéœ€è¦LLMï¼‰
- ä¸æ¶‰åŠUIç•Œé¢é‡æ„

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ConversationalAgent                                 â”‚
â”‚                         (å¯¹è¯å¼æ™ºèƒ½ä½“æ ¸å¿ƒ)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        Input Layer (è¾“å…¥å±‚)                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚   â”‚  â”‚    ASR      â”‚  â”‚  Text Input â”‚  â”‚   Gesture   â”‚                 â”‚   â”‚
â”‚   â”‚  â”‚  è¯­éŸ³è¯†åˆ«   â”‚  â”‚   æ–‡å­—è¾“å…¥   â”‚  â”‚   æ‰‹åŠ¿è¾“å…¥   â”‚                 â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚   â”‚                       â–¼                                             â”‚   â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚   â”‚
â”‚   â”‚              â”‚  InputNormalizerâ”‚                                    â”‚   â”‚
â”‚   â”‚              â”‚   è¾“å…¥å½’ä¸€åŒ–     â”‚                                    â”‚   â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Routing Layer (è·¯ç”±å±‚)                           â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    IntentRouter                              â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                    æ„å›¾è·¯ç”±å™¨                                 â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  Chat   â”‚  â”‚ Action  â”‚  â”‚ Hybrid  â”‚  â”‚ Unknown â”‚        â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  èŠå¤©   â”‚  â”‚  åŠŸèƒ½   â”‚  â”‚  æ··åˆ   â”‚  â”‚  æœªçŸ¥   â”‚        â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼            â–¼            â–¼            â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                   Processing Layer (å¤„ç†å±‚)                         â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ ChatEngine  â”‚  â”‚ActionExecutorâ”‚  â”‚   ContextManager       â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  èŠå¤©å¼•æ“   â”‚  â”‚  è¡Œä¸ºæ‰§è¡Œå™¨  â”‚  â”‚     ä¸Šä¸‹æ–‡ç®¡ç†å™¨        â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚          â”‚                â”‚                      â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ActionRegistryâ”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚  è¡Œä¸ºæ³¨å†Œè¡¨  â”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â”‚Transactionâ”‚ â”‚             â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â”‚Navigation â”‚ â”‚             â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â”‚  Query   â”‚ â”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â”‚  Config  â”‚ â”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                 â”‚   â”‚
â”‚   â”‚          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                              â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Output Layer (è¾“å‡ºå±‚)                            â”‚   â”‚
â”‚   â”‚                                                                     â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚  ResponseGenerator  â”‚â”€â”€â”€â–¶â”‚     TTS     â”‚â”€â”€â”€â–¶â”‚  AudioOutput  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚     å“åº”ç”Ÿæˆå™¨       â”‚    â”‚   è¯­éŸ³åˆæˆ  â”‚    â”‚    éŸ³é¢‘è¾“å‡º   â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### LLM ä¸æ‰§è¡Œå±‚èŒè´£åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          èŒè´£åˆ†ç¦»æ¶æ„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚         LLM å±‚ï¼ˆç†è§£ï¼‰           â”‚   â”‚        æ‰§è¡Œå±‚ï¼ˆæ“ä½œï¼‰            â”‚â”‚
â”‚   â”‚         ~800ms                  â”‚   â”‚         ~100ms                  â”‚â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚   â”‚                                 â”‚   â”‚                                 â”‚â”‚
â”‚   â”‚  âœ“ æ„å›¾åˆ†ç±»                     â”‚   â”‚  âœ“ è°ƒç”¨ç°æœ‰ Service             â”‚â”‚
â”‚   â”‚    - chat / action / hybrid    â”‚   â”‚    - BudgetService              â”‚â”‚
â”‚   â”‚                                 â”‚   â”‚    - AccountService             â”‚â”‚
â”‚   â”‚  âœ“ å®ä½“æå–                     â”‚   â”‚    - CategoryService            â”‚â”‚
â”‚   â”‚    - amount, category, time    â”‚   â”‚    - ReminderService            â”‚â”‚
â”‚   â”‚    - configKey, configValue    â”‚   â”‚    - ThemeService               â”‚â”‚
â”‚   â”‚                                 â”‚   â”‚    - ...                        â”‚â”‚
â”‚   â”‚  âœ“ æƒ…æ„Ÿ/æƒ…ç»ªåˆ¤æ–­                â”‚   â”‚                                 â”‚â”‚
â”‚   â”‚    - å¼€å¿ƒ/æ²®ä¸§/ç„¦è™‘/å¹³é™        â”‚   â”‚  âœ“ å¤ç”¨ç°æœ‰å¯¼èˆª                  â”‚â”‚
â”‚   â”‚                                 â”‚   â”‚    - VoiceNavigationExecutor    â”‚â”‚
â”‚   â”‚  âœ“ é™ªèŠå“åº”ç”Ÿæˆ                 â”‚   â”‚                                 â”‚â”‚
â”‚   â”‚    - è‡ªç„¶è¯­è¨€å¯¹è¯               â”‚   â”‚  âœ“ å¤ç”¨ç°æœ‰è®°è´¦                  â”‚â”‚
â”‚   â”‚                                 â”‚   â”‚    - TransactionService         â”‚â”‚
â”‚   â”‚  âœ— ä¸æ‰§è¡Œä»»ä½•ä¸šåŠ¡æ“ä½œ           â”‚   â”‚                                 â”‚â”‚
â”‚   â”‚  âœ— ä¸ç›´æ¥ä¿®æ”¹é…ç½®               â”‚   â”‚  âœ— ä¸åšæ„å›¾ç†è§£                  â”‚â”‚
â”‚   â”‚  âœ— ä¸æŸ¥è¯¢æ•°æ®åº“                 â”‚   â”‚  âœ— ä¸åšå®ä½“æå–                  â”‚â”‚
â”‚   â”‚                                 â”‚   â”‚                                 â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                    â”‚                                   â–²                    â”‚
â”‚                    â”‚     IntentResult                  â”‚                    â”‚
â”‚                    â”‚     {                             â”‚                    â”‚
â”‚                    â”‚       type: "config",             â”‚                    â”‚
â”‚                    â”‚       action: "budget.category",  â”‚                    â”‚
â”‚                    â”‚       entities: {                 â”‚                    â”‚
â”‚                    â”‚         category: "é¤é¥®",         â”‚                    â”‚
â”‚                    â”‚         amount: 2000              â”‚                    â”‚
â”‚                    â”‚       },                          â”‚                    â”‚
â”‚                    â”‚       emotion: "neutral"          â”‚                    â”‚
â”‚                    â”‚     }                             â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”˜                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

| è€ƒé‡ | è¯´æ˜ |
|------|------|
| **å“åº”é€Ÿåº¦** | LLM èšç„¦ç†è§£ï¼ˆ~800msï¼‰ï¼Œæ‰§è¡Œå±‚æœ¬åœ°è°ƒç”¨ï¼ˆ~100msï¼‰ |
| **ä»£ç å¤ç”¨** | 136+ é…ç½®é¡¹çš„ä¿®æ”¹é€»è¾‘å·²å­˜åœ¨ï¼Œæ— éœ€é‡å†™ |
| **å¯ç»´æŠ¤æ€§** | ä¸šåŠ¡é€»è¾‘å˜åŒ–ä¸å½±å“ LLMï¼ŒLLM å‡çº§ä¸å½±å“ä¸šåŠ¡ |
| **å¯æµ‹è¯•æ€§** | æ„å›¾è¯†åˆ«å’Œæ‰§è¡Œå¯ç‹¬ç«‹æµ‹è¯• |
| **ç¦»çº¿é™çº§** | æ‰§è¡Œå±‚ä¸ä¾èµ– LLMï¼Œè§„åˆ™æ¨¡å¼ä¸‹åŒæ ·å¯ç”¨ |

### LLM è¾“å‡ºæ ¼å¼

```json
{
  "type": "chat|action|hybrid",
  "confidence": 0.95,
  "intent": {
    "category": "config|transaction|query|navigation",
    "action": "budget.category|account.default|...",
    "entities": {
      "category": "é¤é¥®",
      "amount": 2000,
      "accountName": "å¾®ä¿¡"
    }
  },
  "emotion": "neutral|happy|frustrated|anxious",
  "chat_response": "å¦‚æœæ˜¯èŠå¤©æˆ–æ··åˆç±»å‹ï¼Œè¿™é‡Œæ˜¯èŠå¤©å›å¤"
}
```

### æ„å›¾åˆ†ç±»å±‚æ¬¡ï¼ˆå…³é”®ï¼‰

åŒä¸€ä¸ªæ•°å­—åœ¨ä¸åŒè¯­å¢ƒä¸‹å«ä¹‰å®Œå…¨ä¸åŒï¼ŒLLM å¿…é¡»å‡†ç¡®åˆ†ç±»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ„å›¾åˆ†ç±»å±‚æ¬¡                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Level 1: å¤§ç±»                                                              â”‚
â”‚  â”œâ”€ transaction  (è®°è´¦)                                                     â”‚
â”‚  â”œâ”€ config       (é…ç½®)                                                     â”‚
â”‚  â”œâ”€ query        (æŸ¥è¯¢)                                                     â”‚
â”‚  â”œâ”€ navigation   (å¯¼èˆª)                                                     â”‚
â”‚  â””â”€ chat         (é—²èŠ)                                                     â”‚
â”‚                                                                             â”‚
â”‚  Level 2: å­ç±»                                                              â”‚
â”‚  â”œâ”€ transaction                                                             â”‚
â”‚  â”‚   â”œâ”€ expense    "åˆé¥­èŠ±äº†50"      â†’ TransactionService.addExpense        â”‚
â”‚  â”‚   â”œâ”€ income     "æ”¶åˆ°çº¢åŒ…50"      â†’ TransactionService.addIncome         â”‚
â”‚  â”‚   â”œâ”€ transfer   "è½¬è´¦ç»™è€å©†200"   â†’ TransactionService.addTransfer       â”‚
â”‚  â”‚   â”œâ”€ modify     "æ”¹æˆ60"          â†’ TransactionService.modify            â”‚
â”‚  â”‚   â””â”€ delete     "åˆ æ‰è¿™ç¬”"        â†’ TransactionService.delete            â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€ config                                                                  â”‚
â”‚  â”‚   â”œâ”€ budget.monthly    "æœ¬æœˆé¢„ç®—8000"    â†’ BudgetService.setMonthly      â”‚
â”‚  â”‚   â”œâ”€ budget.category   "é¤é¥®é¢„ç®—2000"    â†’ BudgetService.setCategory     â”‚
â”‚  â”‚   â”œâ”€ account.default   "é»˜è®¤è´¦æˆ·å¾®ä¿¡"    â†’ AccountService.setDefault     â”‚
â”‚  â”‚   â”œâ”€ reminder.daily    "8ç‚¹æé†’è®°è´¦"     â†’ ReminderService.setDaily      â”‚
â”‚  â”‚   â”œâ”€ theme.mode        "æ·±è‰²æ¨¡å¼"        â†’ ThemeService.setDarkMode      â”‚
â”‚  â”‚   â””â”€ ...               (136+ é…ç½®é¡¹)                                     â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€ query                                                                   â”‚
â”‚  â”‚   â”œâ”€ statistics   "è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘"  â†’ StatisticsService.query            â”‚
â”‚  â”‚   â”œâ”€ trend        "æ¶ˆè´¹è¶‹åŠ¿"        â†’ StatisticsService.getTrend         â”‚
â”‚  â”‚   â””â”€ budget       "é¢„ç®—è¿˜å‰©å¤šå°‘"    â†’ BudgetService.getRemaining         â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€ navigation                                                              â”‚
â”‚       â”œâ”€ page        "æ‰“å¼€ç»Ÿè®¡"        â†’ VoiceNavigationExecutor.goto       â”‚
â”‚       â””â”€ tab         "åˆ‡æ¢åˆ°è´¦æœ¬"      â†’ VoiceNavigationExecutor.switchTab  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒä¸€æ•°å­—çš„ä¸åŒè§£é‡Š

| ç”¨æˆ·è¯´çš„ | æ•°å­— | ä¸Šä¸‹æ–‡çº¿ç´¢ | æ„å›¾åˆ†ç±» | æ‰§è¡Œå±‚ |
|----------|------|------------|----------|--------|
| "åˆé¥­èŠ±äº†50" | 50 | "èŠ±äº†" | transaction.expense | TransactionService.addExpense(50) |
| "æ”¶åˆ°çº¢åŒ…50" | 50 | "æ”¶åˆ°" | transaction.income | TransactionService.addIncome(50) |
| "é¤é¥®é¢„ç®—æ”¹æˆ2000" | 2000 | "é¢„ç®—æ”¹æˆ" | config.budget.category | BudgetService.setCategoryBudget("é¤é¥®", 2000) |
| "æœ¬æœˆé¢„ç®—8000" | 8000 | "æœ¬æœˆé¢„ç®—" | config.budget.monthly | BudgetService.setMonthlyBudget(8000) |
| "8ç‚¹æé†’è®°è´¦" | 8 | "æé†’" | config.reminder.daily | ReminderService.setDailyReminder("20:00") |
| "è¿™ä¸ªæœˆèŠ±äº†å¤šå°‘" | - | "èŠ±äº†å¤šå°‘" | query.statistics | StatisticsService.query("æœ¬æœˆ") |

### LLM Prompt è®¾è®¡è¦ç‚¹

```
ä½ æ˜¯è®°è´¦åŠ©æ‰‹çš„æ„å›¾åˆ†ç±»å™¨ã€‚åˆ†æç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­æ„å›¾ç±»å‹ã€‚

ã€å…³é”®ã€‘åŒä¸€ä¸ªæ•°å­—åœ¨ä¸åŒè¯­å¢ƒä¸‹å«ä¹‰ä¸åŒï¼š
- "èŠ±äº†/ä¹°äº†/åƒäº†/ä»˜äº†" + é‡‘é¢ â†’ æ”¯å‡º (transaction.expense)
- "æ”¶åˆ°/èµšäº†/å…¥è´¦/å·¥èµ„" + é‡‘é¢ â†’ æ”¶å…¥ (transaction.income)
- "é¢„ç®—/é™é¢" + é‡‘é¢ â†’ é¢„ç®—é…ç½® (config.budget.*)
- "æé†’/é—¹é’Ÿ" + æ—¶é—´ â†’ æé†’é…ç½® (config.reminder.*)
- "æ”¹æˆ/è°ƒæ•´ä¸º" + é‡‘é¢ â†’ å¯èƒ½æ˜¯ä¿®æ”¹äº¤æ˜“æˆ–ä¿®æ”¹é…ç½®ï¼Œéœ€çœ‹ä¸Šä¸‹æ–‡

ç”¨æˆ·è¯´ï¼š{input}
ä¸Šä¸‹æ–‡ï¼š{context}

è¾“å‡º JSONï¼š
{
  "type": "action",
  "intent": {
    "category": "transaction|config|query|navigation",
    "action": "expense|income|budget.category|reminder.daily|...",
    "entities": {...}
  }
}
```

### æ‰§è¡Œå±‚è·¯ç”±

```dart
class ActionRouter {
  final Map<String, Function> _handlers = {
    // é…ç½®ç±» - è·¯ç”±åˆ°ç°æœ‰ Service
    'config.budget.monthly': (e) => budgetService.setMonthlyBudget(e['amount']),
    'config.budget.category': (e) => budgetService.setCategoryBudget(e['category'], e['amount']),
    'config.account.default': (e) => accountService.setDefault(e['accountName']),
    'config.theme.mode': (e) => themeService.setDarkMode(e['mode'] == 'dark'),
    'config.reminder.daily': (e) => reminderService.setDailyReminder(e['time']),
    // ... æ‰€æœ‰é…ç½®é¡¹æ˜ å°„åˆ°ç°æœ‰ Service

    // äº¤æ˜“ç±» - è·¯ç”±åˆ°ç°æœ‰ Service
    'transaction.add': (e) => transactionService.add(e),
    'transaction.query': (e) => transactionService.query(e),

    // å¯¼èˆªç±» - è·¯ç”±åˆ°ç°æœ‰ Executor
    'navigation.goto': (e) => voiceNavigationExecutor.navigateTo(e['page']),
  };

  Future<ActionResult> execute(IntentResult intent) async {
    final handler = _handlers[intent.action];
    if (handler == null) {
      return ActionResult.unsupported(intent.action);
    }
    return handler(intent.entities);
  }
}
```

---

## æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. ConversationalAgentï¼ˆå¯¹è¯å¼æ™ºèƒ½ä½“æ ¸å¿ƒï¼‰

**èŒè´£**ï¼šä½œä¸ºæ™ºèƒ½ä½“çš„æ€»æ§åˆ¶å™¨ï¼Œåè°ƒå„ç»„ä»¶å·¥ä½œ

```dart
class ConversationalAgent {
  final IntentRouter _router;
  final ChatEngine _chatEngine;
  final ActionExecutor _actionExecutor;
  final ContextManager _contextManager;
  final ResponseGenerator _responseGenerator;

  /// å¤„ç†ç”¨æˆ·è¾“å…¥
  Future<AgentResponse> process(UserInput input) async {
    // 1. æ›´æ–°ä¸Šä¸‹æ–‡
    _contextManager.addUserInput(input);

    // 2. è·¯ç”±åˆ†æ
    final routeResult = await _router.route(input, _contextManager.context);

    // 3. æ ¹æ®è·¯ç”±ç»“æœå¤„ç†
    AgentResponse response;
    switch (routeResult.type) {
      case RouteType.chat:
        response = await _chatEngine.respond(input, _contextManager.context);
        break;
      case RouteType.action:
        response = await _actionExecutor.execute(routeResult.action!);
        break;
      case RouteType.hybrid:
        // å…ˆæ‰§è¡Œè¡Œä¸ºï¼Œå†ç”Ÿæˆè‡ªç„¶è¯­è¨€å“åº”
        final actionResult = await _actionExecutor.execute(routeResult.action!);
        response = await _responseGenerator.generateActionResponse(
          actionResult,
          routeResult.chatContent,
        );
        break;
      case RouteType.unknown:
        response = await _handleUnknown(input);
        break;
    }

    // 4. æ›´æ–°ä¸Šä¸‹æ–‡
    _contextManager.addAgentResponse(response);

    return response;
  }
}
```

---

### 2. IntentRouterï¼ˆæ„å›¾è·¯ç”±å™¨ï¼‰

**èŒè´£**ï¼šåˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯èŠå¤©ã€åŠŸèƒ½è¯·æ±‚è¿˜æ˜¯æ··åˆç±»å‹

**è·¯ç”±ç­–ç•¥**ï¼š

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æ„å›¾åˆ†ç±»     â”‚  â—€â”€â”€ ä¸»è·¯å¾„ï¼ˆå‡†ç¡®ä½†æ…¢ï¼‰
â”‚  (classify)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ ç½®ä¿¡åº¦>0.8â”‚â”€â”€â–¶ ç›´æ¥è·¯ç”±
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚ å¦
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ è§„åˆ™å¿«é€Ÿåˆ¤æ–­â”‚  â—€â”€â”€ è¾…åŠ©è·¯å¾„ï¼ˆå¿«ä½†ç²—ç•¥ï¼‰
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ ç»¼åˆå†³ç­–   â”‚â”€â”€â–¶ è¾“å‡ºè·¯ç”±ç»“æœ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è·¯ç”±ç±»å‹**ï¼š

| ç±»å‹ | ç¤ºä¾‹ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| Chat | "ä»Šå¤©å¤©æ°”çœŸå¥½å•Š" | äº¤ç»™ChatEngine |
| Action | "è®°ä¸€ç¬”é¤é¥®50å…ƒ" | äº¤ç»™ActionExecutor |
| Hybrid | "å¸®æˆ‘è®°ä¸‹åˆšåƒçš„åˆé¥­ï¼Œ30å—" | å…ˆæ‰§è¡Œï¼Œå†ç”Ÿæˆè‡ªç„¶å“åº” |
| Unknown | "å—¯"ã€"å“¦" | è¯·æ±‚æ¾„æ¸…æˆ–é—²èŠåº”ç­” |

**LLM Prompt è®¾è®¡**ï¼š

```
ä½ æ˜¯ä¸€ä¸ªè®°è´¦åŠ©æ‰‹çš„æ„å›¾åˆ†ç±»å™¨ã€‚åˆ†æç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­å…¶æ„å›¾ç±»å‹ã€‚

è¾“å…¥ï¼š{user_input}
ä¸Šä¸‹æ–‡ï¼š{context_summary}

è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "type": "chat|action|hybrid|unknown",
  "confidence": 0.0-1.0,
  "action_type": "transaction|query|navigation|config|null",
  "chat_content": "å¦‚æœæœ‰èŠå¤©æˆåˆ†ï¼Œæå–èŠå¤©å†…å®¹",
  "action_entities": {...} // å¦‚æœæœ‰è¡Œä¸ºï¼Œæå–å®ä½“
}
```

---

### 3. ActionRegistryï¼ˆè¡Œä¸ºæ³¨å†Œè¡¨ï¼‰

**èŒè´£**ï¼šç®¡ç†æ‰€æœ‰å¯æ‰§è¡Œçš„è¡Œä¸ºï¼Œæä¾›ç»Ÿä¸€çš„è¡Œä¸ºå‘ç°å’Œæ‰§è¡Œæ¥å£

```dart
/// è¡Œä¸ºå®šä¹‰
abstract class Action {
  String get id;
  String get name;
  String get description;
  List<String> get triggerPatterns;
  List<ActionParam> get requiredParams;
  List<ActionParam> get optionalParams;

  Future<ActionResult> execute(Map<String, dynamic> params);
}

/// è¡Œä¸ºæ³¨å†Œè¡¨
class ActionRegistry {
  final Map<String, Action> _actions = {};

  void register(Action action) {
    _actions[action.id] = action;
  }

  Action? findByIntent(String intentType) {
    return _actions.values.firstWhereOrNull(
      (a) => a.triggerPatterns.any((p) => intentType.contains(p))
    );
  }

  List<Action> get allActions => _actions.values.toList();
}
```

**å†…ç½®è¡Œä¸º**ï¼š

| è¡Œä¸ºID | åç§° | è§¦å‘æ¨¡å¼ | å‚æ•° |
|--------|------|----------|------|
| `transaction.add` | æ·»åŠ è®°å½• | è®°ã€èŠ±ã€ä¹°ã€æ”¶å…¥ | amount, category, merchant |
| `transaction.query` | æŸ¥è¯¢è®°å½• | æŸ¥ã€çœ‹ã€å¤šå°‘ã€ç»Ÿè®¡ | timeRange, category |
| `transaction.modify` | ä¿®æ”¹è®°å½• | æ”¹ã€ä¿®æ”¹ã€æ›´æ–° | transactionId, newAmount |
| `transaction.delete` | åˆ é™¤è®°å½• | åˆ ã€åˆ é™¤ã€å–æ¶ˆ | transactionId |
| `navigation.goto` | é¡µé¢è·³è½¬ | æ‰“å¼€ã€å»ã€è·³è½¬ | targetPage |
| `query.statistics` | ç»Ÿè®¡æŸ¥è¯¢ | æœ¬æœˆã€è¿™å‘¨ã€è¶‹åŠ¿ | timeRange, dimension |
| `config.*` | é…ç½®æ“ä½œ | è®¾ç½®ã€è°ƒæ•´ã€æ”¹æˆã€å¼€å¯ã€å…³é—­ | è§ä¸‹æ–¹é…ç½®å…¨æ™¯å›¾ |

---

### è¯­éŸ³å¯é…ç½®é¡¹å…¨æ™¯å›¾

> ğŸ“„ **è®¾è®¡æ¥æº**: `docs/design/app_v2_design.md` ç¬¬ 18.3.1 èŠ‚

åŸºäº v2 ç‰ˆæœ¬è®¾è®¡ï¼Œæ”¯æŒ **13 å¤§ç±»ã€136+ é¡¹** è¯­éŸ³é…ç½®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯­éŸ³å¯é…ç½®é¡¹å…¨æ™¯å›¾                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ä¸€ã€é¢„ç®—ä¸è´¢åŠ¡        äºŒã€è´¦æˆ·ä¸èµ„äº§        ä¸‰ã€è´¦æœ¬ä¸æˆå‘˜                   â”‚
â”‚  â€¢ æœˆåº¦é¢„ç®—è®¾ç½®        â€¢ ç°é‡‘/é“¶è¡Œå¡è´¦æˆ·     â€¢ åˆ›å»º/åˆ‡æ¢è´¦æœ¬                 â”‚
â”‚  â€¢ åˆ†ç±»é¢„ç®—è®¾ç½®        â€¢ ä¿¡ç”¨å¡ç®¡ç†          â€¢ é‚€è¯·/ç§»é™¤æˆå‘˜                 â”‚
â”‚  â€¢ é¢„ç®—é¢„è­¦é˜ˆå€¼        â€¢ é»˜è®¤è´¦æˆ·è®¾ç½®        â€¢ æƒé™é…ç½®                     â”‚
â”‚                                                                             â”‚
â”‚  å››ã€åˆ†ç±»ä¸æ ‡ç­¾        äº”ã€ç›®æ ‡ä¸å€ºåŠ¡        å…­ã€æé†’ä¸é€šçŸ¥                   â”‚
â”‚  â€¢ æ·»åŠ /åˆ é™¤åˆ†ç±»       â€¢ å‚¨è“„ç›®æ ‡            â€¢ è®°è´¦æé†’                     â”‚
â”‚  â€¢ å­åˆ†ç±»ç®¡ç†          â€¢ å¼€æ”¯ç›®æ ‡            â€¢ é¢„ç®—æé†’                     â”‚
â”‚  â€¢ æ ‡ç­¾ç®¡ç†            â€¢ å€ºåŠ¡ç®¡ç†            â€¢ è´¦å•æé†’                     â”‚
â”‚                                                                             â”‚
â”‚  ä¸ƒã€æ¨¡æ¿ä¸å®šæ—¶        å…«ã€å¤–è§‚ä¸æ˜¾ç¤º        ä¹ã€å›½é™…åŒ–                      â”‚
â”‚  â€¢ è®°è´¦æ¨¡æ¿            â€¢ ä¸»é¢˜è®¾ç½®            â€¢ è¯­è¨€è®¾ç½®                     â”‚
â”‚  â€¢ å®šæ—¶è®°è´¦            â€¢ é¦–é¡µå¸ƒå±€            â€¢ è´§å¸è®¾ç½®                     â”‚
â”‚  â€¢ å¿«æ·å…¥å£            â€¢ æ˜¾ç¤ºåå¥½            â€¢ æ ¼å¼è®¾ç½®                     â”‚
â”‚                                                                             â”‚
â”‚  åã€AIä¸æ™ºèƒ½          åä¸€ã€æ•°æ®ä¸åŒæ­¥      åäºŒã€å®‰å…¨ä¸éšç§                 â”‚
â”‚  â€¢ AIè¯†åˆ«è®¾ç½®          â€¢ è‡ªåŠ¨åŒæ­¥            â€¢ åº”ç”¨é”                       â”‚
â”‚  â€¢ è¯­éŸ³è®¾ç½®            â€¢ å¤‡ä»½è®¾ç½®            â€¢ éšç§æ¨¡å¼                     â”‚
â”‚  â€¢ æ™ºèƒ½åŠŸèƒ½å¼€å…³        â€¢ å­˜å‚¨ç®¡ç†            â€¢ è´¦æˆ·å®‰å…¨                     â”‚
â”‚                                                                             â”‚
â”‚  åä¸‰ã€ç½‘ç»œä¸æ€§èƒ½                                                            â”‚
â”‚  â€¢ è¶…æ—¶è®¾ç½®ã€é‡è¯•æ¬¡æ•°ã€åŠ¨ç”»å¼€å…³ã€æ›´æ–°è®¾ç½®                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®è¡Œä¸ºæ³¨å†Œç¤ºä¾‹**ï¼š

```dart
/// é…ç½®è¡Œä¸ºåŸºç±»
abstract class ConfigAction extends Action {
  final String configPath;  // é…ç½®è·¯å¾„ï¼Œå¦‚ "budget.category.é¤é¥®"
  final bool requiresConfirmation;  // æ˜¯å¦éœ€è¦ç¡®è®¤

  @override
  Future<ActionResult> execute(Map<String, dynamic> params) async {
    if (requiresConfirmation) {
      return ActionResult.needsConfirmation(
        message: generateConfirmMessage(params),
        onConfirm: () => _doExecute(params),
      );
    }
    return _doExecute(params);
  }
}

/// é¢„ç®—é…ç½®è¡Œä¸º
class BudgetConfigActions {
  static void registerAll(ActionRegistry registry) {
    // æœˆåº¦é¢„ç®—
    registry.register(ConfigAction(
      id: 'config.budget.monthly',
      triggerPatterns: ['æœˆåº¦é¢„ç®—', 'æ€»é¢„ç®—', 'æœ¬æœˆé¢„ç®—'],
      requiredParams: ['amount'],
      executor: (p) => budgetService.setMonthlyBudget(p['amount']),
    ));

    // åˆ†ç±»é¢„ç®—
    registry.register(ConfigAction(
      id: 'config.budget.category',
      triggerPatterns: ['é¢„ç®—', 'é™é¢'],
      requiredParams: ['category', 'amount'],
      executor: (p) => budgetService.setCategoryBudget(p['category'], p['amount']),
    ));

    // é¢„ç®—é¢„è­¦
    registry.register(ConfigAction(
      id: 'config.budget.threshold',
      triggerPatterns: ['é¢„è­¦', 'æé†’é˜ˆå€¼'],
      requiredParams: ['percentage'],
      executor: (p) => budgetService.setWarningThreshold(p['percentage']),
    ));
  }
}

/// è´¦æˆ·é…ç½®è¡Œä¸º
class AccountConfigActions {
  static void registerAll(ActionRegistry registry) {
    // é»˜è®¤è´¦æˆ·
    registry.register(ConfigAction(
      id: 'config.account.default',
      triggerPatterns: ['é»˜è®¤è´¦æˆ·', 'è®¾ä¸ºé»˜è®¤'],
      requiredParams: ['accountName'],
      executor: (p) => accountService.setDefault(p['accountName']),
    ));

    // ä¿¡ç”¨å¡è´¦å•æ—¥
    registry.register(ConfigAction(
      id: 'config.account.billDay',
      triggerPatterns: ['è´¦å•æ—¥'],
      requiredParams: ['day'],
      executor: (p) => accountService.setBillDay(p['day']),
    ));
  }
}

// ... å…¶ä»– 11 ç±»é…ç½®è¡Œä¸ºæ³¨å†Œ
```

**è¯­éŸ³é…ç½®ç¤ºä¾‹**ï¼š

| ç”¨æˆ·è¯´çš„ | æ„å›¾è¯†åˆ« | æ‰§è¡Œç»“æœ |
|----------|----------|----------|
| "æŠŠé¤é¥®é¢„ç®—æ”¹æˆ2000" | `config.budget.category` | "å°†é¤é¥®é¢„ç®—ä»1500æ”¹ä¸º2000ï¼Œç¡®è®¤å—ï¼Ÿ" |
| "æŠŠå¾®ä¿¡è®¾ä¸ºé»˜è®¤è´¦æˆ·" | `config.account.default` | "å·²å°†å¾®ä¿¡è®¾ä¸ºé»˜è®¤è´¦æˆ·" |
| "æ¯å¤©æ™šä¸Š8ç‚¹æé†’æˆ‘è®°è´¦" | `config.reminder.daily` | "å·²è®¾ç½®æ¯æ—¥è®°è´¦æé†’ï¼Œæ—¶é—´ï¼š20:00" |
| "åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼" | `config.theme.mode` | "å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼" |
| "å¼€å¯æŒ‡çº¹è§£é”" | `config.security.fingerprint` | "å·²å¼€å¯æŒ‡çº¹è§£é”" |
| "å…³é—­æ™ºèƒ½åˆ†ç±»" | `config.ai.smartCategory` | "å·²å…³é—­æ™ºèƒ½åˆ†ç±»åŠŸèƒ½" |

**é…ç½®è¡Œä¸ºåˆ†ç±»**ï¼š

| ç±»åˆ« | è¡Œä¸ºæ•°é‡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|----------|--------|------|
| é¢„ç®—ä¸è´¢åŠ¡ | ~15 | P0 | é«˜é¢‘ä½¿ç”¨ |
| è´¦æˆ·ä¸èµ„äº§ | ~18 | P0 | é«˜é¢‘ä½¿ç”¨ |
| åˆ†ç±»ä¸æ ‡ç­¾ | ~12 | P1 | ä¸­é¢‘ä½¿ç”¨ |
| æé†’ä¸é€šçŸ¥ | ~15 | P1 | ä¸­é¢‘ä½¿ç”¨ |
| è´¦æœ¬ä¸æˆå‘˜ | ~12 | P1 | å…±äº«è´¦æœ¬åœºæ™¯ |
| ç›®æ ‡ä¸å€ºåŠ¡ | ~12 | P2 | è¿›é˜¶åŠŸèƒ½ |
| æ¨¡æ¿ä¸å®šæ—¶ | ~10 | P2 | è¿›é˜¶åŠŸèƒ½ |
| å¤–è§‚ä¸æ˜¾ç¤º | ~15 | P2 | ä¸ªæ€§åŒ– |
| å›½é™…åŒ– | ~12 | P2 | å¤šè¯­è¨€ç”¨æˆ· |
| AIä¸æ™ºèƒ½ | ~12 | P1 | AIåŠŸèƒ½æ§åˆ¶ |
| æ•°æ®ä¸åŒæ­¥ | ~12 | P2 | æ•°æ®ç®¡ç† |
| å®‰å…¨ä¸éšç§ | ~12 | P1 | å®‰å…¨ç›¸å…³ |
| ç½‘ç»œä¸æ€§èƒ½ | ~8 | P3 | é«˜çº§è®¾ç½® |

---

### 4. ChatEngineï¼ˆèŠå¤©å¼•æ“ï¼‰

**èŒè´£**ï¼šå¤„ç†çº¯èŠå¤©å¯¹è¯ï¼Œæä¾›è‡ªç„¶ã€æœ‰äººæ ¼çš„å“åº”

**äººæ ¼å®šä¹‰**ï¼š

```yaml
persona:
  name: å°è®°
  role: æ™ºèƒ½è®°è´¦åŠ©æ‰‹
  traits:
    - å‹å¥½çƒ­æƒ…
    - ä¸“ä¸šå¯é 
    - é€‚åº¦å¹½é»˜
    - å…³å¿ƒç”¨æˆ·è´¢åŠ¡å¥åº·
  speech_style:
    greeting: ä½¿ç”¨æ—¶æ®µé—®å€™ï¼ˆæ—©/åˆ/æ™šå¥½ï¼‰
    confirmation: ç®€æ´è‚¯å®šï¼ˆå¥½çš„ã€æ²¡é—®é¢˜ã€æ”¶åˆ°ï¼‰
    suggestion: å§”å©‰æè®®ï¼ˆè¦ä¸è¦...ã€å»ºè®®...ï¼‰
    error: æ­‰æ„ + è§£å†³æ–¹æ¡ˆ
```

**èŠå¤©ç­–ç•¥**ï¼š

```dart
class ChatEngine {
  final PersonaConfig _persona;
  final QwenService _llm;

  Future<AgentResponse> respond(
    UserInput input,
    ConversationContext context,
  ) async {
    // æ„å»ºprompt
    final prompt = '''
ä½ æ˜¯"${_persona.name}"ï¼Œä¸€ä¸ª${_persona.role}ã€‚
æ€§æ ¼ç‰¹ç‚¹ï¼š${_persona.traits.join('ã€')}

å¯¹è¯å†å²ï¼š
${context.recentHistory}

ç”¨æˆ·è¯´ï¼š${input.text}

è¯·ä»¥"${_persona.name}"çš„èº«ä»½è‡ªç„¶å›åº”ã€‚
æ³¨æ„ï¼š
1. å›å¤ç®€çŸ­è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©
2. å¦‚æœè¯é¢˜æ¶‰åŠè®°è´¦ï¼Œå¯ä»¥é€‚æ—¶å¼•å¯¼
3. ä¿æŒä¸€è‡´çš„äººæ ¼ç‰¹ç‚¹
''';

    final response = await _llm.chat(prompt);
    return AgentResponse(
      text: response,
      type: ResponseType.chat,
      shouldSpeak: true,
    );
  }
}
```

---

### 5. ContextManagerï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼šç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒæŒ‡ä»£æ¶ˆè§£å’Œæ—¶é—´å¼•ç”¨

**å¢å¼ºç°æœ‰ ConversationContext**ï¼š

```dart
class ContextManager {
  final ConversationContext _context;

  /// æœ€è¿‘çš„äº¤æ˜“å¼•ç”¨ï¼ˆç”¨äºæŒ‡ä»£æ¶ˆè§£ï¼‰
  TransactionReference? _lastTransaction;

  /// æœ€è¿‘çš„æŸ¥è¯¢èŒƒå›´
  QueryScope? _lastQueryScope;

  /// æ¶ˆè§£æŒ‡ä»£è¯
  ResolvedReference? resolveReference(String text) {
    // "å®ƒ"ã€"è¿™ç¬”"ã€"é‚£ä¸ª" -> æœ€è¿‘çš„äº¤æ˜“
    if (_containsTransactionRef(text)) {
      return ResolvedReference(
        type: ReferenceType.transaction,
        value: _lastTransaction,
      );
    }

    // "åˆšæ‰"ã€"ä¸Šä¸€ä¸ª"ã€"æ˜¨å¤©é‚£ç¬”"
    if (_containsTimeRef(text)) {
      return _resolveTimeReference(text);
    }

    return null;
  }

  /// è·å–ä¸Šä¸‹æ–‡æ‘˜è¦ï¼ˆä¾›LLMä½¿ç”¨ï¼‰
  String getSummary() {
    return '''
æœ€è¿‘å¯¹è¯ï¼š${_context.recentHistory.take(3).join('\n')}
æœ€è¿‘äº¤æ˜“ï¼š${_lastTransaction?.description ?? 'æ— '}
å½“å‰é¡µé¢ï¼š${_currentPage}
''';
  }
}
```

**æŒ‡ä»£æ¶ˆè§£ç¤ºä¾‹**ï¼š

| ç”¨æˆ·è¯´çš„ | æ¶ˆè§£ä¸º |
|----------|--------|
| "æŠŠå®ƒæ”¹æˆ60" | æœ€è¿‘æ·»åŠ /æåˆ°çš„äº¤æ˜“ |
| "åˆ æ‰è¿™ç¬”" | æœ€è¿‘æ·»åŠ /æåˆ°çš„äº¤æ˜“ |
| "æ˜¨å¤©é‚£ç¬”åˆé¥­" | æŸ¥è¯¢æ˜¨å¤©+åˆé¥­å…³é”®è¯ |
| "ä¸Šä¸ªæœˆèŠ±äº†å¤šå°‘" | æ—¶é—´èŒƒå›´=ä¸Šæœˆ |

---

### 6. ResponseGeneratorï¼ˆå“åº”ç”Ÿæˆå™¨ï¼‰

**èŒè´£**ï¼šç”Ÿæˆç»Ÿä¸€é£æ ¼çš„è‡ªç„¶è¯­è¨€å“åº”

**å“åº”æ¨¡æ¿ + LLMå¢å¼º**ï¼š

```dart
class ResponseGenerator {
  /// è¡Œä¸ºæ‰§è¡Œå“åº”
  Future<AgentResponse> generateActionResponse(
    ActionResult result,
    String? chatContent,
  ) async {
    String response;

    if (result.success) {
      // åŸºç¡€æ¨¡æ¿
      final template = _getSuccessTemplate(result.actionType);

      // LLMæ¶¦è‰²ï¼ˆå¯é€‰ï¼‰
      if (chatContent != null) {
        response = await _llmEnhance(template, chatContent);
      } else {
        response = _fillTemplate(template, result.data);
      }
    } else {
      response = _getErrorResponse(result.error);
    }

    return AgentResponse(
      text: response,
      type: ResponseType.action,
      data: result.data,
      shouldSpeak: true,
    );
  }

  /// æˆåŠŸå“åº”æ¨¡æ¿
  String _getSuccessTemplate(String actionType) {
    switch (actionType) {
      case 'transaction.add':
        return 'å¥½çš„ï¼Œå·²è®°å½•{category}{amount}å…ƒ';
      case 'transaction.query':
        return '{timeRange}å…±{totalAmount}å…ƒï¼Œ{itemCount}ç¬”è®°å½•';
      case 'navigation.goto':
        return 'å¥½çš„ï¼Œæ­£åœ¨æ‰“å¼€{pageName}';
      default:
        return 'å·²å®Œæˆ';
    }
  }
}
```

---

## è§„åˆ™å…œåº•æœºåˆ¶

### è®¾è®¡åŸåˆ™

**LLMä¼˜å…ˆï¼Œè§„åˆ™å…œåº•**ï¼šåœ¨ç½‘ç»œè‰¯å¥½ä¸”LLMå¯ç”¨æ—¶ä½¿ç”¨LLMè¿›è¡Œæ„å›¾è¯†åˆ«å’Œå“åº”ç”Ÿæˆï¼›å½“ç½‘ç»œä¸ä½³æˆ–LLMå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ°è§„åˆ™å¼•æ“ã€‚

### é™çº§è§¦å‘æ¡ä»¶

| æ¡ä»¶ | æ£€æµ‹æ–¹å¼ | é™çº§è¡Œä¸º |
|------|----------|----------|
| ç½‘ç»œç¦»çº¿ | **æå‰æ£€æµ‹**ï¼ˆå¯åŠ¨æ—¶+æŒ‰é’®æŒ‰ä¸‹æ—¶ï¼‰ | å®Œå…¨ä½¿ç”¨è§„åˆ™å¼•æ“ |
| ç½‘ç»œæ…¢ï¼ˆ>3ç§’ï¼‰ | **æå‰æ£€æµ‹** + å†å²å»¶è¿Ÿç»Ÿè®¡ | åˆ‡æ¢åˆ°è§„åˆ™å¼•æ“ |
| LLMæœåŠ¡å¼‚å¸¸ | HTTPé”™è¯¯/è§£æå¤±è´¥ | é‡è¯•1æ¬¡åé™çº§ |
| LLMç½®ä¿¡åº¦ä½ | confidence < 0.7 | ä½¿ç”¨è§„åˆ™éªŒè¯/è¦†ç›– |
| APIé™æµ(429) | å“åº”çŠ¶æ€ç  | æŒ‡æ•°é€€é¿+è§„åˆ™å…œåº• |

### ç½‘ç»œçŠ¶æ€æå‰æ£€æµ‹ï¼ˆå…³é”®ä¼˜åŒ–ï¼‰

**è®¾è®¡åŸåˆ™**ï¼šå°½å¯èƒ½æå‰æ£€æµ‹ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ProactiveNetworkMonitor                              â”‚
â”‚                     (ä¸»åŠ¨ç½‘ç»œç›‘æ§å™¨)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  æ£€æµ‹æ—¶æœº                          æ£€æµ‹å†…å®¹                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚                                                                          â”‚
â”‚  1. Appå¯åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ å®Œæ•´æ£€æµ‹ï¼ˆè¿é€šæ€§+å»¶è¿Ÿ+LLMå¯ç”¨æ€§ï¼‰    â”‚
â”‚     â””â”€â”€ åå°å®šæ—¶åˆ·æ–°ï¼ˆæ¯60ç§’ï¼‰                                           â”‚
â”‚                                                                          â”‚
â”‚  2. è¯­éŸ³æŒ‰é’®æŒ‰ä¸‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ å¿«é€Ÿæ£€æµ‹ï¼ˆä½¿ç”¨ç¼“å­˜+å¢é‡éªŒè¯ï¼‰        â”‚
â”‚     â””â”€â”€ åŒæ—¶é¢„çƒ­LLMè¿æ¥                                                  â”‚
â”‚                                                                          â”‚
â”‚  3. ç½‘ç»œçŠ¶æ€å˜åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ç«‹å³æ›´æ–°ç¼“å­˜çŠ¶æ€                     â”‚
â”‚     â””â”€â”€ ç›‘å¬ç³»ç»Ÿç½‘ç»œäº‹ä»¶                                                 â”‚
â”‚                                                                          â”‚
â”‚  4. è¯­éŸ³è¯†åˆ«å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ç›´æ¥ä½¿ç”¨ç¼“å­˜çŠ¶æ€ï¼ˆä¸å†æ£€æµ‹ï¼‰         â”‚
â”‚     â””â”€â”€ é›¶å»¶è¿Ÿè·¯ç”±å†³ç­–                                                   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **ï¼š

```dart
class ProactiveNetworkMonitor {
  /// ç¼“å­˜çš„ç½‘ç»œçŠ¶æ€
  NetworkStatus _cachedStatus = NetworkStatus.unknown;

  /// æœ€åæ£€æµ‹æ—¶é—´
  DateTime? _lastCheckTime;

  /// å†å²å»¶è¿Ÿè®°å½•ï¼ˆç”¨äºé¢„æµ‹ï¼‰
  final List<int> _latencyHistory = [];

  /// ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  static const int _cacheValiditySeconds = 30;

  /// å»¶è¿Ÿé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
  static const int _latencyThresholdMs = 2000;

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// æ£€æµ‹æ—¶æœº1: Appå¯åŠ¨æ—¶å®Œæ•´æ£€æµ‹
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<void> initializeOnAppStart() async {
    // 1. åŸºç¡€è¿é€šæ€§æ£€æµ‹
    final isOnline = await _checkConnectivity();

    // 2. LLMæœåŠ¡å¯ç”¨æ€§æ£€æµ‹ï¼ˆè½»é‡çº§pingï¼‰
    final llmAvailable = isOnline ? await _pingLLMService() : false;

    // 3. å»¶è¿Ÿæµ‹é‡
    final latency = isOnline ? await _measureLatency() : 0;
    _latencyHistory.add(latency);

    // 4. æ›´æ–°ç¼“å­˜çŠ¶æ€
    _cachedStatus = NetworkStatus(
      isOnline: isOnline,
      llmAvailable: llmAvailable,
      estimatedLatency: latency,
      recommendedMode: _determineMode(isOnline, llmAvailable, latency),
    );
    _lastCheckTime = DateTime.now();

    // 5. å¯åŠ¨åå°å®šæ—¶åˆ·æ–°
    _startPeriodicRefresh();

    // 6. ç›‘å¬ç³»ç»Ÿç½‘ç»œå˜åŒ–
    _listenToNetworkChanges();
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// æ£€æµ‹æ—¶æœº2: è¯­éŸ³æŒ‰é’®æŒ‰ä¸‹æ—¶å¿«é€Ÿæ£€æµ‹
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Future<NetworkStatus> checkOnVoiceButtonPressed() async {
    // å¦‚æœç¼“å­˜ä»ç„¶æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
    if (_isCacheValid()) {
      // åŒæ—¶åœ¨åå°é¢„çƒ­LLMè¿æ¥ï¼ˆä¸é˜»å¡ï¼‰
      unawaited(_preheatLLMConnection());
      return _cachedStatus;
    }

    // ç¼“å­˜è¿‡æœŸï¼Œå¿«é€Ÿå¢é‡æ£€æµ‹
    final isOnline = await _checkConnectivity();
    if (isOnline != _cachedStatus.isOnline) {
      // ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°ç¼“å­˜
      await _quickRefresh();
    }

    // é¢„çƒ­LLMè¿æ¥
    unawaited(_preheatLLMConnection());

    return _cachedStatus;
  }

  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// æ£€æµ‹æ—¶æœº3: è¯­éŸ³è¯†åˆ«å®Œæˆæ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜
  /// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  NetworkStatus getStatusForRouting() {
    // ç›´æ¥è¿”å›ç¼“å­˜çŠ¶æ€ï¼Œé›¶å»¶è¿Ÿ
    return _cachedStatus;
  }

  /// é¢„çƒ­LLMè¿æ¥ï¼ˆå‡å°‘é¦–æ¬¡è¯·æ±‚å»¶è¿Ÿï¼‰
  Future<void> _preheatLLMConnection() async {
    if (_cachedStatus.llmAvailable) {
      // å‘é€ä¸€ä¸ªè½»é‡çº§è¯·æ±‚ï¼Œå»ºç«‹TCPè¿æ¥
      await _llmService.warmup();
    }
  }

  /// åˆ¤æ–­æ¨èæ¨¡å¼
  RoutingMode _determineMode(bool isOnline, bool llmAvailable, int latency) {
    if (!isOnline) return RoutingMode.ruleOnly;
    if (!llmAvailable) return RoutingMode.ruleOnly;
    if (latency > _latencyThresholdMs) return RoutingMode.rulePreferred;
    return RoutingMode.llmPreferred;
  }
}
```

**æ£€æµ‹æ—¶æœºå¯¹æ¯”**ï¼š

| æ—¶æœº | æ£€æµ‹å†…å®¹ | è€—æ—¶ | é˜»å¡ç”¨æˆ· |
|------|----------|------|----------|
| Appå¯åŠ¨ | å®Œæ•´æ£€æµ‹ï¼ˆè¿é€šæ€§+LLM+å»¶è¿Ÿï¼‰ | ~500ms | å¦ï¼ˆåå°ï¼‰ |
| è¯­éŸ³æŒ‰é’®æŒ‰ä¸‹ | ç¼“å­˜éªŒè¯ + é¢„çƒ­è¿æ¥ | <10ms | å¦ |
| ç½‘ç»œçŠ¶æ€å˜åŒ– | æ›´æ–°ç¼“å­˜ | <100ms | å¦ï¼ˆç›‘å¬å™¨ï¼‰ |
| è¯­éŸ³è¯†åˆ«å®Œæˆ | ç›´æ¥è¯»ç¼“å­˜ | 0ms | å¦ |

**é¢„çƒ­ä¼˜åŒ–**ï¼š

```dart
/// è¯­éŸ³æŒ‰é’®æŒ‰ä¸‹æ—¶çš„é¢„çƒ­æµç¨‹
Future<void> onVoiceButtonPressed() async {
  // å¹¶è¡Œæ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
  await Future.wait([
    // 1. ç½‘ç»œçŠ¶æ€å¿«é€Ÿæ£€æµ‹
    _networkMonitor.checkOnVoiceButtonPressed(),

    // 2. ASRè¿æ¥é¢„çƒ­
    _asrService.warmupConnection(),

    // 3. LLMè¿æ¥é¢„çƒ­ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (_networkMonitor.cachedStatus.llmAvailable)
      _llmService.warmupConnection(),

    // 4. TTSå¼•æ“é¢„åŠ è½½
    _ttsService.preloadEngine(),
  ]);
}
```

### æ¶æ„è®¾è®¡

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HybridIntentRouter                        â”‚
â”‚                    (æ··åˆæ„å›¾è·¯ç”±å™¨)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ç½‘ç»œçŠ¶æ€æ£€æµ‹ â”‚â”€â”€â”€â”€â–¶â”‚ LLMå¯ç”¨æ£€æµ‹  â”‚â”€â”€â”€â”€â–¶â”‚  è·¯ç”±å†³ç­–   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                   â”‚         â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”   â”‚
â”‚                    â”‚                              â”‚     â”‚   â”‚
â”‚                    â–¼                              â–¼     â”‚   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚      LLMè·¯å¾„           â”‚    â”‚     è§„åˆ™è·¯å¾„        â”‚ â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚ IntentClassifierâ”‚    â”‚    â”‚  â”‚ RuleRouter   â”‚  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚ (LLMæ„å›¾åˆ†ç±»)   â”‚    â”‚    â”‚  â”‚ (è§„åˆ™è·¯ç”±)   â”‚  â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚   â”‚           â”‚            â”‚    â”‚         â”‚          â”‚ â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚ ChatEngine     â”‚    â”‚    â”‚  â”‚ RuleResponderâ”‚  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚ (LLMèŠå¤©å¼•æ“)  â”‚    â”‚    â”‚  â”‚ (æ¨¡æ¿å“åº”)   â”‚  â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                    â”‚                      â”‚            â”‚   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚                               â–¼                        â”‚   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚                    â”‚  ç»“æœèåˆ/é€‰æ‹©   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                         æœ€ç»ˆå“åº”
```

### è§„åˆ™å¼•æ“å¤ç”¨

å¤ç”¨ç°æœ‰ `SmartIntentRecognizer` å’Œ `VoiceIntentRouter` çš„è§„åˆ™èƒ½åŠ›ï¼š

```dart
class HybridIntentRouter {
  final LLMIntentClassifier _llmClassifier;
  final SmartIntentRecognizer _ruleRecognizer;  // å¤ç”¨ç°æœ‰è§„åˆ™å¼•æ“
  final NetworkMonitor _networkMonitor;

  /// LLMè¶…æ—¶æ—¶é—´
  static const Duration _llmTimeout = Duration(seconds: 3);

  Future<RouteResult> route(String input, ConversationContext context) async {
    // 1. æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨LLM
    if (!_shouldUseLLM()) {
      return _routeWithRules(input, context);
    }

    // 2. å°è¯•LLMè·¯ç”±ï¼ˆå¸¦è¶…æ—¶ï¼‰
    try {
      final llmResult = await _llmClassifier
          .classify(input, context)
          .timeout(_llmTimeout);

      // 3. ç½®ä¿¡åº¦æ£€æŸ¥
      if (llmResult.confidence >= 0.7) {
        return llmResult;
      }

      // 4. ä½ç½®ä¿¡åº¦æ—¶ç”¨è§„åˆ™éªŒè¯
      final ruleResult = await _ruleRecognizer.recognize(input);
      return _mergeResults(llmResult, ruleResult);

    } catch (e) {
      // 5. LLMå¤±è´¥ï¼Œé™çº§åˆ°è§„åˆ™
      debugPrint('[HybridRouter] LLMå¤±è´¥ï¼Œé™çº§åˆ°è§„åˆ™: $e');
      return _routeWithRules(input, context);
    }
  }

  bool _shouldUseLLM() {
    return _networkMonitor.isOnline &&
           _llmClassifier.isAvailable &&
           !_llmClassifier.isRateLimited;
  }

  Future<RouteResult> _routeWithRules(String input, ConversationContext context) async {
    final result = await _ruleRecognizer.recognize(input);
    return RouteResult.fromRuleResult(result);
  }
}
```

### å“åº”ç”Ÿæˆé™çº§

| åœºæ™¯ | LLMæ¨¡å¼ | è§„åˆ™æ¨¡å¼ |
|------|---------|----------|
| è®°è´¦æˆåŠŸ | "å¥½çš„å‘€ï¼Œå·²ç»å¸®ä½ è®°ä¸‹åˆé¥­30å—å•¦~" | "å·²è®°å½•ï¼šé¤é¥® 30å…ƒ" |
| æŸ¥è¯¢ç»“æœ | "è¿™ä¸ªæœˆä½ ä¸€å…±èŠ±äº†1234å…ƒï¼Œä¸»è¦æ˜¯é¤é¥®å’Œäº¤é€š" | "æœ¬æœˆæ”¯å‡ºï¼š1234å…ƒï¼Œå…±15ç¬”" |
| æœªè¯†åˆ« | "æŠ±æ­‰æ²¡å¤ªæ˜ç™½ï¼Œä½ æ˜¯æƒ³è®°è´¦è¿˜æ˜¯æŸ¥è¯¢å‘¢ï¼Ÿ" | "è¯·è¯´å‡ºè¦è®°å½•çš„é‡‘é¢å’Œç±»åˆ«" |
| é—²èŠ | è‡ªç„¶è¯­è¨€å¯¹è¯ | "æˆ‘æ˜¯è®°è´¦åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ è®°è´¦å’ŒæŸ¥è¯¢" |

### è§„åˆ™å¼•æ“èƒ½åŠ›

è§„åˆ™å¼•æ“ï¼ˆé™çº§æ¨¡å¼ï¼‰æ”¯æŒçš„åŠŸèƒ½ï¼š

| åŠŸèƒ½ | è§¦å‘è¯/æ¨¡å¼ | æ”¯æŒç¨‹åº¦ |
|------|-------------|----------|
| æ·»åŠ æ”¯å‡º | èŠ±ã€ä¹°ã€åƒã€ä»˜ã€æ¶ˆè´¹ + é‡‘é¢ | âœ“ å®Œæ•´æ”¯æŒ |
| æ·»åŠ æ”¶å…¥ | æ”¶ã€èµšã€å…¥è´¦ã€å·¥èµ„ã€æ¡åˆ° + é‡‘é¢ | âœ“ å®Œæ•´æ”¯æŒ |
| æŸ¥è¯¢ç»Ÿè®¡ | è¿™ä¸ªæœˆ/ä»Šå¤©/æœ¬å‘¨ + èŠ±äº†å¤šå°‘ | âœ“ å®Œæ•´æ”¯æŒ |
| é¡µé¢å¯¼èˆª | æ‰“å¼€/å»/è·³è½¬ + é¡µé¢å | âœ“ å®Œæ•´æ”¯æŒ |
| ä¿®æ”¹è®°å½• | æ”¹/ä¿®æ”¹ + æŒ‡ä»£è¯ + é‡‘é¢ | â–³ åŸºç¡€æ”¯æŒ |
| åˆ é™¤è®°å½• | åˆ /åˆ é™¤ + æŒ‡ä»£è¯ | â–³ åŸºç¡€æ”¯æŒ |
| è‡ªç„¶é—²èŠ | ä½ å¥½/æ—©ä¸Šå¥½/è°¢è°¢ | â–³ é¢„è®¾å›å¤ |
| å¤æ‚å¯¹è¯ | å¤šè½®ä¸Šä¸‹æ–‡ã€å¤æ‚æŒ‡ä»£ | âœ— ä¸æ”¯æŒ |

### ç”¨æˆ·ä½“éªŒä¿éšœ

1. **æ— æ„Ÿé™çº§**ï¼šç”¨æˆ·ä¸ä¼šå¯Ÿè§‰åˆ°LLMå’Œè§„åˆ™çš„åˆ‡æ¢
2. **åŠŸèƒ½ä¿éšœ**ï¼šæ ¸å¿ƒè®°è´¦åŠŸèƒ½åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ç”¨
3. **æç¤ºä¼˜åŒ–**ï¼šè§„åˆ™æ¨¡å¼ä¸‹ä½¿ç”¨æ›´ç®€æ´çš„æç¤ºè¯­
4. **çŠ¶æ€æ˜¾ç¤º**ï¼šå¯é€‰æ˜¾ç¤ºå½“å‰æ¨¡å¼ï¼ˆè°ƒè¯•ç”¨ï¼‰

---

## å†³ç­–è®°å½•

### å†³ç­–1ï¼šLLMä¼˜å…ˆ vs è§„åˆ™ä¼˜å…ˆ

**é€‰æ‹©**ï¼šLLMä¼˜å…ˆï¼Œè§„åˆ™å…œåº•

**ç†ç”±**ï¼š
- LLMèƒ½ç†è§£è‡ªç„¶è¯­è¨€å˜ä½“ï¼ˆ"å¸®æˆ‘è®°ä¸‹"ã€"è®°ä¸€ç¬”"ã€"è®°ä¸ªè´¦"ï¼‰
- è§„åˆ™éš¾ä»¥è¦†ç›–æ‰€æœ‰è¡¨è¾¾æ–¹å¼
- è§„åˆ™ä½œä¸ºå…œåº•ä¿è¯ç¦»çº¿å¯ç”¨
- å¤ç”¨ç°æœ‰ `SmartIntentRecognizer` è§„åˆ™èƒ½åŠ›

**æƒè¡¡**ï¼š
- å¢åŠ äº†LLMè°ƒç”¨æˆæœ¬
- å¢åŠ äº†å“åº”å»¶è¿Ÿï¼ˆçº¦1-2ç§’ï¼‰
- é€šè¿‡ç¼“å­˜ã€æµå¼å“åº”å’Œè§„åˆ™å¿«é€Ÿåˆ¤æ–­ç¼“è§£

---

### å†³ç­–2ï¼šèŠå¤©/åŠŸèƒ½åˆ†ç¦» vs ç»Ÿä¸€å¤„ç†

**é€‰æ‹©**ï¼šåˆ†ç¦»å¤„ç†

**ç†ç”±**ï¼š
- èŠå¤©éœ€è¦äººæ ¼ä¸€è‡´æ€§ï¼ŒåŠŸèƒ½éœ€è¦ç²¾ç¡®æ‰§è¡Œ
- åˆ†ç¦»åå¯ç‹¬ç«‹ä¼˜åŒ–
- æ··åˆç±»å‹å¯ç»„åˆå¤„ç†

**æƒè¡¡**ï¼š
- å¢åŠ äº†è·¯ç”±å¤æ‚åº¦
- éœ€è¦å¤„ç†è¾¹ç•Œæƒ…å†µ

---

### å†³ç­–3ï¼šè¡Œä¸ºæ³¨å†Œæ¨¡å¼ vs ç¡¬ç¼–ç 

**é€‰æ‹©**ï¼šæ³¨å†Œæ¨¡å¼

**ç†ç”±**ï¼š
- æ–°åŠŸèƒ½å¯é€šè¿‡æ³¨å†Œæ·»åŠ ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œ
- ä¾¿äºæµ‹è¯•å’Œæ¨¡æ‹Ÿ

**æƒè¡¡**ï¼š
- åˆæœŸå¼€å‘æˆæœ¬ç•¥é«˜
- éœ€è¦ç»´æŠ¤æ³¨å†Œè¡¨

---

## é£é™© / æƒè¡¡

### é£é™©1ï¼šLLMå“åº”å»¶è¿Ÿ

- **å½±å“**ï¼šç”¨æˆ·æ„ŸçŸ¥æ˜æ˜¾ç­‰å¾…
- **æ¦‚ç‡**ï¼šé«˜ï¼ˆæ¯æ¬¡å¯¹è¯éƒ½éœ€è°ƒç”¨ï¼‰
- **ç¼“è§£**ï¼š
  1. æµå¼è¾“å‡ºï¼ˆè¾¹ç”Ÿæˆè¾¹è¯´ï¼‰
  2. é«˜é¢‘å“åº”ç¼“å­˜
  3. è§„åˆ™å¿«é€Ÿåˆ¤æ–­åˆ†æµç®€å•è¯·æ±‚

### é£é™©2ï¼šæ„å›¾è¯¯åˆ¤

- **å½±å“**ï¼šæ‰§è¡Œé”™è¯¯æ“ä½œ
- **æ¦‚ç‡**ï¼šä¸­
- **ç¼“è§£**ï¼š
  1. å…³é”®æ“ä½œï¼ˆåˆ é™¤ã€ä¿®æ”¹å¤§é‡‘é¢ï¼‰éœ€ç¡®è®¤
  2. ç½®ä¿¡åº¦ä½æ—¶ä¸»åŠ¨è¯¢é—®
  3. å…è®¸ç”¨æˆ·çº æ­£ï¼ˆ"ä¸æ˜¯ï¼Œæˆ‘æ˜¯è¯´..."ï¼‰

### é£é™©3ï¼šä¸Šä¸‹æ–‡ç´¯ç§¯

- **å½±å“**ï¼šå†…å­˜å ç”¨å¢åŠ 
- **æ¦‚ç‡**ï¼šä½
- **ç¼“è§£**ï¼š
  1. é™åˆ¶å†å²è½®æ•°ï¼ˆé»˜è®¤5è½®ï¼‰
  2. ä¼šè¯è¶…æ—¶è‡ªåŠ¨æ¸…ç†
  3. åªä¿ç•™ç»“æ„åŒ–æ‘˜è¦

---

## è¿ç§»è®¡åˆ’

### é˜¶æ®µ1ï¼šæ ¸å¿ƒæ¡†æ¶ï¼ˆä¼˜å…ˆçº§1ï¼‰

1. å®ç° ConversationalAgent æ ¸å¿ƒæ§åˆ¶å™¨
2. å®ç° IntentRouter æ„å›¾è·¯ç”±
3. å®ç° ActionRegistry è¡Œä¸ºæ³¨å†Œ
4. è¿ç§»ç°æœ‰åŠŸèƒ½åˆ°è¡Œä¸ºæ¨¡å¼

### é˜¶æ®µ2ï¼šèŠå¤©èƒ½åŠ›ï¼ˆä¼˜å…ˆçº§1ï¼‰

1. å®ç° ChatEngine èŠå¤©å¼•æ“
2. è®¾è®¡åŠ©æ‰‹äººæ ¼
3. é›†æˆLLMèŠå¤©

### é˜¶æ®µ3ï¼šä¸Šä¸‹æ–‡å¢å¼ºï¼ˆä¼˜å…ˆçº§2ï¼‰

1. å¢å¼º ContextManager
2. å®ç°æŒ‡ä»£æ¶ˆè§£
3. å®ç°æ—¶é—´å¼•ç”¨è§£æ

### é˜¶æ®µ4ï¼šå“åº”ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§2ï¼‰

1. å¢å¼º ResponseGenerator
2. å®ç°å“åº”å˜ä½“
3. å®ç°æµå¼è¾“å‡º

### é˜¶æ®µ5ï¼šé›†æˆæµ‹è¯•ï¼ˆä¼˜å…ˆçº§3ï¼‰

1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. ç”¨æˆ·ä½“éªŒæµ‹è¯•

---

## å…³é”®æ–‡ä»¶å˜æ›´

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `lib/services/voice/conversational_agent.dart` | æ–°å»º | æ™ºèƒ½ä½“æ ¸å¿ƒ |
| `lib/services/voice/intent_router.dart` | æ–°å»º | æ„å›¾è·¯ç”±å™¨ |
| `lib/services/voice/action_registry.dart` | æ–°å»º | è¡Œä¸ºæ³¨å†Œè¡¨ |
| `lib/services/voice/action_executor.dart` | æ–°å»º | è¡Œä¸ºæ‰§è¡Œå™¨ |
| `lib/services/voice/chat_engine.dart` | æ–°å»º | èŠå¤©å¼•æ“ |
| `lib/services/voice/context_manager.dart` | æ–°å»º | ä¸Šä¸‹æ–‡ç®¡ç† |
| `lib/services/voice/actions/*.dart` | æ–°å»º | å„è¡Œä¸ºå®ç° |
| `lib/services/voice/conversation_context.dart` | ä¿®æ”¹ | å¢å¼ºä¸Šä¸‹æ–‡ |
| `lib/services/voice/llm_response_generator.dart` | ä¿®æ”¹ | å¢å¼ºå“åº” |
| `lib/services/voice_service_coordinator.dart` | ä¿®æ”¹ | é›†æˆæ™ºèƒ½ä½“ |

---

## å¾…å†³é—®é¢˜

1. **åŠ©æ‰‹åç§°**ï¼šå»ºè®®"å°è®°"ï¼Œæ˜¯å¦éœ€è¦äº§å“ç¡®è®¤ï¼Ÿ
2. **èŠå¤©è¾¹ç•Œ**ï¼šå“ªäº›è¯é¢˜åº”è¯¥å¼•å¯¼å›è®°è´¦ï¼Ÿ
3. **ç¡®è®¤é˜ˆå€¼**ï¼šå¤šå¤§é‡‘é¢çš„äº¤æ˜“éœ€è¦ç¡®è®¤ï¼Ÿå»ºè®®>500å…ƒ
4. **ç¦»çº¿èŠå¤©**ï¼šæ˜¯å¦éœ€è¦åŸºç¡€çš„ç¦»çº¿èŠå¤©èƒ½åŠ›ï¼Ÿï¼ˆé¢„è®¾é—®ç­”ï¼‰
