# 对话式智能体 - 任务清单

## 1. 核心框架 - 智能体引擎

### 1.1 实现 ActionRegistry（行为注册表）
- [x] 1.1.1 创建 `action_registry.dart` 基础框架
  - 定义 `Action` 抽象基类
  - 定义 `ActionParam` 参数模型
  - 定义 `ActionResult` 结果模型
  - 实现注册/查找/列表方法

- [x] 1.1.2 实现交易相关行为
  - `AddTransactionAction` - 添加记录
  - `QueryTransactionAction` - 查询记录
  - `ModifyTransactionAction` - 修改记录
  - `DeleteTransactionAction` - 删除记录

- [x] 1.1.3 实现导航相关行为
  - `NavigateToPageAction` - 页面跳转
  - 复用现有 `VoiceNavigationExecutor`

- [x] 1.1.4 实现查询相关行为
  - `StatisticsQueryAction` - 统计查询
  - `TrendQueryAction` - 趋势查询
  - `BudgetQueryAction` - 预算查询

- [x] 1.1.5 实现 ActionRouter（意图→服务映射）
  - 创建意图到现有 Service 的路由映射表
  - 配置类映射到 BudgetService/AccountService/ThemeService 等
  - 交易类映射到 TransactionService
  - 导航类映射到 VoiceNavigationExecutor
  - **注意**：不实现业务逻辑，只做路由

- [ ] 1.1.6 建立配置项意图映射（136+ 项）
  - P0 配置映射：预算、账户（~33 项）
  - P1 配置映射：分类、提醒、安全、AI（~51 项）
  - P2 配置映射：其他类别（~52 项）
  - 每项只需：意图ID + 触发词 + 目标Service方法

**验证**：LLM 识别的意图能正确路由到现有 Service

---

### 1.2 实现 ActionExecutor（行为执行器）
- [x] 1.2.1 创建 `action_executor.dart`
  - 实现参数验证
  - 实现行为执行流程
  - 实现结果封装

- [x] 1.2.2 实现参数补全机制
  - 检测缺失参数
  - 生成追问提示
  - 处理用户补充

- [x] 1.2.3 实现执行确认机制
  - 定义需确认的行为（删除、大金额修改）
  - 生成确认提示
  - 处理用户确认/取消

**验证**：能正确执行行为并处理参数补全和确认

---

### 1.3 实现 HybridIntentRouter（混合意图路由器）
- [x] 1.3.1 创建 `hybrid_intent_router.dart` 基础框架
  - 定义 `RouteResult` 模型
  - 定义 `RouteType` 枚举（chat/action/hybrid/unknown）
  - 定义 `RoutingMode` 枚举（llm/rule/hybrid）

- [x] 1.3.2 实现 LLM 意图分类
  - 设计分类 Prompt
  - 解析 LLM 返回的 JSON
  - 提取意图类型和实体

- [x] 1.3.3 实现规则兜底路由
  - 复用 `SmartIntentRecognizer` 规则能力
  - 复用 `VoiceIntentRouter` 模式匹配
  - 实现 `RouteResult.fromRuleResult()` 转换

- [x] 1.3.4 实现主动网络监控器（ProactiveNetworkMonitor）
  - App启动时完整检测（连通性+LLM可用性+延迟测量）
  - 后台定时刷新（每60秒）
  - 监听系统网络状态变化事件
  - 缓存网络状态（有效期30秒）
  - 历史延迟统计（用于预测）

- [x] 1.3.5 实现语音按钮预热机制
  - 按钮按下时快速验证缓存
  - 并行预热LLM连接（不阻塞）
  - 并行预热ASR连接
  - 并行预加载TTS引擎

- [x] 1.3.6 实现零延迟路由决策
  - 语音识别完成时直接读取缓存状态
  - 根据缓存状态选择LLM/规则路径
  - 不再进行同步网络检测

- [x] 1.3.7 实现智能降级策略
  - 网络离线 → 完全使用规则
  - LLM超时（>3秒）→ 切换规则
  - LLM异常 → 重试1次后降级
  - 置信度低（<0.7）→ 规则验证
  - API限流 → 指数退避 + 规则兜底

- [x] 1.3.8 实现结果融合
  - LLM + 规则结果合并
  - 置信度加权选择
  - 冲突解决策略

**验证**：
- LLM可用时使用LLM
- 网络异常时自动降级到规则
- 降级对用户无感知

---

### 1.4 实现 ConversationalAgent（智能体核心）
- [x] 1.4.1 创建 `conversational_agent.dart`
  - 组装各组件
  - 实现主处理流程
  - 实现会话管理

- [x] 1.4.2 实现输入处理流程
  - 输入归一化
  - 上下文更新
  - 路由分发

- [x] 1.4.3 实现响应生成流程
  - 聊天响应
  - 行为响应
  - 混合响应

- [x] 1.4.4 实现错误处理
  - 意图识别失败
  - 行为执行失败
  - 降级策略

**验证**：端到端处理用户输入并生成响应

---

## 2. 聊天能力 - ChatEngine

### 2.1 实现基础聊天引擎
- [x] 2.1.1 创建 `chat_engine.dart`
  - 定义助手人格配置
  - 实现聊天 Prompt 模板
  - 集成 QwenService

- [x] 2.1.2 设计助手人格
  - 定义名称、角色、特点
  - 定义说话风格
  - 定义场景化响应

- [x] 2.1.3 实现上下文感知聊天
  - 传递对话历史
  - 传递用户画像
  - 传递当前状态

**验证**：能进行自然的闲聊对话

---

### 2.2 实现聊天增强功能
- [ ] 2.2.1 实现话题引导
  - 检测可引导话题
  - 自然引导到记账相关
  - 避免过度打扰

- [ ] 2.2.2 实现主动关怀
  - 时段问候
  - 消费提醒
  - 预算提醒

- [ ] 2.2.3 实现响应变体
  - 同类响应多种表达
  - 避免机械重复
  - 情感适配

**验证**：聊天有人格特点且能适时引导

---

## 3. 上下文增强 - ContextManager

### 3.1 实现增强上下文管理
- [x] 3.1.1 创建 `context_manager.dart`
  - 封装 ConversationContext
  - 添加交易引用追踪
  - 添加查询范围追踪

- [x] 3.1.2 实现指代消解
  - 识别指代词（它、这笔、那个）
  - 绑定到最近交易
  - 返回消解结果

- [x] 3.1.3 实现时间引用解析
  - 相对时间（昨天、上周、上个月）
  - 模糊时间（刚才、之前）
  - 复合时间（昨天下午）

- [x] 3.1.4 实现上下文摘要
  - 生成 LLM 可用的摘要
  - 控制摘要长度
  - 突出关键信息

**验证**：能正确理解"把它改成60"、"昨天那笔午饭"等指代

---

### 3.2 实现上下文持久化
- [ ] 3.2.1 实现会话恢复
  - 保存上下文到本地
  - 应用重启后恢复
  - 过期清理

- [ ] 3.2.2 实现用户画像追踪
  - 常用分类
  - 消费习惯
  - 偏好设置

**验证**：重启后能恢复上下文，了解用户偏好

---

## 4. 响应优化 - ResponseGenerator

### 4.1 增强响应生成
- [ ] 4.1.1 重构 `llm_response_generator.dart`
  - 行为响应生成
  - 聊天响应生成
  - 混合响应生成

- [ ] 4.1.2 实现响应模板系统
  - 各行为类型模板
  - 模板变量填充
  - 模板变体选择

- [ ] 4.1.3 实现 LLM 响应润色
  - 模板 + 上下文生成自然响应
  - 控制响应长度
  - 保持人格一致

**验证**：响应自然、有人格特点

---

### 4.2 实现流式响应
- [ ] 4.2.1 实现流式生成接口
  - 流式返回文本片段
  - 支持提前中断
  - 错误处理

- [ ] 4.2.2 集成流式 TTS
  - 边生成边合成
  - 边合成边播放
  - 首字延迟优化

**验证**：首字响应延迟 < 500ms

---

## 5. 系统集成

### 5.1 集成到 VoiceServiceCoordinator
- [x] 5.1.1 重构协调器
  - 引入 ConversationalAgent
  - 重构处理流程
  - 保持向后兼容

- [x] 5.1.2 实现模式切换
  - 传统模式（命令式）
  - 智能体模式（对话式）
  - 配置开关

- [x] 5.1.3 更新状态管理
  - 智能体会话状态
  - 行为执行状态
  - 错误状态

**验证**：两种模式都能正常工作

---

### 5.2 集成到全局悬浮球
- [ ] 5.2.1 更新悬浮球交互
  - 支持长按进入对话模式
  - 显示智能体状态
  - 支持取消/中断

- [ ] 5.2.2 更新语音聊天页面
  - 显示对话历史
  - 显示行为执行结果
  - 支持文字输入

**验证**：UI正确反映智能体状态

---

## 6. 测试和文档

### 6.1 单元测试
- [ ] 6.1.1 ActionRegistry 测试
- [ ] 6.1.2 IntentRouter 测试
- [ ] 6.1.3 ContextManager 测试
- [ ] 6.1.4 ChatEngine 测试

### 6.2 集成测试
- [ ] 6.2.1 完整对话流程测试
- [ ] 6.2.2 意图混合测试
- [ ] 6.2.3 指代消解测试
- [ ] 6.2.4 错误恢复测试

### 6.3 文档
- [ ] 6.3.1 智能体使用文档
- [ ] 6.3.2 行为扩展指南
- [ ] 6.3.3 人格配置指南

---

## 依赖关系

```
1.1 ActionRegistry
      │
      ▼
1.2 ActionExecutor ──────┐
      │                   │
      ▼                   ▼
1.3 IntentRouter ──▶ 1.4 ConversationalAgent
      ▲                   │
      │                   ▼
2.1 ChatEngine      5.1 系统集成
      │                   │
      ▼                   ▼
2.2 聊天增强        5.2 UI集成
                          │
3.x ContextManager ───────┘
4.x ResponseGenerator
```

## 可并行工作

- 1.1 和 2.1 可并行
- 1.2 和 3.1 可并行
- 4.x 可在 1.x 完成后并行
- 6.x 可在各模块完成后进行

## 验证检查点

- [ ] 用户说"今天天气不错"，助手自然回应
- [ ] 用户说"记一笔午饭30块"，正确记录
- [ ] 用户说"帮我记下刚吃的，30块"，正确识别混合意图
- [ ] 用户说"把它改成50"，正确解析指代
- [ ] 用户说"这个月花了多少"，正确查询统计
- [ ] 首字响应延迟 < 1秒
- [ ] 意图识别准确率 > 90%
