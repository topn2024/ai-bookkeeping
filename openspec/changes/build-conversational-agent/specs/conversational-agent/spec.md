# 对话式智能体规范

## 新增需求

### 需求：智能体核心引擎

智能体**必须**能接收用户输入，判断意图类型，执行相应操作或回复聊天，并生成自然语言响应。

#### 场景：纯聊天对话

**给定** 用户处于语音助手对话模式
**当** 用户说 "今天天气真好啊"
**那么** 智能体识别为聊天意图
**并且** 使用聊天引擎生成自然回复
**并且** 回复内容符合助手人格特点

#### 场景：纯功能请求

**给定** 用户处于语音助手对话模式
**当** 用户说 "记一笔午饭30元"
**那么** 智能体识别为行为意图
**并且** 执行添加记录行为
**并且** 返回执行结果的自然语言描述

#### 场景：混合意图

**给定** 用户处于语音助手对话模式
**当** 用户说 "帮我记一下刚吃的午饭，30块钱"
**那么** 智能体识别为混合意图
**并且** 提取行为意图（添加记录）和聊天语境
**并且** 执行行为并生成带聊天风格的响应

---

### 需求：意图路由

智能体**必须**能准确区分用户输入是聊天、功能请求还是混合类型。

#### 场景：App启动时网络检测

**给定** 用户启动App
**当** App初始化完成
**那么** 后台执行完整网络检测
**并且** 检测内容包括连通性、LLM可用性、延迟测量
**并且** 缓存检测结果供后续使用
**并且** 启动定时刷新（每60秒）

#### 场景：语音按钮按下时预热

**给定** 网络状态已缓存
**当** 用户按下语音按钮
**那么** 快速验证缓存有效性（<10ms）
**并且** 并行预热LLM/ASR/TTS连接
**并且** 不阻塞用户录音操作

#### 场景：LLM路由（正常模式）

**给定** 网络正常且LLM服务可用（从缓存读取）
**当** 用户语音识别完成
**那么** 直接使用缓存状态进行路由决策（0ms延迟）
**并且** 使用LLM进行意图分类

#### 场景：规则兜底（网络离线）

**给定** 设备处于离线状态
**当** 用户说 "记一笔午饭30元"
**那么** 自动切换到规则引擎
**并且** 正确识别为添加记录意图
**并且** 用户无感知模式切换

#### 场景：规则兜底（LLM超时）

**给定** 网络延迟超过3秒
**当** 用户进行语音输入
**那么** LLM调用超时后自动降级
**并且** 使用规则引擎完成意图识别

#### 场景：规则兜底（LLM异常）

**给定** LLM服务返回错误或解析失败
**当** 用户进行语音输入
**那么** 重试1次后降级到规则引擎
**并且** 记录错误日志供排查

#### 场景：聊天意图识别

**给定** 用户输入 "早上好"
**当** 进行意图路由分析
**那么** 返回路由类型为 "chat"
**并且** 置信度高于 0.8

#### 场景：功能意图识别

**给定** 用户输入 "查一下这个月花了多少"
**当** 进行意图路由分析
**那么** 返回路由类型为 "action"
**并且** 行为类型为 "query.statistics"
**并且** 提取时间范围参数为 "本月"

#### 场景：混合意图识别

**给定** 用户输入 "有点饿了，帮我记下刚买的零食15块"
**当** 进行意图路由分析
**那么** 返回路由类型为 "hybrid"
**并且** 提取行为意图和聊天内容

#### 场景：未知意图处理

**给定** 用户输入 "嗯"
**当** 进行意图路由分析
**那么** 返回路由类型为 "unknown"
**并且** 智能体主动询问或礼貌回应

---

### 需求：行为注册与执行

智能体**必须**支持通过注册表管理可执行行为，并能正确执行这些行为。

#### 场景：注册新行为

**给定** 系统初始化
**当** 注册 "添加记录" 行为到注册表
**那么** 注册表包含该行为
**并且** 可通过意图类型查找该行为

#### 场景：执行行为

**给定** 行为 "添加记录" 已注册
**并且** 参数 amount=30, category="餐饮"
**当** 执行该行为
**那么** 成功创建记录
**并且** 返回包含记录ID的执行结果

#### 场景：参数缺失处理

**给定** 用户说 "记一笔午饭"（缺少金额）
**当** 执行添加记录行为
**那么** 检测到缺失必要参数 "amount"
**并且** 返回追问提示 "请问花了多少钱？"

#### 场景：确认敏感操作

**给定** 用户说 "删掉这笔记录"
**当** 执行删除行为
**那么** 首先返回确认请求
**并且** 等待用户确认后才真正执行

---

### 需求：语音配置操作

智能体**必须**支持通过语音修改系统配置，覆盖 v2 设计文档 18.3.1 节定义的 13 大类、136+ 项配置。

#### 场景：预算配置

**给定** 用户说 "把餐饮预算改成2000"
**当** 执行配置行为
**那么** 识别为 `config.budget.category` 意图
**并且** 提取参数 category="餐饮", amount=2000
**并且** 返回确认 "将餐饮预算从1500改为2000，确认吗？"

#### 场景：账户配置

**给定** 用户说 "把微信设为默认账户"
**当** 执行配置行为
**那么** 识别为 `config.account.default` 意图
**并且** 执行配置修改
**并且** 返回 "已将微信设为默认账户"

#### 场景：提醒配置

**给定** 用户说 "每天晚上8点提醒我记账"
**当** 执行配置行为
**那么** 识别为 `config.reminder.daily` 意图
**并且** 提取时间参数 20:00
**并且** 返回 "已设置每日记账提醒，时间：20:00"

#### 场景：外观配置

**给定** 用户说 "切换到深色模式"
**当** 执行配置行为
**那么** 识别为 `config.theme.mode` 意图
**并且** 立即切换主题
**并且** 返回 "已切换到深色模式"

#### 场景：安全配置

**给定** 用户说 "开启指纹解锁"
**当** 执行配置行为
**那么** 识别为 `config.security.fingerprint` 意图
**并且** 检查设备是否支持指纹
**并且** 引导用户完成指纹设置

#### 场景：AI配置

**给定** 用户说 "关闭智能分类"
**当** 执行配置行为
**那么** 识别为 `config.ai.smartCategory` 意图
**并且** 关闭智能分类功能
**并且** 返回 "已关闭智能分类功能，将使用手动分类"

---

### 需求：聊天引擎

智能体**必须**能进行自然的闲聊对话，保持一致的助手人格。

#### 场景：问候响应

**给定** 用户说 "早上好"
**当** 聊天引擎处理
**那么** 返回符合时段的问候
**并且** 语气友好自然

#### 场景：闲聊话题

**给定** 用户说 "最近工作好累啊"
**当** 聊天引擎处理
**那么** 返回关心和理解的回复
**并且** 可适时引导到记账话题（如消费减压）

#### 场景：人格一致性

**给定** 连续多轮对话
**当** 聊天引擎生成响应
**那么** 所有响应保持一致的人格特点
**并且** 语气风格统一

---

### 需求：上下文管理

智能体**必须**能理解对话上下文，支持指代消解和时间引用。

#### 场景：指代消解 - 交易引用

**给定** 用户刚记录了 "午饭30元"
**当** 用户说 "把它改成50"
**那么** 正确识别 "它" 指代最近的交易
**并且** 修改该交易金额为50

#### 场景：指代消解 - 这笔/那笔

**给定** 用户刚记录了一笔交易
**当** 用户说 "删掉这笔"
**那么** 正确识别 "这笔" 指代最近的交易
**并且** 执行删除确认流程

#### 场景：时间引用 - 相对时间

**给定** 用户说 "昨天花了多少"
**当** 解析时间引用
**那么** 正确转换为昨天的日期范围
**并且** 查询该日期范围的记录

#### 场景：时间引用 - 模糊时间

**给定** 用户说 "刚才那笔打车"
**当** 解析时间引用
**那么** 在最近的对话/交易中查找相关记录
**并且** 返回匹配的交易

---

### 需求：响应生成

智能体**必须**能生成自然、有人格特点的响应。

#### 场景：行为成功响应

**给定** 添加记录行为执行成功
**当** 生成响应
**那么** 返回自然语言描述 如 "好的，已记录餐饮30元"
**并且** 语气轻松自然

#### 场景：行为失败响应

**给定** 查询未找到匹配记录
**当** 生成响应
**那么** 返回友好的说明 如 "嗯，没找到这笔记录呢"
**并且** 可提供建议

#### 场景：响应变体

**给定** 多次执行添加记录成功
**当** 生成响应
**那么** 使用不同的响应变体
**并且** 避免完全重复

---

## 修改需求

### 需求：语音服务协调器集成

**必须**修改现有语音服务协调器，集成对话式智能体引擎。

#### 场景：智能体模式启用

**给定** 用户开启智能体模式
**当** 接收语音输入
**那么** 通过智能体引擎处理
**并且** 返回智能体生成的响应

#### 场景：传统模式兼容

**给定** 用户使用传统命令模式
**当** 接收语音输入
**那么** 使用现有意图识别流程
**并且** 保持原有行为不变

---

## 验收标准

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 意图分类准确率 | > 90% | 正确区分聊天/功能/混合 |
| 指代消解准确率 | > 85% | 正确理解"它"、"这笔"等指代 |
| 时间解析准确率 | > 90% | 正确解析相对时间引用 |
| 首字响应延迟 | < 1秒 | LLM模式下 |
| 人格一致性评分 | > 4/5 | 用户主观评价 |
