# 变更：构建对话式智能体

## 为什么

当前语音助手是"命令式"设计——用户必须发出明确的指令（如"记一笔餐饮50元"），系统才能响应。这种交互模式存在以下问题：

1. **学习成本高**：用户需要记住特定的命令格式
2. **交互生硬**：无法进行自然闲聊，缺乏陪伴感
3. **上下文断裂**：每次对话都是独立的，无法理解"那笔"、"刚才"等指代
4. **被动响应**：只能等待用户发起，无法主动提供帮助

用户期望的是一个"智能管家"——既能陪聊，又能在聊天过程中识别意图并自动执行操作。

## 变更内容

### 核心能力：构建对话式智能体引擎

实现一个能够**边聊边做**的智能体，核心特性：

#### 设计原则：LLM 与执行层职责分离

```
LLM 层（理解，~800ms）              执行层（操作，~100ms）
├─ 意图分类                         ├─ 调用现有 Service
├─ 实体提取                         ├─ 复用现有导航/记账
├─ 情感/情绪判断                    └─ 不做意图理解
├─ 陪聊响应生成
└─ 不执行业务操作
```

**为什么这样设计**：
- 响应速度：LLM 聚焦理解，执行层本地调用
- 代码复用：136+ 配置项的修改逻辑已存在
- 离线降级：执行层不依赖 LLM

#### 1. LLM 负责的能力

- **意图分类**：chat / action / hybrid / unknown
- **实体提取**：amount, category, time, configKey, configValue
- **情感判断**：开心 / 沮丧 / 焦虑 / 平静
- **陪聊响应**：自然语言对话，保持助手人格

#### 2. 执行层负责的能力（复用现有代码）

- **记账操作**：TransactionService
- **页面导航**：VoiceNavigationExecutor
- **配置修改**：BudgetService / AccountService / ThemeService 等
- **数据查询**：StatisticsService

#### 3. 上下文感知
   - 理解代词指代（"把它改成60"）
   - 理解时间引用（"昨天那笔"）
   - 记忆对话历史，支持多轮交互
   - 主动跟进（"还有其他要记的吗？"）

### 架构全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                     对话式智能体引擎                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  语音输入   │───▶│ 意图路由器  │───▶│ 行为执行器  │         │
│  │   (ASR)    │    │ (Router)    │    │ (Executor)  │         │
│  └─────────────┘    └──────┬──────┘    └──────┬──────┘         │
│                            │                  │                 │
│                     ┌──────▼──────┐    ┌──────▼──────┐         │
│                     │ 聊天 │ 功能  │    │  行为注册表  │         │
│                     │ (Chat)│(Action)│   │ (Registry) │         │
│                     └──────┬──────┘    └──────┬──────┘         │
│                            │                  │                 │
│  ┌─────────────┐    ┌──────▼──────┐    ┌──────▼──────┐         │
│  │  语音输出   │◀───│ 响应生成器  │◀───│  上下文管理  │         │
│  │   (TTS)    │    │ (Generator) │    │  (Context)  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 关键组件

| 组件 | 职责 | 新建/修改 |
|------|------|----------|
| ConversationalAgent | 智能体核心控制器 | 新建 |
| IntentRouter | 聊天/功能意图路由 | 新建 |
| ActionRegistry | 可执行行为注册表 | 新建 |
| ActionExecutor | 行为执行引擎 | 新建 |
| ChatEngine | 闲聊对话引擎 | 新建 |
| ConversationContext | 上下文管理（增强） | 修改 |
| ResponseGenerator | 响应生成（增强） | 修改 |

## 影响

- **受影响规范**：voice-assistant（新建 conversational-agent 能力）
- **受影响代码**：
  - `app/lib/services/voice/` - 新增智能体相关服务
  - `app/lib/services/voice_service_coordinator.dart` - 集成智能体引擎
  - `app/lib/widgets/global_floating_ball.dart` - 支持新交互模式

## 与现有系统的关系

本提案**复用并增强**现有基础设施：

| 现有组件 | 本提案中的角色 |
|----------|---------------|
| SmartIntentRecognizer | **规则兜底引擎**，网络异常时降级使用 |
| VoiceIntentRouter | **规则模式匹配**，复用关键词和模式定义 |
| ConcurrentVoicePipeline | 作为语音输入/输出管道 |
| ConversationContext | 扩展支持更丰富的上下文 |
| LLMResponseGenerator | 扩展支持聊天和功能响应 |
| VoiceNavigationExecutor | 作为 ActionExecutor 的导航实现 |

### 规则兜底策略

```
正常模式（LLM可用）          降级模式（LLM不可用）
       │                           │
       ▼                           ▼
  LLM意图分类               规则引擎（复用现有）
       │                           │
       ▼                           ▼
  LLM响应生成               模板响应生成
       │                           │
       └─────────┬─────────────────┘
                 ▼
           统一输出接口
```

**触发降级的条件**：
- 网络离线
- LLM调用超时（>3秒）
- LLM服务异常/解析失败
- API限流（429）

**降级后保障**：
- 核心记账功能（添加/查询）完全可用
- 页面导航功能完全可用
- 闲聊使用预设回复

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| LLM 延迟影响对话流畅性 | 高 | 流式响应 + 本地缓存高频问答 |
| 聊天/功能意图误判 | 中 | 置信度阈值 + 确认机制 |
| 上下文管理内存占用 | 低 | 限制历史轮数 + 定期清理 |
| 用户期望过高 | 中 | 明确能力边界，优雅降级 |

## 验收标准

1. **自然对话**：用户可以用自然语言与助手交流，无需记忆命令格式
2. **意图混合**：一句话中同时包含聊天和记账意图能被正确处理
3. **上下文理解**：支持"这笔"、"刚才那个"等指代
4. **响应延迟**：首字响应时间 < 1秒（LLM模式）
5. **准确率**：意图识别准确率 > 90%
6. **覆盖率**：支持所有现有语音功能 + 闲聊
