# AI智能记账 - 发布指南

## 🚀 推荐方式：使用统一发布脚本

### 一键发布到两台服务器

```bash
# 设置管理员密码（如果未设置）
export ADMIN_PASSWORD="admin123"

# 发布（会自动构建、上传到服务器2、同步到服务器1）
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "更新说明" \
  --auto-confirm
```

### 参数说明

**必需参数：**
- `--version VERSION` - 版本号（如 2.0.12）
- `--code CODE` - 构建号（如 58）
- `--notes "说明"` - 更新说明

**可选参数：**
- `--force` - 标记为强制更新
- `--skip-build` - 跳过APK构建，使用已存在的APK
- `--skip-sync` - 仅发布到服务器2，不同步到服务器1
- `--auto-confirm` - 自动确认，不询问

**环境变量：**
- `ADMIN_PASSWORD` - 管理员密码（默认：admin123）
- `FLUTTER_CMD` - Flutter命令路径（默认：flutter）

---

## 📦 发布流程

统一发布脚本会自动执行以下步骤：

1. **更新版本号** - 自动更新 pubspec.yaml 和 build_info.dart
2. **构建APK** - 清理、获取依赖、构建Release APK
3. **验证签名** - 确保使用正确的Release证书
4. **发布到服务器2** (39.105.12.124 - 主服务器)
   - 登录管理后台
   - 创建版本记录
   - 上传APK到MinIO
   - 发布版本
5. **同步到服务器1** (160.202.238.29 - 备份服务器)
   - 自动从服务器2下载APK
   - 上传到服务器1
   - 创建并发布版本记录
6. **验证一致性** - 确保两台服务器版本一致

---

## 📖 使用示例

### 场景1：发布新版本（推荐）

```bash
# 完整发布流程：构建 + 发布到两台服务器
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "修复语音助手bug，优化小金库显示" \
  --auto-confirm
```

### 场景2：使用已构建的APK

```bash
# 如果已经构建好APK，只需要发布
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "修复语音助手bug" \
  --skip-build \
  --auto-confirm
```

### 场景3：仅发布到服务器2

```bash
# 测试时可以先只发布到服务器2
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "测试版本" \
  --skip-sync \
  --auto-confirm
```

### 场景4：强制更新

```bash
# 重要更新，要求用户必须升级
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "重要安全更新" \
  --force \
  --auto-confirm
```

---

## 🔧 高级用法

### 仅使用底层工具发布到单个服务器

```bash
# 发布到服务器2
API_BASE_URL="https://39.105.12.124" \
ADMIN_PASSWORD="admin123" \
./scripts/publish_apk.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "更新说明" \
  --build \
  --publish

# 发布到服务器1
API_BASE_URL="https://160.202.238.29" \
ADMIN_PASSWORD="admin123" \
./scripts/publish_apk.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "更新说明" \
  --build \
  --publish
```

### 手动同步版本

如果自动同步失败，可以手动运行：

```bash
./scripts/sync_version.sh --auto
```

### 检查版本一致性

```bash
./scripts/check_version_consistency.sh
```

---

## 🎯 工作流程建议

### 开发版本发布

```bash
# 1. 修改代码
# 2. 提交到Git
git add -A
git commit -m "feat: 新功能"

# 3. 发布（先只发布到服务器2测试）
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "新功能测试" \
  --skip-sync

# 4. 测试通过后，同步到服务器1
./scripts/sync_version.sh --auto

# 5. 推送代码到GitHub
git push origin master
```

### 正式版本发布

```bash
# 1. 确保代码已提交
git status

# 2. 一键发布到两台服务器
./scripts/publish_unified.sh \
  --version "2.0.12" \
  --code "58" \
  --notes "修复重要bug，优化用户体验" \
  --auto-confirm

# 3. 推送代码
git push origin master
```

---

## 📁 脚本说明

### 核心脚本

- **scripts/publish_unified.sh** ⭐ **推荐使用**
  - 统一发布工具，自动发布到两台服务器
  - 支持自动构建、版本号更新、同步验证

- **scripts/publish_apk.sh**
  - 底层发布工具，发布到单个服务器
  - 被 publish_unified.sh 调用

- **scripts/sync_version.sh**
  - 版本同步工具，从服务器2同步到服务器1

- **scripts/check_version_consistency.sh**
  - 版本一致性检查工具

### 辅助脚本

- **INSTALL_DEPS.sh**
  - 依赖安装脚本

---

## ⚠️ 注意事项

1. **版本号管理**
   - 版本号（VERSION）格式：主版本.次版本.修订号（如 2.0.12）
   - 构建号（CODE）必须递增（如 58 → 59 → 60）
   - 每次发布后需要在下一次开发时更新版本号

2. **服务器配置**
   - 服务器2（39.105.12.124）是主服务器
   - 服务器1（160.202.238.29）是备份服务器
   - 两台服务器会自动保持版本同步

3. **APK签名**
   - 所有发布必须使用Release证书签名
   - 脚本会自动验证签名，防止发布Debug版本

4. **更新说明**
   - 简洁明了地说明本次更新内容
   - 用户会在应用内更新时看到这些说明

5. **强制更新**
   - 谨慎使用 `--force` 参数
   - 只在重要安全更新或必要的兼容性更新时使用

---

## 🔍 故障排查

### 问题1：APK上传失败（413错误）

**原因**：APK文件太大，超过Nginx限制

**解决**：已在服务器配置 client_max_body_size 200M，如仍有问题：

```bash
# 登录服务器检查Nginx配置
ssh root@39.105.12.124
nginx -T | grep client_max_body_size
```

### 问题2：登录失败

**原因**：管理员密码错误或账户被锁定

**解决**：
```bash
# 检查密码
echo $ADMIN_PASSWORD

# 或在服务器上重置密码（参考之前的操作）
```

### 问题3：同步到服务器1失败

**原因**：服务器1连接超时或网络问题

**解决**：
```bash
# 稍后手动同步
./scripts/sync_version.sh --auto

# 或单独发布到服务器1
API_BASE_URL="https://160.202.238.29" \
./scripts/publish_apk.sh --version "X.X.X" --code "XX" ...
```

### 问题4：版本号冲突

**原因**：该版本号已存在

**解决**：
- 增加构建号（CODE）
- 或删除服务器上的旧版本记录后重新发布

---

## 📞 支持

如有问题，请查看：
- [publish_apk.sh 源码](./scripts/publish_apk.sh)
- [publish_unified.sh 源码](./scripts/publish_unified.sh)
- 或联系开发团队
