# Android 调试端口配置说明

## 问题背景

Windows 系统服务 `LogsAndAlerts` (PID: 4344) 占用了 ADB 默认端口 **5037**，导致 Android 调试桥（ADB）无法正常工作。

## 解决方案概述

将 ADB 配置为使用备用端口 **5038**，通过以下方式实现：

1. 设置环境变量 `ANDROID_ADB_SERVER_PORT=5038`
2. 创建启动脚本确保所有工具使用正确端口
3. 更新 PATH 环境变量优先使用包装脚本

## 已完成的配置

### 1. 环境变量配置

**用户级环境变量（已设置）：**
- `ANDROID_ADB_SERVER_PORT=5038`

**PATH 环境变量（已更新）：**
- 添加 `D:\code\ai-bookkeeping\scripts` 到 PATH 最前面

### 2. 创建的脚本文件

| 脚本文件 | 用途 | 使用场景 |
|---------|------|---------|
| `start-adb.bat` | 启动 ADB 服务器并检查设备 | 开发前初始化 |
| `flutter-dev.bat` | 完整开发环境启动脚本 | 开始新的开发会话 |
| `adb.bat` | ADB 包装脚本（强制使用 5038 端口） | 自动被 Flutter 调用 |
| `run-app.bat` | 一键运行应用脚本 | 快速测试应用 |
| `test-flutter.bat` | Flutter 设备检测测试脚本 | 故障诊断 |

所有脚本位于：`D:\code\ai-bookkeeping\scripts\`

### 3. 文档文件

- `scripts/README.md` - 详细的配置和使用说明
- `scripts/快速开始.md` - 快速开始指南
- `端口配置说明.md` - 本文件

## 使用方法

### 每日开发流程

1. **启动 ADB 服务**
   ```cmd
   D:\code\ai-bookkeeping\scripts\start-adb.bat
   ```

2. **确保模拟器运行**
   - 通过 Android Studio 启动，或使用：
     ```cmd
     flutter emulators --launch Medium_Phone_API_36
     ```

3. **使用开发脚本**
   ```cmd
   D:\code\ai-bookkeeping\scripts\flutter-dev.bat
   ```

   或在任何命令行中设置环境变量后使用 Flutter：
   ```cmd
   set ANDROID_ADB_SERVER_PORT=5038
   cd D:\code\ai-bookkeeping\app
   flutter run
   ```

## 端口状态验证

### 检查端口占用

```cmd
REM 检查 5037（应该被 LogsAndAlerts 占用）
netstat -ano | findstr "5037"
输出：TCP    127.0.0.1:5037    0.0.0.0:0    LISTENING    4344

REM 检查 5038（我们的 ADB 端口）
netstat -ano | findstr "5038"
```

### 检查 ADB 状态

```cmd
set ANDROID_ADB_SERVER_PORT=5038
adb devices -l
```

预期输出：
```
List of devices attached
emulator-5554          device product:sdk_gphone64_x86_64 model:sdk_gphone64_x86_64 ...
```

## 可用设备清单

- **Android 模拟器：** Medium_Phone_API_36 (emulator-5554)
- **Windows 桌面：** windows (用于 Flutter 桌面应用)
- **Chrome 浏览器：** chrome (用于 Flutter Web)
- **Edge 浏览器：** edge (用于 Flutter Web)

## 重要注意事项

1. **不要修改 LogsAndAlerts 服务**
   - 这是系统服务，占用端口 5037 是正常的
   - 所有开发工具已配置为使用端口 5038

2. **环境变量生效时机**
   - 修改环境变量后需要重新打开命令行窗口
   - 建议使用提供的启动脚本，确保环境正确

3. **Flutter 与 ADB 端口**
   - Flutter 会调用 ADB，需要确保环境变量已设置
   - 使用 `flutter-dev.bat` 可以自动配置正确的环境

4. **模拟器连接**
   - 模拟器启动需要 30-60 秒才能完全就绪
   - 如果显示 "offline"，稍等片刻或重启 ADB

## 验证配置

运行以下命令验证配置是否正确：

```cmd
REM 1. 检查环境变量
echo %ANDROID_ADB_SERVER_PORT%
应该输出：5038

REM 2. 检查 PATH
echo %PATH%
应该包含：D:\code\ai-bookkeeping\scripts

REM 3. 测试 ADB
D:\code\ai-bookkeeping\scripts\start-adb.bat

REM 4. 测试 Flutter
D:\code\ai-bookkeeping\scripts\test-flutter.bat
```

## 故障排除

### ADB 无法启动

```cmd
REM 检查端口是否被占用
netstat -ano | findstr "5038"

REM 强制终止所有 ADB 进程
taskkill /F /IM adb.exe

REM 重新启动
set ANDROID_ADB_SERVER_PORT=5038
adb start-server
```

### Flutter 未检测到 Android 设备

原因：Flutter 可能未使用正确的环境变量

解决：
1. 使用 `flutter-dev.bat` 启动开发环境
2. 或在运行 Flutter 命令前手动设置：
   ```cmd
   set ANDROID_ADB_SERVER_PORT=5038
   ```

### 模拟器显示 offline

```cmd
set ANDROID_ADB_SERVER_PORT=5038
adb kill-server
adb start-server
adb devices
```

## 技术细节

### ADB 守护进程

- **默认端口：** 5037 (被 LogsAndAlerts 占用)
- **新端口：** 5038
- **配置方式：** 环境变量 `ANDROID_ADB_SERVER_PORT`

### 模拟器端口

- **控制端口：** 5554（自动分配）
- **ADB 端口：** 5555（自动分配）
- 这些端口未被占用，可以正常使用

## 配置完成状态

✅ 环境变量 ANDROID_ADB_SERVER_PORT 已设置为 5038
✅ PATH 已更新，包含 scripts 目录
✅ ADB 可在端口 5038 上启动
✅ Android 模拟器已启动并可连接
✅ 启动脚本已创建并可用
✅ 文档已创建

## 下一步

现在您可以正常进行 Flutter 应用开发了！

- 查看 `scripts/快速开始.md` 了解详细的开发流程
- 使用 `flutter-dev.bat` 开始开发
- 使用 `run-app.bat` 快速运行应用

如有问题，请参考 `scripts/README.md` 中的故障排除部分。
