# æ•°æ®å¤‡ä»½åŠŸèƒ½è¯Šæ–­æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-28
**é—®é¢˜**: ç”¨æˆ·æŠ¥å‘Šæ•°æ®å¤‡ä»½åŠŸèƒ½ä¸å¯ç”¨

## ğŸ” è¯Šæ–­ç»“æœ

### âœ… æœåŠ¡å™¨ç«¯ - å®Œå…¨æ­£å¸¸

**APIç«¯ç‚¹** (`server/app/api/v1/backup.py`):
- `POST /api/v1/backup` - åˆ›å»ºå¤‡ä»½ âœ…
- `GET /api/v1/backup` - è·å–å¤‡ä»½åˆ—è¡¨ âœ…
- `GET /api/v1/backup/{id}` - è·å–æŒ‡å®šå¤‡ä»½ âœ…
- `POST /api/v1/backup/{id}/restore` - æ¢å¤å¤‡ä»½ âœ…
- `DELETE /api/v1/backup/{id}` - åˆ é™¤å¤‡ä»½ âœ…

**è·¯ç”±æ³¨å†Œ**:
- `/server/app/api/v1/__init__.py` ç¬¬18è¡Œ: å¯¼å…¥backup router âœ…
- `/server/app/api/v1/__init__.py` ç¬¬55è¡Œ: æ³¨å†Œåˆ°API router âœ…
- `/server/app/main.py` ç¬¬128è¡Œ: æŒ‚è½½åˆ° `/api/v1` å‰ç¼€ âœ…

**æµ‹è¯•ç»“æœ**:
```bash
curl -k -X POST "https://39.105.12.124/api/v1/backup" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test" \
  -d '{"name":"test","backup_type":0}'

# å“åº”: {"detail":"Invalid or expired token"}
# è¯´æ˜: ç«¯ç‚¹æ­£å¸¸å·¥ä½œï¼Œéœ€è¦æœ‰æ•ˆçš„è®¤è¯token
```

### âœ… å®¢æˆ·ç«¯ - å®Œå…¨æ­£å¸¸

**BackupService** (`app/lib/services/backup_service.dart`):
- âœ… ä½¿ç”¨æœåŠ¡å®šä½å™¨ (Service Locator) è·å–ä¾èµ–
- âœ… æ­£ç¡®è°ƒç”¨ HTTP æœåŠ¡çš„ `/backup` ç«¯ç‚¹
- âœ… å®Œæ•´å®ç°åˆ›å»ºã€åˆ—è¡¨ã€è·å–ã€æ¢å¤ã€åˆ é™¤åŠŸèƒ½
- âœ… æ”¯æŒæœ¬åœ°æ•°æ®åº“å®Œæ•´å¤‡ä»½ï¼ˆåŒ…æ‹¬æ‰©å±•æ•°æ®ï¼‰

**ä¾èµ–æ³¨å…¥é…ç½®** (`app/lib/core/di/service_locator.dart`):
- âœ… IHttpService å·²æ³¨å†Œ (ç¬¬83-85è¡Œ)
- âœ… IDatabaseService å·²æ³¨å†Œ (ç¬¬78-80è¡Œ)
- âœ… æœåŠ¡å®šä½å™¨åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ– (main.dart:64)

**BackupPage UI** (`app/lib/pages/backup_page.dart`):
- âœ… å®Œæ•´çš„åˆ›å»ºå¤‡ä»½ç•Œé¢
- âœ… å®Œæ•´çš„æ¢å¤å¤‡ä»½ç•Œé¢
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ˜¾ç¤º
- âœ… éœ€è¦ç”¨æˆ·ç™»å½•åè®¿é—®

## â“ å¯èƒ½çš„é—®é¢˜åŸå› 

### 1. ç”¨æˆ·æœªç™»å½• â­ **æœ€å¯èƒ½**

**è¡¨ç°**:
- æ— æ³•è®¿é—®å¤‡ä»½é¡µé¢
- æˆ–è€…è®¿é—®åæç¤ºéœ€è¦ç™»å½•

**åŸå› **:
- BackupPage å¯¼å…¥äº† `auth_provider.dart` (ç¬¬4è¡Œ)
- å¤‡ä»½åŠŸèƒ½éœ€è¦ç”¨æˆ·è®¤è¯
- HTTP è¯·æ±‚éœ€è¦æœ‰æ•ˆçš„ Bearer Token

**è§£å†³æ–¹æ¡ˆ**:
```dart
// ç”¨æˆ·éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨å¤‡ä»½åŠŸèƒ½
// åœ¨è®¾ç½®é¡µé¢æˆ–å¤‡ä»½é¡µé¢å…¥å£æ£€æŸ¥ç™»å½•çŠ¶æ€
```

### 2. HTTPæœåŠ¡æœªæ­£ç¡®åˆå§‹åŒ–

**è¡¨ç°**:
- è°ƒç”¨å¤‡ä»½åŠŸèƒ½æ—¶æŠ¥é”™
- æç¤ºæœåŠ¡å®šä½å™¨å¼‚å¸¸

**æ£€æŸ¥æ–¹æ³•**:
æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œæ˜¯å¦æœ‰ä»¥ä¸‹é”™è¯¯:
```
Failed to initialize service locator: ...
```

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿åº”ç”¨æ­£å¸¸å¯åŠ¨å¹¶åˆå§‹åŒ–äº†æœåŠ¡å®šä½å™¨ã€‚

### 3. ç½‘ç»œè¿æ¥é—®é¢˜

**è¡¨ç°**:
- åˆ›å»ºå¤‡ä»½æ—¶é•¿æ—¶é—´æ— å“åº”
- è¶…æ—¶é”™è¯¯

**æ£€æŸ¥æ–¹æ³•**:
- æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿æ¥
- æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®
- æŸ¥çœ‹æ˜¯å¦æœ‰é˜²ç«å¢™æˆ–è¯ä¹¦é—®é¢˜

### 4. APIç«¯ç‚¹é…ç½®é”™è¯¯ âš ï¸ **å·²å‘ç°é…ç½®é—®é¢˜**

**é—®é¢˜**:
`app/lib/core/config/api_endpoints.dart` ä¸­å®šä¹‰çš„å¤‡ä»½ç«¯ç‚¹**ä¸æ­£ç¡®**:

```dart
// âŒ é”™è¯¯çš„ç«¯ç‚¹å®šä¹‰ï¼ˆç¬¬90-92è¡Œï¼‰
static const String backupCreate = '/backup/create';
static const String backupList = '/backup/list';
static const String backupRestore = '/backup/restore';
```

**å®é™…æœåŠ¡å™¨ç«¯ç‚¹**:
```python
# âœ… å®é™…çš„ç«¯ç‚¹ï¼ˆRESTfulé£æ ¼ï¼‰
POST   /api/v1/backup              # åˆ›å»ºå¤‡ä»½
GET    /api/v1/backup              # è·å–åˆ—è¡¨
GET    /api/v1/backup/{id}         # è·å–æŒ‡å®šå¤‡ä»½
POST   /api/v1/backup/{id}/restore # æ¢å¤å¤‡ä»½
DELETE /api/v1/backup/{id}         # åˆ é™¤å¤‡ä»½
```

**å½“å‰çŠ¶æ€**:
- âœ… BackupService **æ²¡æœ‰ä½¿ç”¨** api_endpoints.dart ä¸­çš„å¸¸é‡
- âœ… BackupService ç›´æ¥ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ (å¦‚ `/backup`)
- âš ï¸ api_endpoints.dart ä¸­çš„å®šä¹‰æ˜¯**é”™è¯¯çš„**ä½†**æœªè¢«ä½¿ç”¨**

**å»ºè®®ä¿®å¤**:
è™½ç„¶ä¸å½±å“åŠŸèƒ½ï¼Œä½†åº”è¯¥ä¿®æ­£ api_endpoints.dart ä»¥ä¿æŒä¸€è‡´æ€§:
```dart
// åº”è¯¥æ”¹ä¸º
static const String backup = '/backup';
static const String backupDetail = '/backup/{id}';
static const String backupRestore = '/backup/{id}/restore';
```

æˆ–è€…ç›´æ¥åˆ é™¤è¿™äº›æœªä½¿ç”¨çš„å¸¸é‡ã€‚

## ğŸ“‹ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€

1. æ‰“å¼€åº”ç”¨
2. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
3. å¦‚æœæœªç™»å½•ï¼Œå…ˆè¿›è¡Œç™»å½•
4. ç™»å½•åå°è¯•è®¿é—®å¤‡ä»½åŠŸèƒ½

### æ­¥éª¤2: æ£€æŸ¥ç½‘ç»œè¿æ¥

1. åœ¨åº”ç”¨ä¸­æµ‹è¯•å…¶ä»–éœ€è¦ç½‘ç»œçš„åŠŸèƒ½
2. ç¡®è®¤è®¾å¤‡å¯ä»¥è®¿é—® `https://39.105.12.124`
3. æ£€æŸ¥æ˜¯å¦æœ‰SSLè¯ä¹¦è­¦å‘Šï¼ˆåº”ç”¨é…ç½®äº†è·³è¿‡è¯ä¹¦éªŒè¯ï¼‰

### æ­¥éª¤3: æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

1. å°è¯•åˆ›å»ºå¤‡ä»½
2. å¦‚æœå¤±è´¥ï¼ŒæŸ¥çœ‹æ˜¾ç¤ºçš„é”™è¯¯æ¶ˆæ¯
3. å¸¸è§é”™è¯¯:
   - "Invalid or expired token" â†’ éœ€è¦é‡æ–°ç™»å½•
   - "Connection timeout" â†’ ç½‘ç»œé—®é¢˜
   - "æœåŠ¡å®šä½å™¨å¼‚å¸¸" â†’ åº”ç”¨åˆå§‹åŒ–é—®é¢˜

### æ­¥éª¤4: æŸ¥çœ‹åº”ç”¨æ—¥å¿—

åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œåº”ç”¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—:
```bash
flutter run
```

å…³æ³¨ä»¥ä¸‹æ—¥å¿—:
- `[HttpService] POST /backup` - HTTPè¯·æ±‚æ—¥å¿—
- `Service locator initialized` - æœåŠ¡åˆå§‹åŒ–æ—¥å¿—
- å¤‡ä»½æœåŠ¡ç›¸å…³çš„é”™è¯¯æ—¥å¿—

## ğŸ”§ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ç¡®ä¿ç”¨æˆ·ç™»å½•æµç¨‹

åœ¨å¤‡ä»½é¡µé¢å…¥å£æ·»åŠ ç™»å½•æ£€æŸ¥:

```dart
// backup_page.dart - åœ¨initStateä¸­
@override
void initState() {
  super.initState();
  _checkAuthAndLoadBackups();
}

Future<void> _checkAuthAndLoadBackups() async {
  final authState = ref.read(authProvider);
  if (!authState.isAuthenticated) {
    // è·³è½¬åˆ°ç™»å½•é¡µé¢
    if (mounted) {
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const LoginPage()),
      );
    }
    return;
  }

  await _loadBackups();
}
```

### æ–¹æ¡ˆ2: æ”¹è¿›é”™è¯¯æç¤º

åœ¨ BackupPage ä¸­æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†:

```dart
catch (e) {
  String errorMessage;
  if (e.toString().contains('Invalid or expired token')) {
    errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
  } else if (e.toString().contains('timeout')) {
    errorMessage = 'ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
  } else if (e.toString().contains('Service locator')) {
    errorMessage = 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡å¯åº”ç”¨';
  } else {
    errorMessage = 'å¤‡ä»½å¤±è´¥: $e';
  }

  setState(() {
    _error = errorMessage;
    _loading = false;
  });
}
```

### æ–¹æ¡ˆ3: æ·»åŠ é‡è¯•æœºåˆ¶

```dart
Future<void> _loadBackups({int retryCount = 0}) async {
  setState(() {
    _loading = true;
    _error = null;
  });

  try {
    final backups = await _backupService.listBackups();
    setState(() {
      _backups = backups;
      _loading = false;
    });
  } catch (e) {
    if (retryCount < 3) {
      // æœ€å¤šé‡è¯•3æ¬¡
      await Future.delayed(Duration(seconds: 1 << retryCount));
      return _loadBackups(retryCount: retryCount + 1);
    }

    setState(() {
      _error = e.toString();
      _loading = false;
    });
  }
}
```

## ğŸ“Š åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æœåŠ¡å™¨APIç«¯ç‚¹ | âœ… æ­£å¸¸ | 5ä¸ªç«¯ç‚¹å…¨éƒ¨å®ç°å¹¶æ³¨å†Œ |
| è·¯ç”±æ³¨å†Œ | âœ… æ­£å¸¸ | å·²æŒ‚è½½åˆ° /api/v1/backup |
| å®¢æˆ·ç«¯Service | âœ… æ­£å¸¸ | å®Œæ•´å®ç°æ‰€æœ‰åŠŸèƒ½ |
| ä¾èµ–æ³¨å…¥ | âœ… æ­£å¸¸ | æœåŠ¡å®šä½å™¨å·²é…ç½® |
| UIé¡µé¢ | âœ… æ­£å¸¸ | å®Œæ•´çš„CRUDç•Œé¢ |
| é”™è¯¯å¤„ç† | âœ… æ­£å¸¸ | æœ‰åŸºç¡€é”™è¯¯å¤„ç† |
| è®¤è¯è¦æ±‚ | âœ… æ­£å¸¸ | éœ€è¦ç™»å½•ï¼ˆç¬¦åˆå®‰å…¨è¦æ±‚ï¼‰ |
| ç½‘ç»œæµ‹è¯• | âœ… æ­£å¸¸ | ç«¯ç‚¹å¯è®¿é—® |

## ğŸ“ ç»“è®º

**å¤‡ä»½åŠŸèƒ½çš„å®ç°æ˜¯å®Œæ•´ä¸”æ­£ç¡®çš„ã€‚**

ç”¨æˆ·æŠ¥å‘Šçš„"ä¸å¯ç”¨"é—®é¢˜æœ€å¯èƒ½çš„åŸå› æ˜¯:

1. **ç”¨æˆ·æœªç™»å½•** (80%å¯èƒ½æ€§)
   - éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨å¤‡ä»½åŠŸèƒ½
   - è¿™æ˜¯æ­£å¸¸çš„å®‰å…¨æœºåˆ¶

2. **ç½‘ç»œè¿æ¥é—®é¢˜** (15%å¯èƒ½æ€§)
   - è®¾å¤‡æ— æ³•è®¿é—®æœåŠ¡å™¨
   - ç½‘ç»œè¶…æ—¶

3. **å…¶ä»–ä¸´æ—¶é—®é¢˜** (5%å¯èƒ½æ€§)
   - æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨
   - åº”ç”¨æœªæ­£ç¡®åˆå§‹åŒ–

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç¡®è®¤ç”¨æˆ·ç™»å½•çŠ¶æ€**
   - è®©ç”¨æˆ·å…ˆç™»å½•
   - ç™»å½•åå†å°è¯•å¤‡ä»½åŠŸèƒ½

2. **æµ‹è¯•å¤‡ä»½åŠŸèƒ½**
   - åˆ›å»ºä¸€ä¸ªæµ‹è¯•å¤‡ä»½
   - æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
   - å°è¯•æ¢å¤å¤‡ä»½

3. **æ”¶é›†é”™è¯¯ä¿¡æ¯**
   - å¦‚æœä»ç„¶å¤±è´¥ï¼Œè®°å½•å…·ä½“çš„é”™è¯¯æ¶ˆæ¯
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—

4. **å¯é€‰: ä¿®æ­£APIç«¯ç‚¹é…ç½®**
   - ä¿®æ­£ `api_endpoints.dart` ä¸­çš„å¤‡ä»½ç«¯ç‚¹å®šä¹‰
   - æˆ–åˆ é™¤æœªä½¿ç”¨çš„å¸¸é‡
   - è¿™ä¸å½±å“åŠŸèƒ½ï¼Œä½†å¯ä»¥æé«˜ä»£ç ä¸€è‡´æ€§

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-28
**è¯Šæ–­çŠ¶æ€**: âœ… å·²å®Œæˆ
**å»ºè®®**: é¦–å…ˆç¡®è®¤ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œç„¶åè¿›è¡ŒåŠŸèƒ½æµ‹è¯•
