# 快速发布指南 - v2.0.3

## 🚀 一键发布（最简单）

```bash
cd /Users/beihua/code/baiji/ai-bookkeeping

# 设置管理员密码（如果尚未设置）
export ADMIN_PASSWORD="你的管理员密码"

# 一键发布
./发布v2.0.3.sh
```

就这么简单！脚本会自动完成：
- ✅ 构建 Release APK
- ✅ 验证签名
- ✅ 登录管理后台
- ✅ 创建版本记录
- ✅ 上传APK到MinIO
- ✅ 自动发布

## 📝 版本信息

- **版本名**: 2.0.3
- **版本号**: 43
- **更新内容**: 修复密码找回邮件发送问题

## ⚙️ 自定义配置

如果需要修改服务器地址：

```bash
export API_BASE_URL="http://your-server:8000"
export ADMIN_USERNAME="admin"
export ADMIN_PASSWORD="your-password"

./发布v2.0.3.sh
```

## 🔧 手动发布（高级）

如果需要更多控制，可以直接使用底层脚本：

```bash
# 构建并自动发布
ADMIN_PASSWORD="xxx" ./scripts/publish_apk.sh \
  --version 2.0.3 \
  --code 43 \
  --notes "- 修复密码找回邮件发送问题" \
  --build \
  --publish

# 或者分步操作：

# 1. 先构建APK
cd app
flutter clean
flutter pub get
flutter build apk --release

# 2. 然后发布（不构建）
cd ..
ADMIN_PASSWORD="xxx" ./scripts/publish_apk.sh \
  --version 2.0.3 \
  --code 43 \
  --apk ./app/build/app/outputs/flutter-apk/app-release.apk \
  --notes "- 修复密码找回邮件发送问题" \
  --publish
```

## 📋 完整参数说明

`publish_apk.sh` 支持以下参数：

```
必需参数:
  --version VERSION      版本名称 (例如: 2.0.3)
  --code CODE           版本号 (例如: 43)
  --notes NOTES         更新说明

可选参数:
  --apk PATH            指定APK文件路径
  --build               构建APK（不指定--apk时必需）
  --publish             创建后自动发布
  --force               标记为强制更新
  --notes-en NOTES      英文更新说明
  --min-version VER     最低支持版本
  --skip-signature-check  跳过签名验证（不推荐）

环境变量:
  API_BASE_URL          服务器地址 (默认: https://160.202.238.29)
  ADMIN_USERNAME        管理员用户名 (默认: admin)
  ADMIN_PASSWORD        管理员密码 (必需)
  FLUTTER_CMD           Flutter命令路径
  APP_DIR               App目录路径
```

## 🔍 发布步骤详解

脚本会自动执行以下步骤：

1. **[可选] 构建APK** (如果使用 `--build`)
   - 更新 build_info.dart
   - Flutter clean
   - Flutter pub get
   - Flutter build apk --release --no-tree-shake-icons

2. **验证签名**
   - 使用 apksigner 验证APK签名
   - 确保使用正确的Release证书
   - 防止发布Debug版本

3. **登录管理后台**
   - 使用管理员凭据登录
   - 获取访问Token

4. **创建版本记录**
   - 在数据库中创建版本记录（草稿状态）

5. **上传APK**
   - 上传APK到MinIO对象存储

6. **发布版本** (如果使用 `--publish`)
   - 将版本状态改为"已发布"
   - 用户可见并可下载

## 🐛 故障排查

### 问题1: 签名验证失败

```
✗ 错误: APK 使用了 Debug 证书签名！
```

**解决**: 确保使用 `flutter build apk --release` 构建

### 问题2: 找不到apksigner

```
⚠ 警告: 未找到 apksigner 工具
```

**解决**: 安装 Android SDK Build Tools

### 问题3: 登录失败

```
登录失败: {"detail":"Incorrect credentials"}
```

**解决**: 检查管理员密码是否正确

### 问题4: 上传失败

```
APK 上传失败
```

**解决**:
- 检查网络连接
- 确认MinIO服务运行正常
- 检查服务器地址是否正确

## 📊 预期输出

成功发布后会看到：

```
========================================
APK 一键发布脚本
========================================

版本号: 2.0.3
构建号: 43
构建 APK: true
强制更新: false
API 地址: http://160.202.238.29

[1/6] 构建 Release APK...
✓ 构建成功: app-release.apk (23.4 MB)

[2/6] 验证 APK 签名...
✓ 签名验证通过: 使用正确的 Release 证书

[3/6] 登录管理后台...
✓ 登录成功

[4/6] 创建版本记录...
✓ 版本创建成功: [UUID]

[5/6] 上传 APK 文件...
✓ APK 上传成功 (23.4 MB)

[6/6] 发布版本...
✓ 版本发布成功

========================================
发布完成!
========================================

版本 ID: [UUID]
版本号: 2.0.3+43
状态: 已发布
```

## ✅ 发布后验证

1. **检查管理后台**
   - 访问管理后台查看版本列表
   - 确认版本状态为"已发布"

2. **测试应用内更新**
   - 在旧版本APP中检查更新
   - 确认能看到新版本
   - 测试下载和安装

3. **验证新功能**
   - 测试密码找回功能
   - 确认能收到验证码邮件

## 💡 提示

- 首次使用建议不加 `--publish`，先创建草稿，手动检查后再发布
- 使用 `--force` 参数可以强制用户更新（谨慎使用）
- 发布前建议在测试设备上验证APK
- 保留APK文件用于未来的增量更新

## 🔗 相关文档

- [发布脚本源码](./scripts/publish_apk.sh)
- [版本发布说明](./RELEASE_NOTES_2.0.3.md)
- [管理后台文档](./server/admin/README.md)
