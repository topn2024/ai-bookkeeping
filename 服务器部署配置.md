# AI Bookkeeping 服务器部署配置

## 服务器信息

### 生产服务器
- **IP 地址**: 160.202.238.29
- **Root 账号**: root / 65QLkJ0CogNI
- **应用用户**: ai-bookkeeping（非特权用户，由 setup.sh 创建）

### 应用架构

```
                         Internet
                            │
                      ┌─────┴─────┐
                      │   Nginx   │
                      │  :80/:443 │
                      └─────┬─────┘
                            │
           ┌────────────────┼────────────────┐
           │                │                │
           ▼                ▼                ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │  API :8000  │  │  API :8001  │  │ Admin :8002 │
    │   (主实例)   │  │   (备份)    │  │             │
    └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
           │                │                │
           └────────────────┼────────────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │PostgreSQL│  │  Redis   │  │  MinIO   │
        │  :5432   │  │  :6379   │  │  :9000   │
        └──────────┘  └──────────┘  └──────────┘
```

## 服务器端配置

### 数据库配置（PostgreSQL）
- **类型**: PostgreSQL
- **地址**: localhost（在服务器本地运行）
- **端口**: 5432（标准端口）
- **数据库名**: ai_bookkeeping
- **用户**: ai_bookkeeping
- **密码**: 需要在服务器上配置

### Redis 配置
- **地址**: localhost
- **端口**: 6379
- **密码**: 可选

### MinIO 配置（对象存储）
- **地址**: localhost
- **端口**: 9000
- **用途**: 文件上传存储

## 部署目录结构

```
/home/ai-bookkeeping/
├── app/                    # 应用代码（Git 仓库）
│   ├── server/            # 后端代码
│   │   ├── app/           # 主 API
│   │   ├── admin/         # Admin API
│   │   ├── migrations/    # 数据库迁移
│   │   └── .env           # 环境变量配置
│   └── admin-web/         # Admin 前端
├── venv/                   # Python 虚拟环境
├── backups/               # 部署备份
└── logs/                  # 应用日志
```

## 环境变量配置（.env）

### 本地开发环境
文件位置: `/Users/beihua/code/baiji/ai-bookkeeping/server/.env`

```bash
# App Configuration
APP_NAME=AI Bookkeeping
DEBUG=true  # 开发环境设为 true
SECRET_KEY=MZiYJzmoFNfIW47Q6P9Jcb8rmsCtmAwA9bPjPAigBBo

# Database (PostgreSQL)
# 本地开发：如果有本地数据库则使用 localhost，否则可以 SSH 隧道连接服务器
DATABASE_URL=postgresql+asyncpg://ai_bookkeeping:your-password@localhost:5432/ai_bookkeeping

# Redis
REDIS_URL=redis://localhost:6379/0

# JWT Authentication
JWT_SECRET_KEY=9yOjtx5AE0mk5i08VuFK3CFjsIQ9O7IhQvdeNVUxTIQ
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# MinIO Object Storage
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=your-minio-access-key
MINIO_SECRET_KEY=your-minio-secret-key
MINIO_BUCKET=ai-bookkeeping
MINIO_SECURE=false

# AI APIs
QWEN_API_KEY=your-qwen-api-key
ZHIPU_API_KEY=your-zhipu-api-key

# Logging
LOG_LEVEL=DEBUG  # 开发环境使用 DEBUG
```

### 生产环境配置
文件位置: `/home/ai-bookkeeping/app/server/.env`（在服务器上）

```bash
# App Configuration
APP_NAME=AI Bookkeeping
DEBUG=false  # 生产环境必须为 false
SECRET_KEY=<生产环境密钥>

# Database (PostgreSQL) - 本地连接
DATABASE_URL=postgresql+asyncpg://ai_bookkeeping:<password>@localhost:5432/ai_bookkeeping

# Redis - 本地连接
REDIS_URL=redis://localhost:6379/0

# JWT Authentication
JWT_SECRET_KEY=<生产环境 JWT 密钥>
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# MinIO Object Storage - 本地连接
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=<生产环境密钥>
MINIO_SECRET_KEY=<生产环境密钥>
MINIO_BUCKET=ai-bookkeeping
MINIO_SECURE=false

# AI APIs
QWEN_API_KEY=<生产环境密钥>
ZHIPU_API_KEY=<生产环境密钥>

# Logging
LOG_LEVEL=INFO  # 生产环境使用 INFO 或 WARNING
```

## 部署流程

### 首次部署

1. **初始化服务器**（使用 root 账号）
```bash
# 从本地上传初始化脚本
scp server/deploy/scripts/setup.sh root@160.202.238.29:/tmp/

# SSH 到服务器
ssh root@160.202.238.29

# 执行初始化脚本
chmod +x /tmp/setup.sh
/tmp/setup.sh
```

2. **部署代码**（切换到 ai-bookkeeping 用户）
```bash
# 切换用户
su - ai-bookkeeping

# 克隆代码
git clone https://github.com/topn2024/ai-bookkeeping.git /home/ai-bookkeeping/app

# 配置环境变量
cp /home/ai-bookkeeping/app/server/.env.example /home/ai-bookkeeping/app/server/.env
vim /home/ai-bookkeeping/app/server/.env

# 安装依赖
source /home/ai-bookkeeping/venv/bin/activate
pip install -r /home/ai-bookkeeping/app/server/requirements.txt

# 退出到 root
exit
```

3. **启动服务**（使用 root 账号）
```bash
# 启用并启动服务
systemctl enable ai-bookkeeping-api@8000
systemctl enable ai-bookkeeping-admin
systemctl start ai-bookkeeping-api@8000
systemctl start ai-bookkeeping-admin

# 检查服务状态
systemctl status ai-bookkeeping-api@8000
systemctl status ai-bookkeeping-admin

# 健康检查
curl http://localhost:8000/health
curl http://localhost:8002/health
```

### 后续更新部署

使用部署脚本（使用 root 或 ai-bookkeeping 用户）：

```bash
cd /home/ai-bookkeeping/app/server

# 完整部署（代码 + 数据库迁移）
./deploy/scripts/deploy.sh

# 仅部署代码，跳过迁移
./deploy/scripts/deploy.sh --code-only

# 仅数据库迁移
./deploy/scripts/deploy.sh --migrate-only

# 回滚到上一版本
./deploy/scripts/deploy.sh --rollback

# 查看服务状态
./deploy/scripts/deploy.sh --status
```

## 本地开发配置

### SSH 隧道（连接服务器数据库）

如果本地没有安装 PostgreSQL 和 Redis，可以通过 SSH 隧道连接服务器：

```bash
# 转发 PostgreSQL 端口
ssh -L 5432:localhost:5432 ai-bookkeeping@160.202.238.29 -N &

# 转发 Redis 端口
ssh -L 6379:localhost:6379 ai-bookkeeping@160.202.238.29 -N &

# 转发 MinIO 端口（如需要）
ssh -L 9000:localhost:9000 ai-bookkeeping@160.202.238.29 -N &
```

然后本地 .env 文件可以使用 localhost 连接。

### 启动本地开发服务器

```bash
cd /Users/beihua/code/baiji/ai-bookkeeping/server

# 配置环境变量
export PATH="$PATH:/Users/beihua/Library/Python/3.9/bin"

# 启动开发服务器（带热重载）
uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
```

### 启动管理后台（本地）

```bash
cd /Users/beihua/code/baiji/ai-bookkeeping/admin-web

# 开发模式
npm run dev

# 生产构建
npm run build
```

## 服务管理命令

### Systemd 服务管理

```bash
# 启动服务
systemctl start ai-bookkeeping-api@8000
systemctl start ai-bookkeeping-api@8001    # 备份实例
systemctl start ai-bookkeeping-admin

# 停止服务
systemctl stop ai-bookkeeping-api@8000

# 重启服务
systemctl restart ai-bookkeeping-api@8000

# 查看状态
systemctl status ai-bookkeeping-api@8000

# 查看日志
journalctl -u ai-bookkeeping-api@8000 -f
journalctl -u ai-bookkeeping-api@8000 --since today
```

### Nginx 管理

```bash
# 检查配置
nginx -t

# 重载配置（不中断连接）
systemctl reload nginx

# 查看日志
tail -f /var/log/nginx/ai-bookkeeping-api-access.log
tail -f /var/log/nginx/ai-bookkeeping-api-error.log
```

## 健康检查

```bash
# API 健康检查
curl http://localhost:8000/health
curl http://localhost:8001/health
curl http://localhost:8002/health

# 通过 Nginx 检查（HTTPS）
curl -k https://160.202.238.29/health

# 外部访问检查
curl -k https://160.202.238.29/api/v1/health
```

## 数据库管理

### 连接数据库

```bash
# 在服务器上
psql -U ai_bookkeeping -d ai_bookkeeping

# 从本地通过 SSH
ssh ai-bookkeeping@160.202.238.29 'psql -U ai_bookkeeping -d ai_bookkeeping'
```

### 数据库迁移

```bash
cd /home/ai-bookkeeping/app/server

# 激活虚拟环境
source /home/ai-bookkeeping/venv/bin/activate

# 查看当前迁移状态
alembic current

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

## 监控和日志

### 查看应用日志

```bash
# 实时查看日志
journalctl -u ai-bookkeeping-api@8000 -f

# 查看错误日志
journalctl -u ai-bookkeeping-api@8000 -p err

# 查看最近 100 行
journalctl -u ai-bookkeeping-api@8000 -n 100
```

### 查看系统资源

```bash
# CPU 和内存使用
htop

# 磁盘使用
df -h

# 查看端口监听
netstat -tlnp
ss -tlnp
```

## 故障排查

### 服务无法启动

```bash
# 查看详细错误
journalctl -u ai-bookkeeping-api@8000 -n 50

# 检查端口占用
netstat -tlnp | grep 8000

# 检查配置文件
cat /home/ai-bookkeeping/app/server/.env

# 检查权限
ls -la /home/ai-bookkeeping/app/server/
```

### 数据库连接失败

```bash
# 测试数据库连接
psql -U ai_bookkeeping -d ai_bookkeeping

# 检查 PostgreSQL 服务
systemctl status postgresql

# 检查数据库日志
journalctl -u postgresql -n 50
```

### Nginx 502 错误

```bash
# 检查后端服务是否运行
curl http://localhost:8000/health

# 检查 Nginx 错误日志
tail -f /var/log/nginx/ai-bookkeeping-api-error.log

# 重启服务
systemctl restart ai-bookkeeping-api@8000
```

## 安全注意事项

1. **永远不要将 .env 文件提交到 Git**
2. 生产环境必须设置 `DEBUG=false`
3. 定期更换密钥和密码
4. 使用强密码
5. 定期备份数据库
6. 监控日志和系统资源
7. 及时更新系统补丁

## 备份策略

### 数据库备份

```bash
# 手动备份
pg_dump -U ai_bookkeeping ai_bookkeeping | gzip > backup_$(date +%Y%m%d).sql.gz

# 恢复备份
gunzip -c backup.sql.gz | psql -U ai_bookkeeping ai_bookkeeping
```

### 代码备份

部署脚本会自动备份代码到 `/home/ai-bookkeeping/backups/`

## 总结

✅ 服务器：160.202.238.29
✅ 应用用户：ai-bookkeeping
✅ 数据库：PostgreSQL (localhost:5432)
✅ Redis：localhost:6379
✅ 服务端口：8000 (主API), 8001 (备份API), 8002 (Admin)
✅ Web访问：https://160.202.238.29

配置完成后，可以开始开发和部署工作！
