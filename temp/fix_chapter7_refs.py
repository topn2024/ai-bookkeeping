# -*- coding: utf-8 -*-
"""
修复第7章钱龄智能分析系统中的章节引用错误
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ============================================================
    # 修复1: 扩展层章节号 15 → 14 (位置增强是第14章)
    # ============================================================
    old_text1 = '│  扩展层（第15章，位置增强）                                                  │'
    new_text1 = '│  扩展层（第14章，位置增强）                                                  │'

    if old_text1 in content:
        content = content.replace(old_text1, new_text1)
        print("✓ 修复1: 扩展层章节号 15 → 14")
        changes += 1

    # ============================================================
    # 修复2: 容错层章节号 21 → 23 (异常处理是第23章)
    # ============================================================
    old_text2 = '│  容错层（第21章，异常处理）                                                  │'
    new_text2 = '│  容错层（第23章，异常处理）                                                  │'

    if old_text2 in content:
        content = content.replace(old_text2, new_text2)
        print("✓ 修复2: 容错层章节号 21 → 23")
        changes += 1

    # ============================================================
    # 修复3: 集成全景图第一行章节号修正
    # ============================================================
    old_text3 = '''│  ┌─────────────┐            ┌─────────────┐            ┌─────────────┐      │
│  │ 零基预算系统 │            │ 消费审视系统 │            │ 冲动消费防护 │      │
│  │  (第8章)    │            │  (第10章)    │            │  (第11章)    │      │
│  │             │            │             │            │             │      │
│  │ 钱龄反馈→   │            │ 钱龄作为    │            │ 低钱龄时    │      │
│  │ 预算调整    │            │ 审视指标    │            │ 触发预警    │      │
│  └──────┬──────┘            └──────┬──────┘            └──────┬──────┘      │'''

    new_text3 = '''│  ┌─────────────┐            ┌─────────────┐            ┌─────────────┐      │
│  │ 零基预算系统 │            │ 消费审视系统 │            │ 冲动消费防护 │      │
│  │  (第8章)    │            │ (第9章6.2节) │            │ (第9章6.3节) │      │
│  │             │            │             │            │             │      │
│  │ 钱龄反馈→   │            │ 钱龄作为    │            │ 低钱龄时    │      │
│  │ 预算调整    │            │ 审视指标    │            │ 触发预警    │      │
│  └──────┬──────┘            └──────┬──────┘            └──────┬──────┘      │'''

    if old_text3 in content:
        content = content.replace(old_text3, new_text3)
        print("✓ 修复3: 集成全景图第一行章节号（消费审视、冲动防护）")
        changes += 1

    # ============================================================
    # 修复4: 集成全景图第二行章节号修正
    # ============================================================
    old_text4 = '''│  ┌─────────────┐            ┌─────────────┐            ┌─────────────┐      │
│  │ 财务缓冲系统 │            │ 弹性激励系统 │            │ 伙伴化设计  │      │
│  │  (第12章)    │            │  (第15章)   │            │  (第4章)   │      │
│  │             │            │             │            │             │      │
│  │ 钱龄目标→   │            │ 钱龄提升→   │            │ 钱龄播报→   │      │
│  │ 储蓄规划    │            │ 成就奖励    │            │ 情感反馈    │      │
│  └─────────────┘            └─────────────┘            └─────────────┘      │'''

    new_text4 = '''│  ┌─────────────┐            ┌─────────────┐            ┌─────────────┐      │
│  │ 财务缓冲系统 │            │ 习惯培养系统 │            │ 伙伴化设计  │      │
│  │ (第9章6.4节) │            │  (第9章)    │            │  (第4章)   │      │
│  │             │            │             │            │             │      │
│  │ 钱龄目标→   │            │ 钱龄提升→   │            │ 钱龄播报→   │      │
│  │ 储蓄规划    │            │ 成就奖励    │            │ 情感反馈    │      │
│  └─────────────┘            └─────────────┘            └─────────────┘      │'''

    if old_text4 in content:
        content = content.replace(old_text4, new_text4)
        print("✓ 修复4: 集成全景图第二行章节号（财务缓冲、习惯培养）")
        changes += 1

    # ============================================================
    # 修复5: 扩展集成层章节号修正（含__TEMP__错误）
    # ============================================================
    old_text5 = '''│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 位置智能化  │  │  AI识别     │  │  数据联动    │  │  国际化     │        │
│  │  (第15章)   │  │  (第15章__TEMP__)   │  │  (第19章)   │  │  (第22章)   │        │
│  │             │  │             │  │             │  │             │        │
│  │ 场景钱龄    │  │ 交易→钱龄   │  │ 服务端同步   │  │ 多语言展示  │        │
│  │ 分维分析    │  │ 实时更新    │  │ 钱龄数据    │  │ 钱龄文案    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │'''

    new_text5 = '''│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 位置智能化  │  │  AI识别     │  │  数据联动    │  │  国际化     │        │
│  │  (第14章)   │  │  (第10章)   │  │  (第12章)   │  │  (第21章)   │        │
│  │             │  │             │  │             │  │             │        │
│  │ 场景钱龄    │  │ 交易→钱龄   │  │ 服务端同步   │  │ 多语言展示  │        │
│  │ 分维分析    │  │ 实时更新    │  │ 钱龄数据    │  │ 钱龄文案    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │'''

    if old_text5 in content:
        content = content.replace(old_text5, new_text5)
        print("✓ 修复5: 扩展集成层章节号（位置14、AI识别10、数据联动12、国际化21）")
        changes += 1

    # ============================================================
    # 修复6: 添加与新模块的集成说明（家庭账本、语音交互、用户增长）
    # ============================================================
    old_text6 = '''**集成触发点**：

| 触发事件 | 集成动作 | 涉及系统 |
|----------|----------|----------|
| 新增收入 | 创建资源池，更新钱龄统计 | 资源池管理器 |
| 新增支出 | FIFO消费资源池，计算单笔钱龄 | 所有集成系统 |
| 钱龄等级变化 | 触发预警/庆祝，更新成就 | 冲动防护、弹性激励、伙伴化 |
| 周期结算 | 生成钱龄报告，调整预算建议 | 零基预算、消费审视 |
| 目标达成 | 发放奖励，更新进度 | 弹性激励、财务缓冲 |'''

    new_text6 = '''**集成触发点**：

| 触发事件 | 集成动作 | 涉及系统 |
|----------|----------|----------|
| 新增收入 | 创建资源池，更新钱龄统计 | 资源池管理器 |
| 新增支出 | FIFO消费资源池，计算单笔钱龄 | 所有集成系统 |
| 钱龄等级变化 | 触发预警/庆祝，更新成就 | 冲动防护(9章)、习惯培养(9章)、伙伴化(4章) |
| 周期结算 | 生成钱龄报告，调整预算建议 | 零基预算(8章)、消费审视(9章) |
| 目标达成 | 发放奖励，更新进度 | 习惯培养(9章)、财务缓冲(9章) |
| 家庭成员记账 | 更新家庭钱龄统计 | 家庭账本(13章) |
| 语音查询钱龄 | 返回钱龄播报文案 | 语音交互(18章) |
| 钱龄里程碑 | 触发分享引导 | 用户增长(28-29章) |'''

    if old_text6 in content:
        content = content.replace(old_text6, new_text6)
        print("✓ 修复6: 添加新模块集成触发点（家庭账本、语音交互、用户增长）")
        changes += 1

    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== 第7章章节引用修复完成，共 {changes} 处 =====")
    else:
        print("\n未找到目标位置或已修复")

    return changes

if __name__ == '__main__':
    main()
