# -*- coding: utf-8 -*-
"""
更新第15章中的自学习相关内容，添加对第16章的引用
同时简化第15章中的自学习内容，避免重复
"""

import re

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    # 1. 更新 15.2.4 反馈学习闭环系统 - 添加引用说明
    old_text = '''#### 15.2.4 反馈学习闭环系统

反馈学习是智能分类系统持续优化的核心机制，通过"用户修正→规则沉淀→精度提升→成本降低"的闘环实现自我进化。'''

    new_text = '''#### 15.2.4 反馈学习闭环系统

反馈学习是智能分类系统持续优化的核心机制，通过"用户修正→规则沉淀→精度提升→成本降低"的闭环实现自我进化。

> **📚 模块化设计说明**
>
> 智能分类的反馈学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。
> 本节描述分类场景下的具体应用，底层学习机制详见16.1节（统一自学习框架）和16.3.1节（智能分类学习适配器）。'''

    if old_text in content:
        content = content.replace(old_text, new_text)
        print("✅ 更新 15.2.4 反馈学习说明")

    # 2. 更新 15.3.2 预算建议自学习系统
    old_budget = '#### 15.3.2 预算建议自学习系统'
    new_budget = '''#### 15.3.2 预算建议自学习系统

> **📚 模块化设计说明**
>
> 预算建议的自学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。
> 具体实现请参见16.3.2节（预算建议学习适配器）。'''

    if old_budget in content:
        # 只替换第一次出现
        content = content.replace(old_budget, new_budget, 1)
        print("✅ 更新 15.3.2 预算建议自学习说明")

    # 3. 更新 15.5.2 异常检测自学习系统
    old_anomaly = '#### 15.5.2 异常检测自学习系统'
    new_anomaly = '''#### 15.5.2 异常检测自学习系统

> **📚 模块化设计说明**
>
> 异常检测的自学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。
> 具体实现请参见16.3.3节（异常检测学习适配器）。'''

    if old_anomaly in content:
        content = content.replace(old_anomaly, new_anomaly, 1)
        print("✅ 更新 15.5.2 异常检测自学习说明")

    # 4. 更新 15.6.2 搜索自学习系统
    old_search = '#### 15.6.2 搜索自学习系统'
    new_search = '''#### 15.6.2 搜索自学习系统

> **📚 模块化设计说明**
>
> 搜索的自学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。'''

    if old_search in content:
        content = content.replace(old_search, new_search, 1)
        print("✅ 更新 15.6.2 搜索自学习说明")

    # 5. 更新 15.7.2 对话助手自学习系统
    old_dialog = '#### 15.7.2 对话助手自学习系统'
    new_dialog = '''#### 15.7.2 对话助手自学习系统

> **📚 模块化设计说明**
>
> 对话助手的自学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。'''

    if old_dialog in content:
        content = content.replace(old_dialog, new_dialog, 1)
        print("✅ 更新 15.7.2 对话助手自学习说明")

    # 6. 更新 15.12.1.1 意图识别自学习模型的引用
    old_intent = '''#### 15.12.1.1 意图识别自学习模型

意图识别系统支持从用户使用行为中持续学习，自动适应用户的表达习惯。'''

    new_intent = '''#### 15.12.1.1 意图识别自学习模型

> **📚 模块化设计说明**
>
> 意图识别的自学习能力基于**第16章 自学习与协同学习系统**提供的统一框架实现。
> 本节描述语音意图场景下的具体应用，底层学习机制详见16.1节和16.3.4节。

意图识别系统支持从用户使用行为中持续学习，自动适应用户的表达习惯。'''

    if old_intent in content:
        content = content.replace(old_intent, new_intent)
        print("✅ 更新 15.12.1.1 意图识别自学习说明")

    # 7. 更新 15.12.1.1.8 统一自学习框架 - 简化为引用
    # 找到这个section并添加引用说明
    old_unified = '''##### 15.12.1.1.8 统一自学习框架（可复用）'''
    new_unified = '''##### 15.12.1.1.8 统一自学习框架（可复用）

> **📚 重要说明**
>
> 统一自学习框架已抽取为独立的**第16章 自学习与协同学习系统**。
> 以下内容保留作为历史参考，完整的框架设计请参见第16章。'''

    if old_unified in content:
        content = content.replace(old_unified, new_unified)
        print("✅ 更新 15.12.1.1.8 统一自学习框架说明")

    # 8. 更新目录中的章节编号（如果还有遗漏）
    # 检查并修复目录
    toc_fixes = [
        ('- [17. 性能设计与优化](#16-性能设计与优化)', '- [17. 性能设计与优化](#17-性能设计与优化)'),
        ('- [18. 用户体验设计](#17-用户体验设计)', '- [18. 用户体验设计](#18-用户体验设计)'),
        ('- [19. 国际化与本地化](#18-国际化与本地化)', '- [19. 国际化与本地化](#19-国际化与本地化)'),
        ('- [20. 安全与隐私](#19-安全与隐私)', '- [20. 安全与隐私](#20-安全与隐私)'),
        ('- [21. 异常处理与容错设计](#20-异常处理与容错设计)', '- [21. 异常处理与容错设计](#21-异常处理与容错设计)'),
        ('- [22. 可扩展性与演进架构](#21-可扩展性与演进架构)', '- [22. 可扩展性与演进架构](#22-可扩展性与演进架构)'),
        ('- [23. 可观测性与监控](#22-可观测性与监控)', '- [23. 可观测性与监控](#23-可观测性与监控)'),
        ('- [24. 版本迁移策略](#23-版本迁移策略)', '- [24. 版本迁移策略](#24-版本迁移策略)'),
        ('- [25. 实施路线图](#24-实施路线图)', '- [25. 实施路线图](#25-实施路线图)'),
    ]

    for old, new in toc_fixes:
        if old in content:
            content = content.replace(old, new)

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

    print("\n✅ 自学习引用更新完成！")

if __name__ == '__main__':
    main()
