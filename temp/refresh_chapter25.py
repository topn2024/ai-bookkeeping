# -*- coding: utf-8 -*-
"""
刷新第25章可观测性与监控
1. 添加25.0设计原则回顾
2. 修复图中章节引用错误
3. 添加25.9与其他系统集成
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修复图中章节引用 ==========
    ref_fixes = [
        # 修复"第5章"引用为"第25章"
        ('│                    │   第5章        │                                  │',
         '│                    │   第25章       │                                  │'),
        ('│                    │ 可观测性与监控  │                                  │',
         '│                    │ 可观测性与监控 │                                  │'),
        # 修复与其他章节关系图中的章节引用
        ('│  │  第10章      │      │  第21章     │      │  第22章     │             │',
         '│  │  第16章      │      │  第23章     │      │  第24章     │             │'),
        ('│  │  AI识别     │─────►│  异常处理   │─────►│  架构演进   │             │',
         '│  │  智能化     │─────►│  异常处理   │─────►│  可扩展性   │             │'),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix ref: ...{old[20:50]}...")
            changes += 1

    # ========== 修复2: 添加25.0设计原则回顾 ==========
    section_25_1_marker = '### 25.1 可观测性系统总览'

    new_section_25_0 = '''### 25.0 设计原则回顾

```
+------------------------------------------------------------------------------+
|                         可观测性与监控设计原则                                  |
+------------------------------------------------------------------------------+
|                                                                              |
|  +------------------------------------------------------------------------+  |
|  |  可观测性三支柱                                                         |  |
|  |  --------------------------------------------------------------------  |  |
|  |  * 日志(Logging)：结构化日志，分级输出，支持远程收集                     |  |
|  |  * 指标(Metrics)：性能指标、业务指标、系统指标全覆盖                     |  |
|  |  * 追踪(Tracing)：分布式追踪，请求链路完整可视                          |  |
|  +------------------------------------------------------------------------+  |
|                                                                              |
|  +------------------------------------------------------------------------+  |
|  |  离线优先原则                                                           |  |
|  |  --------------------------------------------------------------------  |  |
|  |  * 本地缓存：离线状态下数据采集不中断                                   |  |
|  |  * 批量上报：网络恢复后智能批量上报                                     |  |
|  |  * 数据压缩：减少网络传输开销                                           |  |
|  |  * 采样策略：高频数据智能采样降低存储                                   |  |
|  +------------------------------------------------------------------------+  |
|                                                                              |
|  +------------------------------------------------------------------------+  |
|  |  2.0版本新增能力                                                        |  |
|  |  --------------------------------------------------------------------  |  |
|  |  核心监控：钱龄计算追踪、预算执行监控、小金库状态                        |  |
|  |  AI监控：语音识别准确率、图片OCR成功率、智能分类效果                     |  |
|  |  体验监控：端侧性能（帧率/内存/启动时间）、用户行为追踪                  |  |
|  |  业务洞察：功能使用统计、转化漏斗、用户留存                              |  |
|  +------------------------------------------------------------------------+  |
|                                                                              |
+------------------------------------------------------------------------------+
```

#### 25.0.1 可观测性设计原则矩阵

| 设计原则 | 实现方式 | 优先级 |
|----------|----------|--------|
| 全面性 | 日志/指标/追踪三支柱全覆盖 | P0 |
| 离线支持 | SQLite本地缓存+批量上报 | P0 |
| 低开销 | 采样策略+异步上报 | P0 |
| 可扩展 | 插件化采集器设计 | P1 |
| 隐私保护 | 敏感数据脱敏处理 | P0 |
| 实时性 | 关键指标秒级更新 | P1 |

#### 25.0.2 可观测性模块协作图

```
+------------------------------------------------------------------------+
|                    可观测性与监控模块协作图                               |
+------------------------------------------------------------------------+
|                                                                        |
|        +-------------+      +-------------+      +-------------+       |
|        |   钱龄系统   |      |  零基预算   |      |   小金库    |       |
|        |   (第7章)   |      |   (第8章)   |      |   (第9章)   |       |
|        +------+------+      +------+------+      +------+------+       |
|               |                    |                    |              |
|               +--------------------+--------------------+              |
|                                    |                                   |
|                           [业务指标采集]                                |
|                                    |                                   |
|                                    v                                   |
|                    +-------------------------------+                   |
|                    |     第25章 可观测性与监控      |                   |
|                    |  +-------------------------+  |                   |
|                    |  | 日志  | 指标  | 追踪    |  |                   |
|                    |  +-------------------------+  |                   |
|                    +---------------+---------------+                   |
|                                    |                                   |
|         +--------------------------+-------------------------+         |
|         |                          |                         |         |
|         v                          v                         v         |
|  +-------------+           +-------------+           +-------------+   |
|  |  语音交互   |           |   位置智能   |           |   自学习    |   |
|  |  (第18章)   |           |   (第14章)   |           |   (第17章)  |   |
|  +-------------+           +-------------+           +-------------+   |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 25.0.3 与2.0其他系统的协同关系

| 集成系统 | 监控内容 | 章节 |
|----------|----------|------|
| 钱龄系统 | 钱龄计算耗时、FIFO队列状态 | 第7章 |
| 零基预算 | 预算执行率、超支告警 | 第8章 |
| 小金库 | 余额变动、自动转入状态 | 第9章 |
| 智能化 | AI识别准确率、模型调用延迟 | 第16章 |
| 自学习 | 学习效果、模型更新 | 第17章 |
| 语音交互 | 识别成功率、响应时间 | 第18章 |
| 位置智能 | 定位精度、场景识别率 | 第14章 |
| 家庭账本 | 同步延迟、冲突率 | 第13章 |

'''

    if section_25_1_marker in content:
        content = content.replace(section_25_1_marker, new_section_25_0 + section_25_1_marker)
        print("OK: Added 25.0 design principle review")
        changes += 1
    else:
        print("SKIP: 25.1 marker not found")

    # ========== 修复3: 添加25.9与其他系统集成 ==========
    chapter26_marker = '## 26. 版本迁移策略'

    new_section_25_9 = '''### 25.9 与其他系统集成

#### 25.9.1 系统集成概览

可观测性系统为所有2.0模块提供统一的监控能力：

```
+------------------------------------------------------------------------+
|                      可观测性与监控集成全景图                             |
+------------------------------------------------------------------------+
|                                                                        |
|  +------------------------------------------------------------------+  |
|  |                        可观测性核心服务                            |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  |  | 日志服务  |  | 指标服务  |  | 追踪服务  |  | 告警服务  |          |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  +-------------------------------+----------------------------------+  |
|                                  |                                     |
|         +------------------------+------------------------+            |
|         |                        |                        |            |
|         v                        v                        v            |
|  +-------------+          +-------------+          +-------------+     |
|  |  核心业务    |          |  智能服务    |          |  2.0新增    |     |
|  |  监控集成    |          |  监控集成    |          |  监控集成    |     |
|  +-------------+          +-------------+          +-------------+     |
|  | * 交易监控   |          | * AI识别    |          | * 语音记账   |     |
|  | * 预算监控   |          | * 智能分类   |          | * 位置智能   |     |
|  | * 钱龄监控   |          | * 洞察生成   |          | * 家庭同步   |     |
|  +-------------+          +-------------+          +-------------+     |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 25.9.2 钱龄系统监控集成

钱龄系统专项监控指标：

| 监控指标 | 类型 | 告警阈值 | 说明 |
|----------|------|----------|------|
| money_age_calc_duration | 耗时 | >500ms | 钱龄计算耗时 |
| fifo_queue_size | 计数 | >10000 | FIFO队列大小 |
| money_age_accuracy | 百分比 | <99% | 钱龄计算准确率 |
| aged_money_ratio | 百分比 | >30% | 超龄资金比例 |

#### 25.9.3 AI识别监控集成

AI服务专项监控指标：

| 监控指标 | 类型 | 告警阈值 | 说明 |
|----------|------|----------|------|
| voice_recognition_success_rate | 百分比 | <95% | 语音识别成功率 |
| image_ocr_success_rate | 百分比 | <90% | 图片OCR成功率 |
| ai_classification_accuracy | 百分比 | <85% | 智能分类准确率 |
| ai_response_latency_p99 | 耗时 | >3s | AI响应P99延迟 |

#### 25.9.4 位置服务监控集成

位置智能监控指标：

| 监控指标 | 类型 | 告警阈值 | 说明 |
|----------|------|----------|------|
| location_accuracy | 米 | >100m | 定位精度 |
| poi_match_rate | 百分比 | <80% | POI匹配率 |
| scene_recognition_rate | 百分比 | <75% | 场景识别率 |
| geofence_trigger_delay | 耗时 | >5s | 地理围栏触发延迟 |

#### 25.9.5 家庭账本监控集成

家庭账本同步监控：

| 监控指标 | 类型 | 告警阈值 | 说明 |
|----------|------|----------|------|
| sync_latency | 耗时 | >10s | 同步延迟 |
| conflict_rate | 百分比 | >5% | 冲突率 |
| member_active_ratio | 百分比 | <50% | 成员活跃率 |
| shared_transaction_ratio | 百分比 | - | 共享交易比例 |

#### 25.9.6 端侧性能监控集成

移动端性能专项监控：

| 监控指标 | 类型 | 告警阈值 | 说明 |
|----------|------|----------|------|
| app_cold_start_time | 耗时 | >3s | 冷启动时间 |
| frame_rate_p50 | FPS | <55 | 帧率P50 |
| memory_usage_peak | MB | >300 | 内存峰值 |
| anr_rate | 百分比 | >0.1% | ANR率 |
| crash_rate | 百分比 | >0.5% | 崩溃率 |

---

'''

    if chapter26_marker in content:
        content = content.replace(chapter26_marker, new_section_25_9 + chapter26_marker)
        print("OK: Added 25.9 integration section")
        changes += 1
    else:
        print("SKIP: Chapter 26 marker not found")

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 25 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
