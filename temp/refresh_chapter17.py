# -*- coding: utf-8 -*-
"""
刷新第17章自学习与协同学习系统
1. 修正图中章节引用
2. 扩展17.5与其他系统集成
3. 添加17.7与其他系统集成扩展（2.0新模块）
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修正图中章节引用 ==========
    ref_fixes = [
        # 修正习惯培养系统章节号 (9→11)
        ('│  9. 习惯培养系统  │',
         '│ 11. 习惯培养系统  │'),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix ref: {old} -> {new}")
            changes += 1

    # ========== 修复2: 在17.6之前添加17.5的扩展内容 ==========
    marker_17_6 = '### 17.6 目标达成检测'

    new_section_17_5_ext = '''#### 17.5.3 2.0新模块学习集成

自学习系统与2.0新增模块的集成：

```
+------------------------------------------------------------------------+
|                      自学习系统与2.0模块集成全景图                        |
+------------------------------------------------------------------------+
|                                                                        |
|  +------------------------------------------------------------------+  |
|  |                        自学习核心引擎                              |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  |  | 样本采集  |  | 模型训练  |  | 规则生成  |  | 效果评估  |          |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  +-------------------------------+----------------------------------+  |
|                                  |                                     |
|         +------------------------+------------------------+            |
|         |                        |                        |            |
|         v                        v                        v            |
|  +-------------+          +-------------+          +-------------+     |
|  |  核心业务    |          |  智能服务    |          |  2.0新增    |     |
|  |  学习适配    |          |  学习适配    |          |  学习适配    |     |
|  +-------------+          +-------------+          +-------------+     |
|  | * 分类学习   |          | * 意图学习   |          | * 位置学习   |     |
|  | * 预算学习   |          | * 搜索学习   |          | * 家庭学习   |     |
|  | * 异常学习   |          | * 对话学习   |          | * 习惯学习   |     |
|  +-------------+          +-------------+          +-------------+     |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 17.5.4 位置智能学习集成

与第14章位置智能的学习集成：

| 学习场景 | 学习内容 | 学习效果 |
|----------|----------|----------|
| POI分类修正 | 用户修正商家分类 | 提升POI分类准确率 |
| 场景识别反馈 | 用户确认/否定场景 | 优化场景识别模型 |
| 消费偏好学习 | 常去地点消费习惯 | 个性化消费预测 |
| 地理围栏优化 | 用户行为触发反馈 | 优化围栏触发精度 |

#### 17.5.5 家庭账本学习集成

与第13章家庭账本的学习集成：

| 学习场景 | 学习内容 | 学习效果 |
|----------|----------|----------|
| 共享分类优化 | 家庭成员分类习惯 | 统一家庭分类规则 |
| 预算模式学习 | 家庭消费模式 | 优化家庭预算建议 |
| 权限偏好学习 | 成员权限使用习惯 | 智能权限推荐 |
| 冲突解决学习 | 冲突解决偏好 | 自动冲突处理 |

#### 17.5.6 语音交互学习集成

与第18章语音交互的学习集成：

| 学习场景 | 学习内容 | 学习效果 |
|----------|----------|----------|
| 意图识别修正 | 用户修正识别意图 | 提升意图识别率 |
| 实体提取优化 | 用户修正金额/分类 | 优化实体提取 |
| 语音习惯学习 | 用户常用表述 | 建立个人词典 |
| 对话偏好学习 | 用户交互风格 | 个性化对话 |

#### 17.5.7 习惯培养学习集成

与第11章习惯培养的学习集成：

| 学习场景 | 学习内容 | 学习效果 |
|----------|----------|----------|
| 行为模式学习 | 用户记账规律 | 优化提醒时机 |
| 激励偏好学习 | 有效激励方式 | 个性化激励 |
| 目标调整学习 | 目标完成反馈 | 合理目标建议 |
| 挑战难度学习 | 挑战完成率 | 自适应难度 |

'''

    if marker_17_6 in content and '#### 17.5.3 2.0新模块学习集成' not in content:
        content = content.replace(marker_17_6, new_section_17_5_ext + marker_17_6)
        print("OK: Added 17.5.3-17.5.7 integration sections")
        changes += 1

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 17 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
