# -*- coding: utf-8 -*-
"""
更新第6章剩余章节：6.2.2, 6.2.4, 6.2.5, 6.3, 6.4, 6.5
基于最新的目录结构更新章节引用
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ============================================================
    # 更新1: 6.2.4 功能特性依赖矩阵 - 添加新模块
    # ============================================================
    old_dependency_matrix = '''#### 6.2.4 功能特性依赖矩阵

| 功能模块 | 依赖的模块 | 被依赖的模块 | 数据流向 |
|---------|-----------|-------------|---------|
| AI智能识别 | 智能化技术方案 | 交易记录、钱龄、预算 | 入口 → 核心 |
| 钱龄分析 | 交易记录、精确位置 | 习惯培养、仪表盘、伙伴化 | 核心 → 展示 |
| 零基预算 | 交易记录、精确位置 | 习惯培养、预警、伙伴化 | 核心 → 监控 |
| 小金库 | 交易记录、预算 | 习惯培养、统计、伙伴化 | 核心 → 展示 |
| 精确位置 | GPS、POI服务 | 钱龄、预算、省钱建议 | 底层 → 核心 |
| 习惯培养 | 钱龄、预算、小金库 | 成就系统、任务推荐、伙伴化 | 核心 → 激励 |
| 数据可视化 | 所有业务数据 | 用户界面 | 核心 → 展示 |
| **可观测性** | 所有业务模块 | 运维、告警、分析 | 全链路 → 监控 |
| **无障碍设计** | 用户界面层 | 所有用户交互 | 横切 → 全局 |
| **懒人设计** | 用户行为数据 | 所有交互流程 | 横切 → 全局 |
| **伙伴化设计** | 钱龄、预算、习惯 | 文案、提醒、激励 | 横切 → 全局 |'''

    new_dependency_matrix = '''#### 6.2.4 功能特性依赖矩阵

| 功能模块 | 章节 | 依赖的模块 | 被依赖的模块 | 数据流向 |
|---------|------|-----------|-------------|---------|
| AI智能识别 | 10章 | 智能化技术方案(16章) | 交易记录、钱龄、预算 | 入口 → 核心 |
| 钱龄分析 | 7章 | 交易记录、精确位置(14章) | 习惯培养、仪表盘、伙伴化 | 核心 → 展示 |
| 零基预算 | 8章 | 交易记录、精确位置(14章) | 习惯培养、预警、伙伴化 | 核心 → 监控 |
| 小金库 | 8章 | 交易记录、预算 | 习惯培养、统计、伙伴化 | 核心 → 展示 |
| 精确位置 | 14章 | GPS、POI服务 | 钱龄、预算、省钱建议 | 底层 → 核心 |
| 习惯培养 | 9章 | 钱龄、预算、小金库 | 成就系统、任务推荐、伙伴化 | 核心 → 激励 |
| 数据可视化 | 12章 | 所有业务数据 | 用户界面 | 核心 → 展示 |
| **家庭账本** | 13章 | 用户管理、预算系统 | 成员协作、共享预算 | 核心 → 协作 |
| **语音交互** | 18章 | AI识别(10章)、自学习(17章) | 快速记账、查询报表 | 入口 → 核心 |
| **自学习系统** | 17章 | 用户行为、交易数据 | AI识别、智能分类 | 数据 → 模型 |
| **数据导入导出** | 11章 | 交易记录、账户 | 数据迁移、备份 | 核心 ↔ 外部 |
| **可观测性** | 25章 | 所有业务模块 | 运维、告警、分析 | 全链路 → 监控 |
| **无障碍设计** | 5章 | 用户界面层 | 所有用户交互 | 横切 → 全局 |
| **懒人设计** | 3章 | 用户行为数据 | 所有交互流程 | 横切 → 全局 |
| **伙伴化设计** | 4章 | 钱龄、预算、习惯 | 文案、提醒、激励 | 横切 → 全局 |
| **用户口碑** | 28章 | 习惯培养、成就系统 | NPS提升、分享引导 | 核心 → 增长 |
| **自然增长** | 29章 | 用户口碑、社交 | 邀请裂变、ASO | 增长 → 获客 |'''

    if old_dependency_matrix in content:
        content = content.replace(old_dependency_matrix, new_dependency_matrix)
        print("✓ 更新1: 6.2.4功能特性依赖矩阵")
        changes += 1

    # ============================================================
    # 更新2: 6.2.5 设计原则横切关系 - 添加性能设计、安全隐私等
    # ============================================================
    old_crosscut = '''#### 6.2.5 设计原则横切关系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        设计原则横切关系图                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                          业务功能层                                      │  │
│   │                                                                         │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │  │
│   │  │ 记账入口 │  │ 钱龄系统 │  │ 预算系统 │  │ 习惯系统 │  │ 报表系统 │      │  │
│   │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘      │  │
│   │       │            │            │            │            │            │  │
│   └───────┼────────────┼────────────┼────────────┼────────────┼────────────┘  │
│           │            │            │            │            │               │
│   ════════╪════════════╪════════════╪════════════╪════════════╪═══════════    │
│           │            │            │            │            │               │
│   ┌───────┴────────────┴────────────┴────────────┴────────────┴────────────┐  │
│   │                    懒人设计原则 (第3章) 横切                            │  │
│   │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│   │  │ • 高频操作1步完成   • 智能默认值   • 单手可操作   • 渐进复杂度   │  │  │
│   │  └─────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│           │            │            │            │            │               │
│   ┌───────┴────────────┴────────────┴────────────┴────────────┴────────────┐  │
│   │                    伙伴化设计原则 (第4章) 横切                          │  │
│   │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│   │  │ • 动态文案系统   • 场景化情感   • 智能时机触发   • 伙伴人格     │  │  │
│   │  └─────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│           │            │            │            │            │               │
│   ┌───────┴────────────┴────────────┴────────────┴────────────┴────────────┐  │
│   │                    无障碍设计 (第5章) 横切                              │  │
│   │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│   │  │ • 视觉无障碍     • 操作无障碍   • 认知无障碍     • WCAG合规     │  │  │
│   │  └─────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│           │            │            │            │            │               │
│   ┌───────┴────────────┴────────────┴────────────┴────────────┴────────────┐  │
│   │                    可观测性与监控 (第22章) 横切                          │  │
│   │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│   │  │ • 日志系统       • 性能监控     • 错误追踪       • 业务指标     │  │  │
│   │  └─────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```'''

    new_crosscut = '''#### 6.2.5 设计原则横切关系

```
┌───────────────────────────────────────────────────────────────────────────────────────┐
│                              设计原则横切关系图                                          │
├───────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐│
│   │                               业务功能层                                         ││
│   │                                                                                 ││
│   │ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐││
│   │ │记账入口││钱龄系统││预算系统││习惯系统││家庭账本││语音交互││数据导入││报表系统│││
│   │ │(10章) ││ (7章) ││ (8章) ││ (9章) ││(13章) ││(18章) ││(11章) ││(12章) │││
│   │ └───┬───┘└───┬───┘└───┬───┘└───┬───┘└───┬───┘└───┬───┘└───┬───┘└───┬───┘││
│   │     │        │        │        │        │        │        │        │    ││
│   └─────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────┘│
│         │        │        │        │        │        │        │        │      │
│   ══════╪════════╪════════╪════════╪════════╪════════╪════════╪════════╪══════│
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                       懒人设计原则 (第3章) 横切                          │ │
│   │  • 高频操作1步完成   • 智能默认值   • 单手可操作   • 渐进复杂度          │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                      伙伴化设计原则 (第4章) 横切                         │ │
│   │  • 动态文案系统   • 场景化情感   • 智能时机触发   • 伙伴人格             │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                       无障碍设计 (第5章) 横切                            │ │
│   │  • 视觉无障碍   • 操作无障碍   • 认知无障碍   • WCAG 2.1 AA合规          │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                      安全与隐私 (第22章) 横切                            │ │
│   │  • 数据加密   • 权限最小化   • 隐私合规(GDPR)   • 敏感数据脱敏           │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                     异常处理与容错 (第23章) 横切                         │ │
│   │  • 优雅降级   • 离线容错   • 错误恢复   • 用户友好提示                   │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                     性能设计与优化 (第19章) 横切                         │ │
│   │  • 启动时间<2s   • 首屏渲染<500ms   • 内存<150MB   • 60fps流畅          │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│         │        │        │        │        │        │        │        │      │
│   ┌─────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────┐ │
│   │                     可观测性与监控 (第25章) 横切                         │ │
│   │  • 日志系统   • 性能监控   • 错误追踪   • 业务指标   • 用户行为分析      │ │
│   └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```'''

    if old_crosscut in content:
        content = content.replace(old_crosscut, new_crosscut)
        print("✓ 更新2: 6.2.5设计原则横切关系图")
        changes += 1

    # ============================================================
    # 更新3: 6.3 功能优先级矩阵 - 更新章节号并添加新模块
    # ============================================================
    old_priority = '''### 6.3 功能优先级矩阵

| 优先级 | 功能模块 | 状态 | 说明 |
|--------|----------|------|------|
| P0 | 基础记账 | ✅ 已有 | 核心功能，需优化体验 |
| P0 | 账户管理 | ✅ 已有 | 支持多账户、信用卡 |
| P0 | 分类管理 | ✅ 已有 | 支持自定义分类 |
| P0 | 统计图表 | ✅ 已有 | 需增强交互能力 |
| P1 | 钱龄分析 | 🆕 新增 | 2.0核心特性（第7章） |
| P1 | 零基预算 | 🆕 新增 | 2.0核心特性（第8章） |
| P1 | 小金库系统 | 🆕 新增 | 2.0核心特性（第8章） |
| P1 | 金融习惯培养 | 🆕 新增 | 打卡/成就/任务系统（第9章） |
| P1 | 数据联动 | 🆕 新增 | 增强交互体验（第12章） |
| P1 | **懒人设计** | 🆕 新增 | 最少操作、智能默认、单手操作（第4章） |
| P1 | **伙伴化设计** | 🆕 新增 | 动态文案、情感交互、智能时机（第4章） |
| P2 | AI语音识别 | ✅ 已有 | 需优化准确率（第10章） |
| P2 | AI图像识别 | ✅ 已有 | 需优化准确率（第10章） |
| P2 | 智能导入 | 🔄 升级 | 增加去重能力（第11章） |
| P2 | 地理位置智能 | 🆕 新增 | 消费场景识别、位置钱龄增强（第15章） |
| P2 | **无障碍设计** | 🆕 新增 | WCAG 2.1合规、全用户可访问（第3章） |
| P2 | **可观测性** | 🆕 新增 | 日志/监控/告警/业务指标（第5章） |
| P3 | 家庭共享 | 📋 规划 | 后续版本 |
| P3 | 智能投资建议 | 📋 规划 | 后续版本 |'''

    new_priority = '''### 6.3 功能优先级矩阵

| 优先级 | 功能模块 | 状态 | 说明 |
|--------|----------|------|------|
| P0 | 基础记账 | ✅ 已有 | 核心功能，需优化体验 |
| P0 | 账户管理 | ✅ 已有 | 支持多账户、信用卡 |
| P0 | 分类管理 | ✅ 已有 | 支持自定义分类 |
| P0 | 统计图表 | ✅ 已有 | 需增强交互能力 |
| P1 | 钱龄分析 | 🆕 新增 | 2.0核心特性（第7章） |
| P1 | 零基预算 | 🆕 新增 | 2.0核心特性（第8章） |
| P1 | 小金库系统 | 🆕 新增 | 2.0核心特性（第8章） |
| P1 | 金融习惯培养 | 🆕 新增 | 打卡/成就/任务系统（第9章） |
| P1 | 数据联动 | 🆕 新增 | 增强交互体验（第12章） |
| P1 | **家庭账本** | 🆕 新增 | 多成员协作、共享预算（第13章） |
| P1 | **懒人设计** | 🆕 新增 | 最少操作、智能默认、单手操作（第3章） |
| P1 | **伙伴化设计** | 🆕 新增 | 动态文案、情感交互、智能时机（第4章） |
| P2 | AI语音识别 | ✅ 已有 | 需优化准确率（第10章） |
| P2 | AI图像识别 | ✅ 已有 | 需优化准确率（第10章） |
| P2 | 智能语音交互 | 🆕 新增 | 语音意图理解、多轮对话（第18章） |
| P2 | 智能导入导出 | 🔄 升级 | 批量导入、多因子去重（第11章） |
| P2 | 自学习系统 | 🆕 新增 | 个性化适应、协同学习（第17章） |
| P2 | 地理位置智能 | 🆕 新增 | 消费场景识别、位置钱龄增强（第14章） |
| P2 | **无障碍设计** | 🆕 新增 | WCAG 2.1 AA合规、全用户可访问（第5章） |
| P2 | **性能优化** | 🆕 新增 | 启动<2s、首屏<500ms、60fps（第19章） |
| P2 | **可观测性** | 🆕 新增 | 日志/监控/告警/业务指标（第25章） |
| P2 | **用户口碑** | 🆕 新增 | NPS提升、口碑传播（第28章） |
| P2 | **自然增长** | 🆕 新增 | 邀请裂变、ASO优化（第29章） |
| P3 | 智能投资建议 | 📋 规划 | 后续版本 |'''

    if old_priority in content:
        content = content.replace(old_priority, new_priority)
        print("✓ 更新3: 6.3功能优先级矩阵")
        changes += 1

    # ============================================================
    # 更新4: 6.3.1 设计原则优先级说明 - 更新章节号
    # ============================================================
    old_principle_priority = '''#### 6.3.1 设计原则优先级说明

| 设计原则 | 优先级 | 实施范围 | 核心价值 |
|---------|--------|---------|---------|
| **懒人设计** | P1 | 全局横切 | 降低用户操作成本，提升记账效率，减少流失 |
| **伙伴化设计** | P1 | 全局横切 | 增强用户粘性，提升留存率，差异化体验 |
| **无障碍设计** | P2 | 全局横切 | 扩大用户群体，符合合规要求，社会责任 |
| **可观测性** | P2 | 全局横切 | 运维保障，问题定位，数据驱动决策 |'''

    new_principle_priority = '''#### 6.3.1 设计原则优先级说明

| 设计原则 | 章节 | 优先级 | 实施范围 | 核心价值 |
|---------|------|--------|---------|---------|
| **懒人设计** | 3章 | P1 | 全局横切 | 降低用户操作成本，提升记账效率，减少流失 |
| **伙伴化设计** | 4章 | P1 | 全局横切 | 增强用户粘性，提升留存率，差异化体验 |
| **无障碍设计** | 5章 | P2 | 全局横切 | 扩大用户群体，符合合规要求，社会责任 |
| **安全与隐私** | 22章 | P1 | 全局横切 | 数据安全，隐私合规，用户信任 |
| **异常处理** | 23章 | P1 | 全局横切 | 系统稳定，用户体验，问题恢复 |
| **性能优化** | 19章 | P2 | 全局横切 | 响应速度，资源效率，流畅体验 |
| **可观测性** | 25章 | P2 | 全局横切 | 运维保障，问题定位，数据驱动决策 |
| **用户增长** | 28-29章 | P2 | 增长层 | NPS提升，自然裂变，低成本获客 |'''

    if old_principle_priority in content:
        content = content.replace(old_principle_priority, new_principle_priority)
        print("✓ 更新4: 6.3.1设计原则优先级说明")
        changes += 1

    # ============================================================
    # 更新5: 6.4 数据模型概览 - 添加家庭账本相关模型
    # ============================================================
    old_data_model = '''### 6.4 数据模型概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           核心数据模型                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  用户数据                    财务数据                    分析数据   │
│  ┌─────────┐                ┌─────────┐                ┌─────────┐ │
│  │  User   │                │ Account │                │MoneyAge │ │
│  │ Profile │                │ 账户    │                │ 钱龄    │ │
│  └─────────┘                └────┬────┘                └─────────┘ │
│       │                          │                          │      │
│       │                    ┌─────┴─────┐                    │      │
│       │                    │           │                    │      │
│       ▼               ┌────▼───┐  ┌────▼────┐               ▼      │
│  ┌─────────┐          │Transaction│ │CreditCard│         ┌─────────┐│
│  │Settings │          │  交易    │ │  信用卡  │         │ Report  ││
│  │ 设置    │          └────┬───┘  └─────────┘         │  报告   ││
│  └─────────┘               │                           └─────────┘│
│                            │                                       │
│               ┌────────────┼────────────┐                          │
│               │            │            │                          │
│          ┌────▼───┐   ┌────▼────┐  ┌────▼────┐                     │
│          │Category│   │  Budget │  │  Vault  │                     │
│          │ 分类   │   │  预算   │  │ 小金库  │                     │
│          └────────┘   └─────────┘  └─────────┘                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```'''

    new_data_model = '''### 6.4 数据模型概览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   核心数据模型                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  用户与协作              财务数据                    分析数据           增长数据    │
│  ┌─────────┐            ┌─────────┐                ┌─────────┐       ┌─────────┐  │
│  │  User   │            │ Account │                │MoneyAge │       │   NPS   │  │
│  │ Profile │            │ 账户    │                │ 钱龄    │       │  评分   │  │
│  └────┬────┘            └────┬────┘                └─────────┘       └─────────┘  │
│       │                      │                          │                 │        │
│  ┌────▼────┐           ┌─────┴─────┐                    │           ┌─────▼─────┐  │
│  │ Family  │           │           │                    │           │  Invite   │  │
│  │ Ledger  │      ┌────▼───┐  ┌────▼────┐               ▼           │  Code     │  │
│  │ 家庭账本│      │Transaction│ │CreditCard│         ┌─────────┐   └───────────┘  │
│  └────┬────┘      │  交易    │ │  信用卡  │         │ Report  │                   │
│       │           └────┬───┘  └─────────┘         │  报告   │                   │
│  ┌────▼────┐           │                           └─────────┘                   │
│  │ Member  │           │                                                         │
│  │ 成员    │ ┌─────────┼─────────┐                                               │
│  └─────────┘ │         │         │                                               │
│         ┌────▼───┐ ┌───▼────┐ ┌──▼──────┐                                        │
│         │Category│ │ Budget │ │  Vault  │                                        │
│         │ 分类   │ │ 预算   │ │ 小金库  │                                        │
│         └────────┘ └────────┘ └─────────┘                                        │
│                                                                                     │
│  辅助数据                                                                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│  │Location │  │  Habit  │  │Achievement│ │ Import  │  │Settings │                  │
│  │位置记录 │  │习惯打卡 │  │ 成就徽章 │  │导入批次 │  │用户设置 │                  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘                  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

> 📎 **数据模型详情**：
> - 家庭账本与成员管理：详见[第13章](#13-家庭账本与多成员管理系统)
> - 钱龄资源池模型：详见[第7章](#7-钱龄智能分析系统)
> - 预算与小金库模型：详见[第8章](#8-零基预算与小金库系统)
> - 导入批次与去重：详见[第11章](#11-数据导入导出系统)'''

    if old_data_model in content:
        content = content.replace(old_data_model, new_data_model)
        print("✓ 更新5: 6.4数据模型概览")
        changes += 1

    # ============================================================
    # 更新6: 6.5.0 系统集成全景图 - 更新章节号
    # ============================================================
    old_integration_overview = '''#### 6.5.0 系统集成全景图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                      核心功能架构 - 系统集成全景                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│                        ┌─────────────────────┐                             │
│                        │   核心功能架构中心   │                             │
│                        │ CoreArchitectureHub │                             │
│                        └──────────┬──────────┘                             │
│                                   │                                        │
│         ┌─────────────┬───────────┼───────────┬─────────────┐              │
│         │             │           │           │             │              │
│         ▼             ▼           ▼           ▼             ▼              │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────┐ │
│  │  钱龄系统   │ │  预算系统   │ │  习惯系统   │ │  报表系统   │ │ 智能系统  │ │
│  │  (第7章)   │ │  (第8章)   │ │  (第9章)   │ │  (第12章)   │ │ (第15章) │ │
│  │            │ │            │ │            │ │            │ │          │ │
│  │ 消费健康度  │ │ 零基预算   │ │ 打卡成就   │ │ 可视化    │ │ AI识别   │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └──────────┘ │
│         │             │           │           │             │              │
│         └─────────────┴───────────┼───────────┴─────────────┘              │
│                                   │                                        │
│                        ┌──────────┴──────────┐                             │
│                        │    功能事件总线      │                             │
│                        │  FeatureEventBus    │                             │
│                        └──────────┬──────────┘                             │
│                                   │                                        │
│         ┌─────────────────────────┼─────────────────────────┐              │
│         │                         │                         │              │
│         ▼                         ▼                         ▼              │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐           │
│  │   位置智能      │    │   伙伴化系统    │    │   无障碍系统    │           │
│  │   (第15章)     │    │   (第4章)     │    │   (第5章)     │           │
│  │               │    │               │    │               │           │
│  │ 场景识别增强  │    │ 情感化交互    │    │ 全用户可用    │           │
│  └────────────────┘    └────────────────┘    └────────────────┘           │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```'''

    new_integration_overview = '''#### 6.5.0 系统集成全景图

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                          核心功能架构 - 系统集成全景                                    │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                           ┌─────────────────────┐                                    │
│                           │   核心功能架构中心   │                                    │
│                           │ CoreArchitectureHub │                                    │
│                           └──────────┬──────────┘                                    │
│                                      │                                               │
│    ┌────────────┬────────────┬───────┼───────┬────────────┬────────────┐             │
│    │            │            │       │       │            │            │             │
│    ▼            ▼            ▼       ▼       ▼            ▼            ▼             │
│ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │
│ │钱龄系统│ │预算系统│ │习惯系统│ │家庭账本│ │报表系统│ │智能系统│ │语音交互│        │
│ │ (7章) │ │ (8章) │ │ (9章) │ │(13章) │ │(12章) │ │(10章) │ │(18章) │        │
│ │        │ │        │ │        │ │        │ │        │ │        │ │        │        │
│ │消费健康│ │零基预算│ │打卡成就│ │成员协作│ │可视化  │ │AI识别  │ │意图理解│        │
│ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘        │
│    │            │            │       │       │            │            │             │
│    └────────────┴────────────┴───────┼───────┴────────────┴────────────┘             │
│                                      │                                               │
│                           ┌──────────┴──────────┐                                    │
│                           │    功能事件总线      │                                    │
│                           │  FeatureEventBus    │                                    │
│                           └──────────┬──────────┘                                    │
│                                      │                                               │
│    ┌─────────────┬───────────────────┼───────────────────┬─────────────┐             │
│    │             │                   │                   │             │             │
│    ▼             ▼                   ▼                   ▼             ▼             │
│ ┌──────────┐ ┌──────────┐    ┌──────────────┐    ┌──────────┐ ┌──────────┐          │
│ │位置智能  │ │自学习系统│    │  伙伴化系统  │    │无障碍系统│ │用户增长  │          │
│ │ (14章)  │ │ (17章)  │    │   (4章)     │    │ (5章)   │ │(28-29章)│          │
│ │         │ │         │    │             │    │         │ │         │          │
│ │场景识别 │ │个性适应 │    │ 情感化交互  │    │全用户可用│ │NPS/裂变 │          │
│ └──────────┘ └──────────┘    └──────────────┘    └──────────┘ └──────────┘          │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```'''

    if old_integration_overview in content:
        content = content.replace(old_integration_overview, new_integration_overview)
        print("✓ 更新6: 6.5.0系统集成全景图")
        changes += 1

    # ============================================================
    # 更新7: 6.5.1 集成触发点 - 添加新模块触发点
    # ============================================================
    old_triggers = '''#### 6.5.1 集成触发点

| 源模块 | 目标模块 | 触发事件 | 集成效果 |
|--------|---------|---------|---------|
| **记账入口** | 钱龄系统 | 新增交易 | 自动更新资源池 |
| **记账入口** | 预算系统 | 新增支出 | 自动扣减预算 |
| **记账入口** | 习惯系统 | 完成记账 | 打卡积分 |
| **钱龄系统** | 习惯系统 | 钱龄变化 | 触发任务推荐 |
| **钱龄系统** | 伙伴化 | 钱龄提升/下降 | 鼓励/关心消息 |
| **预算系统** | 习惯系统 | 预算达成 | 成就解锁 |
| **预算系统** | 伙伴化 | 预算预警/达成 | 提醒/庆祝消息 |
| **位置智能** | 钱龄系统 | 场景识别 | 位置增强钱龄 |
| **位置智能** | 预算系统 | 地理围栏 | 位置预算提醒 |
| **AI智能** | 记账入口 | 语音/图像识别 | 自动解析记账 |'''

    new_triggers = '''#### 6.5.1 集成触发点

| 源模块 | 章节 | 目标模块 | 触发事件 | 集成效果 |
|--------|------|---------|---------|---------|
| **记账入口** | 10章 | 钱龄系统 | 新增交易 | 自动更新资源池 |
| **记账入口** | 10章 | 预算系统 | 新增支出 | 自动扣减预算 |
| **记账入口** | 10章 | 习惯系统 | 完成记账 | 打卡积分 |
| **记账入口** | 10章 | 家庭账本 | 共享交易 | 通知其他成员 |
| **钱龄系统** | 7章 | 习惯系统 | 钱龄变化 | 触发任务推荐 |
| **钱龄系统** | 7章 | 伙伴化 | 钱龄提升/下降 | 鼓励/关心消息 |
| **预算系统** | 8章 | 习惯系统 | 预算达成 | 成就解锁 |
| **预算系统** | 8章 | 伙伴化 | 预算预警/达成 | 提醒/庆祝消息 |
| **预算系统** | 8章 | 家庭账本 | 共享预算变化 | 成员预算同步 |
| **家庭账本** | 13章 | 习惯系统 | 成员活跃 | 家庭贡献积分 |
| **家庭账本** | 13章 | 用户增长 | 邀请成功 | 裂变计数 |
| **位置智能** | 14章 | 钱龄系统 | 场景识别 | 位置增强钱龄 |
| **位置智能** | 14章 | 预算系统 | 地理围栏 | 位置预算提醒 |
| **AI智能** | 10章 | 记账入口 | 语音/图像识别 | 自动解析记账 |
| **语音交互** | 18章 | AI智能 | 语音意图 | 多轮对话处理 |
| **自学习系统** | 17章 | AI智能 | 模型更新 | 识别准确率提升 |
| **习惯系统** | 9章 | 用户增长 | 成就解锁 | 触发分享引导 |
| **用户增长** | 28-29章 | 伙伴化 | NPS反馈 | 个性化跟进 |'''

    if old_triggers in content:
        content = content.replace(old_triggers, new_triggers)
        print("✓ 更新7: 6.5.1集成触发点表格")
        changes += 1

    # ============================================================
    # 更新8: 6.5.2 功能模块注册机制 - 添加新模块
    # ============================================================
    old_module_init = '''  /// 初始化所有核心模块
  static Future<void> initializeCoreModules() async {
    // 按依赖顺序初始化
    await register(TransactionModule());     // 交易模块（基础）
    await register(MoneyAgeModule());        // 钱龄模块
    await register(BudgetModule());          // 预算模块
    await register(VaultModule());           // 小金库模块
    await register(HabitModule());           // 习惯模块
    await register(ReportModule());          // 报表模块
    await register(AIModule());              // AI智能模块
    await register(LocationModule());        // 位置智能模块
    await register(CompanionModule());       // 伙伴化模块
  }'''

    new_module_init = '''  /// 初始化所有核心模块
  static Future<void> initializeCoreModules() async {
    // 按依赖顺序初始化
    // 第一层：基础模块
    await register(TransactionModule());     // 交易模块（基础）
    await register(AccountModule());         // 账户模块
    await register(CategoryModule());        // 分类模块

    // 第二层：核心业务模块
    await register(MoneyAgeModule());        // 钱龄模块（第7章）
    await register(BudgetModule());          // 预算模块（第8章）
    await register(VaultModule());           // 小金库模块（第8章）
    await register(HabitModule());           // 习惯模块（第9章）
    await register(FamilyLedgerModule());    // 家庭账本模块（第13章）

    // 第三层：智能增强模块
    await register(AIModule());              // AI智能模块（第10章）
    await register(ImportExportModule());    // 导入导出模块（第11章）
    await register(VoiceInteractionModule()); // 语音交互模块（第18章）
    await register(SelfLearningModule());    // 自学习模块（第17章）
    await register(LocationModule());        // 位置智能模块（第14章）

    // 第四层：展示与交互模块
    await register(ReportModule());          // 报表模块（第12章）
    await register(CompanionModule());       // 伙伴化模块（第4章）
    await register(AccessibilityModule());   // 无障碍模块（第5章）

    // 第五层：增长模块
    await register(UserGrowthModule());      // 用户增长模块（第28-29章）
  }'''

    if old_module_init in content:
        content = content.replace(old_module_init, new_module_init)
        print("✓ 更新8: 6.5.2功能模块注册机制")
        changes += 1

    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== 第6章剩余更新完成，共 {changes} 处 =====")
    else:
        print("\n未找到目标位置或已更新")

    return changes

if __name__ == '__main__':
    main()
