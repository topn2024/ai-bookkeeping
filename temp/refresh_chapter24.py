# -*- coding: utf-8 -*-
"""
刷新第24章可扩展性与演进架构
1. 修复图中"第22章"引用为"第24章"
2. 添加24.11与其他系统集成部分
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修复图中章节引用 ==========
    ref_fixes = [
        # 修复设计定位图标题
        ('│                    第22章 可扩展性与演进架构 - 设计定位                            │',
         '│                    第24章 可扩展性与演进架构 - 设计定位                            │'),
        # 修复关系图中的章节引用
        ('│                             │    第22章       │                                │',
         '│                             │    第24章       │                                │'),
        # 修复目标达成检测中的章节引用
        ("      chapterName: '第22章 可扩展性与演进架构',",
         "      chapterName: '第24章 可扩展性与演进架构',"),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix ref: ...{old[20:50]}...")
            changes += 1

    # ========== 修复2: 添加24.11与其他系统集成 ==========
    chapter25_marker = '## 25. 可观测性与监控'

    new_section_24_11 = '''### 24.11 与其他系统集成

#### 24.11.1 系统集成概览

可扩展性架构为所有2.0模块提供统一的扩展能力：

```
┌────────────────────────────────────────────────────────────────────────────┐
│                      可扩展性与演进架构集成全景图                             │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                        扩展性核心服务                                 │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │  │ 模块注册  │  │ 策略管理  │  │ 版本控制  │  │ 灰度发布  │           │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘           │  │
│  └───────────────────────────┬─────────────────────────────────────────┘  │
│                              │                                            │
│         ┌────────────────────┼────────────────────┐                       │
│         │                    │                    │                       │
│         ▼                    ▼                    ▼                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                 │
│  │  核心业务    │     │  智能增强    │     │  2.0新增    │                 │
│  │  扩展支持    │     │  扩展支持    │     │  扩展支持    │                 │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤                 │
│  │ • 钱龄策略   │     │ • AI引擎    │     │ • 语音识别   │                 │
│  │ • 预算策略   │     │ • 分类策略   │     │ • 位置服务   │                 │
│  │ • 小金库规则 │     │ • 洞察生成   │     │ • 家庭同步   │                 │
│  └─────────────┘     └─────────────┘     └─────────────┘                 │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

#### 24.11.2 钱龄系统扩展集成

钱龄计算策略的可扩展设计：

| 策略类型 | 扩展方式 | 说明 |
|----------|----------|------|
| FIFO | 内置策略 | 先进先出，默认策略 |
| 加权平均 | 策略注册 | 按权重计算平均钱龄 |
| 按账户 | 策略扩展 | 不同账户不同计算方式 |
| 自定义 | 插件化 | 用户自定义计算规则 |

#### 24.11.3 预算系统扩展集成

预算分配策略的可扩展设计：

| 策略类型 | 扩展方式 | 说明 |
|----------|----------|------|
| 信封法 | 内置策略 | 固定金额分配 |
| 50/30/20 | 策略注册 | 比例分配法则 |
| 智能分配 | AI扩展 | 基于消费习惯智能分配 |
| 自定义 | 插件化 | 用户自定义分配规则 |

#### 24.11.4 AI识别扩展集成

AI识别引擎的可扩展设计：

| 识别类型 | 扩展方式 | 说明 |
|----------|----------|------|
| 语音识别 | 引擎注册 | 支持多ASR引擎切换 |
| 图片OCR | 引擎注册 | 支持多OCR引擎切换 |
| 智能分类 | 模型扩展 | 支持本地/云端模型 |
| 消费解析 | 规则扩展 | 支持自定义解析规则 |

#### 24.11.5 位置服务扩展集成

位置智能服务的可扩展设计：

| 服务类型 | 扩展方式 | 说明 |
|----------|----------|------|
| 定位服务 | 服务注册 | 支持GPS/网络/混合 |
| POI匹配 | 数据源扩展 | 支持多数据源 |
| 场景识别 | 规则扩展 | 支持自定义场景规则 |
| 地理围栏 | 配置扩展 | 支持自定义围栏 |

#### 24.11.6 家庭账本扩展集成

家庭账本协作的可扩展设计：

| 功能类型 | 扩展方式 | 说明 |
|----------|----------|------|
| 权限模型 | 配置扩展 | 支持自定义角色权限 |
| 同步策略 | 策略注册 | 支持多种冲突解决策略 |
| 共享规则 | 规则扩展 | 支持自定义共享范围 |
| 通知模板 | 模板扩展 | 支持自定义通知样式 |

#### 24.11.7 版本迁移扩展集成

数据迁移的可扩展设计：

| 迁移类型 | 扩展方式 | 说明 |
|----------|----------|------|
| 实体迁移 | 迁移脚本 | 注册版本迁移脚本 |
| 配置迁移 | 配置映射 | 旧配置到新配置映射 |
| 数据转换 | 转换器 | 注册数据格式转换器 |
| 回滚支持 | 回滚脚本 | 支持迁移回滚 |

---

'''

    if chapter25_marker in content:
        content = content.replace(chapter25_marker, new_section_24_11 + chapter25_marker)
        print("OK: Added 24.11 integration section")
        changes += 1
    else:
        print("SKIP: Chapter 25 marker not found")

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 24 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
