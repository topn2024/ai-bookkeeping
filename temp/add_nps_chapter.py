# -*- coding: utf-8 -*-
"""
æ·»åŠ ç¬¬28ç« ï¼šç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡
"""

NPS_CHAPTER = '''

---

## 28. ç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡

### 28.0 è®¾è®¡åŸåˆ™å›é¡¾

æœ¬ç« è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

| åŸåˆ™ | åº”ç”¨æ–¹å¼ |
|------|----------|
| **æ‡’äººè®¾è®¡** | å£ç¢‘åˆ†äº«ä¸€é”®å®Œæˆï¼Œæ— éœ€å¤æ‚æ“ä½œ |
| **ä¼™ä¼´åŒ–è®¾è®¡** | é€šè¿‡æƒ…æ„Ÿè¿æ¥åŸ¹å…»æ¨èè€… |
| **ç”¨æˆ·ä¼˜å…ˆ** | ä»¥ç”¨æˆ·çœŸå®ä»·å€¼ä¸ºå£ç¢‘åŸºç¡€ï¼Œè€Œéè¥é”€æ‰‹æ®µ |

#### 28.0.1 NPSä¸äº§å“æˆåŠŸçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NPSé©±åŠ¨å¢é•¿é£è½®                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                      â”Œâ”€â”€â”€â–ºâ”‚  æ¨èè€…å¢åŠ    â”‚â”€â”€â”€â”                         â”‚
â”‚                      â”‚    â”‚  (NPSæå‡)   â”‚   â”‚                         â”‚
â”‚                      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                         â”‚
â”‚                      â”‚                       â–¼                         â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚               â”‚  äº§å“ä½“éªŒä¼˜åŒ– â”‚        â”‚  å£ç¢‘ä¼ æ’­    â”‚                 â”‚
â”‚               â”‚  (ä»·å€¼äº¤ä»˜)   â”‚        â”‚  (è‡ªç„¶è·å®¢)  â”‚                 â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                      â–²                       â”‚                         â”‚
â”‚                      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                         â”‚
â”‚                      â””â”€â”€â”€â”€â”‚  ç”¨æˆ·åé¦ˆ    â”‚â—„â”€â”€â”˜                         â”‚
â”‚                           â”‚  (æŒç»­æ”¹è¿›)  â”‚                              â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â”‚  ã€æ ¸å¿ƒç†å¿µã€‘NPSä¸æ˜¯è¥é”€æŒ‡æ ‡ï¼Œè€Œæ˜¯äº§å“ä»·å€¼çš„çœŸå®åæ˜                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 28.0.2 ä¸2.0å…¶ä»–ç³»ç»Ÿçš„ååŒå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NPSæå‡ç³»ç»Ÿä¸å…¶ä»–æ¨¡å—çš„ååŒ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  ä¼™ä¼´åŒ–è®¾è®¡    â”‚  â”‚  ä¹ æƒ¯åŸ¹å…»ç³»ç»Ÿ  â”‚  â”‚  é’±é¾„åˆ†æç³»ç»Ÿ  â”‚               â”‚
â”‚  â”‚  (ç¬¬4ç« )      â”‚  â”‚  (ç¬¬9ç« )      â”‚  â”‚  (ç¬¬7ç« )      â”‚               â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚               â”‚
â”‚  â”‚ æƒ…æ„Ÿè¿æ¥â†’    â”‚  â”‚ æˆå°±ç³»ç»Ÿâ†’    â”‚  â”‚ å·®å¼‚åŒ–ä»·å€¼â†’  â”‚               â”‚
â”‚  â”‚ æ¨èè€…åŸ¹è‚²   â”‚  â”‚ åˆ†äº«ç´ æ     â”‚  â”‚ å£ç¢‘ä¼ æ’­ç‚¹   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                 â”‚                 â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â–¼                                             â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                â”‚  NPSæå‡è®¾è®¡ (æœ¬ç« )  â”‚                                 â”‚
â”‚                â”‚                     â”‚                                 â”‚
â”‚                â”‚  â€¢ æƒŠå–œæ—¶åˆ»ç³»ç»Ÿ     â”‚                                 â”‚
â”‚                â”‚  â€¢ å£ç¢‘åˆ†äº«æœºåˆ¶     â”‚                                 â”‚
â”‚                â”‚  â€¢ è´Ÿé¢ä½“éªŒä¿®å¤     â”‚                                 â”‚
â”‚                â”‚  â€¢ æ¨èè€…åŸ¹è‚²       â”‚                                 â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â–¼                â–¼                â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  æ•°æ®å¯è§†åŒ–    â”‚ â”‚  å›½é™…åŒ–ç³»ç»Ÿ    â”‚ â”‚  ç”¨æˆ·ä½“éªŒè®¾è®¡  â”‚                â”‚
â”‚  â”‚  (ç¬¬12ç« )     â”‚ â”‚  (ç¬¬21ç« )     â”‚ â”‚  (ç¬¬20ç« )     â”‚                â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚                â”‚
â”‚  â”‚ åˆ†äº«å¡ç‰‡è®¾è®¡  â”‚ â”‚ å¤šè¯­è¨€åˆ†äº«    â”‚ â”‚ é¦–å‘¨ä½“éªŒä¼˜åŒ–  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 28.1 NPSç›®æ ‡ä¸ç›‘æµ‹æœºåˆ¶

#### 28.1.1 NPSç›®æ ‡è®¾å®š

| é˜¶æ®µ | æ—¶é—´èŠ‚ç‚¹ | NPSç›®æ ‡ | è¯´æ˜ |
|------|----------|---------|------|
| **MVPéªŒè¯æœŸ** | ä¸Šçº¿å3ä¸ªæœˆ | â‰¥30 | éªŒè¯æ ¸å¿ƒä»·å€¼è¢«è®¤å¯ |
| **å¢é•¿æœŸ** | ä¸Šçº¿å6ä¸ªæœˆ | â‰¥40 | å£ç¢‘å¼€å§‹ä¼ æ’­ |
| **æˆç†ŸæœŸ** | ä¸Šçº¿å12ä¸ªæœˆ | â‰¥50 | å½¢æˆå£ç¢‘é£è½® |
| **é¢†å…ˆæœŸ** | ä¸Šçº¿å24ä¸ªæœˆ | â‰¥60 | è¡Œä¸šé¢†å…ˆæ°´å¹³ |

#### 28.1.2 NPSç›‘æµ‹ä½“ç³»

```dart
/// NPSç›‘æµ‹æœåŠ¡
class NpsMonitoringService {
  /// NPSè°ƒæŸ¥è§¦å‘æ—¶æœº
  static const surveyTriggers = [
    NpsSurveyTrigger(
      event: 'first_week_completed',
      delay: Duration(days: 7),
      description: 'ä½¿ç”¨æ»¡ä¸€å‘¨åé¦–æ¬¡æ”¶é›†',
    ),
    NpsSurveyTrigger(
      event: 'monthly_active_user',
      interval: Duration(days: 90),
      description: 'æ´»è·ƒç”¨æˆ·æ¯90å¤©è°ƒæŸ¥ä¸€æ¬¡',
    ),
    NpsSurveyTrigger(
      event: 'milestone_achieved',
      milestones: ['money_age_30_days', 'savings_goal_completed', 'streak_30_days'],
      description: 'è¾¾æˆé‡è¦é‡Œç¨‹ç¢‘åè°ƒæŸ¥',
    ),
    NpsSurveyTrigger(
      event: 'feature_intensive_use',
      threshold: 50,  // ä½¿ç”¨æŸåŠŸèƒ½50æ¬¡ä»¥ä¸Š
      description: 'æ·±åº¦ä½¿ç”¨æŸåŠŸèƒ½åè°ƒæŸ¥è¯¥åŠŸèƒ½NPS',
    ),
  ];

  /// NPSé—®å·è®¾è®¡
  Future<NpsSurveyResult> conductSurvey(String userId) async {
    // æ ¸å¿ƒé—®é¢˜
    final score = await _askNpsQuestion(
      question: 'æ‚¨æœ‰å¤šå¤§å¯èƒ½å‘æœ‹å‹æˆ–åŒäº‹æ¨èAIæ™ºèƒ½è®°è´¦ï¼Ÿ',
      scale: 10,  // 0-10åˆ†
    );

    // è¿½é—®åŸå› ï¼ˆæ ¹æ®åˆ†æ•°åˆ†ç±»ï¼‰
    String? reason;
    if (score >= 9) {
      // æ¨èè€…ï¼šäº†è§£æ¨èåŠ¨åŠ›
      reason = await _askOpenQuestion(
        question: 'å¤ªæ£’äº†ï¼æ˜¯ä»€ä¹ˆè®©æ‚¨æ„¿æ„æ¨èæˆ‘ä»¬ï¼Ÿ',
        suggestions: ['é’±é¾„åˆ†æå¾ˆæœ‰ç”¨', 'è®°è´¦å¾ˆæ–¹ä¾¿', 'é¢„ç®—ç®¡ç†å¸®åŠ©å¾ˆå¤§', 'ç•Œé¢å¾ˆå¥½çœ‹'],
      );
    } else if (score >= 7) {
      // è¢«åŠ¨è€…ï¼šäº†è§£æå‡ç©ºé—´
      reason = await _askOpenQuestion(
        question: 'æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼æˆ‘ä»¬è¿˜èƒ½åšäº›ä»€ä¹ˆè®©æ‚¨æ›´æ»¡æ„ï¼Ÿ',
      );
    } else {
      // è´¬æŸè€…ï¼šäº†è§£é—®é¢˜æ‰€åœ¨
      reason = await _askOpenQuestion(
        question: 'å¾ˆæŠ±æ­‰æ²¡èƒ½è®©æ‚¨æ»¡æ„ï¼Œèƒ½å‘Šè¯‰æˆ‘ä»¬å“ªé‡Œéœ€è¦æ”¹è¿›å—ï¼Ÿ',
      );
    }

    return NpsSurveyResult(
      userId: userId,
      score: score,
      reason: reason,
      timestamp: DateTime.now(),
      context: await _captureContext(),  // è®°å½•è°ƒæŸ¥æ—¶çš„ä¸Šä¸‹æ–‡
    );
  }

  /// NPSè®¡ç®—
  double calculateNps(List<NpsSurveyResult> results) {
    if (results.isEmpty) return 0;

    int promoters = 0;   // 9-10åˆ†
    int detractors = 0;  // 0-6åˆ†

    for (final result in results) {
      if (result.score >= 9) {
        promoters++;
      } else if (result.score <= 6) {
        detractors++;
      }
    }

    final promoterRate = promoters / results.length * 100;
    final detractorRate = detractors / results.length * 100;

    return promoterRate - detractorRate;
  }
}
```

#### 28.1.3 NPSåˆ†è§£åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NPSé©±åŠ¨å› ç´ åˆ†è§£                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æ€»ä½“NPS = f(åŠŸèƒ½ä»·å€¼, ä½“éªŒè´¨é‡, æƒ…æ„Ÿè¿æ¥, ä¿¡ä»»åº¦)                        â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŠŸèƒ½ä»·å€¼ (40%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ é’±é¾„åˆ†ææœ‰ç”¨æ€§                                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ é¢„ç®—ç®¡ç†æ•ˆæœ                                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ AIè¯†åˆ«å‡†ç¡®æ€§                                                â”‚   â”‚
â”‚  â”‚  â””â”€ ä¹ æƒ¯åŸ¹å…»æˆæ•ˆ                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä½“éªŒè´¨é‡ (30%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ è®°è´¦ä¾¿æ·æ€§                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç•Œé¢ç¾è§‚åº¦                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ“ä½œæµç•…æ€§                                                  â”‚   â”‚
â”‚  â”‚  â””â”€ å­¦ä¹ æˆæœ¬ä½                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æƒ…æ„Ÿè¿æ¥ (20%)                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ ä¼™ä¼´æ„Ÿå—                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ æˆå°±æ„Ÿè·å¾—                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ æƒŠå–œä½“éªŒ                                                    â”‚   â”‚
â”‚  â”‚  â””â”€ è¢«ç†è§£æ„Ÿ                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¿¡ä»»åº¦ (10%)                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ•°æ®å®‰å…¨æ„Ÿ                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ éšç§ä¿æŠ¤                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç®—æ³•é€æ˜                                                    â”‚   â”‚
â”‚  â”‚  â””â”€ ç¨³å®šå¯é                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 28.2 æƒŠå–œæ—¶åˆ»ç³»ç»Ÿè®¾è®¡

#### 28.2.1 æƒŠå–œæ—¶åˆ»å®šä¹‰

æƒŠå–œæ—¶åˆ»(Delight Moments)æ˜¯æŒ‡è¶…å‡ºç”¨æˆ·é¢„æœŸã€å¸¦æ¥æ„‰æ‚¦æ„Ÿçš„äº§å“ä½“éªŒç‚¹ã€‚è¿™äº›æ—¶åˆ»æ˜¯åŸ¹å…»æ¨èè€…çš„å…³é”®è§¦å‘å™¨ã€‚

```dart
/// æƒŠå–œæ—¶åˆ»æœåŠ¡
class DelightMomentService {
  final NotificationService _notificationService;
  final AnimationService _animationService;
  final AchievementService _achievementService;

  /// é‡Œç¨‹ç¢‘æƒŠå–œé…ç½®
  static const milestoneDelights = [
    // é¦–æ¬¡ä½“éªŒæƒŠå–œ
    MilestoneDelight(
      trigger: 'first_transaction_saved',
      title: 'è®°è´¦ä¹‹æ—…å¼€å§‹äº†ï¼',
      message: 'æ­å–œå®Œæˆç¬¬ä¸€ç¬”è®°è´¦ï¼Œä½ çš„è´¢åŠ¡ç®¡ç†æ–°ç¯‡ç« å¼€å¯å•¦',
      animation: 'confetti_celebration',
      reward: AchievementBadge('first_step'),
    ),

    // é’±é¾„çªç ´æƒŠå–œ
    MilestoneDelight(
      trigger: 'money_age_reached_7_days',
      title: 'é’±é¾„çªç ´7å¤©ï¼',
      message: 'ä½ çš„é’±ç°åœ¨å¯ä»¥"æ´»"ä¸€å‘¨äº†ï¼Œæ¯”å¤§å¤šæ•°æœˆå…‰æ—å¼ºå¤šäº†',
      animation: 'level_up',
      reward: AchievementBadge('money_age_7'),
      shareCard: true,  // å¯ç”Ÿæˆåˆ†äº«å¡ç‰‡
    ),
    MilestoneDelight(
      trigger: 'money_age_reached_30_days',
      title: 'è¿›å…¥å®‰å…¨åŒºï¼',
      message: 'é’±é¾„30å¤©ï¼Œä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªæœˆçš„è´¢åŠ¡ç¼“å†²äº†',
      animation: 'grand_celebration',
      reward: AchievementBadge('money_age_30'),
      shareCard: true,
    ),

    // è¿ç»­è®°è´¦æƒŠå–œ
    MilestoneDelight(
      trigger: 'streak_7_days',
      title: 'è¿ç»­è®°è´¦ä¸€å‘¨ï¼',
      message: 'åšæŒå°±æ˜¯èƒœåˆ©ï¼Œä½ å·²ç»å…»æˆäº†åˆæ­¥çš„è®°è´¦ä¹ æƒ¯',
      animation: 'streak_fire',
      reward: AchievementBadge('streak_7'),
    ),
    MilestoneDelight(
      trigger: 'streak_30_days',
      title: 'è®°è´¦è¾¾äººè¯ç”Ÿï¼',
      message: 'è¿ç»­30å¤©ï¼Œè®°è´¦å·²ç»æˆä¸ºä½ çš„æ—¥å¸¸ä¹ æƒ¯äº†',
      animation: 'master_unlock',
      reward: AchievementBadge('streak_master'),
      shareCard: true,
    ),

    // å‚¨è“„ç›®æ ‡æƒŠå–œ
    MilestoneDelight(
      trigger: 'savings_goal_50_percent',
      title: 'ç›®æ ‡è¿‡åŠï¼',
      message: 'å‚¨è“„ç›®æ ‡å·²å®Œæˆ50%ï¼Œç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥',
      animation: 'progress_boost',
    ),
    MilestoneDelight(
      trigger: 'savings_goal_completed',
      title: 'ç›®æ ‡è¾¾æˆï¼',
      message: 'æ­å–œä½ å®Œæˆäº†å‚¨è“„ç›®æ ‡ï¼ä½ è¯æ˜äº†è‡ªå·±å¯ä»¥åšåˆ°',
      animation: 'goal_achieved',
      reward: AchievementBadge('goal_achiever'),
      shareCard: true,
    ),

    // èŠ‚çœé‡‘é¢æƒŠå–œ
    MilestoneDelight(
      trigger: 'total_saved_1000',
      title: 'çœä¸‹1000å…ƒï¼',
      message: 'é€šè¿‡é¢„ç®—ç®¡ç†ï¼Œä½ å·²ç»ç´¯è®¡èŠ‚çœäº†1000å…ƒ',
      animation: 'money_rain',
      storyGeneration: true,  // ç”Ÿæˆçœé’±æ•…äº‹
    ),
    MilestoneDelight(
      trigger: 'total_saved_10000',
      title: 'ä¸‡å…ƒä¿±ä¹éƒ¨ï¼',
      message: 'ç´¯è®¡èŠ‚çœ10000å…ƒï¼ä½ çš„è´¢åŠ¡ç®¡ç†èƒ½åŠ›ä»¤äººæ•¬ä½©',
      animation: 'fireworks',
      reward: AchievementBadge('savings_master'),
      shareCard: true,
    ),
  ];

  /// è§¦å‘æƒŠå–œæ—¶åˆ»
  Future<void> triggerDelight(MilestoneDelight delight) async {
    // 1. æ’­æ”¾åŠ¨ç”»
    await _animationService.play(delight.animation);

    // 2. æ˜¾ç¤ºç¥è´ºæ¶ˆæ¯
    await _showDelightCard(delight);

    // 3. å‘æ”¾å¥–åŠ±
    if (delight.reward != null) {
      await _achievementService.award(delight.reward!);
    }

    // 4. ç”Ÿæˆåˆ†äº«å†…å®¹
    if (delight.shareCard) {
      await _prepareShareCard(delight);
    }

    // 5. è®°å½•æƒŠå–œæ—¶åˆ»
    await _logDelightMoment(delight);
  }
}
```

#### 28.2.2 æ™ºèƒ½æƒŠå–œå‘ç°

```dart
/// æ™ºèƒ½æƒŠå–œå‘ç°æœåŠ¡
class SmartDelightDiscoveryService {
  /// å‘ç°ç”¨æˆ·ç‹¬ç‰¹çš„æ¶ˆè´¹è§„å¾‹å¹¶ç»™äºˆæƒŠå–œåé¦ˆ
  Future<List<SmartDelight>> discoverDelights(String userId) async {
    final delights = <SmartDelight>[];
    final transactions = await _getRecentTransactions(userId, days: 90);

    // å‘ç°å‘¨æœŸæ€§æ¶ˆè´¹è§„å¾‹
    final patterns = _analyzeConsumptionPatterns(transactions);
    for (final pattern in patterns) {
      if (pattern.confidence > 0.8) {
        delights.add(SmartDelight(
          type: DelightType.patternDiscovery,
          title: 'æˆ‘å‘ç°äº†ä¸€ä¸ªå°ç§˜å¯†',
          message: _generatePatternMessage(pattern),
          // ä¾‹å¦‚: "ä½ å¥½åƒæ¯å‘¨äº”éƒ½ä¼šçŠ’åŠ³è‡ªå·±ä¸€æ¯å’–å•¡â˜•"
        ));
      }
    }

    // å‘ç°ç§¯æå˜åŒ–
    final improvements = _detectImprovements(transactions);
    for (final improvement in improvements) {
      delights.add(SmartDelight(
        type: DelightType.improvementNotice,
        title: 'æ‚„æ‚„å‘Šè¯‰ä½ ä¸€ä¸ªå¥½æ¶ˆæ¯',
        message: _generateImprovementMessage(improvement),
        // ä¾‹å¦‚: "è¿™ä¸ªæœˆå¤–å–æ”¯å‡ºæ¯”ä¸Šä¸ªæœˆå‡å°‘äº†20%ï¼"
      ));
    }

    return delights;
  }

  /// é¢„æµ‹å³å°†è¾¾æˆçš„æˆå°±å¹¶æå‰æ¿€åŠ±
  Future<void> predictAndEncourage(String userId) async {
    // æ£€æµ‹å³å°†è¾¾æˆçš„ç›®æ ‡
    final nearMilestones = await _detectNearMilestones(userId);

    for (final milestone in nearMilestones) {
      if (milestone.progressPercent >= 90) {
        await _sendEncouragement(
          userId: userId,
          title: 'å°±å·®ä¸€ç‚¹ç‚¹äº†ï¼',
          message: '${milestone.name}å³å°†è¾¾æˆï¼Œå†åšæŒ${milestone.remaining}å°±æˆåŠŸäº†',
        );
      }
    }
  }

  /// ç”Ÿæˆæ¶ˆè´¹è§„å¾‹æ¶ˆæ¯
  String _generatePatternMessage(ConsumptionPattern pattern) {
    switch (pattern.type) {
      case PatternType.weeklyRecurring:
        return 'ä½ å¥½åƒæ¯${pattern.dayOfWeek}éƒ½ä¼š${pattern.description}';
      case PatternType.monthlyRecurring:
        return 'æ¯ä¸ªæœˆ${pattern.dayOfMonth}å·ï¼Œä½ éƒ½ä¼š${pattern.description}';
      case PatternType.locationBased:
        return 'æ¯æ¬¡å»${pattern.location}ï¼Œä½ éƒ½å–œæ¬¢${pattern.description}';
      default:
        return 'æˆ‘å‘ç°äº†ä½ çš„ä¸€ä¸ªæ¶ˆè´¹å°ä¹ æƒ¯';
    }
  }
}
```

#### 28.2.3 æƒŠå–œæ—¶åˆ»çš„æ—¶æœºä¸é¢‘ç‡æ§åˆ¶

```dart
/// æƒŠå–œæ—¶åˆ»é¢‘ç‡æ§åˆ¶å™¨
class DelightFrequencyController {
  /// é¢‘ç‡æ§åˆ¶è§„åˆ™
  static const frequencyRules = FrequencyRules(
    // åŒä¸€ç±»å‹æƒŠå–œçš„æœ€å°é—´éš”
    minIntervalBetweenSameType: Duration(days: 7),

    // æ¯æ—¥æƒŠå–œä¸Šé™
    maxDelightsPerDay: 2,

    // æ¯å‘¨æƒŠå–œä¸Šé™
    maxDelightsPerWeek: 5,

    // æƒŠå–œç–²åŠ³æ¢å¤æœŸ
    fatigueRecoveryPeriod: Duration(days: 3),

    // ç”¨æˆ·åå¥½è‡ªé€‚åº”
    adaptToUserPreference: true,
  );

  /// åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘æƒŠå–œ
  Future<bool> shouldTrigger(String userId, MilestoneDelight delight) async {
    // æ£€æŸ¥æ¯æ—¥ä¸Šé™
    final todayCount = await _getTodayDelightCount(userId);
    if (todayCount >= frequencyRules.maxDelightsPerDay) {
      return false;
    }

    // æ£€æŸ¥åŒç±»å‹é—´éš”
    final lastSameType = await _getLastDelightOfType(userId, delight.type);
    if (lastSameType != null) {
      final interval = DateTime.now().difference(lastSameType.timestamp);
      if (interval < frequencyRules.minIntervalBetweenSameType) {
        return false;
      }
    }

    // æ£€æŸ¥ç”¨æˆ·åå¥½
    if (frequencyRules.adaptToUserPreference) {
      final preference = await _getUserDelightPreference(userId);
      if (preference.delightFrequency == DelightFrequency.minimal) {
        // åªè§¦å‘é‡è¦é‡Œç¨‹ç¢‘
        return delight.importance >= DelightImportance.high;
      }
    }

    return true;
  }
}
```

### 28.3 ç¤¾äº¤åˆ†äº«ä¸å£ç¢‘ä¼ æ’­æœºåˆ¶

#### 28.3.1 å¯åˆ†äº«å†…å®¹è®¾è®¡

```dart
/// åˆ†äº«å†…å®¹æœåŠ¡
class ShareableContentService {
  /// ç”Ÿæˆæˆå°±åˆ†äº«å¡ç‰‡
  Future<ShareCard> generateAchievementCard(Achievement achievement) async {
    final user = await _getCurrentUser();
    final stats = await _getUserStats();

    return ShareCard(
      type: ShareCardType.achievement,
      title: achievement.title,
      subtitle: achievement.description,
      visual: AchievementVisual(
        badge: achievement.badge,
        backgroundColor: achievement.themeColor,
        animation: achievement.celebrationAnimation,
      ),
      stats: [
        StatItem(label: 'é’±é¾„', value: '${stats.moneyAge}å¤©'),
        StatItem(label: 'è®°è´¦å¤©æ•°', value: '${stats.recordingDays}å¤©'),
        StatItem(label: 'ç´¯è®¡èŠ‚çœ', value: 'Â¥${stats.totalSaved}'),
      ],
      callToAction: ShareCTA(
        text: 'å’Œæˆ‘ä¸€èµ·ç®¡ç†è´¢åŠ¡å§',
        link: 'https://aibook.app/invite/${user.referralCode}',
      ),
      branding: AppBranding(
        logo: 'assets/logo_small.png',
        slogan: 'AIæ™ºèƒ½è®°è´¦ - ä½ çš„æ™ºèƒ½ç†è´¢ä¼™ä¼´',
      ),
    );
  }

  /// ç”Ÿæˆå¹´åº¦/æœˆåº¦è´¦å•æŠ¥å‘Š
  Future<ShareCard> generateFinancialReport(ReportPeriod period) async {
    final report = await _generateReport(period);

    return ShareCard(
      type: ShareCardType.financialReport,
      title: '${period.year}å¹´${period.month}æœˆè´¢åŠ¡å°ç»“',
      sections: [
        ReportSection(
          title: 'æ”¶æ”¯æ¦‚è§ˆ',
          items: [
            ReportItem(icon: 'ğŸ’°', label: 'æ€»æ”¶å…¥', value: 'Â¥${report.totalIncome}'),
            ReportItem(icon: 'ğŸ’¸', label: 'æ€»æ”¯å‡º', value: 'Â¥${report.totalExpense}'),
            ReportItem(icon: 'ğŸ¯', label: 'ç»“ä½™', value: 'Â¥${report.balance}'),
          ],
        ),
        ReportSection(
          title: 'é’±é¾„å˜åŒ–',
          visualization: MoneyAgeTrendChart(data: report.moneyAgeTrend),
          highlight: 'é’±é¾„ä»${report.startMoneyAge}å¤©æå‡åˆ°${report.endMoneyAge}å¤©',
        ),
        ReportSection(
          title: 'æ¶ˆè´¹TOP3',
          items: report.topCategories.map((c) =>
            ReportItem(icon: c.icon, label: c.name, value: 'Â¥${c.amount}')
          ).toList(),
        ),
      ],
      style: ReportStyle.elegant,
      shareText: 'è¿™æ˜¯æˆ‘çš„${period.month}æœˆè´¢åŠ¡å°ç»“ï¼Œé’±é¾„${report.endMoneyAge}å¤©ï¼',
    );
  }

  /// ç”Ÿæˆé’±é¾„é‡Œç¨‹ç¢‘å¡ç‰‡
  Future<ShareCard> generateMoneyAgeMilestoneCard(int moneyAge) async {
    final level = MoneyAgeLevel.fromDays(moneyAge);

    return ShareCard(
      type: ShareCardType.moneyAgeMilestone,
      title: 'é’±é¾„${moneyAge}å¤©ï¼',
      subtitle: level.title,
      visual: MoneyAgeVisual(
        level: level,
        days: moneyAge,
        animation: 'money_age_celebration',
      ),
      encouragement: level.encouragement,
      shareText: 'æˆ‘çš„é’±é¾„è¾¾åˆ°${moneyAge}å¤©äº†ï¼ä½ çš„é’±èƒ½æ´»å¤šä¹…ï¼Ÿ',
    );
  }
}
```

#### 28.3.2 åˆ†äº«æ¸ é“ä¸è¿½è¸ª

```dart
/// åˆ†äº«æ¸ é“æœåŠ¡
class ShareChannelService {
  /// æ”¯æŒçš„åˆ†äº«æ¸ é“
  static const supportedChannels = [
    ShareChannel(
      id: 'wechat_moment',
      name: 'å¾®ä¿¡æœ‹å‹åœˆ',
      icon: 'wechat',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'wechat_friend',
      name: 'å¾®ä¿¡å¥½å‹',
      icon: 'wechat',
      cardStyle: ShareCardStyle.horizontal,
    ),
    ShareChannel(
      id: 'weibo',
      name: 'å¾®åš',
      icon: 'weibo',
      cardStyle: ShareCardStyle.vertical,
    ),
    ShareChannel(
      id: 'xiaohongshu',
      name: 'å°çº¢ä¹¦',
      icon: 'xiaohongshu',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'save_image',
      name: 'ä¿å­˜å›¾ç‰‡',
      icon: 'download',
      cardStyle: ShareCardStyle.square,
    ),
    ShareChannel(
      id: 'copy_link',
      name: 'å¤åˆ¶é“¾æ¥',
      icon: 'link',
    ),
  ];

  /// æ‰§è¡Œåˆ†äº«
  Future<ShareResult> share(ShareCard card, ShareChannel channel) async {
    // 1. æ ¹æ®æ¸ é“è°ƒæ•´å¡ç‰‡æ ·å¼
    final adaptedCard = _adaptCardForChannel(card, channel);

    // 2. ç”Ÿæˆåˆ†äº«å†…å®¹
    final content = await _generateShareContent(adaptedCard, channel);

    // 3. è°ƒç”¨åˆ†äº«SDK
    final result = await _invokeShareSdk(channel, content);

    // 4. è®°å½•åˆ†äº«äº‹ä»¶
    await _trackShareEvent(ShareEvent(
      cardType: card.type,
      channel: channel.id,
      success: result.success,
      timestamp: DateTime.now(),
    ));

    return result;
  }

  /// è¿½è¸ªåˆ†äº«å¸¦æ¥çš„æ–°ç”¨æˆ·
  Future<void> trackReferral(String referralCode, String newUserId) async {
    final referrer = await _getUserByReferralCode(referralCode);
    if (referrer != null) {
      // è®°å½•æ¨èå…³ç³»
      await _saveReferralRelation(
        referrerId: referrer.id,
        refereeId: newUserId,
        timestamp: DateTime.now(),
      );

      // ç»™æ¨èè€…å‘æ”¾å¥–åŠ±
      await _awardReferrer(referrer.id);

      // æ›´æ–°æ¨èè€…ç»Ÿè®¡
      await _updateReferrerStats(referrer.id);
    }
  }
}
```

#### 28.3.3 é‚€è¯·å¥–åŠ±æœºåˆ¶

```dart
/// é‚€è¯·å¥–åŠ±æœåŠ¡
class ReferralRewardService {
  /// å¥–åŠ±è§„åˆ™
  static const rewardRules = ReferralRewardRules(
    // æ¨èè€…å¥–åŠ±
    referrerRewards: [
      ReferralReward(
        trigger: 'referee_registered',
        reward: '7å¤©é«˜çº§ä¼šå‘˜ä½“éªŒ',
        description: 'å¥½å‹æ³¨å†ŒæˆåŠŸ',
      ),
      ReferralReward(
        trigger: 'referee_active_7_days',
        reward: 'è§£é”ä¸“å±ä¸»é¢˜',
        description: 'å¥½å‹æ´»è·ƒä½¿ç”¨7å¤©',
      ),
      ReferralReward(
        trigger: 'referee_subscribed',
        reward: '1ä¸ªæœˆé«˜çº§ä¼šå‘˜',
        description: 'å¥½å‹è®¢é˜…ä¼šå‘˜',
      ),
    ],

    // è¢«æ¨èè€…å¥–åŠ±
    refereeRewards: [
      ReferralReward(
        trigger: 'registration',
        reward: '14å¤©é«˜çº§ä¼šå‘˜ä½“éªŒ',
        description: 'æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±',
      ),
    ],

    // ç´¯è®¡æ¨èå¥–åŠ±
    cumulativeRewards: [
      CumulativeReward(
        count: 3,
        reward: 'æ¨èè¾¾äººå¾½ç« ',
      ),
      CumulativeReward(
        count: 10,
        reward: '3ä¸ªæœˆé«˜çº§ä¼šå‘˜',
      ),
      CumulativeReward(
        count: 50,
        reward: 'ç»ˆèº«é«˜çº§ä¼šå‘˜',
      ),
    ],
  );

  /// å¤„ç†æ¨èå¥–åŠ±
  Future<void> processReferralReward(ReferralEvent event) async {
    final rules = rewardRules;

    // æ£€æŸ¥æ¨èè€…å¥–åŠ±
    for (final reward in rules.referrerRewards) {
      if (reward.trigger == event.type) {
        await _grantReward(event.referrerId, reward);
        await _notifyReferrer(event.referrerId, reward);
      }
    }

    // æ£€æŸ¥ç´¯è®¡å¥–åŠ±
    final totalReferrals = await _getTotalReferrals(event.referrerId);
    for (final cumReward in rules.cumulativeRewards) {
      if (totalReferrals == cumReward.count) {
        await _grantReward(event.referrerId, cumReward.reward);
        await _celebrateMilestone(event.referrerId, cumReward);
      }
    }
  }
}
```

### 28.4 é¦–å‘¨ä»·å€¼æ„ŸçŸ¥è·¯å¾„

#### 28.4.1 é¦–å‘¨ä½“éªŒè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é¦–å‘¨ä»·å€¼æ„ŸçŸ¥è·¯å¾„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Day 1: åˆæ¬¡ä½“éªŒ                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: å®Œæˆé¦–ç¬”è®°è´¦ï¼Œåˆè¯†"é’±é¾„"æ¦‚å¿µ                               â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  æç®€æ³¨å†Œï¼ˆæ‰‹æœºå·ä¸€é”®ç™»å½•ï¼‰                                    â”‚   â”‚
â”‚  â”‚  â‘¡ 30ç§’æ–°æ‰‹å¼•å¯¼ï¼ˆçªå‡ºé’±é¾„æ¦‚å¿µï¼‰                                  â”‚   â”‚
â”‚  â”‚  â‘¢ å¼•å¯¼å®Œæˆé¦–ç¬”è®°è´¦                                              â”‚   â”‚
â”‚  â”‚  â‘£ ç«‹å³å±•ç¤ºé’±é¾„è®¡ç®—ç»“æœ                                          â”‚   â”‚
â”‚  â”‚  â‘¤ æƒŠå–œåŠ¨ç”» + "è®°è´¦ä¹‹æ—…å¼€å§‹äº†"                                   â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "åŸæ¥æˆ‘çš„é’±åªèƒ½æ´»Xå¤©"                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 2-3: å»ºç«‹ä¹ æƒ¯                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: ä½“éªŒAIä¾¿æ·ï¼Œè®¾ç½®é¦–ä¸ªå°é‡‘åº“                                 â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  æ¨é€æ¸©å’Œæé†’è®°è´¦                                              â”‚   â”‚
â”‚  â”‚  â‘¡ å¼•å¯¼å°è¯•è¯­éŸ³/æ‹ç…§è®°è´¦                                         â”‚   â”‚
â”‚  â”‚  â‘¢ å±•ç¤ºAIæ™ºèƒ½åˆ†ç±»èƒ½åŠ›                                            â”‚   â”‚
â”‚  â”‚  â‘£ å¼•å¯¼è®¾ç½®ç¬¬ä¸€ä¸ªå°é‡‘åº“é¢„ç®—                                      â”‚   â”‚
â”‚  â”‚  â‘¤ å¯è§†åŒ–å±•ç¤ºé¢„ç®—åˆ†é…                                            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "è®°è´¦åŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 4-5: äº§ç”Ÿæ´å¯Ÿ                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: è·å¾—é¦–ä¸ªæ¶ˆè´¹æ´å¯Ÿ                                          â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  ç§¯ç´¯è¶³å¤Ÿæ•°æ®åï¼Œç”Ÿæˆæ¶ˆè´¹åˆ†æ                                  â”‚   â”‚
â”‚  â”‚  â‘¡ å±•ç¤ºæ¶ˆè´¹åˆ†ç±»åˆ†å¸ƒ                                              â”‚   â”‚
â”‚  â”‚  â‘¢ æ™ºèƒ½å‘ç°æ¶ˆè´¹è§„å¾‹                                              â”‚   â”‚
â”‚  â”‚  â‘£ å¯¹æ¯”åŒé¾„äººå¹³å‡æ°´å¹³                                            â”‚   â”‚
â”‚  â”‚  â‘¤ ç»™å‡ºç¬¬ä¸€æ¡æ”¹å–„å»ºè®®                                            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "æˆ‘ç»ˆäºçŸ¥é“é’±éƒ½èŠ±å“ªäº†"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Day 6-7: å½¢æˆä¹ æƒ¯                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç›®æ ‡: å®Œæˆé¦–å‘¨ï¼Œå»ºç«‹åˆæ­¥ä¹ æƒ¯                                     â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â‘  å±•ç¤ºé¦–å‘¨è´¢åŠ¡å°ç»“                                              â”‚   â”‚
â”‚  â”‚  â‘¡ æ˜¾ç¤ºé’±é¾„å˜åŒ–è¶‹åŠ¿                                              â”‚   â”‚
â”‚  â”‚  â‘¢ è§£é”"åšæŒä¸€å‘¨"æˆå°±                                           â”‚   â”‚
â”‚  â”‚  â‘£ æ”¶é›†é¦–æ¬¡NPSåé¦ˆ                                               â”‚   â”‚
â”‚  â”‚  â‘¤ å¼•å¯¼è®¾ç½®å‚¨è“„ç›®æ ‡                                              â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ä»·å€¼æ„ŸçŸ¥ç‚¹: "ä¸€å‘¨å°±æœ‰äº†è¿™ä¹ˆå¤šå˜åŒ–"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 28.4.2 é¦–å‘¨å¼•å¯¼æœåŠ¡

```dart
/// é¦–å‘¨å¼•å¯¼æœåŠ¡
class FirstWeekGuidanceService {
  /// é¦–å‘¨ä»»åŠ¡æ¸…å•
  static const firstWeekTasks = [
    DailyTask(
      day: 1,
      tasks: [
        Task(id: 'complete_onboarding', name: 'å®Œæˆæ–°æ‰‹å¼•å¯¼', required: true),
        Task(id: 'first_transaction', name: 'è®°å½•ç¬¬ä¸€ç¬”è´¦', required: true),
        Task(id: 'view_money_age', name: 'æŸ¥çœ‹é’±é¾„', required: false),
      ],
    ),
    DailyTask(
      day: 2,
      tasks: [
        Task(id: 'try_voice_recording', name: 'å°è¯•è¯­éŸ³è®°è´¦', required: false),
        Task(id: 'second_transaction', name: 'è®°å½•ç¬¬äºŒç¬”è´¦', required: true),
      ],
    ),
    DailyTask(
      day: 3,
      tasks: [
        Task(id: 'setup_first_vault', name: 'è®¾ç½®ç¬¬ä¸€ä¸ªå°é‡‘åº“', required: true),
        Task(id: 'try_photo_recording', name: 'å°è¯•æ‹ç…§è®°è´¦', required: false),
      ],
    ),
    DailyTask(
      day: 4,
      tasks: [
        Task(id: 'view_category_stats', name: 'æŸ¥çœ‹åˆ†ç±»ç»Ÿè®¡', required: true),
        Task(id: 'continue_recording', name: 'ç»§ç»­è®°è´¦', required: true),
      ],
    ),
    DailyTask(
      day: 5,
      tasks: [
        Task(id: 'view_first_insight', name: 'æŸ¥çœ‹æ¶ˆè´¹æ´å¯Ÿ', required: true),
        Task(id: 'review_budget', name: 'æ£€æŸ¥é¢„ç®—ä½¿ç”¨æƒ…å†µ', required: false),
      ],
    ),
    DailyTask(
      day: 6,
      tasks: [
        Task(id: 'set_savings_goal', name: 'è®¾ç½®å‚¨è“„ç›®æ ‡', required: false),
        Task(id: 'explore_more_features', name: 'æ¢ç´¢æ›´å¤šåŠŸèƒ½', required: false),
      ],
    ),
    DailyTask(
      day: 7,
      tasks: [
        Task(id: 'view_weekly_summary', name: 'æŸ¥çœ‹é¦–å‘¨æ€»ç»“', required: true),
        Task(id: 'complete_nps_survey', name: 'å®Œæˆæ»¡æ„åº¦è°ƒæŸ¥', required: true),
      ],
    ),
  ];

  /// è·å–ä»Šæ—¥å¼•å¯¼ä»»åŠ¡
  Future<List<Task>> getTodayTasks(String userId) async {
    final daysActive = await _getDaysActive(userId);
    if (daysActive > 7) return [];  // é¦–å‘¨åä¸å†å¼•å¯¼

    final dailyTask = firstWeekTasks.firstWhere(
      (dt) => dt.day == daysActive,
      orElse: () => DailyTask(day: 0, tasks: []),
    );

    // è¿‡æ»¤å·²å®Œæˆçš„ä»»åŠ¡
    final completedTasks = await _getCompletedTasks(userId);
    return dailyTask.tasks
        .where((t) => !completedTasks.contains(t.id))
        .toList();
  }

  /// æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µå¹¶è§¦å‘å¥–åŠ±
  Future<void> checkTaskCompletion(String userId, String taskId) async {
    await _markTaskCompleted(userId, taskId);

    // æ£€æŸ¥æ˜¯å¦å®Œæˆä»Šæ—¥æ‰€æœ‰å¿…åšä»»åŠ¡
    final todayTasks = await getTodayTasks(userId);
    final requiredTasks = todayTasks.where((t) => t.required).toList();
    if (requiredTasks.isEmpty) {
      await _triggerDailyCompletion(userId);
    }

    // æ£€æŸ¥æ˜¯å¦å®Œæˆé¦–å‘¨æ‰€æœ‰ä»»åŠ¡
    final allCompleted = await _checkAllFirstWeekTasksCompleted(userId);
    if (allCompleted) {
      await _triggerFirstWeekCompletion(userId);
    }
  }
}
```

### 28.5 è´Ÿé¢ä½“éªŒæ£€æµ‹ä¸ä¿®å¤

#### 28.5.1 è´Ÿé¢ä¿¡å·æ£€æµ‹

```dart
/// è´Ÿé¢ä½“éªŒæ£€æµ‹æœåŠ¡
class NegativeExperienceDetector {
  /// è´Ÿé¢ä¿¡å·å®šä¹‰
  static const negativeSignals = [
    // æ“ä½œå±‚é¢çš„è´Ÿé¢ä¿¡å·
    NegativeSignal(
      id: 'repeated_failures',
      description: 'è¿ç»­æ“ä½œå¤±è´¥',
      detection: '3æ¬¡ä»¥ä¸Šè¿ç»­æ“ä½œå¤±è´¥',
      severity: SignalSeverity.medium,
    ),
    NegativeSignal(
      id: 'rage_clicks',
      description: 'æ„¤æ€’ç‚¹å‡»',
      detection: 'çŸ­æ—¶é—´å†…åŒä¸€ä½ç½®å¤šæ¬¡ç‚¹å‡»',
      severity: SignalSeverity.high,
    ),
    NegativeSignal(
      id: 'long_confusion',
      description: 'é•¿æ—¶é—´å›°æƒ‘',
      detection: 'åœ¨åŒä¸€é¡µé¢åœç•™è¶…è¿‡2åˆ†é’Ÿæ— æœ‰æ•ˆæ“ä½œ',
      severity: SignalSeverity.low,
    ),
    NegativeSignal(
      id: 'quick_exit',
      description: 'å¿«é€Ÿé€€å‡º',
      detection: 'è¿›å…¥åŠŸèƒ½å5ç§’å†…è¿”å›',
      severity: SignalSeverity.low,
    ),

    // ä½¿ç”¨æ¨¡å¼çš„è´Ÿé¢ä¿¡å·
    NegativeSignal(
      id: 'usage_decline',
      description: 'ä½¿ç”¨é¢‘ç‡ä¸‹é™',
      detection: 'å‘¨ä½¿ç”¨é¢‘ç‡ä¸‹é™è¶…è¿‡50%',
      severity: SignalSeverity.high,
    ),
    NegativeSignal(
      id: 'feature_abandonment',
      description: 'åŠŸèƒ½æ”¾å¼ƒ',
      detection: 'å¼€å§‹ä½¿ç”¨æŸåŠŸèƒ½åä¸­é€”æ”¾å¼ƒ',
      severity: SignalSeverity.medium,
    ),
    NegativeSignal(
      id: 'session_shortening',
      description: 'ä¼šè¯æ—¶é•¿ç¼©çŸ­',
      detection: 'å¹³å‡ä¼šè¯æ—¶é•¿æŒç»­ä¸‹é™',
      severity: SignalSeverity.medium,
    ),

    // æµå¤±é¢„è­¦ä¿¡å·
    NegativeSignal(
      id: 'approaching_churn',
      description: 'æ¥è¿‘æµå¤±',
      detection: '7å¤©æœªä½¿ç”¨',
      severity: SignalSeverity.critical,
    ),
    NegativeSignal(
      id: 'negative_feedback',
      description: 'è´Ÿé¢åé¦ˆ',
      detection: 'åº”ç”¨å•†åº—1-2æ˜Ÿè¯„ä»·æˆ–è´Ÿé¢åé¦ˆæäº¤',
      severity: SignalSeverity.critical,
    ),
  ];

  /// å®æ—¶æ£€æµ‹è´Ÿé¢ä¿¡å·
  Stream<NegativeSignalEvent> monitorNegativeSignals(String userId) async* {
    // ç›‘æ§æ“ä½œäº‹ä»¶
    await for (final event in _operationEventStream(userId)) {
      final signals = _detectOperationSignals(event);
      for (final signal in signals) {
        yield NegativeSignalEvent(
          userId: userId,
          signal: signal,
          context: event,
          timestamp: DateTime.now(),
        );
      }
    }
  }

  /// åˆ†æç”¨æˆ·çš„è´Ÿé¢ä½“éªŒæ¨¡å¼
  Future<NegativeExperienceReport> analyzeNegativePatterns(String userId) async {
    final signals = await _getRecentSignals(userId, days: 30);

    return NegativeExperienceReport(
      userId: userId,
      totalSignals: signals.length,
      signalsByType: _groupByType(signals),
      signalsByFeature: _groupByFeature(signals),
      churnRisk: _calculateChurnRisk(signals),
      recommendations: _generateRecoveryRecommendations(signals),
    );
  }
}
```

#### 28.5.2 è´Ÿé¢ä½“éªŒä¿®å¤æœºåˆ¶

```dart
/// è´Ÿé¢ä½“éªŒä¿®å¤æœåŠ¡
class NegativeExperienceRecoveryService {
  /// ä¿®å¤ç­–ç•¥
  static const recoveryStrategies = {
    // æ“ä½œå¤±è´¥ä¿®å¤
    'repeated_failures': RecoveryStrategy(
      immediateAction: 'å¼¹å‡ºå¸®åŠ©æç¤ºï¼Œè¯¢é—®æ˜¯å¦éœ€è¦ååŠ©',
      followUp: 'å‘é€æ“ä½œæŒ‡å—æ¨é€',
      escalation: 'é‚€è¯·åŠ å…¥ç”¨æˆ·æ”¯æŒç¾¤',
    ),

    // å›°æƒ‘çŠ¶æ€ä¿®å¤
    'long_confusion': RecoveryStrategy(
      immediateAction: 'æ˜¾ç¤ºåŠŸèƒ½å¼•å¯¼æ°”æ³¡',
      followUp: 'æ¨é€ç›¸å…³åŠŸèƒ½æ•™ç¨‹',
      escalation: null,
    ),

    // æ„¤æ€’ç‚¹å‡»ä¿®å¤
    'rage_clicks': RecoveryStrategy(
      immediateAction: 'æ˜¾ç¤º"é‡åˆ°é—®é¢˜ï¼Ÿè®©æˆ‘æ¥å¸®ä½ "å…¥å£',
      followUp: 'å‘é€å…³æ€€æ¶ˆæ¯å’Œå¸®åŠ©é“¾æ¥',
      escalation: 'äº§å“å›¢é˜Ÿä»‹å…¥åˆ†æ',
    ),

    // ä½¿ç”¨ä¸‹é™ä¿®å¤
    'usage_decline': RecoveryStrategy(
      immediateAction: null,
      followUp: 'å‘é€ä¸ªæ€§åŒ–å”¤é†’æ¶ˆæ¯',
      escalation: 'åˆ†ææµå¤±åŸå› ',
    ),

    // æ¥è¿‘æµå¤±ä¿®å¤
    'approaching_churn': RecoveryStrategy(
      immediateAction: null,
      followUp: 'å‘é€ä»·å€¼å›é¡¾æ¶ˆæ¯ï¼Œå±•ç¤ºç´¯è®¡æˆå°±',
      escalation: 'å‘é€æŒ½å›ä¼˜æƒ æˆ–1å¯¹1å…³æ€€',
    ),

    // è´Ÿé¢åé¦ˆä¿®å¤
    'negative_feedback': RecoveryStrategy(
      immediateAction: 'æ„Ÿè°¢åé¦ˆï¼Œæ‰¿è¯ºæ”¹è¿›',
      followUp: 'è·Ÿè¿›é—®é¢˜è§£å†³è¿›åº¦',
      escalation: 'äº§å“è´Ÿè´£äººäº²è‡ªå›å¤',
    ),
  };

  /// æ‰§è¡Œä¿®å¤ç­–ç•¥
  Future<void> executeRecovery(NegativeSignalEvent event) async {
    final strategy = recoveryStrategies[event.signal.id];
    if (strategy == null) return;

    // æ‰§è¡Œå³æ—¶ä¿®å¤
    if (strategy.immediateAction != null) {
      await _executeImmediateAction(event.userId, strategy.immediateAction!);
    }

    // å®‰æ’åç»­è·Ÿè¿›
    if (strategy.followUp != null) {
      await _scheduleFollowUp(
        userId: event.userId,
        action: strategy.followUp!,
        delay: Duration(hours: 24),
      );
    }

    // è®°å½•ä¿®å¤å°è¯•
    await _logRecoveryAttempt(event, strategy);
  }

  /// æµå¤±ç”¨æˆ·æŒ½å›
  Future<void> attemptChurnRecovery(String userId) async {
    final user = await _getUser(userId);
    final stats = await _getUserStats(userId);

    // ç”Ÿæˆä¸ªæ€§åŒ–æŒ½å›æ¶ˆæ¯
    final message = WinbackMessage(
      title: 'å¥½ä¹…ä¸è§ï¼Œæƒ³ä½ äº†',
      body: _generatePersonalizedWinbackMessage(user, stats),
      highlights: [
        'ä½ çš„é’±é¾„å·²è¾¾${stats.moneyAge}å¤©',
        'ç´¯è®¡è®°å½•${stats.totalTransactions}ç¬”è´¦',
        'æ€»å…±èŠ‚çœäº†Â¥${stats.totalSaved}',
      ],
      callToAction: 'å›æ¥çœ‹çœ‹',
      incentive: stats.isPremiumUser ? null : 'å›å½’å³é€7å¤©ä¼šå‘˜',
    );

    await _sendWinbackNotification(userId, message);
  }
}
```

### 28.6 æ¨èè€…åŸ¹è‚²è®¡åˆ’

#### 28.6.1 æ¨èè€…è¯†åˆ«

```dart
/// æ¨èè€…è¯†åˆ«æœåŠ¡
class PromoterIdentificationService {
  /// æ¨èè€…ç‰¹å¾
  static const promoterIndicators = [
    PromoterIndicator(
      id: 'high_engagement',
      description: 'é«˜æ´»è·ƒåº¦',
      criteria: 'å‘¨æ´»è·ƒâ‰¥5å¤©ï¼Œæ—¥å‡ä½¿ç”¨â‰¥3æ¬¡',
      weight: 0.25,
    ),
    PromoterIndicator(
      id: 'feature_adoption',
      description: 'åŠŸèƒ½é‡‡ç”¨å¹¿',
      criteria: 'ä½¿ç”¨â‰¥5ä¸ªæ ¸å¿ƒåŠŸèƒ½',
      weight: 0.20,
    ),
    PromoterIndicator(
      id: 'positive_outcomes',
      description: 'æ­£å‘æˆæœ',
      criteria: 'é’±é¾„æå‡ã€é¢„ç®—è¾¾æˆã€å‚¨è“„ç›®æ ‡è¿›å±•',
      weight: 0.25,
    ),
    PromoterIndicator(
      id: 'long_tenure',
      description: 'é•¿æœŸç”¨æˆ·',
      criteria: 'ä½¿ç”¨â‰¥3ä¸ªæœˆ',
      weight: 0.15,
    ),
    PromoterIndicator(
      id: 'social_behavior',
      description: 'ç¤¾äº¤è¡Œä¸º',
      criteria: 'æ›¾åˆ†äº«æˆå°±æˆ–é‚€è¯·å¥½å‹',
      weight: 0.15,
    ),
  ];

  /// è®¡ç®—æ¨èè€…æ½œåŠ›åˆ†æ•°
  Future<double> calculatePromoterPotential(String userId) async {
    double score = 0;

    for (final indicator in promoterIndicators) {
      final met = await _checkIndicator(userId, indicator);
      if (met) {
        score += indicator.weight;
      }
    }

    return score;  // 0-1ä¹‹é—´
  }

  /// è¯†åˆ«æ½œåœ¨æ¨èè€…
  Future<List<PotentialPromoter>> identifyPotentialPromoters() async {
    final activeUsers = await _getActiveUsers(days: 30);
    final potentialPromoters = <PotentialPromoter>[];

    for (final userId in activeUsers) {
      final score = await calculatePromoterPotential(userId);
      if (score >= 0.7) {  // é˜ˆå€¼
        potentialPromoters.add(PotentialPromoter(
          userId: userId,
          score: score,
          indicators: await _getMetIndicators(userId),
        ));
      }
    }

    return potentialPromoters..sort((a, b) => b.score.compareTo(a.score));
  }
}
```

#### 28.6.2 æ¨èè€…æ¿€æ´»

```dart
/// æ¨èè€…æ¿€æ´»æœåŠ¡
class PromoterActivationService {
  /// æ¿€æ´»ç­–ç•¥
  Future<void> activatePromoter(PotentialPromoter promoter) async {
    // 1. å‘é€ä¸“å±æ„Ÿè°¢
    await _sendAppreciationMessage(promoter.userId);

    // 2. é‚€è¯·åŠ å…¥VIPç”¨æˆ·ç¾¤
    await _inviteToVipGroup(promoter.userId);

    // 3. è§£é”æ¨èè€…ä¸“å±åŠŸèƒ½
    await _unlockPromoterFeatures(promoter.userId);

    // 4. å±•ç¤ºæ¨èå…¥å£
    await _enablePromoterDashboard(promoter.userId);
  }

  /// æ¨èè€…ä¸“å±åŠŸèƒ½
  static const promoterFeatures = [
    PromoterFeature(
      id: 'custom_share_cards',
      name: 'å®šåˆ¶åˆ†äº«å¡ç‰‡',
      description: 'å¯è‡ªå®šä¹‰åˆ†äº«å¡ç‰‡çš„æ ·å¼å’Œå†…å®¹',
    ),
    PromoterFeature(
      id: 'referral_dashboard',
      name: 'æ¨èæ•°æ®é¢æ¿',
      description: 'æŸ¥çœ‹é‚€è¯·å¥½å‹çš„æ•°æ®ç»Ÿè®¡',
    ),
    PromoterFeature(
      id: 'early_access',
      name: 'æ–°åŠŸèƒ½æŠ¢å…ˆä½“éªŒ',
      description: 'ä¼˜å…ˆä½“éªŒæ–°åŠŸèƒ½å¹¶æä¾›åé¦ˆ',
    ),
    PromoterFeature(
      id: 'priority_support',
      name: 'ä¼˜å…ˆå®¢æœæ”¯æŒ',
      description: 'ä¸“å±å®¢æœé€šé“ï¼Œå¿«é€Ÿå“åº”',
    ),
  ];

  /// æ¨èè€…ä»ªè¡¨ç›˜æ•°æ®
  Future<PromoterDashboard> getPromoterDashboard(String userId) async {
    return PromoterDashboard(
      totalReferrals: await _getTotalReferrals(userId),
      activeReferrals: await _getActiveReferrals(userId),
      earnedRewards: await _getEarnedRewards(userId),
      pendingRewards: await _getPendingRewards(userId),
      referralLink: await _getReferralLink(userId),
      shareStats: await _getShareStats(userId),
    );
  }
}
```

### 28.7 è´¬æŸè€…æŒ½å›ç­–ç•¥

#### 28.7.1 è´¬æŸè€…åˆ†æ

```dart
/// è´¬æŸè€…åˆ†ææœåŠ¡
class DetractorAnalysisService {
  /// è´¬æŸè€…ç±»å‹
  enum DetractorType {
    functional,      // åŠŸèƒ½ä¸æ»¡æ„
    experience,      // ä½“éªŒä¸æ»¡æ„
    expectation,     // æœŸæœ›è½å·®
    technical,       // æŠ€æœ¯é—®é¢˜
    value,           // ä»·å€¼æ„ŸçŸ¥ä¸è¶³
  }

  /// åˆ†æè´¬æŸåŸå› 
  Future<DetractorAnalysis> analyzeDetractor(String userId, int npsScore, String? reason) async {
    final analysis = DetractorAnalysis(userId: userId, npsScore: npsScore);

    // åˆ†ææ–‡æœ¬åé¦ˆ
    if (reason != null) {
      analysis.detractorType = await _classifyReason(reason);
      analysis.keyIssues = await _extractKeyIssues(reason);
    }

    // åˆ†æä½¿ç”¨è¡Œä¸º
    analysis.usagePattern = await _analyzeUsagePattern(userId);
    analysis.failurePoints = await _identifyFailurePoints(userId);
    analysis.abandonedFeatures = await _getAbandonedFeatures(userId);

    // è¯„ä¼°æŒ½å›å¯èƒ½æ€§
    analysis.recoveryProbability = _calculateRecoveryProbability(analysis);

    return analysis;
  }

  /// è®¡ç®—æŒ½å›å¯èƒ½æ€§
  double _calculateRecoveryProbability(DetractorAnalysis analysis) {
    double probability = 0.5;  // åŸºç¡€æ¦‚ç‡

    // æ ¹æ®è´¬æŸç±»å‹è°ƒæ•´
    switch (analysis.detractorType) {
      case DetractorType.technical:
        probability += 0.3;  // æŠ€æœ¯é—®é¢˜å®¹æ˜“ä¿®å¤
        break;
      case DetractorType.functional:
        probability += 0.2;  // åŠŸèƒ½é—®é¢˜å¯ä»¥æ”¹è¿›
        break;
      case DetractorType.experience:
        probability += 0.1;  // ä½“éªŒé—®é¢˜éœ€è¦æ—¶é—´
        break;
      case DetractorType.expectation:
        probability -= 0.1;  // æœŸæœ›è½å·®è¾ƒéš¾å¼¥è¡¥
        break;
      case DetractorType.value:
        probability -= 0.2;  // ä»·å€¼æ„ŸçŸ¥é—®é¢˜è¾ƒéš¾
        break;
    }

    // æ ¹æ®ä½¿ç”¨æ—¶é•¿è°ƒæ•´
    if (analysis.usagePattern.daysActive > 30) {
      probability += 0.1;  // è€ç”¨æˆ·æ›´å®¹æ˜“æŒ½å›
    }

    return probability.clamp(0.0, 1.0);
  }
}
```

#### 28.7.2 è´¬æŸè€…æŒ½å›æ‰§è¡Œ

```dart
/// è´¬æŸè€…æŒ½å›æœåŠ¡
class DetractorRecoveryService {
  /// æŒ½å›ç­–ç•¥
  Future<RecoveryPlan> createRecoveryPlan(DetractorAnalysis analysis) async {
    final plan = RecoveryPlan(userId: analysis.userId);

    // æ ¹æ®è´¬æŸç±»å‹åˆ¶å®šç­–ç•¥
    switch (analysis.detractorType) {
      case DetractorType.technical:
        plan.immediateActions = [
          'ç«‹å³è”ç³»ç”¨æˆ·äº†è§£æŠ€æœ¯é—®é¢˜è¯¦æƒ…',
          'ä¼˜å…ˆä¿®å¤ç”¨æˆ·é‡åˆ°çš„æŠ€æœ¯é—®é¢˜',
          'ä¿®å¤åä¸»åŠ¨é€šçŸ¥ç”¨æˆ·å¹¶é“æ­‰',
        ];
        plan.compensation = 'èµ é€1ä¸ªæœˆä¼šå‘˜';
        break;

      case DetractorType.functional:
        plan.immediateActions = [
          'è®°å½•åŠŸèƒ½æ”¹è¿›å»ºè®®',
          'å‘ŠçŸ¥ç”¨æˆ·æ”¹è¿›è®¡åˆ’å’Œé¢„æœŸæ—¶é—´',
          'é‚€è¯·ç”¨æˆ·åŠ å…¥åŠŸèƒ½å†…æµ‹ç¾¤',
        ];
        plan.compensation = 'è§£é”é«˜çº§åŠŸèƒ½14å¤©ä½“éªŒ';
        break;

      case DetractorType.experience:
        plan.immediateActions = [
          'å®‰æ’1å¯¹1ä½¿ç”¨æŒ‡å¯¼',
          'å‘é€ä¸ªæ€§åŒ–ä½¿ç”¨æ•™ç¨‹',
          'æŒç»­è·Ÿè¿›ä½¿ç”¨ä½“éªŒ',
        ];
        plan.compensation = null;  // ä¸éœ€è¦ç‰©è´¨è¡¥å¿
        break;

      case DetractorType.value:
        plan.immediateActions = [
          'å±•ç¤ºç”¨æˆ·å·²è·å¾—çš„ä»·å€¼ï¼ˆçœé’±é‡‘é¢ã€é’±é¾„æå‡ï¼‰',
          'æ¨èæ›´é€‚åˆç”¨æˆ·çš„åŠŸèƒ½ç»„åˆ',
          'æä¾›1å¯¹1è´¢åŠ¡è§„åˆ’å»ºè®®',
        ];
        plan.compensation = 'å»¶é•¿ä¼šå‘˜ä½“éªŒæœŸ';
        break;

      default:
        plan.immediateActions = [
          'å‘é€è¯šæŒšé“æ­‰å’Œæ„Ÿè°¢åé¦ˆ',
          'é‚€è¯·æ·±åº¦è®¿è°ˆäº†è§£å…·ä½“é—®é¢˜',
        ];
    }

    return plan;
  }

  /// æ‰§è¡ŒæŒ½å›è®¡åˆ’
  Future<RecoveryResult> executeRecoveryPlan(RecoveryPlan plan) async {
    final result = RecoveryResult(userId: plan.userId);

    // æ‰§è¡Œå³æ—¶è¡ŒåŠ¨
    for (final action in plan.immediateActions) {
      try {
        await _executeAction(plan.userId, action);
        result.completedActions.add(action);
      } catch (e) {
        result.failedActions.add(ActionFailure(action: action, error: e.toString()));
      }
    }

    // å‘æ”¾è¡¥å¿
    if (plan.compensation != null) {
      await _grantCompensation(plan.userId, plan.compensation!);
      result.compensationGranted = true;
    }

    // è®¾ç½®è·Ÿè¿›æé†’
    await _scheduleFollowUp(plan.userId, Duration(days: 7));

    return result;
  }

  /// è·Ÿè¿›è´¬æŸè€…çŠ¶æ€
  Future<void> followUpDetractor(String userId) async {
    // æ£€æŸ¥ç”¨æˆ·è¿‘æœŸè¡Œä¸º
    final recentActivity = await _getRecentActivity(userId);

    if (recentActivity.isActive) {
      // ç”¨æˆ·å›å½’æ´»è·ƒï¼Œå‘é€æ„Ÿè°¢
      await _sendThankYouMessage(userId);

      // å†æ¬¡æ”¶é›†NPS
      await _scheduleNpsSurvey(userId, delay: Duration(days: 14));
    } else {
      // ç”¨æˆ·ä»ä¸æ´»è·ƒï¼Œå‡çº§å¤„ç†
      await _escalateToManualOutreach(userId);
    }
  }
}
```

### 28.8 ç›®æ ‡è¾¾æˆæ£€æµ‹

```dart
/// NPSç›®æ ‡è¾¾æˆæ£€æµ‹æœåŠ¡
class NpsGoalDetector {
  /// NPSç›¸å…³ç›®æ ‡
  static const npsGoals = NpsGoalCriteria(
    // æ ¸å¿ƒNPSæŒ‡æ ‡
    overallNps: NpsTarget(
      target: 50,
      measurement: 'æ•´ä½“ç”¨æˆ·NPSè¯„åˆ†',
    ),

    // æ¨èè€…æ¯”ä¾‹
    promoterRate: RateTarget(
      target: 0.40,  // 40%æ¨èè€…
      measurement: '9-10åˆ†ç”¨æˆ·å æ¯”',
    ),

    // è´¬æŸè€…æ¯”ä¾‹
    detractorRate: RateTarget(
      target: 0.10,  // æ§åˆ¶åœ¨10%ä»¥å†…
      measurement: '0-6åˆ†ç”¨æˆ·å æ¯”',
    ),

    // å£ç¢‘è·å®¢æ¯”ä¾‹
    referralRate: RateTarget(
      target: 0.15,  // 15%ç”¨æˆ·æ¥è‡ªæ¨è
      measurement: 'æ¨èæ³¨å†Œç”¨æˆ·å æ¯”',
    ),

    // åˆ†äº«ç‡
    shareRate: RateTarget(
      target: 0.20,  // 20%ç”¨æˆ·æœ‰åˆ†äº«è¡Œä¸º
      measurement: 'æœ‰åˆ†äº«è¡Œä¸ºçš„æ´»è·ƒç”¨æˆ·å æ¯”',
    ),
  );

  /// æ£€æµ‹ç›®æ ‡è¾¾æˆçŠ¶æ€
  Future<NpsGoalStatus> checkGoalStatus() async {
    final status = NpsGoalStatus();

    // è®¡ç®—å½“å‰NPS
    final currentNps = await _calculateCurrentNps();
    status.overallNps = GoalCheckResult(
      current: currentNps,
      target: npsGoals.overallNps.target,
      achieved: currentNps >= npsGoals.overallNps.target,
    );

    // è®¡ç®—æ¨èè€…æ¯”ä¾‹
    final promoterRate = await _calculatePromoterRate();
    status.promoterRate = GoalCheckResult(
      current: promoterRate,
      target: npsGoals.promoterRate.target,
      achieved: promoterRate >= npsGoals.promoterRate.target,
    );

    // è®¡ç®—è´¬æŸè€…æ¯”ä¾‹
    final detractorRate = await _calculateDetractorRate();
    status.detractorRate = GoalCheckResult(
      current: detractorRate,
      target: npsGoals.detractorRate.target,
      achieved: detractorRate <= npsGoals.detractorRate.target,  // è¶Šä½è¶Šå¥½
    );

    // è®¡ç®—å£ç¢‘è·å®¢æ¯”ä¾‹
    final referralRate = await _calculateReferralRate();
    status.referralRate = GoalCheckResult(
      current: referralRate,
      target: npsGoals.referralRate.target,
      achieved: referralRate >= npsGoals.referralRate.target,
    );

    // è®¡ç®—åˆ†äº«ç‡
    final shareRate = await _calculateShareRate();
    status.shareRate = GoalCheckResult(
      current: shareRate,
      target: npsGoals.shareRate.target,
      achieved: shareRate >= npsGoals.shareRate.target,
    );

    return status;
  }

  /// ç”ŸæˆNPSæ”¹è¿›å»ºè®®
  Future<List<NpsImprovement>> generateImprovementSuggestions(NpsGoalStatus status) async {
    final suggestions = <NpsImprovement>[];

    if (!status.overallNps.achieved) {
      // åˆ†æNPSçŸ­æ¿
      final analysis = await _analyzeNpsDrivers();

      if (analysis.functionalSatisfaction < 0.7) {
        suggestions.add(NpsImprovement(
          area: 'åŠŸèƒ½ä»·å€¼',
          priority: Priority.high,
          suggestions: [
            'æå‡é’±é¾„åˆ†æçš„å‡†ç¡®æ€§å’Œæ´å¯Ÿæ·±åº¦',
            'å¢å¼ºé¢„ç®—ç®¡ç†çš„æ™ºèƒ½æ¨èèƒ½åŠ›',
            'ä¼˜åŒ–AIè¯†åˆ«çš„å‡†ç¡®ç‡',
          ],
        ));
      }

      if (analysis.experienceSatisfaction < 0.7) {
        suggestions.add(NpsImprovement(
          area: 'ä½“éªŒè´¨é‡',
          priority: Priority.high,
          suggestions: [
            'ç®€åŒ–æ ¸å¿ƒæ“ä½œæµç¨‹',
            'ä¼˜åŒ–é¦–å‘¨å¼•å¯¼ä½“éªŒ',
            'æå‡åº”ç”¨æ€§èƒ½å’Œç¨³å®šæ€§',
          ],
        ));
      }

      if (analysis.emotionalConnection < 0.5) {
        suggestions.add(NpsImprovement(
          area: 'æƒ…æ„Ÿè¿æ¥',
          priority: Priority.medium,
          suggestions: [
            'å¢åŠ æƒŠå–œæ—¶åˆ»çš„è§¦å‘ç‚¹',
            'ä¼˜åŒ–ä¼™ä¼´åŒ–æ–‡æ¡ˆçš„æƒ…æ„Ÿè¡¨è¾¾',
            'ä¸°å¯Œæˆå°±ç³»ç»Ÿçš„å¥–åŠ±æœºåˆ¶',
          ],
        ));
      }
    }

    if (!status.shareRate.achieved) {
      suggestions.add(NpsImprovement(
        area: 'åˆ†äº«æœºåˆ¶',
        priority: Priority.medium,
        suggestions: [
          'ä¼˜åŒ–åˆ†äº«å¡ç‰‡çš„è§†è§‰è®¾è®¡',
          'å¢åŠ æ›´å¤šå¯åˆ†äº«çš„å†…å®¹ç±»å‹',
          'ç®€åŒ–åˆ†äº«æ“ä½œæµç¨‹',
        ],
      ));
    }

    return suggestions;
  }
}
```

'''

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    # åœ¨æ–‡æ¡£æœ«å°¾æ·»åŠ æ–°ç« èŠ‚
    content = content.rstrip() + NPS_CHAPTER

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

    print("å·²æ·»åŠ ç¬¬28ç« ï¼šç”¨æˆ·å£ç¢‘ä¸NPSæå‡è®¾è®¡")

if __name__ == '__main__':
    main()
