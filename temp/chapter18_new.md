## 18. æµ‹è¯•ç­–ç•¥

æœ¬ç« èŠ‚å®šä¹‰2.0ç‰ˆæœ¬çš„å…¨é¢æµ‹è¯•ç­–ç•¥ï¼Œç¡®ä¿äº§å“è´¨é‡å’Œç”¨æˆ·ä½“éªŒã€‚

### 18.0 è®¾è®¡åŸåˆ™ä¸æµ‹è¯•ç›®æ ‡

#### 18.0.1 æµ‹è¯•è®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æµ‹è¯•è®¾è®¡åŸåˆ™                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è´¨é‡ä¼˜å…ˆ   â”‚    â”‚  è‡ªåŠ¨åŒ–é©±åŠ¨  â”‚    â”‚  å¿«é€Ÿåé¦ˆ   â”‚    â”‚  æŒç»­æ”¹è¿›   â”‚ â”‚
â”‚  â”‚  Quality    â”‚    â”‚  Automation â”‚    â”‚    Fast     â”‚    â”‚  Continuous â”‚ â”‚
â”‚  â”‚   First     â”‚    â”‚   Driven    â”‚    â”‚  Feedback   â”‚    â”‚ Improvement â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†“                  â†“                  â†“                  â†“          â”‚
â”‚   åŠŸèƒ½æ­£ç¡®æ€§ä¼˜å…ˆ     æµ‹è¯•ä»£ç å³æ–‡æ¡£       CI/CDå¿«é€ŸéªŒè¯      æµ‹è¯•è¦†ç›–ç‡æŒç»­   â”‚
â”‚   ç”¨æˆ·ä½“éªŒä¿éšœ       å‡å°‘æ‰‹å·¥æµ‹è¯•         æœ¬åœ°éªŒè¯ç§’çº§        è¿½è¸ªå’Œæå‡       â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 18.0.2 2.0ç‰ˆæœ¬æµ‹è¯•é‡ç‚¹

| æµ‹è¯•é‡ç‚¹ | æè¿° | ä¼˜å…ˆçº§ |
|----------|------|--------|
| **é’±é¾„è®¡ç®—** | FIFOç®—æ³•æ­£ç¡®æ€§ã€è¾¹ç•Œæ¡ä»¶ã€æ€§èƒ½ | P0 |
| **é›¶åŸºé¢„ç®—** | åˆ†é…é€»è¾‘ã€ç»“è½¬è§„åˆ™ã€é¢„è­¦è§¦å‘ | P0 |
| **å°é‡‘åº“ç³»ç»Ÿ** | ä½™é¢è®¡ç®—ã€åˆ†é…éªŒè¯ã€å±•ç¤ºæ­£ç¡® | P0 |
| **AIè¯­éŸ³è¯†åˆ«** | è¯†åˆ«å‡†ç¡®ç‡ã€å¤šäº¤æ˜“è§£æã€é”™è¯¯æ¢å¤ | P1 |
| **æ•°æ®è”åŠ¨** | ä¸‹é’»å¯¼èˆªã€çŠ¶æ€åŒæ­¥ã€åˆ·æ–°æœºåˆ¶ | P1 |
| **ç¦»çº¿åŒæ­¥** | å†²çªè§£å†³ã€é˜Ÿåˆ—å¤„ç†ã€æ–­ç‚¹ç»­ä¼  | P1 |
| **å›½é™…åŒ–** | å¤šè¯­è¨€æ˜¾ç¤ºã€è´§å¸æ ¼å¼ã€æ—¥æœŸæ ¼å¼ | P2 |

### 18.1 æµ‹è¯•é‡‘å­—å¡”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æµ‹è¯•é‡‘å­—å¡”                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚ E2E   â”‚  5%   ç«¯åˆ°ç«¯æµ‹è¯•                    â”‚
â”‚                             â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€      (å…³é”®ç”¨æˆ·æ—…ç¨‹)                â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                           â”‚  é›†æˆæµ‹è¯•    â”‚  15%  (API/æ•°æ®åº“/æœåŠ¡é›†æˆ)      â”‚
â”‚                          â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                                â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                        â”‚    Widgetæµ‹è¯•     â”‚  25%  (UIç»„ä»¶/é¡µé¢äº¤äº’)        â”‚
â”‚                       â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                             â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                     â”‚        å•å…ƒæµ‹è¯•            â”‚  55%  (ä¸šåŠ¡é€»è¾‘/æ¨¡å‹)     â”‚
â”‚                    â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                        â”‚
â”‚                                                                           â”‚
â”‚  æ‰§è¡Œé¢‘ç‡:   æ¯æ¬¡æäº¤    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   æ¯æ—¥    â”‚
â”‚  æ‰§è¡Œé€Ÿåº¦:   æ¯«ç§’çº§      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   åˆ†é’Ÿçº§  â”‚
â”‚  ç»´æŠ¤æˆæœ¬:   ä½          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   é«˜      â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18.2 å•å…ƒæµ‹è¯•ç­–ç•¥

#### 18.2.1 è¦†ç›–ç‡è¦æ±‚

```dart
/// å•å…ƒæµ‹è¯•è¦†ç›–è¦æ±‚
class UnitTestCoverage {
  /// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ - æœ€é«˜ä¼˜å…ˆçº§
  static const coreLogicCoverage = {
    'MoneyAgeCalculator': 95,      // é’±é¾„è®¡ç®— â‰¥95%
    'BudgetAllocationService': 95, // é¢„ç®—åˆ†é… â‰¥95%
    'VaultBalanceService': 90,     // å°é‡‘åº“ä½™é¢ â‰¥90%
    'TransactionMatcher': 90,      // äº¤æ˜“åŒ¹é… â‰¥90%
    'DataSyncService': 85,         // æ•°æ®åŒæ­¥ â‰¥85%
    'ConflictResolver': 90,        // å†²çªè§£å†³ â‰¥90%
  };

  /// æ•°æ®æ¨¡å‹ - é«˜è¦†ç›–è¦æ±‚
  static const modelCoverage = {
    'Transaction': 90,
    'Budget': 90,
    'BudgetVault': 90,
    'MoneyAge': 90,
    'SyncQueue': 85,
  };

  /// AIæœåŠ¡ - ä¸­é«˜è¦†ç›–
  static const aiServiceCoverage = {
    'QwenService': 80,
    'VoiceRecognitionParser': 85,
    'TransactionExtractor': 85,
  };

  /// å·¥å…·ç±» - ä¸­ç­‰è¦†ç›–è¦æ±‚
  static const utilsCoverage = {
    'DateUtils': 80,
    'CurrencyUtils': 80,
    'ValidationUtils': 85,
    'LocalizationService': 75,
  };
}
```

#### 18.2.2 é’±é¾„è®¡ç®—å•å…ƒæµ‹è¯•

```dart
/// é’±é¾„è®¡ç®—å•å…ƒæµ‹è¯•
@Tags(['unit', 'money-age', 'core'])
void main() {
  group('MoneyAgeCalculator', () {
    late MoneyAgeCalculator calculator;
    late MockTransactionRepository mockRepo;

    setUp(() {
      mockRepo = MockTransactionRepository();
      calculator = MoneyAgeCalculator(repository: mockRepo);
    });

    group('åŸºç¡€åœºæ™¯', () {
      test('ç©ºäº¤æ˜“åˆ—è¡¨åº”è¿”å›é›¶é’±é¾„', () {
        when(mockRepo.getTransactions(any)).thenReturn([]);

        final result = calculator.calculate(DateTime.now());

        expect(result.days, equals(0));
        expect(result.level, equals(MoneyAgeLevel.danger));
      });

      test('åªæœ‰æ”¶å…¥æ— æ”¯å‡ºåº”è¿”å›æœ€å¤§é’±é¾„', () {
        final income = Transaction(
          type: TransactionType.income,
          amount: 10000,
          date: DateTime.now().subtract(Duration(days: 60)),
        );
        when(mockRepo.getTransactions(any)).thenReturn([income]);

        final result = calculator.calculate(DateTime.now());

        expect(result.days, greaterThanOrEqualTo(60));
        expect(result.level, equals(MoneyAgeLevel.excellent));
      });
    });

    group('FIFOç®—æ³•éªŒè¯', () {
      test('FIFOç®—æ³•æ­£ç¡®æ¶ˆè€—æ”¶å…¥', () {
        final incomes = [
          Transaction(type: TransactionType.income, amount: 1000,
            date: DateTime.now().subtract(Duration(days: 30))),
          Transaction(type: TransactionType.income, amount: 2000,
            date: DateTime.now().subtract(Duration(days: 15))),
        ];
        final expense = Transaction(
          type: TransactionType.expense,
          amount: 1500,
          date: DateTime.now(),
        );
        when(mockRepo.getTransactions(any)).thenReturn([...incomes, expense]);

        final result = calculator.calculate(DateTime.now());

        // 1500æ”¯å‡ºåº”å…ˆæ¶ˆè€—30å¤©å‰çš„1000ï¼Œå†æ¶ˆè€—15å¤©å‰çš„500
        // åŠ æƒå¹³å‡: (1000*30 + 500*15) / 1500 = 25å¤©
        expect(result.days, closeTo(25, 1));
      });

      test('æ”¯å‡ºå¤§äºæ€»æ”¶å…¥æ—¶é’±é¾„ä¸º0', () {
        final income = Transaction(
          type: TransactionType.income,
          amount: 1000,
          date: DateTime.now().subtract(Duration(days: 30)),
        );
        final expense = Transaction(
          type: TransactionType.expense,
          amount: 2000,
          date: DateTime.now(),
        );
        when(mockRepo.getTransactions(any)).thenReturn([income, expense]);

        final result = calculator.calculate(DateTime.now());

        expect(result.days, equals(0));
        expect(result.isNegativeBalance, isTrue);
      });
    });

    group('é’±é¾„ç­‰çº§åˆ¤å®š', () {
      test('0-7å¤©ä¸ºå±é™©ç­‰çº§', () {
        final result = MoneyAge(days: 5);
        expect(result.level, equals(MoneyAgeLevel.danger));
        expect(result.levelColor, equals(Colors.red));
      });

      test('8-14å¤©ä¸ºè­¦å‘Šç­‰çº§', () {
        final result = MoneyAge(days: 10);
        expect(result.level, equals(MoneyAgeLevel.warning));
      });

      test('15-29å¤©ä¸ºè‰¯å¥½ç­‰çº§', () {
        final result = MoneyAge(days: 20);
        expect(result.level, equals(MoneyAgeLevel.good));
      });

      test('30å¤©ä»¥ä¸Šä¸ºä¼˜ç§€ç­‰çº§', () {
        final result = MoneyAge(days: 45);
        expect(result.level, equals(MoneyAgeLevel.excellent));
      });
    });

    group('è¾¹ç•Œæ¡ä»¶', () {
      test('å¤„ç†åŒä¸€å¤©çš„å¤šç¬”äº¤æ˜“', () { /* ... */ });
      test('å¤„ç†è·¨å¹´äº¤æ˜“', () { /* ... */ });
      test('å¤„ç†å¤§é‡äº¤æ˜“(10000+)æ€§èƒ½', () { /* ... */ });
    });
  });
}
```

#### 18.2.3 é›¶åŸºé¢„ç®—å•å…ƒæµ‹è¯•

```dart
/// é›¶åŸºé¢„ç®—å•å…ƒæµ‹è¯•
@Tags(['unit', 'budget', 'core'])
void main() {
  group('BudgetAllocationService', () {
    late BudgetAllocationService service;

    setUp(() {
      service = BudgetAllocationService();
    });

    group('æ”¶å…¥åˆ†é…', () {
      test('æ”¶å…¥åº”å®Œå…¨åˆ†é…åˆ°å„é¢„ç®—ç±»åˆ«', () {
        final income = 10000.0;
        final allocations = {
          'food': 3000.0,
          'transport': 1000.0,
          'entertainment': 500.0,
          'savings': 5500.0,
        };

        final result = service.allocate(income, allocations);

        expect(result.isValid, isTrue);
        expect(result.unallocated, equals(0));
        expect(result.totalAllocated, equals(income));
      });

      test('åˆ†é…è¶…è¿‡æ”¶å…¥åº”æŠ¥é”™', () {
        final income = 10000.0;
        final allocations = {
          'food': 6000.0,
          'transport': 5000.0,
        };

        expect(
          () => service.allocate(income, allocations),
          throwsA(isA<AllocationExceededException>()),
        );
      });

      test('éƒ¨åˆ†åˆ†é…åº”æ˜¾ç¤ºæœªåˆ†é…é‡‘é¢', () {
        final income = 10000.0;
        final allocations = {'food': 3000.0};

        final result = service.allocate(income, allocations);

        expect(result.unallocated, equals(7000.0));
        expect(result.allocationRate, equals(0.3));
      });
    });

    group('é¢„ç®—ç»“è½¬', () {
      test('æœˆæœ«ç»“ä½™æ­£ç¡®ç»“è½¬åˆ°ä¸‹æœˆ', () {
        final currentBudget = Budget(
          category: 'food',
          amount: 3000,
          spent: 2500,
          month: DateTime(2024, 12),
        );

        final nextMonth = service.carryOver(currentBudget);

        expect(nextMonth.carryOverAmount, equals(500));
        expect(nextMonth.month, equals(DateTime(2025, 1)));
      });

      test('è¶…æ”¯é¢„ç®—ä¸ç»“è½¬è´Ÿæ•°', () {
        final overBudget = Budget(
          category: 'food',
          amount: 3000,
          spent: 3500,
          month: DateTime(2024, 12),
        );

        final nextMonth = service.carryOver(overBudget);

        expect(nextMonth.carryOverAmount, equals(0));
        expect(nextMonth.previousOverspend, equals(500));
      });
    });

    group('é¢„ç®—é¢„è­¦', () {
      test('ä½¿ç”¨ç‡è¾¾80%è§¦å‘é¢„è­¦', () {
        final budget = Budget(amount: 1000, spent: 800);

        expect(budget.warningLevel, equals(BudgetWarning.approaching));
        expect(budget.shouldNotify, isTrue);
      });

      test('ä½¿ç”¨ç‡è¾¾100%è§¦å‘è¶…æ”¯è­¦å‘Š', () {
        final budget = Budget(amount: 1000, spent: 1000);

        expect(budget.warningLevel, equals(BudgetWarning.exceeded));
      });
    });
  });
}
```

#### 18.2.4 å°é‡‘åº“å•å…ƒæµ‹è¯•

```dart
/// å°é‡‘åº“å•å…ƒæµ‹è¯•
@Tags(['unit', 'vault', 'core'])
void main() {
  group('VaultService', () {
    late VaultService service;

    test('åˆ›å»ºå°é‡‘åº“åˆå§‹ä½™é¢ä¸º0', () {
      final vault = service.create(name: 'æ—…æ¸¸åŸºé‡‘', targetAmount: 10000);

      expect(vault.balance, equals(0));
      expect(vault.progress, equals(0));
    });

    test('å­˜å…¥é‡‘é¢æ­£ç¡®æ›´æ–°ä½™é¢', () {
      final vault = Vault(balance: 1000);

      final updated = service.deposit(vault, 500);

      expect(updated.balance, equals(1500));
    });

    test('å–å‡ºé‡‘é¢ä¸èƒ½è¶…è¿‡ä½™é¢', () {
      final vault = Vault(balance: 1000);

      expect(
        () => service.withdraw(vault, 1500),
        throwsA(isA<InsufficientBalanceException>()),
      );
    });

    test('è¾¾åˆ°ç›®æ ‡é‡‘é¢æ ‡è®°ä¸ºå·²å®Œæˆ', () {
      final vault = Vault(balance: 9500, targetAmount: 10000);

      final updated = service.deposit(vault, 500);

      expect(updated.isCompleted, isTrue);
      expect(updated.progress, equals(1.0));
    });
  });
}
```

### 18.3 Widgetæµ‹è¯•ç­–ç•¥

#### 18.3.1 æ ¸å¿ƒé¡µé¢æµ‹è¯•è¦æ±‚

```dart
/// Widgetæµ‹è¯•è¦æ±‚
class WidgetTestRequirements {
  /// æ ¸å¿ƒé¡µé¢å¿…é¡»æœ‰Widgetæµ‹è¯•
  static const requiredPages = [
    'HomePage',              // é¦–é¡µä»ªè¡¨ç›˜
    'BudgetManagementPage',  // é¢„ç®—ç®¡ç†
    'VaultManagementPage',   // å°é‡‘åº“ç®¡ç†
    'TransactionListPage',   // äº¤æ˜“åˆ—è¡¨
    'MoneyAgeDetailPage',    // é’±é¾„è¯¦æƒ…
    'StatisticsPage',        // ç»Ÿè®¡åˆ†æ
    'VoiceRecognitionPage',  // è¯­éŸ³è®°è´¦
    'QuickEntryPage',        // å¿«é€Ÿè®°è´¦
  ];

  /// æ ¸å¿ƒç»„ä»¶å¿…é¡»æœ‰Widgetæµ‹è¯•
  static const requiredWidgets = [
    'MoneyAgeCard',          // é’±é¾„å¡ç‰‡
    'MoneyAgeGauge',         // é’±é¾„ä»ªè¡¨ç›˜
    'BudgetProgressBar',     // é¢„ç®—è¿›åº¦æ¡
    'VaultBalanceWidget',    // å°é‡‘åº“ä½™é¢
    'TransactionTile',       // äº¤æ˜“é¡¹
    'DrillDownPieChart',     // å¯ä¸‹é’»é¥¼å›¾
    'DrillDownLineChart',    // å¯ä¸‹é’»æŠ˜çº¿å›¾
    'EnhancedBreadcrumb',    // é¢åŒ…å±‘å¯¼èˆª
  ];
}
```

#### 18.3.2 é¦–é¡µWidgetæµ‹è¯•

```dart
/// é¦–é¡µWidgetæµ‹è¯•
@Tags(['widget', 'home'])
void main() {
  group('HomePage Widget Tests', () {
    testWidgets('æ˜¾ç¤ºé’±é¾„å¡ç‰‡å’Œæ­£ç¡®æ•°å€¼', (tester) async {
      await tester.pumpWidget(
        ProviderScope(
          overrides: [
            moneyAgeProvider.overrideWith((_) =>
              MoneyAge(days: 25, level: MoneyAgeLevel.good)),
          ],
          child: MaterialApp(home: HomePage()),
        ),
      );

      expect(find.text('é’±é¾„'), findsOneWidget);
      expect(find.text('25'), findsOneWidget);
      expect(find.text('å¤©'), findsOneWidget);
      expect(find.byType(MoneyAgeCard), findsOneWidget);
    });

    testWidgets('æ˜¾ç¤ºé¢„ç®—æ¦‚è§ˆå¡ç‰‡', (tester) async {
      await tester.pumpWidget(createTestApp(
        budgetOverview: BudgetOverview(
          totalBudget: 10000,
          totalSpent: 6500,
          remainingDays: 15,
        ),
      ));

      expect(find.text('æœ¬æœˆé¢„ç®—'), findsOneWidget);
      expect(find.text('Â¥10,000'), findsOneWidget);
      expect(find.text('65%'), findsOneWidget); // ä½¿ç”¨ç‡
    });

    testWidgets('æ˜¾ç¤ºå°é‡‘åº“æ¦‚è§ˆ', (tester) async {
      await tester.pumpWidget(createTestApp(
        vaults: [
          Vault(name: 'æ—…æ¸¸åŸºé‡‘', balance: 5000, targetAmount: 10000),
          Vault(name: 'åº”æ€¥èµ„é‡‘', balance: 20000, targetAmount: 20000),
        ],
      ));

      expect(find.text('å°é‡‘åº“'), findsOneWidget);
      expect(find.text('æ—…æ¸¸åŸºé‡‘'), findsOneWidget);
      expect(find.text('50%'), findsOneWidget);
    });

    testWidgets('ç‚¹å‡»é’±é¾„å¡ç‰‡å¯¼èˆªåˆ°è¯¦æƒ…é¡µ', (tester) async {
      await tester.pumpWidget(createTestApp());

      await tester.tap(find.byType(MoneyAgeCard));
      await tester.pumpAndSettle();

      expect(find.byType(MoneyAgeDetailPage), findsOneWidget);
    });

    testWidgets('ä¸‹æ‹‰åˆ·æ–°æ›´æ–°æ‰€æœ‰æ•°æ®', (tester) async {
      final mockRefresh = MockRefreshCallback();
      await tester.pumpWidget(createTestApp(onRefresh: mockRefresh));

      await tester.fling(
        find.byType(CustomScrollView),
        Offset(0, 300),
        1000,
      );
      await tester.pumpAndSettle();

      verify(mockRefresh.call()).called(1);
    });
  });
}
```

#### 18.3.3 æ•°æ®è”åŠ¨Widgetæµ‹è¯•

```dart
/// æ•°æ®è”åŠ¨Widgetæµ‹è¯•
@Tags(['widget', 'drill-down'])
void main() {
  group('DrillDown Widget Tests', () {
    testWidgets('é¥¼å›¾ç‚¹å‡»è§¦å‘ä¸‹é’»', (tester) async {
      await tester.pumpWidget(createTestApp(
        pieChartData: [
          ChartSegment(category: 'food', value: 3000, label: 'é¤é¥®'),
          ChartSegment(category: 'transport', value: 1000, label: 'äº¤é€š'),
        ],
      ));

      // ç‚¹å‡»é¤é¥®åˆ†ç±»
      await tester.tap(find.text('é¤é¥®'));
      await tester.pumpAndSettle();

      // éªŒè¯ä¸‹é’»åˆ°é¤é¥®è¯¦æƒ…
      expect(find.text('é¤é¥®æ”¯å‡ºè¯¦æƒ…'), findsOneWidget);
      expect(find.byType(EnhancedBreadcrumb), findsOneWidget);
    });

    testWidgets('é¢åŒ…å±‘å¯¼èˆªæ­£ç¡®æ˜¾ç¤ºå±‚çº§', (tester) async {
      await tester.pumpWidget(createTestApp(
        drillDownPath: ['ç»Ÿè®¡', 'é¤é¥®', '12æœˆ25æ—¥'],
      ));

      expect(find.text('ç»Ÿè®¡'), findsOneWidget);
      expect(find.text('é¤é¥®'), findsOneWidget);
      expect(find.text('12æœˆ25æ—¥'), findsOneWidget);
    });

    testWidgets('ç‚¹å‡»é¢åŒ…å±‘è¿”å›ä¸Šçº§', (tester) async {
      await tester.pumpWidget(createTestApp(
        drillDownPath: ['ç»Ÿè®¡', 'é¤é¥®', '12æœˆ25æ—¥'],
      ));

      await tester.tap(find.text('é¤é¥®'));
      await tester.pumpAndSettle();

      // éªŒè¯è¿”å›åˆ°é¤é¥®å±‚çº§
      expect(find.text('é¤é¥®æ”¯å‡ºè¯¦æƒ…'), findsOneWidget);
    });
  });
}
```

### 18.4 é›†æˆæµ‹è¯•ç­–ç•¥

#### 18.4.1 å…³é”®ç”¨æˆ·æ—…ç¨‹

```dart
/// é›†æˆæµ‹è¯•åœºæ™¯
class IntegrationTestScenarios {
  /// å…³é”®ç”¨æˆ·æ—…ç¨‹ - å¿…é¡»è¦†ç›–
  static const criticalJourneys = [
    'new_user_onboarding',       // æ–°ç”¨æˆ·å¼•å¯¼æµç¨‹
    'quick_expense_entry',       // å¿«é€Ÿè®°è´¦
    'voice_expense_entry',       // è¯­éŸ³è®°è´¦
    'multi_transaction_voice',   // å¤šç¬”äº¤æ˜“è¯­éŸ³è®°è´¦
    'budget_creation_flow',      // é¢„ç®—åˆ›å»ºæµç¨‹
    'vault_allocation_flow',     // å°é‡‘åº“åˆ†é…æµç¨‹
    'data_drill_down',           // æ•°æ®ä¸‹é’»
    'monthly_report_view',       // æœˆåº¦æŠ¥è¡¨æŸ¥çœ‹
  ];

  /// æ•°æ®åŒæ­¥åœºæ™¯
  static const syncScenarios = [
    'offline_to_online_sync',    // ç¦»çº¿è½¬åœ¨çº¿åŒæ­¥
    'conflict_resolution',       // å†²çªè§£å†³
    'partial_sync_recovery',     // éƒ¨åˆ†åŒæ­¥æ¢å¤
    'incremental_sync',          // å¢é‡åŒæ­¥
  ];

  /// 2.0æ ¸å¿ƒåŠŸèƒ½åœºæ™¯
  static const v2CoreScenarios = [
    'money_age_calculation',     // é’±é¾„è®¡ç®—æµç¨‹
    'zero_budget_allocation',    // é›¶åŸºé¢„ç®—åˆ†é…
    'vault_management',          // å°é‡‘åº“ç®¡ç†
    'ai_voice_recognition',      // AIè¯­éŸ³è¯†åˆ«
    'cross_page_filter',         // è·¨é¡µé¢ç­›é€‰
  ];
}
```

#### 18.4.2 è¯­éŸ³è®°è´¦é›†æˆæµ‹è¯•

```dart
/// è¯­éŸ³è®°è´¦é›†æˆæµ‹è¯•
@Tags(['integration', 'voice', 'ai'])
void main() {
  group('è¯­éŸ³è®°è´¦é›†æˆæµ‹è¯•', () {
    integration_test('å•ç¬”äº¤æ˜“è¯­éŸ³è®°è´¦', () async {
      final app = await initializeTestApp();

      // 1. æ‰“å¼€è¯­éŸ³è®°è´¦
      await app.tap(find.byIcon(Icons.mic));
      await app.pumpAndSettle();

      // 2. æ¨¡æ‹Ÿè¯­éŸ³è¾“å…¥
      await app.simulateVoiceInput('åˆé¤èŠ±äº†35å—');
      await app.pumpAndSettle();

      // 3. éªŒè¯AIè§£æç»“æœ
      expect(find.text('Â¥35.00'), findsOneWidget);
      expect(find.text('é¤é¥®'), findsOneWidget);
      expect(find.text('åˆé¤'), findsOneWidget);

      // 4. ç¡®è®¤ä¿å­˜
      await app.tap(find.text('ç¡®è®¤'));
      await app.pumpAndSettle();

      // 5. éªŒè¯äº¤æ˜“å·²ä¿å­˜
      await app.tap(find.byIcon(Icons.list));
      expect(find.text('Â¥35.00'), findsOneWidget);
    });

    integration_test('å¤šç¬”äº¤æ˜“è¯­éŸ³è®°è´¦', () async {
      final app = await initializeTestApp();

      await app.tap(find.byIcon(Icons.mic));
      await app.simulateVoiceInput('ä»Šå¤©æ—©é¤15å—ï¼Œåˆé¤28å—ï¼Œæ™šé¤èŠ±äº†45');
      await app.pumpAndSettle();

      // éªŒè¯è§£æå‡º3ç¬”äº¤æ˜“
      expect(find.byType(TransactionConfirmTile), findsNWidgets(3));
      expect(find.text('Â¥15.00'), findsOneWidget);
      expect(find.text('Â¥28.00'), findsOneWidget);
      expect(find.text('Â¥45.00'), findsOneWidget);

      // å…¨éƒ¨ç¡®è®¤
      await app.tap(find.text('å…¨éƒ¨ç¡®è®¤'));
      await app.pumpAndSettle();

      // éªŒè¯é’±é¾„å·²æ›´æ–°
      final moneyAge = app.getMoneyAge();
      expect(moneyAge.lastUpdated, isNotNull);
    });

    integration_test('è¯­éŸ³è¯†åˆ«å¤±è´¥é‡è¯•', () async {
      final app = await initializeTestApp();

      // æ¨¡æ‹Ÿè¯†åˆ«å¤±è´¥
      await app.tap(find.byIcon(Icons.mic));
      await app.simulateVoiceError(VoiceError.networkTimeout);

      // éªŒè¯æ˜¾ç¤ºé‡è¯•é€‰é¡¹
      expect(find.text('è¯†åˆ«å¤±è´¥'), findsOneWidget);
      expect(find.text('é‡è¯•'), findsOneWidget);

      // ç‚¹å‡»é‡è¯•
      await app.tap(find.text('é‡è¯•'));
      await app.simulateVoiceInput('å’–å•¡25å…ƒ');
      await app.pumpAndSettle();

      expect(find.text('Â¥25.00'), findsOneWidget);
    });
  });
}
```

#### 18.4.3 æ•°æ®ä¸‹é’»é›†æˆæµ‹è¯•

```dart
/// æ•°æ®ä¸‹é’»é›†æˆæµ‹è¯•
@Tags(['integration', 'drill-down'])
integration_test('ç»Ÿè®¡å›¾è¡¨ä¸‹é’»æµç¨‹', () async {
  final app = await initializeTestApp(withSampleData: true);

  // 1. è¿›å…¥ç»Ÿè®¡é¡µ
  await app.tap(find.byIcon(Icons.bar_chart));
  await app.pumpAndSettle();

  // 2. ç‚¹å‡»é¥¼å›¾çš„"é¤é¥®"åˆ†ç±»
  await app.tapChartSegment('é¤é¥®');
  await app.pumpAndSettle();

  // 3. éªŒè¯è¿›å…¥é¤é¥®åˆ†ç±»è¯¦æƒ…
  expect(find.text('é¤é¥®æ”¯å‡ºè¯¦æƒ…'), findsOneWidget);

  // 4. éªŒè¯é¢åŒ…å±‘æ˜¾ç¤º
  expect(find.byType(EnhancedBreadcrumb), findsOneWidget);
  expect(find.text('ç»Ÿè®¡'), findsOneWidget);
  expect(find.text('é¤é¥®'), findsOneWidget);

  // 5. ç‚¹å‡»æŸä¸€å¤©
  await app.tap(find.text('12æœˆ25æ—¥'));
  await app.pumpAndSettle();

  // 6. éªŒè¯æ˜¾ç¤ºå½“å¤©äº¤æ˜“åˆ—è¡¨
  expect(find.byType(TransactionList), findsOneWidget);

  // 7. éªŒè¯é¢åŒ…å±‘æ›´æ–°
  expect(find.text('12æœˆ25æ—¥'), findsOneWidget);

  // 8. ç‚¹å‡»é¢åŒ…å±‘è¿”å›ç»Ÿè®¡é¡µ
  await app.tap(find.text('ç»Ÿè®¡'));
  await app.pumpAndSettle();

  expect(find.byType(StatisticsPage), findsOneWidget);
});
```

### 18.5 APIä¸åç«¯æµ‹è¯•

#### 18.5.1 APIæµ‹è¯•ç­–ç•¥

```python
# server/tests/test_api.py

import pytest
from httpx import AsyncClient
from app.main import app

class TestTransactionAPI:
    """äº¤æ˜“APIæµ‹è¯•"""

    @pytest.mark.asyncio
    async def test_create_transaction(self, client: AsyncClient, auth_headers):
        """åˆ›å»ºäº¤æ˜“"""
        response = await client.post(
            "/api/v1/transactions",
            json={
                "type": "expense",
                "amount": 88.5,
                "category_id": "food",
                "date": "2024-12-31",
                "note": "åˆé¤"
            },
            headers=auth_headers
        )

        assert response.status_code == 201
        data = response.json()
        assert data["amount"] == 88.5
        assert data["category_id"] == "food"
        assert "id" in data

    @pytest.mark.asyncio
    async def test_get_transactions_with_filter(self, client: AsyncClient, auth_headers):
        """å¸¦ç­›é€‰æ¡ä»¶æŸ¥è¯¢äº¤æ˜“"""
        response = await client.get(
            "/api/v1/transactions",
            params={
                "start_date": "2024-12-01",
                "end_date": "2024-12-31",
                "category": "food",
                "type": "expense"
            },
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "items" in data
        assert "total" in data

    @pytest.mark.asyncio
    async def test_batch_create_transactions(self, client: AsyncClient, auth_headers):
        """æ‰¹é‡åˆ›å»ºäº¤æ˜“ï¼ˆè¯­éŸ³è®°è´¦åœºæ™¯ï¼‰"""
        response = await client.post(
            "/api/v1/transactions/batch",
            json={
                "transactions": [
                    {"type": "expense", "amount": 15, "category_id": "food"},
                    {"type": "expense", "amount": 28, "category_id": "food"},
                    {"type": "expense", "amount": 45, "category_id": "food"},
                ]
            },
            headers=auth_headers
        )

        assert response.status_code == 201
        data = response.json()
        assert len(data["created"]) == 3


class TestBudgetAPI:
    """é¢„ç®—APIæµ‹è¯•"""

    @pytest.mark.asyncio
    async def test_create_zero_based_budget(self, client: AsyncClient, auth_headers):
        """åˆ›å»ºé›¶åŸºé¢„ç®—"""
        response = await client.post(
            "/api/v1/budgets",
            json={
                "month": "2025-01",
                "total_income": 15000,
                "allocations": [
                    {"category_id": "food", "amount": 3000},
                    {"category_id": "transport", "amount": 1000},
                    {"category_id": "savings", "amount": 5000},
                ]
            },
            headers=auth_headers
        )

        assert response.status_code == 201
        data = response.json()
        assert data["total_allocated"] == 9000
        assert data["unallocated"] == 6000

    @pytest.mark.asyncio
    async def test_budget_carryover(self, client: AsyncClient, auth_headers):
        """é¢„ç®—ç»“è½¬æµ‹è¯•"""
        response = await client.post(
            "/api/v1/budgets/carryover",
            json={"from_month": "2024-12", "to_month": "2025-01"},
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "carryover_amounts" in data


class TestSyncAPI:
    """æ•°æ®åŒæ­¥APIæµ‹è¯•"""

    @pytest.mark.asyncio
    async def test_incremental_sync(self, client: AsyncClient, auth_headers):
        """å¢é‡åŒæ­¥æµ‹è¯•"""
        response = await client.post(
            "/api/v1/sync/pull",
            json={
                "last_sync_time": "2024-12-30T00:00:00Z",
                "device_id": "test-device-001"
            },
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "changes" in data
        assert "server_time" in data

    @pytest.mark.asyncio
    async def test_conflict_resolution(self, client: AsyncClient, auth_headers):
        """å†²çªè§£å†³æµ‹è¯•"""
        response = await client.post(
            "/api/v1/sync/push",
            json={
                "changes": [
                    {
                        "id": "tx-001",
                        "type": "update",
                        "data": {"amount": 100},
                        "client_version": 2,
                        "server_version": 1  # æ¨¡æ‹Ÿå†²çª
                    }
                ]
            },
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "conflicts" in data
```

#### 18.5.2 æ•°æ®åº“æµ‹è¯•

```python
# server/tests/test_db.py

import pytest
from sqlalchemy.ext.asyncio import AsyncSession
from app.models import Transaction, Budget, Vault

class TestTransactionRepository:
    """äº¤æ˜“ä»“åº“æµ‹è¯•"""

    @pytest.mark.asyncio
    async def test_calculate_money_age(self, session: AsyncSession, user_id: str):
        """é’±é¾„è®¡ç®—æ•°æ®åº“æŸ¥è¯¢æµ‹è¯•"""
        # æ’å…¥æµ‹è¯•æ•°æ®
        await self._insert_test_transactions(session, user_id)

        repo = TransactionRepository(session)
        result = await repo.calculate_money_age(user_id, datetime.now())

        assert result.total_income > 0
        assert result.total_expense >= 0
        assert result.weighted_age >= 0

    @pytest.mark.asyncio
    async def test_get_category_statistics(self, session: AsyncSession, user_id: str):
        """åˆ†ç±»ç»Ÿè®¡æŸ¥è¯¢æµ‹è¯•"""
        repo = TransactionRepository(session)
        stats = await repo.get_category_statistics(
            user_id,
            start_date=date(2024, 12, 1),
            end_date=date(2024, 12, 31)
        )

        assert isinstance(stats, list)
        for item in stats:
            assert "category_id" in item
            assert "total_amount" in item
            assert "transaction_count" in item
```

### 18.6 ç«¯åˆ°ç«¯æµ‹è¯•

#### 18.6.1 E2Eæµ‹è¯•åœºæ™¯

```dart
/// E2Eæµ‹è¯•åœºæ™¯å®šä¹‰
class E2ETestScenarios {
  /// å®Œæ•´ç”¨æˆ·æµç¨‹
  static const fullUserFlows = [
    E2EFlow(
      name: 'æœˆåº¦è´¢åŠ¡ç®¡ç†å®Œæ•´æµç¨‹',
      steps: [
        'ç™»å½•åº”ç”¨',
        'æŸ¥çœ‹æœ¬æœˆæ¦‚è§ˆï¼ˆé’±é¾„ã€é¢„ç®—ã€å°é‡‘åº“ï¼‰',
        'è®°å½•æ”¶å…¥ï¼ˆå·¥èµ„ï¼‰',
        'åˆ›å»ºé›¶åŸºé¢„ç®—åˆ†é…æ”¶å…¥',
        'åˆ†é…èµ„é‡‘åˆ°å„å°é‡‘åº“',
        'è®°å½•å¤šç¬”æ—¥å¸¸æ”¯å‡º',
        'æŸ¥çœ‹é’±é¾„å˜åŒ–è¶‹åŠ¿',
        'æ£€æŸ¥é¢„ç®—æ‰§è¡Œæƒ…å†µ',
        'æŸ¥çœ‹ç»Ÿè®¡å›¾è¡¨å¹¶ä¸‹é’»',
        'ç”Ÿæˆæœˆåº¦è´¢åŠ¡æŠ¥å‘Š',
      ],
      expectedDuration: Duration(minutes: 20),
    ),
    E2EFlow(
      name: 'è¯­éŸ³è®°è´¦å®Œæ•´æµç¨‹',
      steps: [
        'æ‰“å¼€è¯­éŸ³è®°è´¦',
        'è¯­éŸ³è¾“å…¥å¤šç¬”äº¤æ˜“',
        'ç¡®è®¤AIè¯†åˆ«ç»“æœ',
        'ä¿®æ”¹é”™è¯¯è¯†åˆ«çš„é¡¹ç›®',
        'ä¿å­˜æ‰€æœ‰äº¤æ˜“',
        'éªŒè¯é¦–é¡µæ•°æ®æ›´æ–°',
      ],
      expectedDuration: Duration(minutes: 5),
    ),
  ];
}
```

#### 18.6.2 æœˆåº¦è´¢åŠ¡ç®¡ç†E2Eæµ‹è¯•

```dart
/// æœˆåº¦è´¢åŠ¡ç®¡ç†E2Eæµ‹è¯•
@Tags(['e2e', 'slow'])
e2e_test('æœˆåº¦è´¢åŠ¡ç®¡ç†å®Œæ•´æµç¨‹', () async {
  final driver = await FlutterDriver.connect();

  try {
    // 1. ç™»å½•
    await driver.tap(find.byValueKey('login_button'));
    await driver.waitFor(find.byType('HomePage'));

    // 2. éªŒè¯é¦–é¡µæ˜¾ç¤ºé’±é¾„
    await driver.waitFor(find.text('é’±é¾„'));

    // 3. è®°å½•æ”¶å…¥
    await driver.tap(find.byValueKey('add_transaction'));
    await driver.tap(find.text('æ”¶å…¥'));
    await driver.enterText(find.byType('AmountInput'), '15000');
    await driver.tap(find.text('å·¥èµ„'));
    await driver.tap(find.text('ä¿å­˜'));

    // 4. åˆ›å»ºé›¶åŸºé¢„ç®—
    await driver.tap(find.byValueKey('budget_tab'));
    await driver.tap(find.text('åˆ›å»ºæœ¬æœˆé¢„ç®—'));
    await driver.enterText(find.byValueKey('budget_food'), '3000');
    await driver.enterText(find.byValueKey('budget_transport'), '1000');
    await driver.enterText(find.byValueKey('budget_entertainment'), '500');
    await driver.tap(find.text('ç¡®è®¤'));

    // 5. åˆ†é…åˆ°å°é‡‘åº“
    await driver.tap(find.byValueKey('vault_tab'));
    await driver.tap(find.text('åˆ†é…èµ„é‡‘'));
    await driver.enterText(find.byValueKey('vault_travel'), '2000');
    await driver.enterText(find.byValueKey('vault_emergency'), '3000');
    await driver.tap(find.text('ç¡®è®¤åˆ†é…'));

    // 6. éªŒè¯é’±é¾„æ›´æ–°
    await driver.tap(find.byValueKey('home_tab'));
    final moneyAgeText = await driver.getText(find.byValueKey('money_age_days'));
    expect(int.parse(moneyAgeText), greaterThan(0));

    // 7. è®°å½•æ”¯å‡º
    await driver.tap(find.byValueKey('add_transaction'));
    await driver.enterText(find.byType('AmountInput'), '88.5');
    await driver.tap(find.text('é¤é¥®'));
    await driver.tap(find.text('ä¿å­˜'));

    // 8. æŸ¥çœ‹ç»Ÿè®¡å¹¶ä¸‹é’»
    await driver.tap(find.byValueKey('stats_tab'));
    await driver.waitFor(find.byType('PieChart'));
    await driver.tap(find.text('é¤é¥®'));
    await driver.waitFor(find.text('é¤é¥®æ”¯å‡ºè¯¦æƒ…'));

    // 9. ç”ŸæˆæŠ¥å‘Š
    await driver.tap(find.byValueKey('reports'));
    await driver.tap(find.text('ç”Ÿæˆæœˆåº¦æŠ¥è¡¨'));
    await driver.waitFor(find.text('æŠ¥è¡¨å·²ç”Ÿæˆ'));

  } finally {
    await driver.close();
  }
});
```

### 18.7 æ€§èƒ½æµ‹è¯•

#### 18.7.1 æ€§èƒ½åŸºå‡†

```dart
/// æ€§èƒ½æµ‹è¯•åŸºå‡†
class PerformanceBenchmarks {
  /// é¡µé¢åŠ è½½æ—¶é—´åŸºå‡† (æ¯«ç§’)
  static const pageLoadTimes = {
    'HomePage': 500,
    'TransactionListPage': 800,
    'StatisticsPage': 1000,
    'MoneyAgeDetailPage': 600,
    'BudgetManagementPage': 700,
    'VaultManagementPage': 600,
  };

  /// æ“ä½œå“åº”æ—¶é—´åŸºå‡† (æ¯«ç§’)
  static const operationTimes = {
    'save_transaction': 200,
    'calculate_money_age': 100,
    'generate_chart': 500,
    'voice_recognition': 2000,
    'sync_data': 3000,
    'export_report': 5000,
  };

  /// å†…å­˜ä½¿ç”¨åŸºå‡† (MB)
  static const memoryLimits = {
    'idle': 150,
    'active': 250,
    'peak': 400,
    'after_gc': 180,
  };

  /// å¸§ç‡åŸºå‡†
  static const frameRateLimits = {
    'scroll_list': 55,      // åˆ—è¡¨æ»šåŠ¨ â‰¥55fps
    'chart_animation': 50,  // å›¾è¡¨åŠ¨ç”» â‰¥50fps
    'page_transition': 55,  // é¡µé¢åˆ‡æ¢ â‰¥55fps
  };
}
```

#### 18.7.2 æ€§èƒ½æµ‹è¯•ç”¨ä¾‹

```dart
/// æ€§èƒ½æµ‹è¯•
@Tags(['performance'])
void main() {
  group('é¡µé¢åŠ è½½æ€§èƒ½', () {
    test('é¦–é¡µåŠ è½½æ—¶é—´ < 500ms', () async {
      final stopwatch = Stopwatch()..start();

      await tester.pumpWidget(HomePage());
      await tester.pumpAndSettle();

      stopwatch.stop();
      expect(stopwatch.elapsedMilliseconds,
        lessThan(PerformanceBenchmarks.pageLoadTimes['HomePage']!));
    });

    test('ç»Ÿè®¡é¡µå›¾è¡¨æ¸²æŸ“ < 1000ms', () async {
      final stopwatch = Stopwatch()..start();

      await tester.pumpWidget(StatisticsPage(data: largeDataSet));
      await tester.pumpAndSettle();

      stopwatch.stop();
      expect(stopwatch.elapsedMilliseconds, lessThan(1000));
    });
  });

  group('æ ¸å¿ƒç®—æ³•æ€§èƒ½', () {
    test('é’±é¾„è®¡ç®— < 100ms (1000æ¡äº¤æ˜“)', () async {
      final transactions = generateTransactions(1000);
      final calculator = MoneyAgeCalculator();

      final stopwatch = Stopwatch()..start();
      calculator.calculate(transactions, DateTime.now());
      stopwatch.stop();

      expect(stopwatch.elapsedMilliseconds, lessThan(100));
    });

    test('é’±é¾„è®¡ç®— < 500ms (10000æ¡äº¤æ˜“)', () async {
      final transactions = generateTransactions(10000);
      final calculator = MoneyAgeCalculator();

      final stopwatch = Stopwatch()..start();
      calculator.calculate(transactions, DateTime.now());
      stopwatch.stop();

      expect(stopwatch.elapsedMilliseconds, lessThan(500));
    });
  });

  group('UIæµç•…åº¦', () {
    test('äº¤æ˜“åˆ—è¡¨æ»šåŠ¨å¸§ç‡ >= 55fps', () async {
      await tester.pumpWidget(TransactionListPage(
        transactions: generateTransactions(500),
      ));

      final timeline = await tester.traceAction(() async {
        await tester.fling(
          find.byType(ListView),
          Offset(0, -500),
          1000,
        );
        await tester.pumpAndSettle();
      });

      final summary = TimelineSummary.summarize(timeline);
      expect(summary.averageFrameBuildTimeMillis, lessThan(18)); // ~55fps
    });

    test('é¥¼å›¾åŠ¨ç”»å¸§ç‡ >= 50fps', () async {
      await tester.pumpWidget(DrillDownPieChart(data: testData));

      final timeline = await tester.traceAction(() async {
        await tester.tap(find.byType(DrillDownPieChart));
        await tester.pumpAndSettle();
      });

      final summary = TimelineSummary.summarize(timeline);
      expect(summary.averageFrameBuildTimeMillis, lessThan(20)); // ~50fps
    });
  });

  group('å†…å­˜ä½¿ç”¨', () {
    test('ç©ºé—²çŠ¶æ€å†…å­˜ < 150MB', () async {
      await tester.pumpWidget(HomePage());
      await tester.pumpAndSettle();

      // ç­‰å¾…ç¨³å®š
      await Future.delayed(Duration(seconds: 2));

      final memoryUsage = await getMemoryUsage();
      expect(memoryUsage, lessThan(150 * 1024 * 1024));
    });
  });
}
```

### 18.8 AIåŠŸèƒ½æµ‹è¯•

#### 18.8.1 è¯­éŸ³è¯†åˆ«æµ‹è¯•

```dart
/// AIè¯­éŸ³è¯†åˆ«æµ‹è¯•
@Tags(['ai', 'voice'])
void main() {
  group('VoiceRecognitionParser', () {
    late VoiceRecognitionParser parser;

    setUp(() {
      parser = VoiceRecognitionParser();
    });

    group('å•ç¬”äº¤æ˜“è§£æ', () {
      test('è§£æç®€å•æ”¯å‡º', () {
        final result = parser.parse('åˆé¤èŠ±äº†35å—');

        expect(result.transactions.length, equals(1));
        expect(result.transactions[0].amount, equals(35));
        expect(result.transactions[0].type, equals(TransactionType.expense));
        expect(result.transactions[0].category, equals('food'));
      });

      test('è§£æå¸¦å°æ•°é‡‘é¢', () {
        final result = parser.parse('æ‰“è½¦èŠ±äº†28.5å…ƒ');

        expect(result.transactions[0].amount, equals(28.5));
        expect(result.transactions[0].category, equals('transport'));
      });

      test('è§£ææ”¶å…¥', () {
        final result = parser.parse('æ”¶åˆ°å·¥èµ„15000');

        expect(result.transactions[0].type, equals(TransactionType.income));
        expect(result.transactions[0].amount, equals(15000));
        expect(result.transactions[0].category, equals('salary'));
      });
    });

    group('å¤šç¬”äº¤æ˜“è§£æ', () {
      test('è§£æé€—å·åˆ†éš”çš„å¤šç¬”äº¤æ˜“', () {
        final result = parser.parse('æ—©é¤15å—ï¼Œåˆé¤28å—ï¼Œæ™šé¤45å—');

        expect(result.transactions.length, equals(3));
        expect(result.transactions[0].amount, equals(15));
        expect(result.transactions[1].amount, equals(28));
        expect(result.transactions[2].amount, equals(45));
      });

      test('è§£ææ··åˆç±»å‹äº¤æ˜“', () {
        final result = parser.parse('æ”¶åˆ°çº¢åŒ…200ï¼Œä¹°äº†æ¯å’–å•¡25');

        expect(result.transactions.length, equals(2));
        expect(result.transactions[0].type, equals(TransactionType.income));
        expect(result.transactions[1].type, equals(TransactionType.expense));
      });
    });

    group('è¾¹ç•Œæƒ…å†µ', () {
      test('æ— æ³•è§£ææ—¶è¿”å›ç©ºåˆ—è¡¨', () {
        final result = parser.parse('ä»Šå¤©å¤©æ°”çœŸå¥½');

        expect(result.transactions, isEmpty);
        expect(result.confidence, lessThan(0.5));
      });

      test('å¤„ç†æ¨¡ç³Šé‡‘é¢', () {
        final result = parser.parse('ä¹°ä¸œè¥¿èŠ±äº†å‡ åå—');

        expect(result.needsConfirmation, isTrue);
        expect(result.suggestedAmount, isNull);
      });
    });
  });
}
```

#### 18.8.2 AIæœåŠ¡Mockæµ‹è¯•

```dart
/// AIæœåŠ¡Mockæµ‹è¯•
@Tags(['ai', 'mock'])
void main() {
  group('QwenService', () {
    late QwenService service;
    late MockHttpClient mockClient;

    setUp(() {
      mockClient = MockHttpClient();
      service = QwenService(httpClient: mockClient);
    });

    test('æ­£å¸¸å“åº”è§£æ', () async {
      when(mockClient.post(any, any)).thenAnswer((_) async => Response(
        statusCode: 200,
        body: jsonEncode({
          'output': {
            'text': '{"transactions":[{"amount":35,"category":"food"}]}'
          }
        }),
      ));

      final result = await service.parseVoiceInput('åˆé¤35å…ƒ');

      expect(result.isSuccess, isTrue);
      expect(result.transactions.length, equals(1));
    });

    test('ç½‘ç»œè¶…æ—¶é‡è¯•', () async {
      var callCount = 0;
      when(mockClient.post(any, any)).thenAnswer((_) async {
        callCount++;
        if (callCount < 3) {
          throw TimeoutException('Connection timeout');
        }
        return Response(statusCode: 200, body: '{"output":{"text":"{}"}}');
      });

      final result = await service.parseVoiceInput('æµ‹è¯•');

      expect(callCount, equals(3));
      expect(result.isSuccess, isTrue);
    });

    test('APIé™æµå¤„ç†', () async {
      when(mockClient.post(any, any)).thenAnswer((_) async => Response(
        statusCode: 429,
        body: '{"error":"rate_limited"}',
      ));

      final result = await service.parseVoiceInput('æµ‹è¯•');

      expect(result.isSuccess, isFalse);
      expect(result.error, equals(AIError.rateLimited));
    });
  });
}
```

### 18.9 å®‰å…¨æµ‹è¯•

#### 18.9.1 å®‰å…¨æµ‹è¯•ç­–ç•¥

```dart
/// å®‰å…¨æµ‹è¯•è¦æ±‚
class SecurityTestRequirements {
  /// å¿…é¡»è¦†ç›–çš„å®‰å…¨æµ‹è¯•åœºæ™¯
  static const requiredTests = [
    'sql_injection_prevention',
    'xss_prevention',
    'authentication_bypass',
    'authorization_check',
    'sensitive_data_encryption',
    'token_expiration',
    'rate_limiting',
  ];
}
```

#### 18.9.2 å®‰å…¨æµ‹è¯•ç”¨ä¾‹

```python
# server/tests/test_security.py

import pytest

class TestSecurityVulnerabilities:
    """å®‰å…¨æ¼æ´æµ‹è¯•"""

    @pytest.mark.asyncio
    async def test_sql_injection_prevention(self, client, auth_headers):
        """SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•"""
        malicious_inputs = [
            "'; DROP TABLE transactions; --",
            "1 OR 1=1",
            "1; SELECT * FROM users",
        ]

        for payload in malicious_inputs:
            response = await client.get(
                f"/api/v1/transactions?category={payload}",
                headers=auth_headers
            )
            # åº”è¯¥è¿”å›ç©ºç»“æœæˆ–é”™è¯¯ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ³¨å…¥
            assert response.status_code in [200, 400]
            assert "error" not in response.text.lower() or "invalid" in response.text.lower()

    @pytest.mark.asyncio
    async def test_xss_prevention(self, client, auth_headers):
        """XSSé˜²æŠ¤æµ‹è¯•"""
        xss_payloads = [
            "<script>alert('xss')</script>",
            "javascript:alert(1)",
            "<img src=x onerror=alert(1)>",
        ]

        for payload in xss_payloads:
            response = await client.post(
                "/api/v1/transactions",
                json={"note": payload, "amount": 100, "category_id": "food"},
                headers=auth_headers
            )
            data = response.json()
            # éªŒè¯è¾“å‡ºè¢«è½¬ä¹‰
            assert "<script>" not in str(data)
            assert "javascript:" not in str(data)

    @pytest.mark.asyncio
    async def test_authentication_required(self, client):
        """è®¤è¯è¦æ±‚æµ‹è¯•"""
        protected_endpoints = [
            "/api/v1/transactions",
            "/api/v1/budgets",
            "/api/v1/sync/pull",
            "/api/v1/user/profile",
        ]

        for endpoint in protected_endpoints:
            response = await client.get(endpoint)
            assert response.status_code == 401

    @pytest.mark.asyncio
    async def test_authorization_isolation(self, client, user1_headers, user2_headers):
        """ç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•"""
        # ç”¨æˆ·1åˆ›å»ºäº¤æ˜“
        response = await client.post(
            "/api/v1/transactions",
            json={"amount": 100, "category_id": "food"},
            headers=user1_headers
        )
        tx_id = response.json()["id"]

        # ç”¨æˆ·2å°è¯•è®¿é—®ç”¨æˆ·1çš„äº¤æ˜“
        response = await client.get(
            f"/api/v1/transactions/{tx_id}",
            headers=user2_headers
        )
        assert response.status_code == 404  # åº”è¯¥çœ‹ä¸åˆ°

    @pytest.mark.asyncio
    async def test_rate_limiting(self, client, auth_headers):
        """é€Ÿç‡é™åˆ¶æµ‹è¯•"""
        # å¿«é€Ÿå‘é€å¤§é‡è¯·æ±‚
        responses = []
        for _ in range(100):
            response = await client.get(
                "/api/v1/transactions",
                headers=auth_headers
            )
            responses.append(response.status_code)

        # åº”è¯¥æœ‰ä¸€äº›è¯·æ±‚è¢«é™æµ
        assert 429 in responses
```

### 18.10 æµ‹è¯•è‡ªåŠ¨åŒ–ä¸CI/CD

#### 18.10.1 CI/CDæµæ°´çº¿é…ç½®

```yaml
# .github/workflows/test.yml
name: Test Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # å•å…ƒæµ‹è¯•
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: cd app && flutter pub get

      - name: Run unit tests
        run: cd app && flutter test --coverage --tags=unit

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: app/coverage/lcov.info

  # Widgetæµ‹è¯•
  widget-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - run: cd app && flutter pub get
      - run: cd app && flutter test --tags=widget

  # é›†æˆæµ‹è¯•
  integration-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Start iOS Simulator
        run: |
          xcrun simctl boot "iPhone 15 Pro"

      - name: Run integration tests
        run: cd app && flutter drive --target=test_driver/app.dart

  # åç«¯APIæµ‹è¯•
  api-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd server
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run API tests
        run: |
          cd server
          pytest tests/ -v --cov=app

  # æ€§èƒ½æµ‹è¯•ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
  performance-tests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - run: cd app && flutter pub get
      - run: cd app && flutter test --tags=performance

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: app/build/performance/

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
```

#### 18.10.2 æœ¬åœ°æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# scripts/run_tests.sh

set -e

echo "=== Running AI Bookkeeping Tests ==="

# å•å…ƒæµ‹è¯•
echo "ğŸ“‹ Running unit tests..."
cd app
flutter test --tags=unit --coverage
echo "âœ… Unit tests passed"

# Widgetæµ‹è¯•
echo "ğŸ“‹ Running widget tests..."
flutter test --tags=widget
echo "âœ… Widget tests passed"

# åç«¯æµ‹è¯•
echo "ğŸ“‹ Running API tests..."
cd ../server
pytest tests/ -v
echo "âœ… API tests passed"

# ä»£ç è¦†ç›–ç‡æ£€æŸ¥
echo "ğŸ“Š Checking coverage..."
cd ../app
lcov --summary coverage/lcov.info

echo "=== All tests passed! ==="
```

### 18.11 æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

#### 18.11.1 è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | æœ€ä½è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ | å¼ºåˆ¶æ£€æŸ¥ |
|------|-----------|-----------|----------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆé’±é¾„/é¢„ç®—/å°é‡‘åº“ï¼‰ | 90% | 95% | âœ… |
| æ•°æ®æ¨¡å‹ | 85% | 90% | âœ… |
| Provider/Service | 80% | 85% | âœ… |
| AIæœåŠ¡ | 75% | 85% | âœ… |
| APIç«¯ç‚¹ | 80% | 90% | âœ… |
| UIç»„ä»¶ | 60% | 75% | âŒ |
| å·¥å…·ç±» | 75% | 85% | âŒ |
| **æ•´ä½“** | **75%** | **85%** | âœ… |

#### 18.11.2 è¦†ç›–ç‡ç›‘æ§

```dart
/// è¦†ç›–ç‡æ£€æŸ¥è„šæœ¬
class CoverageChecker {
  static const requiredCoverage = {
    'lib/core/money_age/': 90,
    'lib/core/budget/': 90,
    'lib/core/vault/': 90,
    'lib/services/': 80,
    'lib/providers/': 80,
  };

  static Future<bool> check(String lcovPath) async {
    final coverage = await parseLcov(lcovPath);

    for (final entry in requiredCoverage.entries) {
      final dirCoverage = coverage.getCoverage(entry.key);
      if (dirCoverage < entry.value) {
        print('âŒ ${entry.key}: $dirCoverage% < ${entry.value}% required');
        return false;
      }
      print('âœ… ${entry.key}: $dirCoverage% >= ${entry.value}%');
    }

    return true;
  }
}
```

### 18.12 ç›®æ ‡è¾¾æˆæ£€æµ‹

#### 18.12.1 æµ‹è¯•è´¨é‡ç›®æ ‡

```dart
/// æµ‹è¯•ç­–ç•¥ç›®æ ‡è¾¾æˆæ£€æµ‹ï¼ˆå¯¹é½1.4.2èŠ‚å®šä¹‰ï¼‰
class TestingGoalAchievement {
  static const testingGoal = GoalCriteria(
    name: 'æµ‹è¯•è´¨é‡ä¿éšœ',
    description: 'ç¡®ä¿äº§å“è´¨é‡å’Œç¨³å®šæ€§',

    // åŠŸèƒ½å®Œæ•´åº¦æ ‡å‡†
    featureCompleteness: [
      'å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘',
      'Widgetæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¸å¿ƒé¡µé¢',
      'é›†æˆæµ‹è¯•è¦†ç›–å…³é”®ç”¨æˆ·æ—…ç¨‹',
      'APIæµ‹è¯•è¦†ç›–æ‰€æœ‰ç«¯ç‚¹',
      'æ€§èƒ½æµ‹è¯•å»ºç«‹åŸºå‡†å¹¶æŒç»­ç›‘æ§',
      'AIåŠŸèƒ½æµ‹è¯•è¦†ç›–è¯†åˆ«å‡†ç¡®ç‡',
      'å®‰å…¨æµ‹è¯•è¦†ç›–OWASP Top 10',
    ],

    // æµ‹è¯•æ•ˆæœæ ‡å‡†
    outcomeMetrics: [
      OutcomeMetric(
        name: 'ä»£ç è¦†ç›–ç‡',
        measurement: 'æ•´ä½“ä»£ç è¦†ç›–ç‡',
        target: 0.80,  // 80%
        method: 'lcovç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'ç¼ºé™·é€ƒé€¸ç‡',
        measurement: 'ä¸Šçº¿åå‘ç°çš„ç¼ºé™·/æ€»ç¼ºé™·',
        target: 0.05,  // <5%
        method: 'ç¼ºé™·è¿½è¸ªç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'CIé€šè¿‡ç‡',
        measurement: 'CIæµæ°´çº¿é¦–æ¬¡é€šè¿‡ç‡',
        target: 0.90,  // 90%
        method: 'GitHub Actionsç»Ÿè®¡',
      ),
      OutcomeMetric(
        name: 'å›å½’ç¼ºé™·ç‡',
        measurement: 'å›å½’æµ‹è¯•å‘ç°çš„æ–°ç¼ºé™·ç‡',
        target: 0.02,  // <2%
        method: 'ç‰ˆæœ¬è¿­ä»£ç¼ºé™·ç»Ÿè®¡',
      ),
    ],

    // æ»¡æ„åº¦æ ‡å‡†
    satisfactionTarget: SatisfactionMetric(
      appCrashRate: 0.001,  // å´©æºƒç‡ <0.1%
      userReportedBugs: 5,  // æ¯æœˆç”¨æˆ·æŠ¥å‘Šç¼ºé™· <5ä¸ª
    ),
  );
}
```

---
