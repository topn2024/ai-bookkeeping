# -*- coding: utf-8 -*-
"""修复专利01的背景技术引用错误"""

from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
import os
import shutil

# 文件路径
input_path = 'D:/code/ai-bookkeeping/docs/patents/专利01_FIFO资源池钱龄计算方法_v1.1.docx'
output_path = 'D:/code/ai-bookkeeping/docs/patents/专利01_FIFO资源池钱龄计算方法_v1.2.docx'

# 新的背景技术内容
new_background = """背景技术

[0002] 资金时间价值（Time Value of Money）是金融学的基本原理，表明今天的一元钱比未来的一元钱更有价值。然而，在个人财务管理领域，现有技术难以精确量化用户每笔支出所消耗资金的实际持有时长，导致用户无法直观了解自己的资金流动效率。

[0003] 现有技术一（美国专利US5947526A，Budget Master LLC，1997年）：公开了一种"个人财务追踪系统和方法"（Personal financial tracking system and method）。该专利采用纸质载体上的离散货币单位，用户通过标记或划除来追踪支出。技术缺陷：（1）基于纸质媒介的人工标记系统，无法实现自动化计算；（2）仅进行总额追踪，无法追踪单笔资金的生命周期；（3）无法计算资金的时间价值或持有时长。

[0004] 现有技术二（YNAB软件"Age of Money"功能，You Need A Budget公司）：该软件提供一种资金年龄计算功能，根据官方文档描述，其采用最近10笔交易的平均算法计算资金年龄。

[0005] YNAB方法的技术缺陷：缺陷一（样本量固定）：固定取最近10笔交易的平均值，忽略交易金额差异。量化分析：用户1月收入1000元、2月收入9000元，3月消费5000元。YNAB算法（简单平均）无法区分不同金额的贡献权重。正确计算（FIFO加权）：(1000×60 + 4000×30)/5000 = 36天，能精确反映资金流动。

[0006] 缺陷二（无法追溯）：仅输出单一数值，无法建立收入-支出的精确对应关系。缺陷三（粒度不足）：以交易笔数而非金额为统计单位，大额交易与小额交易权重相同。缺陷四（无透支检测）：未处理支出超过可用余额的场景。缺陷五（扩展性受限）：专为个人预算设计，无法扩展至股票成本核算、库存管理等FIFO变体场景。

[0007] 现有技术三（会计领域FIFO成本法）：证券交易和库存管理中的先进先出成本核算方法是会计准则（US GAAP、IFRS）认可的标准做法。技术缺陷：（1）仅用于成本计算和税务核算，不计算资产持有时长；（2）无标准化数据模型，各系统实现不统一；（3）无通用框架支持资金、股票、库存等多种资源类型的统一处理。

[0008] 现有技术四（CFPB财务健康评分工具，美国消费者金融保护局）：该公开工具提供0-100分的财务健康评估，基于10个问题的问卷调查。技术缺陷：（1）基于主观问卷而非客观数据；（2）评估维度单一，无时间维度的资金分析功能；（3）无法追踪具体的资金流动。

[0009] 现有技术五（区块链资产追踪技术）：现有区块链技术可用于资产归属权追踪和溯源。技术缺陷：（1）区块链存储开销大，交易确认延迟高；（2）主要追踪资产归属权变更，未计算资产持有时长；（3）对个人财务管理场景过于复杂。

[0010] 现有技术六（传统记账软件）：市场上的个人记账应用（如随手记、钱迹等）提供收支分类统计功能。技术缺陷：（1）仅支持简单的收支分类和汇总统计；（2）采用月度/周度汇总，粒度过粗；（3）无时间维度的资金分析功能，无法回答"这笔消费花的是哪天的收入"这一关键问题。

[0011] 综上所述，现有技术存在以下共性技术问题：（1）无法建立收入与支出之间的精确对应关系；（2）资金时间价值计算采用简单平均或固定样本量，精度不足；（3）修改历史数据需全量重算，效率低下；（4）缺乏标准化数据模型；（5）未将FIFO模型应用于个人资金管理领域并计算持有时长；（6）无法扩展至股票、库存等变体场景；（7）缺乏超大规模数据和极端并发场景的处理能力。"""

# 新的区别特征内容
new_distinction = """[0014] 本发明与现有技术的区别技术特征：

[0015] 区别特征一（vs US5947526A）：本发明采用数字化FIFO队列精确追踪每笔资金的生命周期，实现自动化计算，而非人工标记的纸质追踪系统。

[0016] 区别特征二（vs YNAB Age of Money）：本发明采用金额加权FIFO算法，钱龄 = Σ(消耗金额ᵢ×天数ᵢ) / Σ(消耗金额ᵢ)（加权平均），考虑每笔资金的实际金额贡献，而非固定样本量的简单平均，精度显著提升。

[0017] 区别特征三（vs 会计FIFO成本法）：本发明在成本核算基础上增加持有时长计算，提供通用框架支持资金、股票、库存等多种资源类型。

[0018] 区别特征四（vs 区块链追踪）：本发明采用轻量级本地存储，查询延迟低；支持离线计算，无需网络确认。"""

def fix_patent():
    # 复制原文件
    shutil.copy(input_path, output_path)

    # 打开文档
    doc = Document(output_path)

    # 找到背景技术段落的位置
    bg_start = -1
    bg_end = -1
    distinction_start = -1
    distinction_end = -1

    for i, para in enumerate(doc.paragraphs):
        text = para.text.strip()
        if text == '背景技术':
            bg_start = i
        elif text == '发明内容' and bg_start >= 0:
            bg_end = i
            break
        elif text.startswith('[0014] 本发明与现有技术的区别'):
            distinction_start = i
        elif text.startswith('[0019] 本发明的核心创新点'):
            distinction_end = i

    print(f'背景技术: {bg_start} - {bg_end}')
    print(f'区别特征: {distinction_start} - {distinction_end}')

    # 由于直接修改段落比较复杂，我们采用另一种方法：
    # 遍历所有段落，找到需要修改的段落编号
    paragraphs_to_modify = []

    for i, para in enumerate(doc.paragraphs):
        text = para.text.strip()
        # 检查是否是需要修改的背景技术段落
        if any(x in text for x in [
            '[0003] 现有技术一（中国专利CN110533518A）',
            '[0004] 现有技术二（美国专利US10,430,873B2',
            '[0005] YNAB方法的技术缺陷：缺陷一（精度不足）',
            '[0006] 缺陷二（无法追溯）',
            '[0007] 现有技术三（美国专利US10,789,632B2）',
            '[0008] 现有技术四（美国专利US11,250,468B2）',
            '[0009] 现有技术五（欧洲专利EP3654268A1）',
            '[0010] 现有技术六（日本专利JP2021-089632A）',
            '[0011] 现有技术七（股票成本核算领域）',
            '[0012] 综上所述',
            '[0015] 区别特征一（vs CN110533518A）',
            '[0016] 区别特征二（vs US10,430,873B2',
            '[0017] 区别特征三（vs US10,789,632B2）',
            '[0018] 区别特征四（vs 股票FIFO成本法）'
        ]):
            paragraphs_to_modify.append((i, text[:50]))

    print(f'\n需要修改的段落:')
    for idx, preview in paragraphs_to_modify:
        print(f'  [{idx}] {preview}...')

    # 修改具体段落
    modifications = {
        # 背景技术段落
        '[0003] 现有技术一（中国专利CN110533518A）': '[0003] 现有技术一（美国专利US5947526A，Budget Master LLC，1997年）：公开了一种"个人财务追踪系统和方法"（Personal financial tracking system and method）。该专利采用纸质载体上的离散货币单位，用户通过标记或划除来追踪支出。技术缺陷：（1）基于纸质媒介的人工标记系统，无法实现自动化计算；（2）仅进行总额追踪，无法追踪单笔资金的生命周期；（3）无法计算资金的时间价值或持有时长。',

        '[0004] 现有技术二（美国专利US10,430,873B2': '[0004] 现有技术二（YNAB软件"Age of Money"功能，You Need A Budget公司）：该软件提供一种资金年龄计算功能，根据官方文档描述，其采用最近10笔交易的平均算法计算资金年龄。',

        '[0005] YNAB方法的技术缺陷：缺陷一（精度不足）': '[0005] YNAB方法的技术缺陷：缺陷一（样本量固定）：固定取最近10笔交易的平均值，忽略交易金额差异。量化分析：用户1月收入1000元、2月收入9000元，3月消费5000元。YNAB算法（简单平均）无法区分不同金额的贡献权重。正确计算（FIFO加权）：(1000×60 + 4000×30)/5000 = 36天，能精确反映资金流动。',

        '[0006] 缺陷二（无法追溯）': '[0006] 缺陷二（无法追溯）：仅输出单一数值，无法建立收入-支出的精确对应关系。缺陷三（粒度不足）：以交易笔数而非金额为统计单位，大额交易与小额交易权重相同。缺陷四（无透支检测）：未处理支出超过可用余额的场景。缺陷五（扩展性受限）：专为个人预算设计，无法扩展至股票成本核算、库存管理等FIFO变体场景。',

        '[0007] 现有技术三（美国专利US10,789,632B2）': '[0007] 现有技术三（会计领域FIFO成本法）：证券交易和库存管理中的先进先出成本核算方法是会计准则（US GAAP、IFRS）认可的标准做法。技术缺陷：（1）仅用于成本计算和税务核算，不计算资产持有时长；（2）无标准化数据模型，各系统实现不统一；（3）无通用框架支持资金、股票、库存等多种资源类型的统一处理。',

        '[0008] 现有技术四（美国专利US11,250,468B2）': '[0008] 现有技术四（CFPB财务健康评分工具，美国消费者金融保护局）：该公开工具提供0-100分的财务健康评估，基于10个问题的问卷调查。技术缺陷：（1）基于主观问卷而非客观数据；（2）评估维度单一，无时间维度的资金分析功能；（3）无法追踪具体的资金流动。',

        '[0009] 现有技术五（欧洲专利EP3654268A1）': '[0009] 现有技术五（区块链资产追踪技术）：现有区块链技术可用于资产归属权追踪和溯源。技术缺陷：（1）区块链存储开销大，交易确认延迟高；（2）主要追踪资产归属权变更，未计算资产持有时长；（3）对个人财务管理场景过于复杂。',

        '[0010] 现有技术六（日本专利JP2021-089632A）': '[0010] 现有技术六（传统记账软件）：市场上的个人记账应用（如随手记、钱迹等）提供收支分类统计功能。技术缺陷：（1）仅支持简单的收支分类和汇总统计；（2）采用月度/周度汇总，粒度过粗；（3）无时间维度的资金分析功能，无法回答"这笔消费花的是哪天的收入"这一关键问题。',

        '[0011] 现有技术七（股票成本核算领域）': '',  # 删除此段，内容已合并到[0007]

        '[0012] 综上所述': '[0011] 综上所述，现有技术存在以下共性技术问题：（1）无法建立收入与支出之间的精确对应关系；（2）资金时间价值计算采用简单平均或固定样本量，精度不足；（3）修改历史数据需全量重算，效率低下；（4）缺乏标准化数据模型；（5）未将FIFO模型应用于个人资金管理领域并计算持有时长；（6）无法扩展至股票、库存等变体场景；（7）缺乏超大规模数据和极端并发场景的处理能力。',

        # 区别特征段落
        '[0015] 区别特征一（vs CN110533518A）': '[0015] 区别特征一（vs US5947526A）：本发明采用数字化FIFO队列精确追踪每笔资金的生命周期，实现自动化计算，而非人工标记的纸质追踪系统。',

        '[0016] 区别特征二（vs US10,430,873B2': '[0016] 区别特征二（vs YNAB Age of Money）：本发明采用金额加权FIFO算法，钱龄 = Σ(消耗金额ᵢ×天数ᵢ) / Σ(消耗金额ᵢ)（加权平均），考虑每笔资金的实际金额贡献，而非固定样本量的简单平均，精度显著提升。',

        '[0017] 区别特征三（vs US10,789,632B2）': '[0017] 区别特征三（vs 会计FIFO成本法）：本发明在成本核算基础上增加持有时长计算，提供通用框架支持资金、股票、库存等多种资源类型。',

        '[0018] 区别特征四（vs 股票FIFO成本法）': '[0018] 区别特征四（vs 区块链追踪）：本发明采用轻量级本地存储，查询延迟低；支持离线计算，无需网络确认。',
    }

    # 应用修改
    modified_count = 0
    deleted_indices = []

    for i, para in enumerate(doc.paragraphs):
        text = para.text.strip()
        for old_prefix, new_text in modifications.items():
            if text.startswith(old_prefix):
                if new_text == '':
                    # 标记删除（清空内容）
                    para.clear()
                    deleted_indices.append(i)
                    print(f'  已删除: [{i}] {old_prefix[:40]}...')
                else:
                    para.clear()
                    para.add_run(new_text)
                    print(f'  已修改: [{i}] {old_prefix[:40]}...')
                modified_count += 1
                break

    print(f'\n共修改 {modified_count} 个段落')

    # 保存
    doc.save(output_path)
    print(f'\n已保存到: {output_path}')

    return modified_count

if __name__ == '__main__':
    fix_patent()
