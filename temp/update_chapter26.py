# -*- coding: utf-8 -*-
"""
更新第26章版本迁移策略内容
"""
import re

def update_chapter26():
    with open('D:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'r', encoding='utf-8') as f:
        content = f.read()

    # 1. 修复26.0节小节编号错误 (24.0.x → 26.0.x)
    content = content.replace('#### 24.0.1 版本迁移设计原则矩阵', '#### 26.0.1 版本迁移设计原则矩阵')
    content = content.replace('#### 24.0.2 设计理念', '#### 26.0.2 设计理念')
    content = content.replace('#### 24.0.3 与2.0其他系统的协同关系图', '#### 26.0.3 与2.0其他系统的协同关系图')

    print("✓ 修复26.0节小节编号错误 (24.0.x → 26.0.x)")

    # 2. 在26.0.3后面添加26.0.4本章内容导航图
    nav_diagram = '''
#### 26.0.4 本章内容导航图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         第26章 版本迁移策略 - 内容导航                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐                   │
│  │  26.1 数据库  │    │  26.2 功能开关 │    │  26.3 渐进式  │                   │
│  │    迁移       │    │               │    │  升级引导     │                   │
│  │ ─────────────│    │ ─────────────│    │ ─────────────│                   │
│  │ • Migration  │    │ • Feature    │    │ • 欢迎页引导  │                   │
│  │   脚本管理   │    │   Flag服务   │    │ • 功能介绍    │                   │
│  │ • Schema升级 │    │ • 版本控制   │    │ • 开始使用    │                   │
│  │ • 资源池初始 │    │ • A/B测试    │    │ • 新功能发现  │                   │
│  └───────────────┘    └───────────────┘    └───────────────┘                   │
│          │                   │                   │                              │
│          └───────────────────┴───────────────────┘                              │
│                              │                                                   │
│                              ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      26.4 数据兼容性策略（核心）                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │ 26.4.1     │  │ 26.4.2     │  │ 26.4.3     │  │ 26.4.4     │    │   │
│  │  │ 兼容原则   │  │ Schema版本 │  │ 版本元数据 │  │ 智能备份   │    │   │
│  │  │ 只增不删   │  │ 管理       │  │            │  │ 策略       │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│  │  │ 26.4.5     │  │ 26.4.6     │  │ 26.4.7     │  │ 26.4.8-9   │    │   │
│  │  │ 渐进迁移   │  │ 完整校验   │  │ 格式版本化 │  │ API兼容    │    │   │
│  │  │ 断点续传   │  │ 余额一致   │  │            │  │ UI展示     │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                              │                                                   │
│                              ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         26.5 系统集成                                     │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ 钱龄系统  │  │ 零基预算  │  │ 数据导入  │  │ APP升级   │            │   │
│  │  │ 集成      │  │ 集成      │  │ 集成      │  │ 集成      │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ 同步系统  │  │ 语音交互  │  │ 自学习    │  │ 用户体验  │            │   │
│  │  │ 集成      │  │ 集成      │  │ 集成      │  │ 集成      │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                              │                                                   │
│                              ▼                                                   │
│                    ┌───────────────────┐                                        │
│                    │  26.6 目标达成检测 │                                        │
│                    │  版本迁移质量验证  │                                        │
│                    └───────────────────┘                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

'''

    # 找到26.1数据库迁移之前的位置插入
    old_pattern = '\n### 26.1 数据库迁移'
    if '#### 26.0.4 本章内容导航图' not in content:
        content = content.replace(old_pattern, nav_diagram + old_pattern)
        print("✓ 添加26.0.4本章内容导航图")
    else:
        print("- 26.0.4已存在，跳过")

    with open('D:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'w', encoding='utf-8') as f:
        f.write(content)

    print("\n第一阶段更新完成！")

if __name__ == '__main__':
    update_chapter26()
