# -*- coding: utf-8 -*-
"""
更新第6章核心功能架构
根据最新目录结构更新各种图表和章节引用
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ============================================================
    # 更新1: 6.0.2 核心功能模块协作关系图
    # ============================================================
    old_collaboration_diagram = '''#### 6.0.2 核心功能模块协作关系

```
┌────────────────────────────────────────────────────────────────────────────┐
│                       核心功能模块协作全景图                                  │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│                        ┌─────────────────┐                                 │
│                        │   用户交互层     │                                 │
│                        │  快捷记账入口    │                                 │
│                        └────────┬────────┘                                 │
│                                 │                                          │
│           ┌─────────────────────┼─────────────────────┐                    │
│           │                     │                     │                    │
│           ▼                     ▼                     ▼                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   语音记账       │  │   图像记账       │  │   手动记账       │            │
│  │                 │  │                 │  │                 │            │
│  │ 说话即记账     │  │ 拍照即记账     │  │ 极简输入       │            │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘            │
│           │                     │                     │                    │
│           └─────────────────────┼─────────────────────┘                    │
│                                 │                                          │
│                        ┌────────▼────────┐                                 │
│                        │   交易记录中心   │                                 │
│                        │ TransactionHub  │                                 │
│                        └────────┬────────┘                                 │
│                                 │                                          │
│         ┌───────────────────────┼───────────────────────┐                  │
│         │                       │                       │                  │
│         ▼                       ▼                       ▼                  │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐           │
│  │   钱龄系统      │    │   预算系统      │    │   小金库系统    │           │
│  │   (第7章)      │    │   (第8章)      │    │   (第8章)      │           │
│  │               │    │               │    │               │           │
│  │ 消费健康度    │    │ 零基预算分配  │    │ 目标储蓄管理  │           │
│  └───────┬────────┘    └───────┬────────┘    └───────┬────────┘           │
│          │                      │                      │                   │
│          └──────────────────────┼──────────────────────┘                   │
│                                 │                                          │
│                        ┌────────▼────────┐                                 │
│                        │   习惯培养系统   │                                 │
│                        │    (第9章)      │                                 │
│                        │               │                                 │
│                        │ 打卡/成就/任务 │                                 │
│                        └─────────────────┘                                 │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```'''

    new_collaboration_diagram = '''#### 6.0.2 核心功能模块协作关系

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          核心功能模块协作全景图 (2.0版)                              │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│                              ┌─────────────────┐                                 │
│                              │   用户交互层     │                                 │
│                              │  快捷记账入口    │                                 │
│                              └────────┬────────┘                                 │
│                                       │                                          │
│     ┌─────────────────────────────────┼─────────────────────────────────┐        │
│     │                                 │                                 │        │
│     ▼                                 ▼                                 ▼        │
│  ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐        │
│  │  智能语音交互    │       │   图像记账       │       │   手动记账       │        │
│  │   (第18章)      │       │   (第10章)      │       │                 │        │
│  │                 │       │                 │       │  极简输入       │        │
│  │ 多轮对话/纠错  │       │ 拍照即记账     │       │                 │        │
│  └────────┬────────┘       └────────┬────────┘       └────────┬────────┘        │
│           │                         │                         │                  │
│           └─────────────────────────┼─────────────────────────┘                  │
│                                     │                                            │
│                                     ▼                                            │
│                    ┌─────────────────────────────────┐                           │
│                    │    AI智能识别系统 (第10章)       │                           │
│                    │  ┌───────────┬───────────┐     │                           │
│                    │  │  语音识别  │  图像识别  │     │                           │
│                    │  │  意图理解  │  OCR解析  │     │                           │
│                    │  └───────────┴───────────┘     │                           │
│                    └───────────────┬─────────────────┘                           │
│                                    │                                             │
│                           ┌────────▼────────┐                                    │
│                           │   交易记录中心   │                                    │
│                           │ TransactionHub  │                                    │
│                           └────────┬────────┘                                    │
│                                    │                                             │
│  ┌─────────────────────────────────┼─────────────────────────────────┐           │
│  │                                 │                                 │           │
│  ▼                                 ▼                                 ▼           │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐    ┌──────────┐ │
│  │   钱龄系统      │    │   预算系统      │    │   小金库系统    │    │ 家庭账本 │ │
│  │   (第7章)      │    │   (第8章)      │    │   (第8章)      │    │ (第13章) │ │
│  │               │    │               │    │               │    │          │ │
│  │ 消费健康度    │    │ 零基预算分配  │    │ 目标储蓄管理  │    │ 多成员   │ │
│  └───────┬────────┘    └───────┬────────┘    └───────┬────────┘    │ 协作共享 │ │
│          │                      │                      │            └────┬─────┘ │
│          └──────────────────────┼──────────────────────┼─────────────────┘       │
│                                 │                      │                         │
│                                 ▼                      │                         │
│                    ┌─────────────────────────┐         │                         │
│                    │   金融习惯培养系统       │◄────────┘                         │
│                    │       (第9章)           │                                   │
│                    │                         │                                   │
│                    │ 打卡/成就/任务/挑战     │                                   │
│                    └────────────┬────────────┘                                   │
│                                 │                                                │
│   ┌─────────────────────────────┼─────────────────────────────┐                  │
│   │                             │                             │                  │
│   ▼                             ▼                             ▼                  │
│  ┌──────────────┐    ┌──────────────────┐    ┌─────────────────────┐            │
│  │ 自学习系统    │    │ 数据联动与可视化  │    │  用户增长体系        │            │
│  │  (第17章)    │    │    (第12章)      │    │  (第28-29章)        │            │
│  │              │    │                  │    │                     │            │
│  │ 个性化适配  │    │ 多维报表/图表   │    │ NPS/口碑/裂变      │            │
│  └──────────────┘    └──────────────────┘    └─────────────────────┘            │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```'''

    if old_collaboration_diagram in content:
        content = content.replace(old_collaboration_diagram, new_collaboration_diagram)
        print("✓ 更新1: 6.0.2核心功能模块协作关系图")
        changes += 1

    # ============================================================
    # 更新2: 6.1 功能模块全景图
    # ============================================================
    old_module_overview = '''### 6.1 功能模块全景图

```
┌────────────────────────────────────────────────────────────────────────┐
│                         AI智能记账 2.0 功能架构                         │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │
│  │   快捷记账   │ │   账户管理   │ │   预算中心   │ │   统计分析   │  │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤  │
│  │ • 语音识别   │ │ • 多账户     │ │ • 零基预算   │ │ • 钱龄分析   │  │
│  │ • 图像识别   │ │ • 信用卡     │ │ • 小金库     │ │ • 收支趋势   │  │
│  │ • 快速输入   │ │ • 债务管理   │ │ • 预算提醒   │ │ • 分类分析   │  │
│  │ • 批量导入   │ │ • 储蓄目标   │ │ • 周期预算   │ │ • 智能报告   │  │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │
│                                                                        │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │
│  │   账单提醒   │ │   数据管理   │ │   个人中心   │ │   设置中心   │  │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤  │
│  │ • 定期账单   │ │ • 数据备份   │ │ • 用户信息   │ │ • 主题设置   │  │
│  │ • 还款提醒   │ │ • 数据恢复   │ │ • 会员服务   │ │ • 通知设置   │  │
│  │ • 到期通知   │ │ • 数据导出   │ │ • 帮助反馈   │ │ • 隐私安全   │  │
│  │ • 智能建议   │ │ • 云端同步   │ │ • 关于我们   │ │ • 语言区域   │  │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```'''

    new_module_overview = '''### 6.1 功能模块全景图

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                           AI智能记账 2.0 功能架构全景                                │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  ═══════════════════════════════ 核心记账功能 ═══════════════════════════════════  │
│                                                                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐              │
│  │   智能记账   │ │   账户管理   │ │   预算中心   │ │   统计分析   │              │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤              │
│  │ • 语音记账   │ │ • 多账户     │ │ • 零基预算   │ │ • 钱龄分析   │              │
│  │   (第18章)   │ │ • 信用卡     │ │ • 小金库     │ │ • 收支趋势   │              │
│  │ • 图像识别   │ │ • 债务管理   │ │ • 预算提醒   │ │ • 分类分析   │              │
│  │   (第10章)   │ │ • 储蓄目标   │ │ • 周期预算   │ │   (第12章)   │              │
│  │ • 快速输入   │ │              │ │   (第8章)    │ │ • 智能报告   │              │
│  │ • 批量导入   │ │              │ │              │ │   (第7章)    │              │
│  │   (第11章)   │ │              │ │              │ │              │              │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘              │
│                                                                                    │
│  ═══════════════════════════════ 协作与增长 ═══════════════════════════════════    │
│                                                                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐              │
│  │   家庭账本   │ │   习惯培养   │ │   用户口碑   │ │   用户增长   │              │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤              │
│  │ • 多成员管理 │ │ • 习惯打卡   │ │ • NPS监测    │ │ • 口碑裂变   │              │
│  │ • 预算协作   │ │ • 成就系统   │ │ • 惊喜时刻   │ │ • 家庭裂变   │              │
│  │ • 支出分摊   │ │ • 专家任务   │ │ • 推荐者培育 │ │ • 内容获客   │              │
│  │ • 家庭统计   │ │ • 周期挑战   │ │   (第28章)   │ │   (第29章)   │              │
│  │   (第13章)   │ │   (第9章)    │ │              │ │              │              │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘              │
│                                                                                    │
│  ═══════════════════════════════ 智能化能力 ═══════════════════════════════════    │
│                                                                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐              │
│  │ AI智能识别   │ │ 自学习系统   │ │ 语音交互     │ │ 位置智能     │              │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤              │
│  │ • 语音识别   │ │ • 个人习惯   │ │ • 意图识别   │ │ • 场景识别   │              │
│  │ • 图像OCR    │ │ • 协同学习   │ │ • 多轮对话   │ │ • 地理围栏   │              │
│  │ • 智能分类   │ │ • 模型优化   │ │ • 语音反馈   │ │ • 位置预算   │              │
│  │   (第10章)   │ │   (第17章)   │ │   (第18章)   │ │   (第14章)   │              │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘              │
│                                                                                    │
│  ═══════════════════════════════ 系统支撑 ═════════════════════════════════════    │
│                                                                                    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐              │
│  │   数据管理   │ │   个人中心   │ │   设置中心   │ │   安全隐私   │              │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤              │
│  │ • 数据导入   │ │ • 用户信息   │ │ • 主题设置   │ │ • 数据加密   │              │
│  │ • 数据导出   │ │ • 会员服务   │ │ • 通知设置   │ │ • 权限控制   │              │
│  │ • 云端同步   │ │ • 帮助反馈   │ │ • 语言区域   │ │ • 隐私保护   │              │
│  │   (第11章)   │ │ • 无障碍     │ │   (第21章)   │ │   (第22章)   │              │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘              │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```'''

    if old_module_overview in content:
        content = content.replace(old_module_overview, new_module_overview)
        print("✓ 更新2: 6.1功能模块全景图")
        changes += 1

    # ============================================================
    # 更新3: 6.2.1 系统分层架构关系 - 修正章节号引用
    # ============================================================
    # 修复用户体验设计章节号
    content = content.replace(
        '│   用户体验设计    │\n│                                    │     (第17章)      │',
        '│   用户体验设计    │\n│                                    │     (第20章)      │'
    )

    # 修复地理位置章节号
    content = content.replace(
        '│                         地理位置智能化应用 (第15章)                               │',
        '│                         地理位置智能化应用 (第14章)                               │'
    )

    # 修复智能化技术方案章节号
    content = content.replace(
        '│   智能化技术方案     │\n│  │      (第15章)        │',
        '│   智能化技术方案     │\n│  │      (第16章)        │'
    )

    # 修复技术架构设计章节号
    content = content.replace(
        '│                          技术架构设计 (第15章__TEMP__)                                    │',
        '│                          技术架构设计 (第15章)                                    │'
    )

    # 修复国际化章节号
    content = content.replace(
        '│国际化与本地化│\n│  │  (第18章)    │',
        '│国际化与本地化│\n│  │  (第21章)    │'
    )

    # 修复安全与隐私章节号
    content = content.replace(
        '│ 安全与隐私   │\n│  │  (第19章)    │',
        '│ 安全与隐私   │\n│  │  (第22章)    │'
    )

    # 修复版本迁移策略章节号
    content = content.replace(
        '│版本迁移策略  │\n│  │  (第23章)    │',
        '│版本迁移策略  │\n│  │  (第26章)    │'
    )

    # 修复实施路线图章节号
    content = content.replace(
        '│ 实施路线图   │\n│  │  (第24章)    │',
        '│ 实施路线图   │\n│  │  (第27章)    │'
    )

    # 修复异常处理章节号
    content = content.replace(
        '│ 异常处理与容错设计   │\n│  │     (第20章)         │',
        '│ 异常处理与容错设计   │\n│  │     (第23章)         │'
    )

    # 修复可扩展性章节号
    content = content.replace(
        '│ 可扩展性与演进架构   │\n│  │     (第21章)         │',
        '│ 可扩展性与演进架构   │\n│  │     (第24章)         │'
    )

    # 修复可观测性章节号
    content = content.replace(
        '│  可观测性与监控      │\n│  │     (第22章)         │',
        '│  可观测性与监控      │\n│  │     (第25章)         │'
    )

    print("✓ 更新3: 修正章节号引用")
    changes += 1

    # ============================================================
    # 更新4: 在6.2.1后添加新模块说明
    # ============================================================
    old_layer_diagram_end = '''│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                                    设计原则层                                           │'''

    new_layer_diagram_end = '''│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户增长层 (2.0新增)                                  │
│                                                                                        │
│  ┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐    │
│  │  用户口碑与NPS提升    │◄──►│  低成本获客与增长    │◄──►│  家庭账本裂变        │    │
│  │     (第28章)         │    │     (第29章)         │    │     (第13章)         │    │
│  │                      │    │                      │    │                      │    │
│  │ • NPS监测系统        │    │ • 产品内置增长引擎   │    │ • 家庭成员邀请       │    │
│  │ • 惊喜时刻设计       │    │ • ASO优化           │    │ • AA分摊裂变         │    │
│  │ • 推荐者培育         │    │ • 社交裂变机制       │    │ • 共同目标激励       │    │
│  └──────────────────────┘    └──────────────────────┘    └──────────────────────┘    │
│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                                    设计原则层                                           │'''

    if old_layer_diagram_end in content:
        content = content.replace(old_layer_diagram_end, new_layer_diagram_end)
        print("✓ 更新4: 添加用户增长层")
        changes += 1

    # ============================================================
    # 更新5: 更新设计原则层中的章节号
    # ============================================================
    old_design_principles = '''│  ┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐    │
│  │    无障碍设计        │    │   懒人设计原则       │    │   伙伴化设计原则     │    │
│  │     (第5章)         │    │     (第3章)         │    │     (第4章)         │    │'''

    # 这个部分章节号是正确的，不需要修改

    # ============================================================
    # 更新6: 更新6.0.1表格中的章节引用
    # ============================================================
    old_principle_table = '''| 设计原则 | 架构应用 | 具体措施 | 效果指标 |
|---------|---------|---------|---------|
| **单一职责** | 模块化设计 | 记账/钱龄/预算/习惯独立模块 | 模块可独立迭代 |
| **数据一致性** | 数据联动 | 交易→钱龄→预算→习惯自动流转 | 数据零手动同步 |
| **极简设计** | 渐进复杂度 | 核心功能零配置，高级功能按需启用 | 新用户5分钟上手 |
| **可扩展性** | 插件架构 | 功能模块热插拔，API标准化 | 新模块1周内集成 |
| **性能优化** | 分层计算 | 核心功能本地化，增强功能云端化 | 核心功能0延迟 |
| **可观测性** | 全链路追踪 | 功能使用率、转化率、留存率监控 | 功能健康度可视 |'''

    new_principle_table = '''| 设计原则 | 架构应用 | 具体措施 | 效果指标 |
|---------|---------|---------|---------|
| **单一职责** | 模块化设计 | 记账/钱龄/预算/习惯/家庭/增长独立模块 | 模块可独立迭代 |
| **数据一致性** | 数据联动 | 交易→钱龄→预算→习惯→家庭自动流转 | 数据零手动同步 |
| **极简设计** | 渐进复杂度 | 核心功能零配置，高级功能按需启用 | 新用户5分钟上手 |
| **可扩展性** | 插件架构 | 功能模块热插拔，API标准化 | 新模块1周内集成 |
| **性能优化** | 分层计算 | 核心功能本地化，增强功能云端化 | 核心功能0延迟 |
| **可观测性** | 全链路追踪 | 功能使用率、NPS、转化率、留存率监控 | 功能健康度可视 |
| **用户增长** | 增长引擎 | 口碑裂变、家庭邀请、内容获客 | CAC≤30元 |'''

    if old_principle_table in content:
        content = content.replace(old_principle_table, new_principle_table)
        print("✓ 更新5: 6.0.1表格添加用户增长原则")
        changes += 1

    # ============================================================
    # 更新7: 在数据处理层添加新增模块引用
    # ============================================================
    old_data_layer = '''│  ┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐    │
│  │  数据导入导出系统    │◄──►│  数据联动与可视化    │◄──►│   智能化技术方案     │    │
│  │      (第11章)         │    │      (第12章)         │    │      (第15章)        │    │'''

    new_data_layer = '''│  ┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐    │
│  │  数据导入导出系统    │◄──►│  数据联动与可视化    │◄──►│   智能化技术方案     │    │
│  │      (第11章)         │    │      (第12章)         │    │      (第16章)        │    │'''

    if old_data_layer in content:
        content = content.replace(old_data_layer, new_data_layer)
        print("✓ 更新6: 数据处理层章节号修正")
        changes += 1

    # ============================================================
    # 更新8: 在核心业务层添加家庭账本模块
    # ============================================================
    old_core_business = '''│  │  ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐      │ │
│  │  │   钱龄分析系统   │◄──────►│  零基预算系统   │◄──────►│   小金库系统    │      │ │
│  │  │    (第7章)       │        │    (第8章)      │        │    (第8章)      │      │ │'''

    new_core_business = '''│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │ │
│  │  │ 钱龄分析系统 │◄──►│ 零基预算系统 │◄──►│  小金库系统  │◄──►│ 家庭账本系统 │  │ │
│  │  │   (第7章)   │    │   (第8章)   │    │   (第8章)   │    │  (第13章)   │  │ │'''

    if old_core_business in content:
        content = content.replace(old_core_business, new_core_business)
        print("✓ 更新7: 核心业务层添加家庭账本模块")
        changes += 1

    # ============================================================
    # 保存修改
    # ============================================================
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== 第6章核心功能架构更新完成，共 {changes} 处 =====")
    else:
        print("\n未找到需要更新的内容，可能已经更新过")

    return changes

if __name__ == '__main__':
    main()
