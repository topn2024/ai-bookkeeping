# -*- coding: utf-8 -*-
"""
刷新第23章异常处理与容错设计
1. 修复章节编号错误（24.0.x -> 23.0.x）
2. 修复图中章节引用错误
3. 添加23.7与其他系统集成部分
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修复章节编号错误 ==========
    number_fixes = [
        ('#### 24.0.1 异常处理设计原则矩阵', '#### 23.0.1 异常处理设计原则矩阵'),
        ('#### 24.0.2 异常处理模块协作图', '#### 23.0.2 异常处理模块协作图'),
        ('#### 22.0.3 与其他模块的依赖关系', '#### 23.0.3 与其他模块的依赖关系'),
        ('#### 24.0.4 异常处理子系统职责边界表', '#### 23.0.4 异常处理子系统职责边界表'),
        ('#### 24.0.5 异常处理数据流', '#### 23.0.5 异常处理数据流'),
    ]

    for old, new in number_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix number: {old[:35]}... -> {new[:35]}...")
            changes += 1

    # ========== 修复2: 修复协作图中的章节引用 ==========
    ref_fixes = [
        # 修复协作图中的19.x引用
        ('│ (19.1)      │  │  (19.1.2)   │  │  (19.5)     │  │  (19.5)     │ │',
         '│ (23.1)      │  │  (23.1.2)   │  │  (23.5)     │  │  (23.5)     │ │'),
        ('│     (19.3)      │   │       (19.2)        │   │       (19.6)        │',
         '│     (23.3)      │   │       (23.2)        │   │       (23.6)        │'),
        ('│  (19.3.1)   │ │   │ │    (19.2.1)     │ │   │ │    (19.6.1)     │ │',
         '│  (23.3.1)   │ │   │ │    (23.2.1)     │ │   │ │    (23.6.1)     │ │'),
        ('│  (19.3.2)   │ │   │ │    (19.2.2)     │ │',
         '│  (23.3.2)   │ │   │ │    (23.2.2)     │ │'),
        ('│    (19.1.3)     │   │      (19.4)        │   │    (第5章联动)     │',
         '│    (23.1.3)     │   │      (23.4)        │   │   (第25章联动)    │'),
        # 修复依赖关系图中的引用
        ('║  第21章 异常处理与容错设计 ║', '║  第23章 异常处理与容错设计 ║'),
        ('│  • 第21章是横切关注点', '│  • 第23章是横切关注点'),
        ('│  • 第21章依赖第5章的可观测性', '│  • 第23章依赖第25章的可观测性'),
        # 修复可观测性章节引用
        ('│  │  第5章  │', '│  │  第25章 │'),
        ('│  │ • 异常上报监控 (→ 第5章)', '│  │ • 异常上报监控 (→ 第25章)'),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix ref: ...{old[10:40]}...")
            changes += 1

    # ========== 修复3: 修复职责边界表中的章节号 ==========
    table_fixes = [
        ('| **异常分类与处理** | 19.1 |', '| **异常分类与处理** | 23.1 |'),
        ('| **离线同步** | 19.2 |', '| **离线同步** | 23.2 |'),
        ('| **业务异常处理** | 19.3 |', '| **业务异常处理** | 23.3 |'),
        ('| **幂等性服务** | 19.4 |', '| **幂等性服务** | 23.4 |'),
        ('| **降级与熔断** | 19.5 |', '| **降级与熔断** | 23.5 |'),
        ('| **用户体验保障** | 19.6 |', '| **用户体验保障** | 23.6 |'),
    ]

    for old, new in table_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix table: {old[:30]}...")
            changes += 1

    # ========== 修复4: 添加23.7与其他系统集成 ==========
    chapter24_marker = '## 24. 可扩展性与演进架构'

    new_section_23_7 = '''### 23.7 与其他系统集成

#### 23.7.1 系统集成概览

异常处理与容错系统作为横切关注点，为所有2.0模块提供统一的容错能力：

```
┌────────────────────────────────────────────────────────────────────────────┐
│                       异常处理与容错集成全景图                               │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                        异常处理核心服务                               │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │  │ 异常分类  │  │ 重试策略  │  │ 降级熔断  │  │ UI反馈   │           │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘           │  │
│  └───────────────────────────┬─────────────────────────────────────────┘  │
│                              │                                            │
│         ┌────────────────────┼────────────────────┐                       │
│         │                    │                    │                       │
│         ▼                    ▼                    ▼                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                 │
│  │  核心业务    │     │  智能增强    │     │  2.0新增    │                 │
│  │  容错保护    │     │  容错保护    │     │  容错保护    │                 │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤                 │
│  │ • 钱龄计算   │     │ • AI识别    │     │ • 语音识别   │                 │
│  │ • 预算分配   │     │ • 智能分类   │     │ • 位置服务   │                 │
│  │ • 交易同步   │     │ • 数据分析   │     │ • 家庭同步   │                 │
│  └─────────────┘     └─────────────┘     └─────────────┘                 │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

#### 23.7.2 语音识别容错集成

语音识别失败时的容错处理：

| 异常类型 | 处理策略 | 用户体验 |
|----------|----------|----------|
| 网络超时 | 自动重试3次 | 显示重试进度 |
| 识别失败 | 切换到本地ASR | 提示精度可能降低 |
| 服务不可用 | 降级到手动输入 | 引导用户手动记账 |
| 部分识别 | 展示识别结果供修改 | 预填充已识别内容 |

#### 23.7.3 AI识别容错集成

AI服务异常时的容错处理：

| 服务 | 降级方案 | 恢复检测 |
|------|----------|----------|
| 票据OCR | 使用本地OCR模型 | 每5分钟检测主服务 |
| 智能分类 | 使用规则引擎分类 | 成功后自动恢复 |
| 消费洞察 | 使用缓存的洞察 | 后台静默重试 |
| 预算建议 | 使用历史建议模板 | 用户可手动刷新 |

#### 23.7.4 位置服务容错集成

位置服务异常时的容错处理：

| 异常情况 | 容错策略 | 数据处理 |
|----------|----------|----------|
| GPS不可用 | 使用网络定位 | 降低位置精度 |
| 定位超时 | 使用最后已知位置 | 标记为推测位置 |
| 权限被拒 | 跳过位置功能 | 交易不关联位置 |
| POI匹配失败 | 使用通用场景 | 不影响记账流程 |

#### 23.7.5 家庭同步容错集成

家庭账本同步异常时的容错处理：

| 异常类型 | 容错策略 | 冲突解决 |
|----------|----------|----------|
| 同步失败 | 本地队列暂存 | 自动重试 |
| 数据冲突 | 版本向量检测 | 用户选择保留版本 |
| 成员离线 | 标记待同步 | 上线后自动推送 |
| 权限变更 | 缓存刷新 | 提示权限不足 |

#### 23.7.6 数据同步容错集成

跨设备数据同步的容错设计：

| 同步阶段 | 异常处理 | 数据保护 |
|----------|----------|----------|
| 上传失败 | 指数退避重试 | 本地持久化队列 |
| 下载失败 | 使用本地缓存 | 标记数据版本 |
| 部分成功 | 断点续传 | 事务回滚保护 |
| 版本冲突 | CRDT合并 | 保留所有变更历史 |

---

'''

    if chapter24_marker in content:
        content = content.replace(chapter24_marker, new_section_23_7 + chapter24_marker)
        print("OK: Added 23.7 integration section")
        changes += 1
    else:
        print("SKIP: Chapter 24 marker not found")

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 23 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
