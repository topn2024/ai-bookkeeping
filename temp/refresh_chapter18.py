# -*- coding: utf-8 -*-
"""
刷新第18章智能语音交互系统
1. 修正图中章节引用
2. 修正章节编号格式
3. 扩展18.8与其他系统集成
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修正图中章节引用 ==========
    ref_fixes = [
        # 修正图中"17. 智能语音交互系统"为"18."
        ('│   17. 智能语音交互系统   │',
         '│   18. 智能语音交互系统   │'),
        # 修正图中"12. 数据可视化"为"10."
        ('│  12. 数据可视化  │',
         '│  10. 数据可视化  │'),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix ref: {old[:40]}...")
            changes += 1

    # ========== 修复2: 修正章节编号格式 ==========
    number_fixes = [
        # 18.0.0 -> 18.0.1
        ('#### 18.0.0 智能语音系统设计原则矩阵',
         '#### 18.0.1 智能语音系统设计原则矩阵'),
        # 18.0.0.1 -> 18.0.2
        ('#### 18.0.0.1 与其他系统的关系',
         '#### 18.0.2 与其他系统的关系'),
    ]

    for old, new in number_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix number: {old} -> {new}")
            changes += 1

    # ========== 修复3: 扩展18.8与其他系统集成 ==========
    old_section_18_8 = '''### 18.8 与其他系统的集成

| 集成系统 | 语音能力 | 触发示例 | 输出结果 |
|---------|---------|---------|---------|
| **交易系统** | 语音记账 | "记一笔午餐35" | 创建交易记录 |
| **预算系统** | 预算查询/设置 | "餐饮预算还剩多少" | 预算状态/修改预算 |
| **零基预算** | 小金库配置 | "创建旅游小金库" | 创建小金库 |
| **钱龄系统** | 钱龄查询 | "我的资金健康度" | 钱龄分析报告 |
| **习惯培养** | 打卡提醒 | "设置记账提醒" | 配置提醒 |
| **数据分析** | 统计查询 | "这个月消费趋势" | 趋势分析 |
| **导航系统** | 页面跳转 | "打开设置页面" | 执行导航 |'''

    new_section_18_8 = '''### 18.8 与其他系统的集成

#### 18.8.1 系统集成概览

智能语音系统与2.0各模块的深度集成：

```
+------------------------------------------------------------------------+
|                      智能语音交互系统集成全景图                           |
+------------------------------------------------------------------------+
|                                                                        |
|  +------------------------------------------------------------------+  |
|  |                        语音核心服务                                |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  |  | 语音记账  |  | 语音配置  |  | 语音导航  |  | 语音查询  |          |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  +-------------------------------+----------------------------------+  |
|                                  |                                     |
|         +------------------------+------------------------+            |
|         |                        |                        |            |
|         v                        v                        v            |
|  +-------------+          +-------------+          +-------------+     |
|  |  核心业务    |          |  智能系统    |          |  2.0新增    |     |
|  |  语音集成    |          |  语音集成    |          |  语音集成    |     |
|  +-------------+          +-------------+          +-------------+     |
|  | * 交易记账   |          | * 智能分类   |          | * 家庭账本   |     |
|  | * 预算管理   |          | * 自学习     |          | * 位置智能   |     |
|  | * 钱龄查询   |          | * 异常检测   |          | * 习惯培养   |     |
|  +-------------+          +-------------+          +-------------+     |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 18.8.2 集成触发点矩阵

| 集成系统 | 语音能力 | 触发示例 | 输出结果 |
|---------|---------|---------|---------|
| **交易系统** | 语音记账 | "记一笔午餐35" | 创建交易记录 |
| **预算系统** | 预算查询/设置 | "餐饮预算还剩多少" | 预算状态/修改预算 |
| **零基预算** | 小金库配置 | "创建旅游小金库" | 创建小金库 |
| **钱龄系统** | 钱龄查询 | "我的资金健康度" | 钱龄分析报告 |
| **习惯培养** | 打卡提醒 | "设置记账提醒" | 配置提醒 |
| **数据分析** | 统计查询 | "这个月消费趋势" | 趋势分析 |
| **导航系统** | 页面跳转 | "打开设置页面" | 执行导航 |

#### 18.8.3 钱龄系统语音集成

钱龄系统的语音交互能力：

| 语音指令 | 意图 | 响应示例 |
|----------|------|----------|
| "我的钱龄是多少" | 钱龄查询 | "您的平均资金钱龄是14.2天，属于健康水平" |
| "哪些钱放太久了" | 超龄资金查询 | "有3笔共2000元已超过30天，建议合理使用" |
| "资金健康度怎么样" | 健康评估 | "您的资金健康度85分，比上月提升了5分" |
| "分析一下我的钱龄结构" | 结构分析 | "您的资金结构：短期45%、中期35%、长期20%" |

#### 18.8.4 预算系统语音集成

预算系统的语音交互能力：

| 语音指令 | 意图 | 响应示例 |
|----------|------|----------|
| "餐饮预算还剩多少" | 预算余额查询 | "餐饮预算还剩380元，已使用62%" |
| "设置本月餐饮预算1500" | 预算设置 | "好的，已将本月餐饮预算设置为1500元" |
| "哪个预算快超了" | 预算预警查询 | "交通预算已使用85%，建议控制支出" |
| "这个月预算执行怎么样" | 预算总览 | "本月总预算达成率78%，表现良好" |

#### 18.8.5 家庭账本语音集成

家庭账本的语音交互能力：

| 语音指令 | 意图 | 响应示例 |
|----------|------|----------|
| "邀请家人加入账本" | 成员邀请 | "已生成邀请链接，发送给家人即可加入" |
| "家庭本月消费多少" | 家庭统计 | "家庭本月总消费8520元，比上月减少12%" |
| "谁消费最多" | 成员排行 | "本月消费：您4200元，配偶3100元，孩子1220元" |
| "记一笔家庭聚餐200" | 共享记账 | "好的，已记录家庭聚餐200元，所有成员可见" |

#### 18.8.6 位置智能语音集成

位置服务的语音交互能力：

| 语音指令 | 意图 | 响应示例 |
|----------|------|----------|
| "附近在哪消费最多" | 位置分析 | "您在星巴克国贸店消费最多，月均300元" |
| "记一笔这里的午餐" | 位置记账 | "检测到您在海底捞，已自动填入商家信息" |
| "设置到公司自动提醒记账" | 地理围栏 | "好的，到达公司后会提醒您记录通勤费用" |

#### 18.8.7 自学习系统语音集成

与第17章自学习系统的协同：

| 学习能力 | 语音场景 | 学习效果 |
|----------|----------|----------|
| 意图识别学习 | 用户修正意图 | 提升意图识别准确率 |
| 实体提取学习 | 用户修正金额/分类 | 优化实体提取模型 |
| 语音习惯学习 | 用户常用表述 | 建立个人语音词典 |
| 偏好学习 | 用户语音偏好 | 自动适应语速/音量 |'''

    if old_section_18_8 in content:
        content = content.replace(old_section_18_8, new_section_18_8)
        print("OK: Expanded 18.8 integration section")
        changes += 1

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 18 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
