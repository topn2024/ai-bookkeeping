# -*- coding: utf-8 -*-
"""
刷新第28章用户口碑与NPS提升设计
1. 修复章节编号问题
2. 修正协同关系图中的章节引用
3. 添加28.0.3设计原则矩阵
4. 重新组织章节结构
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修正协同关系图中的章节引用 ==========
    ref_fixes = [
        # 修正伙伴化设计章节号
        ('│  │  伙伴化设计    │  │  习惯培养系统  │  │  钱龄分析系统  │               │',
         '│  │  伙伴化设计    │  │  习惯培养系统  │  │  钱龄分析系统  │               │'),
        ('│  │  (第4章)      │  │  (第9章)      │  │  (第7章)      │               │',
         '│  │  (第6章)      │  │  (第11章)     │  │  (第7章)      │               │'),
        # 修正下方引用
        ('│  │  数据可视化    │ │  国际化系统    │ │  用户体验设计  │                │',
         '│  │  数据可视化    │ │  国际化系统    │ │  用户体验设计  │                │'),
        ('│  │  (第12章)     │ │  (第21章)     │ │  (第20章)     │                │',
         '│  │  (第10章)     │ │  (第21章)     │ │  (第20章)     │                │'),
    ]

    for old, new in ref_fixes:
        if old in content and old != new:
            content = content.replace(old, new)
            print(f"Fix ref: {old[:40]}...")
            changes += 1

    # ========== 修复2: 修复章节编号问题 ==========
    # 把 "### 28.7.3 无障碍设计集成" 改为 "### 28.7 无障碍设计集成"
    old_section = '### 28.7.3 无障碍设计集成'
    new_section = '### 28.7 无障碍设计集成'
    if old_section in content:
        content = content.replace(old_section, new_section)
        print(f"Fix: {old_section} -> {new_section}")
        changes += 1

    # 把 "### 28.8 目标达成检测" 保持不变（编号正确）

    # 把第二个 "### 28.7 跨模块通知频率统一控制" 改为 "### 28.9 跨模块通知频率统一控制"
    old_dup = '### 28.7 跨模块通知频率统一控制'
    new_dup = '### 28.9 跨模块通知频率统一控制'
    if old_dup in content:
        content = content.replace(old_dup, new_dup)
        print(f"Fix: {old_dup} -> {new_dup}")
        changes += 1

    # 把 "#### 28.7.1 全局通知控制器" 改为 "#### 28.9.1 全局通知控制器"
    old_sub = '#### 28.7.1 全局通知控制器'
    new_sub = '#### 28.9.1 全局通知控制器'
    if old_sub in content:
        content = content.replace(old_sub, new_sub)
        print(f"Fix: {old_sub} -> {new_sub}")
        changes += 1

    # ========== 修复3: 添加28.0.3设计原则矩阵 ==========
    marker_28_1 = '### 28.1 NPS目标与监测机制'

    new_section_28_0_3 = '''#### 28.0.3 NPS提升设计原则矩阵

| 设计原则 | 实现方式 | 优先级 |
|----------|----------|--------|
| 价值驱动 | NPS基于真实产品价值，非营销技巧 | P0 |
| 惊喜时刻 | 在用户成就点触发惊喜体验 | P0 |
| 懒人分享 | 一键分享，自动生成分享素材 | P0 |
| 负面修复 | 主动检测贬损者并快速响应 | P0 |
| 推荐培育 | 系统性培养推荐者，提升口碑 | P1 |
| 渐进引导 | 首周价值感知路径设计 | P1 |

'''

    if marker_28_1 in content and '#### 28.0.3 NPS提升设计原则矩阵' not in content:
        content = content.replace(marker_28_1, new_section_28_0_3 + marker_28_1)
        print("OK: Added 28.0.3 design principle matrix")
        changes += 1

    # ========== 修复4: 添加28.10与其他系统集成 ==========
    chapter29_marker = '## 29. 低成本获客与自然增长设计'

    new_section_28_10 = '''### 28.10 与其他系统集成

#### 28.10.1 系统集成概览

NPS提升系统与2.0各模块的深度集成：

```
+------------------------------------------------------------------------+
|                      NPS提升系统集成全景图                                |
+------------------------------------------------------------------------+
|                                                                        |
|  +------------------------------------------------------------------+  |
|  |                        NPS核心服务                                 |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  |  | NPS监测   |  | 惊喜时刻  |  | 口碑分享  |  | 贬损挽回  |          |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  +-------------------------------+----------------------------------+  |
|                                  |                                     |
|         +------------------------+------------------------+            |
|         |                        |                        |            |
|         v                        v                        v            |
|  +-------------+          +-------------+          +-------------+     |
|  |  核心业务    |          |  体验系统    |          |  增长系统    |     |
|  |  NPS集成    |          |  NPS集成    |          |  NPS集成    |     |
|  +-------------+          +-------------+          +-------------+     |
|  | * 钱龄成就   |          | * 伙伴情感   |          | * 口碑获客   |     |
|  | * 预算达成   |          | * 习惯养成   |          | * 推荐奖励   |     |
|  | * 存钱目标   |          | * 首周体验   |          | * 裂变传播   |     |
|  +-------------+          +-------------+          +-------------+     |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 28.10.2 钱龄系统NPS集成

钱龄系统触发的NPS相关事件：

| 触发事件 | NPS动作 | 说明 |
|----------|---------|------|
| 首次查看钱龄 | 记录Aha时刻 | 差异化功能体验 |
| 钱龄优化成功 | 触发惊喜动画 | 资金健康改善 |
| 连续30天钱龄良好 | 解锁成就+分享 | 培养推荐者 |
| 钱龄洞察生成 | 提供分享素材 | 口碑传播点 |

#### 28.10.3 预算系统NPS集成

预算系统触发的NPS相关事件：

| 触发事件 | NPS动作 | 说明 |
|----------|---------|------|
| 首次预算达成 | 触发惊喜庆祝 | 增强成就感 |
| 连续月度预算达成 | 生成成就卡片 | 可分享素材 |
| 预算节省金额 | 展示节省统计 | 价值可视化 |
| 超预算预警 | 温和提醒 | 避免负面体验 |

#### 28.10.4 习惯培养系统NPS集成

习惯系统触发的NPS相关事件：

| 触发事件 | NPS动作 | 说明 |
|----------|---------|------|
| 习惯养成达成 | 解锁勋章 | 成就激励 |
| 记账连续打卡 | 生成打卡海报 | 社交分享 |
| 储蓄习惯形成 | 展示成长曲线 | 价值感知 |
| 消费习惯改善 | 生成对比报告 | 量化价值 |

#### 28.10.5 家庭账本NPS集成

家庭账本触发的NPS相关事件：

| 触发事件 | NPS动作 | 说明 |
|----------|---------|------|
| 成功邀请家人 | 双方奖励 | 裂变激励 |
| 家庭预算共同达成 | 家庭成就 | 增强归属 |
| 共享账单结清 | 感谢卡片 | 情感连接 |
| 家庭理财目标达成 | 全员庆祝 | 集体荣誉 |

#### 28.10.6 增长系统NPS集成

与第29章增长系统的协同：

| 集成点 | 协同方式 | 说明 |
|--------|----------|------|
| 推荐者识别 | 推荐者→增长大使 | 高NPS用户参与裂变 |
| 分享素材 | 共用素材库 | 28/29章共享 |
| 口碑追踪 | 统一归因 | 来源追踪 |
| 激励体系 | 推荐奖励 | 推荐者专属权益 |

---

'''

    if chapter29_marker in content:
        content = content.replace(chapter29_marker, new_section_28_10 + chapter29_marker)
        print("OK: Added 28.10 integration section")
        changes += 1
    else:
        print("SKIP: Chapter 29 marker not found")

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 28 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
