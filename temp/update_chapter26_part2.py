# -*- coding: utf-8 -*-
"""
更新第26章版本迁移策略 - 第二部分
更新26.5系统集成全景图和触发点表，添加新的集成代码
"""
import re

def update_chapter26_part2():
    with open('D:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'r', encoding='utf-8') as f:
        content = f.read()

    # 1. 更新26.5.0系统集成全景图
    old_landscape = '''#### 26.5.0 系统集成全景图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      版本迁移策略 - 系统集成全景图                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                          ┌───────────────────────┐                              │
│                          │    版本迁移服务        │                              │
│                          │  MigrationService     │                              │
│                          └───────────┬───────────┘                              │
│                                      │                                          │
│    ┌─────────────┬───────────┬───────┴───────┬───────────┬─────────────┐       │
│    │             │           │               │           │             │       │
│    ▼             ▼           ▼               ▼           ▼             ▼       │
│ ┌───────┐  ┌───────┐  ┌───────────┐  ┌───────────┐  ┌───────┐  ┌───────────┐  │
│ │钱龄系统│  │零基预算│  │ 数据导入  │  │ 数据备份  │  │APP升级│  │同步系统   │  │
│ │ (7章) │  │ (8章) │  │  (11章)  │  │  (本章)  │  │(本章) │  │  (16章)  │  │
│ │资源池  │  │小金库  │  │格式转换   │  │升级备份   │  │版本元数│  │数据对齐   │  │
│ │初始化  │  │迁移    │  │兼容性处理 │  │完整恢复   │  │据检查  │  │版本同步   │  │
│ └───────┘  └───────┘  └───────────┘  └───────────┘  └───────┘  └───────────┘  │
│                                                                                 │
│  ───────────────────────────────────────────────────────────────────────────   │
│                              2.0新增迁移模块                                     │
│  ───────────────────────────────────────────────────────────────────────────   │
│                                                                                 │
│ ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│ │ 家庭账本  │  │ 语音交互  │  │ 自学习系统 │  │ 位置智能  │  │ 习惯培养  │     │
│ │  (13章)  │  │  (18章)  │  │  (17章)  │  │  (14章)  │  │  (9章)   │     │
│ │          │  │          │  │          │  │          │  │          │     │
│ │ 家庭关系  │  │ 语音配置  │  │ 学习模型  │  │ 位置偏好  │  │ 成就数据  │     │
│ │ 表迁移   │  │ 数据迁移  │  │ 数据迁移  │  │ 数据迁移  │  │ 积分迁移  │     │
│ └───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```'''

    new_landscape = '''#### 26.5.0 系统集成全景图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      版本迁移策略 - 系统集成全景图                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                          ┌───────────────────────┐                              │
│                          │    版本迁移服务        │                              │
│                          │  MigrationService     │                              │
│                          └───────────┬───────────┘                              │
│                                      │                                          │
│    ┌─────────────┬───────────┬───────┴───────┬───────────┬─────────────┐       │
│    │             │           │               │           │             │       │
│    ▼             ▼           ▼               ▼           ▼             ▼       │
│ ┌───────┐  ┌───────┐  ┌───────────┐  ┌───────────┐  ┌───────┐  ┌───────────┐  │
│ │钱龄系统│  │零基预算│  │ 数据导入  │  │ 数据备份  │  │APP升级│  │同步系统   │  │
│ │ (7章) │  │ (8章) │  │  (11章)  │  │  (本章)  │  │(本章) │  │  (16章)  │  │
│ │资源池  │  │小金库  │  │格式转换   │  │升级备份   │  │版本元数│  │数据对齐   │  │
│ │初始化  │  │迁移    │  │兼容性处理 │  │完整恢复   │  │据检查  │  │版本同步   │  │
│ └───────┘  └───────┘  └───────────┘  └───────────┘  └───────┘  └───────────┘  │
│                                                                                 │
│  ═══════════════════════════════════════════════════════════════════════════   │
│                          2.0新增迁移模块 (第一层)                                │
│  ═══════════════════════════════════════════════════════════════════════════   │
│                                                                                 │
│ ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│ │ 家庭账本  │  │ 语音交互  │  │ 自学习系统 │  │ 位置智能  │  │ 习惯培养  │     │
│ │  (15章)  │  │  (18章)  │  │  (14章)  │  │  (12章)  │  │  (9章)   │     │
│ │          │  │          │  │          │  │          │  │          │     │
│ │ 家庭关系  │  │ 语音配置  │  │ 学习模型  │  │ 位置偏好  │  │ 成就数据  │     │
│ │ 成员角色  │  │ 语音历史  │  │ 反馈数据  │  │ 地理围栏  │  │ 连续记账  │     │
│ └───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
│                                                                                 │
│  ═══════════════════════════════════════════════════════════════════════════   │
│                          2.0新增迁移模块 (第二层)                                │
│  ═══════════════════════════════════════════════════════════════════════════   │
│                                                                                 │
│ ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│ │ 用户体验  │  │ NPS增长   │  │ 极致体验  │  │ 跨设备    │  │ 深度个性化 │     │
│ │  (20章)  │  │  (16章)  │  │ (20.16+) │  │ (20.17)  │  │ (20.18)  │     │
│ │          │  │          │  │          │  │          │  │          │     │
│ │ 主题偏好  │  │ NPS评分   │  │ 边界场景  │  │ 设备绑定  │  │ 个性化    │     │
│ │ 交互习惯  │  │ 反馈历史  │  │ 容错配置  │  │ 同步策略  │  │ 配置迁移  │     │
│ └───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
│                                                                                 │
│  ───────────────────────────────────────────────────────────────────────────   │
│                              迁移保障机制                                        │
│  ───────────────────────────────────────────────────────────────────────────   │
│                                                                                 │
│   ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐              │
│   │ 智能备份 │ ──▶ │ 分批迁移 │ ──▶ │ 完整校验 │ ──▶ │ 安全回滚 │              │
│   │ 版本元数 │      │ 断点续传 │      │ 金额一致 │      │ 一键恢复 │              │
│   └─────────┘      └─────────┘      └─────────┘      └─────────┘              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```'''

    content = content.replace(old_landscape, new_landscape)
    print("Phase 1: Updated 26.5.0 system integration landscape diagram")

    # 2. 更新26.5.1集成触发点表
    old_trigger_table = '''#### 26.5.1 集成触发点

| 集成模块 | 触发场景 | 迁移操作 | 回滚策略 |
|---------|---------|---------|---------|
| **钱龄系统** | Schema升级到v16 | 创建资源池表、初始化历史数据 | 删除资源池表及数据 |
| **零基预算** | Schema升级到v15 | 创建小金库表、迁移预算数据 | 恢复原预算结构 |
| **数据导入** | 导入旧版数据 | 格式版本检测、逐版本转换 | 保留原始导入文件 |
| **数据备份** | 版本升级前 | 智能判断是否需要备份 | 从备份完整恢复 |
| **APP升级** | 新版本安装 | 检测版本元数据、执行迁移链 | 回滚到升级前版本 |
| **同步系统** | 多设备数据同步 | 版本对齐、Schema兼容 | 保留冲突数据供用户处理 |'''

    new_trigger_table = '''#### 26.5.1 集成触发点

| 集成模块 | 触发场景 | 迁移操作 | 回滚策略 |
|---------|---------|---------|---------|
| **钱龄系统** | Schema升级到v16 | 创建资源池表、初始化历史数据 | 删除资源池表及数据 |
| **零基预算** | Schema升级到v15 | 创建小金库表、迁移预算数据 | 恢复原预算结构 |
| **数据导入** | 导入旧版数据 | 格式版本检测、逐版本转换 | 保留原始导入文件 |
| **数据备份** | 版本升级前 | 智能判断是否需要备份 | 从备份完整恢复 |
| **APP升级** | 新版本安装 | 检测版本元数据、执行迁移链 | 回滚到升级前版本 |
| **同步系统** | 多设备数据同步 | 版本对齐、Schema兼容 | 保留冲突数据供用户处理 |
| **语音交互** | Schema升级到v21 | 创建语音配置表、迁移历史记录 | 恢复默认语音设置 |
| **自学习系统** | Schema升级到v22 | 创建学习模型表、初始化权重 | 删除学习数据，使用默认模型 |
| **用户体验** | Schema升级到v23 | 迁移主题偏好、交互习惯配置 | 恢复系统默认主题 |
| **家庭账本** | Schema升级到v24 | 创建家庭表、成员角色迁移 | 删除家庭关系，保留个人数据 |
| **位置智能** | Schema升级到v25 | 创建位置偏好表、地理围栏配置 | 删除位置数据，关闭位置功能 |
| **习惯培养** | Schema升级到v26 | 创建成就表、连续记账数据初始化 | 删除成就记录，重置积分 |
| **NPS增长** | Schema升级到v27 | 创建反馈历史表、用户画像迁移 | 删除反馈数据 |
| **极致体验** | Schema升级到v28 | 迁移边界场景配置、容错策略 | 恢复默认容错配置 |'''

    content = content.replace(old_trigger_table, new_trigger_table)
    print("Phase 2: Updated 26.5.1 integration trigger table")

    with open('D:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'w', encoding='utf-8') as f:
        f.write(content)

    print("\nPart 2 updates completed!")

if __name__ == '__main__':
    update_chapter26_part2()
