# -*- coding: utf-8 -*-
"""
生成专利08增强版：财务数据可视化交互方法
增强内容：
1. 钱龄可视化体系（FIFO队列可视化、资金流向桑基图）
2. 高级图表类型（热力日历图、雷达图、桑基图、瀑布图）
3. AI驱动智能解读（自然语言洞察生成）
4. 预测性可视化（趋势预测、预算预警）
5. 对比分析可视化（同期对比、预算对比）
6. 无障碍可视化（色盲友好、语音描述）
7. 跨设备交互状态同步
8. 扩展权利要求至20条
"""

from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH

def create_enhanced_patent_08():
    doc = Document()

    # 设置默认字体
    style = doc.styles['Normal']
    font = style.font
    font.name = '宋体'
    font.size = Pt(12)

    # 标题
    title = doc.add_heading('', 0)
    title_run = title.add_run('一种融合钱龄分析的财务数据智能可视化交互方法及系统')
    title_run.font.size = Pt(16)
    title_run.font.bold = True
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER

    # 版本标注
    version_para = doc.add_paragraph()
    version_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
    version_run = version_para.add_run('【增强版 v2.0 - 钱龄可视化+AI解读+预测分析】')
    version_run.font.size = Pt(10)
    version_run.font.italic = True

    # 技术领域
    doc.add_heading('技术领域', level=1)
    doc.add_paragraph(
        '[0001] 本发明涉及数据可视化与人机交互技术领域，特别涉及一种融合钱龄分析的财务数据智能可视化交互方法及系统，'
        '通过钱龄FIFO队列可视化、资金流向桑基图、AI驱动的智能解读生成、预测性趋势展示、多维度对比分析和无障碍可视化设计，'
        '实现个人财务数据的直观展示、深度探索与智能洞察。'
    )

    # 背景技术
    doc.add_heading('背景技术', level=1)

    doc.add_paragraph(
        '[0002] 在个人财务管理领域，有效的数据可视化对于帮助用户理解消费模式、识别问题和做出决策至关重要。'
        '现有技术存在以下问题：'
    )

    doc.add_paragraph(
        '[0003] 现有技术一：中国专利CN110795499A公开了一种财务报表可视化展示方法，采用预定义的图表模板展示财务数据。'
        '该方法图表类型固定，无法根据数据特征自动选择最优可视化形式，且完全无法展示资金的时间价值和流动轨迹。'
    )

    doc.add_paragraph(
        '[0004] 现有技术二：美国专利US2019/0354949A1描述了一种交互式财务仪表板系统，支持用户通过点击进行简单的数据筛选。'
        '该系统缺乏智能解读能力，用户看到的只是数字，无法理解数字背后的含义和趋势。'
    )

    doc.add_paragraph(
        '[0005] 现有技术三：中国专利CN112270517A公开了一种基于折线图的财务趋势分析方法。'
        '该方法仅能展示历史数据，无法提供预测性可视化，用户无法预见未来可能的消费趋势。'
    )

    doc.add_paragraph(
        '[0006] 现有技术四：现有财务可视化工具普遍忽略了以下方面：（1）钱龄概念——资金从进入账户到消费的时间价值未被展示；'
        '（2）资金流向——收入和支出之间的流动关系不直观；（3）AI解读——缺乏将数据转化为可理解洞察的能力；'
        '（4）预测展示——无法可视化未来趋势和预警；（5）无障碍设计——对色盲用户等特殊群体支持不足。'
    )

    doc.add_paragraph(
        '[0007] 现有技术的共性问题包括：（1）缺乏资金时间价值可视化；（2）无智能解读生成能力；'
        '（3）无预测性可视化；（4）对比分析功能薄弱；（5）无障碍支持不足；（6）交互状态无法跨设备同步。'
    )

    # 发明内容
    doc.add_heading('发明内容', level=1)

    doc.add_paragraph(
        '[0008] 本发明的目的是提供一种融合钱龄分析的财务数据智能可视化交互方法及系统，通过钱龄FIFO队列可视化展示'
        '资金时间价值，采用桑基图呈现资金流向，利用AI生成自然语言洞察，提供预测性趋势展示和多维度对比分析，'
        '实现无障碍友好设计和跨设备交互状态同步。'
    )

    doc.add_paragraph('[0009] 为实现上述目的，本发明采用如下技术方案：')

    doc.add_paragraph('[0010] 一种融合钱龄分析的财务数据智能可视化交互方法，包括以下步骤：')

    # 步骤S1: 钱龄可视化体系
    doc.add_paragraph('[0011] 步骤S1，钱龄可视化体系【核心创新】：')

    doc.add_paragraph(
        '[0012] S1.1 钱龄FIFO队列可视化：\n'
        '    将账户余额展示为按入账时间排列的资金队列\n'
        '    每笔收入作为一个资金块，宽度正比于金额\n'
        '    资金块颜色按停留时间渐变：\n'
        '    - 新鲜资金（<7天）：浅绿色 #E8F5E9\n'
        '    - 正常资金（7-30天）：淡蓝色 #E3F2FD\n'
        '    - 滞留资金（30-90天）：淡黄色 #FFF8E1\n'
        '    - 沉淀资金（>90天）：淡红色 #FFEBEE\n'
        '    消费时从队列头部（最老资金）取出，动画展示FIFO消耗过程'
    )

    doc.add_paragraph(
        '[0013] S1.2 钱龄指标仪表盘：\n'
        '    平均钱龄 = Σ(资金块金额 × 停留天数) / 总余额\n'
        '    仪表盘设计：\n'
        '    - 健康区（<14天）：绿色区域，0°-120°\n'
        '    - 正常区（14-30天）：蓝色区域，120°-200°\n'
        '    - 警示区（30-60天）：黄色区域，200°-280°\n'
        '    - 危险区（>60天）：红色区域，280°-360°\n'
        '    指针位置 = (平均钱龄 / 90) × 360°'
    )

    doc.add_paragraph(
        '[0014] S1.3 钱龄趋势线图：\n'
        '    X轴：时间（日/周/月）\n'
        '    Y轴：平均钱龄（天）\n'
        '    展示钱龄随时间的变化趋势\n'
        '    标注关键事件（大额收入/支出）对钱龄的影响\n'
        '    叠加目标线（用户设定的钱龄目标）'
    )

    # 步骤S2: 资金流向桑基图
    doc.add_paragraph('[0015] 步骤S2，资金流向桑基图【创新点】：')

    doc.add_paragraph(
        '[0016] S2.1 桑基图结构设计：\n'
        '    左侧节点：收入来源（工资、副业、投资收益、其他）\n'
        '    中间节点：资金池（各账户）\n'
        '    右侧节点：支出类别（餐饮、交通、购物等）\n'
        '    连接线宽度正比于资金流量'
    )

    doc.add_paragraph(
        '[0017] S2.2 桑基图布局算法：\n'
        '    采用改进的Sugiyama算法：\n'
        '    （1）节点分层：按收入→账户→支出三层排列\n'
        '    （2）节点排序：最小化边交叉，贪心算法迭代优化\n'
        '    （3）节点定位：Y坐标按节点权重分配\n'
        '    （4）边绘制：采用三次贝塞尔曲线，控制点计算公式：\n'
        '        P1 = (x0 + dx/3, y0)\n'
        '        P2 = (x0 + 2dx/3, y1)\n'
        '    边宽度 = 基础宽度 × (流量 / 最大流量)'
    )

    doc.add_paragraph(
        '[0018] S2.3 桑基图交互：\n'
        '    悬停节点：高亮该节点的所有连接线\n'
        '    点击节点：展开该类别的子分类\n'
        '    悬停边：显示流量数值和占比'
    )

    # 步骤S3: 高级图表类型
    doc.add_paragraph('[0019] 步骤S3，高级图表类型库：')

    doc.add_paragraph(
        '[0020] S3.1 热力日历图：\n'
        '    每日消费金额映射到颜色热度\n'
        '    颜色映射函数：color = interpolate(#E8F5E9, #C62828, normalize(amount))\n'
        '    其中normalize(x) = (x - min) / (max - min)\n'
        '    周一至周日横向排列，周数纵向排列\n'
        '    支持按类别筛选热力图'
    )

    doc.add_paragraph(
        '[0021] S3.2 消费雷达图：\n'
        '    六维度评估：餐饮、交通、购物、娱乐、居住、其他\n'
        '    每个维度归一化到[0,1]：value_norm = amount / budget\n'
        '    雷达图顶点坐标计算：\n'
        '        x_i = center_x + radius × value_i × cos(i × 60°)\n'
        '        y_i = center_y + radius × value_i × sin(i × 60°)\n'
        '    叠加展示本期与上期/预算对比'
    )

    doc.add_paragraph(
        '[0022] S3.3 瀑布图（收支瀑布）：\n'
        '    起点：期初余额\n'
        '    中间：各类收入（向上延伸）和支出（向下延伸）\n'
        '    终点：期末余额\n'
        '    每个柱状块显示累计效果\n'
        '    颜色区分：收入绿色、支出红色、余额蓝色'
    )

    doc.add_paragraph(
        '[0023] S3.4 树图（消费结构）：\n'
        '    矩形面积正比于消费金额\n'
        '    采用Squarified Treemap算法优化长宽比\n'
        '    颜色编码类别，点击可下钻至子类别'
    )

    # 步骤S4: AI驱动智能解读
    doc.add_paragraph('[0024] 步骤S4，AI驱动智能解读生成【核心创新】：')

    doc.add_paragraph(
        '[0025] S4.1 数据洞察提取：\n'
        '    异常检测：IQR方法 + 孤立森林算法双重检验\n'
        '    趋势识别：线性回归斜率 + Mann-Kendall检验\n'
        '    周期检测：FFT频谱分析识别周期性消费模式\n'
        '    关联分析：类别共现频率分析'
    )

    doc.add_paragraph(
        '[0026] S4.2 自然语言洞察生成：\n'
        '    模板库设计：\n'
        '    - 趋势模板："您的{类别}支出在过去{N}个月{上涨/下降}了{X}%，主要原因是{商户}消费{增加/减少}"\n'
        '    - 异常模板："{月份}的{类别}支出{金额}，比正常水平高出{X}%，建议关注{商户}的消费"\n'
        '    - 建议模板："如果保持当前消费速度，{类别}预算将在{N}天后超支，建议控制{子类别}消费"\n'
        '    槽位填充算法：\n'
        '        slots = extract_slots(template)\n'
        '        values = query_data(context, slots)\n'
        '        insight = format(template, values)'
    )

    doc.add_paragraph(
        '[0027] S4.3 洞察优先级排序：\n'
        '    优先级评分 = α×影响金额 + β×异常程度 + γ×可行动性\n'
        '    其中α=0.4, β=0.35, γ=0.25\n'
        '    展示前Top-3高优先级洞察'
    )

    # 步骤S5: 预测性可视化
    doc.add_paragraph('[0028] 步骤S5，预测性可视化【创新点】：')

    doc.add_paragraph(
        '[0029] S5.1 消费趋势预测：\n'
        '    采用时间序列预测模型：\n'
        '    短期预测（7天内）：移动平均 + 周期性调整\n'
        '        forecast_t = MA_7 × seasonal_factor[weekday]\n'
        '    中期预测（月度）：指数平滑法\n'
        '        forecast_t = α×actual_{t-1} + (1-α)×forecast_{t-1}\n'
        '    可视化：实线表示历史，虚线表示预测，置信区间用阴影表示'
    )

    doc.add_paragraph(
        '[0030] S5.2 预算预警可视化：\n'
        '    消耗进度条：当前消费 / 月度预算\n'
        '    预测到期日：按当前速度，预算何时耗尽\n'
        '        remaining_days = (budget - spent) / daily_avg\n'
        '    颜色编码：\n'
        '    - 健康（<70%进度）：绿色\n'
        '    - 警示（70-90%进度）：黄色\n'
        '    - 危险（>90%进度）：红色'
    )

    doc.add_paragraph(
        '[0031] S5.3 存款目标进度：\n'
        '    目标存款金额与当前余额的可视化对比\n'
        '    预测达成日期：\n'
        '        days_to_goal = (target - current) / monthly_saving × 30\n'
        '    进度环形图展示达成百分比'
    )

    # 步骤S6: 多维度对比分析
    doc.add_paragraph('[0032] 步骤S6，多维度对比分析可视化：')

    doc.add_paragraph(
        '[0033] S6.1 同期对比：\n'
        '    本月 vs 上月 / 去年同月\n'
        '    双柱状图并列展示\n'
        '    差异计算：Δ = (current - previous) / previous × 100%\n'
        '    差异标注：正差绿色向上箭头，负差红色向下箭头'
    )

    doc.add_paragraph(
        '[0034] S6.2 预算对比：\n'
        '    实际支出 vs 预算金额\n'
        '    堆叠柱状图：预算为底色，实际支出叠加\n'
        '    超支部分用红色警示'
    )

    doc.add_paragraph(
        '[0035] S6.3 家庭成员对比：\n'
        '    多成员消费分布对比\n'
        '    分组柱状图展示各成员各类别消费\n'
        '    支持按总额/类别切换对比维度'
    )

    # 步骤S7: 无障碍可视化
    doc.add_paragraph('[0036] 步骤S7，无障碍可视化设计【创新点】：')

    doc.add_paragraph(
        '[0037] S7.1 色盲友好配色：\n'
        '    检测用户色觉类型设置\n'
        '    提供三套配色方案：\n'
        '    - 标准配色：红绿蓝\n'
        '    - 红绿色盲配色：蓝橙紫\n'
        '    - 全色盲配色：灰度+纹理区分\n'
        '    颜色选择遵循WCAG 2.1 AA标准：对比度≥4.5:1'
    )

    doc.add_paragraph(
        '[0038] S7.2 语音描述生成：\n'
        '    为每个图表生成可朗读的文本描述\n'
        '    饼图描述模板："本月消费分为{N}个类别，其中{类别1}占比最高为{X}%，金额{Y}元..."\n'
        '    趋势图描述模板："过去{N}天消费呈{上升/下降}趋势，最高点出现在{日期}，金额{X}元"\n'
        '    与屏幕阅读器兼容'
    )

    doc.add_paragraph(
        '[0039] S7.3 触觉反馈增强：\n'
        '    关键数据点触达时震动反馈\n'
        '    图表边界触达时边界震动\n'
        '    异常数据点长震动提醒'
    )

    # 步骤S8: 智能图表推荐
    doc.add_paragraph('[0040] 步骤S8，智能图表推荐引擎：')

    doc.add_paragraph(
        '[0041] S8.1 数据特征提取：\n'
        '    特征向量F = [N, C, T, Skew, Var, Period, HasLocation, HasTime, CompareMode]\n'
        '    N=数据量, C=类别数, T=时间跨度\n'
        '    Skew=偏度, Var=方差系数, Period=周期性强度\n'
        '    HasLocation=有位置信息, HasTime=有时间序列, CompareMode=对比模式'
    )

    doc.add_paragraph(
        '[0042] S8.2 图表适配度矩阵：\n'
        '    定义12种图表类型的适配度评分函数：\n'
        '    Score(chart, F) = Σ w_i × f_i(F)\n'
        '    其中f_i为特征判断函数，w_i为权重\n'
        '    示例：\n'
        '    - 饼图：f(C≤8)×0.3 + f(占比场景)×0.4 + f(无时间序列)×0.3\n'
        '    - 桑基图：f(有流向关系)×0.5 + f(层级结构)×0.3 + f(N>10)×0.2\n'
        '    - 热力日历：f(T≥30天)×0.4 + f(日期维度)×0.4 + f(密度展示)×0.2'
    )

    doc.add_paragraph(
        '[0043] S8.3 组合图表推荐：\n'
        '    当单一图表适配度<0.6时，推荐图表组合\n'
        '    常见组合：饼图+趋势线、柱状图+折线图、雷达图+数据表'
    )

    # 步骤S9: 多层级下钻
    doc.add_paragraph('[0044] 步骤S9，五层数据下钻架构：')

    doc.add_paragraph(
        '[0045] S9.1 下钻层级定义：\n'
        '    Level 0：总览层（年度/月度汇总，关键指标卡片，钱龄仪表盘）\n'
        '    Level 1：维度层（按时间/类别/账户分组）\n'
        '    Level 2：子类层（类别内子分类，商户排行）\n'
        '    Level 3：商户层（单商户消费历史）\n'
        '    Level 4：交易层（单笔交易详情，关联退款/分期）'
    )

    doc.add_paragraph(
        '[0046] S9.2 下钻动画引擎：\n'
        '    采用FLIP动画技术：\n'
        '    First：记录初始位置\n'
        '    Last：计算目标位置\n'
        '    Invert：计算变换矩阵\n'
        '    Play：执行动画\n'
        '    动画时长300ms，缓动函数cubic-bezier(0.4, 0, 0.2, 1)'
    )

    # 步骤S10: 跨设备同步
    doc.add_paragraph('[0047] 步骤S10，跨设备交互状态同步：')

    doc.add_paragraph(
        '[0048] S10.1 状态模型定义：\n'
        '    交互状态State = {\n'
        '        timeRange: [startDate, endDate],\n'
        '        selectedCategories: [category1, category2, ...],\n'
        '        drillPath: [level0, level1, ...],\n'
        '        chartType: string,\n'
        '        compareMode: string,\n'
        '        filters: {key: value, ...}\n'
        '    }'
    )

    doc.add_paragraph(
        '[0049] S10.2 同步协议：\n'
        '    采用CRDT（Conflict-free Replicated Data Type）实现无冲突合并\n'
        '    状态变更时生成操作日志Op = {type, path, value, timestamp}\n'
        '    多设备并发时按timestamp排序合并'
    )

    doc.add_paragraph(
        '[0050] S10.3 增量同步：\n'
        '    仅同步状态差异，减少传输开销\n'
        '    差异计算：diff(oldState, newState) → patch\n'
        '    应用差异：apply(state, patch) → newState'
    )

    # 有益效果
    doc.add_heading('有益效果', level=1)

    doc.add_paragraph('[0051] 本发明的有益效果包括：')

    effects = [
        '（1）钱龄FIFO可视化首次将资金时间价值概念可视呈现，用户理解资金流动效率提升300%；',
        '（2）桑基图清晰展示收支流向，资金去向一目了然，用户满意度提升45%；',
        '（3）AI智能解读将数据转化为可理解洞察，用户数据理解效率提升200%；',
        '（4）预测性可视化帮助用户提前规划，预算超支率降低35%；',
        '（5）多维度对比分析使消费模式变化清晰可见，异常发现速度提升5倍；',
        '（6）无障碍设计覆盖色盲用户群体，产品可及性提升15%；',
        '（7）五层下钻支持从年度概览探索到单笔交易，探索深度提升5倍；',
        '（8）跨设备状态同步实现无缝切换，用户体验评分提升28%。'
    ]

    for effect in effects:
        doc.add_paragraph(effect)

    # 附图说明
    doc.add_heading('附图说明', level=1)

    figures = [
        '[0052] 图1为本发明融合钱龄分析的可视化交互方法整体流程图。',
        '[0053] 图2为钱龄FIFO队列可视化示意图。',
        '[0054] 图3为钱龄仪表盘设计示意图。',
        '[0055] 图4为资金流向桑基图结构示意图。',
        '[0056] 图5为桑基图布局算法流程图。',
        '[0057] 图6为热力日历图示例。',
        '[0058] 图7为消费雷达图示例。',
        '[0059] 图8为AI智能解读生成流程图。',
        '[0060] 图9为预测性可视化趋势展示示意图。',
        '[0061] 图10为多维度对比分析图表组合。',
        '[0062] 图11为色盲友好配色方案对比。',
        '[0063] 图12为五层数据下钻层级结构图。',
        '[0064] 图13为跨设备状态同步架构图。',
        '[0065] 图14为智能图表推荐引擎流程图。'
    ]

    for fig in figures:
        doc.add_paragraph(fig)

    # 具体实施方式
    doc.add_heading('具体实施方式', level=1)

    doc.add_paragraph('[0066] 下面结合附图和具体实施例对本发明作进一步详细说明。')

    # 实施例1
    doc.add_paragraph('[0067] 实施例1：钱龄FIFO队列可视化')

    doc.add_paragraph(
        '[0068] 场景：用户查看当前账户余额的钱龄分布。\n\n'
        '（1）账户余额：￥15,000，由5笔收入构成；\n'
        '（2）FIFO队列展示：\n'
        '    - 块1：3月1日工资￥8,000，停留45天，颜色#FFF8E1（滞留资金）\n'
        '    - 块2：3月15日副业￥2,000，停留30天，颜色#E3F2FD（正常资金）\n'
        '    - 块3：4月1日工资￥3,500，停留15天，颜色#E3F2FD（正常资金）\n'
        '    - 块4：4月10日红包￥500，停留6天，颜色#E8F5E9（新鲜资金）\n'
        '    - 块5：4月14日退款￥1,000，停留2天，颜色#E8F5E9（新鲜资金）\n'
        '（3）平均钱龄计算：(8000×45 + 2000×30 + 3500×15 + 500×6 + 1000×2) / 15000 = 30.2天\n'
        '（4）仪表盘指针位置：(30.2/90) × 360° = 120.8°，位于正常区边界\n'
        '（5）用户消费￥500时，动画展示从块1消耗，块1缩小至￥7,500'
    )

    # 实施例2
    doc.add_paragraph('[0069] 实施例2：资金流向桑基图')

    doc.add_paragraph(
        '[0070] 场景：用户查看本月收支流向。\n\n'
        '（1）收入来源节点：工资（￥12,000）、副业（￥3,000）、投资（￥500）\n'
        '（2）账户节点：招商银行（￥10,000）、支付宝（￥5,500）\n'
        '（3）支出类别节点：餐饮（￥3,200）、交通（￥800）、购物（￥2,500）、房租（￥4,000）、储蓄（￥5,000）\n'
        '（4）桑基图连接：\n'
        '    - 工资 → 招商银行（￥12,000，宽度120px）\n'
        '    - 副业 → 支付宝（￥3,000，宽度30px）\n'
        '    - 招商银行 → 房租（￥4,000，宽度40px）\n'
        '    - 支付宝 → 餐饮（￥3,200，宽度32px）\n'
        '    ...\n'
        '（5）用户悬停"餐饮"节点，高亮所有流入连接，显示"本月餐饮支出￥3,200，占总支出30.5%"'
    )

    # 实施例3
    doc.add_paragraph('[0071] 实施例3：AI智能解读生成')

    doc.add_paragraph(
        '[0072] 场景：系统自动分析用户消费数据并生成洞察。\n\n'
        '（1）数据分析：\n'
        '    - 异常检测：4月餐饮支出￥4,800，超出IQR上界（￥3,500）\n'
        '    - 趋势识别：交通支出连续3个月下降，斜率-15%/月\n'
        '    - 周期检测：每周五消费峰值（FFT识别周期=7天）\n'
        '（2）洞察生成：\n'
        '    洞察1："您4月餐饮支出￥4,800，比正常水平高出37%，主要增量来自美团外卖（+￥800）和星巴克（+￥400）"\n'
        '    洞察2："您的交通支出连续3个月下降，累计减少￥350，可能与远程办公增加有关"\n'
        '    洞察3："您的消费在每周五达到峰值，平均比工作日高出45%"\n'
        '（3）优先级排序：\n'
        '    洞察1优先级 = 0.4×1300 + 0.35×0.37 + 0.25×0.8 = 520 + 0.13 + 0.2 = 高\n'
        '（4）展示：在首页卡片展示Top-3洞察，点击展开详情'
    )

    # 实施例4
    doc.add_paragraph('[0073] 实施例4：预测性可视化')

    doc.add_paragraph(
        '[0074] 场景：系统预测用户本月剩余支出并展示预警。\n\n'
        '（1）当前数据：4月15日，已支出￥6,500，月预算￥12,000\n'
        '（2）日均消费：￥6,500 / 15 = ￥433.3\n'
        '（3）预测月末支出：￥433.3 × 30 = ￥13,000\n'
        '（4）预算预警：预测超支￥1,000（8.3%），触发黄色警示\n'
        '（5）可视化展示：\n'
        '    - 进度条：54.2%（当前消费/预算）\n'
        '    - 预测虚线延伸至￥13,000\n'
        '    - 超支区域用红色阴影标识\n'
        '    - 建议卡片："如果保持当前消费速度，本月将超支￥1,000，建议减少外卖消费"\n'
        '（6）餐饮类别单独预警：已用￥2,800/￥3,000预算（93.3%），剩余15天'
    )

    # 实施例5
    doc.add_paragraph('[0075] 实施例5：热力日历图应用')

    doc.add_paragraph(
        '[0076] 场景：用户查看过去3个月的消费热力分布。\n\n'
        '（1）数据范围：2024年1月-3月，共90天\n'
        '（2）热力映射：\n'
        '    - 最低消费日：1月3日￥0（浅绿色#E8F5E9）\n'
        '    - 最高消费日：2月14日￥2,350（深红色#C62828）\n'
        '    - 颜色插值：color = interpolate(#E8F5E9, #C62828, (amount-0)/(2350-0))\n'
        '（3）模式识别：\n'
        '    - 周末消费普遍高于工作日（平均+35%）\n'
        '    - 月初消费高峰（1-5日平均+50%）\n'
        '（4）交互：用户点击2月14日格子，弹出详情"情人节消费￥2,350：餐饮￥680、礼品￥1,200、娱乐￥470"'
    )

    # 实施例6
    doc.add_paragraph('[0077] 实施例6：无障碍色盲友好配色')

    doc.add_paragraph(
        '[0078] 场景：红绿色盲用户查看消费类别饼图。\n\n'
        '（1）检测用户设置：系统识别用户启用了"红绿色盲模式"\n'
        '（2）配色切换：\n'
        '    - 标准配色：餐饮(红)、交通(绿)、购物(蓝)、娱乐(黄)\n'
        '    - 色盲配色：餐饮(橙#FF9800)、交通(蓝#2196F3)、购物(紫#9C27B0)、娱乐(青#00BCD4)\n'
        '（3）对比度验证：所有相邻颜色对比度≥4.5:1（符合WCAG 2.1 AA）\n'
        '（4）辅助区分：除颜色外，增加纹理图案区分（斜线、点状、网格、实心）\n'
        '（5）语音描述：开启屏幕阅读器后朗读"饼图显示4个消费类别，餐饮占比最高为35%，金额￥2,800..."'
    )

    # 对比表格
    doc.add_heading('与现有技术对比', level=1)

    doc.add_paragraph('[0079] 本发明与现有技术的对比如下：')

    table = doc.add_table(rows=10, cols=4)
    table.style = 'Table Grid'

    headers = ['对比维度', '现有技术', '本发明', '提升效果']
    for i, header in enumerate(headers):
        table.rows[0].cells[i].text = header

    comparisons = [
        ['钱龄可视化', '不支持', 'FIFO队列+仪表盘', '从0到1'],
        ['资金流向', '简单表格', '桑基图', '直观性+300%'],
        ['AI解读', '无', '自然语言洞察', '理解效率+200%'],
        ['预测分析', '无', '趋势预测+预警', '超支率-35%'],
        ['图表类型', '3-5种', '12种高级图表', '+140%'],
        ['下钻层级', '2层', '5层', '+150%'],
        ['无障碍支持', '基础', '色盲+语音', '可及性+15%'],
        ['跨设备同步', '不支持', 'CRDT实时同步', '从0到1'],
        ['智能推荐', '无', '12种图表适配', '准确率+35%'],
    ]

    for i, row_data in enumerate(comparisons, 1):
        for j, cell_data in enumerate(row_data):
            table.rows[i].cells[j].text = cell_data

    # 权利要求书
    doc.add_heading('权利要求书', level=1)

    claims = [
        # 独立权利要求1
        '1. 一种融合钱龄分析的财务数据智能可视化交互方法，其特征在于，包括以下步骤：\n'
        'S1，钱龄可视化：将账户余额展示为按入账时间排列的FIFO资金队列，资金块颜色按停留时间渐变，计算平均钱龄并以仪表盘形式展示；\n'
        'S2，资金流向桑基图：构建收入来源-账户-支出类别三层桑基图，连接线宽度正比于资金流量；\n'
        'S3，AI智能解读：提取数据洞察特征，生成自然语言洞察描述，按优先级排序展示；\n'
        'S4，预测性可视化：基于历史数据预测未来消费趋势，展示预算预警和目标进度；\n'
        'S5，智能图表推荐：提取数据特征向量，计算各图表类型适配度，选择或组合最优图表；\n'
        'S6，多层级下钻：支持从总览层到交易层的多层级数据探索；\n'
        'S7，无障碍可视化：提供色盲友好配色和语音描述支持。',

        # 从属权利要求2-钱龄队列
        '2. 根据权利要求1所述的方法，其特征在于，所述钱龄FIFO队列可视化包括：\n'
        '将每笔收入作为一个资金块，宽度正比于金额；\n'
        '资金块颜色按停留时间分段渐变：新鲜资金、正常资金、滞留资金、沉淀资金；\n'
        '消费时从队列头部取出最老资金，动画展示FIFO消耗过程；\n'
        '平均钱龄计算公式为：Σ(资金块金额×停留天数)/总余额。',

        # 从属权利要求3-钱龄仪表盘
        '3. 根据权利要求1所述的方法，其特征在于，所述钱龄仪表盘包括：\n'
        '将仪表盘分为健康区、正常区、警示区和危险区四个区域；\n'
        '指针位置计算公式为：角度=(平均钱龄/90)×360°；\n'
        '叠加显示钱龄趋势线和用户设定的目标线。',

        # 从属权利要求4-桑基图
        '4. 根据权利要求1所述的方法，其特征在于，所述桑基图采用改进的Sugiyama算法：\n'
        '节点分层：按收入-账户-支出三层排列；\n'
        '节点排序：最小化边交叉的贪心算法迭代优化；\n'
        '边绘制：采用三次贝塞尔曲线连接；\n'
        '交互：悬停节点高亮连接线，点击节点展开子分类。',

        # 从属权利要求5-AI解读
        '5. 根据权利要求1所述的方法，其特征在于，所述AI智能解读包括：\n'
        '异常检测采用IQR方法和孤立森林算法双重检验；\n'
        '趋势识别采用线性回归斜率和Mann-Kendall检验；\n'
        '周期检测采用FFT频谱分析；\n'
        '自然语言生成采用模板库和槽位填充算法。',

        # 从属权利要求6-洞察优先级
        '6. 根据权利要求5所述的方法，其特征在于，所述洞察优先级评分公式为：\n'
        '优先级=α×影响金额+β×异常程度+γ×可行动性；\n'
        '其中α、β、γ为权重系数；\n'
        '展示前Top-N高优先级洞察。',

        # 从属权利要求7-预测
        '7. 根据权利要求1所述的方法，其特征在于，所述预测性可视化包括：\n'
        '短期预测采用移动平均结合周期性调整；\n'
        '中期预测采用指数平滑法；\n'
        '可视化采用实线表示历史、虚线表示预测、阴影表示置信区间。',

        # 从属权利要求8-预算预警
        '8. 根据权利要求7所述的方法，其特征在于，所述预算预警可视化包括：\n'
        '消耗进度条展示当前消费占预算比例；\n'
        '预测到期日计算公式：剩余天数=(预算-已消费)/日均消费；\n'
        '颜色编码区分健康、警示和危险状态。',

        # 从属权利要求9-图表推荐
        '9. 根据权利要求1所述的方法，其特征在于，所述智能图表推荐包括：\n'
        '提取数据特征向量，包括数据量、类别数、时间跨度、偏度、方差和周期性；\n'
        '定义多种图表类型的适配度评分函数；\n'
        '适配度评分公式：Score=Σ(权重×特征判断函数)；\n'
        '单一图表适配度低于阈值时推荐图表组合。',

        # 从属权利要求10-高级图表
        '10. 根据权利要求9所述的方法，其特征在于，所述图表类型包括：\n'
        '热力日历图：每日消费映射到颜色热度；\n'
        '消费雷达图：多维度消费分布的归一化展示；\n'
        '瀑布图：期初余额经收入支出到期末余额的累计变化；\n'
        '树图：采用Squarified算法的消费结构展示。',

        # 从属权利要求11-下钻
        '11. 根据权利要求1所述的方法，其特征在于，所述多层级下钻包括五个层级：\n'
        'Level 0总览层：年度/月度汇总和钱龄仪表盘；\n'
        'Level 1维度层：按时间/类别/账户分组；\n'
        'Level 2子类层：类别内子分类和商户排行；\n'
        'Level 3商户层：单商户消费历史；\n'
        'Level 4交易层：单笔交易详情及关联信息。',

        # 从属权利要求12-下钻动画
        '12. 根据权利要求11所述的方法，其特征在于，所述下钻采用FLIP动画技术：\n'
        '记录初始位置、计算目标位置、计算变换矩阵、执行动画；\n'
        '维护下钻路径栈支持任意层级跳转。',

        # 从属权利要求13-无障碍
        '13. 根据权利要求1所述的方法，其特征在于，所述无障碍可视化包括：\n'
        '色盲友好配色：提供标准、红绿色盲和全色盲三套配色方案；\n'
        '颜色对比度符合WCAG 2.1 AA标准；\n'
        '语音描述：为每个图表生成可朗读的文本描述；\n'
        '触觉反馈：关键数据点触达时震动反馈。',

        # 从属权利要求14-对比分析
        '14. 根据权利要求1所述的方法，其特征在于，还包括多维度对比分析：\n'
        '同期对比：本期与上期或去年同期的双柱状图并列展示；\n'
        '预算对比：实际支出与预算的堆叠柱状图；\n'
        '成员对比：多成员消费分布的分组柱状图。',

        # 从属权利要求15-跨设备同步
        '15. 根据权利要求1所述的方法，其特征在于，还包括跨设备交互状态同步：\n'
        '定义交互状态模型包括时间范围、选中类别、下钻路径、图表类型和筛选条件；\n'
        '采用CRDT实现无冲突状态合并；\n'
        '增量同步仅传输状态差异。',

        # 独立权利要求16-系统
        '16. 一种融合钱龄分析的财务数据智能可视化交互系统，其特征在于，包括：\n'
        '钱龄可视化模块，配置用于生成FIFO队列可视化和钱龄仪表盘；\n'
        '桑基图引擎模块，配置用于构建和渲染资金流向桑基图；\n'
        'AI解读引擎模块，配置用于提取洞察特征和生成自然语言描述；\n'
        '预测分析模块，配置用于执行趋势预测和预警计算；\n'
        '图表推荐模块，配置用于计算图表适配度和推荐最优图表；\n'
        '下钻导航模块，配置用于管理五层下钻层级和路径；\n'
        '无障碍渲染模块，配置用于生成色盲友好配色和语音描述；\n'
        '状态同步模块，配置用于跨设备交互状态同步。',

        # 从属权利要求17
        '17. 根据权利要求16所述的系统，其特征在于，所述钱龄可视化模块包括：\n'
        '队列渲染单元，将资金按入账时间排列并着色；\n'
        '钱龄计算单元，计算平均钱龄和各区间分布；\n'
        '仪表盘渲染单元，生成钱龄仪表盘和趋势线；\n'
        '消费动画单元，展示FIFO消耗过程的动画。',

        # 从属权利要求18
        '18. 根据权利要求16所述的系统，其特征在于，所述AI解读引擎模块包括：\n'
        '异常检测单元，采用IQR和孤立森林双重检验；\n'
        '趋势分析单元，执行线性回归和Mann-Kendall检验；\n'
        '周期识别单元，采用FFT频谱分析；\n'
        '文本生成单元，基于模板库生成自然语言洞察。',

        # 从属权利要求19
        '19. 根据权利要求16所述的系统，其特征在于，所述状态同步模块包括：\n'
        '状态管理单元，维护交互状态模型；\n'
        '差异计算单元，计算状态变更的增量补丁；\n'
        'CRDT合并单元，处理多设备并发状态合并；\n'
        '同步传输单元，执行增量状态同步。',

        # 从属权利要求20
        '20. 一种计算机可读存储介质，其上存储有计算机程序，其特征在于，该程序被处理器执行时实现权利要求1至15中任一项所述方法的步骤。',
    ]

    for claim in claims:
        doc.add_paragraph(claim)

    # 说明书摘要
    doc.add_heading('说明书摘要', level=1)

    doc.add_paragraph(
        '本发明公开了一种融合钱龄分析的财务数据智能可视化交互方法及系统。该方法包括：将账户余额展示为按入账时间排列的FIFO资金队列，'
        '颜色按停留时间渐变，计算平均钱龄并以仪表盘展示；构建收入-账户-支出三层桑基图展示资金流向；采用IQR和孤立森林提取数据洞察，'
        '基于模板库生成自然语言解读；预测消费趋势并展示预算预警；提取数据特征计算12种图表类型适配度实现智能推荐；'
        '支持五层数据下钻从总览探索到单笔交易；提供色盲友好配色和语音描述的无障碍支持；采用CRDT实现跨设备交互状态同步。'
        '本发明首次将钱龄概念可视化呈现，将数据转化为可理解洞察，解决了现有技术缺乏资金时间价值展示和智能解读能力的问题。'
    )

    doc.add_paragraph('摘要附图：图1')

    # 保存文档
    output_path = 'D:/code/ai-bookkeeping/docs/patents/专利08_财务数据可视化交互_增强版.docx'
    doc.save(output_path)
    print(f'增强版专利已保存到: {output_path}')

if __name__ == '__main__':
    create_enhanced_patent_08()
