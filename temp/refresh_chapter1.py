# -*- coding: utf-8 -*-
"""
刷新第1章设计概述
1. 添加1.0 设计原则回顾
2. 添加1.5 2.0版本架构全景图
3. 添加1.6 文档结构导航
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 添加1.0设计原则回顾 ==========
    # 在"## 1. 设计概述"之后，"### 1.1 项目背景"之前插入
    marker_11 = '''## 1. 设计概述

### 1.1 项目背景'''

    new_section_10 = '''## 1. 设计概述

### 1.0 设计原则回顾

#### 1.0.1 2.0版本核心设计原则矩阵

| 设计原则 | 核心理念 | 章节详述 | 覆盖范围 |
|----------|----------|----------|----------|
| 懒人优先 | 最少操作，最大价值 | 第3章 | 全局 |
| 伙伴化 | 有温度的财务伙伴 | 第4章 | 交互体验 |
| 无障碍 | 普惠金融，人人可用 | 第5章 | 全局 |
| 数据驱动 | 用数据辅助决策 | 第9章 | 分析洞察 |
| 智能优先 | AI赋能自动化 | 第17章 | 核心功能 |

#### 1.0.2 设计原则体系架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AI智能记账2.0 设计原则体系                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────────┐                             │
│                         │    用户价值中心      │                             │
│                         │ 省时·省心·省力·安心  │                             │
│                         └──────────┬──────────┘                             │
│                                    │                                        │
│         ┌──────────────────────────┼──────────────────────────┐             │
│         │                          │                          │             │
│         ▼                          ▼                          ▼             │
│  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐        │
│  │  懒人优先    │           │  伙伴化     │           │  无障碍     │        │
│  │ Lazy-First  │           │ Companion   │           │Accessibility│        │
│  │             │           │             │           │             │        │
│  │ ·一键操作   │           │ ·情感化文案 │           │ ·多模态交互 │        │
│  │ ·智能推荐   │           │ ·成就激励   │           │ ·老年模式   │        │
│  │ ·自动分类   │           │ ·鼓励反馈   │           │ ·屏幕阅读   │        │
│  └──────┬──────┘           └──────┬──────┘           └──────┬──────┘        │
│         │                          │                          │             │
│         └──────────────────────────┼──────────────────────────┘             │
│                                    │                                        │
│                                    ▼                                        │
│                    ┌───────────────────────────────┐                        │
│                    │       功能模块实现层           │                        │
│                    │ 记账·预算·报表·分析·协作       │                        │
│                    └───────────────────────────────┘                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 1.0.3 与2.0各章节的协同关系

```
                           第1章 设计概述
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
            ▼                    ▼                    ▼
    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │ 第2章        │      │ 第3-5章      │      │ 第6-14章    │
    │ 产品定位    │      │ 设计原则    │      │ 业务功能    │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
            │                    │                    │
            └────────────────────┼────────────────────┘
                                 │
                                 ▼
                    ┌───────────────────────┐
                    │    第15-19章          │
                    │  技术架构与性能       │
                    └───────────┬───────────┘
                                 │
                                 ▼
                    ┌───────────────────────┐
                    │    第20-29章          │
                    │  运维·测试·迁移       │
                    └───────────────────────┘
```

### 1.1 项目背景'''

    if marker_11 in content and '### 1.0 设计原则回顾' not in content:
        content = content.replace(marker_11, new_section_10)
        print("OK: Added 1.0 设计原则回顾")
        changes += 1

    # ========== 添加1.5和1.6新章节 ==========
    # 在1.4.5之后，"---\n\n\n---\n\n## 2."之前添加
    marker_chapter2 = '''---


---

## 2. 产品定位与愿景'''

    new_sections_15_16 = '''### 1.5 2.0版本架构全景图

#### 1.5.1 系统架构分层

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI智能记账2.0 系统架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         表现层 (Presentation)                        │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │   │
│  │  │ 语音UI  │  │ 图形UI  │  │ 通知UI  │  │ 小组件   │  │ 快捷方式 │   │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         业务层 (Business)                            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │ 记账服务   │  │ 预算服务   │  │ 分析服务   │  │ 协作服务   │        │   │
│  │  │ (第6-8章) │  │ (第10章)  │  │ (第9章)   │  │ (第13章)  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         智能层 (Intelligence)                        │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │ 语音识别   │  │ 图像识别   │  │ 自学习     │  │ 位置智能   │        │   │
│  │  │ (第18章)  │  │ (第7章)   │  │ (第17章)  │  │ (第14章)  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         数据层 (Data)                                │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │ 本地存储   │  │ 云端同步   │  │ 缓存管理   │  │ 数据加密   │        │   │
│  │  │ (第15章)  │  │ (第16章)  │  │ (第19章)  │  │ (第22章)  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 1.5.2 核心模块依赖关系

```dart
/// 2.0版本模块依赖图
class ModuleDependencyGraph {
  static const dependencies = {
    // 核心基础模块（无依赖）
    'core': [],
    'database': ['core'],
    'network': ['core'],

    // 业务模块
    'transaction': ['database', 'category'],
    'category': ['database'],
    'account': ['database'],
    'budget': ['database', 'transaction', 'category'],

    // 智能模块
    'voice_recognition': ['core', 'ai_service'],
    'image_recognition': ['core', 'ai_service'],
    'self_learning': ['database', 'analytics'],
    'location_intelligence': ['core', 'poi_service'],

    // 高级功能模块
    'money_age': ['transaction', 'account'],
    'zero_budget': ['budget', 'income'],
    'family_ledger': ['transaction', 'user', 'sync'],
    'habit_tracking': ['database', 'notification'],

    // 分析模块
    'analytics': ['transaction', 'budget'],
    'report': ['analytics', 'chart'],
    'insight': ['analytics', 'ai_service'],
  };
}
```

### 1.6 文档结构导航

#### 1.6.1 章节速查表

| 部分 | 章节 | 标题 | 主要内容 |
|------|------|------|----------|
| **概述** | 1 | 设计概述 | 项目背景、设计原则、版本目标 |
|  | 2 | 产品定位与愿景 | 用户画像、价值主张、竞品差异 |
| **原则** | 3 | 懒人设计原则 | 一键操作、智能默认、自动化 |
|  | 4 | 伙伴化设计原则 | 情感化、激励化、人性化 |
|  | 5 | 无障碍设计 | 多模态、老年模式、屏幕阅读 |
| **功能** | 6 | 记账模块 | 手动记账、快速记账 |
|  | 7 | AI识别 | 语音识别、图像识别、智能分类 |
|  | 8 | 智能分类 | 自动分类、规则学习 |
|  | 9 | 数据联动与可视化 | 图表下钻、数据筛选 |
|  | 10 | 预算管理 | 零基预算、小金库、预警 |
|  | 11 | 习惯培养 | 打卡、挑战、成就 |
|  | 12 | 钱龄分析 | FIFO计算、可视化、洞察 |
|  | 13 | 家庭账本 | 协作记账、权限管理 |
|  | 14 | 位置智能 | POI识别、场景推荐 |
| **技术** | 15 | 技术架构 | 分层架构、模块设计 |
|  | 16 | 数据同步 | 云端同步、冲突解决 |
|  | 17 | 自学习系统 | 用户偏好、模式识别 |
|  | 18 | 语音交互设计 | 多轮对话、意图理解 |
|  | 19 | 性能优化 | 启动优化、内存管理 |
| **质量** | 20 | 异常处理 | 错误恢复、降级策略 |
|  | 21 | 可观测性 | 日志、监控、告警 |
|  | 22 | 安全设计 | 加密、认证、隐私 |
|  | 23 | 国际化 | 多语言、货币、时区 |
|  | 24 | 测试策略 | 单元测试、集成测试 |
| **运维** | 25 | 部署与发布 | CI/CD、灰度发布 |
|  | 26 | 版本迁移 | 数据迁移、兼容性 |
|  | 27 | 运营支持 | 数据埋点、A/B测试 |
|  | 28 | 反馈与迭代 | 用户反馈、版本规划 |
|  | 29 | 附录 | 术语表、API参考 |

#### 1.6.2 按角色阅读建议

```dart
/// 文档阅读路径建议
const readingPathsByRole = {
  // 产品经理
  'product_manager': [
    '第1章 设计概述',
    '第2章 产品定位与愿景',
    '第3-5章 设计原则',
    '第6-14章 功能模块',
    '第28章 反馈与迭代',
  ],

  // 开发工程师
  'developer': [
    '第1章 设计概述',
    '第15章 技术架构',
    '第6-14章 功能模块',
    '第16-19章 技术专题',
    '第20-22章 质量保障',
  ],

  // 测试工程师
  'qa_engineer': [
    '第1章 设计概述',
    '第24章 测试策略',
    '第20章 异常处理',
    '第21章 可观测性',
    '第6-14章 功能模块',
  ],

  // 设计师
  'designer': [
    '第1章 设计概述',
    '第2章 产品定位与愿景',
    '第3-5章 设计原则',
    '第23章 国际化',
  ],
};
```

---


---

## 2. 产品定位与愿景'''

    if marker_chapter2 in content and '### 1.5 2.0版本架构全景图' not in content:
        content = content.replace(marker_chapter2, new_sections_15_16)
        print("OK: Added 1.5 and 1.6 sections")
        changes += 1

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 1 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
