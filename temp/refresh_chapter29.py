# -*- coding: utf-8 -*-
"""
刷新第29章低成本获客与自然增长设计
1. 修正协同关系图中的章节引用
2. 修复章节编号问题
3. 添加29.0.3设计原则矩阵
4. 添加29.7与其他系统集成
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修正协同关系图中的章节引用 ==========
    ref_fixes = [
        # 修正数据可视化章节号
        ('|  |  数据可视化   |  |  习惯培养系统  |                |',
         '|  |  数据可视化   |  |  习惯培养系统  |                |'),
        ('|  |  (第12章)     |  |  (第9章)      |                |',
         '|  |  (第10章)     |  |  (第11章)     |                |'),
    ]

    for old, new in ref_fixes:
        if old in content and old != new:
            content = content.replace(old, new)
            print(f"Fix ref: {old[:40]}...")
            changes += 1

    # ========== 修复2: 修复章节编号问题 ==========
    # 把 "### 29.5.1 无障碍设计集成" 改为 "#### 29.5.3 无障碍设计集成"
    old_section = '### 29.5.1 无障碍设计集成'
    new_section = '#### 29.5.3 无障碍设计集成'
    if old_section in content:
        content = content.replace(old_section, new_section)
        print(f"Fix: {old_section} -> {new_section}")
        changes += 1

    # ========== 修复3: 添加29.0.3设计原则矩阵 ==========
    marker_29_1 = '### 29.1 产品内置增长引擎'

    new_section_29_0_3 = '''#### 29.0.3 低成本获客设计原则矩阵

| 设计原则 | 实现方式 | 优先级 |
|----------|----------|--------|
| CAC控制 | 综合CAC<=30元/用户 | P0 |
| 自然增长 | 40%流量来自自然渠道 | P0 |
| 口碑裂变 | K值>=0.5的病毒系数 | P0 |
| 体验优先 | 增长不损害用户体验 | P0 |
| 可追踪 | 全渠道可归因分析 | P1 |
| 内容驱动 | 产品自动生成可传播内容 | P1 |

'''

    if marker_29_1 in content and '#### 29.0.3 低成本获客设计原则矩阵' not in content:
        content = content.replace(marker_29_1, new_section_29_0_3 + marker_29_1)
        print("OK: Added 29.0.3 design principle matrix")
        changes += 1

    # ========== 修复4: 在文件末尾添加29.7与其他系统集成 ==========
    # 找到29.6目标达成检测的结束位置，在其后添加29.7

    new_section_29_7 = '''

### 29.7 与其他系统集成

#### 29.7.1 系统集成概览

低成本获客系统与2.0各模块的深度集成：

```
+------------------------------------------------------------------------+
|                      低成本获客系统集成全景图                             |
+------------------------------------------------------------------------+
|                                                                        |
|  +------------------------------------------------------------------+  |
|  |                        获客核心服务                                |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  |  | 增长引擎  |  | ASO优化   |  | 内容生成  |  | 裂变系统  |          |  |
|  |  +----------+  +----------+  +----------+  +----------+          |  |
|  +-------------------------------+----------------------------------+  |
|                                  |                                     |
|         +------------------------+------------------------+            |
|         |                        |                        |            |
|         v                        v                        v            |
|  +-------------+          +-------------+          +-------------+     |
|  |  核心业务    |          |  社交系统    |          |  NPS系统    |     |
|  |  素材生成    |          |  裂变集成    |          |  协同增长    |     |
|  +-------------+          +-------------+          +-------------+     |
|  | * 钱龄报告   |          | * 家庭邀请   |          | * 推荐者激活 |     |
|  | * 预算达成   |          | * 情侣AA    |          | * 口碑获客   |     |
|  | * 存钱成就   |          | * 好友排行   |          | * 分享奖励   |     |
|  +-------------+          +-------------+          +-------------+     |
|                                                                        |
+------------------------------------------------------------------------+
```

#### 29.7.2 钱龄系统获客集成

钱龄系统的增长驱动能力：

| 功能点 | 获客价值 | 实现方式 |
|--------|----------|----------|
| 钱龄报告 | ASO差异化关键词 | "钱龄分析"搜索优化 |
| 钱龄可视化 | 可分享内容 | 生成钱龄图表卡片 |
| 钱龄洞察 | 内容营销素材 | 自动生成理财文章 |
| 钱龄改善 | 成就分享 | 钱龄优化成功卡片 |

#### 29.7.3 预算系统获客集成

预算系统的增长驱动能力：

| 功能点 | 获客价值 | 实现方式 |
|--------|----------|----------|
| 预算达成 | 成就分享素材 | 月度预算达成卡片 |
| 节省金额 | 价值可视化 | "本月节省X元"分享 |
| 预算模板 | 内容传播 | 可分享的预算模板 |
| 消费对比 | 社交裂变 | 匿名消费对比排行 |

#### 29.7.4 家庭账本获客集成

家庭账本的裂变增长能力：

| 功能点 | 获客价值 | 实现方式 |
|--------|----------|----------|
| 家庭邀请 | 核心裂变渠道 | 邀请家人共同记账 |
| 共享账本 | 天然病毒传播 | 家庭成员必须安装 |
| AA记账 | 情侣/室友裂变 | 账单分摊邀请 |
| 家庭成就 | 集体分享 | 家庭理财目标达成 |

#### 29.7.5 NPS系统协同集成

与第28章NPS系统的协同：

| 协同点 | 协同方式 | 说明 |
|--------|----------|------|
| 推荐者识别 | NPS高分用户→增长大使 | 精准激活高价值用户 |
| 分享素材 | 共用统一素材库 | 28/29章素材复用 |
| 口碑追踪 | 统一归因系统 | 来源渠道追踪 |
| 激励体系 | 推荐奖励机制 | 推荐者专属权益 |

#### 29.7.6 国际化获客集成

与第21章国际化的协同：

| 市场 | 本地化策略 | 获客重点 |
|------|------------|----------|
| 中国大陆 | 微信生态 | 小程序分享裂变 |
| 港澳台 | 繁体中文 | 应用商店ASO |
| 东南亚 | 多语言支持 | 本地社交平台 |
| 欧美 | 英语优先 | ASO+内容营销 |

---
'''

    # 在文件末尾添加（在最后一个代码块后）
    if '### 29.7 与其他系统集成' not in content:
        # 找到文件末尾，在最后添加
        content = content.rstrip() + new_section_29_7
        print("OK: Added 29.7 integration section")
        changes += 1

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 29 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
