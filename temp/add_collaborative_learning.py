# -*- coding: utf-8 -*-
"""
åœ¨15.12.1.1.6ä¹‹åæ·»åŠ å¤šç”¨æˆ·ååŒå­¦ä¹ æ–¹æ¡ˆ
"""

COLLABORATIVE_LEARNING_CONTENT = '''

##### 15.12.1.1.7 å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿ

å½“ç”¨æˆ·é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ç¾¤ä½“æ™ºæ…§è¿›è¡ŒååŒå­¦ä¹ ï¼Œåœ¨ä¿æŠ¤éšç§çš„å‰æä¸‹å…±äº«å­¦ä¹ æˆæœã€‚

###### 15.12.1.1.7.1 ååŒå­¦ä¹ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ç«¯ä¾§ï¼ˆä¸ªäººè®¾å¤‡ï¼‰                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  ç”¨æˆ· A     â”‚  â”‚  ç”¨æˆ· B     â”‚  â”‚  ç”¨æˆ· C     â”‚  â”‚  ç”¨æˆ· N     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚  â”‚ â€¢ æœ¬åœ°æ ·æœ¬  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚  â”‚ â€¢ ä¸ªæ€§åŒ–æ¨¡å‹â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚  â”‚ â€¢ å­¦ä¹ è§„åˆ™  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                â”‚            â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚                          ä¸Šä¼ è„±æ•æ¨¡å¼/è§„åˆ™                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         äº‘ç«¯ï¼ˆååŒå­¦ä¹ æœåŠ¡ï¼‰                               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                      æ¨¡å¼èšåˆå¼•æ“                                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è§„åˆ™æŠ•ç¥¨èšåˆï¼šç›¸åŒæ¨¡å¼è¢«å¤šç”¨æˆ·å­¦ä¹  â†’ æå‡ä¸ºå…¨å±€è§„åˆ™            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ç½®ä¿¡åº¦åŠ æƒï¼šç”¨æˆ·è´¨é‡è¯„åˆ† Ã— è§„åˆ™ç½®ä¿¡åº¦ â†’ èšåˆæƒé‡               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å†²çªæ¶ˆè§£ï¼šä¸åŒç”¨æˆ·å­¦ä¹ åˆ°çŸ›ç›¾è§„åˆ™ â†’ å¤šæ•°æŠ•ç¥¨ / ç½®ä¿¡åº¦ä¼˜å…ˆ        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ–°è¡¨è¾¾å‘ç°ï¼šä½é¢‘ä½†é«˜è´¨é‡çš„æ–°è¡¨è¾¾ â†’ å€™é€‰å…¨å±€è§„åˆ™                 â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚                      å…¨å±€æ¨¡å‹ä»“åº“                                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ åŸºç¡€è§„åˆ™åº“  â”‚  â”‚ ç¾¤ä½“å­¦ä¹ åº“  â”‚  â”‚ çƒ­é—¨è¡¨è¾¾åº“  â”‚              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (å†…ç½®1000+) â”‚  â”‚ (èšåˆè§„åˆ™)  â”‚  â”‚ (é«˜é¢‘æ¨¡å¼)  â”‚              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                   â”‚                                      â”‚   â”‚
â”‚  â”‚                          ä¸‹å‘å…¨å±€æ¨¡å‹æ›´æ–°                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ç«¯ä¾§ï¼ˆæ¨¡å‹èåˆï¼‰                                   â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚            æœ€ç»ˆè¯†åˆ«æ¨¡å‹ = å…¨å±€æ¨¡å‹ + ä¸ªæ€§åŒ–æ¨¡å‹                   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  ä¼˜å…ˆçº§ï¼šä¸ªæ€§åŒ–è§„åˆ™ > ç¾¤ä½“å­¦ä¹ è§„åˆ™ > åŸºç¡€è§„åˆ™ > LLMå…œåº•          â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

###### 15.12.1.1.7.2 éšç§ä¿æŠ¤è®¾è®¡

```dart
/// éšç§ä¿æŠ¤çš„æ¨¡å¼ä¸ŠæŠ¥
class PrivacyPreservingPatternReporter {

  /// ä¸ŠæŠ¥å­¦ä¹ åˆ°çš„æ¨¡å¼ï¼ˆéåŸå§‹æ•°æ®ï¼‰
  Future<void> reportLearnedPattern(LearnedRule rule) async {
    // 1. è„±æ•å¤„ç†ï¼šåªä¸ŠæŠ¥æ¨¡å¼ï¼Œä¸ä¸ŠæŠ¥åŸå§‹æ ·æœ¬
    final sanitizedPattern = SanitizedPattern(
      // æ¨¡å¼æ¨¡æ¿ï¼ˆå¦‚ï¼š"æŠŠ{category}é¢„ç®—æ”¹æˆ{amount}"ï¼‰
      template: rule.pattern,
      // æ„å›¾ç±»å‹
      intent: rule.intent,
      // æœ¬åœ°ç½®ä¿¡åº¦
      localConfidence: rule.confidence,
      // æœ¬åœ°å‘½ä¸­é¢‘æ¬¡
      localFrequency: rule.frequency,
      // ç”¨æˆ·IDå“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰
      userHash: _hashUserId(_currentUserId),
      // è®¾å¤‡æŒ‡çº¹ï¼ˆç”¨äºå»é‡ï¼‰
      deviceFingerprint: _getDeviceFingerprint(),
    );

    // 2. å·®åˆ†éšç§ï¼šæ·»åŠ å™ªå£°
    final noisyPattern = _addDifferentialPrivacyNoise(sanitizedPattern);

    // 3. ä¸ŠæŠ¥åˆ°äº‘ç«¯
    await _cloudService.reportPattern(noisyPattern);
  }

  /// å·®åˆ†éšç§å™ªå£°æ·»åŠ 
  SanitizedPattern _addDifferentialPrivacyNoise(SanitizedPattern pattern) {
    // å¯¹é¢‘æ¬¡æ·»åŠ æ‹‰æ™®æ‹‰æ–¯å™ªå£°
    final noisyFrequency = pattern.localFrequency +
        _laplacianNoise(sensitivity: 1.0, epsilon: 0.5);

    // å¯¹ç½®ä¿¡åº¦æ·»åŠ é«˜æ–¯å™ªå£°
    final noisyConfidence = (pattern.localConfidence +
        _gaussianNoise(sigma: 0.05)).clamp(0.0, 1.0);

    return pattern.copyWith(
      localFrequency: noisyFrequency.round().clamp(1, 1000),
      localConfidence: noisyConfidence,
    );
  }
}

/// è„±æ•åçš„æ¨¡å¼ç»“æ„
class SanitizedPattern {
  final String template;        // æ¨¡å¼æ¨¡æ¿ï¼ˆæ— å…·ä½“æ•°å€¼/åç§°ï¼‰
  final VoiceIntentType intent; // æ„å›¾ç±»å‹
  final double localConfidence; // æœ¬åœ°ç½®ä¿¡åº¦ï¼ˆåŠ å™ªåï¼‰
  final int localFrequency;     // æœ¬åœ°é¢‘æ¬¡ï¼ˆåŠ å™ªåï¼‰
  final String userHash;        // ç”¨æˆ·å“ˆå¸Œ
  final String deviceFingerprint;
}
```

###### 15.12.1.1.7.3 ç¾¤ä½“è§„åˆ™èšåˆ

```dart
/// äº‘ç«¯è§„åˆ™èšåˆæœåŠ¡
class GlobalPatternAggregationService {

  /// èšåˆæ¥è‡ªå¤šç”¨æˆ·çš„æ¨¡å¼
  Future<List<GlobalRule>> aggregatePatterns() async {
    final allPatterns = await _db.getAllReportedPatterns();
    final globalRules = <GlobalRule>[];

    // æŒ‰æ¨¡å¼æ¨¡æ¿åˆ†ç»„
    final groupedByTemplate = _groupByTemplate(allPatterns);

    for (final entry in groupedByTemplate.entries) {
      final template = entry.key;
      final patterns = entry.value;

      // è®¡ç®—èšåˆæŒ‡æ ‡
      final stats = _calculateAggregationStats(patterns);

      // åˆ¤æ–­æ˜¯å¦è¾¾åˆ°å…¨å±€è§„åˆ™æ ‡å‡†
      if (_meetsGlobalRuleThreshold(stats)) {
        globalRules.add(GlobalRule(
          id: _generateRuleId(),
          template: template,
          intent: _resolveIntent(patterns),  // æŠ•ç¥¨å†³å®šæ„å›¾
          globalConfidence: stats.weightedConfidence,
          userCount: stats.uniqueUserCount,
          totalFrequency: stats.totalFrequency,
          createdAt: DateTime.now(),
          source: RuleSource.crowdLearned,
        ));
      }
    }

    return globalRules;
  }

  /// è®¡ç®—èšåˆç»Ÿè®¡
  AggregationStats _calculateAggregationStats(List<SanitizedPattern> patterns) {
    // å»é‡ç”¨æˆ·æ•°
    final uniqueUsers = patterns.map((p) => p.userHash).toSet().length;

    // æ€»é¢‘æ¬¡
    final totalFrequency = patterns.fold<int>(
      0, (sum, p) => sum + p.localFrequency);

    // åŠ æƒç½®ä¿¡åº¦ï¼ˆç”¨æˆ·è´¨é‡è¯„åˆ† Ã— æœ¬åœ°ç½®ä¿¡åº¦ï¼‰
    var weightedSum = 0.0;
    var weightTotal = 0.0;
    for (final pattern in patterns) {
      final userQuality = _getUserQualityScore(pattern.userHash);
      weightedSum += pattern.localConfidence * userQuality;
      weightTotal += userQuality;
    }
    final weightedConfidence = weightTotal > 0 ? weightedSum / weightTotal : 0.0;

    return AggregationStats(
      uniqueUserCount: uniqueUsers,
      totalFrequency: totalFrequency,
      weightedConfidence: weightedConfidence,
      patternCount: patterns.length,
    );
  }

  /// åˆ¤æ–­æ˜¯å¦æ»¡è¶³å…¨å±€è§„åˆ™é˜ˆå€¼
  bool _meetsGlobalRuleThreshold(AggregationStats stats) {
    return stats.uniqueUserCount >= 10 &&      // è‡³å°‘10ä¸ªä¸åŒç”¨æˆ·
           stats.totalFrequency >= 50 &&        // è‡³å°‘50æ¬¡å‘½ä¸­
           stats.weightedConfidence >= 0.85;    // åŠ æƒç½®ä¿¡åº¦ >= 85%
  }

  /// æŠ•ç¥¨å†³å®šæ„å›¾ï¼ˆå¤„ç†å†²çªï¼‰
  VoiceIntentType _resolveIntent(List<SanitizedPattern> patterns) {
    final votes = <VoiceIntentType, double>{};

    for (final pattern in patterns) {
      final userQuality = _getUserQualityScore(pattern.userHash);
      final weight = pattern.localConfidence * userQuality * pattern.localFrequency;
      votes[pattern.intent] = (votes[pattern.intent] ?? 0) + weight;
    }

    // è¿”å›å¾—ç¥¨æœ€é«˜çš„æ„å›¾
    return votes.entries
        .reduce((a, b) => a.value > b.value ? a : b)
        .key;
  }
}

/// å…¨å±€è§„åˆ™
class GlobalRule {
  final String id;
  final String template;
  final VoiceIntentType intent;
  final double globalConfidence;
  final int userCount;           // è´¡çŒ®ç”¨æˆ·æ•°
  final int totalFrequency;      // å…¨å±€æ€»å‘½ä¸­æ•°
  final DateTime createdAt;
  final RuleSource source;

  /// å…¨å±€è§„åˆ™è´¨é‡è¯„åˆ†
  double get qualityScore {
    final userScore = (userCount / 100).clamp(0.0, 1.0);
    final frequencyScore = (totalFrequency / 1000).clamp(0.0, 1.0);
    return globalConfidence * 0.5 + userScore * 0.3 + frequencyScore * 0.2;
  }
}
```

###### 15.12.1.1.7.4 æ–°ç”¨æˆ·å†·å¯åŠ¨åŠ é€Ÿ

```dart
/// æ–°ç”¨æˆ·å†·å¯åŠ¨æœåŠ¡
class ColdStartAccelerationService {
  final GlobalModelRepository _globalRepo;
  final UserProfileService _profileService;

  /// ä¸ºæ–°ç”¨æˆ·åˆå§‹åŒ–æ¨¡å‹
  Future<PersonalizedIntentModel> initializeNewUserModel(String userId) async {
    // 1. è·å–å…¨å±€çƒ­é—¨è§„åˆ™
    final hotRules = await _globalRepo.getHotRules(limit: 100);

    // 2. è·å–ç”¨æˆ·ç”»åƒç›¸ä¼¼ç¾¤ä½“çš„è§„åˆ™
    final userProfile = await _profileService.getProfile(userId);
    final similarGroupRules = await _getSimilarGroupRules(userProfile);

    // 3. æ„å»ºåˆå§‹åŒ–æ¨¡å‹
    return PersonalizedIntentModel(
      userId: userId,
      expressionHabits: ExpressionHabits.defaults(),
      intentFrequency: _getDefaultIntentFrequency(),
      contextPreferences: {},
      timePatterns: TimePatterns.defaults(),
      learnedRules: [],  // ä¸ªäººè§„åˆ™ä¸ºç©º
      inheritedRules: [...hotRules, ...similarGroupRules],  // ç»§æ‰¿å…¨å±€è§„åˆ™
      lastUpdated: DateTime.now(),
    );
  }

  /// è·å–ç›¸ä¼¼ç”¨æˆ·ç¾¤ä½“çš„è§„åˆ™
  Future<List<GlobalRule>> _getSimilarGroupRules(UserProfile profile) async {
    // åŸºäºç”¨æˆ·ç‰¹å¾åŒ¹é…ç›¸ä¼¼ç¾¤ä½“
    final similarityFactors = {
      'age_group': profile.ageGroup,        // å¹´é¾„æ®µ
      'profession': profile.profession,      // èŒä¸š
      'usage_frequency': profile.usageFrequency,  // ä½¿ç”¨é¢‘ç‡
      'primary_intent': profile.primaryIntent,    // ä¸»è¦ä½¿ç”¨åœºæ™¯
    };

    return await _globalRepo.getRulesBySimilarity(
      factors: similarityFactors,
      limit: 50,
    );
  }
}

/// ç”¨æˆ·ç”»åƒ
class UserProfile {
  final String ageGroup;        // å¹´é¾„æ®µï¼š18-25, 26-35, 36-45, 46+
  final String profession;      // èŒä¸šç±»å‹ï¼šstudent, employee, business, freelance
  final String usageFrequency;  // ä½¿ç”¨é¢‘ç‡ï¼šdaily, weekly, occasional
  final String primaryIntent;   // ä¸»è¦æ„å›¾ï¼šbookkeeping, budgeting, investing
}
```

###### 15.12.1.1.7.5 A/B æµ‹è¯•ä¸æ¸è¿›å¼å‘å¸ƒ

```dart
/// å…¨å±€è§„åˆ™å‘å¸ƒæœåŠ¡
class GlobalRuleReleaseService {

  /// æ¸è¿›å¼å‘å¸ƒæ–°è§„åˆ™
  Future<void> releaseRule(GlobalRule rule) async {
    // é˜¶æ®µ1ï¼šå†…éƒ¨æµ‹è¯•ï¼ˆ1%ç”¨æˆ·ï¼‰
    await _releaseToGroup(
      rule: rule,
      targetPercentage: 1,
      group: ReleaseGroup.internal,
      duration: Duration(days: 3),
    );

    // é˜¶æ®µ2ï¼šç°åº¦å‘å¸ƒï¼ˆ10%ç”¨æˆ·ï¼‰
    final internalMetrics = await _evaluateRulePerformance(rule);
    if (internalMetrics.successRate >= 0.9) {
      await _releaseToGroup(
        rule: rule,
        targetPercentage: 10,
        group: ReleaseGroup.beta,
        duration: Duration(days: 7),
      );
    }

    // é˜¶æ®µ3ï¼šå…¨é‡å‘å¸ƒ
    final betaMetrics = await _evaluateRulePerformance(rule);
    if (betaMetrics.successRate >= 0.85 && betaMetrics.userSatisfaction >= 0.8) {
      await _releaseToGroup(
        rule: rule,
        targetPercentage: 100,
        group: ReleaseGroup.production,
      );
    } else {
      // å›æ»š
      await _rollbackRule(rule);
    }
  }

  /// è¯„ä¼°è§„åˆ™æ€§èƒ½
  Future<RuleMetrics> _evaluateRulePerformance(GlobalRule rule) async {
    final samples = await _db.getSamplesForRule(rule.id);

    return RuleMetrics(
      matchCount: samples.length,
      successRate: _calculateSuccessRate(samples),
      userSatisfaction: _calculateSatisfaction(samples),
      averageLatency: _calculateAverageLatency(samples),
    );
  }
}

/// A/B æµ‹è¯•æœåŠ¡
class ABTestService {

  /// åˆ›å»ºè§„åˆ™å¯¹æ¯”å®éªŒ
  Future<ABTest> createRuleTest({
    required GlobalRule controlRule,
    required GlobalRule treatmentRule,
    required double trafficPercentage,
  }) async {
    return ABTest(
      id: _generateTestId(),
      controlRule: controlRule,
      treatmentRule: treatmentRule,
      trafficPercentage: trafficPercentage,
      startTime: DateTime.now(),
      status: ABTestStatus.running,
      metrics: ABTestMetrics.empty(),
    );
  }

  /// åˆ†æå®éªŒç»“æœ
  Future<ABTestResult> analyzeTest(String testId) async {
    final test = await _db.getTest(testId);
    final controlSamples = await _getSamplesForVariant(testId, 'control');
    final treatmentSamples = await _getSamplesForVariant(testId, 'treatment');

    final controlMetrics = _calculateMetrics(controlSamples);
    final treatmentMetrics = _calculateMetrics(treatmentSamples);

    // ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ
    final significance = _calculateStatisticalSignificance(
      controlMetrics, treatmentMetrics);

    return ABTestResult(
      testId: testId,
      controlMetrics: controlMetrics,
      treatmentMetrics: treatmentMetrics,
      winner: significance.pValue < 0.05
          ? (treatmentMetrics.successRate > controlMetrics.successRate
              ? 'treatment' : 'control')
          : 'inconclusive',
      significance: significance,
    );
  }
}
```

###### 15.12.1.1.7.6 ååŒå­¦ä¹ æ•ˆæœé¢„æœŸ

| ç”¨æˆ·è§„æ¨¡ | ä¼˜åŒ–æ•ˆæœ | å…³é”®æŒ‡æ ‡ |
|----------|----------|----------|
| **100-1K** | åˆæ­¥ç¾¤ä½“æ•ˆåº” | æ–°ç”¨æˆ·å†·å¯åŠ¨æ—¶é—´ -50%ï¼Œè§„åˆ™è¦†ç›–ç‡ +10% |
| **1K-10K** | æ˜¾è‘—ç¾¤ä½“æ™ºæ…§ | å…¨å±€è§„åˆ™åº“ +200æ¡ï¼Œå‡†ç¡®ç‡ +5%ï¼ŒLLMè°ƒç”¨ -20% |
| **10K-100K** | é•¿å°¾è¡¨è¾¾è¦†ç›– | è¦†ç›–95%+å¸¸è§è¡¨è¾¾ï¼Œåœ°åŸŸ/æ–¹è¨€é€‚é… |
| **100K+** | å®æ—¶ç¾¤ä½“å­¦ä¹  | æ–°è¡¨è¾¾å‘ç° <24hï¼Œè§„åˆ™è‡ªåŠ¨è¿­ä»£ |

**ååŒå­¦ä¹ æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸš€ æ–°ç”¨æˆ·å†·å¯åŠ¨ï¼šä»2å‘¨ç¼©çŸ­åˆ°å³æ—¶å¯ç”¨ï¼ˆç»§æ‰¿ç¾¤ä½“è§„åˆ™ï¼‰
- ğŸ“ˆ é•¿å°¾è¡¨è¾¾è¦†ç›–ï¼šå•ç”¨æˆ·éš¾ä»¥å­¦åˆ°çš„ä½é¢‘è¡¨è¾¾ï¼Œç¾¤ä½“å¯è¦†ç›–
- ğŸ’° æˆæœ¬ä¼˜åŒ–ï¼šç¾¤ä½“è§„åˆ™å‘½ä¸­ç‡æå‡ â†’ LLMè°ƒç”¨è¿›ä¸€æ­¥é™ä½
- ğŸ”„ å®æ—¶è¿­ä»£ï¼šæ–°è¡¨è¾¾å¿«é€Ÿä¼ æ’­åˆ°å…¨ä½“ç”¨æˆ·

'''

def main():
    # è¯»å–æ–‡æ¡£
    with open('d:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'r', encoding='utf-8') as f:
        content = f.read()

    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if '15.12.1.1.7 å¤šç”¨æˆ·ååŒå­¦ä¹ ç³»ç»Ÿ' in content:
        print("Collaborative learning section already exists, skipping")
        return

    # æ¸…ç†å¯èƒ½çš„æ®‹ç•™ä»£ç 
    content = content.replace('\nd }\n```\n\n#### 15.12.2', '\n\n#### 15.12.2')

    # æŸ¥æ‰¾æ’å…¥ç‚¹ï¼šåœ¨ "#### 15.12.2 è¯­éŸ³è®°è´¦æ¨¡å—" ä¹‹å‰
    marker = '#### 15.12.2 è¯­éŸ³è®°è´¦æ¨¡å—'
    idx = content.find(marker)

    if idx == -1:
        print(f"Error: Cannot find marker '{marker}'")
        return

    # æ’å…¥æ–°å†…å®¹
    before = content[:idx].rstrip()
    after = content[idx:]

    new_content = before + '\n' + COLLABORATIVE_LEARNING_CONTENT.strip() + '\n\n' + after

    # å†™å…¥æ–‡ä»¶
    with open('d:/code/ai-bookkeeping/docs/design/app_v2_design.md', 'w', encoding='utf-8') as f:
        f.write(new_content)

    print('Successfully added collaborative learning section!')
    print(f'Old size: {len(content)} characters')
    print(f'New size: {len(new_content)} characters')
    print(f'Added: {len(new_content) - len(content)} characters')

if __name__ == '__main__':
    main()
