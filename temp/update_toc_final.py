# -*- coding: utf-8 -*-
"""
更新目录，确保所有章节正确链接
"""

import re

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    # 修复目录中的章节链接
    fixes = [
        # 第16章
        ('- [16. 自学习与协同学习系统](#16-自学习与协同学习系统)',
         '- [16. 自学习与协同学习系统](#16-自学习与协同学习系统)'),

        # 第17章（需要确保存在）
        # 检查是否已有第17章目录项
    ]

    # 查找目录区域
    toc_start = content.find('## 目录')
    toc_end = content.find('## 产品概述')

    if toc_start == -1 or toc_end == -1:
        print("❌ 未找到目录区域")
        return

    toc_content = content[toc_start:toc_end]

    # 检查是否已有第17章目录项
    if '- [17. 智能语音交互系统]' not in toc_content:
        # 需要添加第17章目录项
        # 在第18章之前插入
        toc_17 = '''- [17. 智能语音交互系统](#17-智能语音交互系统)
  - [17.0 设计原则回顾](#170-设计原则回顾)
  - [17.1 意图识别引擎](#171-意图识别引擎)
  - [17.2 语音记账模块](#172-语音记账模块)
  - [17.3 智能语音配置模块](#173-智能语音配置模块)
  - [17.4 智能语音导航模块](#174-智能语音导航模块)
  - [17.5 智能语音查询模块](#175-智能语音查询模块)
  - [17.6 语音交互会话管理](#176-语音交互会话管理)
  - [17.7 语音交互界面设计](#177-语音交互界面设计)
  - [17.8 与其他系统的集成](#178-与其他系统的集成)
  - [17.9 目标达成检测](#179-目标达成检测)
  - [17.10 智能语音反馈与客服系统](#1710-智能语音反馈与客服系统)
'''
        old_toc_18 = '- [18. 性能设计与优化]'
        new_toc_18 = toc_17 + '- [18. 性能设计与优化]'
        content = content.replace(old_toc_18, new_toc_18, 1)
        print("✅ 添加第17章目录项")

    # 确保目录链接格式正确
    # 修复各章节的锚点链接
    link_fixes = [
        ('(#16-性能设计与优化)', '(#18-性能设计与优化)'),
        ('(#17-用户体验设计)', '(#19-用户体验设计)'),
        ('(#18-国际化与本地化)', '(#20-国际化与本地化)'),
        ('(#19-安全与隐私)', '(#21-安全与隐私)'),
        ('(#20-异常处理与容错设计)', '(#22-异常处理与容错设计)'),
        ('(#21-可扩展性与演进架构)', '(#23-可扩展性与演进架构)'),
        ('(#22-可观测性与监控)', '(#24-可观测性与监控)'),
        ('(#23-版本迁移策略)', '(#25-版本迁移策略)'),
        ('(#24-实施路线图)', '(#26-实施路线图)'),
    ]

    for old, new in link_fixes:
        if old in content:
            content = content.replace(old, new)

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

    print("✅ 目录更新完成")

if __name__ == '__main__':
    main()
