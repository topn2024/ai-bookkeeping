# -*- coding: utf-8 -*-
"""
修正第2章2.0.3协同关系图
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # 按行处理，找到2.0.3和2.1之间的内容替换
    lines = content.split('\n')
    start_idx = -1
    end_idx = -1

    for i, line in enumerate(lines):
        if '#### 2.0.3 与2.0其他系统的协同关系图' in line:
            start_idx = i
        if start_idx > 0 and '### 2.1 产品定位' in line:
            end_idx = i
            break

    if start_idx > 0 and end_idx > start_idx:
        new_section = '''#### 2.0.3 与2.0其他系统的协同关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        产品定位与愿景 (第2章)                                 │
│                  "您的智能财务伙伴，让每一分钱都有意义"                         │
└──────────────────────────────┬──────────────────────────────────────────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         │                     │                     │
         ▼                     ▼                     ▼
  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
  │   第3章      │       │   第4章      │       │   第5章      │
  │  懒人设计    │       │  伙伴化      │       │  无障碍      │
  │  (极致体验)  │       │ (智能伙伴)   │       │  (普惠)      │
  └──────┬──────┘       └──────┬──────┘       └──────┬──────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
┌──────────────────────────────┼──────────────────────────────────────────────┐
│                              ▼                                              │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║                        核��差异化功能                                   ║ │
│  ║                                                                       ║ │
│  ║   ┌───────────────────┐              ┌───────────────────┐            ║ │
│  ║   │     第12章         │              │     第10章         │            ║ │
│  ║   │    钱龄分析        │◄────────────►│    零基预算        │            ║ │
│  ║   │  (理解钱的价值)    │    联动      │  (每分钱有去处)    │            ║ │
│  ║   └─────────┬─────────┘              └─────────┬─────────┘            ║ │
│  ╚═════════════│════════════════════════════════════│════════════════════╝ │
│                │                                    │                      │
│  ┌─────────────┼────────────────────────────────────┼─────────────────┐    │
│  │             ▼          支撑能力                   ▼                 │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │    │
│  │  │    第11章      │  │    第17章      │  │    第18章      │          │    │
│  │  │   习惯培养     │  │   自学习系统   │  │   语音交互     │          │    │
│  │  │  (养成好习惯)  │  │  (越用越懂你)  │  │  (极致体验)   │          │    │
│  │  └───────────────┘  └───────────────┘  └───────────────┘          │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                         扩展服务                                    │    │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │    │
│  │  │    第13章      │  │    第14章      │  │    第9章       │          │    │
│  │  │   家庭账本     │  │   位置智能     │  │  数据可视化    │          │    │
│  │  │  (协作记账)    │  │  (场景识别)    │  │  (洞察分析)    │          │    │
│  │  └───────────────┘  └───────────────┘  └───────────────┘          │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         │                     │                     │
         ▼                     ▼                     ▼
  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
  │   第15章     │       │   第19章     │       │   第22章     │
  │  技术架构    │       │  性能优化    │       │  安全设计    │
  └─────────────┘       └─────────────┘       └─────────────┘
```

'''
        new_lines = lines[:start_idx] + new_section.split('\n') + lines[end_idx:]
        content = '\n'.join(new_lines)
        print(f"OK: Replaced 2.0.3 section (lines {start_idx}-{end_idx})")
        changes += 1

    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 2.0.3 fix done, {changes} changes =====")
    else:
        print("\nNo changes made")

    return changes

if __name__ == '__main__':
    main()
