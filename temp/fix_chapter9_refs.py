# -*- coding: utf-8 -*-
"""
刷新第9章金融习惯培养系统
1. 修正地理位置智能章节号 15→14
2. 扩展协同图添加新模块
3. 修正子系统职责边界表格章节编号
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ============================================================
    # 修复1: 协同图下游消费模块 - 修正章节号并扩展
    # ============================================================
    old_text1 = '''│  ═══════════════════════════════════════════════════════════════════════   │
│                            下游消费模块                                      │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │ AI智能识别   │  │ 数据联动     │  │ 伙伴化设计   │  │ 地理位置智能 │   │
│   │  (第10章)     │  │  (第12章)     │  │  (第4章)    │  │  (第15章)    │   │
│   │              │  │              │  │              │  │              │   │
│   │ 消费洞察→    │  │ 习惯数据→    │  │ 激励反馈→    │  │ 位置场景→    │   │
│   │ 习惯分析     │  │ 可视化展示   │  │ 情感化表达   │  │ 消费提醒     │   │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘'''

    new_text1 = '''│  ═══════════════════════════════════════════════════════════════════════   │
│                            下游消费模块                                      │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │ AI智能识别   │  │ 数据联动     │  │ 伙伴化设计   │  │ 地理位置智能 │   │
│   │  (第10章)    │  │  (第12章)    │  │  (第4章)     │  │  (第14章)    │   │
│   │              │  │              │  │              │  │              │   │
│   │ 消费洞察→    │  │ 习惯数据→    │  │ 激励反馈→    │  │ 位置场景→    │   │
│   │ 习惯分析     │  │ 可视化展示   │  │ 情感化表达   │  │ 消费提醒     │   │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                          2.0新增协作模块                                     │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │  家庭账本    │  │  语音交互    │  │  自学习系统  │  │  用户增长    │   │
│   │  (第13章)    │  │  (第18章)    │  │  (第17章)    │  │ (第28-29章)  │   │
│   │              │  │              │  │              │  │              │   │
│   │ 家庭习惯→    │  │ 语音打卡→    │  │ 历史学习→    │  │ 习惯达成→    │   │
│   │ 协同培养     │  │ 习惯提醒     │  │ 个性化建议   │  │ 分享传播     │   │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘'''

    if old_text1 in content:
        content = content.replace(old_text1, new_text1)
        print("✓ 修复1: 协同图下游模块修正章节号（15→14）并添加2.0新增协作模块")
        changes += 1

    # ============================================================
    # 修复2: 子系统职责边界表格 - 修正章节编号 6.x → 9.x
    # ============================================================
    old_text2 = '''#### 9.0.3 子系统职责边界

| 子系统 | 职责 | 核心依赖 | 输出 |
|--------|------|----------|------|
| **6.2 消费审视** | 识别浪费模式，提供可操作洞察 | 交易记录、AI分析(第10章) | 浪费识别报告、优化建议 |
| **6.3 冲动消费防护** | 消费前预警，建立心智模型 | 预算余额(第8章)、钱龄(第7章) | 消费确认弹窗、预算可视化 |
| **6.4 财务缓冲建设** | 引导储蓄，建立安全感 | 钱龄阶段(第7章)、储蓄小金库(第8章) | 应急金进度、钱龄进阶目标 |
| **6.5 弹性预算机制** | 处理意外，适配不稳定收入 | 预算分配(第8章) | 突发支出处理流程 |
| **6.6 习惯养成激励** | 正向反馈，持续激励 | 记账数据、钱龄趋势 | 连续记账奖励、财务健康分 |'''

    new_text2 = '''#### 9.0.3 子系统职责边界

| 子系统 | 职责 | 核心依赖 | 输出 |
|--------|------|----------|------|
| **9.2 消费审视** | 识别浪费模式，提供可操作洞察 | 交易记录、AI分析(第10章) | 浪费识别报告、优化建议 |
| **9.3 冲动消费防护** | 消费前预警，建立心智模型 | 预算余额(第8章)、钱龄(第7章) | 消费确认弹窗、预算可视化 |
| **9.4 财务缓冲建设** | 引导储蓄，建立安全感 | 钱龄阶段(第7章)、储蓄小金库(第8章) | 应急金进度、钱龄进阶目标 |
| **9.5 弹性预算机制** | 处理意外，适配不稳定收入 | 预算分配(第8章)、自学习(第17章) | 突发支出处理流程 |
| **9.6 习惯养成激励** | 正向反馈，持续激励 | 记账数据、钱龄趋势、用户增长(第28-29章) | 连续记账奖励、财务健康分 |

**2.0新增协作依赖**：

| 子系统 | 新增依赖模块 | 协作内容 |
|--------|-------------|---------|
| 消费审视 | 语音交互(第18章) | 语音播报消费洞察 |
| 冲动防护 | 家庭账本(第13章) | 家庭成员消费提醒 |
| 财务缓冲 | 自学习系统(第17章) | 个性化储蓄目标调整 |
| 习惯激励 | 用户增长(第28-29章) | 成就分享与邀请引导 |'''

    if old_text2 in content:
        content = content.replace(old_text2, new_text2)
        print("✓ 修复2: 子系统职责边界表格修正编号（6.x→9.x）并添加2.0新增协作依赖")
        changes += 1

    # ============================================================
    # 修复3: 协同图中的子系统编号 6.2/6.3/6.4 → 9.2/9.3/9.4
    # ============================================================
    old_text3 = '''│  ┌────▼─────────┐            ┌──────▼──────┐            ┌─────────▼────┐   │
│  │ 6.2 消费审视  │            │ 6.3 冲动防护 │            │ 6.4 财务缓冲 │   │
│  │              │            │              │            │              │   │
│  │ 订阅浪费识别  │            │ 预算余额预警  │            │ 应急金目标   │   │
│  │ 拿铁因子分析  │            │ 消费前确认    │            │ 钱龄进阶    │   │
│  │ 想要vs需要   │            │ 先规划再消费  │            │ 债务健康    │   │
│  └──────────────┘            └──────────────┘            └──────────────┘   │
│         │                           │                           │           │
│         └───────────────────────────┼───────────────────────────┘           │
│                                     ▼                                       │
│                    ┌────────────────────────────────┐                       │
│                    │    6.5 弹性预算 + 6.6 激励     │                       │
│                    │    突发支出 / 收入不稳定适配   │                       │
│                    │    连续记账 / 财务健康分 / 承诺 │                       │
│                    └────────────────────────────────┘                       │'''

    new_text3 = '''│  ┌────▼─────────┐            ┌──────▼──────┐            ┌─────────▼────┐   │
│  │ 9.2 消费审视  │            │ 9.3 冲动防护 │            │ 9.4 财务缓冲 │   │
│  │              │            │              │            │              │   │
│  │ 订阅浪费识别  │            │ 预算余额预警  │            │ 应急金目标   │   │
│  │ 拿铁因子分析  │            │ 消费前确认    │            │ 钱龄进阶    │   │
│  │ 想要vs需要   │            │ 先规划再消费  │            │ 债务健康    │   │
│  └──────────────┘            └──────────────┘            └──────────────┘   │
│         │                           │                           │           │
│         └───────────────────────────┼───────────────────────────┘           │
│                                     ▼                                       │
│                    ┌────────────────────────────────┐                       │
│                    │    9.5 弹性预算 + 9.6 激励     │                       │
│                    │    突发支出 / 收入不稳定适配   │                       │
│                    │    连续记账 / 财务健康分 / 承诺 │                       │
│                    └────────────────────────────────┘                       │'''

    if old_text3 in content:
        content = content.replace(old_text3, new_text3)
        print("✓ 修复3: 协同图中子系统编号修正（6.x→9.x）")
        changes += 1

    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== 第9章金融习惯培养系统刷新完成，共 {changes} 处 =====")
    else:
        print("\n未找到目标位置或已刷新")

    return changes

if __name__ == '__main__':
    main()
