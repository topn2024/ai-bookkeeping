# -*- coding: utf-8 -*-
"""
刷新第22章安全与隐私
1. 修复章节编号错误（24.0.x -> 22.0.x）
2. 修复图中章节引用错误
3. 添加22.6与其他系统集成部分
"""

def main():
    filepath = 'd:/code/ai-bookkeeping/docs/design/app_v2_design.md'

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = 0

    # ========== 修复1: 修复章节编号错误 ==========
    number_fixes = [
        ('#### 24.0.1 安全与隐私设计原则矩阵', '#### 22.0.1 安全与隐私设计原则矩阵'),
        ('#### 24.0.2 安全模块协作图', '#### 22.0.2 安全模块协作图'),
        ('#### 24.0.3 与其他模块的依赖关系', '#### 22.0.3 与其他模块的依赖关系'),
        ('#### 24.0.4 安全子系统职责边界表', '#### 22.0.4 安全子系统职责边界表'),
    ]

    for old, new in number_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Fix: {old[:30]}... -> {new[:30]}...")
            changes += 1

    # ========== 修复2: 修复图中章节引用 ==========
    ref_fixes = [
        # 修复"第19章 安全与隐私"引用为"第22章"
        ('║    第19章 安全与隐私       ║', '║    第22章 安全与隐私       ║'),
        ('│  • 第19章是基础安全设施', '│  • 第22章是基础安全设施'),
        ('│  • 第19章依赖第5章的监控能力', '│  • 第22章依赖第25章的监控能力'),
        # 修复协作图中的章节引用 - 15.x应改为22.x
        ('│  │  (15.2)     │  │  (15.2)     │  │  (15.2)     │  │  (15.4)     │ │',
         '│  │  (22.2)     │  │  (22.2)     │  │  (22.2)     │  │  (22.4)     │ │'),
        ('│  │     (15.1)      │   │      (15.2)         │   │      (15.3)         │',
         '│  │     (22.1)      │   │      (22.2)         │   │      (22.3)         │'),
        ('│  │                          审计与合规层 (15.5)                          │',
         '│  │                          审计与合规层 (22.5)                          │'),
        # 修复依赖关系图
        ('│  │ 第15章  │  │  第15章  │  │  第23章  │  │  第5章  │',
         '│  │ 第14章  │  │  第15章  │  │  第24章  │  │  第25章 │'),
        ('│  │地理位置  │  │技术架构  │  │版本迁移  │  │可观测性  │',
         '│  │地理位置  │  │技术架构  │  │版本迁移  │  │可观测性 │'),
        # 修复"第5章 可观测性"
        ('│                  │ • 安全审计日志 (→ 第5章)',
         '│                  │ • 安全审计日志 (→ 第25章)'),
        # 修复职责边界表
        ('| **数据安全** | 15.1 |', '| **数据安全** | 22.1 |'),
        ('| **隐私保护** | 15.2 |', '| **隐私保护** | 22.2 |'),
        ('| **备份恢复** | 15.3 |', '| **备份恢复** | 22.3 |'),
        ('| **认证授权** | 15.4 |', '| **认证授权** | 22.4 |'),
        ('| **审计合规** | 15.5 |', '| **审计合规** | 22.5 |'),
    ]

    for old, new in ref_fixes:
        if old in content:
            content = content.replace(old, new)
            print(f"Ref fix: ...{old[20:50]}...")
            changes += 1

    # ========== 修复3: 添加22.6与其他系统集成 ==========
    chapter23_marker = '## 23. 异常处理与容错设计'

    new_section_22_6 = '''### 22.6 与其他系统集成

#### 22.6.1 系统集成概览

安全与隐私系统为其他2.0模块提供基础安全能力：

```
┌────────────────────────────────────────────────────────────────────────────┐
│                        安全与隐私集成全景图                                  │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                        安全核心服务                                   │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │  │ 数据加密  │  │ 认证授权  │  │ 隐私保护  │  │ 审计日志  │           │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘           │  │
│  └───────────────────────────┬─────────────────────────────────────────┘  │
│                              │                                            │
│         ┌────────────────────┼────────────────────┐                       │
│         │                    │                    │                       │
│         ▼                    ▼                    ▼                       │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                 │
│  │  核心业务    │     │  智能增强    │     │  2.0新增    │                 │
│  │  安全保护    │     │  安全保护    │     │  安全保护    │                 │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤                 │
│  │ • 钱龄数据   │     │ • AI模型    │     │ • 位置数据   │                 │
│  │ • 预算数据   │     │ • 语音数据   │     │ • 家庭数据   │                 │
│  │ • 交易记录   │     │ • 识别结果   │     │ • 同步数据   │                 │
│  └─────────────┘     └─────────────┘     └─────────────┘                 │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

#### 22.6.2 位置数据安全集成

位置数据是高度敏感的隐私信息，需要特殊保护：

| 安全措施 | 实现方式 | 说明 |
|----------|----------|------|
| 本地加密存储 | AES-256加密 | 原始坐标加密存储 |
| 精度降级 | 网格化处理 | 存储时降低精度 |
| 自动清理 | 定时任务 | 超过30天自动删除 |
| 访问控制 | 权限检查 | 需要明确用户授权 |
| 传输保护 | TLS 1.3 | 上传服务器时加密 |

#### 22.6.3 语音数据安全集成

语音记账涉及用户语音数据的处理：

| 阶段 | 安全措施 | 说明 |
|------|----------|------|
| 录制 | 内存处理 | 音频不落地存储 |
| 识别 | 本地优先 | 优先使用本地ASR |
| 传输 | 端到端加密 | 传输到云端时加密 |
| 存储 | 不存原音 | 只存储识别文本 |
| 清理 | 即时删除 | 识别完成立即删除 |

#### 22.6.4 家庭账本安全集成

家庭账本涉及多用户数据共享：

| 安全需求 | 实现方式 |
|----------|----------|
| 成员认证 | 家庭邀请码 + 用户认证 |
| 数据隔离 | 家庭ID隔离 + 成员权限 |
| 操作审计 | 记录成员操作日志 |
| 退出清理 | 成员退出时清理关联数据 |
| 传输加密 | 家庭同步数据加密传输 |

#### 22.6.5 AI识别安全集成

AI识别涉及用户财务数据的处理：

| 数据类型 | 安全措施 |
|----------|----------|
| 票据图片 | 本地预处理后上传，识别后删除云端副本 |
| 消费文本 | 脱敏处理，不上传真实商户名 |
| 识别结果 | 仅存储结构化数据，不存原始输入 |
| AI模型 | 支持本地模型，减少云端依赖 |

#### 22.6.6 数据同步安全集成

跨设备同步需要确保数据安全：

| 安全措施 | 说明 |
|----------|------|
| 端到端加密 | 同步数据在客户端加密，服务端无法解密 |
| 设备绑定 | 新设备需要验证才能同步 |
| 冲突解决 | 使用版本向量，确保数据一致性 |
| 传输加密 | TLS 1.3 + 应用层加密双重保护 |
| 增量同步 | 仅同步变更数据，减少暴露面 |

---

'''

    if chapter23_marker in content:
        content = content.replace(chapter23_marker, new_section_22_6 + chapter23_marker)
        print("OK: Added 22.6 integration section")
        changes += 1
    else:
        print("SKIP: Chapter 23 marker not found")

    # 写入文件
    if changes > 0:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"\n===== Chapter 22 refresh done, {changes} changes =====")
    else:
        print("\nNo changes needed")

    return changes

if __name__ == '__main__':
    main()
